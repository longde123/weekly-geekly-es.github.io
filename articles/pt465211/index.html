<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>‚òØÔ∏è üßõüèª üì± Escapando o arsenal de testes: construindo um atalho de um dispositivo el√©trico para uma asser√ß√£o ü§ôüèº ‚ôèÔ∏è üöÉ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Neste artigo, gostaria de propor uma alternativa ao estilo tradicional de design de teste usando conceitos de programa√ß√£o funcional no Scala. Essa abo...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Escapando o arsenal de testes: construindo um atalho de um dispositivo el√©trico para uma asser√ß√£o</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/2gis/blog/465211/"><p><img src="https://habrastorage.org/webt/mu/ll/ar/mullaroquhqtdb05ygvb82nmghu.jpeg"></p><br><p>  Neste artigo, gostaria de propor uma alternativa ao estilo tradicional de design de teste usando conceitos de programa√ß√£o funcional no Scala.  Essa abordagem foi inspirada por muitos meses de dor ao manter dezenas de testes com falha e um desejo ardente de torn√°-los mais diretos e mais compreens√≠veis. </p><br><p>  Embora o c√≥digo esteja no Scala, as id√©ias propostas s√£o apropriadas para desenvolvedores e engenheiros de controle de qualidade que usam linguagens que suportam programa√ß√£o funcional.  Voc√™ pode encontrar um link do Github com a solu√ß√£o completa e um exemplo no final do artigo. </p><a name="habracut"></a><br><h2 id="the-problem">  O problema </h2><br><p>  Se voc√™ j√° teve que lidar com testes (n√£o importa quais: testes de unidade, integracionais ou funcionais), eles provavelmente foram escritos como um conjunto de instru√ß√µes seq√ºenciais.  Por exemplo: </p><br><pre><code class="scala hljs"><span class="hljs-comment"><span class="hljs-comment">// The following tests describe a simple internet store. // Depending on their role, bonus amount and the order's // subtotal, users may receive a discount of some size. "If user's role is 'customer'" - { import TestHelper._ "And if subtotal &lt; 250 after bonuses - no discount" in { val db: Database = Database.forURL(TestConfig.generateNewUrl()) migrateDb(db) insertUser(db, id = 1, name = "test", role = "customer") insertPackage(db, id = 1, name = "test", userId = 1, status = "new") insertPackageItems(db, id = 1, packageId = 1, name = "test", price = 30) insertPackageItems(db, id = 2, packageId = 1, name = "test", price = 20) insertPackageItems(db, id = 3, packageId = 1, name = "test", price = 40) val svc = new SomeProductionLogic(db) val result = svc.calculatePrice(packageId = 1) result shouldBe 90 } "And if subtotal &gt;= 250 after bonuses - 10% off" in { val db: Database = Database.forURL(TestConfig.generateNewUrl()) migrateDb(db) insertUser(db, id = 1, name = "test", role = "customer") insertPackage(db, id = 1, name = "test", userId = 1, status = "new") insertPackageItems(db, id = 1, packageId = 1, name = "test", price = 100) insertPackageItems(db, id = 2, packageId = 1, name = "test", price = 120) insertPackageItems(db, id = 3, packageId = 1, name = "test", price = 130) insertBonus(db, id = 1, packageId = 1, bonusAmount = 40) val svc = new SomeProductionLogic(db) val result = svc.calculatePrice(packageId = 1) result shouldBe 279 } } "If user's role is 'vip'" - {/*...*/}</span></span></code> </pre> <br><p>  Na minha experi√™ncia, essa maneira de escrever testes √© preferida pela maioria dos desenvolvedores.  Nosso projeto tem cerca de mil testes em diferentes n√≠veis de isolamento, e todos eles foram escritos com esse estilo at√© recentemente.  √Ä medida que o projeto crescia, come√ßamos a notar s√©rios problemas e lentid√£o na manuten√ß√£o de tais testes: corrigi-los levaria pelo menos a mesma quantidade de tempo que a escrita do c√≥digo de produ√ß√£o. </p><br><p>  Ao escrever novos testes, sempre t√≠nhamos que encontrar maneiras de preparar dados do zero, geralmente copiando e colando as etapas dos testes vizinhos.  Como resultado, quando o modelo de dados do aplicativo mudava, o castelo de cartas desmoronava, e ter√≠amos que reparar todos os testes com falha: no pior cen√°rio - mergulhando profundamente em cada teste e reescrevendo-o. </p><br><p>  Quando um teste falha "honestamente" - ou seja, devido a um bug real na l√≥gica de neg√≥cios - era imposs√≠vel entender o que deu errado sem a depura√ß√£o.  Como os testes eram t√£o dif√≠ceis de entender, ningu√©m tinha o conhecimento completo sempre √† m√£o sobre como o sistema deveria se comportar. </p><br><p>  Toda essa dor, na minha opini√£o, √© um sintoma dos dois problemas mais profundos desse design de teste: </p><br><ol><li>  N√£o existe uma estrutura clara e pr√°tica para os testes.  Todo teste √© um floco de neve √∫nico.  A falta de estrutura leva √† verbosidade, que consome muito tempo e desmotiva.  Detalhes insignificantes desviam o que √© mais importante - o requisito que o teste afirma.  Copiar e colar torna-se a principal abordagem para escrever novos casos de teste. </li><li>  Os testes n√£o ajudam os desenvolvedores a localizar defeitos;  eles apenas sinalizam que h√° algum tipo de problema.  Para entender o estado em que o teste √© executado, voc√™ deve plot√°-lo em sua cabe√ßa ou usar um depurador. </li></ol><br><h2 id="modeling">  Modelagem </h2><br><p>  Podemos fazer melhor?  (Alerta de spoiler: n√≥s podemos.) Vamos considerar que tipo de estrutura esse teste pode ter. </p><br><pre> <code class="scala hljs"><span class="hljs-keyword"><span class="hljs-keyword">val</span></span> db: <span class="hljs-type"><span class="hljs-type">Database</span></span> = <span class="hljs-type"><span class="hljs-type">Database</span></span>.forURL(<span class="hljs-type"><span class="hljs-type">TestConfig</span></span>.generateNewUrl()) migrateDb(db) insertUser(db, id = <span class="hljs-number"><span class="hljs-number">1</span></span>, name = <span class="hljs-string"><span class="hljs-string">"test"</span></span>, role = <span class="hljs-string"><span class="hljs-string">"customer"</span></span>) insertPackage(db, id = <span class="hljs-number"><span class="hljs-number">1</span></span>, name = <span class="hljs-string"><span class="hljs-string">"test"</span></span>, userId = <span class="hljs-number"><span class="hljs-number">1</span></span>, status = <span class="hljs-string"><span class="hljs-string">"new"</span></span>) insertPackageItems(db, id = <span class="hljs-number"><span class="hljs-number">1</span></span>, packageId = <span class="hljs-number"><span class="hljs-number">1</span></span>, name = <span class="hljs-string"><span class="hljs-string">"test"</span></span>, price = <span class="hljs-number"><span class="hljs-number">30</span></span>) insertPackageItems(db, id = <span class="hljs-number"><span class="hljs-number">2</span></span>, packageId = <span class="hljs-number"><span class="hljs-number">1</span></span>, name = <span class="hljs-string"><span class="hljs-string">"test"</span></span>, price = <span class="hljs-number"><span class="hljs-number">20</span></span>) insertPackageItems(db, id = <span class="hljs-number"><span class="hljs-number">3</span></span>, packageId = <span class="hljs-number"><span class="hljs-number">1</span></span>, name = <span class="hljs-string"><span class="hljs-string">"test"</span></span>, price = <span class="hljs-number"><span class="hljs-number">40</span></span>)</code> </pre> <br><p>  Como regra geral, o c√≥digo em teste espera alguns par√¢metros expl√≠citos (identificadores, tamanhos, quantidades, filtros, para citar alguns), al√©m de alguns dados externos (de um banco de dados, fila ou outro servi√ßo do mundo real).  Para que nosso teste seja executado de forma confi√°vel, ele precisa de um <em>dispositivo el√©trico</em> - um estado para colocar o sistema, os provedores de dados ou ambos. </p><br><p>  Com esse acess√≥rio, preparamos uma <em>depend√™ncia</em> para inicializar o c√≥digo em teste - preencha um banco de dados, crie uma fila de um tipo espec√≠fico etc. </p><br><pre> <code class="scala hljs"><span class="hljs-keyword"><span class="hljs-keyword">val</span></span> svc = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-type"><span class="hljs-type">SomeProductionLogic</span></span>(db) <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> result = svc.calculatePrice(packageId = <span class="hljs-number"><span class="hljs-number">1</span></span>)</code> </pre> <br><p>  Ap√≥s executar o c√≥digo em teste em alguns par√¢metros de entrada, recebemos uma <em>sa√≠da</em> - expl√≠cita (retornada pelo c√≥digo em teste) e impl√≠cita (as altera√ß√µes no estado). </p><br><pre> <code class="scala hljs">result shouldBe <span class="hljs-number"><span class="hljs-number">90</span></span></code> </pre> <br><p>  Por fim, verificamos se a sa√≠da √© a esperada, finalizando o teste com uma ou mais <em>asser√ß√µes</em> . </p><br><p><img src="https://habrastorage.org/webt/em/aa/rb/emaarb5ltmnme4-wpda0ebakueq.jpeg"></p><br><p>  Pode-se concluir que os testes geralmente consistem nos mesmos est√°gios: prepara√ß√£o de entrada, execu√ß√£o de c√≥digo e asser√ß√£o de resultado.  Podemos usar esse fato para nos livrar do <strong>primeiro problema de nossos testes</strong> , ou seja, de forma excessivamente liberal, dividindo explicitamente o corpo de um teste em etapas.  Essa id√©ia n√£o √© nova, como pode ser vista nos testes no estilo BDD ( <em>desenvolvimento orientado a comportamento</em> ). </p><br><p>  E quanto √† extensibilidade?  Qualquer etapa do processo de teste pode, por sua vez, conter qualquer quantidade de etapas intermedi√°rias.  Por exemplo, poder√≠amos dar um passo grande e complicado, como construir um equipamento e dividi-lo em v√°rios, encadeados um ap√≥s o outro.  Dessa forma, o processo de teste pode ser infinitamente extens√≠vel, mas, no final das contas, sempre consistindo nas mesmas poucas etapas gerais. </p><br><p><img src="https://habrastorage.org/webt/55/qf/zl/55qfzlhkl99txyyhizbvzg48yhs.jpeg"></p><br><h2 id="running-tests">  Executando testes </h2><br><p>  Vamos tentar implementar a ideia de dividir o teste em est√°gios, mas primeiro, devemos determinar que tipo de resultado gostar√≠amos de ver. </p><br><p>  No geral, gostar√≠amos de escrever e manter testes para se tornar menos trabalhoso e mais agrad√°vel.  Quanto menos instru√ß√µes expl√≠citas e n√£o exclusivas um teste tiver, menos altera√ß√µes dever√£o ser feitas ap√≥s a altera√ß√£o dos contratos ou refatora√ß√£o, e menos tempo levar√° para a leitura do teste.  O design do teste deve promover a reutiliza√ß√£o de trechos de c√≥digo comuns e desencorajar c√≥pias e colagens irracionais.  Tamb√©m seria bom se os testes tivessem uma forma unificada.  A previsibilidade melhora a legibilidade e economiza tempo.  Por exemplo, imagine quanto tempo levaria mais tempo para os cientistas aspirantes aprenderem todas as f√≥rmulas se os livros os escrevessem livremente em linguagem comum, em oposi√ß√£o √† matem√°tica. </p><br><p>  Assim, nosso objetivo √© ocultar qualquer coisa perturbadora e desnecess√°ria, deixando apenas o que √© criticamente importante para a compreens√£o: o que est√° sendo testado, quais s√£o as entradas e sa√≠das esperadas. </p><br><p>  Vamos voltar ao nosso modelo da estrutura do teste. </p><br><p><img src="https://habrastorage.org/webt/em/aa/rb/emaarb5ltmnme4-wpda0ebakueq.jpeg"></p><br><p>  Tecnicamente, todas as etapas podem ser representadas por um tipo de dados e cada transi√ß√£o - por uma fun√ß√£o.  √â poss√≠vel passar do tipo de dado inicial para o final, aplicando cada fun√ß√£o ao resultado do anterior.  Em outras palavras, usando a composi√ß√£o das fun√ß√µes de prepara√ß√£o de dados (vamos cham√°-lo de <code>prepare</code> ), execu√ß√£o de c√≥digo ( <code>execute</code> ) e verifica√ß√£o do resultado esperado ( <code>check</code> ).  A entrada para essa composi√ß√£o seria o primeiro passo - o acess√≥rio.  Vamos chamar a fun√ß√£o de ordem superior resultante como a fun√ß√£o de <strong>ciclo de vida</strong> do <strong>teste</strong> . </p><br><div class="spoiler">  <b class="spoiler_title">Teste a fun√ß√£o do ciclo de vida</b> <div class="spoiler_text"><pre> <code class="scala hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">runTestCycle</span></span></span></span>[<span class="hljs-type"><span class="hljs-type">FX</span></span>, <span class="hljs-type"><span class="hljs-type">DEP</span></span>, <span class="hljs-type"><span class="hljs-type">OUT</span></span>, <span class="hljs-type"><span class="hljs-type">F</span></span>[_]]( fixture: <span class="hljs-type"><span class="hljs-type">FX</span></span>, prepare: <span class="hljs-type"><span class="hljs-type">FX</span></span> =&gt; <span class="hljs-type"><span class="hljs-type">DEP</span></span>, execute: <span class="hljs-type"><span class="hljs-type">DEP</span></span> =&gt; <span class="hljs-type"><span class="hljs-type">OUT</span></span>, check: <span class="hljs-type"><span class="hljs-type">OUT</span></span> =&gt; <span class="hljs-type"><span class="hljs-type">F</span></span>[<span class="hljs-type"><span class="hljs-type">Assertion</span></span>] ): <span class="hljs-type"><span class="hljs-type">F</span></span>[<span class="hljs-type"><span class="hljs-type">Assertion</span></span>] = <span class="hljs-comment"><span class="hljs-comment">// In Scala instead of writing check(execute(prepare(fixture))) // one can use a more readable version using the andThen function: (prepare andThen execute andThen check) (fixture)</span></span></code> </pre> </div></div><br><p>  Surge uma quest√£o: de onde v√™m essas fun√ß√µes?  Bem, quanto √† prepara√ß√£o de dados, h√° apenas uma quantidade limitada de maneiras de faz√™-lo - preenchendo um banco de dados, zombando etc.  Portanto, √© √∫til escrever variantes especializadas da fun√ß√£o de <code>prepare</code> compartilhada em todos os testes.  Como resultado, seria mais f√°cil criar fun√ß√µes especializadas no ciclo de vida do teste para cada caso, o que ocultaria implementa√ß√µes concretas da prepara√ß√£o de dados.  Como a execu√ß√£o e as asser√ß√µes de c√≥digo s√£o mais ou menos exclusivas para cada teste (ou grupo de testes), a <code>execute</code> e a <code>check</code> devem ser escritas sempre explicitamente. </p><br><div class="spoiler">  <b class="spoiler_title">Fun√ß√£o de ciclo de vida de teste adaptada para teste de integra√ß√£o em um banco de dados</b> <div class="spoiler_text"><pre> <code class="scala hljs"><span class="hljs-comment"><span class="hljs-comment">// Sets up the fixture ‚Äî implemented separately def prepareDatabase[DB](db: Database): DbFixture =&gt; DB def testInDb[DB, OUT]( fixture: DbFixture, execute: DB =&gt; OUT, check: OUT =&gt; Future[Assertion], db: Database = getDatabaseHandleFromSomewhere(), ): Future[Assertion] = runTestCycle(fixture, prepareDatabase(db), execute, check)</span></span></code> </pre> </div></div><br><p>  Ao delegar todas as nuances administrativas na fun√ß√£o do ciclo de vida do teste, temos a capacidade de estender o processo de teste sem tocar em nenhum teste.  Utilizando a composi√ß√£o da fun√ß√£o, podemos interferir em qualquer etapa do processo e extrair ou adicionar dados. </p><br><p>  Para ilustrar melhor as capacidades dessa abordagem, vamos resolver <strong>o segundo problema do nosso teste inicial</strong> - a falta de informa√ß√µes suplementares para identificar problemas.  Vamos adicionar o log de qualquer execu√ß√£o de c√≥digo que tenha retornado.  Nosso registro n√£o altera o tipo de dados;  produz apenas <em>um efeito colateral</em> - enviando uma mensagem para o console.  Ap√≥s o efeito colateral, retornamos como est√°. </p><br><div class="spoiler">  <b class="spoiler_title">Teste a fun√ß√£o do ciclo de vida com registro</b> <div class="spoiler_text"><pre> <code class="scala hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">logged</span></span></span></span>[<span class="hljs-type"><span class="hljs-type">T</span></span>](<span class="hljs-keyword"><span class="hljs-keyword">implicit</span></span> loggedT: <span class="hljs-type"><span class="hljs-type">Logged</span></span>[<span class="hljs-type"><span class="hljs-type">T</span></span>]): <span class="hljs-type"><span class="hljs-type">T</span></span> =&gt; <span class="hljs-type"><span class="hljs-type">T</span></span> = (that: <span class="hljs-type"><span class="hljs-type">T</span></span>) =&gt; { <span class="hljs-comment"><span class="hljs-comment">// By passing an instance of the Logged typeclass for T as an argument, // we get an ability to ‚Äúadd‚Äù behavior log() to the abstract ‚Äúthat‚Äù member. // More on typeclasses later on. loggedT.log(that) // We could even do: that.log() that // The object gets returned unaltered } def runTestCycle[FX, DEP, OUT, F[_]]( fixture: FX, prepare: FX =&gt; DEP, execute: DEP =&gt; OUT, check: OUT =&gt; F[Assertion] )(implicit loggedOut: Logged[OUT]): F[Assertion] = // Insert logged right after receiving the result - after execute() (prepare andThen execute andThen logged andThen check) (fixture)</span></span></code> </pre> </div></div><br><p>  Com essa altera√ß√£o simples, adicionamos o registro da sa√≠da do c√≥digo executado <strong>em todos os testes</strong> .  A vantagem dessas fun√ß√µes pequenas √© que elas s√£o f√°ceis de entender, compor e eliminar quando necess√°rio. </p><br><p><img src="https://habrastorage.org/webt/ti/2t/l9/ti2tl9pk8wkd4hp8pqevf74hdn4.jpeg"></p><br><p>  Como resultado, nosso teste agora se parece com o seguinte: </p><br><pre> <code class="scala hljs"><span class="hljs-keyword"><span class="hljs-keyword">val</span></span> fixture: <span class="hljs-type"><span class="hljs-type">SomeMagicalFixture</span></span> = ??? <span class="hljs-comment"><span class="hljs-comment">// Comes from somewhere else def runProductionCode(id: Int): Database =&gt; Double = (db: Database) =&gt; new SomeProductionLogic(db).calculatePrice(id) def checkResult(expected: Double): Double =&gt; Future[Assertion] = (result: Double) =&gt; result shouldBe expected // The creation and filling of Database is hidden in testInDb "If user's role is 'customer'" in testInDb( state = fixture, execute = runProductionCode(id = 1), check = checkResult(90) )</span></span></code> </pre> <br><p>  O corpo do teste tornou-se conciso, o equipamento e as verifica√ß√µes podem ser reutilizados em outros testes, e n√£o preparamos o banco de dados manualmente em nenhum outro lugar.  Apenas um pequeno problema permanece ... </p><br><h2 id="fixture-preparation">  Prepara√ß√£o do acess√≥rio </h2><br><p>  No c√≥digo acima, est√°vamos trabalhando com a suposi√ß√£o de que o acess√≥rio seria dado a n√≥s de algum lugar.  Como os dados s√£o o ingrediente cr√≠tico de testes simples e de manuten√ß√£o, precisamos abordar como faz√™-los facilmente. </p><br><p>  Suponha que nossa loja em teste tenha um banco de dados relacional de tamanho m√©dio t√≠pico (por uma quest√£o de simplicidade, neste exemplo ele possui apenas 4 tabelas, mas, na realidade, pode ter centenas).  Algumas tabelas t√™m dados referenciais, alguns - dados comerciais e tudo isso pode ser agrupado logicamente em uma ou mais entidades complexas.  As rela√ß√µes s√£o vinculadas <em>a chaves estrangeiras</em> ; para criar um <code>Bonus</code> , √© necess√°rio um <code>Package</code> , que por sua vez precisa de um <code>User</code> e assim por diante. </p><br><p><img src="https://habrastorage.org/webt/3z/of/sy/3zofsyjoygierusjtmlu_okrmh0.png"></p><br><p>  As solu√ß√µes alternativas e os hacks levam apenas √† inconsist√™ncia dos dados e, como resultado, a horas e horas de depura√ß√£o.  Por esse motivo, n√£o estamos fazendo altera√ß√µes no esquema de forma alguma. </p><br><p>  Poder√≠amos usar alguns m√©todos de produ√ß√£o para preench√™-lo, mas mesmo sob escrut√≠nio superficial, isso levanta muitas quest√µes dif√≠ceis.  O que preparar√° os dados nos testes para esse c√≥digo de produ√ß√£o?  Ter√≠amos que reescrever os testes se o contrato desse c√≥digo fosse alterado?  E se os dados vierem de algum outro lugar e n√£o houver m√©todos a serem usados?  Quantas solicita√ß√µes seriam necess√°rias para criar uma entidade que depende de muitas outras? </p><br><div class="spoiler">  <b class="spoiler_title">Preenchimento de banco de dados no teste inicial</b> <div class="spoiler_text"><pre> <code class="scala hljs">insertUser(db, id = <span class="hljs-number"><span class="hljs-number">1</span></span>, name = <span class="hljs-string"><span class="hljs-string">"test"</span></span>, role = <span class="hljs-string"><span class="hljs-string">"customer"</span></span>) insertPackage(db, id = <span class="hljs-number"><span class="hljs-number">1</span></span>, name = <span class="hljs-string"><span class="hljs-string">"test"</span></span>, userId = <span class="hljs-number"><span class="hljs-number">1</span></span>, status = <span class="hljs-string"><span class="hljs-string">"new"</span></span>) insertPackageItems(db, id = <span class="hljs-number"><span class="hljs-number">1</span></span>, packageId = <span class="hljs-number"><span class="hljs-number">1</span></span>, name = <span class="hljs-string"><span class="hljs-string">"test"</span></span>, price = <span class="hljs-number"><span class="hljs-number">30</span></span>) insertPackageItems(db, id = <span class="hljs-number"><span class="hljs-number">2</span></span>, packageId = <span class="hljs-number"><span class="hljs-number">1</span></span>, name = <span class="hljs-string"><span class="hljs-string">"test"</span></span>, price = <span class="hljs-number"><span class="hljs-number">20</span></span>) insertPackageItems(db, id = <span class="hljs-number"><span class="hljs-number">3</span></span>, packageId = <span class="hljs-number"><span class="hljs-number">1</span></span>, name = <span class="hljs-string"><span class="hljs-string">"test"</span></span>, price = <span class="hljs-number"><span class="hljs-number">40</span></span>)</code> </pre> </div></div><br><p>  Os m√©todos auxiliares dispersos, como os do nosso primeiro exemplo, s√£o o mesmo problema sob uma apar√™ncia diferente.  Eles colocam a responsabilidade de gerenciar depend√™ncias sobre n√≥s mesmos, o que estamos tentando evitar. </p><br><p>  Idealmente, gostar√≠amos de alguma estrutura de dados que apresentasse todo o estado do sistema de uma s√≥ vez.  Um candidato certo seria uma tabela (ou um <em>conjunto de dados</em> , como em PHP ou Python) que n√£o teria nada a mais, al√©m de campos cr√≠ticos para a l√≥gica de neg√≥cios.  Se isso mudar, manter os testes seria f√°cil: apenas mudamos os campos no conjunto de dados.  Exemplo: </p><br><pre> <code class="scala hljs"><span class="hljs-keyword"><span class="hljs-keyword">val</span></span> dataTable: <span class="hljs-type"><span class="hljs-type">Seq</span></span>[<span class="hljs-type"><span class="hljs-type">DataRow</span></span>] = <span class="hljs-type"><span class="hljs-type">Table</span></span>( (<span class="hljs-string"><span class="hljs-string">"Package ID"</span></span>, <span class="hljs-string"><span class="hljs-string">"Customer's role"</span></span>, <span class="hljs-string"><span class="hljs-string">"Item prices"</span></span>, <span class="hljs-string"><span class="hljs-string">"Bonus value"</span></span>, <span class="hljs-string"><span class="hljs-string">"Expected final price"</span></span>) , (<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-string"><span class="hljs-string">"customer"</span></span>, <span class="hljs-type"><span class="hljs-type">Vector</span></span>(<span class="hljs-number"><span class="hljs-number">40</span></span>, <span class="hljs-number"><span class="hljs-number">20</span></span>, <span class="hljs-number"><span class="hljs-number">30</span></span>) , <span class="hljs-type"><span class="hljs-type">Vector</span></span>.empty , <span class="hljs-number"><span class="hljs-number">90.0</span></span>) , (<span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-string"><span class="hljs-string">"customer"</span></span>, <span class="hljs-type"><span class="hljs-type">Vector</span></span>(<span class="hljs-number"><span class="hljs-number">250</span></span>) , <span class="hljs-type"><span class="hljs-type">Vector</span></span>.empty , <span class="hljs-number"><span class="hljs-number">225.0</span></span>) , (<span class="hljs-number"><span class="hljs-number">3</span></span>, <span class="hljs-string"><span class="hljs-string">"customer"</span></span>, <span class="hljs-type"><span class="hljs-type">Vector</span></span>(<span class="hljs-number"><span class="hljs-number">100</span></span>, <span class="hljs-number"><span class="hljs-number">120</span></span>, <span class="hljs-number"><span class="hljs-number">30</span></span>) , <span class="hljs-type"><span class="hljs-type">Vector</span></span>(<span class="hljs-number"><span class="hljs-number">40</span></span>) , <span class="hljs-number"><span class="hljs-number">210.0</span></span>) , (<span class="hljs-number"><span class="hljs-number">4</span></span>, <span class="hljs-string"><span class="hljs-string">"customer"</span></span>, <span class="hljs-type"><span class="hljs-type">Vector</span></span>(<span class="hljs-number"><span class="hljs-number">100</span></span>, <span class="hljs-number"><span class="hljs-number">120</span></span>, <span class="hljs-number"><span class="hljs-number">30</span></span>, <span class="hljs-number"><span class="hljs-number">100</span></span>) , <span class="hljs-type"><span class="hljs-type">Vector</span></span>(<span class="hljs-number"><span class="hljs-number">20</span></span>, <span class="hljs-number"><span class="hljs-number">20</span></span>) , <span class="hljs-number"><span class="hljs-number">279.0</span></span>) , (<span class="hljs-number"><span class="hljs-number">5</span></span>, <span class="hljs-string"><span class="hljs-string">"vip"</span></span> , <span class="hljs-type"><span class="hljs-type">Vector</span></span>(<span class="hljs-number"><span class="hljs-number">100</span></span>, <span class="hljs-number"><span class="hljs-number">120</span></span>, <span class="hljs-number"><span class="hljs-number">30</span></span>, <span class="hljs-number"><span class="hljs-number">100</span></span>, <span class="hljs-number"><span class="hljs-number">50</span></span>), <span class="hljs-type"><span class="hljs-type">Vector</span></span>(<span class="hljs-number"><span class="hljs-number">10</span></span>, <span class="hljs-number"><span class="hljs-number">20</span></span>, <span class="hljs-number"><span class="hljs-number">10</span></span>), <span class="hljs-number"><span class="hljs-number">252.0</span></span>) )</code> </pre> <br><p><img src="https://habrastorage.org/webt/5j/dt/2p/5jdt2pdn7hdzhepaut_bhukkcgm.jpeg"></p><br><p>  Da nossa tabela, criamos <em>chaves</em> - links de entidade por ID.  Se uma entidade depende de outra, uma chave para essa outra entidade tamb√©m √© criada.  Pode acontecer que duas entidades diferentes criem uma depend√™ncia com o mesmo ID, o que pode levar a <em>uma viola√ß√£o da chave prim√°ria</em> .  No entanto, nesse est√°gio, √© incrivelmente barato desduplicar chaves - como tudo o que elas cont√™m s√£o IDs, podemos coloc√°-las em uma cole√ß√£o que desduplica para n√≥s, por exemplo, um <code>Set</code> .  Se isso for insuficiente, sempre podemos implementar a desduplica√ß√£o mais inteligente como uma fun√ß√£o separada e compor na fun√ß√£o de ciclo de vida do teste. </p><br><div class="spoiler">  <b class="spoiler_title">Chaves (exemplo)</b> <div class="spoiler_text"><pre> <code class="scala hljs"><span class="hljs-keyword"><span class="hljs-keyword">sealed</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">trait</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Key</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">case</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PackageKey</span></span></span><span class="hljs-class">(</span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">id: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Int</span></span></span></span><span class="hljs-class"><span class="hljs-params">, userId: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Int</span></span></span></span></span><span class="hljs-class">) </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Key</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">case</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PackageItemKey</span></span></span><span class="hljs-class">(</span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">id: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Int</span></span></span></span><span class="hljs-class"><span class="hljs-params">, packageId: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Int</span></span></span></span></span><span class="hljs-class">) </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Key</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">case</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">UserKey</span></span></span><span class="hljs-class">(</span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">id: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Int</span></span></span></span></span><span class="hljs-class">) </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Key</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">case</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BonusKey</span></span></span><span class="hljs-class">(</span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">id: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Int</span></span></span></span><span class="hljs-class"><span class="hljs-params">, packageId: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Int</span></span></span></span></span><span class="hljs-class">) </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Key</span></span></span></span></code> </pre> </div></div><br><p>  A gera√ß√£o de dados falsos para campos (por exemplo, nomes) √© delegada em uma classe separada.  Posteriormente, usando essa classe e regras de convers√£o para chaves, obtemos os objetos Row destinados √† inser√ß√£o no banco de dados. </p><br><div class="spoiler">  <b class="spoiler_title">Linhas (exemplo)</b> <div class="spoiler_text"><pre> <code class="scala hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">object</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SampleData</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">name</span></span></span></span>: <span class="hljs-type"><span class="hljs-type">String</span></span> = <span class="hljs-string"><span class="hljs-string">"test name"</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">role</span></span></span></span>: <span class="hljs-type"><span class="hljs-type">String</span></span> = <span class="hljs-string"><span class="hljs-string">"customer"</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">price</span></span></span></span>: <span class="hljs-type"><span class="hljs-type">Int</span></span> = <span class="hljs-number"><span class="hljs-number">1000</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">bonusAmount</span></span></span></span>: <span class="hljs-type"><span class="hljs-type">Int</span></span> = <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">status</span></span></span></span>: <span class="hljs-type"><span class="hljs-type">String</span></span> = <span class="hljs-string"><span class="hljs-string">"new"</span></span> } <span class="hljs-keyword"><span class="hljs-keyword">sealed</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">trait</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Row</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">case</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PackageRow</span></span></span><span class="hljs-class">(</span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">id: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Int</span></span></span></span><span class="hljs-class"><span class="hljs-params">, name: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">String</span></span></span></span><span class="hljs-class"><span class="hljs-params">, userId: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Int</span></span></span></span><span class="hljs-class"><span class="hljs-params">, status: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">String</span></span></span></span></span><span class="hljs-class">) </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Row</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">case</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PackageItemRow</span></span></span><span class="hljs-class">(</span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">id: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Int</span></span></span></span><span class="hljs-class"><span class="hljs-params">, packageId: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Int</span></span></span></span><span class="hljs-class"><span class="hljs-params">, name: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">String</span></span></span></span><span class="hljs-class"><span class="hljs-params">, price: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Int</span></span></span></span></span><span class="hljs-class">) </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Row</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">case</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">UserRow</span></span></span><span class="hljs-class">(</span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">id: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Int</span></span></span></span><span class="hljs-class"><span class="hljs-params">, name: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">String</span></span></span></span><span class="hljs-class"><span class="hljs-params">, role: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">String</span></span></span></span></span><span class="hljs-class">) </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Row</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">case</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BonusRow</span></span></span><span class="hljs-class">(</span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">id: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Int</span></span></span></span><span class="hljs-class"><span class="hljs-params">, packageId: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Int</span></span></span></span><span class="hljs-class"><span class="hljs-params">, bonusAmount: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Int</span></span></span></span></span><span class="hljs-class">) </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Row</span></span></span></span></code> </pre> </div></div><br><p>  Como os dados falsos geralmente n√£o s√£o suficientes, precisamos de uma maneira de substituir campos espec√≠ficos.  Felizmente, as <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">lentes</a> s√£o exatamente o que precisamos - podemos us√°-las para percorrer todas as linhas criadas e alterar apenas os campos de que precisamos.  Como as lentes s√£o fun√ß√µes disfar√ßadas, podemos compor como sempre, que √© o ponto mais forte. </p><br><div class="spoiler">  <b class="spoiler_title">Lense (exemplo)</b> <div class="spoiler_text"><pre> <code class="scala hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">changeUserRole</span></span></span></span>(userId: <span class="hljs-type"><span class="hljs-type">Int</span></span>, newRole: <span class="hljs-type"><span class="hljs-type">String</span></span>): <span class="hljs-type"><span class="hljs-type">Set</span></span>[<span class="hljs-type"><span class="hljs-type">Row</span></span>] =&gt; <span class="hljs-type"><span class="hljs-type">Set</span></span>[<span class="hljs-type"><span class="hljs-type">Row</span></span>] = (rows: <span class="hljs-type"><span class="hljs-type">Set</span></span>[<span class="hljs-type"><span class="hljs-type">Row</span></span>]) =&gt; rows.modifyAll(_.each.when[<span class="hljs-type"><span class="hljs-type">UserRow</span></span>]) .using(r =&gt; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (r.id == userId) r.modify(_.role).setTo(newRole) <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> r)</code> </pre> </div></div><br><p>  Gra√ßas √† composi√ß√£o, podemos aplicar diferentes otimiza√ß√µes e melhorias dentro do processo: por exemplo, podemos agrupar linhas pela tabela para inseri-las com um √∫nico <code>INSERT</code> para reduzir o tempo de execu√ß√£o do teste ou registrar todo o estado do banco de dados. </p><br><div class="spoiler">  <b class="spoiler_title">Fun√ß√£o de prepara√ß√£o do aparelho</b> <div class="spoiler_text"><pre> <code class="scala hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">makeFixture</span></span></span></span>[<span class="hljs-type"><span class="hljs-type">STATE</span></span>, <span class="hljs-type"><span class="hljs-type">FX</span></span>, <span class="hljs-type"><span class="hljs-type">ROW</span></span>, <span class="hljs-type"><span class="hljs-type">F</span></span>[_]]( state: <span class="hljs-type"><span class="hljs-type">STATE</span></span>, applyOverrides: <span class="hljs-type"><span class="hljs-type">F</span></span>[<span class="hljs-type"><span class="hljs-type">ROW</span></span>] =&gt; <span class="hljs-type"><span class="hljs-type">F</span></span>[<span class="hljs-type"><span class="hljs-type">ROW</span></span>] = x =&gt; x ): <span class="hljs-type"><span class="hljs-type">FX</span></span> = (extractKeys andThen deduplicateKeys andThen enrichWithSampleData andThen applyOverrides andThen logged andThen buildFixture) (state)</code> </pre> </div></div><br><p>  Finalmente, a coisa toda nos fornece um suporte.  No teste em si, nada extra √© mostrado, exceto o conjunto de dados inicial - todos os detalhes s√£o ocultados pela composi√ß√£o da fun√ß√£o. </p><br><p><img src="https://habrastorage.org/webt/b3/wz/cq/b3wzcqmqj3gomn-s-zycrakuegy.jpeg"></p><br><p>  Nosso conjunto de testes agora fica assim: </p><br><pre> <code class="scala hljs"><span class="hljs-keyword"><span class="hljs-keyword">val</span></span> dataTable: <span class="hljs-type"><span class="hljs-type">Seq</span></span>[<span class="hljs-type"><span class="hljs-type">DataRow</span></span>] = <span class="hljs-type"><span class="hljs-type">Table</span></span>( (<span class="hljs-string"><span class="hljs-string">"Package ID"</span></span>, <span class="hljs-string"><span class="hljs-string">"Customer's role"</span></span>, <span class="hljs-string"><span class="hljs-string">"Item prices"</span></span>, <span class="hljs-string"><span class="hljs-string">"Bonus value"</span></span>, <span class="hljs-string"><span class="hljs-string">"Expected final price"</span></span>) , (<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-string"><span class="hljs-string">"customer"</span></span>, <span class="hljs-type"><span class="hljs-type">Vector</span></span>(<span class="hljs-number"><span class="hljs-number">40</span></span>, <span class="hljs-number"><span class="hljs-number">20</span></span>, <span class="hljs-number"><span class="hljs-number">30</span></span>) , <span class="hljs-type"><span class="hljs-type">Vector</span></span>.empty , <span class="hljs-number"><span class="hljs-number">90.0</span></span>) , (<span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-string"><span class="hljs-string">"customer"</span></span>, <span class="hljs-type"><span class="hljs-type">Vector</span></span>(<span class="hljs-number"><span class="hljs-number">250</span></span>) , <span class="hljs-type"><span class="hljs-type">Vector</span></span>.empty , <span class="hljs-number"><span class="hljs-number">225.0</span></span>) , (<span class="hljs-number"><span class="hljs-number">3</span></span>, <span class="hljs-string"><span class="hljs-string">"customer"</span></span>, <span class="hljs-type"><span class="hljs-type">Vector</span></span>(<span class="hljs-number"><span class="hljs-number">100</span></span>, <span class="hljs-number"><span class="hljs-number">120</span></span>, <span class="hljs-number"><span class="hljs-number">30</span></span>) , <span class="hljs-type"><span class="hljs-type">Vector</span></span>(<span class="hljs-number"><span class="hljs-number">40</span></span>) , <span class="hljs-number"><span class="hljs-number">210.0</span></span>) , (<span class="hljs-number"><span class="hljs-number">4</span></span>, <span class="hljs-string"><span class="hljs-string">"customer"</span></span>, <span class="hljs-type"><span class="hljs-type">Vector</span></span>(<span class="hljs-number"><span class="hljs-number">100</span></span>, <span class="hljs-number"><span class="hljs-number">120</span></span>, <span class="hljs-number"><span class="hljs-number">30</span></span>, <span class="hljs-number"><span class="hljs-number">100</span></span>) , <span class="hljs-type"><span class="hljs-type">Vector</span></span>(<span class="hljs-number"><span class="hljs-number">20</span></span>, <span class="hljs-number"><span class="hljs-number">20</span></span>) , <span class="hljs-number"><span class="hljs-number">279.0</span></span>) , (<span class="hljs-number"><span class="hljs-number">5</span></span>, <span class="hljs-string"><span class="hljs-string">"vip"</span></span> , <span class="hljs-type"><span class="hljs-type">Vector</span></span>(<span class="hljs-number"><span class="hljs-number">100</span></span>, <span class="hljs-number"><span class="hljs-number">120</span></span>, <span class="hljs-number"><span class="hljs-number">30</span></span>, <span class="hljs-number"><span class="hljs-number">100</span></span>, <span class="hljs-number"><span class="hljs-number">50</span></span>), <span class="hljs-type"><span class="hljs-type">Vector</span></span>(<span class="hljs-number"><span class="hljs-number">10</span></span>, <span class="hljs-number"><span class="hljs-number">20</span></span>, <span class="hljs-number"><span class="hljs-number">10</span></span>), <span class="hljs-number"><span class="hljs-number">252.0</span></span>) ) <span class="hljs-string"><span class="hljs-string">"If the buyer's role is"</span></span> - { <span class="hljs-string"><span class="hljs-string">"a customer"</span></span> - { <span class="hljs-string"><span class="hljs-string">"And the total price of items"</span></span> - { <span class="hljs-string"><span class="hljs-string">"&lt; 250 after applying bonuses - no discount"</span></span> - { <span class="hljs-string"><span class="hljs-string">"(case: no bonuses)"</span></span> in calculatePriceFor(dataTable, <span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-string"><span class="hljs-string">"(case: has bonuses)"</span></span> in calculatePriceFor(dataTable, <span class="hljs-number"><span class="hljs-number">3</span></span>) } <span class="hljs-string"><span class="hljs-string">"&gt;= 250 after applying bonuses"</span></span> - { <span class="hljs-string"><span class="hljs-string">"If there are no bonuses - 10% off on the subtotal"</span></span> in calculatePriceFor(dataTable, <span class="hljs-number"><span class="hljs-number">2</span></span>) <span class="hljs-string"><span class="hljs-string">"If there are bonuses - 10% off on the subtotal after applying bonuses"</span></span> in calculatePriceFor(dataTable, <span class="hljs-number"><span class="hljs-number">4</span></span>) } } } <span class="hljs-string"><span class="hljs-string">"a vip - then they get a 20% off before applying bonuses and then all the other rules apply"</span></span> in calculatePriceFor(dataTable, <span class="hljs-number"><span class="hljs-number">5</span></span>) }</code> </pre> <br><p>  E o c√≥digo auxiliar: </p><br><div class="spoiler">  <b class="spoiler_title">C√≥digo auxiliar</b> <div class="spoiler_text"><pre> <code class="scala hljs"><span class="hljs-comment"><span class="hljs-comment">// Reusable test's body def calculatePriceFor(table: Seq[DataRow], idx: Int) = testInDb( state = makeState(table.row(idx)), execute = runProductionCode(table.row(idx)._1), check = checkResult(table.row(idx)._5) ) def makeState(row: DataRow): Logger =&gt; DbFixture = { val items: Map[Int, Int] = ((1 to row._3.length) zip row._3).toMap val bonuses: Map[Int, Int] = ((1 to row._4.length) zip row._4).toMap MyFixtures.makeFixture( state = PackageRelationships .minimal(id = row._1, userId = 1) .withItems(items.keys) .withBonuses(bonuses.keys), overrides = changeRole(userId = 1, newRole = row._2) andThen items.map { case (id, newPrice) =&gt; changePrice(id, newPrice) }.foldPls andThen bonuses.map { case (id, newBonus) =&gt; changeBonus(id, newBonus) }.foldPls ) } def runProductionCode(id: Int): Database =&gt; Double = (db: Database) =&gt; new SomeProductionLogic(db).calculatePrice(id) def checkResult(expected: Double): Double =&gt; Future[Assertion] = (result: Double) =&gt; result shouldBe expected</span></span></code> </pre></div></div><br><p>  Adicionar novos casos de teste √† tabela √© uma tarefa trivial que nos concentra em <strong>cobrir mais casos marginais</strong> e n√£o em escrever c√≥digo padr√£o. </p><br><h2 id="reusing-fixture-preparation-on-different-projects">  Reutilizando a prepara√ß√£o do acess√≥rio em diferentes projetos </h2><br><p>  Ok, escrevemos muito c√≥digo para preparar equipamentos em um projeto espec√≠fico, gastando bastante tempo no processo.  E se tivermos v√°rios projetos?  Estamos fadados a reinventar a coisa toda do zero toda vez? </p><br><p>  Podemos abstrair a prepara√ß√£o do dispositivo el√©trico sobre um modelo de dom√≠nio concreto.  No mundo da programa√ß√£o funcional, existe um conceito de <em>tipeclasses</em> .  Sem se aprofundar nos detalhes, eles n√£o s√£o como classes no OOP, mas mais como interfaces, pois definem um determinado comportamento de algum grupo de tipos.  A diferen√ßa fundamental √© que eles n√£o s√£o herdados, mas instanciados como vari√°veis.  No entanto, semelhante √† heran√ßa, a resolu√ß√£o de inst√¢ncias de classe de tipo ocorre <em>em tempo de compila√ß√£o</em> .  Nesse sentido, as classes de tipo podem ser entendidas como <em>m√©todos de extens√£o</em> do <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Kotlin</a> e <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">C #</a> . </p><br><p>  Para registrar um objeto, n√£o precisamos saber o que h√° dentro, quais campos e m√©todos ele possui.  Tudo o que importa √© ter um <code>log()</code> comportamento <code>log()</code> com uma assinatura espec√≠fica.  Estender todas as classes com uma interface de <code>Logged</code> seria extremamente tedioso e, mesmo assim, n√£o seria poss√≠vel em muitos casos - por exemplo, para bibliotecas ou classes padr√£o.  Com tipeclasses, isso √© muito mais f√°cil.  Podemos criar uma inst√¢ncia de uma classe chamada <code>Logged</code> , por exemplo, para um equipamento registr√°-lo em um formato leg√≠vel por humanos.  Para todo o resto que n√£o tenha uma inst√¢ncia de <code>Logged</code> , podemos fornecer um fallback: uma inst√¢ncia para o tipo <code>Any</code> que usa um m√©todo padr√£o <code>toString()</code> para registrar todos os objetos em sua representa√ß√£o interna gratuitamente. </p><br><div class="spoiler">  <b class="spoiler_title">Um exemplo da classe de tipo Logged e suas inst√¢ncias</b> <div class="spoiler_text"><pre> <code class="scala hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">trait</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Logged</span></span></span><span class="hljs-class">[</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">A</span></span></span><span class="hljs-class">] </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">log</span></span></span></span>(a: <span class="hljs-type"><span class="hljs-type">A</span></span>)(<span class="hljs-keyword"><span class="hljs-keyword">implicit</span></span> logger: <span class="hljs-type"><span class="hljs-type">Logger</span></span>): <span class="hljs-type"><span class="hljs-type">A</span></span> } <span class="hljs-comment"><span class="hljs-comment">// For all Futures implicit def futureLogged[T]: Logged[Future[T]] = new Logged[Future[T]] { override def log(futureT: Future[T])(implicit logger: Logger): Future[T] = { futureT.map { t =&gt; // map on a Future lets us modify its result after it finishes logger.info(t.toString()) t } } } // Fallback in case there are no suitable implicits in scope implicit def anyNoLogged[T]: Logged[T] = new Logged[T] { override def log(t: T)(implicit logger: Logger): T = { logger.info(t.toString()) t } }</span></span></code> </pre> </div></div><br><p>  Al√©m do registro, podemos usar essa abordagem durante todo o processo de fabrica√ß√£o de acess√≥rios.  Nossa solu√ß√£o prop√µe uma maneira abstrata de criar acess√≥rios de banco de dados e um conjunto de classes para acompanh√°-lo.  √â o projeto que utiliza a responsabilidade da solu√ß√£o implementar as inst√¢ncias dessas classes para que tudo funcione. </p><br><pre> <code class="scala hljs"><span class="hljs-comment"><span class="hljs-comment">// Fixture preparation function def makeFixture[STATE, FX, ROW, F[_]]( state: STATE, applyOverrides: F[ROW] =&gt; F[ROW] = x =&gt; x ): FX = (extractKeys andThen deduplicateKeys andThen enrichWithSampleData andThen applyOverrides andThen logged andThen buildFixture) (state) override def extractKeys(implicit toKeys: ToKeys[DbState]): DbState =&gt; Set[Key] = (db: DbState) =&gt; db.toKeys() override def enrichWithSampleData(implicit enrich: Enrich[Key]): Key =&gt; Set[Row] = (key: Key) =&gt; key.enrich() override def buildFixture(implicit insert: Insertable[Set[Row]]): Set[Row] =&gt; DbFixture = (rows: Set[Row]) =&gt; rows.insert() // Behavior of splitting something (eg a dataset) into keys trait ToKeys[A] { def toKeys(a: A): Set[Key] // Something =&gt; Set[Key] } // ...converting keys into rows trait Enrich[A] { def enrich(a: A): Set[Row] // Set[Key] =&gt; Set[Row] } // ...and inserting rows into the database trait Insertable[A] { def insert(a: A): DbFixture // Set[Row] =&gt; DbFixture } // To be implemented in our project (see the example at the end of the article) implicit val toKeys: ToKeys[DbState] = ??? implicit val enrich: Enrich[Key] = ??? implicit val insert: Insertable[Set[Row]] = ???</span></span></code> </pre> <br><p>  Ao projetar esta ferramenta de prepara√ß√£o de acess√≥rios, usei os <em>princ√≠pios</em> do <em>SOLID</em> como uma b√∫ssola para garantir que seja sustent√°vel e extens√≠vel: </p><br><ul><li>  <em>O princ√≠pio da responsabilidade √∫nica</em> : cada classe descreve um e apenas um comportamento de um tipo. </li><li>  <em>O Princ√≠pio Aberto / Fechado</em> : n√£o modificamos nenhuma das classes de produ√ß√£o;  em vez disso, os estendemos com inst√¢ncias de classes de tipo. </li><li>  <em>O Princ√≠pio da Substitui√ß√£o de Liskov</em> n√£o se aplica aqui, pois n√£o usamos heran√ßa. </li><li>  <em>O princ√≠pio de segrega√ß√£o de interface</em> : usamos muitas classes de tipos especializadas em oposi√ß√£o a globais. </li><li>  <em>Princ√≠pio da invers√£o de depend√™ncia</em> : a fun√ß√£o de prepara√ß√£o do equipamento n√£o depende de tipos concretos, mas de classes abstratas. </li></ul><br><p>  Depois de garantir que todos os princ√≠pios sejam atendidos, podemos assumir com seguran√ßa que nossa solu√ß√£o √© sustent√°vel e extens√≠vel o suficiente para ser usada em diferentes projetos. </p><br><p>  Depois de escrever a fun√ß√£o do ciclo de vida do teste e a solu√ß√£o para a prepara√ß√£o do dispositivo, que tamb√©m √© independente de um modelo de dom√≠nio concreto em qualquer aplicativo, estamos prontos para melhorar todos os testes restantes. </p><br><h2 id="bottom-line">  Bottom line </h2><br><p>  Mudamos do estilo tradicional de design de teste (passo a passo) para funcional.  O estilo passo a passo √© √∫til no in√≠cio e em projetos de tamanho menor, porque n√£o restringe os desenvolvedores e n√£o requer nenhum conhecimento especializado.  No entanto, quando a quantidade de testes se torna muito grande, esse estilo tende a cair.  Escrever testes no estilo funcional provavelmente n√£o resolver√° todos os seus problemas de teste, mas poder√° melhorar significativamente a escala e a manuten√ß√£o de testes em projetos, onde existem centenas ou milhares deles.  Testes escritos no estilo funcional acabam sendo mais concisos e focados nas coisas essenciais (como dados, c√≥digo sob teste e resultado esperado), n√£o nas etapas intermedi√°rias. </p><br><p>  Al√©m disso, exploramos o qu√£o poderosas podem ser a composi√ß√£o de fun√ß√µes e as classes de tipos na programa√ß√£o funcional.  Com a ajuda deles, √© bastante simples projetar solu√ß√µes com a capacidade de expans√£o e reutiliza√ß√£o em mente. </p><br><p>  Desde a ado√ß√£o do estilo, h√° v√°rios meses, nossa equipe teve que se esfor√ßar para se adaptar, mas no final, aproveitamos o resultado.  Novos testes s√£o gravados mais rapidamente, os logs tornam a vida muito mais confort√°vel e os conjuntos de dados s√£o √∫teis para verificar sempre que houver d√∫vidas sobre os meandros da l√≥gica.  Nossa equipe tem como objetivo mudar todos os testes para esse novo estilo gradualmente. </p><br><hr><br><p>  Link para a solu√ß√£o e um exemplo completo pode ser encontrado aqui: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Github</a> .  Divirta-se com seus testes! </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt465211/">https://habr.com/ru/post/pt465211/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt465189/index.html">Equipe de desenvolvimento de uma sprint de fluxo de trabalho</a></li>
<li><a href="../pt465191/index.html">Treinamento Cisco 200-125 CCNA v3.0. Dia 25. Estudo aprofundado do IPv6</a></li>
<li><a href="../pt465193/index.html">Construindo um projeto Android em um cont√™iner de docker</a></li>
<li><a href="../pt465203/index.html">Elefante corporativo</a></li>
<li><a href="../pt465209/index.html">Aprendemos os dados do passaporte de um indiv√≠duo pelo nome (se houver uma garantia)</a></li>
<li><a href="../pt465215/index.html">O que ler l√≠der de equipe e esta√ß√£o de servi√ßo: uma sele√ß√£o de 50 livros com notas e mais</a></li>
<li><a href="../pt465217/index.html">Acronis True Image 2020: Novos esquemas de replica√ß√£o e prote√ß√£o aprimorada</a></li>
<li><a href="../pt465221/index.html">Como os registros em 1C podem parecer na presen√ßa de OOP</a></li>
<li><a href="../pt465223/index.html">Como fazer uso pr√°tico da seguran√ßa do papel ou por que precisamos de conformidade com 152-–§–ó e PCI DSS em uma nuvem</a></li>
<li><a href="../pt465227/index.html">Realidade Aumentada no Varejo Online</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>