<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🔢 🐋 🥇 Cloudflare崩溃详细信息2019年7月2日 💕 🧦 🤷🏼</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="大约9年前，Cloudflare是一家小公司，但是我没有在其中工作，我只是一个客户。 在启动Cloudflare之后一个月，我收到了一条通知，说jgc.org 网站上的DNS似乎不起作用。 Cloudflare对协议缓冲区进行了更改，并且DNS损坏。 


 我立即写信给马修·普林斯（Matthew...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Cloudflare崩溃详细信息2019年7月2日</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/southbridge/blog/460863/"><p><img src="https://habrastorage.org/webt/dx/yb/5r/dxyb5rids6_8tahyhactypl4rwm.png"></p><br><p> 大约9年前，Cloudflare是一家小公司，但是我没有在其中工作，我只是一个客户。 在启动Cloudflare之后一个月，我收到了一条通知，说jgc.org <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">网站</a>上的DNS似乎不起作用。  Cloudflare对<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">协议缓冲区</a>进行了更改，并且DNS损坏。 </p><a name="habracut"></a><br><p> 我立即写信给马修·普林斯（Matthew Prince），标题为“我的DNS在哪里？”，他发送了一个很长的答案，其中包含技术细节（ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">请在此处阅读所有信函</a> ），我回答： </p><br><blockquote> 来自：约翰·格雷厄姆·卡明 <br> 日期：2010年10月7日9:14 <br> 主题：Re：我的DNS在哪里？ <br> 至：马修·普林斯 <br><br> 很酷的报告，谢谢。 如果有问题，我一定会打电话。 收集所有技术信息后，可能值得写一篇有关此的文章。 我认为人们会喜欢一个开放而诚实的故事。 特别是如果您在上面附加图形以显示启动后流量如何增长。 <br><br> 我在网站上进行了良好的监控，并且收到有关每个失败的SMS。 监视显示故障是从13:03:07到14:04:12。 每五分钟进行一次测试。 <br><br> 我相信您会弄清楚的。 您在欧洲绝对不需要自己的人吗？  :-) </blockquote><p> 他回答： </p><br><blockquote> 来自：马修·普林斯 <br> 日期：2010年10月7日，9：57 <br> 主题：Re：我的DNS在哪里？ <br> 致：约翰·格雷厄姆·卡明（John Graham Cumming） <br><br> 谢谢啦 我们回答了所有写信的人。 我现在要去办公室，我们将在博客上写点东西或在公告板上发布正式帖子。 我完全同意，诚实是我们的一切。 </blockquote><p> 现在Cloudflare是一个非常大的公司，我在其中工作，现在我必须公开地写关于我们的错误，其后果和我们的行动。 </p><br><h3 id="sobytiya-2-iyulya">  7月2日活动 </h3><br><p>  7月2日，我们在WAF的托管规则中部署了一条新规则，由于该规则会在处理Cloudflare网络上的HTTP / HTTPS流量的每个处理器核心上<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">耗尽处理器资源</a> 。 我们不断改进WAF的托管规则，以应对新的漏洞和威胁。 例如，在5月，我们急着<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">添加一条规则</a>来保护自己免受SharePoint中的严重漏洞的侵害。 我们WAF的重点在于能够快速，全局地部署规则。 </p><br><p> 不幸的是，上周四的更新包含一个正则表达式，该正则表达式在回溯上花费了过多的处理器资源专用于HTTP / HTTPS。 这影响了我们的核心代理，CDN和WAF功能。 该图显示，在我们网络中的服务器上，用于服务HTTP / HTTPS流量的处理器资源几乎达到100％。 </p><br><p> <a href=""><img src="https://habrastorage.org/webt/au/xp/dz/auxpdz0pbethhc_hka-nvzmmsmo.png"></a> <br>  <em>在事件发生时在存在点之一使用处理器资源</em> </p><br><p> 结果，我们的客户（以及我们客户的客户）在Cloudflare域中遇到了502错误的页面。  Cloudflare前端Web服务器生成了502个错误，这些前端Web服务器仍然具有免费的内核，但是它们无法与处理HTTP / HTTPS流量的进程进行通信。 </p><br><p><img src="https://habrastorage.org/webt/mn/36/v_/mn36v_x1bbtqofu8l9lzpjty-pm.png"></p><br><p> 我们知道这给我们的客户带来了多少不便。 我们非常as愧。 这种失败使我们无法有效地处理这一事件。 </p><br><p>如果您是这些客户之一，它可能会让您感到恐惧，愤怒和不安。 此外，我们已经6年没有发生<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">全球性故障</a>了。  CPU使用率高是由于一个WAF规则的正则表达式编写得不好，导致过多的回溯。 这是有罪的表达式： <code>(?:(?:\"|'|\]|\}|\\|\d|(?:nan|infinity|true|false|null|undefined|symbol|math)|\`|\-|\+)+[)]*;?((?:\s|-|~|!|{}|\|\||\+)*.*(?:.*=.*)))</code> </p><br><p> 尽管它本身很有趣（我将在下面向您详细介绍），但Cloudflare服务被切断了27分钟，这不仅是因为不适合使用正则表达式。 我们花了一些时间描述导致失败的事件的顺序，因此我们没有迅速做出响应。 在文章的结尾，我将以正则表达式描述回溯并告诉您如何做。 </p><br><h3 id="chto-sluchilos"> 发生什么事了 </h3><br><p> 让我们按顺序开始。 所有时间都以UTC表示。 </p><br><p> 在13:42，防火墙团队的工程师对使用自动过程检测<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">XSS</a>的规则进行了少量更改。 因此，创建了变更请求票证。 我们通过吉拉（以下屏幕截图）管理这些票证。 </p><br><p>  3分钟后，出现第一个PagerDuty页面，报告WAF问题。 这是一项综合测试，用于检查Cloudflare之外的WAF（我们有数百个）功能，以监视正常运行。 然后立即有页面通知Cloudflare服务的其他端到端测试失败，全球流量问题，广泛的502错误以及来自我们在世界各地城市的服务点（PoP）发出的大量报告，这些信息表明处理器资源不足。 </p><br><p><img src="https://habrastorage.org/webt/fh/iw/ja/fhiwjas8c3-qfcwo-11nks3lld4.png"></p><br><p><img src="https://habrastorage.org/webt/fs/g7/xo/fsg7xokybw-svzn8tn-uyhuj7dm.jpeg"></p><br><p> 当我的解决方案开发部门负责人说我们丢失了80％的流量时，我收到了几条这样的通知，从会议上摔下来，已经走到桌子旁。 我遇到了已经在解决此问题的SRE工程师。 最初，我们认为这是某种未知的攻击。 </p><br><p><img src="https://habrastorage.org/webt/-r/ox/mw/-roxmwj33bvn_n-xyww8xhfwpmw.jpeg"></p><br><p>  Cloudflare SRE工程师遍布世界各地，并全天候监控情况。 通常，此类警报会通知您有限范围内的特定本地问题，在内部仪表板上进行监视，并且每天会被解决多次。 但是这样的页面和通知表明确实很严重，SRE工程师立即宣布了P0严重性级别，并求助于管理和系统工程师。 </p><br><p> 那时我们的伦敦工程师正在大厅听演讲。 演讲必须中断，每个人都聚集在一个大会议室中，并邀请了更多的专家。 这不是SRE可以自行解决的常见问题。 迫切需要联系合适的专家。 </p><br><p> 在14:00，我们确定WAF存在问题，并且没有攻击。 绩效部门检索了处理器数据，很明显是WAF的罪魁祸首。 另一位合作者通过strace证实了这一理论。 有人在日志中看到了WAF的问题。 在14:02时，当有人提议使用全局kill时，整个团队都来找我-一种内置于Cloudflare中的机制，该机制禁用了全世界的一个组件。 </p><br><p> 我们如何对WAF进行全球杀戮是另外一回事。 这不是那么简单。 我们使用自己的产品，并且由于<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Access</a>服务无法正常工作，因此我们无法进行身份验证并进入内部控制面板（修复所有内容后，我们得知该团队的某些成员由于安全功能而失去了访问权限，如果在（请勿长时间使用内部控制面板）。 </p><br><p> 而且我们无法获得内部服务，例如Jira或构建系统。 我们需要一个不常用的解决方法（这也需要解决）。 最终，一名工程师能够在14:07切断WAF，并在14:09处的流量和处理器水平恢复正常。  Cloudflare的其余防御机制按预期工作。 </p><br><p> 然后，我们着手恢复WAF。 这种情况与众不同，因此我们在一个城市中使用单独的流量进行了负面测试（询问问题是否确实是这种变化）和正面（确保回滚有效），从那里转移了付费客户。 </p><br><p> 下午2时52分，我们确信我们已了解原因并进行了更正，然后再次打开WAF。 </p><br><h3 id="kak-rabotaet-cloudflare">  Cloudflare如何运作 </h3><br><p>  Cloudflare拥有一支工程师团队，负责管理WAF的托管规则。 他们试图提高检测率，减少误报的数量，并在出现新威胁时迅速做出反应。 在过去60天内，已处理476项针对WAF托管规则的变更请求（平均每3个小时提出一次）。 </p><br><p> 需要在仿真模式下部署此特定更改，在该模式下，实际的客户端流量会通过规则，但不会阻塞任何内容。 我们使用这种模式来检查规则的有效性，并衡量假阳性和假阴性结果的比例。 但是，即使在仿真模式下，规则也必须实际执行，在这种情况下，规则包含正则表达式会消耗过多的处理器资源。 </p><br><p> <a href=""><img src="https://habrastorage.org/webt/1p/sc/90/1psc90ccs9enwxvdyvu4thq30eo.png"></a> </p><br><p> 从上面的更改请求中可以看出，我们有一个部署计划，一个回滚计划，以及指向这种部署类型的内部标准操作过程（SOP）的链接。 更改规则的SOP允许您在全局范围内发布它。 实际上，在Cloudflare中，一切安排都完全不同，SOP要求首先将用于测试和内部使用的软件发送到内部存在点（PoP）（供我们的员工使用），然后发送给孤立地点的少量客户，然后再发送给大量客户，然后全世界 </p><br><p> 这是它的外观。 我们通过BitBucket在内部系统中使用git。 变更工程师将他们生成的代码发送给TeamCity，并在生成通过时分配审阅者。 池请求获得批准后，将收集代码并再次进行一系列测试。 </p><br><p> 如果组装和测试成功，那么将在Jira中创建更改请求，并且更改必须由适当的主管或首席专家批准。 批准后，将部署到所谓的“ PoP监狱”：DOG，PIG和<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Canary</a> （狗，腮腺炎和金丝雀）。 </p><br><p>  DOG PoP是Cloudflare PoP（就像我们其他城市一样），仅Cloudflare员工使用。 内部使用的PoP使您甚至可以在解决方案开始接收客户流量之前发现问题。 有用的东西。 </p><br><p> 如果DOG测试成功，则代码进入PIG阶段（豚鼠）。 这是Cloudflare PoP，其中少量免费客户端流量通过新代码流动。 <br> 如果一切顺利，代码将转到Canary。 我们在世界不同地区拥有三个Canary PoP。 付费和免费客户的流量通过其中的新代码传递，这是最后的错误检查。 </p><br><p> <a href=""><img src="https://habrastorage.org/webt/ew/d_/0h/ewd_0hfzquucy07y15qbgbckaao.png"></a> <br>  <em>Cloudflare软件发布流程</em> </p><br><p> 如果该代码在Canary中还可以，我们将其释放。 经历所有阶段-DOG，PIG，Canary和整个世界-花费数小时或数天，具体取决于代码更改。 由于Cloudflare的网络和客户的多样性，我们在对所有客户进行全球发布之前都对代码进行了全面的测试。 但是WAF并没有特别遵循此过程，因为需要快速响应威胁。 </p><br><p> 威胁WAF <br> 在过去的几年中，常规应用中存在着明显更多的威胁。 这是由于软件测试工具的可用性更高。 例如，我们最近撰写了有关<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">fuzzing的文章</a> 。 </p><br><p><img src="https://habrastorage.org/webt/br/lu/mp/brlumpkugkwhpdfq3zb0fb5vixm.png"><br>  <em>资料来源： <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">https</a> : <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">//cvedetails.com/</a></em> </p><br><p> 通常，会创建该概念的确认并立即在Github上发布，以便为应用程序提供服务的团队可以对其进行快速测试，并确保对其进行了充分的保护。 因此，Cloudflare需要能够尽快响应新攻击的能力，以便客户有机会修复其软件。 </p><br><p>  Cloudflare快速响应的一个很好的例子是5月份部署SharePoint漏洞保护（请<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">参阅此处</a> ）。 广告发布后几乎立即，我们注意到进行了大量尝试来利用客户端的SharePoint安装中的漏洞。 我们的员工不断监视新的威胁并编写规则以保护我们的客户。 </p><br><p> 导致星期四发生此问题的规则是防止跨站点脚本（XSS）。 近年来也有更多此类攻击。 </p><br><p><img src="https://habrastorage.org/webt/tr/jy/oz/trjyozwk_k4raviofhzgeskwf2s.png"><br>  <em>资料来源： <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">https</a> : <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">//cvedetails.com/</a></em> </p><br><p> 修改WAF托管规则的标准过程需要在全局部署之前进行连续集成测试（CI）。 上周四，我们做到了，并扩大了规则。 在13:31，一位工程师发送了批准的池请求并进行了更改。 </p><br><p><img src="https://habrastorage.org/webt/uz/xj/jo/uzxjjo5648f52t8x-tnu66tuvku.png"></p><br><p> 在13：37，TeamCity收集了规则，进行了测试并批准了。  WAF测试套件测试WAF核心功能，并且包含针对单个功能的大量单元测试。 经过单元测试后，我们使用大量HTTP请求检查了WAF规则。  HTTP请求检查哪些请求应被WAF阻止（以拦截攻击），哪些请求可以被跳过（以不阻止所有请求并避免误报）。 但是我们没有进行过多使用处理器资源的测试，研究以前的WAF程序集的日志表明，使用该规则的测试执行时间没有增加，并且很难怀疑没有足够的资源。 </p><br><p> 测试通过了，TeamCity在13:42开始自动部署更改。 </p><br><p> <a href=""><img src="https://habrastorage.org/webt/8-/s2/gd/8-s2gd8pw8j5zhxukadhwh77xr4.png"></a> </p><br><h3 id="quicksilver"> 水银 </h3><br><p>  WAF规则解决了紧急消除威胁的问题，因此我们使用分布式键值对Quicksilver对其进行部署，Quicksilver可以在几秒钟内在全球范围内分布更改。 我们所有的客户在更改仪表板上或通过API的配置时都使用该技术，这正是由于有了它，我们才能以闪电般的速度响应更改。 </p><br><p> 我们讨论了一些关于Quicksilver的问题。 我们曾经将<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Kyoto Tycoon</a>用作键值对的全球分布式存储库，但是它存在操作问题，并且我们编写了在180多个城市中复制的存储库。 现在，借助Quicksilver，我们可以发送客户端配置更改，更新WAF规则并分发由Cloudflare Workers中的客户端编写的JavaScript代码。 </p><br><p> 从仪表板上的按钮或调用API到进行配置更改，配置只需几秒钟即可遍历世界。 客户喜欢这种速度设置。 而且，Workers为他们提供了几乎即时的全局软件部署。 平均而言，Quicksilver每秒分发约350次更改。 </p><br><p> 而且Quicksilver的速度非常快。 平均而言，我们将2.29秒的百分位数提高到了世界各地的每台计算机。 通常速度不错。 毕竟，当您打开一个功能或清除缓存时，它几乎立即发生在任何地方。 通过Cloudflare Workers发送代码的速度相同。  Cloudflare承诺在适当的时间为其客户提供快速更新。 </p><br><p> 但是在这种情况下，速度对我们起到了欺骗作用，规则在几秒钟之内到处改变。 您可能已经注意到WAF代码使用Lua。  Cloudflare在生产环境中广泛使用Lua，我们<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">已经</a> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">在WAF中</a> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">讨论了</a> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Lua</a> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">的</a>细节。  Lua WAF在内部使用<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">PCRE，</a>并应用回溯进行匹配。 它没有针对失控的表达式的防御机制。 在下文中，我将详细讨论这一点以及我们正在做什么。 </p><br><p> <a href=""><img src="https://habrastorage.org/webt/zd/qq/yo/zdqqyof00zszstm3indwngi26_8.png"></a> </p><br><p> 在部署规则之前，一切都进行得很顺利：创建并批准了池请求，CI / CD管道编译并测试了代码，根据SOP发送了更改请求，该请求对部署和回滚进行了规范，并完成了部署。 </p><br><p> <a href=""><img src="https://habrastorage.org/webt/5t/47/ar/5t47art0hduaaxywv3io5_71z8a.png"></a> <br>  <em>CloudFare WAF部署流程</em> </p><br><p> 出了什么问题 <br> 正如我之前所说，我们每周都会部署数十个新的WAF规则，并且我们有许多保护系统可以防止此类部署带来的负面影响。 当出现问题时，通常是几种情况的组合。 如果仅找到一个原因，那么这当然可以使人平静，但并非总是如此。 这是共同导致我们的HTTP / HTTPS服务失败的原因。 </p><br><ol><li> 工程师写了一个正则表达式，可能导致过多的<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">回溯</a> 。 </li><li> 在WAF重构之前几周，错误地删除了一个可以防止正则表达式占用过多处理器资源的工具-需要进行重构，以减少WAF消耗的资源。 </li><li> 正则表达式引擎不能保证复杂性。 </li><li> 测试套件无法显示过多的CPU消耗。 </li><li>  SOP程序无需进行多步骤，即可在全球范围内部署非紧急规则更改。 </li><li> 回滚计划需要两次完整的WAF组装，这花费了很长时间。 </li><li> 第一个全局交通警报警报工作太迟了。 </li><li> 我们延迟了状态页面的更新。 </li><li> 由于崩溃，我们在访问系统时遇到了问题，并且解决方法还不够完善。 </li><li>  SRE工程师无法访问某些系统，因为其凭据出于安全原因已过期。 </li><li> 我们的客户无法访问Cloudflare仪表板或API，因为他们要经过Cloudflare区域。 </li></ol><br><h3 id="chto-izmenilos-s-proshlogo-chetverga"> 自上周四以来发生了什么变化 </h3><br><p> 首先，我们完全停止了WAF发行版的所有工作，并执行以下操作： </p><br><ol><li> 重新引入针对我们删除的过多处理器资源的保护。  （完成） </li><li> 手动检查WAF托管规则中的所有3868条规则，以发现并修复其他潜在的过度回溯的情况。  （验证完成） </li><li> 我们在测试套件中包括对所有规则的性能分析。  （预计：7月19日） </li><li> 我们<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">切换</a>到<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">re2</a>或<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Rust</a> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">regex</a>引擎-两者都在运行时提供了保证。  （预计：7月31日） </li><li> 像Cloudflare中的其他软件一样，我们重写SOP以便分阶段部署规则，但同时，如果攻击已经开始，则可以紧急全局部署。 </li><li> 我们正在开发从Cloudflare区域紧急撤出Cloudflare仪表板和API的可能性。 </li><li> 我们正在自动更新<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Cloudflare状态</a>页面。 </li></ol><br><p> 从长远来看，我们将放弃我几年前写的Lua WAF。 我们将WAF迁移到<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">新的防火墙系统</a> 。 因此，WAF将更快，并获得额外的保护级别。 </p><br><h3 id="zaklyuchenie"> 结论 </h3><br><p> 此故障给我们和我们的客户带来麻烦。 我们迅速做出反应以纠正这种情况，现在我们正在研究导致失败的流程中的缺陷，并且我们正在进行更深的挖掘，以期将来通过使用新技术来保护自己免受正则表达式的潜在问题的影响。 </p><br><p> 我们为这次失败感到羞耻，并向客户表示歉意。 我们希望这些更改确保不会再次发生这种情况。 </p><br><h3 id="prilozhenie-bektreking-regulyarnyh-vyrazheniy"> 应用程序。 正则表达式回溯 </h3><br><p> 要了解表达方式： </p><br><pre> <code class="plaintext hljs">(?:(?:\"|'|\]|\}|\\|\d (?:nan|infinity|true|false|null|undefined|symbol|math)|\`|\- |\+)+[)]*;?((?:\s|-|~|!|{}|\|\||\+)*.*(?:.*=.*)))</code> </pre> <br><p> 吞噬了所有处理器资源，您需要对标准正则表达式引擎的工作原理有所了解。 这里的问题是模式<code>.*(?:.*=.*)</code> 。  <code>(?:</code>和对应的一个<code>)</code>不是一个令人兴奋的组（也就是说，括号中的表达式被分组为一个表达式）。 </p><br><p> 在处理器资源过度消耗的情况下，此模式可以指定为<code>.*.*=.*</code> 。 因此，该模式看起来不必要地复杂。 但更重要的是，在现实世界中，要求引擎先匹配一个片段然后再匹配另一个片段的此类表达式（类似于WAF规则中的复杂表达式）可能会导致灾难性的回溯。 这就是为什么。 </p><br><p><img src="https://habrastorage.org/webt/wr/7g/ec/wr7gec__o2lld5uwyz5ir6vfolm.png"></p><br><p> 正则表达式中<code>.</code> 表示您需要匹配一个字符， <code>.*</code> -“贪婪地”匹配零个或多个字符，即捕获最多的字符，因此<code>.*.*=.*</code>表示匹配零个或多个字符，然后匹配零个或多个字符，查找文字字符=，匹配零个或多个字符。 </p><br><p> 取测试线<code>x=x</code> 。 它与表达式<code>.*.*=.*. .*.*</code>相匹配<code>.*.*=.*. .*.*</code>  <code>.*.*=.*. .*.*</code>最多等号对应于第一个<code>x</code> （组中的一个<code>.*</code>对应于<code>x</code> ，第二个对应于零字符）。  <code>.*</code>之后=与最后一个<code>x</code>匹配。 </p><br><p> 为了进行这种比较，需要23个步骤。 第一组<code>.*</code> <code>.*.*=.*</code> “贪婪地”操作并匹配整行<code>x=x</code> 。 引擎移至下一组。 我们不再有要匹配的字符，因此第二组<code>.*</code>匹配零个字符（允许）。 然后，引擎转到<code>=</code>符号。 没有更多的字符（第一组<code>.*</code>使用整个表达式<code>x=x</code> ），不会发生匹配。 </p><br><p> 这里，正则表达式引擎返回到开头。 他进入第一组<code>.*</code>并将其<code> x=</code> （而不是<code>x=x</code> ）进行比较，然后进行第二组<code>.*</code> 。 第二组<code>.*</code>映射到第二个<code>x</code> ，我们再也没有字符了。 当引擎达到<code>=</code> v <code>.*.*=.*</code> ，什么也没有发生。 然后他再次回溯。 </p><br><p> 这次，组<code>.*</code>仍与<code>x=</code>匹配，但第二组<code>.*</code>不再是<code>x</code> ，而是零个字符。 引擎尝试在模式<code>.*.*=.*</code>找到文字符号<code>=</code> ，但不会退出（毕竟，第一组已经占据了它<code>.*</code> 。）。 然后他再次回溯。 </p><br><p> 这次是第一个组<code>.*</code>仅取第一个x。 但是第二组<code>.*</code> “贪婪”捕获<code>=x</code> 。 已经猜测会发生什么？ 引擎尝试匹配文字<code>=</code> ，失败并进行下一个回溯。 </p><br><p>   <code>.*</code>     <code>x</code> .  <code>.*</code>   <code>=</code> . ,      <code>=</code> ,       <code>.*</code> .   .         ! </p><br><p>     <code>.*</code>     <code>x</code> ,  <code>.*</code> —   ,      <code>=</code>   <code> =</code>  .    <code>.*</code>    <code>x</code> . </p><br><p> 23    <code>x=x</code> .      Perl <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Regexp::Debugger</a> ,  ,     . </p><br><p><img src="https://habrastorage.org/webt/a7/do/2n/a7do2nizluizhm1h2q2shajnvgs.gif"></p><br><p>    ,     <code>x=x</code>    <code>x=xx</code> ?  33 .   <code>x=xxx</code> ? 45.   .      <code>x=x</code>  <code>x=xxxxxxxxxxxxxxxxxxxx</code> (20 <code>x</code>  <code>=</code> ).    20 x  <code>=</code> ,     555 ! ( ,     <code>x=</code>      20 <code>x</code> ,   4067 ,  ,   ). </p><br><p><img src="https://habrastorage.org/webt/t-/1m/l4/t-1ml4up0y5w262eye_cyjmlik4.png"></p><br><p>         <code>x=xxxxxxxxxxxxxxxxxxxx</code> : </p><br><p><img src="https://habrastorage.org/webt/t8/oz/wq/t8ozwqwv1otujwl5_bebeglitpe.gif"></p><br><p>   ,         .      ,     . ,     <code>.*.*=.*</code> ; (         ). ,     ,  <code>foo=bar;</code>  。 </p><br><p>       .   <code>x=x</code>  90 ,   23.     .   <code>x=</code>  20 <code>x</code> ,  5353 .  .      <code>Y</code>     . </p><br><p><img src="https://habrastorage.org/webt/kn/n9/ex/knn9exewj9a48-fkxyayefzexeu.png"></p><br><p>  ,   5353    <code>x=xxxxxxxxxxxxxxxxxxxx</code>  <code>.*.*=.*;</code> </p><br><p><img src="https://habrastorage.org/webt/d3/gg/ra/d3ggrayopot2-l7vivzm0fqfnmq.gif"></p><br><p>   «»,   «» ,    .      <code>.*?.*?=.*?</code> ,   <code>x=x</code>  11  (  23).    <code>x=xxxxxxxxxxxxxxxxxxxx</code> .  ,  <code>?</code>  <code>.*</code>      ,    . </p><br><p>  «»      .     <code>.*.*=.*;</code>  <code>.*?.*?=.*?;</code> ,    . <code>x=x</code>    555 ,  <code>x=</code>  20 <code>x</code> — 5353. </p><br><p> ,    (      ) —         .        . </p><br><p>       1968 ,      <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Programming Techniques: Regular expression search algorithm</a> (« :    »).    ,         ,          ,        . </p><br><p> <a href=""><img src="https://habrastorage.org/webt/fd/nn/ri/fdnnril2lmr0udityqylanfzahk.png"></a> </p><br><blockquote> <strong>  <br>     <br>   (Ken Thompson)</strong> <br> Bell Telephone Laboratories, Inc., -,  - <br><br>                 .             IBM 7094    .               ,         .    ,   . <br><br> <strong></strong> <br>      ,       . <br><br>        .      .     —                  . <br>              . ,        . ,           . <br> ,           IBM 7094. <br><br> <strong></strong> <br>       .   —   ,       .       «·»    .         .      .  2  ,       . </blockquote><p>         ,           ALGOL-60,       IBM 7094.  ,     . </p><br><p> <a href=""><img src="https://habrastorage.org/webt/fx/se/9x/fxse9xv8le3pgp2quvsrufznvb8.png"></a> </p><br><blockquote>   .    ⊕      . <br>   1          .      — a, b, c,      S[i]   NNODE. <br><br> NNODE   ,          (. . 5) </blockquote><p>       <code>.*.*=.*</code> ,   ,      . </p><br><p><img src="https://habrastorage.org/webt/mt/_5/lc/mt_5lcklo-jw2x6zmt8nwjg8hpy.png"></p><br><p>  . 0   ,   0,  3 ,     1, 2  3.      <code>.*</code>   . 3      .    <code>=</code>    <code>=</code> .  4  .    ,    . </p><br><p>  ,           <code>.*.*=.*</code> ,     <code>x=x</code> .     0,    .  1。 </p><br><p><img src="https://habrastorage.org/webt/tx/a6/cl/txa6cltpurcbwxzrxk1v9ypkec4.png"></p><br><p>    ,        .        . </p><br><p>      ,       (1  2),    .  2。 </p><br><p><img src="https://habrastorage.org/webt/ve/pb/nj/vepbnjljx-0cinc-eapaz17mths.png"></p><br><p>  . 2 ,  ,     <code>x</code>  <code>x=x</code> . <code>x</code>     ,    1     1.  <code>x</code>     ,    2     2. </p><br><p>    <code>x</code>  <code>x=x</code>  -   1  2.      3  4,       <code>=</code> . </p><br><p>    <code>=</code>  <code>x=x</code> .   x  ,              1    1    2   2,        <code>=</code>     2   3 (  4).    .  3。 </p><br><p><img src="https://habrastorage.org/webt/0b/x8/7f/0bx87fp1aquszmn-wjp7ta3b4i0.png"></p><br><p>      <code>x</code>  <code>x=x</code> .   1  2        1  2.   3 <code>x</code>           3. </p><br><p>      <code>x=x</code> ,      4,     .     ,          .   . </p><br><p> ,     4 (   <code>x=</code> )    ,    ,    <code>x</code> . </p><br><p>        . </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN460863/">https://habr.com/ru/post/zh-CN460863/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN460851/index.html">SamsPcbGuide，第10部分：技术-焊接无铅组件</a></li>
<li><a href="../zh-CN460855/index.html">如何使用PHP实现微服务？</a></li>
<li><a href="../zh-CN460857/index.html">Namecoin区块链研究如何预测RTM网络攻击</a></li>
<li><a href="../zh-CN460859/index.html">在哈尔科夫举行的IThink＃3会议-基于WWDC 2019</a></li>
<li><a href="../zh-CN460861/index.html">JavaScript词汇范围和闭包</a></li>
<li><a href="../zh-CN460865/index.html">月亮上的人。 资料来源</a></li>
<li><a href="../zh-CN460867/index.html">Sourcery自动转换为Realm对象结构</a></li>
<li><a href="../zh-CN460869/index.html">使用YOLOv3在iOS上进行实时对象识别</a></li>
<li><a href="../zh-CN460873/index.html">为什么选择《 Turok：N64的恐龙猎人》比它的时代要早几年</a></li>
<li><a href="../zh-CN460875/index.html">QIWI的我们如何看待MVVM中View和ViewModel之间的通用交互方式</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>