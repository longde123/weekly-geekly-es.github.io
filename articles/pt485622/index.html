<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ü•Ç üåÑ üìÆ Ferramentas de backup do PostgreSQL. Andrey Salnikov (Gar√ßa de Dados) üèáüèº üë®üèø‚ÄçüöÄ üåª</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Sugiro que voc√™ leia a descriptografia do relat√≥rio por Andrey Salnikov do Data Egret "Ferramentas de cria√ß√£o de backup do PostgreSQL" . No final, uma...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Ferramentas de backup do PostgreSQL. Andrey Salnikov (Gar√ßa de Dados)</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/485622/"><p>  <strong>Sugiro que voc√™ leia a descriptografia do relat√≥rio por Andrey Salnikov do Data Egret "Ferramentas de cria√ß√£o de backup do PostgreSQL"</strong> <strong>.</strong>  <strong>No final, uma tabela de resumo atualizada de ferramentas</strong> </p><br><p>  Esta palestra √© sobre as ferramentas de backup dispon√≠veis do PostgreSQL.  Backups l√≥gicos, backups bin√°rios, ferramentas de backup internas e ferramentas de terceiros.  S√£o necess√°rios backups incrementais quando podem realmente ajudar.  Vamos ver quando e qual ferramenta √© mais apropriada para usar.  Qual √© a melhor maneira de automatizar o processo de backup e verificar a integridade de um backup?  D√™ uma olhada em ferramentas como <a href="https://www.postgresql.org/docs/10/app-pgdump.html" rel="nofollow">pg_dump</a> , <a href="https://www.postgresql.org/docs/10/app-pgbasebackup.html" rel="nofollow">pg_basebackup</a> , <a href="https://www.2ndquadrant.com/en/resources/barman/" rel="nofollow">barman</a> , <a href="https://github.com/wal-e/wal-e" rel="nofollow">wal-e</a> , <a href="https://github.com/wal-g/wal-g" rel="nofollow">wal-g</a> , <a href="https://pgbackrest.org/" rel="nofollow">pgbackrest</a> , <a href="https://www.enterprisedb.com/enterprise-postgres/edb-postgres-backup-and-recovery-tool" rel="nofollow">BART</a> e <a href="https://postgrespro.ru/products/extensions/pg_probackup" rel="nofollow">pg_probackup</a> . </p><br><iframe width="560" height="315" src="https://www.youtube.com/embed/Us6cHVNA4vk" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><a name="habracut"></a><br><p>  Meu nome √© Andrey Salnikov, sou funcion√°rio da Data Egret e este relat√≥rio ser√° dedicado √†s ferramentas para criar backups no PostgreSQL. </p><br><p><img src="https://habrastorage.org/webt/qr/pa/mu/qrpamu1psbed1aonvt1shrrpedk.png"></p><br><p>  Primeiro sobre quem somos, minha empresa.  Nossa principal atividade: trabalhamos como administradores remotos e temos um n√∫mero bastante grande de clientes.  Existem bases enormes, existem v√°rias bases pequenas, existem todos os tipos de misturas quando uma base grande ou v√°rias pequenas.  Tamb√©m fornecemos servi√ßos de consultoria e auditoria - este √© o caso se as pessoas n√£o precisam de suporte constante, mas √© necess√°rio algum tipo de conhecimento. <br>  Como o PostgreSQL √© um produto de c√≥digo aberto, naturalmente participaremos de todos os tipos de confer√™ncias em termos de compartilhamento de nossa experi√™ncia e de ajudar o PostgreSQL de todas as formas poss√≠veis.  Porque o banco de dados PostgreSQL √© realmente bom.  Acontece que vimos muitos perfis de carga: cargas DWH, cargas WEB e misturas de cargas.  E as bases estavam caindo de maneiras diferentes.  Muita experi√™ncia. </p><br><p><img src="https://habrastorage.org/webt/a0/vc/b_/a0vcb_l47qx4vvzh1hxnjcqesz4.png"></p><br><p>  Esta √© a parte mais interessante do relat√≥rio.  Por que os backups s√£o necess√°rios?  Na verdade, eles s√£o necess√°rios para que possamos descansar em paz, para que possamos dormir em paz, para que possamos sair em shows calmamente.  Agora, esse √© o objetivo principal, do ponto de vista da base, por que os backups s√£o necess√°rios.  Para que tudo fique calmo em nossas vidas.  Porque se houver backups verificados, podemos fazer tudo isso.  Mas o que est√° acontecendo com a base √© a d√©cima coisa. </p><br><p><img src="https://habrastorage.org/webt/dj/_9/aj/dj_9ajbympb3eslx0bl1phlp6te.png"></p><br><p>  Qual √© a gama de ferramentas para criar backups no mundo do PostgreSQL?  Esta √© a ferramenta de recupera√ß√£o interna pg_dump, pg_dumpall ou pg_restore.  Essa √© a √∫nica ferramenta que permite fazer backups l√≥gicos.  Ou seja, ele pode pg_dump voc√™, no SQL para despejar, e em um pequeno formato bin√°rio para despejar dados.  E sai da caixa com o PostgreSQL. <br>  A pr√≥xima ferramenta (pg_basebackup) para criar backups, que tamb√©m sai da caixa e inicia mais com esta ferramenta, al√©m de todas elas ser√£o ferramentas para criar backups bin√°rios de banco de dados.  Pg_basebackup tamb√©m √© uma ferramenta que sai da caixa, o que nos permite fazer upload de r√©plicas do postgreSQL e fazer uma c√≥pia bin√°ria do banco de dados, gravar um banco de dados persistente e, se quisermos arquivar a tempo, podemos configurar o PostgreSQL para despej√°-lo para algum tipo de disco.  Essas s√£o as ferramentas b√°sicas.  Eles s√£o bons, eles fazem, eles executam sua funcionalidade em 5, mas s√£o inconvenientes em termos de gerenciamento e algum tipo de massa.  Quando voc√™ possui 20 bancos de dados, precisar√° fazer isso sozinho. <br>  As pr√≥ximas duas ferramentas s√£o ferramentas espec√≠ficas de nuvem pura - wal-e e wal-g.  Os mesmos caras est√£o desenvolvendo-os, mas o desenvolvimento do wal-e acabou e eles mudaram para o wal-g.  Essas ferramentas s√£o voltadas principalmente para a AWS e para armazenamento no S3.  O Wal-e ainda pode trabalhar com o Google Cloud, com o Azure e com o sistema de disco, voc√™ pode especificar algum tipo de unidade remota.  O Wal-g funciona apenas com a AWS, apenas com S3.  Bem, ou qualquer outra interface semelhante com o S3.  N√≥s os usamos, coisas boas.  Desmontarei ainda mais cada ferramenta em detalhes. </p><br><p><img src="https://habrastorage.org/webt/h_/cs/my/h_csmywtln65xfdmoryutenb6-g.png"></p><br><p>  E no pr√≥ximo pacote de ferramentas, essas s√£o ferramentas que dependem do pg_basebackup ou o usam diretamente, ou de alguma forma implementam sua funcionalidade.  Todos eles s√£o escritos por desenvolvedores que se comprometem com o PostgreSQL principal e t√™m seu pr√≥prio comercial de fork, que promove em seu c√≠rculo de influ√™ncia. <br>  A ferramenta de barman mais popular, que usamos amplamente no pa√≠s.  Este √© essencialmente um wrapper Python em torno de pg_basebackup.  Tamb√©m pode funcionar em protocolos ssh.  Uma ferramenta pgbackrest muito interessante e muito promissora.  O PostgreSQL est√° envolvido no desenvolvimento e se compromete ativamente com ele.  Foi originalmente escrito em Python.  Agora a vers√£o usada - est√° escrita em C para acelerar e a possibilidade de remo√ß√£o paralela de backups. <br>  Pg_probackup √© um utilit√°rio de nossos colegas russos no PostgreSQL Professional que permite fazer backups incrementais, que s√£o bem pequenos em tamanho. <br>  E o utilit√°rio mais recente √© a ferramenta de backup e recupera√ß√£o (BART) do EnterpriseDB.  Ela n√£o √© muito popular entre n√≥s.  √â principalmente para o CentOS e Red Hat.  Para o Ubuntu, com ela, na minha opini√£o, dif√≠cil.  E devido √† baixa popularidade do BART conosco, ele (BART) quase n√£o √© encontrado em nenhum lugar das instala√ß√µes. </p><br><p><img src="https://habrastorage.org/webt/ow/si/t8/owsit8h0n3welzlugm95_glqdds.png"></p><br><p>  Eu tentaria dividir essas ferramentas em algumas coisas importantes. </p><br><ul><li><p>  Primeiro, √© importante para n√≥s como armazen√°-lo, em quais unidades e em quais servi√ßos.  E h√° uma lista de caracter√≠sticas pelas quais passaremos. </p><br></li><li><p>  A seguinte separa√ß√£o de dados, aqui subdivido o que podemos, ao remover um backup ou restaurar um backup, para cortar um peda√ßo de todo o servidor de banco de dados (servidor) e trabalhar com ele como um banco de dados integral e integral. </p><br></li><li><p>  Quanto eles suportam vers√µes diferentes do banco de dados. </p><br></li><li><p>  Quais modos de opera√ß√£o eles t√™m em termos de paralelismo, em termos de algum tipo de automa√ß√£o e similares. </p><br></li><li><p>  E a capacidade de manuten√ß√£o √© o quanto podemos separ√°-los em um servi√ßo separado, que por si s√≥ passar√° por bancos de dados e remover√° os backups de acordo com alguma programa√ß√£o. </p><br></li><li><p>  Valida√ß√£o - Eu queria que o backup fosse verificado em termos de garantir que possamos recuperar dele e teremos uma base normal e ininterrupta. </p><br><p>  E agora, vamos examinar esses seis grandes pontos com mais detalhes.  E vou marcar l√° qual o instrumento que nos dar√°. </p><br></li></ul><br><p><img src="https://habrastorage.org/webt/s5/v0/h0/s5v0h0p62rsqz1r86v2upwibj5c.png"></p><br><p>  Por armazenamento, eles podem armazenar tudo no sistema de arquivos, ou seja, podemos remontar nosso disco no sistema operacional e copiar os backups l√°.  Todas as ferramentas permitem que voc√™ fa√ßa isso.  Uma unidade de rede montada √© basicamente a mesma, porque √© obtida em nosso sistema de arquivos local. <br>  Na AWS (S3), tr√™s ferramentas podem funcionar para n√≥s - wal-g, wal-e, pgbackrest.  Porque entre esses utilit√°rios: barman e assim por diante, √© o √∫nico que pode trabalhar com a AWS (S3). <br>  Com o Azure, apenas wal-e.  O Google Cloud √© apenas wal-e. </p><br><p><img src="https://habrastorage.org/webt/gw/sc/qd/gwscqdmvmqlbe1r1e545ipkemzs.png"></p><br><ul><li>  Uma c√≥pia l√≥gica dos dados √© fornecida apenas por pg_dump, pg_dumpall.  A diferen√ßa entre eles √© que pg_dumpall processa toda a inst√¢ncia do banco de dados (servidor); em pg_dump, voc√™ pode especificar um banco de dados espec√≠fico na inst√¢ncia e trabalhar com ele. </li><li>  C√≥pias bin√°rias s√£o o resto. </li><li>  Um fator importante durante o armazenamento √© que, se estamos limitados de alguma forma pelos recursos do disco, geralmente surgem situa√ß√µes quando dividimos o banco de dados em diferentes espa√ßos de tabela.  Isso tamb√©m vale para servidores de ferro, porque voc√™ n√£o deseja sofrer com RAID.  Isso √© verdade para as nuvens, porque, porque h√° uma certa limita√ß√£o, especialmente quando voc√™ pega um carro com discos NVME e quantos est√£o conectados, muitos est√£o conectados.  As inst√¢ncias da AWS se expandem, mas com as unidades EBS.  E ao restaurar dados, ser√° importante para n√≥s podermos redistribuir esses espa√ßos de tabela, atribu√≠-los ao longo de novos caminhos e a novos discos.  E agora essa boa propriedade est√° presente na wal-e.  No wal-g, eles ainda n√£o sabem como trabalhar com isso.  Pg_probackup pode trabalhar com ele.  Barman, basebackup, pgbackrest.  Isso geralmente √© importante, especialmente quando voc√™ tem um banco de dados de 8 a 10 TB.  Entre nossos clientes de produ√ß√£o, quase todos esses bancos de dados s√£o recolhidos em espa√ßos de tabela. </li></ul><br><p><img src="https://habrastorage.org/webt/qd/-v/sk/qd-vskcocq-r2tv0duopeyxtvke.png"></p><br><p>  Agora, sobre qual tamanho podemos ter backup.  Tudo isso ocorrer√° no contexto de backups bin√°rios.  √â claro que o backup bin√°rio √© o quanto o banco de dados pesa conosco, tanto que copiamos.  Pesa 8 TB, copiamos 8 TB.  1 MB pesa 1 MB, copiado.  Como economizar espa√ßo quando queremos uma longa cadeia de backups?  Para fazer isso, veio com algumas ferramentas.  Ou seja, o banco de dados armazena dados em seus arquivos.  Se tivermos um banco de dados de arquivamento longo, geralmente alteramos l√° uma pequena porcentagem desses arquivos.  E para isso, eles criaram um backup diferencial. </p><br><p>  Backup diferencial, o que √©?  Examinamos quais arquivos foram alterados e copiamos apenas para o armazenamento, onde armazenar o backup.  E vincularemos todos os outros arquivos com um hardlink a esse banco de dados.  Acontece que, assim, economizamos espa√ßo.  E, ao mesmo tempo, podemos excluir com seguran√ßa os backups antigos do banco de dados sem estragar os mais recentes. </p><br><p>  Isso √© bom, mas decidimos ir em frente e criamos um backup incremental.  Os backups incrementais s√£o de dois tipos. </p><br><p>  O primeiro est√° no n√≠vel do arquivo.  Ele difere do backup diferencial apenas porque o backup diferencial se concentra em um backup completo do seu banco de dados e, em rela√ß√£o a um backup completo, copia arquivos e c√≥pias diff.  O backup incremental pode se concentrar em backups diferenciais, copia apenas os arquivos alterados que foram alterados em compara√ß√£o ao backup diferencial.  Para incremental, voc√™ precisar√° de toda a cadeia de backups.  Ou seja, o backup principal -&gt; 1¬∫ backup incremental (sempre ser√° diferencial) -&gt; todos os backups incrementais.  O backup diferencial sempre se concentra em um banco de dados de backup completo.  Incremental pode se concentrar em outros tipos de backup. <br>  Pg_probackup e BART foram o caminho para criar backups incrementais por bloco.  Porque podemos mudar n√£o o arquivo inteiro, mas o bloco de dados.  E esses utilit√°rios percorrem os arquivos wal e selecionam exatamente os blocos que foram alterados.  Esses blocos de backup s√£o copiados para o backup.  Para recuperar com esse backup incremental, voc√™ tamb√©m precisar√° de uma c√≥pia completa do banco de dados e ainda precisar√° salvar essas partes incrementais digitadas no wal.  Isso imp√µe algumas limita√ß√µes do utilit√°rio, porque elas devem ser executadas nos arquivos wal.  O PostgreSQL Professional tamb√©m possui uma camada sobre a estrutura de arquivos do banco de dados.  Portanto, eles est√£o procurando rapidamente esses blocos.  Esses backups incrementais s√£o muito pequenos.  Se voc√™ tiver uma pequena altera√ß√£o de% do banco de dados e devido ao fato de muitas informa√ß√µes t√©cnicas serem gravadas no arquivo wal, esses utilit√°rios fazem backup de dezenas de kilobytes de dados por 1 wal. </p><br><p><img src="https://habrastorage.org/webt/s3/d9/ca/s3d9ca1otjtkwql3_qakv67am7c.png"></p><br><p>  Mais compartilhamento de dados.  Isso implica que, se precisarmos fazer backup, nem tudo.  Ou restaure nem tudo.  Isso s√≥ √© poss√≠vel com backups l√≥gicos, e isso nos permite fazer apenas pg_dump.  Utilit√°rios fornecem funcionalidade bastante ampla.  Pg_dump pode permitir que voc√™ despeje a estrutura do banco de dados, se necess√°rio.  Voc√™ pode despejar especificamente uma tabela ou pode excluir uma tabela do despejo ou despejar a lista de tabelas, excluir a lista.  A funcionalidade √© bastante ampla nesse sentido.  O ponto negativo √© que, ao recuperar-se de um dump desse tipo, se voc√™ tiver um banco de dados grande, precisar√° gastar muito tempo para recuper√°-lo, porque tudo isso precisa ser reproduzido em uma inst√¢ncia pura do PostgreSQL. <br>  Esses utilit√°rios s√£o muito convenientes para usar o caso quando superestimamos nossos pontos fortes e n√£o criamos muitos bancos de dados pequenos.  Podemos mescl√°-los em uma inst√¢ncia.  Podemos v√™-lo dessa maneira, se agora avaliarmos novamente nossa for√ßa, nosso banco de dados est√° inchado ou estamos mudando a arquitetura de um mon√≥lito para um servi√ßo e vendo os dados.  Pg_dump neste caso √© a √∫nica coisa que permite fazer isso sem problemas. </p><br><p>  Voc√™ tamb√©m pode restaurar um banco de dados e o pgbackrest est√° listado aqui.  Ele possui um chip, e podemos indicar que precisamos de apenas um banco de dados do backup bin√°rio.  O que ele esta fazendo?  Restaura o banco de dados padr√£o do backup, este √© o template, o postgres e o banco de dados que especificamos.  Em todos os outros bancos de dados, ele redefine arquivos e os torna com tamanho zero.  Ou seja, o PostgreSQL possui uma estrutura transparente para armazenar bancos de dados em arquivos; nesse n√≠vel, voc√™ pode, por assim dizer, reduzir o banco de dados restaurado.  Suponha que precisamos encontrar quais dados urgentes de um bin√°rio, n√£o queremos aumentar uma base de 10 TB, temos duas bases l√° e aumentamos uma, o que permite um total de 5 TB.  Nesse caso, √© claro, a consist√™ncia √© violada, mas para algumas solu√ß√µes r√°pidas, quando voc√™ precisa levantar urgentemente dados do furo do nariz de um banco de dados grande, dos quais existem v√°rios, esses s√£o recursos muito bons.  Mas como um banco de dados de backup completo n√£o deve ser considerado durante a recupera√ß√£o.  Ou seja, √© para trabalhos de emerg√™ncia. </p><br><p><img src="https://habrastorage.org/webt/bq/pf/aj/bqpfaj0wvrtn1atsq0yj1j4x7de.png"></p><br><p>  Como √© o trabalho com muitas vers√µes do banco de dados?  Aqui tamb√©m tudo √© bastante interessante.  Pg_dump √© muito bom, pois n√£o estamos vinculados a qual vers√£o do banco de dados restaurar.  H√° um modo de texto sem formata√ß√£o, e √© apenas SQL puro, que descreve toda a estrutura do banco de dados, todos os dados.  Em princ√≠pio, voc√™ pode se recuperar de onde quiser, no MySQL, no MSSQL, no Oracle, com algumas edi√ß√µes neste dump.  Entre as principais vers√µes do PostgreSQL, esses dumps tamb√©m s√£o bastante f√°ceis de usar. <br>  Multi-versioning, o que quero dizer com isso?  √â assim que o utilit√°rio pode processar vers√µes diferentes de bancos de dados e trabalhar simultaneamente com o PostgreSQL 9.6, 10, 11. Tudo, exceto os integrados de pg_dump e pg_basebackup, porque eles est√£o vinculados √† vers√£o espec√≠fica que eles acompanham.  O restante se concentra nesses utilit√°rios.  Eles podem ser indicados onde est√£o localizados pg_basebackup, pg_dump de diferentes vers√µes.  Eles respectivamente com a vers√£o do PostgreSQL escolhem o utilit√°rio mais recente para remover o backup. <br>  Todos os utilit√°rios, exceto pg_dump, s√£o adequados para criar r√©plicas e servidores em espera, porque esses s√£o backups l√≥gicos.  Usando qualquer um desses utilit√°rios, voc√™ pode restaurar os servidores e conectar-se ao assistente para funcionar como uma r√©plica desse servidor. </p><br><p><img src="https://habrastorage.org/webt/rk/mr/jp/rkmrjpvyme8ifuybv7jvpkqd0r4.png"></p><br><p>  Como os backups podem ser removidos em geral, quais modos existem para remover backups.  Voc√™ pode simplesmente copiar arquivos usando as ferramentas padr√£o do sistema operacional: via protocolo ssh (rsync, scp) e, possivelmente, outros utilit√°rios.  Por que existe essa oportunidade, porque eles permitem que voc√™ paralelize a c√≥pia.  O Pgbackrest s√≥ funciona dessa maneira, barman pode funcionar dessa maneira e pode funcionar usando o protocolo PostgreSQL. <br>  Protocolo PostgreSQL - quando o utilit√°rio de backup se conecta ao PostgreSQL e extrai todos os arquivos e logs de arquivamento que surgem durante o processo de backup usando o protocolo de replica√ß√£o.  Todo mundo e barman podem fazer isso. <br>  Basicamente, tudo pode fazer backup de uma r√©plica, depende da vers√£o do PostgreSQL.  Com o PostgreSQL 10 e 11, podemos remover backups de uma r√©plica.  Mas eu n√£o recomendo isso, em geral, nenhuma empresa recomenda.  Como h√° situa√ß√µes em que eles perderam o monitoramento, eles fizeram um backup da r√©plica por um m√™s, que caiu do servidor mestre e n√£o √© relevante.  Ou seja, os backups sempre devem ser removidos do servidor mestre.  Somente nesse caso, voc√™ ter√° certeza de que possui um banco de dados de backup realmente atualizado. <br>  Backups multithreading - todos podem fazer isso, porque tudo √© por diferentes raz√µes, algu√©m atrav√©s do protocolo ssh, algu√©m implementado no n√≠vel de c√≥pia do banco de dados.  Al√©m de pg_basebackup e BART, porque a opera√ß√£o BART est√° apenas em pg_basebackup quando o backup √© removido e, infelizmente, √© de thread √∫nico e n√£o ser√° multithread. </p><br><p><img src="https://habrastorage.org/webt/72/4x/j0/724xj0dcehoennfciyo2uzucisq.png"></p><br><p>  Um exemplo de multithreading.  Eu estava restaurando um banco de dados de 8 TB.  Quando voc√™ se concentra na escolha de um sistema para remover backups, saiba que o wal-e est√° escrito em Python, o wal-g est√° escrito em Golang.  Eu tive que restaurar a base de 8 TB.  Wal-e encontrou a limita√ß√£o do Python e me puxou com a AWS a uma velocidade de 600 Mbps.  Quando mudei para o wal-g, ele tinha uma situa√ß√£o em que n√£o podia trabalhar com backups do wal-e, mas podia puxar arquivos wal.  Portanto, essa imagem do meio aqui √© a restaura√ß√£o do banco de dados.  Em seguida, rolou o wal, que estava l√° no S3 e foi restaurado para um determinado ponto no tempo.  O Wal-e encontrou limita√ß√£o e simultaneidade em Python em Python, √© t√£o condicional.  Um wal-g correu para a interface S3, ou seja, qu√£o r√°pido o S3 podia dar a cada momento, t√£o rapidamente que demorava.  Em m√©dia, era de 2 Gb / s, o que √© bom o suficiente.  Ou seja, com o wal-e, uma hora de altera√ß√µes no banco de dados foi recebida em 45 minutos de backup cont√≠nuo.  Com o wal-g, eles rolaram uma hora em algum lugar do banco de dados por cerca de 5 minutos. </p><br><p><img src="https://habrastorage.org/webt/rj/nk/fa/rjnkfaa9ld-am4dazwrasjqwfbk.png"></p><br><p>  Modos de opera√ß√£o, o que √© interessante aqui no sistema de backup. </p><br><ul><li>  Recupera√ß√£o a tempo para um ponto espec√≠fico.  Se arquivamos logs e os copiamos, podemos restaur√°-los.  Ele permite que voc√™ fa√ßa um sistema de backup, como um fator padr√£o.  O principal √© que armazenamos arquivos wal em algum lugar.  Os lix√µes, √© claro, n√£o sabem como, porque s√£o um pouco sobre outra coisa. </li><li>  Ajustar a carga na rede √© uma coisa muito importante, porque, como eu disse, √© desej√°vel remover o dump do servidor mestre e garantir que voc√™ realmente obtenha o backup real.  Bem, √†s vezes acontece que os servidores est√£o t√£o carregados que √© muito dif√≠cil entrar l√°.  Alguns clientes mant√™m uma interface de rede separada.  √Äs vezes, √© feito um tempo de carregamento m√≠nimo.  Tamb√©m √© bom quando podemos especificar a carga na rede ao criar backup.  Isso permite que voc√™ fa√ßa pg_basebackup, barman e BART, wal-e, wal-g. </li><li>  Compress√£o em tempo real.  Esta √© uma quest√£o de quanto transmitiremos pela rede.  Se pudermos compactar o arquivo antes de envi√°-lo para o reposit√≥rio, isso ser√° bom em tempo real.  E quase todo mundo pode fazer isso aqui.  O principal √© indicar o n√≠vel de compress√£o l√°. </li></ul><br><p><img src="https://habrastorage.org/webt/lv/pe/vd/lvpevdlrpqrg-9hypasdcs9-dse.png"></p><br><p>  Facilidade de manuten√ß√£o, o que √© interessante aqui para sistemas de backup? </p><br><ul><li>   CLI ‚Äî    ,               ,     ,        ,      .    ,       CLI,     ,     ,     .       ,       ,      . </li><li>         barman, pgbackrest  BART,        .   ,        20-30  ,    ,    ,          ,           backup-           . ,  ,     . </li><li>    ‚Äì          ,     ,       backup-,   ,    backup-.           ,     -   .         .       . </li><li>   ‚Äì                 backup-,   ,  -   .     ,    ,     .  ,   , ,      ,       wal ,   ,        .   wal-e, wal-g,      ,    backup      - .  7 backup    . </li></ul><br><p><img src="https://habrastorage.org/webt/zj/r0/es/zjr0esauswimuw1itkqosshmyla.png"></p><br><p>   backup.  ,       backup,    backup  ,    ,        .  ,       .     ,   .   .    stage   .   ,       ,    backup .   CLI  ,           backup    . </p><br><p>     ,      ,  .         ,    backup .   ,     .  ,    .  ,    .   .   checksum  PostgreSQL.      ,      checksum  PostgreSQL.       checksum,   . </p><br><p>  pgbackrest  pg_probackup    backup  ,     checksum.          checksum. </p><br><p>  ,    backup,      checksum , ,   checksum   .     . </p><br><p><img src="https://habrastorage.org/webt/mj/_e/di/mj_edibaxks4v2_4-t5kanbxghe.png"></p><br><p>  : </p><br><ul><li> <a href="https://www.postgresql.org/docs/10/static/app-pgdump.html" rel="nofollow">https://www.postgresql.org/docs/10/static/app-pgdump.html</a> </li><li> <a href="https://www.postgresql.org/docs/10/static/app-pgbasebackup.html" rel="nofollow">https://www.postgresql.org/docs/10/static/app-pgbasebackup.html</a> </li><li> <a href="https://www.2ndquadrant.com/en/resources/barman/" rel="nofollow">https://www.2ndquadrant.com/en/resources/barman/</a> </li><li> <a href="https://github.com/wal-e/wal-e" rel="nofollow">https://github.com/wal-e/wal-e</a> </li><li> <a href="https://github.com/wal-g/wal-g" rel="nofollow">https://github.com/wal-g/wal-g</a> </li><li> <a href="https://pgbackrest.org/" rel="nofollow">https://pgbackrest.org/</a> </li><li> <a href="https://www.enterprisedb.com/products/edb-postgres-platform/edb-backup-and-recovery-tool" rel="nofollow">https://www.enterprisedb.com/products/edb-postgres-platform/edb-backup-and-recovery-tool</a> </li><li> <a href="https://postgrespro.ru/products/extensions/pg_probackup" rel="nofollow">https://postgrespro.ru/products/extensions/pg_probackup</a> </li></ul><br><p>      .   ,     .       ,     . </p><br><p><img src="https://habrastorage.org/webt/tt/qn/i7/ttqni7mc49sw-n6bww9bpi1gese.png"></p><br><p> :  ,  backup      ,     ,   ,   .       ,      ,       backup.    ,  ,  -    , ,   ,  ,    ,     ,   .    -    ? </p><br><p> :       ,        ,       .     .   .  -   , , backup   ,   ,       ,      .          ,         .    ,  , , ,  ,   ,     /     .  ,       ,       .      ,     .   ,      .       ,        . </p><br><p> :    , ,    ?       . </p><br><p> :        .         4 .       .     .      backup.       .    ,     . </p><br><p> :         ? </p><br><p> :    .       .   wal-e, wal-g, pgbackrest.    borman, pg_dump,   basebackup.    ,      ,       .   . </p><br><p> :  ,    -     PostgreSQL,   , , postgis  - -? </p><br><p> :    ,      backup   ,      .  checksum  ,  PostgreSQL   checksum,   ,       .   postgis,     -      . Pg_dump      ,    ,   , SQL .        SQL .     . , ,         .    dump,       . </p><br><p> :  ,     .   ,          -  ? </p><br><p> :     .    dump  ,         .    ,    ‚Äì    ,  ,  - ,  ,     .      ,    . ,   -  ,      . </p><br><p> :   ,     ,   ,  bloat   ? </p><br><p> : . </p><br><p> :    ‚Äî  ,     -    . , Symantec, Veritas Backup Exec  .      PostgreSQL? </p><br><p> : ,      ,      . PostgreSQL     ,    pg_start_backup.  ,  .     . </p><br><p> :  ,  -  Symantec, Veritas Backup Exec      . </p><br><p> :   . </p><br><p> : , ,      .   checksum    - ,   , - ? </p><br><p> :    ‚Äî            .        stage ,    .    stage    .       .             .    ,      -,        .     .      . </p><br><p> :   ,      WAL ,   S3.        wal-e, wal-g    - awscli  .      ? </p><br><p>  (  ):   wal-g.     wal-g.      40     wal-g .      .  ,   .   , prefetch,   wal  ,    . ,      ‚Äî  ,       wal.    wal   ,   page cache   ,  ,      wal,       ,        .     ,   . </p><br><p>  :     .   ,     PostgreSQL ‚Äî   -&gt; /dev/null,  ,      .        ,          .       smoke .   <a href="https://postgrespro.ru/docs/postgresql/10/amcheck" rel="nofollow">amcheck</a> ,      .        ,        ,     ,       . </p><br><p> :       10  .       .            .    .       wal  ‚Äî      .      ? </p><br><p> :        .      .      .         ,        . </p><br><p> :          ,       pg_dump,        . ? </p><br><p> : -     . ,   . </p><br><p> :   ,      ,    - ? </p><br><p> : pg_dump   ,    . </p><br><p> :     pg_dump,    ,   ,   ,         ,    . </p><br><p> :         ,       -,    . </p><br><p> :   ,   . </p><br><p> :        ,       -  . </p><br><p> :    .     .      .      . ,     ,    .   . Pg_dump  ,  - ,  exit_code  .   ,       , .   ,      . </p><br><p> PS ‚Ññ1        pg_dump, pg_basebackup. </p><br><div class="scrollable-table"><table><thead><tr><th></th><th> barman </th><th> wal-e </th><th> wal-g </th><th> pg_probackup </th><th> pgbackrest </th><th> BART </th></tr></thead><tbody><tr><td> ssh (rsync, scp) </td><td>  + </td><td></td><td></td><td></td><td>  + </td><td></td></tr><tr><td>     </td><td>  + </td><td>  + </td><td>  + </td><td>  + </td><td>  + </td><td>  + </td></tr><tr><td> S3 </td><td></td><td>  + </td><td>  + </td><td></td><td>  + </td><td></td></tr><tr><td> Azure </td><td></td><td>  + </td><td>  + </td><td></td><td></td><td></td></tr><tr><td> Google Cloud </td><td></td><td>  + </td><td>  + </td><td></td><td></td><td></td></tr><tr><td>    </td><td>  + </td><td>  + </td><td>  + </td><td>  + </td><td>  + </td><td></td></tr><tr><td>   </td><td></td><td></td><td>  + </td><td></td><td>  + </td><td></td></tr><tr><td>   </td><td></td><td></td><td>  + </td><td></td><td>  + </td><td></td></tr><tr><td></td><td> barman </td><td> wal-e </td><td> wal-g </td><td> pg_probackup </td><td> pgbackrest </td><td> BART </td></tr><tr><td>    </td><td></td><td></td><td>  + </td><td>  + </td><td></td><td></td></tr><tr><td>    </td><td></td><td></td><td></td><td></td><td>  + </td><td></td></tr><tr><td> - </td><td>  + </td><td>  + </td><td>  + </td><td>  + </td><td>  + </td><td>  + </td></tr><tr><td>   </td><td>  + </td><td>  + </td><td>  + </td><td>  + </td><td>  + </td><td></td></tr><tr><td> Recupera√ß√£o Point-in-Time </td><td>  + </td><td>  + </td><td>  + </td><td>  + </td><td>  + </td><td>  + </td></tr><tr><td>  Ajuste de carga de rede </td><td>  + </td><td></td><td>  + </td><td></td><td></td><td>  + </td></tr><tr><td>  Compacta√ß√£o din√¢mica </td><td>  + </td><td>  + </td><td>  + </td><td>  + </td><td>  + </td><td></td></tr><tr><td>  CLI </td><td>  + </td><td>  + </td><td>  + </td><td>  + </td><td>  + </td><td>  + </td></tr><tr><td>  Servidor dedicado </td><td>  + </td><td></td><td></td><td></td><td>  + </td><td>  + </td></tr><tr><td></td><td>  barman </td><td>  wal-e </td><td>  wal-g </td><td>  pg_probackup </td><td>  pgbackrest </td><td>  Bart </td></tr><tr><td>  Armazenamento de backup estruturado </td><td>  + </td><td>  + </td><td>  + </td><td>  + </td><td>  + </td><td>  + </td></tr><tr><td>  Pol√≠ticas de reten√ß√£o </td><td>  + </td><td>  cron </td><td>  cron </td><td>  + </td><td>  + </td><td>  + </td></tr><tr><td>  CLI para monitoramento </td><td>  + </td><td>  + </td><td>  + </td><td>  + </td><td>  + </td><td>  + </td></tr><tr><td>  Validade da conclus√£o do backup </td><td>  + </td><td>  + </td><td>  + </td><td>  + </td><td>  + </td><td>  + </td></tr><tr><td>  Soma de verifica√ß√£o postgresql </td><td></td><td></td><td></td><td>  + </td><td>  + </td><td></td></tr></tbody></table></div><br><p>  PS No. 2 Erros, corre√ß√µes nos termos do artigo, adi√ß√µes √† tabela din√¢mica podem ser feitas atrav√©s da <a href="" rel="nofollow">solicita√ß√£o Pull</a> </p><br><p>  PS # 3 Wal-g recebe volunt√°rios para ajudar com a documenta√ß√£o. </p><br><p>  PS No. 4 Para instalar o wal-g usando o rpm, voc√™ pode usar o meu reposit√≥rio: <a href="https://github.com/patsevanton/wal-g-rpm" rel="nofollow">Github</a> , <a href="https://copr.fedorainfracloud.org/coprs/antonpatsev/wal-g/" rel="nofollow">Fedora COPR</a> . </p><br><p>  PS No. 5 Como fazer backup completo e backup incremental na cria√ß√£o e armazenamento no S3 e salvar apenas o backup completo em fita?  Se voc√™ tiver id√©ias, conte-me nos coment√°rios ou no PM. </p><br><p><img src="https://habrastorage.org/webt/r8/hh/ks/r8hhkssl2kpkvvqvat1xgwe8eie.png"></p><br><p>  Pesquisa: Quais ferramentas de backup voc√™ usa? </p><br><p>  Canal de telegrama PS n¬∫ 6 PostgreSQL: <a href="https://t.me/pgsql" rel="nofollow">https://t.me/pgsql</a> </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt485622/">https://habr.com/ru/post/pt485622/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt485610/index.html">Criar um aplicativo Qt no WebAssembly no Windows</a></li>
<li><a href="../pt485612/index.html">O que um acidente espacial me ensinou como desenvolvedor</a></li>
<li><a href="../pt485614/index.html">A cultura corporativa vermelha √© o principal problema dos neg√≥cios na R√∫ssia (parte 3)</a></li>
<li><a href="../pt485618/index.html">Automa√ß√£o para os mais pequenos. Notas. API RESTful</a></li>
<li><a href="../pt485620/index.html">Yoshkar-Ola, em geral, uma cidade de TI?</a></li>
<li><a href="../pt485624/index.html">Servidor Minecraft: Windows vs Linux</a></li>
<li><a href="../pt485630/index.html">Cosmon√°utica da √Åfrica: do lixo √† realidade</a></li>
<li><a href="../pt485632/index.html">Monitorando a pontua√ß√£o de cr√©dito no Power BI</a></li>
<li><a href="../pt485634/index.html">O painel Dungeons and Dragons me ajudou a aprender ingl√™s</a></li>
<li><a href="../pt485636/index.html">Os v√≠rus resistentes ao CRISPR constroem abrigos para proteger os genomas das enzimas que penetram no DNA</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>