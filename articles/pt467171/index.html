<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üìß üìø üò© O que aprendi testando 200.000 linhas de c√≥digo de infraestrutura üññ üßñüèª ‚õ™Ô∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="A abordagem IaC (Infraestrutura como c√≥digo) consiste n√£o apenas no c√≥digo armazenado no reposit√≥rio, mas tamb√©m nas pessoas e processos que cercam es...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>O que aprendi testando 200.000 linhas de c√≥digo de infraestrutura</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/467171/"><p><img src="https://habrastorage.org/webt/j2/pp/6q/j2pp6qs2f6qjrz5pn35wuzd0luk.png"></p><br><p>  A <strong>abordagem IaC</strong> (Infraestrutura como c√≥digo) consiste n√£o apenas no c√≥digo armazenado no reposit√≥rio, mas tamb√©m nas pessoas e processos que cercam esse c√≥digo.  √â poss√≠vel reutilizar abordagens do desenvolvimento de software ao gerenciamento e descri√ß√£o da infraestrutura?  N√£o ser√° sup√©rfluo manter essa id√©ia em mente enquanto voc√™ l√™ o artigo. </p><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Vers√£o russa</a> </p><a name="habracut"></a><br><p>  Esta √© uma transcri√ß√£o do meu <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">desempenho</a> no <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">DevopsConf 2019-05-28</a> . </p><br><div class="spoiler">  <b class="spoiler_title">Slides e v√≠deos</b> <div class="spoiler_text"><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Vers√£o russa</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Vers√£o russa</a> </li><li>  Corrida a seco 2019-04-24 <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">SpbLUG</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">V√≠deo (RU) de DevopsConf 2019-05-28</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">V√≠deo (RU) do DINS DevOps EVENING 2019-06-20</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Slides</a> </li></ul></div></div><br><h1 id="infrastructure-as-bash-history">  Infraestrutura como hist√≥rico do bash </h1><br><p><img src="https://habrastorage.org/webt/i_/yl/fm/i_ylfms8w-9pgisnujlu-iv1u3y.png"></p><br><p>  Suponha que voc√™ venha para um novo projeto e eles lhe digam: "temos <em>infraestrutura como c√≥digo</em> ".  Na realidade, verifica-se, <em>Infra-estrutura como hist√≥rico de bash</em> ou, por exemplo, <em>Documenta√ß√£o como hist√≥rico de bash</em> .  Esta √© uma situa√ß√£o muito real, por exemplo, um caso semelhante foi descrito por Denis Lysenko em seu discurso <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Como substituir toda a infraestrutura e come√ßar a dormir em paz</a> , ele contou que, a partir do hist√≥rico do bash, eles obtiveram uma infraestrutura esbelta no projeto. </p><br><p>  Se desejar, voc√™ pode dizer que <em>Infraestrutura como hist√≥rico do bash</em> √© como c√≥digo: </p><br><ol><li>  <em>reprodutibilidade</em> : voc√™ pode pegar o hist√≥rico do bash, executar comandos a partir da√≠; talvez, a prop√≥sito, voc√™ tenha uma configura√ß√£o funcional na sa√≠da. </li><li>  <em>versionamento</em> : voc√™ sabe quem entrou e o que fez, novamente, n√£o o fato de que isso o levar√° a uma configura√ß√£o funcional na sa√≠da. </li><li>  <em>hist√≥ria</em> : hist√≥ria de quem fez o qu√™.  somente voc√™ n√£o poder√° us√°-lo se perder o servidor. </li></ol><br><p>  O que fazer? </p><br><h1 id="infrastructure-as-code">  Infraestrutura como c√≥digo </h1><br><p><img src="https://habrastorage.org/webt/gm/3e/wf/gm3ewf7g3w72takvuffsxhcbgoy.png"></p><br><p>  Mesmo um caso t√£o estranho como <em>Infraestrutura e hist√≥rico do bash</em> pode ser atra√≠do para <em>Infraestrutura como C√≥digo</em> , mas quando queremos fazer algo mais complicado que o bom e velho servidor LAMP, chegamos √† conclus√£o de que esse c√≥digo precisa ser modificado, modificado, modificado de alguma forma .  Al√©m disso, gostar√≠amos de considerar paralelos entre <em>infraestrutura como c√≥digo</em> e desenvolvimento de software. </p><br><h2 id="dry">  SECO </h2><br><p><img src="https://habrastorage.org/webt/rx/qa/vf/rxqavfjxrtmtwkjzzq4prr72oao.png"></p><br><p>  No projeto para o desenvolvimento de sistemas de armazenamento, havia uma subtarefa para <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">configurar periodicamente o SDS</a> : estamos lan√ßando um novo release - ele precisa ser implementado para testes adicionais.  A tarefa √© extremamente simples: </p><br><ul><li>  venha aqui pelo ssh e execute o comando. </li><li>  copie o arquivo l√°. </li><li>  aqui est√° o ajuste na configura√ß√£o. </li><li>  iniciar o servi√ßo l√° </li><li>  ... </li><li>  LUCRO! </li></ul><br><p>  O Bash √© mais do que suficiente para a l√≥gica descrita, especialmente nos est√°gios iniciais de um projeto quando ele est√° apenas come√ßando.  N√£o √© <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">ruim o uso do bash</a> , mas com o tempo voc√™ √© solicitado a implantar algo semelhante, mas um pouco diferente.  A primeira coisa que vem √† mente: copiar e colar.  E agora temos dois scripts muito semelhantes que fazem quase a mesma coisa.  Com o tempo, o n√∫mero de scripts aumentou, e somos confrontados com o fato de que existe uma certa l√≥gica de neg√≥cios para implantar a instala√ß√£o, que deve ser sincronizada entre diferentes scripts, e isso √© bastante dif√≠cil. </p><br><p><img src="https://habrastorage.org/webt/-u/ep/cv/-uepcvi1kjsnruflehy0noydk1k.png"></p><br><p>  Acontece que existe uma pr√°tica seca (n√£o se repita).  A id√©ia √© reutilizar o c√≥digo existente.  Parece simples, mas n√£o chegou a isso imediatamente.  No nosso caso, era uma id√©ia comum: separar configura√ß√µes de scripts.  I.e.  l√≥gica de neg√≥cios como a instala√ß√£o √© implementada separadamente, configura separadamente. </p><br><h2 id="solid-for-cfm">  SOLID para CFM </h2><br><p><img src="https://habrastorage.org/webt/kt/7f/ba/kt7fbazyy0arjwrnlwgoynqbvqg.png"></p><br><p>  Com o tempo, o projeto cresceu e uma <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">extens√£o natural</a> foi o surgimento do Ansible.  O principal motivo de sua apar√™ncia √© a presen√ßa de experi√™ncia na equipe e esse bash n√£o se destina a l√≥gica complexa.  O Ansible tamb√©m come√ßou a conter l√≥gica complexa.  Para que uma l√≥gica complexa n√£o se transforme em caos, existem princ√≠pios de organiza√ß√£o do c√≥digo <em>SOLID</em> no desenvolvimento de software.Por exemplo, Grigory Petrov em seu relat√≥rio "Por que a TI precisa de uma marca pessoal" levantou a quest√£o de que uma pessoa √© t√£o projetada que √© mais f√°cil operar com alguns entidades sociais, no desenvolvimento de software esses s√£o objetos.  Se voc√™ combinar essas duas id√©ias e continuar desenvolvendo-as, notar√° que tamb√©m poder√° usar o <em>SOLID</em> na descri√ß√£o da infraestrutura, para que seja mais f√°cil manter e modificar essa l√≥gica no futuro. </p><br><h3 id="the-single-responsibility-principle">  O princ√≠pio da responsabilidade √∫nica </h3><br><p><img src="https://habrastorage.org/webt/yh/h7/kg/yhh7kgr1jal27ddvpeydqxcmzog.png"></p><br><p>  <em>Cada classe executa apenas uma tarefa.</em> </p><br><p>  N√£o h√° necessidade de misturar c√≥digo e criar monstros monol√≠ticos de massa divina.  A infraestrutura deve consistir em tijolos simples.  Acontece que, se voc√™ dividir o manual do Ansible em pequenos peda√ßos, leia os pap√©is do Ansible e eles ser√£o mais f√°ceis de manter. </p><br><h3 id="the-open-closed-principle">  Os princ√≠pios fechados abertos </h3><br><p><img src="https://habrastorage.org/webt/g6/ym/qn/g6ymqn8vohwbewqx7hgixuiuuf8.png"></p><br><p>  <em>O princ√≠pio da abertura / fechamento.</em> </p><br><ul><li>  <em>Aberto para expans√£o: significa que o comportamento de uma entidade pode ser expandido criando novos tipos de entidades.</em> </li><li>  <em>Fechado para altera√ß√£o: como resultado da expans√£o do comportamento de uma entidade, nenhuma altera√ß√£o deve ser feita no c√≥digo que usa essas entidades.</em> </li></ul><br><p>  Inicialmente, implantamos a infraestrutura de teste em m√°quinas virtuais, mas devido ao fato de a l√≥gica de implanta√ß√£o de neg√≥cios ser separada da implementa√ß√£o, adicionamos facilmente um rolamento ao bare-metall. </p><br><h3 id="the-liskov-substitution-principle">  O princ√≠pio da substitui√ß√£o de Liskov </h3><br><p><img src="https://habrastorage.org/webt/1x/-4/am/1x-4am1tjecrhxx3jm7bfur00oy.png"></p><br><p>  <em>O princ√≠pio da substitui√ß√£o de Barbara Liskov.</em>  <em>objetos no programa devem ser substitu√≠veis por inst√¢ncias de seus subtipos sem alterar a corre√ß√£o do programa</em> </p><br><p>  Se voc√™ olhar de maneira mais ampla, n√£o √© um recurso de nenhum projeto espec√≠fico que voc√™ possa aplicar ao <em>SOLID</em> , geralmente trata-se de CFM, por exemplo, em outro projeto, voc√™ precisar√° implantar um aplicativo Java in a box sobre v√°rios Java, servidores de aplicativos, bancos de dados, SO, etc.  Neste exemplo, vou considerar outros princ√≠pios do <em>SOLID</em> . </p><br><p>  No nosso caso, como parte da equipe de infraestrutura, existe um acordo de que, se instalarmos a fun√ß√£o de imbjava ou oraclejava, teremos um execut√°vel java bin√°rio.  Isso √© necess√°rio porque  pap√©is mais altos dependem desse comportamento; eles esperam que o java esteja presente.  Ao mesmo tempo, isso nos permite substituir uma implementa√ß√£o / vers√£o do java por outra sem alterar a l√≥gica de implanta√ß√£o do aplicativo. </p><br><p>  O problema aqui reside no fato de que na Ansible √© imposs√≠vel implementar, como resultado, alguns acordos aparecem dentro da equipe. </p><br><h3 id="the-interface-segregation-principle">  O Princ√≠pio de Segrega√ß√£o de Interface </h3><br><p><img src="https://habrastorage.org/webt/v2/9r/wa/v29rwalnqryarhrwe-_r8jvx0go.png"></p><br><p>  <em>O princ√≠pio da separa√ß√£o de interfaces ‚Äúmuitas interfaces projetadas especificamente para os clientes s√£o melhores que uma √∫nica interface de uso geral.</em> </p><br><p>  Inicialmente, tentamos colocar toda a varia√ß√£o na implanta√ß√£o do aplicativo em um manual Ansible, mas era dif√≠cil de manter, e a abordagem quando temos uma interface (o cliente espera a porta 443) √© especificada, ent√£o podemos compor a infraestrutura de tijolos separados para uma implementa√ß√£o espec√≠fica. </p><br><h3 id="the-dependency-inversion-principle">  O princ√≠pio da invers√£o de depend√™ncia </h3><br><p><img src="https://habrastorage.org/webt/ee/ip/e8/eeipe8nr7hbjx18yxtoxsekwlfy.png"></p><br><p>  <em>O princ√≠pio da invers√£o de depend√™ncia.</em>  <em>Os m√≥dulos de n√≠vel superior n√£o devem depender dos m√≥dulos de n√≠vel inferior.</em>  <em>Ambos os tipos de m√≥dulos devem depender de abstra√ß√µes.</em>  <em>As abstra√ß√µes n√£o devem depender dos detalhes.</em>  <em>Os detalhes devem depender de abstra√ß√µes.</em> </p><br><p>  Aqui o exemplo ser√° baseado no antipadr√£o. </p><br><ol><li>  Um dos clientes tinha uma nuvem privada. </li><li>  Dentro da nuvem, pedimos m√°quinas virtuais. </li><li>  Mas, tendo em vista os recursos da nuvem, a implanta√ß√£o do aplicativo estava ligada a qual hipervisor a VM estava. </li></ol><br><p>  I.e.  l√≥gica de implementa√ß√£o de aplicativos de alto n√≠vel, as depend√™ncias flu√≠ram para os n√≠veis mais baixos do hypervisor e isso significava problemas ao reutilizar essa l√≥gica.  <em><strong>N√£o fa√ßa isso.</strong></em> </p><br><h1 id="interaction">  Intera√ß√£o </h1><br><p><img src="https://habrastorage.org/webt/rd/7_/8r/rd7_8rtprcz4xjkuhctjppbkcuu.png"></p><br><p>  A infraestrutura como c√≥digo n√£o √© apenas sobre c√≥digo, mas tamb√©m sobre o relacionamento entre o c√≥digo e uma pessoa, sobre as intera√ß√µes entre os desenvolvedores da infraestrutura. </p><br><h2 id="bus-factor">  Fator de barramento </h2><br><p><img src="https://habrastorage.org/webt/p5/4-/wh/p54-whkhcglorvk_dlt0b1jpajy.png"></p><br><p>  Suponha que voc√™ tenha Vasya no projeto.  Vasya sabe tudo sobre sua infraestrutura, o que acontecer√° se Vasya desaparecer de repente?  Esta √© uma situa√ß√£o muito real, porque pode ser atropelada por um √¥nibus.  √Äs vezes isso acontece.  Se isso acontecer e o conhecimento sobre o c√≥digo, sua estrutura, como ele funciona, apar√™ncias e senhas n√£o forem distribu√≠dos na equipe, voc√™ poder√° encontrar v√°rias situa√ß√µes desagrad√°veis.  V√°rias abordagens podem ser usadas para minimizar esses riscos e distribuir conhecimento dentro da equipe. </p><br><h2 id="pair-devopsing">  Par de devopsing </h2><br><p><img src="https://habrastorage.org/webt/6q/0l/t0/6q0lt0afzbkpivxxp4uvryxgake.png"></p><br><p>  N√£o √© como <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">uma piada</a> que os administradores bebiam cerveja, alterava senhas, mas um an√°logo da programa√ß√£o em pares.  I.e.  dois engenheiros sentam-se em um computador, um teclado e come√ßam a configurar sua infraestrutura juntos: configurar o servidor, escrever a fun√ß√£o Ansible etc.  Parece bom, mas n√£o funcionou para n√≥s.  Mas os casos especiais dessa pr√°tica funcionaram.  Chegou um novo funcion√°rio, seu mentor leva consigo uma tarefa real, trabalha, transfere conhecimento. </p><br><p>  Outro caso especial √© uma chamada de incidente.  Durante o problema, um grupo de pessoas de plant√£o e envolvidos se re√∫ne, um l√≠der √© nomeado, que compartilha sua tela e expressa a linha de pensamento.  Outros participantes seguem o pensamento do l√≠der, espionam os truques do console, verificam se n√£o perderam uma linha no log, aprendem coisas novas sobre o sistema.  Essa abordagem funcionou e n√£o. </p><br><h2 id="code-review">  Revis√£o de c√≥digo </h2><br><p><img src="https://habrastorage.org/webt/wk/u6/vn/wku6vntzzsquckgu58n1_r3tg-i.png"></p><br><p>  Subjetivamente, com mais efici√™ncia, a dissemina√ß√£o do conhecimento sobre a infraestrutura e como ela foi organizada foi realizada usando a revis√£o de c√≥digo: </p><br><ul><li>  A infraestrutura √© descrita pelo c√≥digo no reposit√≥rio. </li><li>  As altera√ß√µes ocorrem em uma ramifica√ß√£o separada. </li><li>  Com uma solicita√ß√£o de mesclagem, voc√™ pode ver o delta das altera√ß√µes na infraestrutura. </li></ul><br><p>  O destaque aqui foi que os revisores foram selecionados por sua vez, de acordo com o cronograma, ou seja,  com alguma probabilidade, voc√™ entrar√° em uma nova pe√ßa de infraestrutura. </p><br><h3 id="code-style">  Estilo do c√≥digo </h3><br><p><img src="https://habrastorage.org/webt/qa/fz/ju/qafzju1vc86llmvcc1m4urpfa7c.png"></p><br><p>  Com o tempo, brigas come√ßaram a aparecer durante a revis√£o, como  os revisores tinham seu pr√≥prio estilo e a capacidade de rota√ß√£o dos revisores empilhados com estilos diferentes: 2 espa√ßos ou 4, camelCase ou snake_case.  Implementar isso n√£o funcionou imediatamente. </p><br><ul><li>  A primeira id√©ia foi recomendar o uso de linter, porque todos os mesmos engenheiros, todos inteligentes.  Mas editores diferentes, SO, n√£o √© conveniente </li><li>  Isso evoluiu para um bot, que para cada commit se compromete com o problema escrito na folga e aplicava a sa√≠da do linter.  Mas, na maioria dos casos, foram encontrados assuntos mais importantes e o c√≥digo n√£o foi corrigido. </li></ul><br><h3 id="green-build-master">  Mestre de constru√ß√£o verde </h3><br><p><img src="https://habrastorage.org/webt/lw/ow/xi/lwowxis0izoohgthm9db7nheih4.png"></p><br><p>  O tempo passa e chegamos √† conclus√£o de que voc√™ n√£o deve permitir confirma√ß√µes que n√£o passam em certos testes no mestre.  Voila!  inventamos o Green Build Master, que √© praticado h√° muito tempo no desenvolvimento de software: </p><br><ul><li>  O desenvolvimento est√° em um ramo separado. </li><li>  Os testes s√£o executados neste segmento. </li><li>  Se os testes falharem, o c√≥digo n√£o entrar√° no assistente. </li></ul><br><p>  Tomar essa decis√£o foi muito doloroso porque  causou muita controv√©rsia, mas valeu a pena, porque  os pedidos de fus√µes come√ßaram a ser analisados ‚Äã‚Äãsem discord√¢ncia de estilo e, com o tempo, o n√∫mero de √°reas problem√°ticas come√ßou a diminuir. </p><br><h1 id="iac-testing">  Teste IaC </h1><br><p><img src="https://habrastorage.org/webt/ah/dg/sa/ahdgsaecxtevlwnv9ozcoiypkq8.png"></p><br><p>  Al√©m da verifica√ß√£o de estilo, voc√™ pode usar outras coisas, por exemplo, para verificar se sua infraestrutura pode realmente ser implantada.  Ou verifique se as altera√ß√µes na infraestrutura n√£o resultam em perda de dinheiro.  Por que isso pode ser necess√°rio?  A quest√£o √© complexa e filos√≥fica, √© melhor responder com a hist√≥ria de que de alguma forma havia um auto-scaler no Powershell que n√£o verificou as condi√ß√µes de contorno =&gt; mais VMs foram criadas do que o necess√°rio =&gt; o cliente gastou mais dinheiro do que o planejado.  N√£o √© agrad√°vel o suficiente, mas seria bastante realista capturar esse erro em est√°gios anteriores. </p><br><p>  Algu√©m pode perguntar, por que tornar a infraestrutura complexa ainda mais dif√≠cil?  Os testes para a infraestrutura, bem como para o c√≥digo, n√£o s√£o sobre simplifica√ß√£o, mas sobre como a infraestrutura deve funcionar. </p><br><h2 id="iac-testing-pyramid">  Pir√¢mide de Teste IaC </h2><br><p><img src="https://habrastorage.org/webt/pn/98/jt/pn98jtnydc1wupw_jvifjjc9mpc.png"></p><br><h3 id="iac-testing-static-analysis">  Teste IaC: an√°lise est√°tica </h3><br><p>  Se voc√™ implantar imediatamente toda a infraestrutura e verificar se ela funciona, √© poss√≠vel que demore muito tempo e exija muito tempo.  Portanto, a base deve ser algo que funcione rapidamente, √© muito e abrange muitos lugares primitivos. </p><br><h4 id="bash-is-tricky">  Bash √© complicado </h4><br><p>  Aqui est√° um exemplo trivial.  selecione todos os arquivos no diret√≥rio atual e copie para outro local.  A primeira coisa que vem √† mente: </p><br><pre><code class="plaintext hljs">for i in * ; do cp $i /some/path/$i.bak done</code> </pre> <br><p>  Mas e se houver um espa√ßo no nome do arquivo?  Bem, ok, somos inteligentes, podemos usar aspas: </p><br><pre> <code class="plaintext hljs">for i in * ; do cp "$i" "/some/path/$i.bak" ; done</code> </pre> <br><p>  Bem feito?  n√£o!  E se n√£o houver nada no diret√≥rio, ou seja,  Globbing n√£o vai funcionar. </p><br><pre> <code class="plaintext hljs">find . -type f -exec mv -v {} dst/{}.bak \;</code> </pre> <br><p>  Agora bem feito?  not ... Esqueceu que o nome do arquivo pode ser <code>\n</code> . </p><br><pre> <code class="plaintext hljs">touch x mv x "$(printf "foo\nbar")" find . -type f -print0 | xargs -0 mv -t /path/to/target-dir</code> </pre> <br><h4 id="static-analysis-tools">  Ferramentas de an√°lise est√°tica </h4><br><p>  O problema da etapa anterior pode ser detectado quando esquecemos as aspas, por isso, por natureza, existem muitas <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">ferramentas Shellcheck</a> , existem muitas e provavelmente voc√™ pode encontrar seu pr√≥prio empilhador no IDE. </p><br><div class="scrollable-table"><table><thead><tr><th>  Linguagem </th><th>  Ferramenta </th></tr></thead><tbody><tr><td>  festan√ßa </td><td>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Shellcheck</a> </td></tr><tr><td>  Ruby </td><td>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Rubocop</a> </td></tr><tr><td>  python </td><td>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Pylint</a> </td></tr><tr><td>  ansible </td><td>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Fiapos Ansible</a> </td></tr></tbody></table></div><br><h3 id="iac-testing-unit-tests">  Teste IaC: testes de unidade </h3><br><p><img src="https://habrastorage.org/webt/pn/wx/av/pnwxavylqxfmvcc-oynjhjmsq-a.png"></p><br><p>  Como vimos no exemplo anterior, linter n√£o √© onipotente e n√£o pode apontar para todas as √°reas problem√°ticas.  Al√©m disso, por analogia com os testes no desenvolvimento de software, podemos recuperar testes de unidade.  Ent√£o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">shunit</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">junit</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">rspec</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">pytest</a> v√™m imediatamente √† mente.  Mas o que fazer com ansible, chef, saltstack e outros como eles? </p><br><p>  No in√≠cio, conversamos sobre o <em>SOLID</em> e o fato de que nossa infraestrutura deve consistir em pequenos tijolos.  Chegou a hora deles. </p><br><ol><li>  A infraestrutura √© esmagada em pequenos tijolos, por exemplo, pap√©is Ansible. </li><li>  Algum tipo de ambiente est√° se desenvolvendo, seja docker ou VM. </li><li>  Aplicamos nossa fun√ß√£o Ansible neste ambiente de teste. </li><li>  Verificamos que tudo funcionou como esperado (execute os testes). </li><li>  N√≥s decidimos ok ou n√£o ok. </li></ol><br><h4 id="iac-testing-unit-testing-tools">  Teste IaC: ferramentas de teste de unidade </h4><br><p>  A quest√£o √©: o que s√£o testes para CFM?  voc√™ pode executar o script brega ou usar solu√ß√µes prontas para isso: </p><br><div class="scrollable-table"><table><thead><tr><th>  CFM </th><th>  Ferramenta </th></tr></thead><tbody><tr><td>  Ansible </td><td>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Testinfra</a> </td></tr><tr><td>  Chef </td><td>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Inspec</a> </td></tr><tr><td>  Chef </td><td>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Serverspec</a> </td></tr><tr><td>  saltstack </td><td>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Goss</a> </td></tr></tbody></table></div><br><p>  Exemplo para testinfra, verificamos se os usu√°rios <code>test1</code> , <code>test2</code> existem e est√£o no grupo <code>sshusers</code> : </p><br><pre> <code class="plaintext hljs">def test_default_users(host): users = ['test1', 'test2' ] for login in users: assert host.user(login).exists assert 'sshusers' in host.user(login).groups</code> </pre> <br><p>  O que escolher?  A quest√£o √© complexa e amb√≠gua. Aqui est√° um exemplo de uma mudan√ßa nos projetos no github para 2018-2019: </p><br><p><img src="https://habrastorage.org/webt/aj/vm/0w/ajvm0wr0cno5a0kchi0z-jwyyxy.png"></p><br><h4 id="iac-testing-frameworks">  Estruturas de teste IaC </h4><br><p>  H√° como juntar tudo e correr?  Voc√™ pode <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">fazer e fazer tudo sozinho</a> se tiver um n√∫mero suficiente de engenheiros.  E voc√™ pode usar solu√ß√µes prontas, embora n√£o existam muitas delas: </p><br><div class="scrollable-table"><table><thead><tr><th>  CFM </th><th>  Ferramenta </th></tr></thead><tbody><tr><td>  Ansible </td><td>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Mol√©cula</a> </td></tr><tr><td>  Chef </td><td>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Cozinha de teste</a> </td></tr><tr><td>  Terraform </td><td>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Terratest</a> </td></tr></tbody></table></div><br><p>  Um exemplo de altera√ß√£o nos projetos no github para 2018-2019: </p><br><p><img src="https://habrastorage.org/webt/bj/lb/02/bjlb02mi6tympyzdjjxef3_8bhq.png"></p><br><h4 id="molecule-vs-testkitchen">  Mol√©cula vs.  Testkitchen </h4><br><p><img src="https://habrastorage.org/webt/vx/2e/dt/vx2edtvvuquxyw-4yf81zmk6s9c.png"></p><br><p>  Inicialmente, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">tentamos usar o testkitchen</a> : </p><br><ol><li>  Crie VMs em paralelo. </li><li>  Aplique Fun√ß√µes Ans√≠veis. </li><li>  Afaste o inspec. </li></ol><br><p>  Para 25 a 35 fun√ß√µes, isso funcionou por 40 a 70 minutos, o que levou muito tempo. </p><br><p><img src="https://habrastorage.org/webt/i-/9j/cl/i-9jclmr4x36ag1e8ppzk_d-_b0.png"></p><br><p>  O pr√≥ximo passo foi mudar para jenkins / docker / ansible / mol√©cula.  Idiologicamente, tudo √© igual </p><br><ol><li>  Playbooks de algod√£o. </li><li>  Para derramar pap√©is. </li><li>  Executar cont√™iner </li><li>  Aplique Fun√ß√µes Ans√≠veis. </li><li>  Afaste o testinfra. </li><li>  Verifique a idempot√™ncia. </li></ol><br><p><img src="https://habrastorage.org/webt/zz/je/kf/zzjekf-i8wckzdeslzlrbkmmxhg.png"></p><br><p>  Uma r√©gua para 40 pap√©is e testes para uma d√∫zia come√ßaram a levar cerca de 15 minutos. </p><br><p><img src="https://habrastorage.org/webt/pn/6p/qe/pn6pqelxwb7dbaapkefv80ccxra.png"></p><br><p>  O que escolher depende de muitos fatores, como a pilha usada, a experi√™ncia na equipe etc.  aqui todos decidem como encerrar a quest√£o dos testes de unidade </p><br><h3 id="iac-testing-integration-tests">  Teste IaC: testes de integra√ß√£o </h3><br><p><img src="https://habrastorage.org/webt/yt/jf/br/ytjfbruwxfanxl15sxcfyg_gz1g.png"></p><br><p>  No pr√≥ximo est√°gio da pir√¢mide de testes de infraestrutura, ser√£o exibidos testes de integra√ß√£o.  Eles s√£o semelhantes aos testes de unidade: </p><br><ol><li>  A infraestrutura √© esmagada em pequenos tijolos, como pap√©is Ansible. </li><li>  Algum tipo de ambiente est√° se desenvolvendo, seja docker ou VM. </li><li>  Existem <strong>muitas</strong> fun√ß√µes Ansible aplicadas a esse ambiente de teste. </li><li>  Verificamos que tudo funcionou como esperado (execute os testes). </li><li>  N√≥s decidimos ok ou n√£o ok. </li></ol><br><p>  Grosso modo, n√£o verificamos a operacionalidade de um elemento individual do sistema, como nos testes de unidade, verificamos como o servidor est√° configurado como um todo. </p><br><h3 id="iac-testing-end-to-end-tests">  Teste de IaC: testes de ponta a ponta </h3><br><p><img src="https://habrastorage.org/webt/pn/98/jt/pn98jtnydc1wupw_jvifjjc9mpc.png"></p><br><p>  No topo da pir√¢mide, somos atendidos pelos testes de ponta a ponta.  I.e.  n√£o verificamos a opera√ß√£o de um servidor separado, um script separado, um bloco separado de nossa infraestrutura.  Verificamos que muitos servidores est√£o combinados, nossa infraestrutura funciona como esperamos.  Infelizmente, eu n√£o vi nenhuma solu√ß√£o de caixa pronta, provavelmente porque  a infraestrutura geralmente √© √∫nica e dif√≠cil de modelar e cria uma estrutura para test√°-la.  Como resultado, todos criam sua pr√≥pria solu√ß√£o.  Existe demanda, mas n√£o h√° resposta.  Portanto, vou lhe dizer o que h√° para levar outras pessoas a emitir pensamentos ou cutucar meu nariz, que tudo foi inventado muito antes de n√≥s. </p><br><p><img src="https://habrastorage.org/webt/us/xz/rl/usxzrlzt8unudguhf9b89d83dfm.png"></p><br><p>  Um projeto com uma hist√≥ria rica.  Usado em grandes organiza√ß√µes e provavelmente cada um de voc√™s se cruza indiretamente.  O aplicativo suporta muitos bancos de dados, integra√ß√µes, etc., etc.  Saber como a infraestrutura pode se parecer com isso √© um monte de arquivos de composi√ß√£o do docker e saber quais testes executar em qual ambiente √© Jenkins. </p><br><p><img src="https://habrastorage.org/webt/an/l2/ev/anl2ev_lxlsnegrxpulghdw9jxw.png"></p><br><p>  Esse esquema funcionou por um longo tempo, at√© que, como parte do <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">estudo</a> , tentamos transferi-lo para o Openshift.  Os cont√™ineres permaneceram os mesmos, mas o ambiente de inicializa√ß√£o mudou (ol√° DRY novamente). </p><br><p><img src="https://habrastorage.org/webt/sh/sg/ud/shsgudbrhuqpazrpikcacxskzrm.png"></p><br><p>  A ideia da pesquisa foi mais longe e, no turno da noite, houve uma coisa do tipo APB (Ansible Playbook Bundle) que permite incluir no cont√™iner conhecimento sobre como implantar a infraestrutura.  I.e.  H√° um ponto de conhecimento reproduz√≠vel e test√°vel de como implantar a infraestrutura. </p><br><p><img src="https://habrastorage.org/webt/l_/cw/ho/l_cwho8ftxhtnmuekhjlsfllctg.png"></p><br><p>  Tudo isso soou bem, at√© que nos enterramos em uma infraestrutura heterog√™nea: precis√°vamos do Windows para testes.  Como resultado, o conhecimento sobre onde implantar e testar est√° em jenkins. </p><br><h1 id="conclusion">  Conclus√£o </h1><br><p><img src="https://habrastorage.org/webt/j2/pp/6q/j2pp6qs2f6qjrz5pn35wuzd0luk.png"></p><br><p>  Infraestrutura como c√≥digo √© </p><br><ul><li>  O c√≥digo no reposit√≥rio. </li><li>  A intera√ß√£o das pessoas. </li><li>  Teste de infraestrutura. </li></ul><br><div class="spoiler">  <b class="spoiler_title">liga√ß√µes</b> <div class="spoiler_text"><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Vers√£o Inglesa</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Postagem cruzada de um blog pessoal</a> </li><li>  Corrida a seco 2019-04-24 <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">SpbLUG</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">V√≠deo (RU) de DevopsConf 2019-05-28</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">V√≠deo (RU) do DINS DevOps EVENING 2019-06-20</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Li√ß√µes aprendidas ao escrever mais de 300.000 linhas de c√≥digo de infraestrutura</a> e <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">vers√£o em texto</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Integrando infraestrutura como c√≥digo em um pipeline de entrega cont√≠nua</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Testando a infraestrutura como c√≥digo</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Desenvolvimento e manuten√ß√£o eficazes de pap√©is Ansible</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Ansible n√£o √© festan√ßa para voc√™!</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Idempotente Ansible</a> </li></ul></div></div></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt467171/">https://habr.com/ru/post/pt467171/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt467155/index.html">Pr√°ticas recomendadas para cont√™ineres Kubernetes: verifica√ß√µes de sa√∫de</a></li>
<li><a href="../pt467161/index.html">Aplicativo da Web no Kotlin + Spring Boot + Vue.js</a></li>
<li><a href="../pt467163/index.html">Como migrar para a nuvem em duas horas, gra√ßas ao Kubernetes e √† automa√ß√£o</a></li>
<li><a href="../pt467165/index.html">Seguindo os passos do movimento russo Scala. Parte 2</a></li>
<li><a href="../pt467169/index.html">Li√ß√µes aprendidas ao testar Mais de 200.000 linhas de c√≥digo de infraestrutura</a></li>
<li><a href="../pt467173/index.html">Arquive a implementa√ß√£o segura de ERP</a></li>
<li><a href="../pt467177/index.html">Tarantino Marketing Tips: Qual o papel dos p√©s e por que fazer Sabonete Uma Thurman</a></li>
<li><a href="../pt467179/index.html">Samsung Compiler Bootcamp: ensine a criar "programas de programa√ß√£o"</a></li>
<li><a href="../pt467181/index.html">Tentando criar um anal√≥gico ASH para o PostgreSQL</a></li>
<li><a href="../pt467183/index.html">Estudo das 50 principais plataformas de bot de bate-papo e assistentes virtuais em 2019</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>