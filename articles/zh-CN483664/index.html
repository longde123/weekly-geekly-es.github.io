<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ğŸ›ï¸ ğŸ‘©â€â¤ï¸â€ğŸ‘© â—¼ï¸ TensorFlowä¸­çš„KerasåŠŸèƒ½API ğŸ§”ğŸ½ ğŸ” ğŸšµğŸ½</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Keraså…·æœ‰ä¸¤ä¸ªAPIï¼Œç”¨äºå¿«é€Ÿæ„å»ºé¡ºåºå’ŒåŠŸèƒ½ç¥ç»ç½‘ç»œä½“ç³»ç»“æ„ã€‚ å¦‚æœç¬¬ä¸€ä¸ªåªå…è®¸æ‚¨æ„å»ºç¥ç»ç½‘ç»œçš„é¡ºåºä½“ç³»ç»“æ„ï¼Œåˆ™å¯ä»¥ä½¿ç”¨Functional APIä»¥ä»»æ„æœ‰å‘æ— ç¯å›¾çš„å½¢å¼å®šä¹‰ç¥ç»ç½‘ç»œï¼Œè¿™ä¸ºæ„å»ºå¤æ‚æ¨¡å‹æä¾›äº†æ›´å¤šæœºä¼šã€‚ æœ¬æ–‡æ˜¯TensorFlowç½‘ç«™ä¸Šçš„ã€ŠåŠŸèƒ½APIåŠŸèƒ½æŒ‡å—ã€‹çš„ç¿»è¯‘ç‰ˆæœ¬ã€‚ 

 å¼•...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>TensorFlowä¸­çš„KerasåŠŸèƒ½API</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/483664/"><img src="https://habrastorage.org/webt/w1/zr/n8/w1zrn8ydafoxahso_ig7vx1stfg.png"><br><br>  Keraså…·æœ‰ä¸¤ä¸ªAPIï¼Œç”¨äºå¿«é€Ÿæ„å»ºé¡ºåºå’ŒåŠŸèƒ½ç¥ç»ç½‘ç»œä½“ç³»ç»“æ„ã€‚ å¦‚æœç¬¬ä¸€ä¸ªåªå…è®¸æ‚¨æ„å»ºç¥ç»ç½‘ç»œçš„é¡ºåºä½“ç³»ç»“æ„ï¼Œåˆ™å¯ä»¥ä½¿ç”¨Functional APIä»¥ä»»æ„æœ‰å‘æ— ç¯å›¾çš„å½¢å¼å®šä¹‰ç¥ç»ç½‘ç»œï¼Œè¿™ä¸ºæ„å»ºå¤æ‚æ¨¡å‹æä¾›äº†æ›´å¤šæœºä¼šã€‚ æœ¬æ–‡æ˜¯TensorFlowç½‘ç«™ä¸Šçš„ã€ŠåŠŸèƒ½APIåŠŸèƒ½æŒ‡å—ã€‹çš„ç¿»è¯‘ç‰ˆæœ¬ã€‚ <br><a name="habracut"></a><br><h2> å¼•è¨€ </h2><br> é€šè¿‡åŠŸèƒ½APIï¼Œæ‚¨å¯ä»¥æ¯”é¡ºåºAPIæ›´çµæ´»åœ°åˆ›å»ºæ¨¡å‹ï¼›å®ƒå¯ä»¥å¤„ç†å…·æœ‰éçº¿æ€§æ‹“æ‰‘çš„æ¨¡å‹ï¼Œå…·æœ‰å…¬å…±å±‚çš„æ¨¡å‹ä»¥åŠå…·æœ‰å¤šä¸ªè¾“å…¥æˆ–è¾“å‡ºçš„æ¨¡å‹ã€‚ <br><br> å®ƒåŸºäºè¿™æ ·ä¸€ä¸ªäº‹å®ï¼Œå³æ·±åº¦å­¦ä¹ æ¨¡å‹é€šå¸¸æ˜¯å±‚çš„æœ‰å‘æ— ç¯å›¾ï¼ˆDAGï¼‰ <br><br> åŠŸèƒ½APIæ˜¯ç”¨äº<b>ç»˜åˆ¶å›¾å±‚çš„</b>ä¸€ç»„å·¥å…·ã€‚ <br><br> è€ƒè™‘ä»¥ä¸‹æ¨¡å‹ï¼š <br><br><blockquote>  ï¼ˆè¾“å…¥ï¼š784ç»´å‘é‡ï¼‰ <br>  â†§ <br>  [è‡´å¯†å±‚ï¼ˆ64ä¸ªå…ƒç´ ï¼Œæ¿€æ´»reluï¼‰] <br>  â†§ <br>  [è‡´å¯†å±‚ï¼ˆ64ä¸ªå…ƒç´ ï¼Œæ¿€æ´»reluï¼‰] <br>  â†§ <br>  [è‡´å¯†å±‚ï¼ˆ10ä¸ªå…ƒç´ ï¼Œæ¿€æ´»softmaxï¼‰] <br>  â†§ <br>  ï¼ˆè¾“å‡ºï¼š10ä¸ªç±»åˆ«çš„æ¦‚ç‡åˆ†å¸ƒï¼‰ </blockquote> è¿™æ˜¯3å±‚çš„ç®€å•å›¾å½¢ã€‚ <br><br> è¦ä½¿ç”¨Functional APIæ„å»ºæ­¤æ¨¡å‹ï¼Œæ‚¨éœ€è¦é¦–å…ˆåˆ›å»ºä¸€ä¸ªè¾“å…¥èŠ‚ç‚¹ï¼š <br><br><pre><code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> tensorflow <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> keras inputs = keras.Input(shape=(<span class="hljs-number"><span class="hljs-number">784</span></span>,))</code> </pre> <br> åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬ä»…æŒ‡ç¤ºæ•°æ®çš„ç»´æ•°ï¼š784ç»´å‘é‡ã€‚ è¯·æ³¨æ„ï¼Œæ€»æ˜¯å¿½ç•¥æ•°æ®é‡ï¼Œæˆ‘ä»¬ä»…æŒ‡ç¤ºæ¯ä¸ªå…ƒç´ çš„å°ºå¯¸ã€‚ è¦è¾“å…¥ç”¨äºå›¾åƒ`ï¼ˆ32ï¼Œ32ï¼Œ3ï¼‰`çš„å°ºå¯¸ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨ï¼š <br><br><pre> <code class="python hljs">img_inputs = keras.Input(shape=(<span class="hljs-number"><span class="hljs-number">32</span></span>, <span class="hljs-number"><span class="hljs-number">32</span></span>, <span class="hljs-number"><span class="hljs-number">3</span></span>))</code> </pre> <br>  <code>inputs</code>è¿”å›çš„å†…å®¹åŒ…å«æœ‰å…³æ‚¨è®¡åˆ’è½¬ç§»åˆ°æ¨¡å‹çš„æ•°æ®çš„å¤§å°å’Œç±»å‹çš„ä¿¡æ¯ï¼š <br><br><pre> <code class="python hljs">inputs.shape</code> </pre> <br><pre> <code class="python hljs">TensorShape([<span class="hljs-keyword"><span class="hljs-keyword">None</span></span>, <span class="hljs-number"><span class="hljs-number">784</span></span>])</code> </pre> <br><pre> <code class="python hljs">inputs.dtype</code> </pre> <br><pre> <code class="python hljs">tf.float32</code> </pre> <br> é€šè¿‡åœ¨æ­¤<code>inputs</code>å¯¹è±¡ä¸Šè°ƒç”¨å›¾å±‚ï¼Œå¯ä»¥åœ¨å›¾å±‚å›¾ä¸­åˆ›å»ºä¸€ä¸ªæ–°èŠ‚ç‚¹ï¼š <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> tensorflow.keras <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> layers dense = layers.Dense(<span class="hljs-number"><span class="hljs-number">64</span></span>, activation=<span class="hljs-string"><span class="hljs-string">'relu'</span></span>) x = dense(inputs)</code> </pre> <br>  â€œè°ƒç”¨å›¾å±‚â€ç±»ä¼¼äºå°†ç®­å¤´ä»â€œè¾“å…¥â€ç»˜åˆ¶åˆ°æˆ‘ä»¬åˆ›å»ºçš„å›¾å±‚ä¸­ã€‚ æˆ‘ä»¬å°†è¾“å…¥â€œä¼ é€’â€åˆ°<code>dense</code>å±‚ï¼Œå¾—åˆ°<code>x</code> ã€‚ <br><br> è®©æˆ‘ä»¬åœ¨å›¾å±‚å›¾ä¸­æ·»åŠ æ›´å¤šçš„å›¾å±‚ï¼š <br><br><pre> <code class="python hljs">x = layers.Dense(<span class="hljs-number"><span class="hljs-number">64</span></span>, activation=<span class="hljs-string"><span class="hljs-string">'relu'</span></span>)(x) outputs = layers.Dense(<span class="hljs-number"><span class="hljs-number">10</span></span>, activation=<span class="hljs-string"><span class="hljs-string">'softmax'</span></span>)(x)</code> </pre> <br> ç°åœ¨æˆ‘ä»¬å¯ä»¥<code>Model</code>åœ¨å›¾å±‚å›¾ä¸­æŒ‡å®šå…¶è¾“å…¥å’Œè¾“å‡ºæ¥åˆ›å»º<code>Model</code> ï¼š <br><br><pre> <code class="python hljs">model = keras.Model(inputs=inputs, outputs=outputs)</code> </pre> <br> è®©æˆ‘ä»¬å†æ¬¡çœ‹ä¸€ä¸‹å®Œæ•´çš„æ¨¡å‹å®šä¹‰è¿‡ç¨‹ï¼š <br><br><pre> <code class="python hljs">inputs = keras.Input(shape=(<span class="hljs-number"><span class="hljs-number">784</span></span>,), name=<span class="hljs-string"><span class="hljs-string">'img'</span></span>) x = layers.Dense(<span class="hljs-number"><span class="hljs-number">64</span></span>, activation=<span class="hljs-string"><span class="hljs-string">'relu'</span></span>)(inputs) x = layers.Dense(<span class="hljs-number"><span class="hljs-number">64</span></span>, activation=<span class="hljs-string"><span class="hljs-string">'relu'</span></span>)(x) outputs = layers.Dense(<span class="hljs-number"><span class="hljs-number">10</span></span>, activation=<span class="hljs-string"><span class="hljs-string">'softmax'</span></span>)(x) model = keras.Model(inputs=inputs, outputs=outputs, name=<span class="hljs-string"><span class="hljs-string">'mnist_model'</span></span>)</code> </pre> <br> è®©æˆ‘ä»¬çœ‹çœ‹æ¨¡å‹æ‘˜è¦æ˜¯ä»€ä¹ˆæ ·çš„ï¼š <br><br><pre> <code class="python hljs">model.summary()</code> </pre> <br><pre> <code class="python hljs">Model: <span class="hljs-string"><span class="hljs-string">"mnist_model"</span></span> _________________________________________________________________ Layer (type) Output Shape Param <span class="hljs-comment"><span class="hljs-comment"># ================================================================= img (InputLayer) [(None, 784)] 0 _________________________________________________________________ dense_3 (Dense) (None, 64) 50240 _________________________________________________________________ dense_4 (Dense) (None, 64) 4160 _________________________________________________________________ dense_5 (Dense) (None, 10) 650 ================================================================= Total params: 55,050 Trainable params: 55,050 Non-trainable params: 0 _________________________________________________________________</span></span></code> </pre> <br> æˆ‘ä»¬è¿˜å¯ä»¥å°†æ¨¡å‹ç»˜åˆ¶ä¸ºå›¾å½¢ï¼š <br><br><pre> <code class="python hljs">keras.utils.plot_model(model, <span class="hljs-string"><span class="hljs-string">'my_first_model.png'</span></span>)</code> </pre> <br><img src="https://habrastorage.org/webt/oq/4o/vl/oq4ovlxewr3hxczaldchmbeyfua.png" alt="å›¾ç‰‡"><br><br> å¹¶å¯é€‰åœ°å¾—å‡ºæ„é€ å›¾ä¸Šæ¯ä¸€å±‚çš„è¾“å…¥å’Œè¾“å‡ºçš„å°ºå¯¸ï¼š <br><br><pre> <code class="python hljs">keras.utils.plot_model(model, <span class="hljs-string"><span class="hljs-string">'my_first_model_with_shape_info.png'</span></span>, show_shapes=<span class="hljs-keyword"><span class="hljs-keyword">True</span></span>)</code> </pre> <br><img src="https://habrastorage.org/webt/fn/rm/hc/fnrmhcqknnsjdcgmqp9w6dpong8.png" alt="å›¾ç‰‡"><br><br> æ­¤å›¾åƒå’Œæˆ‘ä»¬ç¼–å†™çš„ä»£ç ç›¸åŒã€‚ åœ¨ä»£ç ç‰ˆæœ¬ä¸­ï¼Œç»‘å®šç®­å¤´ä»…ç”±è°ƒç”¨æ“ä½œä»£æ›¿ã€‚ <br><br>  â€œå±‚å›¾â€æ˜¯ç”¨äºæ·±åº¦å­¦ä¹ æ¨¡å‹çš„éå¸¸ç›´è§‚çš„å¿ƒç†å›¾åƒï¼Œè€ŒFunctional APIæ˜¯åˆ›å»ºç´§å¯†åæ˜ è¯¥å¿ƒç†å›¾åƒçš„æ¨¡å‹çš„æ–¹æ³•ã€‚ <br><br><h2> åŸ¹è®­ï¼Œè¯„ä¼°å’Œç»“è®º </h2><br> å°±åƒåœ¨é¡ºåºæ¨¡å‹ä¸­ä¸€æ ·ï¼Œå­¦ä¹ ï¼Œè¯„ä¼°å’Œæ¨å¯¼ä½¿ç”¨åŠŸèƒ½APIæ„å»ºçš„æ¨¡å‹çš„å·¥ä½œã€‚ <br><br> è€ƒè™‘ä¸€ä¸ªå¿«é€Ÿæ¼”ç¤ºã€‚ <br><br> åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬åŠ è½½MNISTå›¾åƒæ•°æ®é›†ï¼Œå°†å…¶è½¬æ¢ä¸ºçŸ¢é‡ï¼Œåœ¨æ•°æ®ä¸Šè®­ç»ƒæ¨¡å‹ï¼ˆåŒæ—¶ç›‘è§†æµ‹è¯•æ ·æœ¬çš„å·¥ä½œè´¨é‡ï¼‰ï¼Œæœ€åæˆ‘ä»¬åœ¨æµ‹è¯•æ•°æ®ä¸Šè¯„ä¼°æ¨¡å‹ï¼š <br><br><pre> <code class="python hljs">(x_train, y_train), (x_test, y_test) = keras.datasets.mnist.load_data() x_train = x_train.reshape(<span class="hljs-number"><span class="hljs-number">60000</span></span>, <span class="hljs-number"><span class="hljs-number">784</span></span>).astype(<span class="hljs-string"><span class="hljs-string">'float32'</span></span>) / <span class="hljs-number"><span class="hljs-number">255</span></span> x_test = x_test.reshape(<span class="hljs-number"><span class="hljs-number">10000</span></span>, <span class="hljs-number"><span class="hljs-number">784</span></span>).astype(<span class="hljs-string"><span class="hljs-string">'float32'</span></span>) / <span class="hljs-number"><span class="hljs-number">255</span></span> model.compile(loss=<span class="hljs-string"><span class="hljs-string">'sparse_categorical_crossentropy'</span></span>, optimizer=keras.optimizers.RMSprop(), metrics=[<span class="hljs-string"><span class="hljs-string">'accuracy'</span></span>]) history = model.fit(x_train, y_train, batch_size=<span class="hljs-number"><span class="hljs-number">64</span></span>, epochs=<span class="hljs-number"><span class="hljs-number">5</span></span>, validation_split=<span class="hljs-number"><span class="hljs-number">0.2</span></span>) test_scores = model.evaluate(x_test, y_test, verbose=<span class="hljs-number"><span class="hljs-number">2</span></span>) print(<span class="hljs-string"><span class="hljs-string">'Test loss:'</span></span>, test_scores[<span class="hljs-number"><span class="hljs-number">0</span></span>]) print(<span class="hljs-string"><span class="hljs-string">'Test accuracy:'</span></span>, test_scores[<span class="hljs-number"><span class="hljs-number">1</span></span>])</code> </pre> <br><h2> ä¿å­˜å’Œåºåˆ—åŒ– </h2><br> ä½¿ç”¨Functional APIæ„å»ºçš„æ¨¡å‹çš„ä¿å­˜å’Œåºåˆ—åŒ–ä¸é¡ºåºæ¨¡å‹çš„ä¿å­˜å’Œåºåˆ—åŒ–å®Œå…¨ç›¸åŒã€‚ <br><br> ä¿å­˜åŠŸèƒ½æ¨¡å‹çš„æ ‡å‡†æ–¹æ³•æ˜¯è°ƒç”¨<code>model.save(</code> ï¼‰ï¼Œå®ƒå…è®¸æ‚¨å°†æ•´ä¸ªæ¨¡å‹ä¿å­˜åœ¨ä¸€ä¸ªæ–‡ä»¶ä¸­ã€‚ <br><br> ä»¥åï¼Œå³ä½¿æ‚¨ä¸å†æœ‰æƒè®¿é—®åˆ›å»ºæ¨¡å‹çš„ä»£ç ï¼Œä¹Ÿå¯ä»¥ä»è¯¥æ–‡ä»¶æ¢å¤ç›¸åŒçš„æ¨¡å‹ã€‚ <br><br> è¯¥æ–‡ä»¶åŒ…æ‹¬ï¼š <br><br><ul><li> æ¨¡å‹æ¶æ„ </li><li> æ¨¡å‹æƒé‡ï¼ˆåœ¨è®­ç»ƒè¿‡ç¨‹ä¸­è·å¾—ï¼‰ </li><li> æ¨¡å‹è®­ç»ƒé…ç½®ï¼ˆæ‚¨åœ¨<code>compile</code>ä¼ é€’çš„å†…å®¹ï¼‰ </li><li> ä¼˜åŒ–å™¨åŠå…¶æ¡ä»¶ï¼ˆå¦‚æœæœ‰ï¼‰ï¼ˆè¿™ä½¿æ‚¨å¯ä»¥ä»ä¸Šæ¬¡åœæ­¢çš„åœ°æ–¹ç»§ç»­è®­ç»ƒï¼‰ </li></ul><br><pre> <code class="python hljs">model.save(<span class="hljs-string"><span class="hljs-string">'path_to_my_model.h5'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">del</span></span> model <span class="hljs-comment"><span class="hljs-comment"># Recreate the exact same model purely from the file: model = keras.models.load_model('path_to_my_model.h5')</span></span></code> </pre><br><h2> ä½¿ç”¨åŒä¸€å±‚å›¾å®šä¹‰å¤šä¸ªæ¨¡å‹ </h2><br> åœ¨Functional APIä¸­ï¼Œé€šè¿‡åœ¨å›¾å±‚å›¾ä¸­æŒ‡å®šè¾“å…¥å’Œè¾“å‡ºæ•°æ®æ¥åˆ›å»ºæ¨¡å‹ã€‚ è¿™æ„å‘³ç€å•å±‚å›¾å¯ç”¨äºç”Ÿæˆå¤šä¸ªæ¨¡å‹ã€‚ <br><br> åœ¨ä¸‹é¢çš„ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨ç›¸åŒçš„å›¾å±‚å †æ ˆæ¥åˆ›å»ºä¸¤ä¸ªæ¨¡å‹ï¼š <br> å°†è¾“å…¥å›¾åƒè½¬æ¢ä¸º16ç»´çŸ¢é‡çš„<code> (encoder)</code>æ¨¡å‹ï¼Œä»¥åŠç”¨äºè®­ç»ƒçš„ç«¯åˆ°ç«¯<code> (autoencoder)</code> <code> (encoder)</code>æ¨¡å‹ã€‚ <br><br><pre> <code class="python hljs">encoder_input = keras.Input(shape=(<span class="hljs-number"><span class="hljs-number">28</span></span>, <span class="hljs-number"><span class="hljs-number">28</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>), name=<span class="hljs-string"><span class="hljs-string">'img'</span></span>) x = layers.Conv2D(<span class="hljs-number"><span class="hljs-number">16</span></span>, <span class="hljs-number"><span class="hljs-number">3</span></span>, activation=<span class="hljs-string"><span class="hljs-string">'relu'</span></span>)(encoder_input) x = layers.Conv2D(<span class="hljs-number"><span class="hljs-number">32</span></span>, <span class="hljs-number"><span class="hljs-number">3</span></span>, activation=<span class="hljs-string"><span class="hljs-string">'relu'</span></span>)(x) x = layers.MaxPooling2D(<span class="hljs-number"><span class="hljs-number">3</span></span>)(x) x = layers.Conv2D(<span class="hljs-number"><span class="hljs-number">32</span></span>, <span class="hljs-number"><span class="hljs-number">3</span></span>, activation=<span class="hljs-string"><span class="hljs-string">'relu'</span></span>)(x) x = layers.Conv2D(<span class="hljs-number"><span class="hljs-number">16</span></span>, <span class="hljs-number"><span class="hljs-number">3</span></span>, activation=<span class="hljs-string"><span class="hljs-string">'relu'</span></span>)(x) encoder_output = layers.GlobalMaxPooling2D()(x) encoder = keras.Model(encoder_input, encoder_output, name=<span class="hljs-string"><span class="hljs-string">'encoder'</span></span>) encoder.summary() x = layers.Reshape((<span class="hljs-number"><span class="hljs-number">4</span></span>, <span class="hljs-number"><span class="hljs-number">4</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>))(encoder_output) x = layers.Conv2DTranspose(<span class="hljs-number"><span class="hljs-number">16</span></span>, <span class="hljs-number"><span class="hljs-number">3</span></span>, activation=<span class="hljs-string"><span class="hljs-string">'relu'</span></span>)(x) x = layers.Conv2DTranspose(<span class="hljs-number"><span class="hljs-number">32</span></span>, <span class="hljs-number"><span class="hljs-number">3</span></span>, activation=<span class="hljs-string"><span class="hljs-string">'relu'</span></span>)(x) x = layers.UpSampling2D(<span class="hljs-number"><span class="hljs-number">3</span></span>)(x) x = layers.Conv2DTranspose(<span class="hljs-number"><span class="hljs-number">16</span></span>, <span class="hljs-number"><span class="hljs-number">3</span></span>, activation=<span class="hljs-string"><span class="hljs-string">'relu'</span></span>)(x) decoder_output = layers.Conv2DTranspose(<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">3</span></span>, activation=<span class="hljs-string"><span class="hljs-string">'relu'</span></span>)(x) autoencoder = keras.Model(encoder_input, decoder_output, name=<span class="hljs-string"><span class="hljs-string">'autoencoder'</span></span>) autoencoder.summary()</code> </pre><br> è¯·æ³¨æ„ï¼Œæˆ‘ä»¬ä½¿è§£ç æ¶æ„ä¸ç¼–ç æ¶æ„ä¸¥æ ¼å¯¹ç§°ï¼Œä»¥ä¾¿ä½¿è¾“å‡ºæ•°æ®çš„ç»´æ•°ä¸è¾“å…¥æ•°æ®<code>(28, 28, 1)</code> ã€‚  <code>Conv2D</code>å±‚<code>Conv2D</code>åˆ°<code>Conv2D</code>å±‚ï¼Œè€Œ<code>MaxPooling2D</code>å±‚å°†å›åˆ°<code>MaxPooling2D</code>å±‚ã€‚ <br><br><h2> æ¨¡å‹å¯ä»¥ç§°ä¸ºå›¾å±‚ </h2><br> æ‚¨å¯ä»¥ä½¿ç”¨ä»»ä½•æ¨¡å‹ï¼Œå°±å¥½åƒå®ƒæ˜¯ä¸€ä¸ªå±‚ä¸€æ ·ï¼Œåœ¨<code>Input</code>æˆ–å¦ä¸€å±‚çš„è¾“å‡ºä¸Šè°ƒç”¨å®ƒã€‚ <br><br> è¯·æ³¨æ„ï¼Œé€šè¿‡è°ƒç”¨æ¨¡å‹ï¼Œä¸ä»…å¯ä»¥é‡ç”¨å…¶ä½“ç³»ç»“æ„ï¼Œè¿˜å¯ä»¥é‡ç”¨å…¶æƒé‡ã€‚ è®©æˆ‘ä»¬æ¥çœ‹çœ‹å®ƒçš„ä½œç”¨ã€‚ è¿™æ˜¯å¦ä¸€ç§è‡ªåŠ¨ç¼–ç å™¨çš„ç¤ºä¾‹ï¼Œå½“åˆ›å»ºç¼–ç å™¨æ¨¡å‹ï¼Œè§£ç å™¨æ¨¡å‹å¹¶å°†å®ƒä»¬è¿æ¥åˆ°ä¸¤ä¸ªè°ƒç”¨ä¸­ä»¥è·å¾—è‡ªåŠ¨ç¼–ç å™¨æ¨¡å‹æ—¶ï¼š <br><br><pre> <code class="python hljs">encoder_input = keras.Input(shape=(<span class="hljs-number"><span class="hljs-number">28</span></span>, <span class="hljs-number"><span class="hljs-number">28</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>), name=<span class="hljs-string"><span class="hljs-string">'original_img'</span></span>) x = layers.Conv2D(<span class="hljs-number"><span class="hljs-number">16</span></span>, <span class="hljs-number"><span class="hljs-number">3</span></span>, activation=<span class="hljs-string"><span class="hljs-string">'relu'</span></span>)(encoder_input) x = layers.Conv2D(<span class="hljs-number"><span class="hljs-number">32</span></span>, <span class="hljs-number"><span class="hljs-number">3</span></span>, activation=<span class="hljs-string"><span class="hljs-string">'relu'</span></span>)(x) x = layers.MaxPooling2D(<span class="hljs-number"><span class="hljs-number">3</span></span>)(x) x = layers.Conv2D(<span class="hljs-number"><span class="hljs-number">32</span></span>, <span class="hljs-number"><span class="hljs-number">3</span></span>, activation=<span class="hljs-string"><span class="hljs-string">'relu'</span></span>)(x) x = layers.Conv2D(<span class="hljs-number"><span class="hljs-number">16</span></span>, <span class="hljs-number"><span class="hljs-number">3</span></span>, activation=<span class="hljs-string"><span class="hljs-string">'relu'</span></span>)(x) encoder_output = layers.GlobalMaxPooling2D()(x) encoder = keras.Model(encoder_input, encoder_output, name=<span class="hljs-string"><span class="hljs-string">'encoder'</span></span>) encoder.summary() decoder_input = keras.Input(shape=(<span class="hljs-number"><span class="hljs-number">16</span></span>,), name=<span class="hljs-string"><span class="hljs-string">'encoded_img'</span></span>) x = layers.Reshape((<span class="hljs-number"><span class="hljs-number">4</span></span>, <span class="hljs-number"><span class="hljs-number">4</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>))(decoder_input) x = layers.Conv2DTranspose(<span class="hljs-number"><span class="hljs-number">16</span></span>, <span class="hljs-number"><span class="hljs-number">3</span></span>, activation=<span class="hljs-string"><span class="hljs-string">'relu'</span></span>)(x) x = layers.Conv2DTranspose(<span class="hljs-number"><span class="hljs-number">32</span></span>, <span class="hljs-number"><span class="hljs-number">3</span></span>, activation=<span class="hljs-string"><span class="hljs-string">'relu'</span></span>)(x) x = layers.UpSampling2D(<span class="hljs-number"><span class="hljs-number">3</span></span>)(x) x = layers.Conv2DTranspose(<span class="hljs-number"><span class="hljs-number">16</span></span>, <span class="hljs-number"><span class="hljs-number">3</span></span>, activation=<span class="hljs-string"><span class="hljs-string">'relu'</span></span>)(x) decoder_output = layers.Conv2DTranspose(<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">3</span></span>, activation=<span class="hljs-string"><span class="hljs-string">'relu'</span></span>)(x) decoder = keras.Model(decoder_input, decoder_output, name=<span class="hljs-string"><span class="hljs-string">'decoder'</span></span>) decoder.summary() autoencoder_input = keras.Input(shape=(<span class="hljs-number"><span class="hljs-number">28</span></span>, <span class="hljs-number"><span class="hljs-number">28</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>), name=<span class="hljs-string"><span class="hljs-string">'img'</span></span>) encoded_img = encoder(autoencoder_input) decoded_img = decoder(encoded_img) autoencoder = keras.Model(autoencoder_input, decoded_img, name=<span class="hljs-string"><span class="hljs-string">'autoencoder'</span></span>) autoencoder.summary()</code> </pre> <br> å¦‚æ‚¨æ‰€è§ï¼Œå¯ä»¥åµŒå¥—ä¸€ä¸ªæ¨¡å‹ï¼šä¸€ä¸ªæ¨¡å‹å¯ä»¥åŒ…å«ä¸€ä¸ªå­æ¨¡å‹ï¼ˆå› ä¸ºè¯¥æ¨¡å‹å¯ä»¥è§†ä¸ºä¸€ä¸ªå±‚ï¼‰ã€‚ <br><br> åµŒå¥—æ¨¡å‹çš„ä¸€ä¸ªå¸¸è§ç”¨ä¾‹æ˜¯<i>é›†åˆ</i> ã€‚ <br><br> ä¸¾ä¾‹æ¥è¯´ï¼Œä»¥ä¸‹æ˜¯å°†ä¸€ç»„æ¨¡å‹ç»„åˆæˆä¸€ä¸ªå¯¹é¢„æµ‹å€¼æ±‚å¹³å‡çš„æ¨¡å‹çš„æ–¹æ³•ï¼š <br><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">get_model</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">:</span></span> inputs = keras.Input(shape=(<span class="hljs-number"><span class="hljs-number">128</span></span>,)) outputs = layers.Dense(<span class="hljs-number"><span class="hljs-number">1</span></span>, activation=<span class="hljs-string"><span class="hljs-string">'sigmoid'</span></span>)(inputs) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> keras.Model(inputs, outputs) model1 = get_model() model2 = get_model() model3 = get_model() inputs = keras.Input(shape=(<span class="hljs-number"><span class="hljs-number">128</span></span>,)) y1 = model1(inputs) y2 = model2(inputs) y3 = model3(inputs) outputs = layers.average([y1, y2, y3]) ensemble_model = keras.Model(inputs=inputs, outputs=outputs)</code> </pre> <br><br><h2> å¤„ç†å¤æ‚çš„å›¾æ‹“æ‰‘ </h2><br><h3> å…·æœ‰å¤šä¸ªè¾“å…¥å’Œè¾“å‡ºçš„æ¨¡å‹ </h3><br>  Functional APIç®€åŒ–äº†å¤šä¸ªè¾“å…¥å’Œè¾“å‡ºçš„æ“ä½œã€‚ è¿™ä¸èƒ½ä½¿ç”¨é¡ºåºAPIæ¥å®Œæˆã€‚ <br><br> è¿™æ˜¯ä¸€ä¸ªç®€å•çš„ä¾‹å­ã€‚ <br><br> å‡è®¾æ‚¨æ­£åœ¨åˆ›å»ºä¸€ä¸ªç³»ç»Ÿï¼Œç”¨äºæŒ‰ä¼˜å…ˆçº§å¯¹å®¢æˆ·åº”ç”¨ç¨‹åºè¿›è¡Œæ’åï¼Œå¹¶å°†å…¶å‘é€ç»™æ­£ç¡®çš„éƒ¨é—¨ã€‚ <br><br> æ‚¨çš„æ¨¡å‹å°†å…·æœ‰3ä¸ªè¾“å…¥ï¼š <br><br><ul><li> åº”ç”¨ç¨‹åºæ ‡é¢˜ï¼ˆæ–‡æœ¬è¾“å…¥ï¼‰ </li><li> åº”ç”¨ç¨‹åºçš„æ–‡æœ¬å†…å®¹ï¼ˆæ–‡æœ¬è¾“å…¥ï¼‰ </li><li> ç”¨æˆ·æ·»åŠ çš„æ‰€æœ‰æ ‡ç­¾ï¼ˆåˆ†ç±»è¾“å…¥ï¼‰ </li></ul><br> è¯¥æ¨¡å‹å°†æœ‰2ä¸ªè¾“å‡ºï¼š <br><br><ul><li> ä¼˜å…ˆçº§å¾—åˆ†ä»‹äº0å’Œ1ä¹‹é—´ï¼ˆæ ‡é‡Så‹è¾“å‡ºï¼‰ </li><li> å¿…é¡»å¤„ç†åº”ç”¨ç¨‹åºçš„éƒ¨é—¨ï¼ˆæœ‰å…³å¤šä¸ªéƒ¨é—¨çš„softmaxè¾“å‡ºï¼‰ </li></ul><br> è®©æˆ‘ä»¬ä½¿ç”¨Functional APIå‡ è¡Œæ„å»ºä¸€ä¸ªæ¨¡å‹ã€‚ <br><br><pre> <code class="python hljs">num_tags = <span class="hljs-number"><span class="hljs-number">12</span></span> <span class="hljs-comment"><span class="hljs-comment">#     num_words = 10000 #         num_departments = 4 #     title_input = keras.Input(shape=(None,), name='title') #      body_input = keras.Input(shape=(None,), name='body') #      tags_input = keras.Input(shape=(num_tags,), name='tags') #    `num_tags` #      64-  title_features = layers.Embedding(num_words, 64)(title_input) #      64-  body_features = layers.Embedding(num_words, 64)(body_input) #        128-  title_features = layers.LSTM(128)(title_features) #        32-  body_features = layers.LSTM(32)(body_features) #          x = layers.concatenate([title_features, body_features, tags_input]) #         priority_pred = layers.Dense(1, activation='sigmoid', name='priority')(x) #       department_pred = layers.Dense(num_departments, activation='softmax', name='department')(x) #   ,     model = keras.Model(inputs=[title_input, body_input, tags_input], outputs=[priority_pred, department_pred])</span></span></code> </pre> <br> è®©æˆ‘ä»¬ç”»ä¸€ä¸ªæ¨¡å‹å›¾ï¼š <br><br><pre> <code class="python hljs">keras.utils.plot_model(model, <span class="hljs-string"><span class="hljs-string">'multi_input_and_output_model.png'</span></span>, show_shapes=<span class="hljs-keyword"><span class="hljs-keyword">True</span></span>)</code> </pre> <br><img src="https://habrastorage.org/webt/gc/hk/uw/gchkuwc_zgefnaf4tx0ercck8bc.png"><br><br> ç¼–è¯‘æ­¤æ¨¡å‹æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥ä¸ºæ¯ä¸ªè¾“å‡ºåˆ†é…ä¸åŒçš„æŸå¤±å‡½æ•°ã€‚ <br><br> æ‚¨ç”šè‡³å¯ä»¥ä¸ºæ¯ä¸ªæŸå¤±å‡½æ•°åˆ†é…ä¸åŒçš„æƒé‡ï¼Œä»¥æ”¹å˜å®ƒä»¬å¯¹æ•´ä½“å­¦ä¹ æŸå¤±å‡½æ•°çš„è´¡çŒ®ã€‚ <br><br><pre> <code class="python hljs">model.compile(optimizer=keras.optimizers.RMSprop(<span class="hljs-number"><span class="hljs-number">1e-3</span></span>), loss=[<span class="hljs-string"><span class="hljs-string">'binary_crossentropy'</span></span>, <span class="hljs-string"><span class="hljs-string">'categorical_crossentropy'</span></span>], loss_weights=[<span class="hljs-number"><span class="hljs-number">1.</span></span>, <span class="hljs-number"><span class="hljs-number">0.2</span></span>])</code> </pre> <br> å› ä¸ºæˆ‘ä»¬ç»™è¾“å‡ºå±‚èµ·äº†åå­—ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¹Ÿå¯ä»¥æŒ‡å®šæŸå¤±å‡½æ•°ï¼š <br><br><pre> <code class="python hljs">model.compile(optimizer=keras.optimizers.RMSprop(<span class="hljs-number"><span class="hljs-number">1e-3</span></span>), loss={<span class="hljs-string"><span class="hljs-string">'priority'</span></span>: <span class="hljs-string"><span class="hljs-string">'binary_crossentropy'</span></span>, <span class="hljs-string"><span class="hljs-string">'department'</span></span>: <span class="hljs-string"><span class="hljs-string">'categorical_crossentropy'</span></span>}, loss_weights=[<span class="hljs-number"><span class="hljs-number">1.</span></span>, <span class="hljs-number"><span class="hljs-number">0.2</span></span>])</code> </pre> <br> æˆ‘ä»¬å¯ä»¥é€šè¿‡ä¼ é€’è¾“å…¥æ•°æ®å’Œæ ‡ç­¾çš„Numpyæ•°ç»„åˆ—è¡¨æ¥è®­ç»ƒæ¨¡å‹ï¼š <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> numpy <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> np <span class="hljs-comment"><span class="hljs-comment"># Dummy input data title_data = np.random.randint(num_words, size=(1280, 10)) body_data = np.random.randint(num_words, size=(1280, 100)) tags_data = np.random.randint(2, size=(1280, num_tags)).astype('float32') # Dummy target data priority_targets = np.random.random(size=(1280, 1)) dept_targets = np.random.randint(2, size=(1280, num_departments)) model.fit({'title': title_data, 'body': body_data, 'tags': tags_data}, {'priority': priority_targets, 'department': dept_targets}, epochs=2, batch_size=32)</span></span></code> </pre><br> ä½¿ç”¨<code>Dataset</code>å¯¹è±¡è°ƒç”¨fitæ—¶ï¼Œåº”è¿”å›åˆ—è¡¨çš„å…ƒç»„ï¼ˆä¾‹å¦‚<code>([title_data, body_data, tags_data], [priority_targets, dept_targets])</code>æˆ–å­—å…¸çš„å…ƒç»„<code>({'title': title_data, 'body': body_data, 'tags': tags_data}, {'priority': priority_targets, 'department': dept_targets})</code> ã€‚ <br><br><h3> åŸ¹è®­èµ„æºæ¨¡å‹ </h3><br> é™¤äº†å…·æœ‰å¤šä¸ªè¾“å…¥å’Œè¾“å‡ºçš„æ¨¡å‹å¤–ï¼ŒFunctional APIè¿˜ç®€åŒ–äº†å…·æœ‰éçº¿æ€§è¿æ¥çš„æ‹“æ‰‘çš„æ“ä½œï¼Œå³ï¼Œå…¶ä¸­çš„æ¨¡å‹æ²¡æœ‰ä¸²è”è¿æ¥ã€‚ æ­¤ç±»æ¨¡å‹ä¹Ÿæ— æ³•ä½¿ç”¨é¡ºåºAPIæ¥å®ç°ï¼ˆé¡¾åæ€ä¹‰ï¼‰ã€‚ <br><br> å¸¸è§çš„ç”¨ä¾‹æ˜¯æ®‹ä½™è¿æ¥ã€‚ <br><br> è®©æˆ‘ä»¬ä¸ºCIFAR10å»ºç«‹ä¸€ä¸ªResNetåŸ¹è®­æ¨¡å‹æ¥æ¼”ç¤ºè¿™ä¸€ç‚¹ã€‚ <br><br><pre> <code class="python hljs">inputs = keras.Input(shape=(<span class="hljs-number"><span class="hljs-number">32</span></span>, <span class="hljs-number"><span class="hljs-number">32</span></span>, <span class="hljs-number"><span class="hljs-number">3</span></span>), name=<span class="hljs-string"><span class="hljs-string">'img'</span></span>) x = layers.Conv2D(<span class="hljs-number"><span class="hljs-number">32</span></span>, <span class="hljs-number"><span class="hljs-number">3</span></span>, activation=<span class="hljs-string"><span class="hljs-string">'relu'</span></span>)(inputs) x = layers.Conv2D(<span class="hljs-number"><span class="hljs-number">64</span></span>, <span class="hljs-number"><span class="hljs-number">3</span></span>, activation=<span class="hljs-string"><span class="hljs-string">'relu'</span></span>)(x) block_1_output = layers.MaxPooling2D(<span class="hljs-number"><span class="hljs-number">3</span></span>)(x) x = layers.Conv2D(<span class="hljs-number"><span class="hljs-number">64</span></span>, <span class="hljs-number"><span class="hljs-number">3</span></span>, activation=<span class="hljs-string"><span class="hljs-string">'relu'</span></span>, padding=<span class="hljs-string"><span class="hljs-string">'same'</span></span>)(block_1_output) x = layers.Conv2D(<span class="hljs-number"><span class="hljs-number">64</span></span>, <span class="hljs-number"><span class="hljs-number">3</span></span>, activation=<span class="hljs-string"><span class="hljs-string">'relu'</span></span>, padding=<span class="hljs-string"><span class="hljs-string">'same'</span></span>)(x) block_2_output = layers.add([x, block_1_output]) x = layers.Conv2D(<span class="hljs-number"><span class="hljs-number">64</span></span>, <span class="hljs-number"><span class="hljs-number">3</span></span>, activation=<span class="hljs-string"><span class="hljs-string">'relu'</span></span>, padding=<span class="hljs-string"><span class="hljs-string">'same'</span></span>)(block_2_output) x = layers.Conv2D(<span class="hljs-number"><span class="hljs-number">64</span></span>, <span class="hljs-number"><span class="hljs-number">3</span></span>, activation=<span class="hljs-string"><span class="hljs-string">'relu'</span></span>, padding=<span class="hljs-string"><span class="hljs-string">'same'</span></span>)(x) block_3_output = layers.add([x, block_2_output]) x = layers.Conv2D(<span class="hljs-number"><span class="hljs-number">64</span></span>, <span class="hljs-number"><span class="hljs-number">3</span></span>, activation=<span class="hljs-string"><span class="hljs-string">'relu'</span></span>)(block_3_output) x = layers.GlobalAveragePooling2D()(x) x = layers.Dense(<span class="hljs-number"><span class="hljs-number">256</span></span>, activation=<span class="hljs-string"><span class="hljs-string">'relu'</span></span>)(x) x = layers.Dropout(<span class="hljs-number"><span class="hljs-number">0.5</span></span>)(x) outputs = layers.Dense(<span class="hljs-number"><span class="hljs-number">10</span></span>, activation=<span class="hljs-string"><span class="hljs-string">'softmax'</span></span>)(x) model = keras.Model(inputs, outputs, name=<span class="hljs-string"><span class="hljs-string">'toy_resnet'</span></span>) model.summary()</code> </pre> <br> è®©æˆ‘ä»¬ç”»ä¸€ä¸ªæ¨¡å‹å›¾ï¼š <br><br><pre> <code class="python hljs">keras.utils.plot_model(model, <span class="hljs-string"><span class="hljs-string">'mini_resnet.png'</span></span>, show_shapes=<span class="hljs-keyword"><span class="hljs-keyword">True</span></span>)</code> </pre> <br><img src="https://habrastorage.org/webt/qj/vi/bk/qjvibkpx9zrbp09rcfhj_drtlzc.png"><br><br> å¹¶æ•™å¥¹ï¼š <br><br><pre> <code class="python hljs">(x_train, y_train), (x_test, y_test) = keras.datasets.cifar10.load_data() x_train = x_train.astype(<span class="hljs-string"><span class="hljs-string">'float32'</span></span>) / <span class="hljs-number"><span class="hljs-number">255.</span></span> x_test = x_test.astype(<span class="hljs-string"><span class="hljs-string">'float32'</span></span>) / <span class="hljs-number"><span class="hljs-number">255.</span></span> y_train = keras.utils.to_categorical(y_train, <span class="hljs-number"><span class="hljs-number">10</span></span>) y_test = keras.utils.to_categorical(y_test, <span class="hljs-number"><span class="hljs-number">10</span></span>) model.compile(optimizer=keras.optimizers.RMSprop(<span class="hljs-number"><span class="hljs-number">1e-3</span></span>), loss=<span class="hljs-string"><span class="hljs-string">'categorical_crossentropy'</span></span>, metrics=[<span class="hljs-string"><span class="hljs-string">'acc'</span></span>]) model.fit(x_train, y_train, batch_size=<span class="hljs-number"><span class="hljs-number">64</span></span>, epochs=<span class="hljs-number"><span class="hljs-number">1</span></span>, validation_split=<span class="hljs-number"><span class="hljs-number">0.2</span></span>)</code> </pre> <br><h2> å±‚å…±äº« </h2><br>  Functional APIçš„å¦ä¸€ä¸ªå¾ˆå¥½çš„ç”¨é€”æ˜¯ä½¿ç”¨å…¬å…±å±‚çš„æ¨¡å‹ã€‚ é€šç”¨å±‚æ˜¯åœ¨åŒä¸€æ¨¡å‹ä¸­é‡å¤ä½¿ç”¨çš„å±‚çš„å®ä¾‹ï¼šå®ƒä»¬ç ”ç©¶ä¸å±‚å›¾ä¸­çš„è‹¥å¹²è·¯å¾„ç›¸å…³çš„ç‰¹å¾ã€‚ <br><br> å…¬å…±å±‚é€šå¸¸ç”¨äºå¯¹æ¥è‡ªç›¸åŒç©ºé—´ï¼ˆä¾‹å¦‚ï¼Œæ¥è‡ªå…·æœ‰ç›¸åŒå­—å…¸çš„ä¸¤ä¸ªä¸åŒæ–‡æœ¬çš„æ–‡æœ¬ï¼‰çš„è¾“å…¥æ•°æ®è¿›è¡Œç¼–ç ï¼Œå› ä¸ºå®ƒä»¬æä¾›äº†è¿™äº›ä¸åŒæ•°æ®ä¹‹é—´çš„ä¿¡æ¯äº¤æ¢ï¼Œä»è€Œä½¿æ­¤ç±»æ¨¡å‹å¯ä»¥ä½¿ç”¨æ›´å°‘çš„æ•°æ®è¿›è¡Œè®­ç»ƒã€‚ å¦‚æœæŸä¸ªå•è¯å‡ºç°åœ¨å…¶ä¸­ä¸€ä¸ªè¾“å…¥ä¸Šï¼Œè¿™å°†æœ‰åŠ©äºåœ¨é€šè¿‡å¸¸è§„çº§åˆ«çš„æ‰€æœ‰è¾“å…¥ä¸Šå¯¹å…¶è¿›è¡Œå¤„ç†ã€‚ <br><br> è¦åœ¨Functional APIä¸­å…±äº«å±‚ï¼Œåªéœ€å¤šæ¬¡è°ƒç”¨è¯¥å±‚çš„åŒä¸€å®ä¾‹å³å¯ã€‚ ä¾‹å¦‚ï¼Œæ­¤å¤„çš„<code>Embedding</code>å±‚åœ¨ä¸¤ä¸ªæ–‡æœ¬è¾“å…¥ä¸Šå…±äº«ï¼š <br><br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment">#   1000    128-  shared_embedding = layers.Embedding(1000, 128) #     text_input_a = keras.Input(shape=(None,), dtype='int32') #     text_input_b = keras.Input(shape=(None,), dtype='int32') #           encoded_input_a = shared_embedding(text_input_a) encoded_input_b = shared_embedding(text_input_b)</span></span></code> </pre> <br><h2> æ£€ç´¢å’Œé‡ç”¨å›¾å±‚å›¾ä¸­çš„èŠ‚ç‚¹ </h2><br> ç”±äºæ‚¨åœ¨Functional APIä¸­æ“ä½œçš„å›¾å±‚å›¾æ˜¯é™æ€æ•°æ®ç»“æ„ï¼Œå› æ­¤æ‚¨å¯ä»¥å¯¹å…¶è¿›è¡Œè®¿é—®å’Œæ£€æŸ¥ã€‚ ä¾‹å¦‚ï¼Œè¿™å°±æ˜¯æˆ‘ä»¬ä»¥å›¾åƒå½¢å¼æ„å»ºåŠŸèƒ½æ¨¡å‹çš„æ–¹å¼ã€‚ <br><br> è¿™ä¹Ÿæ„å‘³ç€æˆ‘ä»¬å¯ä»¥è®¿é—®ä¸­é—´å±‚ï¼ˆå›¾ä¸­çš„â€œèŠ‚ç‚¹â€ï¼‰çš„æ¿€æ´»ï¼Œå¹¶åœ¨å…¶ä»–åœ°æ–¹ä½¿ç”¨å®ƒä»¬ã€‚ ä¾‹å¦‚ï¼Œè¿™å¯¹äºæå–ç‰¹å¾éå¸¸æœ‰ç”¨ï¼ <br><br> è®©æˆ‘ä»¬æ¥çœ‹ä¸€ä¸ªä¾‹å­ã€‚ è¿™æ˜¯ä¸€ä¸ªVGG19æ¨¡å‹ï¼Œå…¶ç¼©æ”¾æ¯”ä¾‹å·²åœ¨ImageNetä¸Šè¿›è¡Œäº†é¢„è®­ç»ƒï¼š <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> tensorflow.keras.applications <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> VGG19 vgg19 = VGG19()</code> </pre> <br> è¿™äº›æ˜¯é€šè¿‡æŸ¥è¯¢å›¾å½¢æ•°æ®ç»“æ„è·å¾—çš„ä¸­é—´æ¨¡å‹æ¿€æ´»ï¼š <br><br><pre> <code class="python hljs">features_list = [layer.output <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> layer <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> vgg19.layers]</code> </pre> <br> æˆ‘ä»¬å¯ä»¥ä½¿ç”¨è¿™äº›ç‰¹å¾æ¥åˆ›å»ºä¸€ä¸ªæ–°çš„ç‰¹å¾æå–æ¨¡å‹ï¼Œè¯¥æ¨¡å‹è¿”å›ä¸­é—´çº§åˆ«çš„æ¿€æ´»å€¼-æˆ‘ä»¬å¯ä»¥åœ¨3è¡Œä¸­å…¨éƒ¨å®Œæˆ <br><br><pre> <code class="python hljs">feat_extraction_model = keras.Model(inputs=vgg19.input, outputs=features_list) img = np.random.random((<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">224</span></span>, <span class="hljs-number"><span class="hljs-number">224</span></span>, <span class="hljs-number"><span class="hljs-number">3</span></span>)).astype(<span class="hljs-string"><span class="hljs-string">'float32'</span></span>) extracted_features = feat_extraction_model(img)</code> </pre> <br> ä¸å…¶ä»–æƒ…å†µä¸€æ ·ï¼Œè¿™åœ¨å®ç°ç¥ç»æ ·å¼è½¬æ¢æ—¶å¾ˆæ–¹ä¾¿ã€‚ <br><br><h2> é€šè¿‡ç¼–å†™è‡ªå®šä¹‰å±‚æ¥æ‰©å±•API </h2><br>  <code>tf.keras</code>å…·æœ‰å¹¿æ³›çš„å†…ç½®å±‚ã€‚ ä»¥ä¸‹æ˜¯ä¸€äº›ç¤ºä¾‹ï¼š <br><br> å·ç§¯å±‚ï¼š <code>Conv1D</code> ï¼Œ <code>Conv2D</code> ï¼Œ <code>Conv3D</code> ï¼Œ <code>Conv2DTranspose</code>ç­‰ <br>  <code>MaxPooling1D</code>å±‚ï¼š <code>MaxPooling1D</code> ï¼Œ <code>MaxPooling2D</code> ï¼Œ <code>MaxPooling3D</code> ï¼Œ <code>AveragePooling1D</code>ç­‰ <br>  RNNå±‚ï¼š <code>GRU</code> ï¼Œ <code>LSTM</code> ï¼Œ <code>ConvLSTM2D</code>ç­‰ã€‚ <br>  <code>BatchNormalization</code> ï¼Œ <code>Dropout</code> ï¼Œ <code>Embedding</code>ç­‰ <br><br> å¦‚æœæ‚¨æ‰¾ä¸åˆ°æ‰€éœ€çš„å†…å®¹ï¼Œåˆ™å¯ä»¥é€šè¿‡åˆ›å»ºè‡ªå·±çš„å±‚æ¥æ‰©å±•APIã€‚ <br><br> æ‰€æœ‰å›¾å±‚éƒ½ç»§æ‰¿äº†<code>Layer</code>ç±»å¹¶å®ç°ï¼š <br><br> å®šä¹‰è¯¥å±‚æ‰§è¡Œçš„è®¡ç®—çš„<code>call</code>æ–¹æ³•ã€‚ <br> åˆ›å»ºå›¾å±‚æƒé‡çš„<code>build</code>æ–¹æ³•ï¼ˆè¯·æ³¨æ„ï¼Œè¿™åªæ˜¯ä¸€ç§æ ·å¼çº¦å®šï¼›æ‚¨ä¹Ÿå¯ä»¥åœ¨<code>__init__</code>åˆ›å»ºæƒé‡ï¼‰ã€‚ <br><br> è¿™æ˜¯<code>Dense</code>å±‚çš„ç®€å•å®ç°ï¼š <br><br><pre> <code class="python hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CustomDense</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(layers.Layer)</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__init__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, units=</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">32</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function">:</span></span> super(CustomDense, self).__init__() self.units = units <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">build</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, input_shape)</span></span></span><span class="hljs-function">:</span></span> self.w = self.add_weight(shape=(input_shape[<span class="hljs-number"><span class="hljs-number">-1</span></span>], self.units), initializer=<span class="hljs-string"><span class="hljs-string">'random_normal'</span></span>, trainable=<span class="hljs-keyword"><span class="hljs-keyword">True</span></span>) self.b = self.add_weight(shape=(self.units,), initializer=<span class="hljs-string"><span class="hljs-string">'random_normal'</span></span>, trainable=<span class="hljs-keyword"><span class="hljs-keyword">True</span></span>) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">call</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, inputs)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> tf.matmul(inputs, self.w) + self.b inputs = keras.Input((<span class="hljs-number"><span class="hljs-number">4</span></span>,)) outputs = CustomDense(<span class="hljs-number"><span class="hljs-number">10</span></span>)(inputs) model = keras.Model(inputs, outputs)</code> </pre> <br> å¦‚æœæ‚¨å¸Œæœ›è‡ªå®šä¹‰å›¾å±‚æ”¯æŒåºåˆ—åŒ–ï¼Œåˆ™è¿˜å¿…é¡»å®šä¹‰<code>get_config</code>æ–¹æ³•ï¼Œè¯¥æ–¹æ³•è¿”å›å›¾å±‚å®ä¾‹çš„æ„é€ å‡½æ•°å‚æ•°ï¼š <br><br><pre> <code class="python hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CustomDense</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(layers.Layer)</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__init__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, units=</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">32</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function">:</span></span> super(CustomDense, self).__init__() self.units = units <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">build</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, input_shape)</span></span></span><span class="hljs-function">:</span></span> self.w = self.add_weight(shape=(input_shape[<span class="hljs-number"><span class="hljs-number">-1</span></span>], self.units), initializer=<span class="hljs-string"><span class="hljs-string">'random_normal'</span></span>, trainable=<span class="hljs-keyword"><span class="hljs-keyword">True</span></span>) self.b = self.add_weight(shape=(self.units,), initializer=<span class="hljs-string"><span class="hljs-string">'random_normal'</span></span>, trainable=<span class="hljs-keyword"><span class="hljs-keyword">True</span></span>) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">call</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, inputs)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> tf.matmul(inputs, self.w) + self.b <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">get_config</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> {<span class="hljs-string"><span class="hljs-string">'units'</span></span>: self.units} inputs = keras.Input((<span class="hljs-number"><span class="hljs-number">4</span></span>,)) outputs = CustomDense(<span class="hljs-number"><span class="hljs-number">10</span></span>)(inputs) model = keras.Model(inputs, outputs) config = model.get_config() new_model = keras.Model.from_config( config, custom_objects={<span class="hljs-string"><span class="hljs-string">'CustomDense'</span></span>: CustomDense})</code> </pre> <br>  ï¼ˆå¯é€‰ï¼‰æ‚¨è¿˜å¯ä»¥å®ç°<code>from_config (cls, config)</code>ç±»æ–¹æ³•ï¼Œè¯¥æ–¹æ³•è´Ÿè´£æ ¹æ®ç»™å®šçš„é…ç½®å­—å…¸é‡æ–°åˆ›å»ºå›¾å±‚å®ä¾‹ã€‚ é»˜è®¤<code>from_config</code>å¦‚ä¸‹æ‰€ç¤ºï¼š <br><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">from_config</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(cls, config)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> cls(**config)</code> </pre> <br><h2> ä½•æ—¶ä½¿ç”¨åŠŸèƒ½æ€§API </h2><br> å¦‚ä½•ç¡®å®šä½•æ—¶æœ€å¥½ä½¿ç”¨Functional APIåˆ›å»ºæ–°æ¨¡å‹ï¼Œæˆ–è€…ç›´æ¥å°†<code>Model</code>å­ç±»åŒ–ï¼Ÿ <br><br> é€šå¸¸ï¼ŒFunctional APIæ›´åŠ é«˜çº§ä¸”æ˜“äºä½¿ç”¨ï¼Œå®ƒå…·æœ‰è®¸å¤šå­ç±»æ¨¡å‹ä¸æ”¯æŒçš„åŠŸèƒ½ã€‚ <br><br> ä½†æ˜¯ï¼Œåœ¨åˆ›å»ºä¸å®¹æ˜“æè¿°ä¸ºæœ‰å‘æ— ç¯å±‚å›¾çš„æ¨¡å‹æ—¶ï¼Œå¯¹æ¨¡å‹è¿›è¡Œå­ç±»åŒ–å¯ä¸ºæ‚¨æä¾›æå¤§çš„çµæ´»æ€§ï¼ˆä¾‹å¦‚ï¼Œæ‚¨æ— æ³•ä½¿ç”¨Functional APIå®ç°Tree-RNNï¼Œæ‚¨éœ€è¦ç›´æ¥å¯¹<code>Model</code>è¿›è¡Œå­ç±»åŒ–ï¼‰ã€‚ <br><br><h3> åŠŸèƒ½æ€§APIçš„ä¼˜åŠ¿ï¼š </h3><br> ä¸‹é¢åˆ—å‡ºçš„å±æ€§å¯¹äºé¡ºåºæ¨¡å‹ï¼ˆä¹Ÿæ˜¯æ•°æ®ç»“æ„ï¼‰éƒ½æ˜¯æ­£ç¡®çš„ï¼Œä½†å¯¹äºå­ç±»æ¨¡å‹ï¼ˆæ˜¯Pythonä»£ç ï¼Œä¸æ˜¯æ•°æ®ç»“æ„ï¼‰éƒ½æ˜¯æ­£ç¡®çš„ã€‚ <br><br><h4>  Functional APIç”Ÿæˆè¾ƒçŸ­çš„ä»£ç ã€‚ </h4><br> æ²¡æœ‰<code>super(MyClass, self).__init__(...)</code> ï¼Œæ²¡æœ‰<code>def call(self, ...):</code>ç­‰ <br><br> æ¯”è¾ƒï¼š <br><br><pre> <code class="python hljs">inputs = keras.Input(shape=(<span class="hljs-number"><span class="hljs-number">32</span></span>,)) x = layers.Dense(<span class="hljs-number"><span class="hljs-number">64</span></span>, activation=<span class="hljs-string"><span class="hljs-string">'relu'</span></span>)(inputs) outputs = layers.Dense(<span class="hljs-number"><span class="hljs-number">10</span></span>)(x) mlp = keras.Model(inputs, outputs)</code> </pre> <br> å¸¦æœ‰å­ç±»ç‰ˆæœ¬ï¼š <br><br><pre> <code class="python hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MLP</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(keras.Model)</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__init__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, **kwargs)</span></span></span><span class="hljs-function">:</span></span> super(MLP, self).__init__(**kwargs) self.dense_1 = layers.Dense(<span class="hljs-number"><span class="hljs-number">64</span></span>, activation=<span class="hljs-string"><span class="hljs-string">'relu'</span></span>) self.dense_2 = layers.Dense(<span class="hljs-number"><span class="hljs-number">10</span></span>) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">call</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, inputs)</span></span></span><span class="hljs-function">:</span></span> x = self.dense_1(inputs) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> self.dense_2(x) <span class="hljs-comment"><span class="hljs-comment">#   . mlp = MLP() #    . #            . _ = mlp(tf.zeros((1, 32)))</span></span></code> </pre> <br><h4> æ‚¨çš„æ¨¡å‹åœ¨ç¼–å†™æ—¶å·²é€šè¿‡éªŒè¯ã€‚ </h4><br> åœ¨Functional APIä¸­ï¼Œè¾“å…¥è§„èŒƒï¼ˆshapeå’Œdtypeï¼‰æ˜¯é¢„å…ˆåˆ›å»ºçš„ï¼ˆé€šè¿‡Inputï¼‰ï¼Œå¹¶ä¸”æ¯æ¬¡è°ƒç”¨è¯¥å±‚æ—¶ï¼Œè¯¥å±‚éƒ½ä¼šæ£€æŸ¥ä¼ é€’ç»™å®ƒçš„è§„èŒƒæ˜¯å¦ç¬¦åˆå…¶å‡è®¾ï¼›å¦‚æœä¸æ˜¯è¿™ç§æƒ…å†µï¼Œæ‚¨å°†æ”¶åˆ°ä¸€æ¡æœ‰ç”¨çš„é”™è¯¯æ¶ˆæ¯ã€‚ <br><br> è¿™æ ·å¯ä»¥ç¡®ä¿æ‚¨å¯åŠ¨ä½¿ç”¨Functional APIæ„å»ºçš„ä»»ä½•æ¨¡å‹ã€‚ æ‰€æœ‰è°ƒè¯•ï¼ˆä¸æ”¶æ•›è°ƒè¯•æ— å…³ï¼‰å°†åœ¨æ¨¡å‹æ„å»ºè¿‡ç¨‹ä¸­é™æ€å‘ç”Ÿï¼Œè€Œä¸æ˜¯åœ¨è¿è¡Œæ—¶å‘ç”Ÿã€‚ è¿™ç±»ä¼¼äºç¼–è¯‘å™¨ä¸­çš„ç±»å‹æ£€æŸ¥ã€‚ <br><br><h4> æ‚¨çš„åŠŸèƒ½æ¨¡å‹å¯ä»¥ç”¨å›¾å½¢è¡¨ç¤ºï¼Œä¹Ÿå¯ä»¥æµ‹è¯•ã€‚ </h4><br> æ‚¨å¯ä»¥ä»¥å›¾å½¢çš„å½¢å¼ç»˜åˆ¶æ¨¡å‹ï¼Œå¹¶ä¸”å¯ä»¥è½»æ¾åœ°è®¿é—®å›¾å½¢çš„ä¸­é—´èŠ‚ç‚¹ï¼Œä¾‹å¦‚ï¼Œæå–å¹¶é‡ç”¨ä¸­é—´å±‚çš„æ¿€æ´»ï¼Œå¦‚æˆ‘ä»¬åœ¨å‰é¢çš„ç¤ºä¾‹ä¸­çœ‹åˆ°çš„ï¼š <br><br><pre> <code class="plaintext hljs">features_list = [layer.output for layer in vgg19.layers] feat_extraction_model = keras.Model(inputs=vgg19.input, outputs=features_list)</code> </pre> <br> ç”±äºFunctionalæ¨¡å‹æ¯”ä¸€æ®µä»£ç æ›´åƒæ˜¯ä¸€ç§æ•°æ®ç»“æ„ï¼Œå› æ­¤å¯ä»¥å®‰å…¨åœ°åºåˆ—åŒ–å®ƒï¼Œå¹¶ä¸”å¯ä»¥å°†å…¶ä¿å­˜ä¸ºå•ä¸ªæ–‡ä»¶ï¼Œä»è€Œä½¿æ‚¨æ— éœ€è®¿é—®æºä»£ç å³å¯é‡æ–°åˆ›å»ºå®Œå…¨ç›¸åŒçš„æ¨¡å‹ã€‚ <br><br><h3> åŠŸèƒ½æ€§APIå¼±ç‚¹ </h3><br><h4> å®ƒä¸æ”¯æŒåŠ¨æ€æ¶æ„ã€‚ </h4><br>  Functional APIå°†æ¨¡å‹ä½œä¸ºDAGå±‚è¿›è¡Œå¤„ç†ã€‚ å¯¹äºå¤§å¤šæ•°æ·±åº¦å­¦ä¹ æ¶æ„è€Œè¨€ï¼Œè¿™éƒ½æ˜¯æ­£ç¡®çš„ï¼Œä½†å¹¶éå¯¹æ‰€æœ‰äººéƒ½é€‚ç”¨ï¼šä¾‹å¦‚ï¼Œé€’å½’ç½‘ç»œæˆ–Tree RNNä¸æ»¡è¶³æ­¤å‡è®¾ï¼Œå› æ­¤æ— æ³•åœ¨Functional APIä¸­å®ç°ã€‚ <br><br><h4> æœ‰æ—¶ï¼Œæ‚¨åªéœ€è¦ä»å¤´å¼€å§‹ç¼–å†™æ‰€æœ‰å†…å®¹ã€‚ </h4><br> åœ¨ç¼–å†™é«˜çº§ä½“ç³»ç»“æ„æ—¶ï¼Œæ‚¨å¯èƒ½éœ€è¦åšä¸€äº›è¶…è¶Šâ€œå®šä¹‰DAGå±‚â€çš„äº‹æƒ…ï¼šä¾‹å¦‚ï¼Œæ‚¨å¯ä»¥åœ¨æ¨¡å‹çš„å®ä¾‹ä¸Šä½¿ç”¨å‡ ç§è‡ªå®šä¹‰è®­ç»ƒå’Œè¾“å‡ºæ–¹æ³•ã€‚ è¿™éœ€è¦å­ç±»åŒ–ã€‚ <br><br><h2> åˆå¹¶å’Œåˆå¹¶å„ç§APIæ ·å¼ </h2><br> é‡è¦çš„æ˜¯è¦æ³¨æ„ï¼Œåœ¨åŠŸèƒ½APIæˆ–æ¨¡å‹çš„å­ç±»ä¹‹é—´è¿›è¡Œé€‰æ‹©ä¸æ˜¯å°†æ‚¨é™åˆ¶ä¸ºä¸€ç±»æ¨¡å‹çš„äºŒè¿›åˆ¶è§£å†³æ–¹æ¡ˆã€‚<font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tf.keras APIä¸­çš„æ‰€æœ‰æ¨¡å‹éƒ½å¯ä»¥ç›¸äº’äº¤äº’ï¼Œæ— è®ºæ˜¯é¡ºåºæ¨¡å‹ï¼ŒåŠŸèƒ½æ¨¡å‹è¿˜æ˜¯ä»å¤´å¼€å§‹ç¼–å†™çš„å­ç±»æ¨¡å‹/å±‚ã€‚</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">æ‚¨å§‹ç»ˆå¯ä»¥å°†åŠŸèƒ½æ¨¡å‹æˆ–é¡ºåºæ¨¡å‹ç”¨ä½œå­ç±»æ¨¡å‹/å±‚çš„ä¸€éƒ¨åˆ†ï¼š</font></font><br><br><pre> <code class="python hljs">units = <span class="hljs-number"><span class="hljs-number">32</span></span> timesteps = <span class="hljs-number"><span class="hljs-number">10</span></span> input_dim = <span class="hljs-number"><span class="hljs-number">5</span></span> <span class="hljs-comment"><span class="hljs-comment"># Define a Functional model inputs = keras.Input((None, units)) x = layers.GlobalAveragePooling1D()(inputs) outputs = layers.Dense(1, activation='sigmoid')(x) model = keras.Model(inputs, outputs) class CustomRNN(layers.Layer): def __init__(self): super(CustomRNN, self).__init__() self.units = units self.projection_1 = layers.Dense(units=units, activation='tanh') self.projection_2 = layers.Dense(units=units, activation='tanh') # Our previously-defined Functional model self.classifier = model def call(self, inputs): outputs = [] state = tf.zeros(shape=(inputs.shape[0], self.units)) for t in range(inputs.shape[1]): x = inputs[:, t, :] h = self.projection_1(x) y = h + self.projection_2(state) state = y outputs.append(y) features = tf.stack(outputs, axis=1) print(features.shape) return self.classifier(features) rnn_model = CustomRNN() _ = rnn_model(tf.zeros((1, timesteps, input_dim)))</span></span></code> </pre><br> ,      Layer  Model  Functional API       <code>call</code>      : <br><br> <code>call(self, inputs, **kwargs)</code>  <code>inputs</code>       (.  ),   <code>**kwargs</code>    (  ). <br> <code>call(self, inputs, training=None, **kwargs)</code>  <code>training</code>           ,   . <br> <code>call(self, inputs, mask=None, **kwargs)</code>  <code>mask</code>     (  RNN, ). <br> <code>call(self, inputs, training=None, mask=None, **kwargs)</code> â€”          . <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å¦å¤–ï¼Œå¦‚æœæ‚¨åœ¨è‡ªå®šä¹‰å›¾å±‚æˆ–æ¨¡å‹ä¸Šå®ç°`get_config`æ–¹æ³•ï¼Œåˆ™ä½¿ç”¨å®ƒåˆ›å»ºçš„åŠŸèƒ½æ¨¡å‹å°†è¢«åºåˆ—åŒ–å’Œå…‹éš†ã€‚</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ä¸‹é¢æ˜¯ä¸€ä¸ªå°ç¤ºä¾‹ï¼Œå…¶ä¸­æˆ‘ä»¬ä½¿ç”¨ä»å¤´ç¼–å†™çš„è‡ªå®šä¹‰RNNåŠŸèƒ½æ¨¡å‹ï¼š</font></font><br><br><pre> <code class="python hljs">units = <span class="hljs-number"><span class="hljs-number">32</span></span> timesteps = <span class="hljs-number"><span class="hljs-number">10</span></span> input_dim = <span class="hljs-number"><span class="hljs-number">5</span></span> batch_size = <span class="hljs-number"><span class="hljs-number">16</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CustomRNN</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(layers.Layer)</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__init__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> super(CustomRNN, self).__init__() self.units = units self.projection_1 = layers.Dense(units=units, activation=<span class="hljs-string"><span class="hljs-string">'tanh'</span></span>) self.projection_2 = layers.Dense(units=units, activation=<span class="hljs-string"><span class="hljs-string">'tanh'</span></span>) self.classifier = layers.Dense(<span class="hljs-number"><span class="hljs-number">1</span></span>, activation=<span class="hljs-string"><span class="hljs-string">'sigmoid'</span></span>) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">call</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, inputs)</span></span></span><span class="hljs-function">:</span></span> outputs = [] state = tf.zeros(shape=(inputs.shape[<span class="hljs-number"><span class="hljs-number">0</span></span>], self.units)) <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> t <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> range(inputs.shape[<span class="hljs-number"><span class="hljs-number">1</span></span>]): x = inputs[:, t, :] h = self.projection_1(x) y = h + self.projection_2(state) state = y outputs.append(y) features = tf.stack(outputs, axis=<span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> self.classifier(features) <span class="hljs-comment"><span class="hljs-comment">#           #  `batch_shape`,     `CustomRNN`  #    (     `state`). inputs = keras.Input(batch_shape=(batch_size, timesteps, input_dim)) x = layers.Conv1D(32, 3)(inputs) outputs = CustomRNN()(x) model = keras.Model(inputs, outputs) rnn_model = CustomRNN() _ = rnn_model(tf.zeros((1, 10, 5)))</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">åˆ°æ­¤ï¼Œæˆ‘ä»¬çš„å‡½æ•°å¼APIæŒ‡å—ç»“æŸäº†ï¼</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ç°åœ¨ï¼Œæ‚¨æ‹¥æœ‰äº†ä¸€å¥—å¼ºå¤§çš„å·¥å…·æ¥æ„å»ºæ·±åº¦å­¦ä¹ æ¨¡å‹ã€‚</font></font><br><br>  <i>ç»è¿‡éªŒè¯åï¼Œç¿»è¯‘ä¹Ÿå°†å‡ºç°åœ¨Tensorflow.orgä¸Šã€‚</i>  <i>å¦‚æœæ‚¨æƒ³å‚ä¸å°†Tensorflow.orgç½‘ç«™çš„æ–‡æ¡£ç¿»è¯‘æˆä¿„è¯­ï¼Œè¯·ä»¥ä¸ªäººèº«ä»½æˆ–è¯„è®ºè”ç³»ã€‚</i>  <i>ä»»ä½•æ›´æ­£æˆ–è¯„è®ºè¡¨ç¤ºèµèµã€‚</i> <i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ä½œä¸ºè¯´æ˜ï¼Œæˆ‘ä»¬ä½¿ç”¨äº†GoogLeNetæ¨¡å‹çš„å›¾åƒï¼Œå®ƒä¹Ÿæ˜¯æœ‰å‘æ— ç¯å›¾ã€‚</font></font></i> </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN483664/">https://habr.com/ru/post/zh-CN483664/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN483652/index.html">å¦‚æœå¯ä»¥ï¼Œè¯·å¯¹æˆ‘è¯´è°ï¼šè¿›è¡Œç¤¾ä¼šæŠ€æœ¯ç¬”è¯•çš„ç‰¹å¾</a></li>
<li><a href="../zh-CN483654/index.html">é›†ä¼šä¸Šçš„åé¦ˆæ˜¯ä¸€å¯¹ä¸€çš„ï¼Œä¸ºä»€ä¹ˆå¯èƒ½ä¸èµ·ä½œç”¨ï¼Œä»¥åŠå¦‚ä½•è§£å†³å®ƒï¼Ÿ</a></li>
<li><a href="../zh-CN483656/index.html">é›¶å”®ä¸­çš„Tableauï¼ŒçœŸçš„å—ï¼Ÿ</a></li>
<li><a href="../zh-CN483660/index.html">ç”¨äºåŸºç¡€æ¶æ„ç®¡ç†çš„ç”µæŠ¥æœºå™¨äºº</a></li>
<li><a href="../zh-CN483662/index.html">æ€ç§‘å¨èƒå“åº”å’Œæ€ç§‘Stealthwatch Enterpriseçš„é›†æˆ</a></li>
<li><a href="../zh-CN483666/index.html">å…³äºVolodyaå’Œè‡­æ°§å‘ç”Ÿå™¨</a></li>
<li><a href="../zh-CN483668/index.html">ä¸Šå‘¨ç¬¬397å·ï¼ˆ2020å¹´1æœˆ6æ—¥è‡³12æ—¥ï¼‰å‰ç«¯ä¸–ç•Œçš„æ–°é²œææ–™æ‘˜è¦</a></li>
<li><a href="../zh-CN483670/index.html">æ‚¨æƒ³è¦äº†è§£çš„æœ‰å…³MACåœ°å€çš„æ‰€æœ‰ä¿¡æ¯</a></li>
<li><a href="../zh-CN483674/index.html">äºŒè¿›åˆ¶ç¥ç»ç½‘ç»œå¦‚ä½•å·¥ä½œä»¥åŠä¸ºä»€ä¹ˆå®ƒä»¬å°†åœ¨2020å¹´æµè¡Œ</a></li>
<li><a href="../zh-CN483676/index.html">è¯„ä¼°å®æ–½ç«¯åˆ°ç«¯è¥é”€åˆ†æç³»ç»Ÿçš„æœ‰æ•ˆæ€§å’Œæˆæœ¬</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>