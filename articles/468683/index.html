<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë©üèº‚Äçüîß ‚ôçÔ∏è üí® Teor√≠a y pr√°ctica de la estandarizaci√≥n de los servicios de Docker. üë©üèø‚Äçü§ù‚Äçüë©üèº üö≤ üòò</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="La informaci√≥n sobre el tema de la arquitectura de aplicaciones de microservicios, que ya ha logrado llenar su ventaja, es suficiente hoy para decidir...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Teor√≠a y pr√°ctica de la estandarizaci√≥n de los servicios de Docker.</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/antiplagiat/blog/468683/"><p>  La informaci√≥n sobre el tema de la arquitectura de aplicaciones de microservicios, que ya ha logrado llenar su ventaja, es suficiente hoy para decidir si se adapta a su producto o no.  Y no es un secreto en absoluto que las empresas que han decidido elegir este camino tienen que enfrentar muchos desaf√≠os de ingenier√≠a y culturales.  Una de las fuentes de problemas es la sobrecarga que se multiplica en todas partes, y esto se aplica igualmente a la rutina asociada con los procesos de producci√≥n. </p><br><p><img src="https://habrastorage.org/webt/6g/-f/o5/6g-fo54hrcctez4vg4-avzkijc0.jpeg"><br>  <sub><em><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Fuente de imagen:</a></em></sub> </p><br><p>  Como se puede adivinar, el antiplagio es solo una empresa de este tipo, donde gradualmente se lleg√≥ a la comprensi√≥n de que estamos con microservicios en el camino.  Pero antes de comenzar a comer el cactus, decidimos limpiarlo y cocinarlo.  Y dado que las √∫nicas soluciones verdaderas y correctas para cada una son √∫nicas, en lugar de las diapositivas universales de DevOps con hermosas flechas, decidimos compartir nuestra propia experiencia y contar c√≥mo ya hemos cubierto una parte considerable de nuestro camino especial hacia, espero, el √©xito. </p><a name="habracut"></a><br><p>  Si est√° haciendo un producto verdaderamente √∫nico, que consiste en gran medida en conocimientos, casi no hay posibilidad de eludir este camino especial, porque est√° formado por muchos privados: a partir de la cultura y los datos hist√≥ricos que se han desarrollado en la empresa, terminando con su propia especificidad y la pila tecnol√≥gica utilizada . </p><br><p>  Una de las tareas para cualquier empresa y equipo es encontrar el equilibrio √≥ptimo entre las libertades y las reglas, y los microservicios llevan este problema a un nuevo nivel.  Esto puede parecer contradecir la idea misma de los microservicios, lo que implica una amplia libertad en la elecci√≥n de tecnolog√≠as, pero si no se enfoca directamente en cuestiones arquitect√≥nicas y tecnol√≥gicas, pero mira los problemas de producci√≥n en su conjunto, entonces el riesgo de estar en alg√∫n lugar de la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">trama del</a> "Jard√≠n de las Delicias" es bastante tangible. . </p><br><p> Sin embargo, en el libro "Creaci√≥n de microservicios", Sam Newman ofrece una soluci√≥n a este problema, donde literalmente desde las primeras p√°ginas habla de la necesidad de limitar la creatividad de los equipos en el marco de acuerdos t√©cnicos.  Por lo tanto, una de las claves del √©xito, especialmente en el contexto de un recurso limitado de manos libres, es la estandarizaci√≥n de todo lo que solo se puede negociar y que a nadie realmente le gustar√≠a hacer todo el tiempo.  Al elaborar acuerdos, creamos reglas claras del juego para todos los participantes en la producci√≥n y operaci√≥n de componentes del sistema.  Y conociendo las reglas del juego, debes aceptar que jugarlo deber√≠a ser m√°s f√°cil e incluso m√°s agradable.  Sin embargo, seguir estas reglas en s√≠ mismas puede convertirse en una rutina y causar incomodidad a los participantes, lo que conduce directamente a todo tipo de desviaciones de ellos y, como consecuencia, al fracaso de toda la idea.  Y la salida m√°s obvia es incluir todos los acuerdos en el c√≥digo, porque ninguna regulaci√≥n puede hacer lo que la automatizaci√≥n y las herramientas convenientes pueden usar, cuyo uso es intuitivo y natural. </p><br><p>  Movi√©ndonos en esta direcci√≥n, pudimos automatizar m√°s y m√°s, y cuanto m√°s fuerte fue nuestro proceso, se convirti√≥ en un transportador de extremo a extremo para la producci√≥n de bibliotecas y micro servicios (o no). </p><br><p></p><div class="spoiler">  <b class="spoiler_title">Descargo de responsabilidad</b> <div class="spoiler_text">  Este texto no es un intento de indicar "como deber√≠a", no hay soluciones universales, solo una descripci√≥n de nuestra posici√≥n en el camino evolutivo y la direcci√≥n elegida.  Todo lo anterior puede no ser adecuado para todos, pero en nuestro caso tiene sentido en gran medida porque: <br><br>  - El desarrollo en la empresa en el 90% de los casos se realiza en C #; <br>  - No hab√≠a necesidad de comenzar desde cero, como parte de los est√°ndares, enfoques y tecnolog√≠as aceptados: este es el resultado de la experiencia o simplemente un legado hist√≥rico; <br>  - Repositorios con proyectos .NET, a diferencia de los equipos, docenas (y habr√° m√°s); <br>  - Nos gusta usar una canalizaci√≥n de CI muy simple, evitando el bloqueo de proveedores tanto como sea posible; <br>  - Para un desarrollador ordinario de .NET, las palabras "contenedor", "docker" y "Linux" pueden causar episodios de horror existencial leve, pero no quiero romper a nadie. </div></div><br><h2 id="nemnogo-predystorii">  Un poco de historia </h2><br><p>  En la primavera de 2017, Microsoft present√≥ al mundo una vista previa de .NET Core 2.0, y este a√±o los astr√≥logos de C # se apresuraron a declarar Linux Year, as√≠ que ... </p><br><p><img src="https://habrastorage.org/webt/ex/zm/0r/exzm0rw_jaawe48lclqgweok1rq.png"><br>  <sub><em><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Fuente de imagen:</a></em></sub> </p><br><p>  Durante un tiempo, nosotros, sin confiar en la magia, recopilamos y probamos todo, tanto en Windows como en Linux, publicamos artefactos con algunos scripts SSH, tratamos de configurar viejas canalizaciones de CI / CD en el modo cuchillo suizo.  Pero despu√©s de un tiempo se dieron cuenta de que est√°bamos haciendo algo mal.  Adem√°s, las referencias a microservicios y contenedores sonaban cada vez m√°s a menudo.  As√≠ que tambi√©n decidimos montar la ola de bombo y explorar estas direcciones. </p><br><p>  Ya en la etapa de reflexi√≥n sobre nuestro posible futuro de microservicio, surgieron una serie de preguntas, ignorando las cuales, arriesgamos en este mismo futuro nuevos problemas que nosotros mismos habr√≠amos creado a cambio de resolverlos. </p><br><p>  En primer lugar, al observar el lado operativo del mundo te√≥rico de microservicios sin reglas, nos asust√≥ la posibilidad de un caos con todas las consecuencias resultantes, incluida no solo la calidad impredecible del resultado, sino tambi√©n conflictos entre equipos o desarrolladores e ingenieros.  Y tratar de dar algunas recomendaciones, al no poder garantizar su cumplimiento, inmediatamente parec√≠a una tarea vac√≠a. </p><br><p>  En segundo lugar, nadie sab√≠a realmente c√≥mo hacer contenedores y escribir archivos acoplables, que, sin embargo, ya han comenzado a vivir en nuestros repositorios.  Adem√°s, muchos "leyeron en alguna parte" que no todo es tan simple all√≠.  Entonces, alguien tuvo que profundizar y resolverlo, luego regresar con las mejores pr√°cticas de ensamblaje de contenedores.  Pero la perspectiva de asumir el papel de un Docker Packer a tiempo completo, solo con pilas de archivos Docker, por alguna raz√≥n no inspir√≥ a nadie en la empresa.  Adem√°s, como result√≥, bucear una vez claramente no es suficiente, e incluso a primera vista parece bueno y correcto, puede resultar incorrecto o simplemente no muy bueno. </p><br><p>  Y en tercer lugar, quer√≠a estar seguro de que las im√°genes obtenidas con los servicios no solo ser√≠an correctas desde el punto de vista de las pr√°cticas de contenedores, sino que ser√≠an predecibles en su comportamiento y tendr√≠an todas las propiedades y atributos necesarios para simplificar el control de los contenedores lanzados.  En otras palabras, quer√≠a obtener im√°genes con aplicaciones que estuvieran igualmente configuradas y escribir registros, proporcionar una interfaz √∫nica para obtener m√©tricas, tener un conjunto coherente de etiquetas y similares.  Tambi√©n era importante que el ensamblaje en la computadora del desarrollador arroje el mismo resultado que el ensamblaje en cualquier sistema de CI, incluidas las pruebas aprobadas y la generaci√≥n de artefactos. </p><br><p>  Por lo tanto, naci√≥ el entendimiento de que se requerir√≠a alg√∫n proceso para administrar y centralizar nuevos conocimientos, pr√°cticas y est√°ndares, y el camino desde el primer compromiso hasta una imagen acoplada completamente lista para la infraestructura del producto debe estar unificado y tan automatizado como sea posible, sin ir m√°s all√° de los t√©rminos que comienzan con la palabra continua </p><br><h2 id="cli-vs-gui">  CLI vs.  GUI </h2><br><p>  El punto de partida para un nuevo componente, ya sea un servicio o una biblioteca, es crear un repositorio.  Esta etapa se puede dividir en dos partes: crear y configurar el repositorio en el host del sistema de control de versiones (tenemos Bitbucket) e inicializarlo con la creaci√≥n de una estructura de archivos.  Afortunadamente, ya exist√≠an una serie de requisitos para ambos.  Por lo tanto, formalizarlos en c√≥digo era una tarea l√≥gica. </p><br><p>  Entonces, ¬øcu√°l deber√≠a ser nuestro repositorio? </p><br><ul><li>  Ubicado en uno de los proyectos, en el cual el nombre, los derechos de acceso, las pol√≠ticas para aceptar solicitudes de extracci√≥n, etc. </li><li>  Contiene los archivos y directorios necesarios, como: <br><ul><li> archivo con la configuraci√≥n e informaci√≥n sobre el repositorio <code>SolutionInfo.props</code> (m√°s sobre eso a continuaci√≥n); </li><li>  c√≥digos fuente del proyecto en el directorio <code>src</code> ; </li><li>  <code>.gitignore</code> , <code>README.md</code> , etc. </li></ul></li><li>  Contiene los subm√≥dulos de Git necesarios; </li><li>  El proyecto debe derivarse de una de las plantillas. </li></ul><br><p>  Dado que la API REST de Bitbucket brinda un control total sobre la configuraci√≥n de los repositorios, se cre√≥ una utilidad especial para interactuar con ella: el generador de repositorios.  En el modo de preguntas y respuestas, recibe del usuario todos los datos necesarios y crea un repositorio que cumple todos nuestros requisitos, a saber: </p><br><ul><li>  Define un proyecto en Bitbucket para elegir; </li><li>  Valida el nombre de acuerdo con nuestro acuerdo; </li><li>  Realiza todas las configuraciones necesarias que no se pueden heredar del proyecto; </li><li>  Actualiza la lista de plantillas personalizadas (utilizamos <a href="">plantillas de dotnet</a> ) para el proyecto y sugiere elegir entre ellas; </li><li>  Rellena la informaci√≥n m√≠nima necesaria sobre el repositorio en el archivo de configuraci√≥n y en los documentos <code>*.md</code> ; </li><li>  Conecta subm√≥dulos con la configuraci√≥n de canalizaci√≥n de CI / CD (en nuestro caso, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Bamboo Specs</a> ) y scripts de ensamblaje. </li></ul><br><p>  En otras palabras, el desarrollador, al iniciar un nuevo proyecto, inicia la utilidad, completa varios campos, selecciona el tipo de proyecto y recibe, por ejemplo, el "¬°Hola, mundo!" Completamente terminado.  un servicio que ya est√° conectado al sistema CI, desde donde el servicio puede incluso publicarse si realiza una confirmaci√≥n que cambia la versi√≥n a distinta de cero. </p><br><p>  El primer paso ha sido tomado.  Sin trabajo manual y errores, buscando documentaci√≥n, registros y SMS.  Ahora pasemos a lo que se gener√≥ all√≠. </p><br><h2 id="struktura">  Estructura </h2><br><p>  La estandarizaci√≥n de la estructura del repositorio ha arraigado con nosotros durante mucho tiempo y fue necesaria para simplificar el ensamblaje, la integraci√≥n con el sistema CI y el entorno de desarrollo.  Inicialmente, partimos de la idea de que la canalizaci√≥n en CI deber√≠a ser tan simple y, como se podr√≠a adivinar, est√°ndar, lo que garantizar√≠a la portabilidad y reproducibilidad del ensamblaje.  Es decir, el mismo resultado podr√≠a obtenerse f√°cilmente tanto en cualquier sistema de CI como en el lugar de trabajo del desarrollador.  Por lo tanto, todo lo que no se relaciona con las caracter√≠sticas de un entorno espec√≠fico de integraci√≥n continua se env√≠a a un subm√≥dulo Git especial y es un sistema de compilaci√≥n autosuficiente.  M√°s precisamente, el sistema de estandarizaci√≥n de ensamblaje.  La tuber√≠a en s√≠, con una aproximaci√≥n m√≠nima, solo debe ejecutar el script <code>build.sh</code> , recoger un informe sobre las pruebas e iniciar una implementaci√≥n, si es necesario.  Para mayor claridad, veamos qu√© sucede si genera el repositorio <em>SampleService</em> en un proyecto con el nombre pronunciado <em>Sandbox</em> . </p><br><pre> <code class="plaintext hljs">. ‚îú‚îÄ‚îÄ [bamboo-specs] ‚îú‚îÄ‚îÄ [devops.build] ‚îÇ ‚îú‚îÄ‚îÄ build.sh ‚îÇ ‚îî‚îÄ‚îÄ ... ‚îú‚îÄ‚îÄ [docs] ‚îú‚îÄ‚îÄ [.scripts] ‚îú‚îÄ‚îÄ [src] ‚îÇ ‚îú‚îÄ‚îÄ [CodeAnalysis] ‚îÇ ‚îú‚îÄ‚îÄ [Sandbox.SampleService] ‚îÇ ‚îú‚îÄ‚îÄ [Sandbox.SampleService.Bootstrap] ‚îÇ ‚îú‚îÄ‚îÄ [Sandbox.SampleService.Client] ‚îÇ ‚îú‚îÄ‚îÄ [Sandbox.SampleService.Tests] ‚îÇ ‚îú‚îÄ‚îÄ Directory.Build.props ‚îÇ ‚îú‚îÄ‚îÄ NLog.config ‚îÇ ‚îú‚îÄ‚îÄ NuGet.Config ‚îÇ ‚îî‚îÄ‚îÄ Sandbox.SampleService.sln ‚îú‚îÄ‚îÄ .gitattributes ‚îú‚îÄ‚îÄ .gitignore ‚îú‚îÄ‚îÄ .gitmodules ‚îú‚îÄ‚îÄ CHANGELOG.md ‚îú‚îÄ‚îÄ README.md ‚îî‚îÄ‚îÄ SolutionInfo.props</code> </pre> <br><p>  Los primeros dos directorios son subm√≥dulos Git.  <code>bamboo-specs</code> es "Pipeline as Code" para el sistema Atlassian Bamboo CI (podr√≠a haber alg√∫n archivo Jenkins en su lugar), <code>devops.build</code> es nuestro sistema de compilaci√≥n, que analizar√© con m√°s detalle a continuaci√≥n.  El directorio <code>.scripts</code> tambi√©n se <code>.scripts</code> .  El proyecto .NET en s√≠ se encuentra en <code>src</code> : <code>NuGet.Config</code> contiene la configuraci√≥n del repositorio privado <acronym>NuGet</acronym> , <code>NLog.config</code> configuraci√≥n de tiempo de <acronym>desarrollo</acronym> de <acronym>NLog</acronym> .  Como puede suponer, usar NLog en una empresa tambi√©n es uno de los est√°ndares.  Una de las cosas interesantes aqu√≠ es el archivo casi m√°gico <code>Directory.Build.props</code> .  Por alguna raz√≥n, pocas personas conocen esa posibilidad en los proyectos .NET, como la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">personalizaci√≥n del ensamblado</a> .  En resumen, los archivos con los nombres <code>Directory.Build.props</code> y <code>Directory.Build.targets</code> importan autom√°ticamente a sus proyectos y le permiten configurar propiedades comunes para todos los proyectos en un solo lugar.  Por ejemplo, as√≠ es como conectamos el analizador <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">StyleCop.Analyzers</a> y su configuraci√≥n desde el directorio <code>CodeAnalysis</code> a todos los proyectos de estilo de c√≥digo, establecemos reglas de versiones y algunos atributos comunes para bibliotecas y paquetes ( <em>Compa√±√≠a</em> , <em>Copyright</em> , etc.), y tambi√©n nos conectamos a trav√©s de <code>&lt;Import&gt;</code> archivo <code>SolutionInfo.props</code> , que es precisamente el mismo archivo de configuraci√≥n del repositorio, que se discuti√≥ anteriormente.  Ya contiene la versi√≥n actual, informaci√≥n sobre los autores, la URL del repositorio y su descripci√≥n, as√≠ como varias propiedades que afectan el comportamiento del sistema de ensamblaje y los artefactos resultantes. </p><br><div class="spoiler">  <b class="spoiler_title">Ejemplo `SolutionInfo.props`</b> <div class="spoiler_text"><pre> <code class="xml hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?xml version="1.0"?&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Project</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">xmlns:xsi</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">xsi:noNamespaceSchemaLocation</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"devops.build/SolutionInfo.xsd"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">PropertyGroup</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-comment"><span class="hljs-comment">&lt;!-- Product name --&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Product</span></span></span><span class="hljs-tag">&gt;</span></span>Sandbox.SampleService<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Product</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-comment"><span class="hljs-comment">&lt;!-- Product version. Version 0.0.0 wouldn't be published! --&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">BaseVersion</span></span></span><span class="hljs-tag">&gt;</span></span>0.0.0<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">BaseVersion</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-comment"><span class="hljs-comment">&lt;!-- Project name which contains Main() --&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">EntryProject</span></span></span><span class="hljs-tag">&gt;</span></span>Sandbox.SampleService.Bootstrap<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">EntryProject</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-comment"><span class="hljs-comment">&lt;!-- Exposed port --&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ExposedPort</span></span></span><span class="hljs-tag">&gt;</span></span>4000/tcp<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ExposedPort</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-comment"><span class="hljs-comment">&lt;!-- DOTNET_SYSTEM_GLOBALIZATION_INVARIANT value. See https://github.com/dotnet/corefx/blob/master/Documentation/architecture/globalization-invariant-mode.md --&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">GlobalizationInvariant</span></span></span><span class="hljs-tag">&gt;</span></span>false<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">GlobalizationInvariant</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-comment"><span class="hljs-comment">&lt;!-- Project URL --&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">RepositoryUrl</span></span></span><span class="hljs-tag">&gt;</span></span>https://bitbucket.contoso.com/projects/SND/repos/sandbox.sampleservice/<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">RepositoryUrl</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-comment"><span class="hljs-comment">&lt;!-- Documentation URL --&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">DocumentationUrl</span></span></span><span class="hljs-tag">&gt;</span></span>https://bitbucket.contoso.com/projects/SND/repos/sandbox.sampleservice/browse/README.md<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">DocumentationUrl</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-comment"><span class="hljs-comment">&lt;!-- Your name here --&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Authors</span></span></span><span class="hljs-tag">&gt;</span></span>User Name &amp;lt;username@contoso.com&amp;gt;<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Authors</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-comment"><span class="hljs-comment">&lt;!-- Project description --&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Description</span></span></span><span class="hljs-tag">&gt;</span></span>The sample service for demo purposes.<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Description</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-comment"><span class="hljs-comment">&lt;!-- Bamboo plan key (required for Bamboo Specs --&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">BambooBlanKey</span></span></span><span class="hljs-tag">&gt;</span></span>SMPL<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">BambooBlanKey</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">PropertyGroup</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Project</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> </div></div><br><div class="spoiler">  <b class="spoiler_title">Ejemplo `Directory.Build.props`</b> <div class="spoiler_text"><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Project</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Import</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Condition</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Exists('..\SolutionInfo.props')"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Project</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"..\SolutionInfo.props"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ItemGroup</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">None</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Include</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"$(MSBuildThisFileDirectory)/CodeAnalysis/stylecop.json"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Link</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"stylecop.json"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">CopyToOutputDirectory</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Never"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">PackageReference</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Include</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"StyleCop.Analyzers"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Version</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"1.*"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">PrivateAssets</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"all"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ItemGroup</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">PropertyGroup</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">CodeAnalysisRuleSet</span></span></span><span class="hljs-tag">&gt;</span></span>$(MSBuildThisFileDirectory)/CodeAnalysis/stylecop.ruleset<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">CodeAnalysisRuleSet</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-comment"><span class="hljs-comment">&lt;!-- Enable XML docs generating--&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">GenerateDocumentationFile</span></span></span><span class="hljs-tag">&gt;</span></span>true<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">GenerateDocumentationFile</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-comment"><span class="hljs-comment">&lt;!-- Enable C# 7.x features --&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">LangVersion</span></span></span><span class="hljs-tag">&gt;</span></span>latest<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">LangVersion</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-comment"><span class="hljs-comment">&lt;!-- default base version --&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">BaseVersion</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Condition</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"'$(BaseVersion)' == ''"</span></span></span><span class="hljs-tag">&gt;</span></span>0.0.0<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">BaseVersion</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-comment"><span class="hljs-comment">&lt;!-- default build number and format --&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">BuildNumber</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Condition</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"'$(BuildNumber)' == ''"</span></span></span><span class="hljs-tag">&gt;</span></span>0<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">BuildNumber</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">BuildNumber</span></span></span><span class="hljs-tag">&gt;</span></span>$([System.String]::Format('{0:0000}',$(BuildNumber)))<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">BuildNumber</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-comment"><span class="hljs-comment">&lt;!-- default version suffix --&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">VersionSuffix</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Condition</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"'$(VersionSuffix)' == ''"</span></span></span><span class="hljs-tag">&gt;</span></span>local<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">VersionSuffix</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-comment"><span class="hljs-comment">&lt;!-- empty version suffix instead of 'prod' --&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">VersionSuffix</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Condition</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"'$(VersionSuffix)' == 'prod'"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">VersionSuffix</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-comment"><span class="hljs-comment">&lt;!-- format version prefix --&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">VersionPrefix</span></span></span><span class="hljs-tag">&gt;</span></span>$(BaseVersion).$(BuildNumber)<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">VersionPrefix</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-comment"><span class="hljs-comment">&lt;!-- disable IsPackable by default --&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">IsPackable</span></span></span><span class="hljs-tag">&gt;</span></span>false<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">IsPackable</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">PackageProjectUrl</span></span></span><span class="hljs-tag">&gt;</span></span>$(RepositoryUrl)<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">PackageProjectUrl</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Company</span></span></span><span class="hljs-tag">&gt;</span></span>Contoso<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Company</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Copyright</span></span></span><span class="hljs-tag">&gt;</span></span>Copyright $([System.DateTime]::Now.Date.Year) Contoso Ltd<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Copyright</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">PropertyGroup</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Project</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> </div></div><br><h2 id="sborka">  Asamblea </h2><br><p>  Vale la pena mencionar de inmediato que tanto yo como mis colegas ya tuvimos una experiencia bastante exitosa en el uso de diferentes <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">sistemas de compilaci√≥n</a> .  Y en lugar de ponderar una herramienta existente con una funcionalidad completamente inusual, se decidi√≥ hacer otra, especializada para nuestro nuevo proceso, y dejar la antigua sola para llevar a cabo sus tareas como parte de proyectos heredados.  La idea de la soluci√≥n fue el deseo de obtener una herramienta que convierta el c√≥digo en una imagen acoplable que cumpla con todos nuestros requisitos, utilizando un √∫nico proceso est√°ndar, al tiempo que elimina la necesidad de que los desarrolladores se sumerjan en las complejidades del ensamblaje, pero conservando la posibilidad de alguna personalizaci√≥n. </p><br><p>  La selecci√≥n de un marco adecuado ha comenzado.  Basado en los requisitos de reproducibilidad del resultado tanto en m√°quinas de compilaci√≥n con Linux como en m√°quinas de Windows de cualquier desarrollador, la multiplataforma real y un m√≠nimo de dependencias predefinidas se convirtieron en una condici√≥n clave.  En diferentes momentos, logr√© conocer bastante bien algunos de los frameworks de ensamblaje para desarrolladores de .NET: desde MSBuild y sus monstruosas configuraciones XML, que luego se tradujeron a <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Psake</a> (Powershell), hasta <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">FAKE</a> ex√≥tico (F #).  Pero esta vez quer√≠a algo fresco y ligero.  Adem√°s, ya se decidi√≥ que el ensamblaje y las pruebas deber√≠an llevarse a cabo completamente en un entorno de contenedor aislado, por lo que no plane√© ejecutar dentro de otra cosa que no sean los comandos Docker CLI y Git, es decir, la mayor parte del proceso deber√≠a haberse descrito en el Dockerfile. <br>  En ese momento, tanto FAKE 5 como <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Cake</a> for .NET Core a√∫n no estaban listos, por lo que con una plataforma cruzada, estos proyectos estaban m√°s o menos.  Pero mi querido y querido <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">PowerShell 6 Core</a> ya ha sido lanzado, y lo us√© al m√°ximo.  Por lo tanto, decid√≠ recurrir a Psake nuevamente, y mientras lo hac√≠a, me top√© con un interesante proyecto <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Invoke-Build</a> , que es un replanteamiento de Psake y, como se√±ala el propio autor, es lo mismo, solo que mejor y m√°s f√°cil.  As√≠ es  No me detendr√© en detalles en el marco de este art√≠culo, solo notar√© que la compacidad me soborna si todas las funciones b√°sicas para esta clase de productos est√°n disponibles: </p><br><ul><li>  La secuencia de acciones se describe mediante un conjunto de tareas interrelacionadas (tareas), que pueden controlarse utilizando sus interdependencias y condiciones adicionales. </li><li>  Hay varios ayudantes √∫tiles, por ejemplo, exec {} para manejar correctamente los c√≥digos de salida de la aplicaci√≥n de consola. </li><li>  Cualquier excepci√≥n o dejar de usar Ctrl + C se procesar√° correctamente en un bloque especial de Salir-Construir incorporado.  Por ejemplo, all√≠ puede eliminar todos los archivos temporales, un entorno de prueba o dibujar un informe que sea agradable a la vista. </li></ul><br><p><img src="https://habrastorage.org/webt/nw/sg/0g/nwsg0gzd3fo0a-ep6b60pfqce98.png"></p><br><h2 id="universalnyy-dockerfile">  Archivo Docker Gen√©rico </h2><br><p>  El Dockerfile en s√≠ y el ensamblaje que usa Docker Build proporcionan capacidades de parametrizaci√≥n bastante d√©biles, y la flexibilidad de estas herramientas es apenas un poco m√°s alta que la de un mango de pala.  Adem√°s, hay una gran cantidad de formas de hacer que la imagen "incorrecta" sea demasiado grande, demasiado insegura, poco intuitiva o simplemente impredecible.  Afortunadamente, <a href="">la documentaci√≥n de Microsoft</a> ya ofrece varios <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">ejemplos de Dockerfile</a> , que le permiten comprender r√°pidamente los conceptos b√°sicos y crear su primer Dockerfile, mejorando gradualmente m√°s adelante.  √âl ya usa un patr√≥n de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">etapas m√∫ltiples</a> y crea una imagen especial de " <a href="">Test Runner</a> " para ejecutar pruebas. </p><br><h2 id="multi-stage-pattern-i-argumenty">  Patr√≥n de m√∫ltiples etapas y argumentos </h2><br><p>  El primer paso es dividir las etapas de ensamblaje en otras m√°s peque√±as y agregar otras nuevas.  Por lo tanto, vale la pena destacar el lanzamiento de <code>dotnet build</code> como una etapa separada, porque para proyectos que contienen solo bibliotecas, no tiene sentido ejecutar <code>dotnet publish</code> .  Ahora, a nuestra discreci√≥n, solo podemos ejecutar las etapas de ensamblaje requeridas usando <br> <code>dotnet build --target &lt;name&gt;</code> <br>  Por ejemplo, aqu√≠ estamos recopilando un proyecto que contiene solo bibliotecas.  Los artefactos aqu√≠ son solo paquetes NuGet, lo que significa que no tiene sentido recopilar una imagen de tiempo de ejecuci√≥n. </p><br><p><img src="https://habrastorage.org/webt/vn/_a/a3/vn_aa3w7oodzrpythwrixomkhs8.png"></p><br><p>  O ya estamos construyendo un servicio, pero desde la rama de caracter√≠sticas.  No necesitamos artefactos de tal ensamblaje en absoluto, solo es importante pasar las pruebas y el control de salud. </p><br><p><img src="https://habrastorage.org/webt/fo/ua/l1/foual199bsvqf2u7mk6xgjzbw9q.png"></p><br><p>  Lo siguiente que debe hacer es parametrizar el uso de im√°genes b√°sicas.  Desde hace alg√∫n tiempo, en el Dockerfile, la directiva <code>ARG</code> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">se puede colocar</a> fuera de las etapas de compilaci√≥n, y los valores transferidos se pueden usar en el nombre de la imagen base. </p><br><pre> <code class="plaintext hljs">ARG DOTNETCORE_VERSION=2.2 ARG ALPINE_VERSION= ARG BUILD_BASE=mcr.microsoft.com/dotnet/core/sdk:${DOTNETCORE_VERSION}-alpine${ALPINE_VERSION} ARG RUNTIME_BASE=mcr.microsoft.com/dotnet/core/runtime:${DOTNETCORE_VERSION}-alpine${ALPINE_VERSION} FROM ${BUILD_BASE} AS restore ... FROM ${RUNTIME_BASE} AS runtime ...</code> </pre> <br><p>  As√≠ que tenemos nuevas y a primera vista, y no oportunidades obvias.  En primer lugar, si queremos crear una imagen con una aplicaci√≥n ASP.NET Core, la imagen en tiempo de ejecuci√≥n necesitar√° una diferente: <code>mcr.microsoft.com/dotnet/core/aspnet</code> .  El par√°metro con una imagen b√°sica no est√°ndar debe guardarse en la configuraci√≥n del repositorio <code>SolutionInfo.props</code> y pasarlo como argumento durante el ensamblaje.  Tambi√©n facilitamos al desarrollador el uso de otras versiones de las im√°genes de .NET Core: vistas previas, por ejemplo, o incluso personalizadas (¬°nunca se sabe!). </p><br><p>  En segundo lugar, la capacidad de "expandir" el Dockerfile es a√∫n m√°s interesante, ya que ha formado parte de las operaciones en otro ensamblado, cuyo resultado se tomar√° como base al preparar la imagen en tiempo de ejecuci√≥n.  Por ejemplo, algunos de nuestros servicios usan JavaScript y Vue.js, cuyo c√≥digo prepararemos en una imagen separada, simplemente agregando un Dockerfile "expansivo" al repositorio: </p><br><pre> <code class="plaintext hljs">ARG DOTNETCORE_VERSION=2.2 ARG ALPINE_VERSION= ARG RUNTIME_BASE=mcr.microsoft.com/dotnet/core/aspnet:${DOTNETCORE_VERSION}-alpine${ALPINE_VERSION} FROM node:alpine AS install WORKDIR /build COPY package.json . RUN npm install FROM install AS src COPY [".babelrc", ".eslintrc.js", ".stylelintrc", "./"] COPY ClientApp ./ClientApp FROM src AS publish RUN npm run build-prod FROM ${RUNTIME_BASE} AS appbase COPY --from=publish /build/wwwroot/ /app/wwwroot/</code> </pre> <br><p>  Recopilemos esta imagen con la etiqueta, que pasaremos a la etapa de ensamblar la imagen de tiempo de ejecuci√≥n del servicio ASP.NET como argumento para RUNTIME_BASE.  Por lo tanto, puede expandir el ensamblaje tanto como desee, incluso, puede parametrizar lo que no puede hacer en la <code>docker build</code> .  ¬øQuiere parametrizar la adici√≥n de Volumen?  F√°cil: </p><br><pre> <code class="plaintext hljs">ARG DOTNETCORE_VERSION=2.2 ARG ALPINE_VERSION= ARG RUNTIME_BASE=mcr.microsoft.com/dotnet/core/aspnet:${DOTNETCORE_VERSION}-alpine${ALPINE_VERSION} FROM ${RUNTIME_BASE} AS runtime ARG VOLUME VOLUME ${VOLUME}</code> </pre> <br><p>  Comenzamos el ensamblaje de este Dockerfile tantas veces como queramos agregar directivas VOLUME.  Usamos la imagen resultante como base para el servicio. </p><br><h2 id="zapusk-testov">  Ejecutando pruebas </h2><br><p>  En lugar de ejecutar pruebas directamente en las etapas de ensamblaje, es m√°s correcto y m√°s conveniente hacerlo en un contenedor especial "Test Runner".  Transmitiendo brevemente la esencia de este enfoque, observo que le permite: </p><br><ul><li>  Realice todos los lanzamientos programados, incluso si uno de ellos falla; </li><li>  Monte el directorio del sistema de archivos del host en el contenedor para recibir un informe de prueba, que es vital al construir en el sistema CI; </li><li>  Ejecute las pruebas en un entorno temporal pasando el nombre de su red al <code>docker run --network &lt;test_network_name&gt;</code> . </li></ul><br><p>  El √∫ltimo p√°rrafo significa que ahora podemos ejecutar no solo pruebas unitarias, sino tambi√©n pruebas de integraci√≥n.  Describimos el entorno, por ejemplo, en <code>docker-compose.yaml</code> , y lo ejecutamos para toda la compilaci√≥n.  Ahora puede verificar la interacci√≥n con la base de datos o nuestro otro servicio, y guardar los registros de ellos en caso de que los necesite para su an√°lisis. </p><br><p>  Siempre verificamos la imagen de tiempo de ejecuci√≥n resultante para pasar el chequeo de salud, que tambi√©n es una especie de prueba.  Un entorno de prueba temporal puede ser √∫til aqu√≠ si el servicio que se est√° probando depende de su entorno. </p><br><p>  Tambi√©n noto que el enfoque con los contenedores de corredores ensamblados en el escenario con la <code>dotnet build</code> servir√° entonces bien para lanzar <code>dotnet publish</code> , <code>dotnet pack</code> y <code>dotnet nuget push</code> .  Esto nos permitir√° guardar los artefactos de ensamblaje localmente. </p><br><h2 id="healthcheck-i-zavisimosti-os">  Verificaci√≥n de salud y dependencias del sistema operativo </h2><br><p>  R√°pidamente se hizo evidente que nuestros servicios estandarizados seguir√≠an siendo √∫nicos a su manera.  Pueden tener diferentes requisitos para paquetes preinstalados del sistema operativo dentro de la imagen y diferentes formas de verificar el chequeo de salud.  Y si curl es adecuado para verificar el estado de una aplicaci√≥n web, entonces para un backend gRPC o, adem√°s, un servicio sin cabeza, ser√° in√∫til y tambi√©n ser√° un paquete adicional en el contenedor. </p><br><p>  Para dar a los desarrolladores la oportunidad de personalizar la imagen y expandir su configuraci√≥n, utilizamos el acuerdo en varios scripts especiales que se pueden redefinir en el repositorio: </p><br><pre> <code class="plaintext hljs">.scripts ‚îú‚îÄ‚îÄ healthcheck.sh ‚îú‚îÄ‚îÄ run.sh ‚îî‚îÄ‚îÄ runtime-deps.sh</code> </pre> <br><p>  El script <code>healthcheck.sh</code> contiene los comandos necesarios para verificar el estado: </p><br><ul><li><p>  Para la web usando curl: </p><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/ash set ‚Äìe curl -sIf -o /dev/null -w "%{http_code}\n" 127.0.0.1/health || exit 1</span></span></code> </pre> <br></li><li><p>  Otros servicios que utilizan nuestra propia utilidad cli: </p><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/ash set ‚Äìe healthcheck || exit 1</span></span></code> </pre> <br></li></ul><br><p>  Usando <code>runtime-deps.sh</code> , se instalan las dependencias y, si es necesario, se realizan otras acciones en el sistema operativo base que son necesarias para el funcionamiento normal de la aplicaci√≥n dentro del contenedor.  Ejemplos tipicos: </p><br><ul><li><p>  Para una aplicaci√≥n web: </p><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/ash apk add --no-cache curl icu-libs</span></span></code> </pre> <br></li><li><p>  Para el servicio gRPC: </p><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/ash apk add --no-cache libc6-compat</span></span></code> </pre> <br></li></ul><br><p>  Por lo tanto, la forma de administrar las dependencias y verificar el estado est√° estandarizada, pero hay espacio para cierta flexibilidad.  En cuanto a <code>run.sh</code> , entonces es m√°s. </p><br><h2 id="entrypoint-skript">  Script de punto de entrada </h2><br><p>  Estoy seguro de que todos los que al menos una vez escribieron su Dockerfile se preguntaron qu√© directiva usar: <code>CMD</code> o <code>ENTRYPOINT</code> .  Adem√°s, estos equipos tambi√©n tienen dos opciones de sintaxis, que de la manera m√°s dram√°tica afectan el resultado.  No explicar√© la diferencia en detalle, repitiendo despu√©s de aquellos que ya han <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">aclarado todo</a> .  Solo recomiendo recordar que en el 99% de las situaciones es correcto usar ENTRYPOINT y la sintaxis ejecutiva: </p><br><p>  PUNTO DE ENTRADA ["/ ruta / a / ejecutable"] </p><br><p>  De lo contrario, la aplicaci√≥n iniciada no podr√° procesar correctamente los comandos del sistema operativo, como SIGTERM, etc., y tambi√©n puede tener problemas en forma de procesos zombies y todo lo relacionado con <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">el problema PID 1</a> .  Pero, ¬øqu√© sucede si desea iniciar el contenedor sin iniciar la aplicaci√≥n?  S√≠, puede anular el punto de entrada: <br> <code>docker run --rm -it --entrypoint ash &lt;image_name&gt; &lt;params&gt;</code> <br>  No se ve muy c√≥modo e intuitivo, ¬øverdad?  Pero hay buenas noticias: ¬°puedes hacerlo mejor!  A saber, use un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">script de punto de entrada</a> .  Tal script le permite realizar una inicializaci√≥n arbitrariamente compleja ( <a href="">ejemplo</a> ), procesamiento de par√°metros y todo lo que desee. </p><br><p>  En nuestro caso, por defecto, se utiliza el escenario m√°s simple, pero al mismo tiempo funcional: </p><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/sh set -e if [ ! -z "$1" ] &amp;&amp; $(command -v $1 &gt;/dev/null 2&gt;&amp;1) then exec $@ else exec /usr/bin/dotnet /app/${ENTRY_PROJECT}.dll $@ fi</span></span></code> </pre> <br><p>  Le permite controlar el lanzamiento del contenedor de forma muy intuitiva: <br>  <code>docker run &lt;image&gt; env</code> : solo ejecuta env en la imagen, mostrando las variables de entorno. <br>  <code>docker run &lt;image&gt; -param1 value1</code> - inicia el servicio con los argumentos especificados. </p><br><p>  Por separado, debe prestar atenci√≥n al comando <code>exec</code> : su presencia antes de llamar a la aplicaci√≥n ejecutable le proporcionar√° el codiciado PID 1 en su contenedor. </p><br><h2 id="chto-esche">  Que mas </h2><br><p>  Por supuesto, durante m√°s de un a√±o y medio de uso, el sistema de compilaci√≥n ha acumulado muchas funcionalidades diferentes.  Adem√°s de gestionar las condiciones de lanzamiento de varias etapas, trabajando con el almacenamiento de artefactos, versiones y otras caracter√≠sticas, tambi√©n se desarroll√≥ nuestro "est√°ndar" del contenedor.  Estaba lleno de atributos importantes que lo hacen m√°s predecible y administrativamente conveniente: </p><br><ul><li>  Se instalan todas las etiquetas de imagen necesarias: versiones, n√∫meros de revisi√≥n, enlaces a documentaci√≥n, autor y otros. </li><li>  En el contenedor de tiempo de ejecuci√≥n, la configuraci√≥n de NLog se redefine para que, despu√©s de la publicaci√≥n, todos los registros se presenten inmediatamente en forma estructurada utilizando json, cuya versi√≥n se versiona. </li><li>  Las reglas de an√°lisis est√°tico y cualquier otro est√°ndar se actualizan autom√°ticamente. </li></ul><br><p>  Tal herramienta, por supuesto, siempre se puede mejorar y desarrollar.  Todo depende de las necesidades y la imaginaci√≥n.  Por ejemplo, adem√°s de todo, fue posible empaquetar utilidades cli adicionales en una imagen.  El desarrollador puede ponerlos f√°cilmente en la imagen, especificando en el archivo de configuraci√≥n solo el nombre de la utilidad requerida y el nombre del proyecto .NET desde el cual debe ensamblarse (por ejemplo, nuestro <code>healthcheck</code> ). </p><br><h2 id="zaklyuchenie">  Conclusi√≥n </h2><br><p>  Aqu√≠ se describe solo una parte de un enfoque integrado de estandarizaci√≥n.  Los servicios en s√≠, que se crean a partir de nuestras plantillas, permanecieron detr√°s de escena y, por lo tanto, est√°n bastante unificados por muchos criterios, como un enfoque √∫nico de configuraci√≥n, m√©todos comunes para acceder a m√©tricas, generaci√≥n de c√≥digo, etc.        .          ,  . </p><br><p>             ,      Linux    ,   -      .       , ,          . , ,  ,    Code Style,      ,           . </p><br><p> ,    !   ,    ¬´  ¬ª,       ,             .      ,    Docker        . </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/468683/">https://habr.com/ru/post/468683/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../468663/index.html">End2 End Approach en tareas de reconocimiento autom√°tico de voz</a></li>
<li><a href="../468665/index.html">¬øPero es hora de comprar un irrigador?</a></li>
<li><a href="../468673/index.html">Taller "Garantizar la seguridad de los datos personales" - 3 de octubre, San Petersburgo</a></li>
<li><a href="../468677/index.html">El anuncio del tel√©fono inteligente Xiaomi Mi Mix Alpha</a></li>
<li><a href="../468679/index.html">El ABC de la seguridad en Kubernetes: autenticaci√≥n, autorizaci√≥n, auditor√≠a</a></li>
<li><a href="../468687/index.html">Analizamos las nuevas iniciativas del Banco Central para regular el mercado de valores: 3 grupos de inversores, restricciones para principiantes</a></li>
<li><a href="../468689/index.html">Registrar su negocio de TI en Singapur: ¬øqu√© debo hacer?</a></li>
<li><a href="../468691/index.html">Controladores de terceros peligrosos en su sistema o LOLDrivers</a></li>
<li><a href="../468693/index.html">C√≥mo la automatizaci√≥n destruye a los empleados de Walmart</a></li>
<li><a href="../468703/index.html">¬øC√≥mo puede un programador ganar a√∫n m√°s?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>