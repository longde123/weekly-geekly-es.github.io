<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🛶 🌱 👲🏾 So erstellen Sie hochgradig anpassbares Caching in einem Projekt und ersparen Kollegen das Schreiben des gleichen Codetyps 🐶 👩🏽‍🔬 🚶🏻</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="„Wenn die Arbeit des Programmierers im Wesentlichen darin besteht, die Arbeit anderer zu automatisieren, warum ist meine Arbeit dann so wenig automati...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>So erstellen Sie hochgradig anpassbares Caching in einem Projekt und ersparen Kollegen das Schreiben des gleichen Codetyps</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/453382/">  „Wenn die Arbeit des Programmierers im Wesentlichen darin besteht, die Arbeit anderer zu automatisieren, warum ist meine Arbeit dann so wenig automatisiert?“, Dachte ich und kopierte erneut alle im Projekt erforderlichen Bindungen, um der Datenbank eine neue Entität hinzuzufügen.  Und ich beschloss, diese Routine des Hinzufügens von Vorlagenklassen loszuwerden, gleichzeitig dem Projekt „Gutes“ zu tun und die Datenbank von unnötigen Lesevorgängen zu entladen. <br><a name="habracut"></a><br>  Ein kleiner Exkurs über das System, das wir entwickeln, und seinen Zustand zu Beginn dieses Experiments: <br><br><ul><li>  Ein System, in dem 90% der Daten aktiv geändert und verarbeitet werden (Transaktionen, personenbezogene Daten, berechnete Aggregationen), aber selten gelesen werden und die restlichen 10% sich sehr selten ändern, aber bei jeder Gelegenheit zum Lesen verwendet werden </li><li>  Fast monolithischer Dienst auf .Net Framework, in dem all dies implementiert ist </li><li>  Nhibernate mit minimaler Bindung, verwendet für den Zugriff auf die Datenbank und einige darauf basierende Caches (Abonnements für Änderungen an BO-Entitäten, Handler, die beim Transaktions-Commit aufgerufen werden) </li><li>  Ein Dutzend unausgesprochener Regeln, "wie man Code schreibt, um auf die Datenbank zuzugreifen, ohne die Leistung mit NHibernate-Funktionen zu beeinträchtigen", werden regelmäßig in Core Review behandelt </li><li>  Eine etwas langweilige Datenbank, die optimiert werden muss </li></ul><br>  Beim Nachdenken über die Situation mit der Datenbank entstand der Gedanke: ob diese 10% der Anforderungen aus der Datenbank entfernt werden sollen (und gleichzeitig die für sie erforderlichen Verbindungen zur Datenbank geöffnet werden sollen, offene Transaktionen gehalten und der Vorlagencode verwendet werden soll, um über unsere Repositorys auf die Datenbank zuzugreifen).  In diesem Fall musste Folgendes berücksichtigt werden: <br><br><ul><li>  Wir haben bereits versucht, mit dem Nhibernate-Cache zu arbeiten, haben jedoch festgestellt, dass sein Verhalten nicht immer explizit und vorhersehbar ist. </li><li>  Ich wollte ohne guten Grund nichts grundlegend an der Plattform oder Infrastruktur ändern </li><li>  Die Anzahl der handgeschriebenen Codes sollte, wie bei jedem faulen Programmierer, dadurch verringert werden, dass Hunderte von Zeilen mit Wrappern und Abonnements für vorhandene Caches mit Ihren Händen geschrieben werden </li></ul><br><div class="spoiler">  <b class="spoiler_title">Eine Beispielimplementierung eines dieser alten Caches</b> <div class="spoiler_text"><pre><code class="cs hljs"><span class="hljs-comment"><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;summary&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> Base class for caches, containing rarely changed entities. Updated by subscription to nHibernate session commits. </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/summary&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;typeparam name="T"&gt;</span></span></span><span class="hljs-comment">Type, used as a base for the cache. Sessions, containing changes to any instance of this class will cause cache refresh.</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/typeparam&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;typeparam name="K"&gt;</span></span></span><span class="hljs-comment">Key used for cache search.</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/typeparam&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;typeparam name="V"&gt;</span></span></span><span class="hljs-comment">Value, stored in cache.</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/typeparam&gt;</span></span></span><span class="hljs-comment"> public abstract class RareChangedObjectsCache</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;T, K, V&gt;</span></span></span><span class="hljs-comment"> : EmptySessionNotificationListener, ITransactionNotificationListener, IRareChangedObjectsCache</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;K, V&gt;</span></span></span><span class="hljs-comment"> where T : class { [NotNull] private static readonly ILog Log = IikoBizLogManager.GetLogger(typeof(RareChangedObjectsCache</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;T, K, V&gt;</span></span></span><span class="hljs-comment">)); [NotNull] protected readonly ReaderWriterLockSlim LockObj = new ReaderWriterLockSlim(LockRecursionPolicy.SupportsRecursion); [NotNull] protected readonly Dictionary</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;K, V&gt;</span></span></span><span class="hljs-comment"> Cache = new Dictionary</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;K, V&gt;</span></span></span><span class="hljs-comment">(); [NotNull] protected abstract QueryOver</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;T&gt;</span></span></span><span class="hljs-comment"> GetQuery(); [NotNull] private readonly ConcurrentDictionary</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;String, bool&gt;</span></span></span><span class="hljs-comment"> changesByTransaction = new ConcurrentDictionary</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;string, bool&gt;</span></span></span><span class="hljs-comment">(); private DateTime lastRefreshTime = DateTime.MinValue; [NotNull] public HibernateSessionManager SessionManager { get; set; } </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;summary&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> Interval of automatic data renewal for cases of read access to cache. Also, cache is forcibly refreshed on any commit, changing base entities of this cache. </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/summary&gt;</span></span></span><span class="hljs-comment"> public TimeSpan AutoRefreshInterval { get; set; } public void Reset() { lastRefreshTime = DateTime.MinValue; } protected void ReloadCacheIfNeeded(ISession session = null) { if (SystemTime.Now - lastRefreshTime </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;= AutoRefreshInterval) return; LockObj.EnterWriteLock(); try { if (SystemTime.Now - lastRefreshTime &lt;= AutoRefreshInterval) return; IList&lt;object&gt;</span></span></span><span class="hljs-comment"> result; if (session == null) result = SessionManager.CallTransacted(s =&gt; GetQuery().GetExecutableQueryOver(s).List</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;object&gt;</span></span></span><span class="hljs-comment">()); else //TODO At that moment, the transaction may have been closed, so a new transaction opens implicitly result = GetQuery().GetExecutableQueryOver(session).List</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;object&gt;</span></span></span><span class="hljs-comment">(); Cache.Clear(); ProcessResult(result); lastRefreshTime = SystemTime.Now; } catch (Exception e) { Log.Error("Exception on cache invalidation: ", e); } finally { LockObj.ExitWriteLock(); } } protected abstract void ProcessResult(IList</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;object&gt;</span></span></span><span class="hljs-comment"> result); public override void OnSaveOrUpdate(ISession session, object entity, Guid id, object[] currentState, object[] previousState, string[] propertyNames, IType[] types) { if (entity is T) { var transactionName = HibernateSessionManager.GetTransactionName(); if (!string.IsNullOrEmpty(transactionName)) { changesByTransaction.TryAdd(transactionName, true); } } } public override void OnDelete(ISession session, object entity, Guid id) { if (entity is T) { var transactionName = HibernateSessionManager.GetTransactionName(); if (!string.IsNullOrEmpty(transactionName)) { changesByTransaction.TryAdd(transactionName, true); } } } void ITransactionNotificationListener.AfterCommit(ISession session, string transactionName) { bool tmp; if (changesByTransaction.TryRemove(transactionName, out tmp)) Reset(); ReloadCacheIfNeeded(session); } void ITransactionNotificationListener.AfterRollback(ISession session, string transactionName) { } public bool Contains(K key) { ReloadCacheIfNeeded(); LockObj.EnterReadLock(); try { return Cache.ContainsKey(key); } finally { LockObj.ExitReadLock(); } } public virtual V TryGet(K key) { ReloadCacheIfNeeded(); LockObj.EnterReadLock(); try { return Cache.TryGetValue(key, out var value) ? value : default; } finally { LockObj.ExitReadLock(); } } protected TV GetOrAddEntry</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;TK, TV&gt;</span></span></span><span class="hljs-comment">(IDictionary</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;TK, TV&gt;</span></span></span><span class="hljs-comment"> dictionary, TK key) where TV : new() { TV list; if (!dictionary.TryGetValue(key, out list)) dictionary[key] = (list = new TV()); return list; } } </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;summary&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> Caches all guest categories, grouped by organization or network they belong. </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/summary&gt;</span></span></span><span class="hljs-comment"> [UsedImplicitly] public sealed class GuestCategoryCache : RareChangedObjectsCache</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;GuestCategory, Guid, HashSet&lt;GuestCategory&gt;</span></span></span><span class="hljs-comment">&gt; { private static readonly QueryOver</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;GuestCategory&gt;</span></span></span><span class="hljs-comment"> SelectAllEntitiesQuery = QueryOver.Of</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;GuestCategory&gt;</span></span></span><span class="hljs-comment">() .Fetch(gc =&gt; gc.Organization).Eager .Fetch(gc =&gt; gc.Network).Eager; private readonly Dictionary</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;Guid, string&gt;</span></span></span><span class="hljs-comment"> invertedCache = new Dictionary</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;Guid, string&gt;</span></span></span><span class="hljs-comment">(); public bool TryGetNetworkExternalId(Guid id, out string extId) { ReloadCacheIfNeeded(); LockObj.EnterReadLock(); try { return invertedCache.TryGetValue(id, out extId); } finally { LockObj.ExitReadLock(); } } protected override QueryOver</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;GuestCategory&gt;</span></span></span><span class="hljs-comment"> GetQuery() { return SelectAllEntitiesQuery; } protected override void ProcessResult(IList</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;object&gt;</span></span></span><span class="hljs-comment"> result) { invertedCache.Clear(); foreach (GuestCategory gc in result) { var orgOrNetworkId = gc.Organization?.Id ?? gc.Network.Id; GetOrAddEntry(Cache, orgOrNetworkId).Add(gc); } } }</span></span></code> </pre> <br></div></div><br>  damals schon etwas müde. <br>  - Eine neue Funktion sollte andere Entwickler nicht global beeinflussen. Die Migration auf einen neuen Ansatz sollte reibungslos und reibungslos erfolgen. <br><br>  Gleichzeitig wollte ich sicherstellen, dass das Hinzufügen einer neuen Entität zu den Caching-Mechanismen einen minimalen Aufwand erfordert, der Code lesbar und unkompliziert bleibt und beim Abrufen von Daten aus dem Cache nur minimal darüber nachgedacht werden kann, welcher Hilfscode geschrieben werden soll.  Die letzten beiden Punkte haben die Auswahlmöglichkeiten erheblich eingeschränkt.  Tatsächlich müssen Sie entweder mit Reflexion und generischen Klassen einen Unterschied machen oder sich der guten alten Metaprogrammierung zuwenden. <br><br>  Da das Hauptentwicklungstool Visual Studio ist, ich aber nicht viel Energie darauf verwenden wollte, dass es keinen großen Effekt hat, habe ich beschlossen, die Entscheidung „auf der Stirn“ mit den meisten Standardwerkzeugen und erst in der Phase des fertigen Proof Of Concept für einige der am häufigsten verwendeten zu treffen Unternehmen - präsentieren eine Entscheidung vor Kollegen vor Gericht. <br><br>  Als nächstes kam ein moralisches Dilemma.  Ob Sie eine Klasse als Quelle verwenden möchten, die für alle Gelegenheiten mit Attributen versehen ist (im Stil von Nhibernates Fluent-Mapping auf Steroiden) oder ein schönes, ordentliches XML schreiben möchten.  Ich erinnerte mich daran, dass Faulheit der beste Freund eines Programmierers ist und das Beschreiben von Klassen mit Attributen zeitaufwändiger ist als das Schreiben von ein wenig XML. Ich entschied mich für Letzteres. <br><br>  Was brauchte ich im Wesentlichen für die Beschreibung von Entitäten? <br><br><ul><li>  Beschreibung der zwischengespeicherten Felder </li><li>  Die Fähigkeit, die Eigenschaften anzugeben, mit denen wir aus diesen Daten Samples erstellen, falls erforderlich, die Fähigkeit, diese Samples zu optimieren, indem der lineare Durchgang durch Listen eliminiert wird (wenn Sie in der Optimierung spielen, also vollständig) </li><li>  Zusätzliche Bequemlichkeit, um Klassen in verschiedenen Ordnern zu verteilen und die vorhandenen Entwicklungen im Code zu verwenden, um seine Anzahl zu reduzieren </li></ul><br><div class="spoiler">  <b class="spoiler_title">Wir haben diese XML-Struktur</b> <div class="spoiler_text"><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">class</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"GuestCategory"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">logicallyDeletable</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"true"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">revisioned</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"true"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">organizationNetworkBased</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"true"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">basedOn</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"BO.GuestCategory"</span></span></span><span class="hljs-tag"> &gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">emitBo</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">emitMapping</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"true"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">emitRepository</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">dependsOn</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"guestCategoryCache"</span></span></span><span class="hljs-tag">&gt;</span></span>IGuestCategoryRepository<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">emitRepository</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">field</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"IsActive"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"bool"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">field</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"IsDefaultForNewGuests"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"bool"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">field</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Name"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"string"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">notNull</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"true"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">class</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br></div></div><br>  Und eine große, beängstigende T4-Vorlage zum Parsen und Generieren verschiedener, aber dringend benötigter Klassen: <br><br><ul><li>  Ein "zwischengespeicherter" Typ mit denselben Feldern wie BO, jedoch nicht bearbeitbar </li><li>  Implementieren eines Caches für einen Typ mit Filterauswahlmethoden </li><li>  Eine Registrierung von Caches zum Abonnieren von Nhibernate-Mechanismen für Benachrichtigungen und Registrierung in DI (in unserem Fall Spring) </li><li>  Schnittstellen für all dies, um die Innenseiten zu verbergen und gegebenenfalls den generierten Code durch handgeschriebenen und zurück zu ersetzen. </li><li>  Als angenehmer ungeplanter Bonus von Anfang an, wenn die Arbeit mit den Hauptentitäten bereits fertig war - ich habe einen halben Schritt zum Glück getan und nebenbei die Möglichkeit hinzugefügt, einfache BO-Typen und Zuordnungen zu generieren, um Kollegen die Möglichkeit zu geben, mit einem halben Tritt neue Klassen hinzuzufügen. </li></ul><br>  Die Vorlage selbst besteht aus logischer Sicht aus zwei Teilen: Parsen der ursprünglichen XML in Klassen, die die gewünschte Klassenstruktur beschreiben (um das Risiko eines impliziten Verhaltens zu verringern, wurde in diesem Fall beschlossen, dies durch explizites Parsen von Tags und nicht durch Zuordnen zu tun Attribute. <br><br><div class="spoiler">  <b class="spoiler_title">Strukturklassen</b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">DalClass</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Name { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> LogicallyDeletable { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> BasedOn { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> DalBOType { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>[] Implements { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>[] Include { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> CustomConsistencyManager { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> List&lt;DalField&gt; Fields { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> List&lt;DalField&gt; ExplicitlyDefinedFields { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> DalGetBy[] GetBy { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> DalGetBy[] GetAllBy { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> GenerateInterface { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> DalEmitBo EmitBo { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> DalEmitRepository EmitRepository { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">DalClass</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">XmlElement sourceXml</span></span></span><span class="hljs-function">)</span></span> { Implements = sourceXml.SelectNodes(<span class="hljs-string"><span class="hljs-string">"*[local-name()='implements']"</span></span>) .Cast&lt;XmlElement&gt;() .Select(f =&gt; f.InnerText + <span class="hljs-string"><span class="hljs-string">","</span></span>) .ToArray(); Include = sourceXml.SelectNodes(<span class="hljs-string"><span class="hljs-string">"*[local-name()='include']"</span></span>) .Cast&lt;XmlElement&gt;() .Select(f =&gt; f.InnerText) .ToArray(); Name = sourceXml.GetAttribute(<span class="hljs-string"><span class="hljs-string">"name"</span></span>); LogicallyDeletable = sourceXml.HasAttribute(<span class="hljs-string"><span class="hljs-string">"logicallyDeletable"</span></span>); BasedOn = sourceXml.GetAttribute(<span class="hljs-string"><span class="hljs-string">"basedOn"</span></span>); DalBOType = sourceXml.HasAttribute(<span class="hljs-string"><span class="hljs-string">"dalBoType"</span></span>) ? sourceXml.GetAttribute(<span class="hljs-string"><span class="hljs-string">"dalBoType"</span></span>) : BasedOn; CustomConsistencyManager = sourceXml.HasAttribute(<span class="hljs-string"><span class="hljs-string">"customConsistencyManager"</span></span>) ? sourceXml.GetAttribute(<span class="hljs-string"><span class="hljs-string">"customConsistencyManager"</span></span>) == <span class="hljs-string"><span class="hljs-string">"true"</span></span> : <span class="hljs-literal"><span class="hljs-literal">false</span></span>; Fields = sourceXml.SelectNodes(<span class="hljs-string"><span class="hljs-string">"*[local-name()='field']"</span></span>) .Cast&lt;XmlElement&gt;() .Select(f =&gt; <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> DalField(f)) .ToList(); ExplicitlyDefinedFields = Fields.ToList(); Fields = Fields.OrderBy(f=&gt;f.Name).ToList(); GetBy = sourceXml.SelectNodes(<span class="hljs-string"><span class="hljs-string">"*[local-name()='getBy']"</span></span>) .Cast&lt;XmlElement&gt;() .Select(f =&gt; <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> DalGetBy(f)) .ToArray(); GetAllBy = sourceXml.SelectNodes(<span class="hljs-string"><span class="hljs-string">"*[local-name()='getAllBy']"</span></span>) .Cast&lt;XmlElement&gt;() .Select(f =&gt; <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> DalGetBy(f)) .ToArray(); EmitBo = sourceXml.SelectNodes(<span class="hljs-string"><span class="hljs-string">"*[local-name()='emitBo']"</span></span>) .Cast&lt;XmlElement&gt;() .Select(f =&gt; <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> DalEmitBo(f)) .SingleOrDefault(); EmitRepository = sourceXml.SelectNodes(<span class="hljs-string"><span class="hljs-string">"*[local-name()='emitRepository']"</span></span>) .Cast&lt;XmlElement&gt;() .Select(f =&gt; <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> DalEmitRepository(f, Name)) .SingleOrDefault(); GenerateInterface = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">string</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetIncludedNamespaces</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.Join(<span class="hljs-string"><span class="hljs-string">"/n"</span></span>, Include.Select(i =&gt; <span class="hljs-string"><span class="hljs-string">"using "</span></span> + i + <span class="hljs-string"><span class="hljs-string">";"</span></span>)); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">string</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetBoClassDefinition</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Name + <span class="hljs-string"><span class="hljs-string">" :\n\t\tBaseEntity,\n\t\t"</span></span> + (LogicallyDeletable ? <span class="hljs-string"><span class="hljs-string">"ILogicallyDeletable,\n\t\t"</span></span> : <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.Empty) + (Implements.Any() ? <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.Join(<span class="hljs-string"><span class="hljs-string">"\n\t\t"</span></span>, Implements) + <span class="hljs-string"><span class="hljs-string">"\n\t\t"</span></span> : <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.Empty) + <span class="hljs-string"><span class="hljs-string">"I"</span></span> + Name; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">string</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetCachedClassDefinition</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"Cached"</span></span> + Name + <span class="hljs-string"><span class="hljs-string">" :\n\t\t"</span></span> + (LogicallyDeletable ? <span class="hljs-string"><span class="hljs-string">"Deletable"</span></span> : <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.Empty) + <span class="hljs-string"><span class="hljs-string">"CachedEntity&lt;"</span></span> + BasedOn + <span class="hljs-string"><span class="hljs-string">"&gt;,\n\t\t"</span></span> + (Implements.Any() ? <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.Join(<span class="hljs-string"><span class="hljs-string">"\n\t\t"</span></span>, Implements) + <span class="hljs-string"><span class="hljs-string">"\n\t\t"</span></span> : <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.Empty) + <span class="hljs-string"><span class="hljs-string">"I"</span></span> + Name; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">string</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">TryGetIsDeletedParameter</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (LogicallyDeletable) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">",bool getDeleted"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> String.Empty; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">string</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">TryGetIsDeletedFilter</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (LogicallyDeletable) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">@" if (!getDeleted) entities = entities.Where(e =&gt; !e.IsDeleted); "</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> String.Empty; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">string</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetFilterParameters</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">DalGetBy getBy</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> filters = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> List&lt;FieldDescription&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> filter <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> getBy.Filters) filters.Add(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> FieldDescription { TypeName = Fields.Single(f =&gt; f.Name == filter.Key).FieldType, Alias = filter.Value }); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.Join(<span class="hljs-string"><span class="hljs-string">", "</span></span>, filters.Select(f =&gt; f.TypeName + <span class="hljs-string"><span class="hljs-string">" "</span></span> + f.Alias)); } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">struct</span></span> FieldDescription { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> TypeName; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Alias; } } <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">DalField</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Name { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> FieldType { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Source { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> PropertySource { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> NotNull { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">DalField</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> name, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> type</span></span></span><span class="hljs-function">)</span></span> { Name = name; FieldType = type; Source = name; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">DalField</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">XmlElement sourceXml</span></span></span><span class="hljs-function">)</span></span> { Name = sourceXml.GetAttribute(<span class="hljs-string"><span class="hljs-string">"name"</span></span>); FieldType = sourceXml.GetAttribute(<span class="hljs-string"><span class="hljs-string">"type"</span></span>); Source = sourceXml.HasAttribute(<span class="hljs-string"><span class="hljs-string">"source"</span></span>) ? sourceXml.GetAttribute(<span class="hljs-string"><span class="hljs-string">"source"</span></span>) : sourceXml.GetAttribute(<span class="hljs-string"><span class="hljs-string">"name"</span></span>); PropertySource = sourceXml.HasAttribute(<span class="hljs-string"><span class="hljs-string">"propertySource"</span></span>) ? sourceXml.GetAttribute(<span class="hljs-string"><span class="hljs-string">"propertySource"</span></span>) : <span class="hljs-literal"><span class="hljs-literal">null</span></span>; NotNull = sourceXml.HasAttribute(<span class="hljs-string"><span class="hljs-string">"notNull"</span></span>) ? sourceXml.GetAttribute(<span class="hljs-string"><span class="hljs-string">"notNull"</span></span>) == <span class="hljs-string"><span class="hljs-string">"true"</span></span> : <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">string</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetConstructorInitValueExpression</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> fieldIsArray = FieldType.EndsWith(<span class="hljs-string"><span class="hljs-string">"[]"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> fieldRealType = FieldType.Replace(<span class="hljs-string"><span class="hljs-string">"[]"</span></span>, <span class="hljs-string"><span class="hljs-string">""</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (PropertySource!=<span class="hljs-literal"><span class="hljs-literal">null</span></span> &amp;&amp; fieldRealType.StartsWith(<span class="hljs-string"><span class="hljs-string">"I"</span></span>)) fieldRealType = <span class="hljs-string"><span class="hljs-string">"Cached"</span></span> + fieldRealType.Substring(<span class="hljs-number"><span class="hljs-number">1</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> UpperInitial(Name) + <span class="hljs-string"><span class="hljs-string">" = source."</span></span> + Source + (fieldIsArray ? <span class="hljs-string"><span class="hljs-string">".Select(i=&gt;new "</span></span> + fieldRealType + <span class="hljs-string"><span class="hljs-string">"(i)).ToArray()"</span></span> : <span class="hljs-string"><span class="hljs-string">""</span></span>) + <span class="hljs-string"><span class="hljs-string">";"</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">string</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetPropertyDefinitionExpression</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"public "</span></span> + GetType() + <span class="hljs-string"><span class="hljs-string">" "</span></span> + UpperInitial(Name) + (PropertySource != <span class="hljs-literal"><span class="hljs-literal">null</span></span> ? <span class="hljs-string"><span class="hljs-string">" =&gt; "</span></span> + PropertySource + <span class="hljs-string"><span class="hljs-string">";"</span></span> : <span class="hljs-string"><span class="hljs-string">" { get; private set; }"</span></span>); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">string</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetBOPropertyDefinitionExpression</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"public virtual "</span></span> + GetBoType() + <span class="hljs-string"><span class="hljs-string">" "</span></span> + UpperInitial(Name) + <span class="hljs-string"><span class="hljs-string">" { get; set; }"</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">string</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetInterfacePropertyDefinitionExpression</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> GetNullAttribute() + GetType() + <span class="hljs-string"><span class="hljs-string">" "</span></span> + UpperInitial(Name) + <span class="hljs-string"><span class="hljs-string">" { get; }"</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">string</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetType</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> fieldIsArray = FieldType.EndsWith(<span class="hljs-string"><span class="hljs-string">"[]"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (fieldIsArray) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"IEnumerable&lt;"</span></span> + FieldType.Replace(<span class="hljs-string"><span class="hljs-string">"[]"</span></span>, <span class="hljs-string"><span class="hljs-string">""</span></span>) + <span class="hljs-string"><span class="hljs-string">"&gt;"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> FieldType; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">string</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetBoType</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> fieldIsArray = FieldType.EndsWith(<span class="hljs-string"><span class="hljs-string">"[]"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (fieldIsArray) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"IList&lt;"</span></span> + FieldType.Replace(<span class="hljs-string"><span class="hljs-string">"[]"</span></span>, <span class="hljs-string"><span class="hljs-string">""</span></span>) + <span class="hljs-string"><span class="hljs-string">"&gt;"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> FieldType; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">string</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetNullAttribute</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> =&gt; TypeCanBeNull() ? NotNull ? <span class="hljs-string"><span class="hljs-string">"[NotNull] "</span></span> : <span class="hljs-string"><span class="hljs-string">"[CanBeNull] "</span></span> : <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.Empty; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>[] NotNullTypes = { <span class="hljs-string"><span class="hljs-string">"Guid"</span></span>, <span class="hljs-string"><span class="hljs-string">"DateTime"</span></span>, <span class="hljs-string"><span class="hljs-string">"DateTimeOffset"</span></span>, <span class="hljs-string"><span class="hljs-string">"bool"</span></span>, <span class="hljs-string"><span class="hljs-string">"int"</span></span>, <span class="hljs-string"><span class="hljs-string">"long"</span></span>, <span class="hljs-string"><span class="hljs-string">"short"</span></span>, <span class="hljs-string"><span class="hljs-string">"ProgramType"</span></span>, <span class="hljs-string"><span class="hljs-string">"GuestSubscriptionTypes"</span></span>, <span class="hljs-string"><span class="hljs-string">"SenderType"</span></span>, <span class="hljs-string"><span class="hljs-string">"ApiClientType"</span></span> }; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">TypeCanBeNull</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> =&gt; !NotNullTypes.Contains(FieldType); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">string</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">UpperInitial</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> name</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> name[<span class="hljs-number"><span class="hljs-number">0</span></span>].ToString().ToUpperInvariant() + name.Substring(<span class="hljs-number"><span class="hljs-number">1</span></span>); } } <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">DalGetBy</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> IsTry { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Alias { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Dictionary&lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>&gt; Filters { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; } = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Dictionary&lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>&gt;(); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">DalGetBy</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">XmlElement sourceXml</span></span></span><span class="hljs-function">)</span></span> { IsTry = sourceXml.HasAttribute(<span class="hljs-string"><span class="hljs-string">"try"</span></span>); Alias = sourceXml.GetAttribute(<span class="hljs-string"><span class="hljs-string">"alias"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (XmlElement filterNode <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> sourceXml.SelectNodes(<span class="hljs-string"><span class="hljs-string">"*[local-name()='field']"</span></span>)) Filters.Add(filterNode.GetAttribute(<span class="hljs-string"><span class="hljs-string">"field"</span></span>), filterNode.GetAttribute(<span class="hljs-string"><span class="hljs-string">"alias"</span></span>)); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">string</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetConditions</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.Join(<span class="hljs-string"><span class="hljs-string">" &amp;&amp; "</span></span>, Filters.Select(f =&gt; <span class="hljs-string"><span class="hljs-string">$"e.</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{f.Key}</span></span></span><span class="hljs-string"> == </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{f.Value}</span></span></span><span class="hljs-string">"</span></span>)); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.Join(<span class="hljs-string"><span class="hljs-string">" &amp;&amp; "</span></span>, Filters.Select(f =&gt; <span class="hljs-string"><span class="hljs-string">$"e.</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{f.Key}</span></span></span><span class="hljs-string"> == </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{f.Value}</span></span></span><span class="hljs-string">"</span></span>)); } } <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">DalEmitBo</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Namespace { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> EmitMapping { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> XmlElement sourceXml; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">DalEmitBo</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">XmlElement sourceXml</span></span></span><span class="hljs-function">)</span></span> { Namespace = sourceXml.GetAttribute(<span class="hljs-string"><span class="hljs-string">"ns"</span></span>); EmitMapping = sourceXml.HasAttribute(<span class="hljs-string"><span class="hljs-string">"emitMapping"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.sourceXml = sourceXml; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">string</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetMapping</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">DalField field</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> notNull = !field.TypeCanBeNull() || field.NotNull; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> overridenXml = sourceXml.SelectNodes(<span class="hljs-string"><span class="hljs-string">"*[local-name()='column']"</span></span>).Cast&lt;XmlElement&gt;().SingleOrDefault(e =&gt; e.GetAttribute(<span class="hljs-string"><span class="hljs-string">"name"</span></span>) == field.Name); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> props = overridenXml != <span class="hljs-literal"><span class="hljs-literal">null</span></span> ? <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> OverridenProperties(overridenXml) : <span class="hljs-literal"><span class="hljs-literal">null</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span>(field.FieldType) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-string"><span class="hljs-string">"string"</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">$"&lt;property name=\"</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{field.Name}</span></span></span><span class="hljs-string">\"&gt;&lt;column name=\"</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{field.Name}</span></span></span><span class="hljs-string">\" </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{(notNull ? </span></span><span class="hljs-string"><span class="hljs-string"><span class="hljs-subst"><span class="hljs-string">"not-null=\"true\""</span></span></span></span><span class="hljs-string"><span class="hljs-subst"> : </span></span><span class="hljs-keyword"><span class="hljs-string"><span class="hljs-subst"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-string"><span class="hljs-subst">.Empty)}</span></span></span><span class="hljs-string"> </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{(props?.SqlType !=</span></span><span class="hljs-literal"><span class="hljs-string"><span class="hljs-subst"><span class="hljs-literal">null</span></span></span></span><span class="hljs-string"><span class="hljs-subst"> ? </span></span><span class="hljs-string"><span class="hljs-string"><span class="hljs-subst"><span class="hljs-string">"sql-type=\""</span></span></span></span><span class="hljs-string"><span class="hljs-subst"> + props.SqlType+</span></span><span class="hljs-string"><span class="hljs-string"><span class="hljs-subst"><span class="hljs-string">"\""</span></span></span></span><span class="hljs-string"><span class="hljs-subst"> : </span></span><span class="hljs-keyword"><span class="hljs-string"><span class="hljs-subst"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-string"><span class="hljs-subst">.Empty)}</span></span></span><span class="hljs-string">/&gt;&lt;/property&gt;"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-string"><span class="hljs-string">"bool"</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">$"&lt;property name=\"</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{field.Name}</span></span></span><span class="hljs-string">\" not-null=\"true\" type=\"boolean\"&gt;&lt;column name=\"</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{field.Name}</span></span></span><span class="hljs-string">\" not-null=\"true\" default=\"</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{props?.DefaultValue??</span></span><span class="hljs-string"><span class="hljs-string"><span class="hljs-subst"><span class="hljs-string">"0"</span></span></span></span><span class="hljs-string"><span class="hljs-subst">}</span></span></span><span class="hljs-string">\" sql-type=\"bit\" /&gt;&lt;/property&gt;"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-string"><span class="hljs-string">"DateTime"</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">$"&lt;property name=\"</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{field.Name}</span></span></span><span class="hljs-string">\" not-null=\"true\"/&gt;"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-string"><span class="hljs-string">"DateTime?"</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">$"&lt;property name=\"</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{field.Name}</span></span></span><span class="hljs-string">\" /&gt;"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-string"><span class="hljs-string">"ProgramType"</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">$"&lt;property name=\"</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{field.Name}</span></span></span><span class="hljs-string">\"&gt;&lt;column name=\"</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{field.Name}</span></span></span><span class="hljs-string">\" default=\"</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{props?.DefaultValue??</span></span><span class="hljs-string"><span class="hljs-string"><span class="hljs-subst"><span class="hljs-string">"0"</span></span></span></span><span class="hljs-string"><span class="hljs-subst">}</span></span></span><span class="hljs-string">\" </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{(notNull ? </span></span><span class="hljs-string"><span class="hljs-string"><span class="hljs-subst"><span class="hljs-string">"not-null=\"true\""</span></span></span></span><span class="hljs-string"><span class="hljs-subst"> : </span></span><span class="hljs-keyword"><span class="hljs-string"><span class="hljs-subst"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-string"><span class="hljs-subst">.Empty)}</span></span></span><span class="hljs-string">/&gt;&lt;/property&gt;"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-string"><span class="hljs-string">"Guid?"</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">$"&lt;property name=\"</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{field.Name}</span></span></span><span class="hljs-string">\" /&gt;"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">default</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ArgumentOutOfRangeException(<span class="hljs-string"><span class="hljs-string">$"Not supported type </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{field.FieldType}</span></span></span><span class="hljs-string">. Edit DAL.tt to add mapping definition."</span></span>); } } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">OverridenProperties</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> DefaultValue { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> SqlType { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OverridenProperties</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">XmlElement sourceXml</span></span></span><span class="hljs-function">)</span></span> { DefaultValue = sourceXml.GetAttribute(<span class="hljs-string"><span class="hljs-string">"default"</span></span>); SqlType = sourceXml.GetAttribute(<span class="hljs-string"><span class="hljs-string">"sql-type"</span></span>); } } } <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">DalEmitRepository</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Interface { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> DependsOn { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">DalEmitRepository</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">XmlElement sourceXml, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> className</span></span></span><span class="hljs-function">)</span></span> { Interface = <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.IsNullOrEmpty(sourceXml.InnerText) ? <span class="hljs-string"><span class="hljs-string">"IRepository&lt;"</span></span>+className+<span class="hljs-string"><span class="hljs-string">"&gt;"</span></span> : sourceXml.InnerText; DependsOn = sourceXml.GetAttribute(<span class="hljs-string"><span class="hljs-string">"dependsOn"</span></span>); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">string</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetRepositoryClassName</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> =&gt; Interface.Substring(<span class="hljs-number"><span class="hljs-number">1</span></span>); }</code> </pre> <br></div></div><br><div class="spoiler">  <b class="spoiler_title">Der Code für die resultierende Vorlage</b> <div class="spoiler_text"><pre> <code class="cs hljs">&lt;<span class="hljs-meta"><span class="hljs-meta">#@ template debug="false" hostspecific="true" language="C#" #&gt; &lt;#@ assembly name="System.Xml" #&gt; &lt;#@ assembly name="System.Core" #&gt; &lt;#@ assembly name="EnvDTE" #&gt; &lt;#@ import namespace="System.Xml" #&gt; &lt;#@ import namespace="System.Collections.Generic" #&gt; &lt;#@ import namespace="System.IO" #&gt; &lt;#@ import namespace="System.Linq" #&gt; &lt;#@ output extension="/" #&gt; &lt;# EnvDTE.DTE dte = (EnvDTE.DTE) ((IServiceProvider) this.Host) .GetService(typeof(EnvDTE.DTE)); XmlDocument doc = new XmlDocument(); doc.Load(System.IO.Path.Combine(dte.ActiveDocument.Path, "DAL.xml")); var classes = doc.SelectNodes("//*[local-name()='class']").Cast&lt;XmlElement&gt;().Select(classXml=&gt;new DalClass(classXml)).ToArray(); //fields foreach(var classNode in classes) { #&gt; /* The file was generated automatically and should not be edited manually. For any changes edit DAL.xml or DAL.tt. */ using System; using System.Collections.Generic; using System.Linq; using System.Runtime.Serialization; using JetBrains.Annotations; &lt;#=classNode.GetIncludedNamespaces()#&gt; namespace Domain.DALV2 { public class &lt;#=classNode.GetCachedClassDefinition()#&gt; { public Cached&lt;#=classNode.Name#&gt;(&lt;#=classNode.DalBOType#&gt; source) : base(source) { &lt;#=string.Join("\n\t\t\t", classNode.Fields.Where(f =&gt; f.PropertySource == null).Select(f=&gt;f.GetConstructorInitValueExpression()))#&gt; } &lt;#=string.Join("\n\n\t\t", classNode.Fields.Select(f=&gt;f.GetPropertyDefinitionExpression()))#&gt; } } &lt;#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> (classNode.GenerateInterface){#&gt; namespace Domain.DAL { public interface I&lt;#=classNode.Name#&gt; &lt;#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> (classNode.LogicallyDeletable){#&gt; :ILogicallyDeletableReadonly &lt;#}#&gt; { Guid Id { get; } &lt;#=string.Join("\n\n\t\t", classNode.Fields.Select(f=&gt;f.GetInterfacePropertyDefinitionExpression()))#&gt; } } &lt;#SaveOutput("Entities//gen//"+classNode.Name+".g.cs");#&gt; &lt;#}#&gt; /* The file was generated automatically and should not be edited manually. For any changes edit DAL.xml or DAL.tt. */ using System; using System.Collections.Generic; using System.Linq; using System.Runtime.Serialization; using Resto.Framework.Common; using JetBrains.Annotations; &lt;#=classNode.GetIncludedNamespaces()#&gt; namespace Domain.DALV2 { public partial class &lt;#=classNode.Name#&gt;DAL : DAL&lt;Cached&lt;#=classNode.Name#&gt;, &lt;#=classNode.BasedOn#&gt;, &lt;#=classNode.DalBOType#&gt;&gt; { internal &lt;#=classNode.Name#&gt;DAL(ISessionManager sessionManager, ICacheConsistencyManager&lt;&lt;#=classNode.BasedOn#&gt;, &lt;#=classNode.DalBOType#&gt;&gt; consistencyManager) : base(sessionManager, Repositories.&lt;#=classNode.Name#&gt;, consistencyManager) { } &lt;#foreach (var getBy in classNode.GetBy){#&gt; &lt;#=getBy.IsTry?"[CanBeNull]":"[NotNull]"#&gt; public Cached&lt;#=classNode.Name#&gt; &lt;#=getBy.IsTry?"Try":""#&gt;GetBy&lt;#=getBy.Alias#&gt;(&lt;#=classNode.GetFilterParameters(getBy)#&gt;) { UpdateCacheIfNeeded(); using (ConsistencyManager.GetReadLock()) { return Cache.Values.Single&lt;#=getBy.IsTry?"OrDefault":""#&gt;(e =&gt; &lt;#=getBy.GetConditions()#&gt;); } } &lt;#}#&gt; &lt;#foreach (var fieldNode in classNode.GetAllBy){#&gt; [NotNull] [ItemNotNull] public IList&lt;Cached&lt;#=classNode.Name#&gt;&gt; GetAllBy&lt;#=fieldNode.Alias#&gt;(&lt;#=classNode.GetFilterParameters(fieldNode)#&gt;) { UpdateCacheIfNeeded(); using (ConsistencyManager.GetReadLock()) { return Cache.Values.Where(e =&gt; &lt;#=fieldNode.GetConditions()#&gt;).ToList(); } } &lt;#}#&gt; [NotNull] protected override Cached&lt;#=classNode.Name#&gt; Convert(&lt;#=classNode.DalBOType#&gt; source) { return new Cached&lt;#=classNode.Name#&gt;(source); } } } &lt;#SaveOutput("Repositories//gen//"+ classNode.Name+".g.cs");#&gt; &lt;#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta">(classNode.EmitBo != null){#&gt; &lt;?xml version="1.0" encoding="utf-8"?&gt; &lt;hibernate-mapping xmlns="urn:nhibernate-mapping-2.2" assembly="Domain" namespace="&lt;#=classNode.EmitBo.Namespace#&gt;"&gt; &lt;class name="&lt;#=classNode.Name#&gt;" dynamic-update="true" dynamic-insert="true"&gt; &lt;id name="Id"&gt; &lt;generator class="assigned" /&gt; &lt;/id&gt; &lt;#=string.Join("\n\t\t", classNode.ExplicitlyDefinedFields.Select(f=&gt;classNode.EmitBo.GetMapping(f)))#&gt; &lt;#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> (classNode.LogicallyDeletable){#&gt; &lt;property name="IsDeleted" not-null="true" type="boolean"&gt; &lt;column name="IsDeleted" not-null="true" default="0" /&gt; &lt;/property&gt; &lt;property name="WhenDeleted" type="DateTime" not-null="false"/&gt; &lt;#}#&gt; &lt;/class&gt; &lt;/hibernate-mapping&gt; &lt;#SaveOutput("..\\..\\DAL.Hibernate\\Mapping\\gen\\"+classNode.Name+".hbm.xml");#&gt; /* The file was generated automatically and should not be edited manually. For any changes edit DAL.xml or DAL.tt. */ using System; using Common.Domain.BO.DB; using Domain.DAL; using Domain.DALV2; using JetBrains.Annotations; &lt;#=classNode.GetIncludedNamespaces()#&gt; namespace &lt;#=classNode.EmitBo.Namespace#&gt; { public partial class &lt;#=classNode.GetBoClassDefinition()#&gt; { [UsedImplicitly] protected &lt;#=classNode.Name#&gt;(){} &lt;#=string.Join("\n\n\t\t", classNode.ExplicitlyDefinedFields.Select(f=&gt;f.GetBOPropertyDefinitionExpression()))#&gt; &lt;#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> (classNode.LogicallyDeletable){#&gt; public virtual bool IsDeleted { get; set; } public virtual DateTime? WhenDeleted { get; set; } &lt;#}#&gt; } } &lt;# SaveOutput("..//BO//gen//"+ classNode.Name+".g.cs"); } } #&gt; &lt;!-- The file was generated automatically and should not be edited manually. For any changes edit DAL.xml or DAL.tt. --&gt; &lt;objects xmlns="http://www.springframework.net" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:db="http://www.springframework.net/database" xsi:schemaLocation="http://www.springframework.net http://www.springframework.net/xsd/spring-objects.xsd"&gt; &lt;# foreach(var classNode in classes.Where(c =&gt; !c.CustomConsistencyManager)) { #&gt; &lt;object id="&lt;#=LowerInitial(classNode.Name)#&gt;CacheManager" type="Domain.DALV2.TransactionSubscribedManager&lt;&lt;#=classNode.BasedOn#&gt;, &lt;#=classNode.DalBOType#&gt;&gt;, Domain" singleton="true"&gt; &lt;/object&gt; &lt;#}#&gt; &lt;object id="dalGeneratedListeners" type="System.Collections.Generic.List&lt;Common.Hibernate.DAL.ISessionNotificationListener&gt;, mscorlib"&gt; &lt;constructor-arg&gt; &lt;list element-type="Common.Hibernate.DAL.ISessionNotificationListener, Common.Hibernate"&gt; &lt;# foreach(var classNode in classes) { #&gt; &lt;ref object="&lt;#=LowerInitial(classNode.Name)#&gt;CacheManager"/&gt; &lt;#}#&gt; &lt;/list&gt; &lt;/constructor-arg&gt; &lt;/object&gt; &lt;/objects&gt; &lt;#SaveOutput("..//Config//DALSpringDefinitions.g.xml");#&gt; /* The file was generated automatically and should not be edited manually. For any changes edit DAL.xml or DAL.tt. */ using Common; using Common.Domain.DAL; using Domain.BO; using Domain.DALV2; using Spring.Context.Support; using JetBrains.Annotations; &lt;#=string.Join("\n", classes.Select(c=&gt;c.GetIncludedNamespaces()).Where(s=&gt;!string.IsNullOrEmpty(s)))#&gt; namespace Domain.DAL { public partial class DALs { private static readonly SafeLazy&lt;DALs&gt; instance = new SafeLazy&lt;DALs&gt;(() =&gt; new DALs()); private DALs() { var sessionManager = (ISessionManager)ContextRegistry.GetContext().GetObject("sessionManager"); &lt;# foreach(var classNode in classes){ #&gt; this.&lt;#=LowerInitial(classNode.Name)#&gt; = new &lt;#=classNode.Name#&gt;DAL(sessionManager, (ICacheConsistencyManager&lt;&lt;#=classNode.BasedOn#&gt;, &lt;#=classNode.DalBOType#&gt;&gt;)ContextRegistry.GetContext().GetObject("&lt;#=LowerInitial(classNode.Name)#&gt;CacheManager")); &lt;# } #&gt; } &lt;# foreach(var classNode in classes) { #&gt; [NotNull] private readonly &lt;#=classNode.Name#&gt;DAL &lt;#=LowerInitial(classNode.Name)#&gt;; [NotNull] public static &lt;#=classNode.Name#&gt;DAL &lt;#=classNode.Name#&gt; =&gt; instance.Value.&lt;#=LowerInitial(classNode.Name)#&gt;; &lt;#}#&gt; public static void ResetAll() =&gt; instance.Value.ResetAllImpl(); private void ResetAllImpl() { &lt;#foreach(var classNode in classes){#&gt; this.&lt;#=LowerInitial(classNode.Name)#&gt;.Reset(); &lt;#}#&gt; } } } &lt;#SaveOutput("DALs.g.cs");#&gt; /* The file was generated automatically and should not be edited manually. For any changes edit DAL.xml or DAL.tt. */ using JetBrains.Annotations; namespace Domain.DAL { public partial interface IRepositoryFactory { &lt;#foreach(var classNode in classes.Where(c =&gt; c.EmitRepository != null)){#&gt; [NotNull] &lt;#=classNode.EmitRepository.Interface#&gt; &lt;#=classNode.Name#&gt; { get; } &lt;#}#&gt; } } &lt;#SaveOutput("IRepositoryFactory.g.cs");#&gt; /* The file was generated automatically and should not be edited manually. For any changes edit DAL.xml or DAL.tt. */ using JetBrains.Annotations; namespace Domain.DAL { public static partial class Repositories { &lt;#foreach(var classNode in classes.Where(c =&gt; c.EmitRepository != null)){#&gt; [NotNull] public static &lt;#=classNode.EmitRepository.Interface#&gt; &lt;#=classNode.Name#&gt; =&gt; Instance.Value.&lt;#=classNode.Name#&gt;; &lt;#}#&gt; } } &lt;#SaveOutput("Repositories.g.cs");#&gt; /* The file was generated automatically and should not be edited manually. For any changes edit DAL.xml or DAL.tt. */ using Common.Domain.DAL; using Common.Hibernate.DAL; using DAL.Hibernate.Cache.CachingProviders; using Domain.BO; using Domain.DAL; using Domain.DAL.Cache; using Domain.SaveManager; using System; using System.Collections.Generic; using JetBrains.Annotations; using Engine.Main; &lt;#=string.Join("\n", classes.Select(c=&gt;c.GetIncludedNamespaces()).Where(s=&gt;!string.IsNullOrEmpty(s)))#&gt; namespace DAL.Hibernate.DAL { public partial class RepositoryFactory : IRepositoryFactory { public void Init([NotNull] IOrganizationsByNetworkCache organizationsByNetworkCache, [NotNull] INetworkCache networkCache, [NotNull] ITransactionSaveManager transactionSaveManager, [NotNull] ILoginEntryDataProvider loginEntryDataProvider, ListenerNotifier listenerNotifier) { &lt;#foreach(var classNode in classes.Where(c =&gt; c.EmitRepository != null)){#&gt; this.&lt;#=classNode.Name#&gt; = new &lt;#=classNode.EmitRepository.GetRepositoryClassName()#&gt;(&lt;#=classNode.EmitRepository.DependsOn#&gt;); &lt;#}#&gt; } &lt;#foreach(var classNode in classes.Where(c =&gt; c.EmitRepository != null)){#&gt; [NotNull] public &lt;#=classNode.EmitRepository.Interface#&gt; &lt;#=classNode.Name#&gt; { get; private set; } &lt;#}#&gt; } } &lt;#SaveOutput("..\\..\\DAL.Hibernate\\DAL\\RepositoryFactory.g.cs");#&gt; &lt;#+ private string LowerInitial(string name) { return name[0].ToString().ToLowerInvariant() + name.Substring(1); } private string UpperInitial(string name) { return name[0].ToString().ToUpperInvariant() + name.Substring(1); } void SaveOutput(string outputFileName) { string templateDirectory = Path.GetDirectoryName(Host.TemplateFile); string outputFilePath = Path.Combine(templateDirectory, outputFileName); File.WriteAllText(outputFilePath, this.GenerationEnvironment.ToString()); this.GenerationEnvironment.Remove(0, this.GenerationEnvironment.Length); } #&gt;</span></span></code> </pre> <br></div></div><br>  Und wo ohne eine gewisse Menge an kniffligem generischem Code abonniert werden muss, um Änderungen an der Datenbank vorzunehmen, Caches bei Bedarf zu aktualisieren und andere Freuden des Lebens.  Hier stellte sich heraus, dass generisch genug ist, um alle Anwendungsfälle zu schließen, gepaart mit denen, die bereits mit verwendet wurden <br><br><div class="spoiler">  <b class="spoiler_title">Gemeinsamer Code für den Zugriff auf Daten</b> <div class="spoiler_text"><pre> <code class="cs hljs"> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">abstract</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">DAL</span></span>&lt;<span class="hljs-title"><span class="hljs-title">T</span></span>, <span class="hljs-title"><span class="hljs-title">TBase</span></span>, <span class="hljs-title"><span class="hljs-title">TCachedBo</span></span>&gt; <span class="hljs-title"><span class="hljs-title">where</span></span> <span class="hljs-title"><span class="hljs-title">T</span></span> : <span class="hljs-title"><span class="hljs-title">CachedEntity</span></span>&lt;<span class="hljs-title"><span class="hljs-title">TBase</span></span>&gt; <span class="hljs-title"><span class="hljs-title">where</span></span> <span class="hljs-title"><span class="hljs-title">TBase</span></span> : <span class="hljs-title"><span class="hljs-title">class</span></span>, <span class="hljs-title"><span class="hljs-title">IEntity</span></span> <span class="hljs-title"><span class="hljs-title">where</span></span> <span class="hljs-title"><span class="hljs-title">TCachedBo</span></span> : <span class="hljs-title"><span class="hljs-title">class</span></span>, <span class="hljs-title"><span class="hljs-title">IIdEntity</span></span>&lt;<span class="hljs-title"><span class="hljs-title">Guid</span></span>&gt; { [NotNull] <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> ILog log; [NotNull] <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> ISessionManager SessionManager; [NotNull] <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> IReadonlyRepository&lt;TBase&gt; BaseRepository; [NotNull] <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> ICacheConsistencyManager&lt;TBase, TCachedBo&gt; ConsistencyManager; [NotNull] <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> Dictionary&lt;Guid, T&gt; Cache = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Dictionary&lt;Guid, T&gt;(); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">DAL</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">[NotNull] ISessionManager sessionManager, [NotNull] IReadonlyRepository&lt;TBase&gt; baseRepository, [NotNull] ICacheConsistencyManager&lt;TBase, TCachedBo&gt; consistencyManager</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.SessionManager = sessionManager; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.BaseRepository = baseRepository; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.ConsistencyManager = consistencyManager; log = LogManager.GetLogger(GetType()); } [CanBeNull] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> T </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">TryGetById</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Guid id</span></span></span><span class="hljs-function">)</span></span> { UpdateCacheIfNeeded(); <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> (ConsistencyManager.GetReadLock()) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Cache.GetOrDefault(id); } } [NotNull] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> T </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetById</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Guid id</span></span></span><span class="hljs-function">)</span></span> { UpdateCacheIfNeeded(); <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> (ConsistencyManager.GetReadLock()) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ValidateEntityFound(Cache.GetOrDefault(id), <span class="hljs-string"><span class="hljs-string">"{0} with id {1} not found"</span></span>, <span class="hljs-literal"><span class="hljs-literal">null</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(T), id); } } [NotNull] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> TBase </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetEntity</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">[NotNull] ISession session, Guid id</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> BaseRepository.GetById(session, id); } [NotNull] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> TBase </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetEntity</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">[NotNull] ISession session, [NotNull] T e</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> BaseRepository.GetById(session, e.Id); } [NotNull] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> HashSet&lt;T&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetByIds</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">[NotNull] HashSet&lt;Guid&gt; ids</span></span></span><span class="hljs-function">)</span></span> { UpdateCacheIfNeeded(); <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> (ConsistencyManager.GetReadLock()) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ids .Select(id =&gt; Cache.GetOrDefault(id)) .ToHashSet(); } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Reset</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { ConsistencyManager.Reset(); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">abstract</span></span></span><span class="hljs-function"> T </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Convert</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">TCachedBo source</span></span></span><span class="hljs-function">)</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">UpdateCacheIfNeeded</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!ConsistencyManager.UpdateRequired) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; log.Debug(<span class="hljs-string"><span class="hljs-string">$"</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{</span></span><span class="hljs-keyword"><span class="hljs-string"><span class="hljs-subst"><span class="hljs-keyword">typeof</span></span></span></span><span class="hljs-string"><span class="hljs-subst">(T).Name}</span></span></span><span class="hljs-string"> DAL: Update required, getting writeLock"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> updateScope = ConsistencyManager.GetWriteLock()) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (updateScope.UpdateRequired ?? ConsistencyManager.UpdateRequired) SessionManager.RunTransacted(session =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> updatedEntities = updateScope.GetUpdatedEntities(BaseRepository, session); <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> updatedEntity <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> updatedEntities) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (updatedEntity.Value != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) Cache[updatedEntity.Key] = Convert(updatedEntity.Value); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> Cache.Remove(updatedEntity.Key); Reindex(); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (Exception) { ConsistencyManager.Reset(); <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span>; } }); } } <span class="hljs-comment"><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;summary&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> Reevaluate specific indexes, used for search in cached entities. Called after cache has been updated. </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/summary&gt;</span></span></span><span class="hljs-comment"> protected virtual void Reindex() { } [NotNull] protected T1 ValidateEntityFound</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;T1&gt;</span></span></span><span class="hljs-comment">([CanBeNull] T1 entity, [NotNull] string errorMessage, [NotNull] string frontMessage, [NotNull] params object[] p) { if (entity == null) throw new DataAccessException(Util.GetMessage(errorMessage, p), Util.GetMessage(frontMessage, p)); return entity; } }</span></span></code> </pre> <br><br></div></div><br>  Interessanterweise stellte sich heraus, dass es sich um eine Klasse handelte, die die Cache-Konsistenz überwachte und deren Aktualisierung verwaltete. Dies war der Hauptpunkt, an dem ich über die Implementierung von Sperren nachdenken musste, damit alles optimal und minimal blockierend, aber gleichzeitig geschützt war <br><br><div class="spoiler">  <b class="spoiler_title">Eigentlich Umsetzung</b> <div class="spoiler_text"><pre> <code class="cs hljs"> [<span class="hljs-meta"><span class="hljs-meta">UsedImplicitly</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">TransactionSubscribedManager</span></span>&lt;<span class="hljs-title"><span class="hljs-title">TBase</span></span>, <span class="hljs-title"><span class="hljs-title">TCachedBo</span></span>&gt; : <span class="hljs-title"><span class="hljs-title">EmptySessionNotificationListener</span></span>, <span class="hljs-title"><span class="hljs-title">ICacheConsistencyManager</span></span>&lt;<span class="hljs-title"><span class="hljs-title">TBase</span></span>, <span class="hljs-title"><span class="hljs-title">TCachedBo</span></span>&gt;, <span class="hljs-title"><span class="hljs-title">ITransactionNotificationListener</span></span> <span class="hljs-title"><span class="hljs-title">where</span></span> <span class="hljs-title"><span class="hljs-title">TBase</span></span> : <span class="hljs-title"><span class="hljs-title">class</span></span>, <span class="hljs-title"><span class="hljs-title">IEntity</span></span> <span class="hljs-title"><span class="hljs-title">where</span></span> <span class="hljs-title"><span class="hljs-title">TCachedBo</span></span> : <span class="hljs-title"><span class="hljs-title">class</span></span>, <span class="hljs-title"><span class="hljs-title">IIdEntity</span></span>&lt;<span class="hljs-title"><span class="hljs-title">Guid</span></span>&gt; { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> UpdateRequired =&gt; needFullUpdate || !entitiesToUpdate.IsEmpty; [NotNull] <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> ReaderWriterLockSlim LockObj = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ReaderWriterLockSlim(LockRecursionPolicy.SupportsRecursion); [NotNull] <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> ConcurrentDictionary&lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>, ConcurrentBag&lt;Guid&gt;&gt; changesByTransaction = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ConcurrentDictionary&lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>, ConcurrentBag&lt;Guid&gt;&gt;(); [NotNull] <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> ConcurrentBag&lt;Guid&gt; entitiesToUpdate = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ConcurrentBag&lt;Guid&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> needFullUpdate = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">virtual</span></span></span><span class="hljs-function"> CacheWriteLockScope&lt;TBase, TCachedBo&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetWriteLock</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { LockObj.EnterWriteLock(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (needFullUpdate) { needFullUpdate = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> CacheWriteLockScope&lt;TBase, TCachedBo&gt;(LockObj); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> IdBasedCacheWriteLockScope&lt;TBase, TCachedBo&gt;(LockObj, ChangedEntitiesIdsProvider); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (Exception) { LockObj.ExitWriteLock(); <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span>; } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> ICollection&lt;Guid&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ChangedEntitiesIdsProvider</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> ids = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> List&lt;Guid&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> newBag = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ConcurrentBag&lt;Guid&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> oldBag = Interlocked.Exchange(<span class="hljs-keyword"><span class="hljs-keyword">ref</span></span> entitiesToUpdate, newBag); <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (oldBag.TryTake(<span class="hljs-keyword"><span class="hljs-keyword">out</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> id)) ids.Add(id); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ids; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> CacheReadLockScope </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetReadLock</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> CacheReadLockScope(LockObj); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OnSaveOrUpdate</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">ISession session, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">object</span></span></span></span><span class="hljs-function"><span class="hljs-params"> entity, Guid id, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">object</span></span></span></span><span class="hljs-function"><span class="hljs-params">[] currentState, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">object</span></span></span></span><span class="hljs-function"><span class="hljs-params">[] previousState, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params">[] propertyNames, IType[] types</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (entity <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> TBase) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> transactionName = HibernateSessionManager.GetTransactionName(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.IsNullOrEmpty(transactionName)) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (changesByTransaction.TryAdd(transactionName, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ConcurrentBag&lt;Guid&gt;() { id })) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; changesByTransaction.TryGetValue(transactionName, <span class="hljs-keyword"><span class="hljs-keyword">out</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> transactionChangedEntities); <span class="hljs-comment"><span class="hljs-comment">// ReSharper disable once PossibleNullReferenceException // R# does not have attributes telling that value in dictionary is not null. But we know it. transactionChangedEntities.Add(id); } } } public override void OnDelete(ISession session, object entity, Guid id) { if (entity is TBase) { var transactionName = HibernateSessionManager.GetTransactionName(); if (string.IsNullOrEmpty(transactionName)) return; if (changesByTransaction.TryAdd(transactionName, new ConcurrentBag&lt;Guid&gt;() { id })) return; changesByTransaction.TryGetValue(transactionName, out var transactionChangedEntities); // ReSharper disable once PossibleNullReferenceException // R# does not have attributes telling that value in dictionary is not null. But we know it. transactionChangedEntities.Add(id); } } public void Reset() { needFullUpdate = true; } void ITransactionNotificationListener.AfterCommit(ISession session, string transactionName) { if (changesByTransaction.TryRemove(transactionName, out var transactionChangedEntities) &amp;&amp; !transactionChangedEntities.IsEmpty) while (transactionChangedEntities.TryTake(out var id)) entitiesToUpdate.Add(id); } void ITransactionNotificationListener.AfterRollback(ISession session, string transactionName) { changesByTransaction.TryRemove(transactionName, out _); } }</span></span></code> </pre> <br><pre> <code class="cs hljs"> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">IdBasedCacheWriteLockScope</span></span>&lt;<span class="hljs-title"><span class="hljs-title">TBase</span></span>, <span class="hljs-title"><span class="hljs-title">TCachedBo</span></span>&gt; : <span class="hljs-title"><span class="hljs-title">CacheWriteLockScope</span></span>&lt;<span class="hljs-title"><span class="hljs-title">TBase</span></span>, <span class="hljs-title"><span class="hljs-title">TCachedBo</span></span>&gt; <span class="hljs-title"><span class="hljs-title">where</span></span> <span class="hljs-title"><span class="hljs-title">TBase</span></span> : <span class="hljs-title"><span class="hljs-title">class</span></span>, <span class="hljs-title"><span class="hljs-title">IEntity</span></span> <span class="hljs-title"><span class="hljs-title">where</span></span> <span class="hljs-title"><span class="hljs-title">TCachedBo</span></span> : <span class="hljs-title"><span class="hljs-title">class</span></span>, <span class="hljs-title"><span class="hljs-title">IIdEntity</span></span>&lt;<span class="hljs-title"><span class="hljs-title">Guid</span></span>&gt; { [NotNull] <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> ICollection&lt;Guid&gt; changedEntitiesIds; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span>? UpdateRequired =&gt; changedEntitiesIds.Any(); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">IdBasedCacheWriteLockScope</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">[NotNull] ReaderWriterLockSlim lockObj, [NotNull] Func&lt;ICollection&lt;Guid&gt;&gt; changedEntitiesIdsProvider</span></span></span><span class="hljs-function">) : </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">base</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">lockObj</span></span></span><span class="hljs-function">)</span></span> { changedEntitiesIds = changedEntitiesIdsProvider() ?? <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> InvalidOperationException(<span class="hljs-keyword"><span class="hljs-keyword">nameof</span></span>(changedEntitiesIdsProvider)); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> IDictionary&lt;Guid, TCachedBo&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetUpdatedEntities</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">IReadonlyRepository&lt;TBase&gt; repository, ISession session</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> entities = repository.GetByIds(session, changedEntitiesIds, <span class="hljs-literal"><span class="hljs-literal">true</span></span>).ToDictionary(e =&gt; e.Id, be =&gt; be <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> TCachedBo); <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> id <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> changedEntitiesIds.Where(i =&gt; !entities.ContainsKey(i))) entities.Add(id, <span class="hljs-literal"><span class="hljs-literal">null</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> entities; } }</code> </pre> <br></div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Interessante Pfosten, die während der Entwicklung und Erweiterung der Schlacht aufgedeckt wurden: </font></font><br><br><ul><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Es ist nur so, dass Sie verwandte Entitäten mit direkten Verknüpfungen nicht abrufen und zwischenspeichern können. </font><font style="vertical-align: inherit;">Andernfalls verbleibt die veraltete Kopie in den Objekten, die darauf verweisen, wenn wir eine der Entitäten ändern. </font><font style="vertical-align: inherit;">Anstatt eine knifflige Logik für die Ungültigmachung solcher Verbindungen zu erstellen, haben wir uns einfach beim Zugriff über die Eigenschaft entschieden, immer die neuesten Informationen aus dem Cache abzurufen</font></font></li><li>   ,              ,         (       ,   ,            , ).     ,              </li><li>     «»   (         )   ,         ,          </li></ul></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de453382/">https://habr.com/ru/post/de453382/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de453368/index.html">Datenwiederherstellung aus XtraDB-Tabellen ohne Strukturdatei mithilfe der Byteanalyse der ibd-Datei</a></li>
<li><a href="../de453370/index.html">Konfrontation 2019: Das Jet Security Team belegte den ersten Platz in der Verteidigung</a></li>
<li><a href="../de453374/index.html">Top 10 Chat-, Audio- und Videoanruf-API- und SDK-Anbieter für Unternehmen</a></li>
<li><a href="../de453376/index.html">Wie können Sie Ihre Zeit und Ihre SSD-Ressourcen vergeblich verschwenden? Leicht und einfach</a></li>
<li><a href="../de453380/index.html">Weltkrieg mit Privatwagen: MaaS geht um den Planeten</a></li>
<li><a href="../de453384/index.html">Sicherheitskrippen: REST</a></li>
<li><a href="../de453388/index.html">So erhalten Sie OFFZONE 2019 und ein Angebot an einem Tag</a></li>
<li><a href="../de453390/index.html">Über Äxte und Kohl</a></li>
<li><a href="../de453392/index.html">Nachrichten der Woche: US-Krieg mit Huawei, Start von Internet-Satelliten in die Umlaufbahn, russisches Elektroauto</a></li>
<li><a href="../de453394/index.html">Sternenkarte oder wie man Wissen in einem Team unter dem Einfluss von Soft Skills ausbalanciert</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>