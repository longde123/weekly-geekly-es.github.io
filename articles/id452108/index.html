<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ğŸ™‡ğŸ¾ ğŸ¤ ğŸ‘©ğŸ½â€âœˆï¸ Docker: saran tidak berbahaya ğŸ†š ğŸ‘‘ ğŸ†–</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Dalam komentar di artikel Docker saya : saran buruk , ada banyak permintaan untuk menjelaskan mengapa Dockerfile yang dijelaskan di dalamnya sangat me...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Docker: saran tidak berbahaya</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/southbridge/blog/452108/"><p>  Dalam komentar di artikel <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Docker</a> saya <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">: saran buruk</a> , ada banyak permintaan untuk menjelaskan mengapa Dockerfile yang dijelaskan di dalamnya sangat mengerikan. </p><br><p>  <em>Ringkasan dari seri sebelumnya</em> : dua pengembang dalam tenggat waktu yang sulit membuat Dockerfile.  Dalam prosesnya, Ops Igor Ivanovich mendatangi mereka.  Dockerfile yang dihasilkan sangat buruk sehingga AI berada di ambang serangan jantung. </p><br><p><img src="https://habrastorage.org/webt/nl/uj/xm/nlujxmo7chgsgo7dti72jckbk04.jpeg"></p><br><p>  Sekarang mari kita cari tahu apa yang salah dengan Dockerfile ini. </p><br><p>  Jadi, satu minggu telah berlalu. </p><a name="habracut"></a><br><p>  Dev Petya bertemu di ruang makan dengan secangkir kopi dengan Ops Igor Ivanovich. </p><br><p>  P: Igor Ivanovich, apakah Anda sangat sibuk?  Saya ingin mencari tahu di mana kami mengacau. </p><br><p>  AI: Ini bagus, Anda tidak sering bertemu pengembang yang tertarik dengan operasi. <br>  Untuk memulai, mari kita sepakati beberapa hal: </p><br><ol><li>  Ideologi buruh pelabuhan: satu wadah - satu proses. </li><li>  Semakin kecil wadahnya, semakin baik. </li><li>  Semakin banyak cache yang diambil, semakin baik. </li></ol><br><p>  P: Dan mengapa harus ada satu proses dalam satu wadah? </p><br><p>  AI: Docker, ketika wadah mulai, memonitor status proses dengan pid 1. Jika proses mati, Docker mencoba untuk memulai kembali wadah.  Misalkan Anda memiliki beberapa aplikasi yang berjalan di wadah Anda atau aplikasi utama tidak diluncurkan dengan pid 1. Jika prosesnya mati, Docker tidak akan mengetahuinya. </p><br><p>  Jika tidak ada pertanyaan lagi, perlihatkan Dockerfile Anda. </p><br><p>  Dan Petya menunjukkan: </p><br><pre><code class="plaintext hljs">FROM ubuntu:latest #    COPY ./ /app WORKDIR /app #    RUN apt-get update #   RUN apt-get upgrade #    RUN apt-get -y install libpq-dev imagemagick gsfonts ruby-full ssh supervisor #  bundler RUN gem install bundler #  nodejs     RUN curl -sL https://deb.nodesource.com/setup_9.x | sudo bash - RUN apt-get install -y nodejs #   RUN bundle install --without development test --path vendor/bundle #     RUN rm -rf /usr/local/bundle/cache/*.gem RUN apt-get clean RUN rm -rf /var/lib/apt/lists/* /tmp/* /var/tmp/* RUN rake assets:precompile #  ,   ,    . CMD ["/app/init.sh"]</code> </pre> <br><p>  AI: Oh, mari kita bereskan.  Mari kita mulai dengan baris pertama: </p><br><pre> <code class="plaintext hljs">FROM ubuntu:latest</code> </pre> <br><p>  Anda mengambil tag <code>latest</code> .  Menggunakan tag <code>latest</code> menyebabkan konsekuensi yang tidak terduga.  Bayangkan bahwa pengelola gambar sedang membangun versi baru dari gambar dengan daftar perangkat lunak yang berbeda, gambar ini mendapatkan tag terbaru.  Dan yang terbaik, wadah Anda berhenti mengumpulkan, dan paling buruk, Anda menangkap serangga yang tidak ada sebelumnya. </p><br><p>  Anda mengambil gambar dengan OS penuh dengan banyak perangkat lunak yang tidak perlu, yang mengembang wadah.  Dan semakin banyak perangkat lunak, semakin banyak lubang dan kerentanan. </p><br><p>  Selain itu, semakin besar gambar, semakin banyak ruang yang digunakan pada host dan dalam registri (apakah Anda menyimpan gambar di suatu tempat)? </p><br><p>  P: Ya, tentu saja, kami memiliki registri, dan Anda mengaturnya. </p><br><p>  II: Jadi, apa yang saya bicarakan? .. Oh ya, volume ... Beban jaringan juga bertambah.  Untuk satu gambar, ini tidak terlihat, tetapi ketika ada perakitan terus menerus, tes dan penyebaran, itu bisa diraba.  Dan jika Anda tidak memiliki mode Tuhan di AWS, Anda juga akan menerima akun luar angkasa. </p><br><p>  Karena itu, Anda perlu memilih gambar yang paling cocok, dengan versi yang tepat dan perangkat lunak minimum.  Sebagai contoh, ambil: <code>FROM ruby:2.5.5-stretch</code> </p><br><p>  P: Oh, begitu.  Dan bagaimana dan di mana melihat gambar yang tersedia?  Bagaimana cara memahami yang mana yang saya butuhkan? </p><br><p>  AI: Biasanya, gambar diambil dari <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">dockhub</a> , jangan bingung dengan pornhub :).  Biasanya ada beberapa rakitan untuk gambar: <br>  <strong>Alpine</strong> : Gambar dikompilasi pada gambar Linux minimalis, hanya 5 MB.  Kekurangannya: ia dibangun dengan implementasi libc sendiri, paket standar di dalamnya tidak berfungsi.  Mencari dan menginstal paket yang tepat akan membutuhkan banyak waktu. <br>  <strong>Scratch</strong> : gambar dasar, tidak digunakan untuk membangun gambar lain.  Ini dimaksudkan hanya untuk menjalankan data biner yang disiapkan.  Ideal untuk menjalankan aplikasi biner, yang mencakup semua yang Anda butuhkan, seperti aplikasi-go. <br>  Berdasarkan OS apa pun seperti Ubuntu atau Debian.  Nah, di sini, saya pikir, tidak perlu dijelaskan. </p><br><p>  II: Sekarang kita harus menambahkan semuanya.  Paket dan bersihkan cache.  Dan segera Anda dapat <em>melakukan upgrade apt-get</em> .  Jika tidak, dengan setiap perakitan, meskipun tag tetap dari gambar dasar, gambar yang berbeda akan diperoleh.  Memperbarui paket dalam suatu gambar adalah tugas pengelola, disertai dengan perubahan tag. </p><br><p>  P: Ya, saya mencoba melakukannya, ternyata seperti ini: </p><br><pre> <code class="plaintext hljs">WORKDIR /app COPY ./ /app RUN curl -sL https://deb.nodesource.com/setup_9.x | bash - \ &amp;&amp; apt-get -y install libpq-dev imagemagick gsfonts ruby-full ssh supervisor nodejs \ &amp;&amp; gem install bundler \ &amp;&amp; bundle install --without development test --path vendor/bundle RUN rm -rf /usr/local/bundle/cache/*.gem \ &amp;&amp; apt-get clean \ &amp;&amp; rm -rf /var/lib/apt/lists/* /tmp/* /var/tmp/*</code> </pre> <br><p>  II: Tidak buruk, tetapi ada juga sesuatu untuk dikerjakan.  Lihat, ini perintahnya: </p><br><pre> <code class="plaintext hljs">RUN rm -rf /usr/local/bundle/cache/*.gem \ &amp;&amp; apt-get clean \ &amp;&amp; rm -rf /var/lib/apt/lists/* /tmp/* /var/tmp/*</code> </pre> <br><p>  ... tidak menghapus data dari gambar akhir, tetapi hanya membuat lapisan tambahan tanpa data ini.  Benar sekali: </p><br><pre> <code class="plaintext hljs">RUN curl -sL https://deb.nodesource.com/setup_9.x | bash - \ &amp;&amp; apt-get -y install libpq-dev imagemagick gsfonts nodejs \ &amp;&amp; gem install bundler \ &amp;&amp; bundle install --without development test --path vendor/bundle \ &amp;&amp; rm -rf /usr/local/bundle/cache/*.gem \ &amp;&amp; apt-get clean \ &amp;&amp; rm -rf /var/lib/apt/lists/* /tmp/* /var/tmp/*</code> </pre> <br><p>  Tapi itu belum semuanya.  Apa yang ada di sana, Ruby?  Maka tidak perlu menyalin seluruh proyek di awal.  Cukup salin Gemfile dan Gemfile.lock. </p><br><p>  Dengan pendekatan ini, instalasi bundel tidak akan dijalankan untuk setiap perubahan ke sumber, tetapi hanya jika Gemfile atau Gemfile.lock telah berubah. </p><br><p>  Metode yang sama berfungsi untuk bahasa lain dengan manajer dependensi, seperti npm, pip, komposer, dan lainnya berdasarkan file dengan daftar dependensi. </p><br><p>  Dan akhirnya, ingat, pada awalnya saya berbicara tentang ideologi Docker "satu wadah - satu proses"?  Ini berarti bahwa seorang supervisor tidak diperlukan.  Juga, jangan menginstal systemd, karena alasan yang sama.  Padahal, Docker sendiri adalah seorang supervisor.  Dan ketika Anda mencoba menjalankan beberapa proses di dalamnya, itu seperti meluncurkan beberapa aplikasi dalam satu proses penyelia. <br>  Saat merakit, Anda akan membuat satu gambar, dan kemudian menjalankan jumlah kontainer yang diinginkan sehingga setiap proses memiliki satu proses. </p><br><p>  Tetapi lebih lanjut tentang itu nanti. </p><br><p>  P: Sepertinya mengerti.  Lihat apa yang terjadi: </p><br><pre> <code class="plaintext hljs">FROM ruby:2.5.5-stretch WORKDIR /app COPY Gemfile* /app RUN curl -sL https://deb.nodesource.com/setup_9.x | bash - \ &amp;&amp; apt-get -y install libpq-dev imagemagick gsfonts nodejs \ &amp;&amp; gem install bundler \ &amp;&amp; bundle install --without development test --path vendor/bundle \ &amp;&amp; rm -rf /usr/local/bundle/cache/*.gem \ &amp;&amp; apt-get clean \ &amp;&amp; rm -rf /var/lib/apt/lists/* /tmp/* /var/tmp/* COPY . /app RUN rake assets:precompile CMD ["bundleâ€, â€œexecâ€, â€œpassengerâ€, â€œstart"]</code> </pre> <br><p>  Apakah daemon akan didefinisikan ulang ketika wadah dimulai? </p><br><p>  AI: Ya, benar.  Omong-omong, Anda dapat menggunakan CMD dan ENTRYPOINT.  Dan untuk memahami apa bedanya, ini adalah pekerjaan rumah Anda.  Ada <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">artikel</a> bagus tentang topik ini di HabrÃ©. </p><br><p>  Jadi ayo.  Anda mengunduh file untuk menginstal node, tetapi tidak ada jaminan bahwa itu akan memiliki apa yang Anda butuhkan.  Perlu menambahkan validasi.  Misalnya, seperti ini: </p><br><pre> <code class="plaintext hljs">RUN curl -sL https://deb.nodesource.com/setup_9.x &gt; setup_9.x \ &amp;&amp; echo "958c9a95c4974c918dca773edf6d18b1d1a41434 setup_9.x" | sha1sum -c - \ &amp;&amp; bash setup_9.x \ &amp;&amp; rm -rf setup_9.x \ &amp;&amp; apt-get -y install libpq-dev imagemagick gsfonts nodejs \ &amp;&amp; gem install bundler \ &amp;&amp; bundle install --without development test --path vendor/bundle \ &amp;&amp; rm -rf /usr/local/bundle/cache/*.gem \ &amp;&amp; apt-get clean \ &amp;&amp; rm -rf /var/lib/apt/lists/* /tmp/* /var/tmp/*</code> </pre> <br><p>  Dengan menggunakan checksum, Anda dapat memverifikasi bahwa Anda mengunduh file yang benar. </p><br><p>  P: Tetapi jika file berubah, maka perakitan tidak akan berfungsi. </p><br><p>  II: Ya, dan anehnya, ini juga merupakan nilai tambah.  Anda akan menemukan bahwa file telah berubah, dan Anda dapat melihat apa yang diubah di sana.  Anda tidak pernah tahu, mereka menambahkan, mengatakan, sebuah skrip yang menghapus semua yang dicapainya, atau melakukan backdoor. </p><br><p>  P: Terima kasih.  Ternyata Dockerfile terakhir akan terlihat seperti ini: </p><br><pre> <code class="plaintext hljs">FROM ruby:2.5.5-stretch WORKDIR /app COPY Gemfile* /app RUN curl -sL https://deb.nodesource.com/setup_9.x &gt; setup_9.x \ &amp;&amp; echo "958c9a95c4974c918dca773edf6d18b1d1a41434 setup_9.x" | sha1sum -c - \ &amp;&amp; bash setup_9.x \ &amp;&amp; rm -rf setup_9.x \ &amp;&amp; apt-get -y install libpq-dev imagemagick gsfonts nodejs \ &amp;&amp; gem install bundler \ &amp;&amp; bundle install --without development test --path vendor/bundle \ &amp;&amp; rm -rf /usr/local/bundle/cache/*.gem \ &amp;&amp; apt-get clean \ &amp;&amp; rm -rf /var/lib/apt/lists/* /tmp/* /var/tmp/* COPY . /app RUN rake assets:precompile CMD ["bundleâ€, â€œexecâ€, â€œpassengerâ€, â€œstart"]</code> </pre> <br><p>  P: Igor Ivanovich, terima kasih atas bantuannya.  Sudah waktunya bagi saya untuk berlari, saya perlu membuat 10 komitmen lebih untuk hari ini. </p><br><p>  Igor Ivanovich, menghentikan pandangan rekannya yang tergesa-gesa, menyesap kopi kental.  Setelah berpikir selama beberapa detik tentang 99,9% SLA dan kode tanpa bug, ia mengajukan pertanyaan. </p><br><p>  AI: Dan di mana Anda menyimpan log? </p><br><p>  P: Tentu saja, di production.log.  Ngomong-ngomong, ya, bagaimana kita bisa mengaksesnya tanpa ssh? </p><br><p>  II: Jika Anda membiarkannya dalam file, solusi telah ditemukan untuk Anda.  Perintah docker exec memungkinkan Anda untuk mengeksekusi perintah apa pun dalam sebuah wadah.  Misalnya, Anda dapat membuat cat untuk log.  Dan menggunakan <em>-it</em> switch dan menjalankan bash (jika dipasang di wadah), Anda akan mendapatkan akses interaktif ke wadah. </p><br><p>  Tetapi Anda tidak harus menyimpan log dalam file.  Minimal, ini mengarah pada pertumbuhan kontainer yang tidak terkendali, tetapi tidak ada yang memutar log.  Semua log harus dilemparkan ke stdout.  Di sana Anda sudah dapat melihat mereka menggunakan <em>perintah log buruh pelabuhan</em> . </p><br><p>  P: Igor Ivanovich, tetapi dapat menempatkan log ke direktori yang terpasang, pada simpul fisik, sebagai data pengguna? </p><br><p>  AI: Sangat baik bahwa Anda tidak lupa untuk menghapus data yang diunduh ke disk node.  Dengan log, ini juga mungkin, hanya ingat untuk mengatur rotasi. <br>  Yang bisa Anda jalankan. </p><br><p>  P: Igor Ivanovich, tetapi menyarankan apa yang harus dibaca? </p><br><p>  AI: Pertama, baca <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">rekomendasi dari pengembang Docker</a> , hampir tidak ada yang tahu Docker lebih baik dari mereka. </p><br><p>  Dan jika Anda ingin menjalani latihan, lakukan <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">secara intensif</a> .  Bagaimanapun, sebuah teori tanpa latihan sudah mati. </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/id452108/">https://habr.com/ru/post/id452108/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../id452092/index.html">Pembaruan Dalam Aplikasi: Mempercepat Pembaruan Aplikasi Android</a></li>
<li><a href="../id452094/index.html">.NET: Alat untuk bekerja dengan multithreading dan asynchrony. Bagian 1</a></li>
<li><a href="../id452098/index.html">Log Habr pengembang front-end: refactor dan reflex</a></li>
<li><a href="../id452102/index.html">Permainan foto untuk mereka yang menyukai drone: secara singkat tentang AirSelfie 2</a></li>
<li><a href="../id452106/index.html">Kami mengundang pembicara ke pertemuan DIY musim panas pada 16 Juni 2019</a></li>
<li><a href="../id452110/index.html">Mengotomatiskan penggantian disk dengan Ansible</a></li>
<li><a href="../id452112/index.html">CRM ++</a></li>
<li><a href="../id452114/index.html">HolyJS 2019: Pembekalan dari SEMrush (Bagian 1)</a></li>
<li><a href="../id452116/index.html">Indeks dalam PostgreSQL - 8 (RUM)</a></li>
<li><a href="../id452118/index.html">Ilmuwan memecahkan kode naskah misterius Voynich</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>