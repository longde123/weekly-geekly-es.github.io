<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë¢ üë¥üèΩ üë©üèº‚Äçüé§ Servidor Commento nativo com Docker Compose üëç üôÜüèæ üåÆ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Nota: esta √© uma tradu√ß√£o da minha postagem (em ingl√™s), descrevendo a implementa√ß√£o do servidor de coment√°rios usado no mesmo site em que o original ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Servidor Commento nativo com Docker Compose</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/464105/"><p>  <em>Nota: esta √© uma tradu√ß√£o da <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">minha postagem</a> (em ingl√™s), descrevendo a implementa√ß√£o do servidor de coment√°rios usado no mesmo site em que o original est√° localizado.</em> </p><br><blockquote>  Vers√£o TL; DR: Desenvolvi a configura√ß√£o do servidor Commento, que √© f√°cil e simplesmente implementada no modo semiautom√°tico.  Copie <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">este reposit√≥rio</a> para voc√™ do GitHub e siga as instru√ß√µes no <a href="">README</a> . </blockquote><p>  H√° algum tempo, eu queria irresistivelmente mudar o Disqus - que √© talvez o sistema mais comum para adicionar coment√°rios √†s p√°ginas - para um <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Commento</a> gratuito e aberto. </p><br><h2 id="pochemu-imenno-commento">  Por que Commento? </h2><br><p> O problema com o Disqus, como muitos outros produtos "gratuitos", √© que, nesse caso, o produto √© o usu√°rio - ou seja, voc√™.  Al√©m disso, o Disqus ‚Äúenriquece‚Äù todas as p√°ginas em que √© usado com megabytes de scripts e mais de <em>cem</em> solicita√ß√µes HTTP adicionais. </p><br><p>  Al√©m disso, sua vers√£o gratuita mostra an√∫ncios dos quais voc√™ pode pagar "apenas" por US $ 9 por m√™s (plano Plus).  Isso por si s√≥ √© suficiente para querer encontrar algo melhor. </p><br><p>  Em algum momento, me deparei com <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">este post</a> e descobri a exist√™ncia de um servidor de coment√°rios gratuito chamado <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Commento</a> .  Por uma coincid√™ncia de sorte, o Commento recentemente se tornou completamente aberto - antes de estar dispon√≠vel em duas vers√µes, <em>Comunidade</em> gratuita e <em>Empresa</em> comercial.  Gra√ßas ao seu desenvolvedor Adhityaa Chandrasekar. </p><a name="habracut"></a><br><p>  O Commento tem <em>ordens de magnitude</em> mais eficientes que o Disqus, o tamanho t√≠pico da carga adicional √© de cerca de <strong>11 KB</strong> , al√©m dos pr√≥prios coment√°rios, √© claro.  Aproximadamente a mesma situa√ß√£o com as solicita√ß√µes HTTP necess√°rias. </p><br><p>  Outra vantagem do servidor Commento √© que ele √© muito r√°pido, como est√° escrito em Go. </p><br><p>  Bem, como uma cereja no bolo, ele tem uma importa√ß√£o de coment√°rios do Disqus, com o que mais ele poderia sonhar? </p><br><h2 id="varianty-ispolzovaniya-commento">  Casos de uso para o Commento </h2><br><p>  Para usu√°rios n√£o avan√ßados (tecnicamente), o Commento possui um servi√ßo de nuvem pronto para uso no <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">commento.io</a> .  O autor oferece a voc√™ a escolha da taxa mensal, mas ela n√£o pode ser inferior a US $ 3 "por raz√µes t√©cnicas". </p><br><p>  O Sr. Chandrasekar tamb√©m oferece generosamente uma conta gratuita no Commento.io em troca de "patches n√£o triviais" para o produto. </p><br><p>  Bem, eu escolhi a terceira op√ß√£o: aumentar o servidor Commento.  Nesse caso, voc√™ n√£o depende de ningu√©m (al√©m do hoster, √© claro), e eu amo a independ√™ncia. </p><br><h2 id="trudnosti">  Dificuldades </h2><br><p>  Sou um grande f√£ dos cont√™ineres do Docker e tamb√©m uso frequentemente o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Docker Compose</a> , uma ferramenta para gerenciar grupos de v√°rios cont√™ineres relacionados.  O Commento possui uma imagem do Docker pronta para uso no registro de cont√™iner do GitLab. </p><br><p>  Portanto, a decis√£o de usar cont√™ineres amadureceu por si s√≥ - mas primeiro algumas coisas tiveram que ser decididas. </p><br><h3 id="trudnost-1-postgresql">  Dificuldade N¬∫ 1: PostgreSQL </h3><br><p>  O Commento requer uma vers√£o bastante recente do servidor PostgreSQL, infelizmente nenhum outro servidor SQL √© suportado. </p><br><p>  Bem, ainda executamos tudo em cont√™ineres, ent√£o √© bem simples. </p><br><h3 id="trudnost-2-net-podderzhki-https">  Dificuldade # 2: N√£o h√° suporte para HTTPS </h3><br><p>  O Commento em si √© um servidor da Web, mas suporta apenas o protocolo HTTP inseguro. </p><br><p>  Deve-se notar que essa pr√°tica √© bastante comum atualmente: nesse caso, o servidor est√° oculto atr√°s do <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">proxy reverso</a> , que tamb√©m executa a descarga de SSL.  O fato √© que o suporte a SSL / HTTPS √© absolutamente obrigat√≥rio nesse caso, afinal de contas, no p√°tio de 2019 e procurar tentativas de autorizar um usu√°rio usando um protocolo de Internet inseguro ser√° muito distorcido. </p><br><p>  Decidi usar o servidor <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Nginx</a> ; primeiro, tive uma experi√™ncia consider√°vel trabalhando com ele; segundo, √© muito r√°pido, econ√¥mico e est√°vel.  E publica as vers√µes oficiais das <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">imagens</a> do <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Docker</a> . </p><br><p>  O segundo ingrediente na receita HTTPS √© o certificado SSL para o dom√≠nio.  Sou eternamente grato √† EFF e √† Mozilla por criar a <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Let's Encrypt</a> Certificate <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Authority</a> , que emite milh√µes de certificados gratuitos todos os meses. </p><br><p>  O Let's Encrypt tamb√©m fornece um utilit√°rio de linha de comando gratuito chamado <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">certbot</a> , que simplifica bastante o processo de obten√ß√£o e atualiza√ß√£o de um certificado.  Bem, e - √© claro - uma imagem do Docker para ele! </p><br><h3 id="trudnost-3-problema-kuricy-yayca-certbot">  Dificuldade # 3: Problema do ovo de galinha Certbot </h3><br><p>  Mas esse truque √© mais complicado. </p><br><p>  Queremos nos referir ao certificado SSL na configura√ß√£o de nosso proxy reverso no Nginx, o que significa que, sem um certificado, ele simplesmente se recusa a iniciar.  Ao mesmo tempo, para <em>obter um</em> certificado SSL para um dom√≠nio, voc√™ precisa de um servidor HTTP que funcione, o Let's Encrypt ir√° provar sua propriedade desse dom√≠nio. </p><br><p>  Consegui resolver esse problema e, ao que me parece, com bastante eleg√¢ncia: </p><br><ol><li>  Primeiro, √© gerado um certificado inv√°lido e fict√≠cio, cujo √∫nico objetivo √© permitir que o Nginx inicie. </li><li>  Nginx e certbot recebem em conjunto um novo certificado agora v√°lido. </li><li>  Assim que o certificado √© recebido, o certbot entra em "modo de espera", acordando a cada 12 horas para verificar se precisa ser atualizado - de acordo com as recomenda√ß√µes do Let's Encrypt. </li><li>  Quando chegar o momento e o certificado for renovado, o certbot sinalizar√° ao Nginx para reiniciar. </li></ol><br><h3 id="trudnost-4-chto-to-dolzhno-sohranyatsya">  Dificuldade n¬∫ 4: algo deve ser preservado </h3><br><p>  Suspeito fortemente que voc√™ deseja que os coment√°rios do usu√°rio sejam salvos ap√≥s uma reinicializa√ß√£o ou atualiza√ß√£o do sistema. </p><br><p>  Al√©m disso, para que o Let's Encrypt n√£o o bane devido a solicita√ß√µes muito frequentes, seria bom manter os certificados recebidos por toda a data de validade. </p><br><p> Ambos os pontos foram resolvidos na configura√ß√£o proposta usando os volumes do Docker, criados automaticamente pelo <em>systemd</em> quando o Commento foi lan√ßado.  Como os volumes s√£o marcados como "externos", o Docker os ignora ao remover cont√™ineres usando <code>docker-compose down -v</code> . </p><br><h2 id="svodim-vsyo-voedino">  Junte tudo </h2><br><p>  Agora voc√™ pode ver como tudo funciona juntos. </p><br><p>  A figura abaixo mostra a intera√ß√£o e o tr√°fego entre os quatro cont√™ineres: </p><br><p><img src="https://habrastorage.org/webt/zl/kr/y3/zlkry3l9lxx8mfwzzlsnuvubi6a.png"></p><br><p>  Eu apliquei a op√ß√£o <code>depends_on</code> Docker Compose <code>depends_on</code> para garantir que os cont√™ineres iniciem na ordem correta. </p><br><p>  Se voc√™ deseja iniciar apenas seu pr√≥prio servidor Commento, pode pular o restante do artigo e ir diretamente para o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">c√≥digo no GitHub</a> . </p><br><p>  Bem, falarei mais sobre essa implementa√ß√£o em mais detalhes posteriormente. </p><br><h2 id="kak-eto-vsyo-rabotaet">  Como tudo isso funciona </h2><br><h3 id="fayl-compose">  Redigir arquivo </h3><br><p>  Como voc√™ pode ver na figura acima, minha ‚Äúcomposi√ß√£o‚Äù consiste em quatro servi√ßos: </p><br><ol><li>  <code>certbot</code> - utilit√°rio <code>certbot</code> da EFF </li><li>  <code>nginx</code> - proxy reverso implementando descarregamento de SSL </li><li>  <code>app</code> - servidor Commento </li><li>  <code>postgres</code> - banco de dados PostgreSQL </li></ol><br><p>  O <a href=""><code>docker-compose.yml</code></a> cont√©m declara√ß√µes de sua pr√≥pria rede Docker, chamada <code>commento_network</code> , e tr√™s volumes, dos quais dois s√£o externos (ou seja, devem ser criados fora do Compose): </p><br><ul><li>  <code>commento_postgres_volume</code> armazena dados do servidor PostgreSQL para o Commento: usu√°rios, moderadores, coment√°rios, etc. </li><li>  <code>certbot_etc_volume</code> cont√©m certificados recebidos pelo <code>certbot</code> . </li></ul><br><h3 id="nginx">  Nginx </h3><br><p>  O cont√™iner Nginx √© baseado em uma imagem oficial leve baseada no Alpine e usa o seguinte script para executar: </p><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/sh trap exit TERM # Wait for the certificate file to arrive wait_for_certs() { echo 'Waiting for config files from certbot...' i=0 while [[ ! -f /etc/letsencrypt/options-ssl-nginx.conf ]]; do sleep 0.5 [[ $((i++)) -gt 20 ]] &amp;&amp; echo 'No files after 10 seconds, aborting' &amp;&amp; exit 2 done } # Watches for a "reload flag" (planted by certbot container) file and reloads nginx config once it's there watch_restart_flag() { while :; do [[ -f /var/www/certbot/.nginx-reload ]] &amp;&amp; rm -f /var/www/certbot/.nginx-reload &amp;&amp; echo 'Reloading nginx' &amp;&amp; nginx -s reload sleep 10 done } # Wait for certbot wait_for_certs # Start "reload flag" watcher watch_restart_flag &amp; # Run nginx in the foreground echo 'Starting nginx' exec nginx -g 'daemon off;'</span></span></code> </pre> <br><ul><li>  Linha <strong>3</strong> ( <em>ARRGHHH, Habr n√£o suporta a exibi√ß√£o de n√∫meros de linha no c√≥digo - aprox. Transl.</em> ) Um manipulador de interrup√ß√£o √© registrado para que o Nginx e o processo de monitoramento em segundo plano concluam com √™xito o trabalho quando o cont√™iner para. </li><li>  A linha <strong>27</strong> chama a fun√ß√£o de espera, que interrompe o processo de inicializa√ß√£o do Nginx at√© que os arquivos de configura√ß√£o SSL criados pelo cont√™iner <code>certbot</code> .  Sem isso, o Nginx se recusaria a come√ßar. </li><li>  A linha <strong>30</strong> cria um processo em segundo plano que regularmente, a cada dez segundos, verifica a presen√ßa de um arquivo de sinalizador chamado <code>.nginx-reload</code> e, assim que √© detectado, instrui o Nginx a recarregar a configura√ß√£o.  Este arquivo tamb√©m cria o certbot quando o certificado √© atualizado. </li><li>  A linha <strong>34</strong> inicia o Nginx no modo normal.  Nesse caso, <code>exec</code> significa que o processo atual do shell √© <em>substitu√≠do pelo</em> processo Nginx. </li></ul><br><p>  Outro arquivo importante nesta imagem √© a configura√ß√£o do servidor virtual Commento, que for√ßa o Nginx a encaminhar solicita√ß√µes HTTPS para o cont√™iner do <code>commento</code> : </p><br><pre> <code class="nginx hljs"><span class="hljs-section"><span class="hljs-section">server</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">listen</span></span> [::]:<span class="hljs-number"><span class="hljs-number">443</span></span> ssl ipv6only=<span class="hljs-literal"><span class="hljs-literal">on</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">listen</span></span> <span class="hljs-number"><span class="hljs-number">443</span></span> ssl; <span class="hljs-attribute"><span class="hljs-attribute">server_tokens</span></span> <span class="hljs-literal"><span class="hljs-literal">off</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">root</span></span> /var/www/html; <span class="hljs-attribute"><span class="hljs-attribute">index</span></span> index.html index.htm index.nginx-debian.html; <span class="hljs-attribute"><span class="hljs-attribute">server_name</span></span> __DOMAIN__; <span class="hljs-attribute"><span class="hljs-attribute">location</span></span> / { <span class="hljs-attribute"><span class="hljs-attribute">proxy_pass</span></span> http://app:8080/; <span class="hljs-attribute"><span class="hljs-attribute">proxy_set_header</span></span> Host <span class="hljs-variable"><span class="hljs-variable">$http_host</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">proxy_set_header</span></span> X-Real-IP <span class="hljs-variable"><span class="hljs-variable">$remote_addr</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">proxy_set_header</span></span> X-Forwarded-For <span class="hljs-variable"><span class="hljs-variable">$proxy_add_x_forwarded_for</span></span>; } <span class="hljs-attribute"><span class="hljs-attribute">ssl_certificate</span></span> /etc/letsencrypt/live/__DOMAIN__/fullchain.pem; <span class="hljs-attribute"><span class="hljs-attribute">ssl_certificate_key</span></span> /etc/letsencrypt/live/__DOMAIN__/privkey.pem; <span class="hljs-attribute"><span class="hljs-attribute">include</span></span> /etc/letsencrypt/options-ssl-nginx.conf; <span class="hljs-attribute"><span class="hljs-attribute">ssl_dhparam</span></span> /etc/letsencrypt/ssl-dhparams.pem; } <span class="hljs-section"><span class="hljs-section">server</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">listen</span></span> <span class="hljs-number"><span class="hljs-number">80</span></span> default_server; <span class="hljs-attribute"><span class="hljs-attribute">listen</span></span> [::]:<span class="hljs-number"><span class="hljs-number">80</span></span> default_server; <span class="hljs-attribute"><span class="hljs-attribute">server_tokens</span></span> <span class="hljs-literal"><span class="hljs-literal">off</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">server_name</span></span> __DOMAIN__; <span class="hljs-attribute"><span class="hljs-attribute">location</span></span> /.well-known/acme-challenge/ { <span class="hljs-attribute"><span class="hljs-attribute">root</span></span> /var/www/certbot; } <span class="hljs-comment"><span class="hljs-comment"># Redirect to HTTPS on port 80 location / { return 301 https://$host$request_uri; } }</span></span></code> </pre> <br><p>  O primeiro bloco do servidor (linhas <strong>1-21</strong> ) descreve como trabalhar com HTTPS e a regra de encaminhamento.  √â aqui que os arquivos do certificado Let's Encrypt s√£o mencionados (ou stubs usados). </p><br><p>  O dom√≠nio atendido pelo servidor √© passado como argumento ao criar a imagem;  ele substitui a linha <code>__DOMAIN__</code> na configura√ß√£o do servidor. </p><br><p>  O segundo bloco (linhas <strong>23-38</strong> ) √© a configura√ß√£o do servidor HTTP, que √© usada pelo certbot para confirmar a propriedade do dom√≠nio (o chamado "desafio da ACME").  Todos os outros pedidos causam um redirecionamento para o endere√ßo correspondente via HTTPS. </p><br><h3 id="certbot">  certbot </h3><br><p>  Nossa imagem certbot √© baseada na <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">compila√ß√£o oficial</a> com o seguinte script: </p><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/sh trap exit TERM # Wait until nginx is up and running, up to 10 seconds wait_for_nginx() { echo 'Waiting for nginx...' i=0 while ! nc -z nginx 80 &amp;&gt;/dev/null; do sleep 0.5 [[ $((i++)) -gt 20 ]] &amp;&amp; echo "nginx isn't online after 10 seconds, aborting" &amp;&amp; exit 4 done echo 'nginx is up and running' } # Check vars [[ -z "$DOMAIN" ]] &amp;&amp; echo "Environment variable 'DOMAIN' isn't defined" &amp;&amp; exit 2 [[ -z "$EMAIL" ]] &amp;&amp; echo "Environment variable 'EMAIL' isn't defined" &amp;&amp; exit 2 TEST="${TEST:-false}" # Check external mounts data_dir='/etc/letsencrypt' www_dir='/var/www/certbot' [[ ! -d "$data_dir" ]] &amp;&amp; echo "Directory $data_dir must be externally mounted" [[ ! -d "$www_dir" ]] &amp;&amp; echo "Directory $www_dir must be externally mounted" # If the config/certificates haven't been initialised yet if [[ ! -e "$data_dir/options-ssl-nginx.conf" ]]; then # Copy config over from the initial location echo 'Initialising nginx config' cp /conf/options-ssl-nginx.conf /conf/ssl-dhparams.pem "$data_dir/" # Copy dummy certificates mkdir -p "$data_dir/live/$DOMAIN" cp /conf/privkey.pem /conf/fullchain.pem "$data_dir/live/$DOMAIN/" # Wait for nginx wait_for_nginx # Remove dummy certificates rm -rf "$data_dir/live/$DOMAIN/" # Run certbot to validate/renew certificate test_arg= $TEST &amp;&amp; test_arg='--test-cert' certbot certonly --webroot -w /var/www/certbot -n -d "$DOMAIN" $test_arg -m "$EMAIL" --rsa-key-size 4096 --agree-tos --force-renewal # Reload nginx config touch /var/www/certbot/.nginx-reload # nginx config has been already initialised - just give nginx time to come up else wait_for_nginx fi # Run certbot in a loop for renewals while :; do certbot renew # Reload nginx config touch /var/www/certbot/.nginx-reload sleep 12h done</span></span></code> </pre> <br><p>  Um breve tour por suas linhas: </p><br><ul><li>  A linha <strong>3</strong> , como no script anterior, √© necess√°ria para a conclus√£o regular do cont√™iner. </li><li>  As linhas <strong>17-19</strong> verificam as vari√°veis ‚Äã‚Äãnecess√°rias. </li><li>  E nas linhas <strong>22-25</strong> - que os diret√≥rios necess√°rios para que o certbot funcione sejam montados corretamente. </li><li>  O garfo segue: <br><ul><li>  As linhas <strong>30-50</strong> s√£o executadas apenas no primeiro in√≠cio do cont√™iner: <br><ul><li>  Um certificado fict√≠cio √© copiado, permitindo que o Nginx inicie normalmente. </li><li>  Enquanto isso, o Nginx aguarda o final desse processo, ap√≥s o qual continua o download. </li><li>  Depois que o Nginx √© iniciado, o certbot inicia o processo de obten√ß√£o de um certificado v√°lido no Let's Encrypt. </li><li>  E, finalmente, assim que o certificado √© recebido, o arquivo <code>.nginx-reload</code> √© criado, sugerindo ao Nginx que √© hora de recarregar a configura√ß√£o. </li></ul></li><li>  A linha <strong>54</strong> aguarda o in√≠cio do Nginx - no caso em que um certificado completo j√° esteja dispon√≠vel. </li></ul></li><li>  Depois de tudo isso (linhas <strong>58-63</strong> ), ele continua o ciclo, uma vez a cada 12 horas, verificando a necessidade de renovar o certificado e sinalizando ao Nginx para reiniciar. </li></ul><br><h3 id="commento-i-postgresql">  Commento e PostgreSQL </h3><br><p>  Os cont√™ineres do <code>app</code> e do <code>postgres</code> usam as imagens originais fornecidas pelos desenvolvedores sem nenhuma altera√ß√£o. </p><br><h3 id="servis-systemd">  Servi√ßo Systemd </h3><br><p>  A √∫ltima parte deste quebra-cabe√ßa √© o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">arquivo da unidade systemd</a> <code>commento.service</code> , no qual voc√™ precisa criar um link simb√≥lico em <code>/etc/systemd/system/commento.service</code> para que ele inicie em um bom momento quando o sistema for iniciado: </p><br><pre> <code class="plaintext hljs">[Unit] Description=Commento server [Service] TimeoutStopSec=30 WorkingDirectory=/opt/commento ExecStartPre=-/usr/bin/docker volume create commento_postgres_volume ExecStartPre=-/usr/bin/docker volume create certbot_etc_volume ExecStartPre=-/usr/local/bin/docker-compose -p commento down -v ExecStart=/usr/local/bin/docker-compose -p commento up --abort-on-container-exit ExecStop=/usr/local/bin/docker-compose -p commento down -v [Install] WantedBy=multi-user.target</code> </pre> <br><p>  Linhas: </p><br><ul><li>  A linha <strong>6</strong> implica que o c√≥digo do projeto √© clonado no diret√≥rio <code>/opt/commento</code> - isso √© muito mais simples. </li><li>  As linhas <strong>7-8</strong> criam volumes externos, se ainda n√£o estiverem. </li><li>  Na linha <strong>9</strong> , os poss√≠veis restos dos cont√™ineres anteriores s√£o exclu√≠dos.  Os volumes externos s√£o preservados. </li><li>  A linha <strong>10</strong> marca o lan√ßamento real do Docker Compose.  O <code>--abort-on-container-exit</code> todo o bando de cont√™ineres quando algum deles √© <code>--abort-on-container-exit</code> .  Gra√ßas a isso, o systemd estar√° ciente de que o servi√ßo est√° parado. </li><li>  A linha <strong>11</strong> est√° novamente limpando e excluindo cont√™ineres, redes e volumes. </li></ul><br><h2 id="ishodnyy-kod">  C√≥digo fonte </h2><br><p>  Uma implementa√ß√£o totalmente funcional, exigindo apenas a configura√ß√£o de vari√°veis ‚Äã‚Äãno <code>docker-compose.yml</code> , est√° dispon√≠vel <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">no GitHub</a> .  Voc√™ s√≥ precisa seguir cuidadosamente as etapas descritas em <a href="">README</a> . </p><br><p>  O c√≥digo est√° sujeito √† <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">licen√ßa MIT</a> . </p><br><p>  Obrigado por ler neste lugar, os coment√°rios s√£o freneticamente bem-vindos! </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt464105/">https://habr.com/ru/post/pt464105/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt464093/index.html">Bens digitais: o que fazer se um cliente vier buscar uma compra em um ano?</a></li>
<li><a href="../pt464095/index.html">Getters e Setters em Dart and Flutter</a></li>
<li><a href="../pt464097/index.html">A evolu√ß√£o da intelig√™ncia: por que os rob√¥s precisam de emo√ß√µes</a></li>
<li><a href="../pt464099/index.html">An√°lise da linguagem VKScript: JavaScript, e voc√™?</a></li>
<li><a href="../pt464103/index.html">Rascunho do padr√£o nacional de IoT do OpenUNB: revis√£o cr√≠tica</a></li>
<li><a href="../pt464107/index.html">Eventos digitais em Moscou, de 19 a 25 de agosto</a></li>
<li><a href="../pt464109/index.html">P√°ra-quedas supers√¥nicos do espa√ßo</a></li>
<li><a href="../pt464111/index.html">Natas Web. Passagem da plataforma CTF destinada a explorar vulnerabilidades da Web</a></li>
<li><a href="../pt464113/index.html">"CAD para todos, de gra√ßa, e n√£o deixe ningu√©m ir ..." ou os primeiros passos na programa√ß√£o do FreeCAD em Python</a></li>
<li><a href="../pt464115/index.html">Como fazer amigos para um designer, designer de layout e ‚ÄúFigma‚Äù usando um sistema de design, p√© de cabra e algum tipo de m√£e ‚Ñ¢</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>