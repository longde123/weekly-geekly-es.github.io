<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👨🏽‍🚀 😈 🎓 Dispositivo de visión nocturna basado en el módulo de imagen térmica Flir Lepton 3 👌🏿 💃🏼 👋</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Anteriormente, escribí un artículo sobre la conexión de un decodificador de imágenes térmicas a un teléfono inteligente Flir One Gen 2. Es hora de qui...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Dispositivo de visión nocturna basado en el módulo de imagen térmica Flir Lepton 3</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/413021/"> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Anteriormente,</a> escribí un artículo sobre la conexión de un decodificador de imágenes térmicas a un teléfono inteligente Flir One Gen 2. Es hora de quitar el módulo lepton de este decodificador y conectarlo directamente al microcontrolador ensamblando un dispositivo de visión nocturna con una resolución de 160x120 píxeles. <br><a name="habracut"></a><br>  Para construir su propio dispositivo de imagen térmica de visión nocturna, necesitará: <br><br>  1) Tablero con un microcontrolador.  Tomé una placa de un amigo chino con el microcontrolador STM32F407VGT6.  Un buen controlador: frecuencia de 168 MHz y 192 KB de RAM. <br><br><img src="https://habrastorage.org/webt/8c/dc/ku/8cdckuwklqzb6uau4hu303w7ly0.jpeg"><br><br>  2) Pantalla.  Tomé una pantalla con una resolución de 320x240.  Tales pantallas vienen con varios controladores.  Lo obtuve con el controlador hx8347d. <br><br><img src="https://habrastorage.org/webt/6a/6m/un/6a6mundpajyfht-oxvu96zucw_g.jpeg"><br><br>  3) Placa para conectar lepton 3 en SPI e I2C. <br><br><img src="https://habrastorage.org/webt/9w/l_/ba/9wl_baf3ewy_pcavn7pxgjwlfxo.jpeg"><br><br>  4) El leptón mismo 3. El elemento más difícil y costoso.  Para obtenerlo, compré una cámara termográfica defectuosa Flir One Gen 2 en eBay y le saqué un leptón.  Se ve en aumento así: <br><br><img src="https://habrastorage.org/webt/vk/z0/no/vkz0nogorpl_g0n9in9e3wacyw4.jpeg"><br><br>  Puede excluir el elemento 3 de esta lista, a menos que, por supuesto, se las arregle para tomar una cuna para un leptón de una cámara termográfica que funciona mal y puede soldarlo (y sus contactos, por cierto, serán desde la parte inferior).  Desafortunadamente, la distancia entre las piernas en el lepton es bastante pequeña, por lo que esta opción no me fue presentada. <br><br>  Para recopilar todo esto, solo necesita soldarlo de la siguiente manera: <br><br><img src="https://habrastorage.org/webt/7u/ev/sl/7uevslpasq6o-qw5hazjqqe79_4.jpeg"><br><br>  También necesita conectar la alimentación.  Para alimentar la placa lepton, uso 5 V, para la placa STM32 3.3 V. Para obtener 5 V de la batería, uso el convertidor TEL3-0511 (voltaje de entrada de 4.5 a 9 V), y bajo estos 5 V en un LP2950CZ-3.3 regular (por cierto , se calienta hasta 70 grados. Aquí, también, debe usar un convertidor CC / CC, pero todavía no lo he comprado).  Lepton 3 come, por cierto, bien.  Cuando se alimenta desde 6 V, el consumo de corriente de todo el dispositivo es de aproximadamente 250 mA.  Cuando el lepton quiere hacer clic en el obturador para la calibración, la corriente aumenta a 500 mA. <br><br>  Todo junto se ve así: <br><br><img src="https://habrastorage.org/webt/l_/5u/6u/l_5u6uvczvxtcllw78yr8ggdgxg.jpeg"><br><br><img src="https://habrastorage.org/webt/sd/b4/ao/sdb4aok26v1_ty26lq52t5eaazq.jpeg"><br><br>  Para trabajar con un lepton, necesitas un programa.  Utilicé CubeMX y Keil 5. En este caso, todos los enlaces de software se simplifican a la imposibilidad. <br><br>  La comunicación con un lepton se lleva a cabo en SPI.  No he usado I2C, ya que no era particularmente necesario.  Según I2C, puede controlar el estado del leptón, sus modos de funcionamiento, habilitar / deshabilitar el modo de calibración automática, etc.  Pero para un dispositivo de visión nocturna, esto no es particularmente necesario. <br><br>  Para descifrar los datos, escribí un módulo: <br><br><div class="spoiler">  <b class="spoiler_title">Modulo</b> <div class="spoiler_text">  <b>leptoncontrol.h</b> <br><pre><code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">ifndef</span></span></span><span class="hljs-meta"> LEPTON_CONTROL_H #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> LEPTON_CONTROL_H #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;stdbool.h&gt; #include &lt;stdio.h&gt; //   ( ) #define LEPTON_ORIGINAL_IMAGE_WIDTH 160 #define LEPTON_ORIGINAL_IMAGE_HEIGHT 120 //  VoSPI #define VOSPI_FRAME_HEIGHT 60 //  VoSPI #define VOSPI_FRAME_WIDTH 80 //  VoSPI   (164  RAW14  244  RGB) #define VOSPI_PACKAGE_SIZE 164 //   VoSPI   #define VOSPI_PACKAGE_LINE_SIZE 160 //  VOSPI   #define VOSPI_SEGMENT_LINE_AMOUNT 60 void LEPTONCONTROL_Init(void);// void LEPTONCONTROL_CalculateCRC(unsigned short *crc,unsigned char byte);// crc bool LEPTONCONTROL_PushVoSPI(unsigned char data[VOSPI_PACKAGE_SIZE],bool *first_line);//    VoSPI    unsigned short *LEPTONCONTROL_GetRAW14Ptr(void);//      #endif</span></span></span></span></code> </pre> <br>  <b>leptoncontrol.c</b> <br><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"leptoncontrol.h"</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"stm32f4xx_hal.h"</span></span></span><span class="hljs-meta"> static unsigned short RAW14Image[LEPTON_ORIGINAL_IMAGE_HEIGHT*LEPTON_ORIGINAL_IMAGE_WIDTH];</span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">//  static unsigned short CRCTable[256];//   CRC16 //     #define RESYNC_TIMEOUT_MS 19 //:   #define NO_SEGMENT -1 //:   #define ERROR_PACKAGE -2 //---------------------------------------------------------------------------------------------------- // //---------------------------------------------------------------------------------------------------- void LEPTONCONTROL_Init(void) { //    CRC unsigned short code; for(long n=0;n&lt;256;n++) { code=((unsigned short)n)&lt;&lt;8; for(unsigned char m=0;m&lt;8;m++) { if(code&amp;(1&lt;&lt;15)) code=(code&lt;&lt;1)^0x1021; else code=code&lt;&lt;1; } CRCTable[n]=code; } } //---------------------------------------------------------------------------------------------------- // crc //---------------------------------------------------------------------------------------------------- void LEPTONCONTROL_CalculateCRC(unsigned short *crc,unsigned char byte) { *crc=CRCTable[(((*crc)&gt;&gt;8)^byte++)&amp;0xFF]^((*crc)&lt;&lt;8); } //---------------------------------------------------------------------------------------------------- //---------------------------------------------------------------------------------------------------- long LEPTONCONTROL_ReadSegment(unsigned short *raw14_ptr,unsigned char data[VOSPI_PACKAGE_SIZE],bool *first_line) { static long current_package=-1; static long segment=-1; long n; *first_line=false; if ((data[0]&amp;0x0F)==0x0F) return(NO_SEGMENT);//  unsigned short crc=data[2]; crc&lt;&lt;=8; crc|=data[3]; // CRC unsigned short crc16=0; LEPTONCONTROL_CalculateCRC(&amp;crc16,data[0]&amp;0x0F); LEPTONCONTROL_CalculateCRC(&amp;crc16,data[1]); LEPTONCONTROL_CalculateCRC(&amp;crc16,0); LEPTONCONTROL_CalculateCRC(&amp;crc16,0); for(n=4;n&lt;VOSPI_PACKAGE_SIZE;n++) LEPTONCONTROL_CalculateCRC(&amp;crc16,data[n]); if (crc16!=crc) return(ERROR_PACKAGE);// CRC //   unsigned short package=data[0]&amp;0x0F; package&lt;&lt;=8; package|=data[1]; if (package==0) { *first_line=true; current_package=0; } if (package==20) { unsigned char ttt=(data[0]&amp;0x70)&gt;&gt;4;//     20  segment=ttt; } if (current_package&lt;0) return(NO_SEGMENT); if (current_package!=package) { current_package=-1; return(ERROR_PACKAGE); } unsigned short *raw_ptr=raw14_ptr+current_package*VOSPI_PACKAGE_LINE_SIZE/2; for(n=0;n&lt;VOSPI_PACKAGE_LINE_SIZE/2;n++,raw_ptr++) { //    big-endian: ,  unsigned short value=data[n*sizeof(short)+4]; value&lt;&lt;=8; value|=data[n*sizeof(short)+5]; *raw_ptr=value; } current_package++; if (current_package!=VOSPI_FRAME_HEIGHT) return(NO_SEGMENT); current_package=-1; return(segment); } //---------------------------------------------------------------------------------------------------- //    VoSPI    //---------------------------------------------------------------------------------------------------- bool LEPTONCONTROL_PushVoSPI(unsigned char data[VOSPI_PACKAGE_SIZE],bool *first_line) { *first_line=false; static long waitable_segment=1; long segment=LEPTONCONTROL_ReadSegment(RAW14Image+(waitable_segment-1)*VOSPI_FRAME_WIDTH*VOSPI_SEGMENT_LINE_AMOUNT,data,first_line); if (segment==ERROR_PACKAGE) HAL_Delay(RESYNC_TIMEOUT_MS); if (segment==ERROR_PACKAGE || segment==0) waitable_segment=1; if (segment==ERROR_PACKAGE || segment==NO_SEGMENT || segment==0) return(false); if (segment!=waitable_segment) { waitable_segment=1; if (segment!=1) return(false); } waitable_segment++; if (waitable_segment!=5) return(false); waitable_segment=1; return(true); } //---------------------------------------------------------------------------------------------------- //      //---------------------------------------------------------------------------------------------------- unsigned short *LEPTONCONTROL_GetRAW14Ptr(void) { return(RAW14Image); }</span></span></span></span></code> </pre><br></div></div><br>  Todo el trabajo con este módulo consiste en la simple presentación de datos obtenidos por SPI. <br><br><div class="spoiler">  <b class="spoiler_title">Trabajar con el módulo</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">while</span></span>(<span class="hljs-number"><span class="hljs-number">1</span></span>) { <span class="hljs-comment"><span class="hljs-comment">//   while(1) { HAL_SPI_Receive(&amp;hspi1,buffer,VOSPI_PACKAGE_SIZE,0x1000); bool first_line=false; unsigned char *buffer_ptr=buffer; LEPTONCONTROL_PushVoSPI(buffer_ptr,&amp;first_line); if (first_line==true) break; } //    lepton3 unsigned char *buffer_ptr=buffer; HAL_SPI_Receive(&amp;hspi1,buffer_ptr,VOSPI_PACKAGE_SIZE*SPI_READ_VOSPI_AMOUNT,0x1000); buffer_ptr=buffer; for(long n=0;n&lt;SPI_READ_VOSPI_AMOUNT;n++,buffer_ptr+=VOSPI_PACKAGE_SIZE) { bool first_line=false; bool res=LEPTONCONTROL_PushVoSPI(buffer_ptr,&amp;first_line); if (res==true) CreateImage();//     } }</span></span></code> </pre><br></div></div><br>  Después de ensamblar el marco, las lecturas del sensor simplemente se normalizan, se reducen al rango [0..255] y se muestran en la pantalla en forma de tonos de gris.  Sin embargo, nada impide usar una paleta para colorear la imagen. <br><br>  Para mostrar la imagen en la pantalla, utilizo el módulo FSMC integrado en este controlador en modo de bus de datos de 8 bits. <br><br>  El programa completo se puede descargar <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">aquí</a> . <br><br>  Video de trabajo (desafortunadamente, grabé en una cámara vieja con la calidad adecuada, ahora no tengo una cámara de video conmigo). <br><br><iframe width="560" height="315" src="https://www.youtube.com/embed/BMG0rLr8tC8" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br>  PD: Por cierto, puede conectar la cámara termográfica Flir One Gen 2 a la placa de depuración de descubrimiento STM32F407 directamente a través de USB.  Sin embargo, la conexión es inestable: la cámara termográfica a menudo se pierde. <br><br><iframe width="560" height="315" src="https://www.youtube.com/embed/-elBzHRjZxo" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br>  El programa para tal conexión está <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">aquí</a> .  Tal vez alguien entienda qué es y cómo hacer que la conexión sea estable. <br><br>  Además, este módulo lepton 3 se conecta fácil y simplemente a la Raspberry Pi. <br><br><iframe width="560" height="315" src="https://www.youtube.com/embed/IWScr3B4RJ0" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br>  En este caso, tuve que modificar el programa desde el <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">repositorio</a> , haciendo que mi <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">versión</a> funcionara con lepton 3. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/es413021/">https://habr.com/ru/post/es413021/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../es413011/index.html">Sótano de la muerte</a></li>
<li><a href="../es413013/index.html">El deseo de transparencia.</a></li>
<li><a href="../es413015/index.html">Cómo somos analizados en los cines ... y no solo</a></li>
<li><a href="../es413017/index.html">Una pequeña nota sobre comodines Vamos a cifrar certificados</a></li>
<li><a href="../es413019/index.html">La vida un año después de la introducción de los robots: mientras no se pide igualdad</a></li>
<li><a href="../es413023/index.html">"Well Forgotten Old": bicicletas eléctricas: desde los primeros modelos hasta las posibilidades de hoy</a></li>
<li><a href="../es413025/index.html">Sobre espinas y estrellas en el camino hacia la optimización de los procesos de desarrollo</a></li>
<li><a href="../es413027/index.html">HI-FI soviético y sus creadores: discos de video láser en la URSS</a></li>
<li><a href="../es413029/index.html">La primera solución Managed OpenShift en la nube</a></li>
<li><a href="../es413033/index.html">Aubrey de Gray pionero del rejuvenecimiento: "Las personas de mediana edad tienen una buena oportunidad"</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>