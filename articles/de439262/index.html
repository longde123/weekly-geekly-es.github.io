<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👏🏽 👨‍👩‍👦 🏇🏽 Stellen Sie den Code direkt im Docker-Container bereit. Oder wie man nicht nach jedem Commit zögert ⏱️ 👵🏿 🐯</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Die Aufgabe kam WEB-12982 
 Erstellen Sie einen Web-12982-Zweig im Repository 
 Während die Filiale läuft, lesen Sie tz und trinken Sie Kaffee 
 Fahre...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Stellen Sie den Code direkt im Docker-Container bereit. Oder wie man nicht nach jedem Commit zögert</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/439262/"><blockquote>  <em>Die Aufgabe kam WEB-12982</em> <br>  Erstellen Sie einen Web-12982-Zweig im Repository <br>  <em>Während die Filiale läuft, lesen Sie tz und trinken Sie Kaffee</em> <br>  <em>Fahren Sie direkt mit der Entwicklung fort</em> <br><br>  <em>Git Commit, Git Push</em> <br>  Während der Zweig wieder zusammengebaut wird <br>  <em>Git Commit, Git Push</em> <br>  Während der Zweig wieder aufgebaut wird, wird Twitter umgedreht <br>  <em>Git Commit, Git Push</em> <br>  ... <br>  <em>Sie übergeben einen Bewertungszweig mit 50 Commits</em> <br><br>  Sie verstehen, dass 50 Commits genau 50 Minuten reine Zeit sind, die in Anfällen und Starts gesammelt werden, da 1-Minuten-Intervalle zu klein sind, um etwas anderes als Aufschub und Grundbedürfnisse zu tun. </blockquote><p><img src="https://habrastorage.org/webt/wk/fr/gn/wkfrgnyb8_mtcoblzg_hm2fi_9c.png"></p><br><p>  Ist die Situation bekannt?  In meinem Unternehmen ist die Entwicklungsinfrastruktur wie folgt organisiert: </p><br><ul><li>  Hitlab verfügt über viele Projekt-Repositories </li><li>  Um die Entwicklung beim Erstellen eines neuen Zweigs zu vereinfachen, erstellen Docker automatisch ihre eigene Sandbox an einer eindeutigen Adresse, einer vollständigen Kopie des übergeordneten Zweigs mit der erforderlichen Umgebung. </li><li>  Alles, was Sie brauchen, ist fertig - schreiben Sie einfach den Code und testen Sie das Ergebnis nach jedem Commit. Es ist <strong>sehr praktisch!</strong> </li></ul><br><p>  <strong>Aber langsam ...</strong> Wenn diese Situation in Ihrer Nähe ist, begrüßen Sie unter Katze. </p><a name="habracut"></a><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Das Wesentliche des Problems</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Lösungsoptionen</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Lösungsimplementierung</a> </li></ul><br><h2 id="sut-problemy--a-nameproblema">  Das Wesentliche des Problems </h2><br><blockquote>  <strong>tldr:</strong> Änderungen am Code erfordern das Zusammensetzen der Container und den Zeitaufwand (mehr als eine Minute, dies hängt vom Projekt ab, insbesondere wenn CI \ CD konfiguriert ist), was zwar nicht sinnvoll ausgegeben werden kann, aber die Arbeitszeit des Programmierers <strong>erheblich beeinträchtigt</strong> . </blockquote><br><div class="spoiler">  <b class="spoiler_title">Ähnliche Probleme treten regelmäßig bei allen auf</b> <div class="spoiler_text"><p>  Zum Beispiel wurde das gleiche liveReload für das Frontend aus einem bestimmten Grund eindeutig erfunden </p></div></div><br><p>  Ich habe zuvor <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">einen Artikel zu einem verwandten Thema veröffentlicht</a> , der sich jedoch auf den Debugging-Prozess bezieht (übrigens danke für die informativen Kommentare und das positive Feedback).  Das Problem mit dem Schnitt ist jedoch im Wesentlichen nicht verschwunden. Wir warten auch weiterhin, bis der Zweig wieder zusammengesetzt ist. </p><br><p>  Selbst wenn Sie die zusätzlichen Phasen überspringen und nur Build-Dev und Deployment-Dev belassen, ist die Wartezeit für nützliche Aktionen unerheblich, jedoch erheblich für die Gesamtzeit, die insbesondere für CI \ CD von Gitlab aufgewendet wird. </p><br><p>  Natürlich können Sie den Prozess beschleunigen, indem Sie das Projekt lokal zusammenstellen, vorausgesetzt, der Programmierer verfügt über einen relativ leistungsstarken Computer, Gitlab-Runner ist konfiguriert, dieselbe Umgebung ist wie auf dem Remote-Server konfiguriert und die entsprechenden Tags werden zu gitlab-ci.yml hinzugefügt, aber ich bezweifle Die Erstellungsgeschwindigkeit entspricht der automatischen Bereitstellung des FTP-Codes nach den Tasten Strg + s. </p><br><p>  Besonders <del>  Verbrennungen machen wütend </del>  Es ist anstrengend, wenn Sie während des Entwicklungsprozesses Tippfehler / Fehler machen, die sich im Allgemeinen nicht auf den Betrieb der Anwendung auswirken, aber nicht einfach so belassen werden können, und die Sie erst bemerken, wenn Sie das Ergebnis nach dem Zusammenbau betrachten. </p><br><h2 id="chto-trebuetsya-i-varianty-resheniya-a-namevariantsa">  Was ist erforderlich und Lösungsoptionen </h2><br><blockquote>  <strong>tldr:</strong> Finden Sie einen Weg, um das Ergebnis Ihrer Änderungen so einfach und schnell wie möglich zu sehen.  Um nicht jedes Mal ein Commit durchzuführen und nicht auf den Wiederaufbau des Zweigs zu warten.  Ich habe rsync vom lokalen Computer in den Remote-Server-Ordner ausgewählt, der mit dem Container-Ordner bereitgestellt wurde. </blockquote><p>  Ich habe im Internet keine vollständige Lösung gefunden, aber tatsächlich gibt es mehrere Möglichkeiten: </p><br><ul><li>  Konfigurieren Sie ftp \ ssh direkt im Container mit der Codebasis, fügen Sie es in das Image ein und stellen Sie über FTP eine direkte Verbindung zum Container selbst her <br><ul><li>  Persönlich erschien mir diese Option etwas kompliziert und zu „krückenhaft“, obwohl hier alle Optionen Krücken sind </li></ul></li><li>  (für den lokalen Gebrauch) Verwenden Sie <strong><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Docker CP</a></strong> , um Code direkt in den Container zu laden <br><ul><li>  Die Option ist nicht für die Arbeit mit einem Remote-Server geeignet. </li><li>  Docker-CP verfügt über äußerst eingeschränkte Funktionen, da Herstellerordner, die nicht jedes Mal kopiert werden sollten, und der Kopieralgorithmus selbst eher langsam sind. </li></ul></li><li>  (für Remote- / lokale Verwendung) Hängen Sie den gewünschten Containerordner in den externen Hostordner ein.  Laden Sie lokale Dateien direkt in den bereitgestellten Hostordner herunter.  Es gibt bereits viele Implementierungsoptionen: <br><ul><li>  Verwenden Sie Docker-Maschine und speziell <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Docker-Maschine scp</a> <br><ul><li>  Auch hier müssen Sie die Umgebung konfigurieren, Docker-Maschine konfigurieren. Vielleicht ist dies sinnvoll, wenn Sie ständig mit verschiedenen Servern arbeiten </li></ul></li><li>  Konfigurieren Sie in der IDE eine FTP-Verbindung mit dem gewünschten Hostordner <br><ul><li>  Für jeden neuen Zweig muss eine neue Verbindung erstellt oder die Zuordnung geändert werden </li></ul></li><li>  Verwenden Sie scp oder rsync, um Dateien in den gewünschten Hostordner hochzuladen. Verwenden Sie dazu ein kleines Bash-Skript und hängen Sie es an die Hotkeys <br><ul><li>  Zunächst scheint es unnötig kompliziert zu sein, aber tatsächlich ist es nicht so.  Das Skript selbst ist so einfach wie möglich und wird benötigt, um den Prozess zu automatisieren, damit Sie die Zuordnungen nicht jedes Mal neu konfigurieren müssen </li></ul></li></ul></li></ul><br><h2 id="samo-reshenie-rsync--volumes-a-namedecisiona">  Lösung selbst: rsync + Volumes </h2><br><blockquote>  <strong>tldr:</strong> <br><ul><li>  Benötigen Sie SSH-Zugriff auf einen Remote-Server und Rsync auf dem lokalen Computer </li><li>  Der Remote-Server muss über einen beschreibbaren Ordner verfügen </li><li>  Hängen Sie den Projektordner im Container in den externen Hostordner ein </li><li>  Fügen Sie dem Stammverzeichnis des Projekts ein kleines Bash-Skript hinzu, um Dateien mit dem Remote-Server zu synchronisieren </li><li>  Konfigurieren Sie einen Hotkey für die Ausführung des Synchronisationsskripts </li></ul><br></blockquote><p>  <strong>Es ist anzumerken, dass die bereitgestellte Lösung für die Entwicklungs- und Testumgebung ausgeschlossen ist</strong> </p><br><p>  In diesem Fall werde ich mir die Docker-Compose- und Gitlab-CI-Umgebungen ansehen, wobei Docker-Compose Umgebungsvariablen von Gitlab-CI verwendet. </p><br><p>  Wir bilden den Pfad zum Zielordner in gitlab-ci und exportieren diesen Pfad in docker-compose.yml: </p><br><pre><code class="plaintext hljs">before_script: - export SHARED_DIR_BASE='/var/www/builds' #    ,      - export SHARED_BRANCH_DIR=${SHARED_DIR_BASE}/${PROJECT_GROUP}/${PROJECT_NAME}/${CI_COMMIT_REF_NAME} #     web-123   my_group/my_project,      /var/shared/my_group/my_project/web-123 Deploy dev: stage: deploy_dev script: #   ,         - mkdir -p ${SHARED_BRANCH_DIR} - rsync -r --exclude-from=.gitignore --exclude-from=.dockerignore . ${SHARED_BRANCH_DIR} - find ${SHARED_BRANCH_DIR} -type d -exec setfacl -d -mo:rwx {} \; - find ${SHARED_BRANCH_DIR} -type d -exec setfacl -mo:rwx {} \; - find ${SHARED_BRANCH_DIR} -type f -exec setfacl -mo:rwx {} \; - envsubst &lt; docker-compose.tmpl &gt; docker-compose.yml #     gitlab-ci.yml  docker-compose.yml,   docker-compose.tmpl - docker-compose up -d</code> </pre> <br><p>  Als nächstes müssen wir die Projektordner in Docker-Compose in den externen Host-Ordner einbinden. Da wir die Variablen in Docker-Compose verwenden, benötigen wir die Vorlage Docker-Compose.tmpl, in der wir diese Variablen verwenden. </p><br><pre> <code class="plaintext hljs">version: '2.3' services: web: ... volumes: - ${SHARED_BRANCH_DIR}:/app/:rw #             #        .    ,      ,           .              ,     ,        - /app/protected/vendor/</code> </pre> <br><p>  Bereits die aktuelle Konfiguration ist ausreichend. Wenn Sie jetzt den Zweig auf dem <strong>Hostserver erstellen,</strong> wird der Ordner <strong>/ var / www /build / GROUP_NAME / PROJECT_NAME / BRANCH_NAME</strong> erstellt und das Projekt wird dort übertragen, mit Ausnahme der Dateien und Ordner, die in .gitignore und .dockerignore angegeben sind Sie können einfach FTP-Zuordnungen konfigurieren, aber wir werden noch etwas weiter gehen und den Prozess etwas automatisieren. </p><br><p>  Um Dateien zu synchronisieren, müssen wir ungefähr Folgendes ausführen: </p><br><pre> <code class="bash hljs">rsync -r -u \ --delete-after \ --exclude-from=.gitignore \ --exclude-from=.dockerignore \ . <span class="hljs-variable"><span class="hljs-variable">$sshUserName</span></span>@<span class="hljs-variable"><span class="hljs-variable">$sshHost</span></span>:<span class="hljs-variable"><span class="hljs-variable">$sharedBaseDir</span></span></code> </pre> <br><p>  Tatsächlich wird dieser Befehl in kleinen und mittleren Projekten schneller ausgeführt, als Sie Zeit haben, Änderungen festzuschreiben und in das Repository zu übertragen.  Es bleibt, dieses Skript vollständiger zu gestalten und seine Ausführung an Hotkeys zu binden. </p><br><div class="spoiler">  <b class="spoiler_title">Vollständiger Skriptcode: deploy.sh</b> <div class="spoiler_text"><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/usr/bin/env bash #    while [ -n "$1" ] do case "$1" in --sshUserName=*) sshUserName=${1#*=} ;; --sshHost=*) sshHost=${1#*=} ;; esac shift done #  shared    gitBranch=$(git branch | grep \* | cut -d ' ' -f2) gitProject=$(git config --local remote.origin.url|sed -n 's#.*/\([^.]*\)\.git#\1#p') gitGroup=$(git config --local remote.origin.url|sed -n 's#.*/\([^.]*\)/.*\.git#\1#p') sharedBaseDir=/var/www/builds/$gitGroup/$gitProject/$gitBranch #         rsync -r -u \ --delete-after \ --exclude-from=.gitignore \ --exclude-from=.dockerignore \ . $sshUserName@$sshHost:$sharedBaseDir echo "done"</span></span></code> </pre> </div></div><br><p>  Es ist zu beachten, dass sich das Skript im Stammverzeichnis des Projektordners des Repositorys befinden oder angeben muss, in welchem ​​Verzeichnis es funktionieren soll. </p><br><p>  Es bleibt nur, die Ausführung dieses Skripts an bestimmte Hotkeys zu binden und die Parameter sshUserName und sshHost festzulegen (es versteht sich, dass bereits über ssh auf den Remote-Server zugegriffen werden kann).  Wie das geht, werde ich ein Beispiel für PHPstorm geben. </p><br><ul><li>  Gehen Sie zu <strong>Datei -&gt; Einstellungen</strong> </li><li>  Erweitern Sie im Einstellungsfenster im linken Menü <strong>Extras</strong> und wählen Sie <strong>Externe Tools</strong> </li><li>  Wir schreiben den Pfad zum Skript und geben den realen sshUserName und sshHost in den Argumenten an <br><br><img src="https://habrastorage.org/webt/wv/j6/zq/wvj6zq86jwgy2s4gh01ouqrq7d8.png"></li><li>  Gehen <strong>Sie</strong> als Nächstes zu <strong>Keymap</strong> und suchen Sie nach dem Namen unserer externen Tools. <strong>Stellen Sie</strong> die erforderliche Kombination ein <br><br><img src="https://habrastorage.org/webt/ao/9y/iy/ao9yiyq5zahfsqkeh4lsfgb3wi4.png"></li></ul><br><p>  Das ist alles.  Wenn Sie nun auf die gewünschte Kombination klicken, werden alle Projektdateien mit dem Remote-Ordner synchronisiert, der mit dem Projektordner im Container bereitgestellt wird.  Das heißt, Änderungen werden fast sofort sichtbar. </p><br><p>  Ich gebe nicht vor, "ideal" für diese Lösung zu sein, es gibt wahrscheinlich bessere Optionen. Ich werde mich freuen, wenn ich in den Kommentaren davon erfahre.  Vielen Dank! </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de439262/">https://habr.com/ru/post/de439262/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de439248/index.html">Alan Kay: Könnten die alten Römer einen Computer bauen?</a></li>
<li><a href="../de439252/index.html">6 Gründe für eine IT-Karriere in Armenien</a></li>
<li><a href="../de439254/index.html">Unser alles</a></li>
<li><a href="../de439258/index.html">Generische Methoden im Rost: Wie Exonum von Eisen zu Actix-Web verlagert wurde</a></li>
<li><a href="../de439260/index.html">Der Autor von The Witcher erhält weiterhin eine Entschädigung von CD Projekt Red</a></li>
<li><a href="../de439264/index.html">So verwalten Sie komplexe technische Projekte, ohne PMs einzustellen: DataLine-Erfahrung</a></li>
<li><a href="../de439266/index.html">Die Erfahrung, ein Spiel für Android von Grund auf neu zu erstellen und wie es Google Play gutgeschrieben wurde</a></li>
<li><a href="../de439268/index.html">Wie VR-, AR- und 3D-Druck zusammenarbeiten: VR Concept-Erfahrung</a></li>
<li><a href="../de439270/index.html">Ein Beispiel für das Parsen von C ++ - Code mit libclang in Python</a></li>
<li><a href="../de439272/index.html">Jupyter Notebook auf Netflix</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>