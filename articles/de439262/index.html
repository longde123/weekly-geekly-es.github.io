<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üëèüèΩ üë®‚Äçüë©‚Äçüë¶ üèáüèΩ Stellen Sie den Code direkt im Docker-Container bereit. Oder wie man nicht nach jedem Commit z√∂gert ‚è±Ô∏è üëµüèø üêØ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Die Aufgabe kam WEB-12982 
 Erstellen Sie einen Web-12982-Zweig im Repository 
 W√§hrend die Filiale l√§uft, lesen Sie tz und trinken Sie Kaffee 
 Fahre...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Stellen Sie den Code direkt im Docker-Container bereit. Oder wie man nicht nach jedem Commit z√∂gert</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/439262/"><blockquote>  <em>Die Aufgabe kam WEB-12982</em> <br>  Erstellen Sie einen Web-12982-Zweig im Repository <br>  <em>W√§hrend die Filiale l√§uft, lesen Sie tz und trinken Sie Kaffee</em> <br>  <em>Fahren Sie direkt mit der Entwicklung fort</em> <br><br>  <em>Git Commit, Git Push</em> <br>  W√§hrend der Zweig wieder zusammengebaut wird <br>  <em>Git Commit, Git Push</em> <br>  W√§hrend der Zweig wieder aufgebaut wird, wird Twitter umgedreht <br>  <em>Git Commit, Git Push</em> <br>  ... <br>  <em>Sie √ºbergeben einen Bewertungszweig mit 50 Commits</em> <br><br>  Sie verstehen, dass 50 Commits genau 50 Minuten reine Zeit sind, die in Anf√§llen und Starts gesammelt werden, da 1-Minuten-Intervalle zu klein sind, um etwas anderes als Aufschub und Grundbed√ºrfnisse zu tun. </blockquote><p><img src="https://habrastorage.org/webt/wk/fr/gn/wkfrgnyb8_mtcoblzg_hm2fi_9c.png"></p><br><p>  Ist die Situation bekannt?  In meinem Unternehmen ist die Entwicklungsinfrastruktur wie folgt organisiert: </p><br><ul><li>  Hitlab verf√ºgt √ºber viele Projekt-Repositories </li><li>  Um die Entwicklung beim Erstellen eines neuen Zweigs zu vereinfachen, erstellen Docker automatisch ihre eigene Sandbox an einer eindeutigen Adresse, einer vollst√§ndigen Kopie des √ºbergeordneten Zweigs mit der erforderlichen Umgebung. </li><li>  Alles, was Sie brauchen, ist fertig - schreiben Sie einfach den Code und testen Sie das Ergebnis nach jedem Commit. Es ist <strong>sehr praktisch!</strong> </li></ul><br><p>  <strong>Aber langsam ...</strong> Wenn diese Situation in Ihrer N√§he ist, begr√º√üen Sie unter Katze. </p><a name="habracut"></a><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Das Wesentliche des Problems</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">L√∂sungsoptionen</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">L√∂sungsimplementierung</a> </li></ul><br><h2 id="sut-problemy--a-nameproblema">  Das Wesentliche des Problems </h2><br><blockquote>  <strong>tldr:</strong> √Ñnderungen am Code erfordern das Zusammensetzen der Container und den Zeitaufwand (mehr als eine Minute, dies h√§ngt vom Projekt ab, insbesondere wenn CI \ CD konfiguriert ist), was zwar nicht sinnvoll ausgegeben werden kann, aber die Arbeitszeit des Programmierers <strong>erheblich beeintr√§chtigt</strong> . </blockquote><br><div class="spoiler">  <b class="spoiler_title">√Ñhnliche Probleme treten regelm√§√üig bei allen auf</b> <div class="spoiler_text"><p>  Zum Beispiel wurde das gleiche liveReload f√ºr das Frontend aus einem bestimmten Grund eindeutig erfunden </p></div></div><br><p>  Ich habe zuvor <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">einen Artikel zu einem verwandten Thema ver√∂ffentlicht</a> , der sich jedoch auf den Debugging-Prozess bezieht (√ºbrigens danke f√ºr die informativen Kommentare und das positive Feedback).  Das Problem mit dem Schnitt ist jedoch im Wesentlichen nicht verschwunden. Wir warten auch weiterhin, bis der Zweig wieder zusammengesetzt ist. </p><br><p>  Selbst wenn Sie die zus√§tzlichen Phasen √ºberspringen und nur Build-Dev und Deployment-Dev belassen, ist die Wartezeit f√ºr n√ºtzliche Aktionen unerheblich, jedoch erheblich f√ºr die Gesamtzeit, die insbesondere f√ºr CI \ CD von Gitlab aufgewendet wird. </p><br><p>  Nat√ºrlich k√∂nnen Sie den Prozess beschleunigen, indem Sie das Projekt lokal zusammenstellen, vorausgesetzt, der Programmierer verf√ºgt √ºber einen relativ leistungsstarken Computer, Gitlab-Runner ist konfiguriert, dieselbe Umgebung ist wie auf dem Remote-Server konfiguriert und die entsprechenden Tags werden zu gitlab-ci.yml hinzugef√ºgt, aber ich bezweifle Die Erstellungsgeschwindigkeit entspricht der automatischen Bereitstellung des FTP-Codes nach den Tasten Strg + s. </p><br><p>  Besonders <del>  Verbrennungen machen w√ºtend </del>  Es ist anstrengend, wenn Sie w√§hrend des Entwicklungsprozesses Tippfehler / Fehler machen, die sich im Allgemeinen nicht auf den Betrieb der Anwendung auswirken, aber nicht einfach so belassen werden k√∂nnen, und die Sie erst bemerken, wenn Sie das Ergebnis nach dem Zusammenbau betrachten. </p><br><h2 id="chto-trebuetsya-i-varianty-resheniya-a-namevariantsa">  Was ist erforderlich und L√∂sungsoptionen </h2><br><blockquote>  <strong>tldr:</strong> Finden Sie einen Weg, um das Ergebnis Ihrer √Ñnderungen so einfach und schnell wie m√∂glich zu sehen.  Um nicht jedes Mal ein Commit durchzuf√ºhren und nicht auf den Wiederaufbau des Zweigs zu warten.  Ich habe rsync vom lokalen Computer in den Remote-Server-Ordner ausgew√§hlt, der mit dem Container-Ordner bereitgestellt wurde. </blockquote><p>  Ich habe im Internet keine vollst√§ndige L√∂sung gefunden, aber tats√§chlich gibt es mehrere M√∂glichkeiten: </p><br><ul><li>  Konfigurieren Sie ftp \ ssh direkt im Container mit der Codebasis, f√ºgen Sie es in das Image ein und stellen Sie √ºber FTP eine direkte Verbindung zum Container selbst her <br><ul><li>  Pers√∂nlich erschien mir diese Option etwas kompliziert und zu ‚Äûkr√ºckenhaft‚Äú, obwohl hier alle Optionen Kr√ºcken sind </li></ul></li><li>  (f√ºr den lokalen Gebrauch) Verwenden Sie <strong><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Docker CP</a></strong> , um Code direkt in den Container zu laden <br><ul><li>  Die Option ist nicht f√ºr die Arbeit mit einem Remote-Server geeignet. </li><li>  Docker-CP verf√ºgt √ºber √§u√üerst eingeschr√§nkte Funktionen, da Herstellerordner, die nicht jedes Mal kopiert werden sollten, und der Kopieralgorithmus selbst eher langsam sind. </li></ul></li><li>  (f√ºr Remote- / lokale Verwendung) H√§ngen Sie den gew√ºnschten Containerordner in den externen Hostordner ein.  Laden Sie lokale Dateien direkt in den bereitgestellten Hostordner herunter.  Es gibt bereits viele Implementierungsoptionen: <br><ul><li>  Verwenden Sie Docker-Maschine und speziell <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Docker-Maschine scp</a> <br><ul><li>  Auch hier m√ºssen Sie die Umgebung konfigurieren, Docker-Maschine konfigurieren. Vielleicht ist dies sinnvoll, wenn Sie st√§ndig mit verschiedenen Servern arbeiten </li></ul></li><li>  Konfigurieren Sie in der IDE eine FTP-Verbindung mit dem gew√ºnschten Hostordner <br><ul><li>  F√ºr jeden neuen Zweig muss eine neue Verbindung erstellt oder die Zuordnung ge√§ndert werden </li></ul></li><li>  Verwenden Sie scp oder rsync, um Dateien in den gew√ºnschten Hostordner hochzuladen. Verwenden Sie dazu ein kleines Bash-Skript und h√§ngen Sie es an die Hotkeys <br><ul><li>  Zun√§chst scheint es unn√∂tig kompliziert zu sein, aber tats√§chlich ist es nicht so.  Das Skript selbst ist so einfach wie m√∂glich und wird ben√∂tigt, um den Prozess zu automatisieren, damit Sie die Zuordnungen nicht jedes Mal neu konfigurieren m√ºssen </li></ul></li></ul></li></ul><br><h2 id="samo-reshenie-rsync--volumes-a-namedecisiona">  L√∂sung selbst: rsync + Volumes </h2><br><blockquote>  <strong>tldr:</strong> <br><ul><li>  Ben√∂tigen Sie SSH-Zugriff auf einen Remote-Server und Rsync auf dem lokalen Computer </li><li>  Der Remote-Server muss √ºber einen beschreibbaren Ordner verf√ºgen </li><li>  H√§ngen Sie den Projektordner im Container in den externen Hostordner ein </li><li>  F√ºgen Sie dem Stammverzeichnis des Projekts ein kleines Bash-Skript hinzu, um Dateien mit dem Remote-Server zu synchronisieren </li><li>  Konfigurieren Sie einen Hotkey f√ºr die Ausf√ºhrung des Synchronisationsskripts </li></ul><br></blockquote><p>  <strong>Es ist anzumerken, dass die bereitgestellte L√∂sung f√ºr die Entwicklungs- und Testumgebung ausgeschlossen ist</strong> </p><br><p>  In diesem Fall werde ich mir die Docker-Compose- und Gitlab-CI-Umgebungen ansehen, wobei Docker-Compose Umgebungsvariablen von Gitlab-CI verwendet. </p><br><p>  Wir bilden den Pfad zum Zielordner in gitlab-ci und exportieren diesen Pfad in docker-compose.yml: </p><br><pre><code class="plaintext hljs">before_script: - export SHARED_DIR_BASE='/var/www/builds' #    ,      - export SHARED_BRANCH_DIR=${SHARED_DIR_BASE}/${PROJECT_GROUP}/${PROJECT_NAME}/${CI_COMMIT_REF_NAME} #     web-123   my_group/my_project,      /var/shared/my_group/my_project/web-123 Deploy dev: stage: deploy_dev script: #   ,         - mkdir -p ${SHARED_BRANCH_DIR} - rsync -r --exclude-from=.gitignore --exclude-from=.dockerignore . ${SHARED_BRANCH_DIR} - find ${SHARED_BRANCH_DIR} -type d -exec setfacl -d -mo:rwx {} \; - find ${SHARED_BRANCH_DIR} -type d -exec setfacl -mo:rwx {} \; - find ${SHARED_BRANCH_DIR} -type f -exec setfacl -mo:rwx {} \; - envsubst &lt; docker-compose.tmpl &gt; docker-compose.yml #     gitlab-ci.yml  docker-compose.yml,   docker-compose.tmpl - docker-compose up -d</code> </pre> <br><p>  Als n√§chstes m√ºssen wir die Projektordner in Docker-Compose in den externen Host-Ordner einbinden. Da wir die Variablen in Docker-Compose verwenden, ben√∂tigen wir die Vorlage Docker-Compose.tmpl, in der wir diese Variablen verwenden. </p><br><pre> <code class="plaintext hljs">version: '2.3' services: web: ... volumes: - ${SHARED_BRANCH_DIR}:/app/:rw #             #        .    ,      ,           .              ,     ,        - /app/protected/vendor/</code> </pre> <br><p>  Bereits die aktuelle Konfiguration ist ausreichend. Wenn Sie jetzt den Zweig auf dem <strong>Hostserver erstellen,</strong> wird der Ordner <strong>/ var / www /build / GROUP_NAME / PROJECT_NAME / BRANCH_NAME</strong> erstellt und das Projekt wird dort √ºbertragen, mit Ausnahme der Dateien und Ordner, die in .gitignore und .dockerignore angegeben sind Sie k√∂nnen einfach FTP-Zuordnungen konfigurieren, aber wir werden noch etwas weiter gehen und den Prozess etwas automatisieren. </p><br><p>  Um Dateien zu synchronisieren, m√ºssen wir ungef√§hr Folgendes ausf√ºhren: </p><br><pre> <code class="bash hljs">rsync -r -u \ --delete-after \ --exclude-from=.gitignore \ --exclude-from=.dockerignore \ . <span class="hljs-variable"><span class="hljs-variable">$sshUserName</span></span>@<span class="hljs-variable"><span class="hljs-variable">$sshHost</span></span>:<span class="hljs-variable"><span class="hljs-variable">$sharedBaseDir</span></span></code> </pre> <br><p>  Tats√§chlich wird dieser Befehl in kleinen und mittleren Projekten schneller ausgef√ºhrt, als Sie Zeit haben, √Ñnderungen festzuschreiben und in das Repository zu √ºbertragen.  Es bleibt, dieses Skript vollst√§ndiger zu gestalten und seine Ausf√ºhrung an Hotkeys zu binden. </p><br><div class="spoiler">  <b class="spoiler_title">Vollst√§ndiger Skriptcode: deploy.sh</b> <div class="spoiler_text"><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/usr/bin/env bash #    while [ -n "$1" ] do case "$1" in --sshUserName=*) sshUserName=${1#*=} ;; --sshHost=*) sshHost=${1#*=} ;; esac shift done #  shared    gitBranch=$(git branch | grep \* | cut -d ' ' -f2) gitProject=$(git config --local remote.origin.url|sed -n 's#.*/\([^.]*\)\.git#\1#p') gitGroup=$(git config --local remote.origin.url|sed -n 's#.*/\([^.]*\)/.*\.git#\1#p') sharedBaseDir=/var/www/builds/$gitGroup/$gitProject/$gitBranch #         rsync -r -u \ --delete-after \ --exclude-from=.gitignore \ --exclude-from=.dockerignore \ . $sshUserName@$sshHost:$sharedBaseDir echo "done"</span></span></code> </pre> </div></div><br><p>  Es ist zu beachten, dass sich das Skript im Stammverzeichnis des Projektordners des Repositorys befinden oder angeben muss, in welchem ‚Äã‚ÄãVerzeichnis es funktionieren soll. </p><br><p>  Es bleibt nur, die Ausf√ºhrung dieses Skripts an bestimmte Hotkeys zu binden und die Parameter sshUserName und sshHost festzulegen (es versteht sich, dass bereits √ºber ssh auf den Remote-Server zugegriffen werden kann).  Wie das geht, werde ich ein Beispiel f√ºr PHPstorm geben. </p><br><ul><li>  Gehen Sie zu <strong>Datei -&gt; Einstellungen</strong> </li><li>  Erweitern Sie im Einstellungsfenster im linken Men√º <strong>Extras</strong> und w√§hlen Sie <strong>Externe Tools</strong> </li><li>  Wir schreiben den Pfad zum Skript und geben den realen sshUserName und sshHost in den Argumenten an <br><br><img src="https://habrastorage.org/webt/wv/j6/zq/wvj6zq86jwgy2s4gh01ouqrq7d8.png"></li><li>  Gehen <strong>Sie</strong> als N√§chstes zu <strong>Keymap</strong> und suchen Sie nach dem Namen unserer externen Tools. <strong>Stellen Sie</strong> die erforderliche Kombination ein <br><br><img src="https://habrastorage.org/webt/ao/9y/iy/ao9yiyq5zahfsqkeh4lsfgb3wi4.png"></li></ul><br><p>  Das ist alles.  Wenn Sie nun auf die gew√ºnschte Kombination klicken, werden alle Projektdateien mit dem Remote-Ordner synchronisiert, der mit dem Projektordner im Container bereitgestellt wird.  Das hei√üt, √Ñnderungen werden fast sofort sichtbar. </p><br><p>  Ich gebe nicht vor, "ideal" f√ºr diese L√∂sung zu sein, es gibt wahrscheinlich bessere Optionen. Ich werde mich freuen, wenn ich in den Kommentaren davon erfahre.  Vielen Dank! </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de439262/">https://habr.com/ru/post/de439262/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de439248/index.html">Alan Kay: K√∂nnten die alten R√∂mer einen Computer bauen?</a></li>
<li><a href="../de439252/index.html">6 Gr√ºnde f√ºr eine IT-Karriere in Armenien</a></li>
<li><a href="../de439254/index.html">Unser alles</a></li>
<li><a href="../de439258/index.html">Generische Methoden im Rost: Wie Exonum von Eisen zu Actix-Web verlagert wurde</a></li>
<li><a href="../de439260/index.html">Der Autor von The Witcher erh√§lt weiterhin eine Entsch√§digung von CD Projekt Red</a></li>
<li><a href="../de439264/index.html">So verwalten Sie komplexe technische Projekte, ohne PMs einzustellen: DataLine-Erfahrung</a></li>
<li><a href="../de439266/index.html">Die Erfahrung, ein Spiel f√ºr Android von Grund auf neu zu erstellen und wie es Google Play gutgeschrieben wurde</a></li>
<li><a href="../de439268/index.html">Wie VR-, AR- und 3D-Druck zusammenarbeiten: VR Concept-Erfahrung</a></li>
<li><a href="../de439270/index.html">Ein Beispiel f√ºr das Parsen von C ++ - Code mit libclang in Python</a></li>
<li><a href="../de439272/index.html">Jupyter Notebook auf Netflix</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>