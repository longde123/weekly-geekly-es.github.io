<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ü§ûüèø ‚ôøÔ∏è üôèüèæ Comment parler avec le microcontr√¥leur de JS üêÅ ‚úäüèΩ ‚ú°Ô∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Pourquoi un microcontr√¥leur est-il n√©cessaire? Par exemple, pour installer une brasserie √† la maison. Si votre brasserie ne suffit pas, vous pouvez fa...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Comment parler avec le microcontr√¥leur de JS</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/oleg-bunin/blog/450826/">  Pourquoi un microcontr√¥leur est-il n√©cessaire?  Par exemple, pour installer une brasserie √† la maison.  Si votre brasserie ne suffit pas, vous pouvez faire quelque chose de plus grand: construire une salle de qu√™te, organiser une pr√©sentation, une fontaine interactive qui peint une image avec des gouttes ou un stand d'exposition pour une grande entreprise.  Vous pouvez tout faire avec un microcontr√¥leur - tout d√©pend de votre imagination. <br><br>  Il y a une id√©e fausse selon laquelle pour cr√©er vos propres glandes, vous devez conna√Ætre l'assembleur C / C ++, √™tre capable de g√©rer la m√©moire et de comprendre profond√©ment l'√©lectricit√©.  Autrefois, mais la technologie se d√©veloppe et maintenant pour la mise en ≈ìuvre compl√®te de son projet, seul JS suffit! <br><br><img src="https://habrastorage.org/webt/cc/wc/ou/ccwcoucl5o2c-9xayxy04jc8fsq.jpeg"><br><br>  Ok, nous connaissons JavaScript, mais comment le connecter au mat√©riel?  Quel type de fer existe-t-il et que peut-il faire?  Comment configurer l'ensemble du syst√®me?  Lors du d√©codage du rapport, Victor Nakoryakova de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">FrontendConf</a> apprendra: comment, en utilisant uniquement JS, contr√¥ler les servos, comment combiner physiquement le syst√®me avec un PC et les options de communication pour l'application sur JS.  Nous discuterons des packages serialport et Firmata, serialport avec un firmware auto-√©crit en C ++, Espruino et la programmation du contr√¥leur directement sur JS, Raspberry Pi, HTTP sur le r√©seau local et HTTP et MQTT via le cloud. <br><a name="habracut"></a><br><iframe width="560" height="315" src="https://www.youtube.com/embed/yqeTaf44vNk" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><br>  <strong>Victor Nakoryakov</strong> ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" class="user_link">nailxx</a> ) - directeur technique, co-fondateur d'Amperka.  Il aime les technologies de d√©veloppement avanc√©es, la programmation fonctionnelle et l'informatique physique.  Amperka fabrique et vend des modules √©lectroniques afin que les non-professionnels puissent cr√©er des appareils intelligents de leurs propres mains, des kits de formation et des blocs de construction individuels qui peuvent √™tre ajout√©s √† leur appareil - moteurs, GPS, SMS. <br><br><h2>  O√π √©crire JavaScript </h2><br>  <strong>Espruino dispose d'un microcontr√¥leur autonome avec JavaScript.</strong>  La plate-forme Espruino vous permet d'√©crire JS directement sur le microcontr√¥leur.  C'est une chose autonome en soi: connect√©e √† un ordinateur, flash√©e, puis √ßa fonctionne de fa√ßon ind√©pendante. <br><br>  <strong>Le Raspberry Pi</strong> est un petit ordinateur avec GPIO. <br><br>  <strong>Dans une application Web</strong> , vers le frontend ou le backend. <br><br>  Je vais montrer le fonctionnement du syst√®me en utilisant un exemple de grenouille.  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Acc√©dez</a> √† <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">toad.amperka.ru</a> depuis votre t√©l√©phone - une interface Web simple appara√Ætra. <br><br><img src="https://habrastorage.org/webt/pd/ya/be/pdyabe5bjmklkee0jjco7nontue.jpeg"><br><br>  La colonne de gauche contr√¥le l'≈ìil gauche, la droite - la droite.  Le principe est simple - j'ai appuy√© sur le bouton, le servomoteur fait tourner les yeux. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/oc/z5/re/ocz5rert1d774i6ic7dzkaahjpa.gif" width="350"></div><br><br>  D√©monstration <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">vid√©o</a> d'un stand avec une grenouille pendant le reportage. <br><br><h2>  Comment fonctionne la grenouille </h2><br>  Lorsque vous ouvrez toad.amperka.ru, vous obtenez une page Web statique avec JS statique qui utilise la biblioth√®que <a href="">MQTT.js.</a>  Cette biblioth√®que contacte le courtier MQTT dans le cloud. <br><br><img src="https://habrastorage.org/webt/5r/7h/it/5r7hit4db5ds9369m2fgmsua8t4.jpeg"><br><br>  Si vous connaissez Redis, Publish / Subscribe, RabbitMQ ou d'autres files d'attente de messages, vous avez imm√©diatement compris de quoi il s'agissait.  <strong>MQTT est un courtier de messages Machine-to-Machine</strong> .  L√©ger et simple pour que m√™me les glandes faibles puissent l'utiliser. <br><br>  MQTT n√©cessite un courtier sur le serveur.  Mais vous n'avez m√™me pas besoin de le soulever - de le louer.  Pour quelques dollars par mois, vous aurez votre propre courtier MQTT.  Aucun backend n√©cessaire. <br><br>  D'autre part, il y a un contr√¥leur du courtier MQTT.  Il existe de nombreux appareils diff√©rents avec ce r√¥le, par exemple, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Wi-Fi Slot</a> .  Il s'agit d'un contr√¥leur qui peut se connecter √† Internet. <br><br><img src="https://habrastorage.org/webt/th/dz/jc/thdzjcdluwlertps_bl5lbkdjui.jpeg"><br><br>  Il fonctionne sur la base de la puce ESP8266 populaire.  Ajout de la possibilit√© d'alimenter via micro-USB et de connecter des p√©riph√©riques externes via des contacts triples pour se connecter √† d'autres appareils. <br><br><h2>  Comment programmer du mat√©riel dans JS </h2><br>  Rien d'extraordinaire, JS r√©gulier - ES6 presque complet.  Quelques fonctions et objets pour travailler √† bas niveau avec des signaux √©lectriques ont √©t√© ajout√©s √† la biblioth√®que standard.  Par exemple, des fonctions de lecture et d'√©criture num√©riques simples. <br><br>  <strong>digitalRead - lecture num√©rique</strong> .  C'est une question pour le contr√¥leur: "Y a-t-il trois volts sur la broche num√©ro 4?"  S'il y a de la tension, elle retournera TRUE; sinon, FALSE.  Cela met en ≈ìuvre la lecture de simples capteurs binaires: boutons, interrupteurs, verrous √† lames et capteurs de mouvement infrarouge. <br><br>  <strong>digitalWrite est un simple enregistrement num√©rique</strong> .  Nous disons que digitalWrite TRUE - 3V va de pair avec la broche.  Nous disons digitalWrite FALSE - 0V.  En utilisant ce principe simple, vous pouvez allumer / √©teindre une bande LED ou lancer un missile nucl√©aire.  Nous envoyons un signal faible au relais, il commute une grosse charge et la fus√©e a vol√©. <br><br>  Il existe √©galement des fonctions pour travailler avec des valeurs interm√©diaires entre 0 et 3V: <br><br><ul><li>  analogRead; </li><li>  analogWrite; </li><li>  setWatch; </li><li>  digitalPulse. </li></ul><br>  Les commandes vous permettent d'interroger toutes sortes de rebondissements et offrent des fonctions d'enregistrement flou. <br><br>  Viennent ensuite les objets pour travailler avec des interfaces accept√©es dans le monde des microcontr√¥leurs.  Si sur le Web, nous comprenons et connaissons HTTP, WebSocket, TCP, alors pour un microcontr√¥leur, c'est: <br><br><ul><li>  S√©rie - port s√©rie; </li><li>  Bus I2C </li><li>  Bus SPI </li><li>  Bus OneWire. </li></ul><br><h2>  Comment d√©marrer un servomoteur </h2><br>  Pour un exemple, je vais vous dire comment contr√¥ler un moteur qui se trouve dans un hypodermique.  Le protocole moteur est simple.  0V est appliqu√© √† la broche de commande - la limite inf√©rieure.  Une fois tous les 20 Œºs, il doit √™tre lanc√©, ce qui donne une unit√© stable de 3V, et apr√®s un certain temps - r√©initialis√© √† 0. <br><br><img src="https://habrastorage.org/webt/io/1t/aj/io1tajdpojik7cxsab0mrddw0bi.jpeg"><br><br>  Puis tout recommence.  Selon la longueur de l'unit√©, nous obtenons diff√©rentes vitesses de rotation.  Avec une longueur d'impulsion de 1 500 Œºs, le moteur s'arr√™te.  Lorsqu'il est d√©vi√© dans un sens ou dans un autre, il tourne dans le sens horaire ou antihoraire.  L'amplitude de l'√©cart affecte la vitesse de rotation. <br><br><h2>  Comment programmer </h2><br>  La programmation de la plateforme Espruino se fait dans l'IDE Espruino du m√™me nom.  La carte microcontr√¥leur est connect√©e √† l'ordinateur avec un c√¢ble micro-USB.  La seule chose est que vous devez installer le pilote, ce qui prend 1,5 minute.  Le pilote est install√© pour MAC et Windows, et sur Linux tout fonctionne hors de la bo√Æte. <br><br>  Voici un exemple de programme qui se charge dans l'environnement en un seul clic.  Il fait clignoter une LED une fois par seconde: <br><br><pre><code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> on = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; setInterval(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ on = !on; LED1.write(on); },<span class="hljs-number"><span class="hljs-number">500</span></span>);</code> </pre> <br>  √Ä gauche dans l'environnement se trouve l'interpr√©teur REPL.  Entrez "1 + 1".  Le programme donne la r√©ponse "2".  Miracle! <br><br>  Le miracle est que lorsque vous appuyez sur les boutons, le chiffre ¬´1¬ª, le signe ¬´+¬ª et l'unit√© suivante passent par le c√¢ble vers le contr√¥leur.  Lorsque vous appuyez sur ENTR√âE, l'expression est ex√©cut√©e √† l'int√©rieur du microcontr√¥leur, pas de l'ordinateur.  Le microcontr√¥leur a obtenu le r√©sultat ¬´2¬ª et l'a renvoy√© par c√¢ble √† l'ordinateur.  ¬´2¬ª √©tait affich√© sur le moniteur. <br><br><blockquote>  JavaScript est ex√©cut√© √† l'int√©rieur du mat√©riel. </blockquote><br>  En plus du divertissement avec l'arithm√©tique, vous pouvez faire tourner les moteurs.  Vous aurez besoin de la fonction analogWrite, qui envoie une onde carr√©e.  Nous parlons de quelle broche pour donner une onde.  Par exemple, sur mon tableau, il est sign√© comme A7.  Ensuite, nous indiquons la dur√©e - par exemple, 1300 Œºs sur 20 000 Œºs nous en servirons un.  Une option qui d√©finit √©galement la fr√©quence de ce coup de pied - 50 fois par seconde, soit 20 000 Œºs, est √©galement requise. <br><br><pre> <code class="javascript hljs">&gt;analogWrite(A7, <span class="hljs-number"><span class="hljs-number">1300</span></span> / <span class="hljs-number"><span class="hljs-number">2000</span></span>, {<span class="hljs-attr"><span class="hljs-attr">freq</span></span>: <span class="hljs-number"><span class="hljs-number">50</span></span>}} =<span class="hljs-literal"><span class="hljs-literal">undefined</span></span> &gt;</code> </pre> <br>  Nous passerons pour 1500 - nous forcerons √† tourner dans l'autre sens avec une plus grande vitesse. <br><br><pre> <code class="javascript hljs">&gt;analogWrite(A7, <span class="hljs-number"><span class="hljs-number">2300</span></span> / <span class="hljs-number"><span class="hljs-number">2000</span></span>, {<span class="hljs-attr"><span class="hljs-attr">freq</span></span>: <span class="hljs-number"><span class="hljs-number">50</span></span>}} =<span class="hljs-literal"><span class="hljs-literal">undefined</span></span> &gt;</code> </pre> <br>  Ou dites stop. <br><br><pre> <code class="javascript hljs">&gt;digitalWrite(A7, <span class="hljs-number"><span class="hljs-number">0</span></span>) =<span class="hljs-literal"><span class="hljs-literal">undefined</span></span> &gt;</code> </pre> <br>  En utilisant les m√™mes fonctions, vous pouvez √©crire un programme complet qui, en fonction de facteurs externes - en appuyant sur les boutons, les lectures du capteur - fera ce que vous voulez. <br><br><h3>  Biblioth√®ques </h3><br>  Il n'est pas toujours commode de rappeler les d√©tails de la mise en ≈ìuvre du protocole.  Par cons√©quent, pour toutes sortes de fer, de nombreuses biblioth√®ques ont √©t√© cr√©√©es, de petite √† g√©ante.  Ils contiennent toutes les caract√©ristiques techniques.  Les biblioth√®ques utilisent des m√©thodes compr√©hensibles: lire les donn√©es d'une balise nfc, lire la concentration de dioxyde de carbone en ppm ou envoyer un message √† Telegram. <br><ul><li>  servo.write; </li><li>  barometer.init; </li><li>  barometer.read; </li><li>  barom√®tre.temp√©rature; </li><li>  nfc.listen; </li><li>  nfc.on ('tag', ...); </li><li>  nfc.readPage; </li><li>  nfc.writePage; </li><li>  relay.turnOn; </li><li>  relay.turnOff; </li><li>  gaz.calibrate; </li><li>  gas.read (¬´CO2¬ª); </li><li>  telegram.sendMessage. </li></ul><br>  Il est utile de comprendre les commandes de bas niveau, mais pour commencer √† cr√©er, il n'est pas n√©cessaire de le savoir. <br><br><h2>  Code client </h2><br>  Ainsi, lorsque nous cliquons sur l'un des boutons de la colonne de gauche ou de droite de notre grenouille, la valeur que nous voulons d√©finir sur le servo correspondant est envoy√©e au sujet crapaud / ≈ìil / gauche ou droite. <br><br><img src="https://habrastorage.org/webt/y1/3e/mt/y13emt_fcb-qdw2j_tihccn8ukm.jpeg"><br><br><pre> <code class="javascript hljs">&lt;button <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span></span>=<span class="hljs-string"><span class="hljs-string">"toad__eye__control"</span></span> data-queue=<span class="hljs-string"><span class="hljs-string">"left"</span></span> data-payload=<span class="hljs-string"><span class="hljs-string">"1300"</span></span>&gt; <span class="hljs-number"><span class="hljs-number">-1</span></span> &lt;<span class="hljs-regexp"><span class="hljs-regexp">/button&gt;</span></span></code> </pre> <br>  1300 est la dur√©e d'impulsion.  D'o√π viennent la gauche et 1300?  Je viens de les ajouter au HTML en tant qu'attributs de donn√©es. <br><br>  En JS, nous √©crivons du code simple. <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> mqtt <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'mqtt'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> client = mqtt.connect(<span class="hljs-string"><span class="hljs-string">`ws://</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${location.hostname}</span></span></span><span class="hljs-string">:9001`</span></span>); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onEyeControlClick</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> { queue, payload } = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.dataset; client.publish(<span class="hljs-string"><span class="hljs-string">`toad/eye/</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${queue}</span></span></span><span class="hljs-string">`</span></span>, payload); } <span class="hljs-built_in"><span class="hljs-built_in">document</span></span>.querySelectorAll(<span class="hljs-string"><span class="hljs-string">".toad__eye__control"</span></span>) .forEach(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">e</span></span></span><span class="hljs-function"> =&gt;</span></span> e.addEventListener(<span class="hljs-string"><span class="hljs-string">'click'</span></span>, onEyeControlClick));</code> </pre> <br>  Analysons le code en plusieurs parties.  Au d√©but, nous nous connectons au courtier, qui fonctionne par d√©faut sur le port 9001: <code>const client = mqtt.connect(`ws://${location.hostname}:9001`);</code>  . <br><br>  En cliquant sur l'un des boutons, nous publions un nouveau message avec charge utile, que nous avons obtenu de l'attribut <code>client.publish(`toad/eye/${queue}`, payload);</code> : <code>client.publish(`toad/eye/${queue}`, payload);</code>  . <br><br>  Ensuite, nous publions sur le sujet, qui est √©galement form√© sur la base de l'attribut data.  C'est tout notre code JS dans le navigateur. <br><br><h2>  Code du conseil </h2><br>  Lorsque la fente Wi-Fi d√©marre, elle s'abonne aux sujets qui l'int√©ressent et re√ßoit les donn√©es.  Quand ils arrivent, la fente r√©pond et fait fonctionner les moteurs. <br><br><img src="https://habrastorage.org/webt/5r/7h/it/5r7hit4db5ds9369m2fgmsua8t4.jpeg"><br><br>  Le code du tableau est classiquement divis√© en plusieurs parties.  Pour commencer, nous connectons des biblioth√®ques.  En particulier, ce n'est que la <strong>biblioth√®que qui ex√©cute Servo</strong> afin de ne pas rappeler les d√©tails.  Ils sont dans le champ d'amperka. <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> ssid = <span class="hljs-string"><span class="hljs-string">"Droidxx"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> password = <span class="hljs-string"><span class="hljs-string">"****"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> brokerHostname = <span class="hljs-string"><span class="hljs-string">"toad.amperka.ru"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> leftEye = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">"@amperka/servo"</span></span>).connect(A5); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> rightEye = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">"@amperka/servo"</span></span>).connect(A7).</code> </pre> <br>  Chacun peut cr√©er et publier ses propres biblioth√®ques.  Nous en avons fabriqu√© plusieurs dizaines pour notre propre module et d'autres modules populaires.  Tout Open Source - <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">entrez, utilisez-le</a> . <br><br>  Ensuite, nous avons besoin de <strong>biblioth√®ques pour travailler avec les courtiers Wi-Fi et MQTT</strong> . <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> wifi = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">"Wifi"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> mqtt = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">"tinyMQTT"</span></span>).create(brokerHostname);</code> </pre> <br>  Il n'y a pas de syst√®me d'exploitation, donc m√™me la connexion au Wi-Fi est une op√©ration manuelle.  Les soins de connexion vous appartiennent, mais ce n'est pas si difficile.  Pour se connecter au r√©seau, nous appelons simplement la m√©thode ¬´connect¬ª qui, en cas de succ√®s ou d'√©chec, appellera ¬´callback¬ª et rendra compte des r√©sultats de l'op√©ration. <br><br><pre> <code class="javascript hljs">wifi.connect(ssid, { <span class="hljs-attr"><span class="hljs-attr">password</span></span>: password }, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">e</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (e) { <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-string"><span class="hljs-string">"Error connecting:"</span></span>, e); wifi.disconnect(); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-string"><span class="hljs-string">"Wi-Fi OK, connecting to broker ..."</span></span>); mqtt.connect(); } });</code> </pre> <br>  Si tout va bien, connectez-vous au courtier MQTT. <br><br>  Une fois la connexion √©tablie, nous souscrivons √† des sujets int√©ressants, c'est-√†-dire tout ce qui commence par crapaud / ≈ìil. <br><br><pre> <code class="javascript hljs">mqtt.on(<span class="hljs-string"><span class="hljs-string">"connected"</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ mqtt.subscribe(<span class="hljs-string"><span class="hljs-string">"toad/eye/*"</span></span>); <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-string"><span class="hljs-string">"Connected to broker"</span></span>, brokerHostname); });</code> </pre> <br>  Lorsque nous recevons un message, nous d√©couvrons d'o√π il vient.  Ceci est tr√®s similaire √† une simple analyse d'URL.  Selon le sujet, nous d√©cidons quel ≈ìil nous allons influencer.  Si vous obtenez quelque chose de conscient, alors dans cet ≈ìil, nous √©crivons ce qui est arriv√© en ¬´charge utile¬ª en microsecondes. <br><br><pre> <code class="javascript hljs">mqtt.on(<span class="hljs-string"><span class="hljs-string">"message"</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">msg</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> eye = (msg.topic === <span class="hljs-string"><span class="hljs-string">"toad/eye/left"</span></span>) ? leftEye : (msg.topic === <span class="hljs-string"><span class="hljs-string">"toad/eye/right"</span></span>) ? rightEye : <span class="hljs-literal"><span class="hljs-literal">null</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (eye) { eye.write(<span class="hljs-built_in"><span class="hljs-built_in">Number</span></span>(msg.message), <span class="hljs-string"><span class="hljs-string">"us"</span></span>); } });</code> </pre> <br>  C'est toute la magie d'une grenouille. <br><br><h2>  Limitations d'Espruino JS </h2><br>  Nous sommes pass√©s sur la plate-forme Espruino.  Tordre les grenouilles n'est pas sa seule option.  Mais la plateforme a ses propres hauts-fonds, ce qui nous fait envisager d'autres options. <br><br>  <strong>¬´Total¬ª 1 √† 4 Mo de RAM</strong> .  Il y a une limitation sur la RAM.  Sur le code et les donn√©es en m√™me temps, seuls quelques m√©gaoctets sont donn√©s.  Il peut sembler qu'√† une √©poque o√π la RAM est mesur√©e par des concerts, cela ne suffit pas.  Mais pour un groupe de petits appareils, cela suffit.  √Ä 2 Mo, vous pouvez faire des choses magnifiques - assez pour la fontaine. <br><br>  <strong>Pas si simple avec NPM</strong> .  Ce probl√®me s'applique √† l'ESpruino IDE.  Si nous √©crivons ¬´exiger¬ª, Espruino regarde dans un endroit, dans un autre, et sinon, il produit un repli sur NPM.  √Ä ce stade, il peut ralentir.  Espruino n'est pas toujours capable de g√©rer des packages complexes.  Sa puissance en ce sens est bien inf√©rieure √† celle du m√™me Webpack ou Parcel.  C'est une douleur, mais si vous configurez la cha√Æne d'outils vous-m√™me, avec une compr√©hension de ce qui se passe √† l'int√©rieur du fer, il n'y a pas de probl√®me. <br><br>  <strong>Assortiment de fer.</strong>  Tous les composants mat√©riels appel√©s plates-formes de d√©veloppement ne tireront pas Espruino.  Selon les normes du monde des microcontr√¥leurs, Espruino est vorace - il a besoin de 500 Ko de RAM.  Une telle m√©moire ne donnera aucun morceau de fer.  L'Arduino Uno ou l'Arduino Nano canonique ne dispose que de 2 Ko de RAM - c'est donc impossible l√†-bas.  Il est possible de travailler avec Espruino sur le mat√©riel, ce que nous faisons sur le mat√©riel officiel d'Espruino. <br><br><img src="https://habrastorage.org/webt/gb/fx/9-/gbfx9-t4nskmti1hepnxlkz-lx0.png"><br><br>  Espruino est une entreprise compos√©e d'une seule personne qui va souvent sur Kickstarter avec de nouveaux produits et collecte toujours avec succ√®s.  Si vous souhaitez soutenir la plateforme - achetez officiellement. <br><br>  Il y a une troisi√®me option - prenez un devboard assez puissant, mais tiers.  Par exemple, la soci√©t√© ST, qui produit "Nucl√©aire" et "D√©couverte".  Le fer √©tiquet√© STM32 est susceptible de tirer l'Espruino. <br><br>  Passons en revue deux options alternatives.  Le premier est le Raspberry Pi. <br><br><h2>  Raspberry pi </h2><br><blockquote>  Il s'agit d'un ordinateur Linux complet de la taille d'une carte de visite. </blockquote><br><br><img src="https://habrastorage.org/webt/y_/af/ws/y_afwsgmlr9e7fvkesyrwlvobak.jpeg"><br><br>  De plus, il y a des broches d'entr√©e / sortie.  Si vous avez Raspberry Pi √† votre disposition, utilisez la topologie d'appareil suivante. <br><br><img src="https://habrastorage.org/webt/if/1a/jf/if1ajfsmxsvwwcap7ac_cpu8i2k.jpeg"><br><br>  Ici, le cloud est facultatif - un appareil mobile peut se connecter directement √† l'appareil via le nom d'h√¥te, l'API ou un syst√®me pour d√©tecter automatiquement un appareil sur le r√©seau.  J'ai un t√©l√©viseur intelligent et un disque dur de sauvegarde √† la maison.  Ils sont accessibles depuis tous les autres appareils simplement parce qu'ils sont sur le m√™me r√©seau local. <br><br>  Le principe est le m√™me.  Mettez l'appareil sur le Raspberry Pi sur le r√©seau et construisez le client afin qu'il s'y connecte directement via HTTP ou WebSocket, en contournant les interm√©diaires.  Le cloud utilise l'application sur Raspberry Pi √† ses fins: il enregistre des capteurs ou diffuse des pr√©visions m√©t√©orologiques. <br><br>  La prochaine topologie possible avec un backend complet. <br><br><img src="https://habrastorage.org/webt/if/1a/jf/if1ajfsmxsvwwcap7ac_cpu8i2k.jpeg"><br><br>  Le serveur monte dans le cloud.  Son client est la m√™me application mobile qui maintient une connexion via HTTP ou WebSocket.  D'autre part, la connexion est d√©j√† maintenue via le Raspberry Pi, en utilisant HTTP ou le m√™me MQTT. <br><br>  Dans cette approche, l'avantage est un contr√¥le total: validation, autorisation, refus aux clients.  Dans le m√™me temps, la disponibilit√© mondiale est un appareil √† Moscou, et la communication avec lui est disponible aupr√®s de Vladivostok. <br><br><h3>  Limitations de Raspberry Pi </h3><br>  <strong>Long chargement.</strong>  Raspberry Pi est un ordinateur complet et il faut du temps pour d√©marrer.  En tant que disque dur, une carte SD est utilis√©e.  M√™me la carte la plus rapide perd toujours un disque dur ordinaire, sans parler du SSD.  Avec le temps, la charge approche d'une minute. <br><br>  <strong>Le prochain inconv√©nient est la consommation d'√©nergie</strong> .  En termes d'efficacit√© √©nerg√©tique, parlons du Raspberry Pi comme appareil mobile.  Cela ne durera pas longtemps de la batterie - la facture va √† l'horloge.  Pour que l'appareil fonctionne pendant six mois ou un an, un programme comp√©tent pour le microcontr√¥leur et un jeu de piles sont n√©cessaires. <br><br>  <strong>Le mauvais GPIO est une entr√©e / sortie √† usage g√©n√©ral</strong> .  Les caract√©ristiques de l'alimentation des vagues, de la lecture des ondes, du travail avec des signaux analogiques au Raspberry Pi sont beaucoup plus faibles que celles des microcontr√¥leurs, pour lesquelles c'est la t√¢che principale.  Par exemple, hors de la bo√Æte sur un Raspberry Pi, il ne sera pas possible de contr√¥ler le servo en mode mat√©riel. <br><br><img src="https://habrastorage.org/webt/0r/sz/oj/0rszojmbxar2o-zhp26divehxj4.jpeg"><br><br>  La restriction est conditionnelle, car elle peut √™tre contourn√©e par l'extension.  Par exemple, le <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">morceau de</a> fer <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Troyka Cap</a> , qui prend tout le contr√¥le de bas niveau du travail avec les signaux sur lui-m√™me.  Raspberry Pi communique avec elle via un package de haut niveau.  Donne des commandes pour tordre le servo et cela fonctionne.  En utilisant ces cartes d'extension, vous pouvez connecter tout ce que vous voulez. <br><br><h2>  Arduino </h2><br>  Vous pouvez prendre l' <strong>Arduino</strong> habituel, dont tout le monde est fatigu√©.  Mais JavaScript devra √™tre d√©plac√© quelque part qui peut transformer Node JS - un vieil ordinateur ou le m√™me Raspberry Pi. <br><br><img src="https://habrastorage.org/webt/fc/z2/gx/fcz2gxhtqtz7gsoqbopfki6tlqm.jpeg"><br><br>  Nous connectons un vieil ordinateur inutile √† Arduino via un c√¢ble USB.  Dans Arduino, remplissez le firmware <a href="">Firmata</a> standard <a href="">une fois</a> .  Elle transforme Arduino en zombie qui suit les instructions d'un ma√Ætre - un vieil ordinateur.  Le ma√Ætre dit de transmettre tel ou tel signal √† telle ou telle broche, et Arduino transmet. <br><br>  Pour la communication, des biblioth√®ques avec NPM - <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">SerialPort</a> et Firmata avec une API claire sont utilis√©es.  Vous √™tes donc √† nouveau dans le monde JS, en train d'√©crire un programme de haut niveau que vous envoyez √† votre serveur.  Vous faites confiance √† Arduino pour travailler avec des signaux, et elle le fait. <br><br>  Pas toujours avec Firmata arrivera √† tout g√©rer.  Il est capable de fournir une interaction avec le mat√©riel auquel il est destin√©: servos, bandes LED, contr√¥leurs de m√©dia.  Mais si la capacit√© de lire un gyroscope ou un acc√©l√©rom√®tre tr√®s sp√©cifique n'est pas int√©gr√©e - cela ne fonctionnera pas.  Ensuite, vous devez √©crire un programme en C sur un Arduino ordinaire. <br><br>  Mais ce n'est pas tout - si vous ne voulez pas √©crire en C, utilisez l'outil Open Source <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">XOD.io.</a> <br><br><img src="https://habrastorage.org/webt/-p/-9/j0/-p-9j0ex1ngdm7pfdq-lv5dej9u.jpeg"><br><br>  Il s'agit d'un environnement de programmation visuelle o√π le graphique que vous construisez se transforme en code, et vous pouvez d√©j√† le compiler et le remplir.  XOD.io permet aux personnes qui ne sont pas famili√®res avec les subtilit√©s et les nuances de la programmation des microcontr√¥leurs de cr√©er rapidement des programmes simples.  Si vous avez grandi de Firmata, mais que vous ne ressentez toujours pas la force d'√©crire √† un bas niveau - utilisez XOD.io. <br><br><blockquote>  La prochaine conf√©rence <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">FrontendConf</a> se tiendra en octobre.  Vous connaissez JavaScript que la plupart des d√©veloppeurs frontaux ne connaissent pas, d√©veloppez des interfaces pratiques √† utiliser ou trouvez le graal des performances et √™tes pr√™t √† dire o√π il se trouve, nous <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">attendons des applications</a> pour les rapports. <br><br>  Nous recueillons des rapports int√©ressants dans le programme, des nouvelles de la conf√©rence, des vid√©os et des articles dans la newsletter r√©guli√®re - <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">inscrivez-vous</a> . </blockquote></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr450826/">https://habr.com/ru/post/fr450826/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr450816/index.html">En-t√™tes HTTP pour le d√©veloppeur responsable</a></li>
<li><a href="../fr450818/index.html">De la latence Ceph √©lev√©e au patch du noyau avec eBPF / BCC</a></li>
<li><a href="../fr450820/index.html">Comit√© du programme FrontendConf: cadres, horizons, exp√©rience mondiale et mission de la conf√©rence</a></li>
<li><a href="../fr450822/index.html">Cadres en voie de disparition</a></li>
<li><a href="../fr450824/index.html">L'√©tat du CSS</a></li>
<li><a href="../fr450828/index.html">Quand la ville s'endort ...</a></li>
<li><a href="../fr450830/index.html">Nikita Dubko sur les conf√©rences, le syndrome des imposteurs et les reportages</a></li>
<li><a href="../fr450832/index.html">L'histoire d'une animation</a></li>
<li><a href="../fr450834/index.html">Analyser les sites - et est-ce g√©n√©ralement l√©gal en Russie?</a></li>
<li><a href="../fr450836/index.html">Sur rails derri√®re les nuages: comment laver le verre dans un gratte-ciel</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>