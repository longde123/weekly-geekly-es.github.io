<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üöÅ ‚è¨ üö∫ Comment nous avons construit un r√©f√©rentiel rapide et fiable de vues d'annonces üë©‚Äçüë©‚Äçüë¶ üë©‚Äçüëß üíÜüèª</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="L'une des fonctions discr√®tes mais importantes de nos sites publicitaires est d'enregistrer et d'afficher le nombre de leurs vues. Nos sites regardent...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Comment nous avons construit un r√©f√©rentiel rapide et fiable de vues d'annonces</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/kolesa/blog/431902/"> L'une des fonctions discr√®tes mais importantes de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">nos sites publicitaires</a> est d'enregistrer et d'afficher le nombre de leurs vues.  Nos sites regardent les annonces depuis plus de 10 ans.  L'impl√©mentation technique de la fonctionnalit√© a r√©ussi √† changer plusieurs fois pendant ce temps, et maintenant c'est un (micro) service sur Go, travaillant avec Redis comme cache et file d'attente de t√¢ches, et avec MongoDB comme stockage persistant.  Il y a quelques ann√©es, il a appris √† travailler non seulement avec la somme des vues d'annonces, mais aussi avec les statistiques de chaque jour.  Mais il a appris √† faire tout cela tr√®s rapidement et de mani√®re fiable tout r√©cemment. <br><br><img src="https://habrastorage.org/webt/ee/nn/jp/eennjposwyrztis3a7s6cbkhq2e.png" alt="image"><br><br>  Au total, le service traite ~ 300 000 requ√™tes de lecture et ~ 9 000 requ√™tes d'√©criture par minute, dont 99% sont ex√©cut√©es jusqu'√† 5 ms.  Ce ne sont bien s√ªr pas des indicateurs astronomiques et non le lancement de fus√©es sur Mars - mais ce n'est pas non plus une t√¢che aussi banale qu'un simple stockage de nombres pourrait sembler.  Il s'est av√©r√© que faire tout cela, assurer un stockage de donn√©es sans perte et lire des valeurs coh√©rentes et pertinentes, n√©cessite un certain effort, dont nous discuterons ci-dessous. <br><a name="habracut"></a><br><h3>  T√¢ches et vue d'ensemble du projet </h3><br>  Bien que les compteurs de vues ne soient pas aussi critiques pour les entreprises que, par exemple, le traitement des paiements ou des <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">demandes de pr√™t</a> , ils sont tout d'abord importants pour nos utilisateurs.  Les gens sont fascin√©s par le suivi de la popularit√© de leurs annonces: certains appellent m√™me le support lorsqu'ils remarquent des informations de visualisation inexactes (cela s'est produit avec l'une des impl√©mentations de service pr√©c√©dentes).  De plus, nous stockons et affichons des statistiques d√©taill√©es dans les comptes personnels des utilisateurs (par exemple, pour √©valuer l'efficacit√© de l'utilisation des services payants).  Tout cela nous fait prendre soin de sauvegarder chaque √©v√©nement de visualisation et d'afficher les valeurs les plus pertinentes. <br><br>  En g√©n√©ral, la fonctionnalit√© et les principes du projet ressemblent √† ceci: <br><br><ul><li>  L'√©cran de la page Web ou de l'application fait une demande derri√®re les compteurs d'affichage des annonces (la demande est g√©n√©ralement asynchrone pour hi√©rarchiser la sortie des informations de base).  Et si la page de l'annonce elle-m√™me est affich√©e, le client vous demandera plut√¥t d'augmenter et de renvoyer le nombre de vues mis √† jour. </li><li>  En traitant les demandes de lecture, le service essaie d'obtenir des informations du cache Redis et compl√®te l'inconnu en compl√©tant une demande √† MongoDB. </li><li>  Les demandes d'√©criture sont envoy√©es √† 2 structures dans le radis: la file d'attente de mise √† jour incr√©mentielle (trait√©e en arri√®re-plan, de mani√®re asynchrone) et le cache du nombre total de vues. </li><li>  Un processus d'arri√®re-plan du m√™me service lit les √©l√©ments de la file d'attente, les accumule dans le tampon local et les √©crit p√©riodiquement dans MongoDB. </li></ul><br><h3>  Compteurs de vues d'enregistrement: pi√®ges </h3><br>  Bien que les √©tapes d√©crites ci-dessus semblent assez simples, le probl√®me ici est l'organisation de l'interaction entre la base de donn√©es et les instances de microservices afin que les donn√©es ne soient pas perdues, pas dupliqu√©es et pas retard√©es. <br><br>  L'utilisation d'un seul r√©f√©rentiel (par exemple, seulement MongoDB) r√©soudrait certains de ces probl√®mes.  En fait, le service fonctionnait auparavant, jusqu'√† ce que nous rencontrions des probl√®mes de mise √† l'√©chelle, de stabilit√© et de vitesse. <br><br>  Une impl√©mentation na√Øve du d√©placement des donn√©es entre les stockages pourrait conduire, par exemple, √† de telles anomalies: <br><br><ul><li>  Perte de donn√©es lors d'une √©criture comp√©titive dans le cache: <br><ol><li>  Le processus <b>A</b> augmente le nombre de vues dans le cache Redis, mais d√©couvre qu'il n'y a toujours pas de donn√©es pour cette entit√© (il peut s'agir d'une nouvelle d√©claration ou d'une ancienne qui a √©t√© extrud√©e du cache), donc le processus doit d'abord obtenir cette valeur de MongoDB. <br></li><li>  Le processus <b>A</b> obtient le nombre de vues de MongoDB - par exemple, le nombre 5;  puis y ajoute 1 et va √©crire dans Redis <b>6</b> . </li><li>  Le processus <b>B</b> (initi√©, par exemple, par un autre utilisateur du site qui a √©galement entr√© la m√™me annonce) fait de m√™me simultan√©ment. </li><li>  Le processus <b>A</b> √©crit une valeur de <b>6</b> dans Redis. </li><li>  Le processus <b>B</b> √©crit une valeur de <b>6</b> dans Redis. </li><li>  Par cons√©quent, une vue est perdue en raison de la course lors de l'enregistrement des donn√©es. <br>  <i>Le sc√©nario n'est pas si improbable: par exemple, nous avons un service payant qui place une annonce sur la page principale du site.</i>  <i>Pour une nouvelle annonce, un tel d√©roulement des √©v√©nements peut entra√Æner la perte de nombreuses vues √† la fois en raison de leur afflux soudain.</i> </li></ol></li><li>  Un exemple d'un autre sc√©nario est la perte de donn√©es lors du d√©placement de vues de Redis vers MongoDb: <br><br><ol><li>  Le processus r√©cup√®re une valeur en attente de Redis et la stocke en m√©moire pour une √©criture ult√©rieure dans MongoDB. </li><li>  Une demande d'√©criture √©choue (ou le processus se bloque avant d'√™tre ex√©cut√©). </li><li>  Les donn√©es sont √† nouveau perdues, ce qui deviendra apparent la prochaine fois que la valeur mise en cache sera pouss√©e et remplac√©e par la valeur de la base de donn√©es. </li></ol><br></li></ul><br>  D'autres erreurs peuvent se produire, dont les raisons r√©sident √©galement dans la nature non atomique des op√©rations entre les bases de donn√©es, par exemple, un conflit lors de la suppression et de l'augmentation des vues de la m√™me entit√©. <br><br><h3>  Enregistrement du nombre de vues: solution </h3><br>  Notre approche du stockage et du traitement des donn√©es dans ce projet est bas√©e sur l'hypoth√®se qu'√† tout moment, MongoDB peut √©chouer plus probablement que Redis.  Bien s√ªr, ce n'est pas une <i>r√®gle</i> absolue - du moins pas pour chaque projet - mais dans notre environnement, nous sommes vraiment habitu√©s √† observer des d√©lais d'expiration p√©riodiques pour les requ√™tes dans MongoDB caus√©s par la performance des op√©rations sur disque, ce qui √©tait auparavant l'une des raisons de la perte de certains √©v√©nements. <br><br>  Pour √©viter bon nombre des probl√®mes mentionn√©s ci-dessus, nous utilisons des files d'attente de t√¢ches pour l'enregistrement diff√©r√© et des lua-scripts, qui permettent de modifier atomiquement les donn√©es dans plusieurs structures de radis √† la fois.  Dans cet esprit, les d√©tails de l'enregistrement des vues sont les suivants: <br><br><ol><li>  Lorsqu'une demande d'√©criture tombe dans le microservice, elle ex√©cute le script lua <b>IncrementIfExists</b> pour augmenter le compteur uniquement s'il existe d√©j√† dans le cache.  Le script renvoie imm√©diatement <b>-1</b> s'il n'y a pas de donn√©es pour l'entit√© visualis√©e dans le radis;  sinon, il augmente la valeur des vues dans le cache via <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">HINCRBY</a> , ajoute l'√©v√©nement √† la file d'attente pour un stockage ult√©rieur dans MongoDB (appel√© <i>file d'attente en attente par</i> nous) via <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">LPUSH</a> , et renvoie la quantit√© de vues mise √† jour. <br></li><li>  Si IncrementIfExists renvoie un nombre positif, cette valeur est renvoy√©e au client et la demande se termine. <br><br>  Sinon, le microservice r√©cup√®re le compteur de vues de MongoDb, l'incr√©mente de 1 et l'envoie au radis. <br></li><li>  L'√©criture sur le radis se fait via un autre lua-script - <b>Upsert</b> - qui enregistre la quantit√© de vues dans le cache s'il est encore vide, ou les augmente de 1 si quelqu'un d'autre a r√©ussi √† remplir le cache entre les √©tapes 1 et 3. <br></li><li>  Upsert ajoute √©galement un √©v√©nement d'affichage √† la file d'attente en attente et renvoie un montant mis √† jour, qui est ensuite envoy√© au client. <br></li></ol><br>  Du fait que les scripts lua <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">sont ex√©cut√©s de mani√®re atomique</a> , nous √©vitons de nombreux probl√®mes potentiels qui pourraient √™tre caus√©s par une √©criture comp√©titive. <br><br>  Un autre d√©tail important est d'assurer le transfert s√©curis√© des mises √† jour de la file d'attente en attente vers MongoDB.  Pour ce faire, nous avons utilis√© le mod√®le de ¬´file d'attente fiable¬ª d√©crit dans la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">documentation Redis</a> , qui r√©duit consid√©rablement les risques de perte de donn√©es en cr√©ant une copie des √©l√©ments trait√©s dans une autre file d'attente jusqu'√† ce qu'ils soient finalement stock√©s dans un stockage persistant. <br><br>  Pour mieux comprendre l'ensemble des √©tapes du processus, nous avons pr√©par√© une petite visualisation.  Tout d'abord, regardons un sc√©nario normal et r√©ussi (les √©tapes sont num√©rot√©es dans le coin sup√©rieur droit et sont d√©crites en d√©tail ci-dessous): <br><br><img src="https://habrastorage.org/webt/0v/al/bq/0valbqz3kj6du62z0foxfcb6bay.gif" alt="image"><br><br><ol><li>  Le microservice re√ßoit une demande d'√©criture </li><li>  Le gestionnaire de requ√™tes la transmet √† un lua-script qui √©crit la recherche dans le cache (la rendant imm√©diatement lisible) et dans la file d'attente pour un traitement ult√©rieur. </li><li>  Le goroutine d'arri√®re-plan effectue (p√©riodiquement) l'op√©ration <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">BRPopLPush</a> , qui d√©place atomiquement un √©l√©ment d'une file d'attente √† une autre (nous l'appelons ¬´file d'attente de traitement¬ª - une file d'attente avec des √©l√©ments actuellement trait√©s).  Le m√™me √©l√©ment est ensuite stock√© dans un tampon de la m√©moire de processus. <br></li><li>  Une autre demande d'√©criture arrive et est en cours de traitement, ce qui nous laisse 2 √©l√©ments dans le tampon et 2 √©l√©ments dans la file d'attente de traitement. </li><li>  Apr√®s un certain d√©lai, le processus d'arri√®re-plan d√©cide de vider le tampon dans MongoDB.  L'√©criture de plusieurs valeurs √† partir du tampon est effectu√©e par une seule demande, ce qui affecte positivement le d√©bit.  De plus, avant l'enregistrement, le processus essaie de combiner plusieurs vues en une seule, en r√©sumant leurs valeurs pour les m√™mes annonces. <br>  <i>Sur chacun de nos projets, 3 instances de microservices sont utilis√©es, chacune avec son propre tampon, qui est enregistr√© dans la base de donn√©es toutes les 2 secondes.</i>  <i>Pendant ce temps, environ 100 √©l√©ments sont accumul√©s dans un seul tampon.</i> <i><br></i> </li><li>  Apr√®s une √©criture r√©ussie, le processus supprime les √©l√©ments de la file d'attente de traitement, signalant que le traitement s'est termin√© avec succ√®s. <br></li></ol><br>  Lorsque tous les sous-syst√®mes sont en ordre, certaines de ces √©tapes peuvent sembler redondantes.  Et le lecteur attentif peut √©galement avoir une question sur ce que fait le gopher dormant dans le coin inf√©rieur gauche. <br>  Tout est expliqu√© lorsque l'on consid√®re le sc√©nario o√π MongoDB n'est pas disponible: <br><br><img src="https://habrastorage.org/webt/hl/jd/bs/hljdbsmwzxn6i2k5xfgj2mm02em.gif" alt="Un exemple de service lorsque MongoDB plante"><br><br><ol><li>  La premi√®re √©tape est identique aux √©v√©nements du sc√©nario pr√©c√©dent: le service re√ßoit 2 demandes d'enregistrement des vues et les traite. <br></li><li>  Le processus perd la connexion avec MongoDB (le processus lui-m√™me, bien s√ªr, ne le sait pas encore). <br>  Le gestionnaire Gorutin, comme pr√©c√©demment, essaie de vider son tampon dans la base de donn√©es - mais cette fois sans succ√®s.  Elle revient √† attendre la prochaine it√©ration. <br></li><li>  Un autre goroutine d'arri√®re-plan se r√©veille et v√©rifie la file d'attente de traitement.  Elle d√©couvre que les √©l√©ments lui ont √©t√© ajout√©s il y a longtemps;  concluant que leur traitement a √©chou√©, elle les replace dans la file d'attente. <br></li><li>  Apr√®s un certain temps, la connexion avec MongoDB est r√©tablie. <br></li><li>  Le premier goroutine d'arri√®re-plan essaie √† nouveau d'effectuer une op√©ration d'√©criture - cette fois avec succ√®s - et supprime d√©finitivement les √©l√©ments de la file d'attente de traitement. <br></li></ol><br>  Dans ce sch√©ma, il existe plusieurs d√©lais d'attente et heuristiques importants d√©riv√©s des tests et du bon sens: par exemple, les √©l√©ments sont d√©plac√©s de la file d'attente de traitement vers la file d'attente en attente apr√®s 15 minutes d'inactivit√©.  De plus, le goroutine responsable de cette t√¢che effectue un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">verrouillage</a> avant l'ex√©cution afin que plusieurs instances du microservice n'essaient pas de restaurer les vues ¬´fig√©es¬ª en m√™me temps. <br><br>  √Ä strictement parler, m√™me ces mesures n'offrent pas de garanties th√©oriquement justifi√©es (par exemple, nous ignorons des sc√©narios comme le processus se bloque pendant 15 minutes) - mais en pratique, cela fonctionne de mani√®re assez fiable. <br><br>  De plus, dans ce sch√©ma, il y a au moins 2 autres vuln√©rabilit√©s connues que nous devons conna√Ætre: <br><br><ul><li>  Si le microservice est tomb√© en panne imm√©diatement apr√®s avoir enregistr√© avec succ√®s dans MongoDb, mais avant d'effacer la liste de files d'attente de traitement, ces donn√©es seront consid√©r√©es comme non enregistr√©es - et apr√®s 15 minutes seront √† nouveau enregistr√©es. <br>  <i>Pour r√©duire la probabilit√© d'un tel sc√©nario, nous avons fourni des tentatives r√©p√©t√©es de suppression de la file d'attente de traitement en cas d'erreurs.</i>  <i>En r√©alit√©, nous n'avons pas encore observ√© de tels cas en production.</i> <br></li><li>  Lorsque vous red√©marrez, le radis peut perdre non seulement le cache, mais √©galement certaines vues non enregistr√©es des files d'attente, car il est configur√© pour enregistrer p√©riodiquement des <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">instantan√©s RDB</a> toutes les quelques minutes. <br>  <i>Bien qu'en th√©orie cela puisse √™tre un probl√®me s√©rieux (surtout si le projet traite de donn√©es vraiment critiques), en pratique les n≈ìuds sont extr√™mement rarement red√©marr√©s.</i>  <i>Dans le m√™me temps, selon la surveillance, les √©l√©ments passent dans les files d'attente pendant moins de 3 secondes, c'est-√†-dire que le montant possible des pertes est tr√®s limit√©.</i> <br></li></ul><br>  Il peut sembler qu'il y a plus de probl√®mes que nous ne le souhaiterions.  Cependant, en fait, il s'av√®re que le sc√©nario que nous avons initialement d√©fendu - l'√©chec de MongoDB - est en effet une menace bien plus r√©elle, et le nouveau sch√©ma de traitement des donn√©es garantit avec succ√®s la disponibilit√© du service et √©vite les pertes. <br><br>  Un exemple frappant de cela √©tait lorsque l'instance MongoDB √† l'un des projets √©tait absurdement indisponible toute la nuit.  Pendant tout ce temps, le nombre de vues accumul√©es et tourn√©es dans un radis d'une file d'attente √† une autre, jusqu'√† ce qu'elles soient finalement enregistr√©es dans la base de donn√©es apr√®s la r√©solution de l'incident;  la plupart des utilisateurs n'ont m√™me pas remarqu√© l'√©chec. <br><br><h3>  Lecture en lecture compte </h3><br>  Les demandes de lecture sont beaucoup plus simples que les demandes d'√©criture: le microservice v√©rifie d'abord le cache dans le radis;  tout ce qui ne se trouve pas dans le cache est rempli avec des donn√©es de MongoDb et retourn√© au client. <br><br>  Il n'y a pas d'√©criture de bout en bout dans le cache pendant les op√©rations de lecture pour √©viter la surcharge de protection contre les √©critures concurrentes.  Le taux de r√©ussite du cache reste bon, car le plus souvent, il sera d√©j√† r√©chauff√© gr√¢ce √† d'autres demandes d'√©criture. <br><br>  Les statistiques de vue quotidiennes sont lues directement √† partir de MongoDB, car elles sont demand√©es beaucoup moins souvent et la mise en cache est plus difficile.  Cela signifie √©galement que lorsque la base de donn√©es n'est pas disponible, la lecture des statistiques cesse de fonctionner;  mais cela n'affecte qu'une petite partie des utilisateurs. <br><br><h3>  Sch√©ma de stockage des donn√©es MongoDB </h3><br>  Le sch√©ma de collecte MongoDB pour le projet est bas√© sur <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ces recommandations des d√©veloppeurs de bases de donn√©es eux</a> - <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">m√™mes</a> et ressemble √† ceci: <br><br><ul><li>  Les vues sont enregistr√©es dans 2 collections: dans l'une il y a leur montant total, dans l'autre - les statistiques par jour. <br></li><li>  Les donn√©es de la collecte de statistiques sont organis√©es sur la base d' <b>un document par annonce et par mois</b> .  Pour les nouvelles annonces, un document rempli de trente et un z√©ro pour le mois en cours est ins√©r√© dans la collection;  Selon l'article mentionn√© ci-dessus, cela vous permet d'allouer imm√©diatement suffisamment d'espace pour un document sur le disque afin que la base de donn√©es n'ait pas √† le d√©placer lors de l'ajout de donn√©es. <br>  <i>Cet √©l√©ment rend le processus de lecture des statistiques un peu d√©licat (les demandes doivent √™tre g√©n√©r√©es par mois du c√¥t√© du microservice), mais dans l'ensemble, le sch√©ma reste assez intuitif.</i> <br></li><li>  L'op√©ration <b>upsert</b> est utilis√©e pour l'enregistrement, afin de mettre √† jour et, si n√©cessaire, de cr√©er un document pour l'entit√© souhait√©e dans la m√™me requ√™te. <br></li></ul><br>  Nous n'utilisons pas les capacit√©s transactionnelles de MongoDb pour mettre √† jour plusieurs collections en m√™me temps, ce qui signifie que nous risquons que les donn√©es puissent √™tre √©crites dans une seule collection.  Pour le moment, nous nous connectons simplement √† de tels cas;  il y en a peu, et jusqu'√† pr√©sent, cela ne pr√©sente pas le m√™me probl√®me important que d'autres sc√©narios. <br><br><h3>  Test </h3><br>  Je ne ferais pas confiance √† mes propres mots que les sc√©narios d√©crits fonctionnent vraiment s'ils n'√©taient pas couverts par des tests. <br><br>  √âtant donn√© que la plupart du code du projet fonctionne en √©troite collaboration avec les radis et MongoDb, la plupart des tests qu'il contient sont des tests d'int√©gration.  L'environnement de test est pris en charge par docker-compose, ce qui signifie qu'il peut √™tre d√©ploy√© rapidement, offre une reproductibilit√© en r√©initialisant et en restaurant l'√©tat √† chaque d√©marrage, et permet d'exp√©rimenter sans affecter les bases de donn√©es d'autres personnes. <br><br>  Dans ce projet, il existe 3 principaux domaines de test: <br><br><ol><li>  Validation de la logique m√©tier dans des sc√©narios typiques, les soi-disant  chemin heureux.  Ces tests r√©pondent √† la question - lorsque tous les sous-syst√®mes sont en ordre, le service fonctionne-t-il conform√©ment aux exigences fonctionnelles? </li><li>  V√©rification des sc√©narios n√©gatifs dans lesquels le service devrait poursuivre son travail.  Par exemple, le service ne perd-il vraiment pas de donn√©es lorsque MongoDb plante? <br>  Sommes-nous s√ªrs que les informations restent coh√©rentes avec les d√©lais d'expiration p√©riodiques, les blocages et les op√©rations d'enregistrement concurrentielles? </li><li>  V√©rification des sc√©narios n√©gatifs dans lesquels nous ne nous attendons pas √† ce que le service continue, mais un niveau minimum de fonctionnalit√© doit toujours √™tre fourni.  Par exemple, il n'y a aucune chance que le service continue d'enregistrer et de renvoyer des donn√©es lorsque ni radis ni mongo ne sont disponibles - mais nous voulons √™tre s√ªrs que, dans de tels cas, il ne se bloque pas, mais attend la r√©cup√©ration du syst√®me, puis revient au travail. </li></ol><br>  Pour v√©rifier les sc√©narios infructueux, le code de logique m√©tier de service fonctionne avec les interfaces client de base de donn√©es, qui dans les tests n√©cessaires sont remplac√©es par des impl√©mentations qui renvoient des erreurs et / ou simulent des retards r√©seau.  Nous simulons √©galement le fonctionnement parall√®le de plusieurs instances de service en utilisant le mod√®le " <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">objet environnement</a> ".  Il s'agit d'une variante de l'approche bien connue ¬´d'inversion de contr√¥le¬ª, o√π les fonctions n'acc√®dent pas aux d√©pendances elles-m√™mes, mais les re√ßoivent via l'objet d'environnement pass√© dans les arguments.  Entre autres avantages, l'approche vous permet de simuler plusieurs copies ind√©pendantes du service en un seul test, chacune ayant son propre pool de connexions √† la base de donn√©es et reproduisant plus ou moins efficacement l'environnement de production.  Certains tests ex√©cutent chacune de ces instances en parall√®le et s'assurent qu'ils voient tous les m√™mes donn√©es, et il n'y a pas de conditions de concurrence. <br><br>  Nous avons √©galement effectu√© un test de r√©sistance rudimentaire, mais toujours tr√®s utile, bas√© sur <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">si√®ge</a> , qui a permis d'estimer approximativement la charge admissible et la vitesse de r√©ponse du service. <br><br><h3>  √Ä propos des performances </h3><br>  Pour 90% des demandes, le temps de traitement est tr√®s court et, surtout, stable;  Voici un exemple de mesures sur l'un des projets sur plusieurs jours: <br><br><img src="https://habrastorage.org/webt/ln/bk/zy/lnbkzy7-wnykbaelv4vzsd8b53q.png" alt="image"><br><br>  Fait int√©ressant, un enregistrement (qui est en fait une op√©ration d'√©criture + lecture, car il renvoie des valeurs mises √† jour) est l√©g√®rement plus rapide que la lecture (mais uniquement du point de vue d'un client qui n'observe pas l'√©criture en attente r√©elle). <br>  Une augmentation r√©guli√®re des retards le matin est un effet secondaire du travail de notre √©quipe d'analyse, qui recueille quotidiennement ses propres statistiques sur la base des donn√©es du service, cr√©ant pour nous une ¬´surcharge artificielle¬ª. <br><br>      :           (          ‚Äî          MongoDB),       (      ),     : <br><br><img src="https://habrastorage.org/webt/6f/pz/v9/6fpzv9b8lmswdsjhmrn4gk_qugw.png" alt="image"><br><br><h3>  Conclusion </h3><br> ,  -  , ,   Redis                . <br><br>       , 95%    ,     .      ,                .           5. <br><br>        Go, Redis  MongoDB             .                 ,       .         ,      ‚Äî      . </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr431902/">https://habr.com/ru/post/fr431902/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr431888/index.html">¬´Je pense que les id√©es d'√©quipe sont les plus importantes lors du d√©veloppement d'un produit.¬ª</a></li>
<li><a href="../fr431890/index.html">Comment passer une commande sur la bourse ind√©pendante</a></li>
<li><a href="../fr431892/index.html">Nous utilisons Veeam Backup & Replication pour tester de nouveaux syst√®mes et applications avant la mise √† niveau</a></li>
<li><a href="../fr431894/index.html">En d√©cembre, ils d√©cideront de l'enregistrement obligatoire des stations de base LPWAN</a></li>
<li><a href="../fr431898/index.html">Il s'agit d'Agile - 2: Fonctionnalit√©s d'impl√©mentation Agile</a></li>
<li><a href="../fr431904/index.html">Comment nous avons d√©charg√© les sp√©cialistes RH: informations pour l'√©mission des feuilles de paiement</a></li>
<li><a href="../fr431906/index.html">PIFR - une m√©thode pour g√©n√©rer un masque 3D, quel que soit l'angle de rotation du visage</a></li>
<li><a href="../fr431908/index.html">Configuration de l'API Tinkoff Bank. Comment est votre intuition ....? Ou une chanson sur Oauth 2.0</a></li>
<li><a href="../fr431910/index.html">PSEFABRIC - une nouvelle approche de la gestion et de l'automatisation des r√©seaux. Pas √† l'id√©al</a></li>
<li><a href="../fr431912/index.html">Le plus gros bot-no a √©t√© arr√™t√© aux √âtats-Unis: qu'est-ce que cela signifie pour la communaut√© num√©rique?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>