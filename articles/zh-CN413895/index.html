<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🆔 🐉 👁️ 抢便宜的健身手镯 🤷🏿 🆕 🔋</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="这是翻译。 文章发表于2018年5月27日 


 健身追踪器拆卸前后 

 当我来到现任公司时，第一天给了我一套礼物。 其中包括带健身追踪器的手链。 无论您热爱运动，从纯技术角度来看，这都是一个非常酷的小工具： 



- 很小的外形尺寸（约15×40毫米）； 
- 低功耗蓝牙（BLE）; 
- ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>抢便宜的健身手镯</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/413895/">  <font color="gray">这是翻译。</font>  <font color="gray"><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">文章</a>发表于2018年5月27日</font> <br><br><img src="https://habrastorage.org/webt/4n/-9/ah/4n-9ah3fvyxx23aobpo2tvx0jg4.jpeg"><br>  <i><font color="gray">健身追踪器拆卸前后</font></i> <br><br> 当我来到现任公司时，第一天给了我一套礼物。 其中包括带健身追踪器的手链。 无论您热爱运动，从纯技术角度来看，这都是一个非常酷的小工具： <br><br><ul><li> 很小的外形尺寸（约15×40毫米）； </li><li> 低功耗蓝牙（BLE）; </li><li>  OLED显示屏（96×32像素）; </li><li> 电池 </li><li>  USB充电 </li><li> 加速度计 </li><li> 振动马达 </li><li> 价格大约是10美元（！）。 </li></ul><a name="habracut"></a><br> 在外面，后面板上唯一的标识符是标贴“ FCC ID：2AHFTID115”。 如果您用它搜索，它似乎与<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">ID115</a>设备相对应，甚至可以找到其内部的<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">几张照片</a> 。 回顾<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">其中一张照片</a> ，如果您努力尝试，您会看到最大的集成电路（IC）的名称：N51822。 这表明可能存在<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Nordic</a>微控制器（MCU） <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">nRF51822</a> ，这是一种具有内置BLE支持的32位ARM M0处理器，从理论上讲，它很容易编程为手镯应做的其他事情。 <br><br> 在拆卸小工具之前，我松了一口气，发现在<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">一些类似的手镯中</a> ，安装了相同的芯片，人们成功地对其进行了编程。 <br><br> 打开案件并非易事。 黑色塑料盖粘在灰色背景上。 我尝试使用吹风机软化胶水，然后耐心地用小刀将其切开，以免损坏塑料。 打开后，我确保确实有nRF51822。 后来我从德州仪器（TI）购买了几乎完全相同的MCU手镯。 请记住，有很多选择。 <br><br> <a href=""><img src="https://habrastorage.org/getpro/habr/post_images/2e6/0af/a75/2e60afa757e9f5859408e49d7f76e54f.jpg"></a> <br>  <i><font color="gray">nRF51822和圆珠笔用于刻度</font></i> <br><br><h1> 寻找一种沟通方式 </h1><br> 该<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">文档</a>说，可以使用ARM <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">串行线调试</a> （SWD）两针接口对芯片进行编程/调试。 如果我们要与芯片建立通信通道，则意味着两件事： <br><br><ul><li> 我们需要一个SWD程序员（例如<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Segger J-Link</a> ）。 </li><li> 我们将需要访问微控制器上的两个SWD引脚，即SWDIO（数据）和SWDCLK（时钟脉冲）。 </li></ul><br> 幸运的是，板上有几个焊盘。 尽管通过调试，测试和验证的需要可以清楚地说明它们的存在，但我更倾向于认为一些出色的工程师将它们作为礼物送给像我们这样的人。 并非所有标签都正确标记，因此我建议使用以下代码： <br><br><img src="https://habrastorage.org/webt/fc/gd/y9/fcgdy9fj-73b3cdtcsbgdqdjovw.jpeg"><br><br><img src="https://habrastorage.org/webt/et/-t/_4/et-t_46am8apprgxc3mtkyyg0gq.jpeg"><br>  <i><font color="gray">电路板的正面和背面。</font></i>  <i><font color="gray">圆珠笔，用于刻度盘和半任意名称的开口垫</font></i> <br><br> 使用相同的廉价<a href="">USB显微镜，</a>我拍摄了电路板正面和背面的几张照片，并试图跟踪从微控制器到焊盘的轨迹。 <br><br><img src="https://habrastorage.org/webt/pc/oe/-h/pcoe-ha9fus65p5oenznunhxx30.jpeg"><br><br><img src="https://habrastorage.org/webt/nk/hy/ed/nkhyedqu2al7dvuxmbqs8ns9g9u.jpeg"><br>  <i><font color="gray">跟踪板正面和背面的SWDIO和SWDCLK引脚</font></i> <br><br> 请注意，这是带有通孔的多层印刷电路板，因此您应检查电路板两侧的走线。 从这些照片中，您可以跟踪从芯片上的触点SWDIO和SWDCLK到焊盘IO和CLK的轨迹。 因此，我们将确保板上的CLK标记与MCU上的SWDCLK对应，并且未标记的触点为SWDIO引脚。 现在，您可以准备我们的第一个映射表： <br><br><table><tbody><tr><th>  NRF51822针 </th><th> 游乐场 </th><th> 内容描述 </th></tr><tr><td> 软件 </td><td>  IO </td><td> 数据输出用于SWD编程 </td></tr><tr><td> 时钟 </td><td> 时钟 </td><td>  SWD编程的时钟输出 </td></tr></tbody></table><br><h1> 验尸手术 </h1><br> 获得了两个SWD焊盘后，我将非常细的电线焊接到了它们以及所有其他可用的触点上。 <br><br> <a href=""><img src="https://habrastorage.org/webt/hf/cm/6j/hfcm6jaswn6gf08oxc8ypaehmtu.jpeg"></a> <br><br><h1> 眨一下 </h1><br> 下一个任务是尝试对设备进行编程以完成某些任务。 要运行最简单的程序，我们需要确保以下几点： <br><br><ul><li> 我们正确地跟踪了SWDIO / SWDCLK的触点。 </li><li>  SWD编程器正在运行，计算机可以发出命令。 </li><li> 我们可以编译Arm程序并正确使用<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Nordic SDK</a> 。 </li><li> 我们可以将编译后的程序闪存到芯片中。 </li><li> 该芯片可以正常工作并加载我们的程序。 </li></ul><br> 在这种情况下，“ hello，world”可以是打开和关闭LED的程序。 甚至这都不是基本的，因为板上没有内置LED，并且如果您添加一个外部LED，您仍然需要弄清楚将其连接到什么位置。 这为问题的空间模型增加了另一个维度。 由于缺乏免费的奶酪定理，我只将两个LED连接到引脚<code>P1</code>和<code>P2</code> ，希望我们可以使用MCU来连接这些焊盘。 <br><br> <a href=""><img src="https://habrastorage.org/webt/vj/t0/ab/vjt0abxchpbfjiyq87acqsyq4n4.jpeg"></a> <br>  <i><font color="gray">糟糕的一天</font></i> <br><br>  J-Link SWD编程器的驱动程序和命令行程序位于<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Segger网站上</a> 。 如果您使用macOS并使用Homebrew，请在<code>caskroom/drivers/segger-jlink</code>查找Cask公式。 通过<code>JLinkExe</code>命令行<code>JLinkExe</code>程序可建立与SWD程序员的通信。 <br><br> 然后，我下载了<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Nordic nRF5 SDK</a> （我正在使用<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">版本12.3.0</a> ）。 从SDK示例中可以明显看出，我们需要一个能够编译Arm程序的编译器。 因此，我安装了<code>gcc-arm-embedded</code> （也可以在Homebrew上找到）。 <br><br> 在查看了SDK文档和Nordic开发者论坛之后，我发现他们的SDK最常与<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">此类</a>开发板一起使用。  SDK已针对此类板的多种变体进行了预配置。 由于我们直接与控制器联系，因此您必须配置一些SDK参数。 <br><br> 我花了<i>很多</i>时间来了解nRF5生态系统，但最终我仍然能够在芯片上运行该程序！  <a href="">视频</a>显示两个闪烁的LED。 至此，我创建<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">了一个Github存储库，</a>并在其中转储了带有可用<code>Makefile</code>的程序。 主要秘密之一是，实际上nRF51822有多种选择，而在我的内存中只有16 KB的内存。 因此，我仍然必须<a href="">修复链接脚本</a> 。 <br><br><h1> 数字量输入/输出 </h1><br> 就像我已经说过的那样，LED闪烁的任务提供了一些希望和解决方法，MCU触点中的哪一个通向LED所连接的<code>P1</code>和<code>P2</code> 。 最简单的策略是依次连接所有输出并依次施加高低压。 令我惊讶的是，两个LED都亮了！ 振动马达开始工作时，我感到更加惊讶！ <br><br> 因此，将poke方法添加到表中： <br><br><table><tbody><tr><th>  NRF51822针 </th><th> 游乐场 </th><th> 内容描述 </th></tr><tr><td>  P0.30 </td><td>  P1 </td><td> 数字GPIO </td></tr><tr><td>  P0.00 </td><td>  P2 </td><td> 数字GPIO </td></tr><tr><td>  P0.01 </td><td>  -- </td><td> 振动马达 </td></tr></tbody></table><br><h1> 打印 </h1><br> 对于调试来说，将数据传输到计算机的能力是必不可少的。  J-Link编程器支持<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">实时传输（RTT），</a>用于从芯片发送和接收数据。 要使用RTT，您需要<code>#include "SEGGER_RTT.h"</code>并调用<code>SEGGER_RTT_WriteString()</code> 。 要在计算机上接收数据，请调用<code>jlinkrttlogger</code>提供的<code>jlinkrttlogger</code>命令行<code>jlinkrttlogger</code> 。 <br><br><h1> 有机发光二极管 </h1><br> 另一个挑战是使OLED正常工作。 市场上最常见的OLED运行<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">ssd1306</a>驱动器/控制器，通常通过使用<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">SPI</a>或<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">I²C</a>的串行接口与MCU进行通信。 这是<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Adafruit的一个例子</a> 。 <br><br> 我在任何一家普通商店中都找不到这种显示器。  96×32的尺寸为非标准尺寸。 在显示屏上按标识符QT1316P01A进行搜索可找到类似<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Aliexpress的</a>中文站点，但是除结论名称外没有任何文档： <br><br><img src="https://habrastorage.org/webt/jh/we/dj/jhwedjuvdabshgmklscu3wk6edi.png"><br>  <i><font color="gray">使用Aliexpress命名OLED引脚</font></i> <br><br> 如果列表不存在，则联系人<code>SCL</code> ， <code>SDA</code>和<code>RES#</code>告诉我们这是I²C选项。 如果nRF51822的三个引脚和OLED的这三个引脚之间有走线，那么我们将向前迈出一步。 让我们回到显微镜。 <br><br><img src="https://habrastorage.org/webt/vw/dg/9d/vwdg9dxuopykb2umzrjt1zskvv4.jpeg"><br><br><img src="https://habrastorage.org/webt/zq/zl/ym/zqzlymrnmspwkcroh4argcj_udo.jpeg"><br>  <i><font color="gray">OLED数据接触轨迹</font></i> <br><br> 我们更新对应表： <br><br><table><tbody><tr><th>  NRF51822针 </th><th> 游乐场 </th><th> 内容描述 </th></tr><tr><td>  P0.21 </td><td>  -- </td><td>  OLED SDA输出 </td></tr><tr><td>  P0.22 </td><td>  -- </td><td>  OLED SCL引脚 </td></tr><tr><td>  P0.24 </td><td>  -- </td><td> 输出OLED RES＃ </td></tr></tbody></table><br>  I²C协议比任何简单的串行协议（如<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">UART）</a>都要先进得多。 优点之一是它在同一总线上支持多个主设备和从设备。 这使事情变得有些复杂：至少您需要告诉MCU发出了哪些从属命令。 因此，在高层次上，除了物理接触之外，OLED显示器还有一个“逻辑”地址。 <br><br> 幸运的是，nRF5 SDK中的一个示例是I²C扫描仪。 他从所有可能的逻辑地址中询问，并报告是否在其中安装了某些内容。 我的修改版本在<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">这里</a> 。 它产生以下日志： <br><br> <code>$ make <br> # ... <br> $ make flash <br> # ... <br> $ make log <br> # ... <br> TWI scanner. <br> TWI device detected at 0x3c.</code> <br> <br> 好消息！ 我们有充分的理由相信显示器可以正确识别，并且确实是I²C变体。  <code>0x3c</code>搜索显示<code>0x3c</code>是此类设备的典型地址。 <br><br> 现在我们准备将一些像素发送到显示器。 在这个级别上，没有通过库的抽象。  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">有关</a>传输数据的低级方法， <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">请参见ssd1306</a>文档。 该过程由一系列配置命令组成，这些命令可设置显示方向，记录模式，大小等。 然后，将屏幕上显示的字节序列发送到图形显示内存（GDDRAM）。 <br><br> 为了获得正确的配置，我研究<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">了Adafruit的ssd1306库，</a>并尝试模拟类似的命令。 这就是该项目中大部分时间所花费的时间。 找出所有细节是一项非常耗时的任务，但我仍然无法解释某些事情。 但是，它有效！ <br><br> <a href=""><img src="https://habrastorage.org/webt/lr/ix/r7/lrixr7dxh_7j9098jx677drocxm.jpeg"></a> <br>  <i><font color="gray">显示硬编码位图</font></i> <br><br> 此示例的代码<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">在此处</a> 。 <br><br> 通过这些设置，显示分为4行（页面）和96列。 因此页面高8像素。 发送的第一个字节将“垂直”位于第一页的第一列中。 当第二个字节<i>返回</i>并从第二页的第一列开始时，它将占据第二列，然后是第三列，依此类推，直到第96列。 <br><br> 这是<i>预期的</i>行为。 如<a href="">视频所示</a> ， <i>观察到的</i>行为是不同的：首先填充奇数列，然后填充偶数列，然后返回第二页。 <br><br> 我花了很多时间来了解这种愚蠢的显示行为的原因，然后花更多的时间来配置它来解决它。 最后，我吞下了骄傲，仍然在程序中实现了一个奇怪的渲染逻辑来完成它。 <br><br><h1> 前往Arduino </h1><br> 深入研究Arduino <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">的Adafruit ssd1306库</a> ，我一直认为，有一种方法可以“模拟”特定的Arduino位以在nRF51822上对其进行测试，将是一件很不错的事情。 事实证明，更多有经验的人也想到了这个主题-这就是惊人的<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">sandeepmistry / arduino-nRF5</a>项目<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">所做的</a> 。 它使用nRF5 SDK实现了主要的Arduino库。 <br><br> 通过这个项目，我们可以打开Arduino IDE，选择nRF5开发板，并使用丰富的Arduino生态系统。 我<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">分叉了该项目，</a>并从我们的手镯中添加了对董事会的支持。 您可以从“ <code>Tools &gt; Board &gt; ID115 Fitness Bracelet (nRF51822)</code>下拉菜单中选择它。 <br><br> <a href=""><img src="https://habrastorage.org/webt/jx/ts/2h/jxts2hki_rpefinf1cjd2ms7k1w.jpeg"></a> <br><br> <a href=""><img src="https://habrastorage.org/webt/50/gn/dm/50gndm8tzezp_frgdrile7la5hs.jpeg"></a> <br>  <i><font color="gray">原始格式的Adafruit ssd1306库（上）和带补丁的库（下）</font></i> <br><br> 这也意味着现在我们可以使用<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Adafruit OLED库</a> 。 令我惊讶和欣慰的是，同样的奇怪行为发生在首先填充奇数甚至偶数OLED列时！ 我很高兴地<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">分叉了</a>图书馆并实施了同样的修改。 与低级方法相比，我们现在可以访问各种很酷的抽象，例如文本输出： <br><br> <a href=""><img src="https://habrastorage.org/webt/gd/62/xf/gd62xfqutmoq_szmosnzvpbdu1i.jpeg"></a> <br>  <i><font color="gray">比较熟悉的“世界，您好！”</font></i> <br><br><h1> 模拟量输入/输出 </h1><br> 除了数字开/关信号外，nRF51822还具有10个用于模拟输入的引脚。 例如，这对于读取当前电池电量很有用。 根据文档判断，读取模拟触点会产生一个10位的值。 因此，如果输入端有<code>0V</code> ，那么我们将读取<code>0</code> ，如果有<code>VCC</code> ，我们将读取<code>1023</code>其中有中间值。 <br><br> 我定期读取模拟输入的值并绘制最有趣的信号： <br><br><img src="https://habrastorage.org/getpro/habr/post_images/483/446/36c/48344636cddd789c9c1f86c15ffca411.png"><br><br><img src="https://habrastorage.org/getpro/habr/post_images/b3c/3ab/38c/b3c3ab38ce708082b19a67ed9cdb30ae.png"><br>  <i><font color="gray">根据模拟输入的数据摇动板并为电池充电的效果</font></i> <br><br> 我确信触点<code>P0.05</code>指的是电池电量，因为该值随充电和放电而增加和减少。 我怀疑引脚<code>P0.26</code>连接到加速度计的输出之一，因为当您摇动电路板时，它会发疯。 触点<code>P0.03</code>和<code>P0.04</code>也可以连接到加速度计的各种输出，但是在这里，某些二阶效应很可能会叠加在来自输入的信号上。 例如，在第一个图表中，请注意当加速计需要更多能量时电池电量（引脚5）如何变化。 这是二阶效应的一个例子。 <br><br> 代码可以<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">在此草图中</a>找到。 源数据和图形脚本在<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">此处</a> 。 现在我们可以在对应表中添加几行： <br><br><table><tbody><tr><th>  NRF51822针 </th><th> 游乐场 </th><th> 内容描述 </th></tr><tr><td>  P0.05 </td><td>  -- </td><td> 模拟输入-连接到电池 </td></tr><tr><td>  P0.26 </td><td>  -- </td><td> 模拟输入-一轴加速度计 </td></tr><tr><td>  P0.03 </td><td>  -- </td><td> 模拟输入-加速度计的一个轴（可能） </td></tr><tr><td>  P0.04 </td><td>  -- </td><td> 模拟输入-加速度计的一个轴（可能） </td></tr></tbody></table><br><h1> 纽扣 </h1><br> 在原始固件中，在某一点触摸手镯会打开显示屏。 如果我没记错的话，把握这一点可以启动天文钟。 这不是物理按钮，而是某种电容式触摸效果很好的东西。 使用与搜索数字输出相同的方法，我<a href="">找到了连接MCU的位置（视频）</a> 。 <br><br> 代码在<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">这里</a> 。 <br><br><table><tbody><tr><th>  NRF51822针 </th><th> 游乐场 </th><th> 内容描述 </th></tr><tr><td>  P0.10 </td><td>  -- </td><td> 数字输入-内置按钮 </td></tr></tbody></table><br><h1> 低功耗蓝牙（BLE） </h1><br>  nRF5芯片上的BLE功能通过称为<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">SoftDevice的</a>东西来实现。 这是带有BLE堆栈的预编译二进制文件。 无论用途如何，都可以缝制。  SoftDevice有很多版本，具体取决于SDK版本和芯片版本。 <br><br> 该<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">文档</a>提供了一定的依赖关系矩阵（不幸的是，您不能直接对其进行链接）。 它显示了该芯片的不同版本附带哪个SDK-以及它是哪个版本的SoftDevice。 在我们的示例中，该芯片标记为QFAAH0，该芯片具有256 KB的闪存，16 KB的RAM，并声明了与SoftDevice s130的兼容性。 <br><br> 我的SDK版本12.3已经包含一些使用SoftDevice s130的示例。 与以前从地址<code>0x0</code>直接连接到微芯片的程序相比，现在您需要从地址<code>0x0</code>刷新SoftDevice，并从地址<code>0x1b000</code>程序本身。 加载和初始化后，SoftDevice二进制文件将转到该地址并将控制权转移到我们的程序。 为了说明这一点，我以闪烁的LED指示灯作为示例，但是将其更改为SoftDevice固件（ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">代码</a> ）。 观察到的行为没有改变，除了您应该预刷新SoftDevice： <br><br> <code>$ make <br> # ... <br> $ make flash-softdevice <br> # ... <br> $ make flash <br> # ... <br> $ make log <br> # ... <br> Hello, world!</code> <br> <br> 也许最简单的蓝牙应用程序就是将设备变成<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">信标</a> 。 设备仅广播其状态。  SDK名为<code>ble_app_beacon</code>就是一个这样的例子。 假定SoftDevice s130已经闪烁。 <br><br> 与通过SDK进行编程相比，与芯片的低级通信也使一切变得复杂。 除了调整RAM的大小（在带LED的示例中，这对我来说很难理解），还发现了另一个难以跟踪的问题。 事实证明，BLE堆栈使用时钟发生器执行对时间敏感的任务。 在SDK示例中，假定使用外部晶体振荡器。 经过数千次<code>printf</code>尝试后，当我意识到这一点时，我将配置标志更改为使用合成时钟生成器，从而解决了该问题。 信标的源代码在<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">这里</a> 。 <br><br><h1>  BLE + Arduino </h1><br> 当BLE示例与nRF5 SDK一起使用时，了解有关RAM和生成器的陷阱，我再次查看了Arduino环境。 同样，还有一个光荣的<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">sandeepmistry / arduino-BLEPeripheral项目</a> （与<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">arduino-nRF5</a>来自同一个人！），它在内部BLE设置之上提供了出色的抽象性。 <br><br> 令我惊讶的是，我什至不必拨出图书馆。  arduino-nrf5项目的作者花费了时间，并添加了所有板卡和设置的配置，因此，现在从下拉菜单“ <code>Tools &gt; Low Frequency Clock &gt; Synthesized</code>为“软设备”选择合适的时钟发生器可以轻松选择。 太棒了 我很快编写<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">了一个示例</a> ，该<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">示例</a>通过蓝牙（带有<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">此应用程序</a> ）通过绿色的LED点亮。  <a href="">视频中展示了</a>他的工作。 <br><br><h1> 进一步的计划 </h1><br> 在忙了无数小时的操作之后，我的手痒了好几个星期，将其进一步伸入洗衣机，忘记了一段时间。 </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN413895/">https://habr.com/ru/post/zh-CN413895/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN413881/index.html">使用Telegram MTProxy的5.94米docker映像</a></li>
<li><a href="../zh-CN413885/index.html">Cavium ThunderX2评估：Arm Server的梦想成真（第1部分，简介）</a></li>
<li><a href="../zh-CN413889/index.html">错过了最后期限，或者为什么一半以上的公司未准备好进行GDPR</a></li>
<li><a href="../zh-CN413891/index.html">统一法人实体州注册簿-统一法人实体州注册簿如何</a></li>
<li><a href="../zh-CN413893/index.html">作为安全工具的漏洞-2，或如何捕捉APT“活饵”</a></li>
<li><a href="../zh-CN413897/index.html">Unity3D ECS和作业系统</a></li>
<li><a href="../zh-CN413899/index.html">俄罗斯人的生物识别个人数据</a></li>
<li><a href="../zh-CN413901/index.html">通过ROS使用PS4 Dualshock 4游戏杆控制EduMip自平衡机器人</a></li>
<li><a href="../zh-CN413903/index.html">Cambridge Analytica如何将点击转化为声音</a></li>
<li><a href="../zh-CN413907/index.html">面向移动开发人员256的有趣材料的摘要（6月4日-6月12日）</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>