<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>⏹️ 🧚🏼 🧒🏽 在移至Akka工具包以实施事件源和CQRS之前需要了解的知识 🏨 ✊🏾 🛷</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="您好，Habr亲爱的读者。 我叫Rustem，是哈萨克斯坦IT公司DAR的主要开发人员。 在本文中，我将告诉您使用Akka工具包进入事件源和CQRS模板之前需要了解的内容。 


 2015年左右，我们开始设计生态系统。 经过分析并基于对Scala和Akka的经验，我们决定停止使用Akka工具包。 ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>在移至Akka工具包以实施事件源和CQRS之前需要了解的知识</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/453418/"><p> 您好，Habr亲爱的读者。 我叫Rustem，是哈萨克斯坦IT公司DAR的主要开发人员。 在本文中，我将告诉您使用Akka工具包进入事件源和CQRS模板之前需要了解的内容。 </p><br><p>  2015年左右，我们开始设计生态系统。 经过分析并基于对Scala和Akka的经验，我们决定停止使用Akka工具包。 我们已经成功地使用CQRS实现了事件来源模板的实现，而并非如此。 我想与读者分享这方面的专业知识。 我们将研究Akka如何实现这些模式，以及可用的工具，并讨论Akka的陷阱。 我希望阅读本文后，您将对使用Akka工具包的风险有更多的了解。 </p><a name="habracut"></a><br><p> 关于CQRS和事件采购的主题，撰写了许多有关Habré和其他资源的文章。 本文适用于已经了解CQRS和事件源的读者。 在本文中，我想重点介绍Akka。 </p><br><h3 id="domain-driven-design"> 域驱动设计 </h3><br><p> 关于域驱动设计（DDD）的许多材料已经被撰写。 这种方法既有反对者，也有支持者。 我想补充一点，如果您决定切换到事件源和CQRS，那么学习DDD并不是多余的。 此外，所有Akka工具都具有DDD理念。 </p><br><p> 实际上，事件源和CQRS只是称为域驱动设计的全局图的一小部分。 在设计和开发时，您可能会遇到许多有关如何正确实现这些模板并将其集成到生态系统中的问题，并且了解DDD将使您的生活更轻松。 </p><br><blockquote> 在本文中，实体（由DDD表示实体）一词将表示具有唯一标识符的Persistence Actor。 </blockquote><br><h3 id="pochemu-scala"> 为什么选择Scala？ </h3><br><p> 经常有人问我们为什么使用Scala，而不是Java。 原因之一是Akka。 用Scala语言编写的框架本身，并支持Java语言。 在这里我必须说， <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">.NET</a>上也有一个实现，但这是另一个主题。 为了不引起讨论，我不会写为什么Scala比Java更好或更差。 我只告诉您几个例子，我认为Scala在使用Akka时比Java具有优势： </p><br><ul><li>不可变的对象。 在Java中，您需要自己编写不可变的对象。 相信我，不断编写最终参数并不容易，也不是很方便。 在Scala <code>case class</code> ，内置<code>copy</code>功能已使<code>case class</code>不可变 </li><li> 编码样式。 当用Java实现时，您仍将以Scala风格（即功能上）进行编写。 </li></ul><br><p> 这是Scala和Java中actor的示例实现： </p><br><p>  <strong>Scala：</strong> </p><br><pre> <code class="scala hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">object</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">DemoActor</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">props</span></span></span></span>(magicNumber: <span class="hljs-type"><span class="hljs-type">Int</span></span>): <span class="hljs-type"><span class="hljs-type">Props</span></span> = <span class="hljs-type"><span class="hljs-type">Props</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-type"><span class="hljs-type">DemoActor</span></span>(magicNumber)) } <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">DemoActor</span></span></span><span class="hljs-class">(</span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">magicNumber: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Int</span></span></span></span></span><span class="hljs-class">) </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Actor</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">receive</span></span></span><span class="hljs-function"> </span></span>= { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> x: <span class="hljs-type"><span class="hljs-type">Int</span></span> =&gt; sender() ! (x + magicNumber) } } <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SomeOtherActor</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Actor</span></span></span><span class="hljs-class"> </span></span>{ context.actorOf(<span class="hljs-type"><span class="hljs-type">DemoActor</span></span>.props(<span class="hljs-number"><span class="hljs-number">42</span></span>), <span class="hljs-string"><span class="hljs-string">"demo"</span></span>) <span class="hljs-comment"><span class="hljs-comment">// ... }</span></span></code> </pre> <br><p>  <strong>Java：</strong> </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">DemoActor</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AbstractActor</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> Props </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">props</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Integer magicNumber)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Props.create(DemoActor.class, () -&gt; <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> DemoActor(magicNumber)); } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Integer magicNumber; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">DemoActor</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Integer magicNumber)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.magicNumber = magicNumber; } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Receive </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">createReceive</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> receiveBuilder() .match( Integer.class, i -&gt; { getSender().tell(i + magicNumber, getSelf()); }) .build(); } } <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SomeOtherActor</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AbstractActor</span></span></span><span class="hljs-class"> </span></span>{ ActorRef demoActor = getContext().actorOf(DemoActor.props(<span class="hljs-number"><span class="hljs-number">42</span></span>), <span class="hljs-string"><span class="hljs-string">"demo"</span></span>); <span class="hljs-comment"><span class="hljs-comment">// ... }</span></span></code> </pre> <br><p>  （示例取自<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">此处</a> ） </p><br><p> 请注意使用Java语言示例实现<code>createReceive()</code>方法。 在内部，通过<code>ReceiveBuilder</code>工厂实现了模式匹配。  <code>receiveBuilder()</code>是Akka提供的一种支持lambda表达式的方法，即Java中的模式匹配。 在Scala中，这是本地实现的。 同意，Scala中的代码更短，更易于阅读。 </p><br><ul><li> 文档和示例。 尽管官方文档中有Java实例，但在Internet上，几乎所有实例都在Scala中。 同样，您可以更轻松地在Akka库的源代码中导航。 </li></ul><br><blockquote> 在性能方面，Scala和Java之间没有区别，因为一切都在JVM中进行。 </blockquote><br><h3 id="hranilische"> 贮藏 </h3><br><p> 在使用Akka Persistence实现事件源之前，建议您预先选择一个用于永久数据存储的数据库。 基础的选择取决于系统的要求，您的需求和偏好。 数据既可以存储在NoSQL和RDBMS中，也可以存储在文件系统中，例如<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Google的</a> LevelDB。 </p><br><p> 请务必注意，Akka Persistence不负责从数据库中写入和读取数据，而是通过必须实现Akka Persistence API的插件来完成的。 </p><br><p> 选择用于存储数据的工具后，您需要从列表中选择一个<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">插件</a> ，或者自己编写。 第二种选择，我不建议为什么重新发明轮子。 </p><br><p> 对于永久数据存储，我们决定留在Cassandra。 事实是我们需要一个可靠，快速且分布式的基础。 此外，Typesafe本身也随<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">插件一起提供</a> ，该<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">插件</a>完全实现了<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Akka Persistence API</a> 。 它会不断更新，与其他版本相比，Cassandra插件编写了更完整的文档。 </p><br><p> 值得一提的是，该插件还存在一些问题。 例如，仍然没有稳定的版本（在撰写本文时，最新版本为0.97）。 对于我们来说，使用此插件时遇到的最大麻烦是读取某些实体的持久查询时事件丢失。 要获得完整的图片，下面是CQRS图表： </p><br><p><img src="https://habrastorage.org/webt/xd/3o/hk/xd3ohkb_wfvtfds2qangxxoctws.png"></p><br><p> 持久实体使用一致的哈希算法（例如10个分片）将实体事件分布到标签中： </p><br><p><img src="https://habrastorage.org/webt/eb/sq/zj/ebsqzjcj_nom7zs4pyizzkq5o0q.png"></p><br><p> 然后，Persistent Query订阅这些标签并启动将数据添加到Elastic Search的流。 由于Cassandra位于群集中，因此事件将分散在各个节点上。 一些节点可能会下垂，并且响应速度会比其他节点慢。 不能保证您会严格按照顺序接收事件。 为了解决此问题，实现了插件，以便如果它接收到无序事件（例如， <code>entity-A event NR 2</code> ，则它会等待一段时间以等待初始事件，如果未接收到该事件，它将简单地忽略此实体的所有事件。 即使这样，也有关于Gitter的讨论。 如果有人感兴趣，您可以阅读@kotdv和插件开发人员之间的对应关系： <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Gitter</a> </p><br><p>  <strong>如何解决这种误解：</strong> </p><br><ul><li> 您需要将插件更新为最新版本。 在最新版本中，Typesafe开发人员解决了许多与最终一致性有关的问题。 但是，我们仍在等待稳定的版本 </li><li> 已为负责接收事件的组件添加了更精确的设置。 您可以尝试增加无序事件的超时时间，以使插件更可靠地运行：c <code>assandra-query-journal.events-by-tag.eventual-consistency.delay=10s</code> </li><li> 按照DataStax的建议配置Cassandra。 放入垃圾收集器G1并为<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Cassandra</a>分配尽可能多的内存。 </li></ul><br><p> 最后，我们解决了事件丢失的问题，但是现在持久性查询方面存在稳定的数据延迟（从五秒到十秒）。 决定不再使用用于分析的数据的方法，在速度很重要的地方，我们手动在总线上发布事件。 最主要的是选择适当的机制来处理或发布数据：至少一次或最多一次。 在<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">这里</a>可以找到Akka的详尽描述。 对于我们来说，保持数据的一致性非常重要，因此，在将数据成功写入数据库之后，我们引入了一种过渡状态，该状态控制着数据在总线上的成功发布。 以下是示例代码： </p><br><pre> <code class="scala hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">object</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SomeEntity</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">sealed</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">trait</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Event</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">uuid</span></span></span></span>: <span class="hljs-type"><span class="hljs-type">String</span></span> } <span class="hljs-comment"><span class="hljs-comment">/** * ,    . */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">DidSomething</span></span></span><span class="hljs-class">(</span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">uuid: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">String</span></span></span></span></span><span class="hljs-class">) </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Event</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">/**</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">*</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title"></span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title"></span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title"></span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title"></span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title"></span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title"></span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title"></span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title"></span></span></span><span class="hljs-class">. </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">*/</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">case</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">LastEventPublished</span></span></span><span class="hljs-class">(</span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">uuid: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">String</span></span></span></span></span><span class="hljs-class">) </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Event</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">/**</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">*</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title"></span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title"></span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title"></span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title"></span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title"></span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title"></span></span></span><span class="hljs-class">. </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">*</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">@param</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">unpublishedEvents</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">–</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title"></span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title"></span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title"></span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title"></span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title"></span></span></span><span class="hljs-class">. </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">*/</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">case</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">State</span></span></span><span class="hljs-class">(</span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">unpublishedEvents: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Seq</span></span></span></span><span class="hljs-class"><span class="hljs-params">[</span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Event</span></span></span></span><span class="hljs-class"><span class="hljs-params">]</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">object</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">State</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">updated</span></span></span></span>(event: <span class="hljs-type"><span class="hljs-type">Event</span></span>): <span class="hljs-type"><span class="hljs-type">State</span></span> = event <span class="hljs-keyword"><span class="hljs-keyword">match</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> evt: <span class="hljs-type"><span class="hljs-type">DidSomething</span></span> =&gt; copy( unpublishedEvents = unpublishedEvents :+ evt ) <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> evt: <span class="hljs-type"><span class="hljs-type">LastEventPublished</span></span> =&gt; copy( unpublishedEvents = unpublishedEvents.filter(_.uuid != evt.uuid) ) } } } <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SomeEntity</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PersistentActor</span></span></span><span class="hljs-class"> </span></span>{ … persist(newEvent) { evt =&gt; updateState(evt) publishToEventBus(evt) } … }</code> </pre> <br><p> 如果由于某种原因无法发布事件，则在<code>SomeEntity</code>的下一次启动时，它将知道<code>DidSomething</code>事件未到达总线，并将尝试重新发布数据。 </p><br><h3 id="serializator"> 序列化器 </h3><br><p> 序列化是使用Akka时同样重要的一点。 他有一个内部模块<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">-Akka序列化</a> 。 在参与者之间交换消息以及通过Persistence API存储消息时，该模块用于序列化消息。 默认情况下，使用Java序列化程序，但建议使用另一个序列化程序。 问题是Java序列化程序速度很慢并且占用大量空间。 有两种流行的解决方案-JSON和Protobuf。  JSON虽然很慢，但是更易于实现和维护。 如果需要最小化序列化和数据存储的成本，可以在Protobuf停下来，但是开发过程会变慢。 除了域模型，您还必须编写另一个数据模型。 不要忘记数据版本控制。 准备好不断编写域模型和数据模型之间的映射。 </p><br><p><img src="https://habrastorage.org/webt/ag/fk/h0/agfkh04g1ykq5ymlxl0ma5ciwmo.png"></p><br><p> 添加了一个新事件-写映射。 更改了数据结构-编写新版本的数据模型并更改映射功能。 不要忘了串行器的测试。 通常，会有很多工作要做，但是最终您将获得松耦合的组件。 </p><br><h3 id="vyvody"> 结论 </h3><br><ul><li> 仔细研究并为自己选择合适的基础和插件。 我建议选择一个维护良好且不会停止开发的插件。 该领域是一个相对较新的领域，仍有许多缺陷尚待解决 </li><li> 如果选择分布式存储，则必须自己或最多忍受10秒的延迟来解决问题。 </li><li> 序列化的复杂性。 您可以牺牲速度并停止使用JSON，或者选择Protobuf并编写许多适配器并支持它们。 </li><li> 该模板有很多优点，它们是组成一个大型系统的松散耦合组件和独立开发团队。 </li></ul></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN453418/">https://habr.com/ru/post/zh-CN453418/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN453408/index.html">研究人员工具箱-第二版：15个专题数据库的集合</a></li>
<li><a href="../zh-CN453410/index.html">请勿将智能灯泡丢进垃圾桶，否则有物联网的危险</a></li>
<li><a href="../zh-CN453412/index.html">顶级3D商店成为UFactory的独家分销商</a></li>
<li><a href="../zh-CN453414/index.html">IEO的兴衰，您需要了解新一轮的筹款浪潮</a></li>
<li><a href="../zh-CN453416/index.html">.NET Core中配置的工作方式</a></li>
<li><a href="../zh-CN453422/index.html">熟悉ITSM：主题中“快速沉浸”的10种哈勃龙图案和专家材料</a></li>
<li><a href="../zh-CN453428/index.html">在iOS开发中提高代码的可读性</a></li>
<li><a href="../zh-CN453430/index.html">当我写监控文件时</a></li>
<li><a href="../zh-CN453432/index.html">从评论家到算法：音乐世界中精英的衰落之声</a></li>
<li><a href="../zh-CN453434/index.html">墨盒的多功能性：Game Boy游戏中的传感器</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>