<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üî´ üñêüèø ü¶å OceanLotus: novo backdoor, esquemas antigos ü¶è ‚ôüÔ∏è üëâüèΩ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="O grupo OceanLotus (tamb√©m conhecido como APT32 e APT-C-00) √© conhecido por seus ataques no leste da √Åsia. No ano passado, v√°rios estudos sobre o trab...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>OceanLotus: novo backdoor, esquemas antigos</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/eset/blog/421779/">  O grupo OceanLotus (tamb√©m conhecido como APT32 e APT-C-00) √© conhecido por seus ataques no leste da √Åsia.  No ano passado, v√°rios estudos sobre o trabalho do grupo foram publicados, incluindo documentos do <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">CyberReason</a> , uma revis√£o do <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">FireEye</a> e uma descri√ß√£o do ataque do <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Volexity</a> .  Como podemos ver, o grupo atualiza backdoors, infraestrutura e vetores de infec√ß√£o. <br><br>  A OceanLotus continua a atingir empresas e ag√™ncias governamentais no leste da √Åsia.  De acordo com a telemetria da ESET, as metas priorit√°rias da OceanLotus est√£o no Vietn√£, Laos, Camboja e Filipinas. <br><br>  Alguns meses atr√°s, descobrimos e analisamos uma de suas mais recentes backdoors.  Ele implementa v√°rias ferramentas que dificultam a an√°lise e evitam a detec√ß√£o - as discutiremos em um post. <br><br><img src="https://habrastorage.org/webt/4f/mf/dz/4fmfdzgqiqskqku5rz7eeprycti.jpeg"><br><br><a name="habracut"></a><h2>  Distribui√ß√£o </h2><br>  Os invasores usam m√©todos diferentes para convencer a v√≠tima a lan√ßar um conta-gotas malicioso. <br><br><h3>  Extens√µes duplas e √≠cones de aplicativos falsos (Word, PDF etc.) </h3><br>  √â prov√°vel que os conta-gotas se espalhem por meio de anexos de email.  Observamos os seguintes nomes de arquivo: <br>  - <code>Mi17 Technical issues - Phonesack Grp.exe</code> (Mi-17 - modelo de helic√≥ptero russo) <br>  - <code>Chi tiet don khieu nai gui saigontel.exe</code> (traduzido do vietnamita - ‚Äúdetalhes da reivindica√ß√£o enviada √† Saigontel‚Äù, Saigontel - empresa de telecomunica√ß√µes vietnamita) <br>  - <code>Updated AF MOD contract - Jan 2018.exe</code> <br>  - <code>remove_pw_Reschedule of CISD Regular Meeting.exe</code> <br>  - <code>Sorchornor_with_PM_-_Sep_2017.exe</code> <br>  - <code>20170905-Evaluation Table.xls.exe</code> <br>  - <code>CV_LeHoangThing.doc.exe</code> (curr√≠culos falsos tamb√©m foram encontrados no Canad√°) <br><br>  Todos esses arquivos t√™m algo em comum - iniciar um documento de isca protegido por senha.  N√£o est√° claro se a senha est√° em algum lugar nos dados da carta transmitida ou se o documento n√£o deve ser aberto. <br><br><h3>  Instaladores falsos </h3><br>  V√°rios instaladores falsos que se apresentam como instaladores ou atualiza√ß√µes de software foram vistos em campanhas de watering hole.  Um exemplo √© o instalador reembalado do Firefox descrito pelo 360 Labs no <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Freebuf</a> (em chin√™s). <br><br>  Outro exemplo que vimos foi chamado <code>RobototFontUpdate.exe</code> .  Provavelmente se espalhou por sites comprometidos, mas n√£o temos evid√™ncias suficientes disso. <br><br>  Todos os arquivos descritos, distribu√≠dos por correio ou baixados ao visitar um site comprometido, entregaram o mesmo componente de backdoor.  Em uma postagem, analisaremos uma amostra do <code>RobototFontUpdate.exe</code> e mostraremos como ele consegue executar uma carga maliciosa no sistema. <br><br><h2>  An√°lise t√©cnica </h2><br>  O processo de instala√ß√£o e execu√ß√£o depende da ofusca√ß√£o de v√°rias camadas, como criptografia de componentes, reconstru√ß√£o de arquivos PE, t√©cnicas de carregamento de c√≥digo de shell e carregamento lateral.  Este √∫ltimo foi descrito no <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">estudo anterior da Koretug</a> da ESET. <br><br><h3>  Revis√£o do Progresso </h3><br>  O ataque consiste em duas partes: um conta-gotas e um ve√≠culo de lan√ßamento.  Cada etapa de cada parte do processo ser√° explicada em detalhes na se√ß√£o correspondente.  Os dois diagramas abaixo d√£o uma breve id√©ia do progresso geral do malware. <br><br><img src="https://habrastorage.org/webt/yn/wa/jd/ynwajd8empdclmahz0mzaarmpxk.png"><br>  <i>Figura 1. O progresso do conta-gotas</i> <br><br><img src="https://habrastorage.org/webt/gv/ba/jb/gvbajbzaqzd6tmrjpj95nkov-j8.png"><br>  <i>Figura 2. Progresso da porta traseira</i> <br><br>  Quase todos esses componentes s√£o ofuscados.  A ofusca√ß√£o √© baseada em comandos complementares de transi√ß√£o de pares condicionais.  Para cada um dos formul√°rios: JZ / JNZ, JP / JNP, JO / JNO e assim por diante, cada par realiza uma transi√ß√£o para o mesmo objetivo.  A sequ√™ncia √© intercalada com c√≥digo de lixo eletr√¥nico que usa o ponteiro da pilha, mas n√£o altera o valor do sinalizador condicional.  Acontece que a transi√ß√£o ocorre dentro do mesmo ramo.  Isso leva a problemas durante o processo de descompila√ß√£o devido ao uso de valores positivos do ponteiro da pilha. <br><br><img src="https://habrastorage.org/webt/lh/y6/an/lhy6anvm_1feplhj7depx1udiiu.png"><br>  <i>Figura 3. Transi√ß√£o condicional complementar</i> <br><br>  Al√©m disso, alguns elementos b√°sicos do programa adicionam um endere√ßo √† pilha, ap√≥s o qual terminam em JMP / CALL, enquanto outros elementos b√°sicos adicionam dois endere√ßos e terminam com o comando RET.  A adi√ß√£o do segundo item √© a fun√ß√£o chamada e o primeiro √© o endere√ßo do pr√≥ximo elemento b√°sico do programa em que a transi√ß√£o ser√° feita.  Assim, os elementos b√°sicos do programa s√£o criados sem objetos pai. <br><br><img src="https://habrastorage.org/webt/jc/5j/dw/jc5jdw3rbtwezkp4ylemfursggw.png"><br>  <i>Figura 4. T√©cnica PUSH / JMP</i> <br><br>  Como resultado de uma combina√ß√£o de duas t√©cnicas de ofusca√ß√£o, s√£o obtidos gr√°ficos "bonitos": <br><br><img src="https://habrastorage.org/webt/3l/pe/3x/3lpe3x_ccjdkh9rm0rpxyykztf0.png"><br>  <i>Figura 5. Ofuscando uma sequ√™ncia de execu√ß√£o</i> <br><br>  Perceber c√≥digos indesejados √© bem simples.  Pode ser ignorado na an√°lise de amostras, se voc√™ conhecer o esquema de aplica√ß√£o. <br><br><h2>  Conta-gotas </h2><br><h3>  Etapa 1. Documento de isca </h3><br>  Nos √∫ltimos meses, o OceanLotus usou v√°rias iscas.  Um deles √© um software falso para atualizar a fonte TrueType <code>Roboto Slab regular</code> do <code>Roboto Slab regular</code> .  A escolha de uma fonte parece um pouco estranha, pois n√£o suporta muitos idiomas do leste asi√°tico. <br><br><img src="https://habrastorage.org/webt/2p/p8/sm/2pp8sm8gjt15kzqakmyooah1pk8.jpeg"><br>  <i>Figura 6. √çcone de atualiza√ß√£o da fonte RobototFontUpdate</i> <br><br>  Quando executado, o arquivo bin√°rio descriptografa seus recursos (XOR, 128 bytes, chave codificada) e restaura os dados descriptografados (LZMA).  Arquivo leg√≠timo RobotoSlab-Regular.ttf <br><br>  (SHA1: <code>912895e6bb9e05af3a1e58a1da417e992a71a324</code> ) √© gravado na pasta <code>%temp%</code> e iniciado usando a fun√ß√£o <code>ShellExecute</code> API do Win32. <br><br>  O c√≥digo do shell decodificado dos recursos √© executado.  Ap√≥s a execu√ß√£o, uma atualiza√ß√£o de fonte falsa implementa outro aplicativo cujo √∫nico objetivo √© remover o conta-gotas.  Este aplicativo de <code>%temp%\[0-9].tmp.exe</code> √© <code>%temp%\[0-9].tmp.exe</code> como <code>%temp%\[0-9].tmp.exe</code> . <br><br><h3>  Etapa 2. C√≥digo do Shell </h3><br>  Em cada est√°gio, o mesmo c√≥digo de shell √© usado. <br><br>  O shellcode √© um carregador de PE personalizado.  Restaura o arquivo execut√°vel na mem√≥ria - descriptografa todas as se√ß√µes e calcula os movimentos necess√°rios e outros recuos.  O <code>RtlMoveMemory</code> usa as tr√™s fun√ß√µes da API do Windows: <code>VirtualAlloc</code> , <code>RtlMoveMemory</code> e <code>RtlZeroMemory</code> . <br><br>  A fun√ß√£o <code>RtlZeroMemory</code> usada para <code>RtlZeroMemory</code> campos no cabe√ßalho do PE.  Confiar em um despejo autom√°tico de mem√≥ria falhar√°, pois os cabe√ßalhos MZ / PE est√£o corrompidos. <br>  O c√≥digo do shell chama a fun√ß√£o de logon PE descriptografada e, em seguida, a <code>DLLEntry</code> exporta√ß√£o <code>DLLEntry</code> . <br><br><h3>  Etapa 3. O verdadeiro conta-gotas </h3><br> <code>{103004A5-829C-418E-ACE9-A7615D30E125}.dll</code> <br>  Este execut√°vel descriptografa recursos usando o algoritmo AES no modo CBC por meio da API do Windows.  A chave codificada possui 256 bits de tamanho.  Ap√≥s a descriptografia, os dados compactados s√£o descomprimidos (algoritmo LZMA). <br><br>  Se o processo for iniciado com direitos de administrador, o malware fornecer√° persist√™ncia criando um servi√ßo.  Caso contr√°rio, a chave cl√°ssica do Registro Executar ser√° usada ( <code>HKCU\SOFTWARE\Microsoft\ Windows\CurrentVersion\Run;DeviceAssociationService;rastlsc.exe</code> ). <br><br>  Se o c√≥digo dropper for executado com direitos de administrador, ele tenta gravar os arquivos listados abaixo na pasta <code>C:\Program Files\Symantec\Symantec Endpoint Protection\12.1.671.4971.104a\DeviceAssociationService\</code> , se n√£o, grava-os na <code>%APPDATA%\Symantec\Symantec Endpoint Protection\12.1.671.4971.104a\DeviceAssociationService\</code> : <br><br>  - <code>rastlsc.exe</code> (SHA1: <code>2616da1697f7c764ee7fb558887a6a3279861fac</code> , c√≥pia do aplicativo leg√≠timo Symantec Network Access Control, <code>dot1xtra.exe</code> ) <br>  - <code>SyLog.bin</code> (SHA1: <code>5689448b4b6260ec9c35f129df8b8f2622c66a45</code> , backdoor criptografado) <br>  - <code>rastls.dll</code> (SHA1: <code>82e579bd49d69845133c9aa8585f8bd26736437b</code> , uma DLL maliciosa que o <code>rastlsc.exe</code> ) <br><br>  O caminho varia de amostra para amostra, mas o layout √© semelhante.  Dependendo dos direitos, o malware despeja arquivos em <code>%ProgramFiles%</code> ou <code>%appdata%</code> .  Observamos tamb√©m: <br><br>  - <code>\Symantec\CNG Key Isolation\</code> <br>  - <code>\Symantec\Connected User Experiences and Telemetry\</code> <br>  - <code>\Symantec\DevQuery Background Discovery Broker Tasks\</code> <br><br>  Esses caminhos s√£o usados ‚Äã‚Äãpor v√°rios produtos da Symantec. <br><br>  Ap√≥s obter persist√™ncia e implementar o arquivo execut√°vel, um arquivo leg√≠timo, <br>  <code>rastlsc.exe</code> , √© executado usando <code>CreateProcessW</code> . <br><br>  Tamb√©m observamos uma vers√£o ( <code>{BB7BDEC9-B59D-492E-A4AF-4C7B1C9E646B}.dll</code> ) que executa o <code>rastlsc.exe</code> com o par√¢metro <code>krv</code> .  Discutiremos com mais detalhes abaixo. <br><br><h2>  Componente backdoor: preenchimento do rastlsc.exe </h2><br>  A equipe do OceanLotus usa uma t√©cnica antiga e conhecida em um dos execut√°veis ‚Äã‚Äãdo produto Symantec.  A linha inferior √© usar o processo de carregar uma biblioteca de um arquivo .exe leg√≠timo e assinado, escrevendo uma biblioteca maliciosa na mesma pasta.  Isso far√° com que o comportamento malicioso pare√ßa leg√≠timo, pois essas a√ß√µes s√£o executadas enquanto o execut√°vel confi√°vel est√° em execu√ß√£o. <br><br>  Como mencionado acima, o arquivo leg√≠timo <code>rastlsc.exe</code> √© redefinido e executado. <br>  Ele importa o arquivo <code>rastls.dll</code> , que neste caso tem conte√∫do malicioso. <br><br><img src="https://habrastorage.org/webt/jy/ga/ax/jygaaxccovxfilcmjrol9rmoklu.jpeg"><br>  <i>Figura 7. Rastlsc.exe assinado digitalmente da Symantec</i> <br><br>  Tamb√©m vimos um preenchimento usando outros execut√°veis ‚Äã‚Äãleg√≠timos e assinados, incluindo o <code>mcoemcpy.exe</code> da McAfee, que carrega o <code>McUtil.dll</code> .  Essa t√©cnica foi usada anteriormente pelo PlugX, que atraiu a aten√ß√£o do <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Vietnam CERT</a> (em vietnamita). <br><br><h3>  Etapa 1. Preenchendo a biblioteca, rastls.dll </h3><br>  O nome interno do arquivo dll √© <code>{7032F494-0562-4422-9C39-14230E095C52}.dll</code> , mas vimos outras vers√µes, por exemplo, <code>{5248F13C-85F0-42DF-860D-1723EEAA4F90}.dll</code> .  Todas as fun√ß√µes exportadas levam √† execu√ß√£o da mesma fun√ß√£o. <br><br><img src="https://habrastorage.org/webt/hg/1h/qm/hg1hqmssbsek8-kl8e7dkbzsotq.jpeg"><br>  <i>Figura 8. Todas as exporta√ß√µes rasltls.dll levam a uma √∫nica fun√ß√£o</i> <br><br>  Exportar tenta ler o arquivo <code>SyLog.bin</code> localizado na mesma pasta.  Outras vers√µes tentaram abrir o arquivo <code>OUTLFLTR.DAT</code> .  Se o arquivo existir, ele ser√° descriptografado usando o algoritmo AES no modo CBC com uma chave de 256 bits codificada e os dados compactados recebidos ser√£o descompactados (compacta√ß√£o LZMA). <br><br>  A variante <code>McUtil.dll</code> usa uma t√©cnica diferente.  √Ä primeira vista, a fun√ß√£o principal n√£o faz nada de mal-intencionado, mas na verdade substitui a se√ß√£o <code>.text</code> do arquivo leg√≠timo <code>mcoemcpy.exe</code> , um arquivo bin√°rio.  Ele gera um c√≥digo de shell cuja tarefa √© chamar uma fun√ß√£o para ler o c√≥digo de shell criptografado do segundo est√°gio no arquivo <code>mcscentr.adf</code> . <br><br>  O pseudoc√≥digo a seguir √© usado para criar o c√≥digo do shell: <br><br> <code>x = False i = 0 <br> buff = genRandom() <br> opc1 = [0x58,0x59,0x5a,0x5b] <br> opc2 = [0x50,0x51,0x52,0x53,0x54,0x55,0x56,0x57] <br> opc3 = [0x90,0x40,0x41,0x42,0x43,0x44,0x45,0x46,0x47,0x48, <br> 0x49,0x4a,0x4b] <br> while i &lt; len(buff): <br> currentChar = buff[i] if currentChar &lt; 0xc8: <br> buff[i] = opc1[currentChar % len(opc1)] <br> else: <br> if x: <br> buff[i] = opc2[currentChar % len(opc2)] <br> else: <br> buff[i] = opc3[currentChar % len(opc3)] x = x == False <br> i+=1</code> <br> <br>  Abaixo na figura, voc√™ pode ver uma lista do resultado do montador: <br><br><img src="https://habrastorage.org/webt/i8/4y/gg/i84yggcraq46pahxx_g5gzha4_y.png"><br>  <i>Figura 9. C√≥digo de shell gerado</i> <br><br><h3>  Passos 2‚Äì4.  Shellcode, lan√ßador e shellcode novamente </h3><br>  O <code>{E1E4CBED-5690-4749-819D-24FB660DF55F}.dll</code> descriptografa e baixa a <code>{E1E4CBED-5690-4749-819D-24FB660DF55F}.dll</code> .  A biblioteca carrega recursos e tenta iniciar o servi√ßo DeviceAssociationService.  As informa√ß√µes descriptografadas tamb√©m cont√™m um c√≥digo de shell.  O √∫ltimo descriptografa a etapa final: uma porta dos fundos. <br><br>  A variante <code>{92BA1818-0119-4F79-874E-E3BF79C355B8}.dll</code> verifica se <code>rastlsc.exe</code> executado com <code>krv</code> como o primeiro par√¢metro.  <code>rastlsc.exe</code> caso, uma tarefa √© criada e o <code>rastlsc.exe</code> √© executado novamente, mas sem esse par√¢metro. <br><br><h3>  Etapa 5. Backdoor </h3><br> <code>{A96B020F-0000-466F-A96D-A91BBF8EAC96}.dll</code> <br> <br>  Primeiro, o malware tenta baixar seus recursos e descriptograf√°-los usando o algoritmo RC4.  Os recursos resultantes cont√™m dados usados ‚Äã‚Äãpara configurar o backdoor.  O formato de configura√ß√£o n√£o √© dif√≠cil de encontrar.  Usando o Kaitai struct e seu amortecedor de estrutura, obtemos o seguinte: <br><br><img src="https://habrastorage.org/webt/wv/sq/7r/wvsq7r5rn67px5msvrjogbnoelk.jpeg"><br>  <i>Figura 10. Estrutura de configura√ß√£o</i> <br><br>  <b>Nota</b> : com exce√ß√£o da linha domain_encoding_str e da biblioteca httpprov, os dados mudam de amostra para amostra.  As chaves do registro s√£o quase as mesmas, mas possuem um esquema semelhante: <code>\HKCU\SOFTWARE\Classes\AppX[a-f0-9]{32}</code> , nada de not√°vel. <br><br>  O programa malicioso recebe os 10 primeiros bytes do nome de usu√°rio (UTF-16), codifica-os com a sequ√™ncia de tr√™s letras <code>mutex_encoding_str</code> em UTF-16 e codifica em hexadecimal.  O resultado √© usado como o nome do mutex.  Por exemplo, para um usu√°rio cujo nome come√ßa com <code>abc</code> e uma chave na forma de <code>vwx</code> , o mutex ser√° <code>\Sessions\1\BaseNamedObjects\170015001b</code> . <br><br>  O backdoor inclui um carregador de PE que carrega a biblioteca <code>HTTPProv.dll</code> na mem√≥ria, chama o ponto de entrada e chama a fun√ß√£o de exporta√ß√£o <code>CreateInstance</code> . <br><br><h3>  Comunica√ß√£o </h3><br>  O backdoor usa o protocolo de comunica√ß√£o TCP padr√£o na porta <code>25123</code> .  Para obter o endere√ßo IP do servidor, o backdoor primeiro cria uma consulta DNS espec√≠fica. <br><br>  O programa malicioso seleciona um dos tr√™s dom√≠nios da configura√ß√£o e adiciona um subdom√≠nio especial que √© gerado usando dois valores.  O primeiro valor √© o nome do computador com um comprimento de 16 bytes.  O segundo √© um ID de vers√£o de quatro bytes.  O c√≥digo Python 2 abaixo √© um algoritmo de codifica√ß√£o: <br><br> <code>letters=domain_encoding_str # ‚Äúghijklmnop‚Äù hex_pc_name=pc_name.encode(‚ÄúUTF-16LE‚Äù).encode(‚Äúhex‚Äù) s='' <br> for c in hex_pc_name: <br> if 0x2f &lt; ord(c) &lt; 0x3a: <br> s+=letters[ord(c) - 0x30] <br> else: <br> s+=c</code> <br> <br>  Por exemplo, se o nome do computador for <code>random-pc</code> e o ID da vers√£o for 0x0a841523, o seguinte dom√≠nio ser√° gerado: <br> <code>niggmhggmeggmkggmfggmdggidggngggmjgg.ijhlokga.dwarduong[.]com</code> <br> <br>  A seguinte express√£o regular pode ser usada para rotular o servidor C&amp;C desse backdoor: <br> <code>[ghijklmnopabcdef]{4-60}\.[ghijklmnopabcdef]{8}\.[az]+\.[az]+</code> <br> <br>  Se o endere√ßo IP pertencer a um dom√≠nio espec√≠fico, o malware tentar√° estabelecer uma conex√£o TCP atrav√©s da porta <code>25123</code> .  Cada uma das amostras possui tr√™s nomes de dom√≠nio diferentes que s√£o usados ‚Äã‚Äãpara localizar o servidor C&amp;C. <br><br>  O processo de comunica√ß√£o √© criptografado via RC4 e compactado usando LZMA.  √â poss√≠vel descriptografar o tr√°fego, pois a chave √© adicionada ao in√≠cio dos pacotes.  O formato √© o seguinte: <br> <code>[ RC4 (4 )][ ]</code> <br> <br>  Cada byte de chave √© gerado pela fun√ß√£o <code>rand</code> .  Ap√≥s descriptografar e descompactar o pacote, os dados t√™m o seguinte formato: <br> <code>[dw:][dw:][dw: ][dw: ][dw:] [dw:]</code> <br> <br>  Na primeira vez em que o cliente se conecta ao servidor, o UUID √© transmitido, que √© usado como o identificador da sess√£o.  O √∫ltimo √© armazenado na chave do Registro como dados bin√°rios: <code>HKCU\SOFTWARE\Classes\ AppXc52346ec40fb4061ad96be0e6cb7d16a\DefaultIcon</code> <br><br>  Como dissemos anteriormente, o backdoor tamb√©m cont√©m uma biblioteca chamada <code>HTTPprov</code> .  √â usado como uma maneira alternativa de se comunicar com o servidor.  O arquivo DLL envia uma solicita√ß√£o POST por HTTP.  Ele tamb√©m suporta HTTPS e proxies usando SOCKS5, SOCKS4a e SOCKS4.  A biblioteca est√° estaticamente vinculada ao <code>libcurl</code> . <br><br>  Ap√≥s a inicializa√ß√£o, uma entrada do registro ser√° criada - um comando para que o backdoor use ainda o HTTP para se comunicar com o servidor de comando: <code>HKCU\SOFTWARE\Classes\ CLSID{E3517E26-8E93-458D-A6DF-8030BC80528B}</code> . <br><br>  O aplicativo cliente padr√£o √© usado: <code>Mozilla/4.0 ( ; MSIE 8.0; Windows NT 6.0; Trident/4.0)</code> . <br><br>  A principal caracter√≠stica desta biblioteca √© um algoritmo de criptografia especial para um identificador universal de recursos.  A parte do recurso do URI √© criada usando o seguinte pseudoc√≥digo: <br><br> <code>buffEnd = ((DWORD)genRand(4) % 20) + 10 + buff; while (buff &lt; buffEnd){ <br> b=genRand(16); <br> if (b[0] - 0x50 &gt; 0x50) <br> t=0; <br> else <br> *buf++= UPPER(vowels[b[1] % 5]); <br> v=consonants[b[1]%21]); if (!t) <br> v=UPPER(v); <br> *buff++= v; <br> if (v!='h' &amp;&amp; b[2] - 0x50 &lt; 0x50) <br> *buff++= 'h'; <br> *buff++= vowels[b[4] % 5]; <br> if (b[5] &lt; 0x60) <br> *buff++= vowels[b[6] % 5]; <br> *buff++= consonants[b[7] % 21]; <br> if (b[8] &lt; 0x50) <br> *buff++= vowels[b[9] % 5]; <br> *buff++= '-'; <br> }; <br> *buff='\0';</code> <br> <br>  <b>Nota</b> : para maior clareza, a parte respons√°vel pela verifica√ß√£o do comprimento da string foi removida do c√≥digo. <br><br>  Para obter o identificador da sequ√™ncia gerada, dois n√∫meros s√£o adicionados usando um algoritmo de verifica√ß√£o de soma especial: <br><br> <code>checksum=crc32(buff) <br> num2=(checksum &gt;&gt; 16) + (checksum &amp; 0xffff) * 2 <br> num1=(num2 ^ 1) &amp; 0xf <br> URL=GENERATED_DOMAIN+ ‚Äú/‚Äù + num1 + ‚Äú/‚Äù + num2 + ‚Äú-‚Äù + buff</code> <br> <br>  Adicionando o gerador de URI da biblioteca <code>HTTPprov</code> , obtemos o seguinte URL: <br> <code>hXXp://niggmhggmeggmkggmfggmdggidggngggmjgg.ijhlokga.aisicoin[.]com/ 13/139756-Ses-Ufali-L</code> <br> <br><h3>  Equipas </h3><br>  Depois de receber o identificador da sess√£o SESSIONID, o backdoor faz uma impress√£o digital do sistema.  O pacote √© constru√≠do da seguinte forma (recuo no pacote - descri√ß√£o): <br><br>  <i>0x000</i> - bytes: o valor muda em cada vers√£o <br>  <i>0x001</i> - 0x01: byte codificado <br>  <i>0x002</i> - bool: privil√©gios elevados <br>  <i>0x003</i> - dword: ID da vers√£o <br>  <i>0x007</i> - sequ√™ncia (UTF-16), nome do computador (m√°x. 0x20) <br>  <i>0x027</i> - sequ√™ncia (UTF-16), nome de usu√°rio <br>  <i>0x079</i> - o resultado de uma consulta do registro nos valores <code>HKLM\SOFTWARE\Microsoft\Windows NT\ CurrentVersion</code> : <code>ProductName</code> , <code>CSDVersion</code> , <code>CurrentVersion</code> , <code>ReleaseId</code> , <code>CurrentBuildNumber</code> e o resultado da chamada <code>IsWow64Process (x86|x64)</code> <br>  <i>0x179</i> - o formato subsequente da sequ√™ncia% s (% s);  substitu√≠do por ( <code>GetVolumeInformationW:VolumeNameBuffer</code> ), <code>VolumePathNames</code> <br>  <i>0x279</i> - Disco f√≠sico, controle de E / S de um dispositivo PhysicalDriveIOControl 0x2D1400 (IOCTL_STORAGE_QUERY_ PROPERTY) (VolSerialNumber) <br>  <i>0x379</i> - <i>wmi</i> <code>SELECT SerialNumber FROM Win32_BaseBoard</code> <br>  <i>0x3f9</i> - Obtenha a data e hora atuais GetSystemTimeAsFileTime <br>  <i>0x400</i> - bool: desconhecido <br>  <i>0x401</i> - dword: recebido ap√≥s descriptografar o recurso <br><br>  Aqui est√° um exemplo de uma impress√£o digital do sistema: <br><br><img src="https://habrastorage.org/webt/s5/kg/rj/s5kgrj1nop52oeuj-xgop8c7zsa.jpeg"><br>  <i>Figura 11. Impress√£o digital do sistema</i> <br><br>  Este √© um backdoor completo que fornece a seus operadores v√°rios recursos: manipula√ß√£o de arquivos, registro e processos, download de componentes adicionais, obten√ß√£o de uma impress√£o digital digital do sistema.  Abaixo est√£o os n√∫meros e descri√ß√µes dos comandos suportados: <br><br>  0 - impress√£o digital <br>  1 - define o ID da sess√£o <br>  2 - criando um processo e obtendo um resultado (usando canais de programa) <br>  3 - define o contador de tentativas de conex√£o <br>  4 - adia o tempo de vota√ß√£o <br>  5 - l√™ um arquivo ou chave do registro e considera MD5 <br>  6 - criando um processo <br>  7 - cria um arquivo, entrada do registro ou fluxo na mem√≥ria <br>  8 - grava no registro <br>  9 - pesquisa o registro <br>  10 - procura por arquivos no sistema <br>  11 - transfere arquivos para outro diret√≥rio <br>  12 - remove arquivos do disco <br>  13 - obtendo uma lista de discos marcados no sistema usando a fun√ß√£o <br> <code>GetLogicalDriveStringW</code> <br>  14 - cria um diret√≥rio <br>  15 - remove o diret√≥rio <br>  16 - l√™ o arquivo do deslocamento <br>  17 - chama o carregador PE (alterne para comunica√ß√£o via <code>HTTPprov</code> ) <br>  18 - [desconhecido] <br>  19 - 0: pesquisando o valor no registro;  1: implementa√ß√£o e implementa√ß√£o do programa <br>  20 - define a vari√°vel de ambiente <br>  21 - lan√ßa shellcode em um novo thread <br>  22 - retorna a vari√°vel de ambiente <br>  23 na nova vers√£o - reinicia-se se a vari√°vel de ambiente APPL n√£o existir <br><br><h2>  Conclus√£o </h2><br>  O OceanLotus permanece altamente ativo e continua a atualizar o kit de ferramentas. <br>  O grupo busca ocultar suas atividades, para isso os atacantes selecionam cuidadosamente as v√≠timas, limitam a dissemina√ß√£o de malware, usam v√°rios servidores para n√£o chamar a aten√ß√£o para o mesmo dom√≠nio ou endere√ßo IP.  A descriptografia do componente que est√° sendo implementado e a t√©cnica de carregamento lateral, apesar de sua ampla popularidade, tornam poss√≠vel evitar a detec√ß√£o, uma vez que o trabalho dos invasores, neste caso, √© disfar√ßado de aplicativo leg√≠timo. <br><br><h2>  Indicadores de compromisso (IoCs) </h2><br><h3>  Amostras </h3><br><h4>  Tabela 1: conta-gotas </h4><br><img src="https://habrastorage.org/webt/4z/vz/kh/4zvzkhbbyci_fp6w6jyedbpn42i.png"><br><br><h4>  Tabela 2: Bibliotecas </h4><br><img src="https://habrastorage.org/webt/0g/9i/2r/0g9i2rys-bufj_lmi9xqb7orl3g.png"><br><br><h3>  Rede </h3><br><h4>  Endere√ßos IP </h4><br> <code>46.183.220.81 <br> 46.183.220.82 <br> 46.183.222.82 <br> 46.183.222.83 <br> 46.183.222.84 <br> 46.183.223.106 <br> 46.183.223.107 <br> 74.121.190.130 <br> 74.121.190.150 <br> 79.143.87.230</code> </div> </div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt421779/">https://habr.com/ru/post/pt421779/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt421765/index.html">O que √© um aplicativo Web em produ√ß√£o?</a></li>
<li><a href="../pt421767/index.html">Os mineiros s√£o oferecidos para dar o status de trabalhadores independentes</a></li>
<li><a href="../pt421769/index.html">O livro "Deep Learning on R"</a></li>
<li><a href="../pt421773/index.html">Como uma equipe de t√©cnicos criou sua empresa, a terceira temporada (finalmente voou!)</a></li>
<li><a href="../pt421775/index.html">Rede neural treinada para reconhecer a depress√£o atrav√©s do discurso arbitr√°rio de uma pessoa sem contexto</a></li>
<li><a href="../pt421783/index.html">Estrutura divertida de gerenciamento de estado Huex</a></li>
<li><a href="../pt421785/index.html">A Calif√≥rnia est√° √† beira de uma completa rejei√ß√£o de carbono na produ√ß√£o de energia</a></li>
<li><a href="../pt421787/index.html">Desenvolvimento da arquitetura do projeto, navios e JavaScript</a></li>
<li><a href="../pt421789/index.html">Tornar o front-end "back-end" novamente</a></li>
<li><a href="../pt421791/index.html">Quest√µes √©ticas da intelig√™ncia artificial</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>