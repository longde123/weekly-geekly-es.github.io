<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>‚ö±Ô∏è üßóüèΩ üëêüèΩ Reserva de Kubernetes: Existe üö¥üèΩ ü§õüèª ‚èÆÔ∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Meu nome √© Sergey, sou do ITSumma e quero lhe contar como abordamos a reserva em Kubernetes. Recentemente, tenho realizado muitos trabalhos de consult...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Reserva de Kubernetes: Existe</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/itsumma/blog/452078/">  Meu nome √© Sergey, sou do ITSumma e quero lhe contar como abordamos a reserva em Kubernetes.  Recentemente, tenho realizado muitos trabalhos de consultoria na implementa√ß√£o de uma variedade de solu√ß√µes de devops para v√°rias equipes e, em particular, trabalho de perto em projetos usando K8s.  Na confer√™ncia Uptime day 4, dedicada √† redund√¢ncia em arquiteturas complexas, fiz uma apresenta√ß√£o em cubo redundante e aqui est√° sua recontagem livre.  Apenas avisarei com anteced√™ncia que ele n√£o √© um guia direto para a a√ß√£o, mas uma generaliza√ß√£o de pensamentos sobre esse t√≥pico. <br><br><img src="https://habrastorage.org/webt/fi/pj/ox/fipjoxmwx-hrd0tvm0_bvgjaa-e.jpeg"><br><br>  Em princ√≠pio, monitoramento e redund√¢ncia s√£o as duas principais ferramentas para aumentar a resili√™ncia de qualquer projeto.  Mas no cubador, tudo √© equilibrado por si s√≥, voc√™ diz, tudo √© dimensionado por si s√≥, e se algo acontecer, ele aumentar√° por si mesmo ... Ou seja, durante o primeiro estudo superficial do t√≥pico, a Internet me respondeu a pergunta "Como funciona o backup do K8s?" ? "  Muitas pessoas pensam que um cubo √© uma coisa t√£o m√°gica que elimina todos os problemas de infraestrutura e faz com que o projeto nunca caia.  Mas ... o mundo n√£o √© o que parece. <br><a name="habracut"></a><br>  Como abordamos o processo de backup antes?  T√≠nhamos plataformas id√™nticas para posicionamento - eram m√°quinas virtuais ou servidores de ferro, √†s quais aplicamos tr√™s pr√°ticas b√°sicas: <br><br><ol><li>  sincroniza√ß√£o de c√≥digo e est√°tica </li><li>  sincroniza√ß√£o de configura√ß√£o </li><li>  replica√ß√£o de banco de dados </li></ol><br>  E pronto: a qualquer momento, mudamos para o site de reservas, todo mundo est√° feliz, acordamos e discordamos. <br><br><img src="https://habrastorage.org/webt/mw/ym/zw/mwymzwrfdl9vsaf_hg-wm3wvphm.jpeg"><br><br>  E o que eles nos oferecem para aumentar a disponibilidade constante de nosso aplicativo kubernetes?  A primeira coisa que a documenta√ß√£o n√£o oficial diz √© colocar muitas m√°quinas, criar muitos mestres - o n√∫mero deles deve satisfazer as condi√ß√µes para obter um quorum dentro do cluster e para que o agendador etcd, api, MC seja gerado em cada um dos mestres ... E, parece, est√° tudo bem : quando v√°rios n√≥s ou mestres de trabalho falham, nosso cluster ser√° reequilibrado e o aplicativo continuar√° funcionando.  Parece m√°gica de novo!  Por√©m, muitas vezes nosso cluster est√° localizado no mesmo datacenter e isso pode causar certas perguntas.  E se uma escavadeira chegasse e desenterrasse um cabo, com um raio, houvesse uma inunda√ß√£o universal?  Tudo est√° coberto, nosso cluster n√£o existe mais.  Como abordar a reserva levando em considera√ß√£o esse lado do problema? <br><br>  Antes de tudo, voc√™ deve ter outro cluster na reserva quente, ou seja, um cluster para o qual voc√™ possa alternar a qualquer momento.  Ao mesmo tempo, do ponto de vista do cubador, as infraestruturas devem ser completamente id√™nticas.  Ou seja, se houver algum plug-in n√£o-padr√£o para trabalhar com o sistema de arquivos, solu√ß√µes personalizadas para entrada, eles dever√£o ser completamente id√™nticos nos seus dois (ou tr√™s ou dez, h√° dinheiro e for√ßa de administrador suficientes).  √â necess√°rio definir claramente dois conjuntos de aplicativos (deployment'ov, statefulset'ov, daemonset'ov, cronjob'ov etc.): quais deles podem trabalhar em uma reserva constantemente e quais s√£o melhores para n√£o iniciar antes da troca direta. <br><br>  Ent√£o, nosso cluster de backup deve ser completamente id√™ntico ao nosso cluster de combate?  N√£o.  Anteriormente, na estrutura de trabalho com projetos monol√≠ticos, com infraestrutura de ferro, mantivemos um ambiente quase completamente id√™ntico, mas na estrutura do cubador, acho que n√£o deveria ser.  Vamos ver o porqu√™. <br><br>  Por exemplo, vamos come√ßar com as entidades b√°sicas do kubernetes - implanta√ß√µes - elas devem ser id√™nticas.  Devem ser lan√ßados aplicativos que podem interceptar o processamento do tr√°fego a qualquer momento e permitir que o nosso projeto continue ativo.  Se estamos falando sobre arquivos de configura√ß√£o, precisamos verificar aqui se eles devem ser id√™nticos ou n√£o.  Ou seja, se n√≥s, pessoas inteligentes, n√£o usarmos subst√¢ncias proibidas e n√£o mantivermos a base nos K8s, nos configmaps, deveremos ter configura√ß√µes de acesso √† base de combate (cujo processo de backup √© constru√≠do separadamente).  Portanto, para garantir o acesso √† inst√¢ncia do banco de dados de backup, precisamos ter um arquivo de configura√ß√£o separado (configmap).  Exatamente da mesma maneira que trabalhamos com segredos: senhas para acessar o banco de dados, chaves api;  a qualquer momento, um segredo de combate ou uma reserva pode ser trabalhada conosco.  No total, j√° temos duas entidades kubernetes cujas vers√µes de backup n√£o devem ser id√™nticas √†s de combate.  A pr√≥xima entidade que vale a pena se concentrar √© o cronjob.  Cronjobs em reserva n√£o devem ser de forma alguma id√™nticos ao conjunto de clusters de produ√ß√£o do cronjob!  Se aumentarmos o cluster de backup e aumentarmos completamente com todo o cronjob ativado, ent√£o, por exemplo, as pessoas receber√£o duas cartas suas ao mesmo tempo, em vez de uma.  Ou algum tipo de sincroniza√ß√£o de dados com fontes externas ocorrer√° duas vezes, respectivamente, come√ßamos a magoar, chorar, gritar e xingar. <br><br><img src="https://habrastorage.org/webt/m3/n2/yx/m3n2yxmvocsvsfiavdmevq4vx18.jpeg"><br><br>  Mas como as pessoas da Internet nos oferecem a organiza√ß√£o de um cluster de backup?  A segunda resposta mais popular depois de "por qu√™?"  - uso da Federa√ß√£o Kubernetes. <br><br>  O que √© isso  Este √©, digamos, um grande meta cluster.  Se imaginarmos a arquitetura do cubo - onde temos um mestre, v√°rios n√≥s -, do ponto de vista da federa√ß√£o, tamb√©m temos um mestre e v√°rios n√≥s, apenas cada n√≥ √© um cluster separado.  Ou seja, trabalhamos com as mesmas entidades, com as mesmas primitivas que com um √∫nico cubador, mas torcemos e giramos n√£o nossas m√°quinas f√≠sicas, mas aglomerados inteiros.  No √¢mbito da federa√ß√£o, estamos em completa sincroniza√ß√£o de recursos federais, de pais para descendentes.  Por exemplo, se lan√ßarmos alguma implanta√ß√£o por meio da federa√ß√£o, ela ser√° implantada em cada um de nossos clusters subsidi√°rios.  Se pegarmos qualquer mapa de configura√ß√£o, o segredo √© lan√ß√°-lo na federa√ß√£o - ele se espalhar√° por todos os nossos clusters filhos;  ao mesmo tempo, a federa√ß√£o nos permite personalizar nossos recursos para crian√ßas.  Ou seja, pegamos um mapa de configura√ß√£o, implantamos na federa√ß√£o e, em seguida, se precisarmos corrigir algo em clusters espec√≠ficos, vamos editar em um cluster separado, e essa altera√ß√£o n√£o ser√° sincronizada em nenhum lugar. <br><br>  A Federa√ß√£o Kubernetes n√£o √© h√° muito tempo uma ferramenta existente e n√£o suporta todo o conjunto de recursos que o pr√≥prio K8s fornece: no momento da publica√ß√£o de uma das primeiras vers√µes da documenta√ß√£o, estava falando sobre o suporte apenas a mapas de configura√ß√£o, implanta√ß√£o para conjunto de r√©plicas e entrada.  Segredos n√£o eram suportados, o trabalho com volume tamb√©m n√£o era suportado.  Conjunto muito limitado.  Especialmente se gostarmos de nos divertir, por exemplo, atrav√©s da defini√ß√£o de recursos personalizados para transferir nossos pr√≥prios recursos para os kubernetes, n√£o os enviaremos para a federa√ß√£o.  Isto √©, por assim dizer ... uma decis√£o muito semelhante √† verdade, mas nos faz periodicamente dar um tiro no p√©.  Por outro lado, a federa√ß√£o permite que voc√™ gerencie com flexibilidade nosso conjunto de r√©plicas.  Por exemplo, queremos que 10 r√©plicas de nosso aplicativo sejam iniciadas. Por padr√£o, a federa√ß√£o dividir√° esse n√∫mero proporcionalmente entre o n√∫mero de clusters.  E tudo isso tamb√©m pode ser configurado!  Ou seja, voc√™ pode especificar que precisa manter 6 r√©plicas de nosso aplicativo no cluster de combate e apenas 4 r√©plicas de nosso aplicativo no cluster de backup, para economizar recursos ou para seu pr√≥prio entretenimento.  O que tamb√©m √© bastante conveniente.  Mas com a federa√ß√£o, precisamos usar algumas solu√ß√µes novas, finalizar algo em movimento e nos for√ßar a pensar um pouco mais ... <br><br>  √â poss√≠vel abordar o processo de reservar um cubador de alguma forma mais simples?  Quais ferramentas n√≥s temos? <br><br>  Primeiramente, sempre temos algum tipo de sistema ci / cd, ou seja, n√£o andamos manualmente, n√£o escrevemos criar / aplicar nos servidores.  O sistema gera yaml'ics para nossos cont√™ineres. <br><br>  Em segundo lugar, existem v√°rios clusters, temos um ou v√°rios (se formos inteligentes) registro, que tamb√©m utilizamos e reservamos.  E existe um maravilhoso utilit√°rio kubectl que pode trabalhar com v√°rios clusters simultaneamente. <br><br><img src="https://habrastorage.org/webt/vs/ib/ed/vsibeda9uobcn8jtrfztjkln3ag.jpeg"><br><br>  Ent√£o: na minha opini√£o, a solu√ß√£o mais simples e correta para criar um cluster de backup √© uma implanta√ß√£o paralela primitiva.  Existe algum tipo de pipeline no sistema ci / cd;  primeiro, constru√≠mos nossos cont√™ineres, testamos e implementamos aplicativos atrav√©s do kubectl para v√°rios clusters independentes.  Podemos construir c√°lculos simult√¢neos em v√°rios clusters.  Dessa forma, tamb√©m decidimos fornecer configura√ß√µes nesta fase.  √â poss√≠vel pr√©-definir o conjunto de configura√ß√µes para nosso cluster de combate, o conjunto de configura√ß√µes para o cluster de backup e, no n√≠vel ci / cd do sistema, rolar o pr√≥-ambiente para o pr√≥-cluster, o ambiente de backup para o cluster de backup.  Comparado com a federa√ß√£o, voc√™ n√£o precisa definir um recurso federal para cada cluster filho e redefinir algo.  Fizemos isso com anteced√™ncia.  Que bons companheiros somos. <br><br>  Mas ... existe ... eu escrevi, existe a "raiz de todo mal", mas na verdade existem duas delas.  O primeiro √© o sistema de arquivos.  Existe algum tipo de PV, ou usamos armazenamento externo.  Se armazenarmos arquivos dentro do cluster, precisaremos seguir as pr√°ticas antigas remanescentes da √©poca das infraestruturas de ferro: por exemplo, sincronize com o lsync.  Bem, ou qualquer outra muleta que voc√™ pessoalmente prefira.  N√≥s rolamos tudo para outros carros e ao vivo. <br><br>  Em segundo lugar, e, de fato, um obst√°culo ainda mais importante √© o banco de dados.  Se somos pessoas inteligentes e n√£o mantemos o banco de dados no cubo, o processo de backup de dados de acordo com o mesmo esquema antigo √© a replica√ß√£o mestre-escravo e, em seguida, alternamos, acompanharemos a r√©plica e viveremos bem.  Por√©m, se mantivermos nosso banco de dados dentro do cluster, em princ√≠pio, existem muitas solu√ß√µes prontas para organizar a mesma r√©plica mestre-escravo, muitas solu√ß√µes para aumentar o banco de dados dentro do cubo. <br>  Um bilh√£o de relat√≥rios j√° foi lido sobre backups de bancos de dados, um bilh√£o de artigos foram escritos, nada de novo √© necess√°rio aqui, na verdade.  Em geral, siga seu sonho, viva como quiser, invente algumas muletas complicadas tamb√©m, mas n√£o deixe de pensar em como voc√™ reservar√° tudo isso. <br><br>  E agora, sobre como, em princ√≠pio, teremos o processo de mudar para o site de backup em caso de inc√™ndio.  Primeiro, implantamos aplicativos sem estado em paralelo.  Eles n√£o afetam a l√≥gica de neg√≥cios de nossos aplicativos, nosso projeto, podemos manter constantemente dois conjuntos de aplicativos em execu√ß√£o e podem come√ßar a receber tr√°fego.  √â muito importante no processo de mudan√ßa para o site de backup para ver definitivamente se as configura√ß√µes precisam ser redefinidas?  Por exemplo, temos um cluster de vendas kubernetes, existe um cluster de backup kubernetes, h√° um banco de dados mestre externo e um banco de dados mestre de backup.  Temos quatro op√ß√µes para como esses aplicativos no produto podem come√ßar a interagir entre si.  Nossa base pode mudar, e acontece que precisamos mudar o tr√°fego para a nova base no cluster de produtos, ou podemos obter o cluster e nos mudamos para a reserva, mas continuamos trabalhando com a base profissional, bem, a terceira op√ß√£o, quando a obtivemos , ele est√° ferrado e alternamos os dois aplicativos, redefinimos nossa configura√ß√£o para que novos aplicativos j√° funcionem com o novo banco de dados. <br><br>  Bem, na verdade, que conclus√µes podem ser tiradas disso tudo? <br><br><img src="https://habrastorage.org/webt/rl/81/0a/rl810a1jyyc78gkz0cop0gjzhma.jpeg"><br><br>  A primeira conclus√£o: viver bem com uma reserva.  Mas caro.  Mas, idealmente, vivendo com mais de uma reserva.  Idealmente, voc√™ geralmente precisa viver com v√°rias reservas.  Em primeiro lugar, a reserva deve estar pelo menos n√£o em um CD e, em segundo lugar, pelo menos, em outro host.  Muitas vezes acontecia - e na minha pr√°tica era.  Infelizmente, n√£o posso citar os projetos, exatamente quando houve um inc√™ndio no data center ... sou assim: estamos mudando para a reserva!  E os servidores de backup no mesmo rack estavam ... <br><br>  Ou imagine que a Amazon tenha sido banida na R√∫ssia (e isso foi).  E tudo: a sensa√ß√£o de que em outra amaz√¥nia reside nossa reserva?  Tamb√©m n√£o est√° dispon√≠vel.  Por isso, repito: mantemos a reserva, pelo menos, em outro CD e, de prefer√™ncia, com outro host. <br><br>  A segunda conclus√£o: se seu aplicativo se comunicar com algumas fontes externas (pode ser um banco de dados ou alguma API externa), defina-o como um servi√ßo com um ponto de extremidade externo, para que voc√™ n√£o precise corrigi-lo no momento da altern√¢ncia 15 de seus aplicativos que est√£o batendo na mesma base.  Defina o banco de dados como um servi√ßo separado, bata nele como se estivesse dentro do cluster: se voc√™ tiver um banco de dados, mude o ip em um local e continue a viver feliz. <br><br>  E finalmente: eu amo o ‚Äúcubo‚Äù, bem como experimentos com ele.  Tamb√©m gosto de compartilhar os resultados desses experimentos e, em geral, minha experi√™ncia pessoal.  Portanto, gravei uma s√©rie de semin√°rios on-line sobre K8s, bem no <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">nosso canal do youtube</a> para obter detalhes. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt452078/">https://habr.com/ru/post/pt452078/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt452066/index.html">Excelsior JET interrompe o desenvolvimento de seu compilador AOT ap√≥s 18 anos de trabalho</a></li>
<li><a href="../pt452068/index.html">12. Introdu√ß√£o ao Ponto de Verifica√ß√£o R80.20. Logs e relat√≥rios</a></li>
<li><a href="../pt452072/index.html">Implementamos CircularRevealAnimation no Flutter e publicamos simultaneamente a biblioteca em pub.dev</a></li>
<li><a href="../pt452074/index.html">O primeiro jogo de unidade ou o que me levou seis meses</a></li>
<li><a href="../pt452076/index.html">Quebrando o navegador UC</a></li>
<li><a href="../pt452082/index.html">Fluxo flex√≠vel de atualiza√ß√µes no aplicativo: acelere o processo de atualiza√ß√£o de aplicativos no Android</a></li>
<li><a href="../pt452086/index.html">O que h√° no meu pixel para voc√™: cria√ß√£o de nanopixels usando metassuperf√≠cies de plasmon</a></li>
<li><a href="../pt452088/index.html">Reconhecimento de estradas por segmenta√ß√£o sem√¢ntica</a></li>
<li><a href="../pt452090/index.html">Criando um gerador de quebra-cabe√ßas procedural</a></li>
<li><a href="../pt452092/index.html">Atualiza√ß√µes no aplicativo: Acelerando as atualiza√ß√µes de aplicativos Android</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>