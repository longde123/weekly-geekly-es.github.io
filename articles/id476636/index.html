<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ğŸ‘©ğŸ¿â€ğŸŒ¾ ğŸ‘ğŸ¿ ğŸŒº Tuning Firebird dan Linux untuk database berukuran 691 GB dengan 1000+ pengguna ğŸ¤ ğŸ‘©â€ğŸ¨ ğŸ¤µ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Firebird adalah DBMS terbuka yang sangat populer di Rusia, dan meskipun tidak ada kampanye pemasaran yang bising, Firebird digunakan dalam sejumlah be...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Tuning Firebird dan Linux untuk database berukuran 691 GB dengan 1000+ pengguna</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/476636/"> Firebird adalah DBMS terbuka yang sangat populer di Rusia, dan meskipun tidak ada kampanye pemasaran yang bising, Firebird digunakan dalam sejumlah besar sistem kritis, terutama dalam sistem otomatisasi medis dan negara. <br><br>  Ukuran basis data dan jumlah pengguna aktif dalam sistem seperti itu biasanya cukup besar, jadi dalam artikel ini saya akan berbicara tentang pengalaman mengoptimalkan pengaturan Firebird dan Linux berdasarkan contoh spesifik dari basis data Firebird besar di <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">BeZdorov</a> (Ingosstrakh), <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">AlfaZdrav</a> , dan saya akan <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">menyentuh</a> pengalaman perusahaan pengoptimalan lainnya. Firebird + Linux. <br><br>  Mari kita melihat lebih dekat pada subjek optimasi - Firebird 3.0.5 DBMS (dengan ekstensi HQbird), melayani basis data 691GB (saat ini) dengan 1000-1100 pengguna harian, berjalan pada Linux CentOS 7, server menggunakan besi HP DL380.  Replikasi ke server cadangan dikonfigurasikan untuk basis data (pertanyaan replikasi berada di luar cakupan artikel ini). <br><a name="habracut"></a><br>  DBMS melayani sistem informasi medis Infoklinika (diproduksi oleh perusahaan Rusia <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Smart Delta Systems</a> ), yang merupakan salah satu sistem informasi medis paling populer di Rusia. <br><br>  Mari kita lihat detailnya (screenshot diambil dari HQbird nanti) dari operasi database ini: <br><br>  Data dimasukkan secara intensif ke dalam basis data - keuntungan harian sekitar 0,4 - 0,5 GB <br><br><img src="https://habrastorage.org/webt/vf/v7/4k/vfv74kl3pcxkou42snnuyv98fqg.png"><br><br>  1000-1100 koneksi adalah beban harian yang biasa: <br><br><img src="https://habrastorage.org/webt/73/qj/5t/73qj5tu1spoxlkq7debfz8ifn2q.png"><br><br>  Meskipun pertumbuhan intensif dan pekerjaan aktif, database tidak mengandung sejumlah besar versi catatan sampah - keduanya berkat aplikasi yang ditulis dengan pengetahuan yang baik tentang arsitektur multi-versi, dan karena pengumpulan sampah yang dikonfigurasi dengan benar: <br><br><img src="https://habrastorage.org/webt/sy/zg/rj/syzgrjtckhyhydolkmeufwwgb_q.png"><br><br>  Penanda Transaksi di Zona Hijau: <br><br><img src="https://habrastorage.org/webt/vn/1h/wu/vn1hwu2celimgvpgtioyfugumsi.png"><br><br>  By the way, perhatikan bahwa data dalam database adalah string, gumpalan hadir, tetapi ada beberapa dari mereka - hanya 10 GB dari 690 GB dari ukuran total. <br><br>  Sifat beban basis data adalah campuran, 75% operasi baca dan 25% tulis: <br><br><img src="https://habrastorage.org/webt/k2/gr/xz/k2grxztnytufblqb0y6idmfljeo.png"><br><br><h3>  Besi </h3><br>  Server yang melayani sistem ini tidak buruk, tetapi jauh dari top-end: <br><br><pre><code class="plaintext hljs">HP ProLiant DL380p Gen8, Gen8 2x Xeon(R) CPU E5v2 @ 2.60GHz, 24 logical cores with HT 320Gb RAM, 4 network cards</code> </pre> <br>  Subsistem disk terdiri dari dua bagian: disk 745Gb lokal dan koneksi 2 saluran serat ganda ke SAN, dengan partisi 1,8Tb. <br><br><h3>  Sistem operasi </h3><br>  Menggunakan CentOS 7, versi kernel: <br><br><pre> <code class="plaintext hljs">Linux version 3.10.0-957.21.3.el7.x86_64 (mockbuild@kbuilder.bsys.centos.org) (gcc version 4.8.5 20150623 (Red Hat 4.8.5-36) (GCC) ) #1 SMP Tue Jun 18 16:35:19 UTC 2019</code> </pre><br>  Untuk pertanyaan logis, mengapa kernel paling modern dan CentOS 8 tidak digunakan, jawabannya juga logis - migrasi sistem kritis hanya terjadi setelah rilis beberapa rilis minor dan pengujian yang ketat - ini adalah salah satu kasus ketika bug yang dikenal lebih baik daripada dua yang tidak diketahui. <br><br>  Namun, perlu dicatat bahwa hingga 2017 sistem bekerja pada CentOS 6.x, dan setelah migrasi, peningkatan yang signifikan dalam indikator kinerja dicatat. <br><br><h2>  Pengaturan Linux </h2><br><h3>  Kustomisasi Linux yang Sangat Penting untuk Firebird </h3><br>  Ada 2 parameter yang harus ditingkatkan pada semua server Linux tempat Firebird berjalan - jumlah area memori virtual (VMA) dan jumlah file yang terbuka untuk proses Firebird. <br><br>  <b>1. VMA</b> <br><br>  Nomor VMA default adalah 64K, harus ditingkatkan 4 kali, untuk ini, tambahkan baris di sysctl.conf <br><br><pre> <code class="bash hljs">vm.max_map_count=262144</code> </pre> <br>  Untuk memeriksa nilai saat ini, gunakan perintah <br><br><pre> <code class="bash hljs">sysctl vm.max_map_count</code> </pre> <br>  <b>2. Max Buka File</b> <br><br>  Firebird membuka hingga 20 deskriptor (pegangan file) untuk setiap koneksi ke basis data (mengingat fakta bahwa di Linux semua sumber daya terlihat seperti file), sehingga jumlah maksimum file yang terbuka secara default (biasanya 4.096) dapat sangat cepat habis. <br><br>  Untuk memeriksa jumlah file yang tersedia untuk Firebird, yang terbaik adalah melihat batas-batas file executable Firebird: <br><br><pre> <code class="bash hljs">cat /proc/$(pgrep firebird)/limits</code> </pre> <br>  di mana memeriksa nilai untuk Max Open Files dan meningkatkannya jika perlu. <br><br>  Untuk meningkatkan parameter Max Open Files untuk Firebird, kami menambahkan baris ke file firebird-superserver.service di bagian [layanan]: <br><br><pre> <code class="bash hljs">LimitNOFILE=49999</code> </pre> <br><h3>  Pengaturan Linux opsional </h3><br>  Di server ini, kami juga membuat pengaturan berikut <br><br>  <b>1. Mengurangi swapiness</b> <br><br>  Karena server didedikasikan khusus untuk DBMS Firebird, dan kami ingin menggunakan RAM secara efisien di bawah cache DBMS dan cache file sistem operasi, kami mengurangi swapiness dari default 60% menjadi 10%, untuk ini kami menambahkan sysctl.conf <br><br><pre> <code class="bash hljs">vm.swappiness=10</code> </pre> <br>  <b>2. Meningkatkan ukuran memori minimum yang dicadangkan untuk proses OS khusus</b> <br><br><pre> <code class="bash hljs">vm.min_free_kbytes=1048576</code> </pre> <br>  yaitu 1GB memori.  Pengaturan ini secara tidak langsung memengaruhi defragmentasi memori. <br><br>  Harap dicatat bahwa pengaturan ini bersifat individual - mengingat bahwa kami memiliki 320GB RAM, 1GB tidak terlalu banyak, tetapi dalam kasus jumlah memori yang kecil (misalnya, 32GB), 1GB mungkin terlalu banyak. <br><br>  <b>3. Mengurangi keepalive</b> <br><br>  Firebird bergantung pada interval keepalive untuk memeriksa status koneksi, dan nilai default keepalive bisa sangat besar.  Membatasinya hingga 300 detik, kami menyingkirkan koneksi yang menggantung <br><br><pre> <code class="bash hljs">net.ipv4.tcp_keepalive_time=300 net.ipv4.tcp_keepalive_probes=5 net.ipv4.tcp_keepalive_intvl=15</code> </pre> <br><h3>  Lebih Banyak Tuning Linux </h3><br>  Mengapa kita terbatas pada sejumlah kecil pengaturan Linux? <br><br>  Pertama, kami mengambil pendekatan konservatif untuk mengatur server dengan Linux (yang semakin baik dengan setiap versi baru), dan kedua, basis data Firebird ini tidak terlalu besar atau paling banyak dimuat, dan Linux berupaya dengan pengaturan yang ditentukan dengan tugas Anda. <br><br>  Tentu saja, ada beberapa pengaturan yang dapat digunakan untuk mengoptimalkan pekerjaan Firebird di Linux - misalnya, sejumlah hal menarik disajikan dalam <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">presentasi tentang basis data Firebird 3 TB (RedBaza)</a> di Layanan Federal Bailiff. <br><br><h2>  Konfigurasikan Firebird </h2><br>  File konfigurasi komunitas Firebird dengan firebirdsql.org dikonfigurasi dengan sangat konservatif, dan pada server yang kurang lebih kuat Anda perlu mengubah file konfigurasi dan dengan hati-hati memilih arsitektur yang digunakan (dalam Firebird 3.0 ada 2 jenis koneksi: Embedded dan NetworkServer, dan 3 jenis arsitektur: SuperServer , SuperClassic, Klasik). <br>  Selain itu, Anda harus menggunakan pengaturan untuk setiap basis data - mis.  letakkan pengaturan kritis di databases.conf, dengan referensi ke database tertentu. <br><br>  Dalam kasus kami, kami memilih arsitektur SuperServer, yang paling populer di versi 3.0, karena  secara efisien menggunakan prosesor multi-core dan memiliki cache yang dibagikan untuk semua koneksi (tetapi terpisah untuk setiap database). <br><br>  Berikut ini adalah file konfigurasi (hanya nilai terkait kinerja): <br><br>  <b>firebird.conf - file konfigurasi untuk semua database di server</b> <br><br><pre> <code class="plaintext hljs">DefaultDbCachePages = 50K # pages FileSystemCacheThreshold = 300K # pages TempBlockSize = 2M # bytes TempCacheLimit = 20480M # bytes LockMemSize = 30M # bytes LockHashSlots = 30011 WireCompression = true ServerMode = Super ExtConnPoolSize = 500 # HQBird ExtConnPoolLifeTime = 14200 # HQBird SortDataStorageThreshold = 8192 #HQbird reports queries</code> </pre> <br>  Dalam hal kinerja, parameter utama di sini adalah: <br><br>  <b>1. DefaultDbCachePages = 50K # diukur dalam halaman, pada DB, pada halaman 16K = 0.8Gb</b> <br><br>  Ukuran cache halaman DefaultDbCachePages di firebird.conf secara khusus diatur secara default ke 800Mb sehingga database pengujian yang tidak sengaja berantakan di server tidak mencoba untuk mengambil sejumlah besar RAM. <br><br>  <b>2. FileSystemCacheThreshold = 300K # halaman</b> <br><br>  Penting untuk mengatur parameter ini ke nilai yang lebih besar dari DefaultDBCachePages untuk memungkinkan penggunaan cache file OS. <br><br>  <b>3. TempCacheLimit = 20480M # byte</b> <br><br>  Parameter ini menetapkan ukuran memori untuk kueri dengan sort (dan beberapa operasi lainnya), dan bersifat individual untuk setiap sistem. <br>  Sebagai hasil dari pemantauan ukuran, kami menemukan bahwa 20GB optimal untuk database ini. <br><br>  <b>4. LockMemSize dan LockHashSlots - parameter dari tabel kunci</b> <br><br>  Parameter ini menentukan ukuran awal tabel kunci dan jumlah slot untuk menghitung fungsi hash. <br><br>  <b>5. WireCompression = Benar</b> <br><br>  Mengkonfigurasi kompres lalu lintas antara klien dan server, ini sangat berguna dengan Execute Statement On External, yang menjalankan aplikasi klien. <br><br>  Parameter yang tersisa dijelaskan dalam firebird.conf itu sendiri dan dokumentasi terkait Firebird dan HQbird. <br><br>  Kami membuat pengaturan paling penting di <b>databases.conf</b> , dengan basis data yang tepat <br><br><pre> <code class="plaintext hljs">database1 = /data/database1.fdb { DefaultDbCachePages = 14080K # 16K pages, 220 GB FileSystemCacheThreshold = 15361K TempSpaceCacheThreshold=2G #HQbird only, track big sorts LockHashSlots = 40099 LockMemSize = 50M }</code> </pre> <br>  Seperti yang bisa Anda tebak, kesulitan utama dalam hal ini adalah bagaimana cara menghitung dengan benar ukuran memori yang dialokasikan oleh basis data besar kami. <br><br>  Untuk Firebird 3.0 dengan arsitektur SuperServer, ada dua pendekatan - konservatif, yang digunakan pada server dengan jumlah RAM yang kecil (hingga 32GB inklusif), yang terdiri dari mengalokasikan tidak lebih dari 25% RAM untuk cache halaman, dan sisanya bergantung pada sistem operasi file sistem, dan fine-tuning, ketika kita secara tepat menentukan ukuran optimal untuk menyortir, mengalokasikan ukuran memori tertentu untuk kernel OS, cadangan sejumlah memori untuk operasi file besar-besaran (misalnya, cadangan),  sisanya dialokasikan untuk cache halaman. <br><br>  Dalam kasus kedua, tidak mungkin untuk segera mendapatkan ukuran cache yang optimal, karena sifat beban dapat sangat berbeda untuk berbagai jenis database, tetapi setelah beberapa iterasi Anda dapat mencapai hasil yang sangat baik. <br><br><h3>  Kesalahan umum dalam mengonfigurasi Firebird </h3><br>  Kesalahan umum meliputi: <br><br>  1) Ukuran cache halaman secara eksplisit ditentukan pada halaman header DB, yang menimpa nilai yang ditentukan dalam firebird.conf dan databases.conf. <br><br>  Terutama sering kesalahan ini terjadi ketika mengubah arsitektur dari Classic / SuperClassic ke SuperServer - jika ukuran cache untuk koneksi Classic / SuperClassic berfungsi dengan baik dengan ukuran kecil (500-2000 halaman) yang ditunjukkan dengan jelas, maka diperlukan cache yang lebih besar untuk SuperServer. <br>  Untuk memeriksa, jalankan perintah <br><br><pre> <code class="plaintext hljs">gstat -h databasepathname</code> </pre> <br>  dan periksa nilai <code>Page Buffers</code> - itu harus 0, maka Firebird akan menggunakan nilai-nilai dari databases.conf atau firebird.conf. <br><br>  Untuk mengatur ulang pengaturan cache halaman pada halaman header, jalankan perintah <br><br><pre> <code class="plaintext hljs">gfix -buff 0 databasepathname</code> </pre> <br>  2) Ketika meningkatkan cache halaman, mereka lupa untuk meningkatkan FileSystemCacheThreshold, yang mengarah pada pemutusan cache file, yang mengurangi kinerja. <br><br>  3) Menggunakan ukuran halaman database default (4096 atau 8192), sedangkan untuk database besar Anda perlu menggunakan 16K. <br><br><h2>  Kesimpulan </h2><br>  Secara umum, 1000+ pengguna Firebird menggunakan besi, sesuai dengan beban yang dikonfigurasikan oleh Linux dan dikonfigurasikan oleh Firebird, bekerja tanpa masalah.  Ada margin pada server ini dalam hal kinerja, yang diuji pada beban puncak hingga 1500-1800 pengguna. <br><br>  Di antara distribusi Linux untuk basis data Firebird dengan beban yang serupa, yang paling populer adalah CentOS 7, versi yang direkomendasikan adalah Firebird 3.0. <br><br>  Jika Anda memiliki pertanyaan, dengan senang hati saya akan menjawab di komentar, atau melalui email ak@ibase.ru. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/id476636/">https://habr.com/ru/post/id476636/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../id476618/index.html">Bagaimana Saya Merancang Kit Fokus</a></li>
<li><a href="../id476620/index.html">SP701 + PCAM-5C + 15 Menit + VITIS = Easy MIPI di FPGA</a></li>
<li><a href="../id476624/index.html">Jalur pipa berkualitas dalam pengembangan seluler, bagian 1: Android</a></li>
<li><a href="../id476626/index.html">PVS-Studio di Awan: GitLab CI / CD</a></li>
<li><a href="../id476628/index.html">PVS-Studio beralih ke cloud: GitLab CI / CD</a></li>
<li><a href="../id476640/index.html">Melindungi Zimbra OSE dari brute force dan serangan DoS</a></li>
<li><a href="../id476644/index.html">Lapisan bahasa</a></li>
<li><a href="../id476646/index.html">3-arah bergabung di werf: penyebaran di Kubernetes dengan Helm "on steroids"</a></li>
<li><a href="../id476648/index.html">Lenovo di FINOPOLIS 2019</a></li>
<li><a href="../id476650/index.html">Tempat enum di dunia yang berubah saat ini</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>