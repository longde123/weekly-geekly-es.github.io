<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ğŸ¥ âœ”ï¸ â¬ Angularä¸­çš„WebSocketsï¼šåˆ›å»ºAngular Serviceä»¥ä½¿ç”¨Webå¥—æ¥å­— ğŸ‚ğŸ¾ âš”ï¸ ğŸ“´</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="åœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘å°†å°è¯•è¯¦ç»†ä»‹ç»Angularæ¡†æ¶åŠå…¶å·²ä¸å¯æˆ–ç¼ºçš„åŠ©æ‰‹-RxJsæ¡†æ¶å†…çš„æŠ€æœ¯èŒƒå›´ï¼Œè€Œæˆ‘ä»¬ä¸ä¼šæ•…æ„æ¶‰åŠæœåŠ¡å™¨å®ç°ï¼Œå› ä¸º è¿™æ˜¯å¦ä¸€ç¯‡æ–‡ç« çš„å®Œæ•´ä¸»é¢˜ã€‚ 

 å¯¹äºé‚£äº›å·²ç»ç†Ÿæ‚‰Angularä½†æƒ³è¦ç›´æ¥åŠ æ·±ä»–ä»¬å¯¹è¯¥ä¸»é¢˜çš„çŸ¥è¯†çš„äººæ¥è¯´ï¼Œæœ¬æ–‡å°†æ˜¯æœ‰ç”¨çš„ã€‚ 

 é¦–å…ˆï¼Œä¸€äº›åŸºæœ¬ä¿¡æ¯ã€‚ 

 ä»€ä¹ˆæ˜¯WebS...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Angularä¸­çš„WebSocketsï¼šåˆ›å»ºAngular Serviceä»¥ä½¿ç”¨Webå¥—æ¥å­—</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/416155/"><img src="https://habrastorage.org/webt/dz/-h/c_/dz-hc_la-a4emvhkqbd4ihr5zfe.jpeg" alt="å›¾ç‰‡"><br> åœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘å°†å°è¯•è¯¦ç»†ä»‹ç»Angularæ¡†æ¶åŠå…¶å·²ä¸å¯æˆ–ç¼ºçš„åŠ©æ‰‹-RxJsæ¡†æ¶å†…çš„æŠ€æœ¯èŒƒå›´ï¼Œè€Œæˆ‘ä»¬ä¸ä¼šæ•…æ„æ¶‰åŠæœåŠ¡å™¨å®ç°ï¼Œå› ä¸º è¿™æ˜¯å¦ä¸€ç¯‡æ–‡ç« çš„å®Œæ•´ä¸»é¢˜ã€‚ <br><br> å¯¹äºé‚£äº›å·²ç»ç†Ÿæ‚‰Angularä½†æƒ³è¦ç›´æ¥åŠ æ·±ä»–ä»¬å¯¹è¯¥ä¸»é¢˜çš„çŸ¥è¯†çš„äººæ¥è¯´ï¼Œæœ¬æ–‡å°†æ˜¯æœ‰ç”¨çš„ã€‚ <br><a name="habracut"></a><br> é¦–å…ˆï¼Œä¸€äº›åŸºæœ¬ä¿¡æ¯ã€‚ <br><br><h2> ä»€ä¹ˆæ˜¯WebSocketï¼Œä¸ºä»€ä¹ˆéœ€è¦å®ƒ </h2><br><blockquote> æ ¹æ®<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Wikipediaçš„</a>è¯´æ³•ï¼ŒWebSocketæ˜¯ä¸€ç§â€œåŒå·¥é€šä¿¡åè®®ï¼ˆå®ƒå¯ä»¥åŒæ—¶å‘é€å’Œæ¥æ”¶ï¼‰ï¼Œå®ƒå¯ä»¥é€šè¿‡TCPè¿æ¥è¿›è¡Œä¼ è¾“ï¼Œæ—¨åœ¨ç”¨äºæµè§ˆå™¨å’ŒWebæœåŠ¡å™¨ä¹‹é—´çš„å®æ—¶æ¶ˆæ¯ä¼ é€’ã€‚ <br>  WebSocketæ—¨åœ¨åœ¨Webæµè§ˆå™¨å’ŒWebæœåŠ¡å™¨ä¸­å®ç°ï¼Œä½†å¯ç”¨äºä»»ä½•å®¢æˆ·ç«¯æˆ–æœåŠ¡å™¨åº”ç”¨ç¨‹åºã€‚  WebSocketåè®®æ˜¯åŸºäºTCPåè®®çš„ç‹¬ç«‹åè®®ã€‚ å®ƒä½¿æµè§ˆå™¨ä¸ç½‘ç«™ä¹‹é—´çš„äº¤äº’æ›´åŠ ç´§å¯†ï¼Œä»è€Œä¿ƒè¿›äº†äº¤äº’å¼å†…å®¹çš„åˆ†å‘å’Œå®æ—¶åº”ç”¨ç¨‹åºçš„åˆ›å»ºã€‚â€ <br></blockquote><br> æ¢å¥è¯è¯´ï¼ŒWebSocketå…è®¸æœåŠ¡å™¨åœ¨ä»»ä½•æœŸæœ›çš„æ—¶é—´ä»å®¢æˆ·ç«¯æ¥æ”¶è¯·æ±‚å¹¶å°†è¯·æ±‚å‘é€åˆ°å®¢æˆ·ç«¯ï¼Œå› æ­¤ï¼Œæµè§ˆå™¨ï¼ˆå®¢æˆ·ç«¯ï¼‰å’ŒæœåŠ¡å™¨åœ¨è¿æ¥æ—¶å…·æœ‰åŒç­‰çš„æƒé™å’Œäº¤æ¢æ¶ˆæ¯çš„èƒ½åŠ›ã€‚ å¸¸è§„çš„AJAXè¯·æ±‚éœ€è¦ä¼ è¾“å®Œæ•´çš„HTTPæ ‡å¤´ï¼Œè¿™æ„å‘³ç€åŒå‘æµé‡éƒ½å°†å¢åŠ ï¼Œè€Œå»ºç«‹è¿æ¥åWebå¥—æ¥å­—çš„å¼€é”€ä»…ä¸ºä¸¤ä¸ªå­—èŠ‚ã€‚  Webå¥—æ¥å­—å°†HTTPæ ‡å¤´ä¸­ä¼ è¾“çš„ä¿¡æ¯é‡å‡å°‘äº†æˆåƒä¸Šä¸‡æ¬¡ï¼Œå¹¶æ˜¾ç€å‡å°‘äº†ç­‰å¾…æ—¶é—´ã€‚  Webå¥—æ¥å­—è¿æ¥æ”¯æŒè·¨åŸŸï¼ˆå¦‚CORSï¼‰ã€‚ <br><br> åœ¨æœåŠ¡å™¨ç«¯ï¼Œæœ‰æ”¯æŒWebå¥—æ¥å­—çš„åŒ…ï¼Œåœ¨å®¢æˆ·ç«¯æ˜¯HTML5 WebSocket APIï¼Œå®ƒå…·æœ‰ä¸‰ç§æ–¹æ³•çš„æ¥å£ï¼š <br><br>  <b><i>WebSocket-</i></b>è¿æ¥åˆ°WebSocketæœåŠ¡å™¨ï¼Œç„¶åé€šè¿‡è¯¥è¿æ¥å‘é€å’Œæ¥æ”¶æ•°æ®çš„ä¸»ç•Œé¢ï¼› <br>  <b><i>CloseEvent-</i></b>è¿æ¥å…³é—­æ—¶WebSocketå¯¹è±¡è°ƒåº¦çš„äº‹ä»¶ï¼› <br>  <b><i>MessageEvent-</i></b>å½“ä»æœåŠ¡å™¨æ¥æ”¶åˆ°æ¶ˆæ¯æ—¶ï¼Œç”±WebSocketè°ƒåº¦çš„äº‹ä»¶ã€‚ <br><br> è¿™æ˜¯ä»JavaSriptå®ç°çº§åˆ«çœ‹çš„æ ·å­ï¼š <br><br><pre><code class="plaintext hljs">const ws = new WebSocket("ws://www.example.com/socketserver", "protocolOne"); ws.onopen = () =&gt; { ws.onmessage = (event) =&gt; { console.log(event); } ws.send("Here's some text that the server is urgently awaiting!"); };</code> </pre> <br>  <b><i>onmessage-</i></b>ä¾¦å¬æ¥è‡ªæœåŠ¡å™¨çš„æ¶ˆæ¯ <br>  <b><i>å‘é€</i></b> -å°†æ‚¨çš„æ¶ˆæ¯å‘é€åˆ°æœåŠ¡å™¨ <br><br> ä¹Ÿå°±æ˜¯è¯´ï¼Œä»æ ¹æœ¬ä¸Šè®²ï¼Œä¸€åˆ‡éƒ½éå¸¸ç®€å•ï¼Œä½†æ˜¯å¦‚æœæ‚¨å¸Œæœ›æ·±å…¥ç ”ç©¶è¯¥ä¸»é¢˜ï¼Œåˆ™å¯ä»¥ä½¿ç”¨<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">MDN Web Docs</a> ï¼ŒåŒæ—¶å¯ä»¥å­¦ä¹ åœ¨æ­¤APIä¹‹ä¸Šå®ç°è‡ªå·±çš„å±‚çš„åº“ã€‚ <br><br><h2> ä¸ºä»€ä¹ˆä¸å®³æ€•ä½¿ç”¨WebSocket </h2><br> å¯èƒ½å“åˆ°çš„ç¬¬ä¸€ç‚¹æ˜¯<b>æµè§ˆå™¨æ”¯æŒ</b> ã€‚ å¦‚ä»Šå·²ä¸å­˜åœ¨æ­¤ç±»é—®é¢˜-WebSocketå’Œç§»åŠ¨ç½‘æ®µå‡ ä¹å®Œå…¨æ”¯æŒWebSocketã€‚ <br><br><img src="https://habrastorage.org/webt/6q/kt/br/6qktbrrlnloyi0ec862v8qzclts.png" alt="å›¾ç‰‡"><br><br><img src="https://habrastorage.org/webt/bn/pk/k5/bnpkk58xzozo2c9plnkgszfjnk4.png" alt="å›¾ç‰‡"><br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">https://caniuse.com/#feat=websockets</a> <br><br> ç¬¬äºŒç‚¹æ˜¯<b>æ˜“äºå®æ–½</b> ã€‚ æ˜¯çš„ï¼Œèµ·åˆè¿™ä»¤äººæ²®ä¸§ã€‚ <br><br> è¯¥APIéå¸¸ç®€å•ï¼Œä¹ä¸€çœ‹å¯èƒ½å¾ˆéš¾ç†è§£å¦‚ä½•ä½¿ç”¨å¦‚æ­¤å°‘é‡çš„æ–¹æ³•ï¼Œå› ä¸ºé™¤ä¸€ä¸ªæ–¹æ³•å¤–ï¼Œæ‰€æœ‰æ–¹æ³•å‡æŠ¥å‘Šé”™è¯¯æˆ–è¿æ¥ï¼Œå¹¶ä¸”å…¶ä¸­ä»…ä¸€ä¸ªæ–¹æ³•ï¼ˆ <b><i>onmessage</i></b> ï¼‰æºå¸¦å…³äºä½¿ç”¨ä»€ä¹ˆç½‘ç»œå¥—æ¥å­—ï¼Œå³ ä»æœåŠ¡å™¨æ¥æ”¶æ•°æ®ã€‚ <br><br> åŒæ—¶ï¼Œè¦æ³¨æ„çš„æ˜¯æœåŠ¡å™¨é€šå¸¸å‘é€ä¸åŒçš„æ•°æ®ï¼Œå› æ­¤ï¼Œæˆ‘ä»¬éœ€è¦å‡ ä¸ªä¸åŒçš„æ¶ˆæ¯å—ï¼Ÿ è¿˜æ˜¯éœ€è¦ä¸ºæ¯ä¸ªæ•°æ®æ¨¡å‹åˆ›å»ºè‡ªå·±çš„è¿æ¥ï¼Ÿ <br><br> å› æ­¤ï¼Œä»»åŠ¡æ˜¯ï¼šæ‚¨éœ€è¦æ¥å—æœåŠ¡å™¨ä¸Šçš„ç”¨æˆ·æ¨¡å‹å’Œæœ€æ–°æ–°é—»æ¨¡å‹ï¼Œç”šè‡³å¯èƒ½è¿˜è¦æ¥å—å…¶ä»–æ¨¡å‹ã€‚ <br><br> æˆ‘é‡åˆ°è¿‡è¿™æ ·ä¸€ä¸ªâ€œä¼˜é›…â€çš„å®ç°ï¼š <br><br><pre> <code class="plaintext hljs">const wsUser = new WebSocket("ws://www.example.com/user"); wsUser.onmessage = (event) =&gt; { // ... }; const wsNews = new WebSocket("ws://www.example.com/news"); wsNews.onmessage = (event) =&gt; { // ... }; const wsTime = new WebSocket("ws://www.example.com/time"); wsTime.onmessage = (event) =&gt; { // ... }; const wsDinner = new WebSocket("ws://www.example.com/dinner"); wsDinner.onmessage = (event) =&gt; { // ... }; const wsCurrency = new WebSocket("ws://www.example.com/currency"); wsCurrency.onmessage = (event) =&gt; { // ... }; const wsOnline = new WebSocket("ws://www.example.com/online"); wsOnline.onmessage = (event) =&gt; { // ... }; const wsLogin = new WebSocket("ws://www.example.com/login"); wsLogin.onmessage = (event) =&gt; { // ... }; const wsLogout = new WebSocket("ws://www.example.com/logout"); wsLogout.onmessage = (event) =&gt; { // ... };</code> </pre> <br> ä¹ä¸€çœ‹ï¼Œä¸€åˆ‡éƒ½æ˜¯åˆä¹é€»è¾‘çš„ã€‚ ä½†æ˜¯ç°åœ¨æƒ³è±¡ä¸€ä¸‹ï¼Œå¦‚æœæœ‰æ•°åä¸ªæˆ–æ•°ç™¾ä¸ªå®ƒä»¬ï¼Œå®ƒå°†æ˜¯ä»€ä¹ˆæ ·å­ã€‚ åœ¨æˆ‘ç¢°å·§ä»äº‹çš„ä¸€ä¸ªé¡¹ç›®ä¸­ï¼Œå¤§çº¦æœ‰ä¸‰ç™¾ä¸ªäº‹ä»¶ã€‚ <br><br><img src="https://habrastorage.org/webt/d3/rg/dl/d3rgdlp8eggnms2ot2ely5zktz8.jpeg" alt="å›¾ç‰‡"><br><br> æˆ‘ä»¬è§£å†³äº†è¿™ä¸ªé—®é¢˜ã€‚ <br><br> æ‰€æœ‰ç”¨äºWebå¥—æ¥å­—çš„ç¬¬ä¸‰æ–¹åº“éƒ½å…è®¸æ‚¨è®¢é˜…addEventListenerç±»å‹çš„æ¶ˆæ¯ã€‚ çœ‹èµ·æ¥åƒè¿™æ ·ï¼š <br><br><pre> <code class="plaintext hljs">ws.on("user", (userData) =&gt; { / .. })</code> </pre> <br> ä¼—æ‰€å‘¨çŸ¥ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ä¸€ç§æ–¹æ³•<b><i>onmessage</i></b>è¿›è¡Œæ“ä½œï¼Œ <b><i>onmessage</i></b>æ¥æ”¶æ‰€æœ‰æ•°æ®ä½œä¸ºå…¶è¿æ¥çš„ä¸€éƒ¨åˆ†ï¼Œå› æ­¤æ­¤ä»£ç çœ‹èµ·æ¥æœ‰äº›ä¸å¯»å¸¸ã€‚ å®ƒçš„å®ç°æ–¹å¼å¦‚ä¸‹ï¼š <b><i>onmessage</i></b>è¿”å›ä¸€ä¸ªåŒ…å«<b><i>æ•°æ®</i></b>å­—æ®µçš„<b><i>MessageEvent</i></b> ã€‚ è¿™äº›<b><i>æ•°æ®</i></b>åŒ…å«æœåŠ¡å™¨å‘é€ç»™æˆ‘ä»¬çš„ä¿¡æ¯ã€‚ è¯¥å¯¹è±¡å¦‚ä¸‹æ‰€ç¤ºï¼š <br><br><pre> <code class="plaintext hljs">{ "event": "user", "data": { "name": "John Doe", ... } }</code> </pre> <br> å…¶ä¸­ï¼Œ <b><i>äº‹ä»¶</i></b>æ˜¯ç¡®å®šæœåŠ¡å™¨å‘é€å“ªäº›ä¿¡æ¯çš„å…³é”®ã€‚ æ¥ä¸‹æ¥ï¼Œåœ¨å‰ç«¯ä¾§ï¼Œåˆ›å»ºä¸€æ¡æ€»çº¿ï¼Œè¯¥æ€»çº¿æŒ‰äº‹ä»¶è¿‡æ»¤ä¿¡æ¯å¹¶å°†å…¶å‘é€åˆ°æ‰€éœ€çš„åœ°å€ï¼š <br><br><pre> <code class="plaintext hljs">const ws = new WebSocket("ws://www.example.com"); ws.onmessage = (event) =&gt; { const data = JSON.parse(event.data); if (data.event === 'user') { // ... } if (data.event === 'news') { // ... } };</code> </pre> <br><br> è¿™æ ·å°±å¯ä»¥åœ¨åŒä¸€è¿æ¥ä¸­æ¥æ”¶ä¸åŒçš„æ•°æ®ï¼Œå¹¶é€šè¿‡ç±»ä¼¼äºJSäº‹ä»¶é€šå¸¸çš„è¯­æ³•æ¥è®¢é˜…å®ƒä»¬ã€‚ <br><br><h2>  Angularä¸­çš„WebSockets </h2><br> æœ€åï¼Œæˆ‘ä»¬äº†è§£äº†æœ€é‡è¦çš„äº‹æƒ…-ç›´æ¥åœ¨Angularä¸­ä½¿ç”¨WebSocketsã€‚ <br><br> å°½ç®¡ä½¿ç”¨æœ¬æœºWebSocket APIéå¸¸ç®€å•ï¼Œä½†æ˜¯åœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨RxJï¼Œè¿™å½“ç„¶æ˜¯å› ä¸ºæˆ‘ä»¬åœ¨è°ˆè®ºAngularã€‚ <br><br> å¯ä»¥åœ¨Angularåº”ç”¨ç¨‹åºä¸­ä½¿ç”¨æœ¬æœºWebSocket APIï¼Œåˆ›å»ºæ˜“äºä½¿ç”¨çš„ç•Œé¢ï¼Œå¯è§‚å¯Ÿåˆ°RxJsï¼Œè®¢é˜…å¿…è¦çš„æ¶ˆæ¯ç­‰ï¼Œä½†æ˜¯RxJså·²ç»ä¸ºæ‚¨å®Œæˆäº†ä¸»è¦å·¥ä½œï¼šWebSocketSubjectæ˜¯æ ‡å‡†WebSocketçš„ååº”å¼åŒ…è£…API å®ƒä¸ä¼šåˆ›å»ºäº‹ä»¶æ€»çº¿æˆ–é‡æ–°è¿æ¥å¤„ç†ã€‚ è¿™æ˜¯ä¸€ä¸ªå¸¸è§„ä¸»é¢˜ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨å®ƒæ¥ä½¿ç”¨ååº”å¼Webå¥—æ¥å­—ã€‚ <br><br><h2>  RxJs WebSocketä¸»é¢˜ </h2><br> å› æ­¤ï¼Œ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">WebSocketSubject</a>éœ€è¦<a href="">WebSocketSubjectConfig</a>å’Œä¸€ä¸ªå¯é€‰ç›®æ ‡ï¼Œæ‚¨å¯ä»¥åœ¨å…¶ä¸­ä¼ é€’æŒ‡å‘è§‚å¯Ÿåˆ°çš„Subjectçš„é“¾æ¥ï¼Œåˆ›å»ºä¸€ä¸ªObservableï¼Œé€šè¿‡å®ƒå¯ä»¥ä¾¦å¬å’Œå‘é€Webå¥—æ¥å­—çš„æ¶ˆæ¯ã€‚ <br><br> ç®€è€Œè¨€ä¹‹ï¼Œå°†è¿æ¥URLä½œä¸ºå‚æ•°ä¼ é€’ç»™WebSocketSubjectï¼Œå¹¶ä»¥RxJçš„å¸¸è§„æ–¹å¼è®¢é˜…Webå¥—æ¥å­—çš„æ‰€æœ‰æ´»åŠ¨ã€‚ å¹¶ä¸”ï¼Œå¦‚æœæ‚¨éœ€è¦å‘æœåŠ¡å™¨å‘é€æ¶ˆæ¯ï¼Œè¯·ä½¿ç”¨ç›¸åŒçš„å¸¸ç”¨æ–¹æ³•webSocketSubject.nextï¼ˆæ•°æ®ï¼‰ã€‚ <br><br><h2> æˆ‘ä»¬æä¾›ä½¿ç”¨WebSocket Angularçš„æœåŠ¡ </h2><br> ç®€è¦æè¿°æˆ‘ä»¬å¯¹æœåŠ¡çš„æœŸæœ›ï¼š <br><br><ul><li> ç»Ÿä¸€ç®€æ´çš„ç•Œé¢ï¼› </li><li> èƒ½å¤Ÿåœ¨<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">DI</a>ä¾èµ–å…³ç³»çš„è¿æ¥çº§åˆ«è¿›è¡Œé…ç½® </li><li> é‡ç”¨çš„å¯èƒ½æ€§ï¼› </li><li> æ‰“å­—; </li><li> é€šè¿‡å¯†é’¥è®¢é˜…æ¥æ”¶ä¿¡æ¯çš„èƒ½åŠ›ï¼› </li><li> èƒ½å¤Ÿç»ˆæ­¢è®¢é˜…ï¼› </li><li> å‘æœåŠ¡å™¨å‘é€æ¶ˆæ¯ï¼› </li><li> é‡æ–°è¿æ¥ã€‚ </li></ul><br> æœ€åä¸€ç‚¹å€¼å¾—ç‰¹åˆ«æ³¨æ„ã€‚ å½“ä½¿ç”¨Webå¥—æ¥å­—æ—¶ï¼Œé‡æ–°è¿æ¥æˆ–é‡æ–°è¿æ¥åˆ°æœåŠ¡å™¨çš„ç»„ç»‡æ˜¯è‡³å…³é‡è¦çš„å› ç´ ï¼Œå› ä¸º ç½‘ç»œä¸­æ–­ï¼ŒæœåŠ¡å™¨å´©æºƒæˆ–å…¶ä»–å¯¼è‡´è¿æ¥ä¸­æ–­çš„é”™è¯¯å¯èƒ½å¯¼è‡´åº”ç”¨ç¨‹åºå´©æºƒã€‚ <br><br> é‡è¦çš„æ˜¯è¦æ³¨æ„ï¼Œé‡æ–°è¿æ¥å°è¯•<b>ä¸åº”å¤ªé¢‘ç¹</b>ä¸”ä¸åº”æ— é™æœŸåœ°ç»§ç»­ï¼Œä¾‹å¦‚ æ­¤è¡Œä¸ºå¯ä»¥æŒ‚èµ·å®¢æˆ·ç«¯ã€‚ <br><br> è®©æˆ‘ä»¬å¼€å§‹å§ã€‚ <br><br> é¦–å…ˆï¼Œæˆ‘ä»¬å°†åˆ›å»ºä¸€ä¸ªæœåŠ¡é…ç½®æ¥å£å’Œä¸€ä¸ªæ¨¡å—ï¼Œè¯¥æ¨¡å—å°†æä¾›åœ¨è¿æ¥æ—¶è¿›è¡Œé…ç½®çš„åŠŸèƒ½ã€‚ <br><br> å¦‚æœå¯èƒ½ï¼Œæˆ‘å°†ç¼©çŸ­ä»£ç ï¼Œå³æ‚¨å¯ä»¥<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">åœ¨GitHubä¸Šçš„ä¿„è¯­Angularç¤¾åŒºä¸­</a>çœ‹åˆ°çš„å®Œæ•´ç‰ˆæœ¬ã€‚ <br><br><pre> <code class="plaintext hljs">export interface WebSocketConfig { url: string; reconnectInterval?: number; reconnectAttempts?: number; } export class WebsocketModule { public static config(wsConfig: WebSocketConfig): ModuleWithProviders { return { ngModule: WebsocketModule, providers: [{ provide: config, useValue: wsConfig }] }; } }</code> </pre> <br> æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬éœ€è¦æè¿°Webå¥—æ¥å­—æ¶ˆæ¯çš„æ¥å£ï¼š <br><br><pre> <code class="plaintext hljs">export interface IWsMessage&lt;T&gt; { event: string; data: T; }</code> </pre> <br> å…¶ä¸­<b><i>event</i></b>æ˜¯é”®ï¼Œè€Œç”±é”®è·å–çš„<b><i>æ•°æ®</i></b>æ˜¯ç±»å‹åŒ–æ¨¡å‹ã€‚ <br><br> æœåŠ¡çš„å…¬å…±æ¥å£å¦‚ä¸‹æ‰€ç¤ºï¼š <br><br><pre> <code class="plaintext hljs">export interface IWebsocketService { on&lt;T&gt;(event: string): Observable&lt;T&gt;; send(event: string, data: any): void; status: Observable&lt;boolean&gt;; }</code> </pre> <br> æœåŠ¡åŒ…å«ä»¥ä¸‹å­—æ®µï¼š <br><br><pre> <code class="plaintext hljs">//   WebSocketSubject private config: WebSocketSubjectConfig&lt;IWsMessage&lt;any&gt;&gt;; private websocketSub: SubscriptionLike; private statusSub: SubscriptionLike; // Observable    interval private reconnection$: Observable&lt;number&gt;; private websocket$: WebSocketSubject&lt;IWsMessage&lt;any&gt;&gt;; // ,      private connection$: Observer&lt;boolean&gt;; //  Observable       private wsMessages$: Subject&lt;IWsMessage&lt;any&gt;&gt;; //       private reconnectInterval: number; //    private reconnectAttempts: number; //      private isConnected: boolean; //   public status: Observable&lt;boolean&gt;;</code> </pre> <br> åœ¨æœåŠ¡ç±»çš„æ„é€ å‡½æ•°ä¸­ï¼Œæˆ‘ä»¬è·å–è¿æ¥æ¨¡å—æ—¶æŒ‡å®šçš„WebSocketConfigå¯¹è±¡ï¼š <br><br><pre> <code class="plaintext hljs">constructor(@Inject(config) private wsConfig: WebSocketConfig) { this.wsMessages$ = new Subject&lt;IWsMessage&lt;any&gt;&gt;(); //  ,  ,     this.reconnectInterval = wsConfig.reconnectInterval || 5000; this.reconnectAttempts = wsConfig.reconnectAttempts || 10; //      connection$   websocket$ this.config = { url: wsConfig.url, closeObserver: { next: (event: CloseEvent) =&gt; { this.websocket$ = null; this.connection$.next(false); } }, //     connection$ openObserver: { next: (event: Event) =&gt; { console.log('WebSocket connected!'); this.connection$.next(true); } } }; // connection status this.status = new Observable&lt;boolean&gt;((observer) =&gt; { this.connection$ = observer; }).pipe(share(), distinctUntilChanged()); //      this.statusSub = this.status .subscribe((isConnected) =&gt; { this.isConnected = isConnected; if (!this.reconnection$ &amp;&amp; typeof(isConnected) === 'boolean' &amp;&amp; !isConnected) { this.reconnect(); } }); // ,  -    this.websocketSub = this.wsMessages$.subscribe( null, (error: ErrorEvent) =&gt; console.error('WebSocket error!', error) ); //  this.connect(); }</code> </pre> <br> è¿æ¥æ–¹æ³•æœ¬èº«å¾ˆç®€å•ï¼š <br><br><pre> <code class="plaintext hljs">private connect(): void { this.websocket$ = new WebSocketSubject(this.config); //  //   ,    , //  ,  // ,    this.websocket$.subscribe( (message) =&gt; this.wsMessages$.next(message), (error: Event) =&gt; { if (!this.websocket$) { // run reconnect if errors this.reconnect(); } }); }</code> </pre> <br> é‡æ–°è¿æ¥æœ‰ç‚¹å¤æ‚ï¼š <br><br><pre> <code class="plaintext hljs">private reconnect(): void { //  interval    reconnectInterval this.reconnection$ = interval(this.reconnectInterval) .pipe(takeWhile((v, index) =&gt; index &lt; this.reconnectAttempts &amp;&amp; !this.websocket$)); //     ,        this.reconnection$.subscribe( () =&gt; this.connect(), null, () =&gt; { // Subject complete if reconnect attemts ending this.reconnection$ = null; if (!this.websocket$) { this.wsMessages$.complete(); this.connection$.complete(); } }); }</code> </pre> <br>  <b><i>on</i></b>æ–¹æ³•ä¹Ÿéå¸¸ç®€å•ï¼Œç”šè‡³æ²¡æœ‰ä»€ä¹ˆå¯è¯„è®ºçš„ã€‚ <br><br><pre> <code class="plaintext hljs">public on&lt;T&gt;(event: string): Observable&lt;T&gt; { if (event) { return this.wsMessages$.pipe( filter((message: IWsMessage&lt;T&gt;) =&gt; message.event === event), map((message: IWsMessage&lt;T&gt;) =&gt; message.data) ); } }</code> </pre> <br>  <b><i>send</i></b>æ–¹æ³•æ›´ç®€å•ï¼š <br><br><pre> <code class="plaintext hljs">public send(event: string, data: any = {}): void { if (event &amp;&amp; this.isConnected) { //   any ,   ""   string //      :) this.websocket$.next(&lt;any&gt;JSON.stringify({ event, data })); } else { console.error('Send error!'); } }</code> </pre> <br> è¿™å°±æ˜¯æ•´ä¸ªæœåŠ¡ã€‚ å¦‚æ‚¨æ‰€è§ï¼Œå¤§éƒ¨åˆ†ä»£ç éƒ½å±äºé‡æ–°è¿æ¥çš„ç»„ç»‡ã€‚ <br><br> ç°åœ¨è®©æˆ‘ä»¬çœ‹çœ‹å¦‚ä½•ä½¿ç”¨å®ƒã€‚ è¿æ¥WebsocketModuleæ¨¡å—ï¼š <br><br><pre> <code class="plaintext hljs">imports: [ WebsocketModule.config({ url: environment.ws //      'ws://www.example.com' }) ]</code> </pre> <br> åœ¨ç»„ä»¶æ„é€ å‡½æ•°ä¸­ï¼Œæˆ‘ä»¬æ³¨å…¥æœåŠ¡å¹¶è®¢é˜…æ¥è‡ªâ€œ <b><i>messages</i></b> â€çš„<b><i>æ¶ˆæ¯</i></b> ï¼Œç„¶åå°†æ–‡æœ¬å‘é€å›æœåŠ¡å™¨ï¼š <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">constructor</span></span>(private wsService: WebsocketService) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.wsService.on&lt;IMessage[]&gt;<span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">'messages'</span></span></span></span></span><span class="hljs-function">) .</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">subscribe</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(messages: IMessage[]</span></span></span><span class="hljs-function">) =&gt;</span></span> { <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(messages); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.wsService.send(<span class="hljs-string"><span class="hljs-string">'text'</span></span>, <span class="hljs-string"><span class="hljs-string">'Test Text!'</span></span>); }); }</code> </pre> <br> äº‹ä»¶çš„åç§°æ›´æ–¹ä¾¿æ”¾å…¥å¸¸é‡æˆ–æšä¸¾ã€‚ æˆ‘ä»¬åœ¨websocket.events.tsæ–‡ä»¶çš„æŸä¸ªä½ç½®åˆ›å»ºå¹¶å°†å…¶å†™å…¥å…¶ä¸­ï¼š <br><br><pre> <code class="plaintext hljs">export const WS = { ON: { MESSAGES: 'messages' }, SEND: { TEXT: 'text' } };</code> </pre> <br> ä½¿ç”¨åˆ›å»ºçš„WSå¯¹è±¡é‡å†™è®¢é˜…ï¼š <br><br><pre> <code class="plaintext hljs">this.wsService.on&lt;IMessage[]&gt;(WS.ON.MESSAGES) .subscribe((messages: IMessage[]) =&gt; { console.log(messages); this.wsService.send(WS.SEND.TEXT, 'Test Text!'); });</code> </pre> <br><img src="https://habrastorage.org/webt/zn/jz/k7/znjzk75iy2uudtgep2wr4u8djmk.jpeg" alt="å›¾ç‰‡"><br><br><h2> æ€»ç»“ </h2><br> å®é™…ä¸Šï¼Œä»…æ­¤è€Œå·²ã€‚ è¿™æ˜¯Angularå¼€å‘äººå‘˜éœ€è¦äº†è§£çš„WebSocketsçš„æœ€ä½è¦æ±‚ã€‚ æˆ‘å¸Œæœ›æˆ‘å·²ç»å¾ˆæ¸…æ¥šåœ°æ¶µç›–äº†è¿™ä¸ªè¯é¢˜ã€‚ è¯¥æœåŠ¡çš„å®Œæ•´ç‰ˆæœ¬å¯ä»¥åœ¨<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">GitHub</a>ä¸Š<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">æ‰¾åˆ°</a> ã€‚ <br><br> å¯¹äºæ‰€æœ‰é—®é¢˜ï¼Œæ‚¨éƒ½å¯ä»¥åœ¨è¯„è®ºä¸­è”ç³»ï¼Œæ— è®ºæ˜¯é€šè¿‡Telegramè¿˜æ˜¯åœ¨åŒä¸€ä¸ªåœ°æ–¹<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">çš„Angularé¢‘é“</a>ä¸Šï¼Œå¯ä»¥ä¸<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">æˆ‘</a>è”ç³»ã€‚ </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN416155/">https://habr.com/ru/post/zh-CN416155/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN416143/index.html">è¿™æœ¬ä¹¦â€œå°†è¿›è¡Œå°¸æ£€ï¼â€ å®ç”¨çš„æ¶æ„è½¯ä»¶åˆ†æÂ»</a></li>
<li><a href="../zh-CN416147/index.html">ä½¿ç”¨æ ¹æ§åˆ¶å™¨åœ¨iOSåº”ç”¨ç¨‹åºä¸­ç»„ç»‡å¯¼èˆª</a></li>
<li><a href="../zh-CN416149/index.html">å¯å†ç”Ÿèƒ½æºé—®ç­”ï¼Œç¬¬1éƒ¨åˆ†</a></li>
<li><a href="../zh-CN416151/index.html">æ— é‡çº²çš„æ°”çƒã€‚ åŠŸåˆ©ç»´åº¦åˆ†æé­”æœ¯</a></li>
<li><a href="../zh-CN416153/index.html">é£æœºä¼šå˜å¾—æ›´å¯é å—ï¼Ÿ é£æœºåˆ¶é€ å•†å‘ä¼ä¸šä»‹ç»æœºå™¨äºº</a></li>
<li><a href="../zh-CN416157/index.html">åœ¨Pythonçš„æ€€æŠ±ä¸­ï¼ˆä»…é™å¥³æ€§ï¼‰</a></li>
<li><a href="../zh-CN416159/index.html">æˆ‘ä»¬å¦‚ä½•è¢«å§”æ‰˜æ¯”è¾ƒåˆºçŒ¬</a></li>
<li><a href="../zh-CN416161/index.html">[ä¸]ä½¿ç”¨k8çš„10ä¸ªç†ç”±</a></li>
<li><a href="../zh-CN416163/index.html">å­¦ä¹ OpenGLã€‚ è¯¾5.6-è§†å·®æ˜ å°„</a></li>
<li><a href="../zh-CN416167/index.html">å½¼å¾—Â·è¯ºç»´æ ¼ï¼ˆPeter Norwigï¼‰ï¼š10å¹´å­¦ä¹ ç¼–ç¨‹</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>