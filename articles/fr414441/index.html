<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ü§∂üèø üë®üèº‚Äçüç≥ üë®üèø‚Äçüîß Exp√©rience des migrations de bases de donn√©es 1440 üë©üèø‚ÄçüöÄ üõ¥ üë≤üèø</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Imaginez Oracle DBA. Il a d√©j√† plus de trente ans, il est un peu en surpoids, porte un gilet, il a un jeton d'acc√®s secret √† toutes les bases accroch√©...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Exp√©rience des migrations de bases de donn√©es 1440</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/wrike/blog/414441/"><img src="https://habrastorage.org/webt/pv/6j/9e/pv6j9e1v5h6g8nvmd5am7bhtmb8.jpeg"><br><br>  Imaginez Oracle DBA.  Il a d√©j√† plus de trente ans, il est un peu en surpoids, porte un gilet, il a un jeton d'acc√®s secret √† toutes les bases accroch√©es √† son cou, et dans un r√©sum√© d'une demi-page des certifications qu'il a pass√©es.  Samedi  Grande journ√©e de sortie.  Climax.  Il est temps de reporter les modifications dans la base de donn√©es.  Il tape sqlplus, appuie sur ENTR√âE, et quelque part sur l'√©cran noir dans le vide, des kilom√®tres de commandes SQL se pr√©cipitent.  Tout comme dans les guerres des √©toiles.  Cinq minutes plus tard, tout est pr√™t.  Une heure plus tard, la sortie est termin√©e.  Le travail est fait, la journ√©e a √©t√© un succ√®s.  Maintenant, vous pouvez avoir quelques bi√®res. <br><a name="habracut"></a><br>  Une autre chose est lundi.  Il s'av√®re que certaines commandes n'ont pas √©t√© ex√©cut√©es en raison d'erreurs, ce qui n'a toutefois pas arr√™t√© le script dans sa poursuite effr√©n√©e du vide noir.  La t√¢che d√©j√† difficile de d√©terminer ce qui est bris√© est compliqu√©e par une certaine pression de la part des dirigeants.  En g√©n√©ral, lundi n'a pas fonctionn√©. <br><br>  Bien s√ªr, c'est une histoire fictive.  Cela n'est jamais arriv√© √† personne.  Au moins, cela ne se serait pas produit si le travail de modification du sch√©ma de la base de donn√©es avait √©t√© organis√© par le biais de migrations. <br><br><h3>  Qu'est-ce qu'un outil de migration de base de donn√©es? </h3><br>  L'id√©e de g√©rer les modifications de sch√©ma de base de donn√©es via des migrations est extr√™mement simple: <br><br><ol><li>  Chaque modification est √©mise dans un fichier de migration distinct. </li><li>  Le fichier de migration comprend des modifications directes et inverses. </li><li>  L'application des migrations √† la base de donn√©es est effectu√©e par un utilitaire sp√©cial. </li></ol><br>  L'exemple de migration le plus simple: <br><pre><code class="sql hljs"><span class="hljs-comment"><span class="hljs-comment">-- 20180618152059: create sequence for some_table CREATE SEQUENCE some_table_seq; --//@UNDO DROP SEQUENCE some_table_seq;</span></span></code> </pre> <br>  Cette approche offre de nombreux avantages par rapport √† l'organisation des modifications dans un fichier SQL commun.  La simple absence de conflits de fusion en vaut la peine. <br><br>  Il est d'autant plus surprenant que l'approche elle-m√™me a gagn√© en popularit√© relativement r√©cemment.  Il semble que le framework Ruby on Rails, dans lequel l'outil de migration √©tait √† l'origine int√©gr√©, √©tait la principale renomm√©e de l'approche, c'√©tait fin 2005.  Martin Fowler, 2003, a <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">√©crit</a> un peu plus t√¥t sur cette approche, mais le fait est que le d√©veloppement n'a commenc√© √† adapter activement l'utilisation du syst√®me de contr√¥le de version qu'au d√©but de ce si√®cle.  En 2000, le premier paragraphe du <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">test de Joel Spolsky</a> √©tait <i>"Utilisez-vous le contr√¥le de code source?"</i>  - cela sugg√®re que tout le monde n'utilisait pas les syst√®mes de contr√¥le de version √† l'√©poque.  Mais nous √©tions distraits. <br><br><h3>  Huit ans avec MyBatis Migrations </h3><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Chez Wrike,</a> nous avons commenc√© √† utiliser l'approche de changement de base de donn√©es lors des migrations en 2010, le 29 mars √† midi et demi.  Depuis lors, nous avons impl√©ment√© 1 440 migrations, contenant 6 436 modifications directes et 5 015 inverses.  En g√©n√©ral, nous avons acquis une certaine exp√©rience en utilisant l'outil de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">migration MyBatis</a> en conjonction avec <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">PostgreSQL</a> . <br><br>  Bref, nous n'avons jamais regrett√©.  S'il vous arrive de ne pas utiliser Migrations ou quelque chose de similaire, il est temps de commencer.  Oui, le <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Pentium 4 est</a> √©galement obsol√®te. <br><br>  Mais c'est ennuyeux de parler des m√©rites de quoi que ce soit, passons directement aux difficult√©s. <br><br><h3>  Sp√©cificit√©s de PostgreSQL </h3><br>  Il n'y a aucune difficult√© √† √©crire des migrations pour Postgres, sauf pour deux: <br><ul><li>  Vous ne pouvez pas cr√©er d'index, </li><li>  Vous ne pouvez pas ajouter de colonnes NOT NULL. </li></ul><br>  Non, en fait, c'est possible, mais pas de mani√®re tout √† fait √©vidente.  Lors de la cr√©ation d'un index, vous devez toujours sp√©cifier <i>CREATE INDEX CONCURRENTLY</i> , sinon vous interrompez la production, car Postgres verrouille la table pendant la dur√©e de la cr√©ation de l'index, ce qui peut √™tre assez long.  Bien s√ªr, les d√©veloppeurs l'oublient une fois, vous devez toujours garder cette subtilit√© √† l'esprit.  Ici, on pourrait √©crire un test.  Mais ce n'est qu'un l√©ger inconv√©nient. <br><br>  La cr√©ation de colonnes NOT NULL est plus d√©licate, ici vous devez effectuer une modification en quatre √©tapes: <br><ol><li>  Cr√©ez une colonne NULL (dans Postgres c'est gratuit). </li><li>  D√©finissez la colonne DEFAULT sur une valeur. </li><li>  Dans une boucle, mettez √† jour progressivement les valeurs NULL dans DEFAULT. </li><li>  D√©finissez SET NOT NULL. </li></ol><br>  Le plus gros probl√®me ici est dans le troisi√®me paragraphe.  Les valeurs NULL doivent √™tre mises √† jour par portions, car <code>UPDATE some_table SET some_column='' WHERE some_column IS NULL</code> ;  bloquera la table, comme c'est le cas avec l'index, avec les m√™mes cons√©quences.  Et les migrations ne peuvent ex√©cuter que des commandes SQL, de tels scripts doivent donc √™tre mis en production manuellement.  Plaisir en dessous de la moyenne.  Maintenant, si un cycle pouvait √™tre √©crit dans Migrations, il n'y aurait aucun probl√®me.  Peut-√™tre que cela est impl√©ment√© via des <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">crochets</a> . <br><br>  La cr√©ation d'un index <code>UNIQUE</code> et la modification d'une <code>PRIMARY KEY</code> n√©cessitent √©galement des comp√©tences, mais ces op√©rations sont relativement rares √† approfondir. <br><br><h3>  Sp√©cificit√©s du cluster </h3><br>  L'outil de gestion de la migration de base de donn√©es est bon tant que vous n'avez qu'une seule base de donn√©es.  D'autant plus amusant si vous avez plusieurs bases.  Surtout si vous avez plusieurs types de bases de donn√©es, chacune ayant plusieurs instances. <br><br>  Par cons√©quent, apr√®s <code>git pull</code> d√©veloppeur doit transf√©rer les modifications √† la premi√®re instance de la premi√®re base de donn√©es, puis √† la deuxi√®me instance, puis √† la premi√®re instance de la deuxi√®me base de donn√©es et ainsi de suite - un tel principe.  Ici, il est juste d'√©crire un utilitaire pour g√©rer l'utilitaire de gestion de la migration de la base de donn√©es.  Automatisation totale. <br><br><h3>  Jongler avec les r√¥les </h3><br>  Ce n'est un secret pour personne que les r√¥les en tant qu'entit√©s ne vivent pas au niveau d'une base de donn√©es distincte, mais au niveau de l'ensemble du serveur de base de donn√©es, du moins dans Postgres.  Dans ce cas, vous devrez peut-√™tre sp√©cifier <code>REVOKE INSERT ON some_table FROM some_role</code> ;  Il est toujours possible de s'attendre √† ce que les r√¥les soient pr√©configur√©s en production, mais pour le d√©veloppement ou la mise en sc√®ne, c'est d√©j√† difficile.  En m√™me temps, en cours de d√©veloppement, bien s√ªr, toutes les bases de donn√©es existent sur le m√™me serveur local, vous ne pouvez donc tout simplement pas √©crire <code>CREATE ROLE</code> dans la migration, et <code>IF NOT EXISTS</code> pas pris en charge.  Tout est r√©solu simplement: <br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">DO</span></span> $$ <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXISTS</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> pg_roles <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> rolname = <span class="hljs-string"><span class="hljs-string">'some_role'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ROLE</span></span> <span class="hljs-string"><span class="hljs-string">"some_role"</span></span> NOLOGIN; <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">END</span></span>; $$;</code> </pre><br>  Regardez-le!  Je les attrape et les jette, attrape et jette, c'est si simple. <br><br><h3>  Un peu de r√©alit√© de d√©veloppement </h3><br>  Les d√©veloppeurs font des erreurs, et m√™me dans les migrations SQL, cela se produit.  Habituellement, des erreurs peuvent √™tre constat√©es dans la revue, mais elles peuvent √©galement √™tre inhabituelles.  Si nous parlons de changements directs, alors les jambages l√†-bas n'atteignent toujours pas la production - il y a trop d'√©tapes de v√©rification.  Mais avec les changements inverses, des incidents peuvent survenir.  Pour √©viter les erreurs dans la migration UNDO, lors du test de la migration, vous devez effectuer non seulement <code>./migrate up</code> , mais <code>./migrate up</code> , puis <code>./migrate down</code> , puis √† nouveau <code>./migrate up</code> .  Ce n'est rien de compliqu√©, il vous suffit de vous assurer que quarante d√©veloppeurs le font toujours.  Dans le bon sens, l'utilitaire pourrait effectuer automatiquement un tel combo pour l'environnement de d√©veloppeur. <br><br><h3>  Environnements de test </h3><br>  Si l'environnement de test est de courte dur√©e: disons que vous cr√©ez un conteneur, initialisez la base de donn√©es et ex√©cutez des tests d'int√©gration, il ne devrait pas y avoir de probl√®me.  Nous <code>./migrate bootstrap</code> , puis <code>./migrate up</code> , et vous avez termin√©.  C'est juste lorsque le nombre de migrations d√©passe mille, ce processus peut √™tre retard√©.  C'est dommage quand la base de donn√©es est initialis√©e plus longtemps que les tests ne s'ex√©cutent.  Nous devons esquiver. <br><br>  Avec des environnements √† longue dur√©e de vie, c'est encore plus difficile.  QA, vous savez, ils n'aiment pas voir une base de donn√©es impeccablement propre lorsqu'ils viennent travailler.  Je ne sais pas pourquoi il en est ainsi, mais le fait est le fait.  Ainsi, l'√©tat des bases utilis√©es dans les tests manuels doit √™tre maintenu en int√©grit√©.  Et ce n'est pas toujours facile. <br><br>  La subtilit√© est que si la migration est appliqu√©e √† la base de donn√©es, l'identifiant de migration y est √©crit.  Et si le code de migration a √©t√© modifi√© ult√©rieurement, la base de donn√©es ne sera pas affect√©e.  Si les modifications ne sont pas critiques, le code peut r√©ussir √† atteindre la production.  Rssynchron.  Bien s√ªr, c'est une honte.  Le premier principe du travail avec les migrations est de ne jamais changer les migrations √©crites, mais d'en cr√©er toujours de nouvelles.  Mais parfois j'ai envie de t√¢tonner - je vais changer un peu ici, rien ne se cassera, car la v√©rit√© est.  Bien s√ªr!  Allez-y! <br><br>  Si des migrations √©taient sign√©es apr√®s l'examen, il serait possible d'interdire l'application de projets pour la mise en sc√®ne.  Et il serait possible d'enregistrer non seulement l'identifiant de migration dans le <code>changelog</code> , mais √©galement la <code>checksum</code> - √©galement utile. <br><br><h3>  Retour tel qu'il √©tait </h3><br>  Un virage particuli√®rement insidieux se produit lorsqu'une t√¢che est annul√©e: ils l'ont fait, l'ont fait et ont chang√© d'avis.  C‚Äôest une situation normale.  Une fois que le code n'est plus n√©cessaire, la branche doit √™tre supprim√©e.  Et il y a eu la migration ... et elle est d√©j√† en sc√®ne ... ah, ... oups.  Une bonne raison de v√©rifier si vous pouvez restaurer la sauvegarde du r√©f√©rentiel.  Tout en rappelant qu'il y avait peut-√™tre plus facile. <br><br>  Dans le m√™me temps, la migration est du texte.  Et il serait possible de sauvegarder ce texte l√†, dans le <code>changelog</code> .  Ensuite, si la migration √† partir du code a disparu, peu importe pour quelles raisons, elle pourrait toujours √™tre annul√©e.  Et m√™me automatiquement. <br><br><h3>  Refaire encore </h3><br>  La section UNDO est d√©finitivement n√©cessaire.  Mais pourquoi l'√©crire?  Bien s√ªr, il existe des cas accrocheurs, mais la plupart des modifications sont <code>CREATE TABLE</code> ou <code>ADD COLUMN</code> ou <code>CREATE INDEX</code> .  Pour eux, l'utilitaire pouvait g√©n√©rer automatiquement des op√©rations inverses, directement √† l'aide de code SQL.  Bien s√ªr, il y a une sp√©cificit√©.  <code>CREATE TABLE ${name}</code> - c'est une √©quipe si sp√©ciale, soudainement non standard.  Oui, et pour g√©n√©rer <code>DROP TABLE ${name}</code> , vous devez pouvoir analyser l'expression jusqu'au troisi√®me mot.  Bien qu'il s'agisse en g√©n√©ral d'une t√¢che technique pleinement r√©alisable.  Peut √™tre sorti de la bo√Æte. <br><br><h3>  Conclusion </h3><br>  Bien s√ªr, je trouve √† redire.  MyBatis Migrations a √©t√© con√ßu comme un utilitaire simple et universel, minimalement li√© aux sp√©cificit√©s des bases de donn√©es.  Et elle est plus que se justifier.  Mais il semble que quelques petites am√©liorations le rendraient beaucoup mieux, surtout lorsqu'il est utilis√© sur de longues distances. <br>  - <br>  <i>Dmitry Mamonov / Wrike</i> </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr414441/">https://habr.com/ru/post/fr414441/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr414427/index.html">Que peut faire une imprimante 3D? Rapport de l'exposition Maker Faire Bay Area 2018</a></li>
<li><a href="../fr414429/index.html">Comment apprendre une langue √©trang√®re sans professeur. Partie 1. ¬´Mon exp√©rience¬ª</a></li>
<li><a href="../fr414431/index.html">Mitap JavaJam. D√©bat Javista, rafting, exp√©riences et microservices</a></li>
<li><a href="../fr414433/index.html">Nous nous promenons sagement dans la ville: comme j'ai fait le service pour construire des itin√©raires de randonn√©e int√©ressants</a></li>
<li><a href="../fr414437/index.html">Le blocage des t√©l√©grammes a d√©clench√© une augmentation du co√ªt des startups nationales</a></li>
<li><a href="../fr414443/index.html">Caract√©ristiques des appels de fonction en C ++</a></li>
<li><a href="../fr414445/index.html">Am√©liorer Zimbra avec la suite Zextras</a></li>
<li><a href="../fr414447/index.html">Des tr√©sors de tous les temps</a></li>
<li><a href="../fr414449/index.html">Comment se faire des amis de tous les op√©rateurs du stade et ne pas l'ensemencer avec des centaines d'antennes</a></li>
<li><a href="../fr414451/index.html">"Calendrier des testeurs" pour juin. Le testeur doit attraper le bug, lire Caner et organiser le d√©placement.</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>