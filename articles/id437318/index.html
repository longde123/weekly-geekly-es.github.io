<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🏓 🕺🏼 😚 Migrasi yang mulus (hampir) antara rilis PostgreSQL besar menggunakan replikasi logis 🦎 💌 🌒</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Di True Engineering, pada satu proyek, kebutuhan telah datang untuk mengubah versi PostgreSQL dari 9.6 menjadi 11.1. 

 Mengapa Basis data pada proyek...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Migrasi yang mulus (hampir) antara rilis PostgreSQL besar menggunakan replikasi logis</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/true_engineering/blog/437318/">  Di True Engineering, pada satu proyek, kebutuhan telah datang untuk mengubah versi PostgreSQL dari 9.6 menjadi 11.1. <br><br>  Mengapa  Basis data pada proyek ini sudah berukuran 1,5 Tb dan terus bertambah.  Kinerja adalah salah satu persyaratan utama untuk sistem.  Dan struktur data itu sendiri berkembang: kolom baru ditambahkan, yang sudah ada diubah.  Versi baru Postgres telah belajar cara bekerja secara efisien dengan penambahan kolom baru dengan nilai default, sehingga tidak perlu memagari kruk kustom di tingkat aplikasi.  Bahkan dalam versi baru, beberapa cara baru tabel partisi ditambahkan, yang juga sangat berguna dalam kondisi sejumlah besar data. <br><br>  Jadi, sudah diputuskan, kami sedang bermigrasi.  Tentu saja, Anda dapat meningkatkan versi baru dari server PostgreSQL bersamaan dengan yang lama, menghentikan aplikasi, menggunakan dump / restore (atau pg_upgrade) untuk memindahkan database, dan memulai aplikasi lagi.  Solusi ini tidak cocok untuk kami karena ukuran pangkalan yang besar, di samping itu, aplikasi berfungsi dalam mode pertempuran, dan hanya ada beberapa menit untuk downtime. <br><br>  Oleh karena itu, kami memutuskan untuk mencoba migrasi menggunakan replikasi logis di PostgreSQL menggunakan plugin pihak ketiga yang disebut <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">pglogical</a> . <br><br>  Dalam proses "percobaan", kami menemukan dokumentasi yang sangat terpisah tentang proses ini (dan dalam bahasa Rusia tidak sama sekali), serta beberapa jebakan dan nuansa yang tidak jelas.  Pada artikel ini, kami ingin menyajikan pengalaman kami dalam bentuk Tutorial. <br><br><img src="https://habrastorage.org/webt/cp/i7/oi/cpi7oixtsenmioqdrcyyotgagyk.png"><br><br>  <b>TL; DR</b> <br><br><ul><li>  Semuanya ternyata (bukan tanpa kruk, artikel tentang mereka). </li><li>  Anda dapat bermigrasi dalam versi PostgreSQL dari 9,4 ke 11.x, dari versi mana saja ke bawah, ke atas atau ke atas. </li><li>  Waktu henti sama dengan waktu yang dibutuhkan aplikasi Anda untuk terhubung kembali ke server database baru (dalam kasus kami, itu adalah restart seluruh aplikasi, tetapi di alam liar, jelas, "opsi yang memungkinkan"). </li></ul><a name="habracut"></a><br><h3>  Mengapa solusi "dahi" tidak cocok untuk kita </h3><br>  Seperti yang telah kami katakan, jalan keluar yang paling mudah adalah menaikkan versi baru dari server PostgreSQL secara paralel dengan yang lama, menghentikan aplikasi, menggunakan dump / restore (atau pg_upgrade) untuk memindahkan database, dan memulai aplikasi lagi.  Untuk database volume kecil, pada prinsipnya, ini adalah opsi yang cukup cocok (atau, dalam kasus umum, volume tidak penting ketika Anda memiliki opsi downtime aplikasi untuk periode "transfusi" database dari server lama ke yang baru, tidak peduli berapa lama waktu ini).  Tetapi dalam kasus kami, basis data membutuhkan sekitar 1,5 Tb pada disk, dan memindahkannya bukan masalah beberapa menit, tetapi beberapa jam.  Aplikasi ini, pada gilirannya, berfungsi dalam mode tempur, dan saya benar-benar ingin menghindari waktu henti selama lebih dari beberapa menit. <br><br>  Juga terhadap opsi ini adalah kenyataan bahwa kami menggunakan replikasi Master-Slave dan tidak dapat dengan aman mematikan server Slave dari alur kerja.  Jadi, untuk mengalihkan aplikasi dari versi PostgreSQL lama ke yang baru setelah migrasi dari server Master, perlu menyiapkan server Slave baru sebelum meluncurkan aplikasi.  Dan ini adalah beberapa jam lagi downtime sampai Slave dibuat (walaupun jauh lebih sedikit daripada migrasi dari Master). <br><br>  Oleh karena itu, kami memutuskan untuk mencoba migrasi menggunakan replikasi logis di PostgreSQL menggunakan plugin pihak ketiga yang disebut pglogical. <br><br><h3>  Informasi umum </h3><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">pglogical</a> adalah sistem replikasi logis menggunakan Decoding Logical asli dalam PostgreSQL dan diimplementasikan sebagai ekstensi PostgreSQL.  Memungkinkan Anda mengonfigurasi replikasi selektif menggunakan model berlangganan / publikasi.  Itu tidak memerlukan penciptaan pemicu dalam database atau penggunaan utilitas eksternal untuk replikasi. <br><br>  Ekstensi berfungsi pada versi PostgreSQL apa pun, mulai dari 9,4 (sejak Decoding Logikal pertama kali muncul pada 9.4), dan memungkinkan Anda untuk bermigrasi di antara versi PostgreSQL yang didukung ke segala arah. <br><br>  Menyiapkan replikasi secara manual menggunakan pglogical secara manual tidak terlalu sepele, meskipun pada prinsipnya sangat mungkin.  Untungnya, ada <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">pgrepup</a> utilitas pihak <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">ketiga</a> untuk mengotomatisasi proses konfigurasi, yang akan kita gunakan. <br><br><h3>  Disk Space Memo </h3><br>  Karena kami berencana untuk meningkatkan versi baru PostgreSQL pada server yang sama secara paralel dengan yang lama, persyaratan disk untuk database pada server Master dan Slave menjadi dua kali lipat.  Tampaknya ini sudah jelas, tapi ... Jaga cukup ruang kosong sebelum memulai replikasi, agar tidak menyesali tahun yang dihabiskan tanpa tujuan. <br><br>  Dalam kasus kami, modifikasi database diperlukan, ditambah format penyimpanan selama migrasi antara 9,6 dan 11 "membengkak" tidak mendukung versi terbaru, sehingga ruang disk harus ditingkatkan bukan oleh 2, tetapi sekitar 2,2 kali.  Puji LVM, ini bisa dilakukan dalam proses migrasi on the fly. <br><br>  Secara umum, rawatlah itu. <br><br><h3>  Instal PostgreSQL 11 pada Master </h3><br><blockquote>  Catatan: Kami menggunakan Oracle Linux, dan semua hal berikut akan dipertajam untuk distribusi ini.  Ada kemungkinan bahwa distribusi Linux lainnya akan memerlukan sedikit revisi dengan sebuah file, tetapi sepertinya tidak akan signifikan. </blockquote><pre><code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#   yum install https://download.postgresql.org/pub/repos/yum/11/redhat/rhel-7-x86_64/pgdg-oraclelinux11-11-2.noarch.rpm #   postgresql11 yum install postgresql11 postgresql11-devel postgresql11-server postgresql11-contrib #   /usr/pgsql-11/bin/postgresql-11-setup initdb</span></span></code> </pre> <br>  Datadir lama terletak di <b>/var/lib/pgsql/9.6/data</b> , yang baru, oleh karena itu, ada di <b>/ var / lib / pgsql / 11 / data</b> <br><br>  Salin pengaturan akses ( <b>pg_hba.conf</b> ) dan pengaturan server ( <b>postgresql.conf</b> ) dari 9,6 ke 11. <br><br>  Untuk menjalankan dua server PostgreSQL pada mesin yang sama, dalam konfigurasi konfigurasi <b>postgresql.conf</b> 11, ubah port menjadi 15432 (port = 15432). <br><br>  Di sini Anda perlu berpikir hati-hati apa lagi yang perlu Anda lakukan dalam versi baru PostgreSQL khusus dalam kasus Anda, sehingga itu dimulai dengan <b>postgresql.conf</b> Anda (dan aplikasi Anda akhirnya dapat bekerja dengannya).  Dalam kasus kami, diperlukan untuk menginstal ekstensi PostgreSQL yang digunakan oleh kami di versi baru.  Ini di luar ruang lingkup artikel, buat saja PostgreSQL baru mulai, bekerja, dan sepenuhnya cocok untuk Anda :) <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#  ,  ,  shared libraries, whatever... # .... #  systemctl enable postgresql-11 systemctl start postgresql-11</span></span></code> </pre> <br>  Kami mencari di <b>/ var / lib / pgsql / 11 / data / pg_log /</b> .  Apakah semuanya baik-baik saja?  Kami melanjutkan! <br><br><h3>  Instal dan konfigurasikan pgrepup </h3><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#  python yum install python yum install python2-pip #  pgrepup pip install pgrepup #   pgrepup config</span></span></code> </pre> <br><img src="https://habrastorage.org/webt/zg/xz/9o/zgxz9oct5l-qglkxyeyrqejh4we.png"><br><br>  Nuansa: <br><br><ol><li>  Sebagai <b>app_owner kami</b> menentukan pengguna yang menjalankan server PostgreSQL. </li><li>  Untuk <b>Database,</b> tentukan <b>template1</b> . </li><li>  <b>Nama Pengguna</b> dan <b>Kata Sandi</b> - data untuk akses pengguna super.  Dalam kasus kami, metode <b>trust</b> ditentukan dalam <b>pg_hba.conf</b> untuk koneksi lokal pengguna <b>postgres</b> , sehingga Anda dapat menentukan kata sandi secara sewenang-wenang. </li></ol><br><h3>  Konfigurasikan Replikasi </h3><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#   pgrepup check</span></span></code> </pre><br>  Kami mendapatkan output dari daftar banyak parameter yang harus dikonfigurasi sesuai kebutuhan. <br><br>  Contoh hasil verifikasi: <br><br><img src="https://habrastorage.org/webt/h3/wu/zm/h3wuzmcevo7idf-xlyrz3ae8av8.png"><br><br><img src="https://habrastorage.org/webt/58/zh/bb/58zhbbubdbfvzzgat051bviywqy.png"><br><br>  Semua kesalahan selama verifikasi harus dihilangkan.  Dalam pengaturan kedua server harus ditetapkan <b>wal_level = LOGICAL</b> (untuk Decoding Logical berfungsi), pengaturan yang diperlukan untuk mesin replikasi (jumlah slot dan <b>wal_sender</b> ).  Petunjuk utilitas pgrepup cukup informatif; pertanyaan tidak boleh muncul pada sebagian besar poin. <br><br>  Kami membuat semua pengaturan yang diperlukan yang diminta pgrepup. <br><br>  Dalam kedua file <b>pg_hba.conf</b> kami menambahkan izin untuk pengguna yang akan melakukan replikasi, semua pada prompt pgrepup: <br><br><pre> <code class="bash hljs">host replication pgrepup_replication 127.0.0.1/32 md5 host all pgrepup_replication 127.0.0.1/32 md5</code> </pre> <br><h3>  Tambahkan Kunci Utama </h3><br>  Agar replikasi berfungsi, Kunci Utama harus didefinisikan di semua tabel. <br><br>  Dalam kasus kami, PK tidak ada di mana-mana, oleh karena itu, pada saat replikasi, Anda perlu menambahkannya, dan pada akhir replikasi, jika perlu, hapus saja. <br><br>  Daftar tabel tanpa PK, antara lain, menghasilkan <code>pgrepup check</code> .  Untuk semua tabel dari daftar ini, Anda perlu menambahkan kunci utama dengan cara apa pun yang cocok untuk Anda.  Dalam kasus kami, itu adalah sesuatu seperti: <br><br><pre> <code class="pgsql hljs"><span class="hljs-keyword"><span class="hljs-keyword">ALTER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> %s <span class="hljs-keyword"><span class="hljs-keyword">ADD</span></span> <span class="hljs-keyword"><span class="hljs-keyword">COLUMN</span></span> temporary_pk <span class="hljs-type"><span class="hljs-type">BIGSERIAL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">PRIMARY KEY</span></span></code> </pre> <br>  Utilitas pgrepup memiliki perintah <code>pgrepup fix</code> untuk melakukan operasi ini ( <code>pgrepup fix</code> ), dan bahkan jika digunakan, diasumsikan bahwa jika replikasi berhasil, kolom sementara ini akan dihapus secara otomatis.  Tapi, sayangnya, fungsi ini sangat ilusif dan mempesona buggy di pangkalan besar bahwa kami memutuskan untuk tidak menggunakannya, tetapi untuk melakukan operasi ini secara manual, karena nyaman bagi kami. <br><br><h3>  Instal ekstensi pglogical </h3><br>  Petunjuk untuk menginstal ekstensi dapat ditemukan di <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">sini</a> .  Ekstensi harus diinstal di kedua server. <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#       curl https://access.2ndquadrant.com/api/repository/dl/default/release/9.6/rpm | bash curl https://access.2ndquadrant.com/api/repository/dl/default/release/11/rpm | bash #   yum install postgresql96-pglogical postgresql11-pglogical</span></span></code> </pre> <br>  Tambahkan beban pustaka di <b>postgresql.conf dari</b> kedua server: <br><br><pre> <code class="bash hljs">shared_preload_libraries = <span class="hljs-string"><span class="hljs-string">'pglogical'</span></span></code> </pre> <br><h3>  Pasang ekstensi pgl_ddl_deploy </h3><br>  Ini adalah ekstensi pembantu yang digunakan pgrepup untuk replikasi DDL logis. <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#      git clone https://github.com/enova/pgl_ddl_deploy.git #       PATH=/usr/pgsql-9.6/bin/:$PATH USE_PGXS=1 make USE_PGXS=1 make install make clean #       PATH=/usr/pgsql-11/bin/:$PATH make CLANG=true make install</span></span></code> </pre> <br>  Tambahkan beban pustaka di <b>postgresql.conf dari</b> kedua server: <br><br><pre> <code class="bash hljs">shared_preload_libraries = <span class="hljs-string"><span class="hljs-string">'pglogical,pgl_ddl_deploy'</span></span></code> </pre> <br><h3>  Memeriksa Perubahan </h3><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#   postgresql systemctl restart postgresql-11</span></span></code> </pre> <br>  Sekarang menggunakan <code>pgrepup check</code> Anda perlu memastikan bahwa semuanya telah menjadi baik-baik saja dengan server target dan semua komentar mengenai server target telah sepenuhnya dihilangkan. <br><br>  Jika semuanya baik-baik saja, Anda dapat me-restart server lama.  Di sini Anda perlu memikirkan bagaimana aplikasi Anda akan bereaksi terhadap restart server database, mungkin Anda harus menghentikannya terlebih dahulu. <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#  systemctl restart postgresql-9.6 #  pgrepup check</span></span></code> </pre> <br>  Sekarang dalam output dari perintah, semua item harus ditandai sebagai OK. <br><br>  Tampaknya Anda dapat memulai migrasi, tetapi ... <br><br><h3>  Perbaiki bug pgrepup </h3><br>  Ada beberapa bug dalam versi pgrepup saat ini yang membuat migrasi menjadi tidak mungkin.  Permintaan penarikan telah dikirim, tetapi sayangnya, permintaan itu diabaikan, jadi Anda harus melakukan koreksi secara manual. <br><br>  Kami pergi ke folder instalasi pgrepup (case kami adalah <b>/usr/lib/python2.7/site-packages/pgrepup/commands/</b> ). <br><br>  Lakukan sekali.  Di setiap file <b>* .py</b> , tambahkan <code>**kwargs</code> hilang dalam deskripsi fungsi.  Gambar lebih baik daripada seribu kata: <br><br><img src="https://habrastorage.org/webt/l3/zc/uo/l3zcuo2exe8lq_0u3gwv_nq8jty.png"><br><br>  Berkomitmen di <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">sini</a> . <br><br>  Lakukan dua.  Di <b>setup.py</b> kita melakukan pencarian untuk "sh -c", dua entri, semua perintah shell multi-line harus dibuat satu-baris. <br><br>  Berkomitmen di <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">sini</a> . <br><br><h3>  Mulai migrasi </h3><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#  pgrepup setup</span></span></code> </pre> <br>  Dengan perintah ini, pgrepup menyiapkan kedua server untuk memulai replikasi, membuat pengguna, mengkonfigurasi pglogical, mentransfer skema database. <br><br><img src="https://habrastorage.org/webt/ww/km/jd/wwkmjdmmpmwyvgbdqyktohnhmmy.png"><br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#   pgrepup start</span></span></code> </pre> <br>  Dia berkata, "Ayo pergi!"  dan melambaikan tangannya: <br><br><img src="https://habrastorage.org/webt/3k/xc/_r/3kxc_rgde-t7q6yuhtvwkol5acs.png"><br><br>  Replikasi sedang berjalan.  Situasi saat ini dapat dilihat menggunakan perintah <code>pgrepup status</code> : <br><br><img src="https://habrastorage.org/webt/ig/gs/wb/iggswbqldii-c6cd5a1y7qyqawu.png"><br><br>  Di sini kita melihat bahwa dua database telah dipindahkan dan replikasi sedang berlangsung, dan satu masih dalam proses pemindahan.  Sekarang tinggal minum kopi dan menunggu sampai seluruh volume database asli dipompa. <br><br>  Sepanjang jalan, Anda dapat melihat lebih dalam ke fasad pgrepup dan melihat apa yang terjadi di bawah tenda.  Untuk pikiran yang ingin tahu, berikut adalah daftar pertanyaan sebagai titik awal: <br><br><pre> <code class="pgsql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> pg_replication_origin_status <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> remote_lsn <span class="hljs-keyword"><span class="hljs-keyword">DESC</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> *,pg_xlog_location_diff(s.sent_location,s.replay_location) byte_lag <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> pg_stat_replication s; <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> query <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> pg_stat_activity <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> application_name=<span class="hljs-string"><span class="hljs-string">'subscription_copy'</span></span></code> </pre> <br>  Memiliki banyak kopi (di server pengujian saat menulis artikel ini, migrasi ~ 700Gb data berlangsung sekitar satu hari), kami akhirnya melihat gambar berikut: <br><br><img src="https://habrastorage.org/webt/ep/2e/q2/ep2eq2c_mtywxboftk4ocb0e_1c.png"><br><br>  Dan itu berarti saatnya untuk mempersiapkan seorang budak baru. <br><br><h3>  Instal PostgreSQL 11 di Slave </h3><br>  Di sini semuanya sederhana dan menurut buku teks, tidak ada nuansa. <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#   yum install https://download.postgresql.org/pub/repos/yum/11/redhat/rhel-7-x86_64/pgdg-oraclelinux11-11-2.noarch.rpm #  postgresql 11 yum install postgresql11 postgresql11-devel postgresql11-server postgresql11-contrib #      su - postgres pg_basebackup -h db-master.hostname -p 15432 -D /var/lib/pgsql/11/data/ -R -P -U replication -X stream -c fast</span></span></code> </pre> <br>  Salin pengaturan akses ( <b>pg_hba.conf</b> ) dan pengaturan server ( <b>postgresql.conf</b> ) dari 9,6 ke 11. Dalam konfigurasi versi <b>postgresql.conf</b> 11, ubah port ke 15432 (port = 15432) <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#  systemctl enable postgresql-11 systemctl start postgresql-11</span></span></code> </pre> <br><pre> <code class="pgsql hljs">#     Master <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> *,pg_wal_lsn_diff(s.sent_lsn,s.replay_lsn) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> byte_lag <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> pg_stat_replication s; #     Slave <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> now()-pg_last_xact_replay_timestamp();</code> </pre><br><h3>  Subtotal </h3><br>  Setelah semua prosedur ini, kami mendapatkan skema replikasi yang rumit ini: <br><br><img src="https://habrastorage.org/webt/70/ns/ej/70nsejcslxlccih_yktvesptqjg.png"><br><br>  Di sini, sebagai cek terakhir (dan, pada akhirnya, itu hanya indah), Anda dapat melakukan beberapa PEMBARUAN di database Master 9.6 dan melihat bagaimana itu direplikasi ke tiga server lainnya. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/7c0/c42/89e/7c0c4289e8a00b100f58ce751bd9209e.png" alt="gambar"><br><br><h3>  Mengalihkan aplikasi ke versi baru PostgreSQL </h3><br>  Sejauh ini, aplikasi kami belum mencurigai adanya versi baru PostgreSQL, saatnya untuk memperbaikinya.  Opsi di sini pada dasarnya bergantung hanya pada dua hal: <br>  Apakah Anda akan melebihi layanan baru pada port yang sama di mana yang lama bekerja, <br>  dan apakah aplikasi Anda memerlukan restart ketika memulai kembali server database. <br><br>  Untuk bersenang-senang, kami akan menjawab kedua pertanyaan "ya" dan melanjutkan. <br><br>  Kami menghentikan aplikasi. <br><br><pre> <code class="pgsql hljs"># ,   , : <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> pg_stat_activity;</code> </pre> <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#    #       sequences. pgrepup stop</span></span></code> </pre> <br><img src="https://habrastorage.org/webt/cz/hc/2t/czhc2t8k6pjk-6ivvilidj5k9xq.png"><br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#      pgrepup uninstall</span></span></code> </pre><br><img src="https://habrastorage.org/webt/2w/ud/dq/2wuddqovqbninwwz9rx9fia8psa.png"><br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#  master: #    systemctl disable postgresql-9.6 #   ,  ,  . systemctl stop postgresql-9.6 systemctl stop postgresql-11 #  slave: #    systemctl disable postgresql-9.6 #   ,  ,  . systemctl stop postgresql-9.6 systemctl stop postgresql-11</span></span></code> </pre> <br>  Kami mengembalikan port standar di konfigurasi <b>postgresql.conf</b> versi baru ke Master dan Slave. <br><br>  Pada Slave baru, kami juga mengubah port ke yang standar di <b>recovery.conf</b> . <br><br>  Sepanjang jalan, ada saran dari dosa untuk lebih lanjut mengubah port pada versi lama menjadi tidak aktif: <br>  Kami mengekspos port non-standar di <b>postgresql.conf dari</b> versi lama ke Master dan Slave. <br>  Pada Slave lama, kami juga mengubah port ke yang non-standar di <b>recovery.conf</b> . <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#   master systemctl enable postgresql-11 systemctl start postgresql-11 #   slave: systemctl enable postgresql-11 systemctl start postgresql-11</span></span></code> </pre> <br>  Periksa log. <br><br>  Periksa status replikasi pada Master. <br><br><pre> <code class="pgsql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> *,pg_wal_lsn_diff(s.sent_lsn,s.replay_lsn) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> byte_lag <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> pg_stat_replication s;</code> </pre> <br>  Kami meluncurkan aplikasi.  Kami senang selama setengah jam. <br><br>  <b>Dan akhirnya, literatur yang bermanfaat tentang topik:</b> <br><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">pglogical</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Petunjuk Instalasi untuk pglogical</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">dokumen pglogical</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Memutakhirkan PostgreSQL dari 9,4 menjadi 10.3 dengan pglogical</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">pgrepup - tingkatkan PostgreSQL menggunakan replikasi logis</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">pgrepup - PostgreSQL REPlicate dan UPgrade</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Mengupgrade PostgreSQL dari 9,6 menjadi 10 dengan downtime minimal menggunakan pglogical</a> </li></ul><br>  Semoga beruntung </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/id437318/">https://habr.com/ru/post/id437318/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../id437308/index.html">SDL 2.0 Siklus Pelajaran: Pelajaran 4 - Menangani Acara</a></li>
<li><a href="../id437310/index.html">Batas Gradien CSS</a></li>
<li><a href="../id437312/index.html">Mengimplementasikan hot reload kode C ++ di Linux dan macOS: menggali lebih dalam</a></li>
<li><a href="../id437314/index.html">Enigma Italia: mesin kriptografi OMI</a></li>
<li><a href="../id437316/index.html">Institut Pengembangan Internet telah menyebutkan situs-situs yang mungkin terputus di RuNet sejak 1 Februari</a></li>
<li><a href="../id437320/index.html">Indeks Pengembangan Sphere Media 2018: stagnasi televisi, peningkatan kepercayaan terhadap media informal</a></li>
<li><a href="../id437322/index.html">Negara terlibat dalam BigDate</a></li>
<li><a href="../id437324/index.html">Ciuman berdarah: sifat vasorelaksasi pada air liur kelelawar vampir</a></li>
<li><a href="../id437326/index.html">Pada masalah multiplikasi, ekstraksi akar kuadrat, substitusi impor dan Milander perusahaan</a></li>
<li><a href="../id437330/index.html">devleads - bicarakan burnout</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>