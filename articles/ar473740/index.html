<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>๐ค๐ฝ ๐คต๐ป ๐๐ฝ CreateRemoteThread ููุธุงู ุงูุชุดุบูู Linux ๐ซ ๐ฉ๐ฝโ๐ฌ ๐ฌ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="ูุญุชูู WinAPI ุนูู ูุธููุฉ CreateRemoteThread ุงูุชู ุชุณูุญ ูู ุจุจุฏุก ุณูุณูุฉ ุฑุณุงุฆู ุฌุฏูุฏุฉ ูู ูุณุงุญุฉ ุงูุนููุงู ูุนูููุฉ ุฃุฎุฑู. ูููู ุงุณุชุฎุฏุงูู ููุฌููุนุฉ ูุชููุนุฉ ูู ุญูู DLL ุ ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>CreateRemoteThread ููุธุงู ุงูุชุดุบูู Linux</h1><div class="post__body post__body_full" style=";text-align:right;direction:rtl">
      <div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/473740/" style=";text-align:right;direction:rtl"><p style=";text-align:right;direction:rtl"><img src="https://habrastorage.org/webt/qu/fi/43/qufi43ym9g9-ptbmm43ajv-e_-4.jpeg" width="300" align="right" alt="Mitsuha ูุฌูุจ ุชูุงุฑุงุช ุฌุฏูุฏุฉ">  ูุญุชูู WinAPI ุนูู ูุธููุฉ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=" rel="nofollow">CreateRemoteThread</a> ุงูุชู ุชุณูุญ ูู ุจุจุฏุก ุณูุณูุฉ ุฑุณุงุฆู ุฌุฏูุฏุฉ ูู ูุณุงุญุฉ ุงูุนููุงู ูุนูููุฉ ุฃุฎุฑู.  ูููู ุงุณุชุฎุฏุงูู ููุฌููุนุฉ ูุชููุนุฉ ูู ุญูู DLL ุ ุณูุงุก ููุฃุบุฑุงุถ ุงูุณูุฆุฉ (ุงูุบุด ูู ุงูุฃูุนุงุจ ุ ุณุฑูุฉ ูููุฉ ุงููุฑูุฑ ุ ููุง ุฅูู ุฐูู) ุ ููุฅุตูุงุญ ุงูุฎูู ูู ุจุฑูุงูุฌ ููุฏ ุงูุชุดุบูู ุ ุฃู ุฅุถุงูุฉ ููููุงุช ุฅุถุงููุฉ ุฅูู ุงูุฃูุงูู ุงูุชู ูู ุชูู ูููุง ุงูููุฏูุฉ. </p><br><p style=";text-align:right;direction:rtl">  ุจุดูู ุนุงู ุ ุชุญุชูู ูุฐู ุงููุธููุฉ ุนูู ุฃุฏุงุฉ ูุณุงุนุฏุฉ ููุชุทุจูู ูุดููู ูููุง ุ ูุฐูู ููุณ ูู ุงููุณุชุบุฑุจ ุฃู ูุง ูุญุชูู Linux ุนูู ูุณุฎุฉ ุชูุงุซููุฉ ุฌุงูุฒุฉ ูู CreateRemoteThread.  ููุน ุฐูู ุ ููุช ุฃุชุณุงุกู ููู ูููู ุชูููุฐูุง.  ุฏุฑุงุณุฉ ุงูููุถูุน ุชุญููุช ุฅูู ูุบุงูุฑุฉ ุฌูุฏุฉ. </p><br><p style=";text-align:right;direction:rtl">  ุณูู ุฃุชุญุฏุซ ุจุงูุชูุตูู ุนู ููููุฉ ุ ุจูุณุงุนุฏุฉ ููุงุตูุงุช ELF ุ ูุชุงุจุฉ ุจุนุถ ุงููุนุฑูุฉ ุจุงููููู x86_64 ูููุงููุงุช ูุธุงู Linux ุ ูุฏูู ูุทุนุฉ ุตุบูุฑุฉ ูู ูุตุญุญ ุงูุฃุฎุทุงุก ุงูุชู ูููููุง ุชุญููู ูุชูููุฐ ุชุนูููุงุช ุจุฑูุฌูุฉ ุนุดูุงุฆูุฉ ูู ุนูููุฉ ููุฏ ุงูุชุดุบูู ูุงูุนูู ุจุงููุนู. </p><br><p style=";text-align:right;direction:rtl">  ุณูุชุทูุจ ููู ุงููุต ูุนุฑูุฉ ุฃุณุงุณูุฉ ุญูู ุจุฑูุฌุฉ ุงููุธุงู ููุธุงู Linux: ูุบุฉ C ูุจุฑุงูุฌ ุงููุชุงุจุฉ ูุงูุชุตุญูุญ ุนููู ุ ูููู ุฏูุฑ ุฑูุฒ ุงูุฌูุงุฒ ูุงูุฐุงูุฑุฉ ูู ุงูููุจููุชุฑ ุ ูููููู ููุงููุงุช ุงููุธุงู ุ ูุงูุฅููุงู ุจุงูููุชุจุงุช ุงูุฑุฆูุณูุฉ ุ ููุฑุงุกุฉ ุงููุซุงุฆู. </p><a name="habracut"></a><br><ul style=";text-align:right;direction:rtl"><li style=";text-align:right;direction:rtl">  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">ุงูุฃููุงุฑ ุงูุฑุฆูุณูุฉ</a> </li><li style=";text-align:right;direction:rtl">  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">ุฑุณู ุงูุญู</a> </li><li style=";text-align:right;direction:rtl">  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">ุงูุฎุทูุฉ 1. ุงุชุตุงู ููุฐู ุงูุนูููุฉ</a> </li><li style=";text-align:right;direction:rtl">  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">ุงูุฎุทูุฉ 2. ุงูุจุญุซ ูู ุงูููุชุจุงุช ูู ุงูุฐุงูุฑุฉ</a> </li><li style=";text-align:right;direction:rtl">  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">ุงูุฎุทูุฉ 3. ุชุญููู ุงูุตูุฑ ููุชุจุฉ ELF</a> </li><li style=";text-align:right;direction:rtl">  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">ุงูุฎุทูุฉ 4. ุชูููุฐ ููุฏ ุงููุดุฑุฉ</a> </li><li style=";text-align:right;direction:rtl">  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">ุงูุฎุทูุฉ 5. ุจุฏุก ููุถูุน ุฌุฏูุฏ</a> </li><li style=";text-align:right;direction:rtl">  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">ุงุณุชูุชุงุฌ</a> </li></ul><br><p style=";text-align:right;direction:rtl">  ููุชูุฌุฉ ูุฐูู ุ ุชูููุช ูู "ุฅุถุงูุฉ" ุงููุฏุฑุฉ ุนูู ูุนุงููุฉ ูููุงุช ุงููุฑูุฑ ูู ูุฑูุฒ ุชุญูู ุฌููู: </p><br><p style=";text-align:right;direction:rtl"><img src="https://habrastorage.org/webt/0v/gu/we/0vguwedoumnnjh89zw5jtpaaltw.gif" alt="ูุธุงูุฑุฉ ุงูุญูู ูู ูุฑูุฒ ุชุญูู ุฌููู"></p><br><h2 id="osnovnye-idei" style=";text-align:right;direction:rtl">  ุงูุฃููุงุฑ ุงูุฑุฆูุณูุฉ </h2><br><p style=";text-align:right;direction:rtl">  ุฅุฐุง ูู ููู ููุงู ุดุฑุท ูู ูุชุทูุจุงุช ุชุญููู ุงูููุฏ ูู ุนูููุฉ ููุฏ ุงูุชุดุบูู ุจุงููุนู ุ ูุณูููู ุงูุญู ุจุณูุทูุง ููุบุงูุฉ: LD_PRELOAD.  ูุณูุญ ูุชุบูุฑ ุงูุจูุฆุฉ ูุฐุง ุจุชุญููู ููุชุจุฉ ุงุนุชุจุงุทูุฉ ูุน ุงูุชุทุจูู.  ูู ุงูููุชุจุงุช ุงููุดุชุฑูุฉ ุ ููููู ุชุญุฏูุฏ <em>ูุธุงุฆู ุงูููุดุฆ</em> ุงูุชู ูุชู ุชูููุฐูุง ุนูุฏ ุชุญููู ุงูููุชุจุฉ. </p><br><p style=";text-align:right;direction:rtl">  ูุนุงู ุ ูุณูุญ LD_PRELOAD ูุงูููุดุฆูู ุจุชูููุฐ ุชุนูููุงุช ุจุฑูุฌูุฉ ุนุดูุงุฆูุฉ ูู ุฃู ุนูููุฉ ุจุงุณุชุฎุฏุงู ุฃุฏุงุฉ ุชุญููู ุญูููุฉ.  ูุฐู ูู ููุฒุฉ ูุนุฑููุฉ ูุณุจูุง ูุบุงูุจุง ูุง ุชุณุชุฎุฏู ูุชุตุญูุญ ุงูุฃุฎุทุงุก.  ุนูู ุณุจูู ุงููุซุงู ุ ููููู ุชูุฒูู ููุชุจุชู ุงูุฎุงุตุฉ ูู ุฎูุงู ุงูุชุทุจูู ุ ุงูุฐู ูุญุฏุฏ ุงููุธุงุฆู malloc () ู free () ุ ููุง ูุฏ ูุณุงุนุฏ ูู ุงูุชุดุงู ุชุณุฑุจ ุงูุฐุงูุฑุฉ. </p><br><p style=";text-align:right;direction:rtl">  ูุณูุก ุงูุญุธ ุ ูุง ูุนูู LD_PRELOAD ุฅูุง ุนูุฏ ุจุฏุก ุงูุนูููุฉ.  ูุง ูููู ุงุณุชุฎุฏุงูู ูุชุญููู ููุชุจุฉ ูู ุนูููุฉ ููุฏ ุงูุชุดุบูู ุจุงููุนู.  ููุงู ูุธููุฉ dlopen () ูุชุญููู ุงูููุชุจุงุช ุฃุซูุงุก ุชุดุบูู ุงูุนูููุฉ ุ ูููู ูู ุงููุงุถุญ ุฃู ุงูุนูููุฉ ููุณูุง ูุฌุจ ุฃู ุชุทูููุง ูุชุญููู ุงูููููุงุช ุงูุฅุถุงููุฉ. </p><br><blockquote style=";text-align:right;direction:rtl"> <strong>ุญูู ุงููููุงุช ุงูุชูููุฐูุฉ ุงูุซุงุจุชุฉ</strong> <br><br>  ูุนูู LD_PRELOAD ููุท ูุน ุงูุจุฑุงูุฌ ุงูุชู ุชุณุชุฎุฏู ุจุฑูุงูุฌ ุงูุชุญููู ุงูุฏููุงูููู.  ุฅุฐุง ุชู ุจูุงุก ุงูุจุฑูุงูุฌ ุจุงุณุชุฎุฏุงู ููุชุงุญ ุงูุชุจุฏูู <code>-static</code> ุ ูุฅูู ูุดูู ุฌููุน ุงูููุชุจุงุช ุงููุงุฒูุฉ.  ูู ูุฐู ุงูุญุงูุฉ ุ ูุชู ุชูููุฐ ุฏูุฉ ุงูุชุจุนูุงุช ูู ุงูููุชุจุงุช ูู ููุช ุงูุฅูุดุงุก ุ ูุนุงุฏุฉ ูุง ูููู ุงูุจุฑูุงูุฌ ุบูุฑ ุฌุงูุฒ ูุบูุฑ ูุงุฏุฑ ุนูู ุชุญููู ุงูููุชุจุงุช ุฏููุงูููููุง ุจุนุฏ ุงูุชุฌููุน ุ ูู ููุช ุงูุชุดุบูู. <br><br>  ูู ุงูุจุฑุงูุฌ ุงููุฌูุนุฉ ุจุดูู ุซุงุจุช ุ ููููู ุชุถููู ุงูุชุนูููุงุช ุงูุจุฑูุฌูุฉ ูู ููุช ุงูุชุดุบูู ุ ูููู ูุฌุจ ุฃู ูุชู ุฐูู ุจุทุฑููุฉ ูุฎุชููุฉ ููููุงู.  ููุฐุง ููุณ ุขูููุง ุชูุงููุง ุ ูุฃู ุงูุจุฑูุงูุฌ ูุฏ ูุง ูููู ุฌุงูุฒูุง ููุซู ูุฐุง ุงูููุนุทู. </blockquote><p style=";text-align:right;direction:rtl">  ุจุดูู ุนุงู ุ ูุง ููุฌุฏ ุญู ููุงุณุจ ุฌุงูุฒ ุ ูุฌุจ ุนููู ูุชุงุจุฉ ุฏุฑุงุฌุชู.  ุฎูุงู ุฐูู ุ ูู ุชูุฑุฃ ูุฐุง ุงููุต :) </p><br><p style=";text-align:right;direction:rtl">  ูู ุงููุงุญูุฉ ุงููุธุฑูุฉ ุ ูุฅุฌุจุงุฑ ุนูููุฉ ุดุฎุต ุขุฎุฑ ุนูู ุชูููุฐ ููุน ูู ุงูุชุนูููุงุช ุงูุจุฑูุฌูุฉ ุ ุชุญุชุงุฌ ุฅูู ุชูููุฐ ุงูุฅุฌุฑุงุกุงุช ุงูุชุงููุฉ: </p><br><ol style=";text-align:right;direction:rtl"><li style=";text-align:right;direction:rtl">  ุงูุญุตูู ุนูู ุงูุณูุทุฑุฉ ูู ุงูุนูููุฉ ุงููุณุชูุฏูุฉ. </li><li style=";text-align:right;direction:rtl">  ูู ุจุชุญููู ุงูููุฏ ูู ุฐุงูุฑุฉ ุงูุนูููุฉ ุงููุณุชูุฏูุฉ. </li><li style=";text-align:right;direction:rtl">  ูู ุจุฅุนุฏุงุฏ ุงูููุฏ ุงูุฐู ุชู ุชูุฒููู ููุชูููุฐ ูู ุงูุนูููุฉ ุงููุณุชูุฏูุฉ. </li><li style=";text-align:right;direction:rtl">  ุชูุธูู ุชูููุฐ ุงูููุฏ ุงูุฐู ุชู ุชูุฒููู ุจูุงุณุทุฉ ุงูุนูููุฉ ุงููุณุชูุฏูุฉ. </li></ol><br><p style=";text-align:right;direction:rtl">  ุฏุนูุง ูุฐูุจ ... </p><br><h3 id="poluchenie-upravleniya-v-processe" style=";text-align:right;direction:rtl">  ุงูุญุตูู ุนูู ุงูุณูุทุฑุฉ ูู ูุฐู ุงูุนูููุฉ </h3><br><p style=";text-align:right;direction:rtl">  ุจุงุฏุฆ ุฐู ุจุฏุก ุ ูุญู ุจุญุงุฌุฉ ุฅูู ุฅุฎุถุงุน ุงูุนูููุฉ ุงููุณุชูุฏูุฉ ูุฅุฑุงุฏุชูุง.  ุจุนุฏ ูู ุดูุก ุ ุนุงุฏุฉ ูุง ุชููุฐ ุงูุนูููุงุช ููุท ุงูุชุนูููุงุช ุงูุจุฑูุฌูุฉ ุงูุฎุงุตุฉ ุจูุง ุ ุฃู ุฑูุฒ ุงูููุชุจุงุช ุงููุญููุฉ ุ ุฃู ูุชุงุฆุฌ ุชุฌููุน JIT.  ูููู ุจุงูุชุฃููุฏ ููุณ ูุฏููุง ุฑูุฒ. </p><br><p style=";text-align:right;direction:rtl">  ุฃุญุฏ ุงูุฎูุงุฑุงุช ูู ุงุณุชุฎุฏุงู ููุน ูู ุงูุถุนู ูู ุงูุนูููุฉ ุงูุชู ุชุชูุญ ูู ุงูุณูุทุฑุฉ.  ูุซุงู ููุงุณููู ูู ุงูุจุฑุงูุฌ ุงูุชุนููููุฉ: ุชุฌุงูุฒ ุณุนุฉ ุงููุฎุฒู ุงููุคูุช ุ ููุง ูุณูุญ ุจุฅุนุงุฏุฉ ูุชุงุจุฉ ุนููุงู ุงููุฑุณู ูู ุงูุญุฒูุฉ.  ุฅูู ููุชุน ุ ุญุชู ูู ุจุนุถ ุงูุฃุญูุงู ูุนูู ุ ูููู ุบูุฑ ููุงุณุจ ููุญุงูุฉ ุงูุนุงูุฉ. </p><br><p style=";text-align:right;direction:rtl">  ุณูู ูุณุชุฎุฏู ุทุฑููุฉ ุฃุฎุฑู ุตุงุฏูุฉ ููุณูุทุฑุฉ: <em>ููุงููุงุช ูุธุงู ุชุตุญูุญ ุงูุฃุฎุทุงุก</em> .  ูููู ุฃู ุชููู ูุตุญุญุงุช ุงูุฃุฎุทุงุก ุงูุชูุงุนููุฉ ุจุฅููุงู ุนูููุงุช ุงูุฌูุงุช ุงูุฎุงุฑุฌูุฉ ุชูุงููุง ูุชูููู ุงูุชุนุจูุฑุงุช ูุฃุดูุงุก ุฃุฎุฑู ูุซูุฑุฉ.  ูููููู - ูููููุง ุฐูู. </p><br><p style=";text-align:right;direction:rtl">  ุนูู Linux ุ ุงุณุชุฏุนุงุก ูุธุงู ุงูุชุตุญูุญ ุงูุฑุฆูุณู ูู <strong>ptrace ()</strong> .  ูุชูุญ ูู ุงูุงุชุตุงู ุจุงูุนูููุงุช ููุญุต ุญุงูุชูุง ูุงูุชุญูู ูู ุชูุฏู ุชูููุฐูุง.  ูุชู ุชูุซูู ptrace () ุจุดูู ุฌูุฏ ูู ุชููุงุก ููุณู ุ ูููู ุชูุงุตูู ุงุณุชุฎุฏุงูู ูุงุถุญุฉ ููุท ูู ุงูููุงุฑุณุฉ ุงูุนูููุฉ. </p><br><h3 id="zagruzka-koda-v-pamyat-processa" style=";text-align:right;direction:rtl">  ุชุญููู ุฑูุฒ ูู ุฐุงูุฑุฉ ุงูุนูููุฉ </h3><br><p style=";text-align:right;direction:rtl">  ูู ุญุงูุฉ ุชุฌุงูุฒุงุช ุงููุฎุฒู ุงููุคูุช ุ ุนุงุฏุฉู ูุง ูุชู ุชุถููู ุงูุญูููุฉ ุงููุงูุนุฉ ( <em>ููุฏ ุงููุดุฑุฉ</em> ) ูู ุงููุญุชููุงุช ุงูุชู ุชููุถ ุนูู ููุณ ุงููุฎุฒู ุงููุคูุช.  ุนูุฏ ุงุณุชุฎุฏุงู ูุตุญุญ ุงูุฃุฎุทุงุก ุ ูููู ูุชุงุจุฉ ุงูุชุนูููุงุช ุงูุจุฑูุฌูุฉ ุงูุถุฑูุฑูุฉ ูู ุฐุงูุฑุฉ ุงูุนูููุฉ ูุจุงุดุฑุฉ.  ูู WinAPI ููุงู ูุธููุฉ ุฎุงุตุฉ WriteProcessMemory ููุฐุง ุงูุบุฑุถ.  ูุชูุงูู Linux ููุฐุง ุงูุบุฑุถ ูุน ุทุฑููุฉ UNIX: ููู ุนูููุฉ ูู ุงููุธุงู ุ ููุฌุฏ ููู <strong>/ proc / $ pid / mem</strong> ุ ูุนุฑุถ ุฐุงูุฑุฉ ูุฐู ุงูุนูููุฉ.  ูู ุงููููู ูุชุงุจุฉ ุดูุก ูุง ุนูู ุฐุงูุฑุฉ ุงูุนูููุฉ ุจุงุณุชุฎุฏุงู ุงููุฏุฎูุงุช ูุงููุฎุฑุฌุงุช ุงููุนุชุงุฏุฉ. </p><br><h3 id="podgotovka-koda-k-ispolneniyu" style=";text-align:right;direction:rtl">  ุฅุนุฏุงุฏ ุฑูุฒ ููุชูููุฐ </h3><br><p style=";text-align:right;direction:rtl">  ูุฌุฑุฏ ูุชุงุจุฉ ุงูุชุนูููุงุช ุงูุจุฑูุฌูุฉ ูู ุงูุฐุงูุฑุฉ ูุง ูููู.  ูุง ูุฒุงู ูุญุชุงุฌ ุฅูู ุฃู ููุชุจ <em>ุฅูู ุงูุฐุงูุฑุฉ ุงููุงุจูุฉ ููุชูููุฐ</em> .  ูู ุญุงูุฉ ุงูุชุณุฌูู ูู ุฎูุงู ูุดููุฉ ุนุฏู ุงูุญุตุงูุฉ ุ ุชูุฌุฏ ุตุนูุจุงุช ุบูุฑ ุชุงููุฉ ูุน ุฐูู ุ ูููู ุจูุง ุฃููุง ูุณุชุทูุน ุงูุชุญูู ุงููุงูู ูู ุงูุนูููุฉ ุงููุณุชูุฏูุฉ ุ ููู ููุงุฌู ูุดููุฉ ูู ุฅูุฌุงุฏ ุฃู ุชุฎุตูุต ุงูุฐุงูุฑุฉ "ุงูุตุญูุญุฉ". </p><br><p style=";text-align:right;direction:rtl">  ููุทุฉ ุฃุฎุฑู ูููุฉ ููุชุญุถูุฑ ูู ุฑูุฒ ูุฐููุฉ ููุณูุง.  ูู ุฐูู ุ ุฑุจูุง ูุฑุบุจ ูู ุงุณุชุฎุฏุงู ุจุนุถ ุงููุธุงุฆู ูู ุงูููุชุจุงุช ุ ูุซู ุงููุฏุฎูุงุช ูุงููุฎุฑุฌุงุช ุ ูุงูุฃููููุงุช ุงูุฑุณูููุฉ ุ ูููู ุฌุฑุง.  ููุน ุฐูู ุ ูุชุนูู ุนูููุง ูุชุงุจุฉ ุฑูุฒ ุงูุฌูุงุฒ ุงูุนุงุฑู ุ ูุงูุฐู ูู ุญุฏ ุฐุงุชู ููุณ ูุฏูู ููุฑุฉ ุนู ุนูุงููู ูู ูุฐู ุงููุธุงุฆู ุงูุฑุงุฆุนุฉ ูู ุงูููุชุจุงุช.  ูู ุฃูู ุชุญุตู ุนูููุงุ </p><br><p style=";text-align:right;direction:rtl">  ูุชุจุณูุท ุนูุฑ ูุธุงู ุงูุชุดุบูู ูุชุนููุฏ ุนูุฑ ุงูุชุนูููุงุช ุงูุจุฑูุฌูุฉ ุงูุถุงุฑุฉ ุ ูุง ุชุณุชุฎุฏู ุงูููุชุจุงุช ุนุงุฏุฉ ุนูุงููู ุซุงุจุชุฉ (ูุชุญุชูู ุนูู ูุง ูุณูู <em>ุจุฑูุฒ ูุณุชูู ุนู ุงูููุถุน</em> ).  ูุฐูู ูุง ูููู ุชุฎููู ุงูุนูุงููู. </p><br><p style=";text-align:right;direction:rtl">  ุนูุฏูุง ุชุจุฏุฃ ุงูุนูููุฉ ุจุดูู ุทุจูุนู ุ ูููู <em>ุงููุญูู</em> ุงูุฐู ูููู ุจุฅุฌุฑุงุก ุนูููุงุช <em>ุงูุชุฑุญูู</em> ูุณุคููุงู ุนู ุชุญุฏูุฏ ุงูุนูุงููู ุงูุฏูููุฉ ููููุชุจุงุช.  ููุน ุฐูู ุ ูุฅูู ููู ูุฑุฉ ูุงุญุฏุฉ ููุท ูู ุงูุจุฏุงูุฉ.  ุฅุฐุง ูุงูุช ุงูุนูููุฉ ุชุณูุญ ุจุงูุชุญููู ุงูุฏููุงูููู ููููุชุจุงุช ุ ูููุงู <em>ูุญูู ุฏููุงูููู</em> ูููู ุฃู ููุนู ููุณ ุงูุดูุก ุฃุซูุงุก ุชุดุบูู ุงูุนูููุฉ.  ููุน ุฐูู ุ ูุฅู ุนููุงู ุงููุญูู ุงูุฏููุงูููู ุบูุฑ ุซุงุจุช ุฃูุถูุง. </p><br><p style=";text-align:right;direction:rtl">  ุจุดูู ุนุงู ุ ูุน ุงูููุชุจุงุช ุ ููุงู ุฃุฑุจุนุฉ ุฎูุงุฑุงุช: </p><br><ul style=";text-align:right;direction:rtl"><li style=";text-align:right;direction:rtl">  ูุง ุชุณุชุฎุฏู ุงูููุชุจุงุช ุนูู ุงูุฅุทูุงู ุ ุงูุนู ูู ุดูุก ุนูู ููุงููุงุช ุงููุธุงู ุงููุธูู </li><li style=";text-align:right;direction:rtl">  ูุถุน ูุณุฎ ูู ุฌููุน ุงูููุชุจุงุช ุงููุงุฒูุฉ ูู ุฑูุฒ ูุฐููุฉ </li><li style=";text-align:right;direction:rtl">  ูู ุจุนูู ุงููุญูู ุงูุฏููุงูููู ุจููุณู </li><li style=";text-align:right;direction:rtl">  ุงูุนุซูุฑ ุนูู ูุญูู ุงูุฅููุงุน ุงูุฏููุงูููู ูุฌุนูู ุชุญููู ููุชุจุงุชูุง </li></ul><br><p style=";text-align:right;direction:rtl">  ุณูุฎุชุงุฑ ุงูุฃุฎูุฑ ุ ูุฃููุง ูุฑูุฏ ุงูููุชุจุงุช ุ ูููุชุจ ูุญูู ุงูุฅููุงุน ุงููุงูู ุงูุฎุงุต ุจูุง ููุชุฑุฉ ุทูููุฉ.  ูุฐู ููุณุช ุงูุทุฑููุฉ ุงูุฃูุซุฑ ุณุฑูุฉ ุ ูููุณุช ูู ุงูุฃูุซุฑ ุฅุซุงุฑุฉ ููุงูุชูุงู ุ ูููููุง ุงูุฃูุซุฑ ุจุณุงุทุฉ ูููุฉ ูููุซูููุฉ. </p><br><h3 id="peredacha-upravleniya-kodu" style=";text-align:right;direction:rtl">  ููู ุงูุณูุทุฑุฉ ุนูู ุฑูุฒ </h3><br><p style=";text-align:right;direction:rtl">  ูุณูุญ ูู ptrace () ุจุชุบููุฑ ุณุฌูุงุช ุงููุนุงูุฌ ุ ูุฐูู ูุฌุจ ุฃูุง ุชููู ููุงู ูุดุงูู ูู ููู ุงูุชุญูู ุฅูู ุงูููุฏ ุงูุฐู ุชู ุชุญูููู ูุฅุนุฏุงุฏู: ูุง ุนููู ุณูู ูุชุงุจุฉ ุนููุงู ุงูููุฏ ุงูุฎุงุต ุจูุง ูู ุณุฌููช rip - ู voila!  ููุน ุฐูู ุ ูู ุงููุงูุน ุ ูู ุดูุก ููุณ ุจูุฐู ุงูุจุณุงุทุฉ.  ุชุฑุชุจุท ุงูุตุนูุจุงุช ุจุญูููุฉ ุฃู ุงูุนูููุฉ ุงูุชู ุชู ุชุตุญูุญูุง ูู ุงููุงูุน ูู ุชุฎุชู ูุฃู ูุฏููุง ุฃูุถูุง ููุนูุง ูู ุงูุชุนูููุงุช ุงูุจุฑูุฌูุฉ ุงูุชู ุชู ุชูููุฐูุง ูุณุชุณุชูุฑ ุนูููุฉ ุงูุชูููุฐ. </p><br><h2 id="eskiz-resheniya" style=";text-align:right;direction:rtl">  ุฑุณู ุงูุญู </h2><br><p style=";text-align:right;direction:rtl">  ุงููุฌููุน ุ ุณูููุฐ ุชุฏูููุง ูู ุนูููุฉ ุทุฑู ุซุงูุซ ุนูู ุงููุญู ุงูุชุงูู: </p><br><ol style=";text-align:right;direction:rtl"><li style=";text-align:right;direction:rtl">  ูุญู ูุชุตููู ุจุงูุนูููุฉ ุงููุณุชูุฏูุฉ ูุชุตุญูุญ ุงูุฃุฎุทุงุก. </li><li style=";text-align:right;direction:rtl">  ูุฌุฏ ุงูููุชุจุงุช ุงููุงุฒูุฉ ูู ุงูุฐุงูุฑุฉ: <br><ul style=";text-align:right;direction:rtl"><li style=";text-align:right;direction:rtl">  libdl - ูุชุญููู ููุชุจุฉ ุฌุฏูุฏุฉ </li><li style=";text-align:right;direction:rtl">  libpthread - ูุจุฏุก ููุถูุน ุฌุฏูุฏ </li></ul></li><li style=";text-align:right;direction:rtl">  ูุฌุฏ ุงููุธุงุฆู ุงููุงุฒูุฉ ูู ุงูููุชุจุงุช: <br><ul style=";text-align:right;direction:rtl"><li style=";text-align:right;direction:rtl">  libdl: dlopen () ุ dlsym () </li><li style=";text-align:right;direction:rtl">  libpthread: pthread_create () ุ pthread_detach () </li></ul></li><li style=";text-align:right;direction:rtl"><p style=";text-align:right;direction:rtl">  ููุฏู ููุฏ shell ูู ุฐุงูุฑุฉ ุงูุนูููุฉ ุงููุณุชูุฏูุฉ: </p><br><pre style=";text-align:right;direction:rtl"> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">shellcode</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> *payload = dlopen(<span class="hljs-string"><span class="hljs-string">"/path/to/payload.so"</span></span>, RTLD_LAZY); <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> *entry = dlsym(payload, <span class="hljs-string"><span class="hljs-string">"entry_point"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">pthread_t</span></span> thread; pthread_create(&amp;thread, <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, entry, <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>); pthread_detach(thread); }</code> </pre> <br></li><li style=";text-align:right;direction:rtl">  ูุนุทู ุฑูุฒ ูุฐููุฉ ููุชู ุงูููุงุก ุจูุง. </li></ol><br><p style=";text-align:right;direction:rtl">  ูุชูุฌุฉู ูุฐูู ุ ุณุชููู ุงูููุชุจุงุช ุจุนูู ุงูุดูุก ุงูุตุญูุญ ุจุงููุณุจุฉ ููุง: ุญูุซ ุณุชููู ุจุชุญููู ููุชุจุฉ ูุฏููุง ุจุงูุฑูุฒ ุงูุฐู ูุญุชุงุฌู ูู ุงูุฐุงูุฑุฉ ูุจุฏุก ุณูุณูุฉ ุฑุณุงุฆู ุฌุฏูุฏุฉ ูุชูููุฐ ูุฐุง ุงูุฑูุฒ. </p><br><h3 id="ogranicheniya" style=";text-align:right;direction:rtl">  ูููุฏ </h3><br><p style=";text-align:right;direction:rtl">  ุงูููุฌ ุงูููุตูู ุฃุนูุงู ููุฑุถ ูููุฏูุง ูุนููุฉ: </p><br><ul style=";text-align:right;direction:rtl"><li style=";text-align:right;direction:rtl">  ูุฌุจ ุฃู ูููู ูุฏู ุฃุฏุงุฉ ุชุญููู ุงูุชุดุบูู ุงูุชูุงุฒุงุช ูุงููุฉ ูุชุตุญูุญ ุงูุนูููุฉ ุงููุฏู. </li><li style=";text-align:right;direction:rtl">  ูุฌุจ ุฃู ุชุณุชุฎุฏู ุงูุนูููุฉ libdl (ุฌุงูุฒุฉ ููุชุญููู ุงูุฏููุงูููู ูููุญุฏุงุช ุงูููุทูุฉ). </li><li style=";text-align:right;direction:rtl">  ูุฌุจ ุฃู ุชุณุชุฎุฏู ุงูุนูููุฉ libpthread (ุฌุงูุฒ ููุชุนุฏุฏ). </li><li style=";text-align:right;direction:rtl">  ุงูุชุทุจููุงุช ุงูุซุงุจุชุฉ ุบูุฑ ูุฏุนููุฉ. </li></ul><br><p style=";text-align:right;direction:rtl">  ุจุงูุฅุถุงูุฉ ุฅูู ุฐูู ุ ุฃูุง ุดุฎุตูุงู ูุณุงูู ููุบุงูุฉ ูุฃุฒุนุฌูุง ุจุฏุนู ูู ุฌููุน ุงูููุงูู ุ ูุฐูู ุณููุชุตุฑ ุนูู x86_64.  (ุญุชู x86 32 ุจุช ุณูููู ุฃูุซุฑ ุชุนููุฏูุง.) </p><br><p style=";text-align:right;direction:rtl">  ููุง ุชุฑูู ุ ูู ูุฐุง ูุถุน ุญุฏุง ููุงุณุชุฎุฏุงู ุงูุณุฑู ูุน ุงูุฃูุฏุงู ุงูุฎุจูุซุฉ.  ููุน ุฐูู ุ ูุง ุชุฒุงู ุงููููุฉ ุชุญุชูุธ ุจุงูุงูุชูุงู ุงูุจุญุซู ูุชุชุฑู ูุฑุตุฉ ุถุนููุฉ ููุงุณุชุฎุฏุงู ุงูุตูุงุนู. </p><br><h3 id="otstuplenie-ob-ispolzovanii-libdl-i-libpthread" style=";text-align:right;direction:rtl">  ุงูุงุณุชุทุฑุงุฏ: ุญูู ุงุณุชุฎุฏุงู libdl ู libpthread </h3><br><p style=";text-align:right;direction:rtl">  ูุฏ ูุชุณุงุกู ุงููุงุฑุฆ ุงููุญุชุฑู ุฐู ุงูุฎุจุฑุฉ: ููุงุฐุง ูุชุทูุจ libdl ูุง ุฅุฐุง ูุงูุช ุงูุฏุงูุชุงู ุงูุฏุงุฎููุชุงู __libc_dlopen_mode () ู __libc_dlsym () ูุฏูุฌุฉ ุจุงููุนู ูู glibc ุ ููุง ุฅุฐุง ูุงู libdl ูุฌุฑุฏ ุบูุงู ุนููููุงุ  ูุจุงููุซู ุ ููุงุฐุง ุชุชุทูุจ libpthread ุฅุฐุง ูุงู ูููู ุฅูุดุงุก ุณูุณูุฉ ุฑุณุงุฆู ุฌุฏูุฏุฉ ุจุณูููุฉ ุจุงุณุชุฎุฏุงู ุงุณุชุฏุนุงุก ูุธุงู clone ()ุ </p><br><p style=";text-align:right;direction:rtl">  ูู ุงููุงูุน ุ ูุง ููุฌุฏ ุนูู ุงูุฅูุชุฑูุช ูุซุงู ูุงุญุฏ ุนูู ููููุฉ ุงุณุชุฎุฏุงููุง: </p><br><ul style=";text-align:right;direction:rtl"><li style=";text-align:right;direction:rtl">  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=" rel="nofollow">https://github.com/gaffe23/linux-inject</a> </li><li style=";text-align:right;direction:rtl">  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=" rel="nofollow">https://github.com/TsarFox/hypodermic</a> </li><li style=";text-align:right;direction:rtl">  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=" rel="nofollow">http://hick.org/code/skape/papers/needle.txt</a> </li><li style=";text-align:right;direction:rtl">  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=" rel="nofollow">https://github.com/ice799/injectso64</a> </li><li style=";text-align:right;direction:rtl">  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=" rel="nofollow">http://www.ouah.org/subversiveld.pdf</a> </li></ul><br><p style=";text-align:right;direction:rtl">  ูุชู ุฐูุฑูุง ุญุชู ูู ุงูุฃุฏุจ ุงููุฑุงุตูุฉ ุงูุดุนุจูุฉ: </p><br><ul style=";text-align:right;direction:rtl"><li style=";text-align:right;direction:rtl">  ุชุนูู ููููุณ ุชุญููู ุซูุงุฆู </li><li style=";text-align:right;direction:rtl">  ูู ุงูุทุจ ุงูุดุฑุนู ุงูุฐุงูุฑุฉ </li></ul><br><p style=";text-align:right;direction:rtl">  ูููุงุฐุง ูุงุ  ุญุณููุง ุ ุนูู ุงูุฃูู ูุฃููุง ูุง ููุชุจ ุชุนูููุงุช ุจุฑูุฌูุฉ ุถุงุฑุฉ ุญูุซ ูููู ุงูุญู ููุงุณุจูุง ูุญุฐู 90ูช ูู ุนูููุงุช ุงููุญุต ุ ูุณุชุบุฑู ูุณุงุญุฉ ุฃูู 20 ูุฑุฉ ุ ููููู ูุนูู ุฃูุถูุง ูู 80ูช ูู ุงูุญุงูุงุช.  ุจุงูุฅุถุงูุฉ ุฅูู ุฐูู ุ ุฃุฑุฏุช ุฃู ุฃุฌุฑุจ ูู ุดูุก ุจูุฏู. </p><br><p style=";text-align:right;direction:rtl">  ูู ุงููุงูุน ุ ููุณ ูู <em>ุงูุถุฑูุฑู</em> libdl ุชุญููู ุงูููุชุจุฉ ูู ุญุงูุฉ glibc.  ูุดูุฑ ุงุณุชุฎุฏุงูู ูู ุฎูุงู ุงูุนูููุฉ ุฅูู ุฃูู ุฌุงูุฒ ุจุดูู ูุงุถุญ ูุชุญููู ุงูููุฏ ุงูุฏููุงูููู.  ุนูู ุงูุฑุบู ูู ูุฐุง ุ ูู ุญูุซ ุงููุจุฏุฃ ุ ููููู ุฑูุถ ุงุณุชุฎุฏุงู libdl (ุจุงููุธุฑ ุฅูู ุฃููุง ุณูุธู ุจุญุงุฌุฉ ุฅูู ุงูุจุญุซ ุนู glibc ูุงุญููุง ุฃูุถูุง). </p><br><blockquote style=";text-align:right;direction:rtl">  <strong>ููุงุฐุง dlopen () ุฏุงุฎู glibc ุนูู ุงูุฅุทูุงูุ</strong> <br><br>  ูุฐุง ุณุคุงู ูุซูุฑ ููุงูุชูุงู ุจุทุฑููุชู ุงูุฎุงุตุฉ.  ุฅุฌุงุจุฉ ูุตูุฑุฉ: ุชูุงุตูู ุงูุชูููุฐ. <br><br>  ุงูููุทุฉ ุงููููุฉ ูู <em>ููุชุงุญ ุฎุฏูุฉ ุงูุงุณู</em> (NSS) - ุฃุญุฏ ุฃุฌุฒุงุก glibc ุงูุชู ุชููุฑ ุชุฑุฌูุฉ ูุฃุณูุงุก ูุฎุชููุฉ: ุฃุณูุงุก ุงูุขูุงุช ูุงูุจุฑูุชููููุงุช ูุงููุณุชุฎุฏููู ูุฎูุงุฏู ุงูุจุฑูุฏ ุ ุฅูุฎ. ููู ุงููุณุคููุฉ ุนู ูุธุงุฆู ูุซู getaddrinfo () ููุญุตูู ุนูู ุนูุงููู IP ุนู ุทุฑูู ุงุณู ุงููุฌุงู ู getpwuid () ููุญุตูู ุนูู ูุนูููุงุช ุญูู ุงููุณุชุฎุฏู ุจูุงุณุทุฉ ูุนุฑูู ุงูุฑููู. <br><br>  NSS ูุฏูู ุจููุฉ ูุญุฏุงุช ูุชุญููู ูุญุฏุงุช ุจุดูู ุญููู.  ูู ุงููุงูุน ุ ููุฐุง ุ ูุชุทูุจ glibc ุฃูุถูุง ุขููุงุช ูุชุญููู ุงูููุชุจุงุช ุฏููุงูููููุง.  ูุฐุง ูู ุงูุณุจุจ ุนูุฏ ูุญุงููุฉ ุงุณุชุฎุฏุงู getaddrinfo () ูู ุชุทุจูู ุชู ุชุฌููุนู ุจุดูู ุซุงุจุช ุ ูุทุจุน ุฑุงุจุท ุชุญุฐูุฑ "ุบูุฑ ููููู": <br><pre style=";text-align:right;direction:rtl">
 /tmp/build/socket.o: ูู ุงููุธููุฉ `Socket :: bind ':
 socket.o :(. text + 0x374): ุชุญุฐูุฑ: ุงุณุชุฎุฏุงู "getaddrinfo" ูู ุงูุงุฑุชุจุงุท ุงูุซุงุจุช
 ุชุชุทูุจ ุงูุชุทุจููุงุช ูู ููุช ุงูุชุดุบูู ุงูููุชุจุงุช ุงููุดุชุฑูุฉ ูู ุฅุตุฏุงุฑ glibc
 ุชุณุชุฎุฏู ููุฑุจุท
</pre><br></blockquote><p style=";text-align:right;direction:rtl">  ุจุงููุณุจุฉ ุฅูู ุณูุงุณู ุงูุฑุณุงุฆู ุ ุนุงุฏุฉ ูุง ูุง ูููู ูุคุดุฑ ุงูุชุฑุงุจุท ุฑูุฒูุง ููุฏุณูุง ููุงุจููุง ููุชูููุฐ ุ ูููู ุฃูุถูุง ุงูุจูุงูุงุช ุงูุนุงูููุฉ ุงููุฎุฒูุฉ ูู <em>ุงูุชุฎุฒูู ุงููุญูู ููุคุดุฑ ุงูุชุฑุงุจุท</em> (TLS).  ูุชุทูุจ ุงูุชููุฆุฉ ุงูุตุญูุญุฉ ููุคุดุฑ ุชุฑุงุจุท ุฌุฏูุฏ ุงูุชุดุบูู ุงูููุณู ููุธุงู ุงูุชุดุบูู kernel ููุญูู ุงูููุฏ ุงูุซูุงุฆู ูููุช ุชุดุบูู ูุบุฉ ุงูุจุฑูุฌุฉ.  ูุฐูู ุ ูุฅู ุงุณุชุฏุนุงุก ุจุณูุท ููุงุณุชูุณุงุฎ () ูููู ูุฅูุดุงุก ุฏูู ููููู ุงููุชุงุจุฉ ุฅูู ููู "Hello world!" ุ ููู ูุฐุง ูุฏ ูุง ูุนูู ูุน ุฑูุฒ ุฃูุซุฑ ุชุนููุฏูุง ูุญุชุงุฌ ุฅูู ุงููุตูู ุฅูู TLS ูุฃุดูุงุก ุฃุฎุฑู ูุซูุฑุฉ ููุงูุชูุงู ูุฎููุฉ ุนู ุฃุนูู ูุจุฑูุฌ ุงูุชุทุจูู. </p><br><p style=";text-align:right;direction:rtl">  ููุงู ููุทุฉ ุฃุฎุฑู ูุฑุชุจุทุฉ ุจุชุนุฏุฏ ุงูุนูููุงุช ููู ุงูุนูููุงุช ุฐุงุช ุงูุนูููุงุช ุงููุฑุฏูุฉ.  ูุงุฐุง ูุญุฏุซ ุฅุฐุง ูููุง ุจุฅูุดุงุก ุณูุณูุฉ ุฑุณุงุฆู ุฌุฏูุฏุฉ ูู ุนูููุฉ ูู ูุชู ุชุตูุฑูุง ุนูู ุฃููุง ุฐุงุช ูุคุดุฑุงุช ุชุฑุงุจุท ูุชุนุฏุฏุฉุ  ุตุญูุญ ุ ุณููู ุบุงูุถ.  ูู ุงููุงูุน ุ ูู ูุฐู ุงูุนูููุฉ ูุง ููุฌุฏ ุชุฒุงูู ููุนูู ุจูู ูุคุดุฑุงุช ุงูุชุฑุงุจุท ุ ูุงูุชู ุณูู ุชุคุฏู ุนุงุฌูุงู ุฃู ุขุฌูุงู ุฅูู ุชูู ุงูุจูุงูุงุช.  ุฅุฐุง ุทูุจูุง ุฃู ูุณุชุฎุฏู ุงูุชุทุจูู libpthread ุ ููููููุง ุงูุชุฃูุฏ ูู ุฃูู ุฌุงูุฒ ููุนูู ูู ุจูุฆุฉ ูุชุนุฏุฏุฉ ุงูุฎููุท (ุนูู ุงูุฃูู ูุฌุจ ุฃู ูููู ุฌุงูุฒูุง). </p><br><h2 id="shag-1-podklyuchenie-k-processu" style=";text-align:right;direction:rtl">  ุงูุฎุทูุฉ 1. ุงุชุตุงู ููุฐู ุงูุนูููุฉ </h2><br><p style=";text-align:right;direction:rtl">  ุฃููุงู ุ ูุญุชุงุฌ ุฅูู ุงูุงุชุตุงู ุจุงูุนูููุฉ ุงููุณุชูุฏูุฉ ูุชุตุญูุญ ุงูุฃุฎุทุงุก ุ ุซู ูููุง ุจุนุฏ ูุทุน ุงูุงุชุตุงู ุจู.  ูุฐุง ูู ุงูููุงู ุงูุฐู ูุฃุชู ููู ุงุณุชุฏุนุงุก ูุธุงู <em>ptrace</em> (). </p><br><h3 id="pervyy-kontakt-s-ptrace" style=";text-align:right;direction:rtl">  ุฃูู ุงุชุตุงู ูุน ptrace () </h3><br><p style=";text-align:right;direction:rtl">  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=" rel="nofollow">ูู ูุซุงุฆู ptrace ()</a> ููููู ุฃู ุชุฌุฏ ูู ุงููุนูููุงุช ุงูุถุฑูุฑูุฉ ุชูุฑูุจูุง: </p><br><pre style=";text-align:right;direction:rtl">   ุฑุจุท ููุตู
        ูููู ุฑุจุท ุงูุฎูุท ุจุงูุชุชุจุน ุจุงุณุชุฎุฏุงู ุงูููุงููุฉ<font></font>
<font></font>
            ptrace (PTRACE_ATTACHุ pidุ 0ุ 0)ุ<font></font>
<font></font>
        ุฃู<font></font>
<font></font>
            ptrace (PTRACE_SEIZEุ pidุ 0ุ PTRACE_O_flags)ุ<font></font>
<font></font>
        ูุฑุณู PTRACE_ATTACH SIGSTOP ุฅูู ูุฐุง ุงูููุถูุน.  ุฅุฐุง ูุงู ุงูุชุชุจุน ูุฑูุฏ ูุฐุง
        SIGSTOP ููููู ููุง ุฃู ุชุฃุซูุฑ ุ ูุฅูู ูุญุชุงุฌ ุฅูู ููุนูุง.  ูุงุญุธ ุฃูู ุฅุฐุง
        ูุชู ุฅุฑุณุงู ุฅุดุงุฑุงุช ุฃุฎุฑู ุจุดูู ูุชุฒุงูู ุฅูู ูุฐุง ุงูููุถูุน ุฃุซูุงุก ุฅุฑูุงู ุ ู
        ูุฏ ูุฑู ุงูุชุชุจุน ุงูุชุชุจุน ูุฏุฎู ุฅุดุงุฑุฉ ุชููู ุงูุชุณููู ูุน sigโ ุงูุฃุฎุฑู
        nal (s) ุฃููุงู!  ุงูููุงุฑุณุฉ ุงููุนุชุงุฏุฉ ูู ุฅุนุงุฏุฉ ูุฐู ุงูุฅุดุงุฑุงุช ุญุชู
        ูุชู ุฑุคูุฉ SIGSTOP ุ ุซู ููุน ุญูู SIGSTOP.  ุนูุฉ ุงูุชุตููู
        ููุง ูู ุฃู ptrace ูุนูู ู SIGSTOP ุชุณููููุง ูู ููุช ูุงุญุฏ ูุฏ
        ุณุจุงู ู SIGSTOP ุงููุชุฒุงููุฉ ูุฏ ุชุถูุน.
</pre><br><p style=";text-align:right;direction:rtl">  ูุจุงูุชุงูู ูุฅู ุงูุฎุทูุฉ ุงูุฃููู ูู ุงุณุชุฎุฏุงู PTRACE_ATTACH: </p><br><pre style=";text-align:right;direction:rtl"> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ptrace_attach</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">pid_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> pid)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">/*     */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ptrace(PTRACE_ATTACH, pid, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>) &lt; <span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">-1</span></span>; <span class="hljs-comment"><span class="hljs-comment">/*    */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (wait_for_process_stop(pid, SIGSTOP) &lt; <span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">-1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>; }</code> </pre> <br><p style=";text-align:right;direction:rtl">  ุจุนุฏ ptrace () ุ ุงูุนูููุฉ ุงููุณุชูุฏูุฉ ููุณุช ุฌุงูุฒุฉ ุชูุงููุง ููุชุตุญูุญ.  ููุฏ ูููุง ุจุงูุงุชุตุงู ุจู ุ ูููู ูุฏุฑุงุณุฉ ุชูุงุนููุฉ ูุญุงูุฉ ุงูุนูููุฉ ุ ูุฌุจ ุฅููุงููุง.  ูุฑุณู ptrace () ุฅุดุงุฑุฉ SIGSTOP ุฅูู ุงูุนูููุฉ ุ ููู ูุง ูุฒุงู ุจุญุงุฌุฉ ุฅูู ุงูุงูุชุธุงุฑ ุญุชู ุชุชููู ุงูุนูููุฉ ูุนูููุง. </p><br><p style=";text-align:right;direction:rtl">  ููุงูุชุธุงุฑ ุ ุงุณุชุฎุฏู ุงุณุชุฏุนุงุก ุงููุธุงู <em>waitpid</em> ().  ูู ุงูููุช ููุณู ุ ุงูุนุฏูุฏ ูู ุงูุญุงูุงุช ุงูุญุฏูุฏ ูุซูุฑุฉ ููุงูุชูุงู ูุชุฌุฏุฑ ุงูุฅุดุงุฑุฉ.  ุฃููุงู ุ ูุฏ ุชูุชูู ุงูุนูููุฉ ุฃู ุชููุช ุจุจุณุงุทุฉ ุฏูู ุชููู SIGSTOP.  ูู ูุฐู ุงูุญุงูุฉ ุ ูุง ูููููุง ูุนู ุดูุก.  ุซุงููุงู ุ ูุฏ ูุชู ุฅุฑุณุงู ุจุนุถ ุงูุฅุดุงุฑุงุช ุงูุฃุฎุฑู ูุณุจููุง ุฅูู ุงูุนูููุฉ.  ูู ูุฐู ุงูุญุงูุฉ ุ ูุฌุจ ุฃู ูุฏุน ุงูุนูููุฉ ุชุนุงูุฌูุง (ุจุงุณุชุฎุฏุงู PTRACE_CONT) ุ ูุฃููุณูุง ุ ููุงุตู ุงูุงูุชุธุงุฑ ุฃูุซุฑ ูู ุฃุฌู SIGSTOP: </p><br><pre style=";text-align:right;direction:rtl"> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">wait_for_process_stop</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">pid_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> pid, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> expected_signal)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (;;) { <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> status = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-comment"><span class="hljs-comment">/* ,    -  */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (waitpid(pid, &amp;status, <span class="hljs-number"><span class="hljs-number">0</span></span>) &lt; <span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">-1</span></span>; <span class="hljs-comment"><span class="hljs-comment">/*      โ   */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (WIFSIGNALED(status) || WIFEXITED(status)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">-1</span></span>; <span class="hljs-comment"><span class="hljs-comment">/*   ,     */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (WIFSTOPPED(status)) { <span class="hljs-comment"><span class="hljs-comment">/* *  WSTOPSIG()   , *   ptrace()   *     . */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> stop_signal = status &gt;&gt; <span class="hljs-number"><span class="hljs-number">8</span></span>; <span class="hljs-comment"><span class="hljs-comment">/*    ,    */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (stop_signal == expected_signal) <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-comment"><span class="hljs-comment">/*        */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ptrace(PTRACE_CONT, pid, <span class="hljs-number"><span class="hljs-number">0</span></span>, stop_signal) &lt; <span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">-1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">continue</span></span>; } <span class="hljs-comment"><span class="hljs-comment">/*   โ   */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">-1</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>; }</code> </pre> <br><h3 id="otklyuchenie-ot-processa" style=";text-align:right;direction:rtl">  ุงููุทุงุน ุงูุนูููุฉ </h3><br><p style=";text-align:right;direction:rtl">  ุฅููุงู ุนูููุฉ ุงูุชุตุญูุญ ุฃุจุณุท ุจูุซูุฑ: ูุง ุนููู ุณูู ุงุณุชุฎุฏุงู PTRACE_DETACH: </p><br><pre style=";text-align:right;direction:rtl"> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ptrace_detach</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">pid_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> pid)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ptrace(PTRACE_DETACH, pid, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>) &lt; <span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">-1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>; }</code> </pre> <br><p style=";text-align:right;direction:rtl">  ุจุงููุนูู ุงูุฏููู ูููููุฉ ุ ููุณ ูู ุงูุถุฑูุฑู ุฏุงุฆููุง ุชุนุทูู ุงููุตุญุญ ุจุดูู ุตุฑูุญ.  ุนูุฏูุง ุชูุชูู ุนูููุฉ ูุตุญุญ ุงูุฃุฎุทุงุก ุ ูุชู ูุทุน ุงูุงุชุตุงู ุชููุงุฆููุง ูู ุฌููุน ุนูููุงุช ุชุตุญูุญ ุงูุฃุฎุทุงุก ุ ูุชุณุชุฃูู ุงูุนูููุงุช ุฅุฐุง ุชู ุฅููุงููุง ุจูุงุณุทุฉ ptrace ().  ููุน ุฐูู ุ ุฅุฐุง ุชู ุฅููุงู ุนูููุฉ ุชุตุญูุญ ุงูุฃุฎุทุงุก ุจุดูู ุตุฑูุญ ุจูุงุณุทุฉ ูุตุญุญ ุงูุฃุฎุทุงุก ุจุงุณุชุฎุฏุงู ุฅุดุงุฑุฉ SIGSTOP ุฏูู ุงุณุชุฎุฏุงู ptrace () ุ ููู ุชุณุชููุธ ุจุฏูู ุฅุดุงุฑุฉ SIGCONT ุฃู PTRACE_DETACH ุงูููุงุจูุฉ.  ูุฐูู ุ ูู ุงูุฃูุถู ุงูุงููุตุงู ุนู ุงูุนูููุงุช ุงูุซูุงููุฉ. </p><br><h3 id="nastroyka-ptrace_scope" style=";text-align:right;direction:rtl">  ุฅุนุฏุงุฏ Ptrace_scope </h3><br><p style=";text-align:right;direction:rtl">  ูุฏู ูุตุญุญ ุงูุฃุฎุทุงุก ุงูุชุญูู ุงููุงูู ูู ุงูุนูููุฉ ุงูุชู ูุชู ุชุตุญูุญูุง.  ุฅุฐุง ูุงู ุจุฅููุงู ุฃู ุดุฎุต ุชุตุญูุญ ุฃู ุดูุก ุ ููุงุฐุง ุณูููู ุงูุงูุชุฏุงุฏ ููุฑูุฒ ุงูุถุงุฑ!  ูู ุงููุงุถุญ ุฃู ุงูุชุตุญูุญ ุงูุชูุงุนูู ูุดุงุท ูุญุฏุฏ ุฅูู ุญุฏ ูุง ุ ูุนุงุฏุฉ ูุง ูููู ุถุฑูุฑููุง ูููุทูุฑูู ููุท.  ุฃุซูุงุก ุงูุชุดุบูู ุงูุนุงุฏู ูููุธุงู ุ ูู ุฃุบูุจ ุงูุฃุญูุงู ูุง ุชูุฌุฏ ุญุงุฌุฉ ูุชุตุญูุญ ุงูุนูููุงุช. </p><br><p style=";text-align:right;direction:rtl">  ููุฐู ุงูุฃุณุจุงุจ ุ ููุฃุณุจุงุจ ุฃูููุฉ ุ ุชุนุทู ุงูุฃูุธูุฉ ุนุงุฏุฉู ุงููุฏุฑุฉ ุนูู ุชุตุญูุญ ุฃู ุนูููุงุช ุจุดูู ุงูุชุฑุงุถู.  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=" rel="nofollow">ูุญุฏุฉ ุฃูุงู <strong>Yama</strong></a> ูุณุคููุฉ ุนู ุฐูู ุ ุชุชู ุฅุฏุงุฑุชูุง ุนุจุฑ ุงูููู / proc / sys / kernel / yama / ptrace_scope.  ูููุฑ ุฃุฑุจุนุฉ ุณููููุงุช: </p><br><ul style=";text-align:right;direction:rtl"><li style=";text-align:right;direction:rtl">  0 - ูููู ูููุณุชุฎุฏู ุชุตุญูุญ ุฃู ุนูููุงุช ุจุฏุฃูุง </li><li style=";text-align:right;direction:rtl">  1 - ุงููุถุน ุงูุงูุชุฑุงุถู ุ ููุท ุงูุนูููุงุช ุงูุชู ุจุฏุฃูุง ูุตุญุญ ุงูุฃุฎุทุงุก ูููู ุชุตุญูุญูุง </li><li style=";text-align:right;direction:rtl">  2 - ูุณุคูู ุงููุธุงู ุงูุฌุฐุฑ ููุท ููููู ุชุตุญูุญ ุงูุนูููุงุช </li><li style=";text-align:right;direction:rtl">  3 - ูุญุธุฑ ุชุตุญูุญ ุงูุฃุฎุทุงุก ููุฌููุน ุนูู ุงูุฅุทูุงู ุ ูุง ูุชู ุฅููุงู ุชุดุบูู ุงููุถุน ุญุชู ูุชู ุฅุนุงุฏุฉ ุชูููุฏ ุงููุธุงู </li></ul><br><p style=";text-align:right;direction:rtl">  ูู ุงููุงุถุญ ุ ูุฃุบุฑุงุถูุง ุ ุณูููู ูู ุงูุถุฑูุฑู ุฃู ุชููู ูุงุฏุฑูุง ุนูู ุชุตุญูุญ ุงูุนูููุงุช ุงูุชู ุชู ุชุดุบูููุง ูุจู ูุตุญุญ ุงูุฃุฎุทุงุก ุงูุฎุงุต ุจูุง ุ ูุฐูู ูู ุงูุชุฌุงุฑุจ ุณุชุญุชุงุฌ ุฅูุง ุฅูู ุชุจุฏูู ุงููุธุงู ุฅูู ูุถุน ุงูุชุทููุฑ ุนู ุทุฑูู ูุชุงุจุฉ 0 ุฅูู ููู ptrace_scope ุฎุงุต (ูุชุทูุจ ุญููู ุงููุณุคูู): </p><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">$ sudo sh -c 'echo 0 &gt; /proc/sys/kernel/yama/ptrace_scope'</code> </pre> <br><p style=";text-align:right;direction:rtl">  ุฃู ูู ุจุชุดุบูู ูุตุญุญ ุงูุฃุฎุทุงุก ููุณุคูู: </p><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">$ sudo ./inject-thread ...</code> </pre> <br><h3 id="rezultaty-pervogo-shaga" style=";text-align:right;direction:rtl">  ูุชุงุฆุฌ ุงูุฎุทูุฉ ุงูุฃููู </h3><br><p style=";text-align:right;direction:rtl">  ูุชูุฌุฉ ูุฐูู ุ ูู ุงูุฎุทูุฉ ุงูุฃููู ุ ุฃุตุจุญูุง ูุงุฏุฑูู ุนูู ุงูุงุชุตุงู ุจุงูุนูููุฉ ุงููุณุชูุฏูุฉ ููุตุญุญ ุฃุฎุทุงุก ุซู ูุทุน ุงูุงุชุตุงู ุจูุง ูุงุญููุง. </p><br><p style=";text-align:right;direction:rtl">  ุณูุชู ุฅููุงู ุงูุนูููุฉ ุงููุณุชูุฏูุฉ ููููููุง ุงูุชุฃูุฏ ูู ุฃู ูุธุงู ุงูุชุดุบูู ููุธุฑ ุฅูููุง ุจุงููุนู ุนูู ุฃูู ูุตุญุญ ุฃุฎุทุงุก: </p><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">$ sudo ./inject-thread --target $(pgrep docker) $ cat /proc/$(pgrep docker)/status | head Name: docker State: t (tracing stop) &lt;---    Tgid: 31330 Ngid: 0 Pid: 31330 PPid: 1 TracerPid: 2789 &lt;--- PID   Uid: 0 0 0 0 Gid: 0 0 0 0 FDSize: 64 $ ps a | grep [2]789 2789 pts/5 S+ 0:00 ./inject-thread --target 31330</code> </pre> <br><h2 id="shag-2-poisk-bibliotek-v-pamyati" style=";text-align:right;direction:rtl">  ุงูุฎุทูุฉ 2. ุงูุจุญุซ ูู ุงูููุชุจุงุช ูู ุงูุฐุงูุฑุฉ </h2><br><p style=";text-align:right;direction:rtl">  ุงูุฎุทูุฉ ุงูุชุงููุฉ ุฃุจุณุท: ุนููู ุฃู ุชุฌุฏ ูู ุฐุงูุฑุฉ ุงูุนูููุฉ ุงููุณุชูุฏูุฉ ุงูููุชุจุฉ ุจุงููุธุงุฆู ุงูุชู ูุญุชุงุฌูุง.  ูููู ููุงู ุงููุซูุฑ ูู ุงูุฐุงูุฑุฉ ุ ูู ุฃูู ูุจุฏุฃ ุจุงูุจุญุซ ุนู ูุงุฐุง ุจุงูุถุจุทุ </p><br><h3 id="fayl-procpidmaps" style=";text-align:right;direction:rtl">  ููู / proc / $ pid / maps </h3><br><p style=";text-align:right;direction:rtl">  ุณูู ูุณุงุนุฏูุง ููู ุฎุงุต ูู ูุฐุง ุงูุฃูุฑ ุ ูุงูุฐู ูู ุฎูุงูู ููุฎุจุฑ ุงูููุงุฉ ุนู ููุงู ูููุงู ุงูุนูููุฉ ูู ุงูุฐุงูุฑุฉ.  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=" rel="nofollow">ููุง ุชุนูู</a> ุ ููุฌุฏ ูู ุงูุฏููู / proc ููู ุนูููุฉ ุฏููู ูุฑุนู.  ูููุงู ููู ููู ูุตู <em>ุจุทุงูุฉ ุฐุงูุฑุฉ</em> ุงูุนูููุฉ: </p><br><pre style=";text-align:right;direction:rtl"> $ ุงููุท / ุจุฑูู / ุงูุฐุงุช / ุฎุฑุงุฆุท
 00400000-0040c000 r-xp 00000000 fe: 01 1044592 / bin / cat
 0060b000-0060c000 r - p 0000b000 fe: 01 1044592 / bin / cat
 0060c000-0060d000 rw-p 0000c000 fe: 01 1044592 / bin / cat
 013d5000-013f6000 rw-p 00000000 00:00 0 [ูููุฉ ุงูุฐุงูุฑุฉ ุงููุคูุชุฉ]
 7f9920bd1000-7f9920d72000 r-xp 00000000 fe: 01 920019 / lib/x86_64-linux-gnu/libc-2.19.so
 7f9920d72000-7f9920f72000 --- p 001a1000 fe: 01 920019 / lib/x86_64-linux-gnu/libc-2.19.so
 7f9920f72000-7f9920f76000 r - p 001a1000 fe: 01 920019 / lib/x86_64-linux-gnu/libc-2.19.so
 7f9920f76000-7f9920f78000 rw-p 001a5000 fe: 01 920019 / lib/x86_64-linux-gnu/libc-2.19.so
 7fc3f8381000-7fc3f8385000 rw-p 00000000 00:00 0
 7fc3f8385000-7fc3f83a6000 r-xp 00000000 fe: 01 920012 /lib/x86_64-linux-gnu/ld-2.19.so
 7fc3f83ec000-7fc3f840e000 rw-p 00000000 00:00 0
 7fc3f840e000-7fc3f8597000 r - ุต 00000000 fe: 01 657286 / usr / lib / locale / locale-archive
 7fc3f8597000-7fc3f859a000 rw-p 00000000 00:00 0
 7fc3f85a3000-7fc3f85a5000 rw-p 00000000 00:00 0
 7fc3f85a5000-7fc3f85a6000 r - p 00020000 fe: 01 920012 /lib/x86_64-linux-gnu/ld-2.19.so
 7fc3f85a6000-7fc3f85a7000 rw-p 00021000 fe: 01 920012 /lib/x86_64-linux-gnu/ld-2.19.so
 7fc3f85a7000-7fc3f85a8000 rw-p 00000000 00:00 0
 7ffdb6f0e000-7ffdb6f2f000 rw-p 00000000 00:00 0 [ููุฏุณ]
 7ffdb6f7f000-7ffdb6f81000 r-xp 00000000 00:00 0 [vdso]
 7ffdb6f81000-7ffdb6f83000 r - p 00000000 00:00 0 [vvar]
 ffffffffff600000-ffffffffff601000 r-xp 00000000 00:00 0 [vsyscall]
</pre><br><p style=";text-align:right;direction:rtl">  ูุชู ุฅูุดุงุก ูุญุชููุงุช ูุฐุง ุงูููู ุฃุซูุงุก ุงูุชููู ุจูุงุณุทุฉ kernel ููุธุงู ุงูุชุดุบูู ูู ุงูููุงูู ุงูุฏุงุฎููุฉ ุงูุชู ุชุตู ููุงุทู ุงูุฐุงูุฑุฉ ุงูุฎุงุตุฉ ุจุงูุนูููุฉ ุงูุชู ุชูููุง ุ ูุชุญุชูู ุนูู ุงููุนูููุงุช ุงูุชุงููุฉ: </p><br><ul style=";text-align:right;direction:rtl"><li style=";text-align:right;direction:rtl">  ูุทุงู ุงูุนููุงู ุงููุฎุตุต ููููุทูุฉ </li><li style=";text-align:right;direction:rtl">  ุญููู ุงููุตูู ุฅูู ุงูููุทูุฉ <br><ul style=";text-align:right;direction:rtl"><li style=";text-align:right;direction:rtl">  <code>r/-</code> : ูุฑุงุกุฉ </li><li style=";text-align:right;direction:rtl">  <code>w/-</code> : ุงููุชุงุจุฉ </li><li style=";text-align:right;direction:rtl">  <code>x/-</code> : ุงูุชูููุฐ </li><li style=";text-align:right;direction:rtl">  <code>p/s</code> : ูุดุงุฑูุฉ ุงูุฐุงูุฑุฉ ูุน ุงูุนูููุงุช ุงูุฃุฎุฑู </li></ul></li><li style=";text-align:right;direction:rtl">  ุฅุฒุงุญุฉ ุงูููู (ุฅู ูุฌุฏ) </li><li style=";text-align:right;direction:rtl">  ุฑูุฒ ุงูุฌูุงุฒ ุญูุซ ููุฌุฏ ุงูููู ุงููุนุฑูุถ </li><li style=";text-align:right;direction:rtl">  ุฑูู ุงูููู inode (ุฅู ูุฌุฏ) </li><li style=";text-align:right;direction:rtl">  ุงููุณุงุฑ ุฅูู ุงูููู ุงููุนุฑูุถ (ุฅู ูุฌุฏ) </li></ul><br><p style=";text-align:right;direction:rtl">  ูุชู ุชุนููู ุจุนุถ ููุงุทู ุงูุฐุงูุฑุฉ ุนูู ุงููููุงุช: ุนูุฏูุง ุชููู ุฅุญุฏู ุงูุนูููุงุช ุจูุฑุงุกุฉ ูุฐู ุงูุฐุงูุฑุฉ ุ ูุฅููุง ุชููู ุจุงููุนู ุจูุฑุงุกุฉ ุงูุจูุงูุงุช ูู ุงููููุงุช ุงูููุงุจูุฉ ุนูุฏ ุฅุฒุงุญุฉ ูุญุฏุฏุฉ.  ุฅุฐุง ุงุณุชุทุนุช ุงููุชุงุจุฉ ุฅูู ููุทูุฉ ูุง ุ ูุฅู ุงูุชุบููุฑุงุช ูู ุงูุฐุงูุฑุฉ ูููู ุฃู ุชููู ูุฑุฆูุฉ ููุท ููุนูููุฉ ููุณูุง (ุขููุฉ <em>ุงููุณุฎ ุนูุฏ ุงููุชุงุจุฉ</em> ุฃู ูุถุน <code>p</code> ุฎุงุต) ุฃู ูุชุฒุงููุฉ ูุน ุงููุฑุต (ูุชู ูุดุงุฑูุฉ ูุถุน ( <code>s</code> )). </p><br><p style=";text-align:right;direction:rtl">  ุงูููุงุทู ุงูุฃุฎุฑู <em>ูุฌูููุฉ</em> - ูุฐู ุงูุฐุงูุฑุฉ ูุง ุชุชูุงูู ูุน ุฃู ููู.  ูุนุทู ูุธุงู ุงูุชุดุบูู ุจุจุณุงุทุฉ ุงูุนูููุฉ ูุทุนุฉ ูู ุงูุฐุงูุฑุฉ ุงููุนููุฉ ุงูุชู ูุณุชุฎุฏููุง.  ูุชู ุงุณุชุฎุฏุงู ูุซู ูุฐู ุงูููุงุทู ุ ุนูู ุณุจูู ุงููุซุงู ุ ูุฐุงูุฑุฉ ุงูุนูููุฉ "ุงูุทุจูุนูุฉ": ุงูููุฏุณ ู ุงููููุฉ.  ูููู ุฃู ุชููู ุงูููุงุทู ุงููุฌูููุฉ ุดุฎุตูุฉ ุฅูุง ูุนูููุฉ ุฃู ูููู ูุดุงุฑูุชูุง ุจูู ุนุฏุฉ ุนูููุงุช (ุขููุฉ <em>ุงูุฐุงูุฑุฉ ุงููุดุชุฑูุฉ</em> ). </p><br><p style=";text-align:right;direction:rtl">  ุจุงูุฅุถุงูุฉ ุฅูู ุฐูู ุ ููุงู ุงูุนุฏูุฏ ูู ุงูููุงุทู ุงูุฎุงุตุฉ ูู ุงูุฐุงูุฑุฉ ุงููููุฒุฉ ุจุงูุฃุณูุงุก ุงูุฒุงุฆูุฉ [vdso] ู [vsyscall].  ูุชู ุงุณุชุฎุฏุงููุง ูุชุญุณูู ุจุนุถ ููุงููุงุช ุงููุธุงู. </p><br><p style=";text-align:right;direction:rtl">  ูุญู ููุชููู ุจุงูููุงุทู ุงูุชู ูุชู ูููุง ุนุฑุถ ูุญุชููุงุช ูููุงุช ุงูููุชุจุฉ.  ุฅุฐุง ูุฑุฃูุง ุจุทุงูุฉ ุงูุฐุงูุฑุฉ ููููุง ุจุชุตููุฉ ุงูุฅุฏุฎุงูุงุช ุงูููุฌูุฏุฉ ุจูุง ุจุงุณู ุงูููู ุงููุนุฑูุถ ุ ูุณูุฌุฏ ุฌููุน ุงูุนูุงููู ุงูุชู ุชุดุบููุง ุงูููุชุจุงุช ุงูุชู ูุญุชุงุฌ ุฅูููุง.  ุชู ุชุตููู ุชูุณูู ุจุทุงูุฉ ุงูุฐุงูุฑุฉ ุฎุตูุตูุง ููุนุงูุฌุฉ ุงูุจุฑูุงูุฌ ููููู ูููู ุจุณูููุฉ ุจุงุณุชุฎุฏุงู ูุธุงุฆู ุนุงุฆูุฉ scanf (): </p><br><pre style=";text-align:right;direction:rtl"> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">read_proc_line</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *line, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *library, struct memory_region *region)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> vaddr_low = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> vaddr_high = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> read = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> write = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> execute = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> path_offset = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-comment"><span class="hljs-comment">/*    /proc/$pid/maps */</span></span> <span class="hljs-built_in"><span class="hljs-built_in">sscanf</span></span>(line, <span class="hljs-string"><span class="hljs-string">"%lx-%lx %c%c%c%*c %*lx %*x:%*x %*d %n"</span></span>, &amp;vaddr_low, &amp;vaddr_high, &amp;read, &amp;write, &amp;execute, &amp;path_offset); <span class="hljs-comment"><span class="hljs-comment">/* ,       */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!<span class="hljs-built_in"><span class="hljs-built_in">strstr</span></span>(line + path_offset, library)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; <span class="hljs-comment"><span class="hljs-comment">/*           */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (region) { region-&gt;vaddr_low = vaddr_low; region-&gt;vaddr_high = vaddr_high; region-&gt;readable = (read == <span class="hljs-string"><span class="hljs-string">'r'</span></span>); region-&gt;writeable = (write == <span class="hljs-string"><span class="hljs-string">'w'</span></span>); region-&gt;executable = (execute == <span class="hljs-string"><span class="hljs-string">'x'</span></span>); region-&gt;content = <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>; }</code> </pre> <br><h3 id="tayna-tretey-planety" style=";text-align:right;direction:rtl">    </h3><br><p style=";text-align:right;direction:rtl">      ,  libc-2.19.so,     : </p><br><p style=";text-align:right;direction:rtl"><img src="https://habrastorage.org/webt/vf/lw/4m/vflw4m5jy3pwtbcxu0foudxnh3o.png" alt="  libc-2.19.so"></p><br><p style=";text-align:right;direction:rtl">        2   -    ?  51?   ?  ? </p><br><p style=";text-align:right;direction:rtl"> ,    ,          . </p><br><p style=";text-align:right;direction:rtl">  ,     <em></em>   ,         .  <em> </em>         ,    ,   ,           (, ,        ). </p><br><p style=";text-align:right;direction:rtl">      ,  <em></em> (  4  ).    ,            . </p><br><p style=";text-align:right;direction:rtl">  ,           .       โ    โ      .           2    โ   ,        ( x86_64    4 , 2 , 1 ).                  . </p><br><h3 id="rezultaty-vtorogo-shaga" style=";text-align:right;direction:rtl">    </h3><br><p style=";text-align:right;direction:rtl">     ,          : </p><br><ul style=";text-align:right;direction:rtl"><li style=";text-align:right;direction:rtl">  libdl: dlopen()  dlsym() </li><li style=";text-align:right;direction:rtl">  libpthread: pthread_create()  pthread_detach() </li></ul><br><p style=";text-align:right;direction:rtl">    ,       ,   .      Linux       ( <em>address space layout randomization</em> , ASLR).        (- ,     ),             โ    - . </p><br><p style=";text-align:right;direction:rtl">       ,           ,      ,     /proc/$pid/maps.     ,          . </p><br><h2 id="shag-3-razbor-elf-obrazov-bibliotek" style=";text-align:right;direction:rtl">  3.  ELF-  </h2><br><p style=";text-align:right;direction:rtl"> ,      ,        ,   . </p><br><p style=";text-align:right;direction:rtl">   : </p><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">$ nm -D /lib/x86_64-linux-gnu/libdl-2.19.so | grep dlopen 0000000000001090 T dlopen</code> </pre> <br><p style=";text-align:right;direction:rtl">  <em>nm</em>             .                . </p><br><p style=";text-align:right;direction:rtl">   -  ,      nm     ,        .  ,      dlsym(). </p><br><h3 id="chtenie-pamyati-celevogo-processa" style=";text-align:right;direction:rtl">     </h3><br><p style=";text-align:right;direction:rtl">   โ    ELF-,    .        procfs.    UNIX way,         <strong>/proc/$pid/mem</strong> ,    โ      (     /proc/$pid/maps). </p><br><p style=";text-align:right;direction:rtl">   Linux           mmap(),         (    ,   ).            : </p><br><pre style=";text-align:right;direction:rtl"> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">map_region</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">pid_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> pid, struct memory_region *region)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">size_t</span></span> length = region-&gt;vaddr_high - region-&gt;vaddr_low; <span class="hljs-keyword"><span class="hljs-keyword">off_t</span></span> offset = region-&gt;vaddr_low; <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> path[<span class="hljs-number"><span class="hljs-number">32</span></span>] = {<span class="hljs-number"><span class="hljs-number">0</span></span>}; <span class="hljs-built_in"><span class="hljs-built_in">snprintf</span></span>(path, <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(path), <span class="hljs-string"><span class="hljs-string">"/proc/%d/mem"</span></span>, pid); <span class="hljs-comment"><span class="hljs-comment">/*     */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> fd = open(path, O_RDONLY); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (fd &lt; <span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">goto</span></span> error; <span class="hljs-comment"><span class="hljs-comment">/*      */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> *buffer = <span class="hljs-built_in"><span class="hljs-built_in">malloc</span></span>(length); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!buffer) <span class="hljs-keyword"><span class="hljs-keyword">goto</span></span> error_close_file; <span class="hljs-comment"><span class="hljs-comment">/*   */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (read_region(fd, offset, buffer, length) &lt; <span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">goto</span></span> error_free_buffer; region-&gt;content = buffer; close(fd); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>; error_free_buffer: <span class="hljs-built_in"><span class="hljs-built_in">free</span></span>(buffer); error_close_file: close(fd); error: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">-1</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">read_region</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> fd, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">off_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> offset, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *buffer, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">size_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> length)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">/*      */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (lseek(fd, offset, SEEK_SET) &lt; <span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">-1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">size_t</span></span> remaining = length; <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> *ptr = buffer; <span class="hljs-comment"><span class="hljs-comment">/* *     .   , *      ,  . */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (remaining &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">ssize_t</span></span> count = read(fd, ptr, remaining); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (count &lt; <span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">-1</span></span>; remaining -= count; ptr += count; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>; }</code> </pre> <br><p style=";text-align:right;direction:rtl">      ELF- .    , -,       ,  -,       . </p><br><h3 id="dvulikiy-elf" style=";text-align:right;direction:rtl">  ELF </h3><br><p style=";text-align:right;direction:rtl">       <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=" rel="nofollow">   ELF</a> โ         Linux.      ,    ,      . </p><br><p style=";text-align:right;direction:rtl">      ELF   .    ELF    <em></em>    .    โ   <em></em> ,        .      ,  โ    .        ELF-. </p><br><p style=";text-align:right;direction:rtl"> ,   libdl-2.19.so  : </p><br><p style=";text-align:right;direction:rtl"><img src="https://habrastorage.org/webt/at/zw/up/atzwupwipysw3kip1yx95aa-eps.png" alt="   libdl-2.19.so"></p><br><p style=";text-align:right;direction:rtl"> (          <code>readelf --headers</code> .) </p><br><p style=";text-align:right;direction:rtl">   ,    ,   (29  9).    โ    ,           ,     .  ELF โ    ,      .  Linux, ,    LOAD,      (     ). </p><br><p style=";text-align:right;direction:rtl">   ELF-     ,         . ,       . </p><br><p style=";text-align:right;direction:rtl">       ,   . ยซยป    .     .bss,   ,      (    ). </p><br><p style=";text-align:right;direction:rtl">  ,   ELF     โ  ,     .       ... </p><br><h3 id="gde-lezhit-tablica-simvolov" style=";text-align:right;direction:rtl">    ? </h3><br><p style=";text-align:right;direction:rtl">          ()   .        ,     dlsym(),       .  -   . </p><br><p style=";text-align:right;direction:rtl">        <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=" rel="nofollow"> ELF</a> (. 2-10).   ,        <strong>.dynamic</strong> ,     <strong>DYNAMIC</strong> .   .dynamic     ,  : </p><br><ul style=";text-align:right;direction:rtl"><li style=";text-align:right;direction:rtl"> <strong>.dynsym</strong> โ     ; </li><li style=";text-align:right;direction:rtl"> <strong>.dynstr</strong> โ     ; </li><li style=";text-align:right;direction:rtl"> <strong>.hash</strong> โ -,   . </li></ul><br><p style=";text-align:right;direction:rtl">    ,     ,       ELF: </p><br><p style=";text-align:right;direction:rtl"><img src="https://habrastorage.org/webt/yw/y9/7d/ywy97dqzszhxz1jmoe45851oebe.png" alt="  DYNAMIC"></p><br><p style=";text-align:right;direction:rtl">     ELF,      (1),      (2),      (3),      (4) <del>  ,    </del>  . </p><br><h4 id="zagolovok-elf--tablica-segmentov" style=";text-align:right;direction:rtl">  ELF โ   </h4><br><p style=";text-align:right;direction:rtl"> ()   ELF      &lt;elf.h&gt;, ,   ,   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=" rel="nofollow"> </a> .   ,  ELF โ      .    32-  64- ,      ,      ,   .          x86_64,    ELF  . </p><br><p style=";text-align:right;direction:rtl">  ELF-    ( <strong>Elf64_Ehdr</strong> ).          ( <em>program headers</em> ),    <strong>e_phoff</strong>  <strong>e_phnum</strong> : </p><br><p style=";text-align:right;direction:rtl"><img src="https://habrastorage.org/webt/1z/al/rn/1zalrn30vwfxce_smmy4vylj55g.png" alt=" ELF"></p><br><p style=";text-align:right;direction:rtl">   โ    ,   ,  ELF-   โ     ,    ,     ,  ,    . </p><br><p style=";text-align:right;direction:rtl">        e_phoff,       ,      .    e_phnum   e_phentsize  . </p><br><p style=";text-align:right;direction:rtl">    (   ),        ELF โ    64 . </p><br><h4 id="tablica-segmentov--segment-dynamic" style=";text-align:right;direction:rtl">   โ  DYNAMIC </h4><br><p style=";text-align:right;direction:rtl">      .   โ      <strong>Elf64_Phdr</strong> ( 64- ELF-),   .      <strong>PT_DYNAMIC</strong>   <strong>p_type</strong> : </p><br><p style=";text-align:right;direction:rtl"><img src="https://habrastorage.org/webt/i0/rg/cp/i0rgcpji9bl9wbsvegzrree9zfm.png" alt="  ELF"></p><br><p style=";text-align:right;direction:rtl">          : </p><br><ul style=";text-align:right;direction:rtl"><li style=";text-align:right;direction:rtl"> <strong>p_vaddr</strong> โ   ,    ; </li><li style=";text-align:right;direction:rtl"> <strong>p_memsz</strong> โ      . </li></ul><br><p style=";text-align:right;direction:rtl">     .dynamic      0x2D88 (     ).        DYNAMIC     โ   0x202D88.    0x210 (8448) .                . </p><br><h4 id="segment-dynamic--sekcii-dynsym-dynstr-hash" style=";text-align:right;direction:rtl">  DYNAMIC โ  .dynsym, .dynstr, .hash </h4><br><p style=";text-align:right;direction:rtl">  .dynamic,    DYNAMIC,      .       <strong>Elf64_Dyn</strong> ,   : </p><br><p style=";text-align:right;direction:rtl"><img src="https://habrastorage.org/webt/dd/jp/th/ddjpthosvl8irw8ekelw0bdkaug.png" alt="  DYNAMIC"></p><br><p style=";text-align:right;direction:rtl">    8     <strong>d_val</strong>  <strong>d_ptr</strong> ,   8-  <strong>d_tag</strong> ,  ,    .      : </p><br><ul style=";text-align:right;direction:rtl"><li style=";text-align:right;direction:rtl"> <strong>DT_HASH</strong> (4) โ    .hash ( d_ptr) </li><li style=";text-align:right;direction:rtl"> <strong>DT_STRTAB</strong> (5) โ    .dynstr ( d_ptr) </li><li style=";text-align:right;direction:rtl"> <strong>DT_SYMTAB</strong> (6) โ    .dynsym ( d_ptr) </li><li style=";text-align:right;direction:rtl"> <strong>DT_STRSZ</strong> (10) โ     .dynstr ( d_val) </li><li style=";text-align:right;direction:rtl"> <strong>DT_NULL</strong> (0) โ     </li></ul><br><p style=";text-align:right;direction:rtl">       .     .dynamic     :  ,   ,    ,    . </p><br><p style=";text-align:right;direction:rtl">    ,   DYNAMIC   <em></em>          ,    .      ,            ,  - ,   . </p><br><p style=";text-align:right;direction:rtl">    .dynamic         ,          . -,   .dynstr   ,      ?     . </p><br><h3 id="poisk-funkciy-v-biblioteke" style=";text-align:right;direction:rtl">     </h3><br><p style=";text-align:right;direction:rtl">            .     ,    <strong>.dynsym</strong>   ,        . (  ยซยป   .symtab,      , ,  .    .) </p><br><h4 id="tablica-simvolov" style=";text-align:right;direction:rtl">   </h4><br><p style=";text-align:right;direction:rtl">      <strong>Elf64_Sym</strong> ,        ELF โ , , , .       <code>dlopen</code> : </p><br><p style=";text-align:right;direction:rtl"><img src="https://habrastorage.org/webt/pd/5_/qh/pd5_qhcculmqmjk7p6krar1czjy.png" alt="  ELF"></p><br><p style=";text-align:right;direction:rtl">      : </p><br><ul style=";text-align:right;direction:rtl"><li style=";text-align:right;direction:rtl"> <strong>st_name</strong> โ  ,       </li><li style=";text-align:right;direction:rtl"> <strong>st_info</strong> โ     (   ) </li><li style=";text-align:right;direction:rtl"> <strong>st_value</strong> โ     </li></ul><br><p style=";text-align:right;direction:rtl"> (  ,   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">  nm</a>   ,  dlopen()     .text,   0x1090   .) </p><br><p style=";text-align:right;direction:rtl">     ,       . </p><br><h4 id="tablica-strok" style=";text-align:right;direction:rtl">   </h4><br><p style=";text-align:right;direction:rtl">   โ     - ,    .            (   ).        <strong>.dynstr</strong> ,      libdl-2.19.so  : </p><br><p style=";text-align:right;direction:rtl"><img src="https://habrastorage.org/webt/mg/b9/1v/mgb91vjtwrr_kqrncnrojgg6jum.png" alt="  ELF"></p><br><p style=";text-align:right;direction:rtl"> ,           ( ยซdlopenยป,   0xA5)      ,    .        . </p><br><h4 id="hesh-tablica" style=";text-align:right;direction:rtl"> - </h4><br><p style=";text-align:right;direction:rtl">  <strong>.hash</strong>  <em>-</em> ,       .   - โ    โ      ELF-,       . ,         .dynsym,       ,      .   ( )     - . </p><br><p style=";text-align:right;direction:rtl">  -      &lt;elf.h&gt;,    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=" rel="nofollow"> </a> (. 2-19).   -   ,   : </p><br><p style=";text-align:right;direction:rtl"><img src="https://habrastorage.org/webt/ez/a3/ku/eza3ku71zydhqm_e3je0xbtjec8.png" alt="- ELF"></p><br><p style=";text-align:right;direction:rtl">  ุญูุซ </p><br><ul style=";text-align:right;direction:rtl"><li style=";text-align:right;direction:rtl"> nbuckets โ    buckets </li><li style=";text-align:right;direction:rtl"> nchains โ    chains (  ) </li><li style=";text-align:right;direction:rtl"> buckets โ      </li><li style=";text-align:right;direction:rtl"> chains โ      </li></ul><br><p style=";text-align:right;direction:rtl">  -  : </p><br><ol style=";text-align:right;direction:rtl"><li style=";text-align:right;direction:rtl">   <strong>h</strong>    . </li><li style=";text-align:right;direction:rtl">   <strong>i</strong>  <code>buckets[h % nbuckets]</code> ,     . </li><li style=";text-align:right;direction:rtl">      (     )  ,   . </li><li style=";text-align:right;direction:rtl">    โ  <code>chains[i % nchains]</code> . </li><li style=";text-align:right;direction:rtl">   3โ4           ,       . </li></ol><br><p style=";text-align:right;direction:rtl">  -,  ELF: </p><br><pre style=";text-align:right;direction:rtl"> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> uint32_t </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">elf_hash</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *name)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span> h = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span> g; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (*name) { h = (h &lt;&lt; <span class="hljs-number"><span class="hljs-number">4</span></span>) + *name++; g = h &amp; <span class="hljs-number"><span class="hljs-number">0xF0000000</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (g) h ^= g &gt;&gt; <span class="hljs-number"><span class="hljs-number">24</span></span>; h &amp;= ~g; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> h; }</code> </pre> <br><p style=";text-align:right;direction:rtl"> ,   <code>"dlopen"</code> -   112420542     : </p><br><p style=";text-align:right;direction:rtl"><img src="https://habrastorage.org/webt/zu/ch/4i/zuch4ibwuspxmog6_erhbq1evyg.png" alt="   "></p><br><p style=";text-align:right;direction:rtl"> libdl โ    ,    39   ,      .  -           . </p><br><h3 id="rezultaty-tretego-shaga" style=";text-align:right;direction:rtl">    </h3><br><p style=";text-align:right;direction:rtl">              ,          : </p><br><ul style=";text-align:right;direction:rtl"><li style=";text-align:right;direction:rtl"> dlopen()  dlsym()   libdl </li><li style=";text-align:right;direction:rtl"> pthread_create()  pthread_detach()   libpthread </li></ul><br><p style=";text-align:right;direction:rtl">   ,    . </p><br><p style=";text-align:right;direction:rtl">         .            .      ,       . </p><br><p style=";text-align:right;direction:rtl">     ELF-    .       ,      (  ).        ,    . ,    ,     .               . </p><br><h2 id="shag-4-vnedrenie-shell-koda" style=";text-align:right;direction:rtl">  4.  - </h2><br><p style=";text-align:right;direction:rtl">   ,    ,    <em>-</em> ,     :         ,   .   -  . </p><br><h3 id="soderzhimoe-shell-koda" style=";text-align:right;direction:rtl">  - </h3><br><p style=";text-align:right;direction:rtl"> ,   -: </p><br><pre style=";text-align:right;direction:rtl"> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">shellcode</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> *payload = dlopen(<span class="hljs-string"><span class="hljs-string">"/path/to/payload.so"</span></span>, RTLD_LAZY); <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> (*entry)(<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>) = dlsym(payload, <span class="hljs-string"><span class="hljs-string">"entry_point"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">pthread_t</span></span> thread; pthread_create(&amp;thread, <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, entry, <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>); pthread_detach(thread); }</code> </pre> <br><p style=";text-align:right;direction:rtl">       ? </p><br><p style=";text-align:right;direction:rtl"> ,        โ   .    ,     ,      ,       -  โ  -     !    . </p><br><p style=";text-align:right;direction:rtl">    โ   -  .         ,    ,           :        . </p><br><pre style=";text-align:right;direction:rtl"> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">/* *      .rodata:   * .         , *        . */</span></span> .section .rodata <span class="hljs-comment"><span class="hljs-comment">/* *   .       . *      -:    ,  *  ,       . */</span></span> .global shellcode_start .global shellcode_address_dlopen .global shellcode_address_dlsym .global shellcode_address_pthread_create .global shellcode_address_pthread_detach .global shellcode_address_payload .global shellcode_address_entry .global shellcode_end <span class="hljs-comment"><span class="hljs-comment">/* *   dlopen().     #include &lt;dlfcn.h&gt;, *       . */</span></span> .set RTLD_LAZY, <span class="hljs-number"><span class="hljs-number">1</span></span> .align <span class="hljs-number"><span class="hljs-number">8</span></span> shellcode_start: <span class="hljs-comment"><span class="hljs-comment">/* * void *payload = dlopen(shellcode_address_payload, RTLD_LAZY); * *        x86_64: * * -     %rdi, %rsi, %rdx, %rcx * -     %rax * -      * *         . * *       %rax,    *     . */</span></span> lea shellcode_address_payload(%rip),%rdi mov $RTLD_LAZY,%rsi mov shellcode_address_dlopen(%rip),%rax callq *%rax <span class="hljs-comment"><span class="hljs-comment">/* * void (*entry)(void) = dlsym(payload, shellcode_address_entry); */</span></span> mov %rax,%rdi lea shellcode_address_entry(%rip),%rsi mov shellcode_address_dlsym(%rip),%rax callq *%rax <span class="hljs-comment"><span class="hljs-comment">/* * pthread_t thread; * pthread_create(&amp;thread, NULL, entry, NULL); * *            * ,     pthread_create(). */</span></span> sub $<span class="hljs-number"><span class="hljs-number">8</span></span>,%rsp mov %rsp,%rdi xor %rsi,%rsi mov %rax,%rdx xor %rcx,%rcx mov shellcode_address_pthread_create(%rip),%rax callq *%rax <span class="hljs-comment"><span class="hljs-comment">/* * pthread_detach(thread); * *    ,   ,  *     . */</span></span> mov (%rsp),%rdi add $<span class="hljs-number"><span class="hljs-number">8</span></span>,%rsp mov shellcode_address_pthread_detach(%rip),%rax callq *%rax <span class="hljs-comment"><span class="hljs-comment">/* *   - โ    ,     *      ret.    *     ,  *      . */</span></span> int $<span class="hljs-number"><span class="hljs-number">3</span></span> <span class="hljs-comment"><span class="hljs-comment">/* *       ,   *   ,    - *     .   โ  *  โ (global offset table, GOT),   *           . */</span></span> .align <span class="hljs-number"><span class="hljs-number">8</span></span> shellcode_address_dlopen: .space <span class="hljs-number"><span class="hljs-number">8</span></span> shellcode_address_dlsym: .space <span class="hljs-number"><span class="hljs-number">8</span></span> shellcode_address_pthread_create: .space <span class="hljs-number"><span class="hljs-number">8</span></span> shellcode_address_pthread_detach: .space <span class="hljs-number"><span class="hljs-number">8</span></span> shellcode_address_payload: .space <span class="hljs-number"><span class="hljs-number">256</span></span> shellcode_address_entry: .space <span class="hljs-number"><span class="hljs-number">256</span></span> <span class="hljs-comment"><span class="hljs-comment">/* *  - . */</span></span> shellcode_end: .end</code> </pre> <br><p style=";text-align:right;direction:rtl"> ,   .      : </p><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">$ as -o shellcode.o shellcode.S</code> </pre> <br><p style=";text-align:right;direction:rtl">  ,      ,  ,   .            :   <em>  </em> (procedure linkage table, PLT),        . </p><br><p style=";text-align:right;direction:rtl">     -    ,         (, )       .  <em>-</em>  <em></em> . </p><br><h3 id="razmeschenie-shell-koda-v-pamyati" style=";text-align:right;direction:rtl">  -   </h3><br><p style=";text-align:right;direction:rtl">     <em>-</em>    . ,       ,   ,          .      ? </p><br><h4 id="trebovaniya-k-pamyati-pod-shell-kod" style=";text-align:right;direction:rtl">     - </h4><br><p style=";text-align:right;direction:rtl">      ,       .      <em></em> ,       .    ,         .         ,       . </p><br><p style=";text-align:right;direction:rtl">              (-  ),         :   ,    ,    . , ,   JIT-   ,       .    ? </p><br><h4 id="podhody-k-razmescheniyu-v-pamyati" style=";text-align:right;direction:rtl">      </h4><br><p style=";text-align:right;direction:rtl">         : </p><br><ul style=";text-align:right;direction:rtl"><li style=";text-align:right;direction:rtl">  -  ,     </li><li style=";text-align:right;direction:rtl">   - ,    </li></ul><br><p style=";text-align:right;direction:rtl">      ,  . -,    - ,     . -,       . -,      ,  -    -,     . </p><br><p style=";text-align:right;direction:rtl">   ,      .     .  x86_64  <code>int $3</code>     โ 0xCC โ          .  ptrace()         PTRACE_POKETEXT โ ,     8   , . ,          ,     . </p><br><p style=";text-align:right;direction:rtl"> ,  ,   ,       :        .     -       ,  . </p><br><h4 id="kak-vydelit-novuyu-pamyat" style=";text-align:right;direction:rtl">    ? </h4><br><p style=";text-align:right;direction:rtl">  ,  !    malloc()! </p><br><p style=";text-align:right;direction:rtl"> .      ,      -,    .       .          ,     mmap(): </p><br><pre style=";text-align:right;direction:rtl"> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">inject_shellcode</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *shellcode_src, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">size_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> shellcode_size)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> *shellcode_dst = mmap(<span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, shellcode_size, PROT_READ | PROT_WRITE | PROT_EXEC, MAP_ANONYMOUS | MAP_PRIVATE, <span class="hljs-number"><span class="hljs-number">-1</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>); copy_shellcode(shellcode_dst, shellcode_src, shellcode_size); }</code> </pre> <br><p style=";text-align:right;direction:rtl">  ,   ptrace()         ,     . </p><br><h3 id="vypolnenie-sistemnyh-vyzovov" style=";text-align:right;direction:rtl">    </h3><br><p style=";text-align:right;direction:rtl">      ,     ?    ,            . Linux  x86_64   : </p><br><ul style=";text-align:right;direction:rtl"><li style=";text-align:right;direction:rtl">       %rax </li><li style=";text-align:right;direction:rtl">    โ    โ      %rsi, %rdi, %rdx, %r10, %r8, %r9 </li><li style=";text-align:right;direction:rtl">   SYSCALL,     </li><li style=";text-align:right;direction:rtl">       %rax </li></ul><br><p style=";text-align:right;direction:rtl">  ptrace()           PTRACE_GETREGS  PTRACE_SETREGS.  ,        .   -   SYSCALL. </p><br><p style=";text-align:right;direction:rtl">     :      ,       %rip.   ,   ,   SYSCALL. </p><br><h4 id="poisk-instrukcii-syscall" style=";text-align:right;direction:rtl">   SYSCALL </h4><br><p style=";text-align:right;direction:rtl">    SYSCALL? ,    .   -   ,   <em>-</em>      .    โ   libc.  ,  ,      ,   : </p><br><pre style=";text-align:right;direction:rtl"> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">unsigned</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">long</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">find_syscall_instruction</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(struct library *library)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">size_t</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; library-&gt;region_count; i++) { <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">memory_region</span></span></span><span class="hljs-class"> *</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">region</span></span></span><span class="hljs-class"> = &amp;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">library</span></span></span><span class="hljs-class">-&gt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">regions</span></span></span><span class="hljs-class">[</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">i</span></span></span><span class="hljs-class">];</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!(region-&gt;readable &amp;&amp; region-&gt;executable)) <span class="hljs-keyword"><span class="hljs-keyword">continue</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> *region_data = region-&gt;content; <span class="hljs-keyword"><span class="hljs-keyword">size_t</span></span> region_size = region-&gt;vaddr_high - region-&gt;vaddr_low; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (region_size &lt; <span class="hljs-number"><span class="hljs-number">2</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">continue</span></span>; <span class="hljs-comment"><span class="hljs-comment">/* * 0F 05 syscall */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">size_t</span></span> offset = <span class="hljs-number"><span class="hljs-number">0</span></span>; offset &lt; region_size - <span class="hljs-number"><span class="hljs-number">1</span></span>; offset++) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (region_data[offset + <span class="hljs-number"><span class="hljs-number">0</span></span>] == <span class="hljs-number"><span class="hljs-number">0x0F</span></span> &amp;&amp; region_data[offset + <span class="hljs-number"><span class="hljs-number">1</span></span>] == <span class="hljs-number"><span class="hljs-number">0x05</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> region-&gt;vaddr_low + offset; } } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>; }</code> </pre> <br><p style=";text-align:right;direction:rtl">        , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">  /proc/$pid/maps</a> .  x86_64     ,    -   .     <em></em>   ,    0x0F 0x05.     , ,  ARM,       0xDF 0x00 ( SVC #0),  <em>  </em> . </p><br><h4 id="ispolzovanie-ptrace_getsetregs" style=";text-align:right;direction:rtl">  PTRACE_{GET,SET}REGS </h4><br><p style=";text-align:right;direction:rtl">      : </p><br><pre style=";text-align:right;direction:rtl"> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">get_registers</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">pid_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> pid, struct user_regs_struct *registers)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> err = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ptrace(PTRACE_GETREGS, pid, registers, registers) &lt; <span class="hljs-number"><span class="hljs-number">0</span></span>) err = -errno; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> err; }</code> </pre> <br><p style=";text-align:right;direction:rtl">     <code>struct user_regs_struct</code> ,    &lt;sys/user.h&gt;.     .          .     ,        <em>varargs</em> : </p><br><pre style=";text-align:right;direction:rtl"> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">set_regs_for_syscall</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(struct user_regs_struct *registers, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">unsigned</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">long</span></span></span></span><span class="hljs-function"><span class="hljs-params"> syscall_insn_vaddr, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">long</span></span></span></span><span class="hljs-function"><span class="hljs-params"> syscall_number, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> args_count, va_list args)</span></span></span><span class="hljs-function"> </span></span>{ registers-&gt;rip = syscall_insn_vaddr; registers-&gt;rax = syscall_number; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; args_count; i++) { <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> (i) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>: registers-&gt;rdi = va_arg(args, <span class="hljs-keyword"><span class="hljs-keyword">long</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>: registers-&gt;rsi = va_arg(args, <span class="hljs-keyword"><span class="hljs-keyword">long</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span>: registers-&gt;rdx = va_arg(args, <span class="hljs-keyword"><span class="hljs-keyword">long</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-number"><span class="hljs-number">3</span></span>: registers-&gt;r10 = va_arg(args, <span class="hljs-keyword"><span class="hljs-keyword">long</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-number"><span class="hljs-number">4</span></span>: registers-&gt;r8 = va_arg(args, <span class="hljs-keyword"><span class="hljs-keyword">long</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-number"><span class="hljs-number">5</span></span>: registers-&gt;r9 = va_arg(args, <span class="hljs-keyword"><span class="hljs-keyword">long</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">default</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> -E2BIG; } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">long</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">perform_syscall</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">pid_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> pid, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">unsigned</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">long</span></span></span></span><span class="hljs-function"><span class="hljs-params"> syscall_insn_vaddr, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">long</span></span></span></span><span class="hljs-function"><span class="hljs-params"> syscall_number, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> args_count, ...)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">user_regs_struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">old_registers</span></span></span><span class="hljs-class">;</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">user_regs_struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">new_registers</span></span></span><span class="hljs-class">;</span></span> <span class="hljs-comment"><span class="hljs-comment">/* *    ,   *      . */</span></span> get_registers(pid, &amp;old_registers); <span class="hljs-comment"><span class="hljs-comment">/* *      ,   * ,     . */</span></span> new_registers = old_registers; va_list args; va_start(args, args_count); set_regs_for_syscall(&amp;new_registers, syscall_insn_vaddr, syscall_number, args_count, args); va_end(args); set_registers(pid, &amp;new_registers); <span class="hljs-comment"><span class="hljs-comment">/* *    ,    *   ,    * (  ),    . *     . */</span></span> wait_for_syscall_completion(pid); <span class="hljs-comment"><span class="hljs-comment">/* *       *    . *        . */</span></span> get_registers(pid, &amp;new_registers); <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> result = new_registers.rax; set_registers(pid, &amp;old_registers); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> result; }</code> </pre> <br><h4 id="ispolzovanie-ptrace_syscall" style=";text-align:right;direction:rtl">  PTRACE_SYSCALL </h4><br><p style=";text-align:right;direction:rtl">       :        ,    ? </p><br><p style=";text-align:right;direction:rtl">      PTRACE_SYSCALL.   PTRACE_CONT,     .   ,    - :    ,    . </p><br><p style=";text-align:right;direction:rtl"> PTRACE_SYSCALL    SIGTRAP    :      (     )       (      ).  , ptrace()   ,          ,         . </p><br><p style=";text-align:right;direction:rtl">  ,           SIGTRAP: </p><br><pre style=";text-align:right;direction:rtl"> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">wait_for_syscall_enter_exit_stop</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">pid_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> pid)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ptrace(PTRACE_SYSCALL, pid, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>) &lt; <span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">-1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (wait_for_process_stop(pid, SIGTRAP) &lt; <span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">-1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">wait_for_syscall_completion</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">pid_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> pid)</span></span></span><span class="hljs-function"> </span></span>{ wait_for_syscall_enter_exit_stop(pid); wait_for_syscall_enter_exit_stop(pid); }</code> </pre> <br><p style=";text-align:right;direction:rtl">   โ   ,    โ       (wait_for_process_stop() <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u="> </a> ).           .       ,     . </p><br><h4 id="opciya-ptrace_o_tracesysgood" style=";text-align:right;direction:rtl">  PTRACE_O_TRACESYSGOOD </h4><br><p style=";text-align:right;direction:rtl">   , PTRACE_SYSCALL      :       ,   ,  -  .  ,      SIGTRAP       (    ). </p><br><p style=";text-align:right;direction:rtl">     SIGTRAP       <em></em> .        PTRACE_O_TRACESYSGOOD,            : </p><br><ul style=";text-align:right;direction:rtl"><li style=";text-align:right;direction:rtl"> SIGTRAP โ -     </li><li style=";text-align:right;direction:rtl"> SIGTRAP | 0x80 โ     </li></ul><br><pre style=";text-align:right;direction:rtl"> <code class="diff hljs"> int ptrace_attach(pid_t pid) { if (ptrace(PTRACE_ATTACH, pid, 0, 0) &lt; 0) return -1; if (wait_for_process_stop(pid, SIGSTOP) &lt; 0) return -1; + /*     */ + unsigned long options = PTRACE_O_TRACESYSGOOD; + if (ptrace(PTRACE_SETOPTIONS, pid, 0, options) &lt; 0) + return -1; return 0; } static int wait_for_syscall_enter_exit_stop(pid_t pid) { if (ptrace(PTRACE_SYSCALL, pid, 0, 0) &lt; 0) return -1; - if (wait_for_process_stop(pid, SIGTRAP) &lt; 0) + if (wait_for_process_stop(pid, SIGTRAP | 0x80) &lt; 0) return -1; return 0; }</code> </pre> <br><h3 id="zagruzka-shell-koda-v-pamyat" style=";text-align:right;direction:rtl">  -   </h3><br><p style=";text-align:right;direction:rtl"> -       : </p><br><pre style=";text-align:right;direction:rtl"> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">write_shellcode</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> shellcode_text[SHELLCODE_TEXT_SIZE]; <span class="hljs-keyword"><span class="hljs-keyword">size_t</span></span> shellcode_size = shellcode_end - shellcode_start; <span class="hljs-comment"><span class="hljs-comment">/*   ,  ,  . . */</span></span> prepare_shellcode(shellcode_text, shellcode_size); <span class="hljs-comment"><span class="hljs-comment">/*   -   */</span></span> write_remote_memory(target, shellcode_text_vaddr, shellcode_text, shellcode_size); }</code> </pre> <br><p style=";text-align:right;direction:rtl">   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">   -</a>    :      dlopen(),               . </p><br><pre style=";text-align:right;direction:rtl"> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">inline</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">copy_shellcode</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *shellcode_text, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *shellcode_addr, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *data, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">size_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> length)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">ptrdiff_t</span></span> offset = shellcode_addr - shellcode_start; <span class="hljs-built_in"><span class="hljs-built_in">memcpy</span></span>(shellcode_text + offset, data, length); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">prepare_shellcode</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *shellcode_text, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">size_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> shellcode_size)</span></span></span><span class="hljs-function"> </span></span>{ copy_shellcode(shellcode_text, shellcode_start, shellcode_start, shellcode_size); copy_shellcode(shellcode_text, shellcode_address_dlopen, &amp;dlopen_vaddr, <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(dlopen_vaddr)); copy_shellcode(shellcode_text, shellcode_address_dlsym, &amp;dlsym_vaddr, <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(dlsym_vaddr)); copy_shellcode(shellcode_text, shellcode_address_pthread_create, &amp;pthread_create_vaddr, <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(pthread_create_vaddr)); copy_shellcode(shellcode_text, shellcode_address_pthread_detach, &amp;pthread_detach_vaddr, <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(pthread_detach_vaddr)); copy_shellcode(shellcode_text, shellcode_address_payload, payload, <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(payload)); copy_shellcode(shellcode_text, shellcode_address_entry, entry, <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(entry)); }</code> </pre> <br><p style=";text-align:right;direction:rtl">     ,    ,      -: </p><br><pre style=";text-align:right;direction:rtl"> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">extern</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> shellcode_start[]; <span class="hljs-keyword"><span class="hljs-keyword">extern</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> shellcode_address_dlopen[]; <span class="hljs-keyword"><span class="hljs-keyword">extern</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> shellcode_address_dlsym[]; <span class="hljs-keyword"><span class="hljs-keyword">extern</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> shellcode_address_pthread_create[]; <span class="hljs-keyword"><span class="hljs-keyword">extern</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> shellcode_address_pthread_detach[]; <span class="hljs-keyword"><span class="hljs-keyword">extern</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> shellcode_address_payload[]; <span class="hljs-keyword"><span class="hljs-keyword">extern</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> shellcode_address_entry[]; <span class="hljs-keyword"><span class="hljs-keyword">extern</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> shellcode_end[];</code> </pre> <br><p style=";text-align:right;direction:rtl">      ,              . </p><br><p style=";text-align:right;direction:rtl">    -        .         /proc/$pid/mem, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">    </a> : </p><br><pre style=";text-align:right;direction:rtl"> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">write_remote_memory</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">pid_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> pid, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">unsigned</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">long</span></span></span></span><span class="hljs-function"><span class="hljs-params"> vaddr, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *data, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">size_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> size)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> path[<span class="hljs-number"><span class="hljs-number">32</span></span>] = {<span class="hljs-number"><span class="hljs-number">0</span></span>}; <span class="hljs-built_in"><span class="hljs-built_in">snprintf</span></span>(path, <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(path), <span class="hljs-string"><span class="hljs-string">"/proc/%d/mem"</span></span>, pid); <span class="hljs-comment"><span class="hljs-comment">/*       */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> fd = open(path, O_WRONLY); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (fd &lt; <span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">-1</span></span>; <span class="hljs-comment"><span class="hljs-comment">/*     */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (lseek(fd, vaddr, SEEK_SET) &lt; <span class="hljs-number"><span class="hljs-number">0</span></span>) { close(fd); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">-1</span></span>; } <span class="hljs-comment"><span class="hljs-comment">/*    */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> err = do_write_remote_memory(fd, data, size); close(fd); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> err; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">do_write_remote_memory</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> fd, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *data, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">size_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> size)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">size_t</span></span> left = size; <span class="hljs-comment"><span class="hljs-comment">/* *    ,  ,     *   ,       *      . */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (left &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">ssize_t</span></span> wrote = write(fd, data, left); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (wrote &lt; <span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">-1</span></span>; data += wrote; left -= wrote; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>; }</code> </pre> <br><h3 id="rezultaty-chetvyortogo-shaga" style=";text-align:right;direction:rtl">    </h3><br><p style=";text-align:right;direction:rtl"> ,             - โ ยซ ยป .           .    - ,                . </p><br><h2 id="shag-5-zapusk-novogo-potoka" style=";text-align:right;direction:rtl">  5.    </h2><br><p style=";text-align:right;direction:rtl">     -        .  ,    :    %rip  -,  PTRACE_SETREGS,  PTRACE_CONT    .     . </p><br><p style=";text-align:right;direction:rtl"> ,   ,    .      -?        ? </p><br><h3 id="pochemu-nuzhen-novyy-potok" style=";text-align:right;direction:rtl">     </h3><br><p style=";text-align:right;direction:rtl">  ,    .    ,          ยซ ยป  .  ,      .      : </p><br><ul style=";text-align:right;direction:rtl"><li style=";text-align:right;direction:rtl">       </li><li style=";text-align:right;direction:rtl">   (async-signal-safe)  </li></ul><br><p style=";text-align:right;direction:rtl">      โ     . dlopen()  pthread_create()     .        -  dlopen(),      dlopen()  ? </p><br><p style=";text-align:right;direction:rtl">        -, ,   ,       . ,     pthread_create()    .     ,       (     ).     clone(). </p><br><blockquote style=";text-align:right;direction:rtl"> <strong>  pthread_create()?</strong> <br><br>     ,  -     ,         ? <br><br> :          clone(). <br><br>          ,    (libc)    (pthread).   clone()       <em> </em> (thread control block, TCB)  <em> </em> (thread-local storage, TLS),        ,  . .     pthread_create()    ,    . <br><br>    ยซยป,      clone()        libc  pthread.        ,    . </blockquote><br><h3 id="podgotovka-k-zapusku-potoka" style=";text-align:right;direction:rtl">     </h3><br><p style=";text-align:right;direction:rtl">      clone()      : </p><br><ul style=";text-align:right;direction:rtl"><li style=";text-align:right;direction:rtl">      ? </li><li style=";text-align:right;direction:rtl">    ? </li><li style=";text-align:right;direction:rtl">    -? </li></ul><br><h4 id="obrabotka-zaversheniya-potoka" style=";text-align:right;direction:rtl">    </h4><br><p style=";text-align:right;direction:rtl">      :     -? </p><br><p style=";text-align:right;direction:rtl">     ,  -       :   ,   ,       ,       . </p><br><p style=";text-align:right;direction:rtl">        .  ,     ,        . ?  :     exit().          ,     . </p><br><p style=";text-align:right;direction:rtl">         .     exit()   -: </p><br><pre style=";text-align:right;direction:rtl"> <code class="diff hljs"><span class="hljs-addition"><span class="hljs-addition">+.set __NR_exit, 60 .set RTLD_LAZY, 1 @@ - /* - *  . - */ - int $3 + /* + * exit(0); + */ + xor %rdi,%rdi + mov $__NR_exit,%rax + syscall</span></span></code> </pre> <br><p style=";text-align:right;direction:rtl">  :   exit() โ    exit()   .   exit()    <em></em> ,    exit()    โ <em> </em>   .    Linux     exit_group(). </p><br><h4 id="vydelenie-pamyati-pod-stek" style=";text-align:right;direction:rtl">     </h4><br><p style=";text-align:right;direction:rtl">     .         .     ,      ,   PROT_EXEC: </p><br><pre style=";text-align:right;direction:rtl"> <code class="cpp hljs">shellcode_stack_vaddr = remote_mmap(target, syscall_vaddr, <span class="hljs-number"><span class="hljs-number">0</span></span>, SHELLCODE_STACK_SIZE, PROT_READ | PROT_WRITE, MAP_ANONYMOUS | MAP_PRIVATE | MAP_STACK | MAP_GROWSDOWN, <span class="hljs-number"><span class="hljs-number">-1</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>);</code> </pre> <br><p style=";text-align:right;direction:rtl">   ,   Linux  x86_64  <em> </em> โ  ยซยป  ,     .  mmap()      ,   clone()     .  ,    mmap()  MAP_GROWSDOWN,       ,    . </p><br><h4 id="opciya-ptrace_o_traceclone" style=";text-align:right;direction:rtl">  PTRACE_O_TRACECLONE </h4><br><p style=";text-align:right;direction:rtl">        .       ,   -   .         waitpid(),     :      ,          . </p><br><p style=";text-align:right;direction:rtl">        โ   PTRACE_O_TRACECLONE.          .  ,       . ,      ,     ,    .      ,       PTRACE_ATTACH  ,    . </p><br><p style=";text-align:right;direction:rtl"> -,       : </p><br><pre style=";text-align:right;direction:rtl"> <code class="diff hljs"><span class="hljs-deletion"><span class="hljs-deletion">- unsigned long options = PTRACE_O_TRACESYSGOOD; + unsigned long options = PTRACE_O_TRACESYSGOOD | PTRACE_O_TRACECLONE; if (ptrace(PTRACE_SETOPTIONS, pid, 0, options) &lt; 0) return -1;</span></span></code> </pre> <br><p style=";text-align:right;direction:rtl"> -,         clone(),    PTRACE_EVENT_CLONE,     ,  PTRACE_SYSCALL.        : </p><br><pre style=";text-align:right;direction:rtl"> <code class="diff hljs"><span class="hljs-deletion"><span class="hljs-deletion">-void wait_for_syscall_completion(pid_t pid) +void wait_for_syscall_completion(pid_t pid, long syscall) { wait_for_syscall_enter_exit_stop(pid); + + /*  clone()   PTRACE_EVENT_CLONE */ + if (syscall == __NR_clone) + wait_for_clone_event(pid); wait_for_syscall_enter_exit_stop(pid); }</span></span></code> </pre> <br><p style=";text-align:right;direction:rtl">     : </p><br><pre style=";text-align:right;direction:rtl"> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">wait_for_clone_event</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">pid_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> pid)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ptrace(PTRACE_CONT, pid, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>) &lt; <span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">-1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> event = SIGTRAP | (PTRACE_EVENT_CLONE &lt;&lt; <span class="hljs-number"><span class="hljs-number">8</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (wait_for_process_stop(pid, event) &lt; <span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">-1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>; }</code> </pre> <br><p style=";text-align:right;direction:rtl">     clone()  PID  ,    .         : </p><br><pre style=";text-align:right;direction:rtl"> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">clear_ptrace_options</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">pid_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> pid)</span></span></span><span class="hljs-function"> </span></span>{ ptrace(PTRACE_SETOPTIONS, pid, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>); }</code> </pre> <br><p style=";text-align:right;direction:rtl">   ,   clone()    ptrace(),  PTRACE_O_TRACECLONE.     ,     ,  -     . </p><br><h3 id="zapusk-novogo-potoka" style=";text-align:right;direction:rtl">    </h3><br><p style=";text-align:right;direction:rtl">      ,   - .       clone()   : </p><br><pre style=";text-align:right;direction:rtl"> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">spawn_shell_thread</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ shell_tid = remote_clone(target, syscall_ret_vaddr, CLONE_FILES | CLONE_FS | CLONE_IO | CLONE_SIGHAND | CLONE_SYSVSEM | CLONE_THREAD | CLONE_VM, <span class="hljs-comment"><span class="hljs-comment">/*   **  */</span></span> shellcode_stack_vaddr + SHELLCODE_STACK_SIZE); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!shell_tid) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">-1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>; }</code> </pre> <br><p style=";text-align:right;direction:rtl">     <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=" rel="nofollow">clone()    </a> :    ,   ,     ,  .      ,  . </p><br><p style=";text-align:right;direction:rtl"> CLONE_FILES, CLONE_FS, CLONE_IO, CLONE_SIGHAND, CLONE_SYSVSEM, CLONE_VM โ         . ,   CLONE_FILES    <em></em>   ,    (  fork()).      โ    <em></em> โ      ,        .       . , CLONE_VM   ,       ,    . </p><br><p style=";text-align:right;direction:rtl">  CLONE_THREAD       <em></em> :    Linux โ  ยซ   ยป,     .  , ,  getpid()         , kill() โ   -   , execve() โ       ,   . </p><br><p style=";text-align:right;direction:rtl">  ,  clone()   fork():        ,    .      clone()      :    ,  โ   .        . ( , ,        .) </p><br><p style=";text-align:right;direction:rtl">    ,  pthread_create()    ,      ,    .     ? </p><br><h3 id="peredacha-upravleniya" style=";text-align:right;direction:rtl">   </h3><br><p style=";text-align:right;direction:rtl">    fork()  : </p><br><pre style=";text-align:right;direction:rtl"> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">pid_t</span></span> child = fork(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (child &lt; <span class="hljs-number"><span class="hljs-number">0</span></span>) { <span class="hljs-comment"><span class="hljs-comment">/* fork() ,    */</span></span> } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (child == <span class="hljs-number"><span class="hljs-number">0</span></span>) { <span class="hljs-comment"><span class="hljs-comment">/*     execve() */</span></span> } <span class="hljs-comment"><span class="hljs-comment">/*     */</span></span></code> </pre> <br><p style=";text-align:right;direction:rtl">  ,     .  clone()                 .            . </p><br><p style=";text-align:right;direction:rtl">      <a href="" rel="nofollow"> </a> . ,   clone()      ,    .      syscall   ret,       ,     .           . </p><br><h4 id="poisk-pary-instrukciy-syscall--ret" style=";text-align:right;direction:rtl">    SYSCALL + RET </h4><br><p style=";text-align:right;direction:rtl">        <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">   </a> ,       .      ,     syscall   ret: </p><br><pre style=";text-align:right;direction:rtl"> <code class="diff hljs"><span class="hljs-deletion"><span class="hljs-deletion">-if (region_size &lt; 2) +if (region_size &lt; 3) continue; /* * 0F 05 syscall + * C3 retq */ -for (size_t offset = 0; offset &lt; region_size - 1; offset++) { +for (size_t offset = 0; offset &lt; region_size - 2; offset++) { if (region_data[offset + 0] == 0x0F &amp;&amp; - region_data[offset + 1] == 0x05) + region_data[offset + 1] == 0x05 &amp;&amp; + region_data[offset + 2] == 0xC3) { return region-&gt;vaddr_low + offset; } }</span></span></code> </pre> <br><p style=";text-align:right;direction:rtl">  ,       . </p><br><h4 id="podgotovka-steka" style=";text-align:right;direction:rtl">   </h4><br><p style=";text-align:right;direction:rtl">     .   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u="> prepare_shellcode()</a> ,    ,          : </p><br><pre style=";text-align:right;direction:rtl"> <code class="diff hljs"> void write_shellcode(void) { char shellcode_text[SHELLCODE_TEXT_SIZE]; size_t shellcode_size = shellcode_end - shellcode_start; /*   ,  ,  . . */ prepare_shellcode(shellcode_text, shellcode_size); /*   -   */ write_remote_memory(target, shellcode_text_vaddr, shellcode_text, shellcode_size); + /*    ยซยป   */ + unsigned long retaddr_vaddr = + shellcode_stack_vaddr + SHELLCODE_STACK_SIZE - 8; + write_remote_memory(target, retaddr_vaddr, + &amp;shellcode_text_vaddr, sizeof(shellcode_text_vaddr)); }</code> </pre> <br><p style=";text-align:right;direction:rtl">  ,      ,     . </p><br><p style=";text-align:right;direction:rtl">  ,     ,   <em></em> . System V ABI ,   ( %rsp)     16    .  <code>shellcode_stack_vaddr + SHELLCODE_STACK_SIZE</code>  :       (  4096 ),     1 .  8 ,     ,      retq,      -    .   -   : </p><br><pre style=";text-align:right;direction:rtl"> <code class="diff hljs"><span class="hljs-deletion"><span class="hljs-deletion">- sub $8,%rsp + sub $16,%rsp /*   */ mov %rsp,%rdi xor %rsi,%rsi mov %rax,%rdx xor %rcx,%rcx mov shellcode_address_pthread_create(%rip),%rax callq *%rax</span></span></code> </pre> <br><p style=";text-align:right;direction:rtl">     ,   %rsp    16       pthread_create().          SIGSEGV,     โ     pthread_create()   ,       . </p><br><h4 id="zapusk-potoka" style=";text-align:right;direction:rtl">   </h4><br><p style=";text-align:right;direction:rtl">        ,       - ,      clone(): </p><br><pre style=";text-align:right;direction:rtl"> <code class="diff hljs"> static int spawn_shell_thread() { shell_tid = remote_clone(target, syscall_ret_vaddr, CLONE_FILES | CLONE_FS | CLONE_IO | CLONE_SIGHAND | CLONE_SYSVSEM | CLONE_THREAD | CLONE_VM, /*   **  */ - shellcode_stack_vaddr + SHELLCODE_STACK_SIZE); + shellcode_stack_vaddr + SHELLCODE_STACK_SIZE - 8); if (!shell_tid) return -1; return 0; }</code> </pre> <br><p style=";text-align:right;direction:rtl">      ptrace()    SIGSTOP,     : </p><br><pre style=";text-align:right;direction:rtl"> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ignore_thread_stop</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">pid_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> pid)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> wait_for_process_stop(pid, SIGSTOP); }</code> </pre> <br><p style=";text-align:right;direction:rtl"> .               ptrace(): </p><br><pre style=";text-align:right;direction:rtl"> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">resume_thread</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">pid_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> pid)</span></span></span><span class="hljs-function"> </span></span>{ ptrace(PTRACE_CONT, pid, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>); }</code> </pre> <br><h3 id="zavershenie-potoka" style=";text-align:right;direction:rtl">   </h3><br><p style=";text-align:right;direction:rtl">  ,    ,  ,    exit().        waitpid().     โ  CLONE_THREAD   wait()  ,โ    PTRACE_O_TRACECLONE,      : </p><br><pre style=";text-align:right;direction:rtl"> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">wait_for_process_exit</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">pid_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> pid)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> status = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (waitpid(pid, &amp;status, <span class="hljs-number"><span class="hljs-number">0</span></span>) &lt; <span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">-1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!WIFEXITED(status)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">-1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> WEXITSTATUS(status); }</code> </pre> <br><p style=";text-align:right;direction:rtl">    pthread ,   ,  pthread_join()      pthread       ,        . ,  โ  .       ,   ,  . </p><br><h4 id="osvobozhdenie-pamyati" style=";text-align:right;direction:rtl">  ุฐุงูุฑุฉ ุญุฑุฉ </h4><br><p style=";text-align:right;direction:rtl">     ,  -   .     ,   -   ,      munmap(): </p><br><pre style=";text-align:right;direction:rtl"> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">remote_munmap</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">pid_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> pid, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">unsigned</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">long</span></span></span></span><span class="hljs-function"><span class="hljs-params"> syscall_insn_vaddr, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">unsigned</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">long</span></span></span></span><span class="hljs-function"><span class="hljs-params"> addr, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">size_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> len)</span></span></span><span class="hljs-function"> </span></span>{ perform_syscall(pid, syscall_insn_vaddr, __NR_munmap, <span class="hljs-number"><span class="hljs-number">2</span></span>, (<span class="hljs-keyword"><span class="hljs-keyword">long</span></span>) addr, (<span class="hljs-keyword"><span class="hljs-keyword">long</span></span>) len); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">unmap_shellcode</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ remote_munmap(target, syscall_ret_vaddr, shellcode_text_vaddr, SHELLCODE_TEXT_SIZE); remote_munmap(target, syscall_ret_vaddr, shellcode_stack_vaddr, SHELLCODE_STACK_SIZE); }</code> </pre> <br><p style=";text-align:right;direction:rtl"> ,  ,     ,      โ  ptrace()   .        (, SIGSTOP),    ,   <em> </em>    (    ): </p><br><pre style=";text-align:right;direction:rtl"> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">stop_thread</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">pid_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> pid)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (kill(pid, SIGSTOP) &lt; <span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">-1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (wait_for_process_stop(pid, SIGSTOP) &lt; <span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">-1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>; }</code> </pre> <br><h4 id="otklyuchenie-otladchika" style=";text-align:right;direction:rtl">   </h4><br><p style=";text-align:right;direction:rtl"> ,      ,    .     PTRACE_DETACH: </p><br><pre style=";text-align:right;direction:rtl"> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ptrace_detach</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">pid_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> pid)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ptrace(PTRACE_DETACH, pid, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>) &lt; <span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">-1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>; }</code> </pre> <br><h3 id="rezultaty-pyatogo-shaga" style=";text-align:right;direction:rtl">    </h3><br><p style=";text-align:right;direction:rtl">                   ,      .     ,         .   ,      . </p><br><h2 id="zaklyuchenie" style=";text-align:right;direction:rtl">  ุงุณุชูุชุงุฌ </h2><br><p style=";text-align:right;direction:rtl">      ?   . ,       ,      . </p><br><p style=";text-align:right;direction:rtl"><img src="https://habrastorage.org/webt/0v/gu/we/0vguwedoumnnjh89zw5jtpaaltw.gif" alt="   Gnome Control Center"></p><br><p style=";text-align:right;direction:rtl">    Linux    .     GTK+     .      ,       make: </p><br><pre style=";text-align:right;direction:rtl"> <code class="bash hljs">libpayload.so: payload.c $(CC) $(CFLAGS) $(shell pkg-config --cflags --libs gtk+-3.0) -shared -o <span class="hljs-variable"><span class="hljs-variable">$@</span></span> $&lt;</code> </pre> <br><p style=";text-align:right;direction:rtl">     entry()            GTK- โ    GTK  UI      ,    : </p><br><pre style=";text-align:right;direction:rtl"> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;glib.h&gt; #include &lt;gtk/gtk.h&gt; static gboolean actual_entry(gpointer _arg) { /*       : */ hook_gtk_entry_constructor(); /*   FALSE,       */ return FALSE; } void entry(void) { /*    -,   */ g_idle_add_full(G_PRIORITY_DEFAULT_IDLE, actual_entry, NULL, NULL); }</span></span></span></span></code> </pre> <br><p style=";text-align:right;direction:rtl"> ,   GTK   ,  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=" rel="nofollow">GtkEntry</a> .  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=" rel="nofollow"> "input-purpose"</a>     .       ยซยป,    ,      . </p><br><p style=";text-align:right;direction:rtl"> GTK   glib โ     โ      GtkEntry       .    constructed(),     .    : </p><br><pre style=";text-align:right;direction:rtl"> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">void</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(*old_gtk_entry_constructed)</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(GObject *object)</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">new_gtk_entry_constructed</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(GObject *object)</span></span></span><span class="hljs-function"> </span></span>{ GtkEntry *entry = GTK_ENTRY(object); <span class="hljs-comment"><span class="hljs-comment">/*    */</span></span> old_gtk_entry_constructed(object); <span class="hljs-comment"><span class="hljs-comment">/*    ,  ,   entry */</span></span> } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">hook_gtk_entry_constructor</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">/*     GtkEntry */</span></span> GTypeClass *entry_type_class = g_type_class_peek(GTK_TYPE_ENTRY); GObjectClass *entry_object_class = G_OBJECT_CLASS(entry_type_class); <span class="hljs-comment"><span class="hljs-comment">/* *     "constructed"     . */</span></span> old_gtk_entry_constructed = entry_object_class-&gt;constructed; entry_object_class-&gt;constructed = new_gtk_entry_constructed; }</code> </pre> <br><p style=";text-align:right;direction:rtl">   GtkEntry   : </p><br><ul style=";text-align:right;direction:rtl"><li style=";text-align:right;direction:rtl">   ,  ,   </li><li style=";text-align:right;direction:rtl">        </li></ul><br><p style=";text-align:right;direction:rtl">  ,    GtkEntry  <em></em> ,   ,    .     ,    : </p><br><pre style=";text-align:right;direction:rtl"> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">new_gtk_entry_constructed</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(GObject *object)</span></span></span><span class="hljs-function"> </span></span>{ GtkEntry *entry = GTK_ENTRY(object); old_gtk_entry_constructed(object); <span class="hljs-comment"><span class="hljs-comment">/*       */</span></span> g_signal_connect(entry, <span class="hljs-string"><span class="hljs-string">"notify::input-purpose"</span></span>, G_CALLBACK(input_purpose_changed), <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>); <span class="hljs-comment"><span class="hljs-comment">/*      */</span></span> g_signal_connect(entry, <span class="hljs-string"><span class="hljs-string">"icon-press"</span></span>, G_CALLBACK(icon_pressed), <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>); <span class="hljs-comment"><span class="hljs-comment">/*      */</span></span> g_signal_connect(entry, <span class="hljs-string"><span class="hljs-string">"icon-release"</span></span>, G_CALLBACK(icon_released), <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>); }</code> </pre> <br><p style=";text-align:right;direction:rtl">   .                ,         .         . </p><br><pre style=";text-align:right;direction:rtl"> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">input_purpose_changed</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(GtkEntry *entry)</span></span></span><span class="hljs-function"> </span></span>{ GtkInputPurpose purpose = gtk_entry_get_input_purpose(entry); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (purpose == GTK_INPUT_PURPOSE_PASSWORD) { gtk_entry_set_icon_activatable(entry, GTK_ENTRY_ICON_PRIMARY, TRUE); gtk_entry_set_icon_from_icon_name(entry, GTK_ENTRY_ICON_PRIMARY, <span class="hljs-string"><span class="hljs-string">"list-remove"</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { gtk_entry_set_icon_activatable(entry, GTK_ENTRY_ICON_PRIMARY, FALSE); gtk_entry_set_icon_from_icon_name(entry, GTK_ENTRY_ICON_PRIMARY, <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>); } }</code> </pre> <br><p style=";text-align:right;direction:rtl">   : ,      ,   ,  -       ,      : </p><br><pre style=";text-align:right;direction:rtl"> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">icon_pressed</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(GtkEntry *entry, GtkEntryIconPosition position)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (position != GTK_ENTRY_ICON_PRIMARY) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; gtk_entry_set_visibility(entry, TRUE); gtk_entry_set_icon_from_icon_name(entry, GTK_ENTRY_ICON_PRIMARY, <span class="hljs-string"><span class="hljs-string">"list-add"</span></span>); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">icon_released</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(GtkEntry *entry, GtkEntryIconPosition position)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (position != GTK_ENTRY_ICON_PRIMARY) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; gtk_entry_set_visibility(entry, FALSE); gtk_entry_set_icon_from_icon_name(entry, GTK_ENTRY_ICON_PRIMARY, <span class="hljs-string"><span class="hljs-string">"list-remove"</span></span>); }</code> </pre> <br><p style=";text-align:right;direction:rtl">  ูุฐุง ูู ุดูุก. </p><br><p style=";text-align:right;direction:rtl"> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=" rel="nofollow"> GitHub</a>         (GPLv2). </p><br><p style=";text-align:right;direction:rtl"> ,       .   gdb         : </p><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">$ gdb --pid $(pgrep target) \ --batch \ -ex 'compile file -raw shell-code.c'</code> </pre> </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/ar473740/">https://habr.com/ru/post/ar473740/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ar473720/index.html">ุทุฑููุชุงู ูุฅุฌุฑุงุก ุงุฎุชุจุงุฑุงุช ูุญุฏุฉ ููุซููุฉ</a></li>
<li><a href="../ar473722/index.html">ุงูุนุฒูุฉ ุนู ุจุนุฏ ูุงูููู ูุงูุงูุชุฆุงุจ</a></li>
<li><a href="../ar473726/index.html">ูุง ูููู ุฃู ุชุนุฑู ูุง ูู Mutex ู Semaphore ู async / ุงูุชุธุงุฑ. ุชุญุชุงุฌ ุฅูู ูุนุฑูุฉ ูู ุดูุก ูู ููุงูุชุง</a></li>
<li><a href="../ar473728/index.html">ุชูููุฐ ูููุฐุฌู ููุฑุตุฏ. ูููููุงู ุณูููู</a></li>
<li><a href="../ar473732/index.html">ุชุงุฑูุฎ ุงูุงุญุชูุงู ูู ุจูุงุก ุดุจูุฉ ุงููุงุจู ุชุญุช ุงููุทุจ ุงูุดูุงูู ู 1 ูููุงุฑ ุฏููุงุฑ</a></li>
<li><a href="../ar473742/index.html">ุทุงุจุนุงุช Epson ุงูููุฏุณูุฉ ููุธุงูู CAD ู GIS ูุจุถุน ูููุงุช ุญูู "ุงูุชุตููู ุงูููู"</a></li>
<li><a href="../ar473748/index.html">ููุญูู ุจูุฒูุฑ ูู ุฎุฏูุฉ ุงูุงูุชุตุงุฏููู ุงูุนูู</a></li>
<li><a href="../ar473750/index.html">Stereopi + WebRTC = ุงูุชุญูู ุนู ุจุนุฏ ูู ุงูููุฒู</a></li>
<li><a href="../ar473752/index.html">ูุง ุงูุฎุทุฃ ูู ุงููุณุฎ ุนูุฏ ุงููุชุงุจุฉ ููุธุงู Linux ุนูุฏ ุงููุณุฎ</a></li>
<li><a href="../ar473756/index.html">HTTPS DNS - ุญู ูุตู ูุฎุทุฃ</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>