<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👤 🧚 🧑🏾‍🤝‍🧑🏻 Roteador sem fio DIY 🔌 🕔 👩‍🌾</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="1. Seleção de componentes 
2. Iniciar interfaces de rede 
3. Configurando um ponto de acesso 802.11ac (5 GHz) 
4. Configurando um SSID virtual usando ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Roteador sem fio DIY</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/437634/"><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/967/b65/9d2/967b659d291d3021a9a93f68b4b305b2.jpg"></div><br><ol><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Seleção de componentes</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Iniciar interfaces de rede</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Configurando um ponto de acesso 802.11ac (5 GHz)</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Configurando um SSID virtual usando o hostapd</a> </li></ol><br>  Nos últimos dez anos, comprei equipamentos de rede baratos e instalei o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">DD-WRT</a> nele para devolver as “funções” por mais de US $ 500 removidos do kernel Linux, no qual o firmware padrão é baseado. <br><br>  Apesar das compilações instáveis, erros e <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=https://web.archive.org/web/20160303173311/">disputas</a> não corrigidos, o DD-WRT ainda é preferível ao estoque de firmware.  Mas agora os componentes dignos estão mais baratos do que nunca, e a comunidade DIY mudou completamente para o Linux (estou olhando para você, Sr. Raspberry), então por que não construir seu próprio roteador sem fio de uma vez por todas? <br><a name="habracut"></a><br><a name="1"></a><h1>  Seleção de componentes </h1><br>  Primeiro de tudo, você precisa decidir sobre a plataforma: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">x86</a> ou <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">ARM</a> ?  Não <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">discutirei em detalhes as principais diferenças</a> , mas brevemente: o primeiro tem melhor desempenho, enquanto o segundo é mais barato e mais eficiente em termos de energia.  As placas Raspberry Pi (e equivalentes) são extremamente baratas e provavelmente mais poderosas do que a maioria dos roteadores comerciais sem fio, mas as plataformas x86 são comuns e têm a vantagem de fatores de forma e portas de expansão padronizados. <br><br>  Obviamente, o detalhe mais importante é o chipset.  Hoje, os padrões de fato são <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">802.11n</a> (2.4 GHz) e <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">802.11ac</a> (5 GHz), mas escolher drivers para Linux <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">ainda</a> é <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">um desafio</a> , especialmente com suporte ao modo AP (ponto de acesso).  Em resumo, se você não quer problemas, escolha os chipsets <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Atheros</a> .  Os <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">drivers ath9k</a> e <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">ath10k são</a> bem suportados, você pode encontrá-los facilmente com interfaces USB e / ou mini-PCIe. <br><br>  Pelo menos um NIC (controlador de interface de rede) é o mínimo necessário e escolha RAM e armazenamento ao seu gosto. <br><br><h2>  Lista de materiais </h2><br>  Sacrificando preço e energia, optei pela plataforma x86 por uma configuração modular relativamente poderosa disponível para atualização. <br><br>  <i>Se você não precisar de um ARM, não é necessário um ventilador.</i> <br><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow noopener">Gigabyte GA-J1900N-D3V</a> (J1900 Celeron de 2 GHz e dois núcleos, duas placas de rede) </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow noopener">Airetos AEX-QCA9880-NX</a> (banda dupla 802.11ac, MIMO) </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow noopener">4 GB de RAM</a> (DDR3-LP, 1333 MHz, 1,35 V) </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow noopener">Extensão mPCIe</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow noopener">Chassi mini-ITX MX500</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow noopener">Três antenas de banda dupla 6dBi RP-SMA +</a> cabo <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow noopener">RP-SMA</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow noopener">PicoPSU-90</a> </li><li>  HDD de reposição 2,5 ” </li></ul><br>  A caixa é espaçosa, com dois orifícios preparados para o plugue CA / CC.  A instalação da placa-mãe, RAM e Pico-PSU ocorreu sem problemas: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/7ad/455/84b/7ad45584b277d11fa3f1a7b119759ebc.jpg"><br>  <i><font color="gray">Ferro pornô</font></i> <br><br>  O mais difícil foi instalar o WiFi mini-PCIe, porque a placa suporta apenas placas de tamanho médio: aqui o cabo de extensão mPCIe veio em socorro.  Peguei um cabo FFC de 20 cm (incluído) para conectar os dois lados do adaptador e fixei o mini-PCIe ao chassi usando fita dupla face. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/db1/c7a/8f7/db1c7a8f756c70176d86ce9441d5cf7a.jpg"><img src="https://habrastorage.org/getpro/habr/post_images/5bb/b09/5c7/5bbb095c759ac5cd9be3cf316070ab22.jpg"><br><br><img src="https://habrastorage.org/getpro/habr/post_images/3a4/e91/9b8/3a4e919b817344fdc03d98bb1e9d001f.jpg"><br>  <i><font color="gray">Expansor mini-PCIe</font></i> <br><br>  Felizmente, o chassi vem com três furos de antena pré-cortados.  Aqui está o resultado final: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/967/b65/9d2/967b659d291d3021a9a93f68b4b305b2.jpg"><br><br><img src="https://habrastorage.org/getpro/habr/post_images/c3d/82d/a98/c3d82da9842de641d8d3a4dec3cfe517.jpg"><br><br><a name="2"></a><h1>  De software </h1><br>  É claro que colocamos o Linux.  Dependendo do hardware, pode ser uma distribuição otimizada como <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Raspbian</a> (para o Raspberry Pi) ou qualquer outra distribuição Linux que você desejar.  Como uso o Ubuntu há muitos anos, escolhi o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Ubuntu Server 18.04 LTS</a> , com o qual estou mais acostumado a trabalhar e com quem há suporte a longo prazo. <br><br>  <i>O restante deste artigo assume que você está usando uma distribuição baseada em Debian.</i> <br><br>  Se a instalação foi boa e você foi ao console, defina os nomes da interface: <br><br><pre><code class="bash hljs">$ ip -br a | awk <span class="hljs-string"><span class="hljs-string">'{print $1}'</span></span> lo enp1s0 enp2s0 wlp5s0</code> </pre> <br>  Existem duas placas de rede embutidas na placa-mãe: são <code>enp1s0</code> e <code>enp2s0</code> .  A placa sem fio aparece como <code>wlp5s0</code> e suporta o modo AP, conforme pretendido: <br><br><pre> <code class="bash hljs">$ iw list ... Supported interface modes: * managed * AP * AP/VLAN * monitor * mesh point</code> </pre> <br>  Agora podemos descrever o que precisamos: colocamos a primeira NIC como uma porta WAN e a segunda nos conectamos à interface sem fio: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/5e6/f00/dd4/5e6f00dd4994b5dc252d70dda1d325ec.png"><br><br><h2>  Rede </h2><br>  Se você possui o Ubuntu 18.04, livre-se do <code>netplan</code> imediatamente para retornar ao suporte para / etc / network / interfaces: <br><br><pre> <code class="bash hljs">$ sudo apt-get install ifupdown bridge-utils $ sudo systemctl stop networkd-dispatcher $ sudo systemctl <span class="hljs-built_in"><span class="hljs-built_in">disable</span></span> networkd-dispatcher $ sudo systemctl mask networkd-dispatcher $ sudo apt-get purge nplan netplan.io</code> </pre> <br>  Como servidor DHCP / DNS, selecione <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">dnsmasq</a> : <br><br><pre> <code class="bash hljs">$ sudo apt-get install dnsmasq</code> </pre> <br>  Como iniciaremos e configuraremos o processo <code>dnsmasq</code> através do gancho de <code>post-up</code> , lembre-se de desativar o daemon no momento da inicialização: <br><br><pre> <code class="bash hljs">$ sudo sed -i <span class="hljs-string"><span class="hljs-string">"s/^ENABLED=1$/ENABLED=0/g"</span></span> /etc/default/dnsmasq</code> </pre> <br>  Escreveremos a configuração <b>preliminar</b> das interfaces de rede de acordo com o diagrama, incluindo a configuração mínima do <code>dnsmasq</code> : <br><br><pre> <code class="bash hljs">$ cat /etc/network/interfaces <span class="hljs-comment"><span class="hljs-comment"># Loopback auto lo iface lo inet loopback # WAN interface auto enp1s0 iface enp1s0 inet dhcp # Bridge (LAN) auto br0 iface br0 inet static address 192.168.1.1 network 192.168.1.0 netmask 255.255.255.0 broadcast 192.168.1.255 bridge_ports enp2s0 post-up /usr/sbin/dnsmasq \ --pid-file=/var/run/dnsmasq.$IFACE.pid \ --dhcp-leasefile=/var/lib/misc/dnsmasq.$IFACE.leases \ --conf-file=/dev/null \ --interface=$IFACE --except-interface=lo \ --bind-interfaces \ --dhcp-range=192.168.1.10,192.168.1.150,24h pre-down cat /var/run/dnsmasq.$IFACE.pid | xargs kill</span></span></code> </pre> <br>  <i>A documentação <code>/etc/network/interfaces</code> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">aqui</a></i> <br><br>  Como você pode ver na seção de <code>post-up</code> , o dnsmasq inicia assim que a ponte aumenta.  Sua configuração é realizada apenas por argumentos de linha de comando ( <code>--conf-file=/dev/null</code> ), e o processo será interrompido quando a interface estiver desativada. <br><br>  A interface <code>bridge_ports</code> não está especificada especificamente no <code>wlp5s0</code> , porque o <code>hostapd</code> a adicionará automaticamente à ponte (o brctl pode se recusar a fazer isso antes que o hostapd seja iniciado para alterar o modo da interface). <br><br>  <i>Consulte a <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">documentação do</a> <code>dnsmasq</code> .</i> <br><br>  Agora você pode reiniciar a rede (reinício da rede do <code>sudo service networking restart</code> ) ou simplesmente reiniciar para verificar se a configuração da rede está correta. <br><br>  Observação: embora atualmente possamos receber o DHCP do <code>enp2s0</code> , não teremos <b>conexão sem fio</b> (mais sobre isso mais tarde) <b>ou acesso à Internet</b> (veja abaixo). <br><br><h2>  Encaminhamento </h2><br>  Nesse ponto, você precisa rotear pacotes entre as <code>enp2s0</code> LAN ( <code>enp2s0</code> ) e WAN ( <code>enp1s0</code> ) e ativar <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">a conversão de endereço de rede</a> . <br><br>  É fácil ativar o encaminhamento de pacotes: <br><br><pre> <code class="bash hljs">$ sudo sysctl -w net.ipv4.ip_forward=1 $ <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> <span class="hljs-string"><span class="hljs-string">"net.ipv4.ip_forward=1"</span></span> | sudo tee -a /etc/sysctl.conf</code> </pre> <br>  <i>O último comando garante que a configuração seja salva até a próxima reinicialização.</i> <br><br>  A tradução de endereços de rede é outra questão, geralmente você precisa lidar com (ou melhor, combater) as <code>iptables</code> .  Felizmente, a Idade da Pedra acabou, e os caras do FireHol se esforçaram bastante para adicionar o nível necessário de abstração: <br><br><pre> <code class="bash hljs">$ sudo apt-get install firehol</code> </pre> <br>  FireHOL é uma linguagem de firewall segura de última geração, sua configuração é fácil de entender e acessível.  Você não precisa mais escrever instruções <code>iptables</code> : o próprio arquivo de configuração é convertido em instruções <code>iptables</code> e aplicado conforme necessário.  Nenhum daemon em segundo plano. <br><br>  A habilitação da tradução de endereços de rede para interfaces de LAN com a adição de regras mínimas de firewall é feita elementarmente: <br><br><pre> <code class="bash hljs">$ cat /etc/firehol/firehol.conf version 6 <span class="hljs-comment"><span class="hljs-comment"># Accept all client traffic on WAN interface enp1s0 wan client all accept # Accept all traffic on LAN interface br0 lan server all accept client all accept # Route packets between LAN and WAN router lan2wan inface br0 outface enp1s0 masquerade route all accept</span></span></code> </pre> <br>  <i>FireHOL é escrito por pessoas para pessoas, a documentação está <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">aqui</a> .</i> <br><br>  Você pode verificar as configurações iniciando manualmente o <code>firehol</code> ( <code>sudo firehol start</code> ) e conectando o laptop à porta LAN: <b>agora você pode ficar online</b> se a porta WAN estiver conectada. <br><br>  Antes de reiniciar, <b>certifique-se de</b> editar <code>/etc/default/firehol</code> para permitir que o FireHol inicie na inicialização: <br><br><pre> <code class="bash hljs">$ sudo sed -i -E <span class="hljs-string"><span class="hljs-string">"s/^START_FIREHOL=.+$/START_FIREHOL=YES/g"</span></span> /etc/default/firehol</code> </pre> <br>  <i>Não entrarei em detalhes de toda a sintaxe do <code>firehol</code> , o arquivo de configuração se explica; recomendo <code>firehol</code> a <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">documentação</a> no caso de uma configuração mais complexa.</i>  <i>Se você está realmente interessado no que o <code>firehol</code> fez com o <code>iptables</code> , digite <code>sudo firehol status</code> na linha de comando.</i> <br><br><h2>  Ponto de acesso sem fio </h2><br>  Obviamente, gerenciaremos o ponto de acesso usando o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">hostapd</a> : <br><br><pre> <code class="bash hljs">$ sudo apt-get install hostapd</code> </pre> <br>  Abaixo, você encontrará um arquivo de configuração mínimo e quase inexplicável 802.11 n / 2.4 Ghz / WPA2-AES: <br><br><pre> <code class="bash hljs">$ cat /etc/hostapd/hostapd-simple.conf <span class="hljs-comment"><span class="hljs-comment">#### Interface configuration #### interface=wlp5s0 bridge=br0 driver=nl80211 ##### IEEE 802.11 related configuration ##### ssid=iCanHearYouHavingSex hw_mode=g channel=1 auth_algs=1 wmm_enabled=1 ##### IEEE 802.11n related configuration ##### ieee80211n=1 ##### WPA/IEEE 802.11i configuration ##### wpa=2 wpa_key_mgmt=WPA-PSK rsn_pairwise=CCMP wpa_passphrase=YouCantGuess</span></span></code> </pre> <br>  <i><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Veja</a> <code>hostpad.conf</code> documentação em <code>/usr/share/doc/hostapd/examples/hostapd.conf</code></i> . <br><br>  A configuração descrita pode ser testada manualmente: <br><br><pre> <code class="bash hljs">$ sudo hostapd /etc/hostapd/hostapd-simple.conf</code> </pre> <br>  Se tudo correr bem, uma <b>conexão sem fio será exibida</b> .  Se você estiver satisfeito com o resultado, <b>não esqueça</b> de alterar a configuração para iniciar o <code>hostapd</code> assim que a interface subir (como mostrado abaixo). <br><br>  <b>Aqui está o seu <code>/etc/network/interfaces:</code> final <code>/etc/network/interfaces:</code></b> <br><br><pre> <code class="bash hljs">$ cat /etc/network/interfaces <span class="hljs-comment"><span class="hljs-comment"># Loopback auto lo iface lo inet loopback # WAN interface auto enp1s0 iface enp1s0 inet dhcp # Bridge (LAN) auto br0 iface br0 inet static address 192.168.1.1 network 192.168.1.0 netmask 255.255.255.0 broadcast 192.168.1.255 bridge_ports enp2s0 post-up /usr/sbin/hostapd \ -P /var/run/hostapd.$IFACE.pid \ -B /etc/hostapd/hostapd-simple.conf post-up /usr/sbin/dnsmasq \ --pid-file=/var/run/dnsmasq.$IFACE.pid \ --dhcp-leasefile=/var/lib/misc/dnsmasq.$IFACE.leases \ --conf-file=/dev/null \ --interface=$IFACE --except-interface=lo \ --bind-interfaces \ --dhcp-range=192.168.1.10,192.168.1.150,24h pre-down cat /var/run/dnsmasq.$IFACE.pid | xargs kill pre-down cat /var/run/hostapd.$IFACE.pid | xargs kill</span></span></code> </pre> <br><a name="3"></a><h1>  Configurando um ponto de acesso 802.11ac (5 GHz) </h1><br><h2>  Varredura passiva </h2><br>  De acordo com a documentação <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Airetos AEX-QCA9880-NX</a> , o chipset suporta 802.11ac, para que possamos deixar os canais de 2,4 GHz lotados no paraíso de 5 GHz. <br><br>  Vamos ver quais frequências são suportadas: <br><br><pre> <code class="plaintext hljs">$ iw list ... Frequencies: * 2412 MHz [1] (20.0 dBm) * 2417 MHz [2] (20.0 dBm) * 2422 MHz [3] (20.0 dBm) * 2427 MHz [4] (20.0 dBm) * 2432 MHz [5] (20.0 dBm) * 2437 MHz [6] (20.0 dBm) * 2442 MHz [7] (20.0 dBm) * 2447 MHz [8] (20.0 dBm) * 2452 MHz [9] (20.0 dBm) * 2457 MHz [10] (20.0 dBm) * 2462 MHz [11] (20.0 dBm) * 2467 MHz [12] (disabled) * 2472 MHz [13] (disabled) * 2484 MHz [14] (disabled) ... Frequencies: * 5180 MHz [36] (17.0 dBm) (no IR) * 5200 MHz [40] (17.0 dBm) (no IR) * 5220 MHz [44] (17.0 dBm) (no IR) * 5240 MHz [48] (17.0 dBm) (no IR) * 5260 MHz [52] (23.0 dBm) (no IR, radar detection) * 5280 MHz [56] (23.0 dBm) (no IR, radar detection) * 5300 MHz [60] (23.0 dBm) (no IR, radar detection) * 5320 MHz [64] (23.0 dBm) (no IR, radar detection) * 5500 MHz [100] (23.0 dBm) (no IR, radar detection) * 5520 MHz [104] (23.0 dBm) (no IR, radar detection) * 5540 MHz [108] (23.0 dBm) (no IR, radar detection) * 5560 MHz [112] (23.0 dBm) (no IR, radar detection) * 5580 MHz [116] (23.0 dBm) (no IR, radar detection) * 5600 MHz [120] (23.0 dBm) (no IR, radar detection) * 5620 MHz [124] (23.0 dBm) (no IR, radar detection) * 5640 MHz [128] (23.0 dBm) (no IR, radar detection) * 5660 MHz [132] (23.0 dBm) (no IR, radar detection) * 5680 MHz [136] (23.0 dBm) (no IR, radar detection) * 5700 MHz [140] (23.0 dBm) (no IR, radar detection) * 5720 MHz [144] (23.0 dBm) (no IR, radar detection) * 5745 MHz [149] (30.0 dBm) (no IR) * 5765 MHz [153] (30.0 dBm) (no IR) * 5785 MHz [157] (30.0 dBm) (no IR) * 5805 MHz [161] (30.0 dBm) (no IR) * 5825 MHz [165] (30.0 dBm) (no IR) ...</code> </pre> <br>  Na lista acima, vemos que o chipset suporta os canais 1-14 (2,4 GHz) e os canais 36-165 (5 GHz), mas você notou a sinalização de <code>no IR</code> ? <br><br>  O sinalizador <code>no IR</code> indica <i>radiação não iniciada</i> (isto é, <i>varredura passiva</i> ).  Isso significa que este modo é proibido no caso em que o dispositivo é o primeiro a iniciar radiação (incluindo <b>sinalizadores</b> ).  Em outras palavras, <b>você não pode executar o ponto de acesso nesses canais</b> ! <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/03f/743/e75/03f743e7505714ae9864dcce2b5b4964.gif"></div><br><br><h2>  Requisitos regulatórios </h2><br>  A situação acima é explicada pelos <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">requisitos regulamentares do Linux</a> , que regulam o uso do espectro de radiofrequências, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">dependendo do país</a> . <br><br>  Mas ei! <br><br>  Eu moro nos EUA, e o link diz que tenho o direito de iniciar a radiação nos canais 36-48, então qual é o problema?  Vamos ver qual domínio regulatório está atualmente em uso: <br><br><pre> <code class="plaintext hljs">$ iw reg get country 00: DFS-UNSET (2402 - 2472 @ 40), (N/A, 20), (N/A) (2457 - 2482 @ 40), (N/A, 20), (N/A), NO-IR (2474 - 2494 @ 20), (N/A, 20), (N/A), NO-OFDM, NO-IR (5170 - 5250 @ 80), (N/A, 20), (N/A), NO-IR (5250 - 5330 @ 80), (N/A, 20), (0 ms), DFS, NO-IR (5490 - 5730 @ 160), (N/A, 20), (0 ms), DFS, NO-IR (5735 - 5835 @ 80), (N/A, 20), (N/A), NO-IR (57240 - 63720 @ 2160), (N/A, 0), (N/A)</code> </pre> <br>  O problema mostra que o domínio <i>mundial</i> está atualmente ativo (ou não instalado), ou seja, os <b>valores mínimos permitidos em cada país</b> . <br><br>  Infelizmente, você não pode instalar manualmente o domínio <code>sudo iw reg set</code> , porque o domínio está protegido na EEPROM: <br><br><pre> <code class="plaintext hljs">$ dmesg | grep EEPROM [ 12.123068] ath: EEPROM regdomain: 0x6c</code> </pre> <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/5de/5a9/ae2/5de5a9ae216cf2c3f2f9416b4ffa54bc.gif"></div><br><h2>  Patch! </h2><br>  Felizmente, os requisitos regulatórios são processados ​​no nível do driver, para que possam ser facilmente alterados: encontramos o patch no <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">código-fonte</a> do <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Open-WRT</a> . <br><br>  Antes de tudo, não se esqueça de conectar o repositório de código fonte em <code>/etc/apt/sources.list</code> : <br><br><pre> <code class="bash hljs">$ cat /etc/apt/sources.list ... deb-src http://us.archive.ubuntu.com/ubuntu/ bionic main restricted ...</code> </pre> <br>  Em seguida, prepare o ambiente instalando as dependências necessárias: <br><br><pre> <code class="bash hljs">$ sudo apt-get install build-essential fakeroot $ sudo apt-get build-dep linux</code> </pre> <br>  Faça o download das fontes do seu kernel: <br><br><pre> <code class="bash hljs">$ apt-get <span class="hljs-built_in"><span class="hljs-built_in">source</span></span> linux</code> </pre> <br>  Como o patch <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">original do</a> Open-WRT não pode ser aplicado "como está" na árvore do kernel do Ubuntu devido a diferenças sutis no sistema de compilação, eu tive que corrigi-lo: <br><br><pre> <code class="bash hljs">$ VERSION=$(uname -r) $ <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> linux-<span class="hljs-variable"><span class="hljs-variable">${VERSION%%-*}</span></span> $ wget -O - https://gist.github.com/renaudcerrato/02de8b2e8dc013bc71326defd2ef062c/raw/a2db325e520e6442c8c12f7599d64ac1b7596a3e/402-ath_regd_optional.patch | patch -p1 -b</code> </pre> <br>  Tudo está pronto para montagem: <br><br><pre> <code class="bash hljs">$ fakeroot debian/rules clean $ fakeroot debian/rules binary-generic</code> </pre> <br>  Se não houver problemas, agora você pode instalar o kernel fixo em cima do anterior: <br><br><pre> <code class="bash hljs">$ <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> .. $ sudo dpkg -i linux*.deb</code> </pre> <br>  Reinicialize e pronto: <br><br><pre> <code class="bash hljs">$ sudo iw reg <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> US $ iw list ... Frequencies: * 5180 MHz [36] (17.0 dBm) * 5200 MHz [40] (17.0 dBm) * 5220 MHz [44] (17.0 dBm) * 5240 MHz [48] (17.0 dBm) * 5260 MHz [52] (23.0 dBm) (radar detection) * 5280 MHz [56] (23.0 dBm) (radar detection) * 5300 MHz [60] (23.0 dBm) (radar detection) * 5320 MHz [64] (23.0 dBm) (radar detection) * 5500 MHz [100] (23.0 dBm) (radar detection) * 5520 MHz [104] (23.0 dBm) (radar detection) * 5540 MHz [108] (23.0 dBm) (radar detection) * 5560 MHz [112] (23.0 dBm) (radar detection) * 5580 MHz [116] (23.0 dBm) (radar detection) * 5600 MHz [120] (23.0 dBm) (radar detection) * 5620 MHz [124] (23.0 dBm) (radar detection) * 5640 MHz [128] (23.0 dBm) (radar detection) * 5660 MHz [132] (23.0 dBm) (radar detection) * 5680 MHz [136] (23.0 dBm) (radar detection) * 5700 MHz [140] (23.0 dBm) (radar detection) * 5720 MHz [144] (23.0 dBm) (radar detection) * 5745 MHz [149] (30.0 dBm) * 5765 MHz [153] (30.0 dBm) * 5785 MHz [157] (30.0 dBm) * 5805 MHz [161] (30.0 dBm) * 5825 MHz [165] (30.0 dBm) ...</code> </pre> <br>  <i>Para evitar atualizações automáticas, pode ser necessário <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">corrigir a versão do kernel do Linux</a> .</i> <br><br><h2>  Configuração </h2><br>  O novo <code>hostapd</code> configuração do <code>hostapd</code> será bastante simples: <code>hw_mode=a</code> inclui bandas de 5 GHz e <code>ieee80211ac=1</code> inclui 802.11ac (VHT).  A opção <code>ieee80211d=1</code> com <code>country_code=US</code> especifica o domínio regulatório sob o qual operamos. <br><br>  Para aproveitar ao máximo a largura de banda, <code>ht_capab</code> e <code>vht_capab</code> devem refletir os recursos do equipamento: <br><br><pre> <code class="bash hljs">$ iw list ... Band 1: Capabilities: 0x19e3 RX LDPC HT20/HT40 Static SM Power Save RX HT20 SGI RX HT40 SGI TX STBC RX STBC 1-stream Max AMSDU length: 7935 bytes DSSS/CCK HT40 ... Band 2: VHT Capabilities (0x338001b2): Max MPDU length: 11454 Supported Channel Width: neither 160 nor 80+80 RX LDPC short GI (80 MHz) TX STBC RX antenna pattern consistency TX antenna pattern consistency</code> </pre> <br>  Com isso em mente, <b>aqui está o</b> <code>hostapd.conf</code> <b>final</b> : <br><br><pre> <code class="bash hljs">$ cat /etc/hostapd/hostapd.conf <span class="hljs-comment"><span class="hljs-comment">#### Interface configuration #### interface=wlp5s0 bridge=br0 driver=nl80211 ##### IEEE 802.11 related configuration ##### ssid=iCanHearYouHavingSex hw_mode=a channel=0 auth_algs=1 wmm_enabled=1 country_code=US ieee80211d=1 ieee80211h=0 ##### IEEE 802.11n related configuration ##### ieee80211n=1 ht_capab=[HT40+][SHORT-GI-20][SHORT-GI-40][TX-STBC][RX-STBC1][DSSS_CK-40][LDPC][MAX-AMSDU-7935] ##### IEEE 802.11ac related configuration ##### ieee80211ac=1 vht_capab=[MAX-MPDU-11454][RXLDPC][SHORT-GI-80][TX-STBC-2BY1][RX-STBC-1][MAX-A-MPDU-LEN-EXP7][TX-ANTENNA-PATTERN][RX-ANTENNA-PATTERN] vht_oper_chwidth=1 ##### WPA/IEEE 802.11i configuration ##### wpa=2 wpa_key_mgmt=WPA-PSK rsn_pairwise=CCMP wpa_passphrase=YouCantGuess</span></span></code> </pre> <br>  <i><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Veja</a> <code>hostpad.conf</code> documentação em <code>/usr/share/doc/hostapd/examples/hostapd.conf</code></i> . <br><br>  Nesse ponto, o roteador sem fio está totalmente operacional e, se você precisar de uma configuração mais complexa, poderá agora mergulhar nos arquivos de configuração. <br><br><a name="4"></a><h1>  Configurando um SSID virtual usando o hostapd </h1><br>  Independentemente de você desejar configurar um ponto de acesso de convidado ou uma rede sem fio dedicada para sua VPN, em algum momento você precisará configurar um SSID virtual. <br><br><h2>  Gráfico </h2><br>  Com base na <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">configuração atual</a> , aqui está um diagrama atualizado do que queremos obter.  Supondo que <code>wlp5s0</code> é a interface sem fio física, o SSID virtual será executado na interface virtual <code>wlan0</code> usando sua própria sub-rede <code>192.168.2.0/24</code> : <br><br><img src="https://habrastorage.org/getpro/habr/post_images/096/450/32b/09645032b28e7310ad93b2109efb0860.png"><br><br><h2>  Preparação </h2><br>  Primeiro, verifique se o seu dispositivo sem fio suporta vários SSIDs: <br><br><pre> <code class="bash hljs">$ iw list ... valid interface combinations: * <span class="hljs-comment"><span class="hljs-comment">#{ AP, mesh point } &lt;= 8, total &lt;= 8, #channels &lt;= 1, STA/AP BI must match ...</span></span></code> </pre> <br>  Como você pode ver, o chipset suporta até oito pontos de acesso em um canal.  Isso significa que você pode configurar até sete SSIDs virtuais e todos eles funcionarão no mesmo canal. <br><br><h2>  Interface de rede </h2><br>  De acordo com a documentação em hostapd.conf, há uma conexão estrita entre o endereço MAC da interface física e o BSSID das interfaces virtuais: <br><br><blockquote>  O hostapd irá gerar uma máscara BSSID baseada nos BSSIDs configurados.  <b>O hostapd verificará se dev_addr &amp; MASK == dev_addr</b> .  Se não for esse o caso, o endereço MAC do rádio deve ser alterado antes de iniciar o hostapd.  Se um BSSID estiver configurado para cada BSS secundário, essa limitação não será aplicada no hostapd e outras máscaras poderão ser usadas se o driver as suportar (por exemplo, troque o bit administrado localmente) <br><br>  Os BSSIDs são atribuídos em ordem a cada BSS, a menos que um BSSID explícito seja especificado usando o parâmetro 'bssid'. <br><br>  Se um BSSID explícito for especificado, ele deverá ser escolhido de forma que: <br>  - resulta em uma máscara válida que a cobre e o dev_addr <br>  - não é o mesmo que o endereço MAC do rádio <br>  - não é o mesmo que qualquer outro BSSID explicitamente especificado </blockquote><br>  Para atender a esses requisitos e permitir que o <code>hostapd</code> atribua automaticamente o BSSID da (s) interface (s) virtual (is), atualizamos o endereço MAC da interface física sem fio, zerando os quatro bits menos significativos.  Isso é suficiente para 15 BSSIDs virtuais - muito mais que o necessário. <br><br>  Primeiro, determine o endereço MAC atual: <br><br><pre> <code class="bash hljs">$ ip addr show wlp5s0 | grep link | awk <span class="hljs-string"><span class="hljs-string">'{print $2}'</span></span> 44:c3:06:00:03:eb</code> </pre> <br>  Se você limpar os últimos quatro bits e definir o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">U / L</a> , obterá o endereço MAC <code>46:c3:06:00:03:e0</code> . <br><br>  Agora, atualizaremos a configuração para definir o endereço MAC correto antes de carregar a interface e também declararemos uma interface sem fio virtual de acordo com nosso diagrama: <br><br><pre> <code class="bash hljs">$ cat /etc/network/interfaces ... <span class="hljs-comment"><span class="hljs-comment"># Physical Wireless auto wlp5s0 iface wlp5s0 inet manual pre-up ip link set dev wlp5s0 address 46:c3:06:00:03:e0 # Virtual Wireless allow-hotplug wlan0 iface wlan0 inet static address 192.168.2.1 network 192.168.2.0 netmask 255.255.255.0 broadcast 192.168.2.255 post-up /usr/sbin/dnsmasq \ --pid-file=/var/run/dnsmasq-wlan0.pid \ --conf-file=/dev/null \ --interface=wlan0 --except-interface=lo \ --bind-interfaces \ --dhcp-range=192.168.2.10,192.168.2.150,24h post-down cat /var/run/dnsmasq-wlan0.pid | xargs kill ...</span></span></code> </pre> <br>  Ótimo.  Eu uso o <code>dnsmasq</code> como um servidor DHCP - <code>dnsmasq</code> à vontade para substituir o que quiser.  Observe que, para que a interface virtual funcione corretamente, é necessário o <code>allow-hotplug</code> . <br><br><h2>  Configuração do ponto de acesso </h2><br>  Agora, a coisa mais simples: adicione um SSID virtual à configuração atual do <code>hostapd</code> .  Basta adicionar isso <b>ao final do</b> arquivo <code>hostapd.conf</code> existente: <br><br><pre> <code class="bash hljs">$ cat /etc/hostapd/hostapd.conf ... <span class="hljs-comment"><span class="hljs-comment">### Virtual SSID(s) ### bss=wlan0 ssid=MyVirtualSSID wpa=2 wpa_key_mgmt=WPA-PSK rsn_pairwise=CCMP wpa_passphrase=you_cant_guess</span></span></code> </pre> <br>  No exemplo, usei a criptografia WPA2, mas a maioria das opções de interface de rádio está disponível aqui (por exemplo, <code>channel</code> ).  Você pode adicionar mais SSIDs virtuais simplesmente adicionando as linhas no arquivo de configuração de acordo com as interfaces virtuais declaradas e configuradas corretamente. <br><br>  Agora reinicie - e veja seu novo SSID junto com a nova interface sem fio (preste atenção ao endereço MAC): <br><br><pre> <code class="bash hljs">$ ip addr show wlan0 | grep link | awk <span class="hljs-string"><span class="hljs-string">'{print $2}'</span></span> 46:c3:06:00:03:e1</code> </pre> <br>  <b>É isso aí pessoal!</b> </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt437634/">https://habr.com/ru/post/pt437634/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt437622/index.html">Introdução ao serviço Azure Machine Learning</a></li>
<li><a href="../pt437624/index.html">OpenSceneGraph: Noções básicas de textura</a></li>
<li><a href="../pt437626/index.html">Desempenho da plataforma de negociação com um exemplo simples</a></li>
<li><a href="../pt437630/index.html">Os principais anúncios da Microsoft da conferência BETT</a></li>
<li><a href="../pt437632/index.html">Mash, o básico do idioma</a></li>
<li><a href="../pt437636/index.html">Publicando o aplicativo na Microsoft Store: algumas mudanças para o ano</a></li>
<li><a href="../pt437638/index.html">"Qual é o ponto de resposta?" REVISÃO DO NEONIZADOR. Atmotube e solda</a></li>
<li><a href="../pt437640/index.html">Como as marcas podem romper a bolha da mídia tecnológica</a></li>
<li><a href="../pt437642/index.html">Se as janelas se abrirem, alguém precisará delas</a></li>
<li><a href="../pt437646/index.html">Coisas úteis e não óbvias para uma impressora 3D: pequenas coisas para uma impressora 3D</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>