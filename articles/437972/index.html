<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üõéÔ∏è üëÇüèª üë∂üèæ PHP para principiantes. La sesi√≥n üë®üèΩ‚Äçüî¨ ‚öìÔ∏è üç•</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Que tengas un buen d√≠a. Aqu√≠ est√° el primer art√≠culo de la serie PHP para desarrolladores principiantes. Esta ser√° una serie inusual de art√≠culos, no ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>PHP para principiantes. La sesi√≥n</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/437972/"><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/c0a/389/8cf/c0a3898cf539ad6a3dc7ffb833d9715d.png" alt="ElePHPant. PHP para principiantes. Sesi√≥n"></div><br>  Que tengas un buen d√≠a.  Aqu√≠ est√° el primer art√≠culo de la serie PHP para desarrolladores principiantes.  Esta ser√° una serie inusual de art√≠culos, no habr√° <code>echo "Hello World"</code> , habr√° hardcore de la vida de los programadores de PHP con una peque√±a mezcla de "tarea" para consolidar el material. <br><br>  Comenzar√© con sesiones: este es uno de los componentes m√°s importantes con los que tiene que trabajar.  Sin entender los principios de su trabajo, hacer negocios.  Entonces, para evitar problemas, tratar√© de hablar sobre todos los matices posibles. <br><a name="habracut"></a><br>  Pero para empezar, para comprender por qu√© necesitamos una sesi√≥n, nos dirigimos a los or√≠genes, al protocolo HTTP. <br><br><h3>  Protocolo HTTP </h3><br>  El protocolo HTTP es el Protocolo de transferencia de hipertexto, el "Protocolo de transferencia de hipertexto", es decir  de hecho - un protocolo de texto, y entiendo que no es dif√≠cil. <br><blockquote>  Inicialmente, se entendi√≥ que bajo este protocolo solo se transmitir√° HTML, la direcci√≥n y el nombre, pero ahora simplemente no se enviar√°n y = ^. ^ = Y Ôºà‚Ä¢ _ „ÖÖ _ ‚Ä¢Ôºâ </blockquote><br>  Para no andar por las ramas, d√©jame darte un ejemplo de comunicaci√≥n a trav√©s del protocolo HTTP. <br>  Aqu√≠ hay un ejemplo de la solicitud de env√≠o de su navegador cuando solicita la p√°gina <code>http://example.com</code> : <br><br><pre> <code class="plaintext hljs">GET / HTTP/1.1 Host: example.com Accept: text/html &lt; &gt;</code> </pre> <br>  Y aqu√≠ hay un ejemplo de respuesta: <br><br><pre> <code class="plaintext hljs">HTTP/1.1 200 OK Content-Length: 1983 Content-Type: text/html; charset=utf-8 &lt;html&gt; &lt;head&gt;...&lt;/head&gt; &lt;body&gt;...&lt;/body&gt; &lt;/html&gt;</code> </pre><br>  Estos son ejemplos muy simplificados, pero incluso aqu√≠ puede ver en qu√© consisten la solicitud y la respuesta HTTP: <br><br><ol><li>  <strong>l√≠nea de inicio</strong> - para una solicitud contiene el m√©todo y la ruta de la p√°gina solicitada, para una respuesta - la versi√≥n del protocolo y el c√≥digo de respuesta </li><li>  <strong>encabezados</strong> : tienen un formato de clave-valor separado por dos puntos, cada nuevo encabezado se escribe desde una nueva l√≠nea </li><li>  <strong>cuerpo del mensaje</strong> : ya sea directamente HTML o los datos est√°n separados de los encabezados por dos saltos de l√≠nea, puede estar ausente, como en la solicitud anterior </li></ol><br>  Entonces, de alguna manera descubrimos el protocolo: es simple, ha estado liderando su historia desde 1992, por lo que no lo nombrar√° ideal, pero lo que es, env√≠e una solicitud, obtenga una respuesta, y eso es todo, el servidor y el cliente ya no est√°n conectados.  Pero tal escenario no es el √∫nico posible, podemos tener autorizaci√≥n, el servidor debe entender de alguna manera que esta solicitud proviene de un usuario espec√≠fico, es decir  el cliente y el servidor deben comunicarse dentro de una determinada sesi√≥n.  Y s√≠, se invent√≥ el siguiente mecanismo para esto: <br><br><ol><li>  Cuando un usuario autoriza, el servidor genera y recuerda una clave √∫nica: el identificador de sesi√≥n, y lo informa al navegador </li><li>  El navegador guarda esta clave y, con cada solicitud posterior, env√≠a </li></ol><br>  Para implementar este mecanismo, se crearon cookies (cookies, cookies): archivos de texto simples en su computadora, por archivo para cada dominio (aunque algunos navegadores son m√°s avanzados y usan una base de datos SQLite para almacenar), mientras que el navegador impone un l√≠mite en la cantidad de registros y el tama√±o de los datos almacenados (para la mayor√≠a de los navegadores esto es 4096 bytes, ver <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">RFC 2109</a> de 1997) <br><blockquote>  Es decir  Si robas una cookie de tu navegador, ¬øpuedes ir a tu p√°gina de Facebook en tu nombre?  No se alarme, esto no se puede hacer, al menos con Facebook, y luego le mostrar√© una de las posibles formas de protegerse contra este tipo de ataque a sus usuarios. </blockquote><br>  Ahora veamos c√≥mo cambia nuestra solicitud-respuesta, est√© all√≠ la autorizaci√≥n: <br><br>  <b>Solicitud</b> <br><pre> <code class="plaintext hljs">POST /login/ HTTP/1.1 Host: example.com Accept: text/html login=Username&amp;password=Userpass</code> </pre> <br><br>  Nuestro m√©todo ha cambiado a POST, y el nombre de usuario y la contrase√±a se transmiten en el cuerpo de la solicitud.  Si utiliza el m√©todo GET, la cadena de consulta contendr√° un nombre de usuario y una contrase√±a, lo cual no es muy correcto desde un punto de vista ideol√≥gico, y tiene una serie de efectos secundarios en forma de registro (por ejemplo, en el mismo <code>access.log</code> ) y el almacenamiento en cach√© de contrase√±as en forma clara. <br><br>  <b>Respuesta</b> <br><pre> <code class="plaintext hljs">HTTP/1.1 200 OK Content-Type: text/html; charset=utf-8 Set-Cookie: KEY=VerySecretUniqueKey &lt;html&gt; &lt;head&gt;...&lt;/head&gt; &lt;body&gt;...&lt;/body&gt; &lt;/html&gt;</code> </pre> <br>  La respuesta del servidor contendr√° el encabezado <code>Set-Cookie: KEY=VerySecretUniqueKey</code> , lo que obligar√° al navegador a guardar estos datos en cookies, y la pr√≥xima vez que acceda al servidor, ser√° enviado y reconocido por el servidor: <br><br>  <b>Solicitud</b> <br><pre> <code class="plaintext hljs">GET / HTTP/1.1 Host: example.com Accept: text/html Cookie: KEY=VerySecretUniqueKey &lt; &gt;</code> </pre> <br><blockquote>  Como puede ver, los encabezados enviados por el navegador (encabezados de solicitud) y el servidor (encabezados de respuesta) son diferentes, aunque son comunes tanto para las solicitudes como para las respuestas (encabezados generales) </blockquote><br>  El servidor reconoci√≥ a nuestro usuario por la cookie enviada y adem√°s le proporcionar√° acceso a informaci√≥n personal.  Entonces, bueno, con sesiones y HTTP resueltos, ahora puede volver a PHP y sus caracter√≠sticas. <br><br><h3>  PHP y sesi√≥n </h3><br><blockquote>  Espero que ya tengas PHP instalado en tu computadora, como  Adem√°s, dar√© ejemplos, y deber√°n ejecutarse </blockquote><br>  El lenguaje PHP fue creado para que coincida con el protocolo HTTP, es decir  Su tarea principal es dar una respuesta a la solicitud HTTP y "morir" liberando memoria y recursos.  Por lo tanto, el mecanismo de sesi√≥n no funciona en PHP en modo autom√°tico, sino en modo manual, y necesita saber a qu√© llamar y en qu√© orden. <br><blockquote>  Aqu√≠ tiene un art√≠culo sobre el tema que <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">PHP est√° destinado a morir</a> , o aqu√≠ est√° <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">en ruso</a> , pero es mejor ponerlo en los marcadores "para m√°s adelante". </blockquote><br>  En primer lugar, debe "iniciar" la sesi√≥n; para esto utilizamos la funci√≥n <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">session_start ()</a> , cree un archivo <em>session.start.php</em> con el siguiente contenido: <br><br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> session_start();</code> </pre> <br>  Ejecute el <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">servidor web</a> PHP <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">integrado</a> en la carpeta con su script: <br><br><pre> <code class="bash hljs">php -S 127.0.0.1:8080</code> </pre> <br>  Inicie el navegador y abra las Herramientas para desarrolladores (o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">lo que sea</a> ), luego vaya a la p√°gina <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">http://127.0.0.1:8080/session.start.php</a> ; deber√≠a ver solo una p√°gina en blanco, pero no se apresure a cerrarla. a los encabezados que nos envi√≥ el servidor: <br><br> <a href="" rel="attachment"><img src="https://habrastorage.org/getpro/habr/post_images/3e8/b2d/145/3e8b2d145c8f29ce0fe30664dcc36119.png" alt="Galleta" width="460" height="222"></a> <br><br>  Habr√° muchas cosas, solo estamos interesados ‚Äã‚Äãen esta l√≠nea en la respuesta del servidor (limpia las cookies, si no hay esa l√≠nea, y actualiza la p√°gina): <br><br><pre> <code class="plaintext hljs">Set-Cookie: PHPSESSID=dap83arr6r3b56e0q7t5i0qf91; path=/</code> </pre> <br>  Al ver esto, el navegador guardar√° una cookie llamada `PHPSESSID`: <br><br> <a href="" rel="attachment wp-att-2816"><img src="https://habrastorage.org/getpro/habr/post_images/f06/d02/09e/f06d0209e68ccac4b99570758c23a2ad.png" alt="Cookie de sesi√≥n del navegador" width="460" height="410"></a> <br><br><blockquote>  <code>PHPSESSID</code> : el nombre de sesi√≥n predeterminado, se ajusta desde la configuraci√≥n de php.ini con la directiva <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">session.name</a> , si es necesario, el nombre se puede cambiar en el archivo de configuraci√≥n o utilizando la funci√≥n <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">session_name ()</a> </blockquote><br>  Y ahora: actualizamos la p√°gina y vemos que el navegador env√≠a esta cookie al servidor, puede intentar actualizar la p√°gina un par de veces, el resultado ser√° id√©ntico: <br><br> <a href="" rel="attachment wp-att-2817"><img src="https://habrastorage.org/getpro/habr/post_images/272/4e6/001/2724e60013b929e3e9e7f1bfa9212ef1.png" alt="Solicitud de navegador con cookie" width="460" height="87"></a> <br><br>  El total que tenemos: la teor√≠a coincidi√≥ con la pr√°ctica, y esto est√° bien. <br><br>  El siguiente paso es guardar un valor arbitrario en la sesi√≥n, para esto, la variable s√∫per global <code>$_SESSION</code> usa en PHP, <code>$_SESSION</code> la hora actual; para hacerlo, llame a la funci√≥n <a href="">date ()</a> : <br><br><pre> <code class="php hljs">session_start(); $_SESSION[<span class="hljs-string"><span class="hljs-string">'time'</span></span>] = date(<span class="hljs-string"><span class="hljs-string">"H:i:s"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">echo</span></span> $_SESSION[<span class="hljs-string"><span class="hljs-string">'time'</span></span>];</code> </pre> <br>  Actualizamos la p√°gina y vemos la hora del servidor, la actualizamos nuevamente, y la hora se ha actualizado.  Ahora asegur√©monos de que el tiempo establecido no cambie con cada actualizaci√≥n de p√°gina: <br><br><pre> <code class="php hljs">session_start(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!<span class="hljs-keyword"><span class="hljs-keyword">isset</span></span>($_SESSION[<span class="hljs-string"><span class="hljs-string">'time'</span></span>])) { $_SESSION[<span class="hljs-string"><span class="hljs-string">'time'</span></span>] = date(<span class="hljs-string"><span class="hljs-string">"H:i:s"</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">echo</span></span> $_SESSION[<span class="hljs-string"><span class="hljs-string">'time'</span></span>];</code> </pre> <br>  Actualizamos: el tiempo no cambia, lo que se necesita.  Pero al mismo tiempo, recordamos que PHP est√° muriendo, lo que significa que almacena esta sesi√≥n en alg√∫n lugar, y encontraremos este lugar ... <br><br><h3>  Todo secreto queda claro </h3><br>  De forma predeterminada, PHP almacena la sesi√≥n en archivos; la directiva <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">session.save_handler</a> es responsable de esto, busca la ruta a lo largo de la cual se guardan los archivos en la directiva <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">session.save_path</a> o usa la funci√≥n <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">session_save_path ()</a> para obtener la ruta necesaria. <br><blockquote>  En su configuraci√≥n, es posible que no se especifique la ruta a los archivos, luego los archivos de sesi√≥n se almacenar√°n en archivos temporales de su sistema; llame a la funci√≥n <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">sys_get_temp_dir ()</a> y descubra d√≥nde est√° este lugar oculto. </blockquote><br>  Entonces, seguimos este camino y encontramos su archivo de sesi√≥n (tengo este archivo <code>sess_dap83arr6r3b56e0q7t5i0qf91</code> ), lo abrimos en un editor de texto: <br><br><pre> <code class="bash hljs">time|s:8:<span class="hljs-string"><span class="hljs-string">"16:19:51"</span></span>;</code> </pre> <br>  Como puede ver, aqu√≠ es nuestro momento, este es el formato complicado en el que se almacena nuestra sesi√≥n, pero podemos hacer cambios, cambiar el tiempo o simplemente podemos ingresar cualquier l√≠nea, por qu√© no: <br><br><pre> <code class="bash hljs">time|s:13:<span class="hljs-string"><span class="hljs-string">"\m/ (@.@) \m/"</span></span>;</code> </pre> <br>  Para convertir esta cadena en una matriz, debe usar la funci√≥n <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">session_decode ()</a> , para la conversi√≥n inversa - <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">session_encode ()</a> - esto se llama serializaci√≥n, solo en PHP para sesiones - es su propio - especial, aunque puede usar la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">serializaci√≥n PHP</a> est√°ndar - escriba en la directiva de configuraci√≥n de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">sesi√≥n El</a> valor de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">.serialize_handler</a> es <code>php_serialize</code> y estar√° contento, y <code>$_SESSION</code> puede usarse sin restricciones; ahora puede usar n√∫meros y caracteres especiales como √≠ndice <code>|</code>  y <code>!</code>  en el nombre (para los m√°s de 10 a√±os de trabajo, nunca tuve que :) <br><br><div class="spoiler">  <b class="spoiler_title">Tarea</b> <div class="spoiler_text">  Escriba su funci√≥n, similar en funci√≥n a <code>session_decode()</code> , aqu√≠ tiene un conjunto de datos de prueba para la sesi√≥n (no es necesario para resolver el conocimiento de expresiones regulares), tome el texto para la conversi√≥n del archivo de su sesi√≥n actual: <br><br><pre> <code class="php hljs">$_SESSION[<span class="hljs-string"><span class="hljs-string">'integer var'</span></span>] = <span class="hljs-number"><span class="hljs-number">123</span></span>; $_SESSION[<span class="hljs-string"><span class="hljs-string">'float var'</span></span>] = <span class="hljs-number"><span class="hljs-number">1.23</span></span>; $_SESSION[<span class="hljs-string"><span class="hljs-string">'octal var'</span></span>] = <span class="hljs-number"><span class="hljs-number">0x123</span></span>; $_SESSION[<span class="hljs-string"><span class="hljs-string">'string var'</span></span>] = <span class="hljs-string"><span class="hljs-string">"Hello world"</span></span>; $_SESSION[<span class="hljs-string"><span class="hljs-string">'array var'</span></span>] = <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>(<span class="hljs-string"><span class="hljs-string">'one'</span></span>, <span class="hljs-string"><span class="hljs-string">'two'</span></span>, [<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-number"><span class="hljs-number">2</span></span>,<span class="hljs-number"><span class="hljs-number">3</span></span>]); $object = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> stdClass(); $object-&gt;foo = <span class="hljs-string"><span class="hljs-string">'bar'</span></span>; $object-&gt;arr = <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>(<span class="hljs-string"><span class="hljs-string">'hello'</span></span>, <span class="hljs-string"><span class="hljs-string">'world'</span></span>); $_SESSION[<span class="hljs-string"><span class="hljs-string">'object var'</span></span>] = $object; $_SESSION[<span class="hljs-string"><span class="hljs-string">'integer again'</span></span>] = <span class="hljs-number"><span class="hljs-number">42</span></span>;</code> </pre> <br></div></div><br>  Entonces, ¬øqu√© no hemos probado todav√≠a?  As√≠ es: para robar cookies, iniciemos otro navegador y agreguemos las mismas cookies.  Para esto escrib√≠ un javascript simple para usted, c√≥pielo en la consola del navegador y ejec√∫telo, solo recuerde cambiar el identificador de sesi√≥n a su cuenta: <br><br><pre> <code class="javascript hljs">javascript:(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span>{<span class="hljs-built_in"><span class="hljs-built_in">document</span></span>.cookie=<span class="hljs-string"><span class="hljs-string">'PHPSESSID=dap83arr6r3b56e0q7t5i0qf91;path=/;'</span></span>;<span class="hljs-built_in"><span class="hljs-built_in">window</span></span>.location.reload();})()</code> </pre> <br>  Ahora ambos navegadores miran la misma sesi√≥n.  Mencion√© anteriormente que hablar√© sobre m√©todos de protecci√≥n, consideremos la forma m√°s simple: vincularemos la sesi√≥n al navegador, m√°s precisamente, a c√≥mo se ve el navegador en el servidor; recordaremos al <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Agente de usuario</a> y lo comprobaremos cada vez: <br><br><pre> <code class="php hljs">session_start(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!<span class="hljs-keyword"><span class="hljs-keyword">isset</span></span>($_SESSION[<span class="hljs-string"><span class="hljs-string">'time'</span></span>])) { $_SESSION[<span class="hljs-string"><span class="hljs-string">'ua'</span></span>] = $_SERVER[<span class="hljs-string"><span class="hljs-string">'HTTP_USER_AGENT'</span></span>]; $_SESSION[<span class="hljs-string"><span class="hljs-string">'time'</span></span>] = date(<span class="hljs-string"><span class="hljs-string">"H:i:s"</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($_SESSION[<span class="hljs-string"><span class="hljs-string">'ua'</span></span>] != $_SERVER[<span class="hljs-string"><span class="hljs-string">'HTTP_USER_AGENT'</span></span>]) { <span class="hljs-keyword"><span class="hljs-keyword">die</span></span>(<span class="hljs-string"><span class="hljs-string">'Wrong browser'</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">echo</span></span> $_SESSION[<span class="hljs-string"><span class="hljs-string">'time'</span></span>];</code> </pre> <br>  Es m√°s dif√≠cil fingir, pero a√∫n es posible, agregue el ahorro y la comprobaci√≥n <code>$_SERVER['REMOTE_ADDR']</code> y <code>$_SERVER['HTTP_X_FORWARDED_FOR']</code> , y esto se ver√° m√°s o menos como protecci√≥n contra intrusos que invaden nuestras cookies. <br><br><blockquote>  La palabra clave en el p√°rrafo anterior <b>parece que las</b> cookies se han estado ejecutando sobre el protocolo HTTPS en proyectos reales durante mucho tiempo, por lo que nadie puede robarlas sin acceso f√≠sico a su computadora o tel√©fono inteligente </blockquote><br><br>  Vale la pena mencionar la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=http://php.net/session.configuration.php&amp;usg=ALkJrhjhls_b7qkr62E2p1iHBBVU9NIGnw#ini.session.cookie-">directiva session.cookie-httponly</a> , gracias a ella la cookie de sesi√≥n ser√° inaccesible desde JavaScript.  Adem√°s, si mira el manual de funciones <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">setcookie ()</a> , notar√° que el √∫ltimo par√°metro tambi√©n es responsable de HttpOnly.  Recuerde esto: esta configuraci√≥n le permite lidiar efectivamente con ataques XSS en casi <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">todos los navegadores</a> . <br><br><div class="spoiler">  <b class="spoiler_title">Tarea</b> <div class="spoiler_text">  Agregue un cheque a la IP del usuario en el c√≥digo; si el cheque falla, elimine la sesi√≥n comprometida. <br></div></div><br><h3>  Paso a paso </h3><br>  Y ahora explicar√© en pasos el algoritmo de c√≥mo funciona una sesi√≥n en PHP, usando el siguiente c√≥digo como ejemplo (configuraci√≥n predeterminada): <br><br><pre> <code class="php hljs">session_start(); $_SESSION[<span class="hljs-string"><span class="hljs-string">'id'</span></span>] = <span class="hljs-number"><span class="hljs-number">42</span></span>;</code> </pre> <br><ol><li>  despu√©s de llamar a <code>session_start()</code> PHP busca en la cookie el identificador de sesi√≥n por el nombre especificado en <code>session.name</code> - esto es <code>PHPSESSID</code> </li><li>  si no hay un identificador, se crea (consulte <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">session_id ()</a> ) y crea un archivo de sesi√≥n vac√≠o a lo largo de la ruta <code>session.save_path</code> con el nombre <code>sess_{session_id()}</code> , se agregar√°n encabezados a la respuesta del servidor para configurar la cookie <code>{session_name()}={session_id()}</code> </li><li>  si el identificador est√° presente, busque el archivo de sesi√≥n en la carpeta <code>session.save_path</code> : <br><ul><li>  no lo encontramos: creamos un archivo vac√≠o con el nombre <code>sess_{$_COOKIE[session_name()]}</code> (el identificador puede contener solo caracteres de los rangos <code>az</code> , <code>AZ</code> , <code>0-9</code> , una coma y un signo menos) </li><li>  encuentre, lea el archivo y desempaquete los datos (vea <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">session_decode ()</a> ) en la variable s√∫per global <code>$_SESSION</code> (el archivo est√° bloqueado para lectura / escritura) </li></ul></li><li>  cuando el script ha finalizado su trabajo, todos los datos de <code>$_SESSION</code> empaquetan usando <code>session_encode()</code> en un archivo a lo largo de la ruta <code>sess_{session_id()}</code> llamado <code>sess_{session_id()}</code> (se libera el bloqueo) </li></ol><br><div class="spoiler">  <b class="spoiler_title">Tarea</b> <div class="spoiler_text">  Configure en su navegador un valor de cookie arbitrario con el nombre <code>PHPSESSID</code> , deje que sea <code>1234567890</code> , actualice la p√°gina, verifique que haya creado un nuevo archivo <code>sess_1234567890</code> <br></div></div><br><h3>  ¬øHay vida sin galletas? </h3><br>  PHP puede funcionar con la sesi√≥n incluso si las cookies est√°n deshabilitadas en el navegador, pero todas las URL del sitio contendr√°n un par√°metro con el identificador de su sesi√≥n, y s√≠, ¬øa√∫n necesita configurar esto, pero lo necesita?  No tuve que usarlo, pero si realmente quiero, solo dir√© d√≥nde cavar: <br><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">session.use_cookies</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">session.use_only_cookies</a> </li></ul><br><h3>  ¬øY si necesita almacenar una sesi√≥n en una base de datos? </h3><br>  Para almacenar una sesi√≥n en la base de datos, deber√° cambiar el almac√©n de la sesi√≥n y decirle a PHP c√≥mo usarla. Para este prop√≥sito, se han creado la interfaz <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">SessionHandlerInterface</a> y la funci√≥n <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">session_set_save_handler</a> . <br><blockquote>  Por separado, noto que no necesita escribir sus propios controladores de sesi√≥n para redis y memcache: cuando instala estas extensiones, los controladores correspondientes tambi√©n van con ellas, por lo que RTFM lo es todo.  Bueno y s√≠, el controlador debe especificarse antes de llamar a <code>session_start()</code> ;) </blockquote><br><div class="spoiler">  <b class="spoiler_title">Tarea</b> <div class="spoiler_text">  Implemente <code>SessionHandlerInterface</code> para almacenar la sesi√≥n en MySQL, verifique si funciona. <br>  Esta es una tarea de asterisco para aquellos que ya se han familiarizado con las bases de datos. <br></div></div><br><br><h3>  ¬øCu√°ndo muere la sesi√≥n? </h3><br>  La directiva <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">session.gc_maxlifetime</a> es responsable de la duraci√≥n de una sesi√≥n.  Por defecto, esta directiva es igual a 1440 segundos (24 minutos), debe entenderse de modo que si no se ha accedido a la sesi√≥n durante un tiempo espec√≠fico, la sesi√≥n se considerar√° "podrida" y esperar√° su turno para eliminarla. <br><br>  Otra pregunta es interesante, ¬øpuede preguntarle a los desarrolladores maduros? ¬øCu√°ndo elimina PHP los archivos de las sesiones caducadas?  La respuesta est√° en la gu√≠a oficial, pero no expl√≠citamente, as√≠ que recuerde: <br><br>  La recolecci√≥n de basura se puede iniciar cuando se llama a la funci√≥n <code>session_start()</code> , la probabilidad de inicio depende de dos directivas <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">session.gc_probability</a> y <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">session.gc_divisor</a> , la primera act√∫a como un dividendo, la segunda act√∫a como un divisor y, por defecto, estos valores son 1 y 100, etc. e.  La probabilidad de que se inicie el recopilador y se eliminen los archivos de sesi√≥n es aproximadamente del 1%. <br><br><div class="spoiler">  <b class="spoiler_title">Tarea</b> <div class="spoiler_text">  Cambie el valor de la directiva <code>session.gc_divisor</code> para que el recolector de basura se inicie cada vez, verifique que esto suceda. <br></div></div><br><br><h3>  El error mas trivial </h3><br>  Un error con m√°s de medio mill√≥n de resultados en los resultados de Google: <br><br><blockquote>  No se puede enviar la cookie de sesi√≥n: los <strong>encabezados ya enviados</strong> por <br>  No se puede enviar el limitador de cach√© de sesi√≥n: los <strong>encabezados ya se enviaron</strong> </blockquote><br>  Para obtener uno, cree un archivo <em>session.error.php</em> con el siguiente contenido: <br><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">echo</span></span> str_pad(<span class="hljs-string"><span class="hljs-string">' '</span></span>, ini_get(<span class="hljs-string"><span class="hljs-string">'output_buffering'</span></span>)); session_start();</code> </pre> <br><blockquote>  En la segunda l√≠nea, una extra√±a "magia" es un foco con un b√∫fer de salida, hablar√© de ello en uno de los siguientes art√≠culos, hasta ahora considero que esto es solo una cadena con una longitud de 4096 caracteres, en este caso son todos espacios </blockquote><br>  Comience eliminando la cookie de antemano y obtendr√° los errores anteriores, aunque el texto del error es diferente, pero la esencia es la misma: el tren se fue: el servidor ya ha enviado el contenido de la p√°gina al navegador y es demasiado tarde para enviar los encabezados, esto no funcionar√° en las cookies y el identificador de sesi√≥n apreciado no aparece en las cookies.  Si se encuentra con este error, busque un lugar donde el texto se muestre antes de tiempo, puede ser un espacio antes de los caracteres <code>&lt;?php</code> o after <code>?&gt;</code> En uno de los archivos conectados, y bueno, si es un espacio, puede haber alg√∫n hilo que no sea imprimible como <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">BOM</a> , as√≠ que ten cuidado, y esta infecci√≥n no te afectar√° (despu√©s de todo ... risas hom√©ricas). <br><br><div class="spoiler">  <b class="spoiler_title">Tarea</b> <div class="spoiler_text">  Para probar este conocimiento, quiero que implemente su propio mecanismo de sesi√≥n y haga que el c√≥digo anterior funcione: <br><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">require_once</span></span> <span class="hljs-string"><span class="hljs-string">'include/sess.php'</span></span>; sess_start(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">isset</span></span>($_SESS[<span class="hljs-string"><span class="hljs-string">"id"</span></span>])) { <span class="hljs-keyword"><span class="hljs-keyword">echo</span></span> $_SESS[<span class="hljs-string"><span class="hljs-string">"id"</span></span>]; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { $_SESS[<span class="hljs-string"><span class="hljs-string">"id"</span></span>] = <span class="hljs-number"><span class="hljs-number">42</span></span>; }</code> </pre> <br><blockquote>  Para implementar su plan, necesitar√° la funci√≥n <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">register_shutdown_function ()</a> </blockquote><br></div></div><br><br><h3>  Cerradura </h3><br>  Otro error com√∫n entre los principiantes es un intento de leer el archivo de sesi√≥n mientras est√° bloqueado por otro script.  En realidad, esto no es un error, es un malentendido del principio de bloqueo :) <br><br>  Pero volvamos a seguir los pasos: <br><br><ol><li>  <code>session_start()</code> no solo crea / lee un archivo, sino que tambi√©n lo bloquea para que nadie pueda hacer cambios en el momento en que se ejecuta el script o leer datos no consistentes del archivo de sesi√≥n </li><li>  el bloqueo se libera al final del gui√≥n </li></ol><br><br>  "Pegarse" en este error es muy f√°cil, cree dos archivos: <br><br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">// start.php session_start(); echo "OK";</span></span></code> </pre><br><br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">// lock.php session_start(); sleep(10); echo "OK";</span></span></code> </pre><br><br>  Ahora, si abre la p√°gina <code>lock.php</code> en el navegador y luego abre <code>start.php</code> en una nueva pesta√±a, ver√° que la segunda p√°gina solo se abrir√° despu√©s de que se haya ejecutado el primer script, que bloquea el archivo de sesi√≥n durante 10 segundos. <br><br>  Hay un par de opciones para evitar este fen√≥meno: "torpe" y "reflexivo". <br><br>  <b>"Hacha"</b> <br>  Utilice un controlador de sesi√≥n personalizado en el que "olvidar" para implementar el bloqueo :) <br>  Una opci√≥n un poco mejor es tomar una lista y deshabilitar el bloqueo (por ejemplo, memcached tiene esa opci√≥n: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">memcached.sess_locking</a> ) O_o <br>  Pase horas depurando el c√≥digo en busca de un error emergente raro ... <br><br>  <b>"Pensativo"</b> <br>  ¬øCu√°l es la mejor manera? Para controlar la sesi√≥n, bloquee usted mismo y elim√≠nela cuando no sea necesario: <br><br>  - Si est√° seguro de que no necesita realizar cambios en los datos de la sesi√≥n, use la opci√≥n <code>read_and_close</code> al iniciar la sesi√≥n: <br><br><pre> <code class="php hljs">session_start([ <span class="hljs-string"><span class="hljs-string">'read_and_close'</span></span> =&gt; <span class="hljs-keyword"><span class="hljs-keyword">true</span></span> ]);</code> </pre><br><br>  Por lo tanto, el bloqueo se liberar√° inmediatamente despu√©s de leer los datos de la sesi√≥n. <br><br>  - Si a√∫n necesita realizar cambios en la sesi√≥n, luego de hacerlos cerrar la sesi√≥n desde la grabaci√≥n: <br><br><pre> <code class="php hljs">session_start(); <span class="hljs-comment"><span class="hljs-comment">// some changes session_write_close();</span></span></code> </pre><br><br><div class="spoiler">  <b class="spoiler_title">Tarea</b> <div class="spoiler_text">  La lista de los dos archivos <code>start.php</code> y <code>lock.php</code> fue un poco m√°s alta. Cree m√°s archivos <code>read-close.php</code> y <code>write-close.php</code> , en los que controlar√° el bloqueo de las formas enumeradas.  Compruebe c√≥mo funciona el bloqueo (o no funciona). <br></div></div><br><br><h3>  En conclusi√≥n </h3><br>  En este art√≠culo, se le han asignado siete tareas, mientras que se refieren no solo al trabajo con <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">sesiones</a> , sino tambi√©n a presentarle <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">MySQL</a> y <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">funciones de cadena</a> .  Para la asimilaci√≥n de este material, no necesita un art√≠culo separado, solo el manual en los enlaces provistos es suficiente, nadie lo leer√° por usted.  ¬°A por ello! <br><br>  <b>PD:</b> si aprendiste algo nuevo del art√≠culo, gracias al autor, comp√°rtelo en las redes sociales;) <br>  <b>PPS</b> S√≠, este es un art√≠culo cruzado de mi <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">blog</a> , pero sigue siendo relevante :) <br><br>  <b>Una serie de art√≠culos "PHP para principiantes":</b> <br><br><ul><li>  <b>La sesi√≥n</b> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Conexi√≥n de archivo</a> </li></ul></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/437972/">https://habr.com/ru/post/437972/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../437958/index.html">Autorizaci√≥n en ESIA en un servidor de terminal con firma digital de acuerdo con GOST-2012</a></li>
<li><a href="../437960/index.html">Asesoramiento del director t√©cnico de una empresa de TI para graduados de bootcamp</a></li>
<li><a href="../437962/index.html">PVS-Studio ROI</a></li>
<li><a href="../437964/index.html">Libro "Machine Learning y TensorFlow"</a></li>
<li><a href="../437968/index.html">PVS-Studio ROI</a></li>
<li><a href="../437974/index.html">¬øC√≥mo ganar WorldSkills digitales? En un ejemplo pr√°ctico</a></li>
<li><a href="../437976/index.html">"Vkontakte" permiti√≥ ocultar registros individuales de la polic√≠a</a></li>
<li><a href="../437978/index.html">Bienvenido a SphinxSearch-meetup SuperJob</a></li>
<li><a href="../437980/index.html">Abrir el seminario web "M√©todo de prueba por pares en la prueba de recuadro negro"</a></li>
<li><a href="../437982/index.html">El nuevo ataque de cifrado de Shade apunta a usuarios comerciales rusos</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>