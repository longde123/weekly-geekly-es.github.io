<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë∞üèº üôÜüèΩ ‚õé Sortir des r√©seaux Tarantool. Synchronisation des n≈ìuds lors du filtrage du trafic üêû üìú üëÇ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Variti est sp√©cialis√© dans la protection contre les bots et les attaques DDoS, et effectue √©galement des tests de stress et de charge. √âtant donn√© que...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Sortir des r√©seaux Tarantool. Synchronisation des n≈ìuds lors du filtrage du trafic</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/variti/blog/459264/"><img src="https://habrastorage.org/getpro/habr/post_images/479/4d3/c95/4794d3c95e7b9d2fe9155a3083f674eb.jpg" alt="image"><br><br>  <i>Variti est sp√©cialis√© dans la protection contre les bots et les attaques DDoS, et effectue √©galement des tests de stress et de charge.</i>  <i>√âtant donn√© que nous travaillons en tant que service international, il est extr√™mement important pour nous d'assurer un √©change ininterrompu d'informations entre les serveurs et les clusters en temps r√©el.</i>  <i>Lors de la conf√©rence de Saint HighLoad ++ 2019, le d√©veloppeur de Variti, Anton Barabanov, a expliqu√© comment nous utilisons UDP et Tarantool, pourquoi nous avons pris un tel groupe et comment nous avons d√ª r√©√©crire le module Tarantool de Lua √† C.</i> <br><br>  Vous pouvez √©galement lire le <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">r√©sum√© du</a> rapport <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">via le</a> lien, et voir la vid√©o ci-dessous sous le spoiler. <br><br><div class="spoiler">  <b class="spoiler_title">Signaler la vid√©o</b> <div class="spoiler_text"><iframe width="560" height="315" src="https://www.youtube.com/embed/R0-POaXC0lI" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br></div></div><br>  Lorsque nous avons commenc√© √† cr√©er un service de filtrage du trafic, nous avons imm√©diatement d√©cid√© de ne pas traiter le transit IP, mais de prot√©ger HTTP, l'API et les services de jeux.  Ainsi, nous terminons le trafic au niveau L7 dans le protocole TCP et le transmettons.  La protection sur L3 et 4 en m√™me temps se produit automatiquement.  Le diagramme ci-dessous montre le diagramme de service: les demandes des personnes passent par un cluster, c'est-√†-dire que les serveurs et les √©quipements r√©seau et les robots (repr√©sent√©s comme des fant√¥mes) sont filtr√©s. <br><br><img src="https://habrastorage.org/webt/g0/eg/qd/g0egqdye_eghswvgjsdpkek9cda.jpeg"><br><br>  Pour le filtrage, il est n√©cessaire de diviser le trafic en requ√™tes distinctes, d'analyser la session avec pr√©cision et rapidit√©, et comme nous ne bloquons pas par les adresses IP, d√©finissez les bots et les personnes √† l'int√©rieur de la connexion √† partir de la m√™me adresse IP. <a name="habracut"></a><br><br><h4>  Que se passe-t-il √† l'int√©rieur du cluster </h4><br>  √Ä l'int√©rieur du cluster, nous avons des n≈ìuds de filtre ind√©pendants, c'est-√†-dire que chaque n≈ìud fonctionne seul et uniquement avec son propre trafic.  Le trafic est r√©parti de mani√®re al√©atoire entre les n≈ìuds: si, par exemple, 10 connexions sont re√ßues d'un utilisateur, elles divergent toutes sur des serveurs diff√©rents. <br><br>  Nous avons des exigences de performance tr√®s strictes car nos clients sont situ√©s dans diff√©rents pays.  Et si, par exemple, un internaute suisse visite un site fran√ßais, il est d√©j√† confront√© √† 15 millisecondes de retard sur le r√©seau en raison d'une augmentation de la circulation.  Par cons√©quent, nous ne sommes pas autoris√©s √† ajouter 15 √† 20 millisecondes suppl√©mentaires dans notre centre de traitement - la demande se poursuivra de mani√®re critique.  De plus, si nous traitons chaque requ√™te HTTP pendant 15 √† 20 millisecondes, une simple attaque de 20 000 RPS ajoutera l'ensemble du cluster.  Ceci, bien s√ªr, est inacceptable. <br><br>  Une autre exigence pour nous √©tait non seulement de suivre la demande, mais aussi de comprendre le contexte.  Supposons qu'un utilisateur ouvre une page Web et envoie une demande de barre oblique.  Apr√®s cela, la page est charg√©e, et s'il s'agit de HTTP / 1.1, alors le navigateur ouvre 10 connexions au backend et dans 10 flux demande des statiques et dynamiques, fait des requ√™tes ajax et des sous-requ√™tes.  Si, au lieu de mandater une sous-requ√™te, au cours de la soumission de la page, vous commencez √† interagir avec le navigateur et essayez de lui donner, disons, JS Challenge pour la sous-requ√™te, alors vous casserez probablement la page.  √Ä la toute premi√®re demande, vous pouvez donner des d√©fis CAPTCHA (bien que ce soit mauvais) ou JS, faire une redirection, puis n'importe quel navigateur traitera tout correctement.  Apr√®s les tests, il est n√©cessaire de diffuser des informations sur tous les clusters que la session est l√©gitime.  S'il n'y a pas d'√©change d'informations entre les clusters, les autres n≈ìuds recevront la session du milieu et ne sauront pas si elle doit √™tre ignor√©e ou non. <br><br>  Il est √©galement important de r√©pondre rapidement √† toutes les surcharges de charge et aux changements de trafic.  Si quelque chose saute sur un n≈ìud, alors, apr√®s 50 √† 100 millisecondes, un saut se produit sur tous les autres n≈ìuds.  Par cons√©quent, il est pr√©f√©rable que les n≈ìuds soient inform√©s des modifications √† l'avance et d√©finissent les param√®tres de protection √† l'avance de sorte qu'aucun saut ne se produise sur tous les autres n≈ìuds. <br>  Un service suppl√©mentaire pour se prot√©ger contre les bots √©tait le service post-balisage: nous mettons un pixel sur le site, √©crivons des informations sur le bot / personne et envoyons ces donn√©es via l'API.  Ces verdicts doivent √™tre conserv√©s quelque part.  Autrement dit, si auparavant nous avons parl√© de synchronisation au sein d'un cluster, nous ajoutons maintenant la synchronisation des informations entre les clusters √©galement.  Ci-dessous, nous montrons le sch√©ma du service au niveau L7. <br><br><img src="https://habrastorage.org/webt/_t/lj/ah/_tljahe28yfpufxw6suxf9ay14y.jpeg"><br><br><h4>  Entre les clusters </h4><br>  Apr√®s avoir cr√©√© le cluster, nous avons commenc√© √† √©voluer.  Nous travaillons via BGP anycast, c'est-√†-dire que nos sous-r√©seaux sont annonc√©s √† partir de tous les clusters et le trafic arrive au plus proche.  En termes simples, une demande est envoy√©e de la France √† un cluster √† Francfort et de Saint-P√©tersbourg √† un cluster √† Moscou.  Les clusters doivent √™tre ind√©pendants.  Les flux de r√©seau sont ind√©pendants ind√©pendants. <br><br>  Pourquoi est-ce important?  Supposons qu'une personne conduise une voiture, travaille avec un site Web √† partir d'Internet mobile et traverse un certain Rubicon, apr√®s quoi le trafic passe soudainement √† un autre cluster.  Ou un autre cas: la route de trafic a √©t√© reconstruite car quelque part le commutateur ou le routeur a br√ªl√©, quelque chose est tomb√©, le segment de r√©seau s'est d√©connect√©.  Dans ce cas, nous fournissons au navigateur (par exemple, dans les cookies) des informations suffisantes pour que lors du passage √† un autre cluster, il soit possible d'informer les param√®tres n√©cessaires sur les tests r√©ussis ou √©chou√©s. <br>  De plus, vous devez synchroniser le mode de protection entre les clusters.  Ceci est important dans le cas d'attaques √† faible volume, qui sont le plus souvent men√©es sous couvert d'inondations.  √âtant donn√© que les attaques se d√©roulent en parall√®le, les gens pensent que leur site brise le d√©luge et ne voient pas d'attaque √† faible volume.  Dans le cas o√π un faible volume arrive dans un cluster et se r√©pand dans un autre, la synchronisation du mode de protection est n√©cessaire. <br><br>  Et comme d√©j√† mentionn√©, nous synchronisons entre les clusters les verdicts m√™mes qui s'accumulent et sont donn√©s par l'API.  Dans ce cas, il peut y avoir de nombreux verdicts et ils doivent √™tre synchronis√©s de mani√®re fiable.  En mode protection, vous pouvez perdre quelque chose √† l'int√©rieur du cluster, mais pas entre les clusters. <br><br>  Il est √† noter qu'il existe une grande latence entre les clusters: dans le cas de Moscou et de Francfort, c'est 20 millisecondes.  Les requ√™tes synchrones ne peuvent pas √™tre effectu√©es ici; toutes les interactions doivent passer en mode asynchrone. <br><br>  Ci-dessous, nous montrons l'interaction entre les clusters.  M, l, p sont quelques param√®tres techniques pour un √©change.  U1, u2 est un balisage utilisateur comme ill√©gitime et l√©gitime. <br><br><img src="https://habrastorage.org/webt/a1/xl/si/a1xlsi20avhzuiv_s1uljdmubic.jpeg"><br><br><h4>  Interaction interne entre les n≈ìuds </h4><br>  Initialement, lorsque nous avons rendu le service, le filtrage au niveau L7 a √©t√© d√©marr√© sur un seul n≈ìud.  Cela a bien fonctionn√© pour deux clients, mais pas plus.  Lors de la mise √† l'√©chelle, nous voulions atteindre une r√©activit√© maximale et une latence minimale. <br><br>  Il √©tait important de minimiser les ressources CPU consacr√©es au traitement des paquets, de sorte que l'interaction via, par exemple, HTTP ne conviendrait pas.  Il √©tait √©galement n√©cessaire d'assurer une consommation minimale de frais g√©n√©raux non seulement pour les ressources informatiques, mais √©galement pour le d√©bit des paquets.  N√©anmoins, nous parlons de filtrage des attaques, et ce sont des situations dans lesquelles il n'y a √©videmment pas assez de performances.  Habituellement, lors de la construction d'un projet Web, x3 ou x4 est suffisant pour la charge, mais nous avons toujours x1, car une attaque √† grande √©chelle peut toujours survenir. <br><br>  Une autre exigence pour l'interface d'interaction est la pr√©sence d'un endroit o√π nous √©crirons des informations et d'o√π nous pourrons ensuite calculer dans quel √©tat nous sommes maintenant.  Ce n'est un secret pour personne que le C ++ est souvent utilis√© pour d√©velopper des syst√®mes de filtrage.  Mais malheureusement, les programmes √©crits en C ++ plantent parfois.  Parfois, ces programmes doivent √™tre red√©marr√©s pour √™tre mis √† jour, ou, par exemple, parce que la configuration n'a pas √©t√© relue.  Et si nous red√©marrons le n≈ìud attaqu√©, nous devons prendre quelque part le contexte dans lequel ce n≈ìud existait.  Autrement dit, le service ne doit pas √™tre apatride, il faut se rappeler qu'il y a un certain nombre de personnes que nous avons bloqu√©es, que nous contr√¥lons.  Il doit y avoir la m√™me communication interne pour que le service puisse recevoir un ensemble principal d'informations.  Nous avons pens√© √† mettre √† proximit√© d'une certaine base de donn√©es, par exemple SQLite, mais nous avons rapidement rejet√© une telle solution, car il est √©trange d'√©crire des entr√©es-sorties sur chaque serveur, cela fonctionnera mal en m√©moire. <br><br>  En fait, nous travaillons avec seulement trois op√©rations.  La premi√®re fonction est ¬´envoyer¬ª √† tous les n≈ìuds.  Cela s'applique, par exemple, aux messages sur la synchronisation de la charge actuelle: chaque n≈ìud doit conna√Ætre la charge totale sur la ressource au sein du cluster afin de suivre les pics.  La deuxi√®me op√©ration consiste √† ¬´sauver¬ª, elle concerne les verdicts de v√©rification.  Et la troisi√®me op√©ration est une combinaison de ¬´envoyer √† tout le monde¬ª et de ¬´sauvegarder¬ª.  Ici, nous parlons de messages de changement d'√©tat que nous envoyons √† tous les n≈ìuds puis que nous enregistrons afin de pouvoir soustraire.  Vous trouverez ci-dessous le sch√©ma d'interaction r√©sultant, dans lequel nous devrons ajouter des param√®tres pour l'enregistrement. <br><br><img src="https://habrastorage.org/webt/s7/__/8c/s7__8c-cnmitihkranlrso0ukza.jpeg"><br><br><h4>  Options et r√©sultat </h4><br>  Quelles options pour pr√©server les verdicts avons-nous envisag√©es?  Tout d'abord, nous pensions aux classiques, RabbitMQ, RedisMQ et √† notre propre service bas√© sur TCP.  Nous avons rejet√© ces d√©cisions parce qu'elles fonctionnent lentement.  Le m√™me TCP ajoute x2 au d√©bit de paquets.  De plus, si nous envoyons un message d'un n≈ìud √† tous les autres, alors nous devons avoir beaucoup de n≈ìuds d'envoi, ou ce n≈ìud peut empoisonner 1/16 de ces messages que 16 machines peuvent lui envoyer.  Il est clair que cela est inacceptable. <br><br>  En cons√©quence, nous avons pris la multidiffusion UDP, car dans ce cas, le centre d'envoi est un √©quipement r√©seau, qui n'est pas limit√© dans les performances et vous permet de r√©soudre compl√®tement les probl√®mes de vitesse d'envoi et de r√©ception.  Il est clair que dans le cas d'UDP, nous ne pensons pas aux formats de texte, mais envoyons des donn√©es binaires. <br><br>  De plus, nous avons imm√©diatement ajout√© un emballage et une base de donn√©es.  Nous avons pris Tarantool, parce que, premi√®rement, les trois fondateurs de l'entreprise avaient de l'exp√©rience avec cette base de donn√©es, et deuxi√®mement, elle est aussi flexible que possible, c'est-√†-dire qu'il s'agit √©galement d'une sorte de service d'application.  De plus, Tarantool a CAPI, et la capacit√© d'√©crire en C est une question de principe pour nous car une protection maximale est requise pour se prot√©ger contre les DDoS.  Aucun langage interpr√©t√© ne peut fournir des performances suffisantes, contrairement √† C. <br><br>  Dans le diagramme ci-dessous, nous avons ajout√© une base de donn√©es √† l'int√©rieur du cluster, dans laquelle les √©tats de communication interne sont stock√©s. <br><br><img src="https://habrastorage.org/webt/k3/py/60/k3py60c1-_z4uirabzit7-otlri.jpeg"><br><br><h4>  Ajouter une base de donn√©es </h4><br>  Dans la base de donn√©es, nous stockons l'√©tat sous la forme d'un journal des appels.  Lorsque nous avons trouv√© comment enregistrer des informations, il y avait deux options.  Il √©tait possible de stocker un √©tat avec une mise √† jour et un changement constants, mais il est plut√¥t difficile √† impl√©menter.  Par cons√©quent, nous avons utilis√© une approche diff√©rente. <br><br>  Le fait est que la structure des donn√©es envoy√©es via UDP est unifi√©e: il y a un timing, une sorte de code, trois ou quatre champs de donn√©es.  Nous avons donc commenc√© √† √©crire cette structure dans l'espace Tarantool et y avons ajout√© un enregistrement TTL, ce qui indique clairement que la structure est obsol√®te et doit √™tre supprim√©e.  Ainsi, un journal des messages est accumul√© dans Tarantool, que nous effa√ßons avec le timing sp√©cifi√©.  Pour supprimer les anciennes donn√©es, nous avons initialement pris expirationd.  Par la suite, nous avons d√ª l'abandonner, car cela a caus√© certains probl√®mes, dont nous parlerons ci-dessous.  Jusqu'√† pr√©sent, le sch√©ma: deux bases de donn√©es ont √©t√© ajout√©es √† notre structure. <br><br><img src="https://habrastorage.org/webt/p-/li/-m/p-li-mkvdsa7ks9bxqz00ywlrey.jpeg"><br><br>  Comme nous l'avons d√©j√† mentionn√©, en plus de stocker les √©tats de cluster, il est √©galement n√©cessaire de synchroniser les verdicts.  Verdicts nous synchronisons intercluster.  En cons√©quence, il a √©t√© n√©cessaire d'ajouter une installation suppl√©mentaire de Tarantool.  Il serait √©trange d'utiliser une autre solution, car Tarantool est d√©j√† l√† et il est id√©al pour notre service.  Dans la nouvelle installation, nous avons commenc√© √† r√©diger des verdicts et √† les reproduire avec d'autres clusters.  Dans ce cas, nous utilisons non pas ma√Ætre / esclave, mais ma√Ætre / ma√Ætre.  Maintenant, √† Tarantool, il n'y a qu'un ma√Ætre / ma√Ætre asynchrone, ce qui dans de nombreux cas ne convient pas, mais pour nous, ce mod√®le est optimal.  Avec une latence minimale entre les clusters, la r√©plication synchrone serait g√™nante, tandis que la r√©plication asynchrone ne pose pas de probl√®me. <br><br><h4>  Les probl√®mes </h4><br>  Mais nous avons eu beaucoup de probl√®mes.  <i>Le premier bloc de complexit√© est li√© √† UDP</i> : ce n'est un secret pour personne que le protocole peut battre et perdre des paquets.  Nous avons r√©solu ces probl√®mes par la m√©thode de l'autruche, c'est-√†-dire que nous avons simplement cach√© nos t√™tes dans le sable.  N√©anmoins, les dommages par paquets et le r√©arrangement de leurs emplacements sont impossibles avec nous, car la communication a lieu dans le cadre d'un commutateur, et il n'y a pas de connexions instables et d'√©quipements de r√©seau instables. <br><br>  Il peut y avoir un probl√®me de perte de paquets si une machine se fige, une entr√©e-sortie se produit quelque part ou un n≈ìud est surcharg√©.  Si un tel blocage s'est produit pendant une courte p√©riode, disons 50 millisecondes, cela est terrible, mais il est r√©solu par l'augmentation des files d'attente sysctl.  Autrement dit, nous prenons sysctl, configurons la taille des files d'attente et obtenons un tampon dans lequel tout se trouve jusqu'√† ce que le n≈ìud recommence √† fonctionner.  Si un gel plus long se produit, le probl√®me ne sera pas la perte de connectivit√©, mais une partie du trafic qui va au n≈ìud.  Jusqu'√† pr√©sent, nous n'avons tout simplement pas eu de tels cas. <br><br>  <i>Les probl√®mes de r√©plication asynchrone de Tarantool</i> √©taient beaucoup plus complexes.  Dans un premier temps, nous n'avons pas pris ma√Ætre / ma√Ætre, mais un mod√®le plus traditionnel de fonctionnement ma√Ætre / esclave.  Et tout a fonctionn√© exactement jusqu'√† ce que l'esclave prenne la charge principale pendant longtemps.  En cons√©quence, expirationd a fonctionn√© et supprim√© les donn√©es sur le ma√Ætre, mais sur l'esclave, ce n'√©tait pas le cas.  En cons√©quence, lorsque nous sommes pass√©s plusieurs fois du ma√Ætre √† l'esclave et vice versa, tant de donn√©es se sont accumul√©es sur l'esclave qu'√† un moment donn√©, tout s'est cass√©.  Donc, pour une tol√©rance aux pannes totale, j'ai d√ª passer √† la r√©plication ma√Ætre / ma√Ætre asynchrone. <br><br>  Et l√† encore, des difficult√©s sont apparues.  Premi√®rement, les cl√©s peuvent se croiser entre diff√©rentes r√©pliques.  Supposons que, dans le cluster, nous √©crivions des donn√©es sur un ma√Ætre, √† ce moment la connexion s'est rompue, nous avons tout √©crit sur le deuxi√®me ma√Ætre, et apr√®s avoir effectu√© la r√©plication asynchrone, il s'est av√©r√© que la m√™me cl√© primaire dans l'espace et la r√©plication s'effondraient. <br><br>  Nous avons r√©solu ce probl√®me simplement: nous avons pris un mod√®le dans lequel la cl√© primaire contient n√©cessairement le nom du n≈ìud Tarantool sur lequel nous √©crivons.  Pour cette raison, des conflits ont cess√© de se produire, mais une situation est devenue possible lorsque les donn√©es utilisateur sont dupliqu√©es.  Il s'agit d'un cas extr√™mement rare, nous l'avons donc tout simplement n√©glig√©.  Si la duplication se produit fr√©quemment, Tarantool a de nombreux index diff√©rents, vous pouvez donc toujours faire de la d√©duplication. <br><br>  Un autre probl√®me concerne la conservation des verdicts et se pose lorsque les donn√©es enregistr√©es sur un ma√Ætre ne sont pas encore apparues sur un autre, et qu'une demande est d√©j√† parvenue au premier ma√Ætre.  Pour √™tre honn√™te, nous n'avons pas encore r√©solu ce probl√®me et retardons simplement le verdict.  Si cela est inacceptable, nous organiserons une sorte de promotion de la pr√©paration des donn√©es.  C‚Äôest ainsi que nous avons trait√© la r√©plication ma√Ætre / ma√Ætre et ses probl√®mes. <br><br>  <i>Il y avait un bloc de probl√®mes li√©s directement √† Tarantool</i> , √† ses pilotes et au module expirationd.  Quelque temps apr√®s le lancement, des attaques ont commenc√© √† nous arriver chaque jour, respectivement, le nombre de messages que nous enregistrons dans la base de donn√©es pour la synchronisation et le stockage du contexte est devenu tr√®s important.  Et pendant le d√©capage, tellement de donn√©es ont commenc√© √† √™tre supprim√©es que le garbage collector a cess√© de faire face.  Nous avons r√©solu ce probl√®me en √©crivant en C notre propre module expirationd appel√© IExpire. <br><br>  Cependant, avec expirationd, il y a encore une difficult√© avec laquelle nous n'avons pas encore r√©ussi et qui r√©side dans le fait que l'expirationd ne fonctionne que sur un seul ma√Ætre.  Et si le n≈ìud expirationd tombe, le cluster perdra ses fonctionnalit√©s critiques.  Supposons que nous nettoyions toutes les donn√©es de plus d'une heure - il est clair que si un n≈ìud se trouve, disons, cinq heures, alors la quantit√© de donn√©es sera x5 √† l'habituel.  Et si √† ce moment une grande attaque survient, c'est-√†-dire que deux mauvais cas co√Øncident, alors le cluster tombera.  Nous ne savons pas encore comment y faire face. <br><br>  Enfin, il restait des difficult√©s avec le pilote Tarantool pour C. Lorsque nous avons interrompu le service (par exemple, en raison de conditions de course), il a fallu beaucoup de temps pour trouver la raison et le d√©bogage.  Par cons√©quent, nous venons d'√©crire notre pilote Tarantool.  Il nous a fallu cinq jours pour mettre en ≈ìuvre le protocole ainsi que les tests, le d√©bogage et l'ex√©cution en production, mais nous avions d√©j√† notre propre code pour travailler avec le r√©seau. <br><br><h4>  Probl√®mes √† l'ext√©rieur </h4><br>  Rappelons que nous avons d√©j√† la r√©plication Tarantool pr√™te, nous savons d√©j√† synchroniser les verdicts, mais il n'y a pas encore d'infrastructure pour transmettre des messages sur les attaques ou les probl√®mes entre les clusters. <br>  Nous avons eu beaucoup de r√©flexions diff√©rentes sur l'infrastructure, y compris l'id√©e d'√©crire notre propre service TCP.  Mais il y a toujours un module Tarantool Queue de l'√©quipe Tarantool.  De plus, nous avions d√©j√† Tarantool avec une r√©plication inter-cluster, des ¬´trous¬ª √©taient tordus, c'est-√†-dire qu'il n'√©tait pas n√©cessaire d'aller aux administrateurs et de demander d'ouvrir des ports ou de g√©n√©rer du trafic.  L√† encore, l'int√©gration dans la filtration logicielle √©tait pr√™te. <br><br>  Il y avait un probl√®me avec le n≈ìud h√¥te.  Supposons qu'il existe n n≈ìuds ind√©pendants √† l'int√©rieur d'un cluster et que vous devez choisir celui qui interagira avec la file d'attente d'√©criture.  Dans le cas contraire, 16 messages seront envoy√©s ou 16 fois le m√™me message sera soustrait de la file d'attente.  Nous avons r√©solu ce probl√®me simplement: nous enregistrons un n≈ìud responsable dans l'espace Tarantool, et si le n≈ìud br√ªle, nous changeons simplement l'espace si nous n'oublions pas.  Mais si nous oublions, c'est un probl√®me que nous voulons √©galement r√©soudre √† l'avenir. <br><br>  Vous trouverez ci-dessous un sch√©ma d√©j√† d√©taill√© d'un cluster avec une interface d'interaction. <br><br><img src="https://habrastorage.org/webt/8f/f3/9o/8ff39og9opl3e4rjwydmtpdsola.jpeg"><br><br><h4>  Ce que je veux am√©liorer et ajouter </h4><br>  Premi√®rement, nous voulons publier dans IExpire open source.  Il nous semble que c'est un module utile, car il vous permet de tout faire de la m√™me mani√®re que expirationd, mais avec une surcharge presque nulle.  L√†, vous devez ajouter un index de tri pour supprimer uniquement le tuple le plus ancien.  Jusqu'√† pr√©sent, nous ne l'avons pas fait, car pour nous, l'op√©ration principale de Tarantool est ¬´l'√©criture¬ª, et un index suppl√©mentaire entra√Ænera une charge suppl√©mentaire en raison de son support.  Nous voulons √©galement r√©√©crire la plupart des m√©thodes de CAPI pour √©viter de replier la base de donn√©es. <br><br>  La question reste du choix d'un ma√Ætre logique, mais il semble que ce probl√®me soit totalement impossible √† r√©soudre.  Autrement dit, si le n≈ìud avec expirationd tombe, il ne reste plus qu'√† s√©lectionner manuellement un autre n≈ìud et √† ex√©cuter expirationd sur celui-ci.  Il est peu probable que cela se produise automatiquement, car la r√©plication est asynchrone.  Bien que nous consulterons probablement √† ce sujet avec l'√©quipe Tarantool. <br><br>  En cas de croissance exponentielle du cluster, nous devrons √©galement demander de l'aide √† l'√©quipe Tarantool.  Le fait est que la r√©plication tout-√†-tout est utilis√©e pour Tarantool Queue et la sauvegarde intercluster des verdicts.  Cela fonctionne bien, alors qu'il y a trois clusters, par exemple, mais quand il y en a 100, le nombre de connexions √† surveiller sera incroyablement important et quelque chose se cassera constamment.  Deuxi√®mement, ce n'est pas un fait que Tarantool peut supporter une telle charge. <br><br><h4>  Conclusions </h4><br>  Les premi√®res conclusions concernent la multidiffusion UDP et Tarantool. Multicast    ,     ‚Äî  ,   .   ,     ,   50   ,   .    ,  ,      .    UDP multicast ,         . <br><br>   ‚Äî Tarantool.      go, php   ,    Tarantool   .      ,   .   ,        :   Oracle,   PostgeSQL. <br><br> ,  ,     ,      ,     : Redis  ,  go, python   .  .   ,     ,     open source, ,     ,    ,     ,     .  ,    .       Tarantool,      ,      ,   Redis,    . </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr459264/">https://habr.com/ru/post/fr459264/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr459252/index.html">Semaine de la s√©curit√© 28: pirater une maison intelligente</a></li>
<li><a href="../fr459254/index.html">Encore mieux la bombe zip</a></li>
<li><a href="../fr459256/index.html">Comment nous avons optimis√© notre h√¥pital th√©matique pour diff√©rentes plateformes</a></li>
<li><a href="../fr459258/index.html">14 000 milles non accroch√©s</a></li>
<li><a href="../fr459262/index.html">Retrait√© √† 22 ans</a></li>
<li><a href="../fr459272/index.html">√âcriture d'une API pour les composants React, partie 1: ne cr√©ez pas d'accessoires conflictuels</a></li>
<li><a href="../fr459274/index.html">Vuln√©rabilit√© de verrouillage d'√©cran dans Astra Linux Special Edition (Smolensk)</a></li>
<li><a href="../fr459276/index.html">Epic fail resistance 2 ou pourquoi vous ne devriez pas vous impliquer dans la confidentialit√© avec les plugins FireFox</a></li>
<li><a href="../fr459280/index.html">Pourquoi les d√©veloppeurs aiment-ils cr√©er une application native?</a></li>
<li><a href="../fr459284/index.html">Br√®ve introduction √† la strat√©gie produit et √† la hi√©rarchisation des fonctionnalit√©s</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>