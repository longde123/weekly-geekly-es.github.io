<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üîõ üå¶Ô∏è üë¶üèº Desde principiantes hasta iconos de estilo: c√≥mo hicimos premios en 2GIS üêÇ üë©‚Äç‚ù§Ô∏è‚Äçüë® üë®üèº‚Äçüîß</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Todos los d√≠as, los usuarios de 2GIS nos ayudan a mantener la precisi√≥n de los datos: informan sobre nuevas empresas, agregan eventos de tr√°fico, carg...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Desde principiantes hasta iconos de estilo: c√≥mo hicimos premios en 2GIS</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/2gis/blog/470942/"><img src="https://habrastorage.org/webt/kl/9g/ja/kl9gjaqo9dmcbsimconigs2pnxo.png"><br><br>  Todos los d√≠as, los usuarios de 2GIS nos ayudan a mantener la precisi√≥n de los datos: informan sobre nuevas empresas, agregan eventos de tr√°fico, cargan fotos y escriben rese√±as.  Anteriormente, solo pod√≠amos agradecerles con palabras o organizar un sorteo.  Pero con el tiempo, las palabras se olvidan y no todos reciben regalos.  Por lo tanto, decidimos asegurarnos de que todos aquellos que se preocupan por 2GIS vean su contribuci√≥n al producto y nuestra gratitud por esto. <br><br>  As√≠ que hubo premios, medallas virtuales que acumulamos para varios tipos de tareas: subir fotos a tarjetas de caf√©, escribir rese√±as sobre teatros, especificar las horas de trabajo de las organizaciones, etc.  Los usuarios ven las recompensas obtenidas en su perfil personal de 2GIS y en la pesta√±a "Mi 2GIS" en la aplicaci√≥n m√≥vil.  All√≠ mostramos cu√°nto queda hasta el pr√≥ximo logro. <br><br>  Para implementar esta funci√≥n, aprendimos c√≥mo procesar una secuencia de eventos con un volumen de 500 mil registros por hora (en lugares de hasta 50 mil registros por segundo) y analizar datos de varios servicios.  Y tambi√©n: agregaron una peque√±a metaprogramaci√≥n para simplificar la configuraci√≥n al desarrollar nuevos premios. <br><br>  Junto con <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" class="user_link">Rapter</a> , le diremos qu√© hay <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" class="user_link">detr√°s</a> del proceso de adjudicaci√≥n. <br><a name="habracut"></a><br><h2>  Concepto </h2><br>  Para comprender la complejidad de la funci√≥n, debe comprender c√≥mo son√≥ el problema t√©cnico.  Luego, considere la idea de implementaci√≥n y el esquema general de los componentes del sistema.  Esto es lo que haremos en esta secci√≥n. <br><br><h3>  Requisitos para res√∫menes </h3><br>  Requisitos: algo bastante aburrido, por lo que no pintaremos todos los matices, nos concentraremos en las cosas m√°s importantes: <br><br><ul><li>  los premios se otorgan solo a usuarios autorizados; </li><li>  actualizar el progreso de una recompensa debe ser lo m√°s r√°pido posible; </li><li>  recompensa: el resultado de un usuario que realiza un conjunto de acciones en el producto: subir una foto, escribir una rese√±a, encontrar instrucciones, etc. Hay muchas fuentes de datos. </li></ul><br><h3>  Idea arquitect√≥nica </h3><br>  La idea de implementaci√≥n no es muy complicada.  Se puede expresar de forma tesis: <br><br><ul><li>  el premio consiste en tareas, cuyos resultados se combinan de acuerdo con la f√≥rmula especificada al configurar el premio; </li><li>  la tarea responde a eventos sobre acciones de usuarios que provienen del exterior, los filtra y registra el cambio en progreso en forma de contadores; </li><li>  Los ‚Äúeventos externos‚Äù son generados por sistemas maestros (foto, comentarios, servicios de refinamiento, etc.) o servicios auxiliares que transforman o filtran los flujos de eventos ya existentes; </li><li>  el procesamiento de eventos ocurre de forma asincr√≥nica y puede detenerse en cualquier momento si es necesario; </li><li>  el usuario ve el estado actual de sus premios; </li><li>  todo lo dem√°s son los detalles ... </li></ul><br><h3>  Entidades clave </h3><br>  El siguiente diagrama muestra las principales entidades del √°rea tem√°tica y su relaci√≥n: <br><br><img src="https://habrastorage.org/webt/vi/ya/59/viya59qa7bnnad3hogutbunyds4.png"><br><br>  Se distinguen dos zonas en el diagrama: <br><br><ul><li>  Esquema: una zona para describir la estructura de los premios y las reglas para su acumulaci√≥n; </li><li>  Datos: √°rea de adjudicaci√≥n para usuarios espec√≠ficos y datos relacionados con su estado actual. </li></ul><br>  Las entidades en el diagrama: <br><br><ul><li>  Lograr: informaci√≥n sobre el premio que se puede obtener.  Incluye metainformaci√≥n y una descripci√≥n de c√≥mo combinar los resultados de las tareas: una estrategia. </li><li>  Objetivo: una tarea, cuyas condiciones deben cumplirse para avanzar a recibir un premio. </li><li>  UserAchieve: el estado actual de la recompensa para un usuario en particular. </li><li>  UserObjective: el estado actual del trabajo de recompensa del usuario. </li><li>  Usuario: informaci√≥n sobre el usuario, necesaria para las notificaciones y la comprensi√≥n de su estado actual (no se necesitan recompensas remotas y prohibidas). </li><li>  ProcessingLog: un registro de acumulaciones para tareas.  Contiene informaci√≥n sobre c√≥mo una acci√≥n espec√≠fica influy√≥ en el progreso de la tarea. </li><li>  Evento: la informaci√≥n m√≠nima necesaria sobre un evento que de alguna manera influy√≥ en el progreso de las tareas del usuario. </li></ul><br><h3>  Estructura de servicio </h3><br>  Ahora considere los componentes principales del servicio y sus dependencias: <br><br><img src="https://habrastorage.org/webt/qi/dp/k_/qidpk_jo7rqnh2x5dywk0sg0ij4.png"><br><br><ul><li>  Bus de eventos: un bus de eventos que se puede utilizar para completar tareas.  Estamos usando Apache Kafka. </li><li>  Las bases de datos maestras y esclavas son el almac√©n de datos principal.  En este caso, un cl√∫ster PostgreSQL. </li><li>  ConsumingWorkers: controladores de eventos de autobuses.  La tarea principal es leer eventos de una fuente espec√≠fica (fotos, rese√±as, etc.), aplicarlos a las tareas del usuario y guardar el resultado. </li><li>  AchievesWorker: relata el progreso de las recompensas de los usuarios seg√∫n el estado de las tareas. </li><li>  NotificationWorkers: un conjunto de controladores para programar y enviar notificaciones sobre la recepci√≥n de premios, anuncios de nuevos logros posibles, etc. </li><li>  API p√∫blica: una interfaz REST p√∫blica para aplicaciones web y m√≥viles. </li><li>  API privada: interfaz REST para el panel de administraci√≥n, que ayuda en la investigaci√≥n de incidentes y el servicio de soporte.  Est√° disponible para desarrolladores y equipos de soporte. </li></ul><br>  Cada uno de los componentes est√° aislado en t√©rminos de l√≥gica y √°reas de responsabilidad, lo que evita integraciones innecesarias y puntos muertos al modificar los datos.  A continuaci√≥n, consideramos solo una parte del esquema asociado con el procesamiento de eventos y su conversi√≥n en recompensas. <br><br><h2>  Manejo de eventos </h2><br><h3>  Contenido </h3><br>  Las recompensas son principalmente un servicio de agregaci√≥n de datos.  Cada sistema maestro genera varios tipos de eventos.  Como regla general, cada tipo de evento est√° estrechamente relacionado con el estado del contenido, su modelo de estado.  Por lo tanto, una foto puede ser moderada, eliminada, bloqueada, oculta o activa.  Todos estos son eventos diferentes que son manejados por un trabajador separado que se especializa en una fuente en particular.  En este momento, hay una interacci√≥n con las siguientes fuentes (sistemas maestros): <br><br><ul><li>  Foto: genera varios eventos relacionados con las operaciones realizadas por los usuarios en las fotograf√≠as. </li><li>  Revisiones: eventos relacionados con operaciones en revisiones de usuarios. </li><li>  Retroalimentaci√≥n de datos: eventos relacionados con operaciones de refinamiento.  La aclaraci√≥n es un cambio en la informaci√≥n sobre un objeto en un mapa, ya sea una empresa o un monumento. </li><li>  Check: eventos relacionados con la aplicaci√≥n 2GIS Check. </li><li>  Los BSS son eventos anal√≠ticos que generan aplicaciones 2GIS.  Por ejemplo, la apertura de una determinada empresa, viajes en el navegador, etc. </li></ul><br><img src="https://habrastorage.org/webt/vg/xy/zb/vgxyzbizbytl_up3fllx5epasue.png"><br><br>  Los eventos generados por el sistema maestro caen en el tema de Kafka en el orden de cambiar sus estados, lo que hace posible avanzar el progreso de la adjudicaci√≥n para el usuario no solo hacia adelante, sino tambi√©n para retroceder.  Por ejemplo, si la foto estaba en el estado "activo", y luego por alguna raz√≥n adquiri√≥ el estado de "bloqueado", el progreso de la adjudicaci√≥n deber√≠a cambiar hacia abajo.  El progreso del premio es una interpretaci√≥n de objetos internos llamados contadores de contenido. <br><br>  Los contadores pueden variar para diferentes datos.  Por ejemplo, para eventos sobre la foto, son los siguientes: el n√∫mero de aprobados, el n√∫mero de moderaci√≥n, el n√∫mero de bloqueados y para eventos de tarjetas de apertura, debe considerar solo el n√∫mero de tarjetas abiertas por el usuario.  En funci√≥n de los valores actuales de los contadores de contenido, para un usuario en particular, en el marco de un premio espec√≠fico, se determinan las respuestas a las siguientes preguntas: <br><br><ul><li>  ¬øHa comenzado el premio? </li><li>  cual es el progreso </li><li>  ¬øLa recompensa est√° completa? </li></ul><br><h3>  Filtros y Reglas </h3><br>  Los contadores de trabajo de un premio en particular se cambian solo si un evento ha llegado con el tipo de contenido deseado, as√≠ como con los datos necesarios para recibir el premio. <br><br>  Para omitir solo el contenido adecuado para el premio, ejecutamos cada evento a trav√©s de una serie de filtros y reglas. <br><br>  Un filtro es una cierta restricci√≥n que se impone al contenido.  Solo le preocupa responder la pregunta: "¬øUn nuevo evento se ajusta a esta condici√≥n o no?" <br>  Una regla es un filtro especial, cuyo prop√≥sito es decir: "Si un evento se ajusta a la condici√≥n, ¬øc√≥mo deber√≠an cambiar los contadores?"  La regla incluye un algoritmo para cambiar los contadores.  Cada premio contiene solo una regla. <br><br>  La implementaci√≥n de filtros y reglas est√° en el c√≥digo del proyecto, y la descripci√≥n de qu√© filtros (reglas) pertenecen a un premio en particular est√° en la base de datos en formato JSON.  No tomamos tal decisi√≥n de inmediato.  Inicialmente, los filtros y las reglas no se pod√≠an establecer usando la configuraci√≥n a trav√©s de la base de datos, la adjudicaci√≥n se describ√≠a completamente en el c√≥digo, solo su identificador se almacenaba en la tabla.  Esta decisi√≥n dio una serie de inconvenientes significativos: <br><br><ul><li>  El problema de soportar m√∫ltiples entornos.  Si desea implementar un estado de la lista de premios para el entorno de prueba y enviar otro a la batalla, debe conocer el c√≥digo del entorno en el c√≥digo del proyecto o tener un archivo de configuraci√≥n con la lista de premios.  Al mismo tiempo, no es posible utilizar diferentes bases de datos para esta tarea, aunque ya existen para cada entorno. </li><li>  Posibilidad de configurar el filtrado solo por el desarrollador.  Como todo se describe en el c√≥digo, solo una persona que conozca el proyecto y el lenguaje de programaci√≥n podr√≠a hacer cambios, me gustar√≠a que fuera posible hacerlo simplemente a trav√©s de la API privada o la base de datos. </li><li>  La desventaja de ver.  Hay muchas recompensas, a veces necesitas ver los filtros que usan.  Cada vez, hacer esto mirando el c√≥digo es bastante tedioso. </li></ul><br>  Al comienzo de la aplicaci√≥n, hacemos coincidir el nombre de los filtros cargados desde la base de datos y los colocamos en una recompensa espec√≠fica.  Ejemplo de descripci√≥n del filtro: <br><br><pre><code class="json hljs">[ { <span class="hljs-attr"><span class="hljs-attr">"name"</span></span>:<span class="hljs-string"><span class="hljs-string">"SourceFilter"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"config"</span></span>:{ <span class="hljs-attr"><span class="hljs-attr">"sources"</span></span>:[<span class="hljs-string"><span class="hljs-string">"reviews"</span></span>] } }, { <span class="hljs-attr"><span class="hljs-attr">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"ReviewsLengthFilter"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"config"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"allowed_length"</span></span>: <span class="hljs-number"><span class="hljs-number">100</span></span> } } ]</code> </pre> <br>  En este caso, tomaremos solo esas revisiones (esto se indica mediante el primer objeto de descripci√≥n de la matriz de filtros), cuyo texto contiene m√°s de 100 caracteres (el segundo filtro en la lista). <br><br>  Descripci√≥n de la regla de ejemplo: <br><br><pre> <code class="json hljs">{<span class="hljs-attr"><span class="hljs-attr">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"ReviewUniqueByObjectRule"</span></span>,<span class="hljs-attr"><span class="hljs-attr">"config"</span></span>:{}}</code> </pre><br>  Esta regla le permitir√° cambiar los contadores solo si el usuario escribi√≥ una revisi√≥n para el objeto, mientras que solo se tendr√° en cuenta una revisi√≥n para un objeto. <br><br><h3>  Bss </h3><br>  Deteng√°monos por separado trabajando con el flujo de eventos BSS.  Hay al menos tres razones para esto: <br><br><ul><li>  Los eventos anal√≠ticos no se pueden revertir, no hay ning√∫n modelo de estado en ellos, lo que, en general, es l√≥gico, porque no se puede cancelar la conducci√≥n a trav√©s del navegador o la construcci√≥n de una ruta.  La acci√≥n estaba all√≠ o no. </li><li>  Vol√∫menes  Perm√≠tame recordarle que la audiencia total de 2GIS es de m√°s de 50 millones de usuarios por mes.  Juntos realizan m√°s de 1.500 millones de consultas de b√∫squeda, as√≠ como muchas otras acciones: iniciar la aplicaci√≥n, ver la tarjeta del objeto, etc. En el pico, el n√∫mero de eventos puede llegar a 50.000 por segundo.  Debemos pasar toda esta informaci√≥n a trav√©s de filtros para otorgar una recompensa al usuario. </li><li>  Los eventos anal√≠ticos tienen caracter√≠sticas: varios formatos, una amplia variedad de tipos. </li></ul><br>  Todo esto influy√≥ mucho en el procesamiento de datos del tema BSS, ya que si necesitamos tiempo real, entonces necesitamos un tiempo de procesamiento muy cercano. <br><br>  Para reducir las diferencias descritas, se ha creado un servicio separado que prepara tales eventos.  El servicio puede funcionar con toda la variedad de formatos de mensajes provenientes de an√°lisis.  La esencia de su trabajo es la siguiente: se lee toda la secuencia de eventos de BSS, de la cual solo se toman los que se necesitan para los Premios.  Tal filtro de servicio reduce significativamente la carga (despu√©s de filtrar, la velocidad de flujo es de ‚âà300 eventos por segundo) de las recompensas del procesador BSS-stream, y tambi√©n genera eventos en un solo formato, nivelando la desventaja asociada con el historial de an√°lisis interno. <br><br><h2>  Premios </h2><br>  Entonces, descubrimos c√≥mo manejar eventos y calcular el progreso de las tareas.  Ahora es el momento de echar un vistazo al proceso de emisi√≥n de recompensas para los usuarios. <br><br>  La primera pregunta que surge es: ¬øpor qu√© asignar la salida a un trabajador separado, no se puede volver a contar al procesar cada evento?  Respuesta: posible, pero no vale la pena. <br><br>  Hay varias razones para asignar la extradici√≥n a un proceso separado: <br><br><ol><li>  Al transferir el recuento a cada ConsumingWorker, obtenemos la Condici√≥n de carrera para la operaci√≥n de actualizar el progreso por recompensa, porque cada controlador intentar√° actualizar el progreso en funci√≥n del estado conocido de las tareas, y otros cambiar√°n activamente este estado. </li><li>  Cada lote de ConsumingWorker procesa eventos de Kafka en una transacci√≥n.  Al agregar un inserto a la tabla de recompensas del usuario, llamaremos bloqueos adicionales a nivel de la base de datos, lo que inhibir√° otros manejadores. </li><li>  En el proceso de emisi√≥n de premios, existe una l√≥gica para enviar notificaciones que solo ralentizar√° el procesamiento del flujo de eventos, lo que no es deseable. </li></ol><br>  Se resolvieron los motivos de la aparici√≥n de un AchievesWorker (controlador para la entrega de premios) por separado.  Ahora debe lidiar con dos partes importantes del procesamiento: <br><br><ol><li>  Hay un conjunto de misiones en la recompensa.  Hay un conjunto de contadores para estas tareas.  ¬øC√≥mo entender cu√°nto se otorga el premio y c√≥mo expresarlo en c√≥digo? <br>  Ejemplo: necesita escribir 3 rese√±as o subir 3 fotos.  El usuario tiene 1 comentario y 2 fotos.  ¬øCu√°l es el progreso del premio?  Respuesta: 3, porque el usuario definitivamente estar√° seguro de que necesita 3 en total. </li><li>  Tenemos un controlador separado para emitir premios.  Cada vez, es poco probable que el recuento de varias docenas de premios para cada usuario autorizado, es decir, varias decenas de millones, tenga √©xito r√°pidamente.  ¬øC√≥mo puede aprender sobre el progreso de qu√© usuarios particulares y qu√© tareas han cambiado desde el √∫ltimo procesamiento? </li></ol><br>  Consideraremos cada parte por separado. <br><br><h3>  Flujo de progreso </h3><br>  Para una mejor comprensi√≥n de c√≥mo puede describir c√≥mo transformar el progreso de las tareas en progreso por recompensa, dividimos las recompensas en categor√≠as y observamos las transformaciones. <br><br>  <b>"Completa una tarea por X unidades".</b>  Ejemplo: conducir 10 km en el navegador. <br><br><img src="https://habrastorage.org/webt/vv/qu/x5/vvqux5yb09uehrul3dkd3mux3wm.png"><br><br>  <b>"Completa varias tareas para X unidades cada una".</b>  Ejemplo: suba 5 fotos y escriba 5 rese√±as en tarjetas, solo 10 unidades de contenido. <br><br><img src="https://habrastorage.org/webt/fe/n8/oc/fen8oc0kbm372ozvyvr3a7fj8jo.png"><br><br>  <b>"Completa varias tareas para X unidades en total".</b>  Ejemplo: escribe 5 rese√±as o sube 5 fotos. <br><br><img src="https://habrastorage.org/webt/d-/ld/gd/d-ldgdazj8xt2eysdzqhgauaxgc.png"><br><br>  <b>"Completa varias tareas agrupadas por tipo".</b>  Ejemplo: cargue 5 unidades de contenido (fotos o rese√±as) y conduzca 10 km en el navegador. <br><br><img src="https://habrastorage.org/webt/ue/c3/ck/uec3ckf33tcm4pjcfmtkfbmv9eq.png"><br><br>  Te√≥ricamente, podr√≠a haber combinaciones anidadas m√°s complejas.  Sin embargo, en condiciones reales, no es posible explicar al usuario en dos o tres oraciones la combinaci√≥n l√≥gica compleja que debe realizarse para recibir el premio.  Por lo tanto, en la mayor√≠a de los casos, estas opciones son suficientes. <br><br>  Llamamos al m√©todo de conversi√≥n una estrategia e intentamos hacerlo m√°s o menos universal elaborando una descripci√≥n formal en forma de un objeto JSON.  Podr√≠a, por supuesto, pensar en escribir en forma de una f√≥rmula, pero luego tendr√≠a que usar similitudes para evaluar o describir la gram√°tica e implementarla, y esto es claramente una complicaci√≥n excesiva.  Almacenar la estrategia en el c√≥digo fuente para cada premio no es muy conveniente, porque la descripci√≥n del premio (parte de la base de datos y parte del c√≥digo) se romper√°, y tampoco permitir√° la recolecci√≥n de premios de componentes listos en el futuro sin la participaci√≥n del desarrollo. <br><br>  La estrategia se presenta en forma de √°rbol, donde cada nodo: <br><br><ul><li>  Se refiere al progreso actual en la asignaci√≥n o es un grupo de otros nodos. </li><li>  Puede tener una restricci√≥n m√°xima, de hecho, una indicaci√≥n de la necesidad de usar min (). </li><li>  Puede tener un coeficiente de normalizaci√≥n.  Necesario para conversiones simples multiplicando el resultado por un n√∫mero.  Fuimos √∫tiles para convertir metros a kil√≥metros. </li></ul><br>  Para describir los ejemplos anteriores, una operaci√≥n es suficiente: suma.  La suma es excelente para mostrar claramente el progreso del usuario con un solo n√∫mero, pero se pueden usar otras operaciones si se desea. <br><br>  Aqu√≠ hay una descripci√≥n de estrategia de ejemplo para la √∫ltima categor√≠a: <br><br><pre> <code class="json hljs">{ <span class="hljs-attr"><span class="hljs-attr">"goal"</span></span>: <span class="hljs-number"><span class="hljs-number">15</span></span>, <span class="hljs-attr"><span class="hljs-attr">"operation"</span></span>: <span class="hljs-string"><span class="hljs-string">"sum"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"strategy"</span></span>: [ { <span class="hljs-attr"><span class="hljs-attr">"goal"</span></span>: <span class="hljs-number"><span class="hljs-number">5</span></span>, <span class="hljs-attr"><span class="hljs-attr">"operation"</span></span>: <span class="hljs-string"><span class="hljs-string">"sum"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"strategy"</span></span>: [ { <span class="hljs-attr"><span class="hljs-attr">"objective_id"</span></span>: <span class="hljs-string"><span class="hljs-string">"photo"</span></span> }, { <span class="hljs-attr"><span class="hljs-attr">"objective_id"</span></span>: <span class="hljs-string"><span class="hljs-string">"reviews"</span></span> } ] }, { <span class="hljs-attr"><span class="hljs-attr">"goal"</span></span>: <span class="hljs-number"><span class="hljs-number">10</span></span>, <span class="hljs-attr"><span class="hljs-attr">"operation"</span></span>: <span class="hljs-string"><span class="hljs-string">"sum"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"strategy"</span></span>: [ { <span class="hljs-attr"><span class="hljs-attr">"objective_id"</span></span>: <span class="hljs-string"><span class="hljs-string">"navi"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"normalization_factor"</span></span>: <span class="hljs-number"><span class="hljs-number">0.001</span></span> } ] } ] }</code> </pre><br><h3>  Actualizaciones requeridas </h3><br>  Existen varios controladores que analizan sin descanso los eventos de los usuarios y aplican cambios al progreso de las tareas.  Una b√∫squeda regular de todos los usuarios con cada premio llevar√° a un an√°lisis de varias decenas de millones de premios, lo que no es muy alentador, siempre que las actualizaciones reales se midan en miles.  ¬øC√≥mo aprender solo sobre miles y no desperdiciar millones de CPU? <br><br>  La idea de c√≥mo volver a calcular el progreso solo en aquellos premios que realmente han cambiado, surgi√≥ con bastante rapidez.  Se basa en el uso de relojes vectoriales. <br><br>  Antes de la descripci√≥n recordar√© entidades: <br><br><ul><li>  UserObjective: datos sobre el progreso del usuario al establecer el premio. </li><li>  UserAchieve: recompensa los datos de progreso del usuario. </li></ul><br>  La implementaci√≥n se ve as√≠: <br><br><ul><li>  Obtenemos el campo de versi√≥n para UserObjective y UserAchieve and Sequence en PostgreSQL. </li><li>  Cada actualizaci√≥n de la entidad UserObjective cambia su versi√≥n.  El valor se toma de la secuencia (lo tenemos en com√∫n para todos los registros). </li><li>  El valor de la versi√≥n para UserAchieve se determinar√° como el m√°ximo de las versiones del UserObjective asociado. </li><li>  En cada ciclo de procesamiento, AchievesWorker busca dicho UserObjective para el que no hay UserAchieve o UserAchieve.version &lt;UserObjective.version.  El problema se resuelve con una sola consulta a la base de datos. </li></ul><br>  Vale la pena se√±alar que la soluci√≥n tiene limitaciones en el n√∫mero de entradas en las tablas de premios y tareas, as√≠ como en la frecuencia de los cambios en el progreso de las tareas, pero con un par de decenas de millones de premios y el n√∫mero de actualizaciones de menos de mil por minuto, es bastante posible vivir con una soluci√≥n de este tipo.  De alguna manera, informaremos por separado sobre c√≥mo optimizamos la emisi√≥n del concurso " <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Agentes 2GIS</a> ". <br><br><h2>  Conclusiones </h2><br>  A pesar de que el art√≠culo result√≥ ser bastante voluminoso, quedaron muchos matices detr√°s de escena, ya que no ser√≠a posible hablar brevemente sobre ellos. <br><br>  ¬øQu√© conclusiones hemos llegado gracias a los Premios? <br><br><ul><li>  El principio de "divide y vencer√°s" en este caso jug√≥ en nuestras manos.  La asignaci√≥n de controladores de eventos a cada fuente nos ayuda a escalar cuando es necesario.  Su trabajo est√° aislado seg√∫n los datos y se cruza solo en √°reas peque√±as.  La l√≥gica de recompensa destacada le permite reducir los gastos generales en los controladores de eventos. </li><li>  Si necesita digerir una gran cantidad de datos y el procesamiento es bastante costoso, debe pensar inmediatamente en c√≥mo filtrar lo que definitivamente no es necesario.  La experiencia con el filtrado de una secuencia BSS es un ejemplo. </li><li>  Una vez m√°s, est√°bamos convencidos de que la integraci√≥n de servicios a trav√©s de un bus de eventos com√∫n es muy conveniente y le permite evitar cargas innecesarias en otros servicios.  Si el servicio de Recompensas recibi√≥ datos de servicios de Foto, Rese√±as, etc. a trav√©s de solicitudes http, entonces varios servicios tendr√≠an que estar preparados para una carga adicional. </li><li>  Un poco de metaprogramaci√≥n puede ayudar a mantener la integridad de la configuraci√≥n de datos y separar entornos de forma arbitraria.  El almacenamiento de filtros, reglas y estrategias en la base de datos simplific√≥ el proceso de desarrollo y lanzamiento de nuevos premios. </li></ul></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/470942/">https://habr.com/ru/post/470942/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../470928/index.html">Mejores pr√°cticas para ejecutar Buildah dentro de un contenedor</a></li>
<li><a href="../470930/index.html">Gamificaci√≥n del producto. Ratatype de historia</a></li>
<li><a href="../470934/index.html">Cura antes de la boda: proliferaci√≥n celular y habilidades regenerativas de las medusas</a></li>
<li><a href="../470938/index.html">C√≥mo abrir un enlace en Python. Trabajar con WebBrowser y resolver un problema con Internet Explorer</a></li>
<li><a href="../470940/index.html">MSK VUE.JS Meetup # 3 en Mail.ru Group: materiales de mitap</a></li>
<li><a href="../470950/index.html">bear_hug: juegos en arte ASCII en Python3.6 +</a></li>
<li><a href="../470952/index.html">Consejos y trucos forenses digitales: aplicaci√≥n "Su tel√©fono" Forense</a></li>
<li><a href="../470954/index.html">Instale Zimbra OSE 8.8.15 y Zextras Suite Pro en Ubuntu 18.04 LTS</a></li>
<li><a href="../470958/index.html">Las sondas de vida en Kubernetes pueden ser peligrosas</a></li>
<li><a href="../470962/index.html">JSConf Budapest 2019</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>