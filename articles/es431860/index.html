<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë©üèΩ‚Äç‚öñÔ∏è üßùüèæ ü§® Sobre las opciones del controlador de Linux, o c√≥mo pas√© el fin de semana üòå ü§≥ üå¶Ô∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content=""Somos flojos y curiosos" 


 Esta vez, la raz√≥n de la publicaci√≥n fue un art√≠culo en una buena revista dedicada al sistema operativo Linux (en lo suc...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Sobre las opciones del controlador de Linux, o c√≥mo pas√© el fin de semana</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/431860/"><h3>  "Somos flojos y curiosos" </h3><br><img src="https://habrastorage.org/webt/sh/n6/_h/shn6_hdnwzoz1wv0ifrfabhtbpg.jpeg"><br><br>  Esta vez, la raz√≥n de la publicaci√≥n fue un art√≠culo en una buena revista dedicada al sistema operativo Linux (en lo sucesivo, L), en la que el "experto" atra√≠do elogi√≥ al controlador que conectaba la pantalla LCD a la placa Raspbery.  Dado que tales cosas (conexi√≥n, no el sistema operativo) est√°n dentro del alcance de mis intereses profesionales, revis√© el art√≠culo con atenci√≥n, luego encontr√© el texto real del "controlador" y me sorprendi√≥ un poco que pudiera elogiarse.  Bueno, en general, el nivel de experto puede determinarse solo porque obstinadamente llam√≥ al programa conductor, a pesar de que no lo es.  Parecer√≠a, e higo con √©l, nunca se sabe lo que alguien escribe para s√≠ mismo, pero publicar esto en el dominio p√∫blico: "No sab√≠a que era posible". <br><br>  El hecho de que la direcci√≥n del dispositivo en el bus I2C se estableciera directamente en el texto del programa y para su cambio requiri√≥ su recompilaci√≥n (es bueno que no todo el n√∫cleo) est√© especialmente satisfecho.  Por cierto, not√© que en los foros dedicados a L, la respuesta m√°s popular a cualquier pregunta sobre problemas de software es "reconstruir la √∫ltima versi√≥n del kernel".  Este enfoque me parece un poco extra√±o, probablemente, no s√© algo.  Pero, sin embargo, surgi√≥ la pregunta de c√≥mo se implementa realmente la parametrizaci√≥n del controlador (dentro, no fuera: todo es simple y claro) en A, la respuesta a la que se dedica esta publicaci√≥n. <br><a name="habracut"></a><br>  No es que escribiera constantemente controladores para L, pero con el proceso en su conjunto estoy familiarizado y Google confirm√≥ vagos recuerdos de que hay un conjunto de macros que deber√≠an usarse al crear el texto fuente del m√≥dulo para poder pasarle par√°metros de operaci√≥n, por ejemplo, la direcci√≥n del dispositivo a al bus  Sin embargo, la mec√°nica del proceso en s√≠ no se describi√≥ en ninguna parte.  Vi el mismo texto en numerosos enlaces (por cierto, una pregunta interesante: ¬øpor qu√© hacer esto, es decir, colocar el texto de otra persona en mi recurso? No entiendo realmente el significado de esta operaci√≥n), que describe las macros anteriores.  No encontr√© una sola menci√≥n del mecanismo para realizar la operaci√≥n, para otro sistema operativo conocido (Windows) tendr√≠a que decir un hecho y limitarme a esto, pero una de las ventajas de A es la disponibilidad de textos fuente y la capacidad de encontrar una respuesta a cualquier pregunta sobre su estructura interna, lo que haremos  Noto de inmediato que tratar√© de no duplicar la informaci√≥n que puede obtener de otras fuentes, y me limitar√© solo a lo que sea necesario para comprender el texto. <br><br>  Pero, antes de mirar la fuente, primero pensaremos un poco, pero ¬øc√≥mo lo har√≠amos si tuvi√©ramos una tarea similar (y de repente, despu√©s de esta publicaci√≥n, me invitar√°n a los mineros L, y no te negar√°s).  Por lo tanto, existe la posibilidad de crear un m√≥dulo, una cierta unidad de programa especialmente dise√±ada que se puede cargar en la memoria para su ejecuci√≥n utilizando alguna utilidad del sistema (insmode, en adelante I), mientras se pasa una cadena de caracteres como par√°metros de inicio.  Esta l√≠nea puede incluir unidades l√©xicas estrictamente definidas, cuya descripci√≥n del formato se especifica al crear el texto fuente del m√≥dulo, y estas unidades contienen informaci√≥n que le permite cambiar el valor de las variables internas de este m√≥dulo. <br><br>  Consideremos m√°s cuidadosamente la forma de describir las unidades l√©xicas anteriores, necesitamos esto para considerar varias soluciones.  La unidad de an√°lisis se determina llamando a la macro, que se informa de la informaci√≥n necesaria: el nombre de la variable que se modificar√° durante el proceso de configuraci√≥n, su nombre externo (generalmente el mismo que el anterior), el tipo de variable del conjunto limitado y los derechos de acceso a la variable en el estilo de rw-rw-rw.  Adem√°s, se puede especificar una cadena de texto (opcional) que describe la variable.  Obviamente, esta informaci√≥n es necesaria y suficiente (junto con las reglas para el dise√±o de unidades sint√°cticas - separadores y tokens) para construir el analizador de la lista de par√°metros especificada en forma de una cadena de texto, pero deja espacio para la implementaci√≥n de la distribuci√≥n de funciones entre el participante del proceso. <br><br>  Para configurar el m√≥dulo necesitamos: <br><br><ol><li>  formulario (bueno, esto est√° en la etapa de compilaci√≥n, puedes hacerlo como quieras, aunque todav√≠a es interesante c√≥mo) y almacenar una tabla de las configuraciones anteriores, </li><li>  analizar par√°metros de entrada de acuerdo con esta tabla y </li><li>  realizar cambios en ciertas √°reas de la memoria de acuerdo con el resultado de analizar una unidad sint√°ctica. </li></ol><br>  Pensaremos un poco en el estilo de "si yo fuera el director" y propondremos posibles implementaciones.  C√≥mo podr√≠amos implementar el comportamiento similar de la utilidad del sistema y el m√≥dulo: comenzaremos el an√°lisis de las opciones en una complejidad creciente. <br><br>  La primera soluci√≥n es la utilidad Y no hace casi nada, solo llama al m√≥dulo que se le indica y le transfiere los par√°metros restantes en el estilo de l√≠nea de comando, y el m√≥dulo ya los analiza, bas√°ndose en la informaci√≥n disponible en √©l y realiza las modificaciones necesarias.  Esta soluci√≥n es simple, comprensible y bastante factible, pero se debe tener en cuenta la siguiente circunstancia: de ninguna manera se debe dejar el an√°lisis de par√°metros a la voluntad del autor del m√≥dulo, ya que esto le proporcionar√° un espacio inaceptable y, despu√©s de todo, dos programadores siempre escribir√°n tres opciones de analizador.  Y entonces fuimos a conocerlo, permitiendo que par√°metros de un tipo indefinido, que tienen una cadena de texto como valor, sean suficientes para √©l. <br><br>  Por lo tanto, un cierto analizador est√°ndar debe incluirse autom√°ticamente en el texto del m√≥dulo, esto es f√°cil de implementar en el nivel de macro sustituci√≥n. <br><br>  Esta soluci√≥n tiene dos inconvenientes: <br><br><ol><li>  no est√° claro por qu√© lo necesitamos en absoluto, y puede llamar al m√≥dulo de inmediato con los par√°metros desde la l√≠nea de comandos </li><li>  el c√≥digo del m√≥dulo (parte de inicializaci√≥n) debe contener las tres secciones de la informaci√≥n necesaria, y esta informaci√≥n es necesaria solo cuando se inicia el m√≥dulo y no se utiliza en el futuro, y siempre ocupa espacio.  Inmediatamente haga una reserva de que esta informaci√≥n necesariamente ocupa espacio en el archivo, pero puede no ir a la memoria al cargar el m√≥dulo, si todo se hace con cuidado.  Para hacer exactamente eso, recordamos las directivas _init e _initdata (por cierto, pero c√≥mo funcionan, tendr√≠amos que resolverlo, este es el tema de la pr√≥xima publicaci√≥n, ¬ølo esperar√°n?).  Pero en el √∫ltimo caso, las secciones 2 y 3 de la informaci√≥n en el archivo son claramente redundantes, ya que el mismo c√≥digo estar√° presente en muchos m√≥dulos, violando maliciosamente el principio DRY. </li></ol><br>  Debido a las deficiencias se√±aladas, la implementaci√≥n de esta opci√≥n es altamente improbable.  Adem√°s, no est√° claro por qu√© en la macro establecer informaci√≥n sobre el tipo de par√°metro, porque el m√≥dulo en s√≠ mismo sabe muy bien lo que modifica (aunque puede ser necesario para el analizador cuando verifica los par√°metros).  La evaluaci√≥n general de la probabilidad de tal decisi√≥n es del 2-3 por ciento. <br><br>  La digresi√≥n necesaria sobre el inconveniente n√∫mero 2: me form√© como especialista en aquellos d√≠as en que 256 kbytes de RAM eran suficientes para organizar 4 estaciones de trabajo, 56 kbytes ten√≠an un sistema operativo de doble tarea y un sistema operativo de una sola tarea comenz√≥ a funcionar a 16 kbytes.  Bueno, 650 kb, que deber√≠an ser suficientes para cualquier programa, generalmente eran algo del campo de la ficci√≥n no cient√≠fica.  Por lo tanto, estoy acostumbrado a considerar la RAM como un recurso escaso y desapruebo su uso innecesario si no es causado por una emergencia (por regla general, requisitos de rendimiento), y en este caso no observo esa situaci√≥n.  Como la mayor√≠a de mis lectores se han formado en diferentes realidades, es posible que tenga sus propias evaluaciones de la preferencia de esta o aquella opci√≥n. <br><br>  La segunda soluci√≥n: el analizador en s√≠ mismo se transfiere a AND, que transfiere los datos extra√≠dos al m√≥dulo (su parte de inicializaci√≥n): n√∫mero y valor del par√°metro.  Luego preservamos la uniformidad de los par√°metros y reducimos los requisitos para el tama√±o del m√≥dulo.  La pregunta sigue siendo c√≥mo proporcionar una lista AND de posibles par√°metros, pero esto es proporcionado por las macros creando una estructura predeterminada del m√≥dulo y la ubicaci√≥n del bloque en alg√∫n lugar espec√≠fico (archivo o memoria).  La soluci√≥n es mejor que la anterior, pero a√∫n queda el exceso de memoria en el m√≥dulo.  En general, me gusta la soluci√≥n, porque mi analizador (que es peor que todos los dem√°s programadores, tengo mi propio analizador, no sin fallas, pero definitivamente no fatal) funciona de acuerdo con este esquema, devolviendo el n√∫mero de la regla y el valor identificados al programa principal par√°metro.  Sin embargo, la probabilidad de implementar esta opci√≥n en particular no es muy alta: 5 por ciento. <br><br>  Una subopci√≥n de la segunda soluci√≥n es transferir los par√°metros extra√≠dos no a la parte de inicio del m√≥dulo, sino directamente a su parte de trabajo cargada, por ejemplo, a trav√©s de ioctl: los requisitos de memoria son los mismos.  Tenemos una oportunidad √∫nica para cambiar los par√°metros "sobre la marcha", que no se implementa en otras versiones.  No est√° muy claro por qu√© podr√≠amos necesitar dicha funci√≥n, pero se ve hermosa.  La desventaja es que 1) necesita reservar una parte del √°rea de funciones con anticipaci√≥n para una solicitud posiblemente no utilizada, y 2) el c√≥digo del modificador debe estar presente en la memoria constantemente.  Evaluaci√≥n de la probabilidad de implementaci√≥n - porcentaje 5. <br><br>  La tercera soluci√≥n es transferir a Y tambi√©n la modificaci√≥n de los par√°metros.  Luego, en el proceso de cargar el c√≥digo binario del m√≥dulo Y, puede modificar los datos en la memoria intermedia y cargar el c√≥digo del controlador con los par√°metros modificados en el lugar de implementaci√≥n permanente, o realizar estas modificaciones directamente en el √°rea de memoria en la que se carg√≥ el binario, y la tabla de par√°metros presente en el archivo est√° en la memoria puede cargarlo y no ocuparlo (recuerde las directivas).  La decisi√≥n es responsable, requerir√°, como la anterior, la presencia de un √°rea de comunicaci√≥n predefinida entre el m√≥dulo y AND para almacenar la descripci√≥n de los par√°metros, pero reduce a√∫n m√°s los requisitos de memoria excesiva en el m√≥dulo.  Inmediatamente, notamos el principal inconveniente de tal soluci√≥n: la incapacidad de controlar los valores de los par√°metros y su consistencia, pero no hay nada que hacer.  Es una soluci√≥n bastante normal, lo m√°s probable es que sea un 75 por ciento. <br><br>  Una variante de la tercera soluci√≥n: la informaci√≥n sobre los par√°metros no se almacena en el m√≥dulo en s√≠, sino en alg√∫n archivo auxiliar, entonces simplemente no hay exceso de memoria en el m√≥dulo.  En principio, lo mismo se puede hacer en la versi√≥n anterior, cuando el m√≥dulo contiene la parte de configuraci√≥n, que AND utiliza durante el proceso de arranque, pero no se carga en la RAM que contiene la parte ejecutable real del m√≥dulo.  En comparaci√≥n con la versi√≥n anterior, se agreg√≥ un archivo adicional y no est√° claro lo que estamos pagando, pero tal vez hicieron directivas de inicializaci√≥n antes de la invenci√≥n: 5 por ciento. <br><br>  El 7 por ciento restante se destinar√° a otras opciones que no se me ocurrieron.  Bueno, ahora que nuestra fantas√≠a se ha agotado (la m√≠a es segura, si hay m√°s ideas, por favor pregunte en el comentario), comenzaremos a estudiar la fuente de L. <br><br>  Para empezar, observo que, aparentemente, el arte de distribuir textos fuente en archivos se perdi√≥ junto con el sistema operativo, que cabe en 16 kb, ya que la estructura del directorio, sus nombres y nombres de archivos est√°n conectados con el contenido un poco m√°s que nada.  Dada la presencia de inclusiones incrustadas, el estudio cl√°sico de las fuentes descargadas con la ayuda de un editor se convierte en una b√∫squeda extra√±a y ser√° improductivo.  Afortunadamente, existe una encantadora utilidad Elixir, disponible en l√≠nea, que le permite realizar b√∫squedas contextuales, y aqu√≠ con ella el proceso se vuelve mucho m√°s interesante y fruct√≠fero.  Realic√© mi investigaci√≥n adicional en el sitio elixir.bootlin.com.  S√≠, este sitio no es una colecci√≥n oficial de quesos del n√∫cleo, a diferencia de kernel.org, pero esperemos que el c√≥digo fuente para ellos sea id√©ntico. <br><br>  Primero, veamos una macro para determinar los par√°metros: en primer lugar, conocemos su nombre y, en segundo lugar, deber√≠a ser m√°s f√°cil (s√≠, ahora).  Se encuentra en el archivo moduleparam.h, es bastante razonable, pero es una sorpresa agradable, dado lo que veremos m√°s adelante.  Macro <br><br><pre><code class="cpp hljs">{<span class="hljs-number"><span class="hljs-number">0</span></span>}module_param(name,type,perm)</code> </pre> <br>  es una envoltura <br><br><pre> <code class="cpp hljs"> {<span class="hljs-number"><span class="hljs-number">0</span></span>a}module_param_named(n,n,t,p)</code> </pre> <br>  - Az√∫car sint√°ctico para el caso m√°s com√∫n.  Al mismo tiempo, por alguna raz√≥n, la enumeraci√≥n de los valores permitidos de uno de los par√°metros, a saber, el tipo de la variable, se proporciona en los comentarios antes del texto de contenedor, y no en la segunda macro, que realmente hace el trabajo y puede usarse directamente. <br><br>  La macro {0a} contiene una llamada a tres macros <br><br><pre> <code class="cpp hljs">{<span class="hljs-number"><span class="hljs-number">1</span></span>}param_check_#<span class="hljs-meta"><span class="hljs-meta">#t(n,&amp;v)</span></span></code> </pre> <br>  (hay un conjunto de macros para todos los tipos v√°lidos) <br><br><pre> <code class="cpp hljs">{<span class="hljs-number"><span class="hljs-number">2</span></span>}module_param_cb(n,&amp;op##t,&amp;v,p)</code> </pre> <br>  y <br><br><pre> <code class="cpp hljs">{<span class="hljs-number"><span class="hljs-number">3</span></span>}__MODULE_PARM_TYPE(n,t)</code> </pre> <br>  (preste atenci√≥n a los nombres, sin embargo, encanto), y el primero de ellos se usa en otros lugares, es decir, las recomendaciones de Occam y el principio KISS tambi√©n son descuidadas por los creadores de A, aparentemente, alg√∫n tipo de base para el futuro.  Por supuesto, estas son solo macros, pero no cuestan nada, pero a√∫n as√≠ ... <br><br>  La primera de las tres macros {1}, como su nombre lo indica, verifica la correspondencia de los tipos de par√°metros y las envolturas <br><br><pre> <code class="cpp hljs">__param_check(n,p,t)</code> </pre> <br>  Tenga en cuenta que en la primera etapa de ajuste, el nivel de abstracci√≥n macro disminuye, y en la segunda, probablemente aumenta de una manera diferente, y solo me parece que podr√≠a ser m√°s simple y m√°s l√≥gico, especialmente teniendo en cuenta que la macro promedio no se usa en ning√∫n otro lugar.  Bien, pongamos otra forma de verificar los par√°metros macro en la alcanc√≠a y seguir adelante. <br><br>  Pero las siguientes dos macros en realidad generan un elemento de la tabla de par√°metros.  ¬øPor qu√© no me preguntas dos y no uno? He dejado de entender la l√≥gica de los creadores de L. Es muy probable que, basado en la diferencia en el estilo de estas dos macros, comenzando con los nombres, el segundo de ellos se agreg√≥ m√°s tarde para expandir la funcionalidad y modificar la estructura existente. Era imposible, porque inicialmente se arrepintieron de asignar un lugar para indicar una variante de los par√°metros.  La macro {2}, como siempre, nos oculta la macro <br><br><pre> <code class="cpp hljs">{<span class="hljs-number"><span class="hljs-number">2</span></span>a}_module_param_call(MODULE_PARAM_PREFIX,n,ops,arg,p,<span class="hljs-number"><span class="hljs-number">-1</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>)</code> </pre> <br>  (es curioso que esta macro no se llame directamente a ninguna parte, excepto 8250_core.c, donde se llama con los mismos par√°metros adicionales), pero esta √∫ltima ya produce el c√≥digo fuente. <br><br>  Una peque√±a observaci√≥n: durante la b√∫squeda nos aseguramos de que la navegaci√≥n de texto funcione bien, pero hay dos circunstancias desagradables: la b√∫squeda por el fragmento de nombre no funciona (no se encontr√≥ check_param_, aunque se encontr√≥ check_param_byte) y la b√∫squeda solo funciona en declaraciones de objetos (la variable no se encuentra, entonces se encuentra en este archivo por ctrF, pero no se detecta la b√∫squeda integrada por fuente).  No es muy alentador, porque es posible que necesitemos buscar un objeto fuera del archivo actual, pero "al final, no tenemos otro". <br><br>  Como resultado del trabajo de {1} en el texto del m√≥dulo compilado en presencia de las siguientes dos l√≠neas <br><br><pre> <code class="cpp hljs">module_param_named(name, c, byte, <span class="hljs-number"><span class="hljs-number">0x444</span></span>); module_param_named(name1, i, <span class="hljs-keyword"><span class="hljs-keyword">int</span></span>, <span class="hljs-number"><span class="hljs-number">0x444</span></span>);</code> </pre> <br>  aparece un fragmento del tipo a continuaci√≥n <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> __param_str_name[] = <span class="hljs-string"><span class="hljs-string">"MODULE"</span></span> <span class="hljs-string"><span class="hljs-string">"."</span></span> <span class="hljs-string"><span class="hljs-string">"name"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">kernel_param</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">const</span></span></span><span class="hljs-class"> __</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">param_name</span></span></span><span class="hljs-class"> \ __</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">attribute__</span></span></span><span class="hljs-class">((__</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">used__</span></span></span><span class="hljs-class">)) \ __</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">attribute__</span></span></span><span class="hljs-class"> ((</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">unused</span></span></span><span class="hljs-class">,__</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">section__</span></span></span><span class="hljs-class"> ("__</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">param</span></span></span><span class="hljs-class">"),</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">aligned</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">sizeof</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">void</span></span></span><span class="hljs-class"> *)))) \ = {</span></span> __param_str_name, ((struct <span class="hljs-keyword"><span class="hljs-keyword">module</span></span> *)<span class="hljs-number"><span class="hljs-number">0</span></span>), &amp;param_ops_byte, (<span class="hljs-number"><span class="hljs-number">0x444</span></span>), <span class="hljs-number"><span class="hljs-number">-1</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, { &amp;c } }; <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> __UNIQUE_ID_nametype72[] \ __attribute__((__used__)) __attribute__((section(<span class="hljs-string"><span class="hljs-string">".modinfo"</span></span>), unused, aligned(<span class="hljs-number"><span class="hljs-number">1</span></span>))) \ = <span class="hljs-string"><span class="hljs-string">"parmtype"</span></span> <span class="hljs-string"><span class="hljs-string">"="</span></span> <span class="hljs-string"><span class="hljs-string">"name"</span></span> <span class="hljs-string"><span class="hljs-string">":"</span></span> <span class="hljs-string"><span class="hljs-string">"byte"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> __param_str_name1[] = <span class="hljs-string"><span class="hljs-string">"MODULE"</span></span> <span class="hljs-string"><span class="hljs-string">"."</span></span> <span class="hljs-string"><span class="hljs-string">"name1"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">kernel_param</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">const</span></span></span><span class="hljs-class"> __</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">param_name1</span></span></span><span class="hljs-class"> \ __</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">attribute__</span></span></span><span class="hljs-class">((__</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">used__</span></span></span><span class="hljs-class">)) \ __</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">attribute__</span></span></span><span class="hljs-class"> ((</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">unused</span></span></span><span class="hljs-class">,__</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">section__</span></span></span><span class="hljs-class"> ("__</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">param</span></span></span><span class="hljs-class">"),</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">aligned</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">sizeof</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">void</span></span></span><span class="hljs-class"> *)))) \ = {</span></span> __param_str_name1, ((struct <span class="hljs-keyword"><span class="hljs-keyword">module</span></span> *)<span class="hljs-number"><span class="hljs-number">0</span></span>), &amp;param_ops_int, (<span class="hljs-number"><span class="hljs-number">0x444</span></span>), <span class="hljs-number"><span class="hljs-number">-1</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, { &amp;i } }; <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> __UNIQUE_ID_name1type73[] __attribute__((__used__)) \ __attribute__((section(<span class="hljs-string"><span class="hljs-string">".modinfo"</span></span>), unused, aligned(<span class="hljs-number"><span class="hljs-number">1</span></span>))) \ = <span class="hljs-string"><span class="hljs-string">"parmtype"</span></span> <span class="hljs-string"><span class="hljs-string">"="</span></span> <span class="hljs-string"><span class="hljs-string">"name1"</span></span> <span class="hljs-string"><span class="hljs-string">":"</span></span> <span class="hljs-string"><span class="hljs-string">"int"</span></span>;</code> </pre> <br>  (de hecho, los archivos de una sola l√≠nea se generan all√≠, los divid√≠ en l√≠neas para facilitar su revisi√≥n) e inmediatamente podemos decir que no hay indicios de la inclusi√≥n de una secci√≥n de programa analizador o un m√≥dulo para asignar valores a los par√°metros en el texto fuente, por lo que las opciones 1 y 2 pueden ser considerado excluido de mayor consideraci√≥n.  La presencia de atributos especiales para el enlazador, por as√≠ decirlo, insin√∫a la existencia de una regi√≥n de comunicaci√≥n ubicada en un lugar predeterminado a trav√©s del cual se transmite la descripci√≥n de los par√°metros.  Al mismo tiempo, observamos con desconcierto la ausencia total de cualquier descripci√≥n del bloque generado de posibles par√°metros en forma de texto que podr√≠a ser utilizado por el m√≥dulo analizador.  Est√° claro que el c√≥digo bien escrito es autodocumentado, pero no en la misma medida que nuevamente no aumenta la probabilidad de la opci√≥n 1 o 2, con el analizador escrito por el desarrollador del m√≥dulo. <br><br>  La combinaci√≥n de los atributos __used__ y no utilizados al mismo tiempo parece divertida en la √∫ltima l√≠nea generada, especialmente si observa el siguiente fragmento de c√≥digo macro <br><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> GCC_VERSION &lt; 30300 # </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> __used __attribute__((__unused__)) #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">else</span></span></span><span class="hljs-meta"> # </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> __used __attribute__((__used__)) #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">endif</span></span></span></span></code> </pre> <br>  ¬øCu√°l es el tipo de agilidad que los desarrolladores de A fuman, la forma dolorosamente tortuosa de sus pensamientos incorporados en el c√≥digo?  S√© que puede usar ambas formas de escritura de atributos, pero ¬øpor qu√© hacer esto en la misma l√≠nea? No lo entiendo. <br><br>  Se puede observar una caracter√≠stica m√°s interesante del c√≥digo resultante: la duplicaci√≥n de informaci√≥n sobre el nombre de la variable y su tipo.  Todav√≠a no est√° claro por qu√© se hizo esto, pero el hecho en s√≠ mismo no est√° en duda.  Por supuesto, esta informaci√≥n es coherente, ya que est√° construida en modo autom√°tico, y esta coherencia se conservar√° cuando cambie el texto fuente (y esto es bueno), pero est√° duplicada (y esto es malo), tal vez m√°s adelante comprendamos la necesidad de tal soluci√≥n.  Adem√°s, la necesidad de formar un nombre √∫nico utilizando el n√∫mero de l√≠nea del c√≥digo fuente sigue sin estar clara, porque la primera l√≠nea generada no lo ten√≠a. <br><br>  Otra nota: descubrir exactamente en qu√© se convierte la definici√≥n del par√°metro no fue una tarea completamente trivial, pero gracias a MinGW, a√∫n se complet√≥.  Debajo del cap√≥ hab√≠a una stringificaci√≥n y doble pegado de par√°metros, la formaci√≥n de nombres √∫nicos, as√≠ como otros trucos dif√≠ciles de trabajar con macros, pero solo presento los resultados.  Resumiendo el resultado intermedio, puedo decir que estudiar macros A no es de lo que me gustar√≠a ganarme la vida, solo es posible como entretenimiento, pero continuamos. <br><br>  No avanzaremos en la comprensi√≥n de las macros para comprender la tarea, por lo que recurriremos al c√≥digo fuente de la utilidad And e intentaremos comprender lo que hace. <br><br>  En primer lugar, nos sorprende ver que los quesos requeridos no est√°n incluidos en las fuentes del grano.  S√≠, estoy listo para aceptar que I es una utilidad e interact√∫a con el n√∫cleo a trav√©s del punto de entrada para cargar el m√≥dulo, pero cualquier libro sobre controladores L nos informa sobre esta utilidad, por lo que la falta de una versi√≥n "oficial" de su fuente en alg√∫n lugar cerca de la fuente del n√∫cleo causa malentendido  Bueno, est√° bien, Google no nos decepcion√≥, y de todos modos salimos con el queso. <br><br>  La segunda cosa sorprendente es que esta utilidad se forma a partir de un paquete cuyo nombre no est√° asociado de ninguna manera con su nombre, hay m√°s de un paquete de este tipo y cada uno se nombra a su manera en diferentes lugares, divertido, por decir lo menos.  Si tiene L instalado, entonces con el comando: puede averiguar desde qu√© paquete est√° construido el programa de utilidad I y luego buscarlo, pero si llevamos a cabo una investigaci√≥n te√≥rica (personalmente no mantengo L en la computadora de mi casa por varias razones, algunas de las cuales Dije mis publicaciones, un boxeador te√≥rico), entonces este m√©todo no est√° disponible para nosotros y todo lo que queda es una b√∫squeda en Internet, afortunadamente, da resultados. <br><br>  Bueno, la tercera cosa sorprendente es que el nombre de la utilidad en s√≠ no aparece en ninguna parte del c√≥digo fuente, no se usa en los nombres de archivo y solo se encuentra en el archivo de creaci√≥n, s√© que en C estamos obligados a nombrar la funci√≥n principal principal, y esto no se discute (personalmente, no estoy en Estoy encantado con esto, ya que Pascal est√° malcriado, pero no me pidieron mi opini√≥n al dise√±ar el lenguaje), pero al menos ser√≠a posible escribir el nombre externo de la utilidad en los comentarios.  Nota necesaria: muchas cosas en el lenguaje C se hicieron seg√∫n el principio "es tan habitual con nosotros", que probablemente fue dif√≠cil hacer las cosas diferentes a veces, o incluso imposibles, pero ¬øqu√© se puede hacer ahora, arrastrando una maleta sin un asa m√°s? <br><br>  Encontramos dos paquetes que contienen el texto fuente, y tambi√©n encontramos los quesos en github, vemos que son id√©nticos y creemos que as√≠ es como se ve el c√≥digo fuente de la utilidad.  A continuaci√≥n, estudiamos solo el archivo en git, especialmente dado que aqu√≠ solo se llama insmod.c, encontramos que Y para empezar, convierte la lista de par√°metros en una cadena larga con terminaci√≥n nula, en la que los elementos individuales est√°n separados por espacios.  Despu√©s de esto, llama a dos funciones, la primera de las cuales se llama grub_file y obviamente abre el binario, mientras que la segunda tiene el nombre init_module y toma un puntero a un archivo abierto con el m√≥dulo binario y una cadena de par√°metros y se llama load_module, que sugiere el prop√≥sito de esta funci√≥n como cargar con modificaci√≥n de par√°metros. <br><br>  Pasamos al texto de la segunda funci√≥n, que se encuentra en el archivo ... y aqu√≠ hay un fastidio, no en ninguno de los archivos del repositorio estudiado en Geet (bueno, esto es l√≥gico, esto es parte del n√∫cleo y su lugar no est√° aqu√≠) no lo es.  Google nuevamente tiene prisa por ayudar y nos devuelve a los quesos del n√∫cleo bajo Elixir y el archivo module.c.  Cabe se√±alar que, sorprendentemente, el nombre del archivo que contiene las funciones para trabajar con m√≥dulos parece l√≥gico, ni siquiera entiendo c√≥mo explicar esto, probablemente sucedi√≥ por accidente. <br><br>  Ahora nos qued√≥ claro la falta de texto. Y al lado del n√∫cleo: en realidad no hace casi nada, solo transfiere par√°metros de un formulario a otro y transfiere el control al n√∫cleo mismo, por lo que incluso es indigno de mentir al lado.  A partir de este momento, queda claro que no hay informaci√≥n externa clara sobre la estructura de los par√°metros, ya que el n√∫cleo los omiti√≥ a trav√©s de sus propias macros y sabe todo sobre ellos perfectamente, y el resto no necesita saber nada sobre la estructura interna (a la luz del hecho de que la fuente est√°n disponibles para su visualizaci√≥n, algunos comentarios no afectar√≠an, pero en principio es m√°s y m√°s claro incluso sin ellos), pero hasta ahora casi no ha arrojado luz sobre la implementaci√≥n del mecanismo de ejecuci√≥n en s√≠. <br><br>  Nota: con respecto a la transferencia de control al kernel, me emocion√© un poco, vemos con certeza el uso de la funci√≥n en el c√≥digo fuente de un determinado, y si la parte binaria estar√° vinculada al m√≥dulo, o si realmente est√° en la imagen del kernel, es necesario investigar m√°s a fondo.  El hecho de que el punto de entrada al procesamiento de esta funci√≥n se enmarque de una manera especial, a trav√©s de SYSCALL_DEFINE3, indirectamente testifica a favor de la segunda opci√≥n, pero hace tiempo que entiendo que mis ideas sobre lo l√≥gico e il√≥gico, lo aceptable y lo inaceptable, as√≠ como sobre lo permisible y lo inaceptable, son muy significativas. desviarse de los de los desarrolladores de L. <br><br>  Nota, una piedra m√°s en el jard√≠n de b√∫squeda incorporado, al buscar una definici√≥n para esta macro, vi muchos lugares para usarla como una funci√≥n, entre los cuales la definici√≥n misma de macro se escondi√≥ muy modestamente. <br><br>  Por ejemplo, no entiendo por qu√© se necesita una utilidad externa para traducir los par√°metros del formulario est√°ndar del sistema operativo (agrc, argv) a la forma de una cadena terminada en nulo con espacios como separadores, que el m√≥dulo del sistema procesa a√∫n m√°s; este enfoque supera un poco al m√≠o habilidades cognitivas  Especialmente, dado el hecho de que el usuario ingresa una cadena de par√°metros en forma de una cadena terminada en cero con espacios como separadores, y la utilidad en el n√∫cleo la convierte en una forma (argc, argv).  Que recuerda mucho a la vieja broma "Retiramos la tetera de la estufa, le echamos agua y tenemos un problema cuya soluci√≥n ya se conoce".  Y como trato de adherirme al principio ‚ÄúConsidera a tu interlocutor no m√°s est√∫pido que t√∫, hasta que demuestre lo contrario.  E incluso despu√©s de eso, puede estar equivocado ‚Äù, y con respecto a los desarrolladores de A, la primera frase es definitivamente v√°lida, significa que no entiendo algo, pero no estoy acostumbrado.  Si alguien puede ofrecer una explicaci√≥n razonable del hecho declarado de la doble conversi√≥n, entonces pido en el comentario.  Pero continuamos la investigaci√≥n. <br><br>  Las perspectivas para la implementaci√≥n de las opciones 1 y 2 se vuelven "muy d√©bilmente visibles" (una redacci√≥n encantadora de un art√≠culo reciente sobre las perspectivas de desarrollar ADC nacionales de alta velocidad), ya que ser√≠a muy extra√±o cargar un m√≥dulo en la memoria usando la funci√≥n del kernel, y luego pasarle el control para implementar el kernel. funci√≥n incorporada en su cuerpo.  Y seguro, en el texto de la funci√≥n load_module, encontramos r√°pidamente la llamada parse_args, parece que estamos en el camino correcto.  A continuaci√≥n, pasamos r√°pidamente por la cadena de llamadas (como siempre, veremos funciones de envoltura y macros de envoltura, pero los desarrolladores ya estamos acostumbrados a hacer la vista gorda a esas bromas tan lindas) y encontramos la funci√≥n parse_one, que coloca el par√°metro requerido en el lugar correcto. <br><br>  Tenga en cuenta que no se verifica la validez de los par√°metros, como cabr√≠a esperar, porque el n√∫cleo, a diferencia del m√≥dulo en s√≠, no sabe nada sobre su prop√≥sito.  Hay verificaciones de sintaxis y el n√∫mero de elementos en la matriz (s√≠, puede haber una matriz de enteros como par√°metro) y cuando se detectan errores de este tipo, la carga del m√≥dulo se detiene, pero nada m√°s.  Sin embargo, no todo se pierde, porque despu√©s de cargar el control se transfiere a la funci√≥n init_module, que puede llevar a cabo la validaci√≥n necesaria de los par√°metros establecidos y, si <s>es</s> necesario <s>guardar el lanzamiento</s> , finalizar el proceso de arranque. <br><br>  Sin embargo, pasamos por alto por completo la cuesti√≥n de c√≥mo las funciones de an√°lisis acceden a una matriz de muestras de par√°metros, porque sin esto, el an√°lisis es algo dif√≠cil.  Un vistazo r√°pido al c√≥digo muestra que se ha aplicado un truco sucio, un truco obvio: en el archivo binario, la funci√≥n find_module_sections busca la secci√≥n nombrada __param, divide su tama√±o por el tama√±o del registro (hace mucho m√°s) y devuelve los datos necesarios a trav√©s de la estructura.  Todav√≠a pondr√≠a las letras p delante de los nombres de los par√°metros de esta funci√≥n, pero esto es cuesti√≥n de gustos. <br><br>  Todo parece ser claro y comprensible, lo √∫nico que le preocupa es la ausencia del atributo __initdata en los datos generados, si realmente puede permanecer en la memoria despu√©s de la inicializaci√≥n, probablemente este atributo se describa en alg√∫n lugar de la parte general, por ejemplo, en los datos del vinculador, para ser honesto , perezoso para mirar, ver el ep√≠grafe. <br><br>  En resumen: el fin de semana fue √∫til, fue interesante entender el c√≥digo fuente de L, recordar algo y aprender algo, pero el conocimiento nunca es superfluo. <br>  Bueno, en mis suposiciones, no lo adivin√©, en L se implement√≥ una opci√≥n que result√≥ estar en el 7 por ciento restante, pero dolorosamente no era obvio. <br><br>  Bueno, en conclusi√≥n, el grito de Yaroslavna (¬øc√≥mo podr√≠a uno prescindir de √©l?) ¬øPor qu√© tengo que buscar la informaci√≥n necesaria (no me refiero a la cocina interna, sino a la presentaci√≥n externa) de varias fuentes que no tienen estatus oficial, donde hay un documento similar al libro <br>  ‚ÄúSoftware de una computadora.  Sistema operativo funcional. <br>  RAFOS  Gu√≠a del programador del sistema ", ¬øo ya no? </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/es431860/">https://habr.com/ru/post/es431860/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../es431850/index.html">Heisenbug 2018 Mosc√∫: transmisi√≥n gratuita en l√≠nea, fiesta y mucho m√°s</a></li>
<li><a href="../es431852/index.html">¬øHackear 50,000 impresoras de red e imprimir texto arbitrario? Nada es m√°s f√°cil«É</a></li>
<li><a href="../es431854/index.html">Consistencia de datos en sistemas muy cargados</a></li>
<li><a href="../es431856/index.html">Extender el editor de Unity con la ventana del editor, el objeto con secuencia de comandos y el editor personalizado</a></li>
<li><a href="../es431858/index.html">Mitap Sbertekh en Rostov del Don</a></li>
<li><a href="../es431862/index.html">Mitap Sbertekh en Ekaterimburgo</a></li>
<li><a href="../es431864/index.html">PVS-Studio ROI: c√≥mo no perder millones (versi√≥n borrador del art√≠culo)</a></li>
<li><a href="../es431866/index.html">Conceptos err√≥neos de los programadores sobre nombres, con ejemplos</a></li>
<li><a href="../es431868/index.html">Horas en l√°mparas de descarga de gas (GRI), son reloj Nixie</a></li>
<li><a href="../es431870/index.html">El desarrollador de libros interactivos con LED se queja del robo de ideas por parte de los empleados de Google</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>