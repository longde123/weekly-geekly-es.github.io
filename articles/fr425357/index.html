<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👩‍👩‍👦‍👦 📇 👩🏼‍🤝‍👨🏻 Comment nous avons constitué une pile technologique de 12 étages et ne sommes pas devenus fous 👨🏽‍🌾 ✋🏾 🗝️</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Appodeal est une entreprise de ~ 100 personnes qui travaillent à Moscou, San Francisco, Barnaul, Lutsk, Kirov, Barcelone et depuis juin 2018, égalemen...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Comment nous avons constitué une pile technologique de 12 étages et ne sommes pas devenus fous</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/appodeal/blog/425357/">  Appodeal est une entreprise de ~ 100 personnes qui travaillent à Moscou, San Francisco, Barnaul, Lutsk, Kirov, Barcelone et depuis juin 2018, également à Minsk. <br><br>  Nous monétisons les applications mobiles en diffusant des annonces auprès des utilisateurs.  Nous avons commencé par la médiation publicitaire, mais la pile technologique ne cesse de croître, de sorte que d'autres produits de l'industrie publicitaire ont également été ajoutés à la médiation. <br><br><img src="https://habrastorage.org/webt/9x/iw/99/9xiw995blvp1eqlv6tc-hnfona0.jpeg" alt="image"><br><br>  Pour ceux qui ne connaissent pas Ad Tech, c'est le domaine de travail des entreprises technologiques qui travaillent dans le domaine de la publicité.  Lorsque vous dites à quelqu'un que vous travaillez dans le domaine de la publicité mobile, les gens réagissent souvent avec scepticisme - apparemment, la publicité ennuyeuse "Azino Three Axes" vient à l'esprit.  En fait, ce n'est que la pointe de l'iceberg, et toute cette publicité «sauvage» n'a rien à voir avec le vrai secteur de la publicité. <a name="habracut"></a>  Et le segment mobile dans lequel nous sommes engagés dépasse depuis longtemps le segment de la publicité sur le Web: <br><br><img src="https://habrastorage.org/webt/3-/h8/ep/3-h8epbkxfz3_k8zk_foglrsnym.png" alt="image"><br><br><h4>  Pourquoi intégrer des publicités dans des applications? </h4><br>  Bien sûr, beaucoup de ressources sont consacrées à la création d'applications - et les créateurs / propriétaires veulent que le temps et les efforts consacrés soient payants.  Les propriétaires d'applications mobiles qui publient leur application sur l'App Store / Google Play sont appelés éditeurs ou éditeurs.  Les éditeurs appliquent différents modèles de monétisation, des achats intégrés à la monétisation publicitaire.  Mais de toutes ces méthodes, seule cette dernière permet à l'utilisateur de ne pas payer pour l'utilisation de l'application - et cela donne la plus grande couverture d'audience. <br><br>  Oui, s'il y a trop de publicité, cela ennuiera tout le monde et nuira à la rétention des utilisateurs.  De quoi, bien sûr, personne n'a besoin.  Par conséquent, ils essaient toujours d'intégrer judicieusement la publicité afin de gagner le maximum d'argent sur leur application et en même temps de ne pas toucher un centime aux utilisateurs. <br><br><h4>  Comment ça marche? </h4><br>  Dès que l'éditeur décide de monétiser par la publicité, il s'adresse à l'entreprise qui peut lui faciliter la tâche.  Comment cela se produit-il avec Appodeal?  Après inscription sur le site, nous intégrons son application à notre service.  Cela se fait via le SDK client, qui connecte l'application à la partie serveur et communique avec la partie serveur via l'API. <br><br>  Si vous minimisez les détails, l'objectif de l'interaction est réduit à deux étapes: <br><br>  a.  Déterminez quelle annonce afficher en ce moment; <br>  b.  Envoyez des informations sur la publicité qui a été diffusée ou non, et affichez-la dans les statistiques. <br><br>  Actuellement, Appodeal dessert plusieurs milliers d'applications actives qui fournissent environ 400 à 450 millions d'impressions publicitaires par jour, reçues en réponse à environ 1 milliard de demandes aux réseaux publicitaires (qui sont les fournisseurs de publicité).  Pour que cela fonctionne, nos serveurs traitent environ 125 mille demandes par seconde, soit  environ 10,8 milliards de requêtes par jour. <br><br><img src="https://habrastorage.org/webt/-j/ci/bq/-jcibqnsphakjli4w0tnq5h7mre.png" alt="image"><br><br><h4>  Sur quoi tout cela s'appuie-t-il? </h4><br>  Nous utilisons diverses technologies pour fournir rapidité, fiabilité et en même temps flexibilité de développement et de support.  En ce moment, nous écrivons du code dans les langues suivantes: <br><br><ul><li>  / Ruby / Ruby on Rails + React.JS (front-end) /: Il y a toujours une grande partie de l'API et la totalité du Web Part que les utilisateurs et nos employés voient </li><li>  / GoLang /: Traitement de grandes quantités de données statistiques et pas seulement </li><li>  / Scala /: Demandes de traitement en temps réel pour travailler avec des échanges de trafic en utilisant le protocole RTB (en savoir plus à ce sujet à la fin de l'article) </li><li>  / Elixir / Phoenix /: Plutôt, la partie expérimentale.  Création de micro-services pour gérer certaines statistiques et API. </li></ul><br><img src="https://habrastorage.org/webt/js/dj/qg/jsdjqgdn5x6skyabw52jkl7rokg.png" alt="image"><br><br><h4>  Pourquoi est-ce à l'origine Ruby et Ruby on Rails? </h4><br>  Appodeal est en concurrence sur son segment avec de très gros acteurs, il faut donc s'adapter rapidement aux évolutions du marché.  Cela ressemble souvent à un changement dans les roues d'une voiture à une vitesse de 100 km / h.  Ruby on Rails nous a permis de résister à la course et de prendre suffisamment pied sur le marché pour être un leader dans son segment.  Les principaux avantages de Rails à notre avis: <br><br><ul><li>  Un grand nombre de développeurs qualifiés </li><li>  Grande communauté.  Un grand nombre de solutions et bibliothèques prêtes à l'emploi </li><li>  La vitesse d'introduction de nouvelles fonctionnalités et de modification / suppression des anciennes </li></ul><br><img src="https://habrastorage.org/webt/31/me/zl/31mezlqllshlsqmm0ultc0z7a7i.png" alt="image"><br><br>  Des inconvénients évidents: <br><br><ul><li>  La performance globale est médiocre.  Cela affecte également le manque de JIT (pour le moment), le manque de capacité à paralléliser le code (si vous ne tenez pas compte de JRuby).  Dans une certaine mesure, cela reste supportable car le goulot d'étranglement est généralement la base de données et le cache.  Ce que nous voyons dans l'image de NewRelic: </li></ul><br><img src="https://habrastorage.org/webt/vz/uk/gh/vzukgh2_2ehcbmbf3mhikl-xsdc.png" alt="image"><br><br><ul><li>  Les monolithes ferroviaires ne sont pas très bien coupés sur les microservices - ils sont affectés par un haut degré de connectivité entre la logique métier et la logique d'accès aux données (ActiveRecord). </li></ul><br><h4>  Comment sont stockées les données? </h4><br>  Nous avons beaucoup de données.  Très.  Nous parlons de milliards / dizaines / centaines de milliards d'enregistrements.  Étant donné que les données sont complètement différentes, nous les stockons de différentes manières.  Il ne devrait jamais être limité en architecture à une seule solution, qui est censée être universelle.  La pratique montre que, premièrement, dans Highload, il n'y a pratiquement pas de solutions universelles.  L'universalité signifie des indicateurs moyens (ou nettement inférieurs à la moyenne) pour l'accès / la vitesse de lecture / la taille du stockage de données en tant que frais pour cette polyvalence même.  Deuxièmement, vous devez toujours essayer quelque chose de nouveau, expérimenter et rechercher des solutions non triviales aux tâches.  Total: <br><br><ul><li>  / PostgreSQL /: Nous aimons Postgre.  Nous la considérons comme la meilleure solution de stockage OLTP pour le moment.  Des données sur les utilisateurs, les applications, les campagnes publicitaires, etc. y sont stockées.  Nous utilisons la réplication de réplique primaire.  Nous faisons des sauvegardes uniquement pendant les vacances de Noël, car c'est pour les mauviettes (une blague). </li><li>  / VerticaDB /: Base de données orientée colonne.  Nous utilisons pour stocker des milliards d'enregistrements statistiques.  En bref, Vertika a été considérée pendant un certain temps comme la meilleure solution OLAP pour stocker des analyses.  Le principal inconvénient est le prix énorme (individuel) de la licence. </li><li>  / ClickHouse /: Également une base de données orientée colonnes.  Passez-y progressivement avec VerticaDB.  Nous considérons la meilleure solution OLAP pour le moment.  Ne vaut pas un centime.  Cela fonctionne très rapidement et de manière fiable.  Le principal inconvénient est que les données ne peuvent pas être supprimées et mises à jour (nous en parlerons dans un article séparé, si quelqu'un est intéressé). </li></ul><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/14e/0af/ee0/14e0afee039b7303db9d70c2f2f3892a.gif" alt="image"></div><br><blockquote>  Rien!  Comment est-il impossible de supprimer et de modifier des données?! </blockquote><br><ul><li>  / Aerospike /: Le stockage de valeur-clé NoSQL le plus rapide à notre avis.  Il y a un certain nombre d'inconvénients, mais en général, nous sommes satisfaits.  Il existe même un tableau de comparaison pour Aerospike sur leur site de performances avec d'autres solutions: [Quand utiliser la base de données Aerospike NoSQL par rapport à  Redis] (https://www.aerospike.com/when-to-use-aerospike-vs-redis/) </li><li>  / Redis /: À propos de "Radis", je pense que cela n'a aucun sens de le dire séparément.  Paradoxalement, son principal avantage est la facilité d'utilisation et le filetage unique, ce qui évite les conditions de concurrence, par exemple, lorsque vous travaillez avec des compteurs courants. </li><li>  / Druid /: Nous utilisons pour les grands ensembles de données en collaboration avec les échanges RTB.  En fait, pour la plupart, il joue sur le même terrain avec ClickHouse, mais historiquement, nous n'avons pas encore été en mesure de basculer vers un seul instrument. </li></ul><br><img src="https://habrastorage.org/webt/o0/6j/un/o06junbll0drckljvb8sten_hei.png" alt="image"><br><br>  Un tel ensemble peut sembler surchargé, mais tout d'abord, Appodeal est un grand conglomérat de plusieurs équipes de développement et plusieurs projets au sein d'une seule.  Et deuxièmement, ce sont les dures réalités de la technologie publicitaire - nous ne sommes pas les seuls à utiliser une pile à plusieurs étages au sein d'une entreprise. <br><br><h4>  Comment suivez-vous cela? </h4><br><br>  Les flux de données étant volumineux, ils doivent être mis en file d'attente pour les traiter.  Comme file d'attente, nous utilisons Kafka.  Il s'agit d'une excellente solution fiable écrite en Scala qui ne nous a jamais encore fait défaut. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/-s/ph/sy/-sphsyrohftcyefndm9nuz5hluo.png" alt="image"></div><br><br>  La seule exigence pour l'utilisateur dans ce cas est qu'il ait le temps de ratisser la file d'attente sans cesse croissante plus rapidement qu'elle ne se développe.  Une règle simple et évidente.  Par conséquent, à ces fins, nous utilisons principalement GoLang.  Cependant, cela n'annule pas le fait que la RAM sur ce serveur doit être abondante. <br><br>  Pour surveiller toute cette économie, vous devez surveiller et déléguer littéralement tout de suite.  Pour cela, nous utilisons: <br><br><ul><li>  / NewRelic /: Une solution éprouvée qui s'intègre parfaitement aux services Ruby on Rails et GoLang.  Le seul inconvénient de NewRelic est son prix.  Par conséquent, NewRelic n'est pas partout avec nous.  Pour la plupart, nous essayons de le remplacer par nos propres métriques collectées à la main - nous les mettons dans Grafana. </li><li>  / Statsd + Grafana /: Une bonne chose pour collecter vos métriques.  Avec le seul inconvénient que vous devez tout configurer vous-même et «répéter» la fonctionnalité NewRelic hors de la boîte. </li><li>  / ElasticSearch + Fluentd + Kibana /: Dans les journaux, nous mettons tout en ligne.  Des requêtes PostgreSQL lentes à certains messages système Rails.  En fait, une solution comme Kibana basée sur ElasticSearch vous permet de collecter facilement tous les journaux en un seul endroit, puis de rechercher les messages nécessaires dessus. </li><li>  / Airbrake /: Obligatoire dans ce processus est la collecte des erreurs avec le message stacktrace'ami.  Nous déplaçons actuellement avec Airbrake vers l'une des solutions gratuites.  Pour une raison, encore une fois, les prix. </li></ul><br><img src="https://habrastorage.org/webt/0f/tx/e7/0ftxe7kzizutxsovtqcack5-bzs.png" alt="image"><br><br>  Vous devez comprendre que la surveillance correctement construite est vos yeux et vos oreilles.  Aveuglément impossible de travailler.  Vous devez voir ce qui se passe sur vos serveurs à un moment donné, de sorte que la stabilité et la fiabilité de votre produit dépendront en grande partie de la compétence avec laquelle vous construirez un système de collecte et d'affichage des métriques. <br><br>  Soit dit en passant, en parlant de fiabilité, nous contenons plusieurs serveurs de transfert pour le pré-déploiement et la vérification des versions, que nous maintenons stables sous charge, dupliquant une partie du trafic réel là-bas.  Chaque semaine, nous synchronisons les bases de données entre la production et la mise en scène.  Cela nous donne une sorte de «miroir» qui nous permet de tester les choses qui ne peuvent pas être vérifiées localement, ainsi que d'identifier les problèmes au niveau des tests de charge. <br><br><h4>  Est-ce vraiment si compliqué? </h4><br>  Il en est ainsi.  Comme Elon Musk l'a écrit dans son livre: "Les meilleurs esprits de ma génération sont occupés à amener les gens à cliquer sur les publicités", m'a dit Jeff Hammerbacher, un ancien ingénieur de Facebook.  "Horreur ..."  Une courte liste de ce que fait Appodeal: <br><br><ul><li>  Nous sommes intégrés à deux douzaines de réseaux et agences publicitaires.  En mode automatique, nous enregistrons des applications dans ces réseaux, ainsi que nous configurons divers paramètres pour que ces réseaux fonctionnent à des performances maximales.  Tous les réseaux n'ont pas d'API correspondantes, quelque part vous devez le faire avec des robots. </li><li>  Chaque réseau paie aux utilisateurs des revenus pour les impressions, qui doivent être reçues, ventilées par divers paramètres et traitées.  Cela se fait sans arrêt.  Quelque part, encore une fois, par des robots. </li><li>  Afin de fournir à l'utilisateur un revenu maximal, nous «faisons» concurrencer les grilles, en construisant la soi-disant «cascade» à partir des offres publicitaires.  La cascade est construite sur la base de divers indicateurs, par exemple l'eCPM (prix moyen pour 1000 impressions), que nous prédisons de différentes manières.  Plus l'offre publicitaire dans la cascade est élevée, plus nous en prédisons le prix.  Cette cascade est offerte sur l'appareil aussi souvent que nécessaire.  Comme vous l'avez peut-être deviné, une publicité sur laquelle personne ne clique et qui ne fera qu'ennuyer tout le monde n'intéresse personne.  L'exception n'est que ce qu'on appelle.  Bannières publicitaires «de marque» de Coca-Cola, Pepsi et d'autres géants d'entreprise qui ont l'habitude de parler d'eux-mêmes toujours et partout. </li><li>  Une partie de cette interaction repose sur le protocole dit RTB (Real-Time Bidding): </li></ul><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/dq/ma/fj/dqmafjo0twbm85ocp0p4vnnfkse.png" alt="image"></div><br><br>  Dans ce cas, les soi-disant enchérisseurs sont échangés entre eux en ligne lors d'une vente aux enchères pour le droit de diffuser leurs annonces sur l'appareil sélectionné.  Un point très intéressant qui mérite un article séparé.  De nombreux échanges, tels que Google AdExchange, définissent un cadre serré pour le temps de réponse du serveur (par exemple, 50 ms), ce qui pose un problème de performances de pointe.  En cas de désobéissance - une amende de milliers de dollars.  C'est exactement ce que fait le noyau écrit en Scala avec Druid. <br><br>  Chaque chasseur veut savoir où se trouve le faisan, et nos clients (comme nous) veulent savoir à qui l'annonce a été montrée, quand et pourquoi.  Par conséquent, nous devons mettre en file d'attente (Kafka) tout le tas de données que nous avons, traiter progressivement et ajouter à la base de données OLAP (ClickHouse).  Beaucoup de gens pensent que PostgreSQL ne fera pas face à cette tâche pas pire que toutes les solutions «hipster», mais ce n'est pas le cas.  PostgreSQL est bon, mais la solution classique pour construire des index pour la vitesse d'accès aux données cesse de fonctionner lorsque le nombre de champs pour le filtrage et le tri dépasse 10, et que la quantité de données stockées approche le milliard d'enregistrements.  Vous n'avez tout simplement pas assez de mémoire pour stocker tous ces index ou vous aurez des problèmes pour mettre à jour ces index.  Dans tous les cas, vous ne pourrez pas obtenir les mêmes performances que les solutions orientées colonnes pour les requêtes analytiques. <br><br><h4>  Conclusion </h4><br>  Dans cet article, j'ai essayé de décrire au moins brièvement ce que nous faisons, comment nous stockons et traitons les données.  Dites-nous dans les commentaires la pile que vous utilisez, posez des questions et demandez de nouveaux articles - nous serons heureux de partager notre expérience. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr425357/">https://habr.com/ru/post/fr425357/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr425347/index.html">Masque de vidage: mythe ou réalité</a></li>
<li><a href="../fr425349/index.html">Le forum Positive Hack Days 9 se tiendra les 21 et 22 mai à Crocus Expo</a></li>
<li><a href="../fr425351/index.html">Les programmeurs de bricolage perdent leur emploi</a></li>
<li><a href="../fr425353/index.html">Toute la vérité sur RTOS. Article # 13. Structures de données de tâche et appels d'API non pris en charge</a></li>
<li><a href="../fr425355/index.html">Cote de sécurité du projet ICO</a></li>
<li><a href="../fr425359/index.html">Les Chinois ont utilisé une puce pour contrôler les ordinateurs américains</a></li>
<li><a href="../fr425361/index.html">Blocage de contenu, extension pour les navigateurs au chrome</a></li>
<li><a href="../fr425363/index.html">Conseils pour les étudiants programmeurs</a></li>
<li><a href="../fr425367/index.html">Le jeu Arduino le plus simple avec un écran 1602 - Partie # 2</a></li>
<li><a href="../fr425369/index.html">KTRU (Catalogue des biens, travaux, services) ou la mort des marchés publics informatiques</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>