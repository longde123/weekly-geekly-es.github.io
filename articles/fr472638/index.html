<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üçº ‚¨úÔ∏è üñêüèª Construisez un d√©ambulateur en fonte sur Spring Boot et AppCDS üõ£Ô∏è üë∂üèª üèæ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Partage de donn√©es de classe d'application (AppCDS) - Fonction JVM pour acc√©l√©rer le d√©marrage et √©conomiser de la m√©moire. Apr√®s √™tre apparu √† ses d√©...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Construisez un d√©ambulateur en fonte sur Spring Boot et AppCDS</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/472638/"><p><img src="https://habrastorage.org/webt/se/py/8z/sepy8zdhkojsr-xiqs-lwdtyegy.jpeg"></p><br><p> <strong>Partage de donn√©es de classe d'application (AppCDS)</strong> - <strong>Fonction</strong> JVM pour acc√©l√©rer le d√©marrage et √©conomiser de la m√©moire.  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Apr√®s √™tre apparu</a> √† ses d√©buts dans HotSpot dans JDK 1.5 (2004), il <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">est rest√©</a> longtemps tr√®s limit√©, et m√™me partiellement commercial.  Ce n'est qu'avec OpenJDK 10 (2018) qu'il a √©t√© mis √† la disposition de simples mortels, tout en √©largissant le champ d'application.  Et r√©cemment, Java 13 a essay√© de simplifier cette application. </p><br><p>  L'id√©e d'AppCDS est de ¬´partager¬ª des classes une fois charg√©es entre des instances de la m√™me machine virtuelle Java sur le m√™me h√¥te.  Il semble que cela devrait √™tre id√©al pour les microservices, en particulier les "broilers" sur Spring Boot avec leurs milliers de classes de biblioth√®que, car maintenant ces classes n'auront plus besoin d'√™tre charg√©es (analys√©es et v√©rifi√©es) √† chaque d√©marrage de chaque instance JVM, et elles ne seront pas dupliqu√©es en m√©moire.  Cela signifie que le lancement devrait devenir plus rapide et la consommation de m√©moire devrait √™tre inf√©rieure.  Merveilleux, non? </p><br><p>  Tout est ainsi, tout est ainsi.  Mais si vous, l'odnokhabryanin, ne croyiez pas aux panneaux du boulevard, mais aux chiffres et aux exemples sp√©cifiques, alors bienvenue √† Kat - essayons de comprendre comment c'est vraiment ... </p><a name="habracut"></a><br><h2 id="vmesto-disclaimera">  Au lieu de l'avertissement </h2><br><p>  Avant vous n'est pas un guide d'utilisation d'AppCDS, mais un r√©sum√© des r√©sultats d'une petite √©tude.  J'√©tais int√©ress√© √† comprendre comment cette fonction JVM est applicable dans mon projet de travail, et j'ai essay√© de l'√©valuer du point de vue d'un d√©veloppeur d'entreprise, en exposant le r√©sultat dans cet article.  Cela n'incluait pas des sujets tels que l'utilisation d'AppCDS sur le chemin du module, l'impl√©mentation d'AppCDS sur d'autres machines virtuelles (pas HotSpot) et les subtilit√©s de l'utilisation des conteneurs.  Mais il y a une partie th√©orique pour explorer le sujet, ainsi qu'une partie exp√©rimentale √©crite pour que vous puissiez r√©p√©ter l'exp√©rience vous-m√™me.  Aucun r√©sultat n'a encore √©t√© appliqu√© en production, mais qui sait √† quoi ressemblera demain ... </p><br><h2 id="teoriya">  Th√©orie </h2><br><h3 id="kratkoe-vvedenie-v-appcds">  Une br√®ve introduction √† AppCDS </h3><br><p>  La connaissance de ce sujet peut avoir eu lieu dans plusieurs sources, par exemple: </p><br><ul><li>  dans un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">article</a> de Nikolai Parlog (y compris Java 13 buns, mais sans Spring Boot) </li><li>  dans un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">rapport</a> et un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">article</a> de Volker Simonis (sans Java 13, mais avec des d√©tails) </li><li>  dans un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">rapport de l'</a> auteur de ces lignes (sans Java 13, mais en mettant l'accent sur Spring Boot) </li></ul><br><p>  Afin de ne pas me lancer dans une nouvelle narration, je ne soulignerai que quelques points importants pour cet article. </p><br><p>  Tout d'abord, AppCDS est une extension de la fonction CDS qui est apparue depuis longtemps dans HotSpot, dont l'essence est la suivante: </p><br><p><img src="https://habrastorage.org/webt/gi/kg/ro/gikgrobp0s_hbnr5ox8z6d1ziqc.png"></p><br><p>  Pour donner vie aux deux id√©es, vous devez proc√©der comme suit (en termes g√©n√©raux): </p><br><ol><li>  Obtenez une liste des classes que vous souhaitez partager entre les instances d'application </li><li>  Fusionnez ces classes dans une archive adapt√©e au mappage de la m√©moire </li><li>  Connectez l'archive √† chaque instance de l'application au d√©marrage </li></ol><br><p>  Il semblerait que l'algorithme ne soit que 3 √©tapes - prenez-le et faites-le.  Mais ici commence la nouvelle, toutes sortes de choses. </p><br><p>  La mauvaise chose est que dans le pire des cas, chacun de ces √©l√©ments se transforme en au moins un lancement JVM avec ses propres options sp√©cifiques, ce qui signifie que l'algorithme entier est un jonglage subtil du m√™me type d'options et de fichiers.  Cela ne semble pas tr√®s prometteur, n'est-ce pas? </p><br><p>  Mais il y a une bonne nouvelle: les travaux d'am√©lioration de cet algorithme <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">sont en cours</a> , et √† chaque version de Java, son application devient plus simple.  Ainsi, par exemple: </p><br><ul><li> Dans OpenJDK <strong>10 et 11,</strong> vous pouvez ignorer l'√©tape <strong>1</strong> si vous souhaitez partager uniquement les classes JDK principales, car elles ont d√©j√† √©t√© compil√©es pour nous et plac√©es dans <code>$JAVA_HOME\lib\classlist</code> (‚âà1200 pcs.). </li><li>  Dans OpenJDK <strong>12,</strong> vous pouvez ignorer l' <strong>√©tape 2</strong> , car avec la liste des classes, l'archive de distribution comprend √©galement une archive pr√™te √† l'emploi avec eux, qui est utilis√©e pr√™te √† l'emploi et ne n√©cessite pas de connexion explicite. </li><li>  Au cas o√π vous souhaiteriez partager tout le reste (et le souhaitez g√©n√©ralement) <br>  OpenJDK <strong>13</strong> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">fournit des</a> archives Dynamic CDS - des archives qui sont collect√©es pendant le fonctionnement de l'application et enregistr√©es lors de la dotation en personnel.  Cela vous permet de r√©duire les <strong>points 1 et 2</strong> en un point pas trop confus (bien que tout ne soit pas si simple, mais plus √† ce sujet plus tard). </li></ul><br><p>  Ainsi, quel que soit le processus de pr√©paration d'AppCDS, les 3 √©tapes √©num√©r√©es ci-dessus sont toujours derri√®re, juste dans certains cas, elles sont voil√©es. </p><br><p>  Comme vous l'avez probablement remarqu√©, avec l'av√®nement d'AppCDS, de nombreuses classes d'application commencent une double vie: elles vivent simultan√©ment dans leurs anciens emplacements (le plus souvent des fichiers JAR) et dans une nouvelle archive partag√©e.  Dans le m√™me temps, le d√©veloppeur continue de les modifier / supprimer / compl√©ter au m√™me endroit, et la JVM les reprend de la nouvelle lorsqu'elle fonctionne.  Il n'est pas n√©cessaire d'√™tre un devin pour voir le danger d'une telle situation: si rien n'est fait, t√¥t ou tard des copies des cours se corrodent, et nous obtiendrons de nombreux charmes de ¬´l'enfer JAR¬ª typique.  Il est clair que la JVM ne peut pas emp√™cher les changements de classe, mais elle devrait √™tre capable de d√©tecter un √©cart dans le temps.  Cependant, faire cela en comparant les classes par paires, m√™me par des sommes de contr√¥le, est une id√©e;  il peut annuler le reste des gains de productivit√©.  C'est probablement pourquoi les ing√©nieurs JVM n'ont pas s√©lectionn√© les classes individuelles comme objet de comparaison, mais tout le chemin de classe, et ont <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">d√©clar√©</a> dans la documentation AppCDS: "Le chemin de classe lors de la cr√©ation d'une archive partag√©e doit √™tre le m√™me (ou au moins un pr√©fixe) que lors des lancements ult√©rieurs de l'application." </p><br><blockquote>  Notez que le chemin de classe utilis√© au moment de la cr√©ation de l'archive doit √™tre le m√™me que (ou un pr√©fixe) le chemin de classe utilis√© au moment de l'ex√©cution. </blockquote><p>  Mais ce n'est pas une d√©claration sans ambigu√Øt√©, car, comme vous vous en souvenez, un chemin de classe peut √™tre form√© de diff√©rentes mani√®res, telles que: </p><br><ul><li>  lire des fichiers <code>.class</code> nus √† partir de r√©pertoires de packages compil√©s, <br>  par exemple <code>java com.example.Main</code> </li><li>  l'analyse des r√©pertoires avec des fichiers JAR lors de l'utilisation de caract√®res g√©n√©riques, <br>  par exemple <code>java -cp mydir/* com.example.Main</code> </li><li>  liste explicite des fichiers JAR et / ou ZIP, <br>  par exemple <code>java -cp lib1.jar;lib2.jar com.example.Main</code> </li></ul><br><p>  (sans parler du fait que le <code>-cp/-classpath/--class-path</code> peut √©galement √™tre d√©fini diff√©remment, par exemple via les options JVM <code>-cp/-classpath/--class-path</code> , la <code>CLASSPATH</code> environnement <code>CLASSPATH</code> ou l'attribut du fichier JAR <code>Class-Path</code> √† lancer) </p><br><p>  Parmi ces m√©thodes, une seule est prise en charge dans AppCDS - √©num√©ration explicite des fichiers JAR.  Apparemment, les ing√©nieurs HotSpot JVM ont estim√© que la comparaison des chemins de classe dans l'archive AppCDS et dans l'application lanc√©e ne serait suffisamment rapide et fiable que s'ils √©taient sp√©cifi√©s <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">aussi</a> clairement <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">que possible</a> - avec une liste exhaustive habituelle. </p><br><blockquote>  CDS / AppCDS prend en charge l'archivage des classes √† partir de fichiers JAR uniquement. </blockquote><p>  Il est important de noter ici que cette d√©claration n'est pas r√©cursive, c'est-√†-dire  ne s'applique pas aux fichiers JAR √† l'int√©rieur des fichiers JAR (sauf s'il s'agit de Dynamic CDS, voir ci-dessous).  Cela signifie que les poup√©es JAR habituelles √©mises par Spring Boot ne fonctionneront pas comme √ßa avec AppCDS normal, vous devrez vous asseoir. </p><br><p>  Un autre inconv√©nient du travail de CDS est que les archives partag√©es sont projet√©es sur la m√©moire avec des adresses fixes (commen√ßant g√©n√©ralement √† <code>0x800000000</code> ).  En soi, ce n'est pas mauvais, mais comme la randomisation de la disposition de l'espace d'adressage (ASLR) est activ√©e par d√©faut sur la plupart des syst√®mes d'exploitation, la plage de m√©moire requise peut √™tre partiellement occup√©e.  Dans ce cas, la <code>-Xshare</code> HotSpot fait l‚Äô <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">option</a> sp√©ciale <code>-Xshare</code> qui prend en charge trois valeurs: </p><br><ul><li>  <code>-Xshare:on</code> - force CDS / AppCDS;  si la plage est occup√©e, la JVM se termine avec une erreur.  Ce mode n'est <strong>pas recommand√© pour une utilisation en production</strong> , car cela peut entra√Æner des plantages sporadiques lors du lancement des applications. </li><li>  <code>-Xshare:off</code> - (vous) changez de CDS / AppCDS;  d√©sactive compl√®tement l'utilisation des donn√©es partag√©es (y compris les archives int√©gr√©es) </li><li>  <code>-Xshare:auto</code> - le comportement par d√©faut de la JVM lorsqu'elle, en cas d'impossibilit√© d'allouer la plage de m√©moire requise, se rend discr√®tement et charge les classes comme d'habitude </li></ul><br><p>  Au moment de la r√©daction de cet article, Oracle <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">s'efforce</a> simplement de r√©soudre ces probl√®mes, mais aucun num√©ro de version n'a encore √©t√© attribu√©. </p><br><p>  Ces options nous sont partiellement utiles plus tard, mais pour l'instant, regardons ... </p><br><h3 id="varianty-primeneniya-appcds">  Applications AppCDS </h3><br><p>  Il existe plusieurs fa√ßons d'utiliser AppCDS. <del>  ruine ta vie </del>  optimiser le travail des microservices.  Leur complexit√© et leur profit potentiel varient consid√©rablement. Il est donc important de d√©cider imm√©diatement lequel sera discut√© plus tard. </p><br><p>  Le plus simple est de ne pas utiliser m√™me AppCDS, mais seulement CDS - c'est lorsque seules les classes de plate-forme entrent dans l'archive partag√©e (voir "Une br√®ve introduction √† AppCDS").  Nous supprimerons cette option imm√©diatement, car lorsqu'elle est appliqu√©e aux microservices sur Spring Boot, elle donne trop peu de profit.  Cela peut √™tre vu par la proportion du nombre de classes partag√©es dans leur distribution g√©n√©rale en utilisant l'exemple d'un vrai microservice (voir le segment vert): </p><br><p><img src="https://habrastorage.org/webt/lz/7x/9l/lz7x9lodfzwv4ihwjjifjyxsf_a.png"></p><br><p>  Plus complexe, mais prometteur est l'utilisation d'AppCDS √† part enti√®re, c'est-√†-dire l'inclusion des classes de biblioth√®que et d'application dans la m√™me archive.  Il s'agit de toute une famille d'options d√©riv√©es de combinaisons du nombre d'applications participantes et du nombre d'instances.  Voici les √©valuations subjectives de l'auteur sur les avantages et les difficult√©s de diverses applications d'AppCDS. </p><br><div class="scrollable-table"><table><thead><tr><th>  Non. </th><th>  Les applications </th><th>  Instances </th><th>  B√©n√©fice CPU </th><th>  B√©n√©fice RAM </th><th>  Difficult√© </th></tr></thead><tbody><tr><td>  1 </td><td>  Un </td><td>  Un </td><td>  + </td><td>  ¬± </td><td>  Faible </td></tr><tr><td>  <strong>2</strong> </td><td>  <strong>Un</strong> </td><td>  <strong>Quelques-uns</strong> </td><td>  <strong>++</strong> </td><td>  <strong>++</strong> </td><td>  <strong>Faible</strong> </td></tr><tr><td>  3 </td><td>  Quelques-uns </td><td>  Un √† la fois </td><td>  ++ </td><td>  ++ </td><td>  √âlev√© </td></tr><tr><td>  4 </td><td>  Quelques-uns </td><td>  Quelques-uns </td><td>  +++ </td><td>  +++ </td><td>  √âlev√© </td></tr></tbody></table></div><br><p>  Faites attention: </p><br><ul><li>  Dans l'application √† une application dans une instance (n ¬∞ 1), le gain de m√©moire peut s'av√©rer nul ou m√™me n√©gatif (surtout lors de la mesure <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">sous Windows</a> ) </li><li>  La cr√©ation de l'archive partag√©e correcte n√©cessite des actions, dont la complexit√© ne d√©pend pas du nombre de copies que l'application sera ensuite lanc√©e (comparer les paires d'options n ¬∞ 1-2 et n ¬∞ 3-4) </li><li>  Dans le m√™me temps, le passage d'une instance √† plusieurs donne √©videmment une augmentation du b√©n√©fice pour les deux indicateurs, mais n'affecte pas la complexit√© de la pr√©paration. </li></ul><br><p>  Dans cet article, nous n'atteindrons <strong>que l'option n ¬∞ 2</strong> (√† travers le n ¬∞ 1), car elle est assez simple pour une connaissance approfondie d'AppCDS et seulement pour elle sans astuces suppl√©mentaires, nous pouvons utiliser les archives <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">JEP-350</a> Dynamic CDS r√©cemment publi√©es, que je veux ressentir en action. </p><br><h3 id="dynamic-cds-archives">  Archives dynamiques du CDS </h3><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Les</a> archives dynamiques CDS <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">JEP-350</a> , l'une des principales innovations de Java 13, sont con√ßues pour simplifier l'utilisation d'AppCDS.  Pour ressentir la simplification, vous devez d'abord comprendre la complexit√©.  Permettez-moi de vous rappeler que l'algorithme d'application ¬´propre¬ª classique pour AppCDS se compose de 3 √©tapes: (1) obtenir une liste des classes partag√©es, (2) cr√©er une archive √† partir de celles-ci, et (3) ex√©cuter l'application avec l'archive connect√©e.  De ces √©tapes, seule la 3√®me est r√©ellement utile, le reste ne fait que la pr√©parer.  Et bien que l'obtention d'une liste de classes (√©tape # 1) puisse sembler tr√®s simple (dans certains cas, ce n'est m√™me pas n√©cessaire), en fait lorsque vous travaillez avec des applications non triviales, cela s'av√®re √™tre le plus difficile, en particulier en ce qui concerne Spring Boot.  Le JEP-350 est donc n√©cessaire juste pour √©liminer cette √©tape, ou plut√¥t l'automatiser.  L'id√©e est que la JVM elle-m√™me dresse une liste des classes dont l'application a besoin, puis forme elle-m√™me l'archive dite ¬´dynamique¬ª.  D'accord, √ßa sonne bien.  Mais le hic, c'est que maintenant il devient difficile de savoir √† quel moment cesser d'accumuler des classes et proc√©der √† leur placement dans l'archive.  Auparavant, dans l'AppCDS classique, nous avions choisi un tel moment nous-m√™mes et pouvions m√™me coincer entre ces actions pour changer quelque chose dans la liste des classes avant de le transformer en archive.  Maintenant, cela se produit automatiquement et seulement √† un moment, pour lequel les ing√©nieurs JVM ont peut-√™tre choisi la seule option de compromis - l'arr√™t r√©gulier de la JVM.  Cela signifie que l'archive ne sera pas cr√©√©e avant l'arr√™t de l'application.  Cette solution a deux cons√©quences importantes: </p><br><ul><li>  En cas de plantage de la JVM, l'archive ne sera pas cr√©√©e, quelle que soit la beaut√© de la liste des classes accumul√©es d'ici l√† (vous ne pouvez pas l'extraire plus tard en utilisant des moyens r√©guliers). </li><li>  L'archive sera cr√©√©e uniquement √† partir des classes qui ont r√©ussi √† se charger pendant la session d'application.  Pour les applications Web, cela signifie que la cr√©ation d'une archive en d√©marrant et en s'arr√™tant l√† n'est pas correcte, car alors de nombreuses classes importantes n'entreront pas dans l'archive.  Il est n√©cessaire d'ex√©cuter au moins une requ√™te HTTP sur l'application (et il est pr√©f√©rable de l'ex√©cuter correctement dans tous les sc√©narios) afin que toutes les classes qu'elle utilise r√©ellement soient charg√©es. </li></ul><br><p>  Une diff√©rence importante entre les archives dynamiques et statiques est qu'elles constituent toujours un ¬´module compl√©mentaire¬ª sur les archives statiques de base, qui peuvent √™tre soit des archives <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">int√©gr√©es</a> dans le kit de distribution Java, soit cr√©√©es s√©par√©ment de mani√®re classique en 3 √©tapes. </p><br><p>  Syntaxiquement, l'utilisation des archives Dynamic CDS se r√©sume √† deux lancements JVM avec deux options: </p><br><ol><li>  Essai avec l'option <code>-XX:ArchiveClassesAtExit=archive.jsa</code> , √† la fin de laquelle une archive dynamique sera cr√©√©e (vous pouvez sp√©cifier n'importe quel chemin et nom) </li><li>  Lancement utile avec l'option <code>-XX:SharedArchiveFile=archive.jsa</code> , qui utilisera l'archive pr√©c√©demment cr√©√©e </li></ol><br><p>  La deuxi√®me option n'est pas diff√©rente de la connexion d'une archive statique r√©guli√®re.  Mais si tout √† coup l'archive statique de base n'est pas √† l'emplacement par d√©faut (√† l'int√©rieur du JDK), cette option peut √©galement inclure une indication du chemin d'acc√®s, par exemple: </p><br><pre> <code class="bash hljs">-XX:SharedArchiveFile=base.jsa:dynamic.jsa</code> </pre> <br><p>  <em>(sous Windows, le s√©parateur de chemin doit √™tre le caract√®re ";")</em> </p><br><p>  Vous en savez maintenant assez sur AppCDS pour pouvoir le regarder en action. </p><br><h2 id="praktika">  Pratique </h2><br><h3 id="podopytnyy-krolik">  Lapin exp√©rimental </h3><br><p>  Pour que notre application d'AppCDS dans la pratique ne se limite pas √† un HelloWorld typique, nous prendrons comme base la vraie application sur Spring Boot.  Mes coll√®gues et moi devons souvent regarder les journaux des applications sur des serveurs de test distants et regarder en direct, tout comme ils sont √©crits.  Utiliser pour cela un agr√©gateur de journaux √† part enti√®re (comme ELK) n'est souvent pas appropri√©;  t√©l√©charger des fichiers journaux √† l'infini - pendant longtemps, et regarder la sortie de la console grise de <code>tail</code> est d√©primant.  Par cons√©quent, j'ai cr√©√© une application Web qui peut sortir tous les journaux en temps r√©el directement vers le navigateur, coloriser les lignes par niveau d'importance (en formatant XML en m√™me temps), agr√©ger plusieurs journaux en un seul, ainsi que d'autres astuces.  Il s'appelle <strong>ANALOG</strong> (comme un ¬´analyseur de journaux¬ª, bien que ce ne soit pas vrai) et se trouve <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">sur GitHub</a> .  Cliquez sur la capture d'√©cran pour agrandir: </p><br><p> <a href=""><img src="https://habrastorage.org/webt/q3/lo/m_/q3lom_x6c9wghlerm1g9oa9-yfw.png"></a> </p><br><p>  Techniquement, il s'agit d'une application sur Spring Boot + Spring Integration, sous le capot de laquelle <code>tail</code> , <code>docker</code> et <code>kubectl</code> (pour prendre en charge les journaux de fichiers, les conteneurs Docker et les ressources Kubernetes, respectivement).  Il se pr√©sente sous la forme du fichier JAR Spring Boot ¬´√©pais¬ª classique.  Au moment de l'ex√©cution, <strong>classes10K classes sont suspendues</strong> dans la m√©moire de l'application, dont la grande majorit√© sont des classes Spring et JDK.  √âvidemment, ces classes changent assez rarement, ce qui signifie qu'elles peuvent √™tre plac√©es dans une archive partag√©e et r√©utilis√©es dans toutes les instances de l'application, √©conomisant de la m√©moire et du CPU. </p><br><h3 id="odinochnyy-eksperiment">  Exp√©rience unique </h3><br><p>  Appliquons maintenant les connaissances existantes de Dynamic AppCDS au lapin exp√©rimental.  Puisque tout est connu en comparaison, nous aurons besoin d'un point de r√©f√©rence - l'√©tat du programme avec lequel nous comparerons les r√©sultats obtenus pendant l'exp√©rience. </p><br><h4 id="vvodnye-zamechaniya">  Remarques introductives </h4><br><ul><li>  Toutes les autres commandes sont pour Linux.  Les diff√©rences pour Windows et macOS ne sont pas fondamentales. </li><li>  La compilation JIT peut sensiblement affecter les r√©sultats et, en th√©orie, pour la puret√© de l'exp√©rience, elle pourrait √™tre d√©sactiv√©e (avec l'option <code>-Xint</code> , comme cela a √©t√© fait dans l' <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">article</a> mentionn√©), mais dans un souci de plausibilit√© maximale, il a √©t√© d√©cid√© de ne pas le faire. </li><li>  Les nombres suivants concernant l'heure de d√©but ont √©t√© obtenus sur un serveur de test rapide.  Sur les machines qui fonctionnent, des nombres similaires sont g√©n√©ralement plus modestes, mais comme nous ne nous int√©ressons pas aux valeurs absolues, mais aux incr√©ments de pourcentage, nous consid√©rons cette diff√©rence comme insignifiante. </li><li>  Afin de ne pas entrer pr√©matur√©ment dans la complexit√© de la mesure de la m√©moire partag√©e, pour l'instant nous omettons d'obtenir des lectures pr√©cises en octets.  Au lieu de cela, nous introduisons le concept de ¬´ <strong>potentiel CDS</strong> ¬ª, exprim√© en pourcentage du nombre de classes partag√©es par rapport au nombre total de classes charg√©es.  Il s'agit bien s√ªr d'une quantit√© abstraite, mais d'un autre c√¥t√©, elle affecte directement la consommation r√©elle de m√©moire;  de plus, sa d√©finition ne d√©pend pas du tout de l'OS, et pour son calcul, seuls les logs sont suffisants. </li></ul><br><h4 id="referentnaya-tochka">  Point de r√©f√©rence </h4><br><p>  Soit ce point l'√©tat d'une application fra√Æchement t√©l√©charg√©e, c'est-√†-dire  sans utilisation explicite d'aucun AppCDS'ov et autres.  Pour l'√©valuer, nous avons besoin de: </p><br><ol><li><p>  Installez OpenJDK 13 (par exemple, la distribution <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Liberica</a> domestique, mais pas la version lite). <br>  Il doit √©galement √™tre ajout√© √† la variable d'environnement PATH ou √† <code>JAVA_HOME</code> , par exemple, comme ceci: </p><br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">export</span></span> JAVA_HOME=~/tools/jdk-13</code> </pre> <br></li><li><p>  <a href="">T√©l√©chargez</a> ANALOG (au moment de la r√©daction, la derni√®re version √©tait la v0.12.1). </p><br><p>  Si n√©cessaire, vous pouvez sp√©cifier dans le fichier <code>config/application.yaml</code> du param√®tre <code>server.address</code> le nom d'h√¥te externe pour acc√©der √† l'application (par d√©faut, <code>localhost</code> est sp√©cifi√©). </p><br></li><li><p>  Activez la journalisation du chargement de classe JVM. <br>  Pour ce faire, vous pouvez <code>JAVA_OPTS</code> la variable d'environnement <code>JAVA_OPTS</code> avec cette valeur: </p><br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">export</span></span> JAVA_OPTS=-Xlog:class+load=info:file=<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>/class-load.log</code> </pre> <br><p>  Cette option sera transmise √† la JVM et lui demandera de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">garantir la</a> source de chaque classe. </p><br></li><li><p>  Ex√©cutez un test: </p><br><ol><li>  Ex√©cutez l'application avec le script <code>bin/analog</code> </li><li>  Ouvrez <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">http: // localhost: 8083</a> dans le navigateur, piquez les boutons et les daws </li><li>  Arr√™tez l'application en appuyant sur <code>Ctrl+C</code> dans la console de script <code>bin/analog</code> </li></ol><br></li><li><p>  Prendre le r√©sultat (√† partir des fichiers du <code>log/</code> r√©pertoire) </p><br><ul><li><p>  Nombre total de classes charg√©es (par <code>class-load.log</code> ): </p><br><pre> <code class="bash hljs">cat class-load.log | wc -l 10463</code> </pre> <br></li><li><p>  Combien d'entre eux sont t√©l√©charg√©s √† partir d'une archive partag√©e (selon elle): </p><br><pre> <code class="bash hljs">grep -o <span class="hljs-string"><span class="hljs-string">'source: shared'</span></span> - class-load.log 1146</code> </pre> <br></li><li><p>  Heure de d√©but moyenne (apr√®s une s√©rie de d√©marrages; par <code>analog.log</code> ): </p><br><pre> <code class="bash hljs">grep -oE <span class="hljs-string"><span class="hljs-string">'\(JVM running for .+\)'</span></span> analog.log | grep -oE <span class="hljs-string"><span class="hljs-string">'[0-9]\.[0-9]+'</span></span> | awk <span class="hljs-string"><span class="hljs-string">'{ total += $1; count++ } END { print total/count }'</span></span> 4.5225</code> </pre> <br></li></ul><br></li></ol><br><p>  Ainsi, √† cette √©tape, le potentiel du CDS √©tait de <code>1146/10463=0,1095</code> <strong>-11%</strong> .  Si vous √™tes surpris de l'origine des classes partag√©es (apr√®s tout, nous n'avons pas encore inclus d'AppCDS), je vous rappelle qu'√† partir de la 12√®me version, le JDK <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">inclut l'</a> archive CDS finie <code>$JAVA_HOME/lib/server/classes.jsa</code> , construite par pas moins de liste de classes pr√™te: </p><br><pre> <code class="bash hljs">cat <span class="hljs-variable"><span class="hljs-variable">$JAVA_HOME</span></span>/lib/classlist | wc -l 1170</code> </pre> <br><p>  Maintenant, apr√®s avoir √©valu√© l'√©tat initial de l'application, nous pouvons lui appliquer AppCDS et, par comparaison, comprendre ce que cela donne. </p><br><h4 id="osnovnoy-opyt">  Exp√©rience de base </h4><br><p>  Comme la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">documentation</a> nous a √©t√© l√©gu√©e, pour cr√©er une archive AppCDS dynamique, vous devez effectuer un seul essai de l'application avec l'option <code>-XX:ArchiveClassesAtExit</code> .  D√®s le prochain lancement, l'archive peut √™tre utilis√©e et recevoir des b√©n√©fices.  Pour v√©rifier cela sur le m√™me lapin exp√©rimental (AnaLog), vous avez besoin de: </p><br><ol><li><p>  Ajoutez l'option sp√©cifi√©e √† la commande d'ex√©cution: </p><br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">export</span></span> JAVA_OPTS=<span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$JAVA_OPTS</span></span></span><span class="hljs-string"> -XX:ArchiveClassesAtExit=work/classes.jsa"</span></span></code> </pre> <br></li><li><p>  √âtendre la journalisation: </p><br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">export</span></span> JAVA_OPTS=<span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$JAVA_OPTS</span></span></span><span class="hljs-string"> -Xlog:cds=debug:file=log/cds.log"</span></span></code> </pre><br><p>  Cette option forcera le processus de construction d'une archive CDS √† √™tre enregistr√© lorsque l'application sera arr√™t√©e. </p><br></li><li><p>  Effectuez le m√™me test que pour le point de r√©f√©rence: </p><br><ol><li>  Ex√©cutez l'application avec le script <code>bin/analog</code> </li><li>  Ouvrez <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">http: // localhost: 8083</a> dans le navigateur, piquez les boutons et les daws </li><li>  Arr√™tez l'application en appuyant sur <code>Ctrl+C</code> dans la console de script <code>bin/analog</code> <br>  Apr√®s cela, un √©norme footcloth avec toutes sortes d'avertissements devrait tomber dans la console, et le <code>log/cds.log</code> devrait √™tre rempli de d√©tails;  ils ne nous int√©ressent pas encore. </li></ol><br></li><li><p>  Faites passer le mode de lancement d'essai √† utile: </p><br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">export</span></span> JAVA_OPTS=<span class="hljs-string"><span class="hljs-string">"-XX:SharedArchiveFile=work/classes.jsa -Xlog:class+load=info:file=log/class-load.log -Xlog:class+path=debug:file=log/class-path.log"</span></span></code> </pre><br><p>  Ici, nous ne <code>JAVA_OPTS</code> pas la variable <code>JAVA_OPTS</code> , mais nous la <code>JAVA_OPTS</code> par de nouvelles valeurs qui incluent (1) l'utilisation d'une archive partag√©e, (2) la journalisation des sources de classe et (3) la journalisation des v√©rifications de chemin de classe. </p><br></li><li><p>  Effectuez un lancement utile de l'application selon le sch√©ma du paragraphe 3. </p><br></li><li><p>  Prendre le r√©sultat (√† partir des fichiers du <code>log/</code> r√©pertoire) </p><br><ul><li><p>  V√©rification de l'application r√©elle d'AppCDS (par le <code>class-path.log</code> ): </p><br><pre> <code class="plaintext hljs">[0.011s][info][class,path] type=BOOT [0.011s][info][class,path] Expecting BOOT path=/home/upc/tools/jdk-13/lib/modules [0.011s][info][class,path] ok [0.011s][info][class,path] type=APP [0.011s][info][class,path] Expecting -Djava.class.path=/home/upc/tmp/analog/lib/analog.jar [0.011s][info][class,path] ok</code> </pre><br><p>  Les marques <code>ok</code> apr√®s les lignes <code>type=BOOT</code> et <code>type=APP</code> indiquent respectivement l'ouverture, la v√©rification et le chargement r√©ussis des archives CDS int√©gr√©es et appliqu√©es. </p><br></li><li><p>  Nombre total de classes charg√©es (par <code>class-load.log</code> ): </p><br><pre> <code class="bash hljs">cat class-load.log | wc -l 10403</code> </pre><br></li><li><p>  Combien d'entre eux sont t√©l√©charg√©s √† partir d'une archive partag√©e (selon elle): </p><br><pre> <code class="bash hljs">grep -o <span class="hljs-string"><span class="hljs-string">'source: shared'</span></span> -c class-load.log 6910</code> </pre><br></li><li><p>  Heure de d√©but moyenne (apr√®s une s√©rie de d√©marrages; par fichier <code>analog.log</code> ): </p><br><pre> <code class="bash hljs">grep -oE <span class="hljs-string"><span class="hljs-string">'\(JVM running for .+\)'</span></span> analog.log | grep -oE <span class="hljs-string"><span class="hljs-string">'[0-9]\.[0-9]+'</span></span> | awk <span class="hljs-string"><span class="hljs-string">'{ total += $1; count++ } END { print total/count }'</span></span> 4.04167</code> </pre><br></li></ul><br></li></ol><br><p>  Mais √† ce <code>6910/10403‚âà0,66</code> , le potentiel du CDS √©tait d√©j√† de <code>6910/10403‚âà0,66</code> <strong>= 66%</strong> , c'est-√†-dire qu'il a augment√© <strong>de 55%</strong> par rapport au point de r√©f√©rence.  Dans le m√™me temps, le temps de lancement moyen a √©t√© r√©duit de <code>(4,5225-4,04167)=0,48</code> seconde, soit  le d√©marrage est plus rapide de <strong>‚âà10,6%</strong> de la valeur initiale. </p><br><h4 id="analiz-rezultatov">  Analyse des r√©sultats </h4><br><p>  <em>Le titre de travail de l'article est: "Pourquoi si peu?"</em> </p><br><p>  Nous, comme, avons tout fait selon les instructions, mais toutes les classes n'√©taient pas dans l'archive.  Leur nombre affecte le temps de lancement non moins que la puissance de calcul de la machine de l'exp√©rimentateur, nous allons donc nous concentrer sur ce nombre. </p><br><p>  Si vous vous en souvenez, nous avons ignor√© le fichier <code>log/cds.log</code> cr√©√© lors de l'arr√™t de l'application exp√©rimentale apr√®s la p√©riode d'essai.  Dans ce fichier HotSpot, la JVM a gentiment not√© les classes d'avertissement pour chaque classe qui n'apparaissait pas dans l'archive CDS.  Voici le nombre total de ces marques: </p><br><pre> <code class="bash hljs">grep -o <span class="hljs-string"><span class="hljs-string">'[warning]'</span></span> cds.log -c 3591</code> </pre><br><p>  √âtant donn√© que seules 10 000 classes et plus sont mentionn√©es dans le journal <code>class-load.log</code> et que 66% d'entre elles sont t√©l√©charg√©es √† partir de l'archive, il n'est pas difficile de comprendre que les 3600 classes r√©pertori√©es dans <code>cds.log</code> repr√©sentent les 44% ¬´manquants¬ª du potentiel CDS.  Vous devez maintenant d√©couvrir pourquoi ils ont √©t√© ignor√©s. </p><br><p>  Si vous regardez le journal cds.log, il s'av√®re qu'il n'y a que 4 raisons uniques pour sauter des classes.  Voici des exemples de chacun d'eux: </p><br><pre> <code class="plaintext hljs">Skipping org/springframework/web/client/HttpClientErrorException: Not linked Pre JDK 6 class not supported by CDS: 49.0 org/jrobin/core/RrdUpdater Skipping java/util/stream/Collectors$$Lambda$554: Unsafe anonymous class Skipping ch/qos/logback/classic/LoggerContext: interface org/slf4j/ILoggerFactory is excluded</code> </pre><br><p>  Parmi les 3591 classes manqu√©es, ces raisons se retrouvent ici avec une telle fr√©quence: </p><br><p><img src="https://habrastorage.org/webt/sp/f6/6k/spf66kzmkajvdxki1xdiwjyx9lg.png"></p><br><p>  Examinez-les de plus pr√®s: </p><br><ul><li><p> <code>Unsafe anonymous class</code> <br>   JVM   ‚Äú‚Äù   ,       -,         . </p><br></li><li><p> <code>Not linked</code> <br>      , ‚Äú‚Äù     ,  ,   .      ,     <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">StackOverflow </a>    . , ,       ‚Äú‚Äù () JAR-  ,   AppCDS.       ,     (  ). </p><br></li><li><p> <code>Pre JDK 6 class</code> <br>  ,   CDS    Java 5.        class-   ,   CDS    .    ,    ,  6,  Java,       .       -   ,      runtime- (, slf4j). </p><br></li><li><p> <code>Skipping ... : super class/interface ... is excluded</code> <br>   ,  ‚Äú‚Äù     .          CDS',    .  Par exemple: </p><br><pre> <code class="plaintext hljs">[warning][cds] Pre JDK 6 class not supported by CDS: 49.0 org/slf4j/spi/MDCAdapter [warning][cds] Skipping ch/qos/logback/classic/util/LogbackMDCAdapter: interface org/slf4j/spi/MDCAdapter is excluded</code> </pre><br></li></ul><br><p>  <strong>Conclusion</strong> </p><br><blockquote>  CDS       100%. </blockquote><p> ,     ,  ,         ,  ,     .      . </p><br><h3 id="mnozhestvennyy-eksperiment">   </h3><br><p>    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">JEP-310</a> , AppCDS                         JDK.   .       ,     .    CDS (, ,     )       . </p><br><div class="spoiler"> <b class="spoiler_title"> </b> <div class="spoiler_text"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Afin de cloner le lapin exp√©rimental (ex√©cuter AnaLog dans plusieurs cas), nous devons changer quelque chose dans les param√®tres; </font><font style="vertical-align: inherit;">cela permettra aux processus lev√©s de ne pas ¬´coude¬ª. </font><font style="vertical-align: inherit;">Gr√¢ce √† Spring Boot, vous pouvez le faire sans modifier ni copier aucun fichier; </font><font style="vertical-align: inherit;">tous les param√®tres peuvent √™tre remplac√©s par les options JVM. </font><font style="vertical-align: inherit;">Le transfert de ces options √† partir de la variable d'environnement </font></font><code>ANALOG_OPTS</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">fournit un script de lancement, gentiment g√©n√©r√© par Gradle.</font></font></p><br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">export</span></span> ANALOG_OPTS=<span class="hljs-string"><span class="hljs-string">"-Djavamelody.enabled=false -Dlogging.config=classpath:logging/logback-console.xml"</span></span> <span class="hljs-built_in"><span class="hljs-built_in">export</span></span> ANALOG_OPTS=<span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$ANALOG_OPTS</span></span></span><span class="hljs-string"> -Dnodes.this.agentPort=7801 -Dserver.port=8091"</span></span></code> </pre><br><p>      JavaMelody,             ,        ,       .     TCP-    ;       . </p><br><p>  ,    ,   JVM      AppCDS    .         <code>JAVA_OPTS</code>    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">JVM Unified Logging Framework</a> : </p><br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">export</span></span> JAVA_OPTS=<span class="hljs-string"><span class="hljs-string">"-Xlog:class+load=info:file=log/class-load-%p.log -Xlog:class+path=debug:file=log/class-path-%p.log"</span></span> <span class="hljs-built_in"><span class="hljs-built_in">export</span></span> JAVA_OPTS=<span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$JAVA_OPTS</span></span></span><span class="hljs-string"> -XX:SharedArchiveFile=work/classes.jsa"</span></span></code> </pre><br><p>        <code>%p</code> ,    JVM      (PID).   AppCDS  ,     (         ). </p></div></div><br><h4 id="osnovnoy-opyt-1">   </h4><br><p>  ,          .                  .     : </p><br><ol><li><p>      <code>server.port</code>  <code>nodes.this.agentPort</code> ,      : </p><br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">export</span></span> ANALOG_OPTS=<span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$ANALOG_OPTS</span></span></span><span class="hljs-string"> -Dnodes.this.agentPort=7801 -Dserver.port=8091"</span></span></code> </pre><br><p> ,       (    ). </p><br></li><li><p>    <code>bin/analog</code> </p><br><p> <em>()</em>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">http://localhost:8091</a>  ,     </p><br></li><li><p>  PID  (  ), : </p><br><pre> <code class="bash hljs">pgrep -f analog 13792</code> </pre><br></li><li><p>      <code>pmap</code> (    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="> </a> ): </p><br><pre> <code class="bash hljs">pmap -XX 13792 | sed -n -e <span class="hljs-string"><span class="hljs-string">'2p;$p'</span></span> Address Perm Offset Device Inode Size KernelPageSize MMUPageSize Rss Pss Shared_Clean Shared_Dirty Private_Clean Private_Dirty Referenced Anonymous LazyFree AnonHugePages ShmemPmdMapped Shared_Hugetlb Private_Hugetlb Swap SwapPss Locked ProtectionKey VmFlagsMapping 3186952 1548 1548 328132 325183 3256 0 10848 314028 212620 314024 0 0 0 0 0 0 0 325183 0 KB</code> </pre><br><p>           ;   . </p><br></li><li><p>   1-4     (,  ). </p><br></li></ol><br><h4 id="analiz-rezultatov-1">   </h4><br><p>    <code>pmap</code>             .        CDS'    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">   </a> .    ,  ,        PSS: </p><br><blockquote> The "proportional set size" (PSS) of a process is the count of pages it has in memory, where each page is divided by the number of processes sharing it. So if a process has 1000 pages all to itself, and 1000 shared with one other process, its PSS will be 1500. </blockquote><p>  ,   ,  ‚Äú ‚Äù .        ,      . </p><br><p>    PSS       ,    : </p><br><div class="scrollable-table"><table><thead><tr><th> Iteration: </th><th>  1 </th><th>  2 </th><th>  3 </th><th>  4 </th><th>  5 </th></tr></thead><tbody><tr><td> PSS of inst#1: </td><td> 339 088 </td><td> 313 778 </td><td> 305 517 </td><td> 301 153 </td><td> 298 604 </td></tr><tr><td> PSS of inst#2: </td><td></td><td> 314 904 </td><td> 306 567 </td><td> 302 555 </td><td> 299 919 </td></tr><tr><td> PSS of inst#3: </td><td></td><td></td><td> 314 914 </td><td> 311 008 </td><td> 308 691 </td></tr><tr><td> PSS of inst#4: </td><td></td><td></td><td></td><td> 306 563 </td><td> 304 495 </td></tr><tr><td> PSS of inst#5: </td><td></td><td></td><td></td><td></td><td> 294 686 </td></tr><tr><td> <em>Average:</em> </td><td> 339 088 </td><td> 314 341 </td><td> 308 999 </td><td> 305 320 </td><td> 301 279 </td></tr></tbody></table></div><br><p>         ,      - : </p><br><ul><li>        ‚Äú‚Äù  </li><li>     , PSS   </li><li>  ‚Äú‚Äù ,     PSS      </li></ul><br><p>    ,      .         AppCDS.        ,       <code>-XX:SharedArchiveFile=work/classes.jsa</code>   <code>-Xshare:off</code> ,    CDS .              ,    . </p><br><p><img src="https://habrastorage.org/webt/vq/4s/n6/vq4sn66zppmcyl5aovqj6xpkwyq.png"></p><br><p>       : </p><br><ul><li><p>  PSS  AppCDS      CDS. <br>          <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="></a> .  ,  ,    HelloWorld- JVM   CDS   2   ,   CDS.      PSS            CDS,     .        : </p><br></li><li><p>    PSS   AppCDS    2-  ; 3-      . <br>        ,      ,    ,     .  ,        AppCDS,   ,   ,      3-    . <br>  :    ,    CDS?      : </p><br></li><li><p>    CDS/AppCDS  JVM      ,  PSS       .  ,    ,      <code>pmap</code> ,   ‚Äú‚Äù   <code>sed</code> '.              : </p><br><pre> <code class="bash hljs">pmap -X `pgrep -f analog` 14981: <span class="hljs-comment"><span class="hljs-comment"># ... Address Perm Offset Device Inode Size Rss Pss ... Mapping # ... ... 7faf5e31a000 r-xp 00000000 08:03 269427 17944 14200 14200 ... libjvm.so # ... ... 7faf5f7f9000 r-xp 00000000 08:03 1447189 1948 1756 25 ... libc-2.27.so</span></span></code> </pre><br><p>       ( <code>Mapping</code> )  , ‚Äú‚Äù      .       JVM  ( <code>libjvm.so</code>   ),     ( <code>libc-2.27.so</code>  ).    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="></a>        : </p><br><blockquote> For the Java VM, the read-only parts of the loaded shared libraries (ie <code>libjvm.so</code> ) can be shared between all the VM instances running at the same time. This explains why, taking together, the two VM's consume less memory (ie have a smaller memory footprint) than the simple sum of their single resident set sizes when running alone. </blockquote><br></li></ul><br><p>           .     ,  , .  ,          ,         JVM     ,    Java-    .       <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">  </a>  GeekOut: </p><br><p><img src="https://habrastorage.org/webt/wp/ia/qo/wpiaqom-2teiw_iegjacskkt3sm.png"></p><br><p> , , ,      AppCDS    , ..     Java-.   ,             JVM,  , -      . </p><br><p>       VisualVM      Metaspace    AppCDS  ,      : </p><br><p> <strong> AppCDS</strong> </p><br><p><img src="https://habrastorage.org/webt/pt/wv/6r/ptwv6rmyk8j7f7yzgxrjkqrsvww.png"></p><br><p> <strong> AppCDS</strong> </p><br><p><img src="https://habrastorage.org/webt/dt/jn/0m/dtjn0mdpcgykbfynjbwdma2vmqm.png"></p><br><p>   ,         128     Metaspace   AppCDS    <code>64.2 MiB / 8.96 MiB</code> <strong>‚âà7,2  </strong> ,   CDS .            (.  )       <code>66.4 MiB / 13.9 MiB</code> <strong>‚âà4,8 </strong> .      ,    AppCDS      ,       Metaspace.            Metaspace,    ,    CDS . </p><br><h2 id="vmesto-zaklyucheniya">  Au lieu d'une conclusion </h2><br><p>            Spring Boot  AppCDS ‚Äì  JVM,        . </p><br><ul><li>            JEP-350 Dynamic CDS Archives ‚Äì    JDK 13. </li><li>    Spring Boot  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">√≥</a>          CDS (  ). ,           100%   -   <strong>66%</strong> .      ,      <strong>‚âà11%</strong> (    15%,      ). </li><li>     ,       5-     PSS (      ).  ,  AppCDS     ,   <strong>  </strong>           , <strong> 8%</strong> (PSS).       ,    CDS,     ,     .        AppCDS  <strong> </strong> . </li><li>          Metaspace,  ,         AppCDS  <strong> 5  </strong> ,   CDS. </li></ul><br><p> ,    , AppCDS,  ,    ‚Äúkiller feature‚Äù.           Spring Boot.   ,   ,    AppCDS      .  , ,        AppCDS   <em></em>   Spring Boot.              ,      ‚Ä¶ </p><br><p> <em>  by <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Nick Fewings</a> on <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Unsplash</a></em> </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr472638/">https://habr.com/ru/post/fr472638/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr472620/index.html">Museum DataArt. Inspection du terminal vid√©o Mera CM 7209</a></li>
<li><a href="../fr472622/index.html">Plan de mise √† niveau pour la profession Data Engineer</a></li>
<li><a href="../fr472626/index.html">Test de la carte m√®re ASRock Z390 Phantom Gaming 7: pr√©paration pour 9900KS</a></li>
<li><a href="../fr472628/index.html">Encodages, chiffrement par d√©calage, hachages bruts et cr√©ation d'images √† l'aide de Python PIL. R√©solution de probl√®mes avec r0ot-mi Cryto. Partie 1</a></li>
<li><a href="../fr472636/index.html">Aper√ßu du programme DotNext 2019 Moscou: qui vous dira quoi?</a></li>
<li><a href="../fr472640/index.html">Ce que j'ai appris en 6 ans pour aider les startups √† se d√©velopper</a></li>
<li><a href="../fr472642/index.html">Webdev ind√©pendant - comment et avec qui vous ne devriez PAS travailler</a></li>
<li><a href="../fr472644/index.html">Stages dans des entreprises internationales: comment ne pas remplir l'entretien et obtenir l'offre convoit√©e</a></li>
<li><a href="../fr472650/index.html">Peur, douleur et haine du support technique</a></li>
<li><a href="../fr472658/index.html">Presque tout sur le futur HolyJS 2019 Moscou</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>