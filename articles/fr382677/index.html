<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👨🏾‍🤝‍👨🏼 ‼️ 💃 Mon Internet des objets: Guest Castle (Partie 2) 🤲🏽 👵🏿 🏝️</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Salut GT! Le tout avec le futur et le passé! 
 Je continue l'histoire de la façon dont j'ai connecté la serrure de porte à Internet. Commencez ici . 
...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Mon Internet des objets: Guest Castle (Partie 2)</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/382677/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Salut GT! Le tout avec le futur et le passé! </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Je continue l'histoire de la façon dont j'ai connecté la serrure de porte à Internet. </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Commencez ici</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Un grand merci à tous pour les commentaires. Il y a vraiment des solutions toutes faites, mais il y a aussi un certain nombre de nuances qui ne m'ont pas permis de les utiliser. Un appartement n'est toujours pas un hôtel, nous rejetons donc immédiatement les châteaux spécialisés. Serrures à clé, antennes pour NFC, afin de ne pas effrayer les voisins, nous n'envisageons pas non plus. Aucune carte, jeton ou autre support physique ne peut être utilisé non plus, il est entendu qu'il n'y a aucun moyen de les transférer à un invité avant qu'il n'ouvre la porte.</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Kevo, August ou Lockitron ne pouvaient pas être utilisés, car ils sont basés sur le type américain de serrure (pêne dormant), qui n'est pas très bien installé sur une porte en acier de 65 à 70 mm d'épaisseur. Notre choix est le CISA électromécanique pour portes blindées, au prix d'environ 500 euros (pas encore acheté, car cher). </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Et surtout, je veux faire quelque chose de mes propres mains, ne pas être égoïste au nom des courants de loisir.</font></font><br>
<img src="https://habrastorage.org/files/12f/2b5/6a3/12f2b56a3cae496d9f3717839e37cea1.JPG"><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Permettez-moi de vous rappeler que le contrôleur de verrouillage est situé profondément derrière NAT dans le réseau domestique local, et donc cela n'a aucun sens d'élever un serveur Web sur Arduin; il n'y a aucun moyen de l'atteindre depuis Internet. Le serveur est écrit en Python en utilisant le framework Twisted, fonctionne sous Linux dans un autre endroit où il y a une vraie adresse IP, et le contrôleur s'y connecte et attend les commandes. </font></font><br>
<img src="https://habrastorage.org/files/c3a/803/92b/c3a80392b83f4a0382e764ad8afa142e.png"><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Maintenant, je veux parler de la logique du travail et de la cryptographie. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Je n'ai pas trouvé de trafic crypté pour Arduina, car les communications du château et du serveur passeront par des canaux ouverts avec du trafic non crypté. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans le premier prototype, j'ai utilisé MD5, maintenant je l'ai changé en SHA-1, ici sur cette bibliothèque </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cryptosuite</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Il consomme moins de mémoire et il existe déjà une fonction HMAC prête à l'emploi.</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La clé est un mot de passe de 30 caractères ASCII maximum, stocké dans la mémoire EEPROM du contrôleur. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans le premier prototype, le même mot de passe était stocké explicitement sur le serveur, ce qui n'est bien sûr pas de sécurité. Le deuxième prototype nécessitait deux mots de passe. La première consiste à authentifier le verrou lors de la connexion au serveur, vous ne pouvez pas ouvrir le verrou avec ce mot de passe, il est nécessaire pour que seuls les verrous corrects puissent se connecter au serveur. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le verrou se connecte au serveur et lui indique tout d'abord son identifiant. Le serveur vérifie dans la base de données s'il existe un tel verrou et, le cas échéant, il envoie une séquence ASCII générée de manière aléatoire en réponse. Le verrou le «signe» avec un mot de passe et renvoie le hachage. Le serveur compare le hachage reçu avec ce qu'il a calculé par lui-même, et s'il correspond, il autorisera le contrôleur connecté en tant que «verrou».</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sinon, la connexion est réinitialisée. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le deuxième mot de passe est déjà une clé numérique, il n'est pas stocké sur le serveur. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il fonctionne comme suit: l'application utilisateur appelle via la fonction SOAP sur le serveur, indique l'ID du verrou et la commande qu'il souhaite lui envoyer. Par conséquent, la fonction renvoie l'ID de demande. Le serveur transmet cette commande au contrôleur, le contrôleur envoie une séquence ASCII générée aléatoirement en réponse et attend la réponse «correcte» pendant quelques secondes. Ensuite, l'application utilisateur doit l'obtenir du serveur, via le même SOAP par ID de demande, la signer avec une clé numérique et la renvoyer. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le contrôleur compare le hachage reçu avec celui calculé de lui-même et s'ils correspondent, il exécute la commande précédemment reçue, qui est signalée au serveur.</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le temps pour confirmer la commande est limité à 2 secondes, si aucune réponse n'est reçue pendant ce temps, le contrôleur ignore la commande reçue précédemment. Si les hachages ne correspondent pas, la commande est également ignorée. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ainsi, j'essaie de me protéger de l'attaque de «l'homme au milieu», qui est très facile à agencer sur les fils de mon fournisseur. La connexion y est simple, pas de mots de passe et de certificats, il suffit de couper la paire torsadée dans le bouclier, de la serrer des deux côtés, de la brancher sur le réseau depuis l'appartement avec l'adresse IP du serveur de commande, d'émuler le verrou de l'autre côté (j'ai également écrit un script d'émulation sur le python pour le débogage ), après avoir organisé un tel «pare-feu» avec écoute électronique. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
À cet égard, à mon avis, le château s'est avéré être assez protégé.</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Même le piratage du serveur de commandes et le vol de sa base de données avec des mots de passe pour l'autorisation par le verrou ne feront pas beaucoup de problèmes, car ils ne peuvent pas ouvrir le verrou. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Il ne reste plus qu'à s'occuper des invités. Ce sont les exigences n ° 6-8 du premier article. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Les claviers, les proxys, la RFID et le NFC ne sont pas une option, ce qui précède a expliqué pourquoi. Mais presque tout le monde a un smartphone et tous les smartphones ont Bluetooth, le choix est évident! </font></font><br>
<img src="https://habrastorage.org/files/d2a/1bd/1b0/d2a1bd1b0a2a4f81a906fba3e2640b5e.jpg"><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dans le premier prototype, un invité était associé à un seul code d'accès. Dans la base de données du serveur pour ce code ont été stockés l'ID du verrou, la date et l'heure du début et de la fin de l'accès invité, ainsi, un champ de texte pour le nom lisible par l'homme de l'invité.</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Un invité s'approche de la serrure, lance une application mobile sur son smartphone, il envoie un code d'accès via Bluetooth au contrôleur, un message arrive du contrôleur au serveur indiquant qu'un invité l'a approché avec un certain code d'accès. Le serveur le vérifie par rapport à la base de données, et si le bon invité est arrivé au bon moment au bon endroit, envoie la commande pour ouvrir le verrou. En fait, au lieu du code d'accès clair, l'invité enverra un hachage HMAC signé avec un «timbre temporaire» (une représentation sous forme de chaîne du temps Unix divisé par 30 avec la partie fractionnaire supprimée). Le serveur de vérification fait une demande à la base de données avec une sélection de tous les codes d'accès actuellement valides pour un verrou donné, puis l'itère et calcule un HMAC similaire pour eux, s'il trouve une correspondance, envoie une commande pour ouvrir,si la recherche des codes d'accès se termine avant qu'une correspondance ne puisse être trouvée, une réponse négative est envoyée au verrou lors d'une tentative d'ouverture.</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le problème est que la clé numérique d'une telle autorisation devait être stockée sur le serveur. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
J'ai dû compliquer l'autorisation "invité" pour le deuxième prototype. Le code d'accès invité se compose désormais de deux clés, appelons-les «serveur» et «privé». Le serveur est nécessaire pour établir un compte invité sur le serveur et privé pour ouvrir le verrou lui-même. La salle des serveurs sera explicitement stockée sur le serveur, et à partir de la salle privée, il n'y aura qu'un hachage, mais pas un simple, mais un HMAC avec une clé numérique pour la serrure. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Maintenant, la session d'autorisation d'invité ressemble à ceci: </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
1. L'application invitée passe la clé «serveur» au contrôleur (comme dans le premier prototype son hachage) et </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
2. Le serveur le vérifie de la même manière, mais au lieu de la commande open envoie le hachage de la clé privée</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
3. Le contrôleur compare le hachage de la clé privée reçue du serveur avec celle calculée indépendamment et si elle correspond, le verrou s'ouvre. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ainsi, le serveur ne stocke rien qui pourrait ouvrir le verrou. Il ne fonctionnera pas pour générer le hachage souhaité sans connaître la clé numérique. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Le même Bluetooth est également utilisé pour l'accès «maître» sans Internet. Le contrôleur reçoit des commandes à travers lui, répond avec un code à usage unique, qui doit être signé avec la bonne clé numérique pendant 2 secondes.</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Grâce à lui, je veux faire les réglages de base du contrôleur. </font><font style="vertical-align: inherit;">Le propriétaire appuie sur un bouton spécial du contrôleur, après quoi il commence à accepter un ensemble étendu de commandes, telles que la définition de l'ID de verrouillage, les clés secrètes, l'adresse du port du serveur, les paramètres réseau, etc. </font><font style="vertical-align: inherit;">Mais à Adruin, la mémoire s'est épuisée et le croquis ne correspond pas. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
À la fin, une courte démonstration du travail.</font></font><br>
<iframe width="420" height="315" src="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=https://www.youtube.com/embed/dfSnXt631KQ%3Ffeature%3Doembed&amp;usg=ALkJrhjeZHKmruHwUJtYVvdS1ukMc441Tw" frameborder="0" allowfullscreen=""></iframe></div>
      
    </div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr382677/">https://habr.com/ru/post/fr382677/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr382665/index.html">Stratégies et tactiques d'email marketing. Partie 1</a></li>
<li><a href="../fr382667/index.html">Intel annonce le premier processeur d'ordinateurs portables Xeon</a></li>
<li><a href="../fr382669/index.html">Un nettoyeur. Lutter contre les logiciels impurs</a></li>
<li><a href="../fr382673/index.html">Mortalité du chien robot Aibo</a></li>
<li><a href="../fr382675/index.html">Des paresseux géants du passé pourraient poser des lignes de métro</a></li>
<li><a href="../fr382679/index.html">Les astronomes ont pu obtenir des photos du lac de lave à la surface d'Io, le satellite de Jupiter</a></li>
<li><a href="../fr382681/index.html">5 heures d'approche de Soyouz sur l'ISS - dans une vidéo d'une demi-minute sur YouTube</a></li>
<li><a href="../fr382685/index.html">Regardez au-delà de l'horizon</a></li>
<li><a href="../fr382687/index.html">Des scientifiques du CERN préparent un "champ de force" pour protéger les astronautes des radiations</a></li>
<li><a href="../fr382689/index.html">Nous contrôlons l'éclairage de l'appartement (NooLite, Raspberry Pi et WebIOPi)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>