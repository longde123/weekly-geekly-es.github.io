<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë¥üèº üëÇüèΩ üêπ PowerShell, volcado de mi experiencia üõÄüèø üë©üèæ‚Äçüíª üîî</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Introduccion 


 Este art√≠culo est√° dirigido a aquellos que ya se han familiarizado con los conceptos b√°sicos de PowerShell, ejecutan algunos scripts ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>PowerShell, volcado de mi experiencia</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/443256/"><h2 id="vvedenie">  Introduccion </h2><br><p>  Este art√≠culo est√° dirigido a aquellos que ya se han familiarizado con los conceptos b√°sicos de PowerShell, ejecutan algunos scripts con stackexchange y probablemente tienen su propio archivo de texto con varios fragmentos para facilitar el trabajo diario.  El prop√≥sito de escribirlo es reducir la entrop√≠a, aumentar la legibilidad y la facilidad de mantenimiento del c√≥digo de PowerShell utilizado en su empresa y, como resultado, aumentar la productividad del administrador que trabaja con √©l. </p><br><p><img src="https://habrastorage.org/webt/go/9u/yw/go9uywfoytxpgrxmggcvf2bfi8e.png" alt="kdpv"></p><br><p>  En mi lugar de trabajo anterior, debido a las caracter√≠sticas espec√≠ficas de las tareas y la imperfecci√≥n del mundo, aprovech√© enormemente la habilidad de trabajar con PowerShell.  Despu√©s del cambio de trabajo, cargas de este tipo disminuyeron significativamente y todo lo que estaba a la vuelta de la esquina de los dedos comenz√≥ a hundirse m√°s y m√°s bajo la experiencia de resolver nuevos problemas con nuevas tecnolog√≠as.  A partir de esto, este art√≠culo afirma ser solo lo que se declara a s√≠ mismo, revelando una lista de temas que, en mi opini√≥n, me ser√≠an √∫tiles hace unos 7 a√±os, cuando reci√©n comenc√© a conocer esta herramienta. </p><a name="habracut"></a><br><p>  Si no comprende por qu√© PowerShell es un shell orientado a objetos, qu√© bonificaciones provienen de esto y por qu√© es necesario en absoluto, le aconsejar√© un buen libro que presente r√°pidamente la esencia de este entorno a pesar de los que odian: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Andrey Vladimirovich Popov, Introducci√≥n a Windows PowerShell</a> .  S√≠, se trata de la versi√≥n anterior de PS, s√≠, el lenguaje ha ganado algunas extensiones y mejoras, pero este libro es bueno porque al describir la primera etapa de desarrollo de este entorno, sin darse cuenta, enfatiza solo cosas fundamentales.  El az√∫car sint√°ctica con la que el medio ambiente se ha desbordado, creo, se percibe r√°pidamente sin comprender c√≥mo funciona el concepto.  Leer este libro te llevar√° solo un par de noches, vuelve despu√©s de leer. </p><br><p><img src="https://habrastorage.org/webt/g9/ea/h9/g9eah9nfoao7gukeochjqasi2ne.jpeg" alt="popov"></p><br><p>  El libro tambi√©n est√° disponible en el sitio web del autor, aunque no estoy seguro de qu√© licencia tiene este uso: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">https://andpop.ru/courses/winscript/books/posh_popov.pdf</a> </p><br><h2 id="stayl-gaydy">  Gu√≠as de estilo </h2><br><p>  Dise√±ar guiones de acuerdo con gu√≠as de estilo es una buena pr√°ctica en todos los casos de su aplicaci√≥n, apenas puede haber dos opiniones.  Algunos ecosistemas se han ocupado de esto en el nivel de ajuste nativo, pep8 en la comunidad de Python e ir a Golang en Golang se vuelve obvio.  Estas son herramientas invaluables para ahorrar tiempo, que, lamentablemente, est√°n ausentes en el paquete est√°ndar de PowerShell y, por lo tanto, transfieren el problema a nuestra cabeza.  Actualmente, la √∫nica forma de resolver el problema del formato de c√≥digo uniforme es desarrollar reflejos escribiendo c√≥digo repetidamente que satisfaga las gu√≠as de estilo (de hecho, no). </p><br><p>  Las gu√≠as de estilo debido a la falta de aprobaci√≥n oficial y descritas en detalle por Microsoft nacieron en la comunidad durante el tiempo de PowerShell v3 y desde entonces se han desarrollado en forma abierta en el github: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">PowerShellPracticeAndStyle</a> .  Este es un repositorio digno de menci√≥n para cualquiera que haya usado el bot√≥n "Guardar" en PowerShell ise. </p><br><p>  Si intenta hacer un apret√≥n, probablemente se reducir√° a los siguientes puntos: </p><br><ul><li>  PowerShell usa PascalCase para nombrar variables, cmdlets, nombres de m√≥dulos y casi todo excepto los operadores; </li><li> Los operadores de lenguaje como <code>if</code> , <code>switch</code> , <code>break</code> , <code>process</code> , <code>-match</code> est√°n escritos en letras muy peque√±as; </li><li>  Los corchetes se colocan de la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">√∫nica manera verdadera</a> , de lo contrario tambi√©n se llama el estilo de Kernigan y Richie, liderando su historia del libro <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">The C Programming Language</a> ; </li><li>  No use alias en ning√∫n lugar que no sea una sesi√≥n de consola interactiva, no escriba ning√∫n <code>ps | ? processname -eq firefox | %{$ws=0}{$ws+=$_.workingset}{$ws/1MB}</code> archivo de script <code>ps | ? processname -eq firefox | %{$ws=0}{$ws+=$_.workingset}{$ws/1MB}</code> <code>ps | ? processname -eq firefox | %{$ws=0}{$ws+=$_.workingset}{$ws/1MB}</code>  <code>ps | ? processname -eq firefox | %{$ws=0}{$ws+=$_.workingset}{$ws/1MB}</code> ; </li><li>  Indique nombres de par√°metros expl√≠citos, el <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">comportamiento de los cmdlets y su firma pueden cambiar</a> , adem√°s esto agrega un contexto a una persona que no est√° familiarizada con un cmdlet en particular; </li><li>  Dise√±e los par√°metros para llamar scripts, y no escriba una funci√≥n dentro del script y la √∫ltima l√≠nea llama a esta funci√≥n con la necesidad de cambiar los valores de las variables globales en lugar de especificar par√°metros; </li><li>  Especifique [CmdletBinding ()]: esto le dar√° a su cmdlet los <code>-Verbose</code> y <code>-Debug</code> y <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">muchas otras caracter√≠sticas √∫tiles</a> .  A pesar de la posici√≥n firme de algunos puristas en la comunidad, no soy partidario de indicar este atributo en funciones simples en l√≠nea y filtros que consisten en varias l√≠neas literales; </li><li>  Escriba una ayuda basada en comentarios: una oraci√≥n, enlace de ticket, ejemplo de llamada; </li><li>  Especifique la versi√≥n requerida de PowerShell en la secci√≥n <code>#requires</code> ; </li><li>  Use <code>Set-StrictMode -Version Latest</code> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">esto lo ayudar√° a evitar los problemas que se describen a continuaci√≥n</a> ; </li><li>  Manejar errores; </li><li>  No se apresure a reescribir todo en PowerShell.  PowerShell es principalmente un shell y llamar a los binarios es su tarea directa.  No hay nada de malo en usar robocopy en un script, por supuesto, no es rsync, pero tambi√©n es muy bueno. </li></ul><br><h2 id="comment-based-help">  Ayuda basada en comentarios </h2><br><p>  A continuaci√≥n se muestra un ejemplo de c√≥mo obtener la secuencia de comandos de ayuda.  El script enmarca la imagen llev√°ndola a un cuadrado y realiza un cambio de tama√±o, creo que tiene la tarea de hacer avatares para los usuarios (excepto quiz√°s la rotaci√≥n de acuerdo con los datos exif).  Hay un ejemplo de uso en la secci√≥n <code>.EXAMPLE</code> , pru√©balo.  Debido al hecho de que PowerShell se ejecuta mediante Common Language Runtime, al igual que otros lenguajes dotnet, tiene la capacidad de utilizar todo el poder de las bibliotecas dotnet: </p><br><pre> <code class="plaintext hljs">&lt;# .SYNOPSIS Resize-Image resizes an image file .DESCRIPTION This function uses the native .NET API to crop a square and resize an image file .PARAMETER InputFile Specify the path to the image .PARAMETER OutputFile Specify the path to the resized image .PARAMETER SquareHeight Define the size of the side of the square of the cropped image. .PARAMETER Quality Jpeg compression ratio .EXAMPLE Resize the image to a specific size: .\Resize-Image.ps1 -InputFile "C:\userpic.jpg" -OutputFile "C:\userpic-400.jpg"-SquareHeight 400 #&gt; # requires -version 3 [CmdletBinding()] Param( [Parameter( Mandatory )] [string]$InputFile, [Parameter( Mandatory )] [string]$OutputFile, [Parameter( Mandatory )] [int32]$SquareHeight, [ValidateRange( 1, 100 )] [int]$Quality = 85 ) # Add System.Drawing assembly Add-Type -AssemblyName System.Drawing # Open image file $Image = [System.Drawing.Image]::FromFile( $InputFile ) # Calculate the offset for centering the image $SquareSide = if ( $Image.Height -lt $Image.Width ) { $Image.Height $Offset = 0 } else { $Image.Width $Offset = ( $Image.Height - $Image.Width ) / 2 } # Create empty square canvas for the new image $SquareImage = New-Object System.Drawing.Bitmap( $SquareSide, $SquareSide ) $SquareImage.SetResolution( $Image.HorizontalResolution, $Image.VerticalResolution ) # Draw new image on the empty canvas $Canvas = [System.Drawing.Graphics]::FromImage( $SquareImage ) $Canvas.DrawImage( $Image, 0, -$Offset ) # Resize image $ResultImage = New-Object System.Drawing.Bitmap( $SquareHeight, $SquareHeight ) $Canvas = [System.Drawing.Graphics]::FromImage( $ResultImage ) $Canvas.DrawImage( $SquareImage, 0, 0, $SquareHeight, $SquareHeight ) $ImageCodecInfo = [System.Drawing.Imaging.ImageCodecInfo]::GetImageEncoders() | Where-Object MimeType -eq 'image/jpeg' # https://msdn.microsoft.com/ru-ru/library/hwkztaft(v=vs.110).aspx $EncoderQuality = [System.Drawing.Imaging.Encoder]::Quality $EncoderParameters = New-Object System.Drawing.Imaging.EncoderParameters( 1 ) $EncoderParameters.Param[0] = New-Object System.Drawing.Imaging.EncoderParameter( $EncoderQuality, $Quality ) # Save the image $ResultImage.Save( $OutputFile, $ImageCodecInfo, $EncoderParameters )</code> </pre> <br><p>  El script anterior comienza con un comentario de varias l√≠neas <code>&lt;# ... #&gt;</code> , si este comentario es el primero y contiene ciertas palabras clave, PowerShell generar√° autom√°ticamente ayuda para el script.  Este tipo de ayuda se llama literalmente: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">ayuda basada en el comentario</a> : </p><br><p><img src="https://habrastorage.org/webt/9y/tw/d3/9ytwd3hlr6yb5nsobqqor_bjshw.png" alt="ayuda"></p><br><p>  Adem√°s, cuando se llama al script, la informaci√≥n sobre herramientas para los par√°metros funcionar√°, ya sea la consola PowerShell o el editor de c√≥digo: </p><br><p><img src="https://habrastorage.org/webt/tr/ha/qg/trhaqga49fwvjphbl6i_cporowa.png" alt="ayuda en l√≠nea"></p><br><p>  Una vez m√°s, llamo la atenci√≥n sobre el hecho de que no debe descuidarse.  Si no sabe qu√© escribir all√≠, escriba algo, vaya al refrigerador y al regresar definitivamente comprender√° lo que debe cambiarse por escrito.  Funciona  No complete fan√°ticamente todas las palabras clave, PowerShell est√° dise√±ado para autodocumentarse y, si proporcion√≥ nombres significativos y completos a los par√°metros, una breve oraci√≥n en la secci√≥n <code>.SYNOPIS</code> y un ejemplo son suficientes. </p><br><h2 id="strict-mode">  Modo estricto </h2><br><p>  PowerShell, como muchos otros lenguajes de secuencias de comandos, tiene una tipificaci√≥n din√°mica.  Este tipo de mecanograf√≠a tiene muchos partidarios: escribir una l√≥gica de alto nivel simple pero poderosa es cuesti√≥n de unos minutos, pero cuando su decisi√≥n comience a llegar a mil l√≠neas, seguramente encontrar√° la fragilidad de este enfoque. </p><br><p>  La salida autom√°tica de tipos invariablemente en la etapa de prueba, que form√≥ una matriz en el lugar donde siempre recibi√≥ un conjunto de elementos, definitivamente pondr√° un cerdo en caso de que obtenga un elemento y en la siguiente condici√≥n, en lugar de verificar el n√∫mero de elementos, obtendr√° el n√∫mero de caracteres u otro atributo, dependiendo de tipo de art√≠culo  La l√≥gica del script se romper√° y el tiempo de ejecuci√≥n fingir√° que todo est√° bien. </p><br><p>  Establecer el modo estricto ayuda a evitar algunos de estos problemas, pero tambi√©n requiere un poco m√°s de c√≥digo, como la inicializaci√≥n de variables y la conversi√≥n expl√≠cita. </p><br><p>  Este modo est√° habilitado por el cmdlet <code>Set-StrictMode -Version Latest</code> , aunque hay otras opciones para el "rigor", mi elecci√≥n es usar este √∫ltimo. </p><br><p>  En el ejemplo a continuaci√≥n, el modo estricto captura una llamada a una propiedad inexistente.  Dado que solo hay un elemento dentro de la carpeta, el tipo de la variable <code>$Input</code> como resultado de la ejecuci√≥n ser√° <code>FileInfo</code> y no la matriz esperada de los elementos correspondientes: </p><br><p><img src="https://habrastorage.org/webt/fk/q-/jk/fkq-jkrdldogwcwyiwkwspskseq.png" alt="estricto"></p><br><p>  Para evitar este problema, debe convertir expl√≠citamente el resultado del cmdlet a una matriz: </p><br><pre> <code class="plaintext hljs">$Items = @( Get-ChildItem C:\Users\snd3r\Nextcloud )</code> </pre> <br><p>  Establezca una regla para establecer siempre el modo estricto, esto le permitir√° evitar resultados inesperados al ejecutar sus scripts. </p><br><h2 id="obrabotka-oshibok">  Manejo de errores </h2><br><h3 id="erroractionpreference">  ErrorActionPreference </h3><br><p>  Cuando miro los scripts de otras personas, por ejemplo, en un github, a menudo veo ignorar por completo el mecanismo de manejo de errores o activar expl√≠citamente el modo de continuaci√≥n silenciosa en caso de error.  El problema de manejo de errores ciertamente no es el m√°s f√°cil de programar en general y en los scripts en particular, pero definitivamente no merece ser ignorado.  De forma predeterminada, PowerShell en caso de error lo muestra y contin√∫a funcionando (simplifiqu√© un poco el concepto, pero a continuaci√≥n hay un enlace a un libro git sobre este tema).  Esto es conveniente si necesita distribuir con urgencia la actualizaci√≥n de un programa que se usa ampliamente en el dominio a todas las m√°quinas, sin esperar hasta que se extienda a todos los puntos de implementaci√≥n de sccm o se difunda de otra manera utilizada por usted.  Es desagradable interrumpir y reiniciar el proceso si una de las m√°quinas est√° apagada, esto es cierto. </p><br><p>  Por otro lado, si realiza una copia de seguridad compleja de un sistema que consta de m√°s de un archivo de datos de m√°s de una parte del sistema de informaci√≥n, debe asegurarse de que su copia de seguridad sea coherente y que todos los conjuntos de datos necesarios se hayan copiado sin errores. </p><br><p>  Para cambiar el comportamiento de los cmdlets en caso de error, hay una variable global <code>$ErrorActionPreference</code> , con la siguiente lista de valores posibles: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Stop, Inquire, Continue, Suspend, SilentlyContinue</a> . </p><br><p>  Le recomiendo que siempre use el valor <code>Stop</code> cuando el n√∫mero de scripts o su complejidad deje de almacenarse en la pila en su cabeza, es mejor asegurarse de que en cualquier situaci√≥n imprevista el script detendr√° su trabajo y no romper√° la le√±a "en silencio", completando la ejecuci√≥n "con √©xito". </p><br><p>  Adem√°s de detener el script en caso de que algo salga mal, hay otro requisito previo para su uso: manejar situaciones excepcionales.  Hay una construcci√≥n <code>try/catch</code> para esto, pero solo funciona si el error hace que la ejecuci√≥n se detenga.  No es necesario que la parada deba habilitarse en el nivel de todo el script, <code>ErrorAction</code> puede establecer en el nivel de cmdlet con el par√°metro: </p><br><pre> <code class="plaintext hljs">Get-ChildItem 'C:\System Volume Information\' -ErrorAction 'Stop'</code> </pre> <br><p>  En realidad, esta posibilidad define dos estrategias l√≥gicas: resolver todos los errores "por defecto" y establecer <code>ErrorAction</code> solo para lugares cr√≠ticos donde manejarlos;  habilite a nivel de todo el script configurando el valor de la variable global y configurando <code>-ErrorAction 'Continue'</code> en operaciones no cr√≠ticas.  Siempre elijo la segunda opci√≥n, no tengo prisa por imponerle, solo recomiendo una vez que comprenda este problema y use esta herramienta √∫til. </p><br><h3 id="trycatch">  intentar / atrapar </h3><br><p>  En el controlador de errores, puede hacer coincidir el tipo de excepci√≥n y operar con un hilo de ejecuci√≥n o, por ejemplo, agregar un poco m√°s de informaci√≥n.  A pesar de que al usar los operadores <code>try/catch/throw/trap</code> puede construir todo el flujo de ejecuci√≥n del script, debe evitarlo categ√≥ricamente, ya que dicho m√©todo de operar con ejecuci√≥n no solo se considera un antipater extremo de la categor√≠a "goto-noodle", por lo que Tambi√©n reduce dr√°sticamente el rendimiento. </p><br><pre> <code class="plaintext hljs">#requires -version 3 $ErrorActionPreference = 'Stop' #   ,    , #          $Logger = Get-Logger "$PSScriptRoot\Log.txt" #    trap { $Logger.AddErrorRecord( $_ ) exit 1 } #    $count = 1; while ( $true ) { try { #   $StorageServers = @( Get-ADGroupMember -Identity StorageServers | Select-Object -Expand Name ) } catch [System.Management.Automation.CommandNotFoundException] { #      ,         throw " Get-ADGroupMember ,    Active Directory module for PowerShell; $( $_.Exception.Message )" } catch [System.TimeoutException] { #             if ( $count -le 3 ) { $count++; Start-Sleep -S 10; continue } #             throw "     -   ,   $count ; $( $_.Exception.Message )" } #         break }</code> </pre> <br><p>  Vale la pena se√±alar que el operador de <code>trap</code> es una trampa de error global.  Captura todo lo que no se ha procesado en niveles inferiores, o se elimina del controlador de excepciones debido a la imposibilidad de corregir de forma independiente la situaci√≥n. </p><br><p>  Adem√°s del enfoque orientado a objetos de las excepciones descritas anteriormente, PowerShell tambi√©n proporciona conceptos m√°s familiares compatibles con otros shells "cl√°sicos", como flujos de error, c√≥digos de retorno y variables de acumulaci√≥n de errores.  Todo esto es ciertamente conveniente, a veces sin alternativa, pero va m√°s all√° del alcance de este tema general.  Afortunadamente hay un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">buen libro abierto sobre github</a> sobre este tema. </p><br><p>  El c√≥digo del registrador que uso cuando no hay certeza de que el sistema tendr√° PowerShell 5 (donde puede describir la clase de registrador m√°s convenientemente), pru√©belo, puede serle √∫til debido a su simplicidad y brevedad, seguramente agregar√° m√©todos adicionales sin dificultad. : </p><br><pre> <code class="plaintext hljs">#   " ",   PowerShell v3 function Get-Logger { [CmdletBinding()] param ( [Parameter( Mandatory = $true )] [string] $LogPath, [string] $TimeFormat = 'yyyy-MM-dd HH:mm:ss' ) $LogsDir = [System.IO.Path]::GetDirectoryName( $LogPath ) New-Item $LogsDir -ItemType Directory -Force | Out-Null New-Item $LogPath -ItemType File -Force | Out-Null $Logger = [PSCustomObject]@{ LogPath = $LogPath TimeFormat = $TimeFormat } Add-Member -InputObject $Logger -MemberType ScriptMethod AddErrorRecord -Value { param( [Parameter( Mandatory = $true )] [string]$String ) "$( Get-Date -Format 'yyyy-MM-dd HH:mm:ss' ) [Error] $String" | Out-File $this.LogPath -Append } return $Logger }</code> </pre> <br><p>  Repito la idea: no ignore el manejo de errores.  Esto le ahorrar√° tiempo y nervios a largo plazo. <br>  No piense que ejecutar el script no importa lo que sea bueno.  Bien, es hora de caer sin romper la le√±a. </p><br><h2 id="instrumenty">  Las herramientas </h2><br><p>  Las herramientas de PowerShell ciertamente deber√≠an iniciarse con un emulador de consola.  A menudo escuch√© de partidarios de avispas alternativas que la consola en Windows es mala y que esta no es una consola, sino dos, etc.  Pocos podr√≠an formular adecuadamente sus afirmaciones sobre este tema, pero si alguien tuvo √©xito, en realidad result√≥ que todos los problemas podr√≠an resolverse.  Ya hab√≠a m√°s informaci√≥n sobre los terminales y la nueva consola en Windows en el hub; <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">todo est√° m√°s que bien all√≠</a> . </p><br><p>  El primer paso es instalar Conemu o su conjunto Cmder, lo cual no es particularmente importante, ya que en mi opini√≥n vale la pena revisar la configuraci√≥n de todos modos.  Por lo general, elijo cmder en la configuraci√≥n m√≠nima, sin un gita y otros binarios, que configur√© yo mismo, aunque durante varios a√±os ajust√© mi configuraci√≥n para Conemu puro.  Este es realmente el mejor emulador de terminal para Windows, ya que le permite dividir la pantalla (para tmux / amantes de la pantalla), crear pesta√±as y habilitar el modo de consola de estilo sismo: </p><br><h3 id="conemu">  Conemu </h3><br><p><img src="https://habrastorage.org/webt/ag/2w/hy/ag2whyp2okkhyroygpuzjkdamis.png" alt="cmder"></p><br><p>  El siguiente paso que recomiendo es poner los m√≥dulos: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">oh-my-posh</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">posh-git</a> y <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">PSReadLine</a> .  Los dos primeros har√°n que el baile sea m√°s agradable al agregar informaci√≥n sobre la sesi√≥n actual, el estado del √∫ltimo comando ejecutado, el indicador de privilegio y el estado del repositorio git en la ubicaci√≥n actual.  PSReadLine aumenta enormemente el indicador, agregando, por ejemplo, una b√∫squeda en el historial de comandos ingresados ‚Äã‚Äã(CRTL + R) y consejos convenientes para cmdlets en CRTL + Space: </p><br><p><img src="https://habrastorage.org/webt/eg/w6/f2/egw6f2sa43hgi3dhwn_hhgxbesa.gif" alt="readline"></p><br><p>  Y s√≠, ahora la consola se puede borrar con CTRL + L y olvidarse de los <code>cls</code> . </p><br><h3 id="visual-studio-code">  C√≥digo de estudio visual </h3><br><p>  El editor  Lo peor que puedo decir sobre PowerShell es puramente PowerShell ISE, aquellos que vieron la primera versi√≥n con tres paneles probablemente no olviden esta experiencia.  La diferente codificaci√≥n del terminal, la falta de funciones b√°sicas del editor, como la sangr√≠a autom√°tica, los corchetes de cierre autom√°tico, el formato de c√≥digo y un conjunto completo de antipatrones generados por √©l sobre lo que no le dir√© (por si acaso), esto se trata de ISE. </p><br><p>  No lo use, use Visual Studio Code con la extensi√≥n PowerShell: hay todo lo que no desea (dentro de l√≠mites razonables, por supuesto).  Y no olvide que en PoweShell hasta la sexta versi√≥n (PowerShell Core 6.0) la codificaci√≥n de los scripts es UTF8 BOM, de lo contrario el idioma ruso se romper√°. </p><br><p><img src="https://habrastorage.org/webt/dd/c0/pa/ddc0paj-xbx5tysllsrmzlxnugi.png" alt="vscode"></p><br><p>  Adem√°s del resaltado de sintaxis, la informaci√≥n sobre herramientas y las capacidades de depuraci√≥n de scripts, el complemento instala un linter que tambi√©n lo ayudar√° a seguir las pr√°cticas establecidas en la comunidad, por ejemplo, expandiendo los accesos directos con un solo clic (en la bombilla).  De hecho, este es un m√≥dulo normal que se puede <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">instalar de forma</a> independiente, por ejemplo, agr√©guelo a sus scripts de firma de canalizaci√≥n: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">PSScriptAnalyzer</a> </p><br><p><img src="https://habrastorage.org/webt/mj/x7/ov/mjx7ovrtephqcdctuiptdu_tff4.png" alt="PSScriptAnalyzer"></p><br><p>  Puede establecer los par√°metros de formato de c√≥digo en la configuraci√≥n de la extensi√≥n, para todas las configuraciones (tanto el editor como las extensiones) hay una b√∫squeda: <code>File - Preferences - Settings</code> : </p><br><p><img src="https://habrastorage.org/webt/ia/xr/km/iaxrkmgjcpcf4wck1ocb7kfp9ym.png" alt="Otbs"></p><br><p>  Para obtener una nueva consola conpty, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">debe establecer la bandera en la configuraci√≥n</a> , m√°s tarde, probablemente, este consejo ser√° irrelevante. </p><br><p>  Vale la pena recordar que cualquier acci√≥n en VS Code se puede realizar desde el centro de control, llamado por CTRL + Shift + P. Formatee <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">un</a> c√≥digo <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">insertado desde el chat</a> , ordene alfab√©ticamente, cambie la sangr√≠a de espacios a pesta√±as, y as√≠ sucesivamente, todo en el centro de control. </p><br><p>  Por ejemplo, encienda la pantalla completa y centre el editor: </p><br><p><img src="https://habrastorage.org/webt/3z/w9/-a/3zw9-avzniwjgooxfa1dvzi9kfc.png" alt="maquetacion"></p><br><h3 id="source-control-git-svn">  Control de fuente  Git, SVN </h3><br><p>  A menudo, los administradores de sistemas de Windows tienen fobia a la resoluci√≥n de conflictos en los sistemas de control de versiones, probablemente porque si un representante de este conjunto usa git, a menudo uno no encuentra ning√∫n problema de este tipo.  Con vscode, la resoluci√≥n de conflictos se reduce literalmente a clics del mouse en aquellas partes del c√≥digo que deben dejarse o reemplazarse. </p><br><p><img src="https://habrastorage.org/webt/ft/fd/8f/ftfd8f1ylxofsckzu6v1uujok1e.png" alt="fusionar"></p><br><p>  Se puede hacer clic en estas etiquetas entre las l√≠neas 303 y 304, vale la pena hacer clic en todas las que aparecen en el documento en caso de conflicto, comprometerse a confirmar los cambios y enviar los cambios al servidor.  U - Conveniencia. </p><br><p>  Sobre c√≥mo trabajar con los sistemas de control de versiones est√° disponible y con las im√°genes <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">escritas en el dock vscode</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">revise</a> sus ojos all√≠ brevemente y bien. </p><br><h3 id="snippets">  Fragmentos </h3><br><p>  <a href="">Los fragmentos</a> son un tipo de macro / plantilla que le permite acelerar la escritura de c√≥digo.  Definitivamente una visita obligada. </p><br><p>  Creaci√≥n r√°pida de objetos: </p><br><p><img src="https://habrastorage.org/webt/yi/wp/om/yiwpomlohxird5oovnutj4hc7ec.gif" alt="objeto personalizado"></p><br><p>  Busque ayuda basada en comentarios: </p><br><p><img src="https://habrastorage.org/webt/ol/jn/37/oljn37jxzabxa9h4yqquuh98s9i.gif" alt="ayuda"></p><br><p>  Si el cmdlet necesita pasar una gran cantidad de par√°metros, tiene sentido <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">usar salpicaduras</a> . <br>  Aqu√≠ hay un fragmento para √©l: </p><br><p><img src="https://habrastorage.org/webt/lx/y_/ek/lxy_ekyxsjsuiad66yzqqfoxzta.gif" alt="salpicaduras"></p><br><p>  Ver todos los fragmentos disponibles disponibles por Ctrl + Alt + J: </p><br><p><img src="https://habrastorage.org/webt/0p/jm/k_/0pjmk_nms2ejlugtcsxvp1vjhea.gif" alt="fragmentos"></p><br><p>  Si despu√©s de eso deseaba continuar mejorando su entorno, pero a√∫n no hab√≠a escuchado sobre las <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">hojas de avispa, entonces aqu√≠ est√°</a> .  Adem√°s, si tiene su propio conjunto de extensiones √∫tiles para escribir scripts de PowerShell, me complacer√° ver su lista en los comentarios. </p><br><h2 id="proizvoditelnost">  Rendimiento </h2><br><p>  El tema del rendimiento no es tan simple como podr√≠a parecer a primera vista.  Por un lado, las optimizaciones prematuras pueden reducir en gran medida la legibilidad y la facilidad de mantenimiento del c√≥digo, ahorrando 300 ms de tiempo de ejecuci√≥n del script, cuyo tiempo de ejecuci√≥n habitual puede ser de diez minutos, su uso en este caso es definitivamente destructivo.  Por otro lado, hay varios trucos bastante simples que aumentan tanto la legibilidad del c√≥digo como su velocidad, que son bastante apropiados para usar de forma continua.  A continuaci√≥n, hablar√© sobre algunos de ellos, si el rendimiento lo es todo para usted y la legibilidad se va por el camino debido a los estrictos l√≠mites de tiempo de inactividad del servicio durante el mantenimiento, le recomiendo que consulte la literatura <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">relevante</a> . </p><br><h3 id="pipeline-i-foreach">  Tuber√≠a y foreach </h3><br><p>  La forma m√°s f√°cil y siempre funcional de aumentar la productividad es evitar el uso de tuber√≠as.  Debido a la seguridad y conveniencia del tipo por el bien de la energ√≠a, los elementos de paso de PowerShell a trav√©s de una tuber√≠a envuelven cada uno de ellos en un objeto.  En los lenguajes dotnet, este comportamiento <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">se llama boxeo</a> .  El boxeo es bueno, garantiza la seguridad, pero tiene su propio precio, que a veces no tiene sentido pagar. </p><br><p>  El primer paso es aumentar el rendimiento y, en mi opini√≥n, mejorar la legibilidad al eliminar todas las aplicaciones del <code>Foreach-Object</code> y reemplazarlo con la instrucci√≥n foreach.  Puede avergonzarse por el hecho de que en realidad son dos entidades diferentes, porque <code>foreach</code> es un alias para <code>Foreach-Object</code> ; en la pr√°ctica, la principal diferencia es que <code>foreach</code> no acepta valores de una tuber√≠a, pero funciona por experiencia hasta tres veces m√°s r√°pido. </p><br><p>  :        -  , ,          : </p><br><pre> <code class="plaintext hljs">Get-Content D:\temp\SomeHeavy.log | Select-String '328117'</code> </pre> <br><p>        ‚Äî       ,      .         ‚Äî ,        ,    <code>Get-Content</code> .                  <code>string</code>  ,    ,            .    ‚Äî      ,         : </p><br><blockquote> When reading from and writing to binary files, use the AsByteStream parameter and a value of 0 for the ReadCount parameter. A ReadCount value of 0 reads the entire file in a single read operation. The default ReadCount value, 1, reads one byte in each read operation and converts each byte into a separate object, which causes errors when you use the Set-Content cmdlet to write the bytes to a file unless you use AsByteStream <br><br> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">https://docs.microsoft.com/en-us/powershell/module/microsoft.powershell.management/get-content</a> </blockquote><br><pre> <code class="plaintext hljs">Get-Content D:\temp\SomeHeavy.log -ReadCount 0 | Select-String '328117'</code> </pre> <br><p>                : </p><br><p><img src="https://habrastorage.org/webt/t2/bg/hw/t2bghwyeop1gofgu_tapyqimp3o.png" alt="recuento"></p><br><p>        ,          .    <code>Select-String</code>          ‚Äî       .                ,          <code>Select-String</code> .      ,      <code>Select-String</code>       ,        ,             : </p><br><pre> <code class="plaintext hljs">foreach ( $line in ( Get-Content D:\temp\SomeHeavy.log -ReadCount 0 )) { if ( $line -match '328117' ) { $line } }</code> </pre> <br><p>        30 , -   30%,           ,         ,        , - ,   (     ;-).      ,     .         ,    <code>-match</code> ;   ‚Äî     .                ,      ‚Äî               ‚Äî   -   ,    . </p><br><p>   ‚Äî -   ,   " "              : </p><br><pre> <code class="plaintext hljs">foreach ( $line in ( Get-Content D:\temp\SomeHeavy.log -ReadCount 0 )) { if ( $line -match '328117' ) { "$( Get-Date -UFormat '%d.%m.%Y %H:%M:%S') $line" | Out-File D:\temp\Result.log -Append } }</code> </pre> <br><p>     <code>Measure-Command</code> : </p><br><pre> <code class="plaintext hljs">Hours : 2 Minutes : 20 Seconds : 9 Milliseconds : 101</code> </pre> <br><p>   .   ,           ,          ,      .    ,    PowerShell           ,    ,       ‚Äî        .         ,    ,            ‚Äî <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">StringBuilder</a> .                 ,            ,           .          ,                     . </p><br><pre> <code class="plaintext hljs">$StringBuilder = New-Object System.Text.StringBuilder foreach ( $line in ( Get-Content D:\temp\SomeHeavy.log -ReadCount 0 )) { if ( $line -match '328117' ) { $null = $StringBuilder.AppendLine( "$( Get-Date -UFormat '%d.%m.%Y %H:%M:%S') $line" ) } } Out-File -InputObject $StringBuilder.ToString() -FilePath D:\temp\Result.log -Append -Encoding UTF8</code> </pre> <br><p>      5 ,      : </p><br><pre> <code class="plaintext hljs">Hours : 0 Minutes : 5 Seconds : 37 Milliseconds : 150</code> </pre> <br><p>    <code>Out-File -InputObject</code> ,    ,       .          ‚Äî        <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">   </a>    .              ‚Äî  <code>Get-Help</code>     <code>-Full</code> ,         <code>Accept pipeline input? true (ByValue)</code> : </p><br><pre> <code class="plaintext hljs">-InputObject &lt;psobject&gt; Required? false Position? Named Accept pipeline input? true (ByValue) Parameter set name (All) Aliases None Dynamic? false</code> </pre> <br><p>    PowerShell     : </p><br><p><img src="https://habrastorage.org/webt/8d/zl/r-/8dzlr-yjpt13avpi_wjibzdpnxs.png" alt="taskmgr"></p><br><p>    <code>StringBuilder</code>                           : </p><br><p><img src="https://habrastorage.org/webt/lc/4j/1c/lc4j1c3-um9jozjohlauurwzo3a.png" alt="cadena de construcci√≥n"></p><br><p>    ,    ,  3  3.        dotnet-      ‚Äî <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">StreamReader</a> . </p><br><pre> <code class="plaintext hljs">$StringBuilder = New-Object System.Text.StringBuilder $StreamReader = New-Object System.IO.StreamReader 'D:\temp\SomeHeavy.log' while ( $line = $StreamReader.ReadLine()) { if ( $line -match '328117' ) { $null = $StringBuilder.AppendLine( "$( Get-Date -UFormat '%d.%m.%Y %H:%M:%S') $line" ) } } $StreamReader.Dispose() Out-File -InputObject $StringBuilder.ToString() -FilePath C:\temp\Result.log -Append -Encoding UTF8</code> </pre> <br><pre> <code class="plaintext hljs">Hours : 0 Minutes : 5 Seconds : 33 Milliseconds : 657</code> </pre> <br><p>      ,       .               ,     ,       ,    ,          2.        ,          : </p><br><p><img src="https://habrastorage.org/webt/wr/ka/_w/wrka_wcvj1idodxx_37ka8wnhmm.png" alt="lector de corriente"></p><br><p>        ‚Äî      "",   ‚Äî  <code>StringBuilder</code> ‚Äî ""       .   ,      (  100)           .       ‚Äî       90%    (        ,     ): </p><br><pre> <code class="plaintext hljs">$BufferSize = 104857600 $StringBuilder = New-Object System.Text.StringBuilder $BufferSize $StreamReader = New-Object System.IO.StreamReader 'C:\temp\SomeHeavy.log' while ( $line = $StreamReader.ReadLine()) { if ( $line -match '1443' ) { #      if ( $StringBuilder.Length -gt ( $BufferSize - ( $BufferSize * 0.1 ))) { Out-File -InputObject $StringBuilder.ToString() -FilePath C:\temp\Result.log -Append -Encoding UTF8 $StringBuilder.Clear() } $null = $StringBuilder.AppendLine( "$( Get-Date -UFormat '%d.%m.%Y %H:%M:%S') $line" ) } } Out-File -InputObject $StringBuilder.ToString() -FilePath C:\temp\Result.log -Append -Encoding UTF8 $StreamReader.Dispose()</code> </pre> <br><pre> <code class="plaintext hljs">Hours : 0 Minutes : 5 Seconds : 53 Milliseconds : 417</code> </pre> <br><p>     1      : </p><br><p><img src="https://habrastorage.org/webt/rg/ro/f6/rgrof6lxdcrx96urvmxuflcbdbc.png" alt="lector de corriente con volcado"></p><br><p>              ,                 .     ,      ,        <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">StreamWriter</a> ,   ,   ;-)      ,        ,    . </p><br><p> -     ‚Äî     ,        .    ,     ‚Äî  .  <code>Select-String</code>  <code>Out-File</code>    ,        <code>OutOfMemoryException</code> ,    ‚Äî    . </p><br><h3 id="nativnye-binarniki">   </h3><br><p> ,      PowerShell         ,         ‚Äî ,  : PowerShell ‚Äî          ,     . </p><br><p>  ,       <code>StringBuilder</code>     <code>dir</code> ‚Äî          (  ).          : </p><br><pre> <code class="plaintext hljs">$CurrentPath = ( Get-Location ).Path + '\' $StringBuilder = New-Object System.Text.StringBuilder foreach ( $Line in ( &amp;cmd /c dir /b /s /ad )) { $null = $StringBuilder.AppendLine( $Line.Replace( $CurrentPath, '.' )) } $StringBuilder.ToString()</code> </pre> <br><pre> <code class="plaintext hljs">Hours : 0 Minutes : 0 Seconds : 3 Milliseconds : 9</code> </pre> <br><pre> <code class="plaintext hljs">$StringBuilder = New-Object System.Text.StringBuilder foreach ( $Line in ( Get-ChildItem -File -Recurse | Resolve-Path -Relative )) { $null = $StringBuilder.AppendLine( $Line ) } $StringBuilder.ToString()</code> </pre> <br><pre> <code class="plaintext hljs">Hours : 0 Minutes : 0 Seconds : 16 Milliseconds : 337</code> </pre> <br><p>     $null ‚Äî     .  ,    ‚Äî    <code>Out-Null</code> ;  ,    (   <code>$null</code> )     ,   . </p><br><pre> <code class="plaintext hljs"># : $null = $StringBuilder.AppendLine( $Line ) # : $StringBuilder.AppendLine( $Line ) | Out-Null</code> </pre> <br><p>           ,          ,  .      <code>Compare-Object</code> ,      ,      ,       .            robocopy.exe,      (   PowerShell 5),      : </p><br><pre> <code class="plaintext hljs">class Robocopy { [String]$RobocopyPath Robocopy () { $this.RobocopyPath = Join-Path $env:SystemRoot 'System32\Robocopy.exe' if ( -not ( Test-Path $this.RobocopyPath -PathType Leaf )) { throw '    ' } } [void]CopyFile ( [String]$SourceFile, [String]$DestinationFolder ) { $this.CopyFile( $SourceFile, $DestinationFolder, $false ) } [void]CopyFile ( [String]$SourceFile, [String]$DestinationFolder, [bool]$Archive ) { $FileName = [IO.Path]::GetFileName( $SourceFile ) $FolderName = [IO.Path]::GetDirectoryName( $SourceFile ) $Arguments = @( '/R:0', '/NP', '/NC', '/NS', '/NJH', '/NJS', '/NDL' ) if ( $Archive ) { $Arguments += $( '/A+:a' ) } $ErrorFlag = $false &amp;$this.RobocopyPath $FolderName $DestinationFolder $FileName $Arguments | Foreach-Object { if ( $ErrorFlag ) { $ErrorFlag = $false throw "$_ $ErrorString" } else { if ( $_ -match '(?&lt;=\(0x[\da-f]{8}\))(?&lt;text&gt;(.+$))' ) { $ErrorFlag = $true $ErrorString = $matches.text } else { $Logger.AddRecord( $_.Trim()) } } } if ( $LASTEXITCODE -eq 8 ) { throw 'Some files or directories could not be copied' } if ( $LASTEXITCODE -eq 16 ) { throw 'Robocopy did not copy any files. Check the command line parameters and verify that Robocopy has enough rights to write to the destination folder.' } } [void]SyncFolders ( [String]$SourceFolder, [String]$DestinationFolder ) { $this.SyncFolders( $SourceFolder, $DestinationFolder, '*.*', '', $false ) } [void]SyncFolders ( [String]$SourceFolder, [String]$DestinationFolder, [Bool]$Archive ) { $this.SyncFolders( $SourceFolder, $DestinationFolder, '*.*', '', $Archive ) } [void]SyncFolders ( [String]$SourceFolder, [String]$DestinationFolder, [String]$Include ) { $this.SyncFolders( $SourceFolder, $DestinationFolder, $Include, '', $false ) } [void]SyncFolders ( [String]$SourceFolder, [String]$DestinationFolder, [String]$Include, [Bool]$Archive ) { $this.SyncFolders( $SourceFolder, $DestinationFolder, $Include, '', $Archive ) } [void]SyncFolders ( [String]$SourceFolder, [String]$DestinationFolder, [String]$Include, [String]$Exclude ) { $this.SyncFolders( $SourceFolder, $DestinationFolder, $Include, $Exclude, $false ) } [void]SyncFolders ( [String]$SourceFolder, [String]$DestinationFolder, [String]$Include, [String]$Exclude, [Bool]$Archive ) { $Arguments = @( '/MIR', '/R:0', '/NP', '/NC', '/NS', '/NJH', '/NJS', '/NDL' ) if ( $Exclude ) { $Arguments += $( '/XF' ) $Arguments += $Exclude.Split(' ') } if ( $Archive ) { $Arguments += $( '/A+:a' ) } $ErrorFlag = $false &amp;$this.RobocopyPath $SourceFolder $DestinationFolder $Include $Arguments | Foreach-Object { if ( $ErrorFlag ) { $ErrorFlag = $false throw "$_ $ErrorString" } else { if ( $_ -match '(?&lt;=\(0x[\da-f]{8}\))(?&lt;text&gt;(.+$))' ) { $ErrorFlag = $true $ErrorString = $matches.text } else { $Logger.AddRecord( $_.Trim()) } } } if ( $LASTEXITCODE -eq 8 ) { throw 'Some files or directories could not be copied' } if ( $LASTEXITCODE -eq 16 ) { throw 'Robocopy did not copy any files. Check the command line parameters and verify that Robocopy has enough rights to write to the destination folder.' } } }</code> </pre> <br><p>                ,             (      ),         ‚Äî    . </p><br><p>   ,   :        <code>Foreach-Object</code> !?  ,             :    <code>foreach</code> ,  <code>Foreach-Object</code>          ‚Äî   ,   , ,   ,      .       . </p><br><p>       ,     : </p><br><pre> <code class="plaintext hljs">$Robocopy = New-Object Robocopy #    $Robocopy.CopyFile( $Source, $Dest ) #   $Robocopy.SyncFolders( $SourceDir, $DestDir ) #    .xml     $Robocopy.SyncFolders( $SourceDir, $DestDir , '*.xml', $true ) #     *.zip *.tmp *.log     $Robocopy.SyncFolders( $SourceDir, $DestDir, '*.*', '*.zip *.tmp *.log', $true )</code> </pre> <br><h3 id="poslevkusie">  </h3><br><p>        ‚Äî           ,       ,            ;   ,        ,   ,     : </p><br><ul><li><p>   <code>foreach</code>   <code>Foreach-Object</code>  ; </p><br></li><li><p>   ; </p><br></li><li><p> /  ,   ; </p><br></li><li><p>  <code>StringBuilder</code>    ; </p><br></li><li><p>      ,   - ; </p><br></li><li><p>      ( ""    ); </p><br></li></ul><br><p>     :    -   ,     . </p><br><h2 id="jobs">  Trabajos </h2><br><p>  ,     ,        ,    ,      ,        ,     .            .      ,      IO,               . </p><br><div class="spoiler"> <b class="spoiler_title">    ssd</b> <div class="spoiler_text"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> As√≠ es como se lleva a cabo el primer arranque del reci√©n instalado Windows Server 2019 en Hyper-V a ssd (fue decidido por la migraci√≥n de la m√°quina virtual a hdd): </font></font></p><br><p><img src="https://habrastorage.org/webt/mo/eu/jf/moeujfnupkxphhi7uso_hjbzsys.jpeg" alt="2019ssd"></p></div></div><br><p>    PowerShell       ( <code>Get-Command *-Job</code> ),    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="> </a> . </p><br><p>      ,  ,  ,     : </p><br><pre> <code class="plaintext hljs">$Job = Start-Job -ScriptBlock { Write-Output 'Good night' Start-Sleep -S 10 Write-Output 'Good morning' } $Job | Wait-Job | Receive-Job Remove-Job $Job</code> </pre> <br><p>          ,         ‚Äî       ,    .             <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">     </a> . </p><br><p>      ,      : </p><br><p><img src="https://habrastorage.org/webt/gc/um/r-/gcumr-9xsk2fh5c5m7epk1eozqg.png" alt="trabajos"><br> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">https://xaegr.wordpress.com/2011/07/12/threadping/</a> </p><br><p> ,      ,   ‚Äî     ,                 .  , ,     (50  ‚Äî  50 ): </p><br><p><img src="https://habrastorage.org/webt/3f/pg/xg/3fpgxg51u9augjj9iua05wm6fgi.png" alt="el trabajo muere"></p><br><p>           .    ,  ‚Äî            ,        .     ‚Äî           ,    . </p><br><p>   ,           , ,              - . </p><br><h2 id="runspaces"> Runspaces </h2><br><p>                  ‚Äî <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Beginning Use of PowerShell Runspaces: Part 1</a> . ,  ‚Äî    PowerShell        ,        .             (,    PowerShell ),       :      <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">       (  )</a>       .        ,            . </p><br><p>          <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">WPF </a> ,              PowerShell,     .      <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="> </a> ‚Äî      ,   .    ‚Äî            ,         "" .     . </p><br><p>       ,      <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">           </a> . </p><br><p><img src="https://habrastorage.org/webt/cx/pp/7v/cxpp7vozkcxdsl_ibdyva0_z3wi.gif" alt="wpf"></p><br><pre> <code class="plaintext hljs">#     $GUISyncHash = [hashtable]::Synchronized(@{}) &lt;# WPF  #&gt; $GUISyncHash.FormXAML = [xml](@" &lt;Window xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation" xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml" Title="Sample WPF Form" Height="510" Width="410" ResizeMode="NoResize"&gt; &lt;Grid&gt; &lt;Label Content=" " HorizontalAlignment="Left" Margin="10,10,0,0" VerticalAlignment="Top" Height="37" Width="374" FontSize="18"/&gt; &lt;Label Content="" HorizontalAlignment="Left" Margin="16,64,0,0" VerticalAlignment="Top" Height="26" Width="48"/&gt; &lt;TextBox x:Name="BackupPath" HorizontalAlignment="Left" Height="23" Margin="69,68,0,0" TextWrapping="Wrap" Text="" VerticalAlignment="Top" Width="300"/&gt; &lt;Label Content="" HorizontalAlignment="Left" Margin="16,103,0,0" VerticalAlignment="Top" Height="26" Width="35"/&gt; &lt;TextBox x:Name="RestorePath" HorizontalAlignment="Left" Height="23" Margin="69,107,0,0" TextWrapping="Wrap" Text="" VerticalAlignment="Top" Width="300"/&gt; &lt;Button x:Name="FirstButton" Content="‚àö" HorizontalAlignment="Left" Margin="357,68,0,0" VerticalAlignment="Top" Width="23" Height="23"/&gt; &lt;Button x:Name="SecondButton" Content="‚àö" HorizontalAlignment="Left" Margin="357,107,0,0" VerticalAlignment="Top" Width="23" Height="23"/&gt; &lt;CheckBox x:Name="Check" Content="  " HorizontalAlignment="Left" Margin="16,146,0,0" VerticalAlignment="Top" RenderTransformOrigin="-0.113,-0.267" Width="172"/&gt; &lt;Button x:Name="Go" Content="Go" HorizontalAlignment="Left" Margin="298,173,0,0" VerticalAlignment="Top" Width="82" Height="26"/&gt; &lt;ComboBox x:Name="Droplist" HorizontalAlignment="Left" Margin="16,173,0,0" VerticalAlignment="Top" Width="172" Height="26"/&gt; &lt;ListBox x:Name="ListBox" HorizontalAlignment="Left" Height="250" Margin="16,210,0,0" VerticalAlignment="Top" Width="364"/&gt; &lt;/Grid&gt; &lt;/Window&gt; "@) &lt;#   #&gt; $GUISyncHash.GUIThread = { $GUISyncHash.Window = [Windows.Markup.XamlReader]::Load(( New-Object System.Xml.XmlNodeReader $GUISyncHash.FormXAML )) $GUISyncHash.Check = $GUISyncHash.Window.FindName( "Check" ) $GUISyncHash.GO = $GUISyncHash.Window.FindName( "Go" ) $GUISyncHash.ListBox = $GUISyncHash.Window.FindName( "ListBox" ) $GUISyncHash.BackupPath = $GUISyncHash.Window.FindName( "BackupPath" ) $GUISyncHash.RestorePath = $GUISyncHash.Window.FindName( "RestorePath" ) $GUISyncHash.FirstButton = $GUISyncHash.Window.FindName( "FirstButton" ) $GUISyncHash.SecondButton = $GUISyncHash.Window.FindName( "SecondButton" ) $GUISyncHash.Droplist = $GUISyncHash.Window.FindName( "Droplist" ) $GUISyncHash.Window.Add_SourceInitialized({ $GUISyncHash.GO.IsEnabled = $true }) $GUISyncHash.FirstButton.Add_Click( { $GUISyncHash.ListBox.Items.Add( 'Click FirstButton' ) }) $GUISyncHash.SecondButton.Add_Click( { $GUISyncHash.ListBox.Items.Add( 'Click SecondButton' ) }) $GUISyncHash.GO.Add_Click( { $GUISyncHash.ListBox.Items.Add( 'Click GO' ) }) $GUISyncHash.Window.Add_Closed( { Stop-Process -Id $PID -Force }) $null = $GUISyncHash.Window.ShowDialog() } $Runspace = @{} $Runspace.Runspace = [RunspaceFactory]::CreateRunspace() $Runspace.Runspace.ApartmentState = "STA" $Runspace.Runspace.ThreadOptions = "ReuseThread" $Runspace.Runspace.Open() $Runspace.psCmd = { Add-Type -AssemblyName PresentationCore, PresentationFramework, WindowsBase }.GetPowerShell() $Runspace.Runspace.SessionStateProxy.SetVariable( 'GUISyncHash', $GUISyncHash ) $Runspace.psCmd.Runspace = $Runspace.Runspace $Runspace.Handle = $Runspace.psCmd.AddScript( $GUISyncHash.GUIThread ).BeginInvoke() Start-Sleep -S 1 $GUISyncHash.ListBox.Dispatcher.Invoke( "Normal", [action] { $GUISyncHash.ListBox.Items.Add( '' ) }) $GUISyncHash.ListBox.Dispatcher.Invoke( "Normal", [action] { $GUISyncHash.ListBox.Items.Add( '  ' ) }) foreach ( $item in 1..5 ) { $GUISyncHash.Droplist.Dispatcher.Invoke( "Normal", [action] { $GUISyncHash.Droplist.Items.Add( $item ) $GUISyncHash.Droplist.SelectedIndex = 0 }) } $GUISyncHash.ListBox.Dispatcher.Invoke( "Normal", [action] { $GUISyncHash.ListBox.Items.Add( 'While ( $true ) { Start-Sleep -S 10 }' ) }) while ( $true ) { Start-Sleep -S 10 }</code> </pre> <br><p>      WPF       github,       ,       smart : <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">https://github.com/snd3r/GetDiskSmart/</a> .          ,    MVVM: </p><br><p><img src="https://habrastorage.org/webt/ke/-1/mb/ke-1mbcf2zuyg6crqt70zx4aoqw.png" alt="atracones"></p><br><p>        Visual Studio,            Community Edition                 ,          xaml-  wpf ‚Äî <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">https://github.com/punker76/kaxaml</a> </p><br><p><img src="https://habrastorage.org/webt/wf/wd/j1/wfwdj1mhk_f8bml8clv3n6sv02a.png" alt="kaxaml"></p><br><h2 id="vmesto-zaklyucheniya">  En lugar de una conclusi√≥n </h2><br><p> PowerShell ‚Äî        Windows-.   ,      <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">  </a> ,           ,            . </p><br><p>      ,                ,   "PowerShell,  ",   .           ,        ‚Äî     ,      .                 .          ,  -    , -                . </p><br><p>          ‚Äî    . </p><br><p><img src="https://habrastorage.org/webt/fd/qg/_1/fdqg_1uamuh8rc66ahep2utydeo.png" alt="calma"></p><br><p> PS <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" class="user_link">Boomburum</a> ,    2019   powershell ‚Äî  . </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/443256/">https://habr.com/ru/post/443256/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../443246/index.html">C√≥mo reinventamos Askozia IP PBX despu√©s de que el desarrollador vendi√≥ y cerr√≥ el proyecto</a></li>
<li><a href="../443248/index.html">Protocolos de reserva perfecta de PRP y HSR</a></li>
<li><a href="../443250/index.html">Recolector de basura casero para OpenJDK</a></li>
<li><a href="../443252/index.html">Hormigas modulares con memoria</a></li>
<li><a href="../443254/index.html">Triton es el virus m√°s mortal</a></li>
<li><a href="../443258/index.html">Gotify: un proyecto de c√≥digo abierto para enviar notificaciones y enviar mensajes al servidor</a></li>
<li><a href="../443260/index.html">Migre a Zimbra sin arriesgar negocios con un dominio com√∫n</a></li>
<li><a href="../443262/index.html">Mal consejo: ¬øc√≥mo escribir documentaci√≥n t√©cnica? Tercera parte y √∫ltima</a></li>
<li><a href="../443266/index.html">C√≥mo ayudamos a transformar el trabajo de contabilidad en una gran empresa energ√©tica</a></li>
<li><a href="../443268/index.html">Post mortem: siga el middleware o c√≥mo rompimos los comentarios</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>