<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🕯️ 🌂 🤜🏻 会员卡。 用于ASP.NET中通行证的Google Pay API ♏️ 🍹 💚</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="借助Apple Wallet和Google Pay，银行卡存储应用程序迅速进入了我们的生活。 除了银行业务，这两个平台还允许您使用其他类型的卡-会员卡，礼品卡，活动门票，登机牌等。 







 在一家为一个庞大零售网络提供服务的公司工作期间，我不得不将该网络的会员卡集成到Apple Walle...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>会员卡。 用于ASP.NET中通行证的Google Pay API</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/434486/"><p> 借助Apple Wallet和Google Pay，银行卡存储应用程序迅速进入了我们的生活。 除了银行业务，这两个平台还允许您使用其他类型的卡-会员卡，礼品卡，活动门票，登机牌等。 <br></p><br><p><img src="https://habrastorage.org/webt/ga/ng/rq/gangrq7tlqwob2cmgxa1dydoasu.png"><br></p><br><p> 在一家为一个庞大零售网络提供服务的公司工作期间，我不得不将该网络的会员卡集成到Apple Wallet和Google Pay中。 而且，如果您只是因为集成层具有多功能性而不得不修改Apple Wallet，那么在Google Pay的帮助下，大部分精力和精力都花在了弄清楚文档，找到合适的工具和开发概念的第一个证明上。 尽管总体上其余工作的速度比Apple Wallet快得多，但我花了一天的时间弄清楚如何启动该服务，因此我不介意有人在我之前写过类似的文章。 <br><a name="habracut"></a><br></p><h2>  1.物资 </h2><br> 会员卡使用两个实体表示-会员类别和会员对象。 <br><br><ul><li>  <i>会员类别</i>是所有会员卡的一种模板。 它包含所有地图通用的字段，例如字体颜色，指向图标资源，背景，文本字段的链接等，可以在此处找到完整说明： <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Loyaltyclass</a> <br></li><li>  <i>忠诚度对象</i> -LoyaltyClass的实例。 它还包含特定客户的特定卡的数据-卡号，名称，其他文本字段。 此处描述： <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">忠诚对象</a> <br></li></ul><br> 为了接收卡，用户必须遵循格式链接 <br>  <i><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">www.android.com/payapp/savetoandroidpay</a> <b>/ {JWT}</b></i> ，其中JWT是一个令牌，其中包含带有LoyaltyClass数据的JSON。 但是，由于URL的长度有限制，因此，如果其结构包含许多字符，建议您首先创建一个忠诚度类。 <br><br><p> 如果由于模板，样式，添加或更改文本字段的更改而需要更新地图，则可以使用API​​进行。 只需使用新版本的地图来满足POST请求，Google服务本身就会同步拥有该地图的用户的所有应用程序。 <br></p><br><h2>  2.工具和文档 </h2><br><p> 问题在于， <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Google Pay Pass for Passes文档中的</a>所有示例都是专门针对Java，PHP和Python的，文档本身强烈建议“使用客户端库来简化使用该API的过程”。 <br></p><br><p> 遵循这个建议，我很高兴地去找nuget，但是Google Pay的资料库不存在。  Glory to Brin，Google中第一行“ Google pays for pass dotnet”返回了<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Google Pay API for Passes实用程序库</a>页面，该页面找到了我所需的内容，尽管是ZIP存档格式，其中有一个.net项目，生成的类，该类是Google Pay API- <a href="">Passes客户端库</a>的Google Pay API的包装。 <br></p><br><p> 从项目中是否存在<i>Google.Apis.Walletobjects.v1.1.9.2.00.nuspec</i>文件来看，部署nuget包仍然是Google团队计划的一部分。 打开该文件以查找文档后，我没有发现任何具体的内容，并且描述部分中的某些链接完全发送到了不存在的页面。 <br><br></p><h2>  3.获取访问令牌 </h2><br><p> 要直接开始使用Google Pay API for Passes，您需要获取访问令牌，为此，您需要： <br><br></p><ol><li> 有一个Google Merchant帐户，您可以在<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">这里</a>获得 <br></li><li> 创建一个服务帐户，获取一个带有凭证的文件-一个带有服务帐户详细信息的json文档，包括标识符，电子邮件，私钥等。 如文档所建议，您需要将此文件存储在安全的地方。 <br></li><li> 在Google Merchant Center链接商家帐户和服务帐户 <br></li></ol><br> 使用此文件，您可以使用<i>Google.Apis.Auth.OAuth2</i>库登录： <br><br><pre><code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">await</span></span></span><span class="hljs-function"> Task&lt;</span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">string</span></span></span><span class="hljs-function">&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetOAuthToken</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> {         <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> serviceAccountFile = <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.Empty;         serviceAccountFile = ConfigurationManager.AppSettings[<span class="hljs-string"><span class="hljs-string">"GooglePayServiceAccountConfigPath"</span></span>];        <span class="hljs-comment"><span class="hljs-comment">/*              Credential, GoogleCredential              Service Account,   ,      scopes API,             */</span></span>         <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> credential = GoogleCredential.FromFile(serviceAccountFile)                            .CreateScoped(WalletobjectsService.Scope.WalletObjectIssuer);        <span class="hljs-comment"><span class="hljs-comment">/*        Access token        ,   GetAccessTokenForRequestAsync         ,               */</span></span>         <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> token = <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> credential.UnderlyingCredential.GetAccessTokenForRequestAsync();         <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> token; }</code> </pre> <br><h2>  4.创建地图 </h2><br><p> 为了创建会员卡，您必须首先创建会员等级。 可以使用API​​和Google Merchant Center网络界面来创建忠诚度等级。 请注意类别名称，因为该名称在Google Pay基础架构中必须唯一。 <br><br> 创建忠诚度类别后，您可以创建忠诚度对象。 为此，您将需要我们之前添加到项目中的库：创建一个请求对象，指定OAuth令牌，转移创建的LoyaltyObject对象，然后执行请求： <br><br></p><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GooglePayApiService</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-comment"><span class="hljs-comment">// ,    Merchant Account IssuerId = ConfigurationManager.AppSettings["GooglePayIssuerId"]; _wobService = new WalletobjectsService(); } private async Task&lt;LoyaltyObject&gt; ConvertLoyaltyObjectFromTemplate(GooglePayPassTemplate template) { string id = $"{IssuerId}.{template.SerialNumber}"; string loyaltyClassName = ConfigurationManager.AppSettings["GooglePayStoreCardClassName"];     var loyaltyClass = await GetLoyaltyClass(loyaltyClassName); var result =  new LoyaltyObject { Id = id, AccountName = template.AccountName,          Barcode = new Barcode          {          AlternateText = template.BarcodeText,               Value = template.SerialNumber,               Type = "pdf417"          },          Kind = "walletObject#loyaltyObject",          ClassId = loyaltyClass.Id,          ClassReference = loyaltyClass,          State = "active"     };     return result; } private async Task&lt;LoyaltyObject&gt; CreateLoyaltyObject(LoyaltyObject loyaltyObject) { var saveRequest = _wobService.Loyaltyobject.Insert(loyaltyObject); saveRequest.OauthToken = await GetOAuthToken(); var savedObject = await saveRequest.ExecuteAsync(); return savedObject; }</span></span></code> </pre><br> 此示例中的<i>GooglePayPassTemplate</i>是DTO，用于存储用户的地图模板，该模板由单独的开发服务生成。 <br><br><h2>  5.地图更新 </h2><br><p> 此处的原理与创建时的原理相同：我们生成一个请求，传输更新的LoyaltyObject对象，然后执行： <br><br></p><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">async</span></span></span><span class="hljs-function"> Task&lt;LoyaltyObject&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">UpdateLoyaltyObject</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">LoyaltyObject loyaltyObject</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> updateRequest = _wobService.Loyaltyobject.Update(loyaltyObject, loyaltyObject.Id);           updateRequest.OauthToken = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> GetOAuthToken(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> savedObject = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> updateRequest.ExecuteAsync(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> savedObject; }</code> </pre> <br><p> 完成请求后，如果设备在网络上并且具有Internet连接，则安装了卡的用户的应用程序中的卡将在几秒钟后更新。 </p><br><br><h2>  6. JWT一代 </h2><br><p> 要安装卡，您必须将用户重定向到<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">www.android.com/payapp/savetoandroidpay</a> <b>/ {JWT}</b>链接。 可以在<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">此链接</a>上找到令牌结构的描述。 <br></p><br><p> 令牌由RSA-SHA256签名，签名可以使用带有服务帐户凭据的同一文件生成： <br><br></p><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">JwtHelper</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">string</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CreateJwtForLoyaltyObject</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">LoyaltyObject loyaltyObject</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-comment"><span class="hljs-comment">/*       credential   ,         */</span></span> ServiceAccountCredential credential; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> now = DateTime.UtcNow; DateTime unixEpoch = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> DateTime(<span class="hljs-number"><span class="hljs-number">1970</span></span>, <span class="hljs-number"><span class="hljs-number">01</span></span>, <span class="hljs-number"><span class="hljs-number">01</span></span>); <span class="hljs-comment"><span class="hljs-comment">// 1970-01-01 00:00:00 UTC var secondsSinceEpoch = (int)Math.Round((now - unixEpoch).TotalSeconds); string serviceAccountFile = serviceAccountFile = ConfigurationManager.AppSettings["GooglePayServiceAccountConfigPath"]; using (var fs = new FileStream(serviceAccountFile, FileMode.Open, FileAccess.Read, FileShare.Read)) { credential = ServiceAccountCredential.FromServiceAccountData(fs); } /*    JwtPayload,     payload-a  JWT */ var jwtPayload = new JwtPayload { iat = secondsSinceEpoch, iss = credential.Id, payload = new JwtInternalPayload { loyaltyObjects = new[] { new LoyaltyObjectPayload { id = loyaltyObject.Id } } } }; string header = @"{""alg"":""RS256"",""typ"":""JWT""}"; string payload = JsonConverter.SerializeObject(jwtPayload); string base64Header = EscapedBase64(Convert.ToBase64String(Encoding.UTF8.GetBytes(header))); string base64Payload = EscapedBase64(Convert.ToBase64String(Encoding.UTF8.GetBytes(payload))); //        Signature string signature = EscapedBase64(credential.CreateSignature( Encoding.UTF8.GetBytes($"{base64Header}.{base64Payload}") )); var token = $"{base64Header}.{base64Payload}.{signature}"; return token; } private static string EscapedBase64(string base64) { return base64.Replace('+', '-') .Replace('/', '_') .Replace("=", ""); } }</span></span></code> </pre><br><h2> 结论 </h2><br><p> 在本文中，我们介绍了使用Google Pay Pass for Passes的基础知识：设置帐户，连接到该API，创建忠诚度类别和忠诚度对象。 <br><br> 如果UFO赞成，我将分别向您介绍如何使用Apple Wallet（在实施方面，所有工作都比较困难），如何通过一项Web服务使Apple Wallet与Google Pay成为朋友，而不感到痛苦。 <br></p><br><p></p><h3> 有用的链接 </h3><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">注册商家帐户</a> <br></li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">适用于通行证的Google Pay API文档</a> <br></li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">使用Google Pay API for Passes的客户端库</a> </li></ul></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN434486/">https://habr.com/ru/post/zh-CN434486/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN434474/index.html">关于空间内容的绿猫</a></li>
<li><a href="../zh-CN434476/index.html">GitLab中的ChatOps将向所有人开放</a></li>
<li><a href="../zh-CN434478/index.html">不露面的代码会杀死程序，我们不会对此做任何事情。</a></li>
<li><a href="../zh-CN434480/index.html">新年，小玩意，火</a></li>
<li><a href="../zh-CN434482/index.html">我们博客的另一年：2018年的结果</a></li>
<li><a href="../zh-CN434490/index.html">我们如何通过水刀切割看到免提电话</a></li>
<li><a href="../zh-CN434494/index.html">阅读什么。 2017年和2018年俄语小说清单</a></li>
<li><a href="../zh-CN434496/index.html">两阶段提交和分布式系统的未来</a></li>
<li><a href="../zh-CN434498/index.html">MVP和Dagger 2-Android应用程序框架-第1部分</a></li>
<li><a href="../zh-CN434500/index.html">骗子叫珍妮或看你的耳朵</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>