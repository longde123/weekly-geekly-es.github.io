<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🆘 🗺️ 💪 Implantação e bancos de dados sem tempo de inatividade 👲🏾 ➗ 📺</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Este artigo explica em detalhes como resolver os problemas associados à compatibilidade do banco de dados durante a implantação. Informaremos o que po...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Implantação e bancos de dados sem tempo de inatividade</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/nixys/blog/481932/"><p><img src="https://habrastorage.org/webt/hr/vy/qq/hrvyqqi2mmitehw9vx_xklbofj8.png" alt="imagem"></p><br><p>  Este artigo explica em detalhes como resolver os problemas associados à compatibilidade do banco de dados durante a implantação.  Informaremos o que pode acontecer com seus aplicativos no produto se você tentar executar uma implantação sem qualquer preparação preliminar.  Em seguida, percorreremos as etapas do ciclo de vida do aplicativo, que são necessárias para que o tempo de inatividade seja zero ( <em>aprox. Transl .: mais - zero de inatividade</em> ).  O resultado de nossas operações será a aplicação de uma alteração de banco de dados incompatível com versões anteriores de uma maneira compatível com versões anteriores. </p><a name="habracut"></a><br><p>  Se você quiser entender os exemplos de código do artigo, você os encontrará no <a href="https://github.com/spring-cloud-samples/zero-downtime-deployment">GitHub</a> . </p><br><h2 id="vvedenie">  1. Introdução </h2><br><h3 id="zero-downtime-deployment">  Implantação de tempo de inatividade zero </h3><br><p>  Qual é a <strong>implantação</strong> mística de <strong>tempo de inatividade zero</strong> ?  Podemos dizer isso quando seu aplicativo é implantado, para que você possa introduzir com êxito uma nova versão do aplicativo para produção, enquanto o usuário não percebe sua inacessibilidade.  Do ponto de vista do usuário e da empresa, esse é o melhor cenário de implantação possível, pois dessa forma é possível introduzir novas funções e eliminar erros sem interrupção. </p><br><p>  Como conseguir isso?  Existem várias maneiras, aqui está uma delas: </p><br><ul><li>  expanda a versão 1 do seu serviço </li><li>  migrar o banco de dados </li><li>  implemente a versão 2 do seu serviço em paralelo com a versão 1 </li><li>  assim que vir que o número da versão 2 está funcionando como deveria, remova o número da versão 1 </li><li>  pronto! </li></ul><br><p>  Fácil né?  Infelizmente, isso não é tão simples, e consideraremos isso em detalhes posteriormente.  Agora vamos verificar outro processo de implantação bastante comum - implantação verde azul. </p><br><p>  Você já ouviu falar em <a href="https://martinfowler.com/bliki/BlueGreenDeployment.html">implantação verde azul</a> ?  Com o Cloud Foundry, isso é extremamente fácil de fazer.  Dê uma olhada <a href="https://spring.io/blog/2014/04/04/project-sagan-zero-downtime-deployments">neste artigo,</a> onde o descrevemos com mais detalhes.  Resumindo, lembramos como fazer a implantação verde azul: </p><br><ul><li>  <em>Garanta a operação de duas cópias do seu código de produção ("azul" e "verde");</em> </li><li>  <em>direcione todo o tráfego para o ambiente azul, ou seja,</em>  <em>para que os URLs de produção sejam apontados para lá;</em> </li><li>  <em>Implante e teste todas as alterações de aplicativo em um ambiente verde</em> </li><li>  <em>alternar URLs do ambiente azul para o verde</em> </li></ul><br><p>  A implantação verde azul é uma abordagem que permite introduzir facilmente novos recursos sem se preocupar com a interrupção da produção.  Isso ocorre porque mesmo que algo aconteça, você pode reverter facilmente para o ambiente anterior simplesmente clicando em um botão. </p><br><p>  Depois de ler todas as opções acima, você pode fazer a pergunta: O que o tempo de inatividade zero tem a ver com a implantação verde azul? </p><br><p>  Bem, eles têm muito em comum, porque o suporte a duas cópias do mesmo ambiente requer esforços duplos para mantê-las.  É por isso que algumas equipes, de acordo com <a href="https://martinfowler.com/bliki/BlueGreenDeployment.html">Martin Fowler</a> , aderem a variações dessa abordagem: </p><br><p> <em>outra opção é usar o mesmo banco de dados, criando opções verde-azuladas para camadas da web e de domínio.</em>  <em>Nessa abordagem, os bancos de dados geralmente podem ser um problema, especialmente quando você precisa alterar seu esquema para suportar uma nova versão do software.</em> </p><br><p>  E aqui chegamos ao principal problema neste artigo.  <strong>O banco de dados</strong>  Vamos dar uma outra olhada nesta frase. </p><br><p>  <em>migrar o banco de dados.</em> </p><br><p>  Agora você deve se perguntar: e se a alteração do banco de dados for incompatível com versões anteriores?  Minha primeira versão do aplicativo não será interrompida?  De fato, é exatamente isso que vai acontecer ... </p><br><p>  Assim, apesar dos enormes benefícios de zero tempo de inatividade / implantação verde azul, as empresas tendem a seguir o seguinte processo de implantação mais seguro para seus aplicativos: </p><br><ul><li>  preparar um pacote com uma nova versão do aplicativo </li><li>  desligar um aplicativo em execução </li><li>  executar scripts para migração de banco de dados </li><li>  implantar e iniciar a nova versão do aplicativo </li></ul><br><p>  Neste artigo, descreveremos em detalhes como você pode trabalhar com um banco de dados e código para aproveitar a implantação de tempo de inatividade zero. </p><br><h3 id="problemy-s-bazoy-dannyh">  Problemas de banco de dados </h3><br><p>  Se você tiver um aplicativo sem estado que não armazena nenhum dado no banco de dados, poderá obter a implantação de tempo de inatividade zero imediatamente.  Infelizmente, a maioria dos softwares precisa armazenar dados em algum lugar.  É por isso que você deve pensar duas vezes antes de fazer alterações no circuito.  Antes de nos aprofundarmos nos detalhes de como alterar o esquema para que seja possível implantar sem tempo de inatividade, vamos nos concentrar primeiro no esquema de controle de versão. </p><br><h3 id="shema-upravleniya-versiyami">  Esquema de controle de versão </h3><br><p> Neste artigo, usaremos o <a href="https://flywaydb.org/">Flyway</a> como uma ferramenta para controle de versão ( <em>aproximadamente tradução: estamos falando sobre migração de banco de dados</em> ).  Naturalmente, também escreveremos um aplicativo Spring Boot que tenha suporte Flyway embutido e migrará o circuito ao configurar o contexto do aplicativo.  Ao usar o Flyway, você pode armazenar scripts de migração na pasta de projetos (por padrão, em <code>classpath:db/migration</code> ).  Aqui você pode ver um exemplo desses arquivos de migração. </p><br><pre> <code class="plaintext hljs">└── db └── migration ├── V1__init.sql ├── V2__Add_surname.sql ├── V3__Final_migration.sql └── V4__Remove_lastname.sql</code> </pre> <br><p>  Neste exemplo, vemos 4 cenários de migração que, se não foram executados anteriormente, serão executados um após o outro quando o aplicativo for iniciado.  Vejamos um dos arquivos ( <code>V1__init.sql</code> ) como um exemplo. </p><br><pre> <code class="plaintext hljs">CREATE TABLE PERSON ( id BIGINT GENERATED BY DEFAULT AS IDENTITY, first_name varchar(255) not null, last_name varchar(255) not null ); insert into PERSON (first_name, last_name) values ('Dave', 'Syer');</code> </pre> <br><p>  Tudo fala perfeitamente por si: você pode usar o SQL para determinar como seu banco de dados deve ser modificado.  Para obter mais informações sobre o Spring Boot e o Flyway, consulte <a href="https://docs.spring.io/spring-boot/docs/1.3.5.RELEASE/reference/html/howto-database-initialization.html">Documentos de inicialização do Spring</a> . </p><br><p>  O uso do controle de versão com o Spring Boot oferece 2 grandes benefícios: </p><br><ul><li>  você separa as alterações no banco de dados das alterações no código </li><li>  a migração do banco de dados ocorre junto com a distribuição do seu aplicativo, ou seja,  seu processo de implantação é simplificado </li></ul><br><h2 id="reshenie-problem-s-bazoy-dannyh">  Solucionando problemas de banco de dados </h2><br><p>  Na próxima seção do artigo, focaremos em considerar duas abordagens para alterações no banco de dados. </p><br><ul><li>  incompatibilidade com versões anteriores </li><li>  compatibilidade com versões anteriores </li></ul><br><p>  O primeiro será considerado como um aviso de que você não deve executar uma implantação de tempo de inatividade zero sem preparação preliminar ... O segundo oferece uma solução para como você pode executar uma implantação sem tempo de inatividade e, ao mesmo tempo, manter a compatibilidade com versões anteriores. </p><br><p>  Nosso projeto, no qual trabalharemos, será um aplicativo Spring Boot Flyway simples, no qual há uma <code>Person</code> com nome e <code>last_name</code> no banco de dados ( <em>aprox. Por.: <code>Person</code> é uma tabela e f <code>irst_name</code> e <code>irst_name</code> são os campos</em> ).  Queremos renomear <code>last_name</code> para <code>surname</code> . </p><br><h3 id="dopuscheniya">  Pressupostos </h3><br><p>  Antes de nos aprofundarmos nos detalhes, precisamos esboçar algumas suposições sobre nossos aplicativos.  O principal resultado que queremos alcançar será um processo bastante simples. </p><br><blockquote>  <strong>Nota</strong>  Negócios PRO-DICA.  A racionalização de processos pode economizar muito dinheiro em suporte (quanto mais pessoas trabalham em sua empresa, mais dinheiro você pode economizar)! </blockquote><br><h3 id="ne-nado-delat-otkat-bazy-dannyh">  Não há necessidade de reverter o banco de dados </h3><br><p>  Isso simplifica o processo de implantação (algumas reversões do banco de dados são quase impossíveis, por exemplo, exclusão de reversão).  Preferimos reverter apenas os aplicativos.  Dessa forma, mesmo se você tiver bancos de dados diferentes (por exemplo, SQL e NoSQL), seu pipeline de implantação terá a mesma aparência. </p><br><p>  <strong>SEMPRE é possível reverter o aplicativo uma versão novamente (não mais)</strong> </p><br><p>  A reversão deve ser feita apenas se necessário.  Se houver um erro na versão atual que não seja fácil de corrigir, poderemos retornar a versão funcional mais recente.  Assumimos que esta versão de trabalho mais recente seja a anterior.  Manter a compatibilidade de código e banco de dados para mais de uma distribuição seria extremamente difícil e dispendioso. </p><br><blockquote>  <strong>Nota</strong>  Para maior legibilidade, dentro da estrutura deste artigo, alteraremos a versão principal do aplicativo. </blockquote><br><h3 id="shag-1-ishodnoe-sostoyanie">  Etapa 1: Estado inicial </h3><br><p>  Versão do aplicativo: <code>1.0.0</code> <br>  Versão do banco de dados: <code>v1</code> </p><br><h3 id="kommentariy">  Comentário </h3><br><p>  Este será o estado inicial do aplicativo. </p><br><h3 id="izmeneniya-bd">  Alterações no banco de dados </h3><br><p>  O banco de dados contém <code>last_name.</code> </p><br><pre> <code class="plaintext hljs">CREATE TABLE PERSON ( id BIGINT GENERATED BY DEFAULT AS IDENTITY, first_name varchar(255) not null, last_name varchar(255) not null ); insert into PERSON (first_name, last_name) values ('Dave', 'Syer');</code> </pre> <br><h3 id="izmeneniya-koda">  Alterações de código </h3><br><p>  O aplicativo salva os dados da pessoa em <code>last_name</code> : </p><br><pre> <code class="plaintext hljs">/* * Copyright 2012-2016 the original author or authors. * * Licensed under the Apache License, Version 2.0 (the "License"); * you may not use this file except in compliance with the License. * You may obtain a copy of the License at * * http://www.apache.org/licenses/LICENSE-2.0 * * Unless required by applicable law or agreed to in writing, software * distributed under the License is distributed on an "AS IS" BASIS, * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. * See the License for the specific language governing permissions and * limitations under the License. */ package sample.flyway; import javax.persistence.Entity; import javax.persistence.GeneratedValue; import javax.persistence.Id; @Entity public class Person { @Id @GeneratedValue private Long id; private String firstName; private String lastName; public String getFirstName() { return this.firstName; } public void setFirstName(String firstName) { this.firstName = firstName; } public String getLastName() { return this.lastName; } public void setLastName(String lastname) { this.lastName = lastname; } @Override public String toString() { return "Person [firstName=" + this.firstName + ", lastName=" + this.lastName + "]"; } }</code> </pre> <br><h3 id="obratno-nesovmestimoe-pereimenovanie-stolbca">  Renomeação de coluna incompatível </h3><br><p>  Vejamos um exemplo de como alterar o nome de uma coluna: </p><br><blockquote>  <strong>Atenção</strong>  O exemplo a seguir será interrompido intencionalmente.  Mostramos isso para demonstrar o problema de compatibilidade do banco de dados. </blockquote><p>  Versão do aplicativo: <code>2.0.0.BAD</code> </p><br><p>  Versão do banco de dados: <code>v2bad</code> </p><br><h3 id="kommentariy-1">  Comentário </h3><br><p>  As alterações atuais NÃO nos permitem executar duas instâncias (antigas e novas) ao mesmo tempo.  Portanto, será difícil conseguir uma implantação com tempo de inatividade zero (suposições levadas em consideração, isso é praticamente impossível). </p><br><h3 id="ab-testirovanie">  Teste A / B </h3><br><p>  A situação atual é que temos um aplicativo versão <code>1.0.0,</code> implementado no prod, e um banco de dados <code>v1</code> .  Devemos implantar a segunda instância do aplicativo, versão <code>2.0.0.BAD</code> , e atualizar o banco de dados para <code>v2bad</code> . </p><br><p>  Passos: </p><br><ol><li>  implementou uma nova instância do aplicativo versão <code>2.0.0.BAD</code> , que atualiza o banco de dados para <code>v2bad</code> </li><li>  a coluna <code>last_name</code> não existe mais no banco de dados <code>v2bad</code> - foi alterada para <code>surname</code> </li><li>  As atualizações de banco de dados e aplicativos foram bem-sucedidas e algumas instâncias funcionam na <code>1.0.0</code> , outras na <code>2.0.0.BAD</code> .  Tudo relacionado ao <code>v2bad</code> </li><li>  todas as instâncias da versão <code>1.0.0</code> começarão a gerar erros porque tentarão inserir dados na coluna <code>last_name</code> , que não é mais </li><li>  todas as instâncias da versão <code>2.0.0.BAD</code> funcionarão sem problemas </li></ol><br><p>  Como você pode ver, se fizermos alterações incompatíveis no banco de dados e nos aplicativos, o teste A / B será impossível. </p><br><h3 id="otkat-prilozheniya">  Aplicação de reversão </h3><br><p>  Vamos supor que, depois de tentar executar a implantação A / B ( <em>aprox. Transl.: Provavelmente, o autor estava se referindo ao teste A / B aqui</em> ), decidimos que precisamos reverter o aplicativo para a versão <code>1.0.0.</code>  Suponha que não queremos reverter o banco de dados. </p><br><p>  Passos: </p><br><ol><li>  paramos a instância da aplicação versão <code>2.0.0.BAD</code> </li><li>  banco de dados ainda é <code>v2bad</code> </li><li>  como a versão <code>1.0.0</code> não entende o que <code>surname</code> , veremos erros </li><li>  inferno se libertou, não podemos mais voltar </li></ol><br><p>  Como você pode ver, se fizermos alterações incompatíveis no banco de dados e nos aplicativos, não podemos reverter para a versão anterior. </p><br><h3 id="logi-ispolneniya-skripta">  Logs de execução de script </h3><br><pre> <code class="plaintext hljs">Backward incompatible scenario: 01) Run 1.0.0 02) Wait for the app (1.0.0) to boot 03) Generate a person by calling POST localhost:9991/person to version 1.0.0 04) Run 2.0.0.BAD 05) Wait for the app (2.0.0.BAD) to boot 06) Generate a person by calling POST localhost:9991/person to version 1.0.0 &lt;-- this should fail 07) Generate a person by calling POST localhost:9992/person to version 2.0.0.BAD &lt;-- this should pass Starting app in version 1.0.0 Generate a person in version 1.0.0 Sending a post to 127.0.0.1:9991/person. This is the response: {"firstName":"b73f639f-e176-4463-bf26-1135aace2f57","lastName":"b73f639f-e176-4463-bf26-1135aace2f57"} Starting app in version 2.0.0.BAD Generate a person in version 1.0.0 Sending a post to 127.0.0.1:9991/person. This is the response: curl: (22) The requested URL returned error: 500 Internal Server Error Generate a person in version 2.0.0.BAD Sending a post to 127.0.0.1:9995/person. This is the response: {"firstName":"e156be2e-06b6-4730-9c43-6e14cfcda125","surname":"e156be2e-06b6-4730-9c43-6e14cfcda125"}</code> </pre> <br><h3 id="izmeneniya-bd-1">  Alterações no banco de dados </h3><br><p>  Script de migração que renomeia <code>surname</code> </p><br><p>  Script Flyway de origem: </p><br><pre> <code class="plaintext hljs">CREATE TABLE PERSON ( id BIGINT GENERATED BY DEFAULT AS IDENTITY, first_name varchar(255) not null, last_name varchar(255) not null ); insert into PERSON (first_name, last_name) values ('Dave', 'Syer');</code> </pre> <br><p>  Um script que renomeia <code>last_name</code> . </p><br><pre> <code class="plaintext hljs">-- This change is backward incompatible - you can't do A/B testing ALTER TABLE PERSON CHANGE last_name surname VARCHAR;</code> </pre> <br><h3 id="izmeneniya-koda-1">  Alterações de código </h3><br><p>  <code>lastName</code> nome do campo <code>lastName</code> para <code>surname</code> . </p><br><h3 id="pereimenovanie-stolbca-obratno-sovmestimym-sposobom">  Renomeando uma coluna de maneira compatível com versões anteriores </h3><br><p>  Essa é a situação mais comum que podemos encontrar.  Precisamos fazer alterações incompatíveis com versões anteriores.  Já provamos que, para uma implantação sem tempo de inatividade, não devemos aplicar apenas a migração do banco de dados sem ações adicionais.  Nesta seção do artigo, faremos 3 implantações do aplicativo junto com as migrações do banco de dados para alcançar o resultado desejado e, ao mesmo tempo, manter a compatibilidade com versões anteriores. </p><br><blockquote>  <strong>Nota</strong>  Lembre-se de que temos uma versão de banco de dados <code>v1</code> .  Ele contém as colunas <code>first_name</code> e <code>last_name</code> .  Devemos mudar <code>last_name</code> para <code>surname</code> .  Também temos um aplicativo versão <code>1.0.0,</code> que ainda não usa <code>surname</code> . </blockquote><br><h3 id="shag-2-dobavlyaem-surname">  Etapa 2: adicionar sobrenome </h3><br><p>  Versão do aplicativo: <code>2.0.0</code> <br>  Versão do banco de dados: <code>v2</code> </p><br><h3 id="kommentariy-2">  Comentário </h3><br><p>  Ao adicionar uma nova coluna e copiar seu conteúdo, criamos alterações no banco de dados compatíveis com versões anteriores.  Ao mesmo tempo, se revertermos o JAR ou tivermos um JAR antigo funcional, ele não será interrompido no tempo de execução. </p><br><h3 id="vykatyvaem-novuyu-versiyu">  Lançamos a nova versão </h3><br><p>  Passos: </p><br><ol><li>  migrar o banco de dados para criar uma nova coluna de <code>surname</code> .  Agora sua versão db <code>v2</code> </li><li>  copie dados do <code>last_name</code> para o <code>surname</code> .  <strong>Observe</strong> que, se você tiver muitos desses dados, considere a migração em lote! </li><li>  escreva o código onde ambas as colunas <strong>nova</strong> e <strong>antiga</strong> são usadas.  Agora seu aplicativo versão <code>2.0.0</code> </li><li>  leia o valor da coluna <code>surname</code> , se não for <code>null</code> , ou de l <code>ast_name</code> se o <code>surname</code> não <code>surname</code> especificado.  Você pode remover <code>getLastName()</code> do código, pois ele retornará <code>null</code> quando você reverter seu aplicativo de <code>3.0.0</code> para <code>2.0.0</code> . </li></ol><br><p>  Se você estiver usando o Spring Boot Flyway, essas duas etapas serão executadas durante o lançamento da versão <code>2.0.0</code> aplicativo.  Se você executar a ferramenta de controle de versão do banco de dados manualmente, precisará fazer duas coisas diferentes para isso (primeiro atualize a versão do banco de dados manualmente e, em seguida, implante um novo aplicativo). </p><br><blockquote>  <strong>É importante.</strong>  Lembre-se de que uma coluna recém-criada <strong>NÃO</strong> <strong>DEVE</strong> <strong>SER NULA</strong> .  Se você reverter, o aplicativo antigo não saberá sobre a nova coluna e não a instalará durante a <code>Insert.</code>  Mas se você adicionar essa restrição, e seu banco de dados for <code>v2</code> , será necessário definir o valor da nova coluna.  O que levará a violações de restrições. <br><br>  <strong>É importante.</strong>  Você deve remover o método <code>getLastName()</code> , pois a versão <code>3.0.0</code> não possui o conceito de uma coluna <code>last_name</code> no código.  Isso significa que nulo será definido lá.  Você pode deixar o método e adicionar verificações <code>null</code> , mas uma solução muito melhor seria garantir que você tenha escolhido o valor diferente de zero correto na lógica <code>getSurname()</code> . </blockquote><br><h3 id="ab-testirovanie-1">  Teste A / B </h3><br><p>  A situação atual é que temos uma versão <code>1.0.0</code> aplicativo implantada no produto e um banco de dados na <code>v1</code> .  Precisamos implantar a segunda instância do aplicativo versão <code>2.0.0</code> , que atualizará o banco de dados para a <code>v2</code> . </p><br><p>  Passos: </p><br><ol><li>  implementou uma nova instância do aplicativo versão <code>2.0.0</code> , que atualiza o banco de dados para a <code>v2</code> </li><li>  Enquanto isso, alguns pedidos foram tratados por instâncias da versão <code>1.0.0</code> </li><li>  a atualização foi bem-sucedida e você tem várias instâncias de trabalho do aplicativo versão <code>1.0.0</code> e do restante da versão <code>2.0.0.</code>  Todos se comunicam com o banco de dados na <code>v2</code> </li><li>  a versão <code>1.0.0</code> não usa a coluna de sobrenome no banco de dados, mas a versão <code>2.0.0</code> .  Eles não interferem um com o outro e não deve haver erros. </li><li>  versão <code>2.0.0</code> armazena dados na coluna antiga e na nova, o que fornece compatibilidade com versões anteriores </li></ol><br><blockquote>  <strong>É importante.</strong>  Se você tiver alguma dúvida que conte itens com base em valores da coluna antiga / nova, lembre-se de que agora você tem valores duplicados (provavelmente eles ainda estão migrando).  Por exemplo, se você quiser contar o número de usuários cujo sobrenome (independentemente do nome da coluna) começa com a letra <code>A</code> , antes que a migração de dados ( <code>old</code> → <code>new</code> coluna) seja concluída, você poderá ter dados inconsistentes se executar uma consulta em uma nova coluna. </blockquote><br><h3 id="otkat-prilozheniya-1">  Aplicação de reversão </h3><br><p>  Agora, temos um aplicativo versão <code>2.0.0</code> e um banco de dados na <code>v2</code> . </p><br><p>  Passos: </p><br><ol><li>  reverta seu aplicativo para a versão <code>1.0.0</code> . </li><li>  a versão <code>1.0.0</code> não usa a coluna de <code>surname</code> no banco de dados, portanto, a reversão deve ser bem-sucedida </li></ol><br><h3 id="izmeneniya-db">  Alterações no banco de dados </h3><br><p>  O banco de dados contém uma coluna chamada <code>last_name</code> . </p><br><p>  Script Flyway de origem: </p><br><pre> <code class="plaintext hljs">CREATE TABLE PERSON ( id BIGINT GENERATED BY DEFAULT AS IDENTITY, first_name varchar(255) not null, last_name varchar(255) not null ); insert into PERSON (first_name, last_name) values ('Dave', 'Syer');</code> </pre> <br><p>  O script para adicionar <code>surname</code> . </p><br><blockquote>  <strong>Atenção</strong>  Lembre-se de que você NÃO PODE ADICIONAR nenhuma restrição NOT NULL à coluna adicionada.  Se você reverter o JAR, a versão antiga não tem idéia da coluna adicionada e a definirá automaticamente como NULL.  Se houver essa restrição, o aplicativo antigo simplesmente será interrompido. </blockquote><br><pre> <code class="plaintext hljs">-- NOTE: This field can't have the NOT NULL constraint cause if you rollback, the old version won't know about this field -- and will always set it to NULL ALTER TABLE PERSON ADD surname varchar(255); -- WE'RE ASSUMING THAT IT'S A FAST MIGRATION - OTHERWISE WE WOULD HAVE TO MIGRATE IN BATCHES UPDATE PERSON SET PERSON.surname = PERSON.last_name</code> </pre> <br><h3 id="izmeneniya-koda-2">  Alterações de código </h3><br><p>  Armazenamos dados em <code>last_name</code> e <code>surname</code> .  Ao mesmo tempo, lemos de <code>last_name</code> , pois essa coluna é mais relevante.  Durante o processo de implantação, algumas solicitações podem ter sido tratadas por uma instância de aplicativo que ainda não foi atualizada. </p><br><pre> <code class="plaintext hljs">/* * Copyright 2012-2016 the original author or authors. * * Licensed under the Apache License, Version 2.0 (the "License"); * you may not use this file except in compliance with the License. * You may obtain a copy of the License at * * http://www.apache.org/licenses/LICENSE-2.0 * * Unless required by applicable law or agreed to in writing, software * distributed under the License is distributed on an "AS IS" BASIS, * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. * See the License for the specific language governing permissions and * limitations under the License. */ package sample.flyway; import javax.persistence.Entity; import javax.persistence.GeneratedValue; import javax.persistence.Id; @Entity public class Person { @Id @GeneratedValue private Long id; private String firstName; private String lastName; private String surname; public String getFirstName() { return this.firstName; } public void setFirstName(String firstName) { this.firstName = firstName; } /** * Reading from the new column if it's set. If not the from the old one. * * When migrating from version 1.0.0 -&gt; 2.0.0 this can lead to a possibility that some data in * the surname column is not up to date (during the migration process lastName could have been updated). * In this case one can run yet another migration script after all applications have been deployed in the * new version to ensure that the surname field is updated. * * However it makes sense since when looking at the migration from 2.0.0 -&gt; 3.0.0. In 3.0.0 we no longer * have a notion of lastName at all - so we don't update that column. If we rollback from 3.0.0 -&gt; 2.0.0 if we * would be reading from lastName, then we would have very old data (since not a single datum was inserted * to lastName in version 3.0.0). */ public String getSurname() { return this.surname != null ? this.surname : this.lastName; } /** * Storing both FIRST_NAME and SURNAME entries */ public void setSurname(String surname) { this.lastName = surname; this.surname = surname; } @Override public String toString() { return "Person [firstName=" + this.firstName + ", lastName=" + this.lastName + ", surname=" + this.surname + "]"; } }</code> </pre> <br><h3 id="shag-3-udalenie-last_name-iz-koda">  Etapa 3: Removendo last_name do código </h3><br><p>  Versão do aplicativo: <code>3.0.0</code> </p><br><p>  Versão do banco de dados: <code>v3</code> </p><br><h3 id="kommentariy-3">  Comentário </h3><br><p>  <em>Nota</em>  <em>trans .: Aparentemente, o autor copiou por engano o texto deste bloco da etapa 2. No artigo original, nesta etapa, devem ser feitas alterações no código do aplicativo que visa remover a funcionalidade que usa a coluna <code>last_name</code> .</em> </p><br><p>  Adicionando uma nova coluna e copiando seu conteúdo, criamos alterações no banco de dados compatíveis com versões anteriores.  Além disso, se revertermos o JAR ou tivermos um JAR antigo funcionando, ele não será interrompido no tempo de execução. </p><br><h3 id="otkat-prilozheniya-2">  Aplicação de reversão </h3><br><p>  Atualmente, temos o aplicativo versão <code>3.0.0</code> e o banco de dados <code>v3</code> .  A versão <code>3.0.0</code> não salva dados no <code>last_name</code> .  Isso significa que o <code>surname</code> armazena as informações mais atuais. </p><br><p>  Passos: </p><br><ol><li>  reverta seu aplicativo para a versão <code>2.0.0</code> . </li><li>  versão <code>2.0.0</code> usa <code>last_name</code> e <code>surname</code> . </li><li>  a versão <code>2.0.0</code> usará <code>surname</code> se não for nulo; caso contrário, <code>last_name</code> </li></ol><br><h3 id="izmeneniya-bd-2">  Alterações no banco de dados </h3><br><p>  Não há alterações estruturais no banco de dados.  O script a seguir é executado, que executa a migração final dos dados antigos: </p><br><pre> <code class="plaintext hljs">-- WE'RE ASSUMING THAT IT'S A FAST MIGRATION - OTHERWISE WE WOULD HAVE TO MIGRATE IN BATCHES -- ALSO WE'RE NOT CHECKING IF WE'RE NOT OVERRIDING EXISTING ENTRIES. WE WOULD HAVE TO COMPARE -- ENTRY VERSIONS TO ENSURE THAT IF THERE IS ALREADY AN ENTRY WITH A HIGHER VERSION NUMBER -- WE WILL NOT OVERRIDE IT. UPDATE PERSON SET PERSON.surname = PERSON.last_name; -- DROPPING THE NOT NULL CONSTRAINT; OTHERWISE YOU WILL TRY TO INSERT NULL VALUE OF THE LAST_NAME -- WITH A NOT_NULL CONSTRAINT. ALTER TABLE PERSON MODIFY COLUMN last_name varchar(255) NULL DEFAULT NULL;</code> </pre> <br><h3 id="izmeneniya-koda-3">  Alterações de código </h3><br><p>  <em>Nota</em>  <em>trans .: a descrição desse bloco também foi copiada por engano pelo autor da etapa 2. De acordo com a lógica da matéria do artigo, as alterações no código nessa etapa devem ter como objetivo remover dele elementos que funcionam com a coluna <code>last_name</code> .</em> </p><br><p>  Armazenamos dados em <code>last_name</code> e <code>surname.</code>  Além disso, lemos da coluna <code>last_name</code> , pois é mais relevante.  Durante o processo de implantação, algumas solicitações podem ser processadas por uma instância que ainda não foi atualizada. </p><br><pre> <code class="plaintext hljs">/* * Copyright 2012-2016 the original author or authors. * * Licensed under the Apache License, Version 2.0 (the "License"); * you may not use this file except in compliance with the License. * You may obtain a copy of the License at * * http://www.apache.org/licenses/LICENSE-2.0 * * Unless required by applicable law or agreed to in writing, software * distributed under the License is distributed on an "AS IS" BASIS, * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. * See the License for the specific language governing permissions and * limitations under the License. */ package sample.flyway; import javax.persistence.Entity; import javax.persistence.GeneratedValue; import javax.persistence.Id; @Entity public class Person { @Id @GeneratedValue private Long id; private String firstName; private String surname; public String getFirstName() { return this.firstName; } public void setFirstName(String firstName) { this.firstName = firstName; } public String getSurname() { return this.surname; } public void setSurname(String lastname) { this.surname = lastname; } @Override public String toString() { return "Person [firstName=" + this.firstName + ", surname=" + this.surname + "]"; } }</code> </pre> <br><h3 id="shag-4-udalenie-last_name-iz-bd">  Etapa 4: Removendo last_name do banco de dados </h3><br><p>  Versão do aplicativo: <code>4.0.0</code> </p><br><p>  Versão do banco de dados: <code>v4</code> </p><br><h3 id="kommentariy-4">  Comentário </h3><br><p>  Devido ao fato de o código da versão <code>3.0.0</code> não usar a coluna <code>last_name</code> , nada de ruim acontecerá durante a execução se voltarmos para a <code>3.0.0</code> após remover a coluna do banco de dados. </p><br><h3 id="logi-ispolneniya-skripta-1">  Logs de execução de script </h3><br><pre> <code class="plaintext hljs">We will do it in the following way: 01) Run 1.0.0 02) Wait for the app (1.0.0) to boot 03) Generate a person by calling POST localhost:9991/person to version 1.0.0 04) Run 2.0.0 05) Wait for the app (2.0.0) to boot 06) Generate a person by calling POST localhost:9991/person to version 1.0.0 07) Generate a person by calling POST localhost:9992/person to version 2.0.0 08) Kill app (1.0.0) 09) Run 3.0.0 10) Wait for the app (3.0.0) to boot 11) Generate a person by calling POST localhost:9992/person to version 2.0.0 12) Generate a person by calling POST localhost:9993/person to version 3.0.0 13) Kill app (3.0.0) 14) Run 4.0.0 15) Wait for the app (4.0.0) to boot 16) Generate a person by calling POST localhost:9993/person to version 3.0.0 17) Generate a person by calling POST localhost:9994/person to version 4.0.0 Starting app in version 1.0.0 Generate a person in version 1.0.0 Sending a post to 127.0.0.1:9991/person. This is the response: {"firstName":"52b6e125-4a5c-429b-a47a-ef18bbc639d2","lastName":"52b6e125-4a5c-429b-a47a-ef18bbc639d2"} Starting app in version 2.0.0 Generate a person in version 1.0.0 Sending a post to 127.0.0.1:9991/person. This is the response: {"firstName":"e41ee756-4fa7-4737-b832-e28827a00deb","lastName":"e41ee756-4fa7-4737-b832-e28827a00deb"} Generate a person in version 2.0.0 Sending a post to 127.0.0.1:9992/person. This is the response: {"firstName":"0c1240f5-649a-4bc5-8aa9-cff855f3927f","lastName":"0c1240f5-649a-4bc5-8aa9-cff855f3927f","surname":"0c1240f5-649a-4bc5-8aa9-cff855f3927f"} Killing app 1.0.0 Starting app in version 3.0.0 Generate a person in version 2.0.0 Sending a post to 127.0.0.1:9992/person. This is the response: {"firstName":"74d84a9e-5f44-43b8-907c-148c6d26a71b","lastName":"74d84a9e-5f44-43b8-907c-148c6d26a71b","surname":"74d84a9e-5f44-43b8-907c-148c6d26a71b"} Generate a person in version 3.0.0 Sending a post to 127.0.0.1:9993/person. This is the response: {"firstName":"c6564dbe-9ab5-40ae-9077-8ae6668d5862","surname":"c6564dbe-9ab5-40ae-9077-8ae6668d5862"} Killing app 2.0.0 Starting app in version 4.0.0 Generate a person in version 3.0.0 Sending a post to 127.0.0.1:9993/person. This is the response: {"firstName":"cbe942fc-832e-45e9-a838-0fae25c10a51","surname":"cbe942fc-832e-45e9-a838-0fae25c10a51"} Generate a person in version 4.0.0 Sending a post to 127.0.0.1:9994/person. This is the response: {"firstName":"ff6857ce-9c41-413a-863e-358e2719bf88","surname":"ff6857ce-9c41-413a-863e-358e2719bf88"}</code> </pre> <br><h3 id="izmeneniya-db-1">  Alterações no banco de dados </h3><br><p>  Para a <code>v3</code> simplesmente removemos a coluna <code>last_name</code> e adicionamos as restrições ausentes. </p><br><pre> <code class="plaintext hljs">-- REMOVE THE COLUMN ALTER TABLE PERSON DROP last_name; -- ADD CONSTRAINTS UPDATE PERSON SET surname='' WHERE surname IS NULL; ALTER TABLE PERSON ALTER COLUMN surname VARCHAR NOT NULL;</code> </pre> <br><h3 id="izmeneniya-koda-4">  Alterações de código </h3><br><p>  Não há alterações no código. </p><br><h3 id="vyvod">  Conclusão </h3><br><p>  Aplicamos com êxito a alteração do nome da coluna incompatível com versões anteriores executando várias implantações compatíveis com versões anteriores.  Abaixo está um resumo das etapas executadas: </p><br><ol><li>  implementação de aplicativo versão <code>1.0.0</code> com esquema de banco de dados <code>v1</code> (nome da coluna = <code>last_name</code> ) </li><li>  implemente o aplicativo versão <code>2.0.0,</code> que salva os dados em <code>last_name</code> e <code>surname</code> .  O aplicativo lê de <code>last_name</code> .  O banco de dados está na versão <code>v2</code> , que contém as colunas <code>last_name</code> e <code>surname. surname</code>  <code>surname. surname</code> é uma cópia de l <code>ast_name</code> . (:       not null) </li><li>    <code>3.0.0</code> ,      <code>surname</code>    surname.   ,     <code>last_name</code>  <code>surname</code> .   <strong>NOT NULL</strong>   <code>last_name</code> .     <code>v3</code> </li><li>    <code>4.0.0</code> —      .    <code>v4</code> ,   <code>last_name</code> .         . </li></ol><br><p>   ,        ,      / . </p><br><h3 id="kod">  Código </h3><br><p>  ,    ,   <a href="https://github.com/spring-cloud-samples/zero-downtime-deployment">Github</a> .   . </p><br><h3 id="proekty">  </h3><br><p>   ,     . </p><br><pre> <code class="plaintext hljs">├── boot-flyway-v1 - 1.0.0 version of the app with v1 of the schema ├── boot-flyway-v2 - 2.0.0 version of the app with v2 of the schema (backward-compatible - app can be rolled back) ├── boot-flyway-v2-bad - 2.0.0.BAD version of the app with v2bad of the schema (backward-incompatible - app cannot be rolled back) ├── boot-flyway-v3 - 3.0.0 version of the app with v3 of the schema (app can be rolled back) └── boot-flyway-v4 - 4.0.0 version of the app with v4 of the schema (app can be rolled back)</code> </pre> <br><h3 id="skripty">  </h3><br><p>    ,    ,         . </p><br><p>   <strong>    </strong> , : </p><br><pre> <code class="plaintext hljs">./scripts/scenario_backward_compatible.sh</code> </pre> <br><p>    <strong>    </strong> , : </p><br><pre> <code class="plaintext hljs">./scripts/scenario_backward_incompatible.sh</code> </pre> <br><h3 id="spring-boot-sample-flyway"> Spring Boot Sample Flyway </h3><br><p>     <code>Spring Boot Sample Flyway.</code> </p><br><p>     <code>http://localhost:8080/flyway</code> ,   . </p><br><p>        H2 (  <code>http://localhost:8080/h2-console</code> ),        (URL jdbc   — <code>jdbc:h2:mem:testdb</code> ). </p><br><h2 id="dopolnitelno">  Opcional </h2><br><ul><li> <a href="https://databaserefactoring.com/">Database Refactoring patterns</a> </li><li> <a href="https://martinfowler.com/bliki/ContinuousDelivery.html">Continuous Delivery</a> </li></ul><br><h2 id="takzhe-chitayte-drugie-stati-v-nashem-bloge">  Leia também outros artigos em nosso blog: </h2><br><ul><li>  <a href="https://habr.com/ru/company/nixys/blog/480072/">Kubernetes: por que é tão importante configurar o gerenciamento de recursos do sistema?</a> </li><li>  <a href="https://habr.com/ru/company/nixys/blog/481992/">Pipeline Tekton - pipelines nativos de Kubernetes</a> </li><li>  <a href="https://habr.com/ru/company/nixys/blog/473578/">Criando módulos dinâmicos para o Nginx</a> </li><li>  <a href="https://habr.com/ru/company/nixys/blog/473014/">Introdução à autorização Kubernetes do cônsul Hashicorp</a> </li><li>  <a href="https://habr.com/ru/company/nixys/blog/468779/">Qual foi o resultado da migração do ClickHouse sem autorização para o ClickHouse com autorização</a> </li><li>  <a href="https://habr.com/ru/company/nixys/blog/470568/">Implantação azul-verde de aplicativos Spring com o Nginx Web Server</a> </li></ul></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt481932/">https://habr.com/ru/post/pt481932/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt481916/index.html">Qual foi o ano de 2019 lembrado em desenvolvimento?</a></li>
<li><a href="../pt481922/index.html">Ano Novo IMaskjs 6 - Reagir Native, Pipes, ESM</a></li>
<li><a href="../pt481924/index.html">Apache Spark, avaliação lenta e consultas SQL de várias páginas</a></li>
<li><a href="../pt481926/index.html">Conheça a nova solução Veeam Backup for AWS</a></li>
<li><a href="../pt481930/index.html">Cultura de desenvolvimento: como o desempenho e a eficiência são avaliados</a></li>
<li><a href="../pt481934/index.html">Análise: por que as ações da Tesla estão crescendo em preço</a></li>
<li><a href="../pt481936/index.html">Prós e contras dos testes A / B: experiência de grandes empresas</a></li>
<li><a href="../pt481940/index.html">Trabalho rápido e eficaz na linha de comando</a></li>
<li><a href="../pt481942/index.html">De volta ao futuro: que jogos modernos foram apresentados em 2010</a></li>
<li><a href="../pt481944/index.html">O que determina a posição do site na página de pesquisa?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>