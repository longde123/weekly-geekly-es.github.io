<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üÜò üó∫Ô∏è üí™ Implanta√ß√£o e bancos de dados sem tempo de inatividade üë≤üèæ ‚ûó üì∫</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Este artigo explica em detalhes como resolver os problemas associados √† compatibilidade do banco de dados durante a implanta√ß√£o. Informaremos o que po...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Implanta√ß√£o e bancos de dados sem tempo de inatividade</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/nixys/blog/481932/"><p><img src="https://habrastorage.org/webt/hr/vy/qq/hrvyqqi2mmitehw9vx_xklbofj8.png" alt="imagem"></p><br><p>  Este artigo explica em detalhes como resolver os problemas associados √† compatibilidade do banco de dados durante a implanta√ß√£o.  Informaremos o que pode acontecer com seus aplicativos no produto se voc√™ tentar executar uma implanta√ß√£o sem qualquer prepara√ß√£o preliminar.  Em seguida, percorreremos as etapas do ciclo de vida do aplicativo, que s√£o necess√°rias para que o tempo de inatividade seja zero ( <em>aprox. Transl .: mais - zero de inatividade</em> ).  O resultado de nossas opera√ß√µes ser√° a aplica√ß√£o de uma altera√ß√£o de banco de dados incompat√≠vel com vers√µes anteriores de uma maneira compat√≠vel com vers√µes anteriores. </p><a name="habracut"></a><br><p>  Se voc√™ quiser entender os exemplos de c√≥digo do artigo, voc√™ os encontrar√° no <a href="https://github.com/spring-cloud-samples/zero-downtime-deployment">GitHub</a> . </p><br><h2 id="vvedenie">  1. Introdu√ß√£o </h2><br><h3 id="zero-downtime-deployment">  Implanta√ß√£o de tempo de inatividade zero </h3><br><p>  Qual √© a <strong>implanta√ß√£o</strong> m√≠stica de <strong>tempo de inatividade zero</strong> ?  Podemos dizer isso quando seu aplicativo √© implantado, para que voc√™ possa introduzir com √™xito uma nova vers√£o do aplicativo para produ√ß√£o, enquanto o usu√°rio n√£o percebe sua inacessibilidade.  Do ponto de vista do usu√°rio e da empresa, esse √© o melhor cen√°rio de implanta√ß√£o poss√≠vel, pois dessa forma √© poss√≠vel introduzir novas fun√ß√µes e eliminar erros sem interrup√ß√£o. </p><br><p>  Como conseguir isso?  Existem v√°rias maneiras, aqui est√° uma delas: </p><br><ul><li>  expanda a vers√£o 1 do seu servi√ßo </li><li>  migrar o banco de dados </li><li>  implemente a vers√£o 2 do seu servi√ßo em paralelo com a vers√£o 1 </li><li>  assim que vir que o n√∫mero da vers√£o 2 est√° funcionando como deveria, remova o n√∫mero da vers√£o 1 </li><li>  pronto! </li></ul><br><p>  F√°cil n√©?  Infelizmente, isso n√£o √© t√£o simples, e consideraremos isso em detalhes posteriormente.  Agora vamos verificar outro processo de implanta√ß√£o bastante comum - implanta√ß√£o verde azul. </p><br><p>  Voc√™ j√° ouviu falar em <a href="https://martinfowler.com/bliki/BlueGreenDeployment.html">implanta√ß√£o verde azul</a> ?  Com o Cloud Foundry, isso √© extremamente f√°cil de fazer.  D√™ uma olhada <a href="https://spring.io/blog/2014/04/04/project-sagan-zero-downtime-deployments">neste artigo,</a> onde o descrevemos com mais detalhes.  Resumindo, lembramos como fazer a implanta√ß√£o verde azul: </p><br><ul><li>  <em>Garanta a opera√ß√£o de duas c√≥pias do seu c√≥digo de produ√ß√£o ("azul" e "verde");</em> </li><li>  <em>direcione todo o tr√°fego para o ambiente azul, ou seja,</em>  <em>para que os URLs de produ√ß√£o sejam apontados para l√°;</em> </li><li>  <em>Implante e teste todas as altera√ß√µes de aplicativo em um ambiente verde</em> </li><li>  <em>alternar URLs do ambiente azul para o verde</em> </li></ul><br><p>  A implanta√ß√£o verde azul √© uma abordagem que permite introduzir facilmente novos recursos sem se preocupar com a interrup√ß√£o da produ√ß√£o.  Isso ocorre porque mesmo que algo aconte√ßa, voc√™ pode reverter facilmente para o ambiente anterior simplesmente clicando em um bot√£o. </p><br><p>  Depois de ler todas as op√ß√µes acima, voc√™ pode fazer a pergunta: O que o tempo de inatividade zero tem a ver com a implanta√ß√£o verde azul? </p><br><p>  Bem, eles t√™m muito em comum, porque o suporte a duas c√≥pias do mesmo ambiente requer esfor√ßos duplos para mant√™-las.  √â por isso que algumas equipes, de acordo com <a href="https://martinfowler.com/bliki/BlueGreenDeployment.html">Martin Fowler</a> , aderem a varia√ß√µes dessa abordagem: </p><br><p> <em>outra op√ß√£o √© usar o mesmo banco de dados, criando op√ß√µes verde-azuladas para camadas da web e de dom√≠nio.</em>  <em>Nessa abordagem, os bancos de dados geralmente podem ser um problema, especialmente quando voc√™ precisa alterar seu esquema para suportar uma nova vers√£o do software.</em> </p><br><p>  E aqui chegamos ao principal problema neste artigo.  <strong>O banco de dados</strong>  Vamos dar uma outra olhada nesta frase. </p><br><p>  <em>migrar o banco de dados.</em> </p><br><p>  Agora voc√™ deve se perguntar: e se a altera√ß√£o do banco de dados for incompat√≠vel com vers√µes anteriores?  Minha primeira vers√£o do aplicativo n√£o ser√° interrompida?  De fato, √© exatamente isso que vai acontecer ... </p><br><p>  Assim, apesar dos enormes benef√≠cios de zero tempo de inatividade / implanta√ß√£o verde azul, as empresas tendem a seguir o seguinte processo de implanta√ß√£o mais seguro para seus aplicativos: </p><br><ul><li>  preparar um pacote com uma nova vers√£o do aplicativo </li><li>  desligar um aplicativo em execu√ß√£o </li><li>  executar scripts para migra√ß√£o de banco de dados </li><li>  implantar e iniciar a nova vers√£o do aplicativo </li></ul><br><p>  Neste artigo, descreveremos em detalhes como voc√™ pode trabalhar com um banco de dados e c√≥digo para aproveitar a implanta√ß√£o de tempo de inatividade zero. </p><br><h3 id="problemy-s-bazoy-dannyh">  Problemas de banco de dados </h3><br><p>  Se voc√™ tiver um aplicativo sem estado que n√£o armazena nenhum dado no banco de dados, poder√° obter a implanta√ß√£o de tempo de inatividade zero imediatamente.  Infelizmente, a maioria dos softwares precisa armazenar dados em algum lugar.  √â por isso que voc√™ deve pensar duas vezes antes de fazer altera√ß√µes no circuito.  Antes de nos aprofundarmos nos detalhes de como alterar o esquema para que seja poss√≠vel implantar sem tempo de inatividade, vamos nos concentrar primeiro no esquema de controle de vers√£o. </p><br><h3 id="shema-upravleniya-versiyami">  Esquema de controle de vers√£o </h3><br><p> Neste artigo, usaremos o <a href="https://flywaydb.org/">Flyway</a> como uma ferramenta para controle de vers√£o ( <em>aproximadamente tradu√ß√£o: estamos falando sobre migra√ß√£o de banco de dados</em> ).  Naturalmente, tamb√©m escreveremos um aplicativo Spring Boot que tenha suporte Flyway embutido e migrar√° o circuito ao configurar o contexto do aplicativo.  Ao usar o Flyway, voc√™ pode armazenar scripts de migra√ß√£o na pasta de projetos (por padr√£o, em <code>classpath:db/migration</code> ).  Aqui voc√™ pode ver um exemplo desses arquivos de migra√ß√£o. </p><br><pre> <code class="plaintext hljs">‚îî‚îÄ‚îÄ db ‚îî‚îÄ‚îÄ migration ‚îú‚îÄ‚îÄ V1__init.sql ‚îú‚îÄ‚îÄ V2__Add_surname.sql ‚îú‚îÄ‚îÄ V3__Final_migration.sql ‚îî‚îÄ‚îÄ V4__Remove_lastname.sql</code> </pre> <br><p>  Neste exemplo, vemos 4 cen√°rios de migra√ß√£o que, se n√£o foram executados anteriormente, ser√£o executados um ap√≥s o outro quando o aplicativo for iniciado.  Vejamos um dos arquivos ( <code>V1__init.sql</code> ) como um exemplo. </p><br><pre> <code class="plaintext hljs">CREATE TABLE PERSON ( id BIGINT GENERATED BY DEFAULT AS IDENTITY, first_name varchar(255) not null, last_name varchar(255) not null ); insert into PERSON (first_name, last_name) values ('Dave', 'Syer');</code> </pre> <br><p>  Tudo fala perfeitamente por si: voc√™ pode usar o SQL para determinar como seu banco de dados deve ser modificado.  Para obter mais informa√ß√µes sobre o Spring Boot e o Flyway, consulte <a href="https://docs.spring.io/spring-boot/docs/1.3.5.RELEASE/reference/html/howto-database-initialization.html">Documentos de inicializa√ß√£o do Spring</a> . </p><br><p>  O uso do controle de vers√£o com o Spring Boot oferece 2 grandes benef√≠cios: </p><br><ul><li>  voc√™ separa as altera√ß√µes no banco de dados das altera√ß√µes no c√≥digo </li><li>  a migra√ß√£o do banco de dados ocorre junto com a distribui√ß√£o do seu aplicativo, ou seja,  seu processo de implanta√ß√£o √© simplificado </li></ul><br><h2 id="reshenie-problem-s-bazoy-dannyh">  Solucionando problemas de banco de dados </h2><br><p>  Na pr√≥xima se√ß√£o do artigo, focaremos em considerar duas abordagens para altera√ß√µes no banco de dados. </p><br><ul><li>  incompatibilidade com vers√µes anteriores </li><li>  compatibilidade com vers√µes anteriores </li></ul><br><p>  O primeiro ser√° considerado como um aviso de que voc√™ n√£o deve executar uma implanta√ß√£o de tempo de inatividade zero sem prepara√ß√£o preliminar ... O segundo oferece uma solu√ß√£o para como voc√™ pode executar uma implanta√ß√£o sem tempo de inatividade e, ao mesmo tempo, manter a compatibilidade com vers√µes anteriores. </p><br><p>  Nosso projeto, no qual trabalharemos, ser√° um aplicativo Spring Boot Flyway simples, no qual h√° uma <code>Person</code> com nome e <code>last_name</code> no banco de dados ( <em>aprox. Por.: <code>Person</code> √© uma tabela e f <code>irst_name</code> e <code>irst_name</code> s√£o os campos</em> ).  Queremos renomear <code>last_name</code> para <code>surname</code> . </p><br><h3 id="dopuscheniya">  Pressupostos </h3><br><p>  Antes de nos aprofundarmos nos detalhes, precisamos esbo√ßar algumas suposi√ß√µes sobre nossos aplicativos.  O principal resultado que queremos alcan√ßar ser√° um processo bastante simples. </p><br><blockquote>  <strong>Nota</strong>  Neg√≥cios PRO-DICA.  A racionaliza√ß√£o de processos pode economizar muito dinheiro em suporte (quanto mais pessoas trabalham em sua empresa, mais dinheiro voc√™ pode economizar)! </blockquote><br><h3 id="ne-nado-delat-otkat-bazy-dannyh">  N√£o h√° necessidade de reverter o banco de dados </h3><br><p>  Isso simplifica o processo de implanta√ß√£o (algumas revers√µes do banco de dados s√£o quase imposs√≠veis, por exemplo, exclus√£o de revers√£o).  Preferimos reverter apenas os aplicativos.  Dessa forma, mesmo se voc√™ tiver bancos de dados diferentes (por exemplo, SQL e NoSQL), seu pipeline de implanta√ß√£o ter√° a mesma apar√™ncia. </p><br><p>  <strong>SEMPRE √© poss√≠vel reverter o aplicativo uma vers√£o novamente (n√£o mais)</strong> </p><br><p>  A revers√£o deve ser feita apenas se necess√°rio.  Se houver um erro na vers√£o atual que n√£o seja f√°cil de corrigir, poderemos retornar a vers√£o funcional mais recente.  Assumimos que esta vers√£o de trabalho mais recente seja a anterior.  Manter a compatibilidade de c√≥digo e banco de dados para mais de uma distribui√ß√£o seria extremamente dif√≠cil e dispendioso. </p><br><blockquote>  <strong>Nota</strong>  Para maior legibilidade, dentro da estrutura deste artigo, alteraremos a vers√£o principal do aplicativo. </blockquote><br><h3 id="shag-1-ishodnoe-sostoyanie">  Etapa 1: Estado inicial </h3><br><p>  Vers√£o do aplicativo: <code>1.0.0</code> <br>  Vers√£o do banco de dados: <code>v1</code> </p><br><h3 id="kommentariy">  Coment√°rio </h3><br><p>  Este ser√° o estado inicial do aplicativo. </p><br><h3 id="izmeneniya-bd">  Altera√ß√µes no banco de dados </h3><br><p>  O banco de dados cont√©m <code>last_name.</code> </p><br><pre> <code class="plaintext hljs">CREATE TABLE PERSON ( id BIGINT GENERATED BY DEFAULT AS IDENTITY, first_name varchar(255) not null, last_name varchar(255) not null ); insert into PERSON (first_name, last_name) values ('Dave', 'Syer');</code> </pre> <br><h3 id="izmeneniya-koda">  Altera√ß√µes de c√≥digo </h3><br><p>  O aplicativo salva os dados da pessoa em <code>last_name</code> : </p><br><pre> <code class="plaintext hljs">/* * Copyright 2012-2016 the original author or authors. * * Licensed under the Apache License, Version 2.0 (the "License"); * you may not use this file except in compliance with the License. * You may obtain a copy of the License at * * http://www.apache.org/licenses/LICENSE-2.0 * * Unless required by applicable law or agreed to in writing, software * distributed under the License is distributed on an "AS IS" BASIS, * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. * See the License for the specific language governing permissions and * limitations under the License. */ package sample.flyway; import javax.persistence.Entity; import javax.persistence.GeneratedValue; import javax.persistence.Id; @Entity public class Person { @Id @GeneratedValue private Long id; private String firstName; private String lastName; public String getFirstName() { return this.firstName; } public void setFirstName(String firstName) { this.firstName = firstName; } public String getLastName() { return this.lastName; } public void setLastName(String lastname) { this.lastName = lastname; } @Override public String toString() { return "Person [firstName=" + this.firstName + ", lastName=" + this.lastName + "]"; } }</code> </pre> <br><h3 id="obratno-nesovmestimoe-pereimenovanie-stolbca">  Renomea√ß√£o de coluna incompat√≠vel </h3><br><p>  Vejamos um exemplo de como alterar o nome de uma coluna: </p><br><blockquote>  <strong>Aten√ß√£o</strong>  O exemplo a seguir ser√° interrompido intencionalmente.  Mostramos isso para demonstrar o problema de compatibilidade do banco de dados. </blockquote><p>  Vers√£o do aplicativo: <code>2.0.0.BAD</code> </p><br><p>  Vers√£o do banco de dados: <code>v2bad</code> </p><br><h3 id="kommentariy-1">  Coment√°rio </h3><br><p>  As altera√ß√µes atuais N√ÉO nos permitem executar duas inst√¢ncias (antigas e novas) ao mesmo tempo.  Portanto, ser√° dif√≠cil conseguir uma implanta√ß√£o com tempo de inatividade zero (suposi√ß√µes levadas em considera√ß√£o, isso √© praticamente imposs√≠vel). </p><br><h3 id="ab-testirovanie">  Teste A / B </h3><br><p>  A situa√ß√£o atual √© que temos um aplicativo vers√£o <code>1.0.0,</code> implementado no prod, e um banco de dados <code>v1</code> .  Devemos implantar a segunda inst√¢ncia do aplicativo, vers√£o <code>2.0.0.BAD</code> , e atualizar o banco de dados para <code>v2bad</code> . </p><br><p>  Passos: </p><br><ol><li>  implementou uma nova inst√¢ncia do aplicativo vers√£o <code>2.0.0.BAD</code> , que atualiza o banco de dados para <code>v2bad</code> </li><li>  a coluna <code>last_name</code> n√£o existe mais no banco de dados <code>v2bad</code> - foi alterada para <code>surname</code> </li><li>  As atualiza√ß√µes de banco de dados e aplicativos foram bem-sucedidas e algumas inst√¢ncias funcionam na <code>1.0.0</code> , outras na <code>2.0.0.BAD</code> .  Tudo relacionado ao <code>v2bad</code> </li><li>  todas as inst√¢ncias da vers√£o <code>1.0.0</code> come√ßar√£o a gerar erros porque tentar√£o inserir dados na coluna <code>last_name</code> , que n√£o √© mais </li><li>  todas as inst√¢ncias da vers√£o <code>2.0.0.BAD</code> funcionar√£o sem problemas </li></ol><br><p>  Como voc√™ pode ver, se fizermos altera√ß√µes incompat√≠veis no banco de dados e nos aplicativos, o teste A / B ser√° imposs√≠vel. </p><br><h3 id="otkat-prilozheniya">  Aplica√ß√£o de revers√£o </h3><br><p>  Vamos supor que, depois de tentar executar a implanta√ß√£o A / B ( <em>aprox. Transl.: Provavelmente, o autor estava se referindo ao teste A / B aqui</em> ), decidimos que precisamos reverter o aplicativo para a vers√£o <code>1.0.0.</code>  Suponha que n√£o queremos reverter o banco de dados. </p><br><p>  Passos: </p><br><ol><li>  paramos a inst√¢ncia da aplica√ß√£o vers√£o <code>2.0.0.BAD</code> </li><li>  banco de dados ainda √© <code>v2bad</code> </li><li>  como a vers√£o <code>1.0.0</code> n√£o entende o que <code>surname</code> , veremos erros </li><li>  inferno se libertou, n√£o podemos mais voltar </li></ol><br><p>  Como voc√™ pode ver, se fizermos altera√ß√µes incompat√≠veis no banco de dados e nos aplicativos, n√£o podemos reverter para a vers√£o anterior. </p><br><h3 id="logi-ispolneniya-skripta">  Logs de execu√ß√£o de script </h3><br><pre> <code class="plaintext hljs">Backward incompatible scenario: 01) Run 1.0.0 02) Wait for the app (1.0.0) to boot 03) Generate a person by calling POST localhost:9991/person to version 1.0.0 04) Run 2.0.0.BAD 05) Wait for the app (2.0.0.BAD) to boot 06) Generate a person by calling POST localhost:9991/person to version 1.0.0 &lt;-- this should fail 07) Generate a person by calling POST localhost:9992/person to version 2.0.0.BAD &lt;-- this should pass Starting app in version 1.0.0 Generate a person in version 1.0.0 Sending a post to 127.0.0.1:9991/person. This is the response: {"firstName":"b73f639f-e176-4463-bf26-1135aace2f57","lastName":"b73f639f-e176-4463-bf26-1135aace2f57"} Starting app in version 2.0.0.BAD Generate a person in version 1.0.0 Sending a post to 127.0.0.1:9991/person. This is the response: curl: (22) The requested URL returned error: 500 Internal Server Error Generate a person in version 2.0.0.BAD Sending a post to 127.0.0.1:9995/person. This is the response: {"firstName":"e156be2e-06b6-4730-9c43-6e14cfcda125","surname":"e156be2e-06b6-4730-9c43-6e14cfcda125"}</code> </pre> <br><h3 id="izmeneniya-bd-1">  Altera√ß√µes no banco de dados </h3><br><p>  Script de migra√ß√£o que renomeia <code>surname</code> </p><br><p>  Script Flyway de origem: </p><br><pre> <code class="plaintext hljs">CREATE TABLE PERSON ( id BIGINT GENERATED BY DEFAULT AS IDENTITY, first_name varchar(255) not null, last_name varchar(255) not null ); insert into PERSON (first_name, last_name) values ('Dave', 'Syer');</code> </pre> <br><p>  Um script que renomeia <code>last_name</code> . </p><br><pre> <code class="plaintext hljs">-- This change is backward incompatible - you can't do A/B testing ALTER TABLE PERSON CHANGE last_name surname VARCHAR;</code> </pre> <br><h3 id="izmeneniya-koda-1">  Altera√ß√µes de c√≥digo </h3><br><p>  <code>lastName</code> nome do campo <code>lastName</code> para <code>surname</code> . </p><br><h3 id="pereimenovanie-stolbca-obratno-sovmestimym-sposobom">  Renomeando uma coluna de maneira compat√≠vel com vers√µes anteriores </h3><br><p>  Essa √© a situa√ß√£o mais comum que podemos encontrar.  Precisamos fazer altera√ß√µes incompat√≠veis com vers√µes anteriores.  J√° provamos que, para uma implanta√ß√£o sem tempo de inatividade, n√£o devemos aplicar apenas a migra√ß√£o do banco de dados sem a√ß√µes adicionais.  Nesta se√ß√£o do artigo, faremos 3 implanta√ß√µes do aplicativo junto com as migra√ß√µes do banco de dados para alcan√ßar o resultado desejado e, ao mesmo tempo, manter a compatibilidade com vers√µes anteriores. </p><br><blockquote>  <strong>Nota</strong>  Lembre-se de que temos uma vers√£o de banco de dados <code>v1</code> .  Ele cont√©m as colunas <code>first_name</code> e <code>last_name</code> .  Devemos mudar <code>last_name</code> para <code>surname</code> .  Tamb√©m temos um aplicativo vers√£o <code>1.0.0,</code> que ainda n√£o usa <code>surname</code> . </blockquote><br><h3 id="shag-2-dobavlyaem-surname">  Etapa 2: adicionar sobrenome </h3><br><p>  Vers√£o do aplicativo: <code>2.0.0</code> <br>  Vers√£o do banco de dados: <code>v2</code> </p><br><h3 id="kommentariy-2">  Coment√°rio </h3><br><p>  Ao adicionar uma nova coluna e copiar seu conte√∫do, criamos altera√ß√µes no banco de dados compat√≠veis com vers√µes anteriores.  Ao mesmo tempo, se revertermos o JAR ou tivermos um JAR antigo funcional, ele n√£o ser√° interrompido no tempo de execu√ß√£o. </p><br><h3 id="vykatyvaem-novuyu-versiyu">  Lan√ßamos a nova vers√£o </h3><br><p>  Passos: </p><br><ol><li>  migrar o banco de dados para criar uma nova coluna de <code>surname</code> .  Agora sua vers√£o db <code>v2</code> </li><li>  copie dados do <code>last_name</code> para o <code>surname</code> .  <strong>Observe</strong> que, se voc√™ tiver muitos desses dados, considere a migra√ß√£o em lote! </li><li>  escreva o c√≥digo onde ambas as colunas <strong>nova</strong> e <strong>antiga</strong> s√£o usadas.  Agora seu aplicativo vers√£o <code>2.0.0</code> </li><li>  leia o valor da coluna <code>surname</code> , se n√£o for <code>null</code> , ou de l <code>ast_name</code> se o <code>surname</code> n√£o <code>surname</code> especificado.  Voc√™ pode remover <code>getLastName()</code> do c√≥digo, pois ele retornar√° <code>null</code> quando voc√™ reverter seu aplicativo de <code>3.0.0</code> para <code>2.0.0</code> . </li></ol><br><p>  Se voc√™ estiver usando o Spring Boot Flyway, essas duas etapas ser√£o executadas durante o lan√ßamento da vers√£o <code>2.0.0</code> aplicativo.  Se voc√™ executar a ferramenta de controle de vers√£o do banco de dados manualmente, precisar√° fazer duas coisas diferentes para isso (primeiro atualize a vers√£o do banco de dados manualmente e, em seguida, implante um novo aplicativo). </p><br><blockquote>  <strong>√â importante.</strong>  Lembre-se de que uma coluna rec√©m-criada <strong>N√ÉO</strong> <strong>DEVE</strong> <strong>SER NULA</strong> .  Se voc√™ reverter, o aplicativo antigo n√£o saber√° sobre a nova coluna e n√£o a instalar√° durante a <code>Insert.</code>  Mas se voc√™ adicionar essa restri√ß√£o, e seu banco de dados for <code>v2</code> , ser√° necess√°rio definir o valor da nova coluna.  O que levar√° a viola√ß√µes de restri√ß√µes. <br><br>  <strong>√â importante.</strong>  Voc√™ deve remover o m√©todo <code>getLastName()</code> , pois a vers√£o <code>3.0.0</code> n√£o possui o conceito de uma coluna <code>last_name</code> no c√≥digo.  Isso significa que nulo ser√° definido l√°.  Voc√™ pode deixar o m√©todo e adicionar verifica√ß√µes <code>null</code> , mas uma solu√ß√£o muito melhor seria garantir que voc√™ tenha escolhido o valor diferente de zero correto na l√≥gica <code>getSurname()</code> . </blockquote><br><h3 id="ab-testirovanie-1">  Teste A / B </h3><br><p>  A situa√ß√£o atual √© que temos uma vers√£o <code>1.0.0</code> aplicativo implantada no produto e um banco de dados na <code>v1</code> .  Precisamos implantar a segunda inst√¢ncia do aplicativo vers√£o <code>2.0.0</code> , que atualizar√° o banco de dados para a <code>v2</code> . </p><br><p>  Passos: </p><br><ol><li>  implementou uma nova inst√¢ncia do aplicativo vers√£o <code>2.0.0</code> , que atualiza o banco de dados para a <code>v2</code> </li><li>  Enquanto isso, alguns pedidos foram tratados por inst√¢ncias da vers√£o <code>1.0.0</code> </li><li>  a atualiza√ß√£o foi bem-sucedida e voc√™ tem v√°rias inst√¢ncias de trabalho do aplicativo vers√£o <code>1.0.0</code> e do restante da vers√£o <code>2.0.0.</code>  Todos se comunicam com o banco de dados na <code>v2</code> </li><li>  a vers√£o <code>1.0.0</code> n√£o usa a coluna de sobrenome no banco de dados, mas a vers√£o <code>2.0.0</code> .  Eles n√£o interferem um com o outro e n√£o deve haver erros. </li><li>  vers√£o <code>2.0.0</code> armazena dados na coluna antiga e na nova, o que fornece compatibilidade com vers√µes anteriores </li></ol><br><blockquote>  <strong>√â importante.</strong>  Se voc√™ tiver alguma d√∫vida que conte itens com base em valores da coluna antiga / nova, lembre-se de que agora voc√™ tem valores duplicados (provavelmente eles ainda est√£o migrando).  Por exemplo, se voc√™ quiser contar o n√∫mero de usu√°rios cujo sobrenome (independentemente do nome da coluna) come√ßa com a letra <code>A</code> , antes que a migra√ß√£o de dados ( <code>old</code> ‚Üí <code>new</code> coluna) seja conclu√≠da, voc√™ poder√° ter dados inconsistentes se executar uma consulta em uma nova coluna. </blockquote><br><h3 id="otkat-prilozheniya-1">  Aplica√ß√£o de revers√£o </h3><br><p>  Agora, temos um aplicativo vers√£o <code>2.0.0</code> e um banco de dados na <code>v2</code> . </p><br><p>  Passos: </p><br><ol><li>  reverta seu aplicativo para a vers√£o <code>1.0.0</code> . </li><li>  a vers√£o <code>1.0.0</code> n√£o usa a coluna de <code>surname</code> no banco de dados, portanto, a revers√£o deve ser bem-sucedida </li></ol><br><h3 id="izmeneniya-db">  Altera√ß√µes no banco de dados </h3><br><p>  O banco de dados cont√©m uma coluna chamada <code>last_name</code> . </p><br><p>  Script Flyway de origem: </p><br><pre> <code class="plaintext hljs">CREATE TABLE PERSON ( id BIGINT GENERATED BY DEFAULT AS IDENTITY, first_name varchar(255) not null, last_name varchar(255) not null ); insert into PERSON (first_name, last_name) values ('Dave', 'Syer');</code> </pre> <br><p>  O script para adicionar <code>surname</code> . </p><br><blockquote>  <strong>Aten√ß√£o</strong>  Lembre-se de que voc√™ N√ÉO PODE ADICIONAR nenhuma restri√ß√£o NOT NULL √† coluna adicionada.  Se voc√™ reverter o JAR, a vers√£o antiga n√£o tem id√©ia da coluna adicionada e a definir√° automaticamente como NULL.  Se houver essa restri√ß√£o, o aplicativo antigo simplesmente ser√° interrompido. </blockquote><br><pre> <code class="plaintext hljs">-- NOTE: This field can't have the NOT NULL constraint cause if you rollback, the old version won't know about this field -- and will always set it to NULL ALTER TABLE PERSON ADD surname varchar(255); -- WE'RE ASSUMING THAT IT'S A FAST MIGRATION - OTHERWISE WE WOULD HAVE TO MIGRATE IN BATCHES UPDATE PERSON SET PERSON.surname = PERSON.last_name</code> </pre> <br><h3 id="izmeneniya-koda-2">  Altera√ß√µes de c√≥digo </h3><br><p>  Armazenamos dados em <code>last_name</code> e <code>surname</code> .  Ao mesmo tempo, lemos de <code>last_name</code> , pois essa coluna √© mais relevante.  Durante o processo de implanta√ß√£o, algumas solicita√ß√µes podem ter sido tratadas por uma inst√¢ncia de aplicativo que ainda n√£o foi atualizada. </p><br><pre> <code class="plaintext hljs">/* * Copyright 2012-2016 the original author or authors. * * Licensed under the Apache License, Version 2.0 (the "License"); * you may not use this file except in compliance with the License. * You may obtain a copy of the License at * * http://www.apache.org/licenses/LICENSE-2.0 * * Unless required by applicable law or agreed to in writing, software * distributed under the License is distributed on an "AS IS" BASIS, * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. * See the License for the specific language governing permissions and * limitations under the License. */ package sample.flyway; import javax.persistence.Entity; import javax.persistence.GeneratedValue; import javax.persistence.Id; @Entity public class Person { @Id @GeneratedValue private Long id; private String firstName; private String lastName; private String surname; public String getFirstName() { return this.firstName; } public void setFirstName(String firstName) { this.firstName = firstName; } /** * Reading from the new column if it's set. If not the from the old one. * * When migrating from version 1.0.0 -&gt; 2.0.0 this can lead to a possibility that some data in * the surname column is not up to date (during the migration process lastName could have been updated). * In this case one can run yet another migration script after all applications have been deployed in the * new version to ensure that the surname field is updated. * * However it makes sense since when looking at the migration from 2.0.0 -&gt; 3.0.0. In 3.0.0 we no longer * have a notion of lastName at all - so we don't update that column. If we rollback from 3.0.0 -&gt; 2.0.0 if we * would be reading from lastName, then we would have very old data (since not a single datum was inserted * to lastName in version 3.0.0). */ public String getSurname() { return this.surname != null ? this.surname : this.lastName; } /** * Storing both FIRST_NAME and SURNAME entries */ public void setSurname(String surname) { this.lastName = surname; this.surname = surname; } @Override public String toString() { return "Person [firstName=" + this.firstName + ", lastName=" + this.lastName + ", surname=" + this.surname + "]"; } }</code> </pre> <br><h3 id="shag-3-udalenie-last_name-iz-koda">  Etapa 3: Removendo last_name do c√≥digo </h3><br><p>  Vers√£o do aplicativo: <code>3.0.0</code> </p><br><p>  Vers√£o do banco de dados: <code>v3</code> </p><br><h3 id="kommentariy-3">  Coment√°rio </h3><br><p>  <em>Nota</em>  <em>trans .: Aparentemente, o autor copiou por engano o texto deste bloco da etapa 2. No artigo original, nesta etapa, devem ser feitas altera√ß√µes no c√≥digo do aplicativo que visa remover a funcionalidade que usa a coluna <code>last_name</code> .</em> </p><br><p>  Adicionando uma nova coluna e copiando seu conte√∫do, criamos altera√ß√µes no banco de dados compat√≠veis com vers√µes anteriores.  Al√©m disso, se revertermos o JAR ou tivermos um JAR antigo funcionando, ele n√£o ser√° interrompido no tempo de execu√ß√£o. </p><br><h3 id="otkat-prilozheniya-2">  Aplica√ß√£o de revers√£o </h3><br><p>  Atualmente, temos o aplicativo vers√£o <code>3.0.0</code> e o banco de dados <code>v3</code> .  A vers√£o <code>3.0.0</code> n√£o salva dados no <code>last_name</code> .  Isso significa que o <code>surname</code> armazena as informa√ß√µes mais atuais. </p><br><p>  Passos: </p><br><ol><li>  reverta seu aplicativo para a vers√£o <code>2.0.0</code> . </li><li>  vers√£o <code>2.0.0</code> usa <code>last_name</code> e <code>surname</code> . </li><li>  a vers√£o <code>2.0.0</code> usar√° <code>surname</code> se n√£o for nulo; caso contr√°rio, <code>last_name</code> </li></ol><br><h3 id="izmeneniya-bd-2">  Altera√ß√µes no banco de dados </h3><br><p>  N√£o h√° altera√ß√µes estruturais no banco de dados.  O script a seguir √© executado, que executa a migra√ß√£o final dos dados antigos: </p><br><pre> <code class="plaintext hljs">-- WE'RE ASSUMING THAT IT'S A FAST MIGRATION - OTHERWISE WE WOULD HAVE TO MIGRATE IN BATCHES -- ALSO WE'RE NOT CHECKING IF WE'RE NOT OVERRIDING EXISTING ENTRIES. WE WOULD HAVE TO COMPARE -- ENTRY VERSIONS TO ENSURE THAT IF THERE IS ALREADY AN ENTRY WITH A HIGHER VERSION NUMBER -- WE WILL NOT OVERRIDE IT. UPDATE PERSON SET PERSON.surname = PERSON.last_name; -- DROPPING THE NOT NULL CONSTRAINT; OTHERWISE YOU WILL TRY TO INSERT NULL VALUE OF THE LAST_NAME -- WITH A NOT_NULL CONSTRAINT. ALTER TABLE PERSON MODIFY COLUMN last_name varchar(255) NULL DEFAULT NULL;</code> </pre> <br><h3 id="izmeneniya-koda-3">  Altera√ß√µes de c√≥digo </h3><br><p>  <em>Nota</em>  <em>trans .: a descri√ß√£o desse bloco tamb√©m foi copiada por engano pelo autor da etapa 2. De acordo com a l√≥gica da mat√©ria do artigo, as altera√ß√µes no c√≥digo nessa etapa devem ter como objetivo remover dele elementos que funcionam com a coluna <code>last_name</code> .</em> </p><br><p>  Armazenamos dados em <code>last_name</code> e <code>surname.</code>  Al√©m disso, lemos da coluna <code>last_name</code> , pois √© mais relevante.  Durante o processo de implanta√ß√£o, algumas solicita√ß√µes podem ser processadas por uma inst√¢ncia que ainda n√£o foi atualizada. </p><br><pre> <code class="plaintext hljs">/* * Copyright 2012-2016 the original author or authors. * * Licensed under the Apache License, Version 2.0 (the "License"); * you may not use this file except in compliance with the License. * You may obtain a copy of the License at * * http://www.apache.org/licenses/LICENSE-2.0 * * Unless required by applicable law or agreed to in writing, software * distributed under the License is distributed on an "AS IS" BASIS, * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. * See the License for the specific language governing permissions and * limitations under the License. */ package sample.flyway; import javax.persistence.Entity; import javax.persistence.GeneratedValue; import javax.persistence.Id; @Entity public class Person { @Id @GeneratedValue private Long id; private String firstName; private String surname; public String getFirstName() { return this.firstName; } public void setFirstName(String firstName) { this.firstName = firstName; } public String getSurname() { return this.surname; } public void setSurname(String lastname) { this.surname = lastname; } @Override public String toString() { return "Person [firstName=" + this.firstName + ", surname=" + this.surname + "]"; } }</code> </pre> <br><h3 id="shag-4-udalenie-last_name-iz-bd">  Etapa 4: Removendo last_name do banco de dados </h3><br><p>  Vers√£o do aplicativo: <code>4.0.0</code> </p><br><p>  Vers√£o do banco de dados: <code>v4</code> </p><br><h3 id="kommentariy-4">  Coment√°rio </h3><br><p>  Devido ao fato de o c√≥digo da vers√£o <code>3.0.0</code> n√£o usar a coluna <code>last_name</code> , nada de ruim acontecer√° durante a execu√ß√£o se voltarmos para a <code>3.0.0</code> ap√≥s remover a coluna do banco de dados. </p><br><h3 id="logi-ispolneniya-skripta-1">  Logs de execu√ß√£o de script </h3><br><pre> <code class="plaintext hljs">We will do it in the following way: 01) Run 1.0.0 02) Wait for the app (1.0.0) to boot 03) Generate a person by calling POST localhost:9991/person to version 1.0.0 04) Run 2.0.0 05) Wait for the app (2.0.0) to boot 06) Generate a person by calling POST localhost:9991/person to version 1.0.0 07) Generate a person by calling POST localhost:9992/person to version 2.0.0 08) Kill app (1.0.0) 09) Run 3.0.0 10) Wait for the app (3.0.0) to boot 11) Generate a person by calling POST localhost:9992/person to version 2.0.0 12) Generate a person by calling POST localhost:9993/person to version 3.0.0 13) Kill app (3.0.0) 14) Run 4.0.0 15) Wait for the app (4.0.0) to boot 16) Generate a person by calling POST localhost:9993/person to version 3.0.0 17) Generate a person by calling POST localhost:9994/person to version 4.0.0 Starting app in version 1.0.0 Generate a person in version 1.0.0 Sending a post to 127.0.0.1:9991/person. This is the response: {"firstName":"52b6e125-4a5c-429b-a47a-ef18bbc639d2","lastName":"52b6e125-4a5c-429b-a47a-ef18bbc639d2"} Starting app in version 2.0.0 Generate a person in version 1.0.0 Sending a post to 127.0.0.1:9991/person. This is the response: {"firstName":"e41ee756-4fa7-4737-b832-e28827a00deb","lastName":"e41ee756-4fa7-4737-b832-e28827a00deb"} Generate a person in version 2.0.0 Sending a post to 127.0.0.1:9992/person. This is the response: {"firstName":"0c1240f5-649a-4bc5-8aa9-cff855f3927f","lastName":"0c1240f5-649a-4bc5-8aa9-cff855f3927f","surname":"0c1240f5-649a-4bc5-8aa9-cff855f3927f"} Killing app 1.0.0 Starting app in version 3.0.0 Generate a person in version 2.0.0 Sending a post to 127.0.0.1:9992/person. This is the response: {"firstName":"74d84a9e-5f44-43b8-907c-148c6d26a71b","lastName":"74d84a9e-5f44-43b8-907c-148c6d26a71b","surname":"74d84a9e-5f44-43b8-907c-148c6d26a71b"} Generate a person in version 3.0.0 Sending a post to 127.0.0.1:9993/person. This is the response: {"firstName":"c6564dbe-9ab5-40ae-9077-8ae6668d5862","surname":"c6564dbe-9ab5-40ae-9077-8ae6668d5862"} Killing app 2.0.0 Starting app in version 4.0.0 Generate a person in version 3.0.0 Sending a post to 127.0.0.1:9993/person. This is the response: {"firstName":"cbe942fc-832e-45e9-a838-0fae25c10a51","surname":"cbe942fc-832e-45e9-a838-0fae25c10a51"} Generate a person in version 4.0.0 Sending a post to 127.0.0.1:9994/person. This is the response: {"firstName":"ff6857ce-9c41-413a-863e-358e2719bf88","surname":"ff6857ce-9c41-413a-863e-358e2719bf88"}</code> </pre> <br><h3 id="izmeneniya-db-1">  Altera√ß√µes no banco de dados </h3><br><p>  Para a <code>v3</code> simplesmente removemos a coluna <code>last_name</code> e adicionamos as restri√ß√µes ausentes. </p><br><pre> <code class="plaintext hljs">-- REMOVE THE COLUMN ALTER TABLE PERSON DROP last_name; -- ADD CONSTRAINTS UPDATE PERSON SET surname='' WHERE surname IS NULL; ALTER TABLE PERSON ALTER COLUMN surname VARCHAR NOT NULL;</code> </pre> <br><h3 id="izmeneniya-koda-4">  Altera√ß√µes de c√≥digo </h3><br><p>  N√£o h√° altera√ß√µes no c√≥digo. </p><br><h3 id="vyvod">  Conclus√£o </h3><br><p>  Aplicamos com √™xito a altera√ß√£o do nome da coluna incompat√≠vel com vers√µes anteriores executando v√°rias implanta√ß√µes compat√≠veis com vers√µes anteriores.  Abaixo est√° um resumo das etapas executadas: </p><br><ol><li>  implementa√ß√£o de aplicativo vers√£o <code>1.0.0</code> com esquema de banco de dados <code>v1</code> (nome da coluna = <code>last_name</code> ) </li><li>  implemente o aplicativo vers√£o <code>2.0.0,</code> que salva os dados em <code>last_name</code> e <code>surname</code> .  O aplicativo l√™ de <code>last_name</code> .  O banco de dados est√° na vers√£o <code>v2</code> , que cont√©m as colunas <code>last_name</code> e <code>surname. surname</code>  <code>surname. surname</code> √© uma c√≥pia de l <code>ast_name</code> . (:       not null) </li><li>    <code>3.0.0</code> ,      <code>surname</code>    surname.   ,     <code>last_name</code>  <code>surname</code> .   <strong>NOT NULL</strong>   <code>last_name</code> .     <code>v3</code> </li><li>    <code>4.0.0</code> ‚Äî      .    <code>v4</code> ,   <code>last_name</code> .         . </li></ol><br><p>   ,        ,      / . </p><br><h3 id="kod">  C√≥digo </h3><br><p>  ,    ,   <a href="https://github.com/spring-cloud-samples/zero-downtime-deployment">Github</a> .   . </p><br><h3 id="proekty">  </h3><br><p>   ,     . </p><br><pre> <code class="plaintext hljs">‚îú‚îÄ‚îÄ boot-flyway-v1 - 1.0.0 version of the app with v1 of the schema ‚îú‚îÄ‚îÄ boot-flyway-v2 - 2.0.0 version of the app with v2 of the schema (backward-compatible - app can be rolled back) ‚îú‚îÄ‚îÄ boot-flyway-v2-bad - 2.0.0.BAD version of the app with v2bad of the schema (backward-incompatible - app cannot be rolled back) ‚îú‚îÄ‚îÄ boot-flyway-v3 - 3.0.0 version of the app with v3 of the schema (app can be rolled back) ‚îî‚îÄ‚îÄ boot-flyway-v4 - 4.0.0 version of the app with v4 of the schema (app can be rolled back)</code> </pre> <br><h3 id="skripty">  </h3><br><p>    ,    ,         . </p><br><p>   <strong>    </strong> , : </p><br><pre> <code class="plaintext hljs">./scripts/scenario_backward_compatible.sh</code> </pre> <br><p>    <strong>    </strong> , : </p><br><pre> <code class="plaintext hljs">./scripts/scenario_backward_incompatible.sh</code> </pre> <br><h3 id="spring-boot-sample-flyway"> Spring Boot Sample Flyway </h3><br><p>     <code>Spring Boot Sample Flyway.</code> </p><br><p>     <code>http://localhost:8080/flyway</code> ,   . </p><br><p>        H2 (  <code>http://localhost:8080/h2-console</code> ),        (URL jdbc   ‚Äî <code>jdbc:h2:mem:testdb</code> ). </p><br><h2 id="dopolnitelno">  Opcional </h2><br><ul><li> <a href="https://databaserefactoring.com/">Database Refactoring patterns</a> </li><li> <a href="https://martinfowler.com/bliki/ContinuousDelivery.html">Continuous Delivery</a> </li></ul><br><h2 id="takzhe-chitayte-drugie-stati-v-nashem-bloge">  Leia tamb√©m outros artigos em nosso blog: </h2><br><ul><li>  <a href="https://habr.com/ru/company/nixys/blog/480072/">Kubernetes: por que √© t√£o importante configurar o gerenciamento de recursos do sistema?</a> </li><li>  <a href="https://habr.com/ru/company/nixys/blog/481992/">Pipeline Tekton - pipelines nativos de Kubernetes</a> </li><li>  <a href="https://habr.com/ru/company/nixys/blog/473578/">Criando m√≥dulos din√¢micos para o Nginx</a> </li><li>  <a href="https://habr.com/ru/company/nixys/blog/473014/">Introdu√ß√£o √† autoriza√ß√£o Kubernetes do c√¥nsul Hashicorp</a> </li><li>  <a href="https://habr.com/ru/company/nixys/blog/468779/">Qual foi o resultado da migra√ß√£o do ClickHouse sem autoriza√ß√£o para o ClickHouse com autoriza√ß√£o</a> </li><li>  <a href="https://habr.com/ru/company/nixys/blog/470568/">Implanta√ß√£o azul-verde de aplicativos Spring com o Nginx Web Server</a> </li></ul></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt481932/">https://habr.com/ru/post/pt481932/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt481916/index.html">Qual foi o ano de 2019 lembrado em desenvolvimento?</a></li>
<li><a href="../pt481922/index.html">Ano Novo IMaskjs 6 - Reagir Native, Pipes, ESM</a></li>
<li><a href="../pt481924/index.html">Apache Spark, avalia√ß√£o lenta e consultas SQL de v√°rias p√°ginas</a></li>
<li><a href="../pt481926/index.html">Conhe√ßa a nova solu√ß√£o Veeam Backup for AWS</a></li>
<li><a href="../pt481930/index.html">Cultura de desenvolvimento: como o desempenho e a efici√™ncia s√£o avaliados</a></li>
<li><a href="../pt481934/index.html">An√°lise: por que as a√ß√µes da Tesla est√£o crescendo em pre√ßo</a></li>
<li><a href="../pt481936/index.html">Pr√≥s e contras dos testes A / B: experi√™ncia de grandes empresas</a></li>
<li><a href="../pt481940/index.html">Trabalho r√°pido e eficaz na linha de comando</a></li>
<li><a href="../pt481942/index.html">De volta ao futuro: que jogos modernos foram apresentados em 2010</a></li>
<li><a href="../pt481944/index.html">O que determina a posi√ß√£o do site na p√°gina de pesquisa?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>