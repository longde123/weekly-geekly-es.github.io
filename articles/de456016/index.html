<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üè∏ üòú üëâüèø Protokoll f√ºr die Kommunikation zwischen iframe und dem Hauptfenster ‚ûó üë®üèΩ‚ÄçüöÄ üçß</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Von Zeit zu Zeit m√ºssen Entwickler die Kommunikation zwischen mehreren Browser-Registerkarten herstellen, um Nachrichten von einer Registerkarte zur a...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Protokoll f√ºr die Kommunikation zwischen iframe und dem Hauptfenster</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/waves/blog/456016/"><p>  Von Zeit zu Zeit m√ºssen Entwickler die Kommunikation zwischen mehreren Browser-Registerkarten herstellen, um Nachrichten von einer Registerkarte zur anderen senden und Antworten empfangen zu k√∂nnen.  Wir haben uns auch irgendwann diesem Bed√ºrfnis gestellt. </p><br><p>  Einige L√∂sungen existieren bereits (wie zum Beispiel die BroadcastChannel-API).  Die Browserunterst√ºtzung <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">l√§sst jedoch zu w√ºnschen √ºbrig</a> , weshalb wir uns f√ºr eine eigene Bibliothek entschieden haben.  Als die Bibliothek fertig war, war diese Funktionalit√§t nicht mehr erforderlich.  Dennoch ergab sich eine andere Aufgabe: die Kommunikation zwischen einem Iframe und dem Hauptfenster. </p><br><p>  Bei n√§herer Betrachtung stellte sich heraus, dass zwei Drittel der Bibliothek nicht ge√§ndert werden mussten - nur einige Code-Umgestaltungen waren erforderlich.  Die Bibliothek ist ein Kommunikationsprotokoll, das mit Textdaten arbeiten kann.  Es kann in allen F√§llen angewendet werden, in denen Text √ºbertragen wird, z. B. iframes, window.open, worker, Browser-Registerkarten oder WebSocket. </p><br><h2 id="how-it-works">  Wie es funktioniert </h2><br><p>  Derzeit hat das Protokoll zwei Funktionen: Senden von Nachrichten und Abonnieren von Ereignissen.  Jede Nachricht im Protokoll ist ein Datenobjekt.  F√ºr uns ist das Hauptfeld in diesem Objekt der <strong>Typ</strong> , der uns sagt, um welche Art von Nachricht es sich handelt.  Das <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Typfeld</a> ist eine <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Aufz√§hlung</a> mit den folgenden Werten: </p><a name="habracut"></a><br><ul><li>  0 - Nachricht senden </li><li>  1 - Senden einer Anfrage </li><li>  2 - eine Antwort erhalten. </li></ul><br><h3 id="sending-a-message">  Senden einer Nachricht </h3><br><p>  Das Senden einer Nachricht bedeutet keine Antwort.  Um eine Nachricht zu senden, erstellen wir ein Objekt mit den folgenden Feldern: </p><br><ul><li>  <strong>Typ</strong> - Ereignistyp 0 </li><li>  <strong>name</strong> - <strong>Name des</strong> Benutzerereignisses </li><li>  <strong>Daten</strong> - Benutzerdaten (JSON-√§hnlich). </li></ul><br><p>  Beim Empfang einer Nachricht auf der anderen Seite mit dem <strong>Typfeld</strong> <strong>= 0</strong> wissen wir, dass es sich um ein Ereignis mit einem vorhandenen Ereignisnamen und Daten handelt.  Alles was wir tun m√ºssen, ist das Ereignis zu √ºbertragen (fast ein Standard- <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">EventEmitter-</a> Muster). </p><br><p>  So funktioniert es in einem einfachen Schema: </p><br><p><img src="https://habrastorage.org/webt/yx/f2/wf/yxf2wfru7lcmcxutd7fonc-awgw.png"></p><br><h3 id="sending-a-request">  Senden einer Anfrage </h3><br><p>  Das Senden einer Anfrage impliziert, dass innerhalb der Bibliothek eine Anforderungs- <strong>ID</strong> erstellt wird und die Bibliothek auf eine Antwort mit der <strong>ID</strong> wartet.  Nach erfolgreichem Empfang einer Antwort werden alle Zusatzfelder entfernt und die Antwort an den Benutzer zur√ºckgegeben.  Au√üerdem kann die maximale Antwortzeit eingestellt werden. </p><br><p><img src="https://habrastorage.org/webt/6r/xb/ic/6rxbicfoqfhxe9zx4nf_eryxgrm.png"></p><br><p>  Bei Anfragen ist dies etwas komplizierter.  Um auf eine Anfrage zu antworten, m√ºssen Sie die in unserem Protokoll verf√ºgbaren Methoden bekannt geben.  Dies erfolgt mit der Methode <strong>registerRequestHandler</strong> .  Es akzeptiert den Namen einer Anforderung f√ºr eine Antwort und eine Funktion, die die Antwort zur√ºckgibt.  Um eine Anfrage zu erstellen, ben√∂tigen wir eine <strong>ID</strong> , und wir k√∂nnen grunds√§tzlich einen <strong>Zeitstempel verwenden</strong> , aber die Anpassung ist nicht sehr bequem.  Dies ist also eine Klassen-ID, die eine Antwort + Antwortnummer + Zeichenfolgenliteral sendet.  Jetzt erstellen wir ein Objekt mit den folgenden Feldern: <strong>ID</strong> , <strong>Typ = 1</strong> , <strong>Name</strong> als Anforderungsname und <strong>Daten</strong> als Benutzerdaten (JSON-√§hnlich). </p><br><p>  Beim Empfang einer Anfrage pr√ºfen wir, ob wir eine API zur Beantwortung dieser Anfrage haben. Wenn dies nicht der Fall ist, geben wir eine Fehlermeldung zur√ºck.  Wenn wir eine API haben, geben wir das Ergebnis der Ausf√ºhrung der Funktion von <strong>registerRequestHandler</strong> mit dem entsprechenden Anforderungsnamen zur√ºck. </p><br><p>  F√ºr die Antwort erstellen wir ein Objekt mit den Feldern: <strong>Typ</strong> = 2, <strong>ID</strong> als ID der Nachricht, auf die wir antworten, <strong>Status</strong> als Feld, das angibt, ob diese Antwort ein Fehler ist (wenn wir keine API haben, oder der Handler ist ein Fehler aufgetreten, oder der Benutzer hat ein abgelehntes Versprechen zur√ºckgegeben, oder es tritt ein anderer Fehler auf (serialisieren)) und der <strong>Inhalt</strong> als Antwortdaten. </p><br><p>  Daher haben wir die Funktionsweise des Protokolls beschrieben, das die Busklasse ausf√ºhrt, aber den Prozess des Sendens und Empfangens von Nachrichten nicht erl√§utert.  Daf√ºr ben√∂tigen wir Klassenadapter mit drei Methoden. </p><br><ul><li>  <strong>send</strong> ist eine Methode, die grunds√§tzlich f√ºr das Senden von Nachrichten verantwortlich ist </li><li>  <strong>addListener</strong> ist eine Methode zum Abonnieren von Ereignissen </li><li>  <strong>destroy</strong> ist eine Methode zum L√∂schen von Abonnements beim L√∂schen von <strong>Bus</strong> . </li></ul><br><h2 id="adapters-execution-of-the-protocol">  Adapter.  Ausf√ºhrung des Protokolls </h2><br><p>  Zum Starten des Protokolls ist derzeit nur der Adapter f√ºr die Arbeit mit iframe / window bereit.  Es verwendet <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">postMessage</a> und <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">addEventListener</a> .  Es ist ziemlich einfach: Sie m√ºssen eine Nachricht mit einem korrekten <strong>Ursprung</strong> an <strong>postMessage</strong> senden und Nachrichten √ºber <strong>addEventListener</strong> beim Ereignis <strong>"message"</strong> abh√∂ren. </p><br><p>  Wir sind auf einige Nuancen gesto√üen: </p><br><ul><li>  Sie sollten die Antworten in IHREM Fenster immer anh√∂ren und im ANDEREN Fenster senden (Iframe, Opener, Eltern, Arbeiter usw.).  Wenn Sie versuchen, eine Nachricht im ANDEREN Fenster abzuh√∂ren und der Ursprung vom aktuellen abweicht, tritt ein Fehler auf. </li><li>  Stellen Sie beim Empfang einer Nachricht sicher, dass sie an Sie gerichtet wurde: Das Fenster kann viele Analysemeldungen, WebStorm (falls Sie es verwenden) und andere Iframes aufnehmen. Sie m√ºssen also sicherstellen, dass das Ereignis in Ihrem Protokoll enthalten und f√ºr Sie bestimmt ist. </li><li> Sie k√∂nnen ein <strong><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Versprechen nicht</a></strong> mit einer <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Windows-</a> Kopie zur√ºckgeben, da das <strong>Versprechen</strong> bei der R√ºckgabe des Ergebnisses versucht, zu √ºberpr√ºfen, ob das Ergebnis die <strong>then-</strong> Methode hat.  Wenn Sie keinen Zugriff auf das Fenster haben (z. B. ein Fenster mit einem anderen Ursprung), tritt ein Fehler auf (obwohl dies nicht in allen Browsern der Fall ist).  Um dieses Problem zu vermeiden, w√ºrde es ausreichen, das Fenster in das Objekt einzuschlie√üen und ein Objekt in das Versprechen aufzunehmen, das einen Link zum richtigen Fenster enth√§lt. </li></ul><br><h2 id="usage-examples">  Anwendungsbeispiele: </h2><br><p>  Die Bibliothek ist in NPM verf√ºgbar und kann einfach √ºber Ihren Paketmanager installiert werden - <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">@ Wave / Waves-Browser-Bus</a> </p><br><p>  Um eine bidirektionale Kommunikation mit einem Iframe herzustellen, reicht es aus, diesen Code zu verwenden: </p><br><pre><code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { Bus, WindowAdapter } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'@waves/waves-browser-bus'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> url = <span class="hljs-string"><span class="hljs-string">'https://some-iframe-content-url.com'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> iframe = <span class="hljs-built_in"><span class="hljs-built_in">document</span></span>.createElement(<span class="hljs-string"><span class="hljs-string">'iframe'</span></span>); WindowAdapter.createSimpleWindowAdapter(iframe).then(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">adapter</span></span></span><span class="hljs-function"> =&gt;</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> bus = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Bus(adapter); bus.once(<span class="hljs-string"><span class="hljs-string">'ready'</span></span>, () =&gt; { <span class="hljs-comment"><span class="hljs-comment">// A message from iframe received }); }); iframe.src = url; // It's preferable to assign a url after calling WindowAdapter.createSimpleWindowAdapter document.body.appendChild(iframe);</span></span></code> </pre> <br><p>  Innerhalb des Iframes: </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { Bus, WindowAdapter } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'@waves/waves-browser-bus'</span></span>; WindowAdapter.createSimpleWindowAdapter().then(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">adapter</span></span></span><span class="hljs-function"> =&gt;</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> bus = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Bus(adapter); bus.dispatchEvent(<span class="hljs-string"><span class="hljs-string">'ready'</span></span>, <span class="hljs-literal"><span class="hljs-literal">null</span></span>); <span class="hljs-comment"><span class="hljs-comment">// A message has been sent to the parent window });</span></span></code> </pre> <br><h2 id="whats-next">  Was kommt als n√§chstes? </h2><br><p>  Wir haben ein flexibles und vielseitiges Protokoll, das in jeder Situation verwendet werden kann.  Als n√§chstes plane ich, die Adapter vom Protokoll zu trennen und sie in separate npm-Pakete zu packen und Adapter f√ºr Worker- und Browser-Registerkarten hinzuzuf√ºgen.  Ich m√∂chte, dass das Schreiben von Adaptern, die das Protokoll f√ºr andere Zwecke ausf√ºhren, so einfach wie m√∂glich ist.  Wenn Sie am Entwicklungsprozess teilnehmen m√∂chten oder Ideen zur Funktionalit√§t der Bibliothek haben, k√∂nnen Sie sich gerne im <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Repo</a> an uns <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">wenden</a> . </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de456016/">https://habr.com/ru/post/de456016/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de456002/index.html">Spezielles Herdged√§chtnis und OOM Killer-Intervention</a></li>
<li><a href="../de456004/index.html">Wir laden Sie zu einem Front-End-Entwicklungstreffen mit stark ausgelasteten Diensten ein</a></li>
<li><a href="../de456006/index.html">Steigern Sie Ihren Umsatz mit In-App-K√§ufen</a></li>
<li><a href="../de456008/index.html">Entwicklung von Programmen f√ºr den Zentralprozessor Redd am Beispiel des Zugriffs auf das FPGA</a></li>
<li><a href="../de456010/index.html">Wie Java 10 die Art und Weise √§ndert, wie Sie anonyme innere Klassen verwenden</a></li>
<li><a href="../de456018/index.html">So implementieren Sie eine Bereitstellung von GitHub auf einem Produktionsserver mithilfe von Webhook</a></li>
<li><a href="../de456022/index.html">QIWI JS DETOX</a></li>
<li><a href="../de456024/index.html">PHP 2019: Besser als Sie dar√ºber nachdenken</a></li>
<li><a href="../de456026/index.html">NeoQUEST-2019 von Angesicht zu Angesicht: Schie√üen Sie Drohnen ab und erstellen Sie ein VirusTotal im Taschenformat</a></li>
<li><a href="../de456028/index.html">Dub-Dub 2019: WWDC-Nachrichten und meine Eindr√ºcke</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>