<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üì± üßóüèº üò± Implementaci√≥n de mi sistema dom√≥tico üèì üë©üèΩ‚Äç‚öïÔ∏è ü§õ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Durante mucho tiempo le√≠ art√≠culos sobre Habr√© sobre sistemas de automatizaci√≥n del hogar, quer√≠a describir en qu√© he estado trabajando durante m√°s de...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Implementaci√≥n de mi sistema dom√≥tico</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/386457/"><img src="https://habrastorage.org/files/ea9/62e/a6d/ea962ea6d63c4af99f2a68e426d88fa5.jpg" align="right"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Durante mucho tiempo le√≠ art√≠culos sobre Habr√© sobre sistemas de automatizaci√≥n del hogar, quer√≠a describir en qu√© he estado trabajando durante m√°s de 2 a√±os. Para comprender mejor mi situaci√≥n, se necesita una peque√±a introducci√≥n. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Hace tres a√±os, mi familia y yo nos mudamos a un nuevo apartamento de tres habitaciones (67.5 metros cuadrados), aunque t√©cnicamente el apartamento es, por supuesto, viejo: Stalin, una casa construida en 1946. Cableado de aluminio de dos hilos con trozos de cable trenzado de cobre de 1 m2 en algunos lugares. La revisi√≥n estaba por delante, decid√≠ hacer todo yo mismo y comenc√© con un reemplazo completo del cableado. Compraron 700m de cable de alimentaci√≥n para iluminaci√≥n y enchufes de 1.5 y 2.5 Mm cuadrados, bah√≠a de par trenzado, un poco de cable coaxial para antenas de televisi√≥n (por si acaso). ¬øPor qu√© tanto y por qu√©? Pido un gato.</font></font><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Decid√≠ hacer el cableado de inmediato, es decir: sin cajas de distribuci√≥n, desde cada punto el cable va al blindaje (con la excepci√≥n de las salidas, que pueden estar en un grupo de 2-3 puntos, el cable va al blindaje desde el extremo, el resto est√° conectado por un bucle) - t. mi. de cada interruptor, su propio cable al escudo, desde cada punto de iluminaci√≥n, su propio cable al escudo, cerca de los enchufes a lo largo de un par de puntos rj-45, por si acaso. Por supuesto, hay muchos cables. En alg√∫n lugar se coloca en el piso de conformidad con todas las reglas del PUE, como, por ejemplo, en la guarder√≠a: </font></font><br>
<br>
<img src="https://habrastorage.org/files/09e/071/732/09e0717328cb46a0b0df95701ac88122.jpg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En alg√∫n lugar, en el techo, por ejemplo, la vista de la puerta del dormitorio:</font></font><br>
<br>
<img src="https://habrastorage.org/files/f0f/f50/510/f0ff505103224720825920b62b9da86c.jpg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como resultado, obtenemos todos los cables en el corredor en un lugar donde se ubicar√° el escudo, y se pueden cambiar entre ellos como lo desee. Incluso si tiene que cambiar el esquema de conexi√≥n en el futuro, no tomar√° mucho tiempo y no tendr√° que estropear la reparaci√≥n. Y, por supuesto, se hicieron muchos enchufes para todas las ocasiones, en total unos 90 puntos para todo el apartamento. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As√≠ es como se ve√≠a el "escudo" temporal durante los experimentos: una </font></font><br>
<br>
<img src="https://habrastorage.org/files/1e4/0bd/131/1e40bd1311d2412686170c0ae8619274.jpg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
visi√≥n terrible, pero todo funcion√≥ y de esta forma este monstruo vivi√≥ durante varios meses. Un buen d√≠a, las estrellas se formaron con √©xito y el escudo se rehizo por decisi√≥n deliberada. Tom√≥ 3 d√≠as en una escalera destartalada debajo del techo (y los techos en el stalin 3m), pero vali√≥ la pena. As√≠ es como comenz√≥ a verse la visera despu√©s de eso: </font></font><br>
<br>
<img src="https://habrastorage.org/files/34b/2e4/1e9/34b2e41e94a54217bad80ce53d2e0e45.jpg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Y la visi√≥n general:</font></font><br>
<br>
<img src="https://habrastorage.org/files/054/e15/85e/054e1585eeb74b7ebe62e3fcd946e1a3.jpg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Esto est√° lejos de la forma final del escudo, todav√≠a no hay suficiente RCD, hay 3 veces menos interruptores de circuito de los necesarios, no hay rel√©s de pulso, pero hay l√≠neas sin desconexi√≥n, todos los cables est√°n conectados a los terminales, hay al menos alg√∫n tipo de selectividad de interruptor de circuito. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ahora que tiene una idea aproximada de exactamente con qu√© tuve que trabajar, puede comenzar a describir los "cerebros" del sistema. Sin m√°s pre√°mbulos, tom√© la base de arduino, especialmente porque ya ten√≠a 2 placas freeduino, 2 protectores de ethernet y un protector de motor que compr√© mucho antes. Tambi√©n orden√≥ a los chinos varios m√≥dulos de rel√© de 4 piezas cada uno. Y tambi√©n encontr√©, siguiendo el consejo de uno de los art√≠culos sobre Habr√© en Ob, interruptores en los que se pod√≠an insertar resortes especiales y se convert√≠an en interruptores sin fijaci√≥n. Es hora de escribir c√≥digo.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En general, estoy muy conectado con las computadoras en la vida. Termin√≥ la estera de pieles, en la que simplemente no escribi√≥: pascal, c #, c ++, 1c, php, javascript, todav√≠a puede enumerar mucho. La √∫ltima vez que trabajo en el campo del desarrollo web, tambi√©n trato con telefon√≠a ip. Por lo tanto, crear un algoritmo es simple, pero con la electr√≥nica "para usted", s√© y s√© cosas simples, y cuando se trata de algo m√°s complicado: microcontroladores, fusibles, rebote de contacto, es m√°s dif√≠cil. Pero no son los dioses los que queman las ollas, los ojos tienen miedo, pero las manos s√≠. Decid√≠ hacer todo simple. Alimento la tierra desde el arduino a la entrada del interruptor, conecto las salidas del interruptor a los pines anal√≥gicos en el arduino (aunque es posible digital, no es importante). Conecto los pines del arduino con los pines del m√≥dulo de rel√©. T√©cnicamente, todo est√° listo, cuando presiona el interruptor, el arduino ve el valor BAJO en el pin deseado y establece el BAJO en el pin conectado al m√≥dulo de rel√©.Dado que todos los cables de los puntos del apartamento llegan a las terminales, la conexi√≥n no tom√≥ mucho tiempo.</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para combatir el rebote de contactos, despu√©s de estudiar el tema en Internet, se seleccion√≥ la biblioteca Bounce2. En general, inicialmente quer√≠a escribir un c√≥digo universal para poder usarlo con al menos 2 interruptores, al menos 22. Fue esta tarea la que form√≥ la base de todo el algoritmo. Bueno, ahora de las palabras al c√≥digo. No cargar√© completamente todo el c√≥digo; los enlaces al github estar√°n al final del art√≠culo. Solo mostrar√© momentos importantes, desde mi punto de vista. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Entonces, declarando bibliotecas y variables:</font></font><br>
<br>
<pre><code class="hljs apache"><span class="hljs-comment">#include &lt;Bounce2.h&gt;</span>
<span class="hljs-comment">#include &lt;EEPROM.h&gt;</span><font></font>
<font></font>
<span class="hljs-attribute">const</span> byte cnt = <span class="hljs-number">8</span>;
<span class="hljs-attribute">const</span> byte pin_cnt = <span class="hljs-number">19</span>;<font></font>
<font></font>
<span class="hljs-attribute">int</span> pins[] = {<span class="hljs-number">11</span>,<span class="hljs-number">12</span>,<span class="hljs-number">13</span>,<span class="hljs-number">13</span>,<span class="hljs-number">14</span>,<span class="hljs-number">15</span>,<span class="hljs-number">16</span>,<span class="hljs-number">17</span>};
<span class="hljs-attribute">int</span> leds[] = {<span class="hljs-number">6</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>, <span class="hljs-number">3</span>};<font></font>
<font></font>
<span class="hljs-attribute">byte</span> init_leds[cnt] ;
<span class="hljs-attribute">byte</span> init_buttons[cnt];
<span class="hljs-attribute">int</span> button_states[cnt];
<span class="hljs-attribute">Bounce</span> debouncers[cnt];
<span class="hljs-attribute">unsigned</span> long buttonPressTimeStamps[cnt];
<span class="hljs-attribute">boolean</span> changed[cnt];
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El punto es: es suficiente aumentar la constante con el n√∫mero de l√°mparas / interruptores y registrar nuevas asociaciones en las matrices, y eso es todo, se agregar√° una nueva l√°mpara o interruptor. </font><font style="vertical-align: inherit;">Al mismo tiempo, la estructura del c√≥digo permite que un interruptor controle de inmediato varios dispositivos. </font><font style="vertical-align: inherit;">O varios interruptores para controlar inmediatamente una l√°mpara. </font><font style="vertical-align: inherit;">Adem√°s, para cada cambio, se crea su propia instancia del objeto Bounce para anti-rebote. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Todos los arreglos se inicializan en la funci√≥n de configuraci√≥n, y almacenamos el estado de las luminarias en la memoria no vol√°til, de modo que cuando se produce un corte de energ√≠a o un reinicio, todo se enciende igual que antes de la falla.</font></font><br>
<br>
<pre><code class="hljs matlab">  <span class="hljs-keyword">for</span>(byte <span class="hljs-built_in">i</span>=<span class="hljs-number">0</span>; <span class="hljs-built_in">i</span>&lt;cnt; <span class="hljs-built_in">i</span>=<span class="hljs-built_in">i</span>+<span class="hljs-number">1</span>) {<font></font>
    EEPROM.write(pins[<span class="hljs-built_in">i</span>], <span class="hljs-number">10</span>);<font></font>
  }<font></font>
<font></font>
  <span class="hljs-keyword">for</span>(byte <span class="hljs-built_in">i</span>=<span class="hljs-number">0</span>; <span class="hljs-built_in">i</span>&lt;cnt; <span class="hljs-built_in">i</span>=<span class="hljs-built_in">i</span>+<span class="hljs-number">1</span>) {<font></font>
    button_states[<span class="hljs-built_in">i</span>] = <span class="hljs-number">0</span>;<font></font>
    <font></font>
    byte value = EEPROM.read(leds[<span class="hljs-built_in">i</span>]);
    <span class="hljs-keyword">if</span>(value==<span class="hljs-number">11</span>) {<font></font>
      init_leds[<span class="hljs-built_in">i</span>] = LOW ;<font></font>
    }<span class="hljs-keyword">else</span>{<font></font>
      init_leds[<span class="hljs-built_in">i</span>] = HIGH ;<font></font>
    }<font></font>
    init_buttons[<span class="hljs-built_in">i</span>] = HIGH;<font></font>
    buttonPressTimeStamps[<span class="hljs-built_in">i</span>] = <span class="hljs-number">0</span>;<font></font>
    changed[<span class="hljs-built_in">i</span>] = <span class="hljs-built_in">false</span>;<font></font>
<font></font>
    debouncers[<span class="hljs-built_in">i</span>] = Bounce();<font></font>
<font></font>
    pinMode(pins[<span class="hljs-built_in">i</span>], INPUT);<font></font>
    pinMode(leds[<span class="hljs-built_in">i</span>], OUTPUT);<font></font>
    <font></font>
    digitalWrite(pins[<span class="hljs-built_in">i</span>], init_buttons[<span class="hljs-built_in">i</span>]);<font></font>
    digitalWrite(leds[<span class="hljs-built_in">i</span>], init_leds[<span class="hljs-built_in">i</span>]);<font></font>
    <font></font>
    debouncers[<span class="hljs-built_in">i</span>].attach( pins[<span class="hljs-built_in">i</span>] );<font></font>
    debouncers[<span class="hljs-built_in">i</span>].interval(<span class="hljs-number">5</span>);<font></font>
  }<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
No dir√© nada sobre el primer ciclo, volveremos sobre √©l un poco m√°s tarde. </font><font style="vertical-align: inherit;">Y lo m√°s interesante comienza en el cuerpo del ciclo principal.</font></font><br>
<br>
<pre><code class="hljs matlab">void loop(){
  <span class="hljs-keyword">for</span>(byte <span class="hljs-built_in">i</span>=<span class="hljs-number">0</span>; <span class="hljs-built_in">i</span>&lt;cnt; <span class="hljs-built_in">i</span>=<span class="hljs-built_in">i</span>+<span class="hljs-number">1</span>){<font></font>
    byte dvalue = EEPROM.read(pins[<span class="hljs-built_in">i</span>]);
    <span class="hljs-keyword">if</span>(dvalue!=<span class="hljs-number">11</span>) {<font></font>
      changed[<span class="hljs-built_in">i</span>] = debouncers[<span class="hljs-built_in">i</span>].update();<font></font>
      <font></font>
      <span class="hljs-keyword">if</span> ( changed[<span class="hljs-built_in">i</span>] ) {<font></font>
        int value = debouncers[<span class="hljs-built_in">i</span>].read();
        <span class="hljs-keyword">if</span> ( value == HIGH) {<font></font>
         button_states[<span class="hljs-built_in">i</span>] = <span class="hljs-number">0</span>;   <font></font>
        } <span class="hljs-keyword">else</span> {
           <span class="hljs-keyword">if</span> (<span class="hljs-built_in">i</span> &gt; <span class="hljs-number">0</span> and pins[<span class="hljs-built_in">i</span>] == pins[<span class="hljs-built_in">i</span><span class="hljs-number">-1</span>]) {<font></font>
             byte prev_value = EEPROM.read(leds[<span class="hljs-built_in">i</span><span class="hljs-number">-1</span>]);<font></font>
                            <font></font>
             <span class="hljs-keyword">if</span>(prev_value == <span class="hljs-number">11</span>) {<font></font>
               digitalWrite(leds[<span class="hljs-built_in">i</span>], LOW );<font></font>
               EEPROM.write(leds[<span class="hljs-built_in">i</span>], <span class="hljs-number">11</span>);<font></font>
             }<span class="hljs-keyword">else</span>{<font></font>
               digitalWrite(leds[<span class="hljs-built_in">i</span>], HIGH);<font></font>
               EEPROM.write(leds[<span class="hljs-built_in">i</span>], <span class="hljs-number">10</span>);<font></font>
             }<font></font>
           } <span class="hljs-keyword">else</span> {               <font></font>
             byte value = EEPROM.read(leds[<span class="hljs-built_in">i</span>]);
             <span class="hljs-keyword">if</span>(value==<span class="hljs-number">11</span>) {<font></font>
               digitalWrite(leds[<span class="hljs-built_in">i</span>], HIGH );<font></font>
               EEPROM.write(leds[<span class="hljs-built_in">i</span>], <span class="hljs-number">10</span>);<font></font>
             }<span class="hljs-keyword">else</span>{<font></font>
               digitalWrite(leds[<span class="hljs-built_in">i</span>], LOW);<font></font>
               EEPROM.write(leds[<span class="hljs-built_in">i</span>], <span class="hljs-number">11</span>);<font></font>
             }<font></font>
           }<font></font>
                 <font></font>
           button_states[<span class="hljs-built_in">i</span>] = <span class="hljs-number">1</span>;<font></font>
           buttonPressTimeStamps[<span class="hljs-built_in">i</span>] = millis();     <font></font>
        }<font></font>
      }<font></font>
   <font></font>
      <span class="hljs-keyword">if</span> ( button_states[<span class="hljs-built_in">i</span>] == <span class="hljs-number">1</span> ) {
        <span class="hljs-keyword">if</span> ( millis() - buttonPressTimeStamps[<span class="hljs-built_in">i</span>] &gt;= <span class="hljs-number">200</span> ) {<font></font>
            button_states[<span class="hljs-built_in">i</span>] = <span class="hljs-number">2</span>;<font></font>
        }<font></font>
      }<font></font>
    }<font></font>
  }<font></font>
<font></font>
  delay( <span class="hljs-number">10</span> );<font></font>
} <font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Durante las pruebas de las primeras versiones del algoritmo, se observ√≥ que a los ni√±os (y tengo tres de ellos, ni√±os) realmente les gustaba hacer clic en los interruptores. </font><font style="vertical-align: inherit;">Por lo tanto, era necesario poder apagar algunos interruptores para que el controlador no respondiera a ellos. </font><font style="vertical-align: inherit;">La opci√≥n m√°s obvia es simplemente eliminar los pines necesarios del tablero, pero esto es incorrecto y poco interesante. </font><font style="vertical-align: inherit;">Por lo tanto, los indicadores tambi√©n se escriben en la memoria no vol√°til que indica si el conmutador est√° abierto o no. </font><font style="vertical-align: inherit;">Esto se inicializa con este bucle:</font></font><br>
<br>
<pre><code class="hljs matlab">  <span class="hljs-keyword">for</span>(byte <span class="hljs-built_in">i</span>=<span class="hljs-number">0</span>; <span class="hljs-built_in">i</span>&lt;cnt; <span class="hljs-built_in">i</span>=<span class="hljs-built_in">i</span>+<span class="hljs-number">1</span>) {<font></font>
    EEPROM.write(pins[<span class="hljs-built_in">i</span>], <span class="hljs-number">10</span>);<font></font>
  }<font></font>
<font></font>
  ...<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Y comprobado aqu√≠:</font></font><br>
<br>
<pre><code class="hljs lisp">  for(<span class="hljs-name">byte</span> i=0<span class="hljs-comment">; i&lt;cnt; i=i+1){</span>
    byte dvalue = EEPROM.read(<span class="hljs-name">pins</span>[i])<span class="hljs-comment">;</span>
    if(<span class="hljs-name">dvalue!=11</span>) {<font></font>
    ...<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ya en esta etapa, los interruptores locales en las paredes comenzaron a funcionar. Pero una casa inteligente no ser√≠a inteligente sin una interfaz. Como me estoy ocupando del desarrollo web, se decidi√≥ crear una interfaz web. Aqu√≠ es donde los escudos de Ethernet fueron √∫tiles. Desafortunadamente, no pude encontrar las fuentes de las primeras versiones de los programas que usan escudos ethernet para control remoto. Intentar√© buscar copias de seguridad, tal vez est√©n all√≠. Pero el significado era primitivo para la desgracia. Cada controlador tiene su propia direcci√≥n IP. Un servidor web estaba subiendo en el arduino, que analizaba las solicitudes GET y encend√≠a o apagaba la l√°mpara correspondiente seg√∫n el n√∫mero de puerto. Hay muchos ejemplos de este tipo en Internet. Para la interfaz web, se construy√≥ un servidor en la placa base con Intel Atom incorporado, se instal√≥ Ubuntu Server 14.02, se instal√≥ el conjunto LAMP est√°ndar,all√≠ se escribe una interfaz simple. Todas las fuentes tambi√©n estar√°n al final del art√≠culo. Por el momento, se ve as√≠:</font></font><br>
<br>
<img src="https://habrastorage.org/files/7ba/5b2/d4c/7ba5b2d4c95c48f0ac3873cef3c76b23.jpg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como puede ver, una l√°mpara de la cocina est√° encendida y el interruptor responsable est√° bloqueado. La administraci√≥n es mega simple: simplemente haga clic en el elemento deseado y sus cambios de estado.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Y todo ser√≠a genial, si no fuera por un "pero". Los escudos de Ethernet se colgaban constantemente. No, el control local de los interruptores siempre funcion√≥ como un reloj. Pero el control remoto desde la interfaz web se ca√≠a constantemente. Si la gerencia trabaj√≥ por un d√≠a, fue excelente. Pero m√°s a menudo, el escudo colgaba solo unas horas despu√©s del reinicio. Lo que no hice fue tratar de tratar con el perro guardi√°n, pero mis tablas no lo soportaron. Ped√≠ en China y reemplac√© los escudos con otros, en en28j60, mejor√≥, pero a√∫n as√≠ colgaban peri√≥dicamente. Agregu√© un m√≥dulo de rel√© al controlador, llev√© la energ√≠a a las placas arduino a trav√©s de contactos normalmente cerrados, y una de las placas arduino tir√≥ del rel√© con una cierta frecuencia y se cort√≥ la alimentaci√≥n, y luego se restableci√≥; sin embargo, esto tampoco siempre funcion√≥ y parpade√≥ en el momento del reinicio luces encendidas,incluso por un par de segundos, pero no obstante. As√≠ es como se ve√≠a el controlador en este punto:</font></font><br>
<br>
<img src="https://habrastorage.org/files/ab0/71d/eb3/ab071deb30a94677a261c5378a809124.jpg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Y luego se decidi√≥ abandonar por completo los escudos de Ethernet. Empec√© a buscar otras funciones de administraci√≥n remota. Trat√© de conectar arduins directamente al servidor y enviar comandos a trav√©s de Serial.read () / Serial.print (): funcion√≥ en cualquier otro momento, no se logr√≥ la estabilidad porque la placa se reiniciaba cada vez que se acced√≠a desde un script en el servidor Le√≠ mucho sobre tales errores, me di cuenta de que estaba conectado con el DTR, en alg√∫n lugar escribieron que puede inicializar el puerto con otras banderas, dio ejemplos que no funcionaron para m√≠. Despu√©s de un tiempo, me encontr√© con un art√≠culo sobre c√≥mo hacer un adaptador USB-I2C de un programador USBAsp. Decid√≠, ¬øpor qu√© no? Ped√≠ un par de tales programadores a los chinos, y esper√©.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Y hace una semana lleg√≥ mi paquete. </font><font style="vertical-align: inherit;">Un programador se actualiz√≥ con un peque√±o firmware USB i2c y nuevamente me sent√© a reescribir el c√≥digo. </font><font style="vertical-align: inherit;">Aqu√≠ las caracter√≠sticas del protocolo comenzaron a aparecer. </font><font style="vertical-align: inherit;">Por supuesto, el servidor era el maestro, y todas las placas Arduino eran esclavas. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El c√≥digo debe resolver las siguientes tareas: </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 - informar el estado del puerto solicitado; </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 - cambiar el estado del puerto solicitado; </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 - apague o encienda todas las luces. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Y me encontr√© con un problema. </font><font style="vertical-align: inherit;">Puedo usar los comandos est√°ndar del conjunto de herramientas i2c para comunicarme con las placas arduino. </font><font style="vertical-align: inherit;">Este es un equipo</font></font><br>
<br>
<pre><code class="bash hljs">i2cget -y &lt; &gt; &lt;&gt;
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
y</font></font><br>
<br>
<pre><code class="bash hljs">i2cset -y &lt; &gt; &lt;&gt; 0x00 &lt;byte &gt;
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Parece que, a juzgar por el hombre, podr√≠a pasar el valor de la palabra, pero no funcion√≥ para m√≠, o me equivoqu√© en alguna parte. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El problema es que, en primer lugar, si necesito cambiar el estado de un determinado puerto, primero debo pasar el n√∫mero del comando responsable de esta operaci√≥n y luego el n√∫mero del puerto. </font><font style="vertical-align: inherit;">Incluso intent√© hacer esto, enviar 2 comandos y en el c√≥digo para recopilarlos por turno, pero fue feo e irracional. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Problema n√∫mero dos: Arduino no puede responder algo en el momento en que recibe los datos. </font><font style="vertical-align: inherit;">Hay dos m√©todos de la biblioteca Wire: onReceive () cuando se reciben datos del maestro y onRequest () cuando el maestro solicita los datos. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
As√≠ que hice esto: el servidor web tiene 6 comandos:</font></font><br>
<br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">comando "1": obtenga el estado de todas las luces</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">comando "2" - obtiene el estado de bloqueo de todos los interruptores</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">comando "5" - enciende el mundo entero</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">comando "6" - apaga el mundo entero</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
un comando formado de la siguiente manera: un n√∫mero decimal de la siguiente forma &lt;cientos (1 o 2) - cambie la l√°mpara o bloquee el bloqueo&gt; &lt;n√∫mero de puerto (de 0 a 99)&gt;; </font><font style="vertical-align: inherit;">por ejemplo, 105 - conmutador de 5 puertos, 213 - conmutador de 13 puertos de bloqueo. </font><font style="vertical-align: inherit;">Este comando se traduce a hexadecimal y se pasa al arduino, que realiza las transformaciones inversas y comprende lo que hay que hacer. </font></font><br>
 <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Esto es lo que parece en el lado del servidor:</font></font><br>
<br>
<pre><code class="php hljs">  ...
  <span class="hljs-keyword">if</span> ($action == <span class="hljs-number">3</span>)<font></font>
     $val_hex = dechex(intval($port) + <span class="hljs-number">100</span>);
  <span class="hljs-keyword">else</span>
     $val_hex = dechex(intval($port) + <span class="hljs-number">200</span>);<font></font>
  <font></font>
  exec(<span class="hljs-string">"sudo i2cset -y 7 $addr 0x00 0x$val_hex"</span>, $output);<font></font>
  ...<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Y desde el lado de arduino:</font></font><br>
<br>
<pre><code class="hljs cs"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">receiveEvent</span>(<span class="hljs-params"><span class="hljs-keyword">int</span> howMany</span>)</span> {
  <span class="hljs-keyword">byte</span> bytes = Wire.available();
  <span class="hljs-keyword">int</span> x = <span class="hljs-number">0</span>;
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">byte</span> i=<span class="hljs-number">1</span>; i &lt;= bytes; i=i+<span class="hljs-number">1</span>) {<font></font>
    x = Wire.read();<font></font>
  }<font></font>
  <font></font>
  <span class="hljs-keyword">if</span> (x == <span class="hljs-number">1</span> or x == <span class="hljs-number">2</span> or x == <span class="hljs-number">5</span> or x == <span class="hljs-number">6</span>) {<font></font>
    do_action(x, <span class="hljs-number">0</span>);<font></font>
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-keyword">if</span> ( x &gt; <span class="hljs-number">200</span>) {<font></font>
      do_action (<span class="hljs-number">4</span>, x - <span class="hljs-number">200</span>);<font></font>
    } <span class="hljs-keyword">else</span> {<font></font>
      do_action (<span class="hljs-number">3</span>, x - <span class="hljs-number">100</span>);<font></font>
    }<font></font>
  }  <font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Parece bastante primitivo, pero funciona. </font><font style="vertical-align: inherit;">El segundo problema se resuelve de la siguiente manera. </font><font style="vertical-align: inherit;">Aqu√≠ est√° la funci√≥n do_action:</font></font><br>
<br>
<pre><code class="hljs cs"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">do_action</span>(<span class="hljs-params"><span class="hljs-keyword">byte</span> command, <span class="hljs-keyword">byte</span> port</span>)</span> {
  <span class="hljs-keyword">byte</span> <span class="hljs-keyword">value</span> = <span class="hljs-number">0</span>;
  <span class="hljs-keyword">byte</span> dvalue = <span class="hljs-number">0</span>;
  <span class="hljs-keyword">switch</span> (command) {
    <span class="hljs-keyword">case</span> <span class="hljs-number">1</span>:<font></font>
      start_request = <span class="hljs-literal">true</span>;<font></font>
      request_type = <span class="hljs-number">1</span>;<font></font>
      current_port = <span class="hljs-number">0</span>;<font></font>
      <font></font>
      <span class="hljs-keyword">break</span>;
    <span class="hljs-keyword">case</span> <span class="hljs-number">2</span>:<font></font>
      start_request = <span class="hljs-literal">true</span>;<font></font>
      request_type = <span class="hljs-number">2</span>;<font></font>
      current_port = <span class="hljs-number">0</span>;<font></font>
      <font></font>
      <span class="hljs-keyword">break</span>;
    <span class="hljs-keyword">case</span> <span class="hljs-number">3</span>:
      <span class="hljs-keyword">value</span> = EEPROM.read(port);
      <span class="hljs-keyword">if</span>(<span class="hljs-keyword">value</span>==<span class="hljs-number">11</span>) {<font></font>
        digitalWrite(port, HIGH);<font></font>
        EEPROM.write(port, <span class="hljs-number">10</span>);<font></font>
      } <span class="hljs-keyword">else</span> {<font></font>
        digitalWrite(port, LOW);<font></font>
        EEPROM.write(port, <span class="hljs-number">11</span>);<font></font>
      }<font></font>
      <font></font>
      <span class="hljs-keyword">break</span>;
    <span class="hljs-keyword">case</span> <span class="hljs-number">4</span>:<font></font>
      dvalue = EEPROM.read(port);<font></font>
      <span class="hljs-keyword">if</span>(dvalue==<span class="hljs-number">11</span>) {<font></font>
        EEPROM.write(port, <span class="hljs-number">10</span>);<font></font>
      } <span class="hljs-keyword">else</span> {<font></font>
        EEPROM.write(port, <span class="hljs-number">11</span>);<font></font>
      }<font></font>
      <font></font>
      <span class="hljs-keyword">break</span>;
    <span class="hljs-keyword">case</span> <span class="hljs-number">5</span>:
      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">byte</span> i=<span class="hljs-number">0</span>; i&lt;cnt; i = i + <span class="hljs-number">1</span>) {<font></font>
        digitalWrite(leds[i], LOW);<font></font>
        EEPROM.write(leds[i], <span class="hljs-number">11</span>);<font></font>
      }<font></font>
      <font></font>
      <span class="hljs-keyword">break</span>;
    <span class="hljs-keyword">case</span> <span class="hljs-number">6</span>:
      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">byte</span> i=<span class="hljs-number">0</span>; i&lt;cnt; i = i + <span class="hljs-number">1</span>) {<font></font>
        digitalWrite(leds[i], HIGH);<font></font>
        EEPROM.write(leds[i], <span class="hljs-number">10</span>);<font></font>
      }<font></font>
      <font></font>
      <span class="hljs-keyword">break</span>;
    <span class="hljs-keyword">default</span>:<font></font>
      <font></font>
    <span class="hljs-keyword">break</span>;<font></font>
  }<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Con los equipos 3-6, todo est√° claro, pero los equipos 1 o 2 se pueden describir con m√°s detalle. </font><font style="vertical-align: inherit;">El servidor primero env√≠a el comando deseado, y cuando el arduino recibe el comando 1 o 2, las banderas se inicializan:</font></font><br>
<br>
<pre><code class="hljs nginx">  <span class="hljs-attribute">start_request</span> = <span class="hljs-literal">true</span>;
  <span class="hljs-attribute">request_type</span> = <span class="hljs-number">1</span>;
  <span class="hljs-attribute">current_port</span> = <span class="hljs-number">0</span>;
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Y luego el servidor comienza a enviar solicitudes al arduino tantas veces como los puertos que desea sondear. </font><font style="vertical-align: inherit;">En el lado del servidor:</font></font><br>
<br>
<pre><code class="php hljs"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">get_data</span>(<span class="hljs-params">$address, $action, $cnt</span>) </span>{<font></font>
	exec(<span class="hljs-string">"sudo i2cset -y 7 $address 0x00 0x0$action"</span>, $output);<font></font>
	$tmp = @$output[<span class="hljs-number">0</span>];
	<span class="hljs-keyword">while</span> (strpos($tmp,<span class="hljs-string">"rror"</span>)!==<span class="hljs-literal">false</span>) {<font></font>
		exec(<span class="hljs-string">"sudo i2cset -y 7 $address 0x00 0x0$action"</span>, $output);<font></font>
		$tmp = @$output[<span class="hljs-number">0</span>];<font></font>
	}<font></font>
	$str = <span class="hljs-string">""</span>;
	<span class="hljs-keyword">for</span> ($i = <span class="hljs-number">1</span>; $i &lt;= $cnt; $i++) {<font></font>
		exec(<span class="hljs-string">"sudo i2cget -y 7 $address"</span>, $output);<font></font>
		$tmp = @$output[<span class="hljs-number">0</span>];
		<span class="hljs-keyword">while</span> (strpos($tmp,<span class="hljs-string">"rror"</span>)!==<span class="hljs-literal">false</span>) {<font></font>
			exec(<span class="hljs-string">"sudo i2cget -y 7 $address"</span>, $output);<font></font>
			$tmp = @$output[<span class="hljs-number">0</span>];<font></font>
		}<font></font>
		<span class="hljs-keyword">if</span> ($tmp) {
			<span class="hljs-keyword">if</span> (strpos($tmp,<span class="hljs-string">"1"</span>)!==<span class="hljs-literal">false</span>)<font></font>
				$str .= <span class="hljs-string">"1"</span>;
			<span class="hljs-keyword">else</span>
				$str .= <span class="hljs-string">"0"</span>;<font></font>
		}<font></font>
		<span class="hljs-keyword">unset</span>($output);
		<span class="hljs-keyword">unset</span>($tmp);<font></font>
	}<font></font>
			<font></font>
	<span class="hljs-keyword">return</span> $str;<font></font>
}<font></font>
<font></font>
$str = <span class="hljs-keyword">array</span>();<font></font>
$c = <span class="hljs-number">1</span>;
<span class="hljs-keyword">while</span> ($c &lt;= $tryes) {<font></font>
	$tmp = get_data($addr, $action, $cnt);<font></font>
	<font></font>
	<span class="hljs-keyword">if</span> (strlen($tmp) == $cnt)<font></font>
		$str[] = $tmp;<font></font>
	<font></font>
	$c++;<font></font>
}<font></font>
<font></font>
$new_array = array_count_values($str);<font></font>
<font></font>
asort($new_array);<font></font>
<font></font>
$res = <span class="hljs-string">""</span>;<font></font>
$max = <span class="hljs-number">0</span>;
<span class="hljs-keyword">foreach</span> ($new_array <span class="hljs-keyword">AS</span> $key=&gt;$val) {
	<span class="hljs-keyword">if</span> ($val &gt;= $max) {<font></font>
		$res = $key;<font></font>
		$max = $val;<font></font>
	}<font></font>
}<font></font>
<font></font>
<span class="hljs-keyword">return</span> preg_split(<span class="hljs-string">'//'</span>, $res, <span class="hljs-number">-1</span>, PREG_SPLIT_NO_EMPTY);
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En pocas palabras: hacemos varios intentos ($ tryes&gt; 3) para interrogar al arduino, obtenemos una l√≠nea que consta de 0 o 1. En cualquier lugar con cualquier comando miramos la respuesta, si existe la palabra Error, significa que hubo errores durante la transferencia y debe repetir la transferencia. . </font><font style="vertical-align: inherit;">Se hicieron varios intentos para garantizar la exactitud de la cadena transmitida; la matriz se contrae por cadena utilizando el m√©todo array_count_values ‚Äã‚Äã($ str); </font><font style="vertical-align: inherit;">y al final obtenemos una matriz con el n√∫mero de ocurrencias de las mismas l√≠neas, damos la l√≠nea que m√°s recibimos de arduino. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Desde el lado de arduino todo es m√°s simple:</font></font><br>
<br>
<pre><code class="hljs pgsql"><span class="hljs-type">void</span> requestEvent() {
  <span class="hljs-keyword">if</span> (request_type == <span class="hljs-number">1</span>) {<font></font>
    byte <span class="hljs-keyword">value</span> = EEPROM.<span class="hljs-keyword">read</span>(leds[current_port]);
    <span class="hljs-keyword">if</span>(<span class="hljs-keyword">value</span>==<span class="hljs-number">11</span>) {<font></font>
      Wire.<span class="hljs-keyword">write</span>(<span class="hljs-number">1</span>);<font></font>
    } <span class="hljs-keyword">else</span> {<font></font>
      Wire.<span class="hljs-keyword">write</span>(<span class="hljs-number">0</span>);<font></font>
    }<font></font>
    <font></font>
    current_port = current_port + <span class="hljs-number">1</span>;<font></font>
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (request_type == <span class="hljs-number">2</span>) {<font></font>
    byte dvalue = EEPROM.<span class="hljs-keyword">read</span>(pins[current_port]);
    <span class="hljs-keyword">if</span>(dvalue==<span class="hljs-number">11</span>) {<font></font>
      Wire.<span class="hljs-keyword">write</span>(<span class="hljs-number">1</span>);<font></font>
    } <span class="hljs-keyword">else</span> {<font></font>
      Wire.<span class="hljs-keyword">write</span>(<span class="hljs-number">0</span>);<font></font>
    }<font></font>
<font></font>
    current_port = current_port + <span class="hljs-number">1</span>;<font></font>
  }<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El c√≥digo de la p√°gina web contiene los controles:</font></font><br>
<br>
<pre><code class="html hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"lamp living_room"</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"lamp0x4d3"</span> <span class="hljs-attr">rel</span>=<span class="hljs-string">'0x4d'</span> <span class="hljs-attr">onclick</span>=<span class="hljs-string">"lamp_click('0x4d',this.id, 3);"</span> &gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"lamp kitchen"</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"lamp0x4d4"</span> <span class="hljs-attr">rel</span>=<span class="hljs-string">'0x4d'</span> <span class="hljs-attr">onclick</span>=<span class="hljs-string">"lamp_click('0x4d',this.id, 4);"</span> &gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"lamp children_main"</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"lamp0x4d5"</span> <span class="hljs-attr">rel</span>=<span class="hljs-string">'0x4d'</span> <span class="hljs-attr">onclick</span>=<span class="hljs-string">"lamp_click('0x4d',this.id, 5);"</span> &gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"lamp children_second"</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"lamp0x4d6"</span> <span class="hljs-attr">rel</span>=<span class="hljs-string">'0x4d'</span> <span class="hljs-attr">onclick</span>=<span class="hljs-string">"lamp_click('0x4d',this.id, 6);"</span> &gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"lamp sleeproom_main"</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"lamp0x423"</span> <span class="hljs-attr">rel</span>=<span class="hljs-string">'0x42'</span> <span class="hljs-attr">onclick</span>=<span class="hljs-string">"lamp_click('0x42',this.id, 3);"</span> &gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"lamp sleeproom_lyuda"</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"lamp0x424"</span> <span class="hljs-attr">rel</span>=<span class="hljs-string">'0x42'</span> <span class="hljs-attr">onclick</span>=<span class="hljs-string">"lamp_click('0x42',this.id, 4);"</span> &gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"lamp sleeproom_anton"</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"lamp0x425"</span> <span class="hljs-attr">rel</span>=<span class="hljs-string">'0x42'</span> <span class="hljs-attr">onclick</span>=<span class="hljs-string">"lamp_click('0x42',this.id, 5);"</span> &gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span><font></font>
<font></font>
<span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"button button_living_room"</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"button0x4d15"</span> <span class="hljs-attr">onclick</span>=<span class="hljs-string">"button_click('0x4d',this.id, 15);"</span> &gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"button button_kitchen"</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"button0x4d14"</span> <span class="hljs-attr">onclick</span>=<span class="hljs-string">"button_click('0x4d',this.id, 14);"</span> &gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"button button_children_main"</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"button0x4d16"</span> <span class="hljs-attr">onclick</span>=<span class="hljs-string">"button_click('0x4d',this.id, 16);"</span> &gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"button button_children_second"</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"button0x4d17"</span> <span class="hljs-attr">onclick</span>=<span class="hljs-string">"button_click('0x4d',this.id, 17);"</span> &gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"button button_sleeproom_door1"</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"button0x4212"</span> <span class="hljs-attr">onclick</span>=<span class="hljs-string">"button_click('0x42',this.id, 12);"</span> &gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"button button_sleeproom_door2"</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"button0x4213"</span> <span class="hljs-attr">onclick</span>=<span class="hljs-string">"button_click('0x42',this.id, 13);"</span> &gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"button button_sleeproom_lyuda1"</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"button0x4214"</span> <span class="hljs-attr">onclick</span>=<span class="hljs-string">"button_click('0x42',this.id, 14);"</span> &gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"button button_sleeproom_lyuda2"</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"button0x4215"</span> <span class="hljs-attr">onclick</span>=<span class="hljs-string">"button_click('0x42',this.id, 15);"</span> &gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"button button_sleeproom_anton1"</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"button0x4216"</span> <span class="hljs-attr">onclick</span>=<span class="hljs-string">"button_click('0x42',this.id, 16);"</span> &gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"button button_sleeproom_anton2"</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"button0x4217"</span> <span class="hljs-attr">onclick</span>=<span class="hljs-string">"button_click('0x42',this.id, 17);"</span> &gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En realidad, indico expl√≠citamente la direcci√≥n de la placa a la que necesito acceder y el n√∫mero de puerto. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Oh s√≠, el controlador se ve as√≠ ahora:</font></font><br>
<br>
<img src="https://habrastorage.org/files/05d/20e/6f0/05d20e6f0e8747bc940f202e2606fd2a.jpg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Despu√©s de que todo se instal√≥ en su lugar, todo comenz√≥ la primera vez. Y al d√≠a siguiente, surgi√≥ un efecto incomprensible: si enciende todas las luces de la habitaci√≥n, toda la luz de la habitaci√≥n comienza a parpadear cada 2-3 segundos. Pas√© toda la noche eligiendo el c√≥digo; no hab√≠a tal jamba en el banco de pruebas, por lo que el problema no est√° en el c√≥digo. Rebusqu√© en un mont√≥n de foros, en una toga en uno de ellos encontr√© una descripci√≥n de un s√≠ntoma similar, verifiqu√© mi suposici√≥n y el problema desapareci√≥. Y lo que pasaba era que alimentaba a los tres arduins desde una fuente de alimentaci√≥n de computadora, 12V, y el viejo freeduino com√≠a en silencio y no zumbaba, y arduino uno v3 no pod√≠a, y cuando todos los rel√©s estaban encendidos, el regulador de potencia se calentaba para que Era imposible tocarlo. Redujo el voltaje de suministro a 5V 2A, y funcion√≥ como deber√≠a.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Hay muchos planes, tenemos que terminar la reparaci√≥n en el apartamento, el pasillo y el ba√±o con el inodoro est√°n alineados, en mis sue√±os quiero controlar el calentador de agua y cada toma de corriente, ya que ahora puedo colgar cualquier cantidad de arduina en el autob√∫s I2C y cada uno har√° lo suyo. </font><font style="vertical-align: inherit;">Tambi√©n se planea agregar rel√©s de pulso al riel DIN para que los m√≥dulos de rel√© solo controlen estos rel√©s de pulso, y ya toda la carga pasa por este √∫ltimo. </font><font style="vertical-align: inherit;">Porque existen serias dudas sobre la fiabilidad de los m√≥dulos de rel√©s chinos. </font><font style="vertical-align: inherit;">Pero eso es todo en el futuro. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Seg√∫n lo prometido, enlaces a github: </font></font><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">interfaz web</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> incompleta </font></font><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">para arduino</font></font></a></div>
      
    </div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/es386457/">https://habr.com/ru/post/es386457/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../es386443/index.html">La tecnolog√≠a moderna elimina los ronquidos: el sistema no invasivo Nora</a></li>
<li><a href="../es386447/index.html">El servicio Location Magic rastrear√° la posici√≥n de su dispositivo sin GPS</a></li>
<li><a href="../es386449/index.html">$ 29 por instrucciones para construir una mesa de transformador</a></li>
<li><a href="../es386451/index.html">Interacci√≥n √≥ptima con relojes inteligentes: correa SHIFT</a></li>
<li><a href="../es386455/index.html">Se propone un criterio computacional para determinar el planeta.</a></li>
<li><a href="../es386459/index.html">Un viejo amigo es mejor que dos nuevos. Generador de paisaje. Parte 1</a></li>
<li><a href="../es386461/index.html">El sat√©lite Mars Phobos est√° colapsando gradualmente bajo la influencia de las fuerzas de marea</a></li>
<li><a href="../es386463/index.html">Salir de las sombras: c√≥mo surgen nuevos intercambios</a></li>
<li><a href="../es386465/index.html">Escaneo e impresi√≥n 3D en paleontolog√≠a. Continuaci√≥n</a></li>
<li><a href="../es386467/index.html">Blizzard demanda a los desarrolladores de bots por infracci√≥n de derechos de autor</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>