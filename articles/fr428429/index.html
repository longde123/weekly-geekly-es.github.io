<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üëéüèø üï¶ ‚úä GOST R 34.10 signature √©lectronique de documents PDF dans la suite bureautique LibreOffice üóΩ üë®‚Äçüë®‚Äçüë¶‚Äçüë¶ üçÑ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Malgr√© tous les incendies , le moment est venu de remplir notre devoir civique: payer des imp√¥ts. Nous paierons des imp√¥ts via le portail des services...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>GOST R 34.10 signature √©lectronique de documents PDF dans la suite bureautique LibreOffice</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/428429/"><img src="https://habrastorage.org/webt/ds/ly/0g/dsly0gpk3xho5hfte1ksa3pmprg.png" align="left">  Malgr√© tous les <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">incendies</a> , le moment est venu de remplir notre devoir civique: payer des imp√¥ts.  Nous paierons des imp√¥ts via le portail des <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">services d'√âtat</a> .  Nous saisirons le compte personnel du portail des services d'√âtat √† l' <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">aide d'une</a> signature √©lectronique ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">terminologie</a> du portail des services d'√âtat), c'est-√†-dire  avoir en main un certificat obtenu dans un centre de certification accr√©dit√© (CA) et une cl√© priv√©e.  Je les stocke tous les deux sur le <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">jeton PKCS # 11</a> avec le support de la cryptographie russe: <br><a name="habracut"></a><br><img src="https://habrastorage.org/webt/kb/hc/so/kbhcsojl7sh1w4rnu9au8johwje.png"><br><br>  Et donc, ayant rempli mon devoir civique, j'ai d√©cid√© de v√©rifier √† nouveau le fonctionnement de la signature √©lectronique dans la suite bureautique <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=https://www.google.ru/url%3Fsa%3Dt%26rct%3Dj%26q%3D%26esrc%3Ds%26source%3Dweb%26cd%3D1%26cad%3Drja%26uact%3D8%26ved%3D2ahUKEwj4kPyNm7HeAhUE_SoKHU-iA7AQFjAAegQIAxAC%26url%3D">libreoffice</a> . <br><br>  Pourquoi ai-je d√©cid√© de faire √ßa?  Pour acc√©der au portail des services d'√âtat, j'utilise Linux et le navigateur Redfox, qui est un navigateur Mozilla Firefox modifi√© avec le support de la cryptographie russe.  Comme vous le savez, la suite bureautique libreoffice utilise √©galement le magasin NSS comme magasin de certificats. <br><br>  Le navigateur Redfox-52 a √©t√© install√© dans le dossier / usr / local / lib64 / firefox-52. <br><br>  Pour connecter les biblioth√®ques du package NSS (Network Security Services) avec la prise en charge des algorithmes GOST, d√©finissez la valeur de la variable LD_LIBRARY_PATH comme suit: <br><br><pre><code class="bash hljs"><span class="hljs-variable"><span class="hljs-variable">$export</span></span> LD_LIBRARY_PATH=/usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/lib64/firefox-52:<span class="hljs-variable"><span class="hljs-variable">$LD_LIBRARY_PATH</span></span> $</code> </pre> <br>  En tant que magasin de certificats, libreoffice utilise g√©n√©ralement un magasin de certificats de Firefox, le client de messagerie Thunderbird ou le package Seamonkey int√©gr√©.  Rien ne vous emp√™che d'utiliser le magasin de certificats des navigateurs GoogleChrome / Cromium ou de cr√©er votre propre magasin ind√©pendant (Outils-&gt; Options-&gt; S√©curit√©-&gt; Certificat): <br><br><img src="https://habrastorage.org/webt/fu/we/8r/fuwe8rrzfjin4gzvntoag8itdfc.png"><br><br>  Une fois le stockage s√©lectionn√©, les biblioth√®ques sont connect√©es, ex√©cutez libreoffice, cr√©ez un fichier odt et essayez de le signer (Fichier-&gt; Signatures num√©riques-&gt; Signatures num√©riques). <br><br>  Les certificats dans le r√©f√©rentiel Firefox / NSS sont correctement affich√©s et v√©rifi√©s: <br><br><img src="https://habrastorage.org/webt/se/ic/bn/seicbnhqivgte6wakn7kym63lck.png"><br><br>  Cependant, la signature apr√®s avoir s√©lectionn√© le certificat et appuy√© sur le bouton OK n'est pas form√©e: <br><br><img src="https://habrastorage.org/webt/di/l0/id/dil0idhl4l_x4zetlzrdiguxkr8.png"><br><br>  Il semble que libreoffice ne veuille pas comprendre les algorithmes cryptographiques russes, malgr√© le fait que NSS soit utilis√© √† partir du navigateur Redfox, qui comprend les algorithmes GOST, ce qui est confirm√© par une v√©rification r√©ussie du certificat. <br><br>  Nous faisons la deuxi√®me tentative: cette fois, nous allons essayer de signer le fichier PDF.  Pour ce faire, exportez le document pr√©par√© au format PDF.  Pour signer un fichier PDF, vous devez naturellement le t√©l√©charger (Fichier-&gt; Signatures num√©riques-&gt; Signer PDF).  Apr√®s l'avoir t√©l√©charg√©, nous essayons de le signer (Fichier-&gt; Signatures num√©riques-&gt; Signatures num√©riques) (voir ci-dessus, s√©lectionnez le certificat, sp√©cifiez, par exemple, le but de la signature du document): <br><br><img src="https://habrastorage.org/webt/s1/eg/wz/s1egwzum3-s8q8krjgljjl8xjo4.png"><br><br>  Et la signature est form√©e !!!  On voit que la signature, se forme sur la base du certificat "Test 12 512" avec la cl√© GOST R 34.10-2012 512 bits.  La signature est correcte. <br><br>  Quitter libreoffice.  R√©ex√©cutez libreoffice, chargez le fichier pdf sign√©, v√©rifiez les signatures.  Tout va bien.  Afficher les certificats des signataires.  Tout va bien.  Des miracles!  La signature de PDF fonctionne.  Nous mettons la deuxi√®me, la troisi√®me signature ... Tout fonctionne.  Mais quelque chose nous hante.  Nous effectuons un contr√¥le suppl√©mentaire. <br><br>  Ouvrez le fichier PDF sign√© (j'ai utilis√© l'√©diteur int√©gr√© de mc - Midnight Commander - gestionnaire de fichiers de console pour Linux).  Trouvez la signature √©lectronique (/ Type / Sig /): <br><br><img src="https://habrastorage.org/webt/q3/kh/ja/q3khjadn38etedwmwo7jdmiyrhk.png"><br><br>  Comme vous pouvez le voir, la signature est stock√©e sous forme hexad√©cimale symbolique.  Nous le copions et l'enregistrons dans un fichier.  Pour convertir le fichier en binaire (encodage DER), nous utilisons l'utilitaire xxd: <br><br><pre> <code class="bash hljs"><span class="hljs-variable"><span class="hljs-variable">$xxd</span></span> ‚Äìp ‚Äìr &lt;    PDF&gt; &gt; &lt;&gt;.der $</code> </pre> <br>  Le fichier r√©sultant contient une signature au format PKCS # 7 cod√©e DER d√©connect√©e.  Maintenant, cette signature peut √™tre visualis√©e avec n'importe quel asn1-prase, par exemple, avec l'utilitaire openssl.  Mais puisque nous parlons du package NSS, nous utiliserons l' <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">utilitaire</a> derdump ou l' <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">utilitaire pp</a> : <br><br><pre> <code class="bash hljs"><span class="hljs-variable"><span class="hljs-variable">$pp</span></span> ‚Äìt p7 ‚Äìu ‚Äìi pkcs7_detach.p7 PKCS <span class="hljs-comment"><span class="hljs-comment">#7 Content Info: PKCS #7 Signed Data: Version: 1 (0x1) Digest Algorithm List: Digest Algorithm (1): SHA-256 Content Information: PKCS #7 Data: &lt;no content&gt; Certificate List: Certificate (1): Data: Version: 3 (0x2) Serial Number: 4107 (0x100b) Signature Algorithm: GOST R 34.10-2012 signature with GOST R 34.11-2012-512 Issuer: "E=ca_12_512@lissi.ru,OGRN=1234567890123,INN=1234 56789012,CN= 12_512,O= 12_512,L=GnuPG  -2012-512,ST= ,C=RU" Validity: Not Before: Sat Sep 08 07:17:56 2018 Not After : Tue Sep 12 07:17:56 2023 Subject: "C=RU,ST= ,CN=  ,SN=,givenName= ,E=xx@xx.ru,L= ,STREET=,INN=123456789012,SNILS=12345678901" Subject Public Key Info: Public Key Algorithm: GOST R 34.10-2012 512 Public Key: . . . Digest Encryption Algorithm: GOST R 34.10-2012 Key 512 Encrypted Digest: 34:9d:6f:37:e6:60:00:ed:fe:ef:f7:96:db:52:66:e1: 47:4c:5d:da:7f:9f:f3:20:50:ac:73:6c:97:db:f9:8d: 43:9b:8f:40:61:99:d3:4b:17:08:b8:34:e3:1e:92:76: b1:0c:dd:37:01:1e:2a:30:45:68:06:af:3d:33:5e:2f: 71:c8:17:b3:a9:8a:6b:2f:78:9e:e4:b2:00:59:6f:5a: a0:c5:9e:be:1e:4b:ca:d5:64:25:50:1a:6f:f9:55:b8: 3a:cf:37:a0:04:eb:89:b4:6c:39:77:27:92:de:61:c7: b1:d3:a5:2f:ef:66:9b:f5:71:42:77:0a:d2:10:7f:50 $</span></span></code> </pre> <br>  Et puis il est devenu clair que tout n'est pas si bon.  Oui, l'algorithme de chiffrement Digest: GOST R 34.10-2012 Algorithme de signature de la cl√© 512 conform√©ment au certificat s√©lectionn√© pour la signature, mais la signature est g√©n√©r√©e √† partir d'un hachage calcul√© √† l'aide de l'algorithme SHA-256 (algorithme Digest (1): SHA-256).  Et c'est faux du point de vue: le hachage pour GOST R 34.10-2012 Key 512 doit √™tre consid√©r√© selon l'algorithme GOST R 34.11-2012-512. <br><br>  Passons √† l'analyse du code source de libreoffice: le diable n'est pas aussi terrible qu'il est peint.  Dans cet article, nous consid√©rons l'utilisation du package NSS pour g√©n√©rer une signature √©lectronique.  Si quelqu'un pr√©f√®re sur la plate-forme MS Windows, utiliser CryptoAPI (et, par cons√©quent, GOST-CSP), peut, par analogie avec ce mat√©riel, faire la r√©vision correspondante. <br><br>  L'analyse a montr√© que les modifications devront √™tre apport√©es dans seulement deux fichiers: <br>  - <i>~ / libreoffice-5.3.7.2 / vcl / source / gdi / pdfwriter_impl.cxx</i> <br>  - <i>~ / libreoffice-5.3.7.2 / xmlsecurity / source / pdfio / pdfdocument.cxx</i> <br><br>  Ces modifications sont associ√©es √† la s√©lection correcte de la fonction de hachage pour les certificats GOST.  Le choix d'une fonction de hachage sera d√©termin√© en fonction du type de cl√© de certificat.  Le choix d'un algorithme de hachage, par exemple, dans PDFWriter :: Sign (fichier pdfwriter_impl.cxx) ressemblera √† ceci: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> PDFWriter::Sign(PDFSignContext&amp; rContext) { <span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">ifndef</span></span></span><span class="hljs-meta"> _WIN32 </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">/* */</span></span></span><span class="hljs-meta"> SECKEYPublicKey *pubk = NULL; SECOidTag hashAlgTag; HASH_HashType hashType; int hashLen; CERTCertificate *cert = CERT_DecodeCertFromPackage(reinterpret_cast</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;char *&gt;(rContext.m_pDerEncoded), rContext.m_nDerEncoded); if (!cert) { SAL_WARN("vcl.pdfwriter", "CERT_DecodeCertFromPackage failed"); return false; } /*    */ pubk = CERT_ExtractPublicKey(cert); if (pubk == NULL) return NULL; /*   */ switch(pubk-&gt;keyType){ case gost3410Key: hashAlgTag = SEC_OID_GOSTHASH; hashType = HASH_AlgGOSTHASH; hashLen = SHA256_LENGTH; break; case gost3410Key_256: hashAlgTag = SEC_OID_GOST3411_2012_256; hashType = HASH_AlgGOSTHASH_12_256; hashLen = SHA256_LENGTH; break; case gost3410Key_512: hashAlgTag = SEC_OID_GOST3411_2012_512; hashLen = SHA256_LENGTH * 2; hashType = HASH_AlgGOSTHASH_12_512; break; default: hashAlgTag = SEC_OID_SHA256; hashType = HASH_AlgSHA256; hashLen = SHA256_LENGTH; break; } /* */ HashContextScope hc(HASH_Create(hashType)); . . . }</span></span></span></span></code> </pre> <br>  D'autres changements de logique sont similaires √† ceux-ci.  Le correctif du fichier ~ / libreoffice-5.3.7.2 / vcl / source / gdi / pdfwriter_impl.cxx est situ√© <br><br><div class="spoiler">  <b class="spoiler_title">ici:</b> <div class="spoiler_text"><pre> <code class="diff hljs"><span class="hljs-comment"><span class="hljs-comment">--- pdfwriter_impl_ORIG.cxx 2017-10-25 17:25:39.000000000 +0300 +++ pdfwriter_impl.cxx 2018-10-31 19:48:32.078482227 +0300 @@ -6698,6 +6698,9 @@ CERTCertificate *cert, SECItem *digest) { + SECKEYPublicKey *pubk = NULL; + SECOidTag hashAlgTag; + NSSCMSMessage *result = NSS_CMSMessage_Create(nullptr); if (!result) { @@ -6732,8 +6735,31 @@ NSS_CMSMessage_Destroy(result); return nullptr; } - + pubk = CERT_ExtractPublicKey(cert); + if (pubk == NULL) + return NULL; + switch(pubk-&gt;keyType){ + case gost3410Key: + hashAlgTag = SEC_OID_GOSTHASH; +fprintf(stderr, "CreateCMSMessage: gost3410Key Use HASH_AlgGOSTHASH_=%d\n", hashAlgTag); + break; + case gost3410Key_256: + hashAlgTag = SEC_OID_GOST3411_2012_256; +fprintf(stderr, "CreateCMSMessage: gost3410Key_256 Use HASH_AlgGOSTHASH_=%d\n", hashAlgTag); + break; + case gost3410Key_512: + hashAlgTag = SEC_OID_GOST3411_2012_512; +fprintf(stderr, "CreateCMSMessage: gost3410Key_512 Use HASH_AlgGOSTHASH_=%d\n", hashAlgTag); + break; + default: + hashAlgTag = SEC_OID_SHA256; + break; + } +/* *cms_signer = NSS_CMSSignerInfo_Create(result, cert, SEC_OID_SHA256); +*/ + *cms_signer = NSS_CMSSignerInfo_Create(result, cert, hashAlgTag); + if (!*cms_signer) { SAL_WARN("vcl.pdfwriter", "NSS_CMSSignerInfo_Create failed"); @@ -6773,8 +6799,8 @@ NSS_CMSMessage_Destroy(result); return nullptr; } + if (NSS_CMSSignedData_SetDigestValue(*cms_sd, hashAlgTag, digest) != SECSuccess) - if (NSS_CMSSignedData_SetDigestValue(*cms_sd, SEC_OID_SHA256, digest) != SECSuccess) { SAL_WARN("vcl.pdfwriter", "NSS_CMSSignedData_SetDigestValue failed"); NSS_CMSSignedData_Destroy(*cms_sd); @@ -6982,6 +7008,10 @@ bool PDFWriter::Sign(PDFSignContext&amp; rContext) { #ifndef _WIN32 + SECKEYPublicKey *pubk = NULL; + SECOidTag hashAlgTag; + HASH_HashType hashType; + int hashLen; CERTCertificate *cert = CERT_DecodeCertFromPackage(reinterpret_cast&lt;char *&gt;(rContext.m_pDerEncoded), rContext.m_nDerEncoded); @@ -6990,8 +7020,33 @@ SAL_WARN("vcl.pdfwriter", "CERT_DecodeCertFromPackage failed"); return false; } + pubk = CERT_ExtractPublicKey(cert); + if (pubk == NULL) + return NULL; + switch(pubk-&gt;keyType){ + case gost3410Key: + hashAlgTag = SEC_OID_GOSTHASH; + hashType = HASH_AlgGOSTHASH; + hashLen = SHA256_LENGTH; + break; + case gost3410Key_256: + hashAlgTag = SEC_OID_GOST3411_2012_256; + hashType = HASH_AlgGOSTHASH_12_256; + hashLen = SHA256_LENGTH; + break; + case gost3410Key_512: + hashAlgTag = SEC_OID_GOST3411_2012_512; + hashLen = SHA256_LENGTH * 2; + hashType = HASH_AlgGOSTHASH_12_512; + break; + default: + hashAlgTag = SEC_OID_SHA256; + hashType = HASH_AlgSHA256; + hashLen = SHA256_LENGTH; + break; + } + HashContextScope hc(HASH_Create(hashType)); - HashContextScope hc(HASH_Create(HASH_AlgSHA256)); if (!hc.get()) { SAL_WARN("vcl.pdfwriter", "HASH_Create failed"); @@ -7005,15 +7060,18 @@ HASH_Update(hc.get(), static_cast&lt;const unsigned char*&gt;(rContext.m_pByteRange2), rContext.m_nByteRange2); SECItem digest; - unsigned char hash[SHA256_LENGTH]; + unsigned char hash[SHA256_LENGTH * 2]; + digest.data = hash; - HASH_End(hc.get(), digest.data, &amp;digest.len, SHA256_LENGTH); + HASH_End(hc.get(), digest.data, &amp;digest.len, hashLen); + hc.clear(); #ifdef DBG_UTIL { FILE *out = fopen("PDFWRITER.hash.data", "wb"); - fwrite(hash, SHA256_LENGTH, 1, out); + fwrite(hash, hashLen, 1, out); + fclose(out); } #endif @@ -7078,8 +7136,8 @@ fclose(out); } #endif + HashContextScope ts_hc(HASH_Create(hashType)); - HashContextScope ts_hc(HASH_Create(HASH_AlgSHA256)); if (!ts_hc.get()) { SAL_WARN("vcl.pdfwriter", "HASH_Create failed"); @@ -7090,16 +7148,19 @@ HASH_Begin(ts_hc.get()); HASH_Update(ts_hc.get(), ts_cms_signer-&gt;encDigest.data, ts_cms_signer-&gt;encDigest.len); SECItem ts_digest; - unsigned char ts_hash[SHA256_LENGTH]; + unsigned char ts_hash[SHA256_LENGTH * 2]; + ts_digest.type = siBuffer; ts_digest.data = ts_hash; - HASH_End(ts_hc.get(), ts_digest.data, &amp;ts_digest.len, SHA256_LENGTH); + HASH_End(ts_hc.get(), ts_digest.data, &amp;ts_digest.len, hashLen); + ts_hc.clear(); #ifdef DBG_UTIL { FILE *out = fopen("PDFWRITER.ts_hash.data", "wb"); - fwrite(ts_hash, SHA256_LENGTH, 1, out); + fwrite(ts_hash, hashLen, 1, out); + fclose(out); } #endif @@ -7111,7 +7172,8 @@ src.messageImprint.hashAlgorithm.algorithm.data = nullptr; src.messageImprint.hashAlgorithm.parameters.data = nullptr; - SECOID_SetAlgorithmID(nullptr, &amp;src.messageImprint.hashAlgorithm, SEC_OID_SHA256, nullptr); + SECOID_SetAlgorithmID(nullptr, &amp;src.messageImprint.hashAlgorithm, hashAlgTag, nullptr); + src.messageImprint.hashedMessage = ts_digest; src.reqPolicy.type = siBuffer; @@ -7340,11 +7402,13 @@ // Write ESSCertIDv2.hashAlgorithm. aCertID.hashAlgorithm.algorithm.data = nullptr; aCertID.hashAlgorithm.parameters.data = nullptr; - SECOID_SetAlgorithmID(nullptr, &amp;aCertID.hashAlgorithm, SEC_OID_SHA256, nullptr); + SECOID_SetAlgorithmID(nullptr, &amp;aCertID.hashAlgorithm, hashAlgTag, nullptr); + // Write ESSCertIDv2.certHash. SECItem aCertHashItem; - unsigned char aCertHash[SHA256_LENGTH]; - HashContextScope aCertHashContext(HASH_Create(HASH_AlgSHA256)); + unsigned char aCertHash[SHA256_LENGTH*2]; + HashContextScope aCertHashContext(HASH_Create(hashType)); + if (!aCertHashContext.get()) { SAL_WARN("vcl.pdfwriter", "HASH_Create() failed"); @@ -7354,7 +7418,8 @@ HASH_Update(aCertHashContext.get(), reinterpret_cast&lt;const unsigned char *&gt;(rContext.m_pDerEncoded), rContext.m_nDerEncoded); aCertHashItem.type = siBuffer; aCertHashItem.data = aCertHash; - HASH_End(aCertHashContext.get(), aCertHashItem.data, &amp;aCertHashItem.len, SHA256_LENGTH); + HASH_End(aCertHashContext.get(), aCertHashItem.data, &amp;aCertHashItem.len, hashLen); + aCertID.certHash = aCertHashItem; // Write ESSCertIDv2.issuerSerial. IssuerSerial aSerial;</span></span></code> </pre> <br></div></div><br>  Le correctif du fichier ~ / libreoffice-5.3.7.2 / xmlsecurity / source / pdfio / pdfdocument.cxx est situ√© <br><br><div class="spoiler">  <b class="spoiler_title">ici:</b> <div class="spoiler_text"><pre> <code class="diff hljs"><span class="hljs-comment"><span class="hljs-comment">--- pdfdocument_ORIG.cxx 2017-10-25 17:25:39.000000000 +0300 +++ pdfdocument.cxx 2018-10-31 19:49:34.174485641 +0300 @@ -2400,6 +2400,19 @@ case SEC_OID_PKCS1_SHA512_WITH_RSA_ENCRYPTION: eOidTag = SEC_OID_SHA512; break; + case SEC_OID_GOST3410_SIGN_256: + case SEC_OID_GOST3411_2012_256: + eOidTag = SEC_OID_GOST3411_2012_256; + break; + case SEC_OID_GOST3410_SIGN_512: + case SEC_OID_GOST3411_2012_512: + eOidTag = SEC_OID_GOST3411_2012_512; + break; + case SEC_OID_GOST3410_SIGNATURE: + case SEC_OID_GOSTHASH: + eOidTag = SEC_OID_GOSTHASH; + break; + default: break; } @@ -2453,6 +2466,16 @@ case SEC_OID_SHA512: nMaxResultLen = msfilter::SHA512_HASH_LENGTH; break; + case SEC_OID_GOST3411_2012_256: + nMaxResultLen = msfilter::SHA256_HASH_LENGTH; + break; + case SEC_OID_GOST3411_2012_512: + nMaxResultLen = msfilter::SHA512_HASH_LENGTH; + break; + case SEC_OID_GOSTHASH: + nMaxResultLen = msfilter::SHA256_HASH_LENGTH; + break; + default: SAL_WARN("xmlsecurity.pdfio", "PDFDocument::ValidateSignature: unrecognized algorithm"); return false;</span></span></code> </pre> <br></div></div><br>  Apr√®s avoir apport√© les modifications, nous construisons le package libreoffice.  Les modifications apport√©es ont affect√© trois biblioth√®ques (/ usr / lib64 / libreoffice / program): <br><br><ul><li>  <i>libvcllo.so</i> ; </li><li>  <i>libxmlsecurity.so</i> ; </li><li>  <i>libxsec-xmlsec.so</i> </li></ul><br>  Ces trois biblioth√®ques ont √©t√© remplac√©es dans la distribution libreoffice install√©e (/ usr / lib64 / libreoffice / program). <br><br>  Apr√®s cela, la signature et la v√©rification de la signature GOST dans les fichiers PDF se sont d√©roul√©es sans accroc.  Et ici sur l'un des sites on accroche le regard tel extrait: <br><blockquote>  Le Service f√©d√©ral des imp√¥ts dispose d'un excellent <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">service</a> pour obtenir un extrait du Registre d'√âtat unifi√© des entit√©s juridiques pour toute entit√© juridique, et absolument gratuitement.  Un extrait peut √™tre obtenu sous la forme d'un document PDF sign√© par une signature √©lectronique qualifi√©e.  Et un tel extrait peut √™tre envoy√© √† une banque commerciale, une agence gouvernementale, et il ne vous sera pas demand√© sous forme papier.  Dans l'ensemble, tr√®s confortable. </blockquote>  Nous commandons, recevons et v√©rifions: <br><br><img src="https://habrastorage.org/webt/ye/rt/ul/yertuldamhhmiwc6wmveofj1a60.png"><br><br>  Il convient de rappeler que vous ne devez pas oublier d'installer dans le r√©f√©rentiel une cha√Æne de certificats de confiance pour le certificat signataire.  Mais c'est naturel. <br><br>  C'est tout, il y a maintenant la possibilit√© d'utiliser une signature √©lectronique (une ou plusieurs) dans les fichiers PDF.  Il est tr√®s pratique √† la fois lors de la coordination de documents et du stockage de documents. <br><br>  Et si quelqu'un est habitu√© √† travailler avec la signature √©lectronique classique au format PKCS # 7 √† la fois connect√© et d√©connect√©, une version mise √† jour (pour les plates-formes Linux et Windows) du <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">package</a> graphique <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">GUINSSPY</a> a √©t√© <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">pr√©par√©e</a> : <br><br><img src="https://habrastorage.org/webt/qw/rz/h_/qwrzh_squqc7zzcd0qibmoakuyi.png"><br><br>  Le d√©veloppement a √©t√© effectu√© en Python3 et s'il n'y avait aucun probl√®me sur la plate-forme Linux, alors sur MS Windows, je devais transpirer avec les encodages.  En fait, c'√©tait une √©volution distincte et cela n√©cessite un article s√©par√©.  Toutes ces nuances sont visibles dans le code source. <br><br>  √Ä l'aide de cet utilitaire, vous pouvez cr√©er un magasin de certificats pour libreoffice, g√©rer des certificats, signer des fichiers, etc.: <br><br><img src="https://habrastorage.org/webt/3g/ge/zc/3ggezcie8_pq5mbnpnd_jtz9z14.png"><br><br>  L'utilitaire vous permet √©galement de cr√©er une demande de certificat avec la g√©n√©ration d'une paire de cl√©s, qui peut ensuite √™tre transf√©r√©e au centre de certification, et d'installer le certificat re√ßu dans le r√©f√©rentiel: <br><br><img src="https://habrastorage.org/webt/xh/st/fx/xhstfxznuqdaoqk_rhl2llwthdk.png"><br><br>  Et si les fabricants de fourches Linux nationales ont modifi√© divers packages (NSS, Firefox, Thunderbiird, GnuPG / SMIME, SSH, KMail, Kleopatra, LibreOffice, OpenSSL, etc., etc.) pour travailler avec la cryptographie russe, alors vous pouvez Il s'agirait de la substitution des importations dans le domaine de la cryptographie. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr428429/">https://habr.com/ru/post/fr428429/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr428415/index.html">Pr√©sentation du contr√¥leur cloud TP-Link Omada OC200</a></li>
<li><a href="../fr428417/index.html">Apprentissage automatique dans MatLab / Octave: exemples d'algorithmes pris en charge par les formules</a></li>
<li><a href="../fr428419/index.html">Faites glisser et faites glisser dans RecyclerView. Partie 2: glisser-d√©poser des contr√¥leurs, des grilles et des animations personnalis√©es</a></li>
<li><a href="../fr428421/index.html">Syst√®me flexible pour tester et collecter des m√©triques de programme en utilisant la suite de tests LLVM comme exemple</a></li>
<li><a href="../fr428423/index.html">Comment un accord de 34 milliards de dollars entre IBM et Red Hat va changer le march√© informatique: experts et analystes</a></li>
<li><a href="../fr428431/index.html">Plus que des couches concentriques</a></li>
<li><a href="../fr428433/index.html">Avocats testeurs priv√©s</a></li>
<li><a href="../fr428435/index.html">Que lire en PHP en russe?</a></li>
<li><a href="../fr428437/index.html">Portefeuille Apple Qu'est-ce que c'est et comment y int√©grer votre carte</a></li>
<li><a href="../fr428439/index.html">Sans ensemble</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>