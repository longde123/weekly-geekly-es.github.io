<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🚵🏻 🐶 👩🏼‍🏭 Apakah kecepatan penyimpanan cocok untuk etcd? Tanyakan fio 🐏 🚗 😹</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Sebuah cerita pendek tentang fio dan lain-lain 


 Kinerja cluster etcd sangat tergantung pada kinerja penyimpanannya. etcd mengekspor beberapa metrik...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Apakah kecepatan penyimpanan cocok untuk etcd? Tanyakan fio</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/southbridge/blog/450892/"><p><img src="https://habrastorage.org/webt/6g/sf/kx/6gsfkx6hm7bcpebreyfrtw3kpps.jpeg"></p><br><h3 id="korotkaya-istoriya-o-fio-i-etcd">  Sebuah cerita pendek tentang fio dan lain-lain </h3><br><p>  Kinerja cluster <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">etcd</a> sangat tergantung pada kinerja penyimpanannya.  etcd mengekspor beberapa metrik ke <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Prometheus</a> untuk memberikan informasi yang diperlukan tentang kinerja penyimpanan.  Misalnya, metrik wal_fsync_duration_seconds.  <a href="">Dokumentasi untuk etcd mengatakan</a> : agar penyimpanan dianggap cukup cepat, persentil ke-99 dari metrik ini harus kurang dari 10 ms.  Jika Anda berencana untuk menjalankan cluster etcd pada mesin Linux dan ingin mengevaluasi apakah penyimpanan Anda cukup cepat (misalnya, SSD), Anda dapat menggunakan <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">fio</a> , alat yang populer untuk menguji operasi I / O.  Jalankan perintah berikut, di mana data uji adalah direktori di bawah titik pemasangan penyimpanan: </p><br><pre><code class="plaintext hljs">fio --rw=write --ioengine=sync --fdatasync=1 --directory=test-data --size=22m --bs=2300 --name=mytest</code> </pre> <br><p>  Anda hanya perlu melihat hasilnya dan memverifikasi bahwa persentil ke-99 dari durasi <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">fdatasync</a> kurang dari 10 ms.  Jika demikian, Anda memiliki penyimpanan yang cukup cepat.  Berikut adalah contoh hasilnya: </p><br><pre> <code class="plaintext hljs"> sync (usec): min=534, max=15766, avg=1273.08, stdev=1084.70 sync percentiles (usec): | 1.00th=[ 553], 5.00th=[ 578], 10.00th=[ 594], 20.00th=[ 627], | 30.00th=[ 709], 40.00th=[ 750], 50.00th=[ 783], 60.00th=[ 1549], | 70.00th=[ 1729], 80.00th=[ 1991], 90.00th=[ 2180], 95.00th=[ 2278], | 99.00th=[ 2376], 99.50th=[ 9634], 99.90th=[15795], 99.95th=[15795], | 99.99th=[15795]</code> </pre> <a name="habracut"></a><br><p>  <strong>Catatan</strong> </p><br><ul><li>  Kami telah mengonfigurasi opsi --size dan --bs untuk skenario spesifik kami.  Untuk mendapatkan hasil yang bermanfaat dari fio, masukkan nilai Anda.  Di mana mendapatkannya?  Baca <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">cara kami mempelajari cara mengkonfigurasi fio</a> . </li><li>  Selama pengujian, seluruh beban I / O berasal dari fio.  Dalam skenario nyata, kemungkinan permintaan penulisan lainnya akan datang ke repositori, kecuali untuk permintaan yang terkait dengan wal_fsync_duration_seconds.  Beban ekstra akan meningkatkan nilai wal_fsync_duration_seconds.  Jadi jika persentil ke-99 hampir mencapai 10 ms, penyimpanan Anda tidak akan memiliki kecepatan yang cukup. </li><li>  <strong>Ambil versi <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">fio</a> tidak lebih rendah dari 3,5</strong> (yang sebelumnya tidak menunjukkan persentil durasi fdatasync). </li><li>  Di atas hanya cuplikan hasil dari fio. </li></ul><br><h3 id="dlinnaya-istoriya-o-fio-i-etcd">  Sebuah cerita panjang tentang fio dan lain-lain </h3><br><p>  <strong>Apa itu WAL di etcd</strong> </p><br><p>  Database biasanya menggunakan <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">log write-ahead</a> ;  etcd menggunakannya juga.  Di sini kita tidak akan membahas secara rinci log write-ahead (WAL).  Kita hanya perlu tahu bahwa setiap anggota gugus etcd menyimpannya dalam penyimpanan persisten.  etcd menulis setiap operasi pasangan nilai kunci (misalnya memperbarui) ke WAL sebelum menerapkannya ke repositori.  Jika di antara snapshot salah satu anggota penyimpanan crash dan restart, secara lokal dapat memulihkan transaksi dari snapshot terakhir menggunakan konten WAL. </p><br><p>  Ketika klien menambahkan kunci ke penyimpanan pasangan nilai kunci atau memperbarui nilai kunci yang ada, dll akan mencatat operasi ini di WAL, yang merupakan file biasa dalam penyimpanan yang persisten.  Sebelum melanjutkan, etcd HARUS yakin sepenuhnya bahwa menulis ke WAL benar-benar terjadi.  Di Linux, panggilan sistem <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">tulis</a> tunggal tidak cukup untuk ini, karena sebenarnya menulis ke penyimpanan fisik mungkin tertunda.  Sebagai contoh, Linux dapat menyimpan catatan WAL dalam cache di memori kernel untuk beberapa waktu (misalnya, cache halaman).  Dan agar data ditulis secara akurat ke penyimpanan persisten, Anda memerlukan pemanggilan sistem fdatasync setelah menulis, dan etcd hanya menggunakannya (seperti yang Anda lihat sebagai hasil dari <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">strace</a> , di mana 8 adalah deskriptor file WAL): </p><br><pre> <code class="plaintext hljs">21:23:09.894875 lseek(8, 0, SEEK_CUR) = 12808 &lt;0.000012&gt; 21:23:09.894911 write(8, ".\0\0\0\0\0\0\202\10\2\20\361\223\255\266\6\32$\10\0\20\10\30\26\"\34\"\r\n\3fo"..., 2296) = 2296 &lt;0.000130&gt; 21:23:09.895041 fdatasync(8) = 0 &lt;0.008314&gt;</code> </pre> <br><p>  Sayangnya, menulis ke penyimpanan yang persisten tidak langsung berjalan.  Jika panggilan fdatasync lambat, kinerja sistem etcd turun.  <a href="">Dokumentasi untuk etcd mengatakan</a> bahwa repositori dianggap cukup cepat jika dalam persentil ke-99 panggilan fdatasync dibutuhkan kurang dari 10 ms untuk menulis ke file WAL.  Ada metrik lain yang berguna untuk penyimpanan, tetapi dalam posting ini kita hanya berbicara tentang metrik ini. </p><br><h3 id="ocenka-hranilischa-s-pomoschyu-fio">  Nilai penyimpanan dengan fio </h3><br><p>  Jika Anda perlu mengevaluasi apakah repositori Anda cocok untuk etcd, gunakan fio, alat pengujian beban I / O yang sangat populer.  Harus diingat bahwa operasi disk dapat sangat berbeda: sinkron dan asinkron, banyak kelas panggilan sistem, dll. Akibatnya, fio sangat sulit digunakan.  Ini memiliki banyak parameter, dan kombinasi nilai yang berbeda menghasilkan beban kerja I / O yang sama sekali berbeda.  Untuk mendapatkan angka yang memadai untuk etcd, Anda harus memastikan bahwa beban rekaman pengujian dari fio sedekat mungkin dengan beban nyata dari etcd saat menulis file WAL. </p><br><p>  Akibatnya, setidaknya harus membuat beban dalam bentuk serangkaian operasi tulis berurutan ke file, setiap catatan akan terdiri dari panggilan sistem <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">tulis</a> diikuti oleh panggilan sistem fdatasync.  Untuk operasi penulisan berurutan, fio membutuhkan opsi --rw = write.  Agar fio menggunakan panggilan sistem tulis alih-alih <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">menulis</a> saat merekam, ada baiknya menentukan parameter --ioengine = sinkronisasi.  Akhirnya, untuk fdatasync dipanggil setelah setiap entri, Anda perlu menambahkan --fdatasync = 1 parameter.  Dua opsi lain dalam contoh ini (--size dan --bs) adalah skenario khusus.  Di bagian selanjutnya, kami akan menunjukkan kepada Anda cara mengonfigurasinya. </p><br><h3 id="pochemu-imenno-fio-i-kak-my-nauchilis-ego-nastraivat">  Mengapa harus dan bagaimana kami mempelajari cara mengonfigurasinya </h3><br><p>  Dalam posting ini kami menggambarkan kasus sebenarnya.  Kami memiliki kluster <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Kubernetes</a> v1.13, yang kami pantau menggunakan Prometheus.  etcd v3.2.24 di-host pada SSD.  Metrik Etcd menunjukkan latensi terlalu tinggi untuk fdatasync, bahkan ketika cluster tidak melakukan apa pun.  Metriknya aneh, dan kami benar-benar tidak tahu apa artinya.  Cluster terdiri dari mesin virtual, Anda harus memahami apa masalahnya: di SSD fisik atau di lapisan virtualisasi.  Selain itu, kami sering melakukan perubahan pada konfigurasi perangkat keras dan perangkat lunak, dan kami membutuhkan cara untuk mengevaluasi hasilnya.  Kita dapat menjalankan etcd di setiap konfigurasi dan melihat metrik Prometheus, tetapi ini terlalu merepotkan.  Kami mencari cara yang cukup sederhana untuk mengevaluasi konfigurasi tertentu.  Kami ingin memeriksa apakah kami memahami metrik Prometheus dari etcd dengan benar. </p><br><p>  Tetapi untuk ini perlu untuk menyelesaikan dua masalah.  Pertama, seperti apa I / O memuat yang diciptakan etcd saat menulis ke WAL?  Sistem panggilan apa yang digunakan?  Berapa ukuran catatan?  Kedua, jika kita menjawab pertanyaan-pertanyaan ini, bagaimana cara mereproduksi beban kerja yang sama dengan fio?  Jangan lupa bahwa fio adalah alat yang sangat fleksibel dengan banyak pilihan.  Kami memecahkan kedua masalah dengan satu pendekatan - menggunakan perintah <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">lsof</a> dan <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">strace</a> .  lsof menampilkan semua deskriptor file yang digunakan oleh proses dan file terkait.  Dan dengan strace, Anda dapat mempelajari proses yang sudah berjalan atau memulai proses dan mempelajarinya.  strace menampilkan semua panggilan sistem dari proses yang sedang dipelajari (dan proses anaknya).  Yang terakhir ini sangat penting, karena etcd hanya menggunakan pendekatan yang sama. </p><br><p>  Pertama-tama, kami menggunakan strace untuk mempelajari server etcd untuk Kubernet ketika tidak ada beban di cluster.  Kami melihat bahwa hampir semua catatan WAL memiliki ukuran yang sama: 2200-2400 byte.  Oleh karena itu, pada perintah di awal tulisan, kami menetapkan parameter --bs = 2300 (bs berarti ukuran dalam byte untuk setiap entri fio).  Perhatikan bahwa ukuran entri etcd tergantung pada versi etcd, pengiriman, nilai parameter, dll, dan mempengaruhi durasi fdatasync.  Jika Anda memiliki skenario yang sama, periksa proses etcd Anda dengan strace untuk mengetahui angka pastinya. </p><br><p>  Kemudian, untuk mendapatkan ide bagus tentang tindakan dalam sistem file etcd, kami memulainya dengan strace dan dengan opsi -ffttT.  Jadi kami mencoba mempelajari proses anak dan menulis output masing-masing dalam file terpisah, dan juga mendapatkan laporan rinci tentang awal dan durasi setiap panggilan sistem.  Kami menggunakan lsof untuk mengkonfirmasi analisis kami tentang output strace dan melihat deskriptor file mana yang digunakan untuk tujuan apa.  Jadi dengan strace kami mendapat hasil yang ditunjukkan di atas.  Statistik pada waktu sinkronisasi mengkonfirmasi bahwa wal_fsync_duration_seconds eksponen dari etcd sesuai dengan panggilan fdatasync dengan deskriptor file WAL. </p><br><p>  Kami mempelajari dokumentasi fio dan memilih opsi untuk skrip kami sehingga fio akan menghasilkan beban yang mirip dengan etcd.  Kami juga memeriksa panggilan sistem dan durasinya dengan menjalankan fio dari strace, mirip dengan etcd. </p><br><p>  Kami dengan hati-hati memilih nilai parameter --size, yang mewakili seluruh beban I / O dari fio.  Dalam kasus kami, ini adalah jumlah total byte yang ditulis ke penyimpanan.  Ternyata berbanding lurus dengan jumlah panggilan sistem tulis (dan fdatasync).  Untuk nilai bs tertentu, jumlah panggilan ke fdatasync = size / bs.  Karena kami tertarik pada persentil, kami seharusnya memiliki sampel yang cukup untuk keandalan, dan kami menghitung bahwa 10 ^ 4 akan cukup bagi kami (kami mendapatkan 22 mebibytes).  Jika --size lebih kecil, outlier dapat terjadi (misalnya, beberapa panggilan fdatasync bekerja lebih lama dari biasanya dan memengaruhi persentil ke-99). </p><br><h3 id="poprobuyte-sami">  Coba sendiri </h3><br><p>  Kami menunjukkan cara menggunakan fio dan mencari tahu apakah penyimpanan memiliki kecepatan yang cukup untuk kinerja tinggi, dll.  Sekarang Anda dapat mencobanya sendiri, menggunakan, misalnya, mesin virtual dengan penyimpanan SSD di <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">IBM Cloud</a> . </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/id450892/">https://habr.com/ru/post/id450892/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../id450878/index.html">Tangkap aku jika kau bisa</a></li>
<li><a href="../id450880/index.html">Ukur bagian cetakan dari bentuk kompleks? MetraSCAN 3D untuk penyelamatan</a></li>
<li><a href="../id450886/index.html">Latar belakang: bagaimana mobil hidrogen bekerja dan kapan mereka muncul di jalan</a></li>
<li><a href="../id450888/index.html">Swift: Saringan Eratosthenes</a></li>
<li><a href="../id450890/index.html">Google I / O News 2019: Pixel 3a, Android Q, Kotlin, dan lainnya</a></li>
<li><a href="../id450894/index.html">Tentang antena untuk yang terkecil</a></li>
<li><a href="../id450896/index.html">Lab: mengkonfigurasi lvm, raid di linux</a></li>
<li><a href="../id450898/index.html">Pengembangan antarmuka pada banyak layar. Langkah menggunakan AI</a></li>
<li><a href="../id450902/index.html">Ingin karyawan yang loyal - mulailah dengan diri Anda sendiri</a></li>
<li><a href="../id450904/index.html">Praktis penggelaran aplikasi Inti ASP.NET berlabuh ke Heroku</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>