<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üêπ üëØ üêº Um pouco mais sobre multitarefa em microcontroladores üéß üßö üë®üèº‚Äçüíª</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Em um artigo anterior , falamos sobre como, de acordo com o autor, √© poss√≠vel programar as a√ß√µes usuais de um microcontrolador em tempo real, dividind...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Um pouco mais sobre multitarefa em microcontroladores</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/456242/"><p>  Em um <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">artigo</a> anterior <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">,</a> falamos sobre como, de acordo com o autor, √© poss√≠vel programar as a√ß√µes usuais de um microcontrolador em tempo real, dividindo-as em v√°rias tarefas independentes (ou quase independentes) uma da outra. </p><br><p>  Foi escolhido um microcontrolador, com um n√∫cleo de uma fam√≠lia muito difundida de ARM Cortex M. Do familiar a muitos, e n√£o apenas o autor, op√ß√µes com os n√∫meros 0,3,4 e 7, M4 foi escolhido, porque estava √† m√£o. </p><br><p>  As duas considera√ß√µes que nos levaram a embarcar no caminho escorregadio e inst√°vel de "inventar uma bicicleta", como observou alguns leitores com perspic√°cia, eram realmente simples.  A primeira foi que ainda temos que viver e conviver com esses "c√≥rtex".  E a segunda √© tentar n√£o fazer algo universal (ganhando fama e fortuna), mas fazer algo mais estreitamente focado, na esperan√ßa de alcan√ßar efici√™ncia e simplicidade.  Aqueles que √†s vezes fazem algo com as m√£os se lembram facilmente de que, como regra, uma chave de fenda especialmente selecionada √© melhor do que a retirada de um conjunto universal brilhante. </p><a name="habracut"></a><br><p>  Um exemplo de assembler foi dado para mostrar que n√£o s√£o gastos mais que 80 ciclos de clock na comuta√ß√£o.  E na velocidade de clock de 72 megahertz, acontece um pouco mais de 1 microssegundo.  Portanto, um carrapato com 50 microssegundos de tamanho n√£o ser√° t√£o caro.  Apenas 2% da sobrecarga.  Portanto, como um dos personagens favoritos do autor disse, "√© aconselh√°vel sofrer". </p><br><p>  Portanto, temos N tarefas, cada uma com garantia de execu√ß√£o de um peda√ßo (marca T) de tempo e repeti√ß√£o desse segmento o mais tardar ap√≥s (N-1) <em>T, al√©m de um atraso que n√£o excede D. Esse atraso irritante, felizmente , √© limitado pelo tamanho m√°ximo poss√≠vel no tempo, que √© igual √† soma da dura√ß√£o da opera√ß√£o de todas as interrup√ß√µes permitidas.</em>  <em>Em outras palavras, a tarefa que tem as maiores interrup√ß√µes em potencial por um determinado per√≠odo antes do pr√≥ximo tick √© mais azarada.</em>  <em>Por um longo tempo, a tarefa n√£o pode ser adiada.</em>  <em>Ela inevitavelmente receber√° seu intervalo de tempo o mais tardar em</em> microssegundos <em>(N-1)</em> T + D.  Na minha opini√£o, isso √© chamado de dif√≠cil em tempo real. </p><br><p>  As tarefas devem concluir suas tarefas e relatar a implementa√ß√£o.  Para quem devo me reportar?  Aparentemente, algu√©m est√° no comando e, em regra, eles s√£o muito menores que os subordinados (na verdade, o autor tamb√©m encontrou exce√ß√µes quando havia quatro chefes para tr√™s trabalhadores com as duas m√£os esquerdas, dos quais apenas um conhecia e respeitava a palavra " adequa√ß√£o ‚Äù). </p><br><p>  E se "voc√™s s√£o muitos, mas eu sou um", isso significa uma fila.  Muitos v√£o come√ßar a empurrar e tentar escapar.  E algu√©m ter√° que esperar e depois se atrasar e explicar.  Apesar de tudo isso parecer terr√≠vel, isso √© chamado de belo: a luta pelo recurso.  Filas s√£o uma solu√ß√£o bem conhecida para todos.  Eu conhecia muitos que n√£o alimentam p√£o - deixe-me ficar na fila. </p><br><p>  Mas a nossa n√£o pode esperar!  No sentido, tarefas.  Eles s√£o de dif√≠cil tempo real.  Suponha que duas tarefas leiam leituras uma vez a cada segundo, e a terceira deve medir algo a cada 10 milissegundos, coloc√°-lo em uma pilha e reportar ao topo.  E eles lhe dizem: "Diga-me, ainda n√£o terminamos com os chefs". </p><br><p>  Aparentemente, √© preciso recorrer, para dizer o m√≠nimo, a um tempo n√£o muito real (tempo real suave). </p><br><p>  Vamos ter uma tarefa especial que sabe esperar e adora faz√™-lo.  O recurso que ele servir√° ser√° o canal de comunica√ß√£o.  Como voc√™ sabe, voc√™ n√£o vai enfiar tudo de uma vez. <br>  Mas, voc√™ pode descobrir imediatamente qual velocidade o canal deve ter para que nada se perca.  Para fazer isso, voc√™ precisa conhecer o desempenho com o qual todas as nossas tarefas graphomaniacs, pah, funcionam.  Obviamente, voc√™ tamb√©m deve calcular o tamanho do buffer ou buffers dos quais todos os pacotes ser√£o enviados (ou √† direita). </p><br><p>  Se o canal n√£o for um, a ess√™ncia n√£o muda.  Uma tarefa separada √© simplesmente adicionada para cada canal, que √© projetado para aguardar (e, √© claro, esperar e acreditar). </p><br><p>  Algumas palavras sobre o canal de comunica√ß√£o com o operador, ou mais simplesmente, com a pessoa.  Aqui o canal √© bidirecional, mas a dire√ß√£o externa √© mais interessante.  Fa√ßa uma reserva imediatamente, h√° uma circunst√¢ncia que, mesmo com um forte desejo, √© imposs√≠vel excluir.  Isso √© sobrecarga de canal.  Durante o teste, precisamos alcan√ß√°-lo e ter um mecanismo para ver seu in√≠cio.  N√£o discuto, n√£o √© bom enganar, mas um pouco pode ser deixado de fora.  Vaughn, Gerasim, abusou completamente. </p><br><p>  Portanto, assumimos imediatamente que a mensagem para o operador da tarefa pode ser perdida.  E para que uma pessoa saiba disso, n√≥s os contaremos.  Isso determinar√° onde e quantas vezes nosso operador ficou sem nada.  Por fim, voc√™ sempre pode fazer algo no c√≥digo, adicionar c√°lculos ou at√© mesmo anex√°-lo ao circuito el√©trico para corrigir a situa√ß√£o.  Parece que, por enquanto, ser√° mais f√°cil.  Mas, √© claro, isso n√£o √© necess√°rio para aplica√ß√µes militares.  Para ser honesto, perder uma mensagem n√£o parece uma desgra√ßa apenas ao depurar. </p><br><p>  Por exemplo, vamos ter uma interface serial duplex sem reconhecimento em 115200 baud.  Por exemplo, RS422 na configura√ß√£o "economia" dois fios - l√°, dois - de volta.  Sua capacidade √© de aproximadamente 10.000 bytes por segundo.  Vamos considerar o tamanho m√©dio da mensagem para uma pessoa igual a 50 bytes.  Recebemos 200 mensagens por segundo ou uma mensagem em 5 milissegundos.  Se tivermos tr√™s tarefas que desejam comunicar alguma coisa, deixe-as fazer isso a cada 15 milissegundos cada.  Em m√©dia, √© claro.  E, se n√£o for em m√©dia, ser√£o necess√°rios c√°lculos estat√≠sticos s√©rios ou um experimento em larga escala.  Escolha o √∫ltimo.  Afinal, aprendemos a detectar mensagens ausentes e veremos tudo na tela do emulador de terminal. <br>  Portanto, deixe as tr√™s tarefas criarem mensagens individuais.  Deixe as mensagens diferirem em import√¢ncia ou urg√™ncia do conte√∫do e nossas tarefas as colocar√£o no buffer apropriado.  Aloque esses tr√™s buffers de anel para tr√™s n√≠veis de urg√™ncia, como mostra a Figura 1. </p><br><p><img src="https://habrastorage.org/webt/my/7m/uu/my7muue1i6hn5gjv3ugckhxsxzy.jpeg"></p><br><p>  A quarta tarefa seleciona desses buffers uma mensagem de acordo com nosso plano aprovado e tenta entreg√°-la.  Se o envio ainda n√£o for poss√≠vel, a quarta tarefa estima o quanto ele pode dormir e faz isso.  Depois de dormir, ela j√° tem o espa√ßo necess√°rio no buffer do anel para enviar. </p><br><p>  Os buffers de v√°rias urg√™ncias, √© claro, n√£o armazenam as mensagens em si, mas seus endere√ßos (links).  Ao mesmo tempo, as pr√≥prias tarefas n√£o precisam esperar nada.  Ok  N√£o, n√£o mesmo.  Isso n√£o funciona, e aqui est√° o porqu√™.  Cada um desses tr√™s buffers de anel √© um recurso compartilhado.  Imagine que a tarefa 1 estava prestes a colocar um endere√ßo em um buffer intermedi√°rio.  Ela l√™ a palavra, verifica se o local est√° vazio, ou seja, o valor √© zero e (nesse momento ela √© substitu√≠da por outra tarefa 2, que deseja fazer exatamente o mesmo e consegue), a primeira tarefa, retornando, coloca a palavra ali, sobrescrevendo tudo o que conseguiu em segundo.  Aqui est√° um colega pedindo palavras.  Parece que sei o que ele dir√°. <br>  Sim, tudo √© muito simples, voc√™ pode proibir interrup√ß√µes durante o teste e nada de ruim vai acontecer, n√£o √© por muito tempo. <br>  - Verdade, n√£o por muito tempo, mas quantas vezes?  Quanto tempo tiraremos da tarefa?  E qual deles?  Esqueci de avisar, nunca proibimos interrup√ß√µes, nossa seita dura de tempo real nos pro√≠be de fazer isso. <br>  -E se voc√™ n√£o proibir interrup√ß√µes, poder√° solicitar √† nossa chave de tarefa que coloque o endere√ßo da mensagem l√°.  Ele pode fazer isso atomicamente. <br>  - Sim, talvez, mas depois quero perguntar-lhe outra coisa, depois outra.  E por que alcan√ßamos 72 graus para diluir tudo com √°gua?  Desculpe, eu quis dizer 72 ciclos para mudar de contexto. <br>  Vamos tentar facilitar, como na Figura 2. </p><br><p><img src="https://habrastorage.org/webt/oq/u0/mk/oqu0mkfpi0g7l5ralfun_qk2vaw.jpeg"></p><br><p>  Nesse caso, cada tarefa possui seu pr√≥prio buffer ou seu pr√≥prio conjunto de buffers, se voc√™ desejar uma urg√™ncia, pompa e import√¢ncia diferentes.  Pessoalmente, eu, como operador simples, ainda tenho a mesma import√¢ncia para todos. </p><br><p>  Esse esquema n√£o faz voc√™ lutar pelo recurso.  Agora temos uma op√ß√£o muito funcional.  S√≥ n√£o gosto disso.  Mas e se as tarefas √† esquerda na imagem n√£o tiverem nada para enviar?  Seria mais sensato pedir que a tarefa da direita fosse acordada quando o motivo aparecesse e n√£o acordar apenas para definir o alarme novamente.  As tarefas √† esquerda s√£o mais f√°ceis de executar.  Al√©m disso, uma fun√ß√£o que ajuda a acordar um amigo foi mencionada em uma postagem anterior. </p><br><p>  Prevejo uma proposta de racionaliza√ß√£o: ‚ÄúDeixe a interrup√ß√£o da porta serial (UART) envolvida na tarefa 4 que est√° sendo executada agora, haver√° economia.‚Äù  Voc√™ pode fazer isso, mas n√£o acho que seja bom.  Vou tentar esclarecer.  As tarefas √† esquerda, de fato, podem ativar o procedimento de interrup√ß√£o UART, e ele come√ßar√° a funcionar e n√£o ser√° interrompido at√© que fa√ßa tudo.  O procedimento de interrup√ß√£o agora deve fazer tudo o que a tarefa 4 costumava fazer.O tempo gasto para processar a interrup√ß√£o aumentar√°, nem uma √∫nica tarefa poder√° ser ativada at√© que o pr√≥ximo "spool" termine.  E o que dizemos aos nossos camaradas do persistente c√≠rculo em tempo real?  Mas nos disseram que a resposta a qualquer interrup√ß√£o externa deveria ser a mais curta poss√≠vel.  Este √© apenas um bom tom.  Ou, em outras palavras: √© necess√°rio fazer o bem, o mal e sem voc√™ funcionar√°. </p><br><p>  A Figura 3 explica qual √© o processo e quais desafios est√£o localizados. </p><br><p><img src="https://habrastorage.org/webt/hs/jj/_h/hsjj_h0riitsgnqvcutjqrfb9ow.jpeg"></p><br><p>  Agora nos voltamos para a situa√ß√£o, pode-se dizer, um espelho.  √â quando as informa√ß√µes v√™m de fora.  Seja um canal SPI com v√°rios gondoleiros com g√¥ndolas e uma pequena orquestra de cordas amadora.  N√£o, √© muito cedo para pensar em descanso.  Deixe apenas a interface SPI e alguns chips.  Por exemplo, sensor de press√£o atmosf√©rica, aceler√¥metro e mem√≥ria armazenada. </p><br><p>  Devo dizer imediatamente - um exemplo est√∫pido.  N√£o por causa do gondoliero com seu eterno ‚Äúdevo acrescentar, cavalheiro‚Äù.  N√£o, √© est√∫pido, de fato, misturar em uma interface esses dados de entrada de import√¢ncia diferente.  De fato, se voc√™ precisa conhecer a acelera√ß√£o, ent√£o, com certeza, para descobrir rapidamente quando remover o pedal do acelerador, virar as abas ou fechar os olhos, finalmente.  Esta informa√ß√£o √© frequentemente necess√°ria.  Mas a press√£o muda lentamente e ter√° que descer cerca de tr√™s metros, de modo que nas camadas inferiores a vida se torne mais quente. </p><br><p>  Quanto √† mem√≥ria armazenada, e quem geralmente a coloca neste SPI?  Existe um segundo SPI?  E n√£o √© esperado?  Nenhum lugar para ir, algo precisa ser feito.  Redirecione as setas na dire√ß√£o oposta na Figura 2 e comece a pensar. </p><br><p>  A tarefa 4 agora atende ao SPI e acorda apenas por seus sinais.  Sua conex√£o com a tarefa 1, que deseja colocar algo na mem√≥ria armazenada, √© direcionada para o exterior e √© realizada atrav√©s da fila.  Tamb√©m √© necess√°rio fornecer um mecanismo para monitorar o estouro do buffer do anel.  A produ√ß√£o dos valores de acelera√ß√£o e press√£o da tarefa 4 deve fornecer sem a participa√ß√£o de duas tarefas consumidoras.  Voc√™ s√≥ precisa girar e acompanhar.  Agora podemos esbo√ßar uma figura explicativa e escrever uma nota explicativa.  Na Figura 4, esses <br>  as a√ß√µes s√£o mostradas esquematicamente (ou diagrama de blocos). </p><br><p><img src="https://habrastorage.org/webt/qs/1p/n0/qs1pn0mxzu5642c1kwrttvpvhtw.jpeg"></p><br><p>  Verifica√ß√£o de fluxo insuficiente - essas a√ß√µes ajudam a descobrir se o valor da acelera√ß√£o tem tempo para mudar antes de ser lido novamente pela tarefa consumidora.  Essa verifica√ß√£o √© mostrada por uma a√ß√£o separada na Figura 4 apenas para chamar a aten√ß√£o.  De fato, essa etapa ocorre junto com a leitura do valor do aceler√¥metro de acordo com o esquema, conforme mostrado na Figura 5. </p><br><p><img src="https://habrastorage.org/webt/2z/6l/tx/2z6ltxiu6jeuvtizhjjurmodhq8.jpeg"></p><br><p>  Cabe ressaltar que existe um recurso compartilhado, pois o local de armazenamento do resultado tamb√©m √© um indicador de a√ß√µes (sem√°foro).  As corridas s√£o poss√≠veis aqui, falando a linguagem dos circuitos, mas para n√≥s isso n√£o √© uma omiss√£o.  Afinal, entrar na porta de um ve√≠culo apenas na vida pode ser considerado uma fortuna.  Aqui consideraremos com seguran√ßa um atraso. </p><br><p>  O acesso √† mem√≥ria ocorre em partes para limitar o tempo de cada etapa.  Assim, garantiremos uma leitura uniforme dos valores de acelera√ß√£o que mudam rapidamente e, nesse meio tempo, cuidaremos do resto. </p><br><p>  Bem, agora resta encontrar algo adequado com ferro e experimentar como deveria.  Acho que essa ser√° a pr√≥xima hist√≥ria. </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt456242/">https://habr.com/ru/post/pt456242/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt456232/index.html">Guia: Atualizando interfaces com membros padr√£o no C # 8.0</a></li>
<li><a href="../pt456234/index.html">Por que a Cisco n√£o compra o Splunk ou fala sobre como a plataforma Cisco funciona para a ca√ßa de amea√ßas</a></li>
<li><a href="../pt456236/index.html">Peter - Insider Dev Tour: Confer√™ncia Insider para desenvolvedores da Microsoft</a></li>
<li><a href="../pt456238/index.html">Tutorial: Atualizar interfaces com membros da interface padr√£o no C # 8.0</a></li>
<li><a href="../pt456240/index.html">Desenvolvimento de chatbot (laravel + botman)</a></li>
<li><a href="../pt456246/index.html">Elemento zero</a></li>
<li><a href="../pt456248/index.html">Como eu peguei: antes de estilos para um elemento de foco</a></li>
<li><a href="../pt456250/index.html">Localiza√ß√£o de aplicativos e suporte a RTL. Relat√≥rio Yandex.Taxi</a></li>
<li><a href="../pt456256/index.html">Guia de Arquitetura de Aplicativos Android</a></li>
<li><a href="../pt456258/index.html">Livre como um vento e livre como uma tradu√ß√£o de cerveja de "Livre como na liberdade" para o russo sob a licen√ßa GNU FDL 1.3</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>