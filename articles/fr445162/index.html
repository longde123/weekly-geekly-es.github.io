<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>💼 👨🏼‍🎓 👩🏼‍🎨 Terraform Provider Selectel 👩🏾‍🏭 😾 🙇🏻</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Nous avons lancé le fournisseur officiel Terraform pour travailler avec Selectel. Ce produit permet aux utilisateurs d'implémenter pleinement la gesti...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Terraform Provider Selectel</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/selectel/blog/445162/"><img src="https://habrastorage.org/webt/yf/si/pf/yfsipfz7j0lfweuvzxwwqzqr94a.png"><br><br>  Nous avons lancé le fournisseur officiel Terraform pour travailler avec Selectel.  Ce produit permet aux utilisateurs d'implémenter pleinement la gestion des ressources via la méthodologie Infrastructure-as-code. <br><a name="habracut"></a><br>  Actuellement, le fournisseur prend en charge la gestion des ressources du <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="noopener noreferrer">service Virtual Private Cloud</a> (ci-après dénommé VPC).  À l'avenir, nous prévoyons d'y ajouter la gestion des ressources d'autres services fournis par Selectel. <br><br>  Comme vous le savez déjà, le service VPC est basé sur OpenStack.  Cependant, étant donné qu'OpenStack ne fournit pas d'outils natifs pour la maintenance du cloud public, nous avons implémenté la fonctionnalité manquante dans un ensemble d'API supplémentaires qui simplifient la gestion des objets composites complexes et rendent le travail plus pratique.  Une partie des fonctionnalités disponibles dans OpenStack est fermée à une utilisation directe, mais est accessible via <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="noopener noreferrer">notre API</a> . <br><br>  Le fournisseur Selectel Terraform offre désormais la possibilité de gérer les ressources VPC suivantes: <br><br><ul><li>  les projets et leurs quotas; </li><li>  les utilisateurs, leurs rôles et jetons; </li><li>  sous-réseaux publics, y compris interrégionaux et VRRP; </li><li>  licences logicielles. </li></ul><br>  Le fournisseur utilise notre bibliothèque publique Go pour travailler avec l'API VPC.  La bibliothèque et le fournisseur lui-même sont open-source, ils sont en cours de développement sur Github: <br><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="noopener noreferrer">Référentiel de</a> bibliothèques <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="noopener noreferrer">Go-selvpcclient</a> , </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="noopener noreferrer">Référentiel de fournisseurs Selectel de Terraform-provider</a> . </li></ul><br>  Pour gérer d'autres ressources cloud, telles que des machines virtuelles, des disques, des clusters Kubernetes, vous pouvez utiliser le fournisseur OpenStack Terraform.  La documentation officielle des deux fournisseurs est disponible sur les liens suivants: <br><br><ul><li>  Documentation sur les ressources Selectel: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="noopener noreferrer">Selectel</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="noopener noreferrer">fournisseur de Terraform</a> , </li><li>  Documentation des ressources OpenStack: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow noopener noreferrer">OpenStack fournisseur Terraform</a> . </li></ul><br><h2>  Pour commencer </h2><br>  Pour commencer, vous devez installer Terraform (les instructions et les liens vers les packages d'installation se trouvent sur le <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow noopener noreferrer">site officiel</a> ). <br><br>  Pour fonctionner, le fournisseur requiert la clé API Selectel, qui est créée dans <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="noopener noreferrer">le panneau de configuration du compte</a> . <br><br>  Les manifestes pour travailler avec Selectel sont créés à l'aide de Terraform ou à l'aide d'un ensemble d'exemples prêts à l'emploi disponibles dans notre référentiel Github: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="noopener noreferrer">terraform-examples</a> . <br><br>  Le référentiel avec des exemples est divisé en deux répertoires: <br><br><ul><li>  <strong>modules</strong> , contenant de petits modules réutilisables qui prennent un ensemble de paramètres en entrée et gèrent un petit ensemble de ressources; </li><li>  <strong>exemples</strong> , contenant des exemples d'un ensemble complet de modules interconnectés. </li></ul><br>  Après avoir installé Terraform, créé une clé API Selectel et pris connaissance des exemples, nous passons à des exemples pratiques. <br><br><h2>  Exemple de création d'un serveur avec un disque local </h2><br>  Prenons l'exemple de la création d'un projet, d'un utilisateur avec un rôle et d'une machine virtuelle avec un disque local: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="noopener noreferrer">terraform-examples / examples / vpc / server_local_root_disk</a> . <br><br>  Le fichier <strong>vars.tf</strong> décrit tous les paramètres qui seront utilisés lors de l'appel des modules.  Certains d'entre eux ont des valeurs par défaut, par exemple, le serveur sera créé dans la zone <strong>ru-3a</strong> avec la configuration suivante: <br><br><pre><code class="bash hljs">variable <span class="hljs-string"><span class="hljs-string">"server_vcpus"</span></span> { default = 4 } variable <span class="hljs-string"><span class="hljs-string">"server_ram_mb"</span></span> { default = 8192 } variable <span class="hljs-string"><span class="hljs-string">"server_root_disk_gb"</span></span> { default = 8 } variable <span class="hljs-string"><span class="hljs-string">"server_image_name"</span></span> { default = <span class="hljs-string"><span class="hljs-string">"Ubuntu 18.04 LTS 64-bit"</span></span> }</code> </pre> <br>  Dans le fichier <b>main.tf</b> , le fournisseur Selectel est initialisé: <br><br><pre> <code class="bash hljs">provider <span class="hljs-string"><span class="hljs-string">"selectel"</span></span> { token = <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">${var.sel_token}</span></span></span><span class="hljs-string">"</span></span> }</code> </pre><br>  Ce fichier contient également la valeur par défaut de la clé SSH qui sera installée sur le serveur: <br><br><pre> <code class="bash hljs">module <span class="hljs-string"><span class="hljs-string">"server_local_root_disk"</span></span> { ... server_ssh_key = <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">${file("~/.ssh/id_rsa.pub")}</span></span></span><span class="hljs-string">"</span></span> }</code> </pre><br>  Si nécessaire, vous pouvez spécifier une clé publique différente.  Il n'est pas nécessaire de spécifier la clé comme chemin d'accès au fichier; vous pouvez également ajouter une valeur sous forme de chaîne. <br><br>  Plus loin dans ce fichier, les modules <strong>project_with_user</strong> et <strong>server_local_root_disk</strong> sont lancés, qui gèrent les ressources nécessaires. <br><br>  Nous analyserons ces modules plus en détail. <br><br><h3>  Création d'un projet et d'un utilisateur avec un rôle </h3><br>  Le premier module crée un projet et un utilisateur avec un rôle dans ce projet: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="noopener noreferrer">terraform-examples / modules / vpc / project_with_user</a> . <br><br>  L'utilisateur créé pourra se connecter à OpenStack et gérer ses ressources.  Le module est simple et ne gère que trois entités: <br><br><ul><li>  selectel_vpc_project_v2, </li><li>  selectel_vpc_user_v2, </li><li>  selectel_vpc_role_v2. </li></ul><br><h3>  Création d'un serveur virtuel avec un disque local </h3><br>  Le deuxième module gère les objets OpenStack nécessaires à la création d'un serveur avec un disque local. <br><br>  Vous devez prêter attention à certains des arguments qui sont spécifiés dans ce module pour la ressource <strong>openstack_compute_instance_v2</strong> : <br><br><pre> <code class="bash hljs">resource <span class="hljs-string"><span class="hljs-string">"openstack_compute_instance_v2"</span></span> <span class="hljs-string"><span class="hljs-string">"instance_1"</span></span> { ... lifecycle { ignore_changes = [<span class="hljs-string"><span class="hljs-string">"image_id"</span></span>] } vendor_options { ignore_resize_confirmation = <span class="hljs-literal"><span class="hljs-literal">true</span></span> } }</code> </pre><br>  L'argument <strong>ignore_changes vous</strong> permet d'ignorer le changement d'attribut <strong>id</strong> pour l'image utilisée pour créer la machine virtuelle.  Dans le service VPC, la plupart des images publiques sont mises à jour automatiquement une fois par semaine et leur <strong>identifiant</strong> change également.  Cela est dû aux fonctionnalités du composant OpenStack - Glance, dans lequel les images sont considérées comme des entités immuables. <br><br>  Si un serveur ou un disque existant est créé ou modifié, qui utilise l' <strong>ID de l'</strong> image publique comme argument <strong>image_id</strong> , une fois cette image mise à jour, le redémarrage du manifeste Terraform recréera le serveur ou le disque.  L'utilisation de l'argument <strong>ignore_changes</strong> évite cette situation. <br><br>  <em>Remarque: l'argument</em> <strong><em>ignore_changes</em></strong> <em>est apparu dans Terraform il y a longtemps:</em> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="noopener noreferrer">pull # 2525</a> <em>.</em> <br><br>  L'argument <strong>ignore_resize_confirmation est</strong> nécessaire pour redimensionner avec succès le disque local, les cœurs ou la mémoire du serveur.  Ces modifications sont effectuées via le composant OpenStack Nova à l'aide de la demande de <b>redimensionnement</b> .  Par défaut, Nova après une demande de <b>redimensionnement</b> met le serveur dans l'état <b>verify_resize</b> et attend une confirmation supplémentaire de l'utilisateur.  Cependant, ce comportement peut être modifié pour que Nova n'attende pas d'actions supplémentaires de la part de l'utilisateur. <br><br>  L'argument spécifié permet à Terraform de ne pas attendre le statut <b>verify_resize</b> pour le serveur et d'être préparé pour que le serveur soit dans l'état actif après avoir changé ses paramètres.  L'argument est disponible à partir de la version 1.10.0 du fournisseur OpenStack Terraform: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="noopener noreferrer">pull # 422</a> . <br><br><h3>  Création de ressources </h3><br>  Avant de lancer des manifestes, il convient de noter que dans notre exemple, deux fournisseurs différents sont lancés et que le fournisseur OpenStack dépend des ressources du fournisseur Selectel, car il est impossible de gérer les objets lui appartenant sans créer un utilisateur dans le projet.  Malheureusement, pour la même raison, nous ne pouvons pas simplement exécuter la <strong>commande terraform apply</strong> dans notre exemple.  Nous devrons d'abord <strong>postuler</strong> pour le module <strong>project_with_user</strong> et ensuite pour tout le reste. <br><br>  <em>Remarque: ce problème n'a pas encore été résolu dans Terraform, vous pouvez suivre sa discussion sur Github dans les <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="noopener noreferrer">numéros 2430</a> et <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="noopener noreferrer">4149</a> .</em> <br><br>  Pour créer des ressources, nous allons aller dans le <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="noopener noreferrer">répertoire terraform-examples / examples / vpc / server_local_root_disk</a> , son contenu devrait être comme ceci: <br><br><pre> <code class="bash hljs">$ ls README.md main.tf vars.tf</code> </pre><br>  Nous initialisons les modules à l'aide de la commande: <br><br><pre> <code class="bash hljs">$ terraform init</code> </pre><br>  La sortie montre que Terraform télécharge les dernières versions des fournisseurs utilisés et vérifie tous les modules décrits dans l'exemple. <br><br>  Tout d'abord, appliquez le module <strong>project_with_user</strong> .  Dans ce cas, vous devez transférer manuellement les valeurs des variables qui n'ont pas été définies: <br><br><ul><li>  <strong>sel_account</strong> avec votre numéro de compte Selectel; </li><li>  <strong>sel_token</strong> avec votre clé pour l'API Selectel; </li><li>  <strong>mot_de_passe_utilisateur</strong> avec mot de passe pour l'utilisateur OpenStack. </li></ul><br>  Les valeurs des deux premières variables doivent être extraites du <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="noopener noreferrer">panneau de commande</a> . <br><br>  Pour la dernière variable, vous pouvez penser à n'importe quel mot de passe. <br><br>  Pour utiliser le module, il est nécessaire de remplacer les valeurs <strong>SEL_ACCOUNT</strong> , <strong>SEL_TOKEN</strong> et <strong>USER_PASSWORD en</strong> exécutant la commande: <br><br><pre> <code class="bash hljs">$ env \ TF_VAR_sel_account=SEL_ACCOUNT \ TF_VAR_sel_token=SEL_TOKEN \ TF_VAR_user_password=USER_PASSWORD \ terraform apply -target=module.project_with_user</code> </pre><br>  Après avoir exécuté la commande Terraform, il montrera quelles ressources il veut créer et devra être confirmé: <br><br><pre> <code class="bash hljs">Plan: 3 to add, 0 to change, 0 to destroy. Do you want to perform these actions? Terraform will perform the actions described above. Only <span class="hljs-string"><span class="hljs-string">'yes'</span></span> will be accepted to approve. Enter a value: yes</code> </pre><br>  Une fois le projet, l'utilisateur et le rôle créés, vous pouvez commencer à créer les ressources restantes: <br><br><pre> <code class="bash hljs">$ env \ TF_VAR_sel_account=SEL_ACCOUNT \ TF_VAR_sel_token=SEL_TOKEN \ TF_VAR_user_password=USER_PASSWORD \ terraform apply</code> </pre><br>  Lors de la création de ressources, faites attention à la sortie Terraform avec une adresse IP externe à laquelle le serveur créé sera accessible: <br><br><pre> <code class="bash hljs">module.server_local_root_disk.openstack_networking_floatingip_associate_v2.association_1: Creating... floating_ip: <span class="hljs-string"><span class="hljs-string">""</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">"xxxx"</span></span></code> </pre><br>  Vous pouvez travailler avec la machine virtuelle créée via SSH sur l'IP spécifiée. <br><br><h3>  Modification des ressources </h3><br>  En plus de créer des ressources via Terraform, elles peuvent également être modifiées. <br><br>  Par exemple, augmentez le nombre de cœurs et de mémoire pour notre serveur en modifiant les valeurs des <strong>paramètres</strong> <strong>server_vcpus</strong> et <strong>server_ram_mb</strong> dans le <strong>fichier examples / vpc / server_local_root_disk / main.tf</strong> : <br><br><pre> <code class="bash hljs">- server_vcpus = <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">${var.server_vcpus}</span></span></span><span class="hljs-string">"</span></span> - server_ram_mb = <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">${var.server_ram_mb}</span></span></span><span class="hljs-string">"</span></span> + server_vcpus = 8 + server_ram_mb = 10240</code> </pre><br>  Après cela, nous vérifions quelles modifications cela entraînera à l'aide de la commande suivante: <br><br><pre> <code class="bash hljs">$ env \ TF_VAR_sel_account=SEL_ACCOUNT \ TF_VAR_sel_token=SEL_TOKEN \ TF_VAR_user_password=USER_PASSWORD \ terraform plan</code> </pre><br>  En conséquence, Terraform a apporté des modifications aux ressources <strong>openstack_compute_instance_v2</strong> et <strong>openstack_compute_flavor_v2</strong> . <br><br>  <em>Veuillez noter que cela entraînera un redémarrage de la machine virtuelle créée.</em> <br><br>  Pour appliquer la nouvelle configuration de machine virtuelle, utilisez la <strong>commande terraform apply</strong> , que nous avons déjà exécutée précédemment. <br><br>  Tous les objets créés seront affichés dans <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="noopener noreferrer">le panneau de configuration VPC</a> : <br><br><img src="https://habrastorage.org/webt/eq/e5/3a/eqe53anrxqpnpd6qn7hlcrnuxec.png"><br><br>  Dans notre <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="noopener noreferrer">référentiel d'exemples,</a> vous pouvez également voir des manifestes pour créer des machines virtuelles avec des lecteurs réseau. <br><br><h2>  Exemple de cluster Kubernetes </h2><br>  Avant de passer à l'exemple suivant, nous effacerons les ressources précédemment créées.  Pour ce faire, dans la racine du projet <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="noopener noreferrer">terraform-examples / examples / vpc / server_local_root_disk,</a> exécutez la commande pour supprimer les objets OpenStack: <br><br><pre> <code class="bash hljs">$ env \ TF_VAR_sel_account=SEL_ACCOUNT \ TF_VAR_sel_token=SEL_TOKEN \ TF_VAR_user_password=USER_PASSWORD \ terraform destroy -target=module.server_local_root_disk</code> </pre><br>  Ensuite, exécutez la commande Selectel VPC API Object Cleanup: <br><br><pre> <code class="bash hljs">$ env \ TF_VAR_sel_account=SEL_ACCOUNT \ TF_VAR_sel_token=SEL_TOKEN \ TF_VAR_user_password=USER_PASSWORD \ terraform destroy -target=module.project_with_user</code> </pre><br>  Dans les deux cas, vous devrez confirmer la suppression de tous les objets: <br><br><pre> <code class="bash hljs">Do you really want to destroy all resources? Terraform will destroy all your managed infrastructure, as shown above. There is no undo. Only <span class="hljs-string"><span class="hljs-string">'yes'</span></span> will be accepted to confirm. Enter a value: yes</code> </pre><br>  L'exemple suivant se trouve dans le <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="noopener noreferrer">répertoire terraform-examples / examples / vpc / kubernetes_cluster</a> . <br><br>  Cet exemple crée un projet, un utilisateur avec un rôle dans le projet et lève un cluster Kubernetes.  Dans le fichier <strong>vars.tf</strong> , <strong>vous</strong> pouvez voir les valeurs par défaut, telles que le nombre de nœuds, leurs caractéristiques, la version de Kubernetes, etc. <br><br>  Pour créer des ressources, comme dans le premier exemple, la première chose que nous ferons est d'initialiser les modules et de créer les ressources du module <strong>project_with_user</strong> , puis de créer le reste: <br><br><pre> <code class="bash hljs">$ terraform init $ env \ TF_VAR_sel_account=SEL_ACCOUNT \ TF_VAR_sel_token=SEL_TOKEN \ TF_VAR_user_password=USER_PASSWORD \ terraform apply -target=module.project_with_user $ env \ TF_VAR_sel_account=SEL_ACCOUNT \ TF_VAR_sel_token=SEL_TOKEN \ TF_VAR_user_password=USER_PASSWORD \ terraform apply</code> </pre><br>  Nous transmettons la création et la gestion des clusters Kubernetes via le composant OpenStack Magnum.  Vous pouvez en savoir plus sur la façon de travailler avec un cluster dans l'un de nos <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="noopener noreferrer">articles précédents</a> , ainsi que dans <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="noopener noreferrer">la base de connaissances</a> . <br><br>  Pendant la préparation du cluster, des disques, des machines virtuelles seront créés et tous les composants nécessaires seront installés.  La préparation dure environ 4 minutes, moment auquel Terraform affichera les messages du formulaire: <br><br><pre> <code class="bash hljs">module.kubernetes_cluster.openstack_containerinfra_cluster_v1.cluster_1: Still creating... (3m0s elapsed)</code> </pre><br>  Une fois l'installation terminée, Terraform vous informera que le cluster est prêt et affichera son identifiant: <br><br><pre> <code class="bash hljs">module.kubernetes_cluster.openstack_containerinfra_cluster_v1.cluster_1: Creation complete after 4m20s (ID: 3c8...) Apply complete! Resources: 6 added, 0 changed, 0 destroyed.</code> </pre><br>  Pour gérer le cluster Kubernetes créé via l'utilitaire kubectl, <strong>vous</strong> devez obtenir le fichier d'accès au cluster.  Pour ce faire, accédez au projet créé via Terraform dans la liste des projets de votre compte: <br><br><img src="https://habrastorage.org/webt/pp/7y/rt/pp7yrtw_q-79pkx1j6mr5ebbsyi.png"><br><br>  Ensuite, suivez le lien du formulaire <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">xxxxxx.selvpc.ru</a> , qui s'affiche sous le nom du projet: <br><br><img src="https://habrastorage.org/webt/yr/in/wk/yrinwkfne83cenropq9t3szxt6c.png"><br><br>  Utilisez le nom d'utilisateur et le mot de passe créés via Terraform comme informations de connexion.  Si vous n'avez pas modifié <strong>vars.tf</strong> ou <strong>main.tf</strong> pour notre exemple, l'utilisateur aura le nom <strong>tf_user</strong> .  En tant que mot de passe, utilisez la valeur de la variable <strong>TF_VAR_user_password</strong> , qui a été spécifiée lors de l'exécution antérieure de <strong>terraform apply</strong> . <br><br>  Dans le projet, vous devez aller dans l'onglet <strong>Kubernetes</strong> : <br><br><img src="https://habrastorage.org/webt/ft/bp/dj/ftbpdjhjrgxkgzomuxegaujj3wu.png"><br><br>  Voici un cluster créé via Terraform.  Vous pouvez télécharger le fichier pour <strong>kubectl</strong> sur l'onglet «Accès»: <br><br><img src="https://habrastorage.org/webt/y_/pe/ov/y_peovkv0kjznzx95c_vw4wc-4e.png"><br><br>  Le même onglet contient des instructions pour installer <strong>kubectl</strong> et utiliser le <strong>fichier</strong> <strong>config.yaml</strong> téléchargé. <br><br>  Après avoir démarré <strong>kubectl</strong> et défini la variable d'environnement <strong>KUBECONFIG,</strong> vous pouvez utiliser Kubernetes: <br><br><pre> <code class="bash hljs">$ kubectl get pods --all-namespaces NAMESPACE NAME READY STATUS RESTARTS AGE kube-system coredns-9578f5c87-g6bjf 1/1 Running 0 8m kube-system coredns-9578f5c87-rvkgd 1/1 Running 0 6m kube-system heapster-866fcbc879-b6998 1/1 Running 0 8m kube-system kube-dns-autoscaler-689688988f-8cxhf 1/1 Running 0 8m kube-system kubernetes-dashboard-7bdb5d4cd7-jcjq9 1/1 Running 0 8m kube-system monitoring-grafana-84c97bb64d-tc64b 1/1 Running 0 8m kube-system monitoring-influxdb-7c8ccc75c6-dzk5f 1/1 Running 0 8m kube-system node-exporter-tf-cluster-rz6nggvs4va7-minion-0 1/1 Running 0 8m kube-system node-exporter-tf-cluster-rz6nggvs4va7-minion-1 1/1 Running 0 8m kube-system openstack-cloud-controller-manager-8vrmp 1/1 Running 3 8m prometeus-monitoring grafana-76bcb7ffb8-4tm7t 1/1 Running 0 8m prometeus-monitoring prometheus-75cdd77c5c-w29gb 1/1 Running 0 8m</code> </pre><br>  Le nombre de nœuds de cluster est facilement modifié via Terraform. <br>  La valeur suivante est spécifiée dans le fichier <strong>main.tf</strong> : <br><br><pre> <code class="bash hljs">cluster_node_count = <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">${var.cluster_node_count}</span></span></span><span class="hljs-string">"</span></span></code> </pre><br><p>  Cette valeur est remplacée par <strong>vars.tf</strong> : </p><br><br><pre> <code class="bash hljs">variable <span class="hljs-string"><span class="hljs-string">"cluster_node_count"</span></span> { default = 2 }</code> </pre><br>  Vous pouvez soit modifier la valeur par défaut dans <strong>vars.tf</strong> , soit spécifier la valeur requise directement dans <strong>main.tf</strong> : <br><br><pre> <code class="bash hljs">- cluster_node_count = <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">${var.cluster_node_count}</span></span></span><span class="hljs-string">"</span></span> + cluster_node_count = 3</code> </pre><br>  Pour appliquer les modifications, comme dans le cas du premier exemple, utilisez la <strong>commande terraform apply</strong> : <br><br><pre> <code class="bash hljs">$ env \ TF_VAR_sel_account=SEL_ACCOUNT \ TF_VAR_sel_token=SEL_TOKEN \ TF_VAR_user_password=USER_PASSWORD \ terraform apply</code> </pre><br>  Lorsque le nombre de nœuds change, le cluster reste disponible.  Après avoir ajouté un nœud via Terraform, vous pouvez l'utiliser sans configuration supplémentaire: <br><br><pre> <code class="bash hljs">$ kubectl get nodes NAME STATUS ROLES AGE VERSION tf-cluster-rz6nggvs4va7-master-0 Ready,SchedulingDisabled master 8m v1.12.4 tf-cluster-rz6nggvs4va7-minion-0 Ready &lt;none&gt; 8m v1.12.4 tf-cluster-rz6nggvs4va7-minion-1 Ready &lt;none&gt; 8m v1.12.4 tf-cluster-rz6nggvs4va7-minion-2 Ready &lt;none&gt; 3m v1.12.4</code> </pre><br><h2>  Conclusion </h2><br>  Dans cet article, nous avons découvert les méthodes de base pour travailler avec le <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="noopener noreferrer">«cloud privé virtuel»</a> via Terraform.  Nous serons heureux si vous utilisez le fournisseur officiel Terraform Selectel et fournissez des commentaires. <br><br>  Tous les bogues trouvés du fournisseur Terraform Selectel peuvent être signalés via <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="noopener noreferrer">Github Issues</a> . </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr445162/">https://habr.com/ru/post/fr445162/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr445152/index.html">Que peut-on faire d'autre dans la recherche? Rapport Yandex</a></li>
<li><a href="../fr445154/index.html">Événements numériques à Moscou du 25 au 31 mars</a></li>
<li><a href="../fr445156/index.html">Nébuliseur compact Glenmark: une chose utile dans la vie quotidienne</a></li>
<li><a href="../fr445158/index.html">Orientation optimale des pièces et configuration de prise en charge dans l'imprimante 3D</a></li>
<li><a href="../fr445160/index.html">Nous développons un firmware de pédale pour apprendre à jouer de la balalaïka</a></li>
<li><a href="../fr445164/index.html">Performance du site équilibrée. Partie 5: Facilité d'utilisation</a></li>
<li><a href="../fr445166/index.html">Tout ce que vous devez savoir sur la césure automatique CSS</a></li>
<li><a href="../fr445168/index.html">Un CV idéal qui sera accueilli par un recruteur et un employeur</a></li>
<li><a href="../fr445170/index.html">Trois grands mensonges sur JavaScript</a></li>
<li><a href="../fr445172/index.html">Les navigateurs Edge avec Chromium sont apparus sur les services d'hébergement de fichiers</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>