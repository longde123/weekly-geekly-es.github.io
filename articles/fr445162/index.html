<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üíº üë®üèº‚Äçüéì üë©üèº‚Äçüé® Terraform Provider Selectel üë©üèæ‚Äçüè≠ üòæ üôáüèª</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Nous avons lanc√© le fournisseur officiel Terraform pour travailler avec Selectel. Ce produit permet aux utilisateurs d'impl√©menter pleinement la gesti...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Terraform Provider Selectel</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/selectel/blog/445162/"><img src="https://habrastorage.org/webt/yf/si/pf/yfsipfz7j0lfweuvzxwwqzqr94a.png"><br><br>  Nous avons lanc√© le fournisseur officiel Terraform pour travailler avec Selectel.  Ce produit permet aux utilisateurs d'impl√©menter pleinement la gestion des ressources via la m√©thodologie Infrastructure-as-code. <br><a name="habracut"></a><br>  Actuellement, le fournisseur prend en charge la gestion des ressources du <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="noopener noreferrer">service Virtual Private Cloud</a> (ci-apr√®s d√©nomm√© VPC).  √Ä l'avenir, nous pr√©voyons d'y ajouter la gestion des ressources d'autres services fournis par Selectel. <br><br>  Comme vous le savez d√©j√†, le service VPC est bas√© sur OpenStack.  Cependant, √©tant donn√© qu'OpenStack ne fournit pas d'outils natifs pour la maintenance du cloud public, nous avons impl√©ment√© la fonctionnalit√© manquante dans un ensemble d'API suppl√©mentaires qui simplifient la gestion des objets composites complexes et rendent le travail plus pratique.  Une partie des fonctionnalit√©s disponibles dans OpenStack est ferm√©e √† une utilisation directe, mais est accessible via <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="noopener noreferrer">notre API</a> . <br><br>  Le fournisseur Selectel Terraform offre d√©sormais la possibilit√© de g√©rer les ressources VPC suivantes: <br><br><ul><li>  les projets et leurs quotas; </li><li>  les utilisateurs, leurs r√¥les et jetons; </li><li>  sous-r√©seaux publics, y compris interr√©gionaux et VRRP; </li><li>  licences logicielles. </li></ul><br>  Le fournisseur utilise notre biblioth√®que publique Go pour travailler avec l'API VPC.  La biblioth√®que et le fournisseur lui-m√™me sont open-source, ils sont en cours de d√©veloppement sur Github: <br><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="noopener noreferrer">R√©f√©rentiel de</a> biblioth√®ques <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="noopener noreferrer">Go-selvpcclient</a> , </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="noopener noreferrer">R√©f√©rentiel de fournisseurs Selectel de Terraform-provider</a> . </li></ul><br>  Pour g√©rer d'autres ressources cloud, telles que des machines virtuelles, des disques, des clusters Kubernetes, vous pouvez utiliser le fournisseur OpenStack Terraform.  La documentation officielle des deux fournisseurs est disponible sur les liens suivants: <br><br><ul><li>  Documentation sur les ressources Selectel: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="noopener noreferrer">Selectel</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="noopener noreferrer">fournisseur de Terraform</a> , </li><li>  Documentation des ressources OpenStack: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow noopener noreferrer">OpenStack fournisseur Terraform</a> . </li></ul><br><h2>  Pour commencer </h2><br>  Pour commencer, vous devez installer Terraform (les instructions et les liens vers les packages d'installation se trouvent sur le <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow noopener noreferrer">site officiel</a> ). <br><br>  Pour fonctionner, le fournisseur requiert la cl√© API Selectel, qui est cr√©√©e dans <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="noopener noreferrer">le panneau de configuration du compte</a> . <br><br>  Les manifestes pour travailler avec Selectel sont cr√©√©s √† l'aide de Terraform ou √† l'aide d'un ensemble d'exemples pr√™ts √† l'emploi disponibles dans notre r√©f√©rentiel Github: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="noopener noreferrer">terraform-examples</a> . <br><br>  Le r√©f√©rentiel avec des exemples est divis√© en deux r√©pertoires: <br><br><ul><li>  <strong>modules</strong> , contenant de petits modules r√©utilisables qui prennent un ensemble de param√®tres en entr√©e et g√®rent un petit ensemble de ressources; </li><li>  <strong>exemples</strong> , contenant des exemples d'un ensemble complet de modules interconnect√©s. </li></ul><br>  Apr√®s avoir install√© Terraform, cr√©√© une cl√© API Selectel et pris connaissance des exemples, nous passons √† des exemples pratiques. <br><br><h2>  Exemple de cr√©ation d'un serveur avec un disque local </h2><br>  Prenons l'exemple de la cr√©ation d'un projet, d'un utilisateur avec un r√¥le et d'une machine virtuelle avec un disque local: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="noopener noreferrer">terraform-examples / examples / vpc / server_local_root_disk</a> . <br><br>  Le fichier <strong>vars.tf</strong> d√©crit tous les param√®tres qui seront utilis√©s lors de l'appel des modules.  Certains d'entre eux ont des valeurs par d√©faut, par exemple, le serveur sera cr√©√© dans la zone <strong>ru-3a</strong> avec la configuration suivante: <br><br><pre><code class="bash hljs">variable <span class="hljs-string"><span class="hljs-string">"server_vcpus"</span></span> { default = 4 } variable <span class="hljs-string"><span class="hljs-string">"server_ram_mb"</span></span> { default = 8192 } variable <span class="hljs-string"><span class="hljs-string">"server_root_disk_gb"</span></span> { default = 8 } variable <span class="hljs-string"><span class="hljs-string">"server_image_name"</span></span> { default = <span class="hljs-string"><span class="hljs-string">"Ubuntu 18.04 LTS 64-bit"</span></span> }</code> </pre> <br>  Dans le fichier <b>main.tf</b> , le fournisseur Selectel est initialis√©: <br><br><pre> <code class="bash hljs">provider <span class="hljs-string"><span class="hljs-string">"selectel"</span></span> { token = <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">${var.sel_token}</span></span></span><span class="hljs-string">"</span></span> }</code> </pre><br>  Ce fichier contient √©galement la valeur par d√©faut de la cl√© SSH qui sera install√©e sur le serveur: <br><br><pre> <code class="bash hljs">module <span class="hljs-string"><span class="hljs-string">"server_local_root_disk"</span></span> { ... server_ssh_key = <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">${file("~/.ssh/id_rsa.pub")}</span></span></span><span class="hljs-string">"</span></span> }</code> </pre><br>  Si n√©cessaire, vous pouvez sp√©cifier une cl√© publique diff√©rente.  Il n'est pas n√©cessaire de sp√©cifier la cl√© comme chemin d'acc√®s au fichier; vous pouvez √©galement ajouter une valeur sous forme de cha√Æne. <br><br>  Plus loin dans ce fichier, les modules <strong>project_with_user</strong> et <strong>server_local_root_disk</strong> sont lanc√©s, qui g√®rent les ressources n√©cessaires. <br><br>  Nous analyserons ces modules plus en d√©tail. <br><br><h3>  Cr√©ation d'un projet et d'un utilisateur avec un r√¥le </h3><br>  Le premier module cr√©e un projet et un utilisateur avec un r√¥le dans ce projet: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="noopener noreferrer">terraform-examples / modules / vpc / project_with_user</a> . <br><br>  L'utilisateur cr√©√© pourra se connecter √† OpenStack et g√©rer ses ressources.  Le module est simple et ne g√®re que trois entit√©s: <br><br><ul><li>  selectel_vpc_project_v2, </li><li>  selectel_vpc_user_v2, </li><li>  selectel_vpc_role_v2. </li></ul><br><h3>  Cr√©ation d'un serveur virtuel avec un disque local </h3><br>  Le deuxi√®me module g√®re les objets OpenStack n√©cessaires √† la cr√©ation d'un serveur avec un disque local. <br><br>  Vous devez pr√™ter attention √† certains des arguments qui sont sp√©cifi√©s dans ce module pour la ressource <strong>openstack_compute_instance_v2</strong> : <br><br><pre> <code class="bash hljs">resource <span class="hljs-string"><span class="hljs-string">"openstack_compute_instance_v2"</span></span> <span class="hljs-string"><span class="hljs-string">"instance_1"</span></span> { ... lifecycle { ignore_changes = [<span class="hljs-string"><span class="hljs-string">"image_id"</span></span>] } vendor_options { ignore_resize_confirmation = <span class="hljs-literal"><span class="hljs-literal">true</span></span> } }</code> </pre><br>  L'argument <strong>ignore_changes vous</strong> permet d'ignorer le changement d'attribut <strong>id</strong> pour l'image utilis√©e pour cr√©er la machine virtuelle.  Dans le service VPC, la plupart des images publiques sont mises √† jour automatiquement une fois par semaine et leur <strong>identifiant</strong> change √©galement.  Cela est d√ª aux fonctionnalit√©s du composant OpenStack - Glance, dans lequel les images sont consid√©r√©es comme des entit√©s immuables. <br><br>  Si un serveur ou un disque existant est cr√©√© ou modifi√©, qui utilise l' <strong>ID de l'</strong> image publique comme argument <strong>image_id</strong> , une fois cette image mise √† jour, le red√©marrage du manifeste Terraform recr√©era le serveur ou le disque.  L'utilisation de l'argument <strong>ignore_changes</strong> √©vite cette situation. <br><br>  <em>Remarque: l'argument</em> <strong><em>ignore_changes</em></strong> <em>est apparu dans Terraform il y a longtemps:</em> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="noopener noreferrer">pull # 2525</a> <em>.</em> <br><br>  L'argument <strong>ignore_resize_confirmation est</strong> n√©cessaire pour redimensionner avec succ√®s le disque local, les c≈ìurs ou la m√©moire du serveur.  Ces modifications sont effectu√©es via le composant OpenStack Nova √† l'aide de la demande de <b>redimensionnement</b> .  Par d√©faut, Nova apr√®s une demande de <b>redimensionnement</b> met le serveur dans l'√©tat <b>verify_resize</b> et attend une confirmation suppl√©mentaire de l'utilisateur.  Cependant, ce comportement peut √™tre modifi√© pour que Nova n'attende pas d'actions suppl√©mentaires de la part de l'utilisateur. <br><br>  L'argument sp√©cifi√© permet √† Terraform de ne pas attendre le statut <b>verify_resize</b> pour le serveur et d'√™tre pr√©par√© pour que le serveur soit dans l'√©tat actif apr√®s avoir chang√© ses param√®tres.  L'argument est disponible √† partir de la version 1.10.0 du fournisseur OpenStack Terraform: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="noopener noreferrer">pull # 422</a> . <br><br><h3>  Cr√©ation de ressources </h3><br>  Avant de lancer des manifestes, il convient de noter que dans notre exemple, deux fournisseurs diff√©rents sont lanc√©s et que le fournisseur OpenStack d√©pend des ressources du fournisseur Selectel, car il est impossible de g√©rer les objets lui appartenant sans cr√©er un utilisateur dans le projet.  Malheureusement, pour la m√™me raison, nous ne pouvons pas simplement ex√©cuter la <strong>commande terraform apply</strong> dans notre exemple.  Nous devrons d'abord <strong>postuler</strong> pour le module <strong>project_with_user</strong> et ensuite pour tout le reste. <br><br>  <em>Remarque: ce probl√®me n'a pas encore √©t√© r√©solu dans Terraform, vous pouvez suivre sa discussion sur Github dans les <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="noopener noreferrer">num√©ros 2430</a> et <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="noopener noreferrer">4149</a> .</em> <br><br>  Pour cr√©er des ressources, nous allons aller dans le <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="noopener noreferrer">r√©pertoire terraform-examples / examples / vpc / server_local_root_disk</a> , son contenu devrait √™tre comme ceci: <br><br><pre> <code class="bash hljs">$ ls README.md main.tf vars.tf</code> </pre><br>  Nous initialisons les modules √† l'aide de la commande: <br><br><pre> <code class="bash hljs">$ terraform init</code> </pre><br>  La sortie montre que Terraform t√©l√©charge les derni√®res versions des fournisseurs utilis√©s et v√©rifie tous les modules d√©crits dans l'exemple. <br><br>  Tout d'abord, appliquez le module <strong>project_with_user</strong> .  Dans ce cas, vous devez transf√©rer manuellement les valeurs des variables qui n'ont pas √©t√© d√©finies: <br><br><ul><li>  <strong>sel_account</strong> avec votre num√©ro de compte Selectel; </li><li>  <strong>sel_token</strong> avec votre cl√© pour l'API Selectel; </li><li>  <strong>mot_de_passe_utilisateur</strong> avec mot de passe pour l'utilisateur OpenStack. </li></ul><br>  Les valeurs des deux premi√®res variables doivent √™tre extraites du <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="noopener noreferrer">panneau de commande</a> . <br><br>  Pour la derni√®re variable, vous pouvez penser √† n'importe quel mot de passe. <br><br>  Pour utiliser le module, il est n√©cessaire de remplacer les valeurs <strong>SEL_ACCOUNT</strong> , <strong>SEL_TOKEN</strong> et <strong>USER_PASSWORD en</strong> ex√©cutant la commande: <br><br><pre> <code class="bash hljs">$ env \ TF_VAR_sel_account=SEL_ACCOUNT \ TF_VAR_sel_token=SEL_TOKEN \ TF_VAR_user_password=USER_PASSWORD \ terraform apply -target=module.project_with_user</code> </pre><br>  Apr√®s avoir ex√©cut√© la commande Terraform, il montrera quelles ressources il veut cr√©er et devra √™tre confirm√©: <br><br><pre> <code class="bash hljs">Plan: 3 to add, 0 to change, 0 to destroy. Do you want to perform these actions? Terraform will perform the actions described above. Only <span class="hljs-string"><span class="hljs-string">'yes'</span></span> will be accepted to approve. Enter a value: yes</code> </pre><br>  Une fois le projet, l'utilisateur et le r√¥le cr√©√©s, vous pouvez commencer √† cr√©er les ressources restantes: <br><br><pre> <code class="bash hljs">$ env \ TF_VAR_sel_account=SEL_ACCOUNT \ TF_VAR_sel_token=SEL_TOKEN \ TF_VAR_user_password=USER_PASSWORD \ terraform apply</code> </pre><br>  Lors de la cr√©ation de ressources, faites attention √† la sortie Terraform avec une adresse IP externe √† laquelle le serveur cr√©√© sera accessible: <br><br><pre> <code class="bash hljs">module.server_local_root_disk.openstack_networking_floatingip_associate_v2.association_1: Creating... floating_ip: <span class="hljs-string"><span class="hljs-string">""</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">"xxxx"</span></span></code> </pre><br>  Vous pouvez travailler avec la machine virtuelle cr√©√©e via SSH sur l'IP sp√©cifi√©e. <br><br><h3>  Modification des ressources </h3><br>  En plus de cr√©er des ressources via Terraform, elles peuvent √©galement √™tre modifi√©es. <br><br>  Par exemple, augmentez le nombre de c≈ìurs et de m√©moire pour notre serveur en modifiant les valeurs des <strong>param√®tres</strong> <strong>server_vcpus</strong> et <strong>server_ram_mb</strong> dans le <strong>fichier examples / vpc / server_local_root_disk / main.tf</strong> : <br><br><pre> <code class="bash hljs">- server_vcpus = <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">${var.server_vcpus}</span></span></span><span class="hljs-string">"</span></span> - server_ram_mb = <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">${var.server_ram_mb}</span></span></span><span class="hljs-string">"</span></span> + server_vcpus = 8 + server_ram_mb = 10240</code> </pre><br>  Apr√®s cela, nous v√©rifions quelles modifications cela entra√Ænera √† l'aide de la commande suivante: <br><br><pre> <code class="bash hljs">$ env \ TF_VAR_sel_account=SEL_ACCOUNT \ TF_VAR_sel_token=SEL_TOKEN \ TF_VAR_user_password=USER_PASSWORD \ terraform plan</code> </pre><br>  En cons√©quence, Terraform a apport√© des modifications aux ressources <strong>openstack_compute_instance_v2</strong> et <strong>openstack_compute_flavor_v2</strong> . <br><br>  <em>Veuillez noter que cela entra√Ænera un red√©marrage de la machine virtuelle cr√©√©e.</em> <br><br>  Pour appliquer la nouvelle configuration de machine virtuelle, utilisez la <strong>commande terraform apply</strong> , que nous avons d√©j√† ex√©cut√©e pr√©c√©demment. <br><br>  Tous les objets cr√©√©s seront affich√©s dans <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="noopener noreferrer">le panneau de configuration VPC</a> : <br><br><img src="https://habrastorage.org/webt/eq/e5/3a/eqe53anrxqpnpd6qn7hlcrnuxec.png"><br><br>  Dans notre <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="noopener noreferrer">r√©f√©rentiel d'exemples,</a> vous pouvez √©galement voir des manifestes pour cr√©er des machines virtuelles avec des lecteurs r√©seau. <br><br><h2>  Exemple de cluster Kubernetes </h2><br>  Avant de passer √† l'exemple suivant, nous effacerons les ressources pr√©c√©demment cr√©√©es.  Pour ce faire, dans la racine du projet <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="noopener noreferrer">terraform-examples / examples / vpc / server_local_root_disk,</a> ex√©cutez la commande pour supprimer les objets OpenStack: <br><br><pre> <code class="bash hljs">$ env \ TF_VAR_sel_account=SEL_ACCOUNT \ TF_VAR_sel_token=SEL_TOKEN \ TF_VAR_user_password=USER_PASSWORD \ terraform destroy -target=module.server_local_root_disk</code> </pre><br>  Ensuite, ex√©cutez la commande Selectel VPC API Object Cleanup: <br><br><pre> <code class="bash hljs">$ env \ TF_VAR_sel_account=SEL_ACCOUNT \ TF_VAR_sel_token=SEL_TOKEN \ TF_VAR_user_password=USER_PASSWORD \ terraform destroy -target=module.project_with_user</code> </pre><br>  Dans les deux cas, vous devrez confirmer la suppression de tous les objets: <br><br><pre> <code class="bash hljs">Do you really want to destroy all resources? Terraform will destroy all your managed infrastructure, as shown above. There is no undo. Only <span class="hljs-string"><span class="hljs-string">'yes'</span></span> will be accepted to confirm. Enter a value: yes</code> </pre><br>  L'exemple suivant se trouve dans le <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="noopener noreferrer">r√©pertoire terraform-examples / examples / vpc / kubernetes_cluster</a> . <br><br>  Cet exemple cr√©e un projet, un utilisateur avec un r√¥le dans le projet et l√®ve un cluster Kubernetes.  Dans le fichier <strong>vars.tf</strong> , <strong>vous</strong> pouvez voir les valeurs par d√©faut, telles que le nombre de n≈ìuds, leurs caract√©ristiques, la version de Kubernetes, etc. <br><br>  Pour cr√©er des ressources, comme dans le premier exemple, la premi√®re chose que nous ferons est d'initialiser les modules et de cr√©er les ressources du module <strong>project_with_user</strong> , puis de cr√©er le reste: <br><br><pre> <code class="bash hljs">$ terraform init $ env \ TF_VAR_sel_account=SEL_ACCOUNT \ TF_VAR_sel_token=SEL_TOKEN \ TF_VAR_user_password=USER_PASSWORD \ terraform apply -target=module.project_with_user $ env \ TF_VAR_sel_account=SEL_ACCOUNT \ TF_VAR_sel_token=SEL_TOKEN \ TF_VAR_user_password=USER_PASSWORD \ terraform apply</code> </pre><br>  Nous transmettons la cr√©ation et la gestion des clusters Kubernetes via le composant OpenStack Magnum.  Vous pouvez en savoir plus sur la fa√ßon de travailler avec un cluster dans l'un de nos <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="noopener noreferrer">articles pr√©c√©dents</a> , ainsi que dans <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="noopener noreferrer">la base de connaissances</a> . <br><br>  Pendant la pr√©paration du cluster, des disques, des machines virtuelles seront cr√©√©s et tous les composants n√©cessaires seront install√©s.  La pr√©paration dure environ 4 minutes, moment auquel Terraform affichera les messages du formulaire: <br><br><pre> <code class="bash hljs">module.kubernetes_cluster.openstack_containerinfra_cluster_v1.cluster_1: Still creating... (3m0s elapsed)</code> </pre><br>  Une fois l'installation termin√©e, Terraform vous informera que le cluster est pr√™t et affichera son identifiant: <br><br><pre> <code class="bash hljs">module.kubernetes_cluster.openstack_containerinfra_cluster_v1.cluster_1: Creation complete after 4m20s (ID: 3c8...) Apply complete! Resources: 6 added, 0 changed, 0 destroyed.</code> </pre><br>  Pour g√©rer le cluster Kubernetes cr√©√© via l'utilitaire kubectl, <strong>vous</strong> devez obtenir le fichier d'acc√®s au cluster.  Pour ce faire, acc√©dez au projet cr√©√© via Terraform dans la liste des projets de votre compte: <br><br><img src="https://habrastorage.org/webt/pp/7y/rt/pp7yrtw_q-79pkx1j6mr5ebbsyi.png"><br><br>  Ensuite, suivez le lien du formulaire <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">xxxxxx.selvpc.ru</a> , qui s'affiche sous le nom du projet: <br><br><img src="https://habrastorage.org/webt/yr/in/wk/yrinwkfne83cenropq9t3szxt6c.png"><br><br>  Utilisez le nom d'utilisateur et le mot de passe cr√©√©s via Terraform comme informations de connexion.  Si vous n'avez pas modifi√© <strong>vars.tf</strong> ou <strong>main.tf</strong> pour notre exemple, l'utilisateur aura le nom <strong>tf_user</strong> .  En tant que mot de passe, utilisez la valeur de la variable <strong>TF_VAR_user_password</strong> , qui a √©t√© sp√©cifi√©e lors de l'ex√©cution ant√©rieure de <strong>terraform apply</strong> . <br><br>  Dans le projet, vous devez aller dans l'onglet <strong>Kubernetes</strong> : <br><br><img src="https://habrastorage.org/webt/ft/bp/dj/ftbpdjhjrgxkgzomuxegaujj3wu.png"><br><br>  Voici un cluster cr√©√© via Terraform.  Vous pouvez t√©l√©charger le fichier pour <strong>kubectl</strong> sur l'onglet ¬´Acc√®s¬ª: <br><br><img src="https://habrastorage.org/webt/y_/pe/ov/y_peovkv0kjznzx95c_vw4wc-4e.png"><br><br>  Le m√™me onglet contient des instructions pour installer <strong>kubectl</strong> et utiliser le <strong>fichier</strong> <strong>config.yaml</strong> t√©l√©charg√©. <br><br>  Apr√®s avoir d√©marr√© <strong>kubectl</strong> et d√©fini la variable d'environnement <strong>KUBECONFIG,</strong> vous pouvez utiliser Kubernetes: <br><br><pre> <code class="bash hljs">$ kubectl get pods --all-namespaces NAMESPACE NAME READY STATUS RESTARTS AGE kube-system coredns-9578f5c87-g6bjf 1/1 Running 0 8m kube-system coredns-9578f5c87-rvkgd 1/1 Running 0 6m kube-system heapster-866fcbc879-b6998 1/1 Running 0 8m kube-system kube-dns-autoscaler-689688988f-8cxhf 1/1 Running 0 8m kube-system kubernetes-dashboard-7bdb5d4cd7-jcjq9 1/1 Running 0 8m kube-system monitoring-grafana-84c97bb64d-tc64b 1/1 Running 0 8m kube-system monitoring-influxdb-7c8ccc75c6-dzk5f 1/1 Running 0 8m kube-system node-exporter-tf-cluster-rz6nggvs4va7-minion-0 1/1 Running 0 8m kube-system node-exporter-tf-cluster-rz6nggvs4va7-minion-1 1/1 Running 0 8m kube-system openstack-cloud-controller-manager-8vrmp 1/1 Running 3 8m prometeus-monitoring grafana-76bcb7ffb8-4tm7t 1/1 Running 0 8m prometeus-monitoring prometheus-75cdd77c5c-w29gb 1/1 Running 0 8m</code> </pre><br>  Le nombre de n≈ìuds de cluster est facilement modifi√© via Terraform. <br>  La valeur suivante est sp√©cifi√©e dans le fichier <strong>main.tf</strong> : <br><br><pre> <code class="bash hljs">cluster_node_count = <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">${var.cluster_node_count}</span></span></span><span class="hljs-string">"</span></span></code> </pre><br><p>  Cette valeur est remplac√©e par <strong>vars.tf</strong> : </p><br><br><pre> <code class="bash hljs">variable <span class="hljs-string"><span class="hljs-string">"cluster_node_count"</span></span> { default = 2 }</code> </pre><br>  Vous pouvez soit modifier la valeur par d√©faut dans <strong>vars.tf</strong> , soit sp√©cifier la valeur requise directement dans <strong>main.tf</strong> : <br><br><pre> <code class="bash hljs">- cluster_node_count = <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">${var.cluster_node_count}</span></span></span><span class="hljs-string">"</span></span> + cluster_node_count = 3</code> </pre><br>  Pour appliquer les modifications, comme dans le cas du premier exemple, utilisez la <strong>commande terraform apply</strong> : <br><br><pre> <code class="bash hljs">$ env \ TF_VAR_sel_account=SEL_ACCOUNT \ TF_VAR_sel_token=SEL_TOKEN \ TF_VAR_user_password=USER_PASSWORD \ terraform apply</code> </pre><br>  Lorsque le nombre de n≈ìuds change, le cluster reste disponible.  Apr√®s avoir ajout√© un n≈ìud via Terraform, vous pouvez l'utiliser sans configuration suppl√©mentaire: <br><br><pre> <code class="bash hljs">$ kubectl get nodes NAME STATUS ROLES AGE VERSION tf-cluster-rz6nggvs4va7-master-0 Ready,SchedulingDisabled master 8m v1.12.4 tf-cluster-rz6nggvs4va7-minion-0 Ready &lt;none&gt; 8m v1.12.4 tf-cluster-rz6nggvs4va7-minion-1 Ready &lt;none&gt; 8m v1.12.4 tf-cluster-rz6nggvs4va7-minion-2 Ready &lt;none&gt; 3m v1.12.4</code> </pre><br><h2>  Conclusion </h2><br>  Dans cet article, nous avons d√©couvert les m√©thodes de base pour travailler avec le <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="noopener noreferrer">¬´cloud priv√© virtuel¬ª</a> via Terraform.  Nous serons heureux si vous utilisez le fournisseur officiel Terraform Selectel et fournissez des commentaires. <br><br>  Tous les bogues trouv√©s du fournisseur Terraform Selectel peuvent √™tre signal√©s via <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="noopener noreferrer">Github Issues</a> . </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr445162/">https://habr.com/ru/post/fr445162/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr445152/index.html">Que peut-on faire d'autre dans la recherche? Rapport Yandex</a></li>
<li><a href="../fr445154/index.html">√âv√©nements num√©riques √† Moscou du 25 au 31 mars</a></li>
<li><a href="../fr445156/index.html">N√©buliseur compact Glenmark: une chose utile dans la vie quotidienne</a></li>
<li><a href="../fr445158/index.html">Orientation optimale des pi√®ces et configuration de prise en charge dans l'imprimante 3D</a></li>
<li><a href="../fr445160/index.html">Nous d√©veloppons un firmware de p√©dale pour apprendre √† jouer de la balala√Øka</a></li>
<li><a href="../fr445164/index.html">Performance du site √©quilibr√©e. Partie 5: Facilit√© d'utilisation</a></li>
<li><a href="../fr445166/index.html">Tout ce que vous devez savoir sur la c√©sure automatique CSS</a></li>
<li><a href="../fr445168/index.html">Un CV id√©al qui sera accueilli par un recruteur et un employeur</a></li>
<li><a href="../fr445170/index.html">Trois grands mensonges sur JavaScript</a></li>
<li><a href="../fr445172/index.html">Les navigateurs Edge avec Chromium sont apparus sur les services d'h√©bergement de fichiers</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>