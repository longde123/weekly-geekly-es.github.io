<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👍 📈 👍🏿 Démarrez-vous, le printemps arrive (partie 2) 🛋️ 🆕 🚗</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Evgeny EvgenyBorisov Borisov (NAYA Technologies) et Kirill tolkkv Tolkachev (Cyan.Finance, Twitter ) continuent de parler de l'utilisation de Spring B...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Démarrez-vous, le printemps arrive (partie 2)</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/jugru/blog/425333/"><p>  Evgeny <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" class="user_link">EvgenyBorisov</a> Borisov (NAYA Technologies) et Kirill <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" class="user_link">tolkkv</a> Tolkachev (Cyan.Finance, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Twitter</a> ) continuent de parler de l'utilisation de Spring Boot pour résoudre les problèmes de l'imaginaire Braavos Iron Bank.  Dans la deuxième partie, nous nous concentrerons sur les profils et subtilités de lancement de l'application. </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/c19/236/8c6/c192368c6d6e05d473201da0031d3ccc.png"><br><br></p><a name="habracut"></a><br><iframe width="560" height="315" src="https://www.youtube.com/embed/7Cq5zEm2wq0" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><p>  La première partie de l'article se trouve <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ici</a> . </p><br><p>  Donc, jusqu'à récemment, le client est venu et a simplement demandé d'envoyer un corbeau.  Maintenant, la situation a changé.  L'hiver est arrivé, le mur est tombé. </p><br><p> Premièrement, le principe de l'octroi de prêts est en train de changer.  Si auparavant, avec une probabilité de 50%, ils ont donné à tout le monde sauf Starks, maintenant ils ne donnent qu'à ceux qui remboursent leurs dettes.  Par conséquent, nous modifions les règles d'émission des prêts dans notre logique commerciale.  Mais seulement pour les succursales de la banque, qui sont situées là où l'hiver est déjà venu, dans tout le reste, tout reste comme avant.  Je vous rappelle qu'il s'agit d'un service qui décide d'accorder ou non un prêt.  Nous ferons juste un autre service qui ne fonctionnera qu'en hiver. </p><br><p>  Nous passons à notre logique métier: </p><br><pre><code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WhiteListBasedProphetService</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ProphetService</span></span></span><span class="hljs-class"> </span></span>{  <span class="hljs-meta"><span class="hljs-meta">@Override</span></span>  <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">willSurvive</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String name)</span></span></span><span class="hljs-function"> </span></span>{    <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>;  } }</code> </pre> <br><p>  Nous avons déjà une liste de ceux qui remboursent leurs dettes. </p><br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">spring</span></span>: <span class="hljs-selector-tag"><span class="hljs-selector-tag">application</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.name</span></span>: <span class="hljs-selector-tag"><span class="hljs-selector-tag">money-raven</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">jpa</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.hibernate</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.ddl-auto</span></span>: <span class="hljs-selector-tag"><span class="hljs-selector-tag">validate</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">ironbank</span></span>: <span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span><span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span><span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span>:   <span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span>  : <span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span>: ,   : <span class="hljs-selector-tag"><span class="hljs-selector-tag">true</span></span></code> </pre> <br><p>  Et il y a une classe qui est déjà associée à la propriété - <code></code> . </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ProphetProperties</span></span></span><span class="hljs-class"> </span></span>{ List&lt;String&gt; ; }</code> </pre> <br><p>  Comme par le passé, nous l'injectons ici: </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WhiteListBasedProphetService</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ProphetService</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> ProphetProperties prophetProperties; <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">willSurvive</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String name)</span></span></span><span class="hljs-function"> </span></span>{   <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; } }</code> </pre> <br><p>  N'oubliez pas l'injection de constructeur (sur les annotations magiques): </p><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Service</span></span> <span class="hljs-meta"><span class="hljs-meta">@RequiredArgsConstructor</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WhiteListBasedProphetService</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ProphetService</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> ProphetProperties prophetProperties; <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">willSurvive</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String name)</span></span></span><span class="hljs-function"> </span></span>{   <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; } }</code> </pre> <br><p>  Presque terminé. </p><br><p>  Maintenant, nous devons donner uniquement à ceux qui remboursent leurs dettes: </p><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Service</span></span> <span class="hljs-meta"><span class="hljs-meta">@RequiredArgsConstructor</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WhiteListBasedProphetService</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ProphetService</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> ProphetProperties prophetProperties; <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">willSurvive</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String name)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> prophetProperties.get().contains(name); } }</code> </pre> <br><p>  Mais ici, nous avons un petit problème.  Nous avons maintenant deux implémentations: l'ancien et le nouveau service. </p><br><pre> <code class="java hljs">Description Parameter <span class="hljs-number"><span class="hljs-number">1</span></span> of constructor in com.ironbank.moneyraven.service.TransferMoneyProphecyBackend… - nameBasedProphetService: defined in file [/Users/tolkv/git/conferences/spring-boot-ripper… - WhileListBackendProphetService: defined in file [/Users/tolkv/git/conferences/spring-boot-ripper...</code> </pre> <br><p>  Il est logique de diviser ces beans en différents profils.  Profil d' <code></code> et profil d' <code></code> .  Laissez notre nouveau service fonctionner uniquement dans le profil <code></code> : </p><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Service</span></span> <span class="hljs-meta"><span class="hljs-meta">@Profile</span></span>(ProfileConstants.) <span class="hljs-meta"><span class="hljs-meta">@RequiredArgsConstructor</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WhiteListBasedProphetService</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ProphetService</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> ProphetProperties prophetProperties; <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">willSurvive</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String name)</span></span></span><span class="hljs-function"> </span></span>{   <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> prophetProperties.get().contains(name); } }</code> </pre> <br><p>  Et l'ancien service est en <code></code> . </p><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Service</span></span> <span class="hljs-meta"><span class="hljs-meta">@Profile</span></span>(ProfileConstants.) <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">NameBasedProphetService</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ProphetService</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">willSurvive</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String name)</span></span></span><span class="hljs-function"> </span></span>{   <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> !name.contains(<span class="hljs-string"><span class="hljs-string">"Stark"</span></span>) &amp;&amp; ThreadLocalRandom.current().nextBoolean(); } }</code> </pre> <br><p>  Mais l'hiver arrive lentement.  Dans les royaumes à côté du mur brisé, c'est déjà l'hiver.  Mais quelque part dans le sud - pas encore.  C'est-à-dire  Les applications situées dans des succursales et des fuseaux horaires différents doivent fonctionner différemment.  Selon les conditions de notre tâche, nous ne pouvons pas effacer l'ancienne implémentation où l'hiver est arrivé et utiliser la nouvelle classe.  Nous voulons que les employés de la banque ne fassent rien du tout: nous leur livrerons une application qui fonctionnera en mode été jusqu'à l'arrivée de l'hiver.  Et quand l'hiver arrive, ils le redémarrent et c'est tout.  Ils n'auront pas à changer le code, à effacer les classes.  Par conséquent, nous avons initialement deux profils: une partie du bac est créée lors de l'été, et une partie du bac est créée lorsque l'hiver. </p><br><p>  Mais un autre problème apparaît: </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/fbd/7a6/882/fbd7a6882ff3180ccfc693ac3b41a852.png"><br></p><br><p>  Maintenant, nous n'avons plus un seul bean, car nous avons spécifié deux profils et l'application démarre dans le profil par défaut. </p><br><p>  Nous avons donc une nouvelle exigence du client. </p><br><h2>  Iron Law 2. Aucun profil n'est autorisé </h2><br><p><img src="https://habrastorage.org/getpro/habr/post_images/04a/0bb/57a/04a0bb57aa20425f959898ac3eecf8a5.png"><br></p><br><p>  Nous ne voulons pas évoquer le contexte si le profil n'est pas activé, car l'hiver est déjà venu, tout est devenu très mauvais.  Il y a certaines choses qui devraient arriver ou non, selon que l' <code></code> ou que l' <code></code> .  Regardez également l'exception, dont le texte est donné ci-dessus.  Il n’explique rien.  Un profil n'est pas défini, il n'y a donc pas d'implémentation de <code>ProphetService</code> .  Dans le même temps, personne n'a dit qu'il était nécessaire de définir un profil. </p><br><p>  Par conséquent, nous voulons maintenant visser une pièce supplémentaire dans notre démarreur, qui, lors de la construction du contexte, vérifiera qu'un certain profil est défini.  S'il n'est pas défini, nous n'irons pas et ne lancerons pas une telle exception (et pas une exception concernant l'absence de bac). </p><br><p>  Pouvons-nous le faire avec notre écouteur d'application?  Non.  Et il y a trois raisons à cela: </p><br><ul><li>  L'auditeur à responsabilité unique est responsable de faire voler le corbeau.  L'auditeur ne doit pas vérifier si un profil a été activé car l'activation d'un profil affecte non seulement l'auditeur lui-même, mais aussi beaucoup plus. </li><li>  Lorsqu'un contexte est créé, différentes choses se produisent.  Et nous ne voulons pas qu'ils commencent à se produire si aucun profil n'a été défini. </li><li>  L'écouteur fonctionne à la toute fin lorsque le contexte est résolu.  Et le fait qu'il n'y ait pas de profil, nous le savons bien plus tôt.  Pourquoi attendre ces cinq minutes conditionnelles jusqu'à ce que le service augmente presque, puis tout tombe. </li></ul><br><p>  De plus, je ne sais toujours pas quels bugs vont apparaître du fait que nous avons commencé à monter sans profil (supposons que je ne connais pas la logique métier).  Par conséquent, en l'absence de profil, vous devez faire tomber le contexte à un stade très précoce.  Soit dit en passant, si vous utilisez n'importe quel Spring Cloud, cela devient encore plus pertinent pour vous, car l'application fait beaucoup de choses à un stade précoce. </p><br><p>  Pour implémenter la nouvelle exigence, il existe <code>ApplicationContextInitializer</code> .  C'est une autre interface qui nous permet d'étendre un certain point de Spring en le spécifiant dans spring.factories. </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/889/f21/a3b/889f21a3bee67ede3394d3c52b02e96d.png"><br></p><br><p>  Nous implémentons cette interface, et nous avons un initialiseur de contexte, qui a un <code>ConfigurableApplicationContext</code> : </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ProfileCheckAppInitializer</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ApplicationContextInitializer</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ConfigurableApplicationContext</span></span></span><span class="hljs-class">&gt; </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">initialize</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ConfigurableApplicationContext applicationContext)</span></span></span><span class="hljs-function"> </span></span>{ } }</code> </pre> <br><p>  Avec cela, nous pouvons obtenir l'environnement - la chose que SpringApplication a préparée pour nous.  Tous les biens que nous lui avons transmis sont arrivés.  Entre autres, ils contiennent également des profils. </p><br><p>  S'il n'y a pas de profils là-bas, alors nous devrions lever une exception en disant que vous ne pouvez pas travailler comme ça. </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ProfileCheckAppInitializer</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ApplicationContextInitializer</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ConfigurableApplicationContext</span></span></span><span class="hljs-class">&gt; </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">initialize</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ConfigurableApplicationContext applicationContext)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> applicationContext.getEnvironment().getActiveProfiles().length == <span class="hljs-number"><span class="hljs-number">0</span></span> {     <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> RuntimeException(<span class="hljs-string"><span class="hljs-string">"  !"</span></span>);   } } }</code> </pre> <br><p>  Vous devez maintenant enregistrer ces informations dans spring.factories. </p><br><pre> <code class="java hljs">org.springframework.boot.context.properties.EnableConfigurationProperties=com.ironbank.moneyraven.starter.IronConfiguration org.springframework.context.ApplicationContextInitializer=com.ironbank.moneyraven.starter.ProfileCheckAppInitializer</code> </pre> <br><p>  D'après ce qui précède, vous pouvez deviner que <code>ApplicationContextInitializer</code> est un point d'extension.  <code>ApplicationContextInitializer</code> fonctionne lorsque le contexte commence tout juste à être créé, il n'y a pas encore de bacs. </p><br><p>  La question se pose: si nous avons écrit <code>ApplicationContextInitializer</code> , pourquoi ne devrait-il pas, en tant qu'auditeur, être écrit dans une configuration qui s'étire quand même?  La réponse est simple: car cela devrait fonctionner beaucoup plus tôt lorsqu'il n'y a pas de contexte et pas de configurations.  C'est-à-dire  il ne peut pas encore être injecté.  Par conséquent, nous le prescrivons comme une pièce distincte. </p><br><p>  Une tentative de lancement a montré que tout était tombé assez vite et a indiqué que nous partions sans profil.  Essayons maintenant de spécifier un profil, et tout fonctionne - le corbeau est envoyé. </p><br><p>  <code>ApplicationContextInitializer</code> - se remplit lorsque le contexte a déjà été créé, mais qu'il n'y a rien d'autre à part l'environnement. </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/4ee/fb1/3e5/4eefb13e5b1e2f8f04c19e22f58062a8.png"><br></p><br><p>  Qui crée l'environnement?  Carlson - <code>SpringBootApplication</code> .  Il le remplit de diverses méta-informations, qui peuvent ensuite être sorties de leur contexte.  La plupart des choses peuvent être injectées via <code>@value</code> , quelque chose peut être obtenu de l'environnement, car nous venons de recevoir des profils. </p><br><p>  Par exemple, différentes propriétés viennent ici: </p><br><ul><li>  que Spring Boot peut construire; </li><li>  qui au démarrage sont transmises via la ligne de commande; </li><li>  systémique; </li><li>  énoncées comme variables d'environnement; </li><li>  prescrit dans les propriétés d'application; </li><li>  enregistré dans d'autres fichiers de propriétés. </li></ul><br><p>  Tout cela est collecté et placé dans un objet d'environnement.  Il contient également des informations sur les profils actifs.  L'objet d'environnement est la seule chose qui existe au moment où Spring Boot commence à créer le contexte. </p><br><p>  J'aimerais deviner automatiquement quel sera le profil si les gens oublient de le demander de leurs mains (nous faisons tout pour que les employés de banque qui sont assez impuissants sans programmeurs puissent lancer l'application pour que tout fonctionne pour eux, quoi qu'il arrive).  Pour ce faire, nous ajouterons à notre entrée une chose qui devinera le profil - <code></code> ou pas - en fonction de la température dans la rue.  Et une autre nouvelle interface magique nous aidera tous avec cela - <code>EnvironmentPostProcessor</code> , car nous devons le faire avant que <code>ApplicationContextInitializer</code> fonctionne.  Et avant <code>ApplicationContextInitializer</code> il n'y a que <code>EnvironmentPostProcessor</code> . </p><br><p>  Nous implémentons à nouveau une nouvelle interface.  Il n'y a qu'une seule méthode, qui de la même manière que <code>ConfigurableEnvironment</code> lance dans <code>SpringApplication</code> , car nous n'avons pas encore <code>ConfigurableContext</code> (il existe déjà dans <code>SpringInitializer</code> il n'est pas ici; il n'y a que l'environnement). </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ResolveProfileEnvironmentPostProcessor</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">EnvironmentPostProcessor</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">postProcessEnvironment</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ConfigurableEnvironment environment, SpringApplication application)</span></span></span><span class="hljs-function"> </span></span>{ } }</code> </pre> <br><p>  Dans cet environnement, nous pouvons définir le profil.  Mais vous devez d'abord vérifier que personne ne l'a installé auparavant.  Par conséquent, nous devons <code>getActiveProfiles</code> vérifier <code>getActiveProfiles</code> .  Si les gens savent ce qu'ils font et créent un profil, nous n'essaierons pas de deviner pour eux.  Mais s'il n'y a pas de profil, nous essaierons de comprendre par la météo. </p><br><p>  Et le second - nous devons comprendre si nous avons un temps d'hiver ou d'été maintenant.  Nous reviendrons la température de <code>-300</code> . </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ResolveProfileEnvironmentPostProcessor</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">EnvironmentPostProcessor</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">postProcessEnvironment</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ConfigurableEnvironment environment, SpringApplication application)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (environment.getActivePrifiles().length == <span class="hljs-number"><span class="hljs-number">0</span></span> &amp;&amp; getTemperature() &lt; -<span class="hljs-number"><span class="hljs-number">272</span></span>) {   } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getTemperature</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> -<span class="hljs-number"><span class="hljs-number">300</span></span>; } }</code> </pre> <br><p>  Dans cette condition, nous avons l'hiver et nous pouvons établir un nouveau profil.  Nous nous souvenons que le profil s'appelle <code></code> : </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ResolveProfileEnvironmentPostProcessor</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">EnvironmentPostProcessor</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">postProcessEnvironment</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ConfigurableEnvironment environment, SpringApplication application)</span></span></span><span class="hljs-function"> </span></span>{   <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (environment.getActivePrifiles().length == <span class="hljs-number"><span class="hljs-number">0</span></span> &amp;&amp; getTemperature() &lt; -<span class="hljs-number"><span class="hljs-number">272</span></span>) { environment.setActiveProfiles(<span class="hljs-string"><span class="hljs-string">""</span></span>);   } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { environment.setActiveProfiles(<span class="hljs-string"><span class="hljs-string">""</span></span>);   } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getTemperature</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> -<span class="hljs-number"><span class="hljs-number">300</span></span>; } }</code> </pre> <br><p>  Maintenant, nous devons spécifier le <code>EnvironmentPostProcessor</code> dans spring.factories. </p><br><pre> <code class="java hljs">org.springframework.boot.context.properties.EnableConfigurationProperties=com.ironbank.moneyraven.starter.IronConfiguration org.springframework.context.ApplicationContextInitializer=com.ironbank.moneyraven.starter.ProfileCheckAppInitializer org.springframework.boot.env.EnvironmentPostProcessor=com.ironbank.moneyraven.starter.ResolveProfileEnvironmentPostProcessor</code> </pre> <br><p>  En conséquence, l'application démarre sans profil, nous disons que c'est de la production et vérifions dans quel profil elle a commencé avec nous.  Par magie, nous avons réalisé que notre profil est l' <code></code> .  Et l'application n'est pas tombée, car l' <code>ApplicationContextInitializer</code> , qui vérifie s'il y a un profil, vient ensuite. <br>  Le résultat: </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ResolveProfileEnvironmentPostProcessor</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">EnvironmentPostProcessor</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">postProcessEnvironment</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ConfigurableEnvironment environment, SpringApplication application)</span></span></span><span class="hljs-function"> </span></span>{   <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (getTemperature() &lt; -<span class="hljs-number"><span class="hljs-number">272</span></span>) {     environment.setActiveProfiles(<span class="hljs-string"><span class="hljs-string">""</span></span>);   } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> {     environment.setActiveProfiles(<span class="hljs-string"><span class="hljs-string">""</span></span>);   } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getTemperature</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{   <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> -<span class="hljs-number"><span class="hljs-number">300</span></span>; } }</code> </pre> <br><p>  Nous avons parlé de <code>EnvironmentPostProcessor</code> , qui s'exécute avant <code>ApplicationContextInitializer</code> .  Mais qui l'exécute? </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/fd0/20e/e9e/fd020ee9edd65a1e41e62e0ebe689658.png"><br></p><br><p>  Ce monstre le démarre, qui, apparemment, est le fils illégitime d' <code>ApplicationListener</code> et <code>EnvironmentPostProcessor</code> , car il est hérité à la fois d' <code>ApplicationListener</code> et d' <code>EnvironmentPostProcessor</code> .  Il s'appelle <code>ConfigFileApplicationListener</code> (pourquoi "ConfigFile" - personne ne sait). </p><br><p>  Lui est notre Carlson, c'est-à-dire  Spring Application fournit un environnement préparé pour écouter deux événements: <code>ApplicationPreparedEvent</code> et <code>ApplicationEnvironmentPreparedEvent</code> .  Nous n'analyserons pas maintenant qui lance ces événements.  Il existe une autre couche (à mon avis, elle est déjà complètement superflue, au moins à ce stade du développement de Spring), qui déclenche un événement que l'environnement commence à être créé (Application.yml, les propriétés, les variables d'environnement sont analysées, etc. ) <br>  Après avoir reçu <code>ApplicationEnvironmentPreparedEvent</code> , l'auditeur comprend que vous devez configurer l'environnement - recherchez tous les <code>EnvironmentPostProcessor</code> et laissez-les fonctionner. </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/cd3/8c4/3b8/cd38c43b8a10c9867cc9b3ebcb3ee1e9.png"><br></p><br><p>  Après cela, il dit à <code>SpringFactoriesLoader</code> de livrer tout ce que vous avez commandé, à savoir tous les <code>EnvironmentPostProcessor</code> , à spring.factories.  Il place ensuite l'ensemble du <code>EnvironmentPostProcessor</code> dans une seule liste. </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/9b0/e39/f0f/9b0e39f0fe2514c22cfdc03af4b3f464.png"><br></p><br><p>  et comprend que lui aussi est un <code>EnvironmentPostProcessor</code> (simultanément), il se pousse donc là-bas, <br><img src="https://habrastorage.org/getpro/habr/post_images/0f9/bf0/d30/0f9bf0d30e0065e707c813101aa173d9.png"><br>  en même temps, il les trie, les accompagne et appelle chaque méthode <code>postProcessEnvironment</code> . </p><br><p>  De cette façon, tous les <code>postProcessEnvironment</code> sont démarrés à un stade précoce avant <code>SpringApplicationInitializer</code> .  Dans ce cas, un <code>EnvironmentPostProcessor</code> incompréhensible appelé <code>ConfigFileApplicationListener</code> démarre également. </p><br><p>  Une fois l'environnement mis en place, tout revient à Carlson. </p><br><p>  Si l'environnement est prêt, vous pouvez créer un contexte.  Et Carlson commence à créer du contexte avec <code>ApplicationInitializer</code> .  Ici, nous avons notre propre morceau, qui vérifie que dans le contexte il y a un environnement dans lequel il y a des profils actifs.  Sinon, nous tombons, car sinon nous aurons encore des problèmes plus tard.  Ensuite, les démarreurs fonctionnent, avec toutes les configurations habituelles déjà. </p><br><p>  L'image ci-dessus reflète que le printemps ne va pas bien non plus.  Ces étrangers s'y rencontrent périodiquement, la responsabilité unique n'est pas respectée et vous devez monter avec précaution. </p><br><p>  Maintenant, nous voulons parler un peu de l'autre côté de cette étrange créature, qui est à l'écoute d'un côté et <code>EnvironmentPostProcessor</code> de l'autre. </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/ffc/200/bf0/ffc200bf085fd822e7fd1fdf6d9e8fec.png"><br></p><br><p>  Comme <code>EnvironmentPostProcessor</code> il peut charger application.yml, les propriétés d'application, toutes sortes de variables d'environnement, les arguments de commande, etc.  Et en tant qu'auditeur, il peut écouter deux événements: </p><br><ul><li> <code>ApplicationPreparedEvent</code> </li> <li> <code>ApplicationEnvironmentPreparedEvent</code> </li> </ul><br><p>  La question est: </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/452/851/6fc/4528516fcdf7fa9038e8ae80d2a8ac9a.png"><br></p><br><p>  Tous ces événements ont eu lieu dans l'ancien printemps.  Et ceux dont nous avons parlé ci-dessus sont des événements de Spring Boot (événements spéciaux qu'il a ajoutés pour son cycle de vie).  Et il y en a plein.  Ce sont les principaux: </p><br><ul><li> <code>ApplicationStartingEvent</code> </li> <li> <code>ApplicationEnvironmentPreparedEvent</code> </li> <li> <code>ApplicationPreparedEvent</code> </li> <li> <code>ContextRefreshedEvent</code> </li> <li> <code>EmbeddedServletContainerInitializedEvent</code> </li> <li> <code>ApplicationReadyEvent</code> </li> <li> <code>ApplicationFailedEvent</code> </li> </ul><br><p>  Cette liste est loin d'être tout.  Mais il est important que certains d'entre eux soient liés à Spring Boot et une partie à Spring (bon vieux <code>ContextRefreshedEvent</code> , etc.). </p><br><p>  La mise en garde est que tous ces événements ne peuvent pas être reçus dans l'application (les simples mortels - différentes grand-mères - ne peuvent pas simplement écouter les événements complexes que Spring Boot lance).  Mais si vous connaissez les mécanismes secrets de spring.factories et définissez votre écouteur d'application au niveau de spring.factories, alors ces événements dès la première étape du démarrage de l'application vous parviennent. </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/54f/14e/bca/54f14ebca5de6e029b3b47dc50f8c7e2.png"><br></p><br><p>  Par conséquent, vous pouvez influencer le démarrage de votre demande à un stade assez précoce.  La plaisanterie, cependant, est qu'une partie de ce travail est effectuée dans d'autres entités - telles que <code>EnvironmentPostProcessor</code> et <code>ApplicationContextInitializer</code> . </p><br><p>  Vous pourriez tout faire sur les auditeurs, mais ce serait gênant et moche.  Si vous souhaitez écouter tous les événements que Spring lance, et pas seulement <code>ContextRefreshedEvent</code> et <code>ContextStartedEvent</code> , vous n'avez pas besoin de définir l'écouteur, comme un bean, de la manière habituelle (sinon il est créé trop tard).  Il doit également être enregistré via spring.factories, puis il sera créé beaucoup plus tôt. </p><br><p>  Soit dit en passant, lorsque nous avons examiné cette liste, il n'était pas clair pour nous quand <code>ContextStartedEvent</code> et <code>ContextStoppedEvent</code> déclenchés. </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/796/e78/7ca/796e787ca88d7271898b4072c03d3691.png"><br></p><br><p>  Il s'est avéré que ces événements ne fonctionnent jamais du tout.  Nous nous sommes longtemps interrogés sur les événements à intercepter pour comprendre que l'application avait vraiment démarré.  Et il s'est avéré que les événements dont nous parlions apparaissent maintenant lorsque vous extrayez avec force des méthodes du contexte: </p><br><ul><li> <code>ctx.start();</code>  -&gt; <code>ContextStartedEvent</code> </li><li> <code>ctx.stop();</code>  -&gt; <code>ContextStoppedEvent</code> </li></ul><br><p>  C'est-à-dire  <code>SpringApplication.run</code> ne <code>SpringApplication.run</code> que si nous <code>SpringApplication.run</code> , obtenons le contexte, en tirons <code>ctx.start();</code>  ou <code>ctx.stop();</code>  .  Il n'est pas très clair pourquoi cela est nécessaire.  Mais, encore une fois, ils vous ont donné un point d'extension. </p><br><p>  Le printemps a-t-il quelque chose à voir avec cela?  Si oui, quelque part il devrait y avoir une exception: </p><br><ul><li> <code>ctx.stop();</code>  (1) </li><li> <code>ctx.start();</code>  (2) </li><li> <code>ctx.close();</code>  (3) </li><li> <code>ctx.start();</code>  (4) </li></ul><br><p>  En fait, ce sera sur la dernière ligne, car après <code>ctx.close();</code>  rien ne peut être fait avec le contexte.  Mais appelez <code>ctx.stop();</code>  avant <code>ctx.start();</code>  - vous pouvez (Spring ignore simplement ces événements - ils sont juste pour vous). </p><br><p>  Écrivez à vos auditeurs, écoutez-vous, <code>ctx.stop();</code> vos lois, que faire sur <code>ctx.stop();</code>  , et que faire sur <code>ctx.start();</code>  . </p><br><p>  Au total, le diagramme d'interaction et de cycle de vie de l'application ressemble à ceci: </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/f05/25b/6b5/f0525b6b5742a9a7969a17465b174a4f.png"><br></p><br><p>  Les couleurs ici montrent différentes périodes de la vie. </p><br><ul><li>  Blue is Spring Boot, l'application a déjà démarré.  Cela signifie que les demandes de service Tomcat qui lui parviennent des clients sont traitées, tout le contexte est définitivement levé, tous les beans fonctionnent, les bases de données sont connectées, etc. </li><li>  Vert - un événement <code>ContextRefreshedEvent</code> arrivé et le contexte est créé.  À partir de ce moment, par exemple, les écouteurs d'application commencent à fonctionner, que vous implémentez soit en définissant l'annotation ApplicationListener, soit via l'interface éponyme avec un générique qui écoute certains événements.  Si vous souhaitez recevoir plus d'événements, vous devez écrire le même ApplicationListener dans spring.factories (le Spring habituel fonctionne ici).  Une barre indique où commence le rapport <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Spring Ripper</a> . </li><li>  À un stade antérieur, SpringApplication fonctionne, ce qui prépare le contexte pour nous.  C'est le travail de préparation de l'application que nous avons fait lorsque nous étions des développeurs Spring réguliers.  Par exemple, WebXML configuré. </li><li>  Mais il y a des étapes encore plus anciennes.  Il montre qui, où et pour qui cela fonctionne. </li><li>  Il y a encore une étape grise dans laquelle il est impossible de se caler en aucune façon.  Il s'agit de l'étape à laquelle SpringApplication sort de la boîte (entrez uniquement dans le code). </li></ul><br><p>  Si vous avez remarqué, lors du rapport en deux parties, nous sommes allés de droite à gauche: nous sommes partis de la toute fin, avons vissé la configuration qui volait du démarreur, puis avons ajouté ce qui suit, etc.  Parlons maintenant rapidement de toute la chaîne dans la direction opposée. <br>  Vous écrivez dans votre <code>SpringApplication.run</code> principal.  Il trouve différents auditeurs, leur lance un événement qu'il a commencé à construire.  Après cela, les écouteurs trouvent <code>EnvironmentPostProcessor</code> , laissez-les configurer l'environnement.  Une fois l'environnement mis en place, nous commençons à construire le contexte (Carlson entre).  Carlson crée le contexte et permet à tous les initialiseurs d'application de faire quelque chose avec ce contexte.  Nous avons un point d'extension.  Après cela, le contexte est déjà configuré et la même chose commence à se produire que dans l'application Spring habituelle, lorsque le contexte est créé - <code>BeanFactoryPostProcessor</code> , <code>BeanPostProcessor</code> , les beans sont configurés.  C'est ce que fait le printemps ordinaire. </p><br><h2>  Comment courir </h2><br><p>  Nous avons terminé de discuter du processus de rédaction d'une demande. </p><br><p>  Mais nous avions encore une chose que les développeurs n'aiment pas.  Ils n'aiment pas penser comment, finalement, leur demande va commencer.  L'administrateur l'exécutera-t-il dans Tomcat, JBoss ou dans WebLogic?  Il faut juste que ça marche.  Si cela ne fonctionne pas, dans le pire des cas, le développeur devra à nouveau configurer quelque chose </p><br><p>  Quelles sont donc nos méthodes de lancement? </p><br><ul><li>  guerre tomcat; </li><li>  idée; </li><li>  <code>java -jar/war</code> . </li></ul><br><p>  Tomcat n'est pas une tendance de masse, nous n'en parlerons pas en détail. </p><br><p>  L'idée est également, en principe, peu intéressante.  C'est juste un peu plus compliqué que je ne le dirai ci-dessous.  Mais dans Idea, en principe, il ne devrait pas y avoir de problèmes.  Elle voit quel genre de dépendances le démarreur apportera. <br>  Si nous utilisons <code>java -jar</code> , le principal problème est de créer un chemin de classe avant de lancer l'application. </p><br><p>  Qu'ont fait les gens en 2001?  Ils ont écrit <code>java -jar</code> quel pot doit être exécuté, puis un espace, <code>classpath=...</code> et les scripts y ont été indiqués.  Dans notre cas, il y a 150 Mo de diverses dépendances ajoutées par les démarreurs.  Et tout cela devrait être fait manuellement.  Naturellement, personne ne fait ça.  Nous écrivons simplement: <code>java -jar</code> , quel pot doit être exécuté et c'est tout.  D'une manière ou d'une autre, le chemin de classe est toujours en cours de construction.  Nous en parlerons maintenant. </p><br><p>  Commençons par la préparation du fichier jar afin qu'il puisse même être lancé sans Tomcat.  Avant de créer <code>java -jar</code> , vous devez créer un bocal.  Ce pot devrait évidemment être inhabituel, une sorte d'analogue de guerre, où tout sera à l'intérieur, y compris le Tomcat intégré. </p><br><pre> <code class="java hljs">&lt;build&gt; &lt;plugins&gt;    &lt;plugin&gt;       &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;       &lt;artifactId&gt;spring-boot-maven-plugin&lt;/artifactId&gt;    &lt;/plugin&gt; &lt;/plugins&gt; &lt;/build&gt;</code> </pre> <br><p>  Lorsque nous avons téléchargé le projet, quelqu'un a déjà enregistré un plug-in dans notre POM.  Ici, en passant, vous pouvez lancer des configurations, mais plus à ce sujet plus tard.     jar,   Maven  Gradle  ,   jar .      : </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/877/aad/b8e/877aadb8e0edbfbe6df10853b8c3f0c9.png"><br></p><br><p>     : </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/5ea/499/a35/5ea499a35d217fca525c27d7c8d2cfd3.png"><br></p><br><p>     war-. </p><br><p> ,     . </p><br><p>     ,    jar.    <code>java -jar</code> ,   ,    , , <code>org.springframework.boot</code> .      .     org.springframework.boot package.         <code>META-INF</code> </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/5a0/6c7/31e/5a06c731e6b958d02f683de73b2c5a9c.png"><br></p><br><p> Spring Boot   MANIFEST (    Maven  Gradle),     main class,    jar-. </p><br><p>  ,  jar-    :     -,    main-.     <code>java -jar</code>   -jar,   ,   main-class-. </p><br><p>  ,   ,        MANIFEST,  main-class   ,    main (    Idea).     ,     .     class path?    <code>java -jar</code>  ,  main,   , —    main,     .    MANIFEST      JarLauncher. </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/496/8b5/f76/4968b5f76b6ece2fc7431dbc6195d14e.png"><br></p><br><p>  C'est-à-dire     ,     ,    JarLauncher.    ,    main,     class path. <br>    ,    main?   property — <code>Start-class</code> . </p><br><p>  C'est-à-dire       .     class path  jar. ,    — <code>org.springframework.boot</code> —   class path.      <code>org.springframework.boot.loader.JarLauncher</code>  main-class.   , main-class  .   class path,    <code>BOOT-INF</code> (   lib     class  ,      ). </p><br><p>    RavenApplication, properties   class  <code>BOOT-INF</code> ,   ,  Tomcat  ,   <code>BOOT-INF/lib/</code> .  JarLauncher  classpath,     —  ,    <code>start-class</code> .     Spring, <code>ContextSpringApplication</code> —   flow,     . </p><br><p>   ,   start-class-?    ,     .      ,  . </p><br><p> ,     .     property,   <code>mainClass</code> ,   MANIFEST   <code>Start-Class</code> ,  <code>mainClass</code> —   JarLauncher. </p><br><p>      ,   mainClass,   ?     . Spring boot plugin   –  mainClass: </p><br><ul><li>     –    .     —     main class; </li><li>    – ,   mainClass   <code>@SpringBootApplication</code>   , , ,  ; </li><li>    —  exception   ,    main class,  ,     jar-  .  C'est-à-dire    ,  ,   . ,   ,     main class. </li><li>  @SpringBootApplication  —   . </li></ul><br><p> JarLauncher   .   Tomcat     WarLauncher,      war-  ,  jar-. </p><br><p>    ,     <code>java -jar</code> .   ?  Tu peux.   . </p><br><pre> <code class="java hljs">&lt;build&gt; &lt;plugins&gt;    &lt;plugin&gt;       &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;       &lt;artifactId&gt;spring-boot-maven-plugin&lt;/artifactId&gt;       &lt;configuration&gt;          &lt;executable&gt;<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>&lt;/executable&gt;       &lt;/configuration&gt;    &lt;/plugin&gt; &lt;/plugins&gt; &lt;/build&gt;</code> </pre> <br><p>     <code>&lt;configuration&gt;</code>    <code>&lt;executable&gt;true&lt;/executable&gt;</code>    Gradle  ,  : </p><br><pre> <code class="java hljs">springBoot { executable = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span> }</code> </pre> <br><p>      jar   executable jar.       . </p><br><p>  ,    .   Windows ,     exe-,   .       Spring Boot, ..   jar,    .      ,    . <br>   ? </p><br><p>      (jar —  zip-,     ): </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/355/f0a/08d/355f0a08d8a971a533cd824c84939827.png"><br></p><br><p> Spring Boot  - . </p><br><p>  -,   jar-.   ,      ,     — <code>#!/bin/bash</code> .     . </p><br><p>       .   <code>exit 0</code>   -  —      zip-. </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/365/674/922/365674922651752dc5a5896f48764d8e.png"><br></p><br><p>   ,   zip-    — <code>0xf4ra</code> .     ,  ,    . </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/60e/915/263/60e915263d6af6d19a5f0a7df977ee82.png"><br></p><br><p>       (,   ..). </p><br><p>  jar    : </p><br><ul><li>     —     ; </li><li>  ,    "   bash" ( <code>#!/bin/bash</code> ); </li><li> bash   ; </li><li>      <code>exit 0</code> ; </li><li>    <code>java -jar</code>   —     jar-,   ; </li><li>  <code>java -jar</code>  zip-   jar-,  ,    ,       . </li></ul><br><h2>  Conclusions </h2><br><p>         ,  Spring Boot —   ,     ,     . </p><br><p> -,  .  ,    Spring,   Spring —      Spring Boot.    ,         ,        — , ,   ,     . ,  ,     Spring, Spring Boot  . </p><br><p> -,    <code>@SpringBootApplication</code> ,     best practice,     Spring-. </p><br><p>   —   ,     ,   .    property  environment variable,    var arg   ,       ,    JSON.            <code>@value</code>       ,    .  configuration properties ,     ,     ,       .  ,  Spring     .   ,     ,      . </p><br><p>  .      ,    .          Spring,  Spring Boot    .    - ,   ,  ,           . </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/dc9/832/498/dc983249828e3fd26a257f871e46409e.png"><br></p><br><blockquote>  Minute de publicité. 19-20    Joker 2018,            <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">«          [Joker Edition]»</a> ,         <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">«Micronaut vs Spring Boot,     ?»</a>  .  ,  Joker       <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="> </a> .     <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="> </a> . </blockquote></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr425333/">https://habr.com/ru/post/fr425333/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr425323/index.html">"Trou de lapin." Designer UX dans l'équipe produit</a></li>
<li><a href="../fr425325/index.html">Interprètes DIY Bytecode</a></li>
<li><a href="../fr425327/index.html">Programmation fonctionnelle: mesure sept fois, coupe une fois</a></li>
<li><a href="../fr425329/index.html">Quelques conseils aux milléniaux des "oldies". Comment réussir dans notre monde numérique</a></li>
<li><a href="../fr425331/index.html">Alice aidera les développeurs à trouver des objets dans les demandes des utilisateurs. NER dans les dialogues</a></li>
<li><a href="../fr425335/index.html">Armada Garmin invaincu</a></li>
<li><a href="../fr425337/index.html">Comment faire évoluer Scrum - quelques mots sur le cadre de développement agile Nexus</a></li>
<li><a href="../fr425339/index.html">Architecture de l'information Internet, partie 2</a></li>
<li><a href="../fr425341/index.html">Présentation de «Top 3D Expo. Éducation numérique 2018 »</a></li>
<li><a href="../fr425343/index.html">25 outils Kubernetes utiles: déploiement et gestion</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>