<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üëç üìà üëçüèø D√©marrez-vous, le printemps arrive (partie 2) üõãÔ∏è üÜï üöó</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Evgeny EvgenyBorisov Borisov (NAYA Technologies) et Kirill tolkkv Tolkachev (Cyan.Finance, Twitter ) continuent de parler de l'utilisation de Spring B...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>D√©marrez-vous, le printemps arrive (partie 2)</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/jugru/blog/425333/"><p>  Evgeny <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" class="user_link">EvgenyBorisov</a> Borisov (NAYA Technologies) et Kirill <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" class="user_link">tolkkv</a> Tolkachev (Cyan.Finance, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Twitter</a> ) continuent de parler de l'utilisation de Spring Boot pour r√©soudre les probl√®mes de l'imaginaire Braavos Iron Bank.  Dans la deuxi√®me partie, nous nous concentrerons sur les profils et subtilit√©s de lancement de l'application. </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/c19/236/8c6/c192368c6d6e05d473201da0031d3ccc.png"><br><br></p><a name="habracut"></a><br><iframe width="560" height="315" src="https://www.youtube.com/embed/7Cq5zEm2wq0" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><p>  La premi√®re partie de l'article se trouve <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ici</a> . </p><br><p>  Donc, jusqu'√† r√©cemment, le client est venu et a simplement demand√© d'envoyer un corbeau.  Maintenant, la situation a chang√©.  L'hiver est arriv√©, le mur est tomb√©. </p><br><p> Premi√®rement, le principe de l'octroi de pr√™ts est en train de changer.  Si auparavant, avec une probabilit√© de 50%, ils ont donn√© √† tout le monde sauf Starks, maintenant ils ne donnent qu'√† ceux qui remboursent leurs dettes.  Par cons√©quent, nous modifions les r√®gles d'√©mission des pr√™ts dans notre logique commerciale.  Mais seulement pour les succursales de la banque, qui sont situ√©es l√† o√π l'hiver est d√©j√† venu, dans tout le reste, tout reste comme avant.  Je vous rappelle qu'il s'agit d'un service qui d√©cide d'accorder ou non un pr√™t.  Nous ferons juste un autre service qui ne fonctionnera qu'en hiver. </p><br><p>  Nous passons √† notre logique m√©tier: </p><br><pre><code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WhiteListBasedProphetService</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ProphetService</span></span></span><span class="hljs-class"> </span></span>{  <span class="hljs-meta"><span class="hljs-meta">@Override</span></span>  <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">willSurvive</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String name)</span></span></span><span class="hljs-function"> </span></span>{    <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>;  } }</code> </pre> <br><p>  Nous avons d√©j√† une liste de ceux qui remboursent leurs dettes. </p><br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">spring</span></span>: <span class="hljs-selector-tag"><span class="hljs-selector-tag">application</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.name</span></span>: <span class="hljs-selector-tag"><span class="hljs-selector-tag">money-raven</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">jpa</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.hibernate</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.ddl-auto</span></span>: <span class="hljs-selector-tag"><span class="hljs-selector-tag">validate</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">ironbank</span></span>: <span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span><span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span><span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span>:   <span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span>  : <span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span>: ,   : <span class="hljs-selector-tag"><span class="hljs-selector-tag">true</span></span></code> </pre> <br><p>  Et il y a une classe qui est d√©j√† associ√©e √† la propri√©t√© - <code></code> . </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ProphetProperties</span></span></span><span class="hljs-class"> </span></span>{ List&lt;String&gt; ; }</code> </pre> <br><p>  Comme par le pass√©, nous l'injectons ici: </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WhiteListBasedProphetService</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ProphetService</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> ProphetProperties prophetProperties; <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">willSurvive</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String name)</span></span></span><span class="hljs-function"> </span></span>{   <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; } }</code> </pre> <br><p>  N'oubliez pas l'injection de constructeur (sur les annotations magiques): </p><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Service</span></span> <span class="hljs-meta"><span class="hljs-meta">@RequiredArgsConstructor</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WhiteListBasedProphetService</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ProphetService</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> ProphetProperties prophetProperties; <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">willSurvive</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String name)</span></span></span><span class="hljs-function"> </span></span>{   <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; } }</code> </pre> <br><p>  Presque termin√©. </p><br><p>  Maintenant, nous devons donner uniquement √† ceux qui remboursent leurs dettes: </p><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Service</span></span> <span class="hljs-meta"><span class="hljs-meta">@RequiredArgsConstructor</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WhiteListBasedProphetService</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ProphetService</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> ProphetProperties prophetProperties; <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">willSurvive</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String name)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> prophetProperties.get().contains(name); } }</code> </pre> <br><p>  Mais ici, nous avons un petit probl√®me.  Nous avons maintenant deux impl√©mentations: l'ancien et le nouveau service. </p><br><pre> <code class="java hljs">Description Parameter <span class="hljs-number"><span class="hljs-number">1</span></span> of constructor in com.ironbank.moneyraven.service.TransferMoneyProphecyBackend‚Ä¶ - nameBasedProphetService: defined in file [/Users/tolkv/git/conferences/spring-boot-ripper‚Ä¶ - WhileListBackendProphetService: defined in file [/Users/tolkv/git/conferences/spring-boot-ripper...</code> </pre> <br><p>  Il est logique de diviser ces beans en diff√©rents profils.  Profil d' <code></code> et profil d' <code></code> .  Laissez notre nouveau service fonctionner uniquement dans le profil <code></code> : </p><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Service</span></span> <span class="hljs-meta"><span class="hljs-meta">@Profile</span></span>(ProfileConstants.) <span class="hljs-meta"><span class="hljs-meta">@RequiredArgsConstructor</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WhiteListBasedProphetService</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ProphetService</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> ProphetProperties prophetProperties; <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">willSurvive</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String name)</span></span></span><span class="hljs-function"> </span></span>{   <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> prophetProperties.get().contains(name); } }</code> </pre> <br><p>  Et l'ancien service est en <code></code> . </p><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Service</span></span> <span class="hljs-meta"><span class="hljs-meta">@Profile</span></span>(ProfileConstants.) <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">NameBasedProphetService</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ProphetService</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">willSurvive</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String name)</span></span></span><span class="hljs-function"> </span></span>{   <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> !name.contains(<span class="hljs-string"><span class="hljs-string">"Stark"</span></span>) &amp;&amp; ThreadLocalRandom.current().nextBoolean(); } }</code> </pre> <br><p>  Mais l'hiver arrive lentement.  Dans les royaumes √† c√¥t√© du mur bris√©, c'est d√©j√† l'hiver.  Mais quelque part dans le sud - pas encore.  C'est-√†-dire  Les applications situ√©es dans des succursales et des fuseaux horaires diff√©rents doivent fonctionner diff√©remment.  Selon les conditions de notre t√¢che, nous ne pouvons pas effacer l'ancienne impl√©mentation o√π l'hiver est arriv√© et utiliser la nouvelle classe.  Nous voulons que les employ√©s de la banque ne fassent rien du tout: nous leur livrerons une application qui fonctionnera en mode √©t√© jusqu'√† l'arriv√©e de l'hiver.  Et quand l'hiver arrive, ils le red√©marrent et c'est tout.  Ils n'auront pas √† changer le code, √† effacer les classes.  Par cons√©quent, nous avons initialement deux profils: une partie du bac est cr√©√©e lors de l'√©t√©, et une partie du bac est cr√©√©e lorsque l'hiver. </p><br><p>  Mais un autre probl√®me appara√Æt: </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/fbd/7a6/882/fbd7a6882ff3180ccfc693ac3b41a852.png"><br></p><br><p>  Maintenant, nous n'avons plus un seul bean, car nous avons sp√©cifi√© deux profils et l'application d√©marre dans le profil par d√©faut. </p><br><p>  Nous avons donc une nouvelle exigence du client. </p><br><h2>  Iron Law 2. Aucun profil n'est autoris√© </h2><br><p><img src="https://habrastorage.org/getpro/habr/post_images/04a/0bb/57a/04a0bb57aa20425f959898ac3eecf8a5.png"><br></p><br><p>  Nous ne voulons pas √©voquer le contexte si le profil n'est pas activ√©, car l'hiver est d√©j√† venu, tout est devenu tr√®s mauvais.  Il y a certaines choses qui devraient arriver ou non, selon que l' <code></code> ou que l' <code></code> .  Regardez √©galement l'exception, dont le texte est donn√© ci-dessus.  Il n‚Äôexplique rien.  Un profil n'est pas d√©fini, il n'y a donc pas d'impl√©mentation de <code>ProphetService</code> .  Dans le m√™me temps, personne n'a dit qu'il √©tait n√©cessaire de d√©finir un profil. </p><br><p>  Par cons√©quent, nous voulons maintenant visser une pi√®ce suppl√©mentaire dans notre d√©marreur, qui, lors de la construction du contexte, v√©rifiera qu'un certain profil est d√©fini.  S'il n'est pas d√©fini, nous n'irons pas et ne lancerons pas une telle exception (et pas une exception concernant l'absence de bac). </p><br><p>  Pouvons-nous le faire avec notre √©couteur d'application?  Non.  Et il y a trois raisons √† cela: </p><br><ul><li>  L'auditeur √† responsabilit√© unique est responsable de faire voler le corbeau.  L'auditeur ne doit pas v√©rifier si un profil a √©t√© activ√© car l'activation d'un profil affecte non seulement l'auditeur lui-m√™me, mais aussi beaucoup plus. </li><li>  Lorsqu'un contexte est cr√©√©, diff√©rentes choses se produisent.  Et nous ne voulons pas qu'ils commencent √† se produire si aucun profil n'a √©t√© d√©fini. </li><li>  L'√©couteur fonctionne √† la toute fin lorsque le contexte est r√©solu.  Et le fait qu'il n'y ait pas de profil, nous le savons bien plus t√¥t.  Pourquoi attendre ces cinq minutes conditionnelles jusqu'√† ce que le service augmente presque, puis tout tombe. </li></ul><br><p>  De plus, je ne sais toujours pas quels bugs vont appara√Ætre du fait que nous avons commenc√© √† monter sans profil (supposons que je ne connais pas la logique m√©tier).  Par cons√©quent, en l'absence de profil, vous devez faire tomber le contexte √† un stade tr√®s pr√©coce.  Soit dit en passant, si vous utilisez n'importe quel Spring Cloud, cela devient encore plus pertinent pour vous, car l'application fait beaucoup de choses √† un stade pr√©coce. </p><br><p>  Pour impl√©menter la nouvelle exigence, il existe <code>ApplicationContextInitializer</code> .  C'est une autre interface qui nous permet d'√©tendre un certain point de Spring en le sp√©cifiant dans spring.factories. </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/889/f21/a3b/889f21a3bee67ede3394d3c52b02e96d.png"><br></p><br><p>  Nous impl√©mentons cette interface, et nous avons un initialiseur de contexte, qui a un <code>ConfigurableApplicationContext</code> : </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ProfileCheckAppInitializer</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ApplicationContextInitializer</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ConfigurableApplicationContext</span></span></span><span class="hljs-class">&gt; </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">initialize</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ConfigurableApplicationContext applicationContext)</span></span></span><span class="hljs-function"> </span></span>{ } }</code> </pre> <br><p>  Avec cela, nous pouvons obtenir l'environnement - la chose que SpringApplication a pr√©par√©e pour nous.  Tous les biens que nous lui avons transmis sont arriv√©s.  Entre autres, ils contiennent √©galement des profils. </p><br><p>  S'il n'y a pas de profils l√†-bas, alors nous devrions lever une exception en disant que vous ne pouvez pas travailler comme √ßa. </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ProfileCheckAppInitializer</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ApplicationContextInitializer</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ConfigurableApplicationContext</span></span></span><span class="hljs-class">&gt; </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">initialize</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ConfigurableApplicationContext applicationContext)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> applicationContext.getEnvironment().getActiveProfiles().length == <span class="hljs-number"><span class="hljs-number">0</span></span> {     <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> RuntimeException(<span class="hljs-string"><span class="hljs-string">"  !"</span></span>);   } } }</code> </pre> <br><p>  Vous devez maintenant enregistrer ces informations dans spring.factories. </p><br><pre> <code class="java hljs">org.springframework.boot.context.properties.EnableConfigurationProperties=com.ironbank.moneyraven.starter.IronConfiguration org.springframework.context.ApplicationContextInitializer=com.ironbank.moneyraven.starter.ProfileCheckAppInitializer</code> </pre> <br><p>  D'apr√®s ce qui pr√©c√®de, vous pouvez deviner que <code>ApplicationContextInitializer</code> est un point d'extension.  <code>ApplicationContextInitializer</code> fonctionne lorsque le contexte commence tout juste √† √™tre cr√©√©, il n'y a pas encore de bacs. </p><br><p>  La question se pose: si nous avons √©crit <code>ApplicationContextInitializer</code> , pourquoi ne devrait-il pas, en tant qu'auditeur, √™tre √©crit dans une configuration qui s'√©tire quand m√™me?  La r√©ponse est simple: car cela devrait fonctionner beaucoup plus t√¥t lorsqu'il n'y a pas de contexte et pas de configurations.  C'est-√†-dire  il ne peut pas encore √™tre inject√©.  Par cons√©quent, nous le prescrivons comme une pi√®ce distincte. </p><br><p>  Une tentative de lancement a montr√© que tout √©tait tomb√© assez vite et a indiqu√© que nous partions sans profil.  Essayons maintenant de sp√©cifier un profil, et tout fonctionne - le corbeau est envoy√©. </p><br><p>  <code>ApplicationContextInitializer</code> - se remplit lorsque le contexte a d√©j√† √©t√© cr√©√©, mais qu'il n'y a rien d'autre √† part l'environnement. </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/4ee/fb1/3e5/4eefb13e5b1e2f8f04c19e22f58062a8.png"><br></p><br><p>  Qui cr√©e l'environnement?  Carlson - <code>SpringBootApplication</code> .  Il le remplit de diverses m√©ta-informations, qui peuvent ensuite √™tre sorties de leur contexte.  La plupart des choses peuvent √™tre inject√©es via <code>@value</code> , quelque chose peut √™tre obtenu de l'environnement, car nous venons de recevoir des profils. </p><br><p>  Par exemple, diff√©rentes propri√©t√©s viennent ici: </p><br><ul><li>  que Spring Boot peut construire; </li><li>  qui au d√©marrage sont transmises via la ligne de commande; </li><li>  syst√©mique; </li><li>  √©nonc√©es comme variables d'environnement; </li><li>  prescrit dans les propri√©t√©s d'application; </li><li>  enregistr√© dans d'autres fichiers de propri√©t√©s. </li></ul><br><p>  Tout cela est collect√© et plac√© dans un objet d'environnement.  Il contient √©galement des informations sur les profils actifs.  L'objet d'environnement est la seule chose qui existe au moment o√π Spring Boot commence √† cr√©er le contexte. </p><br><p>  J'aimerais deviner automatiquement quel sera le profil si les gens oublient de le demander de leurs mains (nous faisons tout pour que les employ√©s de banque qui sont assez impuissants sans programmeurs puissent lancer l'application pour que tout fonctionne pour eux, quoi qu'il arrive).  Pour ce faire, nous ajouterons √† notre entr√©e une chose qui devinera le profil - <code></code> ou pas - en fonction de la temp√©rature dans la rue.  Et une autre nouvelle interface magique nous aidera tous avec cela - <code>EnvironmentPostProcessor</code> , car nous devons le faire avant que <code>ApplicationContextInitializer</code> fonctionne.  Et avant <code>ApplicationContextInitializer</code> il n'y a que <code>EnvironmentPostProcessor</code> . </p><br><p>  Nous impl√©mentons √† nouveau une nouvelle interface.  Il n'y a qu'une seule m√©thode, qui de la m√™me mani√®re que <code>ConfigurableEnvironment</code> lance dans <code>SpringApplication</code> , car nous n'avons pas encore <code>ConfigurableContext</code> (il existe d√©j√† dans <code>SpringInitializer</code> il n'est pas ici; il n'y a que l'environnement). </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ResolveProfileEnvironmentPostProcessor</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">EnvironmentPostProcessor</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">postProcessEnvironment</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ConfigurableEnvironment environment, SpringApplication application)</span></span></span><span class="hljs-function"> </span></span>{ } }</code> </pre> <br><p>  Dans cet environnement, nous pouvons d√©finir le profil.  Mais vous devez d'abord v√©rifier que personne ne l'a install√© auparavant.  Par cons√©quent, nous devons <code>getActiveProfiles</code> v√©rifier <code>getActiveProfiles</code> .  Si les gens savent ce qu'ils font et cr√©ent un profil, nous n'essaierons pas de deviner pour eux.  Mais s'il n'y a pas de profil, nous essaierons de comprendre par la m√©t√©o. </p><br><p>  Et le second - nous devons comprendre si nous avons un temps d'hiver ou d'√©t√© maintenant.  Nous reviendrons la temp√©rature de <code>-300</code> . </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ResolveProfileEnvironmentPostProcessor</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">EnvironmentPostProcessor</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">postProcessEnvironment</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ConfigurableEnvironment environment, SpringApplication application)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (environment.getActivePrifiles().length == <span class="hljs-number"><span class="hljs-number">0</span></span> &amp;&amp; getTemperature() &lt; -<span class="hljs-number"><span class="hljs-number">272</span></span>) {   } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getTemperature</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> -<span class="hljs-number"><span class="hljs-number">300</span></span>; } }</code> </pre> <br><p>  Dans cette condition, nous avons l'hiver et nous pouvons √©tablir un nouveau profil.  Nous nous souvenons que le profil s'appelle <code></code> : </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ResolveProfileEnvironmentPostProcessor</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">EnvironmentPostProcessor</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">postProcessEnvironment</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ConfigurableEnvironment environment, SpringApplication application)</span></span></span><span class="hljs-function"> </span></span>{   <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (environment.getActivePrifiles().length == <span class="hljs-number"><span class="hljs-number">0</span></span> &amp;&amp; getTemperature() &lt; -<span class="hljs-number"><span class="hljs-number">272</span></span>) { environment.setActiveProfiles(<span class="hljs-string"><span class="hljs-string">""</span></span>);   } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { environment.setActiveProfiles(<span class="hljs-string"><span class="hljs-string">""</span></span>);   } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getTemperature</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> -<span class="hljs-number"><span class="hljs-number">300</span></span>; } }</code> </pre> <br><p>  Maintenant, nous devons sp√©cifier le <code>EnvironmentPostProcessor</code> dans spring.factories. </p><br><pre> <code class="java hljs">org.springframework.boot.context.properties.EnableConfigurationProperties=com.ironbank.moneyraven.starter.IronConfiguration org.springframework.context.ApplicationContextInitializer=com.ironbank.moneyraven.starter.ProfileCheckAppInitializer org.springframework.boot.env.EnvironmentPostProcessor=com.ironbank.moneyraven.starter.ResolveProfileEnvironmentPostProcessor</code> </pre> <br><p>  En cons√©quence, l'application d√©marre sans profil, nous disons que c'est de la production et v√©rifions dans quel profil elle a commenc√© avec nous.  Par magie, nous avons r√©alis√© que notre profil est l' <code></code> .  Et l'application n'est pas tomb√©e, car l' <code>ApplicationContextInitializer</code> , qui v√©rifie s'il y a un profil, vient ensuite. <br>  Le r√©sultat: </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ResolveProfileEnvironmentPostProcessor</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">EnvironmentPostProcessor</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">postProcessEnvironment</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ConfigurableEnvironment environment, SpringApplication application)</span></span></span><span class="hljs-function"> </span></span>{   <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (getTemperature() &lt; -<span class="hljs-number"><span class="hljs-number">272</span></span>) {     environment.setActiveProfiles(<span class="hljs-string"><span class="hljs-string">""</span></span>);   } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> {     environment.setActiveProfiles(<span class="hljs-string"><span class="hljs-string">""</span></span>);   } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getTemperature</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{   <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> -<span class="hljs-number"><span class="hljs-number">300</span></span>; } }</code> </pre> <br><p>  Nous avons parl√© de <code>EnvironmentPostProcessor</code> , qui s'ex√©cute avant <code>ApplicationContextInitializer</code> .  Mais qui l'ex√©cute? </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/fd0/20e/e9e/fd020ee9edd65a1e41e62e0ebe689658.png"><br></p><br><p>  Ce monstre le d√©marre, qui, apparemment, est le fils ill√©gitime d' <code>ApplicationListener</code> et <code>EnvironmentPostProcessor</code> , car il est h√©rit√© √† la fois d' <code>ApplicationListener</code> et d' <code>EnvironmentPostProcessor</code> .  Il s'appelle <code>ConfigFileApplicationListener</code> (pourquoi "ConfigFile" - personne ne sait). </p><br><p>  Lui est notre Carlson, c'est-√†-dire  Spring Application fournit un environnement pr√©par√© pour √©couter deux √©v√©nements: <code>ApplicationPreparedEvent</code> et <code>ApplicationEnvironmentPreparedEvent</code> .  Nous n'analyserons pas maintenant qui lance ces √©v√©nements.  Il existe une autre couche (√† mon avis, elle est d√©j√† compl√®tement superflue, au moins √† ce stade du d√©veloppement de Spring), qui d√©clenche un √©v√©nement que l'environnement commence √† √™tre cr√©√© (Application.yml, les propri√©t√©s, les variables d'environnement sont analys√©es, etc. ) <br>  Apr√®s avoir re√ßu <code>ApplicationEnvironmentPreparedEvent</code> , l'auditeur comprend que vous devez configurer l'environnement - recherchez tous les <code>EnvironmentPostProcessor</code> et laissez-les fonctionner. </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/cd3/8c4/3b8/cd38c43b8a10c9867cc9b3ebcb3ee1e9.png"><br></p><br><p>  Apr√®s cela, il dit √† <code>SpringFactoriesLoader</code> de livrer tout ce que vous avez command√©, √† savoir tous les <code>EnvironmentPostProcessor</code> , √† spring.factories.  Il place ensuite l'ensemble du <code>EnvironmentPostProcessor</code> dans une seule liste. </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/9b0/e39/f0f/9b0e39f0fe2514c22cfdc03af4b3f464.png"><br></p><br><p>  et comprend que lui aussi est un <code>EnvironmentPostProcessor</code> (simultan√©ment), il se pousse donc l√†-bas, <br><img src="https://habrastorage.org/getpro/habr/post_images/0f9/bf0/d30/0f9bf0d30e0065e707c813101aa173d9.png"><br>  en m√™me temps, il les trie, les accompagne et appelle chaque m√©thode <code>postProcessEnvironment</code> . </p><br><p>  De cette fa√ßon, tous les <code>postProcessEnvironment</code> sont d√©marr√©s √† un stade pr√©coce avant <code>SpringApplicationInitializer</code> .  Dans ce cas, un <code>EnvironmentPostProcessor</code> incompr√©hensible appel√© <code>ConfigFileApplicationListener</code> d√©marre √©galement. </p><br><p>  Une fois l'environnement mis en place, tout revient √† Carlson. </p><br><p>  Si l'environnement est pr√™t, vous pouvez cr√©er un contexte.  Et Carlson commence √† cr√©er du contexte avec <code>ApplicationInitializer</code> .  Ici, nous avons notre propre morceau, qui v√©rifie que dans le contexte il y a un environnement dans lequel il y a des profils actifs.  Sinon, nous tombons, car sinon nous aurons encore des probl√®mes plus tard.  Ensuite, les d√©marreurs fonctionnent, avec toutes les configurations habituelles d√©j√†. </p><br><p>  L'image ci-dessus refl√®te que le printemps ne va pas bien non plus.  Ces √©trangers s'y rencontrent p√©riodiquement, la responsabilit√© unique n'est pas respect√©e et vous devez monter avec pr√©caution. </p><br><p>  Maintenant, nous voulons parler un peu de l'autre c√¥t√© de cette √©trange cr√©ature, qui est √† l'√©coute d'un c√¥t√© et <code>EnvironmentPostProcessor</code> de l'autre. </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/ffc/200/bf0/ffc200bf085fd822e7fd1fdf6d9e8fec.png"><br></p><br><p>  Comme <code>EnvironmentPostProcessor</code> il peut charger application.yml, les propri√©t√©s d'application, toutes sortes de variables d'environnement, les arguments de commande, etc.  Et en tant qu'auditeur, il peut √©couter deux √©v√©nements: </p><br><ul><li> <code>ApplicationPreparedEvent</code> </li> <li> <code>ApplicationEnvironmentPreparedEvent</code> </li> </ul><br><p>  La question est: </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/452/851/6fc/4528516fcdf7fa9038e8ae80d2a8ac9a.png"><br></p><br><p>  Tous ces √©v√©nements ont eu lieu dans l'ancien printemps.  Et ceux dont nous avons parl√© ci-dessus sont des √©v√©nements de Spring Boot (√©v√©nements sp√©ciaux qu'il a ajout√©s pour son cycle de vie).  Et il y en a plein.  Ce sont les principaux: </p><br><ul><li> <code>ApplicationStartingEvent</code> </li> <li> <code>ApplicationEnvironmentPreparedEvent</code> </li> <li> <code>ApplicationPreparedEvent</code> </li> <li> <code>ContextRefreshedEvent</code> </li> <li> <code>EmbeddedServletContainerInitializedEvent</code> </li> <li> <code>ApplicationReadyEvent</code> </li> <li> <code>ApplicationFailedEvent</code> </li> </ul><br><p>  Cette liste est loin d'√™tre tout.  Mais il est important que certains d'entre eux soient li√©s √† Spring Boot et une partie √† Spring (bon vieux <code>ContextRefreshedEvent</code> , etc.). </p><br><p>  La mise en garde est que tous ces √©v√©nements ne peuvent pas √™tre re√ßus dans l'application (les simples mortels - diff√©rentes grand-m√®res - ne peuvent pas simplement √©couter les √©v√©nements complexes que Spring Boot lance).  Mais si vous connaissez les m√©canismes secrets de spring.factories et d√©finissez votre √©couteur d'application au niveau de spring.factories, alors ces √©v√©nements d√®s la premi√®re √©tape du d√©marrage de l'application vous parviennent. </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/54f/14e/bca/54f14ebca5de6e029b3b47dc50f8c7e2.png"><br></p><br><p>  Par cons√©quent, vous pouvez influencer le d√©marrage de votre demande √† un stade assez pr√©coce.  La plaisanterie, cependant, est qu'une partie de ce travail est effectu√©e dans d'autres entit√©s - telles que <code>EnvironmentPostProcessor</code> et <code>ApplicationContextInitializer</code> . </p><br><p>  Vous pourriez tout faire sur les auditeurs, mais ce serait g√™nant et moche.  Si vous souhaitez √©couter tous les √©v√©nements que Spring lance, et pas seulement <code>ContextRefreshedEvent</code> et <code>ContextStartedEvent</code> , vous n'avez pas besoin de d√©finir l'√©couteur, comme un bean, de la mani√®re habituelle (sinon il est cr√©√© trop tard).  Il doit √©galement √™tre enregistr√© via spring.factories, puis il sera cr√©√© beaucoup plus t√¥t. </p><br><p>  Soit dit en passant, lorsque nous avons examin√© cette liste, il n'√©tait pas clair pour nous quand <code>ContextStartedEvent</code> et <code>ContextStoppedEvent</code> d√©clench√©s. </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/796/e78/7ca/796e787ca88d7271898b4072c03d3691.png"><br></p><br><p>  Il s'est av√©r√© que ces √©v√©nements ne fonctionnent jamais du tout.  Nous nous sommes longtemps interrog√©s sur les √©v√©nements √† intercepter pour comprendre que l'application avait vraiment d√©marr√©.  Et il s'est av√©r√© que les √©v√©nements dont nous parlions apparaissent maintenant lorsque vous extrayez avec force des m√©thodes du contexte: </p><br><ul><li> <code>ctx.start();</code>  -&gt; <code>ContextStartedEvent</code> </li><li> <code>ctx.stop();</code>  -&gt; <code>ContextStoppedEvent</code> </li></ul><br><p>  C'est-√†-dire  <code>SpringApplication.run</code> ne <code>SpringApplication.run</code> que si nous <code>SpringApplication.run</code> , obtenons le contexte, en tirons <code>ctx.start();</code>  ou <code>ctx.stop();</code>  .  Il n'est pas tr√®s clair pourquoi cela est n√©cessaire.  Mais, encore une fois, ils vous ont donn√© un point d'extension. </p><br><p>  Le printemps a-t-il quelque chose √† voir avec cela?  Si oui, quelque part il devrait y avoir une exception: </p><br><ul><li> <code>ctx.stop();</code>  (1) </li><li> <code>ctx.start();</code>  (2) </li><li> <code>ctx.close();</code>  (3) </li><li> <code>ctx.start();</code>  (4) </li></ul><br><p>  En fait, ce sera sur la derni√®re ligne, car apr√®s <code>ctx.close();</code>  rien ne peut √™tre fait avec le contexte.  Mais appelez <code>ctx.stop();</code>  avant <code>ctx.start();</code>  - vous pouvez (Spring ignore simplement ces √©v√©nements - ils sont juste pour vous). </p><br><p>  √âcrivez √† vos auditeurs, √©coutez-vous, <code>ctx.stop();</code> vos lois, que faire sur <code>ctx.stop();</code>  , et que faire sur <code>ctx.start();</code>  . </p><br><p>  Au total, le diagramme d'interaction et de cycle de vie de l'application ressemble √† ceci: </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/f05/25b/6b5/f0525b6b5742a9a7969a17465b174a4f.png"><br></p><br><p>  Les couleurs ici montrent diff√©rentes p√©riodes de la vie. </p><br><ul><li>  Blue is Spring Boot, l'application a d√©j√† d√©marr√©.  Cela signifie que les demandes de service Tomcat qui lui parviennent des clients sont trait√©es, tout le contexte est d√©finitivement lev√©, tous les beans fonctionnent, les bases de donn√©es sont connect√©es, etc. </li><li>  Vert - un √©v√©nement <code>ContextRefreshedEvent</code> arriv√© et le contexte est cr√©√©.  √Ä partir de ce moment, par exemple, les √©couteurs d'application commencent √† fonctionner, que vous impl√©mentez soit en d√©finissant l'annotation ApplicationListener, soit via l'interface √©ponyme avec un g√©n√©rique qui √©coute certains √©v√©nements.  Si vous souhaitez recevoir plus d'√©v√©nements, vous devez √©crire le m√™me ApplicationListener dans spring.factories (le Spring habituel fonctionne ici).  Une barre indique o√π commence le rapport <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Spring Ripper</a> . </li><li>  √Ä un stade ant√©rieur, SpringApplication fonctionne, ce qui pr√©pare le contexte pour nous.  C'est le travail de pr√©paration de l'application que nous avons fait lorsque nous √©tions des d√©veloppeurs Spring r√©guliers.  Par exemple, WebXML configur√©. </li><li>  Mais il y a des √©tapes encore plus anciennes.  Il montre qui, o√π et pour qui cela fonctionne. </li><li>  Il y a encore une √©tape grise dans laquelle il est impossible de se caler en aucune fa√ßon.  Il s'agit de l'√©tape √† laquelle SpringApplication sort de la bo√Æte (entrez uniquement dans le code). </li></ul><br><p>  Si vous avez remarqu√©, lors du rapport en deux parties, nous sommes all√©s de droite √† gauche: nous sommes partis de la toute fin, avons viss√© la configuration qui volait du d√©marreur, puis avons ajout√© ce qui suit, etc.  Parlons maintenant rapidement de toute la cha√Æne dans la direction oppos√©e. <br>  Vous √©crivez dans votre <code>SpringApplication.run</code> principal.  Il trouve diff√©rents auditeurs, leur lance un √©v√©nement qu'il a commenc√© √† construire.  Apr√®s cela, les √©couteurs trouvent <code>EnvironmentPostProcessor</code> , laissez-les configurer l'environnement.  Une fois l'environnement mis en place, nous commen√ßons √† construire le contexte (Carlson entre).  Carlson cr√©e le contexte et permet √† tous les initialiseurs d'application de faire quelque chose avec ce contexte.  Nous avons un point d'extension.  Apr√®s cela, le contexte est d√©j√† configur√© et la m√™me chose commence √† se produire que dans l'application Spring habituelle, lorsque le contexte est cr√©√© - <code>BeanFactoryPostProcessor</code> , <code>BeanPostProcessor</code> , les beans sont configur√©s.  C'est ce que fait le printemps ordinaire. </p><br><h2>  Comment courir </h2><br><p>  Nous avons termin√© de discuter du processus de r√©daction d'une demande. </p><br><p>  Mais nous avions encore une chose que les d√©veloppeurs n'aiment pas.  Ils n'aiment pas penser comment, finalement, leur demande va commencer.  L'administrateur l'ex√©cutera-t-il dans Tomcat, JBoss ou dans WebLogic?  Il faut juste que √ßa marche.  Si cela ne fonctionne pas, dans le pire des cas, le d√©veloppeur devra √† nouveau configurer quelque chose </p><br><p>  Quelles sont donc nos m√©thodes de lancement? </p><br><ul><li>  guerre tomcat; </li><li>  id√©e; </li><li>  <code>java -jar/war</code> . </li></ul><br><p>  Tomcat n'est pas une tendance de masse, nous n'en parlerons pas en d√©tail. </p><br><p>  L'id√©e est √©galement, en principe, peu int√©ressante.  C'est juste un peu plus compliqu√© que je ne le dirai ci-dessous.  Mais dans Idea, en principe, il ne devrait pas y avoir de probl√®mes.  Elle voit quel genre de d√©pendances le d√©marreur apportera. <br>  Si nous utilisons <code>java -jar</code> , le principal probl√®me est de cr√©er un chemin de classe avant de lancer l'application. </p><br><p>  Qu'ont fait les gens en 2001?  Ils ont √©crit <code>java -jar</code> quel pot doit √™tre ex√©cut√©, puis un espace, <code>classpath=...</code> et les scripts y ont √©t√© indiqu√©s.  Dans notre cas, il y a 150 Mo de diverses d√©pendances ajout√©es par les d√©marreurs.  Et tout cela devrait √™tre fait manuellement.  Naturellement, personne ne fait √ßa.  Nous √©crivons simplement: <code>java -jar</code> , quel pot doit √™tre ex√©cut√© et c'est tout.  D'une mani√®re ou d'une autre, le chemin de classe est toujours en cours de construction.  Nous en parlerons maintenant. </p><br><p>  Commen√ßons par la pr√©paration du fichier jar afin qu'il puisse m√™me √™tre lanc√© sans Tomcat.  Avant de cr√©er <code>java -jar</code> , vous devez cr√©er un bocal.  Ce pot devrait √©videmment √™tre inhabituel, une sorte d'analogue de guerre, o√π tout sera √† l'int√©rieur, y compris le Tomcat int√©gr√©. </p><br><pre> <code class="java hljs">&lt;build&gt; &lt;plugins&gt;    &lt;plugin&gt;       &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;       &lt;artifactId&gt;spring-boot-maven-plugin&lt;/artifactId&gt;    &lt;/plugin&gt; &lt;/plugins&gt; &lt;/build&gt;</code> </pre> <br><p>  Lorsque nous avons t√©l√©charg√© le projet, quelqu'un a d√©j√† enregistr√© un plug-in dans notre POM.  Ici, en passant, vous pouvez lancer des configurations, mais plus √† ce sujet plus tard.     jar,   Maven  Gradle  ,   jar .      : </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/877/aad/b8e/877aadb8e0edbfbe6df10853b8c3f0c9.png"><br></p><br><p>     : </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/5ea/499/a35/5ea499a35d217fca525c27d7c8d2cfd3.png"><br></p><br><p>     war-. </p><br><p> ,     . </p><br><p>     ,    jar.    <code>java -jar</code> ,   ,    , , <code>org.springframework.boot</code> .      .     org.springframework.boot package.         <code>META-INF</code> </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/5a0/6c7/31e/5a06c731e6b958d02f683de73b2c5a9c.png"><br></p><br><p> Spring Boot   MANIFEST (    Maven  Gradle),     main class,    jar-. </p><br><p>  ,  jar-    :     -,    main-.     <code>java -jar</code>   -jar,   ,   main-class-. </p><br><p>  ,   ,        MANIFEST,  main-class   ,    main (    Idea).     ,     .     class path?    <code>java -jar</code>  ,  main,   , ‚Äî    main,     .    MANIFEST      JarLauncher. </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/496/8b5/f76/4968b5f76b6ece2fc7431dbc6195d14e.png"><br></p><br><p>  C'est-√†-dire     ,     ,    JarLauncher.    ,    main,     class path. <br>    ,    main?   property ‚Äî <code>Start-class</code> . </p><br><p>  C'est-√†-dire       .     class path  jar. ,    ‚Äî <code>org.springframework.boot</code> ‚Äî   class path.      <code>org.springframework.boot.loader.JarLauncher</code>  main-class.   , main-class  .   class path,    <code>BOOT-INF</code> (   lib     class  ,      ). </p><br><p>    RavenApplication, properties   class  <code>BOOT-INF</code> ,   ,  Tomcat  ,   <code>BOOT-INF/lib/</code> .  JarLauncher  classpath,     ‚Äî  ,    <code>start-class</code> .     Spring, <code>ContextSpringApplication</code> ‚Äî   flow,     . </p><br><p>   ,   start-class-?    ,     .      ,  . </p><br><p> ,     .     property,   <code>mainClass</code> ,   MANIFEST   <code>Start-Class</code> ,  <code>mainClass</code> ‚Äî   JarLauncher. </p><br><p>      ,   mainClass,   ?     . Spring boot plugin   ‚Äì  mainClass: </p><br><ul><li>     ‚Äì    .     ‚Äî     main class; </li><li>    ‚Äì ,   mainClass   <code>@SpringBootApplication</code>   , , ,  ; </li><li>    ‚Äî  exception   ,    main class,  ,     jar-  .  C'est-√†-dire    ,  ,   . ,   ,     main class. </li><li>  @SpringBootApplication  ‚Äî   . </li></ul><br><p> JarLauncher   .   Tomcat     WarLauncher,      war-  ,  jar-. </p><br><p>    ,     <code>java -jar</code> .   ?  Tu peux.   . </p><br><pre> <code class="java hljs">&lt;build&gt; &lt;plugins&gt;    &lt;plugin&gt;       &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;       &lt;artifactId&gt;spring-boot-maven-plugin&lt;/artifactId&gt;       &lt;configuration&gt;          &lt;executable&gt;<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>&lt;/executable&gt;       &lt;/configuration&gt;    &lt;/plugin&gt; &lt;/plugins&gt; &lt;/build&gt;</code> </pre> <br><p>     <code>&lt;configuration&gt;</code>    <code>&lt;executable&gt;true&lt;/executable&gt;</code>    Gradle  ,  : </p><br><pre> <code class="java hljs">springBoot { executable = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span> }</code> </pre> <br><p>      jar   executable jar.       . </p><br><p>  ,    .   Windows ,     exe-,   .       Spring Boot, ..   jar,    .      ,    . <br>   ? </p><br><p>      (jar ‚Äî  zip-,     ): </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/355/f0a/08d/355f0a08d8a971a533cd824c84939827.png"><br></p><br><p> Spring Boot  - . </p><br><p>  -,   jar-.   ,      ,     ‚Äî <code>#!/bin/bash</code> .     . </p><br><p>       .   <code>exit 0</code>   -  ‚Äî      zip-. </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/365/674/922/365674922651752dc5a5896f48764d8e.png"><br></p><br><p>   ,   zip-    ‚Äî <code>0xf4ra</code> .     ,  ,    . </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/60e/915/263/60e915263d6af6d19a5f0a7df977ee82.png"><br></p><br><p>       (,   ..). </p><br><p>  jar    : </p><br><ul><li>     ‚Äî     ; </li><li>  ,    "   bash" ( <code>#!/bin/bash</code> ); </li><li> bash   ; </li><li>      <code>exit 0</code> ; </li><li>    <code>java -jar</code>   ‚Äî     jar-,   ; </li><li>  <code>java -jar</code>  zip-   jar-,  ,    ,       . </li></ul><br><h2>  Conclusions </h2><br><p>         ,  Spring Boot ‚Äî   ,     ,     . </p><br><p> -,  .  ,    Spring,   Spring ‚Äî      Spring Boot.    ,         ,        ‚Äî , ,   ,     . ,  ,     Spring, Spring Boot  . </p><br><p> -,    <code>@SpringBootApplication</code> ,     best practice,     Spring-. </p><br><p>   ‚Äî   ,     ,   .    property  environment variable,    var arg   ,       ,    JSON.            <code>@value</code>       ,    .  configuration properties ,     ,     ,       .  ,  Spring     .   ,     ,      . </p><br><p>  .      ,    .          Spring,  Spring Boot    .    - ,   ,  ,           . </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/dc9/832/498/dc983249828e3fd26a257f871e46409e.png"><br></p><br><blockquote>  Minute de publicit√©. 19-20    Joker 2018,            <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">¬´          [Joker Edition]¬ª</a> ,         <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">¬´Micronaut vs Spring Boot,     ?¬ª</a>  .  ,  Joker       <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="> </a> .     <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="> </a> . </blockquote></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr425333/">https://habr.com/ru/post/fr425333/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr425323/index.html">"Trou de lapin." Designer UX dans l'√©quipe produit</a></li>
<li><a href="../fr425325/index.html">Interpr√®tes DIY Bytecode</a></li>
<li><a href="../fr425327/index.html">Programmation fonctionnelle: mesure sept fois, coupe une fois</a></li>
<li><a href="../fr425329/index.html">Quelques conseils aux mill√©niaux des "oldies". Comment r√©ussir dans notre monde num√©rique</a></li>
<li><a href="../fr425331/index.html">Alice aidera les d√©veloppeurs √† trouver des objets dans les demandes des utilisateurs. NER dans les dialogues</a></li>
<li><a href="../fr425335/index.html">Armada Garmin invaincu</a></li>
<li><a href="../fr425337/index.html">Comment faire √©voluer Scrum - quelques mots sur le cadre de d√©veloppement agile Nexus</a></li>
<li><a href="../fr425339/index.html">Architecture de l'information Internet, partie 2</a></li>
<li><a href="../fr425341/index.html">Pr√©sentation de ¬´Top 3D Expo. √âducation num√©rique 2018 ¬ª</a></li>
<li><a href="../fr425343/index.html">25 outils Kubernetes utiles: d√©ploiement et gestion</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>