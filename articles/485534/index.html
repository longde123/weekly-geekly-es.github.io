<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üéß üî£ üìπ HighLoad ++, Mikhail Makurov (Intersvyaz): experiencia en la creaci√≥n de un servicio Zabbix de respaldo y agrupado üí® ü§ô üë±üèø</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Zabbix es un popular sistema de monitoreo abierto utilizado por una gran cantidad de empresas. Hablar√© sobre la experiencia de crear un cl√∫ster de mon...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>HighLoad ++, Mikhail Makurov (Intersvyaz): experiencia en la creaci√≥n de un servicio Zabbix de respaldo y agrupado</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/ua-hosting/blog/485534/">  Zabbix es un popular sistema de monitoreo abierto utilizado por una gran cantidad de empresas.  Hablar√© sobre la experiencia de crear un cl√∫ster de monitoreo. <br><br>  En el informe, menciono brevemente los cambios realizados anteriormente (parches), que ampl√≠an significativamente las capacidades del sistema y preparan la base para el cl√∫ster (cargando el historial a "Clickhouse", sondeo as√≠ncrono).  Y considerar√© en detalle los problemas que surgieron durante la agrupaci√≥n del sistema: resoluci√≥n de conflictos de identidad en la base de datos, un poco sobre el teorema CAP y el monitoreo con bases de datos distribuidas, sobre los matices de Zabbix trabajando en modo de cl√∫ster: copia de seguridad y coordinaci√≥n de servidores y servidores proxy, sobre "monitoreo de dominios" y una nueva apariencia en la arquitectura del sistema. <br><br>  Hablar√© brevemente sobre c√≥mo iniciar un cl√∫ster en casa, d√≥nde obtener las fuentes y qu√© otras adicionales.  la configuraci√≥n ser√° necesaria para el cl√∫ster. <br><br><img src="https://habrastorage.org/webt/uv/cy/1r/uvcy1rw-6ttiumnzmjuizgl4ml4.jpeg"><br><br>  HighLoad ++ Siberia 2019. Tomsk Hall.  24 de junio, 5 p.m.  Res√∫menes y <a href="https://www.highload.ru/siberia/2019/abstracts/5210">presentaci√≥n</a> .  La pr√≥xima conferencia HighLoad ++ se llevar√° a cabo los d√≠as 6 y 7 de abril de 2020 en San Petersburgo.  Detalles y entradas <a href="http://bit.ly/2sSxgBx">aqu√≠</a> . <a name="habracut"></a><br><br>  <b>Mikhaili Makurov (en adelante, MM):</b> - Trabajo para una empresa proveedora.  El proveedor se llama Intersvyaz, trabaja en la ciudad de Chelyabinsk.  Tenemos aproximadamente 1,5 millones de personas.  Y para que el proveedor trabaje, hay una gran infraestructura.  Tenemos alrededor de 70 mil equipos: interruptores, dispositivos IoT ... - mucho de todo lo que necesita ser monitoreado.  Espec√≠ficamente, este informe trata sobre el uso de Zabbix, sobre la construcci√≥n de un cl√∫ster basado en Zabbix para el monitoreo de la infraestructura. <br><br>  Tengo 12 a√±os en el proveedor.  Ahora no estoy haciendo nada t√©cnico, se trata m√°s de administrar personas.  Y esto (material t√©cnico) es en realidad mi hobby.  Desarrollar√© este tema un poco. <br><br><h3>  Problemas de monitoreo </h3><br>  Creo que tengo suerte.  Hace aproximadamente un a√±o y medio, termin√© en un proyecto que sonaba as√≠: "Necesitamos resolver algunos problemas con nuestro monitoreo".  Hered√© una zona de responsabilidad (monitoreo), que consist√≠a en un grupo de servidores, espec√≠ficamente de 21 servidores: <br><br><img src="https://habrastorage.org/webt/eu/om/mx/euommxg6onyd7rdbncwqbnrhvtc.jpeg"><br><br>  Hab√≠a 4 servidores potentes y 15 servidores proxy: todo era hardware.  Hubo algunas quejas sobre este monitoreo.  La primera es que fue mucho.  No tenemos un solo servidor con el proveedor que ocupe tanto espacio.  Esto es dinero, electricidad ... De hecho, este no es un gran problema. <br><br><img src="https://habrastorage.org/webt/ui/jf/u3/uijfu32ebg7upocsepwtvptenk4.jpeg"><br><br>  El gran problema era que el monitoreo no se manten√≠a al d√≠a con lo mucho que quer√≠amos de √©l.  Para aquellos que no han usado Zabbix de manera activa, este es un tablero que muestra la tardanza en los cheques: <br><br><img src="https://habrastorage.org/webt/ig/jd/ti/igjdtilbejkchus711uvbzzeuyo.jpeg"><br><br>  La mayor√≠a de nuestros cheques estaban en la zona roja.  Corrieron m√°s de 10 minutos m√°s lento de lo que quer√≠amos, es decir, llegaron 10 minutos tarde.  No fue muy agradable, pero a√∫n era posible vivir m√°s o menos.  El mayor problema fue este: <br><br><img src="https://habrastorage.org/webt/vf/ai/nw/vfainwua91q6pgxnj2msbx_tzle.jpeg"><br><br>  Era un sistema de monitoreo de una red en funcionamiento.  Cuando se realiz√≥ el trabajo planificado, un segmento de miles se cay√≥ en cinco interruptores.  Junto con estos interruptores, el interruptor y la supervisi√≥n quedaron en el olvido.  Cuando todo fue restaurado, dos horas m√°s tarde y la supervisi√≥n fue restaurada.  Fue dolorosamente desagradable, y esta frase deber√≠a estar en cada informe: <br><br><img src="https://habrastorage.org/webt/aw/o-/t3/awo-t3j-xbu181dyneis-q4ozjo.jpeg"><br><br><h3>  "¬°Debemos hacer algo con este proyecto!" </h3><br>  Y aqu√≠ contar√© dos historias.  Luego intentamos ir simult√°neamente de dos maneras.  Tenemos un grupo de integraci√≥n: eligi√≥ la forma de construir un sistema modular (hubo un informe muy bueno de Avito a Highload en noviembre del a√±o pasado en Mosc√∫; hablaron sobre esto): <br><br><img src="https://habrastorage.org/webt/qg/f5/nv/qgf5nvonycfltfd8vge1tbeloj8.jpeg"><br><br><h3>  Zabbix = personas + API + eficiencia </h3><br>  Los chicos de peque√±as piezas comenzaron a construir un sistema.  Y con varios entusiastas, segu√≠ trabajando en Zabbix.  Hab√≠a razones para eso.  Cuales son las razones? <br><br><ul><li>  En primer lugar, hay una API genial.  Y cuando tiene 60-70 mil elementos de monitoreo, est√° claro que todo esto funciona solo autom√°ticamente: no puede agregar tantas manos sin errores. </li><li>  Personal  Hay turnos de monitoreo en servicio que se encuentran 24/7.  Estos no son especialistas de TI, son personas de servicio.  Le mostramos al "Grafan" algunos otros sistemas, es dif√≠cil para ellos.  Hay administradores que est√°n acostumbrados a la diversidad, la conveniencia de monitorear en el propio Zabbix: plantillas, detecci√≥n autom√°tica, ¬°y eso es genial! </li><li>  Zabbix puede ser efectivo. </li></ul><br><h3>  ¬øLa base de datos SQL se ralentiza?  Una respuesta - Clickhouse </h3><br>  La primera raz√≥n era obvia.  Luego trabajamos en MySQL, y encontramos alrededor de 6-7 mil m√©tricas por segundo, vimos constantes retrasos en los discos. <br><br><img src="https://habrastorage.org/webt/kb/ke/wf/kbkewfpy7l6b2qdexbuljdwr6ia.jpeg"><br><br>  Hoy ya ha sonado 100 veces: la √∫nica respuesta es Clickhouse: <br><br><img src="https://habrastorage.org/webt/w-/lm/iw/w-lmiwpxynx-rmj4spjyv_gc1cc.jpeg"><br><br>  En la estructura de las consultas, la mayor parte de las consultas (nuestro perfil en unas pocas horas) son registros de m√©tricas.  Escribir m√©tricas en una base de datos SQL es extremadamente costoso.  Aqu√≠ apareci√≥ TimeScaleDB ... Luego tuvimos un "Clickhouse" en funcionamiento durante aproximadamente un a√±o para otras tareas (hacemos grandes datos, tenemos una gran aplicaci√≥n; en general, un proveedor ahora es un negocio de TI completo). <br><br>  Despu√©s de mirar hermosos gr√°ficos de Internet (que "Clickhouse" es cientos de veces m√°s r√°pido, que necesita muy poco espacio) y tener experiencia actual, escribimos nuestro m√≥dulo HistoryStorage para "Zabbix" para que pueda guardar los datos de "Clickhouse" directamente (es decir, no desde la exportaci√≥n de archivos, sino directamente sobre la marcha). <br><br><img src="https://habrastorage.org/webt/tp/f4/p2/tpf4p2z5jftziqwqhtdtxsb99-g.jpeg"><br><br>  Adem√°s, escribimos un m√≥dulo para el "frente".  Todos estos hermosos gr√°ficos en el panel de administraci√≥n de Zabbix se pueden construir desde Clickhouse.  Est√° claro que la API tambi√©n funciona. <br><br>  El efecto es aproximadamente el mismo: el servidor SQL como entidad dedicada no se volvi√≥ completamente, es decir, la carga cay√≥ a cero.  Lo que es m√°s notable, ya ten√≠amos un cl√∫ster dedicado "Clickhouse": cuando dimos toda nuestra carga all√≠, aument√≥ de 6 a 10 mil m√©tricas.  Los muchachos que administran dijeron: "Pero no vemos algo que haya sucedido.  ¬°No! <br><br><h3>  C√≥mo expandimos Clickhouse </h3><br>  Dir√© a√∫n m√°s: para las pruebas, intentamos cargar hasta 140-150 mil m√©tricas por segundo (ya no pudimos exprimirnos de Zabbix, luego dir√© por qu√©), y Clickhouse tampoco ve esta carga.  Es decir, es muy c√≥modo, carga fresca.  En general, existe tal m√≥dulo. <br><br>  Adem√°s, lo expandimos un poco: <br><br><img src="https://habrastorage.org/webt/_u/ha/aj/_uhaajlqcp9mcjuh-ih8sc-dn3k.jpeg"><br><br>  En nuestra versi√≥n, puede desactivar los nanosegundos.  Probablemente lo sepas: Zabbix escribe segundos y nanosegundos en dos campos.  En los campos "Clickhouse" en los que la variabilidad es muy grande, ocupe mucho espacio. <br><br>  Por cierto, sobre el lugar.  Una m√©trica en Clickhouse (ahora tenemos aproximadamente 700 mil millones de m√©tricas registradas) ocupa 2.9 bytes.  Seg√∫n la documentaci√≥n de Zabbix, una m√©trica en las bases de datos SQL toma de 40 a 100 bytes.  Apagar los nanosegundos ahorra otro 40%, es decir, aproximadamente 1,5 bytes por m√©trica.  Es decir, "Clickhouse" es muy efectivo en t√©rminos de ubicaci√≥n. <br><br>  A pedido de nuestros muchachos que se dedican al aprendizaje autom√°tico, hicimos una opci√≥n para poder escribir el host y el nombre de la m√©trica.  Dado que la variabilidad de los datos es grande, esto no ocupa mucho espacio adicional, a pesar de que los datos de texto pueden ser significativos (a√∫n no se han verificado con pruebas largas). <br><br>  Adem√°s, hicimos dos adiciones, ya que desarrollamos Zabbix y a menudo tuvimos que sacarlo.  Una adici√≥n muy interesante: al principio, ya que "Clickhouse" le permite leer millones de registros, podemos llenar el cach√© del historial.  Al principio, nos demoramos 30-40 segundos adicionales, pero recibimos un servicio lanzado de inmediato con un cach√© calentado. <br><br>  En los casos en que es m√°s f√°cil recolectar de la infraestructura, todav√≠a existe esa opci√≥n: prohibir la lectura del cach√© por alg√∫n tiempo.  Es mejor trabajar r√°pidamente durante 5 minutos, sin contar los desencadenantes, y luego el cach√© se llenar√°; si no lo hace, comienza el estancamiento de los hundidores de la historia. <br><br>  En general, hay un m√≥dulo "Clickhouse".  Se puede usar. <br><br><h3>  Eficiencia de sondeo </h3><br>  A pesar del hecho de que luego resolvimos los problemas con la base, los frenos y el problema con quince proxies a√∫n permanec√≠an.  Estaban conectados con esto: <br><br><img src="https://habrastorage.org/webt/un/ec/u8/unecu8ujsgk7scstaonbt3dueim.jpeg"><br><br>  Esta es la principal tuber√≠a de procesamiento de datos en Zabbix.  Hay una etapa de recopilaci√≥n de datos, hay un preprocesamiento y hay sincerizadores hist√≥ricos que hacen todo el trabajo (c√°lculo de disparadores, alertas, historial de guardado).  El cuello de botella del cach√© result√≥ ser: <br><br><img src="https://habrastorage.org/webt/er/jg/ei/erjgein-xwdpitoa8eql3b5dw1g.jpeg"><br><br>  ¬øPor qu√© el sondeo es lento?  Porque los subprocesos que realizan las solicitudes van a la cola en la configuraci√≥n de la memoria cach√© para las m√©tricas de la unidad y la bloquean.  Hay otros lugares, pero no son tan estrechos.  Por ejemplo, hay un preprocesamiento en s√≠ mismo y hay Historial de cach√©.  En nuestro SQL, obtuvimos las siguientes restricciones: <br><br><img src="https://habrastorage.org/webt/-w/ys/-b/-wys-btlu1uxulrqcinsvbmac5a.jpeg"><br><br>  Quiz√°s esto se deba al hecho de que en nuestro caso, la base es de aproximadamente 5 millones de m√©tricas, que eliminamos.  Con todas las optimizaciones que hicimos, pudimos obtener 70 mil m√©tricas en el cuello de botella (en la cach√© de configuraci√≥n), pero solo en el caso cuando las procesamos en masa. <br><br>  ¬øQu√© es el procesamiento a granel?  Poller va a la cach√© de configuraci√≥n y toma la tarea no para una m√©trica, sino para 4 u 8 mil.  Al mismo tiempo, obtiene otra oportunidad maravillosa: ahora puede hacer encuestas de forma asincr√≥nica, porque obtuvo 4 mil m√©tricas ... ¬øPor qu√© lo hacen una tras otra?  ¬°Puedes preguntar todo de inmediato! <br><br><h3>  ¬°El sondeo asincr√≥nico es m√°s eficiente que el proxy! </h3><br>  Para los tipos principales que usa el proveedor, estos son SNMP y AGENT, reescribimos el sondeo a modo as√≠ncrono, y de manera agregada esto aument√≥ la velocidad de 100 a 200 veces.  Ten√≠amos 15 proxies, los dividimos en 150, se hab√≠an ido por completo.  Como resultado, todo se convirti√≥ en dos bancos, que son necesarios solo para la reserva: <br><br><img src="https://habrastorage.org/webt/ax/7z/lk/ax7zlkk-yg9oafyuruz9blq7l-q.jpeg"><br><br>  Banco uniprocesador (un Xeon 1280 cuesta).  Este es el momento de dle: <br><br><img src="https://habrastorage.org/webt/zq/qf/nc/zqqfncyu4fxo38fiegvr0kunhhw.jpeg"><br><br>  Alrededor del 60% es gratuito, pero este timbre del 60% al 40% se ejecuta en secuencias de comandos peri√≥dicas en la m√°quina (secuencias de comandos externas).  Se pueden optimizar hasta que se creen problemas. <br><br>  La escala es algo como esto: <br><br><img src="https://habrastorage.org/webt/km/pa/nj/kmpanjjtpdm3660spp8haz7ypo0.jpeg"><br><br>  Estos son 62 mil hosts, aproximadamente 5 millones de m√©tricas.  Nuestra necesidad actual es de aproximadamente 20 mil m√©tricas por segundo. <br><br>  Bueno, como todo?  Resolvimos los problemas de rendimiento, la historia se expandi√≥, el sondeo es incre√≠ble.  ¬øSe resolvi√≥ el problema?  En realidad no ... Todo ser√≠a demasiado simple. <br><br>  Jugu√© un truco en el gr√°fico anterior (no todos se muestran): <br><br><img src="https://habrastorage.org/webt/ds/ag/k5/dsagk5zrh8bog_ogrq35w1uvawy.jpeg"><br><br>  Hay dos problemas  Quiero decir: "Tontos, caminos".  Hay un factor humano, hay equipos. <br><br>  Un servidor todav√≠a no es suficiente.  En aproximadamente un a√±o de funcionamiento, ha habido dos casos con problemas de hardware: una unidad SSD y algo m√°s.  La mayor√≠a de los problemas son el factor humano cuando las personas hacen alg√∫n tipo de prueba.  En nuestra empresa, Zabbix se utiliza como un servicio: todos los departamentos pueden escribir algo propio all√≠. <br><br>  Me gustar√≠a ampliar  Me gustar√≠a no depender de una lata.  Quer√≠a que pudi√©ramos seguir siendo m√°s fuertes.  Y me gustar√≠a escalar de acuerdo con el principio de escalamiento horizontal.  Incluso no hay nada que discutir aqu√≠: crecer, aumentar la capacidad de una lata, ha sido irrelevante durante 20 a√±os. <br><br><img src="https://habrastorage.org/webt/yl/hy/vn/ylhyvn7za42rcr2allqhjzlmw2i.jpeg"><br><br><h3>  El cl√∫ster solicit√≥ ... </h3><br>  En alg√∫n lugar de diciembre, apareci√≥ la primera versi√≥n.  Una unidad de cl√∫ster at√≥mico es lo que se procesa en un host separado.  El anfitri√≥n ha sido seleccionado. <br><br><img src="https://habrastorage.org/webt/9j/yo/sy/9jyosycj6yj7ecx7k5mn0esrfnu.jpeg"><br><br>  El hecho es que en Zabbix hay conexiones bastante fuertes entre los elementos que pueden estar en el mismo host, es decir, los disparadores se pueden conectar, se pueden procesar juntos en el preprocesamiento.  Pero entre los hosts la conectividad no es tan alta, por lo que es normal usar este cl√∫ster entre los nodos del cl√∫ster; habr√° mucho tr√°fico all√≠.  La tarea principal de los cl√∫steres es acordar entre ellos qui√©n participa en qu√© hosts. <br><br>  Me gustar√≠a superar nuestro l√≠mite m√°ximo de 60-70 mil m√©tricas, porque el apetito viene con la comida.  Tenemos personas que se dedican a QoE ... Calidad de experiencia: un an√°lisis de c√≥mo funciona Internet para los suscriptores en funci√≥n de las m√©tricas de tr√°nsito, es decir, usted suministra todas las m√©tricas TCP a 1,5 millones de personas, verti√©ndolas en el monitoreo: hay muchos datos. <br><br>  Y quer√≠a fiabilidad.  Lo quer√≠a si algo suced√≠a ... El oficial de turno llam√≥ y dijo: "Tenemos problemas con el servidor", lo apag√≥, lo resolveremos ma√±ana. <br><br><h3>  Primer grupo </h3><br>  La primera versi√≥n se implement√≥ en base a etcd: <br><br><img src="https://habrastorage.org/webt/oh/kr/qu/ohkrqu9wh-gldd6q6yheyoztro4.jpeg"><br><br>  Etcd es un almacenamiento distribuido de valor clave utilizado en muchos proyectos progresivos (hasta donde yo entiendo, en Kubernetes).  Todo estuvo genial.  Etcd proporciona herramientas muy interesantes, por ejemplo, resuelve el problema de elegir el servidor principal.  Pero tal problema ... <br><br>  Ten√≠amos un cl√°sico "Zabbix" de tres enlaces: "web" - la base - el servidor mismo.  Y agregamos "Clickhouse" all√≠, y ahora tambi√©n agregamos etcd.  Los administradores comenzaron a rascarse detr√°s de sus cabezas: hay demasiadas dependencias aqu√≠, probablemente no ser√° confiable.  En el proceso de desarrollo, una cosa m√°s se hizo evidente: en el propio Zabbix ya existe una forma integrada de comunicaci√≥n entre servidores, solo se usa entre el servidor y el proxy, el llamado proceso de sondeo proxy: <br><br><img src="https://habrastorage.org/webt/4x/cf/jh/4xcfjhgqaf-2h33nnzrjduw8rn8.jpeg"><br><br>  Es bastante bueno para la comunicaci√≥n entre servidores con cambios m√≠nimos.  Esto permiti√≥ que etcd no se usara (al menos temporalmente), simplificar√≠a enormemente el c√≥digo y, lo m√°s importante, trabajar√≠a en el c√≥digo que ha sido verificado (parece que este c√≥digo tiene 5 o 7 a√±os). <br><br><h3>  ¬øC√≥mo se coordinan los servidores en un cl√∫ster? </h3><br>  La coordinaci√≥n se realiza por tipo, como el protocolo IGP.  Para que los servidores tengan prioridad (ahora dir√© por qu√© esto es necesario) y para evitar conflictos en la base de datos SQL al escribir registros, a cada servidor se le asigna un identificador (hasta ahora de forma manual): este es un n√∫mero del 0 al 63 (63 - es solo una constante, tal vez m√°s): <br><br><img src="https://habrastorage.org/webt/kb/ei/xf/kbeixf3xjk6fo4oucwf9yk9yi9c.jpeg"><br><br>  El servidor con el identificador m√°ximo se convierte en el "maestro".  Cuando lanzamos nuestros primeros grupos de prueba, lo primero que dijeron nuestros administradores fue: ‚Äú¬°Guau!  Y vamos a ponerlos en diferentes sitios.  ¬°Bien, genial! ‚Äù(Volveremos a esto).  Y cuando alguien ha distribuido cl√∫steres, ser√° posible controlar c√≥mo se redistribuye la topolog√≠a: d√≥nde ir√° el papel del "maestro" en caso de una ca√≠da en el servidor principal "Zabbix": <br><br><img src="https://habrastorage.org/webt/fa/n8/nx/fan8nxkovjbepqscnyljtfbc00o.jpeg"><br><br>  En este caso, as√≠: <br><br><img src="https://habrastorage.org/webt/5l/qu/ou/5lquouk5h0tkzky-e6_m8dfdkn4.jpeg"><br><br><h3>  Pisar </h3><br>  En el Zabbix original, esto se hace as√≠: el servidor mismo es responsable de generar √≠ndices de incremento autom√°tico.  Para evitar que muchas instancias pisen los talones de la otra (para no crear registros con los mismos √≠ndices), se usa la operaci√≥n de pasos: "Zabbix" con el identificador "1" generar√° m√∫ltiplos de uno: 1, 11, 21;  con el identificador "7" - 7, 17, 27 (con matices). <br>  Manejamos con modificadores. <br><br><img src="https://habrastorage.org/webt/t3/fo/2-/t3fo2-qoqlx0zwmxds7vc_7y2pw.jpeg"><br><br><h3>  ¬øC√≥mo interact√∫an los servidores entre s√≠? </h3><br>  Este es el legado de los paquetes Hello de IGP cada 5 segundos.  Entonces los servidores saben que tienen vecinos.  Por lo tanto, el "maestro" sabe que hay vecinos cercanos, y sobre la base de esto, el "maestro" decide qu√© hosts se pueden distribuir a qu√© servidores. <br><br><img src="https://habrastorage.org/webt/um/vm/pn/umvmpn5x2hljbhbuzfp6b3umqpo.jpeg"><br><br>  En consecuencia, hay una configuraci√≥n.  Seg√∫n la memoria anterior, lo llamo topolog√≠a.  Una topolog√≠a es esencialmente una lista de servidores y hosts que les pertenecen. <br><br>  El protocolo es simple: este es JSON: <br><br><img src="https://habrastorage.org/webt/qd/xx/rz/qdxxrzw2rj3akue1h8nwcqum1cc.jpeg"><br><br>  Este es tambi√©n el legado del proxy Zabbix y la comunicaci√≥n del servidor Zabbix.  En general, no tiene sentido usar otra cosa.  Lo √∫nico es que en el caso de Zabbix hay 4 bytes (ZBXD), pero este no es el punto. <br><br>  En el paquete de saludo, el identificador del servidor se transmite: cuando el servidor env√≠a el paquete, dice su identificador y su versi√≥n de la topolog√≠a, de esta manera los servidores descubren r√°pidamente que hay una nueva versi√≥n de la topolog√≠a y se actualizan muy r√°pidamente. <br><br>  En realidad, la topolog√≠a en s√≠ misma es solo un √°rbol, una lista de servidores.  Para cada servidor, una lista de hosts que admite: <br><br><img src="https://habrastorage.org/webt/xp/dv/ec/xpdvecth8pp7eaukwxmykgysqiu.jpeg"><br><br>  Y entonces surge un problema interesante. <br><br><h3>  Existe una frase tan m√°gica: monitorear dominios </h3><br>  Cual es el punto?  En el cl√°sico Zabbix, todo era simple: una actitud inequ√≠voca: este proxy es monitoreado por este proxy, este proxy proporciona datos al servidor.  Si el proxy no se ha instalado (o no es necesario), este servidor supervisa todos los hosts: <br><br><img src="https://habrastorage.org/webt/x2/ly/fh/x2lyfh4prsystuyggxb0elwclx4.jpeg"><br><br>  Cuando tenemos muchos servidores, ¬øqu√© hacer?  Adem√°s, puede haber un problema con el hecho de que tenemos servidores distribuidos geogr√°ficamente, y el servidor en alguna oficina que trabaja lentamente en Kemerovo comenzar√° a tratar de monitorear toda la infraestructura de Novosibirsk. <br><br><img src="https://habrastorage.org/webt/ep/06/cy/ep06cyiqx3dx4kkyfer1wcgn8um.jpeg"><br><br>  No queremos esto.  Queremos tener alg√∫n tipo de mecanismo para que no todos los servidores, pero los que seleccionamos (posiblemente basados ‚Äã‚Äãen la geograf√≠a) puedan monitorear un host en particular.  Al mismo tiempo, queremos gestionar esto, y queremos que sea simple.  Para esto, se invent√≥ la idea de monitorear dominios.  De hecho, estos son grupos simples, simplemente ya hay grupos en el registro. <br>  Y cuando hice esto, los chicos de la operaci√≥n hablaron conmigo: me dijeron: ‚ÄúLos grupos nos confunden mucho.  Siempre empezamos a pensar en grupos normales ".  Por lo tanto, este nombre: monitoreo de dominios. <br><br>  Los hosts se relacionan inequ√≠vocamente: un host - un dominio: <br><br><img src="https://habrastorage.org/webt/6x/hi/z5/6xhiz5ocnajnjzoxin17log0liq.jpeg"><br><br>  El dominio del host puede incluir cualquier n√∫mero de servidores.  Los servidores pueden estar en cualquier n√∫mero de dominios.  Esto es algo muy flexible.  Para expandir la flexibilidad y romper completamente el cerebro, tambi√©n hay un dominio predeterminado: <br><br><img src="https://habrastorage.org/webt/ad/zl/2x/adzl2xgso7st_v9c7vg9-fyryvg.jpeg"><br><br>  Los servidores que son miembros del dominio predeterminado son monitoreados por todos los hosts que no tienen servidores activos o que no tienen un dominio de monitoreo. <br><br>  Esto solo nos permite vincular topol√≥gicamente los hosts a algunos servidores y controlar c√≥mo se distribuyen los hosts en caso de que un servidor se caiga: <br><br><img src="https://habrastorage.org/webt/fm/og/nr/fmognrgop74jgnsqkwtxdzddqgw.jpeg"><br><br>  El siguiente problema que encontramos ... <br><br><h3>  Cluster: Piensa diferente </h3><br>  Cuando tenemos muchos servidores, hay nuevas oportunidades para construir un cl√∫ster, para construir una topolog√≠a.  Este es un cl√°sico cuando tenemos alg√∫n tipo de sitio central y hay sitios remotos;  o, por ejemplo, un proxy donde se delega la carga: <br><br><img src="https://habrastorage.org/webt/rn/ar/qd/rnarqdcbs1knledntrvqoibsozs.jpeg"><br><br>  En el caso del cl√∫ster Zabbix, se puede implementar de dos maneras.  Puede seguir el camino cl√°sico: simplemente duplique la infraestructura.  En el centro, tenemos dos servidores que forman un cl√∫ster, pueden reorganizar los hosts o asumir la carga si el vecino se cae.  En consecuencia, puede aumentar los servidores proxy adicionales en los mismos servidores; obtenemos una doble reserva: <br><br><img src="https://habrastorage.org/webt/bx/es/g4/bxesg4ijxn4b9pirro22u3-omoa.jpeg"><br><br>  Puede usar las nuevas "caracter√≠sticas" y hacer esto: <br><br><img src="https://habrastorage.org/webt/v0/-o/ki/v0-okiiibpq1yyurxipbugjqfwq.jpeg"><br><br>  Lo principal es no ir a una situaci√≥n en la que un servidor geogr√°ficamente remoto est√© monitoreando una infraestructura grande en otro lugar.  Esto es m√°s un problema de administraci√≥n (lo llamo negocio) porque es un problema de configuraci√≥n. <br><br><h3>  Cl√∫ster: cerebro dividido y punto de vista </h3><br>       ,    : <br><br><ul><li> split brain; </li><li> point of view ( ). </li></ul><br>   . Split brain ‚Äì       ,         .     ,  -  ‚Äì     ? ,      ,            ( ). <br><br>  point of view  : ,      ,          ,    .     . ,   RTT ,    . <br>       : <br><br><img src="https://habrastorage.org/webt/ab/qa/gc/abqagc2w3ky3kufvm6omjfsjheo.jpeg"><br><br>      ,   .   ,   ,       .    ,   ‚Äì   .    ,       ,  ,  . <br><br><h3>  SQL- </h3><br> ,     ,    ,       .       .  , ,       ‚Ä¶      .    . <br><br> -,  , ,  -      ‚Äì    . , Galera  MySQL. <br><br>        PostgreSQL.    ¬´¬ª   :    ,   ,           ‚Äì   . ¬´¬ª, ,    . <br><br><h3>    ? </h3><br>        ,    : <br><br><img src="https://habrastorage.org/webt/q4/u1/4s/q4u14s11rryz7afktbdfkn0s9sy.jpeg"><br><br><img src="https://habrastorage.org/webt/pj/0p/uq/pj0puqdn9zkhsm2uwolcaw40a1w.jpeg"><br><br>           ‚Äì  .      : <br><br><ul><li>  -  (Logs),    .   problems, events  events recovery.  ,   ‚Äì   ,   . </li><li>  15   (State).  ‚Äì     (    ‚Äì   ‚Äì ¬´¬ª   ).        .   ,  ;   ‚Äì        ‚Ä¶ </li><li>  -       (Configuration update). </li></ul><br>   ¬´.    ¬´¬ª,    SQL-: <br><br><img src="https://habrastorage.org/webt/ne/if/cc/neifccswcjikrxfetvhuip-agva.jpeg"><br><br> -,       : <br><br><img src="https://habrastorage.org/webt/4f/o4/ti/4fo4ticljuykrkh6zjmop4qc5sg.jpeg"><br><br>  .          -,   ,   ‚Ä¶    ‚Äì   ,   2  !    : ¬´  ,    ¬ª.  -  ,       ,    . <br><br> .         ,           : <br><br><img src="https://habrastorage.org/webt/lj/wh/ug/ljwhugg1tdfbehcxjcrloiolwks.jpeg"><br><br>   ,  .  SQL-     .     ,   SQL-.       (   -  ),        ¬´¬ª (        ). ‚Ä¶ <br><br><h3> .  </h3><br> , , ¬´¬ª  . .       ,   ? <br><br><img src="https://habrastorage.org/webt/ci/yo/ne/ciyonezibe3bfla-7xodyyx_zwg.jpeg"><br><br>    ¬´¬ª- (. .  ¬´¬ª daemon).       (   ):   (  1  63,      ¬´¬ª)    (   ,       ). <br><br>      ServerIP  IP-.    ,      ,     IP-   . -    ,         proxy poller,    trapper  hello-,  proxy poller  . <br><br>   . ,       ,    ¬´ ¬ª: <br><br><img src="https://habrastorage.org/webt/dr/1z/pi/dr1zpi2hbe9penikzazqcycw-oa.jpeg"><br><br>      : <br><br><img src="https://habrastorage.org/webt/kf/pg/jb/kfpgjbghzsonjmsizlbcatyo3ja.jpeg"><br><br>  ,       default.       .  ‚Äì   ,     IP-,    ,      (  ).      ¬´¬ª ‚Äì   default. <br><br>  -, . <br><br><ul><li>   . </li><li> ,      : ¬´    ,    ¬ª.   . </li><li>  - ,   . </li><li>     ,    hello-time,  : ¬´   ¬ª;    . </li><li>  . </li></ul><br> ,   , ,   .               30-40 .   ,      ,    ,   . <br><br><h3>    </h3><br>            ,      .      -   : ¬´    ,  !¬ª  -! <br><br><img src="https://habrastorage.org/webt/nq/ta/ah/nqtaahv3gipyew36m8nhrmwukew.jpeg"><br><br>   ‚Äì  :  -  ,  - , ,  GitLab, CI/CD,   . , ,  ‚Äì    . <br><br>  ,      ,       ‚Äì  4.0.9  (4.2   ).   Roadmap ‚Äì        -. -,    ¬´¬ª;   ,   RPM'. <br><br><img src="https://habrastorage.org/webt/er/kn/2r/erkn2r6h9law8l3xynd6i8_jwne.jpeg"><br><br>      (   )  ¬´¬ª       ¬´¬ª-.   .         ,    .   ‚Äì   :   , -   ‚Ä¶  ? !..   ¬´¬ª,  . <br><br>        SQL-   ,    ,   . History Storage. <br><br><h3>  Referencias </h3><br>     5 .      . <br> -, ,   ,      , . .      -. <br><br><img src="https://habrastorage.org/webt/zp/3a/gr/zp3agr9epncvnjndf-hgpwt_zke.jpeg"><br><br><h3>     </h3><br> ,     ?     !  , , ,  .   -   - ,         . ,         ,        .       ,    : <br><br><img src="https://habrastorage.org/webt/ac/fo/pf/acfopfqzuwvtfvtni2n9rjx-ywy.jpeg"><br><br>  . ¬´¬ª- ,      . <br><br><ul><li>    ,         ,     , . </li><li>   ¬´¬ª  :  ,       Configuration Cache,   . </li><li>   ,           ,     .        ,    ,   . </li><li>   -    ,   .      ,    ,    .    200     ,     ‚Äì   . </li></ul><br><h3>   </h3><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nota: ¬°el proxy pasivo a√∫n no es compatible! </font></font></b> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Quit√© el c√≥digo. </font><font style="vertical-align: inherit;">Esto se debe al hecho de que es dif√≠cil para las personas crear otro mecanismo, cuyo servidor seguir√° siendo responsable de este proxy. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Los proxies activos mismos van a los servidores. </font><font style="vertical-align: inherit;">Hay una opci√≥n de servidor para esto (proxy est√°ndar). </font><font style="vertical-align: inherit;">El proxy modificado tiene la opci√≥n Servidores: </font></font><br><br><img src="https://habrastorage.org/webt/jm/ym/6t/jmym6tfhwlg_ix6o5xnnkbwphri.jpeg"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">¬øY qu√© hace un servidor modificado? </font><font style="vertical-align: inherit;">Mantiene una conexi√≥n KPI con todos los servidores especificados para ello; </font><font style="vertical-align: inherit;">pide configuraci√≥n, env√≠a datos al primer servidor disponible de la lista. </font><font style="vertical-align: inherit;">Esto resuelve el problema. </font><font style="vertical-align: inherit;">Suponga que si tiene un proxy configurado en el servidor Zabbix y el servidor Zabbix se ha ca√≠do, hay otro en el cl√∫ster para no quedarse sin proxy; </font><font style="vertical-align: inherit;">entonces el proxy simplemente se conecta a otro.</font></font><br><br><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Preguntas </font></font></h3><br>  Pregunta de la audiencia (en adelante - A): - Me gustar√≠a aclarar c√≥mo est√°n sucediendo las cosas entre los servidores.  ¬øCon qu√© protocolo se comunican?  ¬øHay alg√∫n tipo de seguridad?  Porque no es muy "seguro" llevar la comunicaci√≥n entre servidores a Internet ... ¬øC√≥mo va esto? <br><br>  <b>MM:</b> - Creo que este es un candidato para la mejor pregunta, ¬°hasta el punto!  De hecho, cuando cambiamos a la comunicaci√≥n est√°ndar, los servidores para su comunicaci√≥n entre servidores heredaron todas esas caracter√≠sticas de protocolo de comunicaci√≥n que existen entre el servidor y el proxy.  Aclarar√©: hay cifrado, compresi√≥n de datos.  Por favor, de la misma manera, todo se configura a trav√©s de la web, ya que est√° configurado de forma est√°ndar para el servidor y el proxy;  Todo funcionar√°. <br><br>  <b>R:</b> - ¬øC√≥mo trabaja Hauskiper para usted en el caso de Clickhouse? <br><br>  <b>MM:</b> - En el "Zabbix" est√°ndar no hay una interfaz del "Ama de llaves" a la Interfaz de historial, es decir, la Interfaz de historial no admite la rotaci√≥n de datos (ElasticSearch, por ejemplo, no es compatible).  Tal vez en 4.2 es (no mir√©), pero hasta ahora en 4.0.9. <br><br>  ¬°Hazlo f√°cil!  El nuevo "Clickhouse" tiene una partici√≥n.  Me gustar√≠a hacerlo desactivando particiones obsoletas.  Est√° claro que no habr√° rotaci√≥n a nivel de elementos individuales, pero hay un truco en Zabbix: puede especificar valores globales (por ejemplo, almacenar el historial completo durante no m√°s de 90 d√≠as): puede borrar todos los elementos, todo el historial de estos valores globales. .  ¬°Y se har√°!  Hay m√°s sobre este tema en Gitlab. <br><br>  Queremos hacer el derecho arquitect√≥nico: expandir la interfaz de la historia, para que b√°sicamente sea ... En general, no quiero dejar deuda t√©cnica, pero se har√°.  Debido a que es necesario, m√°s "Clickhouse" comenz√≥ a apoyar. <br><br>  <b>A:</b> - ¬øC√≥mo te sientes acerca de esto?  Resulta que usted est√° haciendo una gran cantidad de trabajo sin proveedores. <br><br>  <b>MM:</b> - Probablemente no lo puse muy correctamente.  Este es mi hobby!  Realmente no soy un especialista t√©cnico, soy un gerente.  En mi tiempo libre practico. <br><br>  <b>R:</b> - Pens√© que estabas haciendo esto como parte de tu negocio principal ... <br><br>  <b>MM:</b> - Los negocios me dan un lugar genial para probar.  De hecho, lo recomiendo: alivia el cerebro.  En alg√∫n lugar de la "cosa" administrativa dir√≠a esto, cuando puedes cambiar de problemas humanos a estos.  ¬°Est√°n tan bien resueltos!  Estos son problemas t√©cnicos.  ¬°Usted program√≥, y funciona de la manera que program√≥!  Es una pena que la gente no deba hacer eso. <br><br>  <b>R:</b> - ¬øEscribe a "Clickhouse" a trav√©s de alg√∫n proxy o directamente? <br><br>  <b>MM:</b> - Directamente.  De hecho, la interfaz de historial alterada, que se utiliza para el "Elastix", tambi√©n se hereda.  Se utiliza la url, es decir, a trav√©s de la interfaz http "Zabbiks" env√≠a "Clickhouse".  Lo que es genial, Zabbix agrega cuando hay una gran corriente de historia, miles de m√©tricas en un paquete, y esto cae muy bien en Clickhouse. <br><br>  <b>A:</b> - De hecho, ¬øescribe bachi para √©l? <br><br>  <b>MM:</b> S√≠.  Una consulta SQL ejecutada por la url generalmente contiene mil m√©tricas.  Administradores "Clickhouse" simplemente feliz. <br><br>  Presentador: - Este es el final del programa en esta sala.  Hay un programa nocturno organizado y hay algo que solo t√∫ puedes hacer.  Y le sugiero, mientras se comuniquen entre s√≠, que piensen en las cosas interesantes que pueden ... Cuando se cuentan sus casos, lo m√°s probable es que de esto puedan hablar.  Al conversar entre ellos, pueden encontrar solo un resumen: el comit√© del programa aceptar√° su solicitud, la considerar√° y ayudar√° a hacer una buena historia.  ¬øQuiz√°s tenga alg√∫n tipo de historia sobre trabajar con el comit√© del programa? <br><br>  <b>MM:</b> - En realidad, se dan muchos comentarios.  Tuve mucha suerte: una persona del comit√© del programa vive en mi Chelyabinsk, y Highload es la √∫nica conferencia que trabaja tan estrechamente con los oradores.  Nunca he visto algo as√≠ en ning√∫n otro lado.  ¬°Es muy beneficioso!  Diferentes etapas: los chicos miran el video, hacen comentarios en las diapositivas; realmente sucede en el tema (ortograf√≠a, errores tipogr√°ficos).  Muy guay!  Lo recomiendo  Pru√©balo t√∫ mismo! <br><br><iframe width="560" height="315" src="https://www.youtube.com/embed/wbIpn44Z2_8" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><h3>  Un poco de publicidad :) </h3><br>  Gracias por quedarte con nosotros.  ¬øTe gustan nuestros art√≠culos?  ¬øQuieres ver m√°s materiales interesantes?  Ap√≥yenos haciendo un pedido o recomendando a sus amigos <a href="https://ua-hosting.company/cloudvps/nl">VPS basado en la nube para desarrolladores desde $ 4.99</a> , un <b>an√°logo √∫nico de servidores de nivel b√°sico que inventamos para usted:</b> <a href="https://habr.com/company/ua-hosting/blog/347386/">toda la verdad sobre VPS (KVM) E5-2697 v3 (6 n√∫cleos) 10GB DDR4 480GB SSD 1Gbps desde $ 19 o c√≥mo dividir el servidor?</a>  (las opciones est√°n disponibles con RAID1 y RAID10, hasta 24 n√∫cleos y hasta 40GB DDR4). <br><br>  <b>Dell R730xd 2 veces m√°s barato en el centro de datos Equinix Tier IV en Amsterdam?</b>  ¬°Solo tenemos <b><a href="https://ua-hosting.company/serversnl">2 x Intel TetraDeca-Core Xeon 2x E5-2697v3 2.6GHz 14C 64GB DDR4 4x960GB SSD 1Gbps 100 TV desde $ 199</a> en los Pa√≠ses Bajos!</b>  <b><b>Dell R420 - 2x E5-2430 2.2Ghz 6C 128GB DDR3 2x960GB SSD 1Gbps 100TB - ¬°desde $ 99!</b></b>  Lea sobre <a href="https://habr.com/company/ua-hosting/blog/329618/">C√≥mo construir un edificio de infraestructura.</a>  <a href="https://habr.com/company/ua-hosting/blog/329618/">clase utilizando servidores Dell R730xd E5-2650 v4 que cuestan 9,000 euros por un centavo?</a> </div></div><p>Source: <a href="https://habr.com/ru/post/485534/">https://habr.com/ru/post/485534/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../485524/index.html">El resumen de materiales interesantes para el desarrollador m√≥vil # 330 (del 20 al 26 de enero)</a></li>
<li><a href="../485526/index.html">¬øQui√©n y por qu√© quiere hacer que Internet sea "compartida"?</a></li>
<li><a href="../485528/index.html">C√≥mo concluir un proyecto de desarrollo de software de la manera correcta</a></li>
<li><a href="../485530/index.html">Aprendizaje Guiado</a></li>
<li><a href="../485532/index.html">Gu√≠a de entrevista para aquellos programadores que no los entienden</a></li>
<li><a href="../485536/index.html">¬øEs posible hackear un avi√≥n - 2</a></li>
<li><a href="../485538/index.html">Zabbix: supervisa todo en una fila (en el ejemplo de Redis)</a></li>
<li><a href="../485542/index.html">Agregar gr√°ficos a Notion</a></li>
<li><a href="../485544/index.html">El ajedrez como sistema din√°mico.</a></li>
<li><a href="../485546/index.html">Se acerca el apocalipsis</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>