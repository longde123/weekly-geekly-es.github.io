<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>▶️ 😉 🐽 DIY无线路由器 👨🏾‍⚖️ 🍝 🔢</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="1. 元件选择 
2. 启动网络接口 
3. 设置802.11ac接入点（5 GHz） 
4. 使用hostapd配置虚拟SSID 
 在过去的十年中，我购买了廉价的网络设备，并在其上安装了DD-WRT ，以使“功能”以超过500美元的价格从Linux内核中删除，而后者是基础固件。 

 尽管存在不...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>DIY无线路由器</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/437634/"><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/967/b65/9d2/967b659d291d3021a9a93f68b4b305b2.jpg"></div><br><ol><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">元件选择</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">启动网络接口</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">设置802.11ac接入点（5 GHz）</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">使用hostapd配置虚拟SSID</a> </li></ol><br> 在过去的十年中，我购买了廉价的网络设备，并在其上安装了<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">DD-WRT</a> ，以使“功能”以超过500美元的价格从Linux内核中删除，而后者是基础固件。 <br><br> 尽管存在不稳定的版本，未纠正的错误和<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=https://web.archive.org/web/20160303173311/">纠纷</a> ，但DD-WRT仍然比库存固件更可取。 但是现在有价值的组件比以往任何时候都更便宜，并且DIY社区已经完全转换为Linux（我正在找您，Raspberry先生），那么为什么不一劳永逸地构建自己的无线路由器呢？ <br><a name="habracut"></a><br><a name="1"></a><h1> 元件选择 </h1><br> 首先，您需要确定平台： <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">x86</a>或<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">ARM</a> ？ 我不会<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">详细讨论主要的区别</a> ，而是简要地介绍一下：前者具有更好的性能，而后者则更便宜且更节能。  Raspberry Pi板（和等效产品）非常便宜，并且可能比大多数无线商用路由器功能更强大，但是x86平台已普及并且具有标准化的外形尺寸和扩展端口的优势。 <br><br> 当然，最重要的细节是芯片组。 今天，事实上的标准是<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">802.11n</a> （2.4 GHz）和<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">802.11ac</a> （5 GHz），但是为Linux选择驱动程序<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">仍然是一个挑战</a> ，尤其是在支持AP（接入点）模式的情况下。 简而言之，如果您不希望出现问题，请选择<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Atheros</a>芯片组。 很好地支持<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">ath9k</a>和<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">ath10k驱动程序</a> ，您可以通过USB和/或mini-PCIe接口轻松找到它们。 <br><br> 至少需要一个网络接口控制器（NIC），并根据您的喜好选择RAM和存储。 <br><br><h2> 材料清单 </h2><br> 牺牲了价格和功耗之后，我选择了x86平台来进行模块化，相对强大的配置以进行升级。 <br><br>  <i>如果不需要ARM，则不需要风扇。</i> <br><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" rel="nofollow noopener">技嘉GA-J1900N-D3V</a> （J1900四核2 GHz赛扬处理器，两个NIC） </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" rel="nofollow noopener">Airetos AEX-QCA9880-NX</a> （双频802.11ac，MIMO） </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" rel="nofollow noopener">4 GB RAM</a> （DDR3-LP，1333 MHz，1.35 V） </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" rel="nofollow noopener">扩展mPCIe</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" rel="nofollow noopener">MX500 mini-ITX机箱</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" rel="nofollow noopener">三个6dBi RP-SMA双频段天线+ RP-SMA</a>电缆 </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" rel="nofollow noopener">笔克PSU-90</a> </li><li> 备用硬盘2.5英寸 </li></ul><br> 外壳很宽敞，有两个准备好的交流/直流插头孔。 顺利安装主板，RAM和Pico-PSU： <br><br><img src="https://habrastorage.org/getpro/habr/post_images/7ad/455/84b/7ad45584b277d11fa3f1a7b119759ebc.jpg"><br>  <i><font color="gray">铁色情</font></i> <br><br> 事实证明，安装mini-PCIe WiFi最困难，因为该板仅支持一半大小的卡：在这里，mPCIe扩展电缆可用于救援。 我用20厘米FFC电缆（随附）连接适配器的两侧，并使用双面胶带将mini-PCIe固定至机箱。 <br><br><img src="https://habrastorage.org/getpro/habr/post_images/db1/c7a/8f7/db1c7a8f756c70176d86ce9441d5cf7a.jpg"><img src="https://habrastorage.org/getpro/habr/post_images/5bb/b09/5c7/5bbb095c759ac5cd9be3cf316070ab22.jpg"><br><br><img src="https://habrastorage.org/getpro/habr/post_images/3a4/e91/9b8/3a4e919b817344fdc03d98bb1e9d001f.jpg"><br>  <i><font color="gray">Mini-PCIe扩展器</font></i> <br><br> 幸运的是，机箱带有三个预先切割的天线孔。 这是最终结果： <br><br><img src="https://habrastorage.org/getpro/habr/post_images/967/b65/9d2/967b659d291d3021a9a93f68b4b305b2.jpg"><br><br><img src="https://habrastorage.org/getpro/habr/post_images/c3d/82d/a98/c3d82da9842de641d8d3a4dec3cfe517.jpg"><br><br><a name="2"></a><h1> 软体类 </h1><br> 显然，我们安装了Linux。 根据硬件的不同，它可能是经过优化的发行版，如<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Raspbian</a> （针对Raspberry Pi）或您喜欢的任何其他Linux发行版。 自从我使用Ubuntu多年以来，我选择了<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Ubuntu Server 18.04 LTS</a> ，我更习惯与之合作并获得长期支持。 <br><br>  <i>本文的其余部分假定您正在使用基于Debian的发行版。</i> <br><br> 如果安装正常，然后转到控制台，请定义接口名称： <br><br><pre><code class="bash hljs">$ ip -br a | awk <span class="hljs-string"><span class="hljs-string">'{print $1}'</span></span> lo enp1s0 enp2s0 wlp5s0</code> </pre> <br> 主板上有两个内置NIC： <code>enp1s0</code>和<code>enp2s0</code> 。 无线网卡显示为<code>wlp5s0</code>并按预期支持AP模式： <br><br><pre> <code class="bash hljs">$ iw list ... Supported interface modes: * managed * AP * AP/VLAN * monitor * mesh point</code> </pre> <br> 现在，我们可以概述所需的内容：我们将第一个NIC用作WAN端口，然后将第二个NIC连接到无线接口： <br><br><img src="https://habrastorage.org/getpro/habr/post_images/5e6/f00/dd4/5e6f00dd4994b5dc252d70dda1d325ec.png"><br><br><h2> 联播网 </h2><br> 如果您具有Ubuntu 18.04，则立即摆脱netplan，以返回对/ etc / network / interfaces的支持： <br><br><pre> <code class="bash hljs">$ sudo apt-get install ifupdown bridge-utils $ sudo systemctl stop networkd-dispatcher $ sudo systemctl <span class="hljs-built_in"><span class="hljs-built_in">disable</span></span> networkd-dispatcher $ sudo systemctl mask networkd-dispatcher $ sudo apt-get purge nplan netplan.io</code> </pre> <br> 作为DHCP / DNS服务器，选择<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">dnsmasq</a> ： <br><br><pre> <code class="bash hljs">$ sudo apt-get install dnsmasq</code> </pre> <br> 由于我们将通过<code>post-up</code>挂钩启动和配置<code>dnsmasq</code>进程，因此请记住在引导时禁用守护程序： <br><br><pre> <code class="bash hljs">$ sudo sed -i <span class="hljs-string"><span class="hljs-string">"s/^ENABLED=1$/ENABLED=0/g"</span></span> /etc/default/dnsmasq</code> </pre> <br> 我们将根据该图编写网络接口的<b>初步</b>配置，包括<code>dnsmasq</code>的最低配置： <br><br><pre> <code class="bash hljs">$ cat /etc/network/interfaces <span class="hljs-comment"><span class="hljs-comment"># Loopback auto lo iface lo inet loopback # WAN interface auto enp1s0 iface enp1s0 inet dhcp # Bridge (LAN) auto br0 iface br0 inet static address 192.168.1.1 network 192.168.1.0 netmask 255.255.255.0 broadcast 192.168.1.255 bridge_ports enp2s0 post-up /usr/sbin/dnsmasq \ --pid-file=/var/run/dnsmasq.$IFACE.pid \ --dhcp-leasefile=/var/lib/misc/dnsmasq.$IFACE.leases \ --conf-file=/dev/null \ --interface=$IFACE --except-interface=lo \ --bind-interfaces \ --dhcp-range=192.168.1.10,192.168.1.150,24h pre-down cat /var/run/dnsmasq.$IFACE.pid | xargs kill</span></span></code> </pre> <br>  <i>文档<code>/etc/network/interfaces</code> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">在这里</a></i> <br><br> 如您在<code>post-up</code>部分中所见，一旦桥升起，dnsmasq就开始启动。 它的配置仅由命令行参数（ <code>--conf-file=/dev/null</code> ）执行，并且在关闭接口时该过程将停止。 <br><br> 在<code>wlp5s0</code>未特别指定<code>bridge_ports</code>接口，因为<code>hostapd</code>会自动将其添加到网桥（在启动hostapd更改接口模式之前，brctl可能会拒绝这样做）。 <br><br>  <i>请参阅<code>dnsmasq</code> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">文档</a> 。</i> <br><br> 现在，您可以重新启动网络（ <code>sudo service networking restart</code> ），或者简单地重新启动以确认网络配置正确。 <br><br> 请注意：尽管我们目前可以从<code>enp2s0</code>接收DHCP， <code>enp2s0</code>我们将无法<b>进行无线连接</b> （稍后会详细介绍） <b>或访问Internet</b> （请参见下文）。 <br><br><h2> 路由选择 </h2><br> 此时，您需要在LAN（ <code>enp2s0</code> ）和WAN（ <code>enp1s0</code> ） <code>enp1s0</code>之间路由数据包，并启用<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">网络地址转换</a> 。 <br><br> 启用数据包转发很容易： <br><br><pre> <code class="bash hljs">$ sudo sysctl -w net.ipv4.ip_forward=1 $ <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> <span class="hljs-string"><span class="hljs-string">"net.ipv4.ip_forward=1"</span></span> | sudo tee -a /etc/sysctl.conf</code> </pre> <br>  <i>最后一条命令确保在下次重新启动之前保存配置。</i> <br><br> 网络地址转换是另一回事，通常您必须处理（或更确切地说，是对付） <code>iptables</code> 。 幸运的是，“石器时代”已经过去了，FireHol的团队付出了很多努力来添加必要的抽象级别： <br><br><pre> <code class="bash hljs">$ sudo apt-get install firehol</code> </pre> <br>  FireHOL是一种最新的安全防火墙语言，其配置易于理解和访问。 您不再需要编写<code>iptables</code>语句：配置文件本身将转换为<code>iptables</code>语句并根据需要应用。 后台无守护程序。 <br><br> 启用LAN的网络地址转换并添加最小防火墙规则的步骤基本完成： <br><br><pre> <code class="bash hljs">$ cat /etc/firehol/firehol.conf version 6 <span class="hljs-comment"><span class="hljs-comment"># Accept all client traffic on WAN interface enp1s0 wan client all accept # Accept all traffic on LAN interface br0 lan server all accept client all accept # Route packets between LAN and WAN router lan2wan inface br0 outface enp1s0 masquerade route all accept</span></span></code> </pre> <br>  <i>FireHOL是人们为人们编写的， <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">这里</a>是文档。</i> <br><br> 您可以通过手动启动<code>firehol</code> （ <code>sudo firehol start</code> ）并将便携式计算机连接到LAN端口来检查设置： <b>现在，</b>如果已连接WAN端口，则<b>可以联机</b> 。 <br><br> 重新引导之前，请<b>确保</b>编辑<code>/etc/default/firehol</code>以允许FireHol在引导时启动： <br><br><pre> <code class="bash hljs">$ sudo sed -i -E <span class="hljs-string"><span class="hljs-string">"s/^START_FIREHOL=.+$/START_FIREHOL=YES/g"</span></span> /etc/default/firehol</code> </pre> <br>  <i>我不会详细介绍整个<code>firehol</code>语法，配置文件会自行<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">说明</a> ，如果配置更复杂，建议您<code>firehol</code> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">文档</a> 。</i>  <i>如果您真的对<code>firehol</code>对<code>iptables</code>做了什么感兴趣，只需在命令行中输入<code>sudo firehol status</code> 。</i> <br><br><h2> 无线热点 </h2><br> 显然，我们将使用<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">hostapd</a>管理访问点： <br><br><pre> <code class="bash hljs">$ sudo apt-get install hostapd</code> </pre> <br> 在下面，您将找到最小且几乎无法解释的802.11 n / 2.4 Ghz / WPA2-AES配置文件： <br><br><pre> <code class="bash hljs">$ cat /etc/hostapd/hostapd-simple.conf <span class="hljs-comment"><span class="hljs-comment">#### Interface configuration #### interface=wlp5s0 bridge=br0 driver=nl80211 ##### IEEE 802.11 related configuration ##### ssid=iCanHearYouHavingSex hw_mode=g channel=1 auth_algs=1 wmm_enabled=1 ##### IEEE 802.11n related configuration ##### ieee80211n=1 ##### WPA/IEEE 802.11i configuration ##### wpa=2 wpa_key_mgmt=WPA-PSK rsn_pairwise=CCMP wpa_passphrase=YouCantGuess</span></span></code> </pre> <br>  <i><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">请参阅</a> <code>hostpad.conf</code> <code>/usr/share/doc/hostapd/examples/hostapd.conf</code>文档</i> 。 <br><br> 可以手动测试描述的配置： <br><br><pre> <code class="bash hljs">$ sudo hostapd /etc/hostapd/hostapd-simple.conf</code> </pre> <br> 如果一切顺利， <b>将出现无线连接</b> 。 如果您对结果感到满意， <b>请不要忘记</b>更改配置以在接口上升后立即启动<code>hostapd</code> （如下所示）。 <br><br>  <b>这是您的最终<code>/etc/network/interfaces:</code></b> <br><br><pre> <code class="bash hljs">$ cat /etc/network/interfaces <span class="hljs-comment"><span class="hljs-comment"># Loopback auto lo iface lo inet loopback # WAN interface auto enp1s0 iface enp1s0 inet dhcp # Bridge (LAN) auto br0 iface br0 inet static address 192.168.1.1 network 192.168.1.0 netmask 255.255.255.0 broadcast 192.168.1.255 bridge_ports enp2s0 post-up /usr/sbin/hostapd \ -P /var/run/hostapd.$IFACE.pid \ -B /etc/hostapd/hostapd-simple.conf post-up /usr/sbin/dnsmasq \ --pid-file=/var/run/dnsmasq.$IFACE.pid \ --dhcp-leasefile=/var/lib/misc/dnsmasq.$IFACE.leases \ --conf-file=/dev/null \ --interface=$IFACE --except-interface=lo \ --bind-interfaces \ --dhcp-range=192.168.1.10,192.168.1.150,24h pre-down cat /var/run/dnsmasq.$IFACE.pid | xargs kill pre-down cat /var/run/hostapd.$IFACE.pid | xargs kill</span></span></code> </pre> <br><a name="3"></a><h1> 设置802.11ac接入点（5 GHz） </h1><br><h2> 被动扫描 </h2><br> 根据<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Airetos AEX-QCA9880-NX</a>文档，该芯片组支持802.11ac，因此我们可以将拥挤的2.4 GHz信道留给天堂5 GHz。 <br><br> 让我们看看支持哪些频率： <br><br><pre> <code class="plaintext hljs">$ iw list ... Frequencies: * 2412 MHz [1] (20.0 dBm) * 2417 MHz [2] (20.0 dBm) * 2422 MHz [3] (20.0 dBm) * 2427 MHz [4] (20.0 dBm) * 2432 MHz [5] (20.0 dBm) * 2437 MHz [6] (20.0 dBm) * 2442 MHz [7] (20.0 dBm) * 2447 MHz [8] (20.0 dBm) * 2452 MHz [9] (20.0 dBm) * 2457 MHz [10] (20.0 dBm) * 2462 MHz [11] (20.0 dBm) * 2467 MHz [12] (disabled) * 2472 MHz [13] (disabled) * 2484 MHz [14] (disabled) ... Frequencies: * 5180 MHz [36] (17.0 dBm) (no IR) * 5200 MHz [40] (17.0 dBm) (no IR) * 5220 MHz [44] (17.0 dBm) (no IR) * 5240 MHz [48] (17.0 dBm) (no IR) * 5260 MHz [52] (23.0 dBm) (no IR, radar detection) * 5280 MHz [56] (23.0 dBm) (no IR, radar detection) * 5300 MHz [60] (23.0 dBm) (no IR, radar detection) * 5320 MHz [64] (23.0 dBm) (no IR, radar detection) * 5500 MHz [100] (23.0 dBm) (no IR, radar detection) * 5520 MHz [104] (23.0 dBm) (no IR, radar detection) * 5540 MHz [108] (23.0 dBm) (no IR, radar detection) * 5560 MHz [112] (23.0 dBm) (no IR, radar detection) * 5580 MHz [116] (23.0 dBm) (no IR, radar detection) * 5600 MHz [120] (23.0 dBm) (no IR, radar detection) * 5620 MHz [124] (23.0 dBm) (no IR, radar detection) * 5640 MHz [128] (23.0 dBm) (no IR, radar detection) * 5660 MHz [132] (23.0 dBm) (no IR, radar detection) * 5680 MHz [136] (23.0 dBm) (no IR, radar detection) * 5700 MHz [140] (23.0 dBm) (no IR, radar detection) * 5720 MHz [144] (23.0 dBm) (no IR, radar detection) * 5745 MHz [149] (30.0 dBm) (no IR) * 5765 MHz [153] (30.0 dBm) (no IR) * 5785 MHz [157] (30.0 dBm) (no IR) * 5805 MHz [161] (30.0 dBm) (no IR) * 5825 MHz [165] (30.0 dBm) (no IR) ...</code> </pre> <br> 在上面的列表中，我们看到芯片组支持通道1-14（2.4 GHz）和通道36-165（5 GHz），但是您是否注意到<code>no IR</code>标志？ <br><br>  <code>no IR</code>标志表示<i>无辐射</i> （即<i>被动扫描</i> ）。 这意味着在设备首次启动辐射（包括<b>信标</b> ）的情况下，禁止使用此模式。 换句话说， <b>您不能在这些通道上运行接入点</b> ！ <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/03f/743/e75/03f743e7505714ae9864dcce2b5b4964.gif"></div><br><br><h2> 法规要求 </h2><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Linux</a>的<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">法规要求</a>解释了上述情况，该<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">法规要求</a> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">根据国家/地区</a>来规范射频频谱的使用。 <br><br> 但是，嘿！ <br><br> 我住在美国，该链接说我有权在36-48频道上发起辐射，那怎么回事？ 让我们看看当前正在使用哪个监管域： <br><br><pre> <code class="plaintext hljs">$ iw reg get country 00: DFS-UNSET (2402 - 2472 @ 40), (N/A, 20), (N/A) (2457 - 2482 @ 40), (N/A, 20), (N/A), NO-IR (2474 - 2494 @ 20), (N/A, 20), (N/A), NO-OFDM, NO-IR (5170 - 5250 @ 80), (N/A, 20), (N/A), NO-IR (5250 - 5330 @ 80), (N/A, 20), (0 ms), DFS, NO-IR (5490 - 5730 @ 160), (N/A, 20), (0 ms), DFS, NO-IR (5735 - 5835 @ 80), (N/A, 20), (N/A), NO-IR (57240 - 63720 @ 2160), (N/A, 0), (N/A)</code> </pre> <br> 问题显示该<i>世界</i>域当前处于活动状态（或未安装），即<b>每个国家/地区允许</b>的<b>最小值</b> 。 <br><br> 不幸的是，您不能手动安装<code>sudo iw reg set</code>域，因为该域在EEPROM中受保护： <br><br><pre> <code class="plaintext hljs">$ dmesg | grep EEPROM [ 12.123068] ath: EEPROM regdomain: 0x6c</code> </pre> <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/5de/5a9/ae2/5de5a9ae216cf2c3f2f9416b4ffa54bc.gif"></div><br><h2> 补丁！ </h2><br> 幸运的是，法规要求是在驱动程序级别处理的，因此可以轻松更改它们：我们在<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Open-WRT源代码中</a>找到了补丁。 <br><br> 首先，不要忘记从<code>/etc/apt/sources.list</code>连接源代码存储库： <br><br><pre> <code class="bash hljs">$ cat /etc/apt/sources.list ... deb-src http://us.archive.ubuntu.com/ubuntu/ bionic main restricted ...</code> </pre> <br> 然后通过安装必要的依赖项来准备环境： <br><br><pre> <code class="bash hljs">$ sudo apt-get install build-essential fakeroot $ sudo apt-get build-dep linux</code> </pre> <br> 下载您的内核源代码： <br><br><pre> <code class="bash hljs">$ apt-get <span class="hljs-built_in"><span class="hljs-built_in">source</span></span> linux</code> </pre> <br> 由于构建系统中的细微差异，由于<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">原始的</a> Open-WRT补丁无法“按原样”应用于Ubuntu内核树，因此我必须对其进行修复： <br><br><pre> <code class="bash hljs">$ VERSION=$(uname -r) $ <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> linux-<span class="hljs-variable"><span class="hljs-variable">${VERSION%%-*}</span></span> $ wget -O - https://gist.github.com/renaudcerrato/02de8b2e8dc013bc71326defd2ef062c/raw/a2db325e520e6442c8c12f7599d64ac1b7596a3e/402-ath_regd_optional.patch | patch -p1 -b</code> </pre> <br> 一切准备就绪，可以进行组装： <br><br><pre> <code class="bash hljs">$ fakeroot debian/rules clean $ fakeroot debian/rules binary-generic</code> </pre> <br> 如果没有问题，现在您可以在前一个内核之上安装固定内核： <br><br><pre> <code class="bash hljs">$ <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> .. $ sudo dpkg -i linux*.deb</code> </pre> <br> 重新启动，瞧： <br><br><pre> <code class="bash hljs">$ sudo iw reg <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> US $ iw list ... Frequencies: * 5180 MHz [36] (17.0 dBm) * 5200 MHz [40] (17.0 dBm) * 5220 MHz [44] (17.0 dBm) * 5240 MHz [48] (17.0 dBm) * 5260 MHz [52] (23.0 dBm) (radar detection) * 5280 MHz [56] (23.0 dBm) (radar detection) * 5300 MHz [60] (23.0 dBm) (radar detection) * 5320 MHz [64] (23.0 dBm) (radar detection) * 5500 MHz [100] (23.0 dBm) (radar detection) * 5520 MHz [104] (23.0 dBm) (radar detection) * 5540 MHz [108] (23.0 dBm) (radar detection) * 5560 MHz [112] (23.0 dBm) (radar detection) * 5580 MHz [116] (23.0 dBm) (radar detection) * 5600 MHz [120] (23.0 dBm) (radar detection) * 5620 MHz [124] (23.0 dBm) (radar detection) * 5640 MHz [128] (23.0 dBm) (radar detection) * 5660 MHz [132] (23.0 dBm) (radar detection) * 5680 MHz [136] (23.0 dBm) (radar detection) * 5700 MHz [140] (23.0 dBm) (radar detection) * 5720 MHz [144] (23.0 dBm) (radar detection) * 5745 MHz [149] (30.0 dBm) * 5765 MHz [153] (30.0 dBm) * 5785 MHz [157] (30.0 dBm) * 5805 MHz [161] (30.0 dBm) * 5825 MHz [165] (30.0 dBm) ...</code> </pre> <br>  <i>为了避免自动更新，您可能需要<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">修复Linux内核版本</a> 。</i> <br><br><h2> 构型 </h2><br> 新的<code>hostapd</code>配置<code>hostapd</code>将非常简单： <code>hw_mode=a</code>包括5 GHz频带，而<code>ieee80211ac=1</code>包括802.11ac（VHT）。  <code>country_code=US</code>的<code>ieee80211d=1</code>选项指定了我们运营所在的监管域。 <br><br> 为了充分利用带宽， <code>ht_capab</code>和<code>vht_capab</code>应该反映硬件功能： <br><br><pre> <code class="bash hljs">$ iw list ... Band 1: Capabilities: 0x19e3 RX LDPC HT20/HT40 Static SM Power Save RX HT20 SGI RX HT40 SGI TX STBC RX STBC 1-stream Max AMSDU length: 7935 bytes DSSS/CCK HT40 ... Band 2: VHT Capabilities (0x338001b2): Max MPDU length: 11454 Supported Channel Width: neither 160 nor 80+80 RX LDPC short GI (80 MHz) TX STBC RX antenna pattern consistency TX antenna pattern consistency</code> </pre> <br> 考虑到这一点， <b>这是最终的</b> <code>hostapd.conf</code> ： <br><br><pre> <code class="bash hljs">$ cat /etc/hostapd/hostapd.conf <span class="hljs-comment"><span class="hljs-comment">#### Interface configuration #### interface=wlp5s0 bridge=br0 driver=nl80211 ##### IEEE 802.11 related configuration ##### ssid=iCanHearYouHavingSex hw_mode=a channel=0 auth_algs=1 wmm_enabled=1 country_code=US ieee80211d=1 ieee80211h=0 ##### IEEE 802.11n related configuration ##### ieee80211n=1 ht_capab=[HT40+][SHORT-GI-20][SHORT-GI-40][TX-STBC][RX-STBC1][DSSS_CK-40][LDPC][MAX-AMSDU-7935] ##### IEEE 802.11ac related configuration ##### ieee80211ac=1 vht_capab=[MAX-MPDU-11454][RXLDPC][SHORT-GI-80][TX-STBC-2BY1][RX-STBC-1][MAX-A-MPDU-LEN-EXP7][TX-ANTENNA-PATTERN][RX-ANTENNA-PATTERN] vht_oper_chwidth=1 ##### WPA/IEEE 802.11i configuration ##### wpa=2 wpa_key_mgmt=WPA-PSK rsn_pairwise=CCMP wpa_passphrase=YouCantGuess</span></span></code> </pre> <br>  <i><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">请参阅</a> <code>hostpad.conf</code> <code>/usr/share/doc/hostapd/examples/hostapd.conf</code>文档</i> 。 <br><br> 至此，无线路由器已完全运行，如果您需要更复杂的配置，则可以深入研究配置文件。 <br><br><a name="4"></a><h1> 使用hostapd配置虚拟SSID </h1><br> 无论您是要为VPN配置访客访问点还是专用无线网络，都必须在某个时候配置虚拟SSID。 <br><br><h2> 图表 </h2><br> 根据<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">当前配置</a> ，这是我们想要获得的更新图。 假设<code>wlp5s0</code>是物理无线接口，则虚拟SSID将使用自己的<code>192.168.2.0/24</code>子网在<code>wlan0</code>虚拟接口上运行： <br><br><img src="https://habrastorage.org/getpro/habr/post_images/096/450/32b/09645032b28e7310ad93b2109efb0860.png"><br><br><h2> 准备工作 </h2><br> 首先，检查您的无线设备是否支持多个SSID： <br><br><pre> <code class="bash hljs">$ iw list ... valid interface combinations: * <span class="hljs-comment"><span class="hljs-comment">#{ AP, mesh point } &lt;= 8, total &lt;= 8, #channels &lt;= 1, STA/AP BI must match ...</span></span></code> </pre> <br> 如您所见，该芯片组在一个通道上最多支持八个接入点。 这意味着您最多可以配置七个虚拟SSID，并且它们都将在同一通道上工作。 <br><br><h2> 网络接口 </h2><br> 根据hostapd.conf中的文档，物理接口的MAC地址与虚拟接口的BSSID之间存在严格的连接： <br><br><blockquote>  hostapd将基于配置的BSSID生成BSSID掩码。  <b>hostapd将验证dev_addr和MASK == dev_addr</b> 。 如果不是这种情况，则必须在启动hostapd之前更改无线电的MAC地址。 如果为每个辅助BSS配置了BSSID，则此限制不适用于hostapd，并且如果驱动程序支持，则可以使用其他掩码（例如，交换本地管理的位） <br><br> 除非使用'bssid'参数指定了明确的BSSID，否则将按顺序将BSSID分配给每个BSS。 <br><br> 如果指定了显式的BSSID，则必须这样选择它： <br>  -生成覆盖它和dev_addr的有效MASK <br>  -与电台的MAC地址不同 <br>  -与任何其他明确指定的BSSID不同 </blockquote><br> 为了满足这些要求并允许<code>hostapd</code>自动分配虚拟接口的BSSID，我们通过将四个最低有效位清零来更新物理无线接口的MAC地址。 这对于15个虚拟BSSID而言已足够-远远超出了必要。 <br><br> 首先，确定当前的MAC地址： <br><br><pre> <code class="bash hljs">$ ip addr show wlp5s0 | grep link | awk <span class="hljs-string"><span class="hljs-string">'{print $2}'</span></span> 44:c3:06:00:03:eb</code> </pre> <br> 如果清除最后四位并设置<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">U / L位</a> ，则将获得MAC地址<code>46:c3:06:00:03:e0</code> 。 <br><br> 现在，我们将在加载接口之前更新配置以设置正确的MAC地址，并根据我们的示意图声明一个虚拟无线接口： <br><br><pre> <code class="bash hljs">$ cat /etc/network/interfaces ... <span class="hljs-comment"><span class="hljs-comment"># Physical Wireless auto wlp5s0 iface wlp5s0 inet manual pre-up ip link set dev wlp5s0 address 46:c3:06:00:03:e0 # Virtual Wireless allow-hotplug wlan0 iface wlan0 inet static address 192.168.2.1 network 192.168.2.0 netmask 255.255.255.0 broadcast 192.168.2.255 post-up /usr/sbin/dnsmasq \ --pid-file=/var/run/dnsmasq-wlan0.pid \ --conf-file=/dev/null \ --interface=wlan0 --except-interface=lo \ --bind-interfaces \ --dhcp-range=192.168.2.10,192.168.2.150,24h post-down cat /var/run/dnsmasq-wlan0.pid | xargs kill ...</span></span></code> </pre> <br> 太好了 我将<code>dnsmasq</code>用作DHCP服务器-随时替换为您喜欢的任何内容。 请注意，为使虚拟接口正常工作，需要<code>allow-hotplug</code> 。 <br><br><h2> 接入点配置 </h2><br> 现在最简单的事情是：将虚拟SSID添加到当前的<code>hostapd</code>配置中。 只需将其添加<b>到</b>现有<code>hostapd.conf</code>文件的末尾： <br><br><pre> <code class="bash hljs">$ cat /etc/hostapd/hostapd.conf ... <span class="hljs-comment"><span class="hljs-comment">### Virtual SSID(s) ### bss=wlan0 ssid=MyVirtualSSID wpa=2 wpa_key_mgmt=WPA-PSK rsn_pairwise=CCMP wpa_passphrase=you_cant_guess</span></span></code> </pre> <br> 在该示例中，我使用了WPA2加密，但是大多数无线接口选项都可以在此处使用（例如， <code>channel</code> ）。 您只需根据已声明并正确配置的虚拟接口在配置文件中添加行即可添加更多虚拟SSID。 <br><br> 现在重新启动-并查看新的SSID和新的无线接口（注意MAC地址）： <br><br><pre> <code class="bash hljs">$ ip addr show wlan0 | grep link | awk <span class="hljs-string"><span class="hljs-string">'{print $2}'</span></span> 46:c3:06:00:03:e1</code> </pre> <br>  <b>就是这样！</b> </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN437634/">https://habr.com/ru/post/zh-CN437634/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN437622/index.html">Azure机器学习服务入门</a></li>
<li><a href="../zh-CN437624/index.html">OpenSceneGraph：纹理基础</a></li>
<li><a href="../zh-CN437626/index.html">一个简单例子的交易平台性能</a></li>
<li><a href="../zh-CN437630/index.html">BETT会议上Microsoft的主要公告</a></li>
<li><a href="../zh-CN437632/index.html">混搭，语言的基础</a></li>
<li><a href="../zh-CN437636/index.html">在Microsoft Store上发布应用程序：一年中的一些更改</a></li>
<li><a href="../zh-CN437638/index.html">“答案是什么？” 非审稿人 大气压管和焊接</a></li>
<li><a href="../zh-CN437640/index.html">品牌如何突破科技媒体泡沫</a></li>
<li><a href="../zh-CN437642/index.html">如果窗户打开，那么有人需要</a></li>
<li><a href="../zh-CN437646/index.html">3D打印机的有用和非显而易见的事物：3D打印机的小事物</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>