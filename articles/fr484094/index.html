<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>‚ùé ü§≤üèΩ üë©üèø‚Äçüé® Cr√©ez un jeu de tir zombie √† la troisi√®me personne avec DOTS üë©‚Äçüëß‚Äçüë¶ üë®üèø‚Äçüé® üë®üèª‚Äçüé®</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Salut, Khabrovsk. Comme nous l'avons d√©j√† √©crit, janvier est riche en nouveaux lancements et aujourd'hui nous annon√ßons un ensemble pour un nouveau co...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Cr√©ez un jeu de tir zombie √† la troisi√®me personne avec DOTS</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/otus/blog/484094/">  <i>Salut, Khabrovsk.</i>  <i>Comme nous l'avons d√©j√† √©crit, janvier est riche en nouveaux lancements et aujourd'hui nous annon√ßons un ensemble pour un nouveau cours d'OTUS - <a href="https://otus.pw/YRoY/">"Game Developer for Unity"</a> .</i>  <i>En pr√©vision du d√©but du cours, nous partageons avec vous la traduction de mat√©riel int√©ressant.</i> <i><br></i> <br><img src="https://habrastorage.org/webt/o-/2d/iz/o-2diz_bo0cjb7cksohmc8zeoxc.png"><br><br><hr><blockquote>  Nous reconstruisons le noyau Unity avec notre <a href="https://unity.com/dots%3F_ga%3D2.241875339.889742683.1579017753-927430519.1579017753">pile technologique orient√©e donn√©es</a> .  Comme de nombreux studios de jeux, nous voyons √©galement de grands avantages √† utiliser l'Entity Component System (ECS), le syst√®me de t√¢ches C # (C # Job System) et Burst Compiler.  √Ä Unite Copenhagen, nous avons eu l'occasion de discuter avec Far North Entertainment et de d√©couvrir comment ils impl√©mentent cette fonctionnalit√© DOTS dans les projets Unity traditionnels. </blockquote><a name="habracut"></a>  Far North Entertainment est un studio su√©dois appartenant √† cinq amis ing√©nieurs.  Depuis la sortie de Down to Dungeon pour Gear VR au d√©but de 2018, la soci√©t√© travaille sur un jeu qui appartient au genre classique des jeux PC, √† savoir un jeu post-apocalyptique en mode de survie zombie.  Ce qui distingue le projet des autres, c'est le nombre de zombies qui vous poursuivent.  La vision de l'√©quipe √† cet √©gard a attir√© des milliers de zombies affam√©s vous suivant dans d'√©normes hordes. <br><br>  Cependant, ils ont rapidement rencontr√© de nombreux probl√®mes de performances au stade du prototypage.  La cr√©ation, la mort, le renouvellement et l'animation de tout ce nombre d'ennemis sont rest√©s le principal goulot d'√©tranglement, m√™me apr√®s que l'√©quipe ait essay√© de r√©soudre le probl√®me avec la <i>mise en commun oblique</i> et une <i>instanciation de nimation</i> . <br><br>  Cela a forc√© le directeur technique du studio Andres Ericsson √† tourner son attention vers DOTS et √† changer l'√©tat d'esprit orient√© objet vers orient√© donn√©es.  "L'id√©e cl√© qui a contribu√© √† provoquer ce changement √©tait que vous deviez arr√™ter de penser aux objets et aux hi√©rarchies d'objets et commencer √† penser aux donn√©es, comment elles sont transform√©es et comment y acc√©der", at-il d√©clar√©. .  Ses mots signifient qu'il n'est pas n√©cessaire de construire une architecture de code avec un ≈ìil sur les objets de la vie r√©elle de telle mani√®re qu'elle r√©sout le probl√®me le plus g√©n√©ral et abstrait.  Il a de nombreux conseils pour ceux qui, comme lui, sont confront√©s √† un changement de vision du monde: <br><br>  <i>¬´Demandez-vous quel est le v√©ritable probl√®me que vous essayez de r√©soudre et quelles donn√©es sont importantes pour obtenir une solution.</i>  <i>Allez-vous convertir le m√™me ensemble de donn√©es de la m√™me mani√®re encore et encore?</i>  <i>Combien de donn√©es utiles pouvez-vous tenir dans une ligne du cache du processeur?</i>  <i>Si vous apportez des modifications au code existant, √©valuez la quantit√© de donn√©es ind√©sirables que vous ajoutez √† la ligne de cache.</i>  <i>Est-il possible de diviser les calculs en plusieurs threads ou dois-je utiliser un seul flux de commandes? "</i> <br><br><iframe width="560" height="315" src="https://www.youtube.com/embed/QGM4feh0fRA" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br>  L'√©quipe a compris que les entit√©s du syst√®me de composants Unity ne sont que des identifiants de recherche dans les flux de composants.  Les composants ne sont que des donn√©es, tandis que les syst√®mes contiennent toute la logique et filtrent les entit√©s avec une signature sp√©cifique, appel√©es arch√©types.  ¬´Je pense que l'une des informations qui nous a aid√©s √† visualiser nos id√©es a √©t√© d'introduire ECS en tant que base de donn√©es SQL.  Chaque arch√©type est une table dans laquelle chaque colonne est un composant et chaque ligne est une entit√© unique.  En gros, vous utilisez des syst√®mes pour cr√©er des requ√™tes pour ces tables d'arch√©type et effectuer des op√©rations sur des entit√©s ¬ª, explique Anders. <br><br><h3>  Pr√©sentation de DOTS </h3><br>  Pour arriver √† cette compr√©hension, il a √©tudi√© la documentation du syst√®me <a href="https://docs.unity3d.com/Packages/com.unity.entities%400.1/manual/index.html%3F_ga%3D2.233150103.889742683.1579017753-927430519.1579017753">Entity Component</a> , des exemples <a href="https://github.com/Unity-Technologies/EntityComponentSystemSamples">ECS</a> et <a href="https://github.com/Unity-Technologies/UniteAustinTechnicalPresentation">un exemple</a> que nous avons fait avec Nordeus et pr√©sent√© √† Unite Austin.  Des informations g√©n√©rales sur l'architecture orient√©e donn√©es ont √©galement √©t√© tr√®s utiles √† l'√©quipe.  ¬´Le rapport de <a href="https://www.youtube.com/watch%3Fv%3DrX0ItVEVjHc">Mike Acton</a> sur l'architecture orient√©e donn√©es avec CppCon 2014 est exactement ce qui nous a ouvert les yeux sur ce mode de programmation.¬ª <br><br>  L'√©quipe de Far North a publi√© ce qu'elle a appris sur son <a href="http://www.farnorthentertainment.com/2019/04/10/what-we-have-been-up-to-why-ecs-is-the-way-to-gigantic-hordes/">blog Dev</a> , en septembre de cette ann√©e, elle est venue √† Copenhague pour parler de ses exp√©riences avec la transition vers une approche orient√©e donn√©es dans Unity. <br><br><iframe width="560" height="315" src="https://www.youtube.com/embed/yTGhg905SCs" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br>  Cet article est bas√© sur un rapport, il explique plus en d√©tail les sp√©cificit√©s de leur impl√©mentation d'ECS, du syst√®me de t√¢ches C # et du compilateur Burst.  Far North a √©galement aimablement partag√© de nombreux exemples de code de leur projet. <br><br><h3>  Organisation des donn√©es Zombie </h3><br>  ¬´Le probl√®me auquel nous √©tions confront√©s √©tait d'interpoler les d√©placements et les rotations de milliers d'objets c√¥t√© client¬ª, explique Anders.  Leur approche initiale orient√©e objet consistait √† cr√©er un script <i>ZombieView</i> abstrait qui h√©ritait de la classe parent <i>EntityView</i> g√©n√©rique.  <i>EntityView</i> est un <i>MonoBehaviour</i> attach√© √† un <i>GameObject</i> .  Il agit comme une repr√©sentation visuelle du mod√®le de jeu.  Chaque <i>ZombieView</i> √©tait responsable de g√©rer sa propre interpolation de mouvement et de rotation dans sa fonction de <i>mise √† jour</i> . <br><br>  Cela semble normal, jusqu'√† ce que vous compreniez que chaque entit√© se trouve en m√©moire dans un endroit arbitraire.  Cela signifie que si vous acc√©dez √† des milliers d'objets, le processeur doit les retirer de la m√©moire un par un, et cela se produit extr√™mement lentement.  Si vous placez vos donn√©es dans des blocs ordonn√©s dispos√©s en s√©rie, le processeur peut mettre en cache tout un tas de donn√©es en m√™me temps.  La plupart des processeurs modernes peuvent recevoir environ 128 ou 256 bits du cache en un cycle. <br><br>  L'√©quipe a d√©cid√© de convertir les ennemis en DOTS dans l'espoir de r√©soudre les probl√®mes de performances c√¥t√© client.  Le premier en ligne √©tait la fonction de <i>mise √† jour</i> dans <i>ZombieView</i> .  L'√©quipe a d√©termin√© quelles parties devaient √™tre divis√©es en diff√©rents syst√®mes et d√©termin√© les donn√©es n√©cessaires.  La premi√®re chose et la plus √©vidente √©tait l'interpolation des positions et des virages, car le monde du jeu est une grille √† deux dimensions.  Deux variables flottantes sont responsables de l'endroit o√π les zombies vont, et le dernier composant est la position cible, il suit la position du serveur pour l'ennemi. <br><br><pre><code class="cs hljs">[<span class="hljs-meta"><span class="hljs-meta">Serializable</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">struct</span></span> PositionData2D : IComponentData { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> float2 Position; } [Serializable] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">struct</span></span> HeadingData2D : IComponentData { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> float2 Heading; } [Serializable] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">struct</span></span> TargetPositionData : IComponentData { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> float2 TargetPosition; }</code> </pre> <br>  L'√©tape suivante consistait √† cr√©er un arch√©type pour les ennemis.  L'arch√©type est un ensemble de composants qui appartiennent √† une certaine entit√©, en d'autres termes, c'est la signature du composant. <br><br>  Le projet utilise des pr√©fabriqu√©s pour d√©terminer les arch√©types, car les ennemis n√©cessitent plus de composants, et certains d'entre eux ont besoin de liens vers <i>GameObject</i> .  Cela fonctionne de sorte que vous puissiez envelopper les donn√©es de votre composant dans <i>ComponentDataProxy</i> , qui le transformera en <i>MonoBehaviour</i> , qui √† son tour peut √™tre attach√© au pr√©fabriqu√©.  Lorsque vous cr√©ez une instance √† l'aide d' <i>EntityManager</i> et passez le pr√©fabriqu√©, il cr√©e une entit√© avec toutes les donn√©es des composants qui ont √©t√© attach√©s au pr√©fabriqu√©.  Toutes les donn√©es des composants sont stock√©es dans des blocs de m√©moire de 16 kilo-octets appel√©s <i>ArchetypeChunk</i> . <br><br>  Voici une visualisation de la fa√ßon dont les flux de composants seront organis√©s dans notre bloc d'arch√©type: <br><br><img src="https://habrastorage.org/webt/mh/cn/r9/mhcnr9qjgpsr6lkej2l0ezq0jmi.png"><br><br>  <i>¬´L'un des principaux avantages des blocs d'arch√©type est que vous n'avez pas souvent besoin de r√©affecter un groupe lors de la cr√©ation de nouveaux objets, car la m√©moire a d√©j√† √©t√© allou√©e √† l'avance.</i>  <i>Cela signifie que la cr√©ation d'entit√©s consiste √† √©crire des donn√©es √† la fin des flux de composants √† l'int√©rieur de blocs d'arch√©type.</i>  <i>Le seul cas o√π il est n√©cessaire d'effectuer √† nouveau l'allocation de segments est lors de la cr√©ation d'une entit√© qui ne rentre pas dans les bordures du bloc.</i>  <i>Dans ce cas, soit l'allocation d'un nouveau morceau d'un arch√©type de 16 Ko sera lanc√©e, soit s'il existe un fragment vide du m√™me arch√©type, il peut √™tre r√©utilis√©.</i>  <i>Ensuite, les donn√©es des nouveaux objets seront enregistr√©es dans les flux de composants du nouveau morceau ¬ª,</i> explique Anders. <br><br><h3>  Le multithreading de vos zombies </h3><br>  Maintenant que les donn√©es √©taient dens√©ment compress√©es et plac√©es en m√©moire de mani√®re pratique pour la mise en cache, l'√©quipe pouvait facilement utiliser le syst√®me de t√¢ches C # pour ex√©cuter son code sur plusieurs c≈ìurs de processeur en parall√®le. <br><br>  L'√©tape suivante consistait √† cr√©er un syst√®me qui filtrait toutes les entit√©s de tous les blocs d'arch√©type <i>contenant des composants</i> <i>PositionData2D</i> , <i>HeadingData2D</i> et <i>TargetPositionData</i> . <br><br>  Pour ce faire, Anders et son √©quipe ont cr√©√© <i>JobComponentSystem</i> et construit leur demande dans la fonction <i>OnCreate</i> .  Cela ressemble √† ceci: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> EntityQuery m_Group; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OnCreate</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">base</span></span>.OnCreate(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> query = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> EntityQueryDesc { All = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> [] { ComponentType.ReadWrite&lt;PositionData2D&gt;(), ComponentType.ReadWrite&lt;HeadingData2D&gt;(), ComponentType.ReadOnly&lt;TargetPositionData&gt;() }, }; m_Group = GetEntityQuery(query); }</code> </pre> <br>  Le code annonce une demande qui filtre tous les objets du monde qui ont une position, une direction et un but.  Ensuite, ils voulaient planifier des t√¢ches pour chaque trame √† l'aide du syst√®me de t√¢ches C # pour distribuer les calculs sur plusieurs workflows. <br><br>  <i>"La chose la plus int√©ressante √† propos du syst√®me de t√¢ches C # est qu'il s'agit du m√™me syst√®me que Unity utilise dans son code, nous n'avons donc pas eu √† nous soucier que les threads ex√©cutables se bloquent les uns les autres, n√©cessitant les m√™mes c≈ìurs de processeur et provoquant des probl√®mes de performances. ",</i> Dit Anders. <br><br>  L'√©quipe a d√©cid√© d'utiliser <i>IJobChunk</i> , car des milliers d'ennemis impliquaient la pr√©sence d'un grand nombre de morceaux d'arch√©type qui devraient correspondre √† la demande au moment de l'ex√©cution.  <i>IJobChunk</i> distribue les bons morceaux sur diff√©rents workflows. <br><br>  Chaque image, une nouvelle t√¢che <i>UpdatePositionAndHeadingJob,</i> est charg√©e de g√©rer l'interpolation des positions et des tours des ennemis dans le jeu. <br><br>  Le code de planification des t√¢ches est le suivant: <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> JobHandle </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OnUpdate</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">JobHandle inputDeps</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> positionDataType = GetArchetypeChunkComponentType&lt;PositionData2D&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> headingDataType = GetArchetypeChunkComponentType&lt;HeadingData2D&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> targetPositionDataType = GetArchetypeChunkComponentType&lt;TargetPositionData&gt;(<span class="hljs-literal"><span class="hljs-literal">true</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> updatePosAndHeadingJob = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> UpdatePositionAndHeadingJob { PositionDataType = positionDataType, HeadingDataType = headingDataType, TargetPositionDataType = targetPositionDataType, DeltaTime = Time.deltaTime, RotationLerpSpeed = <span class="hljs-number"><span class="hljs-number">2.0f</span></span>, MovementLerpSpeed = <span class="hljs-number"><span class="hljs-number">4.0f</span></span>, }; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> updatePosAndHeadingJob.Schedule(m_Group, inputDeps); }</code> </pre> <br>  Voici √† quoi ressemble la t√¢che: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">struct</span></span> UpdatePositionAndHeadingJob : IJobChunk { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> ArchetypeChunkComponentType&lt;PositionData2D&gt; PositionDataType; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> ArchetypeChunkComponentType&lt;HeadingData2D&gt; HeadingDataType; [ReadOnly] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> ArchetypeChunkComponentType&lt;TargetPositionData&gt; TargetPositionDataType; [ReadOnly] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> DeltaTime; [ReadOnly] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> RotationLerpSpeed; [ReadOnly] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> MovementLerpSpeed; }</code> </pre> <br>  Lorsqu'un thread de travail r√©cup√®re une t√¢che de sa file d'attente, il appelle le c≈ìur de la t√¢che. <br><br>  Voici √† quoi ressemble le noyau d'ex√©cution: <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Execute</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">ArchetypeChunk chunk, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> chunkIndex, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> firstEntityIndex</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> chunkPositionData = chunk.GetNativeArray(PositionDataType); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> chunkHeadingData = chunk.GetNativeArray(HeadingDataType); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> chunkTargetPositionData = chunk.GetNativeArray(TargetPositionDataType); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; chunk.Count; i++) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> target = chunkTargetPositionData[i]; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> positionData = chunkPositionData[i]; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> headingData = chunkHeadingData[i]; float2 toTarget = target.TargetPosition - positionData.Position; <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> distance = math.length(toTarget); headingData.Heading = math.<span class="hljs-keyword"><span class="hljs-keyword">select</span></span>( headingData.Heading, math.lerp(headingData.Heading, math.normalize(toTarget), math.mul(DeltaTime, RotationLerpSpeed)), distance &gt; <span class="hljs-number"><span class="hljs-number">0.008</span></span> ); positionData.Position = math.<span class="hljs-keyword"><span class="hljs-keyword">select</span></span>( target.TargetPosition, math.lerp( positionData.Position, target.TargetPosition, math.mul(DeltaTime, MovementLerpSpeed)), distance &lt;= <span class="hljs-number"><span class="hljs-number">1</span></span> ); chunkPositionData[i] = positionData; chunkHeadingData[i] = headingData; } }</code> </pre><br>  <i>¬´Vous remarquerez peut-√™tre que nous utilisons select au lieu de branchement, cela nous permet de nous d√©barrasser de l'effet appel√© pr√©diction de branchement incorrecte.</i>  <i>La fonction select √©valuera les deux expressions et s√©lectionnera celle qui correspond √† la condition, et si vos expressions ne sont pas si difficiles √† calculer, je recommanderais d'utiliser select, car c'est souvent moins cher que d'attendre que le CPU se r√©tablisse d'une pr√©diction de branche incorrecte. "</i> Anders. <br><br><h3>  Augmentez la productivit√© avec Burst </h3><br>  La derni√®re √©tape de la conversion de DOTS en position ennemie et interpolation de cap consiste √† activer le compilateur Burst.  La t√¢che semblait assez simple pour Anders: ¬´Puisque les donn√©es sont situ√©es dans des tableaux adjacents et que nous utilisons la nouvelle biblioth√®que de math√©matiques d'Unity, tout ce que nous avions √† faire √©tait d'ajouter l'attribut <i>BurstCompile</i> √† notre t√¢che.¬ª <br><br><pre> <code class="cs hljs">[<span class="hljs-meta"><span class="hljs-meta">BurstCompile</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">struct</span></span> UpdatePositionAndHeadingJob : IJobChunk { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> ArchetypeChunkComponentType&lt;PositionData2D&gt; PositionDataType; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> ArchetypeChunkComponentType&lt;HeadingData2D&gt; HeadingDataType; [ReadOnly] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> ArchetypeChunkComponentType&lt;TargetPositionData&gt; TargetPositionDataType; [ReadOnly] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> DeltaTime; [ReadOnly] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> RotationLerpSpeed; [ReadOnly] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> MovementLerpSpeed; }</code> </pre><br>  Le compilateur Burst nous donne des donn√©es multiples √† instruction unique (SIMD);  des instructions machine qui peuvent fonctionner avec plusieurs ensembles de donn√©es d'entr√©e et cr√©er plusieurs ensembles de donn√©es de sortie avec une seule instruction.  Cela nous aide √† remplir plus de places sur le bus de cache 128 bits avec les donn√©es correctes.  Le compilateur Burst, combin√© √† une composition de donn√©es compatible avec le cache et √† un syst√®me de travail, a permis √† l'√©quipe d'augmenter consid√©rablement sa productivit√©.  Voici le tableau qu'ils ont compil√© en mesurant les performances apr√®s chaque √©tape de conversion. <br><br><img src="https://habrastorage.org/webt/bo/gu/8i/bogu8ir1i0apb5cwuhrjfjyk-bk.png"><br><br>  Cela signifie que Far North s'est compl√®tement d√©barrass√© des probl√®mes li√©s √† l'interpolation de la position c√¥t√© client et de la direction des zombies.  Leurs donn√©es sont d√©sormais stock√©es sous une forme pratique pour la mise en cache et les lignes de cache ne sont remplies que de donn√©es utiles.  La charge est r√©partie sur tous les c≈ìurs de CPU et le compilateur Burst produit un code machine hautement optimis√© avec des instructions SIMD. <br><br><h4>  Far North Entertainment DOTS Trucs et astuces </h4><br><ul><li>  Commencez √† penser en termes de flux de donn√©es, car dans ECS, les entit√©s sont simplement des index de recherche dans des flux de donn√©es de composants parall√®les. </li><li>  Imaginez ECS comme une base de donn√©es relationnelle dans laquelle les arch√©types sont des tables, les composants sont des colonnes et les entit√©s sont des indices dans une table (ligne). </li><li>  Organisez vos donn√©es en tableaux s√©quentiels pour utiliser le cache du processeur et la pr√©lecture du mat√©riel. </li><li>  Oubliez de vouloir cr√©er des hi√©rarchies d'objets et d'essayer de trouver une solution commune avant de comprendre le vrai probl√®me que vous essayez de r√©soudre. </li><li>  Pensez √† la collecte des ordures.  √âvitez de surallouer des tas dans les zones critiques pour les performances.  Utilisez plut√¥t les nouveaux conteneurs Unity natifs.  Mais attention, vous devez vous occuper du nettoyage manuel. </li><li>  Reconnaissez la valeur de vos abstractions, m√©fiez-vous des frais g√©n√©raux li√©s √† l'invocation de fonctions virtuelles. </li><li>  Utilisez tous les c≈ìurs de processeur avec le syst√®me de t√¢ches C #. </li><li>  Analysez le niveau mat√©riel.  Le compilateur Burst g√©n√®re-t-il r√©ellement des instructions SIMD?  Utilisez l'inspecteur de rafale pour l'analyse. </li><li>  Arr√™tez de gaspiller les lignes de cache en vide.  Consid√©rez le regroupement des donn√©es dans des lignes de cache comme le regroupement des donn√©es dans des paquets UDP. </li></ul><br>  Le principal conseil que Anders Ericsson souhaite partager est un conseil plus g√©n√©ral pour ceux dont le projet est d√©j√† en d√©veloppement: <i>¬´Essayez d'identifier les zones sp√©cifiques de votre jeu o√π vous avez des probl√®mes de performances et voyez si vous pouvez appliquer DOTS sp√©cifiquement dans cette zone isol√©e.</i>  <i>Vous n'avez pas besoin de changer toute la base de code! ¬ª</i> <br><br><h3>  Plans futurs </h3><br>  ¬´Nous voulons utiliser DOTS dans d'autres domaines de notre jeu, et nous avons √©t√© ravis des annonces sur Unite concernant les animations DOTS, Unity Physics et Live Link.  Nous aimerions apprendre √† convertir davantage d'objets de jeu en objets ECS, et il semble que Unity ait fait des progr√®s significatifs dans la mise en ≈ìuvre de cela ¬ª, conclut Anders. <br><br>  Si vous avez des questions suppl√©mentaires pour l'√©quipe du Grand Nord, nous vous recommandons de rejoindre leur <a href="https://discord.gg/jXJyxUh">Discord</a> ! <br>  Consultez la liste de lecture <a href="https://www.youtube.com/playlist%3Flist%3DPLX2vGYjWbI0S1wHRTyDiPtKLEPTWFi4cd">DOTS Unite Copenhagen</a> pour d√©couvrir comment d'autres studios de jeux modernes utilisent DOTS pour cr√©er de superbes jeux haute performance et comment les composants bas√©s sur DOTS comme DOTS Physics, le nouveau Conversion Workflow et le compilateur Burst fonctionnent ensemble. <br><br>  La traduction est termin√©e et nous <b>vous invitons √† assister √† un <a href="https://otus.pw/YRoY/">webinaire gratuit</a> , dans lequel nous <i>vous expliquerons comment cr√©er votre propre jeu de tir zombie dans une heure</i> .</b> </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr484094/">https://habr.com/ru/post/fr484094/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr484076/index.html">O√π stocker les crypto-monnaies: taxation des crypto-monnaies dans diff√©rents pays</a></li>
<li><a href="../fr484084/index.html">1C-Bitrix et une tentative de l'introduire</a></li>
<li><a href="../fr484088/index.html">D√©fil√© de mots de passe (analyse d'environ 5 milliards de mots de passe de fuites)</a></li>
<li><a href="../fr484090/index.html">Nouvelle infrastructure informatique pour le centre de donn√©es de la poste russe</a></li>
<li><a href="../fr484092/index.html">Princes et nobles un peu habill√©s</a></li>
<li><a href="../fr484096/index.html">La bataille des deux Yakozun, ou Cassandra vs HBase. Exp√©rience de l'√©quipe Sberbank</a></li>
<li><a href="../fr484100/index.html">Utilisation de l'interface dans le SDK Google Maps pour Android</a></li>
<li><a href="../fr484102/index.html">PHP vs Python vs Ruby on Rails: comparaison d√©taill√©e</a></li>
<li><a href="../fr484106/index.html">MVCC dans PostgreSQL-6. Le vide</a></li>
<li><a href="../fr484108/index.html">Encapsuleur Etherblade.net et substitution d'importation pour les composants r√©seau (deuxi√®me partie)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>