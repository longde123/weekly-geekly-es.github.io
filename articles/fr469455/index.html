<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üí∑ üë©üèæ‚Äçüöí ‚ÑπÔ∏è Migration de Nginx vers Envoy Proxy üòá üë®‚Äç‚öïÔ∏è üå¨Ô∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Bonjour, Habr! J'attire votre attention sur la traduction de l'article: Migration de Nginx vers Envoy Proxy . 


 Envoy est un serveur proxy distribu√©...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Migration de Nginx vers Envoy Proxy</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/469455/"><p>  Bonjour, Habr!  J'attire votre attention sur la traduction de l'article: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Migration de Nginx vers Envoy Proxy</a> . </p><br><p>  Envoy est un serveur proxy distribu√© hautes performances (√©crit en C ++) con√ßu pour les services et applications individuels, c'est aussi un bus de communication et un ¬´plan de donn√©es universel¬ª con√ßu pour les grandes architectures de ¬´service mesh¬ª de microservices.  Lors de sa cr√©ation, les solutions aux probl√®mes survenus lors du d√©veloppement de serveurs tels que NGINX, HAProxy, les √©quilibreurs de charge mat√©rielle et les √©quilibreurs de charge cloud ont √©t√© prises en compte.  Envoy fonctionne avec toutes les applications et r√©sume le r√©seau, offrant des fonctions communes quelle que soit la plate-forme.  Lorsque tout le trafic de bureau dans l'infrastructure passe par la grille Envoy, il devient facile de visualiser les zones √† probl√®me avec une observabilit√© coh√©rente, le r√©glage des performances globales et l'ajout de fonctions de base √† un endroit sp√©cifique. </p><br><h2 id="vozmozhnosti">  Les possibilit√©s </h2><br><ul><li> Architecture hors processus: l'envoy√© est un serveur autonome haute performance qui consomme une petite quantit√© de RAM.  Il fonctionne en conjonction avec n'importe quel langage ou framework d'application. </li><li>  Prise en charge de http / 2 et grpc: envoy√© a une prise en charge de premi√®re classe pour http / 2 et grpc pour les connexions entrantes et sortantes.  Il s'agit d'un proxy transparent de http / 1.1 √† http / 2. </li><li>  √âquilibrage de charge avanc√©: l'envoy√© prend en charge les fonctionnalit√©s avanc√©es d'√©quilibrage de charge, y compris les tentatives automatiques, le circuit ouvert, la limite de vitesse globale, les demandes d'observation, l'√©quilibrage de charge de zone locale, etc. </li><li>  API de gestion de la configuration: envoy√© fournit une API robuste pour g√©rer dynamiquement sa configuration. </li><li>  Observabilit√©: observabilit√© profonde du trafic L7, prise en charge int√©gr√©e du tra√ßage distribu√© et observabilit√© de mongodb, dynamodb et de nombreuses autres applications. </li></ul><a name="habracut"></a><br><h2 id="shag-1---primer-konfiga-nginx">  √âtape 1 - Exemple de configuration NGINX </h2><br><p>  Ce script utilise un fichier <em>nginx.conf</em> sp√©cialement cr√©√©, bas√© sur un exemple complet du <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">wiki NGINX</a> .  Vous pouvez afficher la configuration dans l'√©diteur en ouvrant <em>nginx.conf</em> </p><br><p>  Configuration de nginx source </p><br><pre><code class="nginx hljs"><span class="hljs-attribute"><span class="hljs-attribute">user</span></span> www www; <span class="hljs-attribute"><span class="hljs-attribute">pid</span></span> /var/run/nginx.pid; <span class="hljs-attribute"><span class="hljs-attribute">worker_processes</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span>; <span class="hljs-section"><span class="hljs-section">events</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">worker_connections</span></span> <span class="hljs-number"><span class="hljs-number">2000</span></span>; } <span class="hljs-section"><span class="hljs-section">http</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">gzip</span></span> <span class="hljs-literal"><span class="hljs-literal">on</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">gzip_min_length</span></span> <span class="hljs-number"><span class="hljs-number">1100</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">gzip_buffers</span></span> <span class="hljs-number"><span class="hljs-number">4</span></span> <span class="hljs-number"><span class="hljs-number">8k</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">gzip_types</span></span> text/plain; <span class="hljs-attribute"><span class="hljs-attribute">log_format</span></span> main <span class="hljs-string"><span class="hljs-string">'</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$remote_addr</span></span></span><span class="hljs-string"> - </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$remote_user</span></span></span><span class="hljs-string"> [</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$time_local</span></span></span><span class="hljs-string">] '</span></span> <span class="hljs-string"><span class="hljs-string">'"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$request</span></span></span><span class="hljs-string">" </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$status</span></span></span><span class="hljs-string"> </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$bytes_sent</span></span></span><span class="hljs-string"> '</span></span> <span class="hljs-string"><span class="hljs-string">'"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$http_referer</span></span></span><span class="hljs-string">" "</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$http_user_agent</span></span></span><span class="hljs-string">" '</span></span> <span class="hljs-string"><span class="hljs-string">'"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$gzip_ratio</span></span></span><span class="hljs-string">"'</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">log_format</span></span> download <span class="hljs-string"><span class="hljs-string">'</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$remote_addr</span></span></span><span class="hljs-string"> - </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$remote_user</span></span></span><span class="hljs-string"> [</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$time_local</span></span></span><span class="hljs-string">] '</span></span> <span class="hljs-string"><span class="hljs-string">'"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$request</span></span></span><span class="hljs-string">" </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$status</span></span></span><span class="hljs-string"> </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$bytes_sent</span></span></span><span class="hljs-string"> '</span></span> <span class="hljs-string"><span class="hljs-string">'"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$http_referer</span></span></span><span class="hljs-string">" "</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$http_user_agent</span></span></span><span class="hljs-string">" '</span></span> <span class="hljs-string"><span class="hljs-string">'"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$http_range</span></span></span><span class="hljs-string">" "</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$sent_http_content_range</span></span></span><span class="hljs-string">"'</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">upstream</span></span> targetCluster { 172.18.0.3:80; 172.18.0.4:80; } <span class="hljs-section"><span class="hljs-section">server</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">listen</span></span> <span class="hljs-number"><span class="hljs-number">8080</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">server_name</span></span> one.example.com www.one.example.com; <span class="hljs-attribute"><span class="hljs-attribute">access_log</span></span> /var/log/nginx.access_log main; <span class="hljs-attribute"><span class="hljs-attribute">error_log</span></span> /var/log/nginx.error_log <span class="hljs-literal"><span class="hljs-literal">info</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">location</span></span> / { <span class="hljs-attribute"><span class="hljs-attribute">proxy_pass</span></span> http://targetCluster/; <span class="hljs-attribute"><span class="hljs-attribute">proxy_redirect</span></span> <span class="hljs-literal"><span class="hljs-literal">off</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">proxy_set_header</span></span> Host <span class="hljs-variable"><span class="hljs-variable">$host</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">proxy_set_header</span></span> X-Real-IP <span class="hljs-variable"><span class="hljs-variable">$remote_addr</span></span>; } } }</code> </pre> <br><p>  Les configurations NGINX comportent g√©n√©ralement trois √©l√©ments cl√©s: </p><br><ol><li>  Configuration du serveur NGINX, de la structure des journaux et de la fonctionnalit√© Gzip.  Ceci est d√©termin√© globalement dans tous les cas. </li><li>  Configuration de NGINX pour accepter les demandes d'h√¥te <em>one.example.com</em> sur le port 8080. </li><li>  D√©finition de votre emplacement de destination, comment g√©rer le trafic pour diff√©rentes parties de l'URL. </li></ol><br><p>  Toutes les configurations ne seront pas appliqu√©es √† Envoy Proxy et vous n'avez pas besoin de configurer certains param√®tres.  Envoy Proxy dispose de <strong>quatre types de cl√©s</strong> qui prennent en charge l'infrastructure sous-jacente offerte par NGINX.  Le noyau est: </p><br><ul><li>  <strong>Auditeurs:</strong> ils d√©terminent comment Envoy Proxy accepte les demandes entrantes.  Envoy Proxy ne prend actuellement en charge que les √©couteurs bas√©s sur TCP.  Une fois la connexion √©tablie, elle est transf√©r√©e vers un ensemble de filtres pour traitement. </li><li>  <strong>Filtres:</strong> ils font partie d'une architecture en pipeline qui peut traiter les donn√©es entrantes et sortantes.  Cette fonctionnalit√© comprend des filtres, tels que Gzip, qui compresse les donn√©es avant de les envoyer au client. </li><li>  <strong>Routeurs:</strong> ils redirigent le trafic vers la destination souhait√©e, d√©finie comme un cluster. </li><li>  <strong>Clusters:</strong> ils d√©finissent le point de terminaison pour les param√®tres de trafic et de configuration. </li></ul><br><p>  Nous utiliserons ces quatre composants pour cr√©er la configuration du proxy Envoy pour correspondre √† la configuration NGINX sp√©cifique.  Le but d'Envoy est de travailler avec l'API et la configuration dynamique.  Dans ce cas, la configuration de base utilisera des param√®tres statiques cod√©s en dur de NGINX. </p><br><h2 id="shag-2---konfiguraciya-nginx">  √âtape 2 - Configurer NGINX </h2><br><p>  La premi√®re partie de <em>nginx.conf</em> d√©finit certains des composants NGINX internes qui doivent √™tre configur√©s. </p><br><h4 id="worker-connections-rabochie-soedineniya">  Connexions des travailleurs </h4><br><p>  La configuration ci-dessous d√©termine le nombre de processus de travail et de connexions.  Cela indique comment NGINX √©voluera pour r√©pondre √† la demande. </p><br><pre> <code class="nginx hljs"><span class="hljs-attribute"><span class="hljs-attribute">worker_processes</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span>; <span class="hljs-section"><span class="hljs-section">events</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">worker_connections</span></span> <span class="hljs-number"><span class="hljs-number">2000</span></span>; }</code> </pre> <br><p>  Envoy Proxy g√®re les workflows et les connexions diff√©remment. </p><br><p>  Envoy cr√©e un flux de travail pour chaque thread mat√©riel du syst√®me.  Chaque thread de travail ex√©cute une boucle d'√©v√©nements non bloquants qui est responsable de </p><br><ol><li>  √Ä l'√©coute de chaque auditeur </li><li>  Accepter de nouvelles connexions </li><li>  Cr√©ation d'un ensemble de filtres pour une connexion </li><li>  Gestion de toutes les op√©rations d'E / S pendant la dur√©e de vie d'une connexion. </li></ol><br><p>  Tous les autres traitements de connexion sont enti√®rement trait√©s dans le flux de travail, y compris tout comportement de transfert. </p><br><p>  Pour chaque flux de travail dans Envoy, il existe une connexion dans le pool.  Ainsi, les pools de connexions HTTP / 2 √©tablissent une seule connexion pour chaque h√¥te externe √† la fois; s'il y a quatre threads de travail, il y aura quatre connexions HTTP / 2 pour chaque h√¥te externe dans un √©tat stable.  En stockant tout dans un flux de travail, presque tout le code peut √™tre √©crit sans verrouillage, comme s'il s'agissait d'un seul thread.  Si plus de workflows que n√©cessaire sont allou√©s, cela peut entra√Æner une utilisation non rationnelle de la m√©moire, la cr√©ation d'un grand nombre de connexions inactives et une diminution du nombre de connexions renvoy√©es au pool. </p><br><p>  Pour plus d'informations, visitez le <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">blog Envoy Proxy</a> . </p><br><h4 id="konfiguraciya-http">  Configuration HTTP </h4><br><p>  Le bloc de configuration NGINX suivant d√©finit les param√®tres HTTP, tels que: </p><br><ul><li>  Quels types MIME sont pris en charge </li><li>  D√©lais d'expiration par d√©faut </li><li>  Configuration de Gzip </li></ul><br><p>  Vous pouvez configurer ces aspects √† l'aide de filtres dans Envoy Proxy, dont nous discuterons plus tard. </p><br><h2 id="shag-3---konfiguraciya-server">  √âtape 3 - Configuration du serveur </h2><br><p>  Dans le bloc de configuration HTTP, la configuration NGINX vous demande d'√©couter sur le port 8080 et de r√©pondre aux demandes entrantes pour les domaines <em>one.example.com</em> et <em>www.one.example.com</em> . </p><br><pre> <code class="nginx hljs"> <span class="hljs-section"><span class="hljs-section">server</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">listen</span></span> <span class="hljs-number"><span class="hljs-number">8080</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">server_name</span></span> one.example.com www.one.example.com;</code> </pre> <br><p>  √Ä l'int√©rieur d'Envoy, les auditeurs le contr√¥lent. </p><br><h4 id="slushateli-envoy">  Auditeurs envoy√©s </h4><br><p>  L'aspect le plus important pour commencer avec Envoy Proxy est l'identification des auditeurs.  Vous devez cr√©er un fichier de configuration qui d√©crit comment vous souhaitez ex√©cuter une instance Envoy. </p><br><p>  L'extrait ci-dessous cr√©era un nouvel √©couteur et l'associera au port 8080. La configuration indique √† Envoy Proxy les ports auxquels il doit √™tre li√© pour les demandes entrantes. </p><br><p>  Envoy Proxy utilise la notation YAML pour sa configuration.  Pour vous familiariser avec cette notation, consultez le <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">lien</a> ici. </p><br><pre> <code class="plaintext hljs">Copy to Editorstatic_resources: listeners: - name: listener_0 address: socket_address: { address: 0.0.0.0, port_value: 8080 }</code> </pre> <br><p>  Il n'est pas n√©cessaire de d√©finir <em>server_name</em> , car les filtres Envoy Proxy peuvent g√©rer cela. </p><br><h2 id="shag-4---konfiguraciya-mestopolozheniya">  √âtape 4 - Configuration de l'emplacement </h2><br><p>  Lorsqu'une demande arrive √† NGINX, le bloc d'emplacement d√©termine comment traiter et o√π diriger le trafic.  Dans le fragment suivant, tout le trafic vers le site est transmis √† un cluster en amont (note du traducteur: en amont est g√©n√©ralement un serveur d'applications) nomm√© <em>targetCluster</em> .  Le cluster en amont d√©finit les n≈ìuds qui doivent traiter la demande.  Nous en discuterons √† l'√©tape suivante. </p><br><pre> <code class="nginx hljs"><span class="hljs-attribute"><span class="hljs-attribute">location</span></span> / { <span class="hljs-attribute"><span class="hljs-attribute">proxy_pass</span></span> http://targetCluster/; <span class="hljs-attribute"><span class="hljs-attribute">proxy_redirect</span></span> <span class="hljs-literal"><span class="hljs-literal">off</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">proxy_set_header</span></span> Host <span class="hljs-variable"><span class="hljs-variable">$host</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">proxy_set_header</span></span> X-Real-IP <span class="hljs-variable"><span class="hljs-variable">$remote_addr</span></span>; }</code> </pre> <br><p>  Chez Envoy, Filters fait cela. </p><br><h4 id="envoy-filters">  Filtres Envoy </h4><br><p>  Pour une configuration statique, les filtres d√©terminent comment g√©rer les demandes entrantes.  Dans ce cas, nous avons d√©fini des filtres qui correspondent aux <em>noms</em> de <em>serveur</em> √† l'√©tape pr√©c√©dente.  Lorsque des demandes entrantes qui correspondent √† des domaines et √† des itin√©raires sp√©cifiques arrivent, le trafic est achemin√© vers le cluster.  C'est l'√©quivalent de la configuration amont NGINX. </p><br><pre> <code class="plaintext hljs">Copy to Editor filter_chains: - filters: - name: envoy.http_connection_manager config: codec_type: auto stat_prefix: ingress_http route_config: name: local_route virtual_hosts: - name: backend domains: - "one.example.com" - "www.one.example.com" routes: - match: prefix: "/" route: cluster: targetCluster http_filters: - name: envoy.router</code> </pre> <br><p>  Le nom <em>envoy√©.http_connection_manager</em> est un filtre int√©gr√© dans Envoy Proxy.  D'autres filtres incluent <em>Redis</em> , <em>Mongo</em> , <em>TCP</em> .  Vous pouvez trouver la liste compl√®te dans la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">documentation</a> . </p><br><p>  Pour plus d'informations sur les autres strat√©gies d'√©quilibrage de charge, consultez la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">documentation d'Envoy</a> . </p><br><h2 id="step-5---proxy-and-upstream-configuration">  √âtape 5 - Configuration proxy et amont </h2><br><p>  Dans NGINX, la configuration en amont d√©finit l'ensemble des serveurs cibles qui g√©reront le trafic.  Dans ce cas, deux grappes ont √©t√© attribu√©es. </p><br><pre> <code class="nginx hljs"> <span class="hljs-attribute"><span class="hljs-attribute">upstream</span></span> targetCluster { 172.18.0.3:80; 172.18.0.4:80; }</code> </pre> <br><p>  Dans Envoy, il est g√©r√© par cluster. </p><br><h4 id="envoy-clusters">  Clusters d'envois </h4><br><p>  L'√©quivalent de l'amont est d√©fini comme des clusters.  Dans ce cas, les h√¥tes qui serviront le trafic ont √©t√© identifi√©s.  Une m√©thode d'acc√®s aux h√¥tes, telle qu'un d√©lai d'attente, est d√©finie comme une configuration de cluster.  Cela vous permet de contr√¥ler plus pr√©cis√©ment la granularit√© d'aspects tels que la latence et l'√©quilibrage de charge. </p><br><pre> <code class="plaintext hljs">Copy to Editor clusters: - name: targetCluster connect_timeout: 0.25s type: STRICT_DNS dns_lookup_family: V4_ONLY lb_policy: ROUND_ROBIN hosts: [ { socket_address: { address: 172.18.0.3, port_value: 80 }}, { socket_address: { address: 172.18.0.4, port_value: 80 }} ]</code> </pre> <br><p>  Lors de l'utilisation de la <em>d√©couverte du</em> service <em>STRICT_DNS,</em> Envoy r√©soudra de mani√®re continue et asynchrone les cibles DNS sp√©cifi√©es.  Chaque adresse IP retourn√©e √† la suite de DNS sera consid√©r√©e comme un h√¥te explicite dans le cluster en amont.  Cela signifie que si la demande renvoie deux adresses IP, Envoy supposera qu'il y a deux h√¥tes dans le cluster et que les deux doivent √™tre √† charge √©quilibr√©e.  Si l'h√¥te est supprim√© du r√©sultat, Envoy suppose qu'il n'existe plus et s√©lectionnera le trafic de tous les pools de connexions existants. </p><br><p>  Pour plus d'informations, consultez la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">documentation du proxy Envoy</a> . </p><br><h2 id="shag-6---dostup-k-zhurnalu-i-oshibki">  √âtape 6 - Acc√®s au journal et erreurs </h2><br><p>  La configuration finale est l'enregistrement.  Au lieu de transf√©rer les journaux d'erreurs sur le disque, Envoy Proxy utilise une approche bas√©e sur le cloud.  Tous les journaux d'application sont affich√©s dans <em>stdout</em> et <em>stderr</em> . </p><br><p>  Lorsque les utilisateurs font une demande, les journaux d'acc√®s sont facultatifs et sont d√©sactiv√©s par d√©faut.  Pour activer les journaux d'acc√®s pour les requ√™tes HTTP, activez la configuration <em>access_log</em> pour le gestionnaire de connexions HTTP.  Le chemin peut √™tre soit un p√©riph√©rique, tel que <em>stdout</em> , soit un fichier sur disque, selon vos besoins. </p><br><p>  La configuration suivante redirigera tous les journaux d'acc√®s vers <em>stdout</em> (note du traducteur - stdout est n√©cessaire pour utiliser l'envoy√© dans docker. Si vous utilisez sans docker, remplacez / dev / stdout par le chemin d'acc√®s au fichier journal normal).  Copiez l'extrait dans la section de configuration du gestionnaire de connexions: </p><br><pre> <code class="plaintext hljs">Copy to Clipboardaccess_log: - name: envoy.file_access_log config: path: "/dev/stdout"</code> </pre> <br><p>  Les r√©sultats devraient ressembler √† ceci: </p><br><pre> <code class="plaintext hljs"> - name: envoy.http_connection_manager config: codec_type: auto stat_prefix: ingress_http access_log: - name: envoy.file_access_log config: path: "/dev/stdout" route_config:</code> </pre> <br><p>  Par d√©faut, Envoy a une cha√Æne de format qui inclut les d√©tails de la demande HTTP: </p><br><pre> <code class="plaintext hljs">[%START_TIME%] "%REQ(:METHOD)% %REQ(X-ENVOY-ORIGINAL-PATH?:PATH)% %PROTOCOL%" %RESPONSE_CODE% %RESPONSE_FLAGS% %BYTES_RECEIVED% %BYTES_SENT% %DURATION% %RESP(X-ENVOY-UPSTREAM-SERVICE-TIME)% "%REQ(X-FORWARDED-FOR)%" "%REQ(USER-AGENT)%" "%REQ(X-REQUEST-ID)%" "%REQ(:AUTHORITY)%" "%UPSTREAM_HOST%"\n</code> </pre> <br><p>  Le r√©sultat de cette cha√Æne de format: </p><br><pre> <code class="bash hljs">[2018-11-23T04:51:00.281Z] <span class="hljs-string"><span class="hljs-string">"GET / HTTP/1.1"</span></span> 200 - 0 58 4 1 <span class="hljs-string"><span class="hljs-string">"-"</span></span> <span class="hljs-string"><span class="hljs-string">"curl/7.47.0"</span></span> <span class="hljs-string"><span class="hljs-string">"f21ebd42-6770-4aa5-88d4-e56118165a7d"</span></span> <span class="hljs-string"><span class="hljs-string">"one.example.com"</span></span> <span class="hljs-string"><span class="hljs-string">"172.18.0.4:80"</span></span></code> </pre> <br><p>  Le contenu de la sortie peut √™tre personnalis√© en d√©finissant le champ de format.  Par exemple: </p><br><pre> <code class="plaintext hljs">access_log: - name: envoy.file_access_log config: path: "/dev/stdout" format: "[%START_TIME%] "%REQ(:METHOD)% %REQ(X-ENVOY-ORIGINAL-PATH?:PATH)% %PROTOCOL%" %RESPONSE_CODE% %RESP(X-ENVOY-UPSTREAM-SERVICE-TIME)% "%REQ(X-REQUEST-ID)%" "%REQ(:AUTHORITY)%" "%UPSTREAM_HOST%"\n"</code> </pre> <br><p>  La cha√Æne de journal peut √©galement √™tre sortie au format JSON en d√©finissant le champ <em>json_format</em> .  Par exemple: </p><br><pre> <code class="plaintext hljs">access_log: - name: envoy.file_access_log config: path: "/dev/stdout" json_format: {"protocol": "%PROTOCOL%", "duration": "%DURATION%", "request_method": "%REQ(:METHOD)%"}</code> </pre> <br><p>  Pour plus d'informations sur les techniques d'enregistrement des envoy√©s, visitez </p><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">https://www.envoyproxy.io/docs/envoy/latest/configuration/access_log#config-access-log-format-dictionaries</a> </p><br><p>  La journalisation n'est pas le seul moyen de se faire une id√©e de travailler avec Envoy Proxy.  Il dispose de fonctionnalit√©s avanc√©es int√©gr√©es pour le suivi et les mesures.  Vous pouvez en savoir plus dans la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">documentation de suivi</a> ou via le <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">script de suivi interactif</a> . </p><br><h2 id="shag-7---zapusk">  √âtape 7 - Lancement </h2><br><p>  Vous avez maintenant transf√©r√© la configuration de NGINX vers Envoy Proxy.  La derni√®re √©tape consiste √† ex√©cuter une instance d'Envoy Proxy pour la tester. </p><br><h4 id="zapusk-ot-polzovatelya">  Ex√©cuter √† partir de l'utilisateur </h4><br><p>  En haut de la configuration NGINX, l' <em>utilisateur de</em> ligne <em>www www;</em>  indique que NGINX a √©t√© lanc√© en tant qu'utilisateur disposant de faibles privil√®ges pour am√©liorer la s√©curit√©. </p><br><p>  Envoy Proxy adopte une approche bas√©e sur le cloud pour g√©rer √† qui appartient le processus.  Lorsque nous ex√©cutons Envoy Proxy via le conteneur, nous pouvons sp√©cifier un utilisateur avec un niveau de privil√®ge bas. </p><br><h4 id="zapusk-envoy-proxy">  Lancer Envoy Proxy </h4><br><p>  La commande ci-dessous lancera Envoy Proxy via le conteneur Docker sur l'h√¥te.  Cette commande permet √† Envoy d'√©couter les demandes entrantes via le port 80. Cependant, comme indiqu√© dans la configuration de l'√©couteur, Envoy Proxy √©coute le trafic entrant via le port 8080. Cela permet au processus de s'ex√©cuter en tant qu'utilisateur avec des privil√®ges faibles. </p><br><pre> <code class="bash hljs">docker run --name proxy1 -p 80:8080 --user 1000:1000 -v /root/envoy.yaml:/etc/envoy/envoy.yaml envoyproxy/envoy</code> </pre> <br><h4 id="testirovanie">  Test </h4><br><p>  Avec les proxys en cours d'ex√©cution, les tests peuvent d√©sormais √™tre effectu√©s et trait√©s.  La commande cURL suivante √©met une demande avec l'en-t√™te d'h√¥te d√©fini dans la configuration du proxy. </p><br><pre> <code class="bash hljs">curl -H <span class="hljs-string"><span class="hljs-string">"Host: one.example.com"</span></span> localhost -i</code> </pre> <br><p>  Une requ√™te HTTP entra√Ænera l'erreur <em>503</em> .  Cela est d√ª au fait que les connexions en amont ne fonctionnent pas et qu'elles ne sont pas disponibles.  Par cons√©quent, Envoy Proxy n'a aucune destination cible disponible pour la demande.  La commande suivante lancera une s√©rie de services HTTP qui correspondent √† la configuration d√©finie pour Envoy. </p><br><pre> <code class="bash hljs">docker run -d katacoda/docker-http-server; docker run -d katacoda/docker-http-server;</code> </pre> <br><p>  Avec les services disponibles, Envoy peut r√©ussir le proxy du trafic vers sa destination. </p><br><pre> <code class="bash hljs">curl -H <span class="hljs-string"><span class="hljs-string">"Host: one.example.com"</span></span> localhost -i</code> </pre> <br><p>  Vous devriez voir une r√©ponse indiquant quel conteneur Docker a trait√© la demande.  Dans les journaux Envoy Proxy, vous devriez √©galement voir la cha√Æne d'acc√®s affich√©e. </p><br><h4 id="dopolnitelnye-zagolovki-otveta-http-http-response">  En-t√™tes de r√©ponse HTTP suppl√©mentaires </h4><br><p>  Vous verrez des en-t√™tes HTTP suppl√©mentaires dans les en-t√™tes de r√©ponse de la demande r√©elle.  L'en-t√™te affiche le temps que l'h√¥te en amont a pass√© √† traiter la demande.  Il est exprim√© en millisecondes.  Ceci est utile si le client souhaite d√©terminer la dur√©e de service par rapport √† la latence du r√©seau. </p><br><pre> <code class="plaintext hljs">x-envoy-upstream-service-time: 0 server: envoy</code> </pre> <br><h2 id="itogovyy-konfig">  Configuration finale </h2><br><pre> <code class="plaintext hljs">static_resources: listeners: - name: listener_0 address: socket_address: { address: 0.0.0.0, port_value: 8080 } filter_chains: - filters: - name: envoy.http_connection_manager config: codec_type: auto stat_prefix: ingress_http route_config: name: local_route virtual_hosts: - name: backend domains: - "one.example.com" - "www.one.example.com" routes: - match: prefix: "/" route: cluster: targetCluster http_filters: - name: envoy.router clusters: - name: targetCluster connect_timeout: 0.25s type: STRICT_DNS dns_lookup_family: V4_ONLY lb_policy: ROUND_ROBIN hosts: [ { socket_address: { address: 172.18.0.3, port_value: 80 }}, { socket_address: { address: 172.18.0.4, port_value: 80 }} ] admin: access_log_path: /tmp/admin_access.log address: socket_address: { address: 0.0.0.0, port_value: 9090 }</code> </pre> <br><h2 id="dopolnitelnaya-informaciya-ot-perevodchika">  Informations suppl√©mentaires du traducteur </h2><br><p>  Les instructions d'installation d'Envoy Proxy sont disponibles √† l' <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">adresse https://www.getenvoy.io/</a> </p><br><p>  Par d√©faut dans rpm, il n'y a pas de configuration de service systemd. </p><br><p>  Ajoutez la configuration du service systemd /etc/systemd/system/envoy.service: </p><br><pre> <code class="bash hljs">[Unit] Description=Envoy Proxy Documentation=https://www.envoyproxy.io/ After=network-online.target Requires=envoy-auth-server.service Wants=nginx.service [Service] User=root Restart=on-failure ExecStart=/usr/bin/envoy --config-path /etc/envoy/config.yaml [Install] WantedBy=multi-user.target</code> </pre> <br><p>  Vous devez cr√©er le r√©pertoire / etc / envoy√© / et y mettre la configuration config.yaml. </p><br><p>  Par mandataire envoy√©, il y a une discussion par t√©l√©gramme: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">https://t.me/envoyproxy_ru</a> </p><br><p>  Envoy Proxy ne prend pas en charge la distribution de contenu statique.  Alors, qui peut voter pour la fonctionnalit√©: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">https://github.com/envoyproxy/envoy/issues/378</a> </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr469455/">https://habr.com/ru/post/fr469455/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr469445/index.html">Pr√©sentation d'AngularConnect 2019. Partie 2</a></li>
<li><a href="../fr469447/index.html">Le chemin de l'intelligence artificielle d'une id√©e fantastique √† l'industrie scientifique</a></li>
<li><a href="../fr469449/index.html">Certificats SSL EV: existe-t-il une vie apr√®s la mort?</a></li>
<li><a href="../fr469451/index.html">Philosophie du z√©ro</a></li>
<li><a href="../fr469453/index.html">Gestion d'une √©quipe distribu√©e en mode multi-projet (revue et reportage vid√©o)</a></li>
<li><a href="../fr469457/index.html">O√π Extravaganza m√®ne</a></li>
<li><a href="../fr469459/index.html">Connecter des appareils IoT dans la Smart City</a></li>
<li><a href="../fr469461/index.html">¬´Vers les √©toiles¬ª: ¬´Apocalypse aujourd'hui¬ª anti-cosmique</a></li>
<li><a href="../fr469463/index.html">Tendances et pr√©visions dans le traitement du langage naturel</a></li>
<li><a href="../fr469465/index.html">Initialisation en C ++ moderne</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>