<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ü§í üê∏ ü§µ MetricKit. An√°lise de desempenho de aplicativos iOS üë©üèΩ‚ÄçüöÄ üë©‚Äçüëß üçÉ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Brinquedo novo 
 Continuamos a nos familiarizar com o novo material da Apple apresentado na WWDC. Desta vez, considere o MetricKit , uma estrutura com...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>MetricKit. An√°lise de desempenho de aplicativos iOS</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/468347/"><img src="https://habrastorage.org/getpro/habr/post_images/362/bcb/a7d/362bcba7db30e427252ec3bf33b87042.jpg" alt="imagem"><br><br><h3>  Brinquedo novo </h3><br>  Continuamos a nos familiarizar com o novo material da Apple apresentado na WWDC.  Desta vez, considere o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">MetricKit</a> , uma estrutura completamente nova que serve como uma ferramenta para monitorar o desempenho do aplicativo. <br><a name="habracut"></a><br>  Todo mundo sabe que √© f√°cil medir o desempenho do aplicativo durante o desenvolvimento.  O Xcode mostra a quantidade de RAM usada e a carga do processador, voc√™ pode conectar o Instruments a um simulador ou dispositivo em teste e at√© escrever suas pr√≥prias ferramentas (para obter mais detalhes, consulte nossos artigos sobre pacotes de ferramentas personalizados: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">parte 1</a> / <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">parte 2</a> ).  Apenas compreender a import√¢ncia do ajuste de desempenho n√£o permite medir quase tudo o que o aplicativo faz.  Mas as coisas ficam mais complicadas quando falamos sobre a AppStore, se o aplicativo desenvolvido for destinado a usu√°rios reais.  N√£o importa o qu√£o cuidadosamente voc√™ teste seu aplicativo, em condi√ß√µes reais sempre haver√° muitas surpresas que afetar√£o o desempenho e a experi√™ncia do usu√°rio.  Obviamente, existem muitas ferramentas para coletar v√°rios par√¢metros, mas a maioria deles √© limitada pelo <b>SDK</b> do <b>iOS</b> , al√©m do impacto do monitoramento real no comportamento do aplicativo. <br><br>  Este ano, a Apple decidiu preencher essa lacuna e forneceu aos desenvolvedores uma ferramenta que os ajuda a coletar e analisar as m√©tricas de desempenho de aplicativos em um ambiente do mundo real.  Eles anunciaram o <b>MetricKit</b> (uma estrutura que fornece acesso √†s op√ß√µes fornecidas pelo sistema operacional) de uma guia separada no organizador do Xcode 11, onde √© poss√≠vel encontrar as configura√ß√µes do aplicativo.  Pausaremos no MetricKit, porque a exibi√ß√£o dos par√¢metros no Xcode funcionar√° apenas com aplicativos que j√° foram publicados na AppStore. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/78a/64c/612/78a64c6124242358e3ceb0ab5b63fe88.png" alt="imagem"><br><br><h3>  MXMetricManager </h3><br>  A arquitetura da estrutura √© bastante simples e direta.  A parte central √© ocupada pela classe <b>MXMetricManager</b> , que √© uma estrutura de elemento √∫nico que fornece ao desenvolvedor um grande conjunto de APIs de estrutura. <br><br>  Em geral, o fluxo de trabalho consiste em 3 etapas principais: <br><br><ol><li>  Voc√™ inicializa o MXMetricMnager e atribui um observador para ele. </li><li>  Se desejar, voc√™ pode implementar suas pr√≥prias m√©tricas em seu aplicativo usando a API do Signpost </li><li>  E, finalmente, agora estamos lidando com os dados recebidos no m√©todo didReceivePayloads, ou seja,  envie-os ao seu back-end para an√°lises adicionais. </li></ol><br>  Os par√¢metros v√™m como uma matriz de inst√¢ncias do <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">MXMetricPayload</a> .  A carga √∫til encapsula conjuntos de metadados e registros de data e hora.  A carga √∫til m√©trica √© um inv√≥lucro simples para subclassificar o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">MXMetric</a> .  Para cada tipo de par√¢metro, √© separado. <br><br>  Os tipos de m√©tricas s√£o muito bem documentados pela Apple, portanto, n√£o vamos insistir nisso por muito tempo.  No entanto, voc√™ deve parar para notar uma coisa interessante - o MXMetric fornece uma API aberta para serializ√°-la no NSDictionary ou JSON, o que, na minha opini√£o, √© um pouco incomum. <br><br><h3>  Componentes internos do MetricKit. </h3><br>  L√° fora, o MetricKit parece bem simples.  Mas √© sempre interessante ver como tudo funciona de dentro para fora.  A imers√£o em algo mais profundo √© sempre uma intriga, se voc√™ estiver enfrentando uma tarefa espec√≠fica.  Por isso, decidi que queria passar par√¢metros com as tags MetricKit e solicit√°-los a fornecer-me m√©tricas atualizadas a qualquer momento.  Obviamente, voc√™ pode usar ` <i>Debug -&gt; Simulate Payloads do MetricKit`</i> no Xcode, mas o id n√£o permite que voc√™ exiba seus pr√≥prios dados.  √â verdade que essa equipe n√£o √© muito √∫til, mas fornece orienta√ß√£o em sua pesquisa e parece muito engra√ßada;) <br><br>  Para iniciar a tarefa, obviamente precisamos do pr√≥prio MetricKit.  Voc√™ pode pensar que √© f√°cil obter um arquivo bin√°rio para a estrutura, porque o Xcode o mostra na lista de estruturas assim que voc√™ o adiciona na caixa de di√°logo "vincular arquivo bin√°rio √†s bibliotecas".  Este √© um pensamento muito otimista.  Porque se voc√™ abrir o <b>MetricKit.framework</b> , ver√° o arquivo <b>MetricKit.tbd</b> .  Seu tamanho √© de apenas <b>4kb</b> .  Obviamente, n√£o √© isso que estamos procurando. <br><br>  Ent√£o, o que realmente est√° acontecendo aqui? <br><br>  <b>TBD</b> significa "stub do dylib baseado em texto" e √© na verdade um arquivo YAML com uma descri√ß√£o do dylib que exporta caracteres e um caminho para o bin√°rio do dylib.  Vincular a arquivos tbd reduz o tamanho do bin√°rio.  Posteriormente, em tempo de execu√ß√£o, o bin√°rio dylib real ser√° baixado do sistema operacional no caminho especificado no arquivo tbd.  √â assim que o arquivo se parece quando voc√™ o abre no Xcode: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/047/3d2/e9e/0473d2e9e853e1c65632c2a1b2500b39.png" alt="imagem"><br><br>  Usando o caminho do arquivo tbd, voc√™ pode facilmente obter o bin√°rio MetricKit para pesquisas adicionais, mas existe um m√©todo ainda mais simples. <br><br>  Nosso aplicativo bin√°rio cont√©m o caminho para cada biblioteca vinculada dinamicamente na se√ß√£o de cabe√ßalho do Mach-O.  Essas informa√ß√µes s√£o facilmente recuperadas usando a ferramenta usando o sinalizador -l. <br><br>  Aqui est√° a sa√≠da do projeto de teste que eu criei: <br><br><pre><code class="swift hljs">‚Üí otool -l ./<span class="hljs-type"><span class="hljs-type">Metrics</span></span> | grep -i metrickit name /<span class="hljs-type"><span class="hljs-type">System</span></span>/<span class="hljs-type"><span class="hljs-type">Library</span></span>/<span class="hljs-type"><span class="hljs-type">Frameworks</span></span>/<span class="hljs-type"><span class="hljs-type">MetricKit</span></span>.framework/<span class="hljs-type"><span class="hljs-type">MetricKit</span></span> (offset <span class="hljs-number"><span class="hljs-number">24</span></span>)</code> </pre> <br>  Voc√™ pode ver o mesmo caminho que vimos anteriormente no arquivo tbd.  Tendo um arquivo de estrutura bin√°ria, voc√™ pode dar uma olhada nos elementos internos.  Para isso, eu costumo usar o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Hopper Disassemble</a> .  √â uma ferramenta f√°cil de usar, mas muito poderosa para um estudo cuidadoso de arquivos bin√°rios. <br><br>  Assim que o arquivo bin√°rio do MetricKit for aberto, v√° para a guia 'Proc'.  e expanda a lista "Tags".  Aqui voc√™ pode ver todos os caracteres exportados.  Selecionando um deles (por exemplo, MXMetricManager), veremos todos os seus m√©todos e, ap√≥s a sele√ß√£o de um m√©todo, veremos seu conte√∫do no lado direito: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/ac1/f17/71a/ac1f1771a4b061364d898d3c28f4564c.png" alt="imagem"><br><br>  Ao visualizar a lista de m√©todos MXMetricManager [ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">https://gist.github.com/deszip/88a258ae21d33dc75d7cbac9569c6ec1</a> ], √© muito f√°cil observar o m√©todo _checkAndDeliverMetricReports.  Parece ser o que precisa ser chamado para que o MetricKit entregue atualiza√ß√µes aos assinantes. <br><br>  Infelizmente, uma tentativa de ligar para ele n√£o levou a uma liga√ß√£o para o assinante, o que provavelmente significa que esses par√¢metros n√£o ser√£o entregues.  Considerando a implementa√ß√£o do m√©todo, notamos algumas coisas interessantes: enumera o conte√∫do do diret√≥rio / Library / Caches / MetricKit / Reports. <br><br>  Ele ent√£o tenta descompactar a inst√¢ncia MXMetricPayload para cada item no disco.  E, finalmente, itera os assinantes registrados e chama o m√©todo didReceive com uma lista de dados. <br><br>  O problema provavelmente √© que n√£o h√° dados em <i>/ Library / Caches / MetricKit / Reports</i> , mas sabemos que precisamos de algumas inst√¢ncias arquivadas do MXMetricPayload.  Ent√£o, vamos cri√°-los e coloc√°-los em disco antes de chamar ' <i>_checkAndDeliverMetricReports</i> '.  Novamente, o plano √© criar uma inst√¢ncia do MXMetricPayload, criar e adicionar qualquer tipo de MXMetric a ele e arquivar a inst√¢ncia de dados no disco.  Afinal, chame o m√©todo ' <i>_checkAndDeliverMetricReports</i> ', isso deve levar a chamar nosso assinante com stub como argumento. <br><br>  Examinando os documentos da Apple sobre carga √∫til e m√©tricas, voc√™ pode perceber que eles n√£o possuem inicializadores p√∫blicos, e a maioria das propriedades √© somente leitura.  Ent√£o, como √© poss√≠vel instanciar uma classe? <br><br>  Volte ao Hopper novamente para ver uma lista dos m√©todos <b>MXMetricPayload</b> : <br><br><img src="https://habrastorage.org/getpro/habr/post_images/3d6/e2a/12c/3d6e2a12c6d296f9f88f811068b4762d.png" alt="imagem"><br><br>  Aqui voc√™ pode ver seus inicializadores e m√©todos para atribuir par√¢metros.  √â f√°cil chamar m√©todos privados usando a classe <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">NSInvocation</a> e o m√©todo 'performSelector' devido √† natureza din√¢mica do Objective-C. <br><br>  Como exemplo, criaremos m√©tricas para a CPU e as adicionaremos √† carga √∫til.  Usando este link, voc√™ pode encontrar o fragmento de c√≥digo completo: [ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">https://gist.github.com/deszip/a0cf877b07cc2877129e0aaef2fed1e4</a> ]. <br><br>  E, finalmente, arquivamos tudo o que criamos e <i>gravamos</i> os dados no <i>diret√≥rio / Library / Caches / MetricKit / Reports</i> . <br><br>  Agora √© hora de chamar o m√©todo ' <i>_checkAndDeliverMetricReports</i> ', que deve levar a uma chamada para o assinante.  Desta vez, passamos os dados com carga √∫til stubbed como argumento como argumento. <br><br><h3>  De onde v√™m as m√©tricas </h3><br>  A obten√ß√£o de relat√≥rios √© muito f√°cil de implementar por meio do <b>MetricKit</b> , mas voc√™ provavelmente est√° interessado em aprender como os relat√≥rios aparecem no diret√≥rio <i>app / Library</i> .  Aqui est√° como. <br><br>  Cavando dentro do bin√°rio MetricKit, notei este m√©todo: '_createXPCConnection'.  A verifica√ß√£o de sua implementa√ß√£o esclarece a situa√ß√£o - ele cria uma NSXPCConnection para servi√ßo com o nome <i>com.apple.metrickit.xpc</i> e duas interfaces <b>MXXPCServer</b> e <b>MXXPCClient</b> para os lados do cliente e do servidor.  Se voc√™ olhar para a descri√ß√£o do protocolo: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/0ae/6ac/fe4/0ae6acfe4f83220d86aa7e61b9690cf5.png" alt="imagem"><br><br><h3>  Conclus√£o </h3><br>  <b>MetricKit</b> √© uma ferramenta √∫nica e indispens√°vel para cuidar do desempenho de sua aplica√ß√£o em condi√ß√µes reais de produ√ß√£o. <br><br>  Infelizmente, atualmente n√£o √© poss√≠vel dar uma olhada na interface do usu√°rio 'Metric' no Xcode, exceto no que foi mostrado durante uma demonstra√ß√£o em uma sess√£o da WWDC. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/8b9/2ec/8af/8b92ec8aff5e8566f00506333e0e4206.png" alt="imagem"><br><br>  Pode ser uma ferramenta inestim√°vel para levar a experi√™ncia do usu√°rio ao pr√≥ximo n√≠vel, eliminando problemas de desempenho no seu c√≥digo. <br><br>  Uma desvantagem que vejo agora nesta ferramenta √© a falta de detalhes para cada tipo: apenas a separa√ß√£o √© a vers√£o do aplicativo e voc√™ n√£o pode ver nenhuma m√©trica para um grupo espec√≠fico de dispositivos / vers√µes / regi√µes do SO, etc. <br><br>  Mas, √© claro, sempre h√° a oportunidade de enviar dados para voc√™ mesmo para processamento adicional, juntamente com informa√ß√µes importantes que voc√™ precisa.  Voc√™ pode anex√°-lo a tarefas no seu rastreador de bugs e muito mais.  No <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">AppSpector,</a> nossa equipe est√° trabalhando para expandir a funcionalidade das ferramentas de monitoramento de desempenho usando dados obtidos do <b>MetricKit</b> . <br><br>  Mantenha-se atualizado! </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt468347/">https://habr.com/ru/post/pt468347/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt468337/index.html">Trabalhando com o cron para Android e adicionando um script de shell √† execu√ß√£o autom√°tica quando o dispositivo √© inicializado</a></li>
<li><a href="../pt468339/index.html">Apresentando o Tema Escuro para o Visual Studio App Center</a></li>
<li><a href="../pt468341/index.html">Shell de nuvem do Azure no terminal do Windows</a></li>
<li><a href="../pt468343/index.html">Jeff Bezos: "Indo para o espa√ßo para o bem da terra"</a></li>
<li><a href="../pt468345/index.html">GitHub lan√ßa seus tent√°culos no gerenciamento de CI / CD e artefatos</a></li>
<li><a href="../pt468351/index.html">Microestrutura de mercado e sele√ß√£o adversa</a></li>
<li><a href="../pt468363/index.html">Minha magnum opus do mundo dos jogos para celular</a></li>
<li><a href="../pt468367/index.html">Amazon anuncia plano de aquecimento global</a></li>
<li><a href="../pt468369/index.html">Como eu criei o "WildMAN" - uma par√≥dia de muitos jogos de 8 bits e o portei recentemente para o Android</a></li>
<li><a href="../pt468377/index.html">8 hist√≥rias sobre o interior da China. O que n√£o √© mostrado aos estrangeiros</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>