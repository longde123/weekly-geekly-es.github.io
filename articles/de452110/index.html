<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🤲🏻 🛌🏿 🐭 Automatisieren Sie den Festplattenaustausch mit Ansible 🚍 🕘 👨‍👧‍👦</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hallo an alle. Ich arbeite als führender Systemadministrator in OK und bin für den stabilen Betrieb des Portals verantwortlich. Ich möchte darüber spr...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Automatisieren Sie den Festplattenaustausch mit Ansible</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/odnoklassniki/blog/452110/"><img src="https://habrastorage.org/webt/s9/ga/q9/s9gaq9eke8gooeu1-nnsr5ocv7o.jpeg"><br><br>  Hallo an alle.  Ich arbeite als führender Systemadministrator in OK und bin für den stabilen Betrieb des Portals verantwortlich.  Ich möchte darüber sprechen, wie wir den Prozess des automatischen Austauschs von Festplatten aufgebaut haben und dann als Administrator von diesem Prozess ausgeschlossen und durch einen Bot ersetzt wurden. <br><br>  Dieser Artikel ist eine Art Transliteration der <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Leistung</a> bei HighLoad + 2018 <br><a name="habracut"></a><br><h2>  Erstellen eines Disc-Austauschprozesses </h2><br><h3>  Zuerst ein paar Zahlen </h3><br>  OK ist ein gigantischer Dienst, der von Millionen von Menschen genutzt wird.  Es wird von etwa 7.000 Servern bedient, die sich in 4 verschiedenen Rechenzentren befinden.  Die Server kosten mehr als 70.000 Laufwerke.  Wenn Sie sie übereinander stapeln, erhalten Sie einen Turm mit einer Höhe von mehr als 1 km. <br><br>  Festplatten sind eine Komponente des Servers, die am häufigsten abstürzt.  Bei solchen Volumina müssen wir ungefähr 30 Scheiben pro Woche wechseln, und dieses Verfahren ist zu einer nicht sehr angenehmen Routine geworden. <br><br><img src="https://habrastorage.org/webt/i8/92/cg/i892cglklhooat_z_qrsexsmzfu.png"><br><br><h3>  Vorfälle </h3><br>  Wir haben ein vollwertiges Incident Management in unserem Unternehmen eingeführt.  Jeder Vorfall, den wir in Jira aufzeichnen und dann lösen und zerlegen.  Wenn der Vorfall Auswirkungen auf die Benutzer hatte, werden wir auf jeden Fall darüber nachdenken, wie wir in solchen Fällen schneller reagieren, den Effekt reduzieren und natürlich eine Wiederholung verhindern können. <br><br>  Laufwerke sind keine Ausnahme.  Ihr Status wird von Zabbix überwacht.  Wir überwachen Nachrichten in Syslog auf Schreib- / Lesefehler, analysieren den Status von HW / SW-Raids, überwachen SMART und berechnen den Verschleiß von SSDs. <br><br><h3>  Wie sich die Discs zuvor geändert haben </h3><br>  Wenn in Zabbix ein Auslöser aufleuchtet, wird in Jira ein Vorfall erstellt und automatisch an die entsprechenden Ingenieure in den Rechenzentren weitergeleitet.  Wir tun dies bei allen HW-Vorfällen, dh solchen, bei denen physische Arbeit mit den Geräten im Rechenzentrum erforderlich ist. <br>  Ein Ingenieur eines Rechenzentrums ist eine Person, die Probleme im Zusammenhang mit der Hardware löst und für die Installation, Wartung und Demontage von Servern verantwortlich ist.  Nachdem der Ingenieur ein Ticket erhalten hat, beginnt er mit der Arbeit.  In Plattenregalen wechselt er die Platten selbst.  Wenn er jedoch keinen Zugriff auf das gewünschte Gerät hat, bittet der Techniker die diensthabenden Systemadministratoren um Hilfe.  Zunächst müssen Sie die Festplatte aus der Rotation entfernen.  Dazu müssen Sie die erforderlichen Änderungen auf dem Server vornehmen, die Anwendung stoppen und die Bereitstellung der Festplatte aufheben. <br><br>  Der während der Schicht diensthabende Systemadministrator ist für den Betrieb des gesamten Portals verantwortlich.  Er untersucht Vorfälle, repariert und hilft Entwicklern bei kleinen Aufgaben.  Er beschäftigt sich nicht nur mit Festplatten. <br><br>  Zuvor unterhielten sich Rechenzentrumsingenieure mit dem Systemadministrator.  Ingenieure schickten Links zu Jira-Tickets, der Administrator ging sie durch und führte ein Arbeitsprotokoll in einem Notizblock.  Chats sind jedoch für solche Aufgaben unpraktisch: Die Informationen dort sind nicht strukturiert und gehen schnell verloren.  Und der Administrator konnte sich einfach vom Computer entfernen und einige Zeit nicht auf Anfragen reagieren, und der Ingenieur stand mit ein paar Festplatten am Server und wartete. <br><br>  Das Schlimmste war jedoch, dass die Administratoren nicht das ganze Bild sahen: Welche Festplattenvorfälle gibt es, bei denen das Problem möglicherweise auftreten könnte?  Dies liegt an der Tatsache, dass wir alle HW-Vorfälle an Ingenieure weitergeben.  Ja, es war möglich, alle Vorfälle im Admin-Dashboard anzuzeigen.  Aber es gibt viele von ihnen, und der Administrator war nur an einigen von ihnen beteiligt. <br><br>  Darüber hinaus konnte der Techniker keine korrekten Prioritäten setzen, da er nichts über den Zweck bestimmter Server und die Verteilung von Informationen auf Laufwerke weiß. <br><br><h3>  Neues Austauschverfahren </h3><br>  Das erste, was wir getan haben, war, alle Festplattenvorfälle in einen separaten Typ von "HW-Festplatte" zu packen und die Felder "Gerätenamen blockieren", "Größe" und "Festplattentyp" hinzuzufügen, damit diese Informationen im Ticket gespeichert werden und nicht müssen ständig chatten. <br><br><div style="text-align:center;"><img width="300" height="400" src="https://habrastorage.org/webt/0y/uz/jm/0yuzjmgoz4hgulcpf5o5vhwde18.png"></div><br>  Wir haben uns auch darauf geeinigt, dass wir im Rahmen eines Vorfalls nur eine Festplatte wechseln werden.  Dies vereinfachte den Automatisierungsprozess, die Statistikerfassung und die Arbeit erheblich. <br><br>  Außerdem wurde das Feld "Verantwortlicher Administrator" hinzugefügt.  Der Systemadministrator wird dort automatisch ersetzt.  Dies ist sehr praktisch, da der Ingenieur jetzt immer sieht, wer verantwortlich ist.  Sie müssen nicht zum Kalender gehen und suchen.  In diesem Feld konnten Tickets in das Dashboard des Administrators gestellt werden, in dem möglicherweise seine Hilfe benötigt wurde. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/9x/b1/ue/9xb1ueokh0450wgkhq0ije1lfqa.png"></div><br>  Um sicherzustellen, dass alle Teilnehmer den größtmöglichen Nutzen aus den Innovationen ziehen, haben wir Filter und Dashboards erstellt und den Jungs davon erzählt.  Wenn Menschen die Veränderungen verstehen, distanzieren sie sich nicht von ihnen als von etwas Unnötigem.  Für einen Techniker ist es wichtig, die Rack-Nummer, in der sich der Server befindet, sowie die Größe und den Typ der Festplatte zu kennen.  Der Administrator muss zunächst verstehen, um welche Art von Servergruppe es sich handelt und welche Auswirkungen dies beim Ersetzen einer Festplatte haben kann. <br><br>  Das Vorhandensein von Feldern und deren Anzeige ist praktisch, aber dies hat uns nicht vor der Notwendigkeit bewahrt, Chats zu verwenden.  Dazu musste ich den Workflow ändern. <br><br>  Früher war es so: <br><br><div style="text-align:center;"><img width="300" height="400" src="https://habrastorage.org/webt/we/wc/du/wewcdu4q8fqy-gd9wkbutorbabi.png"></div><br>  Heute arbeiten Ingenieure so weiter, wenn sie keine Administratorhilfe benötigen. <br><br>  Als erstes haben wir einen neuen <b>Untersuchungsstatus eingeführt</b> .  Das Ticket befindet sich in diesem Status, wenn der Techniker noch nicht entschieden hat, ob er einen Administrator benötigt oder nicht.  Über diesen Status kann der Techniker das Ticket an den Administrator weitergeben.  Darüber hinaus markieren wir Tickets mit diesem Status, wenn ein Festplattenwechsel erforderlich ist, sich jedoch keine Festplatte selbst auf der Site befindet.  Dies geschieht bei CDNs und Remote-Standorten. <br><br>  Wir haben auch den Status <b>Bereit</b> hinzugefügt.  Das Ticket wird nach dem Ersetzen der Festplatte darauf übertragen.  Das heißt, alles wurde bereits erledigt, aber HW / SW-RAID wird auf dem Server synchronisiert.  Dies kann sehr zeitaufwändig sein. <br><br>  Wenn ein Administrator beteiligt ist, ist das Schema etwas komplizierter. <br><br><div style="text-align:center;"><img width="400" src="https://habrastorage.org/webt/ev/5a/58/ev5a58jyosbyuc8cfrhr7sru5zo.png"></div><br>  Ab dem Status " <b>Öffnen</b> " kann ein Ticket sowohl von einem Systemadministrator als auch von einem Techniker übertragen werden.  Im Status " <b>In Bearbeitung"</b> entfernt der Administrator die Festplatte aus der Rotation, sodass der Techniker sie einfach entfernen kann: Je nach Servergruppe wird die Hintergrundbeleuchtung eingeschaltet, die Bereitstellung der Festplatte aufgehoben und Anwendungen gestoppt. <br><br>  Dann wird das Ticket in <b>Ready to change</b> konvertiert: Dies ist ein Signal an den Techniker, dass die Festplatte herausgezogen werden kann.  Alle Felder in Jira sind bereits ausgefüllt, der Ingenieur weiß, welcher Typ und welche Größe die Festplatte hat.  Diese Daten werden entweder automatisch oder vom Administrator auf den vorherigen Status angehängt. <br><br>  Nach dem Ersetzen der Festplatte wird das Ticket in den Status " <b>Geändert</b> " versetzt.  Es wird überprüft, ob der richtige Datenträger eingelegt wurde, das Markup durchgeführt, die Anwendung gestartet und einige Datenwiederherstellungsaufgaben ausgeführt wurden.  Das Ticket kann auch in den Status " <b>Bereit</b> " versetzt werden. In diesem Fall bleibt der Administrator verantwortlich, da er die Festplatte abwechselnd gestartet hat.  Der vollständige Umriss sieht so aus. <br><br><div style="text-align:center;"><img width="500" src="https://habrastorage.org/webt/xg/x7/_z/xgx7_zk2mlyubhzepgfw0oogbt4.png"></div><br>  Das Hinzufügen neuer Felder hat unser Leben viel einfacher gemacht.  Die Jungs begannen mit strukturierten Informationen zu arbeiten, es wurde klar, was und zu welchem ​​Zeitpunkt zu tun war.  Prioritäten sind viel relevanter geworden, da sie jetzt vom Administrator festgelegt werden. <br><br>  Das Bedürfnis nach Chats ist verschwunden.  Natürlich kann der Administrator dem Techniker schreiben, "Sie müssen hier schneller ersetzen" oder "bereits abends, haben Sie Zeit zum Ersetzen?"  Wir unterhalten uns jedoch nicht mehr täglich über diese Themen. <br><br>  Die Festplatten begannen sich in Packungen zu wechseln.  Wenn der Administrator etwas früher zur Arbeit kam, er Freizeit hat und nichts passiert ist, kann er eine Reihe von Servern für den Austausch vorbereiten: Felder ablegen, Festplatten aus der Rotation entfernen und die Aufgabe an den Techniker übertragen.  Ein Techniker kommt später im Rechenzentrum an, sieht die Aufgabe, nimmt die erforderlichen Laufwerke aus dem Lager und ändert sie sofort.  Infolgedessen hat sich die Austauschgeschwindigkeit erhöht. <br><br><h3>  Lehren aus dem Erstellen von Workflows </h3><br><ul><li>  <b>Beim Erstellen einer Prozedur müssen Sie Informationen aus verschiedenen Quellen sammeln.</b> <br>  Einige unserer Administratoren wussten nicht, dass der Techniker die Festplatten selbst ausgetauscht hat.  Einige dachten, dass Ingenieure die MD RAID-Synchronisation überwachten, obwohl einige von ihnen nicht einmal Zugriff darauf hatten.  Einige führende Ingenieure haben dies getan, aber nicht immer, da der Prozess nirgendwo beschrieben wurde. </li><li>  <b>Das Verfahren sollte einfach und unkompliziert sein.</b> <br>  Es fällt einem Menschen schwer, viele Schritte im Kopf zu behalten.  Die wichtigsten Nachbarstatus in Jira müssen auf dem Hauptbildschirm angezeigt werden.  Sie können sie umbenennen, z. B. In Bearbeitung rufen wir Ready to change auf.  Und die verbleibenden Status können im Dropdown-Menü ausgeblendet werden, damit sie keine Kallusaugen verursachen.  Es ist jedoch besser, die Menschen nicht einzuschränken und die Möglichkeit zu geben, den Übergang zu vollziehen. <br>  Erklären Sie den Wert von Innovation.  Wenn die Leute verstehen, akzeptieren sie das neue Verfahren besser.  Für uns war es sehr wichtig, dass die Leute den gesamten Prozess nicht aufriefen, sondern ihm folgten.  Dann haben wir auf dieser Automatisierung aufgebaut. </li><li>  <b>Warten, analysieren, verstehen.</b> <br>  Wir haben ungefähr einen Monat gebraucht, um das Verfahren, die technische Implementierung, die Besprechungen und die Diskussionen zu erstellen.  Und für die Umsetzung - mehr als drei Monate.  Ich habe gesehen, wie die Leute langsam anfangen, die Innovation zu nutzen.  In den frühen Stadien gab es viel Negativität.  Er war jedoch völlig unabhängig vom Verfahren selbst, seiner technischen Umsetzung.  Beispielsweise hat ein Administrator Jira nicht verwendet, aber das Jira-Plugin in Confluence, und einige Dinge standen ihm nicht zur Verfügung.  Hat ihm Jira gezeigt, hat der Administrator die Produktivität und die Gesamtaufgaben sowie das Ersetzen von Festplatten erhöht. </li></ul><br><h2>  Automatisierung des Antriebswechsels </h2><br>  Wir sind mehrmals zur Automatisierung des Austauschs von Festplatten übergegangen.  Wir hatten bereits Betriebszeit, Skripte, aber alle arbeiteten entweder interaktiv oder im manuellen Modus. Sie mussten gestartet werden.  Und erst nach der Einführung des neuen Verfahrens stellten wir fest, dass wir nur vermisst wurden. <br><br>  Da der Austauschprozess jetzt in Phasen unterteilt ist, von denen jede einen Ausführenden und eine Liste von Aktionen enthält, können wir die Automatisierung schrittweise und nicht alle gleichzeitig aktivieren.  Zum Beispiel kann der einfachste Schritt - Bereit (Überprüfen der RAID- / Datensynchronisation) einfach an den Bot delegiert werden.  Wenn der Bot ein wenig lernt, können Sie ihm eine verantwortungsvollere Aufgabe geben - das Drehen der Festplatte usw. <br><br><h3>  Zoo-Setups </h3><br>  Bevor wir über den Bot sprechen, machen wir einen kurzen Ausflug zu unserem Installationszoo.  Dies ist vor allem auf die gigantische Größe unserer Infrastruktur zurückzuführen.  Zweitens versuchen wir für jeden Service die optimale Konfiguration des Eisens zu wählen.  Wir haben ungefähr 20 Hardware-RAID-Modelle, hauptsächlich LSI und Adaptec, aber es gibt sowohl HP als auch DELL mit unterschiedlichen Versionen.  Jeder RAID-Controller verfügt über ein eigenes Verwaltungsdienstprogramm.  Der Befehlssatz und die Ausgabe dieser Befehle können von Version zu Version jedes RAID-Controllers unterschiedlich sein.  Wenn HW-RAID nicht verwendet wird, kann es Angst haben. <br><br>  Fast alle Neuinstallationen werden ohne Festplatten-Backup durchgeführt.  Wir versuchen, kein Hardware- und Software-RAID mehr zu verwenden, da wir unsere Systeme auf der Ebene von Rechenzentren und nicht von Servern reservieren.  Aber natürlich gibt es viele Legacy-Server, die unterstützt werden müssen. <br><br>  Irgendwo werfen die Festplatten in den RAID-Controllern unformatierte Geräte, irgendwo verwenden sie JBOD.  Es gibt Konfigurationen mit einem Systemlaufwerk auf dem Server. Wenn Sie es ersetzen müssen, müssen Sie den Server bei der Installation des Betriebssystems und der Anwendungen mit denselben Versionen neu formatieren, dann Konfigurationsdateien hinzufügen und Anwendungen starten.  Es gibt auch viele Servergruppen, bei denen Redundanz nicht auf der Ebene des Festplattensubsystems, sondern direkt in den Anwendungen selbst ausgeführt wird. <br><br>  Insgesamt haben wir mehr als 400 eindeutige Servergruppen, auf denen etwa 100 verschiedene Anwendungen ausgeführt werden.  Um eine so große Anzahl von Optionen abzudecken, brauchten wir ein multifunktionales Automatisierungstool.  Es ist ratsam, ein einfaches DSL zu verwenden, damit nicht nur die Person, die dies geschrieben hat, es unterstützen kann. <br><br>  Wir haben uns für Ansible entschieden, weil es agentenlos ist: Es war nicht erforderlich, die Infrastruktur vorzubereiten und schnell zu starten.  Darüber hinaus ist es in Python geschrieben, das im Team als Standard akzeptiert wird. <br><br><h3>  Allgemeines Schema </h3><br>  Schauen wir uns ein allgemeines Automatisierungsschema am Beispiel eines Vorfalls an.  Zabbix erkennt, dass das SDB-Laufwerk nicht in Betrieb ist, der Auslöser leuchtet auf und in Jira wird ein Ticket erstellt.  Der Administrator sah es sich an und stellte fest, dass dies kein Duplikat und kein falsch positives Ergebnis ist. Das heißt, Sie müssen die Festplatte ändern und das laufende Ticket übersetzen. <br><br><img src="https://habrastorage.org/webt/9s/fy/q5/9sfyq5cucem0dbbhahfd3_w7tac.png"><br>  Die in Python geschriebene DiskoBot-Anwendung fragt Jira regelmäßig nach neuen Tickets ab.  Es wird darauf hingewiesen, dass ein neues In Bearbeitung-Ticket angezeigt wurde und der entsprechende Thread ausgelöst wird, wodurch das Playbook in Ansible gestartet wird (dies erfolgt für jeden Status in Jira).  In diesem Fall wird Prepare2change gestartet. <br><br>  Ansible geht zum Host, entfernt die Festplatte aus der Rotation und meldet den Status über Rückrufe an die Anwendung. <br><br><img src="https://habrastorage.org/webt/i2/bk/nq/i2bknqits8exw9dtr7sj4zydl58.png"><br>  Entsprechend den Ergebnissen überträgt der Bot das Ticket automatisch an Ready to change.  Der Techniker erhält eine Benachrichtigung und wechselt die Festplatte. Anschließend überträgt er das Ticket an Changed. <br><br><img src="https://habrastorage.org/webt/h9/m8/zw/h9m8zwfrzltmu0q1tz8opctrccu.png"><br>  Gemäß dem obigen Schema kehrt das Ticket zum Bot zurück, startet ein weiteres Playbook, geht zum Host und gibt die Festplatte in Rotation ein.  Der Bot schließt das Ticket.  Hurra! <br><br><img src="https://habrastorage.org/webt/cv/js/w1/cvjsw1y9qrpkra2twsx-sy4jokc.png"><br>  Lassen Sie uns nun über einige Komponenten des Systems sprechen. <br><br><h3>  Diskobot </h3><br>  Diese Anwendung ist in Python geschrieben.  Es wählt Tickets von Jira gemäß <abbr title="JIRA-Abfragesprache">JQL aus</abbr> .  Abhängig vom Ticketstatus gelangt dieser zum entsprechenden Handler, der seinerseits den entsprechenden Ansible-Playbook-Status startet. <br><br>  JQL- und Abfrageintervalle sind in der Anwendungskonfigurationsdatei definiert. <br><br><pre><code class="plaintext hljs">jira_states: investigate: jql: '… status = Open and "Disk Size" is EMPTY' interval: 180 inprogress: jql: '… and "Disk Size" is not EMPTY and "Device Name" is not EMPTY' ready: jql: '… and (labels not in ("dbot_ignore") or labels is EMPTY)' interval: 7200</code> </pre> <br>  Beispielsweise werden unter den Tickets im Status "In Bearbeitung" nur diejenigen mit den Feldern "Datenträgergröße" und "Gerätename" ausgefüllt.  Gerätename ist der Name des Blockgeräts, das zum Ausführen des Playbooks benötigt wird.  Die Festplattengröße wird benötigt, damit der Techniker weiß, welche Festplattengröße benötigt wird. <br><br>  Bei Tickets mit dem Status "Bereit" werden Tickets mit dem Label "dbot_ignore" herausgefiltert.  Übrigens verwenden wir Jira-Labels sowohl zum Filtern als auch zum Markieren doppelter Tickets und zum Sammeln von Statistiken. <br><br>  Wenn das Playbook abstürzt, weist Jira das Label dbot_failed zu, damit Sie es später herausfinden können. <br><br><h3>  Interaktion mit Ansible </h3><br>  Die Anwendung interagiert mit Ansible über die <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Ansible Python-API</a> .  In playbook_executor übergeben wir den Dateinamen und die Variablen.  Auf diese Weise können Sie das Ansible-Projekt in Form von regulären yml-Dateien beibehalten, anstatt es in Python-Code zu beschreiben. <br><br>  Auch in Ansible über * extra_vars * wird der Name des Blockgeräts, der Status des Tickets sowie callback_url verwendet, in dem der Ausgabeschlüssel verkabelt ist - er wird für den Rückruf in HTTP verwendet. <br><br>  Für jeden Start wird ein temporäres Inventar generiert, das aus einem Host und der Gruppe besteht, zu der dieser Host gehört, sodass group_vars angewendet wird. <br><br>  Hier ist ein Beispiel für eine Aufgabe, in der ein HTTP-Rückruf implementiert ist. <br><br>  Das Ergebnis der Playbooks erhalten wir mit Callaback (s).  Es gibt zwei Arten: <br><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Ansible Callback Plugin</a> , es liefert Daten über die Ergebnisse eines Playbooks.  Es beschreibt die Aufgaben, die gestartet, erfolgreich oder erfolglos ausgeführt wurden.  Dieser Rückruf wird am Ende des Playbooks aufgerufen. </li><li>  HTTP-Rückruf, um Informationen beim Abspielen eines Playbooks abzurufen.  In Ansible führen wir eine POST / GET-Anforderung an die Seite unserer Anwendung aus. </li></ul><br>  Über HTTP-Rückrufe werden Variablen übertragen, die während der Ausführung des Playbooks definiert wurden und die wir speichern und in nachfolgenden Läufen verwenden möchten.  Wir schreiben diese Daten in SQLite. <br><br>  Auch durch HTTP-Rückruf hinterlassen wir Kommentare und ändern den Ticketstatus. <br><br><div class="spoiler">  <b class="spoiler_title">HTTP-Rückruf</b> <div class="spoiler_text"><pre> <code class="plaintext hljs"># Make callback to Diskobot App # Variables: # callback_post_body: # A dict with follow keys. All keys are optional # msg: If exist it would be posted to Jira as comment # data: If exist it would be saved in Incident.variables # desire_state: Set desire_state for incident # status: If exist Proceed issue to that status - name: Callback to Diskobot app (jira comment/status) uri: url: "{{ callback_url }}/{{ devname }}" user: "{{ diskobot_user }}" password: "{{ diskobot_pass }}" force_basic_auth: True method: POST body: "{{ callback_post_body | to_json }}" body_format: json delegate_to: 127.0.0.1</code> </pre><br></div></div><br>  Wie viele Aufgaben derselben Art legen wir sie in einer separaten gemeinsamen Datei ab und fügen sie bei Bedarf hinzu, um sie nicht ständig in Spielbüchern zu wiederholen.  Hier wird die Rückruf-URL angezeigt, in der der Ausgabeschlüssel und der Hostname geschützt sind.  Wenn Ansible diese POST-Anforderung ausführt, erkennt der Bot, dass sie Teil eines solchen Vorfalls war. <br><br>  Und hier ist ein Beispiel aus einem Playbook, in dem wir eine Diskette von einem MD-Gerät angezeigt haben: <br><br><pre> <code class="plaintext hljs"> # Save mdadm configuration - include: common/callback.yml vars: callback_post_body: status: 'Ready to change' msg: "Removed disk from mdraid {{ mdadm_remove_disk.msg | comment_jira }}" data: mdadm_data: "{{ mdadm_remove_disk.removed }}" parted_info: "{{ parted_info | default() }}" when: - mdadm_remove_disk | changed - mdadm_remove_disk.removed</code> </pre><br>  Diese Aufgabe versetzt das Jira-Ticket in den Status "Bereit zum Ändern" und fügt einen Kommentar hinzu.  Außerdem speichert die Variable mdam_data die Liste der md-Geräte, von denen die Festplatte gelöscht wurde, und den parted_-Speicherauszug der partierten Partition in parted_info. <br><br>  Wenn der Techniker eine neue Festplatte einlegt, können wir diese Variablen verwenden, um den Partitionsspeicherauszug wiederherzustellen und die Festplatte in die MD-Geräte einzulegen, von denen sie gelöscht wurde. <br><br><h3>  Ansible Check-Modus </h3><br>  Das Einschalten der Automatisierung war beängstigend.  Aus diesem Grund haben wir beschlossen, alle Playbooks im Modus auszuführen <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Trockenlauf</a> , bei dem Ansible keine Aktionen auf den Servern ausführt, sondern nur emuliert. <br><br>  Ein solcher Start wird über ein separates Rückrufmodul ausgeführt, und das Ergebnis des Playbooks wird in Jira als Kommentar gespeichert. <br><br><img src="https://habrastorage.org/webt/aa/rz/0s/aarz0srsrqqxbru88guob9spjqm.png"><br><br>  Erstens erlaubte es, die Arbeit des Bots und der Spielbücher zu validieren.  Zweitens wurde das Vertrauen der Administratoren in den Bot erhöht. <br><br>  Als wir die Validierung durchlaufen haben und festgestellt haben, dass Sie Ansible nicht nur im Trockenlaufmodus ausführen können, haben wir in Jira die Schaltfläche "Diskobot ausführen" aktiviert, um dasselbe Playbook mit denselben Variablen auf demselben Host, jedoch im normalen Modus, zu starten. <br><br>  Darüber hinaus wird die Schaltfläche verwendet, um das Playbook im Falle eines Fehlers neu zu starten. <br><br><h3>  Playbooks Struktur </h3><br>  Ich habe bereits erwähnt, dass der Bot je nach Status des Jira-Tickets verschiedene Playbooks startet. <br><br>  Erstens ist es viel einfacher, einen Eintrag zu arrangieren. <br>  Zweitens ist es in einigen Fällen einfach notwendig. <br><br>  Wenn Sie beispielsweise eine Systemfestplatte ersetzen, müssen Sie zuerst zum Bereitstellungssystem wechseln, eine Aufgabe erstellen. Nach der korrekten Bereitstellung kann der Server über ssh aufgerufen werden, und Sie können die Anwendung darauf rollen.  Wenn wir dies alles in einem Playbook tun würden, könnte Ansible es aufgrund der Unzugänglichkeit des Hosts nicht ausführen. <br><br>  Wir verwenden Ansible-Rollen für jede Servergruppe.  Hier können Sie sehen, wie die Playbooks in einem von ihnen organisiert sind. <br><br><img src="https://habrastorage.org/webt/ef/0o/hu/ef0ohuo0obwa1htij7o4at6dvus.png"><br><br>  Dies ist praktisch, da sofort klar ist, wo sich welche Aufgaben befinden.  In main.yml, der Eingabe für die Ansible-Rolle, können wir nur den Ticketstatus oder allgemeine Aufgaben angeben, die für alle erforderlich sind, z. B. das Übergeben der Identifikation oder das Empfangen eines Tokens. <br><br><h4>  Investigation.yml </h4><br>  Läuft für Tickets im Status "Untersuchung" und "Offen".  Das Wichtigste für dieses Playbook ist der Name des Blockgeräts.  Diese Informationen sind nicht immer verfügbar. <br><br>  Um dies zu erreichen, analysieren wir die Jira-Zusammenfassung, den letzten Wert des Zabbix-Triggers.  Es kann den Namen des Blockgeräts enthalten - zum Glück.  Oder es enthält einen Mount-Punkt. Dann müssen Sie zum Server gehen, das gewünschte Laufwerk analysieren und berechnen.  Ein Trigger kann auch eine SCSI-Adresse oder andere Informationen übertragen.  Es kommt aber auch vor, dass es keine Hinweise gibt und man analysieren muss. <br><br>  Nachdem wir den Namen des Blockgeräts herausgefunden haben, sammeln wir Informationen über den Typ und die Größe der Festplatte, um die Felder in Jira auszufüllen.  Wir entfernen auch Informationen über den Hersteller, das Modell, die Firmware, die ID und SMART und fügen all dies in einen Kommentar im Jira-Ticket ein.  Der Administrator und der Techniker müssen nicht mehr nach diesen Daten suchen.  :) :) <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/m6/64/kr/m664krcgyi4vkc-rq0almmqv6uy.png"></div><br><br><h4>  prepare2change.yml </h4><br>  Die Ausgabe der Platte aus der Rotation, Vorbereitung für den Austausch.  Die schwierigste und entscheidende Phase.  Hier können Sie die Anwendung stoppen, wenn sie nicht gestoppt werden kann.  Oder ziehen Sie eine Festplatte heraus, die nicht über genügend Replikate verfügt und sich dadurch auf die Benutzer auswirkt, und verlieren Sie einige Daten.  Hier haben wir die meisten Überprüfungen und Benachrichtigungen im Chat. <br><br>  Im einfachsten Fall handelt es sich um das Entfernen eines Laufwerks aus HW / MD RAID. <br><br>  In komplexeren Situationen (in unseren Speichersystemen) müssen Sie, wenn die Sicherung auf Anwendungsebene durchgeführt wird, mithilfe der API zur Anwendung wechseln, die Festplattenausgabe melden, sie deaktivieren und die Wiederherstellung starten. <br><br>  Wir migrieren jetzt massiv in die <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Cloud</a> . Wenn der Server trübe ist, greift Diskobot auf die Cloud-API zu und sagt, dass dies mit diesem Minion - dem Server, auf dem die Container ausgeführt werden - funktioniert. Er fragt, ob alle Container von diesem Minion migriert werden sollen.  Gleichzeitig wird die Hintergrundbeleuchtung eingeschaltet, sodass der Techniker sofort sieht, welche herausgezogen werden muss. <br><br><h4>  geändert.yml </h4><br>  Nach dem Ersetzen einer Festplatte überprüfen wir zunächst deren Verfügbarkeit. <br><br>  Ingenieure legen nicht immer neue Discs ein, daher haben wir eine Überprüfung auf SMART-Werte hinzugefügt, die uns zufrieden stellen. <br><br><div class="spoiler">  <b class="spoiler_title">Welche Attribute betrachten wir?</b> <div class="spoiler_text">  Anzahl der neu zugewiesenen Sektoren (5) &lt;100 <br>  Aktuelle ausstehende Sektoranzahl (107) == 0 <br></div></div><br>  Wenn das Laufwerk den Test nicht besteht, wird der Techniker über einen Austausch informiert.  Wenn alles in Ordnung ist, wird die Hintergrundbeleuchtung ausgeschaltet, das Markup wird angewendet und die Festplatte wird in Rotation eingelegt. <br><br><h4>  ready.yml </h4><br>  Der einfachste Fall: Überprüfen der HW / SW-Raid-Synchronisation oder Beenden der Datensynchronisation in der Anwendung. <br><br><h3>  Anwendungs-API </h3><br>  Ich habe mehrmals erwähnt, dass der Bot häufig auf die Anwendungs-APIs zugreift.  Natürlich hatten nicht alle Anwendungen die notwendigen Methoden, deshalb musste ich sie verfeinern.  Hier sind die wichtigsten Methoden, die wir verwenden: <br><ul><li>  Status  Der Status eines Clusters oder einer Festplatte, um zu verstehen, ob es möglich ist, damit zu arbeiten. <br></li><li>  Start / Stopp.  Aktivierung-Deaktivierung der Festplatte; <br></li><li>  Migrieren / Wiederherstellen.  Migration und Datenwiederherstellung während und nach dem Austausch. <br></li></ul><br><h3>  Von Ansible gelernte Lektionen </h3><br>  Ich liebe Ansible wirklich.  Aber oft, wenn ich mir verschiedene OpenSource-Projekte anschaue und sehe, wie Leute Playbooks schreiben, bekomme ich ein bisschen Angst.  Komplexes logisches Geflecht aus Wann / Schleife, mangelnde Flexibilität und Idempotenz aufgrund der häufigen Verwendung von Shell / Befehl. <br><br>  Wir haben uns entschlossen, alles so weit wie möglich zu vereinfachen und die Ansible-Modularität zu nutzen.  Auf der höchsten Ebene befinden sich Playbooks. Sie können von jedem Administrator geschrieben werden, einem Drittentwickler, der Ansible ein wenig kennt. <br><br><pre> <code class="plaintext hljs">- name: Blink disk become: True register: locate_action disk_locate: locate: '{{ locate }}' devname: '{{ devname }}' ids: '{{ locate_ids | default(pd_id) | default(omit) }}'</code> </pre><br><br>  Wenn es schwierig ist, eine Logik in Playbooks zu implementieren, platzieren wir sie in einem Ansible-Modul oder -Filter.  Skripte können sowohl in Python als auch in einer anderen Sprache geschrieben werden. <br><br>  Sie sind einfach und schnell zu schreiben.  Beispielsweise besteht das Plattenhervorhebungsmodul, dessen Verwendungsbeispiel oben angegeben ist, aus 265 Zeilen. <br><br><img width="400" height="400" src="https://habrastorage.org/webt/c4/ma/bp/c4mabpsyezbjbfp2likixvta24k.png"><br><br>  Auf der untersten Ebene befindet sich die Bibliothek.  Für dieses Projekt haben wir eine separate Anwendung geschrieben, eine Art Abstraktion über die Hardware- und Software-RAIDs, die die entsprechenden Anforderungen ausführen. <br><br><img width="400" height="400" src="https://habrastorage.org/webt/qf/vt/pr/qfvtprdi9jw2vxserynmxbrmdg8.png"><br><br>  Die größten Stärken von Ansible sind die Einfachheit und die verständlichen Spielbücher.  Ich glaube, dass Sie dies verwenden müssen und keine beängstigenden Yaml-Dateien und eine große Anzahl von Bedingungen, Shell-Code und Schleifen generieren müssen. <br><br>  Wenn Sie unsere Erfahrungen mit der Ansible-API wiederholen möchten, beachten Sie zwei Dinge: <br><br><ul><li>  Playbook_executor und im Allgemeinen Playbook können nicht abgelaufen werden.  Es gibt eine Zeitüberschreitung in der SSH-Sitzung, aber keine Zeitüberschreitung im Playbook.  Wenn wir versuchen, die Bereitstellung eines Laufwerks aufzuheben, das noch nicht im System vorhanden ist, wird das Playbook unbegrenzt ausgeführt. Daher mussten wir es in einem separaten Wrapper einpacken und nach Zeitüberschreitung beenden. <br></li><li>  Ansible ist gegabelt, daher ist seine API nicht threadsicher.  Wir starten alle unsere Playbooks und Single-Threaded. <br></li></ul><br>  Dadurch konnten wir den Austausch von ca. 80% der Laufwerke automatisieren.  Im Allgemeinen hat sich die Ersatzrate verdoppelt.  Heute betrachtet der Administrator nur den Vorfall und entscheidet, ob die Festplatte geändert werden soll oder nicht, und macht dann einen Klick. <br><br>  Jetzt stellen wir uns jedoch einem anderen Problem: Einige neue Administratoren wissen nicht, wie sie Laufwerke wechseln sollen.  :) :) </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de452110/">https://habr.com/ru/post/de452110/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de452094/index.html">.NET: Tools zum Arbeiten mit Multithreading und Asynchronität. Teil 1</a></li>
<li><a href="../de452098/index.html">Protokolle des Frontend-Entwicklers Habr: Refactor und Reflex</a></li>
<li><a href="../de452102/index.html">Fotospiel für Drohnenliebhaber: kurz über AirSelfie 2</a></li>
<li><a href="../de452106/index.html">Wir laden Redner zum Sommer-DIY-Meeting am 16. Juni 2019 ein</a></li>
<li><a href="../de452108/index.html">Docker: harmloser Rat</a></li>
<li><a href="../de452112/index.html">CRM ++</a></li>
<li><a href="../de452114/index.html">HolyJS 2019: Nachbesprechung von SEMrush (Teil 1)</a></li>
<li><a href="../de452116/index.html">Indizes in PostgreSQL - 8 (RUM)</a></li>
<li><a href="../de452118/index.html">Wissenschaftler bricht den Code des mysteriösen Manuskripts von Voynich</a></li>
<li><a href="../de452122/index.html">"Pille vom Dämon" in Bewegung</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>