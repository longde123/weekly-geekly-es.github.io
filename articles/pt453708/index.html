<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üßòüèæ ü§ö ‚ñ™Ô∏è SO em tempo real AQUA RTOS para MK AVR em ambiente BASCOM AVR üî¥ üë©üèæ‚Äç‚úàÔ∏è üëÉüèæ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Ao escrever para o c√≥digo MK mais complicado do que "piscar uma luz", o desenvolvedor se depara com as limita√ß√µes inerentes √† programa√ß√£o linear no es...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>SO em tempo real AQUA RTOS para MK AVR em ambiente BASCOM AVR</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/453708/"> Ao escrever para o c√≥digo MK mais complicado do que "piscar uma luz", o desenvolvedor se depara com as limita√ß√µes inerentes √† programa√ß√£o linear no estilo de "supercycle mais interrup√ß√µes".  O processamento de interrup√ß√µes requer velocidade e concis√£o, o que leva a adicionar sinalizadores ao c√≥digo e tornar o estilo do projeto "super ciclo com interrup√ß√µes e sinalizadores". <br><br>  Se a complexidade do sistema aumenta, o n√∫mero de sinalizadores interdependentes aumenta exponencialmente, e o projeto rapidamente se transforma em um "c√≥digo de massa" pouco leg√≠vel e gerenci√°vel. <br><br>  O uso de sistemas operacionais em tempo real ajuda a se livrar do "c√≥digo de massa" e a devolver flexibilidade e capacidade de gerenciamento a um projeto MK complexo. <br>  V√°rios sistemas operacionais cooperativos em tempo real foram desenvolvidos e bastante populares para os microcontroladores AVR.  No entanto, todos eles s√£o escritos em C ou Assembler e n√£o s√£o adequados para quem programa o MK no ambiente do BASCOM AVR, privando-os de uma ferramenta t√£o √∫til para escrever aplicativos s√©rios. <br><br>  Para corrigir essa falha, desenvolvi um RTOS simples para o ambiente de programa√ß√£o BASCOM AVR, que chamo a aten√ß√£o dos leitores. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/cd6/0be/c64/cd60bec64b2a0b96ed562770a9063355.jpg" alt="imagem"><br><a name="habracut"></a><br>  Para muitos, o estilo familiar de programa√ß√£o MK √© o chamado  <i>supercycle</i> .  O c√≥digo nesse caso consiste em um conjunto de fun√ß√µes, procedimentos e descritores (constantes, vari√°veis), possivelmente bibliotecas, geralmente chamadas de "c√≥digo de segundo plano", bem como um loop infinito grande inclu√≠do em uma constru√ß√£o do <b>loop</b> .  Na partida, o equipamento do pr√≥prio MK e dos dispositivos externos √© inicializado primeiro, as constantes e os valores iniciais das vari√°veis ‚Äã‚Äãs√£o definidos e, em seguida, o controle √© transferido para esse super ciclo infinito. <br>  A simplicidade da super moto √© √≥bvia.  A maioria das tarefas executadas pelo MK, de uma maneira ou de outra, c√≠clica.  As desvantagens tamb√©m s√£o evidentes: se algum dispositivo ou sinal exigir uma rea√ß√£o imediata, o MK o fornecer√° assim que o ciclo mudar.  Se a dura√ß√£o do sinal for menor que o per√≠odo do ciclo, esse sinal ser√° ignorado. <br><br>  No exemplo abaixo, queremos verificar se o bot√£o est√° <b>pressionado</b> : <br><br><pre><code class="vbscript hljs"><span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-comment"><span class="hljs-comment">' -  if button = 1 then '     '  -  loop</span></span></code> </pre> <br>  Obviamente, se "algum c√≥digo" funcionar por tempo suficiente, o MK poder√° n√£o perceber um toque breve em um bot√£o. <br><br>  Felizmente, o MK est√° equipado com um sistema de interrup√ß√£o que pode resolver esse problema: todos os sinais cr√≠ticos podem ser "pendurados" nas interrup√ß√µes e um manipulador pode ser escrito para cada um.  Ent√£o, o pr√≥ximo n√≠vel aparece: um <i>super ciclo com interrup√ß√µes</i> . <br>  O exemplo abaixo mostra a estrutura do programa com uma super ciclo e uma interrup√ß√£o que processa um clique no bot√£o: <br><br><pre> <code class="vbscript hljs"><span class="hljs-keyword"><span class="hljs-keyword">on</span></span> button button_isr <span class="hljs-comment"><span class="hljs-comment">'    enable interrupts ' ***  *** do ' -  loop end '   button_isr: '  -    return</span></span></code> </pre> <br>  No entanto, o uso de interrup√ß√µes apresenta um novo problema: o c√≥digo do manipulador de interrup√ß√µes deve ser o mais r√°pido e mais curto poss√≠vel;  dentro de interrup√ß√µes, a funcionalidade MK √© limitada.  Como os AVR MKs n√£o possuem um sistema de interrup√ß√£o hier√°rquico, outra interrup√ß√£o n√£o pode ocorrer dentro de uma interrup√ß√£o - eles est√£o desativados no momento.  Portanto, a interrup√ß√£o deve ser executada o mais r√°pido poss√≠vel; caso contr√°rio, outras interrup√ß√µes (e possivelmente as mais importantes) ser√£o ignoradas e n√£o processadas. <br><br><div class="spoiler">  <b class="spoiler_title">Interromper mem√≥ria</b> <div class="spoiler_text">  De fato, estando dentro da interrup√ß√£o, o MK pode observar o fato de outra interrup√ß√£o em um registro especial, o que permite que seja processado posteriormente.  No entanto, essa interrup√ß√£o n√£o pode ser processada imediatamente. <br></div></div><br>  Portanto, n√£o podemos escrever algo complicado no manipulador de interrup√ß√µes, especialmente se esse c√≥digo tiver atrasos - porque at√© que o atraso funcione, o MK n√£o retornar√° ao programa principal (supercycle) e ficar√° surdo a outras interrup√ß√µes. <br><br>  Por esse motivo, dentro do manipulador de interrup√ß√µes, muitas vezes voc√™ s√≥ precisa sinalizar o fato do evento com um sinalizador - o seu para cada evento - e depois verificar e processar os sinalizadores dentro do super-ciclo.  √â claro que isso prolonga o tempo de rea√ß√£o ao evento, mas pelo menos n√£o perdemos algo importante. <br><br>  Assim, surge o pr√≥ximo n√≠vel de complexidade - um <i>super ciclo com interrup√ß√µes e sinalizadores</i> . <br><br>  O c√≥digo a seguir √© mostrado: <br><br><pre> <code class="vbscript hljs"><span class="hljs-keyword"><span class="hljs-keyword">on</span></span> button button_isr <span class="hljs-comment"><span class="hljs-comment">'    enable interrupts ' ***  *** do ' -  if button_flag = 1 then '     button_flag = 0 '     end if '  -  loop end ' ***    *** button_isr: button_flag = 1 return</span></span></code> </pre> <br>  Um n√∫mero consider√°vel de programas para o MK √© limitado por isso.  No entanto, esses programas geralmente s√£o ainda mais ou menos simples.  Se voc√™ escrever algo mais complicado, o n√∫mero de sinalizadores come√ßar√° a crescer como uma bola de neve, e o c√≥digo se tornar√° cada vez mais confuso e ileg√≠vel.  Al√©m disso, no exemplo acima, o problema com atrasos n√£o foi resolvido.  Claro, voc√™ pode "travar" uma interrup√ß√£o separada no cron√¥metro, e nele ... tamb√©m controlar v√°rios sinalizadores.  Mas isso torna o programa completamente feio, o n√∫mero de sinalizadores interdependentes est√° crescendo exponencialmente, e at√© o pr√≥prio desenvolvedor dificilmente pode descobrir esse "c√≥digo de massa" em breve.  Tentar encontrar um erro ou modificar o c√≥digo geralmente se torna igual nos esfor√ßos para desenvolver um novo projeto. <br><br>  Como resolver o problema do "c√≥digo de massa" e torn√°-lo mais leg√≠vel e gerenci√°vel?  O <i>sistema operacional</i> (OS) vem em socorro.  Nele, a funcionalidade que o MK deve implementar √© dividida em tarefas cuja opera√ß√£o √© controlada pelo sistema operacional. <br><br><h2>  Tipos de sistemas operacionais para MK </h2><br>  Os sistemas operacionais para MK podem ser divididos em duas grandes classes: SO com crowding out e SO cooperativo.  Em qualquer um desses sistemas operacionais, as tarefas s√£o controladas por um procedimento especial chamado <i>despachante</i> .  Em um sistema operacional com <i>exclus√£o, o</i> despachante independentemente, a qualquer momento, alterna a execu√ß√£o de uma tarefa para outra, alocando a cada um certo n√∫mero de ciclos de clock (possivelmente diferentes, dependendo da prioridade da tarefa).  Essa abordagem como um todo funciona muito bem, permitindo que voc√™ n√£o veja o conte√∫do das tarefas: voc√™ pode escrever pelo menos o c√≥digo da tarefa <br><br><pre> <code class="vbscript hljs"><span class="hljs-number"><span class="hljs-number">1</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">goto</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span></code> </pre> <br>  - e ainda o restante das tarefas (incluindo esta) ser√£o executadas.  No entanto, os SOs preventivos requerem muitos recursos (mem√≥ria do processador e ciclos de clock), pois cada comutador deve salvar completamente o contexto da tarefa a ser desativada e carregar o contexto do curr√≠culo.  O contexto aqui refere-se ao conte√∫do dos registros da m√°quina e da pilha (o BASCOM usa duas pilhas - a de hardware, para endere√ßos de retorno de subprogramas, e a de software, para passar argumentos).  Essa carga n√£o apenas exige muitos ciclos do processador, mas tamb√©m o contexto de cada tarefa precisa ser armazenado em algum lugar por um tempo at√© que funcione.  Nos processadores "grandes", inicialmente orientados para multitarefa, essas fun√ß√µes geralmente s√£o suportadas em hardware e possuem muito mais recursos.  No AVR MK, n√£o h√° suporte de hardware para multitarefa (tudo precisa ser feito "manualmente") e a mem√≥ria dispon√≠vel √© pequena.  Portanto, os SOs deslocados, embora existam, n√£o s√£o muito adequados para MKs simples. <br><br>  Outra coisa √© o <i>sistema operacional cooperativo</i> .  Aqui, a pr√≥pria tarefa controla em que ponto transferir o controle para o expedidor, permitindo que ele inicie outras tarefas.  Al√©m disso, as tarefas aqui s√£o necess√°rias para fazer isso - caso contr√°rio, a execu√ß√£o do c√≥digo ser√° interrompida.  Por um lado, parece que essa abordagem reduz a confiabilidade geral: se uma tarefa travar, nunca chamar√° o expedidor e todo o sistema deixar√° de responder.  Por outro lado, um c√≥digo linear ou uma super ciclo n√£o √© melhor nesse aspecto - porque eles podem congelar exatamente com o mesmo risco. <br><br>  No entanto, um sistema operacional cooperativo tem uma vantagem importante.  Como aqui o programador define o momento de alternar entre si, isso n√£o pode acontecer repentinamente, por exemplo, enquanto a tarefa est√° trabalhando com algum recurso ou no meio do c√°lculo de uma express√£o aritm√©tica.  Portanto, em um sistema operacional cooperativo, na maioria dos casos, voc√™ pode fazer sem manter o contexto.  Isso economiza significativamente o tempo e a mem√≥ria do processador e, portanto, parece muito mais adequado para implementa√ß√£o no MK AVR. <br><br><h2>  Troca de tarefas no BASCOM AVR </h2><br>  Para implementar a altern√¢ncia de tarefas no ambiente do BASCOM AVR, o c√≥digo da tarefa, cada um dos quais √© implementado como um procedimento normal, deve em algum lugar chamar o expedidor - tamb√©m implementado como um procedimento normal. <br>  Imagine que temos duas tarefas, cada uma das quais em algum lugar de seu c√≥digo √© chamada pelo expedidor. <br><br><pre> <code class="vbscript hljs"><span class="hljs-keyword"><span class="hljs-keyword">sub</span></span> task1() <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-comment"><span class="hljs-comment">'  1 '  loop end sub ' ---------------------------------- sub task2() do '  2 '  loop end sub</span></span></code> </pre> <br>  Suponha que a tarefa 1. tenha sido executada.Vamos ver o que acontece na pilha quando ela executa uma "chamada de despachante": <br><br><blockquote>  endere√ßo de retorno para o c√≥digo principal (2 bytes) <br>  topo da pilha -&gt; endere√ßo de retorno para a Tarefa 1 que chamou o expedidor (2 bytes) </blockquote><br>  A parte superior da pilha apontar√° para o endere√ßo da instru√ß√£o na Tarefa 1, que segue a chamada do despachante (a instru√ß√£o de <b>loop</b> em nosso exemplo). <br><br>  O objetivo do expedidor, no caso mais simples, √© transferir o controle para a Tarefa 2. A quest√£o √© como fazer isso?  (suponha que o expedidor j√° saiba o endere√ßo da tarefa 2). <br><br>  Para fazer isso, o despachante deve extrair o endere√ßo de retorno da Tarefa 1 da pilha (e em algum lugar para lembrar) e colocar o endere√ßo da Tarefa 2 nesse local da pilha e, em seguida, dar o comando de retorno.  O processador extrair√° o endere√ßo colocado da pilha e, em vez de retornar √† Tarefa 1, continuar√° com a execu√ß√£o da Tarefa 2. <br><br>  Por sua vez, quando a Tarefa 2 chama o despachante, tamb√©m retiramos a pilha e salvamos o endere√ßo onde ser√° poss√≠vel retornar √† Tarefa 2, e carregamos o endere√ßo da tarefa 1 salva anteriormente na pilha.D√™ o comando <b>return</b> e estaremos no ponto de continua√ß√£o da Tarefa 1 . <br><br>  Como resultado, temos uma bagun√ßa: <br><br><blockquote>  Tarefa 1 -&gt; Dispatcher -&gt; Tarefa 2 -&gt; Dispatcher -&gt; Tarefa 1 .... </blockquote><br>  Nada mal!  E isso funciona.  Mas, √© claro, isso n√£o √© suficiente para um sistema operacional praticamente utiliz√°vel.  Afinal, nem sempre e nem todas as tarefas devem funcionar - por exemplo, eles podem <i>esperar</i> algo (a expira√ß√£o do tempo de atraso, a apar√™ncia de algum sinal etc.).  Portanto, as tarefas devem ter um <i>status</i> (TRABALHOS, PRONTO, ESPERADO, etc.).  Al√©m disso, seria bom ter tarefas atribu√≠das com <i>prioridade</i> .  Ent√£o, se mais de uma tarefa estiver pronta para execu√ß√£o, o expedidor continuar√° a tarefa que tem a maior prioridade. <br><br><h2>  AQUA RTOS </h2><br>  Para implementar a id√©ia descrita, foi desenvolvido o cooperativo OS AQUA RTOS, que fornece os servi√ßos necess√°rios para as tarefas e permite a implementa√ß√£o de multitarefa cooperativa no ambiente do BASCOM AVR. <br><br><div class="spoiler">  <b class="spoiler_title">Aviso importante sobre o modo de procedimento no BASCOM AVR</b> <div class="spoiler_text">  Antes de iniciar a descri√ß√£o do AUQA RTOS, observe que o ambiente do BASCOM AVR suporta dois tipos de procedimentos de endere√ßamento.  Isso √© regulado pelo config submode = new |  velho. <br>  No caso de especificar a op√ß√£o antiga, o compilador, em primeiro lugar, compila todo o c√≥digo linearmente, independentemente de ser usado em algum lugar ou n√£o, e segundo: procedimentos sem argumentos projetados no estilo de subnome / end sub ser√£o percebidos como procedimentos , denominado no estilo do nome: / return.  Isso nos permite passar o endere√ßo do procedimento como um r√≥tulo como argumento para outro procedimento usando o modificador bylabel.  Isso tamb√©m se aplica a procedimentos projetados no estilo do subnome / subn√≠vel final (voc√™ precisa passar o nome do procedimento como um r√≥tulo). <br>  Ao mesmo tempo, o modo submode = old imp√µe algumas restri√ß√µes: os procedimentos da tarefa n√£o devem conter argumentos;  o c√≥digo dos arquivos conectados via $ include √© inclu√≠do linearmente no projeto geral, portanto, o desvio deve ser fornecido nos arquivos conectados - v√° do come√ßo ao fim usando goto e um r√≥tulo. <br>  Portanto, no AQUA RTOS, o usu√°rio deve usar apenas a nota√ß√£o de procedimento antigo no estilo task_name: / return para tarefas ou usar o sub name / end sub mais comum, adicionando o modificador submode = old no in√≠cio de seu c√≥digo e ignorar os arquivos inclu√≠dos Ir para o r√≥tulo / incluir c√≥digo / r√≥tulo do arquivo:. <br></div></div><br><h3>  Status da tarefa AQUA RTOS </h3><br>  Os seguintes status s√£o definidos para tarefas no AQUA RTOS: <br><br><pre> <code class="vbscript hljs">OSTS_UNDEFINE OSTS_READY OSTS_RUN OSTS_DELAY OSTS_STOP OSTS_WAIT OSTS_PAUSE OSTS_RESTART</code> </pre> <br>  Se a tarefa ainda n√£o foi inicializada, ser√° atribu√≠do o status <b>OSTS_UNDEFINE</b> . <br>  Ap√≥s a inicializa√ß√£o, a tarefa tem o status <b>OSTS_STOP</b> . <br>  Se a tarefa <i>estiver pronta para execu√ß√£o</i> , ser√° atribu√≠do o status <b>OSTS_READY</b> . <br>  A tarefa atualmente em execu√ß√£o tem o status <b>OSTS_RUN</b> . <br>  A partir dela, ela pode ir para os status <b>OSTS_STOP, OSTS_READY, OSTS_DELAY, OSTS_WAIT, OSTS_PAUSE</b> . <br>  O status <b>OSTS_DELAY</b> tem uma tarefa cumprindo um <i>atraso</i> . <br>  O status <b>OSTS_WAIT √©</b> atribu√≠do a tarefas que <i>aguardam um sem√°foro, evento ou mensagem</i> (mais sobre eles abaixo). <br><br>  Qual √© a diferen√ßa entre os <b>status OSTS_STOP</b> e <b>OSTS_PAUSED</b> ? <br>  Se, por algum motivo, a tarefa receber o status <b>OSTS_STOP</b> , a continua√ß√£o subsequente da tarefa (ap√≥s o recebimento do status <b>OSTS_READY</b> ) ser√° realizada a partir do seu ponto de entrada, ou seja,  desde o come√ßo.  No status <b>OSTS_PAUSE, a</b> tarefa continuar√° funcionando no local em que foi suspensa. <br><br><h3>  Gerenciamento de status da tarefa </h3><br>  O pr√≥prio sistema operacional pode gerenciar automaticamente as tarefas, assim como o usu√°rio, chamando os servi√ßos do sistema operacional.  Existem v√°rios servi√ßos de gerenciamento de tarefas (os nomes de todos os servi√ßos do SO come√ßam com o prefixo <b>OS_</b> ): <br><br><pre> <code class="vbscript hljs">OS_InitTask(task_label, task_prio) OS_Stop() OS_StopTask(task_label) OS_Pause() OS_PauseTask(task_label) OS_Resume() OS_ResumeTask(task_label) OS_Restart()</code> </pre> <br>  Cada um deles tem duas op√ß√µes: <b>OS_service</b> e <b>OS_serviceTask</b> (exceto o servi√ßo <b>OS_InitTask</b> , que possui apenas uma op√ß√£o; o servi√ßo <b>OS_Init</b> inicializa o pr√≥prio SO). <br><br>  Qual √© a diferen√ßa entre <b>OS_service</b> e <b>OS_serviceTask</b> ?  O primeiro m√©todo atua na pr√≥pria tarefa que a causou;  o segundo permite definir como argumento um ponteiro para outra tarefa e, assim, gerenciar outro de uma tarefa. <br><br><div class="spoiler">  <b class="spoiler_title">Sobre OS_Resume</b> <div class="spoiler_text">  Todos os servi√ßos de gerenciamento de tarefas, exceto OS_Resume e OS_ResumeTask, chamam automaticamente o gerenciador de tarefas ap√≥s o processamento.  Por outro lado, os servi√ßos OS_Resume * definem apenas o status da tarefa como OSTS_READY.  Esse status ser√° processado apenas quando o expedidor for chamado explicitamente. <br></div></div><br><h3>  Prioridade e fila de tarefas </h3><br>  Como mencionado acima, em um sistema real, algumas tarefas podem ser mais importantes, enquanto outras podem ser secund√°rias.  Portanto, um recurso √∫til do sistema operacional √© a capacidade de atribuir prioridade √†s tarefas.  Nesse caso, se houver v√°rias tarefas <i>prontas</i> ao mesmo tempo, o sistema operacional selecionar√° primeiro a tarefa com a maior prioridade.  Se <b>todas as</b> tarefas prontas tiverem prioridade igual, o sistema operacional as executar√° em c√≠rculo, em uma ordem chamada "carrossel" ou round-robin. <br><br>  No AQUA RTOS, a prioridade √© atribu√≠da a uma tarefa quando √© <i>inicializada</i> por meio de uma chamada ao servi√ßo <b>OS_InitTask</b> , que <b>recebe o</b> endere√ßo da tarefa como o primeiro argumento e um n√∫mero de 1 a 15 como o segundo argumento.Um <i>n√∫mero mais baixo significa uma prioridade mais alta</i> .  Durante a opera√ß√£o do sistema operacional, n√£o √© fornecida uma altera√ß√£o na prioridade atribu√≠da √† tarefa. <br><br><h3>  Atrasos </h3><br>  Em cada tarefa, o atraso √© processado independentemente de outras tarefas. <br>  Assim, enquanto o sistema operacional calcula o atraso de uma tarefa, outras podem ser executadas. <br>  Para a organiza√ß√£o de atrasos prestados servi√ßos <b>OS_Delay |</b>  <b>OS_DelayTask</b> .  O argumento √© o n√∫mero de milissegundos para os quais a tarefa est√° <i>atrasada</i> .  Como a dimens√£o do argumento √© <b>dword</b> , o atraso m√°ximo √© de 4294967295 ms, ou cerca de 120 horas, o que parece ser suficiente para a maioria dos aplicativos.  Depois de chamar o servi√ßo de atraso, o expedidor √© chamado automaticamente, o que transfere o controle para outras tarefas pela dura√ß√£o do atraso. <br><br><h3>  Sem√°foros </h3><br>  Os sem√°foros no AQUA RTOS s√£o algo como sinalizadores e vari√°veis ‚Äã‚Äãdispon√≠veis para as tarefas.  Eles s√£o de dois tipos - bin√°rios e cont√°veis.  O primeiro tem apenas dois estados: livre e fechado.  O segundo √© um contador de bytes (o servi√ßo de contagem de sem√°foros na vers√£o atual do AQUA RTOS n√£o est√° implementado (eu sou pregui√ßoso), portanto, tudo o que foi dito abaixo se aplica apenas aos sem√°foros bin√°rios. <br><br>  A diferen√ßa entre um sem√°foro e um sinalizador simples √© que a tarefa pode ser feita para <i>aguardar a libera√ß√£o do</i> sem√°foro especificado.  De certa forma, o uso de sem√°foros realmente se assemelha a uma ferrovia: ao chegar ao sem√°foro, a composi√ß√£o (tarefa) verificar√° o sem√°foro e, se n√£o estiver aberto, aguardar√° o sinal de ativa√ß√£o parecer mais longe.  Neste momento, outros trens (tarefas) podem continuar a se mover (correr). <br><br>  Nesse caso, todo o trabalho em preto √© atribu√≠do ao expedidor.  Assim que a tarefa √© solicitada a aguardar o sem√°foro, o controle √© automaticamente transferido para o expedidor e ele pode iniciar outras tarefas - exatamente at√© que o sem√°foro especificado seja liberado.  Assim que o estado do sem√°foro mudar para <i>livre</i> , o expedidor atribui a todas as tarefas que estavam esperando por esse sem√°foro o status <i>pronto</i> ( <b>OSTS_READY</b> ) e elas ser√£o executadas na ordem de prioridade e prioridade. <br>  No total, o AQUA RTOS fornece 16 sem√°foros bin√°rios (esse n√∫mero pode, em princ√≠pio, ser aumentado alterando a dimens√£o da vari√°vel na unidade de controle de tarefas, porque por dentro s√£o implementados como sinalizadores de bits). <br>  Os sem√°foros bin√°rios funcionam atrav√©s dos seguintes servi√ßos: <br><br><pre> <code class="vbscript hljs">hBSem OS_CreateBSemaphore() OS_WaitBSemaphore(hBSem) OS_WaitBSemaphoreTask(task_label, hBSem) OS_BusyBSemaphore(hBSem) OS_FreeBSemaphore(hBSem)</code> </pre> <br>  Antes de usar um sem√°foro, √© necess√°rio <i>criar</i> .  Isso √© feito chamando o servi√ßo <b>OS_CreateBSemaphore</b> , que retorna o identificador de bytes exclusivo (identificador) do sem√°foro <b>hBSem</b> criado ou, por meio do manipulador definido pelo usu√°rio, gera um erro <b>OSERR_BSEM_MAX_REACHED</b> , indicando que o n√∫mero m√°ximo poss√≠vel de sem√°foros bin√°rios foi atingido. <br><br>  Voc√™ pode trabalhar com o identificador recebido, passando-o como um argumento para outros servi√ßos de sem√°foro. <br><br>  Servi√ßo <b>OS_WaitBSemaphore |</b>  <b>OS_WaitBSemaphoreTask</b> coloca a tarefa (atual | especificada) em um estado para <i>aguardar a libera√ß√£o do sem√°foro</i> <b>hBSem</b> se esse sem√°foro estiver ocupado e depois transfere o controle para o expedidor para que ele possa iniciar outras tarefas.  Se o sem√°foro estiver livre, a transfer√™ncia de controle n√£o ocorrer√° e a tarefa simplesmente continuar√°. <br><br>  Os <b>servi√ßos OS_BusyBSemaphore</b> e <b>OS_FreeBSemaphore</b> configuram o sem√°foro <b>hBSem</b> como <i>ocupado</i> ou <i>gratuito,</i> respectivamente. <br><br>  A destrui√ß√£o de sem√°foros para simplificar o sistema operacional e reduzir a quantidade de c√≥digo n√£o √© fornecida.  Assim, todos os sem√°foros criados s√£o est√°ticos. <br><br><h3>  Eventos </h3><br>  Al√©m dos sem√°foros, as tarefas podem ser orientadas a eventos.  Uma tarefa pode ser instru√≠da a <i>esperar um determinado evento</i> , e outra tarefa (assim como o c√≥digo de segundo plano) pode <i>sinalizar</i> esse evento.  Ao mesmo tempo, todas as tarefas que aguardavam esse evento receber√£o o status <i>pronto para execu√ß√£o</i> ( <b>OSTS_READY</b> ) e ser√£o definidas pelo expedidor para execu√ß√£o na ordem de prioridade e prioridade. <br><br>  A quais eventos a tarefa pode responder?  Bem, por exemplo: <br><ul><li>  interrup√ß√£o; </li><li>  ocorr√™ncia de um erro; </li><li>  libera√ß√£o do recurso (√†s vezes √© mais conveniente usar um sem√°foro para isso); </li><li>  alterar o status da linha de E / S ou pressionar uma tecla no teclado; </li><li>  receber ou enviar um personagem via RS-232; </li><li>  transfer√™ncia de informa√ß√µes de uma parte do aplicativo para outra (consulte tamb√©m as mensagens). </li></ul><br>  O sistema de eventos √© implementado atrav√©s dos seguintes servi√ßos: <br><br><pre> <code class="vbscript hljs">hEvent OS_CreateEvent() OS_WaitEvent(hEvent) OS_WaitEventTask(task_label, hEvent) OS_WaitEventTO(hEvent, dwTimeout) OS_SignalEvent(hEvent)</code> </pre> <br>  Antes de usar um evento, voc√™ precisa <i>cri√°-lo</i> .  Isso √© feito chamando a fun√ß√£o <b>OS_CreateEvent</b> , que retorna um identificador de bytes exclusivo (identificador) para o evento <b>hEvent</b> ou gera um erro <b>OSERR_EVENT_MAX_REACHED</b> atrav√©s do manipulador definido pelo usu√°rio, indicando que o limite do n√∫mero de eventos que podem ser gerados no SO foi atingido (m√°ximo de 255 eventos diferentes). <br><br>  Para fazer uma tarefa aguardar um evento <b>hEvent</b> , chame <b>OS_WaitEvent</b> em seu c√≥digo, passando o identificador de evento como argumento.  Ap√≥s chamar este servi√ßo, o controle ser√° automaticamente transferido para o expedidor. <br><br>  Ao contr√°rio do servi√ßo de sem√°foro, o servi√ßo de eventos fornece uma op√ß√£o para aguardar um evento com <i>tempo limite</i> .  Para fazer isso, use o servi√ßo <b>OS_WaitEventTO</b> .  O segundo argumento aqui √© poss√≠vel especificar o n√∫mero de milissegundos que a tarefa pode esperar do evento.  Se o tempo especificado expirou, a tarefa receber√° o status <i>pronto para execu√ß√£o</i> como se o evento tivesse ocorrido e ser√° definido pelo expedidor para continuar a execu√ß√£o na ordem de prioridade e prioridade.  A tarefa pode descobrir que n√£o foi um evento, mas um tempo limite, que a tarefa p√¥de verificar verificando o <b>sinalizador</b> global <b>OS_TIMEOUT</b> . <br><br> <i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> c√≥digo da tarefa ou plano de fundo pode </font><i><font style="vertical-align: inherit;">sinalizar</font></i><font style="vertical-align: inherit;"> a ocorr√™ncia de um determinado evento chamando o servi√ßo </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">OS_SignalEvent</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , que </font><b><font style="vertical-align: inherit;">recebe o</font></b><font style="vertical-align: inherit;"> identificador de evento como argumento. </font><font style="vertical-align: inherit;">Nesse caso, todas as tarefas aguardando esse evento, o sistema operacional definir√° o status </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pronto para execu√ß√£o</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , para que possam continuar sendo executados em ordem de prioridade e prioridade.</font></font><br><br><h3>  Mensagens </h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O sistema de mensagens funciona em geral de maneira semelhante ao sistema de eventos, mas fornece tarefas com mais op√ß√µes e flexibilidade: fornece n√£o apenas a expectativa de uma mensagem em um t√≥pico especificado, mas a maneira como a pr√≥pria mensagem √© transmitida de uma tarefa para outra - um n√∫mero ou uma sequ√™ncia. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Isso √© implementado atrav√©s dos seguintes servi√ßos:</font></font><br><br><pre> <code class="vbscript hljs">hTopic OS_CreateMessage() OS_WaitMessage(hTopic) OS_WaitMessageTask(task_label, hTopic) OS_WaitMessageTO(hTopic, dwTimeout) OS_SendMessage(hTopic, wMessage) word_ptr OS_GetMessage(hTopic) word_ptr OS_PeekMessage(hTopic) <span class="hljs-built_in"><span class="hljs-built_in">string</span></span> OS_GetMessageString(hTopic) <span class="hljs-built_in"><span class="hljs-built_in">string</span></span> OS_PeekMessageString(hTopic)</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Para usar o servi√ßo de mensagens, voc√™ deve primeiro criar </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">um assunto para a mensagem</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Isso √© feito por meio do servi√ßo </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">OS_CreateMessage</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , que retorna o identificador de bytes do t√≥pico </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">hTopic</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ou por meio do manipulador definido pelo usu√°rio, gera um erro </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">OSERR_TOPIC_MAX_REACHED</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , indicando que o n√∫mero m√°ximo poss√≠vel de t√≥picos de mensagens foi atingido e n√£o pode mais ser criado. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Para instruir a tarefa a aguardar uma mensagem sobre o t√≥pico </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">hTopic</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , chame </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">OS_WaitMessage</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> em seu c√≥digo </font><font style="vertical-align: inherit;">, passando o identificador do t√≥pico como argumento. Ap√≥s chamar este servi√ßo, o controle ser√° automaticamente transferido para o gerenciador de tarefas. Portanto, este servi√ßo coloca a tarefa atual em um estado</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">aguarde uma </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mensagem hTopic</font></font></b></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O servi√ßo de espera com o tempo limite </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">OS_WaitMessageTO</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> funciona de maneira semelhante ao servi√ßo </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">OS_WaitEventTO</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> do </font><font style="vertical-align: inherit;">sistema de </font><b><font style="vertical-align: inherit;">eventos</font></b><font style="vertical-align: inherit;"> . </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Para enviar mensagens, o servi√ßo </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">OS_SendMessage</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> √© </font><b><font style="vertical-align: inherit;">fornecido</font></b><font style="vertical-align: inherit;"> . O primeiro argumento √© o identificador do t√≥pico para o qual a mensagem ser√° transmitida e o segundo √© o argumento da dimens√£o da </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">palavra</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Pode ser um n√∫mero independente ou um </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ponteiro para uma string</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , que, por sua vez, j√° √© uma mensagem. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Para obter um ponteiro de linha, basta usar a fun√ß√£o varptr embutida no </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">BASCOM</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , por exemplo, assim:</font></font><br><br><pre> <code class="vbscript hljs">strMessage = <span class="hljs-string"><span class="hljs-string">"Hello, world!"</span></span> OS_SendMessage hTopic, varptr (strMessage)</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Continuando o trabalho ap√≥s chamar </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">OS_WaitMessage</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , ou seja, quando a mensagem esperada √© recebida, a tarefa pode receber a mensagem com sua subsequente destrui√ß√£o autom√°tica ou apenas visualiz√°-la - nesse caso, ela n√£o ser√° destru√≠da. Para fazer isso, use os quatro √∫ltimos servi√ßos da lista. Os dois primeiros retornam um n√∫mero de </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">palavra</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> de dimens√£o </font><font style="vertical-align: inherit;">, que pode ser uma mensagem independente ou servir como ponteiro para a sequ√™ncia que cont√©m a mensagem. Nesse caso, </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">OS_GetMessage</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> exclui automaticamente a mensagem e </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">OS_PeekMessage a</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> deixa. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Se a tarefa precisar imediatamente de uma sequ√™ncia, n√£o de um ponteiro, voc√™ poder√° usar os servi√ßos </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">OS_GetMessageString</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ou </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">OS_PeekMessageString</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , que funcionam de maneira semelhante √†s duas anteriores, mas retornam uma sequ√™ncia, n√£o um ponteiro para ela. </font></font><br><br><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Servi√ßo de timer interno </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Para trabalhar com os atrasos e tempo AQUA RTOS usa um built-in IC temporizador hardware </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">TIMER0</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Portanto, c√≥digo externo (segundo plano e tarefas) n√£o deve usar esse timer. </font><font style="vertical-align: inherit;">Mas geralmente isso n√£o √© necess√°rio, porque </font><font style="vertical-align: inherit;">O SO fornece √†s tarefas todas as ferramentas necess√°rias para trabalhar com intervalos de tempo. </font><font style="vertical-align: inherit;">A resolu√ß√£o do temporizador √© de 1 ms.</font></font><br><br><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Exemplos de trabalho com o AQUA RTOS </font></font></h2><br><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Configura√ß√µes iniciais </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">No in√≠cio do c√≥digo do usu√°rio, voc√™ precisa determinar se o c√≥digo ser√° executado no simulador interno ou no hardware real. </font><font style="vertical-align: inherit;">Defina a constante </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">OS_SIM = TRUE | </font><font style="vertical-align: inherit;">FALSE</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , que define o modo de simula√ß√£o. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Al√©m disso, no c√≥digo do SO, edite a constante </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">OS_MAX_TASK</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , que determina o n√∫mero m√°ximo de tarefas suportadas pelo SO. </font><font style="vertical-align: inherit;">Quanto menor esse n√∫mero, mais r√°pido o sistema operacional funciona (menos sobrecarga) e menos mem√≥ria consome. </font><font style="vertical-align: inherit;">Portanto, voc√™ n√£o deve indicar mais tarefas do que o necess√°rio. </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">N√£o se esque√ßa de alterar essa constante se o n√∫mero de tarefas tiver sido alterado.</font></font></i> <br><br><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Inicializa√ß√£o do SO </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Antes de iniciar, o AQUA RTOS deve ser inicializado. Para fazer isso, ligue para o servi√ßo </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">OS_Init</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Este servi√ßo define as configura√ß√µes iniciais do sistema operacional. Mais importante, ele tem um argumento - o endere√ßo da rotina de tratamento de erros definida pelo usu√°rio. Ela, por sua vez, tamb√©m tem uma discuss√£o - um c√≥digo de erro. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Esse manipulador deve estar no c√≥digo do usu√°rio (pelo menos na forma de um stub) - o sistema operacional envia c√≥digos de erro a ele e o usu√°rio n√£o tem outra maneira de captur√°-los e process√°-los adequadamente. Eu recomendo fortemente que, pelo menos no est√°gio de desenvolvimento, n√£o coloque um stub, mas inclua qualquer sa√≠da de informa√ß√µes de erro neste procedimento. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Portanto, a primeira etapa ao trabalhar com o AQUA RTOS √© adicionar o c√≥digo de inicializa√ß√£o do SO e o procedimento do manipulador de erros ao programa do usu√°rio:</font></font><br><br><pre> <code class="vbscript hljs">OS_Init my_err_trap <span class="hljs-comment"><span class="hljs-comment">'... '... '... sub my_err_trap(err_code as byte) print err_code end sub</span></span></code> </pre> <br><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Inicializa√ß√£o de tarefas </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> A segunda etapa √© inicializar as tarefas especificando seus nomes e prioridades: </font></font><br><br><pre> <code class="vbscript hljs">OS_InitTask task_1, <span class="hljs-number"><span class="hljs-number">1</span></span> OS_InitTask task_2 , <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-comment"><span class="hljs-comment">'... OS_InitTask task_N , 1</span></span></code> </pre> <br><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Tarefas de teste </font></font></h2><br><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> LED piscando </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Portanto, vamos criar um aplicativo de teste que pode ser baixado em uma placa Arduino Nano V3 padr√£o. </font><font style="vertical-align: inherit;">Crie uma pasta na pasta com o arquivo do SO (por exemplo, teste) e crie o seguinte arquivo-base:</font></font><br><br><pre> <code class="vbscript hljs"><span class="hljs-comment"><span class="hljs-comment">'    config submode = old $include "..\aquaRTOS_1.05.bas" $regfile = "m328pdef.dat" $crystal = 16000000 $hwstack = 48 $swstack = 48 $framesize = 64 '   declare sub my_err_trap (byval err_code as byte) declare sub task_1() declare sub task_2() '       led_1 alias portd.4 led_2 alias portd.5 config portd.4 = output config portd.5 = output ' ***    *** '   OS_Init my_err_trap '   OS_InitTask task_1, 1 OS_InitTask task_2 , 1 '      ¬´¬ª (OSTS_STOP) '    ,     ' ¬´  ¬ª (OSTS_READY)   OS_ResumeTask OS_ResumeTask task_1 OS_ResumeTask task_2 '      OS_Sheduler end ' ***  *** sub task_1 () do toogle led_1 '   1 OS_delay 1000 '   1000  loop end sub sub task_2 () do toogle led_2 '   2 OS_delay 333 '   333  loop end sub ' **************************************************** '   sub my_err_trap(err_code as byte) print "OS Error: "; err_code end sub</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Conecte os √¢nodos dos LEDs aos pinos </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">D4</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> e </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">D5</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> da placa Arduino (ou a outros pinos alterando as linhas de defini√ß√£o correspondentes no c√≥digo). Conecte os c√°todos atrav√©s de resistores de termina√ß√£o de 100 ... 500 Ohm ao barramento </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GND</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Compile e fa√ßa o upload do firmware para o quadro. Os LEDs come√ßar√£o a alternar de forma ass√≠ncrona com um per√≠odo de 2 e 0,66 s. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Vamos dar uma olhada no c√≥digo. Ent√£o, primeiro inicializamos o equipamento (definimos as op√ß√µes do compilador, o modo de porta e atribu√≠mos aliases), depois o pr√≥prio sistema operacional e, finalmente, as tarefas.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Como as tarefas rec√©m-criadas est√£o no estado "parado", √© necess√°rio atribuir a elas o status "pronto para execu√ß√£o" (talvez n√£o para todas as tarefas em um aplicativo real - afinal, algumas delas, conforme concebidas pelo desenvolvedor, podem estar inicialmente em um estado parado e executar no execu√ß√£o apenas de outras tarefas, e n√£o imediatamente no in√≠cio do sistema; no entanto, neste exemplo, ambas as tarefas devem come√ßar a funcionar imediatamente). Portanto, para cada tarefa, chamamos o servi√ßo </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">OS_ResumeTask</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Agora as tarefas est√£o prontas para execu√ß√£o, mas ainda n√£o foram conclu√≠das. Quem os lan√ßar√°? Claro, o despachante! Para fazer isso, devemos cham√°-lo no primeiro in√≠cio do sistema. Agora, se tudo estiver escrito corretamente, o despachante executar√° nossas tarefas uma a uma, e podemos terminar a parte principal do programa com a instru√ß√£o </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">final</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Vamos dar uma olhada nas tarefas. √â imediatamente evidente que cada um deles √© enquadrado como um </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">loop</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> infinito </font><font style="vertical-align: inherit;">. A segunda propriedade importante - dentro desse ciclo, deve haver pelo menos uma chamada para o despachante ou o servi√ßo do SO que chama automaticamente o despachante para si mesmo - caso contr√°rio, essa tarefa nunca abrir√° m√£o do controle e outras tarefas n√£o poder√£o ser executadas. No nosso caso, este √© o </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">servi√ßo de</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> atraso </font><b><font style="vertical-align: inherit;">OS_Delay</font></b><font style="vertical-align: inherit;"> . Como argumento, indicamos a ele o n√∫mero de milissegundos para os quais cada tarefa deve ser pausada. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Se voc√™ definir a constante </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">OS_SIM = TRUE</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> no in√≠cio do c√≥digo </font><font style="vertical-align: inherit;">e executar o c√≥digo n√£o no chip real, mas no simulador, poder√° rastrear como o sistema operacional funciona.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O despachante que ligamos ver√° se as tarefas com o status est√£o "prontas para execu√ß√£o" e as alinhar√° de acordo com a prioridade. Se a prioridade for a mesma, o expedidor "rolar√° tarefas no carrossel", movendo a tarefa rec√©m-conclu√≠da para o final da fila. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Depois de selecionar a tarefa a ser executada (por exemplo, </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tarefa_1</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ), o expedidor substitui o endere√ßo de retorno (inicialmente, ele aponta para a instru√ß√£o </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">final</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> no c√≥digo principal) </font><font style="vertical-align: inherit;">na pilha pelo endere√ßo do </font><font style="vertical-align: inherit;">ponto de entrada da tarefa </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">task_1</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , que o sistema reconhece durante a inicializa√ß√£o da tarefa, e executa o comando </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">return</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , que for√ßa MK para puxar o endere√ßo de retorno da pilha e </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">acess√°</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> -lo - ou seja, inicie a execu√ß√£o da </font><b><font style="vertical-align: inherit;">tarefa_1</font></b><font style="vertical-align: inherit;"> tarefa </font><font style="vertical-align: inherit;">(operador</font></font><b>do</b>   <b>task_1</b> ). <br><br>  <b>task_1</b> ,   ,   <b>OS_delay</b> , ,   ,   . <br><br>   ,    ,     <b>task_1</b> (  ,    <b>OS_delay</b> , ..  <b>loop</b> ),  , ¬´ ¬ª, ,      <b>task_2</b> .       <b>task_2</b> (      <b>do</b>    <b>task_2</b> )    <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">return</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , que faz com que o MK retire o endere√ßo de retorno da pilha e v√° at√© ele - ou seja, comece a executar </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">task_2</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A tarefa </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">task_2</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , alternando seu LED, chama o servi√ßo </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">OS_delay</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , que, ap√≥s executar as a√ß√µes necess√°rias, vai para o expedidor. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O expedidor salva o endere√ßo que estava na pilha na </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">unidade de</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> controle da tarefa </font><b><font style="vertical-align: inherit;">task_1</font></b><font style="vertical-align: inherit;"> (aponta para a instru√ß√£o ap√≥s a chamada </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">OS_delay</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , ou seja, a instru√ß√£o de </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">loop</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ) e, em seguida, "girando o carrossel", descobre que a </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tarefa_2</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> agora deve ser conclu√≠da </font><font style="vertical-align: inherit;">. A diferen√ßa do estado inicial ser√° que agora no bloco de controle de tarefas </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">task_1</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">n√£o o endere√ßo inicial da tarefa √© armazenado, mas o endere√ßo do ponto em que ocorreu a transi√ß√£o para o expedidor. </font><font style="vertical-align: inherit;">L√° (para a instru√ß√£o de </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">loop</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> no </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">c√≥digo da</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> tarefa </font><b><font style="vertical-align: inherit;">task_1</font></b><font style="vertical-align: inherit;"> ) e o controle ser√° transferido. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A tarefa </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">task_1</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> executar√° a instru√ß√£o de </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">loop</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> e, em seguida, o ciclo inteiro "Tarefa 1 - Despachante - Tarefa 2 - Despachante" ser√° repetido infinitamente.</font></font><br><br><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Enviar mensagens </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Agora vamos tentar enviar mensagens de uma tarefa para outra. </font></font><br><br><pre> <code class="vbscript hljs"><span class="hljs-comment"><span class="hljs-comment">'    config submode = old $include "..\aquaRTOS_1.05.bas" $regfile = "m328pdef.dat" $crystal = 16000000 $hwstack = 48 $swstack = 48 $framesize = 64 '   declare sub my_err_trap (byval err_code as byte) declare sub task_1() declare sub task_2() const OS_SIM = TURE '       '   dim hTopic as byte '     dim task_1_cnt as byte '    1 dim strMessage as string * 16 '  ' ***    *** OS_CreateMessage hTopic OS_Init my_err_trap OS_InitTask task_1 , 1 OS_InitTask task_2 , 1 OS_ResumeTask task_1 OS_ResumeTask task_2 OS_Sheduler end ' ***  *** sub task_1() do print "task 1" OS_Sheduler incr task_1_cnt '    1 if task_1_cnt &gt; 3 then print "task 1 is sending message to task 2" strMessage = "Hello, task 2!" '    2 OS_SendMessage hTopic , varptr(strMessage) task_1_cnt = 0 end if loop end sub sub task_2() do print "task 2 is waiting messages..." '      1 OS_WaitMessage hTopic print "message recieved: " ; OS_GetMessageString (hTopic) loop end sub ' **************************************************** '   sub my_err_trap(err_code as byte) print "OS Error: "; err_code end sub</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> O resultado da execu√ß√£o do programa no simulador ser√° a seguinte sa√≠da na janela do terminal: </font></font><br><br><blockquote> task 1 <br> task 2 is waiting messages‚Ä¶ <br> task 1 <br> task 1 <br> task 1 <br> task 1 is sending message to task 2 <br> task 1 <br> message recieved: Hello, task 2! <br> task 2 is waiting messages‚Ä¶ <br> task 1 <br> task 1 <br>  ... <br></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Preste aten√ß√£o na ordem em que o trabalho e a altern√¢ncia de tarefas ocorrem. Assim que a tarefa 1 imprime a </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tarefa 1</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , o controle √© transferido para o expedidor, para que ele possa iniciar a segunda tarefa. A tarefa 2 imprime que a </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tarefa 2 est√° aguardando mensagens ...</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , depois chama o servi√ßo de mensagem em espera no t√≥pico </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">hTopic</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> e o controle √© automaticamente transferido para o expedidor, que novamente chama a </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tarefa</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 1. Imprime a </font><b><font style="vertical-align: inherit;">tarefa 1</font></b><font style="vertical-align: inherit;"> novamente </font><font style="vertical-align: inherit;">e d√° controle ao expedidor. No entanto, como o despachante detecta que a Tarefa 2 agora est√° aguardando mensagens, ele retorna o controle para a Tarefa 1 na instru√ß√£o </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">incr</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ap√≥s a chamada do despachante. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Quando o contador </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">task_1_cnt</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">na tarefa 1, exceder√° o valor especificado, a tarefa envia uma mensagem, mas continua a executar - executa a instru√ß√£o de </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">loop</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> e imprime a </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tarefa 1</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> novamente </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Depois disso, ela liga para o despachante, que agora descobre que h√° uma mensagem para a Tarefa 2 e transfere o controle para ela. </font><font style="vertical-align: inherit;">Em seguida, o processo √© realizado ciclicamente.</font></font><br><br><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Manipula√ß√£o de eventos </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> O c√≥digo a seguir pesquisa dois bot√µes e alterna os LEDs quando voc√™ pressiona o bot√£o correspondente: </font></font><br><br><pre> <code class="vbscript hljs"><span class="hljs-comment"><span class="hljs-comment">'    config submode = old $include "..\aquaRTOS_1.05.bas" $regfile = "m328pdef.dat" $crystal = 16000000 $hwstack = 48 $swstack = 48 $framesize = 64 '   declare sub my_err_trap (byval err_code as byte) declare sub task_scankeys() declare sub task_led_1() declare sub task_led_2() '        led_1 alias portd.4 led_2 alias portd.5 config portd.4 = output config portd.5 = output button_1 alias pind.6 button_2 alias pind.7 config portd.6 = input config portd.7 = input '   dim eventButton_1 as byte dim eventButton_2 as byte ' ***    *** eventButton_1 = OS_CreateEvent '       eventButton_2 = OS_CreateEvent OS_Init my_err_trap OS_InitTask task_scankeys , 1 OS_InitTask task_led_1 , 1 OS_InitTask task_led_2 , 1 OS_ResumeTask task_scankeys OS_ResumeTask task_led_1 OS_ResumeTask task_led_2 OS_Sheduler end ' ***  *** sub task_scankeys() do debounce button_1 , 0 , btn_1_click , sub debounce button_2 , 0 , btn_2_click , sub OS_Sheduler loop btn_1_click: OS_SignalEvent eventButton_1 return btn_2_click: OS_SignalEvent eventButton_2 return end sub sub task_led_1() do OS_WaitEvent eventButton_1 toggle led_1 loop end sub sub task_led_2() do OS_WaitEvent eventButton_2 toggle led_2 loop end sub ' **************************************************** '   sub my_err_trap(err_code as byte) print "OS Error: "; err_code end sub</span></span></code> </pre> <br><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Um exemplo real de aplica√ß√£o no AQUA RTOS </font></font></h2><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Vamos tentar imaginar como seria um programa de m√°quinas de venda autom√°tica de caf√©. </font><font style="vertical-align: inherit;">A m√°quina deve indicar a presen√ßa de op√ß√µes de caf√© e a escolha de LEDs nos bot√µes; </font><font style="vertical-align: inherit;">receber sinais do receptor de moedas, preparar a bebida solicitada, emitir altera√ß√µes. </font><font style="vertical-align: inherit;">Al√©m disso, a m√°quina deve controlar o equipamento interno: por exemplo, mantenha a temperatura do aquecedor de √°gua em 95 ... 97 ¬∞ C; </font><font style="vertical-align: inherit;">transmitir dados sobre mau funcionamento do equipamento e estoque de ingredientes e receber comandos por acesso remoto (por exemplo, via modem GSM), al√©m de vandalismo de sinal.</font></font><br><br><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Abordagem orientada a eventos </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">No in√≠cio, pode ser dif√≠cil para um desenvolvedor mudar do esquema usual "supercycle + flags + interrupts" para uma abordagem baseada em tarefas e eventos. </font><font style="vertical-align: inherit;">Isso requer destacar as tarefas b√°sicas que o dispositivo deve executar. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Vamos tentar delinear essas tarefas para nossa m√°quina:</font></font><br><br><ul><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">controle e gerenciamento de aquecedores - </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ControlHeater ()</font></font></b> </li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">indica√ß√£o de disponibilidade e escolha de bebidas - </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ShowGoods ()</font></font></b> </li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">aceita√ß√£o de moedas / notas e seu somat√≥rio - </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">AcceptMoney ()</font></font></b> </li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">bot√µes de pesquisa - </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ScanKeys ()</font></font></b> </li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">entrega de altera√ß√µes - </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MakeChange ()</font></font></b> </li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">licen√ßa de bebida - </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ReleaseCoffee ()</font></font></b> </li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">prote√ß√£o contra vandalismo - </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Alarme ()</font></font></b> </li></ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Vamos estimar o grau de import√¢ncia das tarefas e a frequ√™ncia de suas chamadas. </font></font><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ControlHeater () √©</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> obviamente importante porque sempre precisamos de √°gua fervente para fazer caf√©. Mas n√£o deve ser realizado com muita frequ√™ncia, porque o aquecedor tem uma alta in√©rcia e a √°gua esfria lentamente. Basta verificar a temperatura uma vez por minuto. </font></font><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">D√™</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> prioridade a esta tarefa 5. </font><b><font style="vertical-align: inherit;">ShowGoods ()</font></b><font style="vertical-align: inherit;"> n√£o </font><b><font style="vertical-align: inherit;">√©</font></b><font style="vertical-align: inherit;"> muito importante. A oferta pode mudar somente ap√≥s a libera√ß√£o da mercadoria, se o fornecimento de qualquer ingrediente estiver esgotado. Portanto, atribuiremos a esta tarefa uma prioridade de 8 e a executaremos quando a m√°quina iniciar e toda vez que as mercadorias forem liberadas. </font></font><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Teclas de digitaliza√ß√£o ()</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">deve ter uma prioridade suficientemente alta para que a m√°quina responda rapidamente aos pressionamentos de bot√£o. D√™ a esta tarefa a prioridade 3 e n√≥s a executaremos a cada 40 milissegundos. </font></font><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">AcceptMoney ()</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> tamb√©m faz parte da interface do usu√°rio. Daremos a mesma prioridade que </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ScanKeys ()</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> e a executaremos a cada 20 milissegundos. </font></font><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MakeChange ()</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> √© executado somente depois que as mercadorias s√£o liberadas. N√≥s o associaremos ao </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ReleaseCoffee ()</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> e daremos a prioridade 10. </font></font><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ReleaseCoffee () √©</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> necess√°rio apenas quando a quantia apropriada for aceita e o bot√£o de sele√ß√£o de bebida for pressionado. Para uma resposta r√°pida, damos a prioridade 2. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Como a resist√™ncia a vandalismo √© uma fun√ß√£o bastante importante da m√°quina, a tarefa </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Alarm ()</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">voc√™ pode definir a prioridade mais alta - 1 e ativar uma vez por segundo para verificar os sensores de inclina√ß√£o ou viola√ß√£o. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Assim, precisaremos de sete tarefas com prioridades diferentes. </font><font style="vertical-align: inherit;">Ap√≥s o in√≠cio, quando o programa leu as configura√ß√µes da EEPROM e inicializou o equipamento, √© hora de inicializar o sistema operacional e iniciar as tarefas.</font></font><br><br><pre> <code class="vbscript hljs"><span class="hljs-comment"><span class="hljs-comment">'    declare sub ControlHeater() declare sub ShowGoods() declare sub AcceptMoney() declare sub ScanKeys() declare sub MakeChange () declare sub ReleaseCoffee() declare sub Alarm()</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Para trabalhar como parte do RTOS, cada tarefa deve ter uma certa estrutura: deve ter pelo menos uma chamada para o expedidor (ou um servi√ßo de SO que transfira automaticamente o controle para o expedidor) - essa √© a √∫nica maneira de garantir multitarefa cooperativa. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Por exemplo, </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ReleaseCoffee ()</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> pode ser algo como isto:</font></font><br><br><pre> <code class="vbscript hljs"><span class="hljs-keyword"><span class="hljs-keyword">sub</span></span> ReleaseCoffee() <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> OS_WaitMessage bCoffeeSelection wItem = OS_GetMessage(bCoffeeSelection) Release wItem <span class="hljs-keyword"><span class="hljs-keyword">loop</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">sub</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A tarefa </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ReleaseCoffee</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> em um loop infinito espera uma mensagem sobre o t√≥pico </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">bCoffeeSelection</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> e n√£o faz nada at√© chegar (o controle √© retornado automaticamente ao expedidor para que ele possa iniciar outras tarefas). Assim que a mensagem √© enviada, </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ReleaseCoffee ()</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> fica pronto para execu√ß√£o e, quando isso acontece, a tarefa recebe o conte√∫do da mensagem (c√≥digo da bebida selecionada) </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">wItem</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> usando o servi√ßo </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">OS_GetMessage</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> e libera as mercadorias para o cliente. Como </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ReleaseCoffee ()</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> usa o subsistema de mensagens, √© necess√°rio criar uma mensagem antes de iniciar a multitarefa:</font></font><br><br><pre> <code class="vbscript hljs"><span class="hljs-keyword"><span class="hljs-keyword">dim</span></span> bCoffeeSelection as byte bCoffeeSelection = OS_CreateMessage()</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Como mencionado acima, </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ShowGoods ()</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> deve ser executado uma vez na inicializa√ß√£o e sempre que as mercadorias forem liberadas. </font><font style="vertical-align: inherit;">Para associ√°-lo ao procedimento de libera√ß√£o </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ReleaseCoffee ()</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , usamos o servi√ßo de eventos. </font><font style="vertical-align: inherit;">Para fazer isso, crie um evento antes de iniciar a multitarefa:</font></font><br><br><pre> <code class="vbscript hljs"><span class="hljs-keyword"><span class="hljs-keyword">dim</span></span> bGoodsReliased as byte bGoodsReliased = OS_CreateEvent()</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">E no procedimento </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ReleaseCoffee ()</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font><font style="vertical-align: inherit;">ap√≥s a linha </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Release wItem</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , adicionamos um alarme sobre o evento </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">bGoodsReleased</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br><br><pre> <code class="vbscript hljs">OS_SignalEvent bGoodsReliased</code> </pre> <br><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Inicializa√ß√£o do SO </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Para preparar o sistema operacional para o trabalho, precisamos inicializ√°-lo, indicando o endere√ßo do manipulador de erros, que est√° no c√≥digo do usu√°rio. </font><font style="vertical-align: inherit;">Fazemos isso usando o servi√ßo </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">OS_Init</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br><br><pre> <code class="vbscript hljs">OS_Init Mailfuncion</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> No c√≥digo do usu√°rio, voc√™ precisa adicionar um manipulador - um procedimento cujo argumento de byte √© o c√≥digo de erro: </font></font><br><br><pre> <code class="vbscript hljs"><span class="hljs-keyword"><span class="hljs-keyword">sub</span></span> Mailfuncion (bCoffeeErr) print <span class="hljs-string"><span class="hljs-string">"Mailfunction! Error #: "</span></span>; bCoffeeErr <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> isErrCritical (bCoffeeErr) = <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> CallService(bCoffeeErr) <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">sub</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Este procedimento imprime um c√≥digo de erro (ou pode exibi-lo de outra maneira: na tela, via modem GSM, etc.) e, caso o erro seja cr√≠tico, ele liga para o departamento de servi√ßo. </font></font><br><br><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> In√≠cio da tarefa </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">J√° lembramos que eventos, sem√°foros etc. </font><font style="vertical-align: inherit;">deve ser inicializado antes de ser usado. </font><font style="vertical-align: inherit;">Al√©m disso, as pr√≥prias tarefas devem ser inicializadas com o servi√ßo </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">OS_InitTask antes de iniciar</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br><br><pre> <code class="vbscript hljs">OS_InitTask ControlHeater , <span class="hljs-number"><span class="hljs-number">5</span></span> OS_InitTask ShowGoods , <span class="hljs-number"><span class="hljs-number">8</span></span> OS_InitTask AcceptMoney , <span class="hljs-number"><span class="hljs-number">3</span></span> OS_InitTask ScanKeys , <span class="hljs-number"><span class="hljs-number">3</span></span> OS_InitTask MakeChange, <span class="hljs-number"><span class="hljs-number">10</span></span> OS_InitTask ReleaseCoffee , <span class="hljs-number"><span class="hljs-number">2</span></span> OS_InitTask Alarm , <span class="hljs-number"><span class="hljs-number">1</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Como o modo multitarefa ainda n√£o come√ßou, a ordem na qual as tarefas s√£o iniciadas √© insignificante e, de qualquer forma, n√£o depende de suas prioridades. </font><font style="vertical-align: inherit;">Neste ponto, todas as tarefas ainda est√£o em um estado parado. </font><font style="vertical-align: inherit;">Para prepar√°-los para execu√ß√£o, devemos usar o servi√ßo </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">OS_ResumeTask para</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> definir o status "pronto para execu√ß√£o":</font></font><br><br><pre> <code class="vbscript hljs">OS_ResumeTask ControlHeater OS_ResumeTask ShowGoods OS_ResumeTask AcceptMoney OS_ResumeTask ScanKeys OS_ResumeTask MakeChange OS_ResumeTask ReleaseCoffee OS_ResumeTask Alarm</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Como j√° mencionado, nem todas as tarefas devem necessariamente iniciar quando a multitarefa √© iniciada; </font><font style="vertical-align: inherit;">alguns deles podem a qualquer momento permanecer em um estado "parado" e receber prontid√£o apenas sob certas condi√ß√µes. </font><font style="vertical-align: inherit;">O servi√ßo </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">OS_ResumeTask</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> pode ser chamado a qualquer momento e em qualquer lugar do c√≥digo (plano de fundo ou tarefa) quando a multitarefa j√° estiver em execu√ß√£o. </font><font style="vertical-align: inherit;">O principal √© que a tarefa a que se refere √© pr√©-inicializada.</font></font><br><br><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> In√≠cio da multitarefa </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Agora tudo est√° pronto para come√ßar a multitarefa. </font><font style="vertical-align: inherit;">Fazemos isso chamando o expedidor:</font></font><br><br><pre> <code class="vbscript hljs">OS_Sheduler</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Depois disso, podemos </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">finalizar</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> com seguran√ßa o c√≥digo do programa </font><font style="vertical-align: inherit;">- o sistema operacional agora cuida da execu√ß√£o adicional do c√≥digo. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Vejamos o c√≥digo inteiro:</font></font><br><br><pre> <code class="vbscript hljs"><span class="hljs-comment"><span class="hljs-comment">'    config submode = old $include "..\aquaRTOS_1.05.bas" $include "coffee_hardware.bas" '      '       Coffee_ $regfile = "m328pdef.dat" ' Arduino Nano v3 $crystal = 16000000 $hwstack = 48 $swstack = 48 $framesize = 64 Coffee_InitHardware '    '   declare sub Mailfuncion (byval bCoffeeErr as byte) '   declare sub ControlHeater () '   declare sub ShowGoods () '    declare sub AcceptMoney () '   declare sub ScanKeys () '   declare sub MakeChange () '      declare sub ReleaseCoffee () '   declare sub Alarm () '    '     Coffee_InitHardware () '   dim wMoney as long '    dim wGoods as long '   ' ***    *** '   OS_Init Mailfuncion '       dim bCoffeeSelection as byte bCoffeeSelection = OS_CreateMessage() '     dim bGoodsReliased as byte bGoodsReliased = OS_CreateEvent() '   OS_InitTask ControlHeater , 5 OS_InitTask ShowGoods , 8 OS_InitTask AcceptMoney , 3 OS_InitTask ScanKeys , 3 OS_InitTask MakeChange, 10 OS_InitTask ReleaseCoffee , 2 OS_InitTask Alarm , 1 '     OS_ResumeTask ControlHeater OS_ResumeTask ShowGoods OS_ResumeTask AcceptMoney OS_ResumeTask ScanKeys OS_ResumeTask MakeChange OS_ResumeTask ReleaseCoffee OS_ResumeTask Alarm '   OS_Sheduler end ' ***   *** ' ----------------------------------- sub ControlHeater() do select case GetWaterTemp() case is &gt; 97 Coffee_HeaterOff '   case is &lt; 95 Coffee_HeaterOn '   case is &lt; 5 CallServce (WARNING_WATER_FROZEN) '   end select OS_Delay 60000 '  1  loop end sub ' ----------------------------------- sub ShowGoods() do LEDS = Coffee_GetDrinkSupplies() '    D, '         '   LEDS OS_WaitEvent bGoodsReliased '   " " loop end sub ' ----------------------------------- sub AcceptMoney() do wMoney = wMoney + ReadMoneyAcceptor() OS_Delay 20 loop end sub ' ----------------------------------- sub ScanKeys() do wGoods = ButtonPressed() if wMoney &gt;= GostOf(wGoods) then OS_SendMessage bCoffeeSelection, wGoods '     bCoffeeSelection,  '     end if OS_Delay 40 loop end sub ' ----------------------------------- sub MakeChange() do OS_WaitEvent bGoodsReliased '   " " Refund wMoney loop end sub ' ----------------------------------- sub ReleaseCoffee() do OS_WaitMessage bCoffeeSelection '  bCoffeeSelection wItem = OS_GetMessage(bCoffeeSelection) '   Release wItem '    wMoney = wMoney ‚Äì CostOf (wItem) '     OS_SignalEvent bGoodsReliased '     '  ,       : ' MakeChange  ShowGoods '  ,  ,     loop end sub ' ----------------------------------- sub Alarm() do OS_Delay 1000 if Hijack() = 1 then CallPolice() end if loop end sub ' ----------------------------------- ' ***    *** sub Mailfuncion (bCoffeeErr) print "Mailfunction! Error #: "; bCoffeeErr if isErrCritical (bCoffeeErr) = 1 then CallService() end if end sub</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Obviamente, uma abordagem seria mais correta, n√£o com pesquisas peri√≥dicas de bot√µes e um sensor de caixa, mas com o uso de interrup√ß√µes. </font><font style="vertical-align: inherit;">Nos manipuladores dessas interrup√ß√µes, poder√≠amos usar o envio de mensagens usando o </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">servi√ßo OS_SendMessage ()</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> com conte√∫do igual ao n√∫mero da tecla pressionada ou ao valor da moeda / nota inserida. </font><font style="vertical-align: inherit;">Convido o leitor a modificar o programa por conta pr√≥pria. </font><font style="vertical-align: inherit;">Gra√ßas √† abordagem orientada a tarefas e ao servi√ßo fornecido pelo sistema operacional, isso exigir√° altera√ß√µes m√≠nimas de c√≥digo.</font></font><br><br><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> C√≥digo-fonte AQUA RTOS </font></font></h2><br> <a href=""><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O c√≥digo fonte da vers√£o 1.05 est√° dispon√≠vel para download aqui</font></font></b></a> <br><br><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Postscript </font></font></h2><br> <i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Q: Por que AQUA</font></font></i> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> R: Bem, eu fiz o controle do aqu√°rio, √© como uma "casa inteligente", n√£o apenas para as pessoas, mas para os peixes. Cheio de todos os tipos de sensores, rel√≥gio em tempo real, sa√≠das de rel√© e pot√™ncia anal√≥gica, um menu na tela, um "programa de eventos" flex√≠vel e at√© um m√≥dulo WiFi. Os intervalos devem ser contados, os bot√µes devem ser pesquisados, os sensores devem ser processados, o programa de eventos deve ser lido na EEPROM e executado, a tela deve ser atualizada, o Wi-Fi deve responder. Al√©m disso, o controlador deve ir para um menu de v√°rios n√≠veis para configura√ß√µes e programa√ß√£o. Fazer sinalizadores e interrup√ß√µes √© apenas obter o pr√≥prio "c√≥digo da massa", que n√£o √© entendido nem modificado. Portanto, decidi que precisava de um sistema operacional. Aqui est√° ela AQUA. </font></font><br><br> <i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">P: Certamente o c√≥digo est√° cheio de erros e falhas l√≥gicas?</font></font></i> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A: Certamente. </font><font style="vertical-align: inherit;">Eu, como pude, criei uma variedade de testes e conduzi o sistema operacional em uma variedade de tarefas, e at√© bati um n√∫mero not√°vel de bugs, mas isso n√£o significa que tudo esteja completo. </font><font style="vertical-align: inherit;">Tenho mais certeza de que ainda existem muitos nas ruas secund√°rias do c√≥digo. </font><font style="vertical-align: inherit;">Portanto, ficarei muito grato se, em vez de me cutucar nos bichos na cara, voc√™ educadamente e com tato apontar para eles, e melhor me dizer como voc√™ acha que √© melhor corrigi-los. </font><font style="vertical-align: inherit;">Tamb√©m ser√° √≥timo se o projeto for desenvolvido como um produto da criatividade coletiva. </font><font style="vertical-align: inherit;">Por exemplo, algu√©m adicionar√° um servi√ßo para contar sem√°foros (n√£o se esqueceu? - sou um pregui√ßoso) e oferecer√° outras melhorias. </font><font style="vertical-align: inherit;">De qualquer forma, ficarei muito grato pela contribui√ß√£o construtiva.</font></font></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt453708/">https://habr.com/ru/post/pt453708/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt453694/index.html">Conecte-se ao Windows via SSH como no Linux</a></li>
<li><a href="../pt453696/index.html">Liga√ß√£o bidirecional angular, um pouco mais de compreens√£o</a></li>
<li><a href="../pt453698/index.html">Informa√ß√£o qu√¢ntica na consci√™ncia qu√¢ntica</a></li>
<li><a href="../pt453700/index.html">Li√ß√µes sobre SDL 2: Li√ß√£o 1 - Ol√°, SDL 2</a></li>
<li><a href="../pt453706/index.html">Como passei no exame de certifica√ß√£o do Google Cloud Professional Data Engineer</a></li>
<li><a href="../pt453710/index.html">Pr√°tica de desenvolvimento em grandes projetos: mitp SberPractice iOS # 1</a></li>
<li><a href="../pt453712/index.html">Como o eBay criou um scanner de c√≥digo de barras no WebAssembly</a></li>
<li><a href="../pt453714/index.html">Cliente de teste TON (Telegram Open Network) e o novo idioma Fift para contratos inteligentes</a></li>
<li><a href="../pt453716/index.html">Coworking no pa√≠s para o pessoal de TI da fam√≠lia - existe algu√©m?</a></li>
<li><a href="../pt453720/index.html">Sutilezas de express√µes lambda em c #</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>