<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üè∞ üéÖüèæ üê® ClickHouse + Graphite: comment r√©duire consid√©rablement la consommation d'espace disque üßòüèº üìî üë©üèæ‚Äçüîß</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Salutations habr. 


 Si quelqu'un ex√©cute un syst√®me Web graphite et rencontre un probl√®me de performances de stockage silencieux (IO, consommation d...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>ClickHouse + Graphite: comment r√©duire consid√©rablement la consommation d'espace disque</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/479564/"><p><img src="https://habrastorage.org/webt/qq/sw/qe/qqswqech4q2d--d55t5rujx9hrm.png"></p><br><p>  Salutations habr. </p><br><p> Si quelqu'un <a href="https://github.com/graphite-project/graphite-web" rel="nofollow">ex√©cute un syst√®me Web graphite</a> et rencontre un probl√®me de performances de stockage silencieux (IO, consommation d'espace disque), la chance que ClickHouse soit cast√© en remplacement devrait viser un.  Cette d√©claration implique qu'une impl√©mentation tierce, telle que <a href="https://github.com/grobian/carbonwriter" rel="nofollow">carbonwriter</a> ou <a href="https://github.com/go-graphite/go-carbon" rel="nofollow">go-carbon, est</a> d√©j√† utilis√©e comme m√©trique de r√©ception du d√©mon. </p><br><p>  ClickHouse r√©sout bien les probl√®mes d√©crits.  Par exemple, apr√®s avoir transf√©r√© des donn√©es 2TiB √† partir d'un murmure, elles tiennent dans 300GiB.  Je ne m'attarderai pas sur la comparaison en d√©tail, il y a suffisamment d'articles sur ce sujet.  De plus, jusqu'√† r√©cemment, tout √©tait parfait avec notre stockage ClickHouse. </p><a name="habracut"></a><br><h3 id="problemy-s-potreblyaemym-mestom">  Probl√®mes de consommation </h3><br><p> √Ä premi√®re vue, tout devrait bien fonctionner.  Suite √† la <a href="https://clickhouse.yandex/docs/ru/operations/table_engines/graphitemergetree/" rel="nofollow">documentation</a> , nous cr√©ons une configuration pour le sch√©ma de stockage des m√©triques (ci-apr√®s <code>retention</code> ), puis cr√©ons une table selon la recommandation du backend s√©lectionn√© pour graphite-web: <a href="https://github.com/lomik/carbon-clickhouse" rel="nofollow">carbon-clickhouse</a> + <a href="https://github.com/lomik/graphite-clickhouse" rel="nofollow">graphite-clickhouse</a> ou <a href="https://github.com/ClickHouse/graphouse" rel="nofollow">graphouse</a> , selon la pile utilis√©e.  Et ... la bombe √† retardement se d√©clenche. </p><br><p>  Afin de comprendre lequel, vous devez savoir comment les insertions et le chemin de vie des donn√©es dans les tableaux de la famille de moteurs * <em>MergeTree</em> ClickHouse (diagrammes tir√©s de la <a href="https://youtu.be/PLMSA_gDdyM" rel="nofollow">pr√©sentation d'</a> Alexei Zatelepin): </p><br><ul><li>  Un <code></code> donn√©es <code></code> ins√©r√©.  Dans notre cas, les m√©triques sont arriv√©es. <br><img src="https://habrastorage.org/webt/sg/w-/j-/sgw-j-iqinterrfern_vltigkzk.png"></li><li>  Chacun de ces blocs avant d'√©crire sur le disque est tri√© selon la cl√© <code>ORDER BY</code> sp√©cifi√©e lors de la cr√©ation de la table. </li><li>  Apr√®s le tri, une donn√©e est √©crite sur le disque. <br><img src="https://habrastorage.org/webt/pw/jn/i2/pwjni2dacybsmesxpbhsjzcbsnu.png"></li><li>  Le serveur surveille en arri√®re-plan qu'il n'y en a pas beaucoup et d√©marre les <code></code> arri√®re-plan ( <code>merge</code> , ci-apr√®s fusion). <br><img src="https://habrastorage.org/webt/bl/jx/ge/bljxge8pm7mw1dknwvqptruwqcu.png"><br><img src="https://habrastorage.org/webt/le/nx/bk/lenxbkzrtkajgoat-tqdfuqnzkk.png"></li><li>  Le serveur arr√™te de d√©marrer la fusion de lui-m√™me d√®s que les donn√©es n'entrent plus activement <code></code> <code>partition</code> , mais vous pouvez d√©marrer le processus manuellement avec la commande <code>OPTIMIZE</code> . </li><li>  S'il ne reste qu'une seule pi√®ce dans la partition, vous ne pouvez pas d√©marrer la fusion avec la commande habituelle, vous devez utiliser <code>OPTIMIZE ... FINAL</code> </li></ul><br><p>  Ainsi, les premi√®res mesures arrivent.  Et ils occupent un certain espace.  Les √©v√©nements ult√©rieurs peuvent varier l√©g√®rement en fonction de nombreux facteurs: </p><br><ul><li>  La cl√© de partitionnement peut √™tre tr√®s petite (jour) ou tr√®s grande (plusieurs mois). </li><li>  La configuration de r√©tention peut prendre en charge plusieurs seuils d'agr√©gation de donn√©es significatifs au sein de la partition active (o√π va l'enregistrement des m√©triques), ou non. </li><li>  S'il y a beaucoup de donn√©es, les premi√®res pi√®ces, qui en raison des fusions d'arri√®re-plan peuvent d√©j√† √™tre √©normes (lors du choix d'une cl√© de partition sous-optimale), ne pourront pas se tripoter avec de petites pi√®ces fra√Æches. </li></ul><br><p>  Et tout finit toujours pareil.  La place occup√©e par les m√©triques dans ClickHouse ne se d√©veloppe que si: </p><br><ul><li>  n'appliquez pas <code>OPTIMIZE ... FINAL</code> manuellement ou </li><li>  n'ins√©rez pas de donn√©es dans toutes les partitions de fa√ßon continue afin de d√©marrer une fusion en arri√®re-plan t√¥t ou tard </li></ul><br><p>  La deuxi√®me m√©thode semble la plus simple √† mettre en ≈ìuvre <del>  et, par cons√©quent, il a tort </del>  et a √©t√© test√© en premier. <br>  J'ai √©crit un script python assez simple qui a envoy√© des m√©triques factices pour chaque jour au cours des 4 derni√®res ann√©es et a √©t√© ex√©cut√© toutes les heures par la couronne. <br>  √âtant donn√© que tout le travail de ClickHouse DBMS est bas√© sur le fait que ce syst√®me fera tout le travail d'arri√®re-plan t√¥t ou tard, mais on ne sait pas quand, je ne pouvais pas attendre que les √©normes pi√®ces anciennes daignent commencer √† fusionner avec de nouvelles petites.  Il est devenu clair que nous devions chercher un moyen d'automatiser les optimisations forc√©es. </p><br><img src="https://habrastorage.org/webt/ph/p0/1q/php01q8tw0cn8r5hxyr44dvc6hk.png" width="300"><br><h3 id="informaciya-v-sistemnyh-tablicah-clickhouse">  Informations dans les tables syst√®me ClickHouse </h3><br><p>  <a href="https://clickhouse.yandex/docs/ru/operations/system_tables/" rel="nofollow">Jetez un</a> ≈ìil √† la structure de la table <a href="https://clickhouse.yandex/docs/ru/operations/system_tables/" rel="nofollow">system.parts</a> .  Il s'agit d'informations compl√®tes sur chaque √©l√©ment de toutes les tables du serveur ClickHouse.  Il contient, entre autres, les colonnes suivantes: </p><br><ul><li>  Nom de la <code>database</code> ( <code>database</code> ); </li><li>  nom de table ( <code>table</code> ); </li><li>  Nom et ID de la <code>partition</code> ( <code>partition</code> &amp; <code>partition_id</code> ); </li><li>  quand la pi√®ce a √©t√© cr√©√©e ( <code>modification_time</code> ); </li><li>  date minimum et maximum dans un morceau (le partitionnement se fait par jour) ( <code>min_date</code> &amp; <code>max_date</code> ); </li></ul><br><p>  Il existe √©galement une table <a href="https://clickhouse.yandex/docs/ru/operations/system_tables/" rel="nofollow">system.graphite_retentions</a> , avec les champs int√©ressants suivants: </p><br><ul><li>  Nom de la base de donn√©es ( <code>Tables.database</code> ); </li><li>  nom de la table ( <code>Tables.table</code> ); </li><li>  l'√¢ge de la mesure lorsque la prochaine agr√©gation ( <code>age</code> ) doit √™tre appliqu√©e; </li></ul><br><p>  Donc: </p><br><ol><li>  Nous avons un tableau de pi√®ces et un tableau de r√®gles d'agr√©gation. </li><li>  Combinez leur intersection et obtenez toutes les tables * GraphiteMergeTree. </li><li>  Nous recherchons toutes les partitions dans lesquelles: <br><ul><li>  plus d'une pi√®ce </li><li>  ou le moment est venu d'appliquer la r√®gle d'agr√©gation suivante, et <code>modification_time</code> plus ancien que ce moment. </li></ul></li></ol><br><h3 id="realizaciya">  Impl√©mentation </h3><br><div class="spoiler">  <b class="spoiler_title">Cette demande</b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">concat</span></span>(p.database, <span class="hljs-string"><span class="hljs-string">'.'</span></span>, p.table) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">table</span></span>, p.partition_id <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> partition_id, p.partition <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">partition</span></span>, <span class="hljs-comment"><span class="hljs-comment">--  "" ,      -- ,    ,  (*) max(g.age) AS age, --     countDistinct(p.name) AS parts, --        00:00:00   toDateTime(max(p.max_date + 1)) AS max_time, --      max_time + age AS rollup_time, --         min(p.modification_time) AS modified_at FROM system.parts AS p INNER JOIN ( --      *GraphiteMergeTree SELECT Tables.database AS database, Tables.table AS table, age FROM system.graphite_retentions ARRAY JOIN Tables GROUP BY database, table, age ) AS g ON (p.table = g.table) AND (p.database = g.database) WHERE --    p.active -- (*)   ,        AND ((toDateTime(p.max_date + 1) + g.age) &lt; now()) GROUP BY table, partition HAVING --  ,     (modified_at &lt; rollup_time) --     OR (parts &gt; 1) ORDER BY table ASC, partition ASC, age ASC</span></span></code> </pre> </div></div><br><p>  renvoie chacune des partitions des tables * GraphiteMergeTree dont la fusion devrait lib√©rer de l'espace disque.  Il ne reste que la petite chose: parcourez-les tous avec la requ√™te <code>OPTIMIZE ... FINAL</code> .  L'impl√©mentation finale a √©galement pris en compte le moment o√π il n'est pas n√©cessaire de toucher les partitions avec un enregistrement actif. </p><br><p>  C'est exactement ce que fait le projet <a href="https://github.com/innogames/graphite-ch-optimizer" rel="nofollow">graphite-ch-optimizer</a> .  D'anciens coll√®gues de Yandex.Market l'ont test√© dans la prod, le r√©sultat du travail peut √™tre vu ci-dessous. </p><br><p><img src="https://habrastorage.org/webt/23/wv/mw/23wvmwkqw9ckohfvfqfshwhbqmu.jpeg" alt="r√©sultat"></p><br><p>  Si vous ex√©cutez le programme sur le serveur avec ClickHouse, il commencera simplement √† fonctionner en mode d√©mon.  Une fois par heure, une requ√™te sera ex√©cut√©e, v√©rifiant s'il existe de nouvelles partitions de plus de trois jours pouvant √™tre optimis√©es. </p><br><p>  Dans un avenir proche - pour fournir au moins les packages deb, et si possible - √©galement rpm. </p><br><p>  <strong>UPD: les</strong> packages sont disponibles <a href="https://github.com/innogames/graphite-ch-optimizer/releases" rel="nofollow">sur les versions de github</a> , et des images de travail peuvent √™tre trouv√©es sur docker-hub dans le r√©f√©rentiel innogames / graphite-ch-optimizer. </p><br><h3 id="vmesto-zaklyucheniya">  Au lieu d'une conclusion </h3><br><p>  Au cours des 9 derniers mois et plus, j'ai pass√© beaucoup de temps au sein de ma soci√©t√© <a href="https://www.innogames.com/ru/" rel="nofollow">InnoGames</a> √† la jonction de ClickHouse et de graphite-web.  Ce fut une bonne exp√©rience, qui a permis de passer rapidement de chuchotement √† ClickHouse en tant que r√©f√©rentiel de m√©triques.  J'esp√®re que cet article est quelque chose comme le d√©but d'un cycle sur les am√©liorations que nous avons apport√©es √† diff√©rentes parties de cette pile, et ce qui sera fait √† l'avenir. </p><br><p>  Plusieurs litres de bi√®re et des journ√©es d'administration ont √©t√© consacr√©s au d√©veloppement de demandes avec <a href="https://habr.com/ru/users/v0devil/" class="user_link">v0devil</a> , pour lequel je tiens √† lui exprimer ma gratitude.  Et aussi pour avoir revu cet article. </p><br><p>  <a href="https://github.com/innogames/graphite-ch-optimizer" rel="nofollow">Page du projet sur github</a> </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr479564/">https://habr.com/ru/post/fr479564/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr479548/index.html">Le chemin des stages aux performances √† HighLoad 2019</a></li>
<li><a href="../fr479550/index.html">MVC dans Unity avec des objets scriptables. 3e partie</a></li>
<li><a href="../fr479552/index.html">Les ing√©nieurs DevOps n'existent pas. Qui existe alors et que faire √† ce sujet?</a></li>
<li><a href="../fr479554/index.html">Contre tout le monde: assistants vocaux int√©gr√©s √† l'application</a></li>
<li><a href="../fr479562/index.html">Cr√©er la structure d'un bot multi-plateforme simple</a></li>
<li><a href="../fr479566/index.html">Syst√®me de suppression de potentiel ou reverse engineering de la Matrice + preuve de temps simultan√©</a></li>
<li><a href="../fr479568/index.html">Je travaille en tant que programmeur dans une entreprise, mais je veux rencontrer mes 50 ans diff√©remment</a></li>
<li><a href="../fr479570/index.html">Points d'entr√©e Python</a></li>
<li><a href="../fr479572/index.html">Comment Netflix Microservices g√®re les donn√©es Pub-Sub</a></li>
<li><a href="../fr479574/index.html">4 aspects de la gestion des services ITIL</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>