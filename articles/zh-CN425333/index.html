<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👿 🧑‍🤝‍🧑 👨🏼‍🚀 自己动手，春天来了（第2部分） 🉑 📩 👨‍🎨</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Evgeny EvgenyBorisov Borisov（NAYA Technologies）和Kirill Tolkkv Tolkachev（Cyan.Finance， Twitter ）继续谈论使用Spring Boot解决假想的Braavos铁库的问题。 在第二部分中，我们将重点介绍启动应用程...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>自己动手，春天来了（第2部分）</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/jugru/blog/425333/"><p>  Evgeny <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" class="user_link">EvgenyBorisov</a> Borisov（NAYA Technologies）和Kirill <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" class="user_link">Tolkkv</a> Tolkachev（Cyan.Finance， <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Twitter</a> ）继续谈论使用Spring Boot解决假想的Braavos铁库的问题。 在第二部分中，我们将重点介绍启动应用程序的配置文件和细微之处。 </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/c19/236/8c6/c192368c6d6e05d473201da0031d3ccc.png"><br><br></p><a name="habracut"></a><br><iframe width="560" height="315" src="https://www.youtube.com/embed/7Cq5zEm2wq0" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><p> 文章的第一部分可以在<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">这里</a>找到。 </p><br><p> 因此，直到最近，客户来了，才要求发送乌鸦。 现在情况已经改变。 冬天来了，城墙倒塌了。 </p><br><p>首先，发放贷款的原则正在发生变化。 如果以前他们以50％的概率向除Starks以外的所有人进行了捐赠，现在他们仅向偿还债务的人进行了捐赠。 因此，我们正在业务逻辑中更改发放贷款的规则。 但是，仅对于位于冬天已经到来的银行分支机构而言，其余的一切都照旧进行。 我想提醒您，这是一项决定是否授予贷款的服务。 我们将提供仅在冬季工作的另一项服务。 </p><br><p> 我们遵循我们的业务逻辑： </p><br><pre><code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WhiteListBasedProphetService</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ProphetService</span></span></span><span class="hljs-class"> </span></span>{  <span class="hljs-meta"><span class="hljs-meta">@Override</span></span>  <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">willSurvive</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String name)</span></span></span><span class="hljs-function"> </span></span>{    <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>;  } }</code> </pre> <br><p> 我们已经有了偿还债务者的清单。 </p><br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">spring</span></span>: <span class="hljs-selector-tag"><span class="hljs-selector-tag">application</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.name</span></span>: <span class="hljs-selector-tag"><span class="hljs-selector-tag">money-raven</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">jpa</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.hibernate</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.ddl-auto</span></span>: <span class="hljs-selector-tag"><span class="hljs-selector-tag">validate</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">ironbank</span></span>: <span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span><span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span><span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span>:   <span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span>  : <span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span>: ,   : <span class="hljs-selector-tag"><span class="hljs-selector-tag">true</span></span></code> </pre> <br><p> 还有一类已经与财产相关的阶级- <code></code> 。 </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ProphetProperties</span></span></span><span class="hljs-class"> </span></span>{ List&lt;String&gt; ; }</code> </pre> <br><p> 和以前一样，我们只在这里注入它： </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WhiteListBasedProphetService</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ProphetService</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> ProphetProperties prophetProperties; <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">willSurvive</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String name)</span></span></span><span class="hljs-function"> </span></span>{   <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; } }</code> </pre> <br><p> 请记住关于构造函数注入（关于魔术注释）： </p><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Service</span></span> <span class="hljs-meta"><span class="hljs-meta">@RequiredArgsConstructor</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WhiteListBasedProphetService</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ProphetService</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> ProphetProperties prophetProperties; <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">willSurvive</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String name)</span></span></span><span class="hljs-function"> </span></span>{   <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; } }</code> </pre> <br><p> 快完成了 </p><br><p> 现在，我们必须只向偿还债务的人分发： </p><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Service</span></span> <span class="hljs-meta"><span class="hljs-meta">@RequiredArgsConstructor</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WhiteListBasedProphetService</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ProphetService</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> ProphetProperties prophetProperties; <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">willSurvive</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String name)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> prophetProperties.get().contains(name); } }</code> </pre> <br><p> 但是这里有一个小问题。 现在，我们有两个实现：旧服务和新服务。 </p><br><pre> <code class="java hljs">Description Parameter <span class="hljs-number"><span class="hljs-number">1</span></span> of constructor in com.ironbank.moneyraven.service.TransferMoneyProphecyBackend… - nameBasedProphetService: defined in file [/Users/tolkv/git/conferences/spring-boot-ripper… - WhileListBackendProphetService: defined in file [/Users/tolkv/git/conferences/spring-boot-ripper...</code> </pre> <br><p> 将这些bean分成不同的配置文件是合乎逻辑的。  <code></code>资料<code></code>和<code></code>资料<code></code> 。 让我们的新服务仅在<code></code>配置文件中运行： </p><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Service</span></span> <span class="hljs-meta"><span class="hljs-meta">@Profile</span></span>(ProfileConstants.) <span class="hljs-meta"><span class="hljs-meta">@RequiredArgsConstructor</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WhiteListBasedProphetService</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ProphetService</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> ProphetProperties prophetProperties; <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">willSurvive</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String name)</span></span></span><span class="hljs-function"> </span></span>{   <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> prophetProperties.get().contains(name); } }</code> </pre> <br><p> 而且旧服务是在<code></code> 。 </p><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Service</span></span> <span class="hljs-meta"><span class="hljs-meta">@Profile</span></span>(ProfileConstants.) <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">NameBasedProphetService</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ProphetService</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">willSurvive</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String name)</span></span></span><span class="hljs-function"> </span></span>{   <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> !name.contains(<span class="hljs-string"><span class="hljs-string">"Stark"</span></span>) &amp;&amp; ThreadLocalRandom.current().nextBoolean(); } }</code> </pre> <br><p> 但是冬天来得很慢。 在破墙旁的王国里，已经是冬天了。 但是在南部的某个地方-还没有。 即 位于不同分支和时区的应用程序应该以不同的方式工作。 根据任务的条件，我们不能删除冬天来了的旧实现并使用新类。 我们希望银行员工什么都不做：我们将向他们提供一个可以在夏季模式下运行直到冬季到来的应用程序。 当冬天来临时，他们只是重新开始就这样。 他们将不必更改代码，删除任何类。 因此，我们最初有两个配置文件：部分垃圾箱是在夏天创建的，而部分垃圾箱是在冬天创建的。 </p><br><p> 但是出现另一个问题： </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/fbd/7a6/882/fbd7a6882ff3180ccfc693ac3b41a852.png"><br></p><br><p> 现在我们没有单个bean，因为我们指定了两个配置文件，并且应用程序在默认配置文件中启动。 </p><br><p> 因此，我们对客户提出了新要求。 </p><br><h2> 铁法2.禁止个人资料 </h2><br><p><img src="https://habrastorage.org/getpro/habr/post_images/04a/0bb/57a/04a0bb57aa20425f959898ac3eecf8a5.png"><br></p><br><p> 如果不激活概要文件，我们不想提出上下文，因为冬天已经来临，一切都变得非常糟糕。 根据<code></code>还是<code></code> ，某些事情是否应该发生。 另外，请查看异常，其文本已在上面给出。 他什么也没解释。 未定义配置文件，因此没有<code>ProphetService</code>实现。 同时，没有人说有必要设置配置文件。 </p><br><p> 因此，我们现在要在启动器中拧入另一块，在构建上下文时，它将检查是否设置了某些配置文件。 如果未设置，我们将不会抛出此类异常（并且不会缺少缺少bin的某些异常）。 </p><br><p> 我们可以使用我们的应用程序监听器来做到这一点吗？ 不行 这有三个原因： </p><br><ul><li> 单一责任听众负责使乌鸦飞起来。 侦听器不应检查配置文件是否已激活，因为激活配置文件不仅会影响侦听器本身，还会影响更多。 </li><li> 构建上下文时，会发生不同的事情。 如果不设置配置文件，我们不希望它们开始发生。 </li><li> 解析上下文后，侦听器将在最后工作。 而且没有资料这一事实，我们早就知道了。 为什么要等待这些有条件的五分钟，直到服务几乎上升，然后一切都下降。 </li></ul><br><p> 另外，由于我们没有配置文件就开始上升，我仍然不知道会出现什么错误（假设我不知道业务逻辑）。 因此，在没有概要文件的情况下，有必要在很早的阶段就取消上下文。 顺便说一句，如果您使用任何Spring Cloud，这对您来说就变得更加重要，因为该应用程序在早期阶段会做很多事情。 </p><br><p> 为了实现新要求，有<code>ApplicationContextInitializer</code> 。 这是另一个接口，允许我们通过在spring.factories中指定来扩展Spring的某些点。 </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/889/f21/a3b/889f21a3bee67ede3394d3c52b02e96d.png"><br></p><br><p> 我们实现了此接口，并且有一个Context Initializer，它具有<code>ConfigurableApplicationContext</code> ： </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ProfileCheckAppInitializer</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ApplicationContextInitializer</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ConfigurableApplicationContext</span></span></span><span class="hljs-class">&gt; </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">initialize</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ConfigurableApplicationContext applicationContext)</span></span></span><span class="hljs-function"> </span></span>{ } }</code> </pre> <br><p> 有了它，我们可以获得环境-SpringApplication为我们准备的东西。 我们交给他的所有财产都到了那里。 除其他外，它们还包含配置文件。 </p><br><p> 如果那里没有个人资料，那么我们应该抛出一个例外，说你不能那样做。 </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ProfileCheckAppInitializer</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ApplicationContextInitializer</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ConfigurableApplicationContext</span></span></span><span class="hljs-class">&gt; </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">initialize</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ConfigurableApplicationContext applicationContext)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> applicationContext.getEnvironment().getActiveProfiles().length == <span class="hljs-number"><span class="hljs-number">0</span></span> {     <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> RuntimeException(<span class="hljs-string"><span class="hljs-string">"  !"</span></span>);   } } }</code> </pre> <br><p> 现在您需要在spring.factories中注册这些东西。 </p><br><pre> <code class="java hljs">org.springframework.boot.context.properties.EnableConfigurationProperties=com.ironbank.moneyraven.starter.IronConfiguration org.springframework.context.ApplicationContextInitializer=com.ironbank.moneyraven.starter.ProfileCheckAppInitializer</code> </pre> <br><p> 从上面可以看出， <code>ApplicationContextInitializer</code>是扩展点。 当上下文刚刚开始构建时， <code>ApplicationContextInitializer</code>可以工作，但是还没有容器。 </p><br><p> 出现了一个问题：如果我们编写了<code>ApplicationContextInitializer</code> ，为什么作为监听器不以一种可扩展的配置编写它呢？ 答案很简单：因为在没有上下文和配置的情况下它应该可以更早地工作。 即 它不能被注入。 因此，我们将其规定为单独的部分。 </p><br><p> 尝试启动表明一切都已经足够快了，并报告说我们没有配置文件就开始了。 现在，让我们尝试指定一些配置文件，一切正常-乌鸦已发送。 </p><br><p>  <code>ApplicationContextInitializer</code>在已经创建上下文时执行，但是除了环境之外没有其他内容。 </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/4ee/fb1/3e5/4eefb13e5b1e2f8f04c19e22f58062a8.png"><br></p><br><p> 谁创造环境？  Carlson- <code>SpringBootApplication</code> 。 他用各种元信息填充了该信息，然后可以将其从上下文中撤出。 大多数东西可以通过<code>@value</code>注入，某些东西可以从环境中获得，因为我们刚刚获得了配置文件。 </p><br><p> 例如，以下是不同的属性： </p><br><ul><li>  Spring Boot可以构建； </li><li> 在启动时通过命令行传输的内容； </li><li> 系统性 </li><li> 说明为环境变量； </li><li> 应用属性中规定的内容； </li><li> 在其他一些属性文件中注册。 </li></ul><br><p> 所有这些都被收集并设置到环境对象中。 它还包含有关哪些配置文件处于活动状态的信息。  Spring Boot开始构建上下文时，环境对象是唯一存在的对象。 </p><br><p> 我想自动猜测一下，如果人们忘记了用手问该配置文件的情况（我们会做所有事情，以便那些没有程序员的无奈银行雇员可以启动该应用程序，以便无论什么情况都对他们有用）。 为此，我们将向启动器添加一种可以根据街道温度猜测轮廓（ <code></code>与否）的事物。 另一个新的魔术界面将为我们所有人提供帮助<code>EnvironmentPostProcessor</code> ，因为我们需要在<code>ApplicationContextInitializer</code>工作之前执行此操作。 在<code>ApplicationContextInitializer</code>之前，只有<code>EnvironmentPostProcessor</code> 。 </p><br><p> 我们再次实现一个新的接口。 只有一种方法，以与<code>ConfigurableEnvironment</code>引发<code>SpringApplication</code>方式相同的方式，因为我们还没有<code>ConfigurableContext</code> （它已经存在于<code>SpringInitializer</code>它不在这里；只有环境）。 </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ResolveProfileEnvironmentPostProcessor</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">EnvironmentPostProcessor</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">postProcessEnvironment</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ConfigurableEnvironment environment, SpringApplication application)</span></span></span><span class="hljs-function"> </span></span>{ } }</code> </pre> <br><p> 在这种环境下，我们可以设置配置文件。 但是首先，您需要检查之前没有人安装过它。 因此，我们<code>getActiveProfiles</code>需要检查<code>getActiveProfiles</code> 。 如果人们知道自己在做什么，并设置了个人资料，那么我们将不会为他们猜测。 但是，如果没有个人资料，我们将尝试通过天气了解。 </p><br><p> 第二点-我们必须了解我们现在是冬季还是夏季。 我们将返回<code>-300</code>的温度。 </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ResolveProfileEnvironmentPostProcessor</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">EnvironmentPostProcessor</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">postProcessEnvironment</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ConfigurableEnvironment environment, SpringApplication application)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (environment.getActivePrifiles().length == <span class="hljs-number"><span class="hljs-number">0</span></span> &amp;&amp; getTemperature() &lt; -<span class="hljs-number"><span class="hljs-number">272</span></span>) {   } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getTemperature</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> -<span class="hljs-number"><span class="hljs-number">300</span></span>; } }</code> </pre> <br><p> 在这种情况下，我们有了冬天，我们可以建立一个新的轮廓。 我们记得该配置文件称为<code></code> ： </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ResolveProfileEnvironmentPostProcessor</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">EnvironmentPostProcessor</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">postProcessEnvironment</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ConfigurableEnvironment environment, SpringApplication application)</span></span></span><span class="hljs-function"> </span></span>{   <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (environment.getActivePrifiles().length == <span class="hljs-number"><span class="hljs-number">0</span></span> &amp;&amp; getTemperature() &lt; -<span class="hljs-number"><span class="hljs-number">272</span></span>) { environment.setActiveProfiles(<span class="hljs-string"><span class="hljs-string">""</span></span>);   } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { environment.setActiveProfiles(<span class="hljs-string"><span class="hljs-string">""</span></span>);   } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getTemperature</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> -<span class="hljs-number"><span class="hljs-number">300</span></span>; } }</code> </pre> <br><p> 现在我们需要在spring.factories中指定<code>EnvironmentPostProcessor</code> 。 </p><br><pre> <code class="java hljs">org.springframework.boot.context.properties.EnableConfigurationProperties=com.ironbank.moneyraven.starter.IronConfiguration org.springframework.context.ApplicationContextInitializer=com.ironbank.moneyraven.starter.ProfileCheckAppInitializer org.springframework.boot.env.EnvironmentPostProcessor=com.ironbank.moneyraven.starter.ResolveProfileEnvironmentPostProcessor</code> </pre> <br><p> 结果，该应用程序启动时没有配置文件，我们说它是正式的，然后检查它是从我们那里启动的。 神奇地，我们意识到我们的概况是<code></code> 。 而且应用程序没有崩溃，因为接下来要检查是否有配置文件的<code>ApplicationContextInitializer</code> 。 <br> 结果： </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ResolveProfileEnvironmentPostProcessor</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">EnvironmentPostProcessor</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">postProcessEnvironment</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ConfigurableEnvironment environment, SpringApplication application)</span></span></span><span class="hljs-function"> </span></span>{   <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (getTemperature() &lt; -<span class="hljs-number"><span class="hljs-number">272</span></span>) {     environment.setActiveProfiles(<span class="hljs-string"><span class="hljs-string">""</span></span>);   } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> {     environment.setActiveProfiles(<span class="hljs-string"><span class="hljs-string">""</span></span>);   } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getTemperature</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{   <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> -<span class="hljs-number"><span class="hljs-number">300</span></span>; } }</code> </pre> <br><p> 我们讨论了<code>EnvironmentPostProcessor</code> ，它在<code>ApplicationContextInitializer</code>之前运行。 但是谁来运行它？ </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/fd0/20e/e9e/fd020ee9edd65a1e41e62e0ebe689658.png"><br></p><br><p> 此异常启动了它，显然是<code>ApplicationListener</code>和<code>EnvironmentPostProcessor</code>的非法儿子，因为它是从<code>ApplicationListener</code>和<code>EnvironmentPostProcessor</code>继承的。 它称为<code>ConfigFileApplicationListener</code> （为什么使用“ ConfigFile”-没人知道）。 </p><br><p> 他是我们的卡尔森，即  Spring Application提供了一个准备好的环境来监听两个事件： <code>ApplicationPreparedEvent</code>和<code>ApplicationEnvironmentPreparedEvent</code> 。 现在我们将不分析谁引发这些事件。 还有另外一层（至少在Spring开发的这个阶段，我认为已经完全多余了），它引发了一个事件，即环境开始构建（解析Application.yml，属性，环境变量等）。 ） <br> 接收到<code>ApplicationEnvironmentPreparedEvent</code> ，侦听器了解您需要配置环境-找到所有的<code>EnvironmentPostProcessor</code>并使它们工作。 </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/cd3/8c4/3b8/cd38c43b8a10c9867cc9b3ebcb3ee1e9.png"><br></p><br><p> 之后，他告诉<code>SpringFactoriesLoader</code>将您订购的所有内容（即所有<code>EnvironmentPostProcessor</code>交付给spring.factories。 然后将整个<code>EnvironmentPostProcessor</code>填充到一个列表中。 </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/9b0/e39/f0f/9b0e39f0fe2514c22cfdc03af4b3f464.png"><br></p><br><p> 并且知道他也是（同时）是<code>EnvironmentPostProcessor</code> ，因此他将自己推到了那里， <br><img src="https://habrastorage.org/getpro/habr/post_images/0f9/bf0/d30/0f9bf0d30e0065e707c813101aa173d9.png"><br> 同时，它们对它们进行排序，处理并调用每个方法的<code>postProcessEnvironment</code> 。 </p><br><p> 这样，所有<code>postProcessEnvironment</code>都在<code>SpringApplicationInitializer</code>之前的早期阶段<code>SpringApplicationInitializer</code> 。 在这种情况下，还将启动一个名为<code>ConfigFileApplicationListener</code>的令人费解的<code>EnvironmentPostProcessor</code> 。 </p><br><p> 设置环境后，一切将再次返回卡尔森。 </p><br><p> 如果环境准备就绪，则可以构建上下文。 卡尔森开始使用<code>ApplicationInitializer</code>构建上下文。 在这里，我们有自己的作品，该作品检查上下文中是否存在活动配置文件的环境。 如果不是，那我们就倒下了，因为否则我们以后还会遇到问题。 然后，启动器便开始工作，并且已经具有所有常规配置。 </p><br><p> 上图反映了Spring也不是很好。 这样的外星人会定期在那儿见面，不遵守单一责任，您需要小心攀爬。 </p><br><p> 现在，我们想谈谈这种奇怪生物的另一面，它的一侧是侦听器，另一侧是<code>EnvironmentPostProcessor</code> 。 </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/ffc/200/bf0/ffc200bf085fd822e7fd1fdf6d9e8fec.png"><br></p><br><p> 与<code>EnvironmentPostProcessor</code>一样<code>EnvironmentPostProcessor</code>它可以加载application.yml，应用程序属性，各种环境变量，命令参数等。 作为收听者，他可以收听两个事件： </p><br><ul><li> <code>ApplicationPreparedEvent</code> </li> <li> <code>ApplicationEnvironmentPreparedEvent</code> </li> </ul><br><p> 问题是： </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/452/851/6fc/4528516fcdf7fa9038e8ae80d2a8ac9a.png"><br></p><br><p> 所有这些事件都发生在旧的春天。 上面我们讨论的是Spring Boot中的事件（他为生命周期添加的特殊事件）。 还有一大堆。 这些是主要的： </p><br><ul><li> <code>ApplicationStartingEvent</code> </li> <li> <code>ApplicationEnvironmentPreparedEvent</code> </li> <li> <code>ApplicationPreparedEvent</code> </li> <li> <code>ContextRefreshedEvent</code> </li> <li> <code>EmbeddedServletContainerInitializedEvent</code> </li> <li> <code>ApplicationReadyEvent</code> </li> <li> <code>ApplicationFailedEvent</code> </li> </ul><br><p> 这个列表远非所有。 但是重要的是它们中的一些与Spring Boot相关，而与Spring相关（很好的旧<code>ContextRefreshedEvent</code>等）。 </p><br><p> 需要注意的是，并非所有这些事件都可以在应用程序中接收到（只是凡人-不同的祖母-不能只听Spring Boot引发的复杂事件）。 但是，如果您了解spring.factories的秘密机制，并在spring.factories级别定义了应用程序侦听器，那么从应用程序启动的最早阶段就可以了解这些事件。 </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/54f/14e/bca/54f14ebca5de6e029b3b47dc50f8c7e2.png"><br></p><br><p> 因此，您可以在相当早的阶段影响应用程序的启动。 可笑的是，这项工作的一部分是在其他实体中进行的，例如<code>EnvironmentPostProcessor</code>和<code>ApplicationContextInitializer</code> 。 </p><br><p> 您可以对侦听器进行所有操作，但这将带来不便和丑陋。 如果您想侦听Spring引发的所有事件，而不仅仅是<code>ContextRefreshedEvent</code>和<code>ContextStartedEvent</code> ，那么您就不需要像通常那样设置侦听器（如Bean）（否则创建得太晚了）。 还必须通过spring.factories注册它，然后才能更早地创建它。 </p><br><p> 顺便说一下，当我们查看此列表时，我们还不清楚<code>ContextStartedEvent</code>和<code>ContextStoppedEvent</code>何时触发？ </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/796/e78/7ca/796e787ca88d7271898b4072c03d3691.png"><br></p><br><p> 事实证明，这些事件根本不起作用。 为了了解应用程序是否真正启动，我们为应该捕获哪些事件困扰了很长时间。 事实证明，当您从上下文中强制拉出方法时，就会出现我们正在讨论的事件： </p><br><ul><li> <code>ctx.start();</code>  -&gt; <code>ContextStartedEvent</code> </li><li> <code>ctx.stop();</code>  -&gt; <code>ContextStoppedEvent</code> </li></ul><br><p> 即 仅当我们运行<code>SpringApplication.run</code> ，获取上下文并从中拉出<code>ctx.start();</code> ， <code>SpringApplication.run</code>才会发生<code>ctx.start();</code> 或<code>ctx.stop();</code>  。 尚不清楚为什么有必要这样做。 但是，他们又给了您一个扩展点。 </p><br><p>  Spring与此有关吗？ 如果是这样，某处应该有一个例外： </p><br><ul><li> <code>ctx.stop();</code>  （1） </li><li> <code>ctx.start();</code>  （2） </li><li> <code>ctx.close();</code>  （3） </li><li> <code>ctx.start();</code>  （4） </li></ul><br><p> 实际上，它将在最后一行，因为在<code>ctx.close();</code>之后<code>ctx.close();</code> 上下文无能为力。 但是调用<code>ctx.stop();</code> 在<code>ctx.start();</code>之前<code>ctx.start();</code>  -您可以（Spring只会忽略这些事件-它们仅适合您）。 </p><br><p> 写您的听众，听自己，提出您的法律，在<code>ctx.stop();</code>上做什么？  ，以及在<code>ctx.start();</code>上做什么？  。 </p><br><p> 总体而言，交互和应用程序生命周期图如下所示： </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/f05/25b/6b5/f0525b6b5742a9a7969a17465b174a4f.png"><br></p><br><p> 这里的颜色显示了生命的不同时期。 </p><br><ul><li> 蓝色是Spring Boot，应用程序已经启动。 这意味着将处理来自客户端的Tomcat服务请求，肯定会引发整个上下文，所有Bean都在工作，数据库已连接，等等。 </li><li> 绿色-事件<code>ContextRefreshedEvent</code>到达并构建了上下文。 例如，从这一刻起，应用程序侦听器开始工作，您可以通过设置ApplicationListener批注或通过具有监听某些事件的泛型的同名接口来实现。 如果要接收更多事件，则需要在spring.factories中编写相同的ApplicationListener（通常的Spring在这里工作）。 条形图指示“ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Spring Ripper”</a>报告的开始位置。 </li><li> 在较早的阶段，SpringApplication可以工作，为我们准备上下文。 这是准备我们常规的Spring开发人员时所做的应用程序的工作。 例如，配置的WebXML。 </li><li> 但是，甚至还有更早的阶段。 它显示了谁，在哪里和为谁工作。 </li><li> 仍然存在一个灰色的阶段，在其中不可能以任何方式楔入。 这是SpringApplication开箱即用的阶段（仅进入代码）。 </li></ul><br><p> 如果您注意到，在分为两部分的报告中，我们从右到左：从头开始，拧紧了从启动器飞来的配置，然后添加了以下内容，依此类推。 现在，让我们以相反的方向快速讨论整个链条。 <br> 您在主<code>SpringApplication.run</code> 。 他找到了不同的听众，并向他们抛出了他开始建立的事件。 之后，侦听器找到<code>EnvironmentPostProcessor</code> ，让他们配置环境。 设置好环境后，我们便开始构建上下文（Carlson进入）。 卡尔森构建上下文，并使所有应用程序初始化程序都可以在此上下文中执行某些操作。 我们有一个扩展点。 此后，已经配置了上下文，然后开始与常规Spring应用程序中发生的事情一样，在构建上下文时<code>BeanFactoryPostProcessor</code> ， <code>BeanPostProcessor</code> ，bean被配置。 这就是普通Spring所做的。 </p><br><h2> 怎么跑 </h2><br><p> 我们已经完成了编写应用程序的过程的讨论。 </p><br><p> 但是我们还有另一件事是开发人员不喜欢的。 他们不喜欢最终考虑如何开始应用程序。 管理员将在Tomcat，JBoss或WebLogic中运行它吗？ 它只是必须工作。 如果它不起作用，在最坏的情况下，开发人员将不得不再次配置一些内容 </p><br><p> 那么我们的启动方法是什么？ </p><br><ul><li> 雄猫战争 </li><li> 主意 </li><li>  <code>java -jar/war</code> 。 </li></ul><br><p>  Tomcat不是一个大趋势，我们将不对其进行详细讨论。 </p><br><p> 原则上，想法也不是很有趣。 这比我在下面讲的要棘手。 但是在思想上，原则上应该没有问题。 她知道启动程序将带来什么样的依赖性。 <br> 如果执行<code>java -jar</code> ，则主要问题是在启动应用程序之前先构建类路径。 </p><br><p> 人们在2001年做了什么？ 他们写了<code>java -jar</code>应该运行哪个jar，然后写了一个空格， <code>classpath=...</code>并在其中指示了脚本。 在我们的案例中，初学者添加了150 MB的各种依赖项。 所有这些都必须手动完成。 自然，没有人这样做。 我们只写： <code>java -jar</code> ，应该运行哪个jar就是这样。 不知何故，类路径仍在构建中。 我们现在将讨论这个。 </p><br><p> 让我们从准备jar文件开始，以便甚至在没有Tomcat的情况下也可以启动它。 在创建<code>java -jar</code>之前，您需要构建一个jar。 这个jar很明显应该是不寻常的，类似战争的东西，里面所有东西都在里面，包括嵌入式Tomcat。 </p><br><pre> <code class="java hljs">&lt;build&gt; &lt;plugins&gt;    &lt;plugin&gt;       &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;       &lt;artifactId&gt;spring-boot-maven-plugin&lt;/artifactId&gt;    &lt;/plugin&gt; &lt;/plugins&gt; &lt;/build&gt;</code> </pre> <br><p> 当我们下载项目时，已经有人在我们的POM中注册了一个插件。 顺便说一下，您可以在这里抛出配置，但稍后会介绍更多。     jar,   Maven  Gradle  ,   jar .      : </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/877/aad/b8e/877aadb8e0edbfbe6df10853b8c3f0c9.png"><br></p><br><p>     : </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/5ea/499/a35/5ea499a35d217fca525c27d7c8d2cfd3.png"><br></p><br><p>     war-. </p><br><p> ,     . </p><br><p>     ,    jar.    <code>java -jar</code> ,   ,    , , <code>org.springframework.boot</code> .      .     org.springframework.boot package.         <code>META-INF</code> </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/5a0/6c7/31e/5a06c731e6b958d02f683de73b2c5a9c.png"><br></p><br><p> Spring Boot   MANIFEST (    Maven  Gradle),     main class,    jar-. </p><br><p>  ,  jar-    :     -,    main-.     <code>java -jar</code>   -jar,   ,   main-class-. </p><br><p>  ,   ,        MANIFEST,  main-class   ,    main (    Idea).     ,     .     class path?    <code>java -jar</code>  ,  main,   , —    main,     .    MANIFEST      JarLauncher. </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/496/8b5/f76/4968b5f76b6ece2fc7431dbc6195d14e.png"><br></p><br><p> 即     ,     ,    JarLauncher.    ,    main,     class path. <br>    ,    main?   property — <code>Start-class</code> . </p><br><p> 即       .     class path  jar. ,    — <code>org.springframework.boot</code> —   class path.      <code>org.springframework.boot.loader.JarLauncher</code>  main-class.   , main-class  .   class path,    <code>BOOT-INF</code> (   lib     class  ,      ). </p><br><p>    RavenApplication, properties   class  <code>BOOT-INF</code> ,   ,  Tomcat  ,   <code>BOOT-INF/lib/</code> .  JarLauncher  classpath,     —  ,    <code>start-class</code> .     Spring, <code>ContextSpringApplication</code> —   flow,     . </p><br><p>   ,   start-class-?    ,     .      ,  . </p><br><p> ,     .     property,   <code>mainClass</code> ,   MANIFEST   <code>Start-Class</code> ,  <code>mainClass</code> —   JarLauncher. </p><br><p>      ,   mainClass,   ?     . Spring boot plugin   –  mainClass: </p><br><ul><li>     –    .     —     main class; </li><li>    – ,   mainClass   <code>@SpringBootApplication</code>   , , ,  ; </li><li>    —  exception   ,    main class,  ,     jar-  . 即    ,  ,   . ,   ,     main class. </li><li>  @SpringBootApplication  —   . </li></ul><br><p> JarLauncher   .   Tomcat     WarLauncher,      war-  ,  jar-. </p><br><p>    ,     <code>java -jar</code> .   ? 可以的   . </p><br><pre> <code class="java hljs">&lt;build&gt; &lt;plugins&gt;    &lt;plugin&gt;       &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;       &lt;artifactId&gt;spring-boot-maven-plugin&lt;/artifactId&gt;       &lt;configuration&gt;          &lt;executable&gt;<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>&lt;/executable&gt;       &lt;/configuration&gt;    &lt;/plugin&gt; &lt;/plugins&gt; &lt;/build&gt;</code> </pre> <br><p>     <code>&lt;configuration&gt;</code>    <code>&lt;executable&gt;true&lt;/executable&gt;</code>    Gradle  ,  : </p><br><pre> <code class="java hljs">springBoot { executable = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span> }</code> </pre> <br><p>      jar   executable jar.       . </p><br><p>  ,    .   Windows ,     exe-,   .       Spring Boot, ..   jar,    .      ,    . <br>   ? </p><br><p>      (jar —  zip-,     ): </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/355/f0a/08d/355f0a08d8a971a533cd824c84939827.png"><br></p><br><p> Spring Boot  - . </p><br><p>  -,   jar-.   ,      ,     — <code>#!/bin/bash</code> .     . </p><br><p>       .   <code>exit 0</code>   -  —      zip-. </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/365/674/922/365674922651752dc5a5896f48764d8e.png"><br></p><br><p>   ,   zip-    — <code>0xf4ra</code> .     ,  ,    . </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/60e/915/263/60e915263d6af6d19a5f0a7df977ee82.png"><br></p><br><p>       (,   ..). </p><br><p>  jar    : </p><br><ul><li>     —     ; </li><li>  ,    "   bash" ( <code>#!/bin/bash</code> ); </li><li> bash   ; </li><li>      <code>exit 0</code> ; </li><li>    <code>java -jar</code>   —     jar-,   ; </li><li>  <code>java -jar</code>  zip-   jar-,  ,    ,       . </li></ul><br><h2> 结论 </h2><br><p>         ,  Spring Boot —   ,     ,     . </p><br><p> -,  .  ,    Spring,   Spring —      Spring Boot.    ,         ,        — , ,   ,     . ,  ,     Spring, Spring Boot  . </p><br><p> -,    <code>@SpringBootApplication</code> ,     best practice,     Spring-. </p><br><p>   —   ,     ,   .    property  environment variable,    var arg   ,       ,    JSON.            <code>@value</code>       ,    .  configuration properties ,     ,     ,       .  ,  Spring     .   ,     ,      . </p><br><p>  .      ,    .          Spring,  Spring Boot    .    - ,   ,  ,           . </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/dc9/832/498/dc983249828e3fd26a257f871e46409e.png"><br></p><br><blockquote> 分钟的广告。 19-20    Joker 2018,            <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">«          [Joker Edition]»</a> ,         <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">«Micronaut vs Spring Boot,     ?»</a>  。  ,  Joker       <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="> </a> .     <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="> </a> . </blockquote></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN425333/">https://habr.com/ru/post/zh-CN425333/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN425323/index.html">“兔子洞。” 产品团队中的UX设计师</a></li>
<li><a href="../zh-CN425325/index.html">DIY字节码解释器</a></li>
<li><a href="../zh-CN425327/index.html">功能编程：测量七次，切一次</a></li>
<li><a href="../zh-CN425329/index.html">从“老歌”到千禧一代的一些建议。 如何在我们的数字世界中取得成功</a></li>
<li><a href="../zh-CN425331/index.html">爱丽丝将帮助开发人员在用户请求中查找对象。 对话框中的NER</a></li>
<li><a href="../zh-CN425335/index.html">不败的舰队Garmin</a></li>
<li><a href="../zh-CN425337/index.html">如何扩展Scrum-关于Nexus敏捷开发框架的几句话</a></li>
<li><a href="../zh-CN425339/index.html">互联网信息架构第二部分</a></li>
<li><a href="../zh-CN425341/index.html">“顶级3D博览会”概述。 数字教育2018»</a></li>
<li><a href="../zh-CN425343/index.html">25个有用的Kubernetes工具：部署和管理</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>