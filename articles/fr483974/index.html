<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üç™ ü§úüèø ‚ö™Ô∏è Ceph via iSCSI - ou skier debout dans un hamac üò® üëäüèº üïµüèø</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Y a-t-il parmi nous (cefovodov) ceux qui n'aiment pas "l'extr√™me professionnel"? 

 C'est peu probable - sinon nous ne ferions pas de saut p√©rilleux a...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Ceph via iSCSI - ou skier debout dans un hamac</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/483974/"> Y a-t-il parmi nous (cefovodov) ceux qui n'aiment pas "l'extr√™me professionnel"? <br><br>  C'est peu probable - sinon nous ne ferions pas de saut p√©rilleux avec ce produit extr√™mement int√©ressant et amusant. <br><br>  Beaucoup de ceux qui √©taient impliqu√©s dans l'exploitation de Ceph ont rencontr√© un cas pas trop fr√©quent (mais plut√¥t m√™me tr√®s rare) mais parfois exig√© - pour connecter Ceph via iSCSI ou FC.  Pourquoi?  Eh bien, par exemple, soumettez une image de Ceph √† un serveur Windows ou Solaris pas encore virtualis√©.  Ou virtualis√©, mais gr√¢ce √† un hyperviseur que Ceph ne sait pas faire, et comme nous le savons, il y en a assez.  Par exemple?  Eh bien, par exemple, HyperV ou ESXi, qui sont activement utilis√©s.  Et si la t√¢che se pose de soumettre l'image de Ceph √† la machine invit√©e, cela devient une t√¢che tr√®s excitante. <br><a name="habracut"></a><br>  Donc, √©tant donn√©: <br><br><ol><li>  d√©j√† en cours d'ex√©cution cluster Ceph </li><li>  une image existante qui doit √™tre soumise via iSCSI </li><li>  Nom de la piscine <b>mypool</b> , nom de l'image <b>myimage</b> </li></ol><br>  Commen√ßons-nous <br><br>  Tout d'abord, lorsque nous parlons de FC ou iSCSI, nous obtenons des entit√©s telles qu'un initiateur et une cible.  La cible est en fait un serveur, l'initiateur est un client.  Notre t√¢che est de soumettre l'image Ceph √† l'initiateur avec un minimum de travail.  Nous devons donc d√©ployer la cible.  Mais o√π, sur quel ordinateur? <br><br>  Heureusement, dans le cluster Ceph, nous avons au moins un composant dont l'adresse IP est fixe et sur lequel l'un des composants Ceph les plus importants est configur√©, et ce composant est un moniteur.  En cons√©quence, sur le moniteur, nous avons d√©fini la cible iSCSI (et l'initiateur en m√™me temps, au moins pour les tests).  Je l'ai fait sur CentOS, mais pour toute autre distribution, la solution convient √©galement - il suffit de mettre les packages de la mani√®re acceptable dans votre distribution. <br><br> <code># yum -y install iscsi-initiator-utils targetcli</code> <br> <br>  Quel est le but des packages install√©s? <br><br><ul><li>  <b>targetcli</b> - Utilitaire de gestion de cible Linux SCSI pour le noyau Linux </li><li>  <b>iscsi-initiator-utils</b> - un package avec des utilitaires utilis√©s pour contr√¥ler √† nouveau l'initiateur iSCSI int√©gr√© au noyau Linux </li></ul><br>  Afin de soumettre une image via iSCSI √† l'initiateur, il existe deux options pour le d√©veloppement d'√©v√©nements - utiliser le backend de l'espace utilisateur de la cible ou connecter l'image en tant que p√©riph√©rique de bloc visible au syst√®me d'exploitation et l'exporter via iSCSI.  Nous allons suivre la deuxi√®me voie - le backend de l'espace utilisateur est toujours dans un √©tat ¬´exp√©rimental¬ª et n'est pas pr√™t pour une utilisation productive.  De plus, il y a des pi√®ges avec lui dont vous pouvez beaucoup parler et (oh horreur!) Argumenter. <br><br>  Si nous utilisons au moins une distribution stable avec un long cycle de support, alors nous avons le noyau d'une ancienne version ancienne.  Par exemple, sur CentOS7, c'est 3,10. *, Sur CentOS8, c'est 4,19.  Et nous sommes int√©ress√©s par un noyau d'au moins 5.3 (mais plut√¥t 5.4) et un plus r√©cent.  Pourquoi?  Parce que par d√©faut, les images de Ceph ont un ensemble d'options joint qui n'est pas compatible avec les noyaux plus anciens.  Donc, nous connectons le r√©f√©rentiel avec un nouveau noyau pour notre distribution (par exemple, pour CentOS c'est elrepo), installons un nouveau noyau et red√©marrons le syst√®me pour travailler avec le nouveau noyau: <br><br><ul><li>  Connectez-vous au moniteur s√©lectionn√© pour l'exp√©rience </li><li>  Nous connectons les r√©f√©rentiels elrepo conform√©ment aux instructions - <a href="http://elrepo.org/tiki/tiki-index.php">elrepo.org/tiki/tiki-index.php</a> </li><li>  Installez le noyau: yum -y --enablerepo = elrepo-kernel install kernel-ml </li><li>  Nous red√©marrons le serveur avec le moniteur (apr√®s tout, nous avons trois moniteurs, non?) </li></ul><br>  Connectez l'image en tant que p√©riph√©rique de bloc <br><br> <code># <b>rbd map mypool/myimage</b> <br> /dev/rbd0</code> <br> <br>  Il ne reste plus qu'√† configurer la cible.  Dans cet exemple, je vais configurer la cible dans le soi-disant  mode d√©mo - sans authentification, visible et accessible √† tous.  Dans un environnement productif, vous voudrez probablement configurer l'authentification - mais c'est un peu hors de port√©e de l'exercice juste pour le plaisir d'aujourd'hui. <br><br>  Cr√©ez un backend avec le nom disk1 mapp√© sur le fichier / dev / rbd / mypool / myimage.  Le fichier sp√©cifi√© est un lien symbolique vers / dev / rbd0 cr√©√© automatiquement par le d√©mon udev.  Nous utilisons un lien symbolique car le nom du p√©riph√©rique rbd peut changer en raison de l'ordre dans lequel les images Ceph sont connect√©es √† l'h√¥te. <br><br>  Cr√©ez un backend: <br><br> <code># <b>targetcli /backstores/block create disk1 /dev/rbd/mypool/myimage</b></code> <br> <br>  Cr√©ez une cible iSCSI: <br><br> <code># <b>targetcli /iscsi create iqn.2020-01.demo.ceph:mypool</b></code> <br> <br>  Connectez le backend en tant que LUN √† la cible: <br><br> <code># <b>targetcli /iscsi/iqn.2020-01.demo.ceph:mypool/tpg1/luns create /backstores/block/disk1</b></code> <br> <br>  Nous ajustons la cible du mode d√©mo: <br><br> <code># <b>targetcli /iscsi/iqn.2020-01.demo.ceph:mypool/tpg1/ set</b> \ <br> &gt; <b>attribute demo_mode_write_protect=0</b> <br> # <b>targetcli /iscsi/iqn.2020-01.demo.ceph:mypool/tpg1/ set</b> \ <br> &gt; <b>attribute generate_node_acls=1</b> <br> # <b>targetcli /iscsi/iqn.2020-01.demo.ceph:mypool/tpg1/ set</b> \ <br> &gt; <b>attribute cache_dynamic_acls=1</b></code> <br> <br>  Enregistrez la configuration: <br><br> <code># targetcli saveconfig</code> <br> <br>  V√©rifiez la disponibilit√© de la cible: <br><br> <code># <b>iscsiadm -m discovery -t st -p 127.0.0.1:3260</b> <br> 127.0.0.1:3260,1 iqn.2020-01.demo.ceph:mypool</code> <br> <br>  Nous connectons la cible: <br><br> <code># <b>iscsiadm -m node --login</b> <br> Logging in to [iface: default, target: iqn.2020-01.demo.ceph:mypool, portal: 127.0.0.1,3260] (multiple) <br> Login to [iface: default, target: iqn.2020-01.demo.ceph:mypool, portal: 127.0.0.1,3260] successful.</code> <br> <br>  Si vous avez tout fait correctement, un nouveau disque appara√Ætra sur le serveur, qui ressemble √† un p√©riph√©rique SCSI, mais en fait c'est une image de Ceph, dont l'acc√®s se fait via la cible iSCSI.  Pour √©viter les probl√®mes de d√©marrage, il est pr√©f√©rable de supprimer le lecteur mapp√© et la cible d√©tect√©e de l'initiateur local: <br><br> <code># <b>iscsiadm -m node --logout</b> <br> # <b>iscsiadm -m discoverydb -o delete -t st -p 127.0.0.1:3260</b></code> <br> <br>  Il ne reste plus qu'√† conserver la configuration pour que l'image se connecte automatiquement et apr√®s la connexion, la cible est stratifi√©e.  Le lancement d'une cible se compose de deux √©tapes - la connexion de RBD et le lancement r√©el de la cible. <br><br>  Tout d'abord, configurez la connexion automatique des images RBD √† l'h√¥te.  Cela se fait en ajoutant des lignes au fichier / etc / ceph / rbdmap: <br><br> <code># <b>cat /etc/ceph/rbdmap</b> <br> # RbdDevice Parameters <br> mypool/myimage id=admin <br> # <b>systemctl enable rbdmap</b></code> <br> <br>  La restauration de la configuration d'une cible est un peu plus compliqu√©e - nous devons √©crire l'unit√© pour systemd, qui restaurera la configuration: <br><br> <code># <b>cat /usr/lib/systemd/system/scsi-target.service</b> <br> [Unit] <br> Description=Start iSCSI target <br> <br> After=network-online.target rbdmap.service <br> Before=remote-fs-pre.target <br> Wants=network-online.target remote-fs-pre.target <br> <br> [Service] <br> Type=oneshot <br> RemainAfterExit=yes <br> ExecStart=/bin/targetcli restoreconfig <br> <br> [Install] <br> WantedBy=multi-user.target <br> <br> # <b>systemctl daemon-reload</b> <br> # <b>systemctl enable scsi-target</b></code> <br> <br>  Test final - une fois de plus, nous red√©marrons notre moniteur (c'est maintenant une cible iSCSI).  Il convient de noter que si nous n'avions pas effac√© la base de l'initiateur avec la commande <b>iscsiadm -n discoveryydb -o delete ...</b> nous aurions pu obtenir un serveur qui ne se chargeait pas ou se chargeait depuis longtemps. <br><br>  Que reste-t-il? <br><br>  Configurez l'initiateur sur le serveur sur lequel nous voulons soumettre la cible. <br><br>  Comment assurer la r√©silience de notre cible? <br><br>  Vous pouvez √©galement configurer des cibles sur d'autres moniteurs et organiser des trajets multiples (vmware comprendra cela et fonctionnera m√™me, Hyper-V ne comprendra pas - des verrous SCSI sont requis √† cet endroit).  √âtant donn√© que le client Ceph du noyau n'utilise pas la mise en cache, cela est tout √† fait fonctionnel.  Ou une autre option consiste √† cr√©er une ressource de cluster de trois composants - une adresse IP cible d√©di√©e et les services rbdmap et scsi-target, et √† g√©rer cette ressource via des outils de clustering (qui a dit stimulateur cardiaque?) <br><br><h4>  Au lieu d'une postface </h4><br>  Comme vous le savez, cet article est une petite blague - mais j'y ai essay√© ¬´rapidement et avec des exemples¬ª de consid√©rer plusieurs sujets plut√¥t populaires en m√™me temps - la cible iSCSI, qui ne peut pas n√©cessairement exporter des images Ceph - mais par exemple exporter des volumes LVM, les bases de travailler avec l'initiateur iSCSI ( comment analyser une cible, comment se connecter √† une cible, se d√©connecter, supprimer un enregistrement cible de la base de donn√©es), √©crire votre propre unit√© pour systemd et quelques autres <br><br>  J'esp√®re que m√™me si vous ne r√©p√©tez pas enti√®rement cette exp√©rience, au moins quelque chose de cet article vous sera utile. <br></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr483974/">https://habr.com/ru/post/fr483974/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr483954/index.html">[Annonce] Global Game Jam 2020 fin janvier</a></li>
<li><a href="../fr483956/index.html">[Annonce] Global Game Jam 2020</a></li>
<li><a href="../fr483958/index.html">15 m√©thodes JavaScript pour travailler avec des tableaux que vous devez conna√Ætre en 2020</a></li>
<li><a href="../fr483964/index.html">N'ayez pas peur de JSON ou de votre premi√®re application API</a></li>
<li><a href="../fr483972/index.html">Comment utiliser Quora pour promouvoir votre entreprise</a></li>
<li><a href="../fr483976/index.html">Cybers√©curit√© et menaces 2020: ce qui nous attend apr√®s les vacances</a></li>
<li><a href="../fr483978/index.html">Comprendre le concept de d√©veloppement d'applications Web modernes en 2020</a></li>
<li><a href="../fr483980/index.html">Cr√©ation d'une infrastructure informatique tol√©rante aux pannes. Partie 1 - Pr√©paration du d√©ploiement du cluster oVirt 4.3</a></li>
<li><a href="../fr483986/index.html">Contr√¥le des pens√©es des robots avec Emotiv Insight</a></li>
<li><a href="../fr483988/index.html">MicroSPA, ou comment inventer une roue carr√©e</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>