<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🍁 👩🏿‍🍳 🧝🏼 Tests unitaires pour les projets Arduino 👨‍🏫 👴🏻 👹</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Les développeurs embarqués "sérieux" (lire: stmshchiki) aiment de temps en temps espionner le méchant "arduino", dont l'environnement de développement...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Tests unitaires pour les projets Arduino</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/419445/"><p>  Les développeurs embarqués "sérieux" (lire: stmshchiki) aiment de temps en temps espionner le méchant "arduino", dont l'environnement de développement, entre autres, <em>ne prend même pas en charge les débogueurs matériels avec des points d'arrêt et la visualisation des valeurs des variables sous le curseur de la souris ou dans une plaque spéciale dans en temps réel</em> .  Eh bien, l'accusation est tout à fait vraie, la fenêtre du Serial Monitor plus <em>Serial.println</em> n'est pas le meilleur outil de débogage.  Cependant, un conducteur arduino compétent pourra facilement parer l'attaque et mettre en place le capitaine présomptueux s'il (le joueur arduino) utilise des tests unitaires. </p><a name="habracut"></a><br><p>  Ainsi, les tests unitaires (tests unitaires, tests unitaires) facilitent la vie lors de la recherche des zones problématiques de l'application, empêchent la répétition des problèmes déjà trouvés (régressions), donnent une confiance mesurable dans la fiabilité du code écrit.  Ceci est d'autant plus important lors du développement d'applications embarquées et de toutes sortes de robots mobiles, pour lesquels le processus de débogage, de capture et de <strong>reproduction</strong> (en particulier de reproduction) des erreurs est particulièrement difficile par rapport aux applications de bureau, de serveur ou mobiles classiques. </p><br><p>  Cependant, la transition vers l'utilisation de tests automatiques dans le projet nécessite une discipline interne particulière, une approche spéciale pour écrire du code et organiser l'espace de travail du projet. </p><br><p>  Lors de la préparation de la mise en œuvre de tests unitaires dans un projet, vous devez garder à l'esprit: </p><br><ul><li>  Les tests nécessitent du temps supplémentaire pour écrire du code (en fait, non: le temps consacré aux tests automatiques est assez comparable au temps passé à déboguer manuellement la même section, mais il sera rentable plusieurs fois sur une longue distance), tandis que le code de test peut dépasser par taille le code du site de test. </li><li>  Dans un projet couvert par des tests, il peut être difficile de réaliser une réorganisation globale du code (refactoring) - particulièrement pertinente au stade initial de développement, lorsque la base de code et l'API interne ne sont pas suffisamment établies (en revanche, le refactoriseur d'un projet non couvert par les tests entraînera toutes les mêmes régressions, vous ne les connaissez tout simplement pas) </li><li>  Il est nécessaire d'écrire des modules d'application afin qu'ils puissent être exécutés à la fois dans l'application et dans des tests individuels </li><li>  Il est nécessaire de déterminer la structure et les connexions au sein du projet afin qu'il contienne une place pour le code de l'application principale, le micrologiciel exécutable pour l'application principale, le code de test, le micrologiciel exécutable («lanceur» / lanceur) pour exécuter les tests. </li></ul><br><p>  Je ne parlerai plus de la philosophie des tests unitaires, mais je montrerai simplement comment implémenter techniquement des tests unitaires simples dans votre projet Arduino. </p><br><p>  Ensuite, considérez: </p><br><ul><li>  Plusieurs stratégies pour organiser un espace de travail de projet avec des tests unitaires prenant en compte les fonctionnalités de la plateforme Arduino. </li><li>  Option tout-en-un (code et tests dans un seul fichier d'esquisse), </li><li>  mettre des tests dans un module séparé dans le répertoire sketch, </li><li>  faire des tests dans un projet séparé. </li><li>  Exécution de tests sur l'appareil, </li><li>  exécution des mêmes tests sur un ordinateur de bureau sans téléchargement sur l'appareil; talons pour l'API Arduino </li></ul><br><h2 id="vybor-biblioteki-dlya-modulnogo-testirovaniya">  Choisir une bibliothèque pour les tests unitaires </h2><br><p>  Nous avons besoin d'un cadre de tests unitaires: </p><br><ul><li>  Pour C / C ++ </li><li>  Devrait fonctionner sur les appareils de la famille Arduino </li><li>  Doit fonctionner sur les systèmes de bureau </li><li>  J'adore les bibliothèques légères (ma préférence personnelle) </li></ul><br><p>  Pour la programmation d'Arduino, le langage C ++ est utilisé mélangé avec C, par conséquent, théoriquement, tout cadre de test unitaire pour C ++ fonctionnera, mais nous voulons exécuter des tests à la fois sur l'ordinateur de bureau et sur l'appareil.  Le fait est que certains appels à la bibliothèque libc standard sont implémentés pour Arduino, mais en aucun cas tous, donc tous les frameworks fonctionnant avec libc ne sont pas compilés pour Arduino.  L'inverse est également vrai: si le cadre est spécialement conçu pour Arduino, il peut ne pas fonctionner sur le système de bureau avec libc. </p><br><p>  J'ai regardé à travers plusieurs cadres et j'ai opté pour 2x: </p><br><ul><li>  <strong>ArduinoUnit</strong> : <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">https://github.com/mmurdoch/arduinounit</a> .  En général, il satisfait aux exigences initiales clés: il fonctionne à la fois sur Arduino (évidemment d'après le nom) et sur les systèmes de bureau (voir la section Tests in vitro sur le site Web du projet), mais d'un coup d'œil, cela semblait un peu lourd et j'ai décidé de regarder d'autres options. </li><li>  Bibliothèque <strong>Sput</strong> (Sput Unit Testing Framework pour C / C ++) <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">https://www.use-strict.de/sput-unit-testing/</a> .  Cette bibliothèque est aussi légère que possible: un seul fichier d'en-tête, même sans paire avec la source «.cpp» (tout se fait sur plusieurs macros).  Cependant, la sortie des messages passe par <em>std :: out</em> (qui est complètement naturel pour libc), qui n'est tout simplement pas implémenté sur Arduino. </li></ul><br><p>  Néanmoins, mes sympathies étaient dépassées en faveur de Sput, et le problème avec <em>std :: out a</em> été résolu avec plusieurs correctifs (remplacement de printf par sprintf + Serial.print). </p><br><p>  Le résultat a été <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">un projet <strong>sput-ino</strong></a> - un port de la bibliothèque sput vers la plate-forme Arduino tout en maintenant la compatibilité avec les systèmes de bureau avec libc </p><br><p>  - un exemple d'esquisse à fichier unique avec tests <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">/ sput-ino / exemples / sput-ino-monolith /</a> </p><br><p>  - un exemple avec la séparation du code principal et des tests en modules <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">sput-ino / exemples / sput-ino-modules /</a> </p><br><p>  - exécution de tests sur le système de bureau <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">sput-ino / exemple-bureau /</a> </p><br><p>  - un exemple avec la séparation du code principal et des tests pour différents projets - dans un référentiel séparé <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">https://github.com/sadr0b0t/sput-ino-demo</a> </p><br><h2 id="ustanovim-biblioteku">  Installer la bibliothèque </h2><br><p>  Il vous suffit de cloner le référentiel git <a href="">https://github.com/sadr0b0t/sput-ino.git</a> dans le répertoire <em>$ HOME / Arduino / bibliothèques</em> : </p><br><pre><code class="bash">cd $HOME/Arduino/libraries/
git clone https://github.com/sadr0b0t/sput-ino.git</code></pre><br>
<p>    IDE.</p><br>
<p>    github <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">https://github.com/sadr0b0t/sput-ino/</a>   <em>  </em> &gt; <em> ZIP</em> (Clone or download &gt; Download ZIP),     <em>sput-ino-master.zip</em>     : <em></em> &gt; <em> </em> &gt; <em> .ZIP ...</em>.</p><br>
<p>    <em></em> &gt; <em></em> &gt; <em>sput-ino</em> (<em>File</em> &gt; <em>Examples</em> &gt; <em>sput-ino</em>)</p><br>
<h2 id="prostoy-variant-odnofaylovyy-sketch-s-kodom-i-testami"> :      </h2><br>
<p><img src="https://habrastorage.org/getpro/habr/post_images/d96/63b/246/d9663b246920ecc9251e6f7254cb20ae.png" alt="image"></p><br>
<p>            .     ()       «.ino».    «.ino»      «.cpp» (  Arduino.h   -  ),     . </p><br>
<p>  <br>
<a href="">sput-ino/examples/sput-ino-monolith/sput-ino-monolith.ino</a></p><br>
<p> -  :</p><br>
<pre><code class="cpp">/**
 * @return a  b
 */
int a_plus_b(int a, int b) {
    return a + b;
}

/**
 * @return a  b
 */
int a_minus_b(int a, int b) {
    return a - b;
}

/** 
 *  ,   
 * @param pin   
 * @param num 
 * @return true,   num 
 */
bool led_on_even(int pin, int num) {
    if(num % 2 == 0) {
        digitalWrite(pin, HIGH);
    } else {
        digitalWrite(pin, LOW);
    }
    return num % 2 == 0;
}</code></pre><br>
<p>    sput ( : <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">http://www.use-strict.de/sput-unit-testing/tutorial.html</a>):</p><br>
<pre><code class="cpp">#include "sput.h"

/** Test a_plus_b call */
void test_a_plus_b() {
    sput_fail_unless(a_plus_b(2, 2) == 4, "2 + 2 == 4");
    sput_fail_unless(a_plus_b(-2, 2) == 0, "-2 + 2 == 0");

    // this one would pass on 32-bit controllers and would fail on AVR with 16-bit int
    sput_fail_unless(a_plus_b(34000, 34000) == 68000, "34000 + 34000 == 68000");
}

/** Test a_minus_b call */
void test_a_minus_b() {
    sput_fail_unless(a_minus_b(115, 6) == 109, "115 - 6 == 109");
    sput_fail_unless(a_minus_b(13, 17) == -4, "13 - 17 == -4");
}

/** Test test_led_on_even call */
bool test_led_on_even() {
    pinMode(13, OUTPUT);

    sput_fail_unless(led_on_even(13, 2), "num=2 =&gt; led#13 on");
    // would pass on desktop, might fail or pass on difference devices
    // (e.g.: Arduino Due - fail, ChipKIT Uno32 - pass)
    sput_fail_unless(digitalRead(13) == HIGH, "num=2 =&gt; led#13 on");

    sput_fail_unless(!led_on_even(13, 5), "num=5 =&gt; led#13 off");
    sput_fail_unless(digitalRead(13) == LOW, "num=5 =&gt; led#13 off");

    sput_fail_unless(led_on_even(13, 18), "num=18 =&gt; led#13 on");
    sput_fail_unless(digitalRead(13) == HIGH, "num=18 =&gt; led#13 on");
}</code></pre><br>
<p>   (-).</p><br>
<p>    :</p><br>
<pre><code class="cpp">/** All tests in one bundle */
int mylib_test_suite() {
    sput_start_testing();

    sput_enter_suite("a plus b");
    sput_run_test(test_a_plus_b);

    sput_enter_suite("a minus b");
    sput_run_test(test_a_minus_b);

    sput_enter_suite("led on even");
    sput_run_test(test_led_on_even);

    sput_finish_testing();
    return sput_get_return_value();
}</code></pre><br>
<p>      :</p><br>
<pre><code class="cpp">/** Test suite for a_plus_b call */
int mylib_test_suite_a_plus_b() {
    sput_start_testing();

    sput_enter_suite("a plus b");
    sput_run_test(test_a_plus_b);

    sput_finish_testing();
    return sput_get_return_value();
}

/** Test suite for a_minus_b call */
int mylib_test_suite_a_minus_b() {
    sput_start_testing();

    sput_enter_suite("a minus b");
    sput_run_test(test_a_minus_b);

    sput_finish_testing();
    return sput_get_return_value();
}

/** Test suite for led_on_even call */
int mylib_test_suite_led_on_even() {
    sput_start_testing();

    sput_enter_suite("led on even");
    sput_run_test(test_led_on_even);

    sput_finish_testing();
    return sput_get_return_value();
}</code></pre><br>
<p>               .     -,         ,     /,      .          (,    ,    - ).</p><br>
<p>  :</p><br>
<pre><code class="cpp">void run_tests() {
    Serial.println("#################### Start testing...");

    // comment out specific test suites if firmware does not
    // fit to device memory

    // Test suite for a_plus_b call
    mylib_test_suite_a_plus_b();

    // Test suite for a_minus_b call
    mylib_test_suite_a_minus_b();

    // Test suite for led_on_even call
    mylib_test_suite_led_on_even();

    // All tests in one bundle
    //mylib_test_suite();

    Serial.println("#################### Finished testing");
}</code></pre><br>
<p>  <em>setup</em>/<em>loop</em>,    <em>run_tests</em>  <em>setup</em>   ,     <em>Serial.begin</em>,     :</p><br>
<pre><code class="cpp">void setup() {
    Serial.begin(9600);
    while (!Serial);

    // run tests
    run_tests();

    // other code - kinda application business logic
    Serial.println("Just show that we call functions from tested lib, nothing useful here");

    pinMode(13, OUTPUT);

    Serial.print("14+23=");
    Serial.println(a_plus_b(14, 23));
    Serial.print("14-23=");
    Serial.println(a_minus_b(14, 23));
    Serial.print("34000+34000=");
    Serial.println(a_plus_b(34000, 34000));
}

void loop() {
    static int i = 0;
    led_on_even(13, i++);
    delay(2000);
}</code></pre><br>
<p>         .     ,    <em>run_tests</em>,      .</p><br>
<p>,   ,        (<em> &gt;  </em> / <em>Tools &gt; Serial monitor</em>)</p><br>
<p>    ChipKIT Uno32 (   32-  PIC32):</p><br>
<pre><code>#################### Start testing...

== Entering suite #1, "a plus b" ==

[1:1]  test_a_plus_b:#1  "2 + 2 == 4"  pass
[1:2]  test_a_plus_b:#2  "-2 + 2 == 0"  pass
[1:3]  test_a_plus_b:#3  "34000 + 34000 == 68000"  pass

--&gt; 3 check(s), 3 ok, 0 failed (0.00%)

==&gt; 3 check(s) in 1 suite(s) finished after 0.00 second(s),
    3 succeeded, 0 failed (0.00%)

[SUCCESS]

== Entering suite #1, "a minus b" ==

[1:1]  test_a_minus_b:#1  "115 - 6 == 109"  pass
[1:2]  test_a_minus_b:#2  "13 - 17 == -4"  pass

--&gt; 2 check(s), 2 ok, 0 failed (0.00%)

==&gt; 2 check(s) in 1 suite(s) finished after 0.00 second(s),
    2 succeeded, 0 failed (0.00%)

[SUCCESS]

== Entering suite #1, "led on even" ==

[1:1]  test_led_on_even:#1  "num=2 =&gt; led#13 on"  pass
[1:2]  test_led_on_even:#2  "num=2 =&gt; led#13 on"  pass
[1:3]  test_led_on_even:#3  "num=5 =&gt; led#13 off"  pass
[1:4]  test_led_on_even:#4  "num=5 =&gt; led#13 off"  pass
[1:5]  test_led_on_even:#5  "num=18 =&gt; led#13 on"  pass
[1:6]  test_led_on_even:#6  "num=18 =&gt; led#13 on"  pass

--&gt; 6 check(s), 6 ok, 0 failed (0.00%)

==&gt; 6 check(s) in 1 suite(s) finished after 0.00 second(s),
    6 succeeded, 0 failed (0.00%)

[SUCCESS]
#################### Finished testing
Just show that we call functions from tested lib, nothing useful here
14+23=37
14-23=-9
34000+34000=68000</code></pre><br>
<p>   Arduino Uno ( AVR 16 ):</p><br>
<pre><code>#################### Start testing...

== Entering suite #1, "a#################### Start testing...

== Entering suite #1, "a plus b" ==

[1:1]  test_a_plus_b:#1  "2 + 2 == 4"  pass
[1:2]  test_a_plus_b:#2  "-2 + 2 == 0"  pass
[1:3]  test_a_plus_b:#3  "34000 + 34000 == 68000"  FAIL
!    Type:      fail-unless
!    Condition: a_plus_b(34000, 34000) == 68000
!    Line:      14

--&gt; 3 check(s), 2 ok, 1 failed (?%)

==&gt; 3 check(s) in 1 suite(s) finished after ? second(s),
    2 succeeded, 1 failed (?%)

[FAILURE]

== Entering suite #1, "a minus b" ==

[1:1]  test_a_minus_b:#1  "115 - 6 == 109"  pass
[1:2]  test_a_minus_b:#2  "13 - 17 == -4"  pass

--&gt; 2 check(s), 2 ok, 0 failed (?%)

==&gt; 2 check(s) in 1 suite(s) finished after ? second(s),
    2 succeeded, 0 failed (?%)

[SUCCESS]

== Entering suite #1, "led on even" ==

[1:1]  test_led_on_even:#1  "num=2 =&gt; led#13 on"  pass
[1:2]  test_led_on_even:#2  "num=2 =&gt; led#13 on"  pass
[1:3]  test_led_on_even:#3  "num=5 =&gt; led#13 off"  pass
[1:4]  test_led_on_even:#4  "num=5 =&gt; led#13 off"  pass
[1:5]  test_led_on_even:#5  "num=18 =&gt; led#13 on"  pass
[1:6]  test_led_on_even:#6  "num=18 =&gt; led#13 on"  pass

--&gt; 6 check(s), 6 ok, 0 failed (?%)

==&gt; 6 check(s) in 1 suite(s) finished after ? second(s),
    6 succeeded, 0 failed (?%)

[SUCCESS]
#################### Finished testing
Just show that we call functions from tested lib, nothing useful here
14+23=37
14-23=-9
34000+34000=2464</code></pre><br>
<p>    :</p><br>
<p> —  PIC32    ,   AVR     . 34000 + 34000 == 68000   32-  PIC32,  AVR  int = 2  (16 ),  ,      = 2^16-1=65536-1=65535 (   unsigned).  AVR  16- int  ,   32- PIC32 (  64-   x86_64)  .      ,     ,    .</p><br>
<p> —  <em>test_led_on_even</em> ( ,    )     , ,  ,   <em>digitalRead</em>     <em>digitalWrite</em>    —    .</p><br>
<p>-, <em>digitalRead</em> (  GPIO    pinMode INPUT)     ,      GPIO  <em>digitalWrite</em>    pinMode OUTPUT:     <em>digitalRead</em>       ,      .</p><br>
<p>-,   ,  <em>digitalRead</em>      <em>digitalWrite</em>,        ,   .         ,    ,     <em>digitalWrite</em>/<em>digitalRead</em>          (,  Arduino UNO  AVR  ,         pinMode(13, OUTPUT),  ChipKIT Uno32  PIC32     ).</p><br>
<p>    ,  <em>digitalWrite</em>     GPIO ,  <em>digitalRead</em>   .   ,  <em>digitalWriite</em>      .               -   ,              <em></em> ( ).</p><br>
<h2 id="testiruemyy-kod-i-testy-v-otdelnye-moduli">      </h2><br>
<p><img src="https://habrastorage.org/getpro/habr/post_images/62f/600/203/62f6002030eb72c1f344fb05353287fa.png" alt="image"></p><br>
<p>         —    ,          .</p><br>
<p>       .      ,          ,           .   ,       -         .</p><br>
<p>       :     (.ino)      (*.h),     (.c)  C++ (.cpp).        #include,    C/C++         .   Arduino IDE       .</p><br>
<p> :<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">sput-ino/examples/sput-ino-modules/</a></p><br>
<h4 id="modul-s-testiruemym-kodom-mylibhmylibcpp">   : mylib.h+mylib.cpp</h4><br>
<p>  —  :<br>
<a href="">sput-ino/examples/sput-ino-modules/mylib.h</a></p><br>
<pre><code class="cpp">#ifndef MYLIB_H
#define MYLIB_H

/**
 * @return a  b
 */
int a_plus_b(int a, int b);

/**
 * @return a  b
 */
int a_minus_b(int a, int b);

/** 
 *  ,   
 * @param pin   
 * @param num 
 * @return true,   num 
 */
bool led_on_even(int pin, int num);

#endif // MYLIB_TEST_H</code></pre><br>
<p>  .         API Arduino,   <em>Arduino.h</em>.</p><br>
<p><a href="">sput-ino/examples/sput-ino-modules/mylib.cpp</a></p><br>
<pre><code class="cpp">#include "Arduino.h"

/**
 * @return a  b
 */
int a_plus_b(int a, int b) {
    return a + b;
}

/**
 * @return a  b
 */
int a_minus_b(int a, int b) {
    return a - b;
}

/** 
 *  ,   
 * @param pin   
 * @param num 
 * @return true,   num 
 */
bool led_on_even(int pin, int num) {
    if(num % 2 == 0) {
        digitalWrite(pin, HIGH);
    } else {
        digitalWrite(pin, LOW);
    }
    return num % 2 == 0;
}</code></pre><br>
<h4 id="modul-s-testami-mylib-testhmylib-testcpp">  : mylib-test.h+mylib-test.cpp</h4><br>
<p>  —    (-),       :<br>
<a href="">sput-ino/examples/sput-ino-modules/mylib-test.h</a></p><br>
<pre><code class="cpp">#ifndef MYLIB_TEST_H
#define MYLIB_TEST_H

/** Test suite for a_plus_b call */
int mylib_test_suite_a_plus_b();

/** Test suite for a_minus_b call */
int mylib_test_suite_a_minus_b();

/** Test suite for led_on_even call */
int mylib_test_suite_led_on_even();

/** All tests in one bundle */
int mylib_test_suite();

#endif // MYLIB_TEST_H</code></pre><br>
<p>   :    ,    <em>mylib.h</em>  <em>Arduino.h</em> .</p><br>
<p><a href="">sput-ino/examples/sput-ino-modules/mylib-test.cpp</a></p><br>
<pre><code class="cpp">// http://www.use-strict.de/sput-unit-testing/tutorial.html
#include "sput.h"

#include "Arduino.h"
#include "mylib.h"

/** Test a_plus_b call */
void test_a_plus_b() {
    sput_fail_unless(a_plus_b(2, 2) == 4, "2 + 2 == 4");
    sput_fail_unless(a_plus_b(-2, 2) == 0, "-2 + 2 == 0");

    // this one would pass on 32-bit controllers and desktop (libc) and would fail on AVR with 16-bit int
    sput_fail_unless(a_plus_b(34000, 34000) == 68000, "34000 + 34000 == 68000");
}

/** Test a_minus_b call */
void test_a_minus_b() {
    sput_fail_unless(a_minus_b(115, 6) == 109, "115 - 6 == 109");
    sput_fail_unless(a_minus_b(13, 17) == -4, "13 - 17 == -4");
}

/** Test test_led_on_even call */
bool test_led_on_even() {
    pinMode(13, OUTPUT);

    sput_fail_unless(led_on_even(13, 2), "num=2 =&gt; led#13 on");
    // would pass on desktop, might fail or pass on difference devices
    // (e.g.: Arduino Due - fail, ChipKIT Uno32 - pass)
    sput_fail_unless(digitalRead(13) == HIGH, "num=2 =&gt; led#13 on");

    sput_fail_unless(!led_on_even(13, 5), "num=5 =&gt; led#13 off");
    sput_fail_unless(digitalRead(13) == LOW, "num=5 =&gt; led#13 off");

    sput_fail_unless(led_on_even(13, 18), "num=18 =&gt; led#13 on");
    sput_fail_unless(digitalRead(13) == HIGH, "num=18 =&gt; led#13 on");
}

/*******************************************/
// test suites

/** Test suite for a_plus_b call */
int mylib_test_suite_a_plus_b() {
    sput_start_testing();

    sput_enter_suite("a plus b");
    sput_run_test(test_a_plus_b);

    sput_finish_testing();
    return sput_get_return_value();
}

/** Test suite for a_minus_b call */
int mylib_test_suite_a_minus_b() {
    sput_start_testing();

    sput_enter_suite("a minus b");
    sput_run_test(test_a_minus_b);

    sput_finish_testing();
    return sput_get_return_value();
}

/** Test suite for led_on_even call */
int mylib_test_suite_led_on_even() {
    sput_start_testing();

    sput_enter_suite("led on even");
    sput_run_test(test_led_on_even);

    sput_finish_testing();
    return sput_get_return_value();
}

/** All tests in one bundle */
int mylib_test_suite() {
    sput_start_testing();

    sput_enter_suite("a plus b");
    sput_run_test(test_a_plus_b);

    sput_enter_suite("a minus b");
    sput_run_test(test_a_minus_b);

    sput_enter_suite("led on even");
    sput_run_test(test_led_on_even);

    sput_finish_testing();
    return sput_get_return_value();
}</code></pre><br>
<p>    :        <em>mylib.h</em>     <em>mylib-test.h</em>.</p><br>
<p><a href="">sput-ino/examples/sput-ino-modules/sput-ino-modules.ino</a></p><br>
<pre><code class="cpp">#include "mylib.h"
#include "mylib-test.h"

/** run tests on device */
void run_tests() {
    Serial.println("#################### Start testing...");

    // comment out specific test suites if firmware does not
    // fit to device memory

    // Test suite for a_plus_b call
    mylib_test_suite_a_plus_b();

    // Test suite for a_minus_b call
    mylib_test_suite_a_minus_b();

    // Test suite for led_on_even call
    mylib_test_suite_led_on_even();

    // All tests in one bundle
    //mylib_test_suite();

    Serial.println("#################### Finished testing");
}

void setup() {
    Serial.begin(9600);
    while (!Serial);

    // run tests
    run_tests();

    // other code - kinda application business logic
    Serial.println("Just show that we call functions from tested lib, nothing useful here");

    pinMode(13, OUTPUT);

    Serial.print("14+23=");
    Serial.println(a_plus_b(14, 23));
    Serial.print("14-23=");
    Serial.println(a_minus_b(14, 23));
    Serial.print("34000+34000=");
    Serial.println(a_plus_b(34000, 34000));
}

void loop() {
    static int i = 0;
    led_on_even(13, i++);
    delay(2000);
}</code></pre><br>
<p>,    ,   .</p><br>
<p><strong>,  :</strong><br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">sput-ino-modules/</a></p><br>
<p> —       :<br>
<a href="">sput-ino-modules/sput-ino-modules.ino</a></p><br>
<p> —  :<br>
<a href="">sput-ino-modules/mylib.h</a><br>
<a href="">sput-ino-modules/mylib.cpp</a></p><br>
<p> —  :<br>
<a href="">sput-ino-modules/mylib-test.h</a><br>
<a href="">sput-ino-modules/mylib-test.cpp</a></p><br>
<p> ,        .     ,            ,    ,     /  - /       , </p><br>
<h2 id="vynosim-testy-v-otdelnyy-proekt">    </h2><br>
<p> ,         ,      ,      :</p><br>
<ul>
<li>          «.ino» (),      <em>   </em> (: «myproj1/myproj1.ino»).</li>
<li>        —   «.h»,    «.c»,   ++ «.cpp»,     «.ino».</li>
<li>             (-  <em>/tmp/build2b91b1aecd83593cdd811791fcf30e97.tmp/</em>),   «.ino»   «.cpp»,    «.cpp»  «.c»  gcc     «.o»,     «.o»         «.hex»  (    «  »)   avrdude     (:   <em> &gt; </em>,   <em>  </em>    ).</li>
<li>     $HOME/Arduino/libraries/ —            .</li>
</ul><br>
<p>, :</p><br>
<ul>
<li>         «.ino».         «.ino»,           .</li>
<li>                #include (: #include "mylib.h")    .</li>
<li>               ,         (: #include "../proj2/proj2lib.h"), ..               .</li>
<li>       «.h»     ,    (   , ,  ),         «.cpp»  «.c»,    .</li>
<li>    ,             ,         .</li>
</ul><br>
<p>,   :</p><br>
<ul>
<li>          $HOME/Arduino/libraries/</li>
<li>    ,          </li>
</ul><br>
<p>   (  ,      )     :<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">https://github.com/sadr0b0t/sput-ino-demo</a></p><br>
<p> -   .</p><br>
<p>    <em>$HOME/Arduino/libraries</em>       </p><br>
<pre><code>cd $HOME/Arduino/libraries/
ln -s /path/to/projects/dir/sput-ino-demo</code></pre><br>
<p>,         ,            .</p><br>
<p>:</p><br>
<pre><code>$HOME/Arduino/libraries/sput-ino-demo/</code></pre><br>
<p>   —   .</p><br>
<p>     —     /++:<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">sput-ino-demo/src/</a><br>
<a href="">sput-ino-demo/src/mylib.h</a><br>
<a href="">sput-ino-demo/src/mylib.cpp</a></p><br>
<p>              :</p><br>
<pre><code class="cpp">#include "mylib.h"</code></pre><br>
<p>   ,            <em>library.properties</em>:<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">sput-ino-demo/library.properties</a></p><br>
<pre><code>name=sput-ino-demo
version=0.0.1
author=sadr0b0t
maintainer=sadr0b0t
sentence=Demo project for sput-ino, Sput unit testing framework for C/C++ port to Arduino
paragraph=Demo project for sput-ino. Sput is an unit testing framework for C/C++ that focuses on simplicity of use and maximum portability. It is implemented as a single ANSI C compliant header file that provides all macros needed to start unit testing in nearly no time.
category=Other
url=https://github.com/sadr0b0t/sput-ino-demo
architectures=*</code></pre><br>
<p>(,    <em>library.properties</em>,     .h, .c, .cpp   <em>src/</em>,     <em>sput-ino-demo/</em>.     /      ,      , ..  <em>src/</em>, , .)</p><br>
<p>  — ,   :<br>
<a href="">sput-ino-demo/sput-ino-demo/sput-ino-demo.ino</a></p><br>
<p>-2,   -          <em> &gt;  &gt; sput-ino-demo/sput-ino-demo</em>,       .     ,   <em> &gt; </em>      .</p><br>
<p>-3,  - <em>mylib.h</em>  <em>mylib.cpp</em>        Arduino IDE (..       <em>sput-ino-demo/</em>),         .     ,   ,     .</p><br>
<p>-4,           «.ino».</p><br>
<p>,      ,   .</p><br>
<p>      :<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">sput-ino-demo/test/</a></p><br>
<p>      :<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">sput-ino-demo/test/mylib-test-arduino/</a><br>
<a href="">sput-ino-demo/test/mylib-test-arduino/mylib-test-arduino.ino</a><br>
<a href="">sput-ino-demo/test/mylib-test-arduino/mylib-test.h</a><br>
<a href="">sput-ino-demo/test/mylib-test-arduino/mylib-test.cpp</a></p><br>
<p>  :<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">sput-ino-demo/test/mylib-test-desktop/</a></p><br>
<p>     .</p><br>
<h2 id="zapusk-testov-na-nastolnom-kompyutere">    </h2><br>
<p>,        .  ,         .        ? -,    :     ,  ,  ,      ;           ,     . -,  ,        (, ,  <em></em>, <em>mock</em>),      (,        ,    ).    ,        ,        .</p><br>
<p> ,  :</p><br>
<ul>
<li>        ,</li>
<li>             ,     .</li>
</ul><br>
<p> ,    , -,        ,            .      ,  sput-ino    :   sput      libc, sput-ino —   sput        API,         . , ,   sput-ino,        libc,     .</p><br>
<p>,      :</p><br>
<ul>
<li> ,     ,   API .</li>
<li> ,    ,  API .</li>
</ul><br>
<p><strong>    API </strong></p><br>
<p>   (   <em>a_plus_b</em>  <em>a_minis_b</em>)   —   ,    /++.    - ,    .       ,               .            (      ,  -  16- int   AVR,   32- PIC32  64-  Intel/AMD  ).                .</p><br>
<p><strong>   API </strong></p><br>
<p>   (   <em>led_on_even</em>)    . ,    ,            <em>digitalRead</em>  <em>digitalWrite</em>.  ,   <em>digitalRead</em>  <em>digitalWrite</em>    libc    ,       ,     (     GPIO?).  ?         -         ?     x86?    AVR         ?</p><br>
<p>       ,       ,   -     ,    ,   .        ,     .   ,     .</p><br>
<p>,     API       :         (    ),    . ,               .           .</p><br>
<p><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">sput-ino/example-desktop/</a></p><br>
<p>   <em>Arduino.h</em><br>
<a href="">sput-ino/example-desktop/Arduino.h</a></p><br>
<pre><code class="cpp">#ifndef WPROGRAM_H
#define WPROGRAM_H

#define OUTPUT 1
#define INPUT 0

#define HIGH 1
#define LOW 0

unsigned long micros();

void pinMode(int pin, int mode);

void digitalWrite(int pin, int val);

int digitalRead(int pin);

#endif // WPROGRAM_H</code></pre><br>
<p>    <em>Arduino.cpp</em>:<br>
<a href="">sput-ino/example-desktop/Arduino.cpp</a></p><br>
<pre><code class="cpp">// saved values for pins
static int _pin_modes[64];
static int _pin_values[64];

// from Arduino.h

/**
 * micros stub
 */
unsigned long micros() {
    return 0;
}

/**
 * Set GPIO pin mode
 */
void pinMode(int pin, int mode) {
    _pin_modes[pin] = mode;
}

/**
 * Write GPIO pin value
 */
void digitalWrite(int pin, int val) {
    _pin_values[pin] = val;
}

/**
 * Read GPIO pin value
 */
int digitalRead(int pin) {
    return _pin_values[pin];
}</code></pre><br>
<p>     API ,       ,          (      ).         .</p><br>
<p> ,   ,         .      <em>main</em>:<br>
<a href="">sput-ino/example-desktop/mylib-test-main.cpp</a></p><br>
<pre><code class="cpp">#include "mylib-test.h"

int main() {
    return mylib_test_suite();
}</code></pre><br>
<p><br>
<a href="">sput-ino/example-desktop/build.sh</a></p><br>
<pre><code>#!/bin/sh
# simple build script, feel free to modify or convert it
# to your favourite build system config

#gcc -c c_file_stub.c
#g++ -std=c++11 -c cpp_file_stub.cpp

g++ -std=c++11 -c \
    -I. -I../examples/sput-ino-modules -I$HOME/Arduino/libraries/sput-ino/src \
    Arduino.cpp \
    ../examples/sput-ino-modules/mylib.cpp \
    ../examples/sput-ino-modules/mylib-test.cpp \
    mylib-test-main.cpp
g++ *.o -o test_mylib</code></pre><br>
<p>(      )</p><br>
<p></p><br>
<pre><code>./test_mylib</code></pre><br>
<p>   :</p><br>
<pre><code>== Entering suite #1, "a plus b" ==

[1:1]  test_a_plus_b:#1  "2 + 2 == 4"  pass
[1:2]  test_a_plus_b:#2  "-2 + 2 == 0"  pass
[1:3]  test_a_plus_b:#3  "34000 + 34000 == 68000"  pass

--&gt; 3 check(s), 3 ok, 0 failed (0.00%)

== Entering suite #2, "a minus b" ==

[2:1]  test_a_minus_b:#1  "115 - 6 == 109"  pass
[2:2]  test_a_minus_b:#2  "13 - 17 == -4"  pass

--&gt; 2 check(s), 2 ok, 0 failed (0.00%)

== Entering suite #3, "led on even" ==

[3:1]  test_led_on_even:#1  "num=2 =&gt; led#13 on"  pass
[3:2]  test_led_on_even:#2  "num=2 =&gt; led#13 on"  pass
[3:3]  test_led_on_even:#3  "num=5 =&gt; led#13 off"  pass
[3:4]  test_led_on_even:#4  "num=5 =&gt; led#13 off"  pass
[3:5]  test_led_on_even:#5  "num=18 =&gt; led#13 on"  pass
[3:6]  test_led_on_even:#6  "num=18 =&gt; led#13 on"  pass

--&gt; 6 check(s), 6 ok, 0 failed (0.00%)

==&gt; 11 check(s) in 3 suite(s) finished after 0.00 second(s),
    11 succeeded, 0 failed (0.00%)

[SUCCESS]</code></pre><br>
<p>, , .         ,        .</p><br>
<h3 id="rasshirenie-api-maketa-testy-kotorye-poluchitsya-zapuskat-tolko-na-nastolnoy-sisteme"> API ; ,       </h3><br>
<p>  ,     ,  <em>digitalWrite</em>     GPIO ,  <em>digitalRead</em>   .  ,  <em>digitalWriite</em>      .  ,   ,  <em>digitalWrite</em>     ,        <em>digitalRead</em>. ,      <em>digitalWrite</em>/<em>digitalRead</em>,   -      (       <em>digitalRead</em>              ),            API ,       (, <em>pinMode</em>).</p><br>
<p>,     API       ,        .</p><br>
<p>          ,    <em>_Arduino.h</em> (   ):<br>
<a href="">sput-ino/example-desktop/_Arduino.h</a></p><br>
<pre><code class="cpp">#ifndef _ARDUINO_H
#define _ARDUINO_H

// Additional calls to get extended info from Arduino mocks

/** Get pin mode */
int _get_pin_mode(int pin);

/** Get pin value */
int _get_pin_value(int pin);

#endif // _ARDUINO_H</code></pre><br>
<p>   <em>Arduino.cpp</em>:<br>
<a href="">sput-ino/example-desktop/Arduino.cpp</a></p><br>
<pre><code class="cpp">// From _Arduino.h
// Calls to get extended info from Arduino mocks

/** Get pin mode */
int _get_pin_mode(int pin) {
    return _pin_modes[pin];
}

/** Get pin value */
int _get_pin_value(int pin) {
    return _pin_values[pin];
}</code></pre><br>
<p> ,  <em>_get_pin_value</em>    <em>digitalRead</em>,  <em>_get_pin_mode</em>       API .</p><br>
<p>     <em>test_led_on_even</em> — <em>test_led_on_even_desktoponly</em>,    <em>_get_pin_value</em>  <em>digitalRead</em>.          ,            —           <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">sput-ino/example-desktop/</a></p><br>
<p>    :<br>
<a href="">sput-ino/example-desktop/mylib-test-desktoponly.h</a></p><br>
<pre><code class="cpp">#ifndef MYLIB_TEST_DESKTOPONLY_H
#define MYLIB_TEST_DESKTOPONLY_H

/** Test suite for led_on_even call */
int mylib_test_suite_led_on_even_desktoponly();

/** Desktop-only tests in one bundle */
int mylib_test_suite_desktoponly();

#endif // MYLIB_TEST_DESKTOPONLY_H</code></pre><br>
<p> :<br>
<a href="">sput-ino/example-desktop/mylib-test-desktoponly.cpp</a></p><br>
<pre><code class="cpp">// http://www.use-strict.de/sput-unit-testing/tutorial.html
#include "sput.h"

#include "_Arduino.h"
#include "Arduino.h"
#include "mylib.h"

/** Test test_led_on_even call */
bool test_led_on_even_desktoponly() {
    // we do not use Arduino API calls here to get info about
    // moked chip state, use calls from _Arduino.h instead

    sput_fail_unless(led_on_even(13, 2), "num=2 =&gt; led#13 on");
    sput_fail_unless(_get_pin_value(13) == HIGH, "num=2 =&gt; led#13 on");

    sput_fail_unless(!led_on_even(13, 5), "num=5 =&gt; led#13 off");
    sput_fail_unless(_get_pin_value(13) == LOW, "num=5 =&gt; led#13 off");

    sput_fail_unless(led_on_even(13, 18), "num=18 =&gt; led#13 on");
    sput_fail_unless(_get_pin_value(13) == HIGH, "num=18 =&gt; led#13 on");
}

/*******************************************/
// test suites

/** Test suite for led_on_even call */
int mylib_test_suite_led_on_even_desktoponly() {
    sput_start_testing();

    sput_enter_suite("led on even (only desktop)");
    sput_run_test(test_led_on_even_desktoponly);

    sput_finish_testing();
    return sput_get_return_value();
}

/** All tests in one bundle */
int mylib_test_suite_desktoponly() {
    sput_start_testing();

    sput_enter_suite("led on even (only desktop)");
    sput_run_test(test_led_on_even_desktoponly);

    sput_finish_testing();
    return sput_get_return_value();
}</code></pre><br>
<p>    —      : -   ,     .</p><br>
<p><a href="">sput-ino/example-desktop/mylib-test-main.cpp</a></p><br>
<pre><code class="cpp">#include "mylib-test.h"
#include "mylib-test-desktoponly.h"

int main() {
    return mylib_test_suite() | mylib_test_suite_desktoponly();
}</code></pre><br>
<p>    ( <em>mylib-test-desktoponly.cpp</em>)</p><br>
<pre><code>#!/bin/sh
# simple build script, feel free to modify or convert it
# to your favourite build system config

#gcc -c c_file_stub.c
#g++ -std=c++11 -c cpp_file_stub.cpp

g++ -std=c++11 -c \
    -I. -I../examples/sput-ino-modules -I$HOME/Arduino/libraries/sput-ino/src \
    Arduino.cpp \
    ../examples/sput-ino-modules/mylib.cpp \
    ../examples/sput-ino-modules/mylib-test.cpp \
    mylib-test-desktoponly.cpp \
    mylib-test-main.cpp
g++ *.o -o test_mylib</code></pre><br>
<p></p><br>
<pre><code>./build.sh</code></pre><br>
<p></p><br>
<pre><code>./test_mylib</code></pre><br>
<pre><code>== Entering suite #1, "a plus b" ==

[1:1]  test_a_plus_b:#1  "2 + 2 == 4"  pass
[1:2]  test_a_plus_b:#2  "-2 + 2 == 0"  pass
[1:3]  test_a_plus_b:#3  "34000 + 34000 == 68000"  pass

--&gt; 3 check(s), 3 ok, 0 failed (0.00%)

== Entering suite #2, "a minus b" ==

[2:1]  test_a_minus_b:#1  "115 - 6 == 109"  pass
[2:2]  test_a_minus_b:#2  "13 - 17 == -4"  pass

--&gt; 2 check(s), 2 ok, 0 failed (0.00%)

== Entering suite #3, "led on even" ==

[3:1]  test_led_on_even:#1  "num=2 =&gt; led#13 on"  pass
[3:2]  test_led_on_even:#2  "num=2 =&gt; led#13 on"  pass
[3:3]  test_led_on_even:#3  "num=5 =&gt; led#13 off"  pass
[3:4]  test_led_on_even:#4  "num=5 =&gt; led#13 off"  pass
[3:5]  test_led_on_even:#5  "num=18 =&gt; led#13 on"  pass
[3:6]  test_led_on_even:#6  "num=18 =&gt; led#13 on"  pass

--&gt; 6 check(s), 6 ok, 0 failed (0.00%)

==&gt; 11 check(s) in 3 suite(s) finished after 0.00 second(s),
    11 succeeded, 0 failed (0.00%)

[SUCCESS]

== Entering suite #1, "led on even (only desktop)" ==

[1:1]  test_led_on_even_desktoponly:#1  "num=2 =&gt; led#13 on"  pass
[1:2]  test_led_on_even_desktoponly:#2  "num=2 =&gt; led#13 on"  pass
[1:3]  test_led_on_even_desktoponly:#3  "num=5 =&gt; led#13 off"  pass
[1:4]  test_led_on_even_desktoponly:#4  "num=5 =&gt; led#13 off"  pass
[1:5]  test_led_on_even_desktoponly:#5  "num=18 =&gt; led#13 on"  pass
[1:6]  test_led_on_even_desktoponly:#6  "num=18 =&gt; led#13 on"  pass

--&gt; 6 check(s), 6 ok, 0 failed (0.00%)

==&gt; 6 check(s) in 1 suite(s) finished after 0.00 second(s),
    6 succeeded, 0 failed (0.00%)

[SUCCESS]</code></pre><br>
<p>   </p><br>
<h2 id="horoshiy-primer-potestiruem-obrabotchik-preryvaniy"> :   </h2><br>
<p>,          :</p><br>
<ul>
<li>    HIGH &gt; LOW,</li>
<li>        </li>
<li>   .</li>
</ul><br>
<p>           ,   (  )   .   — 3  :  1 —   ( ),  2 —   STEP  HIGH,  3 —  :  STEP  LOW,  .</p><br>
<p>      :</p><br>
<pre><code class="cpp">#define ACTION_STOP 0
#define ACTION_CHECK_BOUNDS 1
#define ACTION_GO_HIGH 2
#define ACTION_STEP 3

int step_count = 0;
int action = ACTION_STOP;

void timer_handle_interrupts() {
    //     ,
    //     
    if(!timeForStep()) return;

    //   
    if(ACTION_CHECK_BOUNDS == action) {
        //   -  
        if(checkBounds()) {
            //   - 
            action = ACTION_STOP;
        } else {
            //  ,     
            action = ACTION_GO_HIGH;
        }
    } else if(ACTION_GO_HIGH == action) {
        //   STEP,     
        digitalWrite(STEP_PIN, HIGH);
        action = ACTION_STEP;
    } else if(ACTION_STEP == action) {
        // 
        digitalWrite(STEP_PIN, LOW);
        step_count++;

        if(step_count &lt; max_steps) {
            //   
            action = ACTION_CHECK_BOUNDS;
        } else {
            // 
            action = ACTION_STOP;
        }
    }
}</code></pre><br>
<p> <em>timer_handle_interrupts</em> —    ,            (    : <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">arduino-timer-api</a>).</p><br>
<p> ,     ,  , ,  -   :    ,      ,  - .    ,    ,    .      ? ,           ,       IDE.            100500 ?             ?  -          .</p><br>
<p> ,           :</p><br>
<pre><code class="cpp">void test_timer_handle_interrupts() {
    //  1
    test_timer_handle_interrupts();
    //  1
    //  2
    //  3

    //  2
    test_timer_handle_interrupts();
    //  1
    //  2
    //  3

    //  3
    test_timer_handle_interrupts();
    //  1
    //  2
    //  3

    //  100500
    for(long i = 0; i &lt; 100500 - 3; i++) {
    }
    //  1
    //  2
    //  3

    //  100500+1
    test_timer_handle_interrupts();
    //  1
    //  2
    //  3

    // ...
    //   
}</code></pre><br>
<p>         <em>test_timer_handle_interrupts</em>.  ,       : 1, 2, 3, 103, , , —         .</p></div>
      
    </div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr419445/">https://habr.com/ru/post/fr419445/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr419433/index.html">Rapports DSW - Générateur de rapports DeepSeeWeb</a></li>
<li><a href="../fr419437/index.html">AR - Réalité augmentée (article plus vidéo)</a></li>
<li><a href="../fr419439/index.html">Comment le commerce électronique survit aux promotions à grande échelle. Se préparer aux pics de charge sur le Web [Partie 2]</a></li>
<li><a href="../fr419441/index.html">SpaceX réutilise la première fusée Falcon 9 Block 5 aujourd'hui</a></li>
<li><a href="../fr419443/index.html">La NASA s'envolera à nouveau vers la lune, rendant tous les éléments de l'avion</a></li>
<li><a href="../fr419449/index.html">API de contexte Redux vs React</a></li>
<li><a href="../fr419451/index.html">Créez pas à pas un bundle pour Symfony 4</a></li>
<li><a href="../fr419453/index.html">Méthodes numériques pour résoudre des systèmes d'équations non linéaires</a></li>
<li><a href="../fr419457/index.html">RabbitMQ - SQL Server</a></li>
<li><a href="../fr419459/index.html">Batteries au plomb: alphabet de charge d'impulsion</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>