<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👨🏾‍💼 🚾 👈🏾 我们击败了Amperka的GPRS模块 👋 🌿 👩‍👧‍👦</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="在击败CAN总线之前 ，我们必须破坏下一个硬件，即GPRS模块。 这就是她作为开发人员的生活-始终必须赢得别人的支持（应该禁止微笑）。 

 对于其中一个自定义项目，我需要添加使用SMS通过GSM控制和接收遥测功能。 我查看了可用选项的列表，并选择了Amperka的GPRS Shield。 为什么不...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>我们击败了Amperka的GPRS模块</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/401721/"><img src="https://habrastorage.org/files/f8d/d05/ce9/f8dd05ce94d24dc283d1abcbffdb5906.jpg" alt="图片"><br> 在击败<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">CAN总线之前</a> ，我们必须破坏下一个硬件，即GPRS模块。 这就是她作为开发人员的生活-始终必须赢得别人的支持（应该禁止微笑）。 <br><br> 对于其中一个自定义项目，我需要添加使用SMS通过GSM控制和接收遥测功能。 我查看了可用选项的列表，并选择了Amperka的GPRS Shield。 为什么不呢 它看起来像样，由一家知名公司生产，具有技术支持，价格与竞争对手没有太大差异，通常给人留下很好的印象。 <br><br> 但事实确实如此。 您可以通过单击下面的按钮将此GPRS模块与<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Arduino Mega Server</a>集成，以了解该任务以及我必须经历的令人难以置信的继续教育课程。 <br><a name="habracut"></a><br><h2> 模块本身 </h2><br> 正如我所说， <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">该模块本身</a>的执行准确性以及与一家知名公司的关系都给人留下了很好的印象。 同样，制造商的网站上有用法示例和本机库。 由于模块是品牌商标，因此希望在模块出现任何问题时获得足够的支持。 <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/332/bf2/2b2/332bf22b21a64277b46f78d65e580b13.jpg" alt="图片"></div><br> 展望未来，我会说技术支持可以在两周内正确回答我的问题，在库中查找错误，甚至根据与我交流的原因发布了新版本。 但是...我仍然必须使模块自己工作。 <br><br><h2> 专案 </h2><br> 关于需要GPRS模块的<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">GSM Coop项目的</a>几句话。 有必要发展自动化管理鸡舍。 确实，在我们生活的美好时光中，现在需要通过网络浏览器，无线智能传感器和GSM遥测来控制鸡舍。 这是某种战略目标，而不是鸡舍。 <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/a91/e3a/6a4/a91e3a6a4cd94a2cabc35ca7ebb381b1.png" alt="图片"></div><br> 但是，如果有必要，那就有必要。 我们购买组件，其中包括GPRS模块，然后继续。 <br><br><h2> 阿喀琉斯之heel </h2><br> 现在介绍该模块的功能。 基本上，它可以工作。 他使用制造商网站上的示例进行工作，甚至可以在此基础上创建一些简单的草图。 但是有三个“ buts”。 <br><br>  <i><strong>注意事项</strong></i>  <i>该项目中使用了两个主板： <strong>Arduino Mega 2560</strong>和<strong>Arduino Due，</strong>以下所有内容仅适用于它们。</i> <br><br>  <strong>第一个“但是”硬件。</strong> 该模块不适用于Arduino Due。 没办法 即使与Amperka的技术支持进行多天的通信也无济于事。 我和公司的专家都没有设法使GPRS Shield与Arduino Due一起使用。 而且这非常令人失望，因为Due是一款功能强大的出色控制器，希望将其与GPRS Shield一起使用。 <br><br>  <strong>第二个“ but”是系统性的。</strong> 该模块需要SoftwareSerial库才能工作。 当我开始与GPRS Shield和Amperka的技术支持进行对话时，这是一个非替代性的解决方案。 经过我们的诉讼，该库的修订版得到了支持，可以在Iron Serial上进行工作，但是……它从来没有赚过Due或Mega。 通常很难解释什么-如果模块在SoftSerial上工作，那么是什么阻止了它在Iron Serial上工作呢？ <br><br>  <strong>第三个“但是”，概念上的。</strong> 这还不是全部。 主要的埋伏在于模块库的原理。 它在关闭模式下工作，也就是说，它在等待SMS到达时（这是99％的时间）以及模块的所有其他操作期间，会阻止控制器的操作。 这是什么意思？ 这意味着在制造商的标准库中，您只能构建测试草图。 战略鸡舍对您而言并不发光，因为像安全系统，温室管理，通过GSM进行的智能家居控制等成千上万的炫酷应用程序都不会发光。 <br><br><h2> 有关SoftwareSerial的更多信息 </h2><br> 该模块不适用于Arduino Due，因此我们将讨论Arduino Mega。 这种情况的麻烦之处在于，Mega具有三个免费的硬件端口Serial1，Serial2和Seria3，我们被迫连接并使用SoftwareSerial库。 以任何无法想象和无法想象的方式，包括重新配置模块上的跳线以及对Amperka的技术支持进行沉思，都无法使GPRS Shield与Arduino Mega上的硬件端口配合使用。 <br><br> 好的...我们使用SoftwareSerial，但是在这里我们等待伏击。  SoftwareSerial可以在许多Arduino Mega引脚上工作，但由于某些原因，它只能在62和63引脚上工作。 为什么只在他们身上？ 这个谜语很棒。 从表面上看，我们永远不会知道这个问题的答案。 <br><br><h2> 选择的面粉 </h2><br> 现在，像往常一样，我们逐渐了解到标准库不适合实际使用。 通过在控制器等待接收来自GPRS模块的响应的过程中阻止控制器，该库还阻止了所有其他进程。 控制器仅在99％的时间内就脱离了现实，一直等到请求或响应到达或超时结束。 <br><br> 这结束了GPRS Shield的所有应用，除了测试之一：发送了一个打开套接字的请求-已打开，发送了一个关闭请求-已关闭。 谈不上Web服务器的任何工作，传感器的工作，执行器的控制等；这些都不能简单地工作。 <br><br> 问题出现了：要么我们放弃制造商的资料库，编写我们的GPRS Shield控制代码（说起来容易），要么我们放弃模块本身，寻找替代解决方案。 但是模块已经在那里，因此决定放弃该库并编写您的模块控制代码。 <br><br><h2> 征服珠穆朗玛峰 </h2><br> 我跳过了创建代码以替换Amperka标准库的整个过程，我只注意到这非常非常非常困难，需要大量的研究工作，复杂的算法编译以及大量的工作来测试最终的解决方案。 <br><br> 一切对您来说都很简单-有点神奇，并且支持GPRS Shield的AMS模块的现成工作代码已经准备就绪。 <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/557/a58/157/557a58157e7b45589395e0a9d867ee52.jpg" alt="图片"></div><br><div class="spoiler">  <b class="spoiler_title">完整的AMS模块代码替换标准库</b> <div class="spoiler_text"><pre><code class="java hljs"><span class="hljs-comment"><span class="hljs-comment">/* Modul GPRS part of Arduino Mega Server project */</span></span> #ifdef GPRS_FEATURE #include &lt;SoftwareSerial.h&gt; #define ALWAYS <span class="hljs-number"><span class="hljs-number">1</span></span> #define GPRS_ON_PIN <span class="hljs-number"><span class="hljs-number">2</span></span> #define GPRS_STATE_PIN <span class="hljs-number"><span class="hljs-number">3</span></span> #define GPRS_RX_PIN <span class="hljs-number"><span class="hljs-number">62</span></span> #define GPRS_TX_PIN <span class="hljs-number"><span class="hljs-number">63</span></span> #define MASTER <span class="hljs-string"><span class="hljs-string">"+7yyyxxxxxxx"</span></span> #define MESSAGE <span class="hljs-string"><span class="hljs-string">"Hello"</span></span> #define CHECK_ERROR <span class="hljs-number"><span class="hljs-number">0</span></span> #define CHECK_MARKER <span class="hljs-number"><span class="hljs-number">1</span></span> #define CHECK_OK <span class="hljs-number"><span class="hljs-number">2</span></span> #define NO_CHECK <span class="hljs-number"><span class="hljs-number">3</span></span> #define MARKER_OK <span class="hljs-string"><span class="hljs-string">"OK"</span></span> #define MARKER_NO_CHECK <span class="hljs-string"><span class="hljs-string">"-"</span></span> <span class="hljs-comment"><span class="hljs-comment">// GPRS commands #define DATA_TEMP1 "temp1" #define DATA_CONT1 "cont1" #define DATA_LEAK1 "leak1" #define DATA_SMOKE1 "smoke1" #define DATA_ALL "all" #define DATA_RELAY1 "relay1" #define DATA_SERVO1 "servo1" #define DATA_PERIOD "period" #define CMD_RELAY1 "relay1=" #define CMD_SERVO1 "servo1=" #define CMD_PERIOD "period=" byte gprsPeriod = 24; SoftwareSerial GPRS(GPRS_RX_PIN, GPRS_TX_PIN); #define MAX_SOFT_SERIAL 128 char bufferGprs[MAX_SOFT_SERIAL]; int curBuf = 0; #define MESSAGE_LENGTH 20 char message[MESSAGE_LENGTH]; char phone[16]; char datetime[24]; void gprsInit() { initStart("GPRS", true); GPRS.begin(9600); gprsOnOff(); gprsStart(); sendGprs("AT+CFUN=1", "OK"); sendGprs("AT+CNMI=2,1", "OK"); sendGprs("AT+CMGF=1", "OK"); sendGprs("AT+CLIP=1", "OK"); modulGprs = MODUL_ENABLE; initDone(true); } void clearBufferGprs() { for (int i = 0; i &lt; curBuf; i++) { bufferGprs[i] = 0; } } void gprsStart() { while (ALWAYS) { delay(1000); curBuf = 0; GPRS.println("AT"); if (GPRS.available() &gt; 0) { while (GPRS.available() &gt; 0) { bufferGprs[curBuf++] = GPRS.read(); } bufferGprs[curBuf] = '\0'; if (strcmp(bufferGprs, "AT\r\n\r\nOK\r\n") == 0) { timeStamp(); Serial.println(" GPRS ON"); break; } else { Serial.print("."); } } clearBufferGprs(); } } // gprsStart() void gprsOnOff() { pinMode(GPRS_ON_PIN, OUTPUT); if (digitalRead(GPRS_STATE_PIN) != HIGH) { digitalWrite(GPRS_ON_PIN, HIGH); delay(3000); } digitalWrite(GPRS_ON_PIN, LOW); } bool clearSoftwareSerial() { if (GPRS.available() &gt; 0) { while (GPRS.available() &gt; 0) { char c = GPRS.read(); } } } #define DELAY_GPRS_COMMAND 2000 byte sendGprs(String command, char marker[]) { unsigned long timer = millis(); bool success = false; clearSoftwareSerial(); clearBufferGprs(); Serial.print(F("Send command: ")); //Serial.println(command); while (ALWAYS) { if (millis() - timer &gt; DELAY_GPRS_COMMAND) { Serial.print(F("Send error: ")); Serial.println(command); //clearBufferGprs(); return CHECK_ERROR; } curBuf = 0; GPRS.println(command); delay(280); if (GPRS.available() &gt; 0) { while (GPRS.available() &gt; 0) { char c = GPRS.read(); if (curBuf &gt; MAX_SOFT_SERIAL - 2) {break;} bufferGprs[curBuf++] = c; Serial.print(c); } Serial.println(); bufferGprs[curBuf] = '\0'; if (marker == MARKER_NO_CHECK) { Serial.print(F("Send no check, ")); Serial.println(millis() - timer); return NO_CHECK; } else if (StrContains(bufferGprs, marker)) { Serial.print(F("Send success, ")); Serial.println(millis() - timer); return CHECK_MARKER; } else if (StrContains(bufferGprs, MARKER_OK)) { Serial.print(F("Send success, ")); Serial.println(millis() - timer); return CHECK_OK; } else { Serial.println("."); } } // if (GPRS.available() &gt; 0) delay(500); } // while (ALWAYS) } // sendGprs( ) // +CMGR: "REC READ", "XXXXXXXXXXX", "", "16/10/01,10:00:00+12" // SMS text void parseSms(char *message, char *phone, char *datetime) { int i = 0; int j = 0; while (bufferGprs[i] != '\"') {i++;} i++; while (bufferGprs[i] != '\"') {i++;} i++; while (bufferGprs[i] != '\"') {i++;} i++; while (bufferGprs[i] != '\"') {phone[j++] = bufferGprs[i++];} phone[j] = '\0'; i++; while (bufferGprs[i] != '\"') {i++;} i++; while (bufferGprs[i] != '\"') {i++;} i++; while (bufferGprs[i] != '\"') {i++;} i++; j = 0; while (bufferGprs[i] != '\"') {datetime[j++] = bufferGprs[i++];} datetime[j] = '\0'; i++; while (bufferGprs[i] != '\n') {i++;} i++; j = 0; //Serial.print(F("strlen(bufferGprs): ")); Serial.println(strlen(bufferGprs)); while (i &lt; strlen(bufferGprs) - 1) { if (j &gt; MESSAGE_LENGTH - 1) {break;} if ((byte)bufferGprs[i] == 13) {break;} message[j++] = bufferGprs[i++]; } Serial.print(F("strlen(message1): ")); Serial.println(strlen(message)); message[j] = '\0'; Serial.print(F("strlen(message2): ")); Serial.println(strlen(message)); for (int z = 0; z &lt; strlen(message); z++) { Serial.print((byte)message[z]); Serial.print(F(" ")); } Serial.println(); } void deleteSms() { if (sendGprs("AT+CMGDA=\"DEL ALL\"", "OK")) { Serial.println(F("All SMS deleted")); } else { Serial.println(F("Error delete all SMS")); } } String stringSens(byte v) { String s = ""; switch (v) { case 0: s = (F("OFF")); break; case 1: s = (F("ON")); break; default: s = (F("?")); } return s; } String stringLeak(byte v) { String s = ""; switch (v) { case 0: s = (F("LEAK!")); break; case 1: s = (F("OK")); break; default: s = (F("?")); } return s; } String stringSmoke(byte v) { String s = ""; switch (v) { case 0: s = (F("OK")); break; case 1: s = (F("SMOKE!")); break; default: s = (F("?")); } return s; } String mkTemp1() {String s = DATA_TEMP1; s += '='; s += String(lpTempTemp); s += '\n'; return s;} String mkCont1() {String s = DATA_CONT1; s += '='; s += stringSens(lpContCont1); s += '\n'; return s;} String mkLeak1() {String s = DATA_LEAK1; s += '='; s += stringLeak(lpLeakLeak1); s += '\n'; return s;} String mkSmoke1() {String s = DATA_SMOKE1; s += '='; s += stringSmoke(smokeSmoke); s += '\n'; return s;} String mkRelay1() {String s = DATA_RELAY1; s += '='; s += stringSens(relayRelay); s += '\n'; return s;} String mkServo1() {String s = DATA_SERVO1; s += '='; s += stringSens(servoState); s += '\n'; return s;} String mkPeriod() {String s = DATA_PERIOD; s += '='; s += String(gprsPeriod); s += '\n'; return s;} String mkAll() { String s = ""; s += mkTemp1(); s += mkCont1(); s += mkLeak1(); s += mkSmoke1(); s += mkRelay1(); s += mkServo1(); s += mkPeriod(); return s; } void gprsSetRelay(byte v) { switch (v) { case 0: if (relayRelay) { relayRelay = STATE_OFF; } break; case 1: if (!relayRelay) { relayRelay = STATE_ON; } break; } } void gprsSetServo(byte v) { switch (v) { case 0: servoState = STATE_OFF; break; case 1: servoState = STATE_ON; break; } } void gprsAnswer() { String s = ""; String mess = String(message); String data = ""; if (mess == DATA_TEMP1) {s += mkTemp1();} else if (mess == DATA_CONT1) {s += mkCont1();} else if (mess == DATA_LEAK1) {s += mkLeak1();} else if (mess == DATA_SMOKE1) {s += mkSmoke1();} else if (mess == DATA_RELAY1) {s += mkRelay1();} else if (mess == DATA_SERVO1) {s += mkServo1();} else if (mess == DATA_PERIOD) {s += mkPeriod();} else if (mess == DATA_ALL) {s += mkAll();} else if (mess.indexOf(F("=")) &gt;= 0) { byte p = mess.indexOf(F("=")); if (mess.indexOf(CMD_RELAY1) &gt;= 0) {data = mess.substring(p + 1); gprsSetRelay(data.toInt()); s += DATA_RELAY1; s += '='; s += stringSens(relayRelay);} else if (mess.indexOf(CMD_SERVO1) &gt;= 0) {data = mess.substring(p + 1); gprsSetServo(data.toInt()); s += DATA_SERVO1; s += '='; s += stringSens(servoState);} else if (mess.indexOf(CMD_PERIOD) &gt;= 0) {data = mess.substring(p + 1); gprsPeriod = data.toInt(); s += DATA_PERIOD; s += '='; s += String(gprsPeriod);} } else { Serial.println(F("Not command!")); } //Serial.print(F("mess: ")); Serial.println(mess); //Serial.print(F("answ: ")); Serial.println(s); if (s == "") {s = "Error";} Serial.println(F("Send answer... ")); if (sendSms(MASTER, s)) { Serial.println(F("success")); } else { Serial.println(F("error")); } } void readSms() { byte result = sendGprs("AT+CMGR=1,1", "+CMGR:"); if (result == CHECK_MARKER) { parseSms(message, phone, datetime); Serial.print(F("Number: ")); Serial.println(phone); Serial.print(F("Datetime: ")); Serial.println(datetime); Serial.print(F("Message: ")); Serial.println(message); deleteSms(); if (String(phone) == String(MASTER)) { Serial.println(F("Message from MASTER!")); gprsAnswer(); } } else if (result == CHECK_OK) { Serial.println(F("No SMS")); } else { Serial.println(F("Error read SMS")); } } bool sendSms(char *number, String data) { String numstr = "AT+CMGS=\"" + String(number) + "\""; String messtr = data + String((char)26); if (sendGprs(numstr, "&gt;")) { if (sendGprs(messtr, MARKER_NO_CHECK)) { return true; } } return false; } void sendPeriod() { Serial.println(F("Send period SMS... ")); if (sendSms(MASTER, mkAll())) { Serial.println(F("success")); } else { Serial.println(F("error")); } } void gprsWorks() { if (cycle20s) { readSms(); } switch (gprsPeriod) { case 1: if (cycle1h) {sendPeriod();} break; case 6: if (cycle6h) {sendPeriod();} break; case 12: if (cycle12h) {sendPeriod();} break; default: if (cycle24h) {sendPeriod();} break; } } #endif // GPRS_FEATURE</span></span></code> </pre> <br></div></div><br> 该模块是在Arduino Mega的AMS版本0.16上开发和测试的。 测试表明，在此模块的控制下，GPRS Shield的运行绝对稳定可靠。 <br><br><h2> 连接到AMS GPRS Shield支持模块 </h2><br> 为了将GPRS Shield模块连接到Arduino Mega Server，您需要执行一些简单的步骤。 首先，将以下行添加到AMS主文件中 <br><br><pre> <code class="java hljs">#define GPRS_FEATURE</code> </pre><br> 和 <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">byte</span></span> modulGprs = MODUL_NOT_COMPILLED;</code> </pre><br> 在适当的部分。 在那里，您需要添加测试变量，该变量在您的实际项目中将负责受控参数（温度，接触状态等）。 <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">float</span></span> lpTempTemp; <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span> lpContCont1; <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span> lpLeakLeak1; <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span> smokeSmoke; <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span> relayRelay; <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span> servoState;</code> </pre><br><h2> 支持功能的说明 </h2><br> 该模块包含一组基本的查询和命令，但是您可以将这些命令替换为其他命令和/或扩展所需的基本命令和查询。 <br><br><h3> 咨询处 </h3><br> 通过SMS发送请求，系统（也通过SMS）发送包含有关所请求参数信息的响应。 非常简单：我们从电话发送请求“ temp1”，系统作为响应发送当前温度值<code>temp1=20.50</code> 。 <br><br><blockquote>  <strong>temp1-</strong>温度要求 <br>  <strong>cont1-</strong>请求联系状态 <br> 泄漏<strong>1-</strong>请求泄漏传感器的状态 <br>  <strong>smoke1-</strong>查询烟雾探测器状态 <br>  <strong>relay1-</strong>请求<strong>继电器</strong>的状态（键） <br> 伺服<strong>1-</strong>请求伺服进<strong>纸</strong>器的状态 <br>  <strong>period-</strong>请求自动遥测软件包的期限 <br>  <strong>全部</strong> -请求所有系统参数 </blockquote><br> 响应“ all”请求，系统发送所有参数的列表。 在发送未注册命令的情况下，系统将发送“错误”响应。 如果监视的参数超出正常范围，则系统本身可以向操作员的智能手机发送警报消息。 <br><br> 为了仅由注册操作员来管理系统，该系统具有防止未授权访问的保护-它仅响应来自特定电话号码的命令。 <br><br><h3> 队伍 </h3><br> 通过SMS发送命令，接受命令后，系统会更改其状态并发送包含有关其执行器或设置的新状态信息的响应。 <br><br><blockquote>  <strong>relay1 =</strong> -继电器控制命令（键） <br>  <strong>伺服1 =</strong> -馈线控制命令 <br>  <strong>period =</strong> -更改遥测自动发送周期的命令 </blockquote><br> 一个例子。 命令<code>relay1=1</code> ，响应<code>relay1=ON</code> 。 命令<code>relay1=0</code> ，响应<code>relay1=OFF</code> 。 <br><br><h2> 代码说明 </h2><br>  GPRS模块初始化。  AMS模块的标准初始化，SoftwareSerial的启动以及GSM AT命令的魔力。 该模块的目的是使GPRS模块栩栩如生，并从涅rv中退回它，前提是此时由于某种原因我们已经离开了它。 <br><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">gprsInit</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ initStart(<span class="hljs-string"><span class="hljs-string">"GPRS"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); GPRS.begin(<span class="hljs-number"><span class="hljs-number">9600</span></span>); gprsOnOff(); gprsStart(); sendGprs(<span class="hljs-string"><span class="hljs-string">"AT+CFUN=1"</span></span>, <span class="hljs-string"><span class="hljs-string">"OK"</span></span>); sendGprs(<span class="hljs-string"><span class="hljs-string">"AT+CNMI=2,1"</span></span>, <span class="hljs-string"><span class="hljs-string">"OK"</span></span>); sendGprs(<span class="hljs-string"><span class="hljs-string">"AT+CMGF=1"</span></span>, <span class="hljs-string"><span class="hljs-string">"OK"</span></span>); sendGprs(<span class="hljs-string"><span class="hljs-string">"AT+CLIP=1"</span></span>, <span class="hljs-string"><span class="hljs-string">"OK"</span></span>); modulGprs = MODUL_ENABLE; initDone(<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); }</code> </pre><br> 模块的主要工作功能。 每隔20秒，Arduino Mega Server就会检查传入的SMS，并在有任何请求或命令的情况下执行它们。 结果，命令执行的平均延迟为10秒（不包括电信运营商发送SMS消息的延迟）。 可以配置此间隔，选择20秒作为对SMS命令的响应速度和系统引导之间的折衷。 <br><br> 在这20秒内，AMS可以做任何需要的事情，并且在这段时间内到达的SMS不会丢失。 使用标准库时，系统只能等待SMS到达，否则将什么也不会做（否则控制器将无法执行任何操作）。 <br><br> 还有一个遥测发送代码，其指定时间间隔为1小时，6小时，12小时或24小时。 可以通过SMS发送适当的命令来更改此间隔。 <br><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">gprsWorks</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (cycle20s) { readSms(); } <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> (gprsPeriod) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (cycle1h) {sendPeriod();} <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-number"><span class="hljs-number">6</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (cycle6h) {sendPeriod();} <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-number"><span class="hljs-number">12</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (cycle12h) {sendPeriod();} <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">default</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (cycle24h) {sendPeriod();} <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } }</code> </pre><br>  GPRS模块和控制器之间的交互是通过特殊的AT命令执行的，以下功能以易于理解的代码形式形成了GPRS模块命令。 <br><br> 短信发送功能。 在功能的参数中，目标电话号码和命令或请求以文本形式传输。 <br><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-function">bool </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sendSms</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *number, String data)</span></span></span><span class="hljs-function"> </span></span>{ String numstr = <span class="hljs-string"><span class="hljs-string">"AT+CMGS=\""</span></span> + String(number) + <span class="hljs-string"><span class="hljs-string">"\""</span></span>; String messtr = data + String((<span class="hljs-keyword"><span class="hljs-keyword">char</span></span>)<span class="hljs-number"><span class="hljs-number">26</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (sendGprs(numstr, <span class="hljs-string"><span class="hljs-string">"&gt;"</span></span>)) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (sendGprs(messtr, MARKER_NO_CHECK)) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; }</code> </pre><br> 短信阅读功能。 接受的值放在变量message，phone和datetime中，它们分别包含接收的命令，电话号码和发送时间。 <br><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">readSms</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span> result = sendGprs(<span class="hljs-string"><span class="hljs-string">"AT+CMGR=1,1"</span></span>, <span class="hljs-string"><span class="hljs-string">"+CMGR:"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (result == CHECK_MARKER) { parseSms(message, phone, datetime); Serial.print(F(<span class="hljs-string"><span class="hljs-string">"Number: "</span></span>)); Serial.println(phone); Serial.print(F(<span class="hljs-string"><span class="hljs-string">"Datetime: "</span></span>)); Serial.println(datetime); Serial.print(F(<span class="hljs-string"><span class="hljs-string">"Message: "</span></span>)); Serial.println(message); deleteSms(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (String(phone) == String(MASTER)) { Serial.println(F(<span class="hljs-string"><span class="hljs-string">"Message from MASTER!"</span></span>)); gprsAnswer(); } } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (result == CHECK_OK) { Serial.println(F(<span class="hljs-string"><span class="hljs-string">"No SMS"</span></span>)); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { Serial.println(F(<span class="hljs-string"><span class="hljs-string">"Error read SMS"</span></span>)); } }</code> </pre><br> 形成对SMS请求和命令的响应的功能。 此功能特定于每个项目，您可以根据系统逻辑在项目中对其进行更改。 <br><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">gprsAnswer</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ String s = <span class="hljs-string"><span class="hljs-string">""</span></span>; String mess = String(message); String data = <span class="hljs-string"><span class="hljs-string">""</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (mess == DATA_TEMP1) {s += mkTemp1();} <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (mess == DATA_CONT1) {s += mkCont1();} <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (mess == DATA_LEAK1) {s += mkLeak1();} <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (mess == DATA_SMOKE1) {s += mkSmoke1();} <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (mess == DATA_RELAY1) {s += mkRelay1();} <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (mess == DATA_SERVO1) {s += mkServo1();} <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (mess == DATA_PERIOD) {s += mkPeriod();} <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (mess == DATA_ALL) {s += mkAll();} <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (mess.indexOf(F(<span class="hljs-string"><span class="hljs-string">"="</span></span>)) &gt;= <span class="hljs-number"><span class="hljs-number">0</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span> p = mess.indexOf(F(<span class="hljs-string"><span class="hljs-string">"="</span></span>)); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (mess.indexOf(CMD_RELAY1) &gt;= <span class="hljs-number"><span class="hljs-number">0</span></span>) {data = mess.substring(p + <span class="hljs-number"><span class="hljs-number">1</span></span>); gprsSetRelay(data.toInt()); s += DATA_RELAY1; s += <span class="hljs-string"><span class="hljs-string">'='</span></span>; s += stringSens(relayRelay);} <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (mess.indexOf(CMD_SERVO1) &gt;= <span class="hljs-number"><span class="hljs-number">0</span></span>) {data = mess.substring(p + <span class="hljs-number"><span class="hljs-number">1</span></span>); gprsSetServo(data.toInt()); s += DATA_SERVO1; s += <span class="hljs-string"><span class="hljs-string">'='</span></span>; s += stringSens(servoState);} <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (mess.indexOf(CMD_PERIOD) &gt;= <span class="hljs-number"><span class="hljs-number">0</span></span>) {data = mess.substring(p + <span class="hljs-number"><span class="hljs-number">1</span></span>); gprsPeriod = data.toInt(); s += DATA_PERIOD; s += <span class="hljs-string"><span class="hljs-string">'='</span></span>; s += String(gprsPeriod);} } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { Serial.println(F(<span class="hljs-string"><span class="hljs-string">"Not command!"</span></span>)); } <span class="hljs-comment"><span class="hljs-comment">//Serial.print(F("mess: ")); Serial.println(mess); //Serial.print(F("answ: ")); Serial.println(s); if (s == "") {s = "Error";} Serial.println(F("Send answer... ")); if (sendSms(MASTER, s)) { Serial.println(F("success")); } else { Serial.println(F("error")); } }</span></span></code> </pre><br> 形成答案的功能。 这些功能构成了系统根据所制定的程序，通过SMS响应用户的请求或自行决定，通过SMS发送到用户的智能手机的响应。 <br><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-function">String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">stringSens</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">byte</span></span></span></span><span class="hljs-function"><span class="hljs-params"> v)</span></span></span><span class="hljs-function"> String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">stringLeak</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">byte</span></span></span></span><span class="hljs-function"><span class="hljs-params"> v)</span></span></span><span class="hljs-function"> String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">stringSmoke</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">byte</span></span></span></span><span class="hljs-function"><span class="hljs-params"> v)</span></span></span><span class="hljs-function"> String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">mkTemp1</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">mkCont1</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">mkLeak1</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">mkSmoke1</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">mkRelay1</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">mkServo1</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">mkPeriod</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">mkAll</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span></code> </pre><br> 以及命令执行的功能。 这些是由SMS命令执行的功能，它们可以更改系统的状态，即更改其设置或启用或禁用执行器。 <br><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">gprsSetRelay</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">byte</span></span></span></span><span class="hljs-function"><span class="hljs-params"> v)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">gprsSetServo</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">byte</span></span></span></span><span class="hljs-function"><span class="hljs-params"> v)</span></span></span></span></code> </pre><br> 其余功能纯属技术，可以完成GPRS Shield与微控制器之间交互的所有粗略工作。 <br><br><h2> 有关SoftwareSerial的更多信息 </h2><br> 以上所有内容不足以使GPRS Shield透明模式下工作并停止阻止微控制器上运行的其他进程。 还需要修改SoftwareSerial库的代码。 事实是，其标准的64字节缓冲区不足以消化大多数AT GSM命令并维持模块与控制器之间的动态交互。 <br><br> 您需要将该缓冲区增加到至少128个字节，只有在此之后魔术才会起作用，并且GPRS Shield将在透明模式下开始正常工作。 这是在<code>SoftwareSerial.h</code>文件中完成的。 线 <br><br><pre> <code class="java hljs">#define _SS_MAX_RX_BUFF <span class="hljs-number"><span class="hljs-number">64</span></span> <span class="hljs-comment"><span class="hljs-comment">// RX buffer size</span></span></code> </pre><br> 需要更改为 <br><br><pre> <code class="java hljs">#define _SS_MAX_RX_BUFF <span class="hljs-number"><span class="hljs-number">128</span></span> <span class="hljs-comment"><span class="hljs-comment">// RX buffer size</span></span></code> </pre><br><h2> 结论 </h2><br> 您会在智能手机屏幕上看到操作员命令和系统响应的交换。 并且，系统以伪多任务处理模式执行数十个过程。  GPRS Shield开始占用不到1％的处理器时间，而不是以前的99％，从而为Web服务器和管理鸡舍的其他任务腾出了其余时间。 <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/2e1/615/a08/2e1615a08e2a4a29802805066509d3e4.png" alt="图片"></div><br> 就是这样，我们将GPRS Shield Shield集成到<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">AMS中</a> ，克服了所有障碍，使其以透明模式工作，而不会阻止其他进程（例如Web服务器，无线传感器和执行器的运行），这为构建具有GSM SMS控制功能的大量系统打开了诱人的前景。基于AMS的控制-温室，安全和供暖系统，智能家居的各种选项等，几乎是无限的。 </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN401721/">https://habr.com/ru/post/zh-CN401721/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN401709/index.html">林实业不死心</a></li>
<li><a href="../zh-CN401711/index.html">气门训练AI检测CS中的作弊者：GO</a></li>
<li><a href="../zh-CN401713/index.html">在飞机上无聊时该怎么办-在椅子背面运行Google Chrome</a></li>
<li><a href="../zh-CN401715/index.html">Robert Winglee（美国宇航局）的太空钓鱼</a></li>
<li><a href="../zh-CN401719/index.html">Cyclone 10-英特尔品牌的FPGA</a></li>
<li><a href="../zh-CN401723/index.html">旧计算机设备的艺术品翻新</a></li>
<li><a href="../zh-CN401725/index.html">植入技术的历史。 假牙</a></li>
<li><a href="../zh-CN401727/index.html">选择2月23日的极客礼物：Madrobots指南</a></li>
<li><a href="../zh-CN401729/index.html">我们周围有用的（危险的）“噪音”</a></li>
<li><a href="../zh-CN401735/index.html">学习PartyFon Max移动震动扬声器的内部知识</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>