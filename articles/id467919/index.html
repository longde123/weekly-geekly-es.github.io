<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üö¥üèΩ üôåüèæ üè¥Û†ÅßÛ†Å¢Û†Å•Û†ÅÆÛ†ÅßÛ†Åø Masalah pemrosesan batch permintaan dan solusinya (bagian 2) üåø ü§∏üèª ‚úñÔ∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Ini adalah kelanjutan dari artikel "Masalah pemrosesan batch permintaan dan solusinya . " Disarankan agar Anda membiasakan diri dengan bagian pertama,...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Masalah pemrosesan batch permintaan dan solusinya (bagian 2)</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/custis/blog/467919/"><img src="https://habrastorage.org/webt/ad/_6/oe/ad_6oeq50j8z5q33t5ixjrcssqs.jpeg"><br>  Ini adalah kelanjutan dari artikel <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">"Masalah pemrosesan batch permintaan dan solusinya</a> . <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">"</a>  Disarankan agar Anda membiasakan diri dengan bagian pertama, karena ini menjelaskan secara rinci esensi masalah dan beberapa pendekatan untuk solusinya.  Di sini kita melihat metode lain. <br><a name="habracut"></a><br><div class="spoiler">  <b class="spoiler_title">Isi</b> <div class="spoiler_text">  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Pengulangan tugas yang singkat</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Tingkatkan paket</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Rekayasa terbalik</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Kumpulkan semua permintaan</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Paralelisme</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Masalahnya</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Kesimpulan</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Heuristik bisnis</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Memecahkan masalah kontrak</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Cari batasan yang bermanfaat</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Kesalahan Heuristik</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Kesimpulan</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Unit bergaya DDD</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Logika kueri yang meningkat di dalam agregat</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Logika untuk mengumpulkan kueri di luar agregat</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Kesimpulan</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Proxy dan panggilan ganda</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Memecahkan masalah kontrak</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Kesimpulan</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Kesimpulan</a> </div></div><br><a name="Revision"></a><h2>  Rekap tugas singkat </h2><br>  Ada obrolan untuk mengoordinasikan dokumen dengan seperangkat peserta yang telah ditentukan.  Pesan berisi teks dan file.  Dan, seperti dalam obrolan biasa, pesan dapat berupa balasan dan penerusan. <br><br><div class="spoiler">  <b class="spoiler_title">Model Pesan Obrolan</b> <div class="spoiler_text"><code><font color="7f0055"><b>data class</b></font> <font color="3e7eff"><b>ChatMessage</b></font> <font color="000066">(</font> <br> <font color="3f7f5f">// nullable      persist</font> <br> <font color="7f0055"><b>val</b></font> <font color="566874">id</font> : <font color="3e7eff"><b>Long</b></font> ? <font color="333333">=</font> <font color="7f0055"><b>null</b></font> <font color="333333">,</font> <br> <font color="395da1">/**    */</font> <br> <font color="7f0055"><b>val</b></font> <font color="566874">author</font> : <font color="3e7eff"><b>UserReference</b></font> <font color="333333">,</font> <br> <font color="395da1">/**  */</font> <br> <font color="7f0055"><b>val</b></font> <font color="566874">message</font> : <font color="3e7eff"><b>String</b></font> <font color="333333">,</font> <br> <font color="395da1">/**    */</font> <br> <font color="3f7f5f">// -   JPA+    null,   </font> <br> <font color="7f0055"><b>val</b></font> <font color="566874">files</font> : <font color="3e7eff"><b>List</b></font> <font color="333333">&lt;</font> <font color="3e7eff"><b>FileReference</b></font> <font color="333333">&gt;</font> ? <font color="333333">=</font> <font color="7f0055"><b>null</b></font> <font color="333333">,</font> <br> <font color="395da1">/**   ,     */</font> <br> <font color="7f0055"><b>val</b></font> <font color="566874">replyTo</font> : <font color="3e7eff"><b>ChatMessage</b></font> ? <font color="333333">=</font> <font color="7f0055"><b>null</b></font> <font color="333333">,</font> <br> <font color="395da1">/**   ,     */</font> <br> <font color="7f0055"><b>val</b></font> <font color="566874">forwardFrom</font> : <font color="3e7eff"><b>ChatMessage</b></font> ? <font color="333333">=</font> <font color="7f0055"><b>null</b></font> <br> <font color="000066">)</font></code> </div> </div><br><div class="spoiler">  <b class="spoiler_title">Melalui Injeksi Ketergantungan, kami dapat menerapkan layanan eksternal berikut:</b> <div class="spoiler_text"> <code><font color="7f0055"><b>interface</b></font> <font color="3e7eff"><b>ChatMessageRepository</b></font> <font color="000066">{</font> <br> <font color="7f0055"><b>fun</b></font> <font color="170591"><b>findLast</b></font> <font color="000066">(</font> <font color="000066"><i>n</i></font> : <font color="3e7eff"><b>Int</b></font> <font color="000066">)</font> : <font color="3e7eff"><b>List</b></font> <font color="333333">&lt;</font> <font color="3e7eff"><b>ChatMessage</b></font> <font color="333333">&gt;</font> <br> <font color="000066">}</font> <br> <br> <font color="7f0055"><b>data class</b></font> <font color="3e7eff"><b>FileHeadRemote</b></font> <font color="000066">(</font> <br> <font color="7f0055"><b>val</b></font> <font color="566874">id</font> : <font color="3e7eff"><b>FileReference</b></font> <font color="333333">,</font> <br> <font color="7f0055"><b>val</b></font> <font color="566874">name</font> : <font color="3e7eff"><b>String</b></font> <br> <font color="000066">)</font> <br> <br> <font color="7f0055"><b>interface</b></font> <font color="3e7eff"><b>FileRemoteApi</b></font> <font color="000066">{</font> <br> <font color="7f0055"><b>fun</b></font> <font color="170591"><b>getHeadById</b></font> <font color="000066">(</font> <font color="000066"><i>id</i></font> : <font color="3e7eff"><b>FileReference</b></font> <font color="000066">)</font> : <font color="3e7eff"><b>FileHeadRemote</b></font> <br> <font color="3e7eff"><b>&nbsp;&nbsp;</b></font> <font color="7f0055"><b>fun</b></font> <font color="170591"><b>getHeadsByIds</b></font> <font color="000066">(</font> <font color="000066"><i>id</i></font> : <font color="3e7eff"><b>Set</b></font> <font color="333333">&lt;</font> <font color="3e7eff"><b>FileReference</b></font> <font color="333333">&gt;</font> <font color="000066">)</font> : <font color="3e7eff"><b>Set</b></font> <font color="333333">&lt;</font> <font color="3e7eff"><b>FileHeadRemote</b></font> <font color="333333">&gt;</font> <br> <font color="7f0055"><b>fun</b></font> <font color="170591"><b>getHeadsByIds</b></font> <font color="000066">(</font> <font color="000066"><i>id</i></font> : <font color="3e7eff"><b>List</b></font> <font color="333333">&lt;</font> <font color="3e7eff"><b>FileReference</b></font> <font color="333333">&gt;</font> <font color="000066">)</font> : <font color="3e7eff"><b>List</b></font> <font color="333333">&lt;</font> <font color="3e7eff"><b>FileHeadRemote</b></font> <font color="333333">&gt;</font> <br> <font color="000066">}</font> <br> <br> <font color="7f0055"><b>data class</b></font> <font color="3e7eff"><b>UserRemote</b></font> <font color="000066">(</font> <br> <font color="7f0055"><b>val</b></font> <font color="566874">id</font> : <font color="3e7eff"><b>UserReference</b></font> <font color="333333">,</font> <br> <font color="7f0055"><b>val</b></font> <font color="566874">name</font> : <font color="3e7eff"><b>String</b></font> <br> <font color="000066">)</font> <br> <br> <font color="7f0055"><b>interface</b></font> <font color="3e7eff"><b>UserRemoteApi</b></font> <font color="000066">{</font> <br> <font color="7f0055"><b>fun</b></font> <font color="170591"><b>getUserById</b></font> <font color="000066">(</font> <font color="000066"><i>id</i></font> : <font color="3e7eff"><b>UserReference</b></font> <font color="000066">)</font> : <font color="3e7eff"><b>UserRemote</b></font> <br> <font color="3e7eff"><b>&nbsp;&nbsp;</b></font> <font color="7f0055"><b>fun</b></font> <font color="170591"><b>getUsersByIds</b></font> <font color="000066">(</font> <font color="000066"><i>id</i></font> : <font color="3e7eff"><b>Set</b></font> <font color="333333">&lt;</font> <font color="3e7eff"><b>UserReference</b></font> <font color="333333">&gt;</font> <font color="000066">)</font> : <font color="3e7eff"><b>Set</b></font> <font color="333333">&lt;</font> <font color="3e7eff"><b>UserRemote</b></font> <font color="333333">&gt;</font> <br> <font color="7f0055"><b>fun</b></font> <font color="170591"><b>getUsersByIds</b></font> <font color="000066">(</font> <font color="000066"><i>id</i></font> : <font color="3e7eff"><b>List</b></font> <font color="333333">&lt;</font> <font color="3e7eff"><b>UserReference</b></font> <font color="333333">&gt;</font> <font color="000066">)</font> : <font color="3e7eff"><b>List</b></font> <font color="333333">&lt;</font> <font color="3e7eff"><b>UserRemote</b></font> <font color="333333">&gt;</font> <br> <font color="000066">}</font></code> </div> </div><br>  Kita perlu mengimplementasikan kontroler REST: <br><br> <code><font color="7f0055"><b>interface</b></font> <font color="3e7eff"><b>ChatRestApi</b></font> <font color="000066">{</font> <br> <font color="7f0055"><b>fun</b></font> <font color="170591"><b>getLast</b></font> <font color="000066">(</font> <font color="000066"><i>n</i></font> : <font color="3e7eff"><b>Int</b></font> <font color="000066">)</font> : <font color="3e7eff"><b>List</b></font> <font color="333333">&lt;</font> <font color="3e7eff"><b>ChatMessageUI</b></font> <font color="333333">&gt;</font> <br> <font color="000066">}</font></code> <br> <br><div class="spoiler">  <b class="spoiler_title">Dimana:</b> <div class="spoiler_text"> <code><font color="395da1">/**          */</font> <br> <font color="7f0055"><b>data class</b></font> <font color="3e7eff"><b>ReferenceUI</b></font> <font color="000066">(</font> <br> <font color="395da1">/**   url */</font> <br> <font color="7f0055"><b>val</b></font> <font color="566874">ref</font> : <font color="3e7eff"><b>String</b></font> <font color="333333">,</font> <br> <font color="395da1">/**     */</font> <br> <font color="7f0055"><b>val</b></font> <font color="566874">name</font> : <font color="3e7eff"><b>String</b></font> <br> <font color="000066">)</font> <br> <br> <font color="7f0055"><b>data class</b></font> <font color="3e7eff"><b>ChatMessageUI</b></font> <font color="000066">(</font> <br> <font color="7f0055"><b>val</b></font> <font color="566874">id</font> : <font color="3e7eff"><b>Long</b></font> <font color="333333">,</font> <br> <font color="395da1">/**    */</font> <br> <font color="7f0055"><b>val</b></font> <font color="566874">author</font> : <font color="3e7eff"><b>ReferenceUI</b></font> <font color="333333">,</font> <br> <font color="395da1">/**  */</font> <br> <font color="7f0055"><b>val</b></font> <font color="566874">message</font> : <font color="3e7eff"><b>String</b></font> <font color="333333">,</font> <br> <font color="395da1">/**    */</font> <br> <font color="7f0055"><b>val</b></font> <font color="566874">files</font> : <font color="3e7eff"><b>List</b></font> <font color="333333">&lt;</font> <font color="3e7eff"><b>ReferenceUI</b></font> <font color="333333">&gt;,</font> <br> <font color="395da1">/**   ,     */</font> <br> <font color="7f0055"><b>val</b></font> <font color="566874">replyTo</font> : <font color="3e7eff"><b>ChatMessageUI</b></font> ? <font color="333333">=</font> <font color="7f0055"><b>null</b></font> <font color="333333">,</font> <br> <font color="395da1">/**   ,     */</font> <br> <font color="7f0055"><b>val</b></font> <font color="566874">forwardFrom</font> : <font color="3e7eff"><b>ChatMessageUI</b></font> ? <font color="333333">=</font> <font color="7f0055"><b>null</b></font> <br> <font color="000066">)</font> <br></code> </div></div><br>  Pada bagian sebelumnya, kami melihat implementasi naif dari layanan menggunakan pemrosesan batch dan beberapa cara untuk mempercepatnya.  Metode ini sangat sederhana, tetapi penerapannya tidak memberikan kinerja yang cukup baik. <br><br><a name="Enlargement"></a><h2>  Tingkatkan paket </h2><br>  Masalah utama dari solusi naif adalah ukuran kecil dari paket. <br><br>  Untuk mengelompokkan panggilan ke dalam paket yang lebih besar, Anda perlu mengakumulasi permintaan.  Baris ini tidak menyiratkan akumulasi permintaan: <br><br> <code><font color="4a86e8">author =</font> <font color="566874">userRepository</font> <font color="333333">.</font> <font color="170591">getUserById</font> <font color="000066">(</font> <font color="566874">author</font> <font color="000066">)</font> <font color="333333">.</font> <i><b>toFrontReference</b></i> <font color="000066">()</font> <font color="333333">,</font></code> <br> <br>  Sekarang di runtime kami tidak ada tempat khusus untuk menyimpan daftar pengguna - itu sedang dibentuk secara bertahap.  Ini harus diubah. <br><br>  Pertama, Anda perlu memisahkan logika akuisisi data dari pemetaan dalam metode ChatMessage.toFrontModel: <br><br> <code><font color="7f0055"><b>private fun</b></font> <font color="3e7eff"><b>ChatMessage</b></font> <font color="333333">.</font> <font color="170591"><b>toFrontModel</b></font> <font color="000066">(</font> <br> <font color="000066"><i>getUser</i></font> : <font color="000066">(</font> <font color="3e7eff"><b>UserReference</b></font> <font color="000066">) -&gt;</font> <font color="3e7eff"><b>UserRemote</b></font> <font color="333333">,</font> <br> <font color="000066"><i>getFile</i></font> : <font color="000066">(</font> <font color="3e7eff"><b>FileReference</b></font> <font color="000066">) -&gt;</font> <font color="3e7eff"><b>FileHeadRemote</b></font> <font color="333333">,</font> <br> <font color="000066"><i>serializeMessage</i></font> : <font color="000066">(</font> <font color="3e7eff"><b>ChatMessage</b></font> <font color="000066">) -&gt;</font> <font color="3e7eff"><b>ChatMessageUI</b></font> <br> <font color="000066">)</font> : <font color="3e7eff"><b>ChatMessageUI</b></font> <font color="333333">=</font> <br> <font color="170591">ChatMessageUI</font> <font color="000066">(</font> <br> <font color="4a86e8">id =</font> <font color="566874">id</font> ?: <font color="7f0055"><b>throw</b></font> <font color="170591">IllegalStateException</font> <font color="000066">(</font> <b>"</b> <font color="333333"><b>$</b></font> <font color="7f0055"><b>this</b></font> <b>must be persisted"</b> <font color="000066">)</font> <font color="333333">,</font> <br> <font color="4a86e8">author =</font> <font color="000066"><i>getUser</i></font> <font color="000066">(</font> <font color="566874">author</font> <font color="000066">)</font> <font color="333333">.</font> <i><b>toFrontReference</b></i> <font color="000066">()</font> <font color="333333">,</font> <br> <font color="4a86e8">message =</font> <font color="566874">message</font> <font color="333333">,</font> <br> <font color="4a86e8">files =</font> <font color="566874">files</font> <font color="333333">?.</font> <i><b>let</b></i> <font color="000066"><b>{</b></font> <br> <font color="000066"><b>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</b></font> <b>it</b> <font color="333333">.</font> <i><b>map</b></i> <font color="000066">(</font> <font color="000066"><i>getFile</i></font> <font color="000066">)</font> <font color="333333">.</font> <i><b>map</b></i> <font color="000066"><b>{</b></font> <font color="000066"><i>it</i></font> <font color="333333">.</font> <i><b>toFrontReference</b></i> <font color="000066">()</font> <font color="000066"><b>}</b></font> <br> <font color="000066"><b>}</b></font> ?: <i><b>listOf</b></i> <font color="000066">()</font> <font color="333333">,</font> <br> <font color="4a86e8">forwardFrom =</font> <font color="566874">forwardFrom</font> <font color="333333">?.</font> <i><b>let</b></i> <font color="000066">(</font> <font color="000066"><i>serializeMessage</i></font> <font color="000066">)</font> <font color="333333">,</font> <br> <font color="4a86e8">replyTo =</font> <font color="566874">replyTo</font> <font color="333333">?.</font> <i><b>let</b></i> <font color="000066">(</font> <font color="000066"><i>serializeMessage</i></font> <font color="000066">)</font> <br> <font color="000066">)</font></code> <br> <br>  Ternyata fungsi ini hanya bergantung pada tiga fungsi eksternal (dan bukan pada seluruh kelas, seperti di awal). <br><br>  Setelah pengerjaan ulang seperti itu, badan fungsi tidak menjadi kurang jelas, dan kontrak menjadi lebih keras (ini memiliki pro dan kontra). <br><br>  Bahkan, Anda tidak dapat melakukan penyempitan kontrak dan meninggalkan ketergantungan pada antarmuka.  Hal utama adalah bahwa tidak ada yang berlebihan di dalamnya, karena kita perlu melakukan implementasi alternatif. <br><br>  Karena fungsi serializeMessage mirip dengan fungsi rekursif, ini dapat dilakukan sebagai rekursi eksplisit pada langkah pertama refactoring: <br><br> <code><font color="7f0055"><b>class</b></font> <font color="3e7eff"><b>ChatRestController</b></font> <font color="000066">(</font> <br> <font color="7f0055"><b>private val</b></font> <font color="566874">messageRepository</font> : <font color="3e7eff"><b>ChatMessageRepository</b></font> <font color="333333">,</font> <br> <font color="7f0055"><b>private val</b></font> <font color="566874">userRepository</font> : <font color="3e7eff"><b>UserRemoteApi</b></font> <font color="333333">,</font> <br> <font color="7f0055"><b>private val</b></font> <font color="566874">fileRepository</font> : <font color="3e7eff"><b>FileRemoteApi</b></font> <br> <font color="000066">)</font> : <font color="3e7eff"><b>ChatRestApi</b></font> <font color="000066">{</font> <br> <font color="7f0055"><b>override fun</b></font> <font color="170591"><b>getLast</b></font> <font color="000066">(</font> <font color="000066"><i>n</i></font> : <font color="3e7eff"><b>Int</b></font> <font color="000066">)</font> <font color="333333">=</font> <br> <font color="566874">messageRepository</font> <font color="333333">.</font> <font color="170591">findLast</font> <font color="000066">(</font> <font color="000066"><i>n</i></font> <font color="000066">)</font> <br> <font color="333333">.</font> <i><b>map</b></i> <font color="000066"><b>{</b></font> <font color="000066"><i>it</i></font> <font color="333333">.</font> <i><b>toFrontModel</b></i> <font color="000066">()</font> <font color="000066"><b>}</b></font></code> <br> <br>  Saya membuat sebuah rintisan untuk metode toFrontModel, yang sejauh ini bekerja persis sama seperti dalam implementasi naif pertama kami (implementasi ketiga fungsi eksternal tetap sama). <br><br> <code><font color="7f0055"><b>private fun</b></font> <font color="3e7eff"><b>ChatMessage</b></font> <font color="333333">.</font> <font color="170591"><b>toFrontModel</b></font> <font color="000066">()</font> : <font color="3e7eff"><b>ChatMessageUI</b></font> <font color="333333">=</font> <br> <i><b>toFrontModel</b></i> <font color="000066">(</font> <br> <font color="4a86e8">getUser =</font> <font color="566874">userRepository</font> ::getUserById <font color="333333">,</font> <br> <font color="4a86e8">getFile =</font> <font color="566874">fileRepository</font> ::getHeadById <font color="333333">,</font> <br> <font color="4a86e8">serializeMessage =</font> <font color="000066"><b>{</b></font> <font color="000066"><i>it</i></font> <font color="333333">.</font> <i><b>toFrontModel</b></i> <font color="000066">()</font> <font color="000066"><b>}</b></font> <br> <font color="000066"><b>&nbsp;&nbsp;</b></font> <font color="000066">)</font></code> <br> <br>  Tetapi kita perlu memastikan bahwa fungsi getUser, getFile dan serializeMessage bekerja secara efisien, yaitu, mereka mengirim permintaan ke layanan yang sesuai dalam paket dengan ukuran yang tepat (secara teoritis, ukuran ini dapat berbeda untuk setiap layanan) atau umumnya satu permintaan per layanan, jika permintaan tidak terbatas diizinkan. <br><br>  Cara termudah untuk mencapai pengelompokan ini adalah jika kami memiliki semua pertanyaan yang diperlukan sebelum memulai pemrosesan.  Untuk melakukan ini, sebelum memanggil toFrontModel, kumpulkan semua tautan yang diperlukan, lakukan pemrosesan batch, dan kemudian gunakan hasilnya. <br><br>  Anda juga dapat mencoba skema dengan akumulasi permintaan dan eksekusi bertahapnya.  Namun, skema semacam itu akan membutuhkan eksekusi asinkron, tetapi untuk saat ini kami akan fokus pada yang sinkron. <br><br>  Jadi, untuk mulai menggunakan pemrosesan batch, dengan satu atau lain cara kita harus mencari tahu di muka sebanyak mungkin permintaan (lebih disukai semua) yang harus kita buat.  Jika kita berbicara tentang pengontrol REST, alangkah baiknya untuk menggabungkan permintaan untuk setiap layanan sepanjang sesi. <br><br><div class="spoiler">  <b class="spoiler_title">Kelompokkan semua panggilan</b> <div class="spoiler_text">  Dalam beberapa situasi, semua data yang diperlukan dalam sesi dapat diperoleh dengan segera dan tidak akan menyebabkan masalah dengan sumber daya baik dari pemrakarsa permintaan atau dari pelaksana.  Dalam hal ini, kami tidak dapat membatasi ukuran paket untuk memanggil layanan dan segera menerima semua data sekaligus. <br><br>  Asumsi lain yang membuat hidup lebih mudah adalah mengasumsikan bahwa inisiator memiliki sumber daya yang cukup untuk memproses semua data.  Permintaan ke layanan eksternal juga dapat dikirim dalam paket terbatas, jika mereka memerlukannya. <br><br>  Penyederhanaan logika dalam hal ini menyangkut bagaimana tempat-tempat di mana data dibutuhkan akan dibandingkan dengan hasil panggilan.  Jika kami menganggap bahwa sumber daya penggagas sangat terbatas, dan pada saat yang sama mencoba untuk meminimalkan jumlah panggilan eksternal, kami mendapatkan tugas yang agak sulit untuk pemotongan grafik yang optimal.  Kemungkinan besar, Anda hanya perlu mengorbankan kinerja untuk mengurangi konsumsi sumber daya. <br><br>  Kami akan mempertimbangkan bahwa secara khusus dalam proyek demo kami inisiator tidak terbatas pada sumber daya, ia dapat menerima semua data yang diperlukan dan menyimpannya sampai akhir sesi.  Jika ada masalah dengan sumber daya, kami hanya akan membuat pagination yang lebih kecil. <br><br>  Karena dalam praktik saya, pendekatan semacam itu sangat dibutuhkan, contoh-contoh lebih lanjut akan menyangkut pilihan ini. </div></div><br>  Kita dapat membedakan metode-metode seperti itu untuk mendapatkan kumpulan pertanyaan besar: <br><br><ul><li>  rekayasa terbalik; </li><li>  heuristik bisnis; </li><li>  agregat dalam gaya DDD; </li><li>  proksi dan panggilan ganda. </li></ul><br>  Mari kita lihat semua opsi pada contoh proyek kami. <br><br><a name="ReverseEngineering"></a><h4>  Rekayasa terbalik </h4><br><a name="RequirementsGathering"></a>  <b>Kumpulkan semua permintaan</b> <br><br>  Karena kita memiliki kode untuk mengimplementasikan semua fungsi yang terlibat dalam mengumpulkan informasi dan mengubahnya untuk frontend, kita dapat melakukan reverse engineering dan dari kode ini kita dapat memahami permintaan apa yang akan: <br><br> <code><font color="7f0055"><b>class</b></font> <font color="3e7eff"><b>ChatRestController</b></font> <font color="000066">(</font> <br> <font color="7f0055"><b>private val</b></font> <font color="566874">messageRepository</font> : <font color="3e7eff"><b>ChatMessageRepository</b></font> <font color="333333">,</font> <br> <font color="7f0055"><b>private val</b></font> <font color="566874">userRepository</font> : <font color="3e7eff"><b>UserRemoteApi</b></font> <font color="333333">,</font> <br> <font color="7f0055"><b>private val</b></font> <font color="566874">fileRepository</font> : <font color="3e7eff"><b>FileRemoteApi</b></font> <br> <font color="000066">)</font> : <font color="3e7eff"><b>ChatRestApi</b></font> <font color="000066">{</font> <br> <font color="7f0055"><b>override fun</b></font> getLast <font color="000066">(</font> <font color="000066"><i>n</i></font> : <font color="3e7eff"><b>Int</b></font> <font color="000066">)</font> <font color="333333">=</font> <br> <font color="566874">messageRepository</font> <font color="333333">.</font> <font color="170591">findLast</font> <font color="000066">(</font> <font color="000066"><i>n</i></font> <font color="000066">)</font> <br> <font color="333333">.</font> <i><b>let</b></i> <font color="000066"><b>{</b></font> <font color="000066"><i>messages</i></font> <font color="000066"><b>-&gt;</b></font> <br> <font color="000066"><b>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</b></font> <font color="3f7f5f">//    ,  forward  reply</font> <br> <font color="7f0055"><b>val</b></font> <font color="170591">allMessages</font> <font color="333333">=</font> <font color="000066"><i>messages</i></font> <font color="333333">.</font> <i><b>asSequence</b></i> <font color="000066">()</font> <font color="333333">.</font> <i><b>flatMap</b></i> <font color="000066"><b>{</b></font> <br> <font color="000066"><b>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</b></font> <i><b>sequenceOf</b></i> <font color="000066">(</font> <font color="000066"><i>it</i></font> <font color="333333">,</font> <font color="000066"><i>it</i></font> <font color="333333">.</font> <font color="566874">forwardFrom</font> <font color="333333">,</font> <b>it</b> <font color="333333">.</font> <font color="566874">replyTo</font> <font color="000066">)</font> <font color="333333">.</font> <i><b>filterNotNull</b></i> <font color="000066">()</font> <br> <font color="000066"><b>}</b></font> <font color="333333">.</font> <i><b>toSet</b></i> <font color="000066">()</font> <br> <font color="7f0055"><b>val</b></font> <font color="170591">allUserReq</font> <font color="333333">=</font> <font color="170591">allMessages</font> <font color="333333">.</font> <i><b>map</b></i> <font color="000066"><b>{</b></font> <b>it</b> <font color="333333">.</font> <font color="566874">author</font> <font color="000066"><b>}</b></font> <br> <font color="000066"><b>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</b></font> <font color="7f0055"><b>val</b></font> <font color="170591">allFileReq</font> <font color="333333">=</font> <font color="170591">allMessages</font> <font color="333333">.</font> <i><b>flatMap</b></i> <font color="000066"><b>{</b></font> <font color="000066"><i>it</i></font> <font color="333333">.</font> <font color="566874">files</font> ?: <i><b>listOf</b></i> <font color="000066">()</font> <font color="000066"><b>}</b></font> <font color="333333">.</font> <i><b>toSet</b></i> <font color="000066">()</font></code> <br> <br>  Semua permintaan dikumpulkan, sekarang Anda perlu melakukan pemrosesan batch yang sebenarnya. <br><br>  Untuk allUserReq dan allFileReq, kami membuat kueri eksternal dan mengelompokkannya berdasarkan id.  Jika tidak ada batasan pada ukuran paket, maka akan terlihat seperti ini: <br><br> <code><font color="566874">userRepository</font> <font color="333333">.</font> <font color="170591">getUsersByIds</font> <font color="000066">(</font> <font color="170591">allMessages</font> <font color="333333">.</font> <i><b>map</b></i> <font color="000066"><b>{</b></font> <b>it</b> <font color="333333">.</font> <font color="566874">author</font> <font color="000066"><b>}</b></font> <font color="333333">.</font> <i><b>toSet</b></i> <font color="000066">())</font> <br> <font color="333333">.</font> <i><b>associateBy</b></i> <font color="000066"><b>{</b></font> <b>it</b> <font color="333333">.</font> <font color="566874">id</font> <font color="000066"><b>}</b></font> ::get <br> <font color="566874">fileRepository</font> <font color="333333">.</font> <font color="170591">getHeadsByIds</font> <font color="000066">(</font> <font color="170591">allMessages</font> <font color="333333">.</font> <i><b>flatMap</b></i> <font color="000066"><b>{</b></font> <b>it</b> <font color="333333">.</font> <font color="566874">files</font> ?: <i><b>listOf</b></i> <font color="000066">()</font> <font color="000066"><b>}</b></font> <font color="333333">.</font> <i><b>toSet</b></i> <font color="000066">())</font> <br> <font color="333333">.</font> <i><b>associateBy</b></i> <font color="000066"><b>{</b></font> <font color="000066"><i>it</i></font> <font color="333333">.</font> <font color="566874">id</font> <font color="000066"><b>}</b></font> ::get</code> <br> <br>  Jika ada batasan, maka kodenya akan berupa: <br><br> <code><font color="7f0055"><b>val</b></font> <font color="170591">userApiChunkLimit</font> <font color="333333">=</font> <font color="333333"><b>100</b></font> <br> <font color="170591">allMessages</font> <font color="333333">.</font> <i><b>map</b></i> <font color="000066"><b>{</b></font> <b>it</b> <font color="333333">.</font> <font color="566874">author</font> <font color="000066"><b>}</b></font> <font color="333333">.</font> <i><b>asSequence</b></i> <font color="000066">()</font> <font color="333333">.</font> <i><b>distinct</b></i> <font color="000066">()</font> <br> <font color="333333">.</font> <i><b>chunked</b></i> <font color="000066">(</font> <font color="170591">userApiChunkLimit</font> <font color="333333">,</font> <font color="566874">userRepository</font> ::getUsersByIds <font color="000066">)</font> <br> <font color="333333">.</font> <i><b>flatten</b></i> <font color="000066">()</font> <br> <font color="333333">.</font> <i><b>associateBy</b></i> <font color="000066"><b>{</b></font> <font color="000066"><i>it</i></font> <font color="333333">.</font> <font color="566874">id</font> <font color="000066"><b>}</b></font> ::get</code> <br> <br>  Sayangnya, tidak seperti Stream, Sequence tidak dapat dengan mudah beralih ke permintaan paket paralel. <br><br>  Jika Anda menganggap kueri paralel sebagai valid dan perlu, Anda dapat melakukan, misalnya, ini: <br><br> <code><font color="170591">allMessages</font> <font color="333333">.</font> <i><b>map</b></i> <font color="000066"><b>{</b></font> <font color="000066"><i>it</i></font> <font color="333333">.</font> <font color="566874">author</font> <font color="000066"><b>}</b></font> <font color="333333">.</font> <font color="170591">parallelStream</font> <font color="000066">()</font> <font color="333333">.</font> <font color="170591">distinct</font> <font color="000066">()</font> <br> <font color="333333">.</font> <i><b>chunked</b></i> <font color="000066">(</font> <font color="05314d"><b>userApiChunkLimit</b></font> <font color="333333">,</font> <font color="566874">userRepository</font> ::getUsersByIds <font color="000066">)</font> <br> <font color="333333">.</font> <i><b>flatten</b></i> <font color="000066">()</font> <br> <font color="333333">.</font> <i><b>associateBy</b></i> <font color="000066"><b>{</b></font> <font color="000066"><i>it</i></font> <font color="333333">.</font> <font color="566874">id</font> <font color="000066"><b>}</b></font> ::get</code> <br> <br>  Dapat dilihat bahwa tidak ada yang berubah banyak.  Menggunakan sejumlah sihir Kotlin tertentu membantu kami dalam hal ini: <br><br> <code><font color="7f0055"><b>fun</b></font> <font color="333333">&lt;</font> <font color="000066"><i>T</i></font> <font color="333333">,</font> <font color="000066"><i>R</i></font> <font color="333333">&gt;</font> <font color="3e7eff"><b>Stream</b></font> <font color="333333">&lt;</font> <font color="7f0055"><b>out</b></font> <font color="000066"><i>T</i></font> <font color="333333">&gt;.</font> <font color="170591"><b>chunked</b></font> <font color="000066">(</font> <font color="000066"><i>size</i></font> : <font color="3e7eff"><b>Int</b></font> <font color="333333">,</font> <font color="000066"><i>transform</i></font> : <font color="000066">(</font> <font color="3e7eff"><b>List</b></font> <font color="333333">&lt;</font> <font color="000066"><i>T</i></font> <font color="333333">&gt;</font> <font color="000066">) -&gt;</font> <font color="000066"><i>R</i></font> <font color="000066">)</font> : <font color="3e7eff"><b>Stream</b></font> <font color="333333">&lt;</font> <font color="7f0055"><b>out</b></font> <font color="000066"><i>R</i></font> <font color="333333">&gt; =</font> <br> <i><b>batches</b></i> <font color="000066">(</font> <font color="7f0055"><b>this</b></font> <font color="333333">,</font> <font color="000066"><i>size</i></font> <font color="000066">)</font> <font color="333333">.</font> <font color="170591">map</font> <font color="000066">(</font> <font color="000066"><i>transform</i></font> <font color="000066">)</font> <br> <br> <font color="7f0055"><b>fun</b></font> <font color="333333">&lt;</font> <font color="000066"><i>T</i></font> <font color="333333">&gt;</font> <font color="3e7eff"><b>Stream</b></font> <font color="333333">&lt;</font> <font color="7f0055"><b>out</b></font> <font color="3e7eff"><b>Collection</b></font> <font color="333333">&lt;</font> <font color="000066"><i>T</i></font> <font color="333333">&gt;&gt;.</font> <font color="170591"><b>flatten</b></font> <font color="000066">()</font> : <font color="3e7eff"><b>Stream</b></font> <font color="333333">&lt;</font> <font color="000066"><i>T</i></font> <font color="333333">&gt; =</font> <br> <font color="170591">flatMap</font> <font color="000066"><b>{</b></font> <font color="000066"><i>it</i></font> <font color="333333">.</font> <font color="170591">stream</font> <font color="000066">()</font> <font color="000066"><b>}</b></font> <br> <br> <font color="7f0055"><b>fun</b></font> <font color="333333">&lt;</font> <font color="000066"><i>T</i></font> <font color="333333">,</font> <font color="000066"><i>K</i></font> <font color="333333">&gt;</font> <font color="3e7eff"><b>Stream</b></font> <font color="333333">&lt;</font> <font color="000066"><i>T</i></font> <font color="333333">&gt;.</font> <font color="170591"><b>associateBy</b></font> <font color="000066">(</font> <font color="000066"><i>keySelector</i></font> : <font color="000066">(</font> <font color="000066"><i>T</i></font> <font color="000066">) -&gt;</font> <font color="000066"><i>K</i></font> <font color="000066">)</font> : <font color="3e7eff"><b>Map</b></font> <font color="333333">&lt;</font> <font color="000066"><i>K</i></font> <font color="333333">,</font> <font color="000066"><i>T</i></font> <font color="333333">&gt; =</font> <br> <font color="170591">collect</font> <font color="000066">(</font> <font color="3e7eff"><b>Collectors</b></font> <font color="333333">.</font> <font color="170591">toMap</font> <font color="000066">(</font> <font color="000066"><i>keySelector</i></font> <font color="333333">,</font> <font color="000066"><b>{</b></font> <b>it</b> <font color="000066"><b>}</b></font> <font color="000066">))</font></code> <br> <br><div class="spoiler">  <b class="spoiler_title">Sekarang tinggal menyatukan semuanya:</b> <div class="spoiler_text"> <code><font color="7f0055"><b>override fun</b></font> <font color="170591"><b>getLast</b></font> <font color="000066">(</font> <font color="000066"><i>n</i></font> : <font color="3e7eff"><b>Int</b></font> <font color="000066">)</font> <font color="333333">=</font> <br> <font color="566874">messageRepository</font> <font color="333333">.</font> <font color="170591">findLast</font> <font color="000066">(</font> <font color="000066"><i>n</i></font> <font color="000066">)</font> <br> <font color="333333">.</font> <i><b>let</b></i> <font color="000066"><b>{</b></font> <font color="000066"><i>messages</i></font> <font color="000066"><b>-&gt;</b></font> <br> <font color="000066"><b>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</b></font> <font color="3f7f5f">//    ,  forward  reply</font> <br> <font color="7f0055"><b>val</b></font> <font color="170591">allMessages</font> <font color="333333">=</font> <font color="000066"><i>messages</i></font> <font color="333333">.</font> <i><b>asSequence</b></i> <font color="000066">()</font> <font color="333333">.</font> <i><b>flatMap</b></i> <font color="000066"><b>{</b></font> <font color="000066"><i>message</i></font> <font color="000066"><b>-&gt;</b></font> <br> <font color="000066"><b>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</b></font> <i><b>sequenceOf</b></i> <font color="000066">(</font> <font color="000066"><i>message</i></font> <font color="333333">,</font> <font color="000066"><i>message</i></font> <font color="333333">.</font> <font color="566874">forwardFrom</font> <font color="333333">,</font> <font color="000066"><i>message</i></font> <font color="333333">.</font> <font color="566874">replyTo</font> <font color="000066">)</font> <br> <font color="333333">.</font> <i><b>filterNotNull</b></i> <font color="000066">()</font> <br> <font color="000066"><b>}</b></font> <font color="333333">.</font> <i><b>toSet</b></i> <font color="000066">()</font> <br> <br> <font color="000066"><i>messages</i></font> <font color="333333">.</font> <i><b>map</b></i> <font color="000066">(</font> <font color="170591">ValueHolder</font> <font color="333333">&lt;</font> <font color="000066">(</font> <font color="3e7eff"><b>ChatMessage</b></font> <font color="000066">) -&gt;</font> <font color="3e7eff"><b>ChatMessageUI</b></font> <font color="333333">&gt;</font> <font color="000066">()</font> <font color="333333">.</font> <i><b>apply</b></i> <font color="000066"><b>{</b></font> <br> <font color="000066"><b>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</b></font> <font color="566874">value</font> <font color="333333">=</font> <i><b>memoize</b></i> <font color="000066"><b>{</b></font> <font color="000066"><i>message</i></font> : <font color="3e7eff"><b>ChatMessage</b></font> <font color="000066"><b>-&gt;</b></font> <br> <font color="000066"><b>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</b></font> <font color="000066"><i>message</i></font> <font color="333333">.</font> <i><b>toFrontModel</b></i> <font color="000066">(</font> <br> <font color="3f7f5f">//       ,    </font> <br> <font color="4a86e8">getUser =</font> <font color="3e7eff"><b>allMessages</b></font> <font color="333333">.</font> <i><b>map</b></i> <font color="000066"><b>{</b></font> <b>it</b> <font color="333333">.</font> <font color="566874">author</font> <font color="000066"><b>}</b></font> <font color="333333">.</font> <font color="170591">parallelStream</font> <font color="000066">()</font> <font color="333333">.</font> <font color="170591">distinct</font> <font color="000066">()</font> <br> <font color="333333">.</font> <i><b>chunked</b></i> <font color="000066">(</font> <font color="05314d"><b>userApiChunkLimit</b></font> <font color="333333">,</font> <font color="566874">userRepository</font> ::getUsersByIds <font color="000066">)</font> <br> <font color="333333">.</font> <i><b>flatten</b></i> <font color="000066">()</font> <br> <font color="333333">.</font> <i><b>associateBy</b></i> <font color="000066"><b>{</b></font> <b>it</b> <font color="333333">.</font> <font color="566874">id</font> <font color="000066"><b>}</b></font> ::get <font color="333333">.</font> <i><b>orThrow</b></i> <font color="000066"><b>{</b></font> <font color="170591">IllegalArgumentException</font> <font color="000066">(</font> <b>"User</b> <font color="333333"><b>$</b></font> <b>it"</b> <font color="000066">)</font> <font color="000066"><b>}</b></font> <font color="333333">,</font> <br> <font color="3f7f5f">//        </font> <br> <font color="4a86e8">getFile =</font> <font color="566874">fileRepository</font> <font color="333333">.</font> <font color="170591">getHeadsByIds</font> <font color="000066">(</font> <font color="3e7eff"><b>allMessages</b></font> <font color="333333">.</font> <i><b>flatMap</b></i> <font color="000066"><b>{</b></font> <font color="000066"><i>it</i></font> <font color="333333">.</font> <font color="566874">files</font> ?: <i><b>listOf</b></i> <font color="000066">()</font> <font color="000066"><b>}</b></font> <font color="333333">.</font> <i><b>toSet</b></i> <font color="000066">())</font> <br> <font color="333333">.</font> <i><b>associateBy</b></i> <font color="000066"><b>{</b></font> <font color="000066"><i>it</i></font> <font color="333333">.</font> <font color="566874">id</font> <font color="000066"><b>}</b></font> ::get <font color="333333">.</font> <i><b>orThrow</b></i> <font color="000066"><b>{</b></font> <font color="170591">IllegalArgumentException</font> <font color="000066">(</font> <b>"File</b> <font color="333333"><b>$</b></font> <b>it"</b> <font color="000066">)</font> <font color="000066"><b>}</b></font> <font color="333333">,</font> <br> <font color="3f7f5f">//       </font> <br> <font color="4a86e8">serializeMessage =</font> <font color="566874">value</font> <br> <font color="000066">)</font> <br> <font color="000066"><b>}</b></font> <br> <font color="000066"><b>}</b></font> <font color="333333">.</font> <font color="566874">value</font> <font color="000066">)</font> <br> <font color="000066"><b>}</b></font></code> </div> </div><br><div class="spoiler">  <b class="spoiler_title">Penjelasan dan Penyederhanaan</b> <div class="spoiler_text">  Hal pertama yang pasti akan menarik perhatian Anda adalah fungsi memoize.  Faktanya adalah bahwa fungsi serializeMessage hampir pasti akan dipanggil beberapa kali untuk pesan yang sama (karena membalas dan meneruskan).  Tidak jelas mengapa kita harus melakukan toFrontModel secara terpisah untuk setiap pesan tersebut (dalam beberapa kasus ini mungkin diperlukan, tetapi bukan milik kita).  Oleh karena itu, Anda dapat melakukan memoisasi untuk fungsi serializeMessage.  Ini diterapkan, misalnya, sebagai berikut: <br><br> <code><font color="7f0055"><b>fun</b></font> <font color="333333">&lt;</font> <font color="000066"><i>A</i></font> <font color="333333">,</font> <font color="000066"><i>R</i></font> <font color="333333">&gt;</font> <font color="170591"><b>memoize</b></font> <font color="000066">(</font> <font color="000066"><i>func</i></font> : <font color="000066">(</font> <font color="000066"><i>A</i></font> <font color="000066">) -&gt;</font> <font color="000066"><i>R</i></font> <font color="000066">)</font> <font color="333333">=</font> <font color="000066"><i>func</i></font> <font color="7f0055"><b>as?</b></font> <font color="3e7eff"><b>Memoize2</b></font> ?: <font color="170591">Memoize2</font> <font color="000066">(</font> <font color="000066"><i>func</i></font> <font color="000066">)</font> <br> <font color="7f0055"><b>class</b></font> <font color="3e7eff"><b>Memoize2</b></font> <font color="333333">&lt;</font> <font color="000066"><i>A</i></font> <font color="333333">,</font> <font color="000066"><i>R</i></font> <font color="333333">&gt;</font> <font color="000066">(</font> <font color="7f0055"><b>val</b></font> <font color="566874">func</font> : <font color="000066">(</font> <font color="000066"><i>A</i></font> <font color="000066">) -&gt;</font> <font color="000066"><i>R</i></font> <font color="000066">)</font> : <font color="000066">(</font> <font color="000066"><i>A</i></font> <font color="000066">) -&gt;</font> <font color="000066"><i>R</i></font> <font color="333333">,</font> java <font color="333333">.</font> util <font color="333333">.</font> function <font color="333333">.</font> <font color="3e7eff"><b>Function</b></font> <font color="333333">&lt;</font> <font color="000066"><i>A</i></font> <font color="333333">,</font> <font color="000066"><i>R</i></font> <font color="333333">&gt;</font> <font color="000066">{</font> <br> <font color="7f0055"><b>private val</b></font> <font color="566874">cache</font> <font color="333333">=</font> <i><b>hashMapOf</b></i> <font color="333333">&lt;</font> <font color="000066"><i>A</i></font> <font color="333333">,</font> <font color="000066"><i>R</i></font> <font color="333333">&gt;</font> <font color="000066">()</font> <br> <font color="7f0055"><b>override fun</b></font> <font color="170591"><b>invoke</b></font> <font color="000066">(</font> <font color="000066"><i>p1</i></font> : <font color="000066"><i>A</i></font> <font color="000066">)</font> <font color="333333">=</font> <font color="566874">cache</font> <font color="333333">.</font> <i><b>getOrPut</b></i> <font color="000066">(</font> <font color="000066"><i>p1</i></font> <font color="333333">,</font> <font color="000066"><b>{</b></font> <font color="566874">func</font> <font color="000066">(</font> <font color="000066"><i>p1</i></font> <font color="000066">)</font> <font color="000066"><b>}</b></font> <font color="000066">)</font> <br> <font color="7f0055"><b>override fun</b></font> <font color="170591"><b>apply</b></font> <font color="000066">(</font> <font color="000066"><i>t</i></font> : <font color="000066"><i>A</i></font> <font color="000066">)</font> : <font color="000066"><i>R</i></font> <font color="333333">=</font> <font color="170591">invoke</font> <font color="000066">(</font> <font color="000066"><i>t</i></font> <font color="000066">)</font> <br> <font color="000066">}</font></code> <br> <br>  Selanjutnya, kita perlu membangun fungsi serializeMessage yang di-memo, tetapi pada saat yang sama akan digunakan di dalamnya.  Penting untuk menggunakan contoh fungsi yang sama persis di dalam, jika tidak semua memoisasi akan sia-sia.  Untuk menyelesaikan tabrakan ini, kami menggunakan kelas ValueHolder, yang hanya menyimpan referensi ke nilai (Anda dapat mengambil sesuatu yang standar, misalnya, AtomicReference).  Untuk mempersingkat catatan rekursi, Anda dapat melakukan ini: <br><br> <code><font color="7f0055"><b>inline fun</b></font> <font color="333333">&lt;</font> <font color="000066"><i>A</i></font> <font color="333333">,</font> <font color="000066"><i>R</i></font> <font color="333333">&gt;</font> <font color="170591"><b>recursiveMemoize</b></font> <font color="000066">(</font> <font color="7f0055"><b>crossinline</b></font> <font color="000066"><i>func</i></font> : <font color="000066">(</font> <font color="000066"><i>A</i></font> <font color="333333">,</font> <font color="000066">(</font> <font color="000066"><i>A</i></font> <font color="000066">) -&gt;</font> <font color="000066"><i>R</i></font> <font color="000066">) -&gt;</font> <font color="000066"><i>R</i></font> <font color="000066">)</font> : <font color="000066">(</font> <font color="000066"><i>A</i></font> <font color="000066">) -&gt;</font> <font color="000066"><i>R</i></font> <font color="333333">=</font> <br> <font color="170591">ValueHolder</font> <font color="333333">&lt;</font> <font color="000066">(</font> <font color="000066"><i>A</i></font> <font color="000066">) -&gt;</font> <font color="000066"><i>R</i></font> <font color="333333">&gt;</font> <font color="000066">()</font> <font color="333333">.</font> <i><b>apply</b></i> <font color="000066"><b>{</b></font> <br> <font color="000066"><b>&nbsp;&nbsp;&nbsp;&nbsp;</b></font> <font color="566874">value</font> <font color="333333">=</font> <i><b>memoize</b></i> <font color="000066"><b>{</b></font> <font color="000066"><i>a</i></font> <font color="000066"><b>-&gt;</b></font> <font color="3e7eff"><b>func</b></font> <font color="000066">(</font> <font color="000066"><i>a</i></font> <font color="333333">,</font> <font color="566874">value</font> <font color="000066">)</font> <font color="000066"><b>}</b></font> <br> <font color="000066"><b>}</b></font> <font color="333333">.</font> <font color="566874">value</font></code> <br> <br>  Jika Anda bisa memahami silogisme panah ini pertama kali - selamat, Anda adalah programmer fungsional :-) <br><br>  Sekarang kode akan terlihat seperti ini: <br><br> <code><font color="7f0055"><b>override fun</b></font> <font color="170591"><b>getLast</b></font> <font color="000066">(</font> <font color="000066"><i>n</i></font> : <font color="3e7eff"><b>Int</b></font> <font color="000066">)</font> <font color="333333">=</font> <br> <font color="566874">messageRepository</font> <font color="333333">.</font> <font color="170591">findLast</font> <font color="000066">(</font> <font color="000066"><i>n</i></font> <font color="000066">)</font> <br> <font color="333333">.</font> <i><b>let</b></i> <font color="000066"><b>{</b></font> <font color="000066"><i>messages</i></font> <font color="000066"><b>-&gt;</b></font> <br> <font color="000066"><b>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</b></font> <font color="3f7f5f">//    ,  forward  reply</font> <br> <font color="7f0055"><b>val</b></font> <font color="170591">allMessages</font> <font color="333333">=</font> <font color="000066"><i>messages</i></font> <font color="333333">.</font> <i><b>asSequence</b></i> <font color="000066">()</font> <font color="333333">.</font> <i><b>flatMap</b></i> <font color="000066"><b>{</b></font> <font color="000066"><i>message</i></font> <font color="000066"><b>-&gt;</b></font> <br> <font color="000066"><b>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</b></font> <i><b>sequenceOf</b></i> <font color="000066">(</font> <font color="000066"><i>message</i></font> <font color="333333">,</font> <font color="000066"><i>message</i></font> <font color="333333">.</font> <font color="566874">forwardFrom</font> <font color="333333">,</font> <font color="000066"><i>message</i></font> <font color="333333">.</font> <font color="566874">replyTo</font> <font color="000066">)</font> <br> <font color="333333">.</font> <i><b>filterNotNull</b></i> <font color="000066">()</font> <br> <font color="000066"><b>}</b></font> <font color="333333">.</font> <i><b>toSet</b></i> <font color="000066">()</font> <br> <br> <font color="3f7f5f">//       ,    </font> <br> <font color="7f0055"><b>val</b></font> <font color="170591">getUser</font> <font color="333333">=</font> <font color="170591">allMessages</font> <font color="333333">.</font> <i><b>map</b></i> <font color="000066"><b>{</b></font> <b>it</b> <font color="333333">.</font> <font color="566874">author</font> <font color="000066"><b>}</b></font> <font color="333333">.</font> <font color="170591">parallelStream</font> <font color="000066">()</font> <font color="333333">.</font> <font color="170591">distinct</font> <font color="000066">()</font> <br> <font color="333333">.</font> <i><b>chunked</b></i> <font color="000066">(</font> <font color="05314d"><b>userApiChunkLimit</b></font> <font color="333333">,</font> <font color="566874">userRepository</font> ::getUsersByIds <font color="000066">)</font> <br> <font color="333333">.</font> <i><b>flatten</b></i> <font color="000066">()</font> <br> <font color="333333">.</font> <i><b>associateBy</b></i> <font color="000066"><b>{</b></font> <font color="000066"><i>it</i></font> <font color="333333">.</font> <font color="566874">id</font> <font color="000066"><b>}</b></font> ::get <font color="333333">.</font> <i><b>orThrow</b></i> <font color="000066"><b>{</b></font> <font color="170591">IllegalArgumentException</font> <font color="000066">(</font> <b>"User</b> <font color="333333"><b>$</b></font> <font color="000066"><i>it</i></font> <b>"</b> <font color="000066">)</font> <font color="000066"><b>}</b></font> <br> <br> <font color="000066"><b>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</b></font> <font color="3f7f5f">//        </font> <br> <font color="7f0055"><b>val</b></font> <font color="170591">getFile</font> <font color="333333">=</font> <font color="566874">fileRepository</font> <font color="333333">.</font> <font color="170591">getHeadsByIds</font> <font color="000066">(</font> <font color="170591">allMessages</font> <font color="333333">.</font> <i><b>flatMap</b></i> <font color="000066"><b>{</b></font> <b>it</b> <font color="333333">.</font> <font color="566874">files</font> ?: <i><b>listOf</b></i> <font color="000066">()</font> <font color="000066"><b>}</b></font> <font color="333333">.</font> <i><b>toSet</b></i> <font color="000066">())</font> <br> <font color="333333">.</font> <i><b>associateBy</b></i> <font color="000066"><b>{</b></font> <font color="000066"><i>it</i></font> <font color="333333">.</font> <font color="566874">id</font> <font color="000066"><b>}</b></font> ::get <font color="333333">.</font> <i><b>orThrow</b></i> <font color="000066"><b>{</b></font> <font color="170591">IllegalArgumentException</font> <font color="000066">(</font> <b>"File</b> <font color="333333"><b>$</b></font> <b>it"</b> <font color="000066">)</font> <font color="000066"><b>}</b></font> <br> <br> <font color="000066"><b>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</b></font> <font color="000066"><i>messages</i></font> <font color="333333">.</font> <i><b>map</b></i> <font color="000066">(</font> <i><b>recursiveMemoize</b></i> <font color="000066"><b>{</b></font> <font color="000066"><i>message</i></font> <font color="333333">,</font> <font color="000066"><i>memoized</i></font> : <font color="000066">(</font> <font color="3e7eff"><b>ChatMessage</b></font> <font color="000066">) -&gt;</font> <font color="3e7eff"><b>ChatMessageUI</b></font> <font color="000066"><b>-&gt;</b></font> <br> <font color="000066"><b>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</b></font> <font color="000066"><i>message</i></font> <font color="333333">.</font> <i><b>toFrontModel</b></i> <font color="000066">(</font> <br> <font color="4a86e8">getUser =</font> <font color="170591">getUser</font> <font color="333333">,</font> <br> <font color="4a86e8">getFile =</font> <font color="170591">getFile</font> <font color="333333">,</font> <br> <font color="3f7f5f">//       </font> <br> <font color="4a86e8">serializeMessage =</font> <font color="000066"><i>memoized</i></font> <br> <font color="000066"><i>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</i></font> <font color="000066">)</font> <br> <font color="000066"><b>}</b></font> <font color="000066">)</font></code> <br> <br>  Anda juga dapat melihat orThrow, yang didefinisikan seperti ini: <br><br> <code><font color="395da1">/**  </font> <font color="3d3d3d"><i><b>[exception]</b></i></font> <font color="395da1">,    null */</font> <br> <font color="7f0055"><b>fun</b></font> <font color="333333">&lt;</font> <font color="000066"><i>P</i></font> <font color="333333">,</font> <font color="000066"><i>R</i></font> <font color="333333">&gt;</font> <font color="000066">((</font> <font color="000066"><i>P</i></font> <font color="000066">) -&gt;</font> <font color="000066"><i>R</i></font> ? <font color="000066">)</font> <font color="333333">.</font> <font color="170591"><b>orThrow</b></font> <font color="000066">(</font> <font color="000066"><i>exception</i></font> : <font color="000066">(</font> <font color="000066"><i>P</i></font> <font color="000066">) -&gt;</font> <font color="3e7eff"><b>Exception</b></font> <font color="000066">)</font> : <font color="000066">(</font> <font color="000066"><i>P</i></font> <font color="000066">) -&gt;</font> <font color="000066"><i>R</i></font> <font color="333333">=</font> <br> <font color="000066"><b>{</b></font> <font color="000066"><i>p</i></font> <font color="000066"><b>-&gt;</b></font> <font color="170591">invoke</font> <font color="000066">(</font> <font color="000066"><i>p</i></font> <font color="000066">)</font> <font color="333333">.</font> <i><b>let</b></i> <font color="000066"><b>{</b></font> <b>it</b> ?: <font color="7f0055"><b>throw</b></font> <font color="3e7eff"><b>exception</b></font> <font color="000066">(</font> <font color="000066"><i>p</i></font> <font color="000066">)</font> <font color="000066"><b>} }</b></font></code> <br> <br>  Jika tidak ada data id kami di layanan eksternal dan ini dianggap sebagai situasi hukum, Anda perlu menanganinya dengan cara yang berbeda. <br><br>  Setelah perbaikan ini, runtime getLast diperkirakan sekitar 300 ms.  Selain itu, waktu ini akan tumbuh sedikit, bahkan jika permintaan tidak lagi sesuai dengan batasan ukuran paket (karena paket diminta secara paralel).  Biarkan saya mengingatkan Anda bahwa tujuan minimum kami adalah 500 ms, dan 250 ms dapat dianggap sebagai pekerjaan normal. </div></div><br><a name="Parallelism"></a>  <b>Paralelisme</b> <br><br>  Tetapi Anda harus pindah.  Panggilan ke userRepository dan fileRepository sepenuhnya independen, dan mereka dapat dengan mudah diparalelkan, secara teori mendekati 200 ms. <br><br><div class="spoiler">  <b class="spoiler_title">Misalnya, melalui fungsi gabungan kami:</b> <div class="spoiler_text"> <code><font color="7f0055"><b>override fun</b></font> <font color="170591"><b>getLast</b></font> <font color="000066">(</font> <font color="000066"><i>n</i></font> : <font color="3e7eff"><b>Int</b></font> <font color="000066">)</font> <font color="333333">=</font> <br> <font color="566874">messageRepository</font> <font color="333333">.</font> <font color="170591">findLast</font> <font color="000066">(</font> <font color="000066"><i>n</i></font> <font color="000066">)</font> <br> <font color="333333">.</font> <i><b>let</b></i> <font color="000066"><b>{</b></font> <font color="000066"><i>messages</i></font> <font color="000066"><b>-&gt;</b></font> <br> <font color="000066"><b>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</b></font> <font color="3f7f5f">//    ,  forward  reply</font> <br> <font color="7f0055"><b>val</b></font> <font color="170591">allMessages</font> <font color="333333">=</font> <font color="000066"><i>messages</i></font> <font color="333333">.</font> <i><b>asSequence</b></i> <font color="000066">()</font> <font color="333333">.</font> <i><b>flatMap</b></i> <font color="000066"><b>{</b></font> <font color="000066"><i>message</i></font> <font color="000066"><b>-&gt;</b></font> <br> <font color="000066"><b>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</b></font> <i><b>sequenceOf</b></i> <font color="000066">(</font> <font color="000066"><i>message</i></font> <font color="333333">,</font> <font color="000066"><i>message</i></font> <font color="333333">.</font> <font color="566874">forwardFrom</font> <font color="333333">,</font> <font color="000066"><i>message</i></font> <font color="333333">.</font> <font color="566874">replyTo</font> <font color="000066">)</font> <br> <font color="333333">.</font> <i><b>filterNotNull</b></i> <font color="000066">()</font> <br> <font color="000066"><b>}</b></font> <font color="333333">.</font> <i><b>toSet</b></i> <font color="000066">()</font> <br> <br> <i><b>join</b></i> <font color="000066">(</font> <font color="000066"><b>{</b></font> <br> <font color="000066"><b>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</b></font> <font color="3f7f5f">//       ,    </font> <br> <font color="3e7eff"><b>allMessages</b></font> <font color="333333">.</font> <i><b>map</b></i> <font color="000066"><b>{</b></font> <b>it</b> <font color="333333">.</font> <font color="566874">author</font> <font color="000066"><b>}</b></font> <font color="333333">.</font> <font color="170591">parallelStream</font> <font color="000066">()</font> <font color="333333">.</font> <font color="170591">distinct</font> <font color="000066">()</font> <br> <font color="333333">.</font> <i><b>chunked</b></i> <font color="000066">(</font> <font color="05314d"><b>userApiChunkLimit</b></font> <font color="333333">,</font> <font color="566874">userRepository</font> ::getUsersByIds <font color="000066">)</font> <br> <font color="333333">.</font> <i><b>flatten</b></i> <font color="000066">()</font> <br> <font color="333333">.</font> <i><b>associateBy</b></i> <font color="000066"><b>{</b></font> <font color="000066"><i>it</i></font> <font color="333333">.</font> <font color="566874">id</font> <font color="000066"><b>}</b></font> <br> <font color="000066"><b>}</b></font> <font color="333333">,</font> <font color="000066"><b>{</b></font> <br> <font color="000066"><b>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</b></font> <font color="3f7f5f">//        </font> <br> <font color="566874">fileRepository</font> <font color="333333">.</font> <font color="170591">getHeadsByIds</font> <font color="000066">(</font> <font color="3e7eff"><b>allMessages</b></font> <font color="333333">.</font> <i><b>flatMap</b></i> <font color="000066"><b>{</b></font> <font color="000066"><i>it</i></font> <font color="333333">.</font> <font color="566874">files</font> ?: <i><b>listOf</b></i> <font color="000066">()</font> <font color="000066"><b>}</b></font> <font color="333333">.</font> <i><b>toSet</b></i> <font color="000066">())</font> <br> <font color="333333">.</font> <i><b>associateBy</b></i> <font color="000066"><b>{</b></font> <b>it</b> <font color="333333">.</font> <font color="566874">id</font> <font color="000066"><b>}</b></font> <br> <font color="000066"><b>}</b></font> <font color="000066">)</font> <font color="333333">.</font> <i><b>let</b></i> <font color="000066"><b>{</b></font> <font color="000066">(</font> <font color="170591">users</font> <font color="333333">,</font> <font color="170591">files</font> <font color="000066">)</font> <font color="000066"><b>-&gt;</b></font> <br> <font color="000066"><b>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</b></font> <font color="000066"><i>messages</i></font> <font color="333333">.</font> <i><b>map</b></i> <font color="000066">(</font> <i><b>recursiveMemoize</b></i> <font color="000066"><b>{</b></font> <font color="000066"><i>message</i></font> <font color="333333">,</font> <font color="000066"><i>memoized</i></font> : <font color="000066">(</font> <font color="3e7eff"><b>ChatMessage</b></font> <font color="000066">) -&gt;</font> <font color="3e7eff"><b>ChatMessageUI</b></font> <font color="000066"><b>-&gt;</b></font> <br> <font color="000066"><b>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</b></font> <font color="000066"><i>message</i></font> <font color="333333">.</font> <i><b>toFrontModel</b></i> <font color="000066">(</font> <br> <font color="4a86e8">getUser =</font> <font color="170591">users</font> ::get <font color="333333">.</font> <i><b>orThrow</b></i> <font color="000066"><b>{</b></font> <font color="170591">IllegalArgumentException</font> <font color="000066">(</font> <b>"User</b> <font color="333333"><b>$</b></font> <b>it"</b> <font color="000066">)</font> <font color="000066"><b>}</b></font> <font color="333333">,</font> <br> <font color="4a86e8">getFile =</font> <font color="170591">files</font> ::get <font color="333333">.</font> <i><b>orThrow</b></i> <font color="000066"><b>{</b></font> <font color="170591">IllegalArgumentException</font> <font color="000066">(</font> <b>"File</b> <font color="333333"><b>$</b></font> <font color="000066"><i>it</i></font> <b>"</b> <font color="000066">)</font> <font color="000066"><b>}</b></font> <font color="333333">,</font> <br> <font color="3f7f5f">//       </font> <br> <font color="4a86e8">serializeMessage =</font> <font color="000066"><i>memoized</i></font> <br> <font color="000066"><i>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</i></font> <font color="000066">)</font> <br> <font color="000066"><b>}</b></font> <font color="000066">)</font> <br> <font color="000066"><b>}</b></font> <br> <font color="000066"><b>}</b></font></code> </div> </div><br>  Seperti yang diperlihatkan oleh praktik, eksekusi memakan waktu sekitar 200 ms, dan sangat penting bahwa waktu tidak tumbuh banyak dengan peningkatan jumlah pesan. <br><br><a name="Problems"></a>  <b>Masalahnya</b> <br><br>  Secara umum, kode tersebut, tentu saja, menjadi kurang dapat dibaca daripada versi pertama kami yang naif, tetapi bagus bahwa serialisasi itu sendiri (implementasi toFrontModel) tidak banyak berubah dan tetap sepenuhnya dapat dibaca.  Seluruh logika kerja licik dengan layanan eksternal tinggal di satu tempat. <br><br>  Kelemahan dari pendekatan ini adalah abstraksi kami sedang berjalan. <br><br>  Jika kita perlu melakukan perubahan pada toFrontModel, kita hampir pasti harus membuat perubahan pada fungsi getLast, yang melanggar <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">prinsip substitusi Barbara Liskov</a> (Prinsip Pergantian Liskov). <br><br>  Sebagai contoh, kami sepakat untuk mendekripsi file terlampir hanya di pesan utama, tetapi tidak di balasan dan ke depan (balas / teruskan), atau hanya dalam tanggapan dan ke depan dari tingkat pertama.  Dalam hal ini, setelah membuat perubahan pada kode toFrontModel, Anda harus membuat koreksi terkait dalam kode pengumpulan permintaan untuk file.  Selain itu, koreksi akan menjadi nontrivial: <br><br> <code><font color="566874">fileRepository</font> <font color="333333">.</font> <font color="170591">getHeadsByIds</font> <font color="000066">(</font> <br> <font color="3e7eff"><b>allMessages</b></font> <font color="333333">.</font> <i><b>flatMap</b></i> <font color="000066"><b>{</b></font> <font color="000066"><i>it</i></font> <font color="333333">.</font> <font color="566874">files</font> ?: <i><b>listOf</b></i> <font color="000066">()</font> <font color="000066"><b>}</b></font> <font color="333333">.</font> <i><b>toSet</b></i> <font color="000066">()</font> <br> <font color="000066">)</font></code> <br> <br>  Dan di sini kita dengan lancar mendekati masalah lain yang terkait erat dengan yang sebelumnya: operasi kode yang benar secara keseluruhan tergantung pada keaksaraan dari rekayasa balik.  Dalam beberapa kasus kompleks, kode mungkin tidak berfungsi dengan benar karena pengumpulan kueri yang salah.  Tidak ada jaminan bahwa Anda akan dapat dengan cepat menghasilkan unit test yang akan mencakup semua situasi rumit seperti itu. <br><br><a name="Summary1"></a>  <b>Kesimpulan</b> <br><br>  Pro: <br><br><ol><li>  Cara yang jelas untuk menerima permintaan sebelumnya, yang mudah dipisahkan dari kode utama. </li><li>  Tidak adanya memori dan waktu overhead yang hampir lengkap terkait dengan penggunaan hanya data yang akan diterima. </li><li>  Penskalaan yang baik dan kemampuan untuk membangun layanan, yang secara teori akan bertanggung jawab untuk waktu yang dapat diprediksi, terlepas dari ukuran permintaan dari luar. </li></ol><br>  Cons: <br><br><ol><li>  Kode yang cukup rumit untuk pemrosesan batch itu sendiri. </li><li>  Pekerjaan besar dan bertanggung jawab atas analisis permintaan dalam implementasi yang ada. </li><li>  Abstraksi yang mengalir dan, sebagai konsekuensinya, kerapuhan seluruh skema dalam kaitannya dengan perubahan dalam implementasi. </li><li>  Kesulitan dalam dukungan: kesalahan dalam blok prediksi kueri sulit dibedakan dari kesalahan dalam kode utama.  Idealnya, Anda perlu menggunakan tes unit dua kali lebih banyak, sehingga proses dengan kesalahan dalam produksi akan dua kali lebih sulit. </li><li>  Mematuhi prinsip-prinsip SOLID ketika menulis kode: kode harus disiapkan untuk mengasingkan logika pemrosesan batch.  Pengenalan prinsip-prinsip ini saja akan memberikan beberapa keuntungan, jadi minus ini adalah yang paling tidak signifikan. </li></ol><br>  Penting untuk dicatat bahwa Anda dapat menggunakan metode ini tanpa melakukan reverse engineering.  Kita perlu mendapatkan kontrak getLast, di mana kontrak untuk perhitungan awal permintaan tergantung (selanjutnya - prefetch).  Dalam hal ini, kami melakukan ini dengan melihat implementasi getLast (reverse engineering).  Namun, dengan pendekatan ini, kesulitan muncul: mengedit dua bagian kode ini harus selalu sinkron, dan tidak mungkin untuk memastikan ini sama sekali (ingat kode hash dan sama dengan, ada hal yang persis sama).  Pendekatan selanjutnya, yang ingin saya tunjukkan, dirancang untuk menyelesaikan masalah ini (atau setidaknya meringankan). <br><br><a name="BusinessHeuristics"></a><h4>  Heuristik bisnis </h4><br><a name="ManagingContractProblem1"></a>  <b>Memecahkan masalah kontrak</b> <br><br>  Bagaimana jika kita beroperasi bukan dengan kontrak yang pasti dan, dengan demikian, dengan serangkaian permintaan yang tepat, tetapi dengan perkiraan?  Selain itu, kami akan membangun satu set perkiraan sehingga mencakup set yang tepat dan didasarkan pada karakteristik area subjek. <br><br>  Jadi, alih-alih ketergantungan kontrak prefetch pada getLast, kami menetapkan ketergantungan keduanya pada beberapa kontrak umum yang akan ditentukan oleh pengguna.  Kesulitan utama adalah bagaimana mewujudkan kontrak umum ini dalam bentuk kode. <br><br><a name="UsefulRestrictions"></a>  <b>Cari batasan yang bermanfaat</b> <br><br>  Mari kita coba lakukan ini dengan contoh kita. <br>  Dalam kasus kami, ada fitur bisnis berikut: <br><br><ul><li>  daftar peserta obrolan sudah ditentukan sebelumnya; </li><li>  obrolan sepenuhnya terisolasi satu sama lain; </li><li>  bersarang rantai balasan / maju kecil (~ 2‚Äì3 pesan). </li></ul><br>  Dari pembatasan pertama, Anda tidak perlu berkeliaran di sekitar pesan, lihat apa yang ada di pengguna, pilih yang unik dan buat permintaan untuk mereka.  Anda dapat dengan mudah meminta daftar yang telah ditentukan.  Jika Anda setuju dengan pernyataan ini, maka saya menangkap Anda. <br><br>  Padahal, semuanya tidak sesederhana itu.  Daftar dapat ditentukan sebelumnya, tetapi bisa ada ribuan pengguna.  Hal-hal seperti itu perlu diklarifikasi.  Dalam kasus kami, biasanya akan ada dua atau tiga peserta obrolan, jarang lebih.  Jadi sangat diterima untuk menerima data tentang semuanya. <br><br>  Lebih lanjut, jika daftar pengguna obrolan telah ditentukan sebelumnya, tetapi informasi ini tidak ada dalam layanan pengguna (yang sangat mungkin), maka tidak akan ada artinya dari informasi tersebut.  Kami akan membuat permintaan tambahan untuk daftar pengguna obrolan, dan kemudian Anda masih harus membuat permintaan ke layanan pengguna. <br><br>  Misalkan informasi tentang koneksi pengguna dan obrolan disimpan dalam layanan pengguna.  Dalam kasus kami, ini benar, karena koneksi ditentukan oleh hak-hak pengguna.  Maka bagi pengguna akan menghasilkan kode prefetch seperti: <br><br>  Mungkin mengejutkan di sini bahwa kami tidak melewati pengenal obrolan apa pun.  Saya melakukan ini dengan sengaja agar tidak mengacaukan kode sampel. <br><br>  Sepintas, tidak ada yang mengikuti dari pembatasan kedua.  Bagaimanapun, saya masih tidak bisa mendapatkan sesuatu yang berguna darinya. <br><br>  Kami telah menggunakan batasan ketiga sebelumnya.  Ini dapat berdampak signifikan pada cara kami menyimpan dan menerima percakapan.  Kami tidak akan mulai mengembangkan topik ini, karena tidak ada hubungannya dengan pengontrol REST dan pemrosesan batch. <br><br>  Apa yang harus dilakukan dengan file?  Saya ingin mendapatkan daftar semua file obrolan dalam satu permintaan sederhana.  Di bawah ketentuan API, kita hanya perlu header file, tanpa badan, jadi ini tidak terlihat seperti tugas yang intensif sumber daya dan berbahaya bagi penelepon. <br><br>  Di sisi lain, kita harus ingat bahwa kita tidak menerima semua pesan obrolan, tetapi hanya N terakhir, dan dapat dengan mudah ternyata tidak mengandung file sama sekali. <br><br>  Tidak ada jawaban universal: semuanya tergantung pada spesifikasi bisnis dan kasus penggunaan.  Saat membuat solusi produk, Anda bisa mendapat masalah jika Anda meletakkan heuristik untuk satu kasus penggunaan, dan kemudian pengguna akan bekerja dengan fungsionalitas dengan cara yang berbeda.  Untuk demo dan presales, ini adalah pilihan yang baik, tetapi saat ini kami sedang mencoba untuk menulis layanan produksi yang jujur. <br><br>  Jadi, sayangnya, dimungkinkan untuk melakukan heuristik bisnis untuk file di sini hanya berdasarkan pada hasil operasi dan pengumpulan statistik (atau setelah penilaian ahli). <br><br>  Karena kami masih ingin menerapkan metode kami, misalkan statistik menunjukkan yang berikut: <br><br><ol><li>  Percakapan umum dimulai dengan pesan yang berisi satu atau lebih file, diikuti oleh pesan balasan tanpa file. </li><li>  Hampir semua pesan datang dalam percakapan biasa. </li><li>  Jumlah file unik yang diharapkan dalam satu obrolan adalah ~ 20. </li></ol><br>  Oleh karena itu untuk menampilkan hampir semua pesan, Anda perlu mendapatkan tajuk beberapa file (karena ChatMessageUI diatur sedemikian rupa) dan jumlah total file kecil.  Dalam hal ini, tampaknya masuk akal untuk menerima semua file obrolan dalam satu permintaan.  Untuk melakukan ini, kita harus menambahkan yang berikut ke API kami untuk file: <br><br> <code><font color="7f0055"><b>fun</b></font> <font color="170591"><b>getHeadsByChat</b></font> <font color="000066">()</font> : <font color="3e7eff"><b>List</b></font> <font color="333333">&lt;</font> <font color="3e7eff"><b>FileHeadRemote</b></font> <font color="333333">&gt;</font></code> <br> <br>  Metode getHeadsByChat tidak terlihat terlalu jauh dan dibuat murni karena keinginan kami untuk mengoptimalkan kinerja (walaupun ini juga merupakan alasan yang bagus).  Cukup sering, di ruang obrolan dengan file, pengguna ingin melihat semua file yang digunakan, dan dalam urutan mereka ditambahkan (oleh karena itu, kami menggunakan Daftar). <br><br>  Implementasi koneksi eksplisit semacam itu akan memerlukan penyimpanan informasi tambahan dalam layanan file atau dalam aplikasi kita.  Itu semua tergantung pada bidang tanggung jawab siapa, menurut pendapat kami, informasi yang berlebihan tentang koneksi file dengan obrolan ini harus disimpan.  Itu berlebihan karena pesan sudah dikaitkan dengan file, dan itu, pada gilirannya, dikaitkan dengan obrolan.  Anda tidak dapat menggunakan denormalisasi, tetapi ekstrak informasi ini dengan cepat dari pesan, yaitu, di dalam SQL, segera terima semua file di seluruh obrolan (ini ada di aplikasi kami) dan minta semuanya sekaligus dari layanan file.  Opsi ini akan bekerja lebih buruk jika ada banyak pesan obrolan, tetapi kami tidak perlu denasionalisasi.  Saya akan menyembunyikan kedua opsi di belakang getHeadsByChat. <br><br>  Kode tersebut adalah sebagai berikut: <br><br> <code><font color="7f0055"><b>override fun</b></font> getLast <font color="000066">(</font> <font color="000066"><i>n</i></font> : <font color="3e7eff"><b>Int</b></font> <font color="000066">)</font> <font color="333333">=</font> <br> <font color="566874">messageRepository</font> <font color="333333">.</font> <font color="170591">findLast</font> <font color="000066">(</font> <font color="000066"><i>n</i></font> <font color="000066">)</font> <br> <font color="333333">.</font> <i><b>let</b></i> <font color="000066"><b>{</b></font> <font color="000066"><i>messages</i></font> <font color="000066"><b>-&gt;</b></font> <br> <font color="000066"><b>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</b></font> <i><b>join</b></i> <font color="000066">(</font> <br> <font color="000066"><b>{</b></font> <font color="566874">userRepository</font> <font color="333333">.</font> <font color="170591">getUsersByChat</font> <font color="000066">()</font> <font color="333333">.</font> <i><b>associateBy</b></i> <font color="000066"><b>{</b></font> <font color="000066"><i>it</i></font> <font color="333333">.</font> <font color="566874">id</font> <font color="000066"><b>} }</b></font> <font color="333333">,</font> <br> <font color="000066"><b>{</b></font> <font color="566874">fileRepository</font> <font color="333333">.</font> <font color="170591">getHeadsByChat</font> <font color="000066">()</font> <font color="333333">.</font> <i><b>associateBy</b></i> <font color="000066"><b>{</b></font> <b>it</b> <font color="333333">.</font> <font color="566874">id</font> <font color="000066"><b>} }</b></font> <br> <font color="000066"><b>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</b></font> <font color="000066">)</font> <br> <font color="333333">.</font> <i><b>let</b></i> <font color="000066"><b>{</b></font> <font color="3f7f5f">//    </font> <br> <font color="000066"><b>}</b></font> <br> <font color="000066"><b>}</b></font></code> <br> <br>  Dapat dilihat bahwa dibandingkan dengan versi sebelumnya, sangat sedikit yang berubah dan hanya bagian prefetch yang terpengaruh, yang hebat. <br><br>  Kode prefetch menjadi jauh lebih pendek dan lebih jelas. <br><br>  Waktu eksekusi tidak berubah, yang logis, karena jumlah permintaan tetap sama.  Secara teoritis ada beberapa kemungkinan kasus ketika penskalaan akan lebih baik daripada rekayasa balik yang jujur ‚Äã‚Äã(hanya karena menghapus tautan penghitungan yang rumit).  Namun, situasi yang berlawanan kemungkinannya sama: heuristik terlalu banyak bertengkar.  Seperti yang ditunjukkan oleh praktik, jika Anda berhasil menghasilkan heuristik yang memadai, maka tidak boleh ada perubahan khusus dalam waktu eksekusi. <br><br>  Namun, ini belum semuanya.  Kami tidak memperhitungkan bahwa sekarang menerima data terperinci tentang pengguna dan file tidak terkait dengan menerima pesan dan permintaan dapat diluncurkan secara paralel: <br><br>  Opsi ini memberikan 100 ms stabil per permintaan. <br><br><a name="Mistakes"></a>  <b>Kesalahan Heuristik</b> <br><br>  Bagaimana jika, ketika menggunakan heuristik, set kueri tidak lebih besar, tetapi sedikit lebih kecil dari yang seharusnya?  Untuk sebagian besar opsi, heuristik seperti itu akan berfungsi, tetapi akan ada pengecualian di mana Anda harus membuat permintaan terpisah.  Dalam praktik saya, keputusan seperti itu tidak berhasil, karena setiap pengecualian memiliki dampak besar pada kinerja, dan pada akhirnya beberapa pengguna membuat permintaan yang seluruhnya terdiri dari pengecualian.  Saya akan mengatakan bahwa dalam situasi seperti itu lebih baik menggunakan teknik reverse, bahkan jika algoritma pengumpulan kueri menyeramkan dan tidak dapat dibaca, tetapi, tentu saja, semuanya tergantung pada kekritisan layanan. <br><br><a name="Summary2"></a>  <b>Kesimpulan</b> <br><br>  Pro: <br><br><ol><li>  Logika heuristik bisnis mudah dibaca dan biasanya sepele.  Ini bagus untuk memahami batasan penerapan, memverifikasi dan memodifikasi kontrak prefetch. </li><li>  Skalabilitas sama baiknya dengan teknik terbalik. </li><li>  Koherensi kode atas data berkurang, yang dapat menyebabkan paralelisasi kode yang lebih baik. </li><li>  Logika prefetch, seperti logika utama controller REST, didasarkan pada persyaratan.  Ini adalah nilai tambah yang lemah jika persyaratan sering berubah. </li></ol><br>  Cons: <br><br><ol><li>  Dari persyaratan tidak mudah untuk mendapatkan heuristik untuk prediksi permintaan.  Klarifikasi persyaratan mungkin diperlukan, sejauh yang tidak kompatibel dengan tangkas. </li><li>  Anda bisa mendapatkan data tambahan. </li><li>  Untuk memastikan bahwa kontrak prefetch berfungsi secara efektif, denormalisasi penyimpanan data mungkin akan diperlukan.<font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Ini adalah minus yang lemah, karena optimasi ini mengikuti dari logika bisnis dan karena itu, kemungkinan besar, akan diklaim oleh proses yang berbeda. </font></font></li></ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dari contoh kita, kita dapat menyimpulkan bahwa menerapkan pendekatan ini sangat sulit dan gamenya tidak bernilai lilin. </font><font style="vertical-align: inherit;">Bahkan, dalam proyek bisnis nyata, jumlah pembatasan sangat besar dan dari tumpukan ini Anda sering berhasil mendapatkan sesuatu yang berguna, yang memungkinkan Anda untuk mempartisi data atau memprediksi statistik. </font><font style="vertical-align: inherit;">Keuntungan utama dari pendekatan ini adalah bahwa pembatasan yang digunakan ditafsirkan oleh bisnis, oleh karena itu mereka mudah dipahami dan divalidasi. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Biasanya masalah terbesar ketika mencoba menggunakan pendekatan ini adalah pemisahan kegiatan. </font><font style="vertical-align: inherit;">Pengembang harus tenggelam dalam logika bisnis dan mengajukan pertanyaan analis yang mengklarifikasi pertanyaan, yang memerlukan tingkat inisiatif tertentu.</font></font><br><br><a name="DDDAgregates"></a><h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Unit bergaya DDD </font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dalam proyek besar, Anda sering dapat melihat penggunaan praktik DDD, karena mereka memungkinkan Anda untuk menyusun kode secara efisien. </font><font style="vertical-align: inherit;">Tidak perlu menggunakan semua templat DDD dalam proyek - terkadang Anda bisa mendapatkan pengembalian yang bagus bahkan dari pengenalan satu. </font><font style="vertical-align: inherit;">Pertimbangkan konsep DDD sebagai agregat. </font><font style="vertical-align: inherit;">Agregat adalah penyatuan entitas yang terhubung secara logis, pekerjaan yang dilakukan hanya melalui akar agregat (biasanya ini adalah entitas yang berada di atas grafik konektivitas entitas). </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dari sudut pandang memperoleh data, hal utama dalam agregat adalah bahwa seluruh logika bekerja dengan daftar entitas ada di satu tempat - agregat. </font><font style="vertical-align: inherit;">Ada dua pendekatan untuk apa yang harus ditransfer ke unit selama pembangunannya:</font></font><br><br><ol><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kami mentransfer fungsi ke unit untuk mendapatkan data eksternal. </font><font style="vertical-align: inherit;">Logika untuk menentukan data yang diperlukan tinggal di dalam unit.</font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kami mentransfer semua data yang diperlukan. </font><font style="vertical-align: inherit;">Logika untuk menentukan data yang diperlukan tinggal di luar agregat.</font></font></li></ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pilihan pendekatan sangat tergantung pada seberapa mudah prefetch dapat dipindahkan di luar agregat. </font><font style="vertical-align: inherit;">Jika logika prefetch didasarkan pada heuristik bisnis, biasanya mudah memisahkannya dari agregat. </font><font style="vertical-align: inherit;">Mengambil logika di luar lingkup agregat berdasarkan analisis penggunaannya (rekayasa terbalik) bisa berbahaya, karena kita dapat mendistribusikan kode yang terkait secara logis ke dalam kelas yang berbeda.</font></font><br><br><a name="EnlargementInside"></a> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Logika memperbesar kueri di dalam agregat.</font></font></b> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Mari kita coba membuat sketsa agregat yang sesuai dengan konsep "obrolan". Kelas ChatMessage, UserReference, FileReference kami sesuai dengan model penyimpanan, sehingga dapat diubah namanya dengan beberapa awalan yang sesuai, tetapi kami memiliki proyek kecil, jadi mari kita biarkan apa adanya. Kami menyebutnya Obrolan rakitan, dan komponennya adalah ChatPage dan ChatPageMessage: </font><font style="vertical-align: inherit;">Sejauh ini, cukup banyak duplikasi yang tidak berarti yang diperoleh. Ini karena fakta bahwa model subjek kami mirip dengan model penyimpanan dan keduanya mirip dengan model frontend. </font><font style="vertical-align: inherit;">Saya menggunakan kelas FileHeadRemote dan UserRemote secara langsung, agar tidak menulis terlalu banyak kode, meskipun biasanya dalam domain Anda harus menghindari menggunakan kelas-kelas tersebut secara langsung.</font></font><br><br> <code><font color="7f0055"><b>interface</b></font> <font color="3e7eff"><b>Chat</b></font> <font color="000066">{</font> <br> <font color="7f0055"><b>fun</b></font> <font color="170591"><b>getLastPage</b></font> <font color="000066">(</font> <font color="000066"><i>n</i></font> : <font color="3e7eff"><b>Int</b></font> <font color="000066">)</font> : <font color="3e7eff"><b>ChatPage</b></font> <br> <font color="000066">}</font> <br> <br> <font color="7f0055"><b>interface</b></font> <font color="3e7eff"><b>ChatPage</b></font> <font color="000066">{</font> <br> <font color="7f0055"><b>val</b></font> <font color="566874">messages</font> : <font color="3e7eff"><b>List</b></font> <font color="333333">&lt;</font> <font color="3e7eff"><b>ChatPageMessage</b></font> <font color="333333">&gt;</font> <br> <font color="000066">}</font> <br> <br> <font color="7f0055"><b>data class</b></font> <font color="3e7eff"><b>ChatPageMessage</b></font> <font color="000066">(</font> <br> <font color="7f0055"><b>val</b></font> <font color="566874">id</font> : <font color="3e7eff"><b>Long</b></font> <font color="333333">,</font> <br> <font color="7f0055"><b>val</b></font> <font color="566874">author</font> : <font color="3e7eff"><b>UserRemote</b></font> <font color="333333">,</font> <br> <font color="7f0055"><b>val</b></font> <font color="566874">message</font> : <font color="3e7eff"><b>String</b></font> <font color="333333">,</font> <br> <font color="7f0055"><b>val</b></font> <font color="566874">files</font> : <font color="3e7eff"><b>List</b></font> <font color="333333">&lt;</font> <font color="3e7eff"><b>FileHeadRemote</b></font> <font color="333333">&gt;,</font> <br> <font color="7f0055"><b>val</b></font> <font color="566874">replyTo</font> : <font color="3e7eff"><b>ChatPageMessage</b></font> ? <font color="333333">,</font> <br> <font color="7f0055"><b>val</b></font> <font color="566874">forwardFrom</font> : <font color="3e7eff"><b>ChatPageMessage</b></font> ? <br> <font color="000066">)</font></code> <br> <br><font style="vertical-align: inherit;"></font><br><br><font style="vertical-align: inherit;"></font><br><br>    ,  REST-   : <br><br> <code><font color="7f0055"><b>class</b></font> <font color="3e7eff"><b>ChatRestController</b></font> <font color="000066">(</font> <br> <font color="7f0055"><b>private val</b></font> <font color="566874">chat</font> : <font color="3e7eff"><b>Chat</b></font> <br> <font color="000066">)</font> : <font color="3e7eff"><b>ChatRestApi</b></font> <font color="000066">{</font> <br> <font color="7f0055"><b>override fun</b></font> <font color="170591"><b>getLast</b></font> <font color="000066">(</font> <font color="000066"><i>n</i></font> : <font color="3e7eff"><b>Int</b></font> <font color="000066">)</font> <font color="333333">=</font> <br> <font color="566874">chat</font> <font color="333333">.</font> <font color="170591">getLastPage</font> <font color="000066">(</font> <font color="000066"><i>n</i></font> <font color="000066">)</font> <font color="333333">.</font> <i><b>toFrontModel</b></i> <font color="000066">()</font> <br> <br> <font color="7f0055"><b>private fun</b></font> <font color="3e7eff"><b>ChatPage</b></font> <font color="333333">.</font> <font color="170591"><b>toFrontModel</b></font> <font color="000066">()</font> <font color="333333">=</font> <br> <font color="566874">messages</font> <font color="333333">.</font> <i><b>map</b></i> <font color="000066"><b>{</b></font> <b>it</b> <font color="333333">.</font> <i><b>toFrontModel</b></i> <font color="000066">()</font> <font color="000066"><b>}</b></font> <br> <br> <font color="000066"><b>&nbsp;&nbsp;</b></font> <font color="7f0055"><b>private fun</b></font> <font color="3e7eff"><b>ChatPageMessage</b></font> <font color="333333">.</font> <font color="170591"><b>toFrontModel</b></font> <font color="000066">()</font> : <font color="3e7eff"><b>ChatMessageUI</b></font> <font color="333333">=</font> <br> <font color="170591">ChatMessageUI</font> <font color="000066">(</font> <br> <font color="4a86e8">id =</font> <font color="566874">id</font> <font color="333333">,</font> <br> <font color="4a86e8">author =</font> <font color="566874">author</font> <font color="333333">.</font> <i><b>toFrontReference</b></i> <font color="000066">()</font> <font color="333333">,</font> <br> <font color="4a86e8">message =</font> <font color="566874">message</font> <font color="333333">,</font> <br> <font color="4a86e8">files =</font> <font color="566874">files</font> <font color="333333">.</font> <i><b>toFrontReference</b></i> <font color="000066">()</font> <font color="333333">,</font> <br> <font color="4a86e8">forwardFrom =</font> <font color="566874">forwardFrom</font> <font color="333333">?.</font> <i><b>toFrontModel</b></i> <font color="000066">()</font> <font color="333333">,</font> <br> <font color="4a86e8">replyTo =</font> <font color="566874">replyTo</font> <font color="333333">?.</font> <i><b>toFrontModel</b></i> <font color="000066">()</font> <br> <font color="000066">)</font> <br> <font color="000066">}</font></code> <br> <br>         ,      :            ,    ,     ,    .  ,   prefetch    .        ,        (Single Responsibility Principle, SRP). <br><br>  ,         . <br><br><div class="spoiler"> <b class="spoiler_title">    ,    -.</b> <div class="spoiler_text"> <code><font color="7f0055"><b>class</b></font> <font color="3e7eff"><b>ChatImpl</b></font> <font color="000066">(</font> <br> <font color="7f0055"><b>private val</b></font> <font color="566874">messageRepository</font> : <font color="3e7eff"><b>ChatMessageRepository</b></font> <font color="333333">,</font> <br> <font color="7f0055"><b>private val</b></font> <font color="566874">userRepository</font> : <font color="3e7eff"><b>UserRemoteApi</b></font> <font color="333333">,</font> <br> <font color="7f0055"><b>private val</b></font> <font color="566874">fileRepository</font> : <font color="3e7eff"><b>FileRemoteApi</b></font> <br> <font color="000066">)</font> : <font color="3e7eff"><b>Chat</b></font> <font color="000066">{</font> <br> <font color="7f0055"><b>override fun</b></font> <font color="170591"><b>getLastPage</b></font> <font color="000066">(</font> <font color="000066"><i>n</i></font> : <font color="3e7eff"><b>Int</b></font> <font color="000066">)</font> <font color="333333">=</font> <font color="7f0055"><b>object</b></font> : <font color="3e7eff"><b>ChatPage</b></font> <font color="000066">{</font> <br> <font color="7f0055"><b>override val</b></font> <font color="566874">messages</font> : <font color="3e7eff"><b>List</b></font> <font color="333333">&lt;</font> <font color="3e7eff"><b>ChatPageMessage</b></font> <font color="333333">&gt;</font> <br> <font color="7f0055"><b>get</b></font> <font color="000066">()</font> <font color="333333">=</font> <br> <i><b>runBlocking</b></i> <font color="000066">(</font> <font color="05314d"><b>IO</b></font> <font color="000066">)</font> <font color="000066"><b>{</b></font> <br> <font color="000066"><b>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</b></font> <font color="7f0055"><b>val</b></font> <font color="170591">prefetch</font> <font color="333333">=</font> <i><b>async</b></i> <font color="000066">(</font> <br> <font color="000066"><b>{</b></font> <font color="566874">userRepository</font> <font color="333333">.</font> <font color="170591">getUsersByChat</font> <font color="000066">()</font> <font color="333333">.</font> <i><b>associateBy</b></i> <font color="000066"><b>{</b></font> <b>it</b> <font color="333333">.</font> <font color="566874">id</font> <font color="000066"><b>} }</b></font> <font color="333333">,</font> <br> <font color="000066"><b>{</b></font> <font color="566874">fileRepository</font> <font color="333333">.</font> <font color="170591">getHeadsByChat</font> <font color="000066">()</font> <font color="333333">.</font> <i><b>associateBy</b></i> <font color="000066"><b>{</b></font> <font color="000066"><i>it</i></font> <font color="333333">.</font> <font color="566874">id</font> <font color="000066"><b>} }</b></font> <br> <font color="000066"><b>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</b></font> <font color="000066">)</font> <br> <br> <i><b>withContext</b></i> <font color="000066">(</font> <font color="05314d"><b>IO</b></font> <font color="000066">)</font> <font color="000066"><b>{</b></font> <font color="566874">messageRepository</font> <font color="333333">.</font> <font color="170591">findLast</font> <font color="000066">(</font> <font color="3e7eff"><b>n</b></font> <font color="000066">)</font> <font color="000066"><b>}</b></font> <br> <font color="000066"><b>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</b></font> <font color="333333">.</font> <i><b>map</b></i> <font color="000066">(</font> <br> <font color="170591">prefetch</font> <font color="333333">.</font> <font color="170591">await</font> <font color="000066">()</font> <font color="333333">.</font> <i><b>let</b></i> <font color="000066"><b>{</b></font> <font color="000066">(</font> <font color="170591">users</font> <font color="333333">,</font> <font color="170591">files</font> <font color="000066">)</font> <font color="000066"><b>-&gt;</b></font> <br> <font color="000066"><b>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</b></font> <i><b>recursiveMemoize</b></i> <font color="000066"><b>{</b></font> <font color="000066"><i>message</i></font> <font color="333333">,</font> <font color="000066"><i>memoized</i></font> : <font color="000066">(</font> <font color="3e7eff"><b>ChatMessage</b></font> <font color="000066">) -&gt;</font> <font color="3e7eff"><b>ChatPageMessage</b></font> <font color="000066"><b>-&gt;</b></font> <br> <font color="000066"><b>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</b></font> <font color="000066"><i>message</i></font> <font color="333333">.</font> <i><b>toDomainModel</b></i> <font color="000066">(</font> <br> <font color="4a86e8">getUser =</font> <font color="170591">users</font> ::get <font color="333333">.</font> <i><b>orThrow</b></i> <font color="000066"><b>{</b></font> <font color="170591">IllegalArgumentException</font> <font color="000066">(</font> <b>"User</b> <font color="333333"><b>$</b></font> <font color="000066"><i>it</i></font> <b>"</b> <font color="000066">)</font> <font color="000066"><b>}</b></font> <font color="333333">,</font> <br> <font color="4a86e8">getFile =</font> <font color="170591">files</font> ::get <font color="333333">.</font> <i><b>orThrow</b></i> <font color="000066"><b>{</b></font> <font color="170591">IllegalArgumentException</font> <font color="000066">(</font> <b>"File</b> <font color="333333"><b>$</b></font> <font color="000066"><i>it</i></font> <b>"</b> <font color="000066">)</font> <font color="000066"><b>}</b></font> <font color="333333">,</font> <br> <font color="3f7f5f">//       </font> <br> <font color="4a86e8">serializeMessage =</font> <font color="000066"><i>memoized</i></font> <br> <font color="000066"><i>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</i></font> <font color="000066">)</font> <br> <font color="000066"><b>}</b></font> <br> <font color="000066"><b>}</b></font> <br> <font color="000066"><b>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</b></font> <font color="000066">)</font> <br> <font color="000066"><b>}</b></font> <br> <font color="000066"><b>&nbsp;&nbsp;</b></font> <font color="000066">}</font> <br> <font color="000066">}</font> <br> <br> <font color="7f0055"><b>private fun</b></font> <font color="3e7eff"><b>ChatMessage</b></font> <font color="333333">.</font> <font color="170591"><b>toDomainModel</b></font> <font color="000066">(</font> <br> <font color="000066"><i>getUser</i></font> : <font color="000066">(</font> <font color="3e7eff"><b>UserReference</b></font> <font color="000066">) -&gt;</font> <font color="3e7eff"><b>UserRemote</b></font> <font color="333333">,</font> <br> <font color="000066"><i>getFile</i></font> : <font color="000066">(</font> <font color="3e7eff"><b>FileReference</b></font> <font color="000066">) -&gt;</font> <font color="3e7eff"><b>FileHeadRemote</b></font> <font color="333333">,</font> <br> <font color="000066"><i>serializeMessage</i></font> : <font color="000066">(</font> <font color="3e7eff"><b>ChatMessage</b></font> <font color="000066">) -&gt;</font> <font color="3e7eff"><b>ChatPageMessage</b></font> <br> <font color="000066">)</font> <font color="333333">=</font> <font color="170591">ChatPageMessage</font> <font color="000066">(</font> <br> <font color="4a86e8">id =</font> <font color="566874">id</font> ?: <font color="7f0055"><b>throw</b></font> <font color="170591">IllegalStateException</font> <font color="000066">(</font> <b>"</b> <font color="333333"><b>$</b></font> <font color="7f0055"><b>this</b></font> <b>must be persisted"</b> <font color="000066">)</font> <font color="333333">,</font> <br> <font color="4a86e8">author =</font> <font color="000066"><i>getUser</i></font> <font color="000066">(</font> <font color="566874">author</font> <font color="000066">)</font> <font color="333333">,</font> <br> <font color="4a86e8">message =</font> <font color="566874">message</font> <font color="333333">,</font> <br> <font color="4a86e8">files =</font> <font color="566874">files</font> <font color="333333">?.</font> <i><b>map</b></i> <font color="000066">(</font> <font color="000066"><i>getFile</i></font> <font color="000066">)</font> ?: <i><b>listOf</b></i> <font color="000066">()</font> <font color="333333">,</font> <br> <font color="4a86e8">forwardFrom =</font> <font color="566874">forwardFrom</font> <font color="333333">?.</font> <i><b>let</b></i> <font color="000066">(</font> <font color="000066"><i>serializeMessage</i></font> <font color="000066">)</font> <font color="333333">,</font> <br> <font color="4a86e8">replyTo =</font> <font color="566874">replyTo</font> <font color="333333">?.</font> <i><b>let</b></i> <font color="000066">(</font> <font color="000066"><i>serializeMessage</i></font> <font color="000066">)</font> <br> <font color="000066">)</font> <br></code> </div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ternyata fungsi getLastPage itu sendiri memiliki strategi akuisisi data, termasuk prefetch, dan fungsi toDomainModel adalah murni teknis dan bertanggung jawab untuk mengubah model yang tersimpan menjadi model domain. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Saya menulis ulang panggilan paralel ke userRepository, fileRepository, dan messageRepository dalam bentuk yang lebih akrab bagi Kotlin. Saya berharap kelengkapan kode tidak menderita karena ini. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Secara umum, metode seperti itu sudah berfungsi penuh, kinerja ketika menerapkannya akan sama dengan penggunaan sederhana teknik terbalik atau heuristik bisnis.</font></font><br><br><a name="EnlargementOutside"></a> <b>    </b> <br><br>          :   ChatPage          Chat,      getLast(),  .     : <br><br> <code><font color="7f0055"><b>interface</b></font> <font color="3e7eff"><b>Chat</b></font> <font color="000066">{</font> <br> <font color="7f0055"><b>fun</b></font> <font color="170591"><b>getPage</b></font> <font color="000066">()</font> : <font color="3e7eff"><b>ChatPage</b></font> <br> <font color="000066">}</font></code> <br> <br>                 ,        Chat    ChatPage: <br><br> <code><font color="7f0055"><b>class</b></font> <font color="3e7eff"><b>ChatPageImpl</b></font> <font color="000066">(</font> <br> <font color="7f0055"><b>private val</b></font> <font color="566874">messageData</font> : <font color="3e7eff"><b>List</b></font> <font color="333333">&lt;</font> <font color="3e7eff"><b>ChatMessage</b></font> <font color="333333">&gt;,</font> <br> <font color="7f0055"><b>private val</b></font> <font color="566874">userData</font> : <font color="3e7eff"><b>List</b></font> <font color="333333">&lt;</font> <font color="3e7eff"><b>UserRemote</b></font> <font color="333333">&gt;,</font> <br> <font color="7f0055"><b>private val</b></font> <font color="566874">fileData</font> : <font color="3e7eff"><b>List</b></font> <font color="333333">&lt;</font> <font color="3e7eff"><b>FileHeadRemote</b></font> <font color="333333">&gt;</font> <br> <font color="000066">)</font> : <font color="3e7eff"><b>ChatPage</b></font> <font color="000066">{</font> <br> <font color="7f0055"><b>override val</b></font> <font color="566874">messages</font> : <font color="3e7eff"><b>List</b></font> <font color="333333">&lt;</font> <font color="3e7eff"><b>ChatPageMessage</b></font> <font color="333333">&gt;</font> <br> <font color="7f0055"><b>get</b></font> <font color="000066">()</font> <font color="333333">=</font> <br> <font color="566874">messageData</font> <font color="333333">.</font> <i><b>map</b></i> <font color="000066">(</font> <br> <font color="000066">(</font> <font color="566874">userData</font> <font color="333333">.</font> <i><b>associateBy</b></i> <font color="000066"><b>{</b></font> <b>it</b> <font color="333333">.</font> <font color="566874">id</font> <font color="000066"><b>}</b></font> <i><b>to</b></i> <font color="566874">fileData</font> <font color="333333">.</font> <i><b>associateBy</b></i> <font color="000066"><b>{</b></font> <font color="000066"><i>it</i></font> <font color="333333">.</font> <font color="566874">id</font> <font color="000066"><b>}</b></font> <font color="000066">)</font> <br> <font color="333333">.</font> <i><b>let</b></i> <font color="000066"><b>{</b></font> <font color="000066">(</font> <font color="170591">users</font> <font color="333333">,</font> <font color="170591">files</font> <font color="000066">)</font> <font color="000066"><b>-&gt;</b></font> <br> <font color="000066"><b>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</b></font> <i><b>recursiveMemoize</b></i> <font color="000066"><b>{</b></font> <font color="000066"><i>message</i></font> <font color="333333">,</font> <font color="000066"><i>self</i></font> : <font color="000066">(</font> <font color="3e7eff"><b>ChatMessage</b></font> <font color="000066">) -&gt;</font> <font color="3e7eff"><b>ChatPageMessage</b></font> <font color="000066"><b>-&gt;</b></font> <br> <font color="000066"><b>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</b></font> <font color="000066"><i>message</i></font> <font color="333333">.</font> <i><b>toDomainModel</b></i> <font color="000066">(</font> <br> <font color="4a86e8">getUser =</font> <font color="170591">users</font> ::get <font color="333333">.</font> <i><b>orThrow</b></i> <font color="000066">()</font> <font color="333333">,</font> <br> <font color="4a86e8">getFile =</font> <font color="170591">files</font> ::get <font color="333333">.</font> <i><b>orThrow</b></i> <font color="000066">()</font> <font color="333333">,</font> <br> <font color="3f7f5f">//       </font> <br> <font color="4a86e8">serializeMessage =</font> <font color="000066"><i>self</i></font> <br> <font color="000066"><i>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</i></font> <font color="000066">)</font> <br> <font color="000066"><b>}</b></font> <br> <font color="000066"><b>}</b></font> <br> <font color="000066"><b>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</b></font> <font color="000066">)</font> <br> <font color="000066">}</font></code> <br> <br>     prefetch,   : <br><br> <code><font color="7f0055"><b>fun</b></font> <font color="170591"><b>chatPagePrefetch</b></font> <font color="000066">(</font> <br> <font color="000066"><i>pageSize</i></font> : <font color="3e7eff"><b>Int</b></font> <font color="333333">,</font> <br> <font color="000066"><i>messageRepository</i></font> : <font color="3e7eff"><b>ChatMessageRepository</b></font> <font color="333333">,</font> <br> <font color="000066"><i>userRepository</i></font> : <font color="3e7eff"><b>UserRemoteApi</b></font> <font color="333333">,</font> <br> <font color="000066"><i>fileRepository</i></font> : <font color="3e7eff"><b>FileRemoteApi</b></font> <br> <font color="000066">)</font> <font color="333333">=</font> <br> <i><b>runBlocking</b></i> <font color="000066">(</font> <font color="05314d"><b>IO</b></font> <font color="000066">)</font> <font color="000066"><b>{</b></font> <br> <font color="000066"><b>&nbsp;&nbsp;&nbsp;&nbsp;</b></font> <i><b>async</b></i> <font color="000066">(</font> <br> <font color="000066"><b>{</b></font> <font color="3e7eff"><b>userRepository</b></font> <font color="333333">.</font> <font color="170591">getUsersByChat</font> <font color="000066">()</font> <font color="000066"><b>}</b></font> <font color="333333">,</font> <br> <font color="000066"><b>{</b></font> <font color="3e7eff"><b>fileRepository</b></font> <font color="333333">.</font> <font color="170591">getHeadsByChat</font> <font color="000066">()</font> <font color="000066"><b>}</b></font> <font color="333333">,</font> <br> <font color="000066"><b>{</b></font> <font color="3e7eff"><b>messageRepository</b></font> <font color="333333">.</font> <font color="170591">findLast</font> <font color="000066">(</font> <font color="3e7eff"><b>pageSize</b></font> <font color="000066">)</font> <font color="000066"><b>}</b></font> <br> <font color="000066"><b>&nbsp;&nbsp;&nbsp;&nbsp;</b></font> <font color="000066">)</font> <br> <font color="000066"><b>}</b></font></code> <br> <br>   ,   ,     prefetch.  DDD     Application Services. <br><br> <code><font color="7f0055"><b>class</b></font> <font color="3e7eff"><b>ChatService</b></font> <font color="000066">(</font> <br> <font color="7f0055"><b>private val</b></font> <font color="566874">messageRepository</font> : <font color="3e7eff"><b>ChatMessageRepository</b></font> <font color="333333">,</font> <br> <font color="7f0055"><b>private val</b></font> <font color="566874">userRepository</font> : <font color="3e7eff"><b>UserRemoteApi</b></font> <font color="333333">,</font> <br> <font color="7f0055"><b>private val</b></font> <font color="566874">fileRepository</font> : <font color="3e7eff"><b>FileRemoteApi</b></font> <br> <font color="000066">) {</font> <br> <font color="7f0055"><b>private fun</b></font> <font color="170591"><b>chatPagePrefetch</b></font> <font color="000066">(</font> <font color="000066"><i>pageSize</i></font> : <font color="3e7eff"><b>Int</b></font> <font color="000066">)</font> <font color="333333">=</font> <br> <i><b>runBlocking</b></i> <font color="000066">(</font> <font color="05314d"><b>IO</b></font> <font color="000066">)</font> <font color="000066"><b>{</b></font> <br> <font color="000066"><b>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</b></font> <i><b>async</b></i> <font color="000066">(</font> <br> <font color="000066"><b>{</b></font> <font color="566874">messageRepository</font> <font color="333333">.</font> <font color="170591">findLast</font> <font color="000066">(</font> <font color="3e7eff"><b>pageSize</b></font> <font color="000066">)</font> <font color="000066"><b>}</b></font> <font color="333333">,</font> <br> <font color="000066"><b>{</b></font> <font color="566874">userRepository</font> <font color="333333">.</font> <font color="170591">getUsersByChat</font> <font color="000066">()</font> <font color="000066"><b>}</b></font> <font color="333333">,</font> <br> <font color="000066"><b>{</b></font> <font color="566874">fileRepository</font> <font color="333333">.</font> <font color="170591">getHeadsByChat</font> <font color="000066">()</font> <font color="000066"><b>}</b></font> <br> <font color="000066"><b>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</b></font> <font color="000066">)</font> <font color="333333">.</font> <font color="170591">await</font> <font color="000066">()</font> <br> <font color="000066"><b>}</b></font> <br> <br> <font color="000066"><b>&nbsp;&nbsp;</b></font> <font color="7f0055"><b>fun</b></font> <font color="170591"><b>getLastPage</b></font> <font color="000066">(</font> <font color="000066"><i>n</i></font> : <font color="3e7eff"><b>Int</b></font> <font color="000066">)</font> : <font color="3e7eff"><b>ChatPage</b></font> <font color="333333">=</font> <br> <font color="170591">chatPagePrefetch</font> <font color="000066">(</font> <font color="000066"><i>n</i></font> <font color="000066">)</font> <br> <font color="333333">.</font> <i><b>let</b></i> <font color="000066"><b>{</b></font> <font color="000066">(</font> <font color="170591">messageData</font> <font color="333333">,</font> <font color="170591">userData</font> <font color="333333">,</font> <font color="170591">fileData</font> <font color="000066">)</font> <font color="000066"><b>-&gt;</b></font> <br> <font color="000066"><b>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</b></font> <font color="170591">ChatPageImpl</font> <font color="000066">(</font> <font color="170591">messageData</font> <font color="333333">,</font> <font color="170591">userData</font> <font color="333333">,</font> <font color="170591">fileData</font> <font color="000066">)</font> <br> <font color="000066"><b>}</b></font> <br> <font color="000066">}</font></code> <br> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nah, pengontrolnya tidak akan banyak berubah, Anda hanya perlu menggunakan ChatService :: getLastPage alih-alih Chat :: getLastPage. </font><font style="vertical-align: inherit;">Artinya, kode akan berubah seperti ini:</font></font><br><br> <code><font color="7f0055"><b>class</b></font> ChatRestController <font color="000066">(</font> <br> <font color="7f0055"><b>private val</b></font> <font color="566874">chat</font> : <font color="3e7eff"><b>ChatService</b></font> <br> <font color="000066">)</font> : <font color="3e7eff"><b>ChatRestApi</b></font> <br></code> <br><br><a name="Summary3"></a>  <b>Kesimpulan</b> <br><br><ol><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Log prefetch dapat ditempatkan di dalam unit atau di tempat yang terpisah. </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Jika logika prefetch sangat terkait dengan logika internal agregat, lebih baik untuk tidak mengeluarkannya, karena ini dapat mengganggu enkapsulasi. </font><font style="vertical-align: inherit;">Saya pribadi tidak melihat banyak gunanya memindahkan prefetch dari agregat, karena ini sangat membatasi kemungkinan dan meningkatkan koherensi kode secara implisit.</font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Organisasi agregat sendiri memiliki efek positif pada kinerja pemrosesan batch, karena kontrol atas permintaan besar menjadi lebih dan tempat untuk logika prefetch menjadi sangat jelas. </font></font></li></ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Pada bab selanjutnya, kami akan mempertimbangkan implementasi prefetch yang tidak dapat diimplementasikan secara terpisah dari fungsi utama. </font></font><br><br><a name="Proxying"></a><h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Proxy dan panggilan ganda </font></font></h4><br><a name="ManagingContractProblem2"></a> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Memecahkan masalah kontrak</font></font></b> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Seperti yang telah kita lihat di bagian sebelumnya, masalah utama kontrak prefetch adalah bahwa ia sangat terkait dengan kontrak fungsi yang harus disiapkan datanya. </font><font style="vertical-align: inherit;">Untuk lebih tepatnya, itu tergantung pada data apa fungsi utama mungkin perlu. </font><font style="vertical-align: inherit;">Bagaimana jika kita tidak mencoba untuk memprediksi, tetapi mencoba melakukan rekayasa balik menggunakan kode itu sendiri? </font><font style="vertical-align: inherit;">Dalam situasi sederhana, pendekatan proksi yang biasa digunakan dalam pengujian dapat membantu kami. </font><font style="vertical-align: inherit;">Perpustakaan seperti Mockito menghasilkan kelas dengan implementasi antarmuka, yang juga dapat mengakumulasi informasi tentang panggilan. </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pendekatan serupa digunakan di perpustakaan kami</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Jika Anda memanggil fungsi utama dengan repositori proksi dan mengumpulkan informasi tentang data yang diperlukan, maka Anda dapat memperoleh data ini dalam bentuk paket dan memanggil kembali fungsi utama untuk mendapatkan hasil akhir. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kondisi utama adalah sebagai berikut: data yang diminta tidak boleh mempengaruhi permintaan berikutnya. Proxy tidak akan mengembalikan data nyata, tetapi hanya beberapa bertopik, sehingga semua yang bercabang dan menerima data yang terkait menghilang. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dalam kasus kami, ini berarti bahwa tidak berguna untuk mempostingkan repositori messageRep, karena permintaan lebih lanjut dibuat berdasarkan hasil dari permintaan pesan. Ini bukan masalah, karena kami hanya punya satu permintaan untuk messageRepository, jadi tidak diperlukan pemrosesan batch di sini.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Karena kami akan mem-proksi fungsi sederhana UserReference-&gt; UserRemote dan FileReference-&gt; FileHeadRemote, Anda hanya perlu mengumpulkan dua daftar argumen. </font></font><br><br><div class="spoiler"> <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hasilnya, kami mendapatkan yang berikut:</font></font></b> <div class="spoiler_text"> <code><font color="7f0055"><b>class</b></font> <font color="3e7eff"><b>ChatRestController</b></font> <font color="000066">(</font> <br> <font color="7f0055"><b>private val</b></font> <font color="566874">messageRepository</font> : <font color="3e7eff"><b>ChatMessageRepository</b></font> <font color="333333">,</font> <br> <font color="7f0055"><b>private val</b></font> <font color="566874">userRepository</font> : <font color="3e7eff"><b>UserRemoteApi</b></font> <font color="333333">,</font> <br> <font color="7f0055"><b>private val</b></font> <font color="566874">fileRepository</font> : <font color="3e7eff"><b>FileRemoteApi</b></font> <br> <font color="000066">)</font> : <font color="3e7eff"><b>ChatRestApi</b></font> <font color="000066">{</font> <br> <font color="7f0055"><b>override fun</b></font> <font color="170591"><b>getLast</b></font> <font color="000066">(</font> <font color="000066"><i>n</i></font> : <font color="3e7eff"><b>Int</b></font> <font color="000066">)</font> : <font color="3e7eff"><b>List</b></font> <font color="333333">&lt;</font> <font color="3e7eff"><b>ChatMessageUI</b></font> <font color="333333">&gt;</font> <font color="000066">{</font> <br> <font color="7f0055"><b>val</b></font> <font color="170591">messages</font> <font color="333333">=</font> <font color="566874">messageRepository</font> <font color="333333">.</font> <font color="170591">findLast</font> <font color="000066">(</font> <font color="000066"><i>n</i></font> <font color="000066">)</font> <br> <br> <font color="3f7f5f">//    </font> <br> <font color="7f0055"><b>fun</b></font> <font color="170591"><b>transform</b></font> <font color="000066">(</font> <br> <font color="000066"><i>getUser</i></font> : <font color="000066">(</font> <font color="3e7eff"><b>UserReference</b></font> <font color="000066">) -&gt;</font> <font color="3e7eff"><b>UserRemote</b></font> <font color="333333">,</font> <br> <font color="000066"><i>getFile</i></font> : <font color="000066">(</font> <font color="3e7eff"><b>FileReference</b></font> <font color="000066">) -&gt;</font> <font color="3e7eff"><b>FileHeadRemote</b></font> <br> <font color="3e7eff"><b>&nbsp;&nbsp;&nbsp;&nbsp;</b></font> <font color="000066">)</font> : <font color="3e7eff"><b>List</b></font> <font color="333333">&lt;</font> <font color="3e7eff"><b>ChatMessageUI</b></font> <font color="333333">&gt; =</font> <br> <font color="3e7eff"><b>messages</b></font> <font color="333333">.</font> <i><b>map</b></i> <font color="000066">(</font> <br> <i><b>recursiveMemoize</b></i> <font color="000066"><b>{</b></font> <font color="000066"><i>message</i></font> <font color="333333">,</font> <font color="000066"><i>self</i></font> <font color="000066"><b>-&gt;</b></font> <br> <font color="000066"><b>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</b></font> <font color="000066"><i>message</i></font> <font color="333333">.</font> <i><b>toFrontModel</b></i> <font color="000066">(</font> <font color="000066"><i>getUser</i></font> <font color="333333">,</font> <font color="000066"><i>getFile</i></font> <font color="333333">,</font> <font color="000066"><i>self</i></font> <font color="000066">)</font> <br> <font color="000066"><b>}</b></font> <br> <font color="000066"><b>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</b></font> <font color="000066">)</font> <br> <br> <font color="3f7f5f">//  </font> <br> <font color="7f0055"><b>val</b></font> <font color="170591">userIds</font> <font color="333333">=</font> <i><b>mutableSetOf</b></i> <font color="333333">&lt;</font> <font color="3e7eff"><b>UserReference</b></font> <font color="333333">&gt;</font> <font color="000066">()</font> <br> <font color="7f0055"><b>val</b></font> <font color="170591">fileIds</font> <font color="333333">=</font> <i><b>mutableSetOf</b></i> <font color="333333">&lt;</font> <font color="3e7eff"><b>FileReference</b></font> <font color="333333">&gt;</font> <font color="000066">()</font> <br> <font color="170591">transform</font> <font color="000066">(</font> <br> <font color="000066"><b>{</b></font> <font color="3e7eff"><b>userIds</b></font> <font color="333333">+=</font> <b>it</b> <font color="333333">;</font> <font color="170591">UserRemote</font> <font color="000066">(</font> <font color="333333"><b>0L</b></font> <font color="333333">,</font> <b>""</b> <font color="000066">)</font> <font color="000066"><b>}</b></font> <font color="333333">,</font> <br> <font color="000066"><b>{</b></font> <font color="3e7eff"><b>fileIds</b></font> <font color="333333">+=</font> <font color="000066"><i>it</i></font> <font color="333333">;</font> <font color="170591">FileHeadRemote</font> <font color="000066">(</font> <font color="333333"><b>0L</b></font> <font color="333333">,</font> <b>""</b> <font color="000066">)</font> <font color="000066"><b>}</b></font> <br> <font color="000066"><b>&nbsp;&nbsp;&nbsp;&nbsp;</b></font> <font color="000066">)</font> <br> <br> <font color="7f0055"><b>return</b></font> <i><b>runBlocking</b></i> <font color="000066">(</font> <font color="05314d"><b>IO</b></font> <font color="000066">)</font> <font color="000066"><b>{</b></font> <br> <font color="000066"><b>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</b></font> <font color="3f7f5f">//      </font> <br> <i><b>async</b></i> <font color="000066">(</font> <br> <font color="000066"><b>{</b></font> <font color="566874">userRepository</font> <font color="333333">.</font> <font color="170591">getUsersByIds</font> <font color="000066">(</font> <font color="3e7eff"><b>userIds</b></font> <font color="000066">)</font> <font color="333333">.</font> <i><b>associateBy</b></i> <font color="000066"><b>{</b></font> <font color="000066"><i>it</i></font> <font color="333333">.</font> <font color="566874">id</font> <font color="000066"><b>}</b></font> ::get <font color="333333">.</font> <i><b>orThrow</b></i> <font color="000066">()</font> <font color="000066"><b>}</b></font> <font color="333333">,</font> <br> <font color="000066"><b>{</b></font> <font color="566874">fileRepository</font> <font color="333333">.</font> <font color="170591">getHeadsByIds</font> <font color="000066">(</font> <font color="3e7eff"><b>fileIds</b></font> <font color="000066">)</font> <font color="333333">.</font> <i><b>associateBy</b></i> <font color="000066"><b>{</b></font> <font color="000066"><i>it</i></font> <font color="333333">.</font> <font color="566874">id</font> <font color="000066"><b>}</b></font> ::get <font color="333333">.</font> <i><b>orThrow</b></i> <font color="000066">()</font> <font color="000066"><b>}</b></font> <br> <font color="000066"><b>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</b></font> <font color="000066">)</font> <font color="333333">.</font> <font color="170591">await</font> <font color="000066">()</font> <font color="333333">.</font> <i><b>let</b></i> <font color="000066"><b>{</b></font> <font color="000066">(</font> <font color="170591">getUser</font> <font color="333333">,</font> <font color="170591">getFile</font> <font color="000066">)</font> <font color="000066"><b>-&gt;</b></font> <br> <font color="000066"><b>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</b></font> <font color="170591">transform</font> <font color="000066">(</font> <font color="170591">getUser</font> <font color="333333">,</font> <font color="170591">getFile</font> <font color="000066">)</font> <br> <font color="000066"><b>}</b></font> <br> <font color="000066"><b>}</b></font> <br> <font color="000066"><b>&nbsp;&nbsp;</b></font> <font color="000066">}</font> <br> <font color="000066">}</font></code> </div> </div><br>   , ,       ,     -,      .    ,        ,       (  ). <br><br>       -,         .   ,        . ,       ,    ,         ,     -        . <br><br><a name="Summary4"></a>  <b>Kesimpulan</b> <br><br>  Pro: <br><br><ol><li>   prefetch   -   . </li><li>          prefetch. </li><li>    ,   -. </li></ol><br>  Cons: <br><br><ol><li>       . </li><li>  ,     . </li></ol><br>    ,           ,         .     ,   -:      ,       (   ,         ). <br><br>   ,    prefetch         . <br><br>    ,      -   ,   prefetch    . <br><br><a name="Conclusion"></a><h2>  Kesimpulan </h2><br>      ,     . ,       ( ). <br><br>              ,     .  :           (  ,       ), ,    ,           . <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cara yang paling jelas untuk menumpuk kueri adalah membalikkan kode yang ada untuk mencari kueri berat. </font><font style="vertical-align: inherit;">Kelemahan utama dari pendekatan ini adalah peningkatan konektivitas kode implisit. </font><font style="vertical-align: inherit;">Alternatifnya adalah dengan menggunakan informasi tentang fitur bisnis untuk membagi data menjadi potongan-potongan, yang sering dibagi dan keseluruhan. </font><font style="vertical-align: inherit;">Kadang-kadang, untuk pemisahan yang efektif seperti itu, perlu untuk mendenormalkan penyimpanan, tetapi jika ini berhasil, logika pemrosesan batch akan ditentukan oleh area subjek, yang bagus. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cara yang tidak terlalu jelas untuk mendapatkan semua permintaan adalah dengan menerapkan dua pass. </font><font style="vertical-align: inherit;">Pada tahap pertama, kami mengumpulkan semua permintaan yang diperlukan, pada tahap kedua kami bekerja dengan data yang sudah diterima. </font><font style="vertical-align: inherit;">Penerapan pendekatan ini dibatasi oleh persyaratan independensi permintaan satu sama lain.</font></font></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/id467919/">https://habr.com/ru/post/id467919/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../id467907/index.html">Pro dan kontra dari outsourcing</a></li>
<li><a href="../id467909/index.html">Obrolan di iOS: menggunakan soket</a></li>
<li><a href="../id467913/index.html">Cara meningkatkan "mineral bajingan", atau antarmuka baru untuk panel surya</a></li>
<li><a href="../id467915/index.html">Memantau postgres di dalam OpenShift</a></li>
<li><a href="../id467917/index.html">Template Manajemen</a></li>
<li><a href="../id467921/index.html">Keluarkan pulpen berdebu: tulisan tangan baik untuk otak</a></li>
<li><a href="../id467923/index.html">Jadi, Anda ingin menjadi seorang analis di bidang keamanan jaringan ...</a></li>
<li><a href="../id467929/index.html">Kami mengatur kekacauan atau cara menerapkan pendekatan proses dalam suatu organisasi</a></li>
<li><a href="../id467933/index.html">Namun, mengapa Posit adalah alternatif yang layak untuk IEEE 754</a></li>
<li><a href="../id467935/index.html">Ulasan perekam Edic Weeny A110 dengan fungsi "kotak hitam"</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>