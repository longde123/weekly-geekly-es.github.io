<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>   M贸nada "Tal vez" a trav茅s de as铆ncrono / espera en C # (隆Sin tareas!)   </title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Tipos de retorno as铆ncrono generalizado : es una nueva caracter铆stica de C # 7 que permite usar no solo la Tarea como un tipo de retorno de m茅todos as...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>M贸nada "Tal vez" a trav茅s de as铆ncrono / espera en C # (隆Sin tareas!)</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/458692/"><p><img src="https://habrastorage.org/webt/3n/zz/tw/3nzztwahkcl-ppecyzowprupvym.jpeg"></p><br><p>  <strong>Tipos de retorno as铆ncrono generalizado</strong> : es una nueva caracter铆stica de C # 7 que permite usar no solo la <strong>Tarea</strong> como un tipo de retorno de m茅todos <strong>as铆ncronos</strong> , sino tambi茅n otros tipos (clases o estructuras) que satisfacen algunos requisitos espec铆ficos. </p><br><p>  Al mismo tiempo, <strong>async / await</strong> es una forma de llamar a un conjunto de funciones de "continuaci贸n" dentro de un contexto que es la esencia de otro patr贸n de dise帽o: <strong>Monad</strong> .  Entonces, 驴podemos usar <strong>async / await</strong> para escribir un c贸digo que se comportar谩 de la misma manera que si us谩ramos m贸nadas?  Resulta que s铆 (con algunas reservas).  Por ejemplo, el siguiente c贸digo es compilable y funciona: </p><br><pre><code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">async</span></span></span><span class="hljs-function"> Task </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Main</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> s <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span>[] { <span class="hljs-string"><span class="hljs-string">"1,2"</span></span>, <span class="hljs-string"><span class="hljs-string">"3,7,1"</span></span>, <span class="hljs-literal"><span class="hljs-literal">null</span></span>, <span class="hljs-string"><span class="hljs-string">"1"</span></span> }) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> res = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> Sum(s).GetMaybeResult(); Console.WriteLine(res.IsNothing ? <span class="hljs-string"><span class="hljs-string">"Nothing"</span></span> : res.GetValue().ToString()); } <span class="hljs-comment"><span class="hljs-comment">// 3, 11, Nothing, Nothing } async Maybe&lt;int&gt; Sum(string input) { var args = await Split(input);//No result checking var result = 0; foreach (var arg in args) result += await Parse(arg);//No result checking return result; } Maybe&lt;string[]&gt; Split(string str) { var parts = str?.Split(',').Where(s=&gt;!string.IsNullOrWhiteSpace(s)).ToArray(); return parts == null || parts.Length &lt; 2 ? Maybe&lt;string[]&gt;.Nothing() : parts; } Maybe&lt;int&gt; Parse(string str) =&gt; int.TryParse(str, out var result) ? result : Maybe&lt;int&gt;.Nothing();</span></span></code> </pre> <br><p>  Adem谩s, explicar茅 c贸mo funciona el c贸digo ... </p><a name="habracut"></a><br><h2 id="generalized-async-return-types">  Tipos de retorno as铆ncrono generalizado </h2><br><p>  En primer lugar, <strong>descubramos</strong> qu茅 se necesita para usar nuestro propio tipo (por ejemplo, <strong>MyAwaitable &lt;T&gt;</strong> ) como tipo de resultado de alguna funci贸n as铆ncrona.  La documentaci贸n dice que ese tipo tiene que tener: </p><br><ol><li><p>  <strong>M茅todo GetAwaiter ()</strong> que devuelve un objeto de un tipo que implementa la interfaz <strong>INotifyCompletion</strong> y tiene la propiedad <strong>boCom IsCompleted</strong> y el m茅todo <strong>T GetResult ()</strong> ; </p><br></li><li><p>  <strong>Atributo [AsyncMethodBuilder (Type)]</strong> que apunta a una clase ( <em>o estructura</em> ) de " <strong>creador de</strong> m茅todos", por ejemplo, <strong>MyAwaitableTaskMethodBuilder &lt;T&gt;</strong> con los siguientes m茅todos: </p><br><ul><li>  Crear est谩tico () </li><li>  Inicio (stateMachine) </li><li>  SetResult (resultado) </li><li>  SetException (excepci贸n) </li><li>  SetStateMachine (stateMachine) </li><li>  AwaitOnCompleted (camarero, stateMachine) </li><li>  AwaitUnsafeOnCompleted (camarero, stateMachine) </li><li>  Tarea </li></ul><br></li></ol><br><div class="spoiler">  <b class="spoiler_title">Aqu铆 hay una implementaci贸n simple de MyAwaitable y MyAwaitableTaskMethodBuilder</b> <div class="spoiler_text"><pre> <code class="cs hljs">[<span class="hljs-meta"><span class="hljs-meta">AsyncMethodBuilder(typeof(MyAwaitableTaskMethodBuilder&lt;&gt;))</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">MyAwaitable</span></span>&lt;<span class="hljs-title"><span class="hljs-title">T</span></span>&gt; : <span class="hljs-title"><span class="hljs-title">INotifyCompletion</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Action _continuation; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">MyAwaitable</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">MyAwaitable</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">T </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">value</span></span></span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.Value = <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.IsCompleted = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> MyAwaitable&lt;T&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetAwaiter</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> =&gt; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> IsCompleted { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> T Value { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Exception Exception { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> T </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetResult</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.IsCompleted) <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Exception(<span class="hljs-string"><span class="hljs-string">"Not completed"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.Exception != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { ExceptionDispatchInfo.Throw(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.Exception); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.Value; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">internal</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">SetResult</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">T </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">value</span></span></span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.IsCompleted) <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Exception(<span class="hljs-string"><span class="hljs-string">"Already completed"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.Value = <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.IsCompleted = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>._continuation?.Invoke(); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">internal</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">SetException</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Exception exception</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.IsCompleted = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.Exception = exception; } <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> INotifyCompletion.OnCompleted(Action continuation) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>._continuation = continuation; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.IsCompleted) { continuation(); } } } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">MyAwaitableTaskMethodBuilder</span></span>&lt;<span class="hljs-title"><span class="hljs-title">T</span></span>&gt; { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">MyAwaitableTaskMethodBuilder</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> =&gt; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.Task = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> MyAwaitable&lt;T&gt;(); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> MyAwaitableTaskMethodBuilder&lt;T&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Create</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> =&gt; <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> MyAwaitableTaskMethodBuilder&lt;T&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> Start&lt;TStateMachine&gt;(<span class="hljs-keyword"><span class="hljs-keyword">ref</span></span> TStateMachine stateMachine) <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> TStateMachine : IAsyncStateMachine =&gt; stateMachine.MoveNext(); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">SetStateMachine</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">IAsyncStateMachine stateMachine</span></span></span><span class="hljs-function">)</span></span> { } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">SetException</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Exception exception</span></span></span><span class="hljs-function">)</span></span> =&gt; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.Task.SetException(exception); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">SetResult</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">T result</span></span></span><span class="hljs-function">)</span></span> =&gt; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.Task.SetResult(result); <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> AwaitOnCompleted&lt;TAwaiter, TStateMachine&gt;( <span class="hljs-keyword"><span class="hljs-keyword">ref</span></span> TAwaiter awaiter, <span class="hljs-keyword"><span class="hljs-keyword">ref</span></span> TStateMachine stateMachine) <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> TAwaiter : INotifyCompletion <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> TStateMachine : IAsyncStateMachine =&gt; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.GenericAwaitOnCompleted(<span class="hljs-keyword"><span class="hljs-keyword">ref</span></span> awaiter, <span class="hljs-keyword"><span class="hljs-keyword">ref</span></span> stateMachine); <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> AwaitUnsafeOnCompleted&lt;TAwaiter, TStateMachine&gt;( <span class="hljs-keyword"><span class="hljs-keyword">ref</span></span> TAwaiter awaiter, <span class="hljs-keyword"><span class="hljs-keyword">ref</span></span> TStateMachine stateMachine) <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> TAwaiter : ICriticalNotifyCompletion <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> TStateMachine : IAsyncStateMachine =&gt; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.GenericAwaitOnCompleted(<span class="hljs-keyword"><span class="hljs-keyword">ref</span></span> awaiter, <span class="hljs-keyword"><span class="hljs-keyword">ref</span></span> stateMachine); <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> GenericAwaitOnCompleted&lt;TAwaiter, TStateMachine&gt;( <span class="hljs-keyword"><span class="hljs-keyword">ref</span></span> TAwaiter awaiter, <span class="hljs-keyword"><span class="hljs-keyword">ref</span></span> TStateMachine stateMachine) <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> TAwaiter : INotifyCompletion <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> TStateMachine : IAsyncStateMachine =&gt; awaiter.OnCompleted(stateMachine.MoveNext); <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> MyAwaitable&lt;T&gt; Task { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; } }</code> </pre></div></div><br><p>  Ahora podemos usar <strong>MyAwaitable</strong> como un tipo de resultado de m茅todos as铆ncronos: </p><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">async</span></span></span><span class="hljs-function"> MyAwaitable&lt;</span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function">&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">MyAwaitableMethod</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> result = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> arg1 = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.GetMyAwaitable(<span class="hljs-number"><span class="hljs-number">1</span></span>); result += arg1; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> arg2 = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.GetMyAwaitable(<span class="hljs-number"><span class="hljs-number">2</span></span>); result += arg2; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> arg3 = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.GetMyAwaitable(<span class="hljs-number"><span class="hljs-number">3</span></span>); result += arg3; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> result; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">async</span></span></span><span class="hljs-function"> MyAwaitable&lt;</span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function">&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetMyAwaitable</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> arg</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> Task.Delay(<span class="hljs-number"><span class="hljs-number">1</span></span>);<span class="hljs-comment"><span class="hljs-comment">//Simulate asynchronous execution return await new MyAwaitable&lt;int&gt;(arg); }</span></span></code> </pre> <br><p>  El c贸digo funciona como se esperaba, pero para comprender el prop贸sito de los requisitos de <strong>MyAwaitable,</strong> echemos un vistazo a lo que hace el preprocesador de C # con <strong>MyAwaitableMethod</strong> .  Si ejecuta alguna utilidad de descompilaci贸n (por ejemplo, dotPeek) ver谩 que el m茅todo original se cambi贸 de la siguiente manera: </p><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> MyAwaitable&lt;</span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function">&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">MyAwaitableMethod</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> stateMachine = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> MyAwaitableMethodStateMachine(); stateMachine.Owner = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>; stateMachine.Builder = MyAwaitableTaskMethodBuilder&lt;<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>&gt;.Create(); stateMachine.State = <span class="hljs-number"><span class="hljs-number">0</span></span>; stateMachine.Builder.Start(<span class="hljs-keyword"><span class="hljs-keyword">ref</span></span> stateMachine); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> stateMachine.Builder.Task; }</code> </pre> <br><div class="spoiler">  <b class="spoiler_title">MyAwaitableMethodStateMachine</b> <div class="spoiler_text"><p>  <em>En realidad, es un c贸digo simplificado donde omito muchas optimizaciones para que un c贸digo generado por el compilador sea legible</em> </p><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">sealed</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">MyAwaitableMethodStateMachine</span></span> : <span class="hljs-title"><span class="hljs-title">IAsyncStateMachine</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> State; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> MyAwaitableTaskMethodBuilder&lt;<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>&gt; Builder; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> BuilderDemo Owner; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> _result; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> _arg1; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> _arg2; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> _arg3; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> MyAwaitableAwaiter&lt;<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>&gt; _awaiter1; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> MyAwaitableAwaiter&lt;<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>&gt; _awaiter2; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> MyAwaitableAwaiter&lt;<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>&gt; _awaiter3; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">SetAwaitCompletion</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">INotifyCompletion awaiter</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> stateMachine = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.Builder.AwaitOnCompleted(<span class="hljs-keyword"><span class="hljs-keyword">ref</span></span> awaiter, <span class="hljs-keyword"><span class="hljs-keyword">ref</span></span> stateMachine); } <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> IAsyncStateMachine.MoveNext() { <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> finalResult; <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { label_begin: <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.State) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>._result = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>._awaiter1 = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.Owner.GetMyAwaitable(<span class="hljs-number"><span class="hljs-number">1</span></span>).GetAwaiter(); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.State = <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>._awaiter1.IsCompleted) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.SetAwaitCompletion(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>._awaiter1); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">goto</span></span> label_begin; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>:<span class="hljs-comment"><span class="hljs-comment">// awaiter1 should be completed this._arg1 = this._awaiter1.GetResult(); this._result += this._arg1; this.State = 2; this._awaiter2 = this.Owner.GetMyAwaitable(2).GetAwaiter(); if (!this._awaiter2.IsCompleted) { this.SetAwaitCompletion(this._awaiter2); return; } goto label_begin; case 2:// awaiter2 should be completed this._arg2 = this._awaiter2.GetResult(); this._result += this._arg2; this.State = 3; this._awaiter3 = this.Owner.GetMyAwaitable(3).GetAwaiter(); if (!this._awaiter3.IsCompleted) { this.SetAwaitCompletion(this._awaiter3); return; } goto label_begin; case 3:// awaiter3 should be completed this._arg3 = this._awaiter3.GetResult(); this._result += this._arg3; finalResult = this._result; break; default: throw new Exception(); } } catch (Exception ex) { this.State = -1; this.Builder.SetException(ex); return; } this.State = -1; this.Builder.SetResult(finalResult); } }</span></span></code> </pre> </div></div><br><p>  Al revisar el c贸digo generado, podemos ver que el "creador de m茅todos" tiene las siguientes responsabilidades: </p><br><ol><li>  Programaci贸n de la llamada al m茅todo <strong>MoveNext () de la</strong> m谩quina de estado cuando se realiza una operaci贸n asincr贸nica secundaria (en el escenario m谩s simple, simplemente pasamos <strong>MoveNext ()</strong> a <strong>OnCompleted ()</strong> del <strong>camarero</strong> de la operaci贸n as铆ncrona). </li><li>  Creaci贸n de un objeto de contexto de operaci贸n as铆ncrono ( <code>public MyAwaitable&lt;T&gt; Task { get; }</code> ) </li><li>  Reacci贸n en estados finales de m谩quinas de estado generadas: <strong>SetResult</strong> o <strong>SetException</strong> . </li></ol><br><p>  En otras palabras, con los "creadores de m茅todos" podemos controlar c贸mo se ejecutan los m茅todos asincr贸nicos y parece una caracter铆stica que nos ayudar谩 a lograr nuestro objetivo: una implementaci贸n del comportamiento de M贸nada <strong>Quiz谩s</strong> .  Pero, 驴qu茅 tiene de bueno esa m贸nada?  Bueno ... puedes encontrar muchos art铆culos sobre esa m贸nada en Internet, as铆 que aqu铆 describir茅 solo lo b谩sico. </p><br><h2 id="maybe-monad">  Tal vez m贸nada </h2><br><p>  En resumen, <strong>Quiz谩s</strong> m贸nada es un patr贸n de dise帽o que permite la interrupci贸n de una cadena de llamada de funci贸n si alguna funci贸n de la cadena no puede producir un resultado valioso (por ejemplo, error de an谩lisis). </p><br><p>  Hist贸ricamente, los lenguajes de programaci贸n imperativos han estado resolviendo el problema de dos maneras: </p><br><ol><li>  Mucha l贸gica condicional </li><li>  Excepciones </li></ol><br><p>  Las dos formas tienen desventajas obvias, por lo que se invent贸 una tercera forma: </p><br><ol><li>  Cree un tipo que pueda estar en 2 estados: "Alg煤n valor" y "Nada". Llam茅moslo "Quiz谩s" </li><li>  Cree una funci贸n (llam茅mosla "SelectMany") que recupera 2 argumentos: <br>  2.1.  Un objeto de tipo "Quiz谩s" <br>  2.2.  Una siguiente funci贸n del conjunto de llamadas: la funci贸n tambi茅n debe devolver un objeto de "Quiz谩s" que contendr谩 un resultado o "Nada" si su resultado no puede evaluarse (por ejemplo, los par谩metros de la funci贸n no est谩n en el formato correcto) </li><li>  La funci贸n "SelectMany" verifica si "Quiz谩s" tiene alg煤n valor y luego llama a la siguiente funci贸n utilizando el valor (extra铆do de "Quiz谩s") como argumento y luego devuelve su resultado; de lo contrario, devuelve un objeto "Quiz谩s" en estado "Nada" . </li></ol><br><p><img src="https://habrastorage.org/webt/f2/zl/3k/f2zl3kmfcocbyyujwqa4wvidxqw.png"></p><br><p>  En C # se puede implementar as铆: </p><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">struct</span></span> Maybe&lt;T&gt; { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">implicit</span></span> <span class="hljs-keyword"><span class="hljs-keyword">operator</span></span> Maybe&lt;T&gt;(T <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>) =&gt; Value(<span class="hljs-keyword"><span class="hljs-keyword">value</span></span>); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> Maybe&lt;T&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Value</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">T </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">value</span></span></span></span></span><span class="hljs-function">)</span></span> =&gt; <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Maybe&lt;T&gt;(<span class="hljs-literal"><span class="hljs-literal">false</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> Maybe&lt;T&gt; Nothing = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Maybe&lt;T&gt;(<span class="hljs-literal"><span class="hljs-literal">true</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">default</span></span>); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Maybe</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">bool</span></span></span></span><span class="hljs-function"><span class="hljs-params"> isNothing, T </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">value</span></span></span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.IsNothing = isNothing; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>._value = <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> IsNothing; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> T _value; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> T </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetValue</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> =&gt; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.IsNothing ? <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Exception(<span class="hljs-string"><span class="hljs-string">"Nothing"</span></span>) : <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>._value; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">MaybeExtensions</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> Maybe&lt;TRes&gt; SelectMany&lt;TIn, TRes&gt;( <span class="hljs-keyword"><span class="hljs-keyword">this</span></span> Maybe&lt;TIn&gt; source, Func&lt;TIn, Maybe&lt;TRes&gt;&gt; func) =&gt; source.IsNothing ? Maybe&lt;TRes&gt;.Nothing : func(source.GetValue()); }</code> </pre><br><p>  y uso: </p><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Main</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; <span class="hljs-number"><span class="hljs-number">10</span></span>; i++) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> res = Function1(i).SelectMany(Function2).SelectMany(Function3); Console.WriteLine(res.IsNothing ? <span class="hljs-string"><span class="hljs-string">"Nothing"</span></span> : res.GetValue().ToString()); } <span class="hljs-function"><span class="hljs-function">Maybe&lt;</span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function">&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Function1</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> acc</span></span></span><span class="hljs-function">)</span></span> =&gt; acc &lt; <span class="hljs-number"><span class="hljs-number">10</span></span> ? acc + <span class="hljs-number"><span class="hljs-number">1</span></span> : Maybe&lt;<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>&gt;.Nothing; <span class="hljs-function"><span class="hljs-function">Maybe&lt;</span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function">&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Function2</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> acc</span></span></span><span class="hljs-function">)</span></span> =&gt; acc &lt; <span class="hljs-number"><span class="hljs-number">10</span></span> ? acc + <span class="hljs-number"><span class="hljs-number">2</span></span> : Maybe&lt;<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>&gt;.Nothing; <span class="hljs-function"><span class="hljs-function">Maybe&lt;</span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function">&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Function3</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> acc</span></span></span><span class="hljs-function">)</span></span> =&gt; acc &lt; <span class="hljs-number"><span class="hljs-number">10</span></span> ? acc + <span class="hljs-number"><span class="hljs-number">3</span></span> : Maybe&lt;<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>&gt;.Nothing; }</code> </pre> <br><div class="spoiler">  <b class="spoiler_title">驴Por qu茅 'SelectMany'?</b> <div class="spoiler_text"><p>  Creo que algunos de ustedes podr铆an hacer una pregunta: "驴Por qu茅 el autor llam贸 a la funci贸n" SelectMany "? Es un nombre tan extra帽o".  Lo es, pero hay una raz贸n para eso.  En C #, <strong>SelectMany</strong> es utilizado por el preprocesador para admitir la <strong>notaci贸n de consultas</strong> que simplifica el trabajo con cadenas de llamadas (puede encontrar <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">m谩s detalles en mi art铆culo anterior</a> ). </p><br><p>  De hecho, podemos cambiar la cadena de llamadas de la siguiente manera: </p><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> res = Function1(i) .SelectMany(x2 =&gt; Function2(x2).SelectMany(x3 =&gt; Function3(x3.SelectMany&lt;<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">int</span></span>&gt;(x4 =&gt; x2 + x3 + x4)));</code> </pre> <br><p>  para que podamos acceder a todos los resultados intermedios, lo cual es conveniente pero el c贸digo es dif铆cil de leer. </p><br><p>  Aqu铆 la <strong>notaci贸n de consulta</strong> nos ayuda: </p><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> res = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">from</span></span></span><span class="hljs-function"> x2 </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">in</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Function1</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">i</span></span></span><span class="hljs-function">) </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">from</span></span></span><span class="hljs-function"> x3 </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">in</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Function2</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">x2</span></span></span><span class="hljs-function">) </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">from</span></span></span><span class="hljs-function"> x4 </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">in</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Function3</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">x3</span></span></span><span class="hljs-function">) </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">select</span></span></span><span class="hljs-function"> x2 + x3 + x4</span></span>;</code> </pre> <br><p>  <em>Para que el c贸digo sea compilable, necesitamos una versi贸n mejorada de "Seleccionar muchos"</em> </p><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> Maybe&lt;TJ&gt; SelectMany&lt;TIn, TRes, TJ&gt;( <span class="hljs-keyword"><span class="hljs-keyword">this</span></span> Maybe&lt;TIn&gt; source, Func&lt;TIn, Maybe&lt;TRes&gt;&gt; func, Func&lt;TIn, TRes, TJ&gt; joinFunc) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (source.IsNothing) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Maybe&lt;TJ&gt;.Nothing; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> res = func(source.GetValue()); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> res.IsNothing ? Maybe&lt;TJ&gt;.Nothing : joinFunc(source.GetValue(), res.GetValue()); }</code> </pre> </div></div><br><div class="spoiler">  <b class="spoiler_title">Implementemos el programa desde el encabezado del art铆culo usando esta implementaci贸n 'cl谩sica' Quiz谩s '</b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Main</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> s <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span>[] {<span class="hljs-string"><span class="hljs-string">"1,2"</span></span>, <span class="hljs-string"><span class="hljs-string">"3,7,1"</span></span>, <span class="hljs-literal"><span class="hljs-literal">null</span></span>, <span class="hljs-string"><span class="hljs-string">"1"</span></span>}) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> res = Sum(s); Console.WriteLine(res.IsNothing ? <span class="hljs-string"><span class="hljs-string">"Nothing"</span></span> : res.GetValue().ToString()); } Console.ReadKey(); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> Maybe&lt;</span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function">&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Sum</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> input</span></span></span><span class="hljs-function">)</span></span> =&gt; Split(input).SelectMany(items =&gt; Acc(<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, items)); <span class="hljs-comment"><span class="hljs-comment">//Recursion is used to process a list of "Maybes" static Maybe&lt;int&gt; Acc(int res, int index, IReadOnlyList&lt;string&gt; array) =&gt; index &lt; array.Count ? Add(res, array[index]) .SelectMany(newRes =&gt; Acc(newRes, index + 1, array)) : res; static Maybe&lt;int&gt; Add(int acc, string nextStr) =&gt; Parse(nextStr).SelectMany&lt;int, int&gt;(nextNum =&gt; acc + nextNum); static Maybe&lt;string[]&gt; Split(string str) { var parts = str?.Split(',') .Where(s =&gt; !string.IsNullOrWhiteSpace(s)).ToArray(); return parts == null || parts.Length &lt; 2 ? Maybe&lt;string[]&gt;.Nothing : parts; } static Maybe&lt;int&gt; Parse(string value) =&gt; int.TryParse(value, out var result) ? result : Maybe&lt;int&gt;.Nothing;</span></span></code> </pre><br><p>  <em>El c贸digo no se ve muy bien ya que C # no fue dise帽ado como un lenguaje funcional, pero en lenguajes funcionales "verdaderos" como Haskell, este enfoque es muy com煤n</em> </p></div></div><br><h2 id="async-maybe">  Tal vez as铆ncrono </h2><br><p>  La esencia de <strong>Quiz谩s</strong> monad es controlar una cadena de llamadas de funci贸n, pero es exactamente lo que hace "async / wait".  As铆 que intentemos combinarlos.  Primero, debemos hacer que el tipo <strong>Quiz谩s sea</strong> compatible con funciones asincr贸nicas y ya sabemos c贸mo hacerlo: </p><br><pre> <code class="cs hljs">[<span class="hljs-meta"><span class="hljs-meta">AsyncMethodBuilder(typeof(MaybeTaskMethodBuilder&lt;&gt;))</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Maybe</span></span>&lt;<span class="hljs-title"><span class="hljs-title">T</span></span>&gt; : <span class="hljs-title"><span class="hljs-title">INotifyCompletion</span></span> { ... <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Maybe&lt;T&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetAwaiter</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> =&gt; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> IsCompleted { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OnCompleted</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Action continuation</span></span></span><span class="hljs-function">)</span></span>{...} <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> T </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetResult</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> =&gt;... }</code> </pre> <br><p>  Ahora echemos un vistazo a c贸mo el "cl谩sico Quiz谩s" puede reescribirse como una m谩quina de estado para poder encontrar cualquier similitud: </p><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Main</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; <span class="hljs-number"><span class="hljs-number">10</span></span>; i++) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> stateMachine = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> StateMachine(); stateMachine.state = <span class="hljs-number"><span class="hljs-number">0</span></span>; stateMachine.i = i; stateMachine.MoveNext(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> res = stateMachine.Result; Console.WriteLine(res.IsNothing ? <span class="hljs-string"><span class="hljs-string">"Nothing"</span></span> : res.GetValue().ToString()); } Console.ReadKey(); } <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">StateMachine</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> state = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Maybe&lt;<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>&gt; Result; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Maybe&lt;<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>&gt; _f1; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Maybe&lt;<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>&gt; _f2; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Maybe&lt;<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>&gt; _f3; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">MoveNext</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { label_begin: <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.state) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>._f1 = Function1(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.i); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.state = Match ? <span class="hljs-number"><span class="hljs-number">-1</span></span> : <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">goto</span></span> label_begin; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>._f2 = Function2(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>._f1.GetValue()); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.state = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>._f2.IsNothing ? <span class="hljs-number"><span class="hljs-number">-1</span></span> : <span class="hljs-number"><span class="hljs-number">2</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">goto</span></span> label_begin; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>._f3 = Function3(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>._f2.GetValue()); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.state = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>._f3.IsNothing ? <span class="hljs-number"><span class="hljs-number">-1</span></span> : <span class="hljs-number"><span class="hljs-number">3</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">goto</span></span> label_begin; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-number"><span class="hljs-number">3</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.Result = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>._f3.GetValue(); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-number"><span class="hljs-number">-1</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.Result = Maybe&lt;<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>&gt;.Nothing; <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } } }</code> </pre> <br><p>  Si hacemos coincidir esta m谩quina de estado con la generada por el preprocesador de C # uno (ver arriba - 'MyAwaitableMethodStateMachine') podemos notar que <strong>tal vez</strong> la verificaci贸n de estado puede implementarse dentro de: </p><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.Builder.AwaitOnCompleted(<span class="hljs-keyword"><span class="hljs-keyword">ref</span></span> awaiter, <span class="hljs-keyword"><span class="hljs-keyword">ref</span></span> stateMachine);</code> </pre> <br><p>  donde <code>ref awaiter</code> es un objeto de tipo <strong>Quiz谩s</strong> .  El 煤nico problema aqu铆 es que no podemos configurar la m谩quina en el estado "final" (-1).  驴Eso significa que no podemos controlar el flujo de ejecuci贸n?  En realidad no lo hace.  La cuesti贸n es que para cada acci贸n asincr贸nica, C # establece una acci贸n de devoluci贸n de llamada a trav茅s de la interfaz <strong>INotifyCompletion</strong> , por lo que si queremos interrumpir un flujo de ejecuci贸n, podemos llamar a la acci贸n de devoluci贸n de llamada en un caso en el que no podemos continuar el flujo. <br>  Otro desaf铆o aqu铆 es que la m谩quina de estado generada pasa una pr贸xima acci贸n (como una devoluci贸n de llamada de continuaci贸n) de un flujo actual, pero necesitamos una devoluci贸n de llamada de continuaci贸n del flujo inicial que permitir铆a omitir el resto de las operaciones as铆ncronas: </p><br><p><img src="https://habrastorage.org/webt/da/v-/vb/dav-vbwfusgtb1degxhxyhafsdk.png"></p><br><p>  Por lo tanto, necesitamos conectar de alguna manera una acci贸n as铆ncrona secundaria con sus antepasados.  Podemos hacerlo utilizando nuestro "generador de m茅todos" que tiene un enlace a una operaci贸n asincr贸nica actual: <strong>Tarea</strong> .  Los enlaces a todas las operaciones as铆ncronas secundarias se pasar谩n a <code>AwaitOnCompleted(ref awaiter</code> como <strong>camarero</strong> , por lo que solo debemos verificar si el par谩metro es una instancia de <strong>Quiz谩s</strong> y si se establece el <strong>tal vez</strong> actual como padre para el hijo: </p><br><pre> <code class="cs hljs">[<span class="hljs-meta"><span class="hljs-meta">AsyncMethodBuilder(typeof(MaybeTaskMethodBuilder&lt;&gt;))</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Maybe</span></span>&lt;<span class="hljs-title"><span class="hljs-title">T</span></span>&gt; : <span class="hljs-title"><span class="hljs-title">IMaybe</span></span>, <span class="hljs-title"><span class="hljs-title">INotifyCompletion</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> IMaybe _parent; <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> IMaybe.SetParent(IMaybe parent) =&gt; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>._parent = parent; ... } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">MaybeTaskMethodBuilder</span></span>&lt;<span class="hljs-title"><span class="hljs-title">T</span></span>&gt; { ... <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> GenericAwaitOnCompleted&lt;TAwaiter, TStateMachine&gt;( <span class="hljs-keyword"><span class="hljs-keyword">ref</span></span> TAwaiter awaiter, <span class="hljs-keyword"><span class="hljs-keyword">ref</span></span> TStateMachine stateMachine) <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> TAwaiter : INotifyCompletion <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> TStateMachine : IAsyncStateMachine { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (awaiter <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> IMaybe maybe) { maybe.SetParent(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.Task); } awaiter.OnCompleted(stateMachine.MoveNext); } ... }</code> </pre> <br><p>  Ahora todos los objetos <strong>tal vez</strong> se pueden unir en un 谩rbol y, como resultado, tendremos acceso a una continuaci贸n de la ra铆z <strong>tal vez</strong> (m茅todo de <strong>salida</strong> ) desde cualquier nodo descendente: </p><br><pre> <code class="cs hljs">[<span class="hljs-meta"><span class="hljs-meta">AsyncMethodBuilder(typeof(MaybeTaskMethodBuilder&lt;&gt;))</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Maybe</span></span>&lt;<span class="hljs-title"><span class="hljs-title">T</span></span>&gt; : <span class="hljs-title"><span class="hljs-title">IMaybe</span></span>, <span class="hljs-title"><span class="hljs-title">INotifyCompletion</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Action _continuation; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> IMaybe _parent; ... <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OnCompleted</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Action continuation</span></span></span><span class="hljs-function">)</span></span> { ... <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>._continuation = continuation; ... } ... <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> IMaybe.Exit() { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.IsCompleted = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>._parent != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>._parent.Exit(); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>._continuation(); } } ... }</code> </pre> <br><p>  Debe llamarse a ese m茅todo <strong>Exit</strong> cuando (durante el movimiento sobre el 谩rbol) encontramos un objeto <strong>Quiz谩s</strong> ya resuelto en el estado <strong>Nothing</strong> .  Tales objetos pueden ser devueltos por un m茅todo como este: </p><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-function">Maybe&lt;</span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function">&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Parse</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> str</span></span></span><span class="hljs-function">)</span></span> =&gt; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span>.TryParse(str, <span class="hljs-keyword"><span class="hljs-keyword">out</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> result) ? result : Maybe&lt;<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>&gt;.Nothing();</code> </pre> <br><p>  Para almacenar un estado de resuelto <strong>Quiz谩s</strong> introduzcamos una nueva estructura separada: </p><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">struct</span></span> MaybeResult { ... <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> T _value; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> IsNothing; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> T </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetValue</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> =&gt; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.IsNothing ? <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Exception(<span class="hljs-string"><span class="hljs-string">"Nothing"</span></span>) : <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>._value; } [AsyncMethodBuilder(<span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(MaybeTaskMethodBuilder&lt;&gt;))] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Maybe</span></span>&lt;<span class="hljs-title"><span class="hljs-title">T</span></span>&gt; : <span class="hljs-title"><span class="hljs-title">IMaybe</span></span>, <span class="hljs-title"><span class="hljs-title">INotifyCompletion</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> MaybeResult? _result; ... <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">internal</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Maybe</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { }<span class="hljs-comment"><span class="hljs-comment">//Used in async method private Maybe(MaybeResult result) =&gt; this._result = result;// "Resolved" instance ... }</span></span></code> </pre> <br><p>  Cuando una m谩quina de estado as铆ncrona llama (a trav茅s del generador de m茅todos) M茅todo <strong>OnCompleted</strong> de una instancia <strong>tal vez</strong> ya resuelta y est谩 en estado <strong>Nothing</strong> , podremos romper un flujo completo: </p><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OnCompleted</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Action continuation</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>._continuation = continuation; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>._result.HasValue) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.NotifyResult(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>._result.Value.IsNothing); } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">internal</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">SetResult</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">T result</span></span></span><span class="hljs-function">) </span><span class="hljs-comment"><span class="hljs-function"><span class="hljs-comment">//Is called by a "method builder" when an async method is completed { this._result = MaybeResult.Value(result); this.IsCompleted = true; this.NotifyResult(this._result.Value.IsNothing); } private void NotifyResult(bool isNothing) { this.IsCompleted = true; if (isNothing) { this._parent.Exit();//Braking an entire flow } else { this._continuation?.Invoke(); } }</span></span></span></span></code> </pre> <br><p>  Ahora lo 煤nico que queda es c贸mo obtener un resultado de un As铆ncrono <strong>Quiz谩s</strong> fuera de su alcance (cualquier m茅todo as铆ncrono cuyo tipo de retorno no sea <strong>Quiz谩s</strong> ).  Si intenta usar la palabra clave <strong>aguardar</strong> con una instancia de <strong>Maybe</strong> , se generar谩 una excepci贸n debido a este c贸digo: </p><br><pre> <code class="cs hljs">[<span class="hljs-meta"><span class="hljs-meta">AsyncMethodBuilder(typeof(MaybeTaskMethodBuilder&lt;&gt;))</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Maybe</span></span>&lt;<span class="hljs-title"><span class="hljs-title">T</span></span>&gt; : <span class="hljs-title"><span class="hljs-title">IMaybe</span></span>, <span class="hljs-title"><span class="hljs-title">INotifyCompletion</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> MaybeResult? _result; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> T </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetResult</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> =&gt; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>._result.Value.GetValue(); } ... <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">struct</span></span> MaybeResult { ... <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> T </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetValue</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> =&gt; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.IsNothing ? <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Exception(<span class="hljs-string"><span class="hljs-string">"Nothing"</span></span>) : <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>._value; }</code> </pre> <br><p>  Para resolver el problema, solo podemos agregar un nuevo <strong>Awaiter</strong> que devolver铆a una estructura completa de <strong>Quiz谩sResult</strong> y podremos escribir un c贸digo como este: </p><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> res = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> GetResult().GetMaybeResult(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(res.IsNothing){ ... } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>{ res.GetValue(); ... };</code> </pre> <br><p>  Eso es todo por ahora.  En los ejemplos de c贸digo, omito algunos detalles para centrarme solo en las partes m谩s importantes.  Puedes encontrar una versi贸n completa en <a href="">github</a> . </p><br><p>  <strong>Sin embargo</strong> , no recomendar铆a usar esta versi贸n en ning煤n c贸digo de producci贸n, ya que tiene un problema importante: cuando frenamos un flujo de ejecuci贸n llamando a una continuaci贸n de la ra铆z. 隆 <strong>Quiz谩s</strong> omitiremos TODO!  incluyendo todos los bloques <strong>finalmente</strong> (es una respuesta a la pregunta "驴Se llaman siempre los bloques <strong>finalmente</strong> ?"), por lo que todos los operadores que <strong>usan</strong> no funcionar谩n como se esperaba y eso podr铆a conducir a la fuga de recursos.  El problema se puede resolver si, en lugar de llamar a la devoluci贸n de llamada de continuaci贸n inicial, lanzaremos una excepci贸n especial que se manejar谩 internamente ( <a href="">aqu铆 puede encontrar la versi贸n</a> ), pero esta soluci贸n aparentemente tiene imitaciones de rendimiento (que pueden ser aceptables en algunos escenarios).  Con la versi贸n actual del compilador de C # no veo ninguna otra soluci贸n, pero eso podr铆a cambiar en el futuro. </p><br><p>  Estas limitaciones no significan que todos los trucos descritos en este art铆culo sean completamente in煤tiles, se pueden usar para implementar otras m贸nadas que no requieren cambios en los flujos de ejecuci贸n, por ejemplo, "Reader".  C贸mo implementar esa m贸nada "Reader" a trav茅s de <strong>async / await</strong> mostrar茅 <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">en el pr贸ximo art铆culo</a> . </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/458692/">https://habr.com/ru/post/458692/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../458680/index.html">驴Por qu茅 necesitamos UML? O c贸mo salvar tus nervios y tu tiempo</a></li>
<li><a href="../458684/index.html">ICANN elimina el umbral de precio para el dominio .org: por qu茅 la comunidad de TI est谩 en contra y qu茅 suceder谩 despu茅s</a></li>
<li><a href="../458686/index.html">@Pythonetc Junio 2019</a></li>
<li><a href="../458688/index.html">Consejos y trucos de mi canal de Telegram @pythonetc, junio de 2019</a></li>
<li><a href="../458690/index.html">隆Automat铆zalo! C贸mo mejoramos las pruebas de integraci贸n</a></li>
<li><a href="../458694/index.html">驴Python GIL est谩 realmente muerto?</a></li>
<li><a href="../458696/index.html">Texturizado, o lo que necesitas saber para convertirte en un Artista de Surface. Parte 3. PBR y materiales</a></li>
<li><a href="../458698/index.html">El camino de la paz y el camino de la guerra en proyectos de TI</a></li>
<li><a href="../458702/index.html">Perros de trineo: lo que necesita saber sobre ellos y c贸mo fueron tra铆dos</a></li>
<li><a href="../458704/index.html">Implementaci贸n de un sistema DLP en el ejemplo del comercio minorista</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>