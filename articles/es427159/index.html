<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üöù üëºüèº üîº Recopilamos registros del cortafuegos Mikrotik en una base de datos üë¥üèΩ üë©üèº‚Äçü§ù‚Äçüë®üèª üÄÑÔ∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Buenas tardes 

 Quiero decirle cu√°n f√°cil y naturalmente puede configurar un servidor de recopilaci√≥n de metadatos de tr√°fico de red para enrutadores...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Recopilamos registros del cortafuegos Mikrotik en una base de datos</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/427159/">  Buenas tardes <br><br>  Quiero decirle cu√°n f√°cil y naturalmente puede configurar un servidor de recopilaci√≥n de metadatos de tr√°fico de red para enrutadores Mikrotik. <br><br>  <b>Prop√≥sito:</b> El objetivo ser√° almacenar los registros de firewall "masticados" en una base de datos para su posterior an√°lisis. <br><br>  <b>Medios:</b> cualquier distribuci√≥n fresca de Linux con rsyslogd v8 y superior es adecuada para la implementaci√≥n, tal vez la sintaxis propuesta tambi√©n funcione en v7.  Tambi√©n necesitamos un DBMS, eleg√≠ mariadb.  El crecimiento de la base de datos variar√° dependiendo del n√∫mero de reglas registradas, porque el tama√±o de la unidad es a su discreci√≥n, en mi caso, se registran 30-40 reglas, que son aproximadamente 1200 mil l√≠neas por d√≠a.  Durante el mes de uso de la base de datos, incluidos los √≠ndices, creci√≥ a 3,8 GB. <br><br>  <b>Mec√°nica: el</b> enrutador env√≠a un registro al servidor remoto a trav√©s de UDP.  Usando expresiones regulares, el servidor rsyslog limpia cadenas de informaci√≥n innecesaria, genera un inserto SQL y lo env√≠a al DBMS.  El DBMS, utilizando un disparador antes de la inserci√≥n, realiza una limpieza y separaci√≥n adicional de los campos que no se pudieron analizar en rsyslog. <br><a name="habracut"></a><br><h4>  <b>Configurar RSYSLOG</b> </h4><br>  Edici√≥n del archivo /etc/rsyslog.conf <br>  Agregue las siguientes l√≠neas all√≠: <br><br><pre><code class="plaintext hljs">module(load="ommysql") module(load="imudp") input(type="imudp" port="514")</code> </pre> <br>  Por lo tanto, cargamos los m√≥dulos necesarios y abrimos el puerto UDP 514. <br><br>  La l√≠nea de registro de Mikrotik se ve as√≠: <br><br><pre> <code class="plaintext hljs">20180927155341 BLOCKSMKNETS forward: in:ether6 - LocalTORF out:VLAN55 - RT_INET, src-mac 00:15:17:31:b8:d7, proto TCP (SYN), 192.168.0.234:2457-&gt;192.168.6.14:65535, len 60</code> </pre> <br>  Como puede ver, ser√° mucho m√°s extra para el almacenamiento en la base de datos y una selecci√≥n clara. <br>  En teor√≠a, necesito agregar tales datos: <br><br><pre> <code class="plaintext hljs">20180927155341 ether6 VLAN5 192.168.0.234 2457 192.168.6.14 65535 00:15:17:31:b8:d7 TCP SYN forward BLOCKSMKNETS 60</code> </pre> <br>  No pude obtener esa l√≠nea usando solo un rsyslog.  Los clientes habituales de Rsyslog utilizan POSIX ERE / BRE, por lo que no hay forma de aplicar funciones como mirar hacia adelante o hacia atr√°s. <br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Hay</a> una herramienta que le permite depurar los clientes habituales, probarlo, tal vez pueda separar el puerto de la direcci√≥n, as√≠ como el nombre de la interfaz de in: y out:.  Solo tenga en cuenta que faltan algunos de los protocolos de deporte y dport. <br><br>  En general, mi salida fue la siguiente: <br><br><pre> <code class="plaintext hljs">20180927155341 in:ether6 out:VLAN5 192.168.0.234:2457 192.168.6.14:65535 00:15:17:31:b8:d7 TCP (SYN) forward BLOCKSMKNETS 60</code> </pre> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Existe</a> documentaci√≥n sobre c√≥mo cocinar los clientes habituales de rsyslog. <br><br>  En la forma final, el archivo de configuraci√≥n para recibir el registro de Mikrotik /etc/rsyslog.d/20-remote.conf se ver√° as√≠: <br><br><pre> <code class="plaintext hljs">$template tpl_traflog,"insert into traflog.traffic (datetime, inif, outif, src, dst, smac, proto, flags, chain, logpref, len) values ('%timereported:::date-mysql%', '%msg:R,ERE,0,DFLT,0:in:[a-zA-Z]+[0-9]+|in:&lt;[a-zA-Z]+-[a-zA-Z]+&gt;--end%', '%msg:R,ERE,0,BLANK,0:out:[a-zA-Z]+[0-9]+|out:&lt;[a-zA-Z]+-[a-zA-Z]+&gt;--end%', '%msg:R,ERE,0,DFLT,0:([0-9]+\.){3}[0-9]+[:]?([0-9]+)?--end%', '%msg:R,ERE,0,DFLT,1:([0-9]+\.){3}[0-9]+[:]?([0-9]+)?--end%', '%msg:R,ERE,0,BLANK:([0-f]+:){5}[0-f]+--end%', '%msg:R,ERE,0,BLANK:\b[AX]{3,4}\b--end%', '%msg:R,ERE,0,BLANK:\([AZ]+\)|\(([AZ]+\,){1,3}[AZ]+\)--end%', '%msg:R,ERE,0,DFLT:[ax]+--end%', '%msg:F,32:2%', '%msg:R,ERE,0,DFLT:[0-9]+$--end%' )",SQL if ($fromhost-ip == '192.168.0.230') and ($syslogtag contains "firewall") then {action(type="ommysql" server="localhost" serverport="3306" db="traflog" uid="rsyslogger" pwd="rsyslogger" template="tpl_traflog") stop}</code> </pre><br>  En la primera l√≠nea, la descripci√≥n de la plantilla (plantilla) es una l√≠nea de c√≥digo SQL para transferirla al DBMS. <br>  La segunda l√≠nea es la condici√≥n cuando se producir√° la acci√≥n, es decir, el registro en el DBMS. <br>  La condici√≥n se ve as√≠: si la fuente de registro = 192.168.0.230 ( <code>if ($fromhost-ip == '192.168.0.230')</code> ) Y si la l√≠nea msg contiene "firewall" (y ($ syslogtag contiene "firewall"), entonces usar el m√≥dulo ommysql con par√°metros de conexi√≥n ( <code>then {action(type="ommysql" server="localhost" serverport="3306" db="traflog" uid="rsyslogger" pwd="..."</code> ) llamamos a la plantilla tpl_traflog ( <code>template="tpl_traflog")</code> ), y despu√©s de eso detenemos el procesamiento posterior de la l√≠nea ( <code>stop}</code> ). <br><br>  Es posible que en su caso algo salga mal, puede deberse a los nombres de las interfaces o prefijos de registro, tal vez algo m√°s.  Para la depuraci√≥n, haremos lo siguiente, comentaremos en la segunda l√≠nea, agregaremos una nueva plantilla y dos condiciones nuevas: <br><br><pre> <code class="plaintext hljs">$template tpl_traflog_test,"%timereported:::date-mysql% %msg:R,ERE,0,DFLT,0:in:[a-zA-Z]+[0-9]+|in:&lt;[a-zA-Z]+-[a-zA-Z]+&gt;--end% %msg:R,ERE,0,BLANK,0:out:[a-zA-Z]+[0-9]+|out:&lt;[a-zA-Z]+-[a-zA-Z]+&gt;--end% %msg:R,ERE,0,DFLT,0:([0-9]+\.){3}[0-9]+[:]?([0-9]+)?--end% %msg:R,ERE,0,DFLT,1:([0-9]+\.){3}[0-9]+[:]?([0-9]+)?--end% %msg:R,ERE,0,BLANK:([0-f]+:){5}[0-f]+--end% %msg:R,ERE,0,BLANK:\b[AX]{3,4}\b--end% %msg:R,ERE,0,BLANK:\([AZ]+\)|\(([AZ]+\,){1,3}[AZ]+\)--end% %msg:R,ERE,0,DFLT:[ax]+--end% %msg:F,32:2% %msg:R,ERE,0,DFLT:[0-9]+$--end%\n" if ($fromhost-ip == '192.168.0.230') then {action(type="omfile" file="/var/log/remote/192.168.0.230.log" )} if ($fromhost-ip == '192.168.0.230') then {action(type="omfile" file="/var/log/remote/192.168.0.230.log" template="tpl_traflog_test" ) stop}</code> </pre> <br>  Reinicie el registrador. <br><br>  La plantilla tpl_traflog_test es similar a tpl_traflog, pero sin SQL INSERT. <br><br>  La primera condici√≥n agrega la l√≠nea no procesada% msg% al archivo /var/log/remote/192.168.0.230.log, porque la plantilla no est√° especificada. <br><br>  La segunda condici√≥n agrega la l√≠nea procesada al mismo archivo. <br>  Por lo tanto, ser√° m√°s conveniente comparar. <br>  A continuaci√≥n, prepare la base de datos. <br><br><h4>  <b>Preparamos un DB</b> </h4><br>  Bajaremos la configuraci√≥n de DBMS, aqu√≠ todo es est√°ndar. <br><br>  Iniciamos la consola mysql y ejecutamos el siguiente c√≥digo: <br><br><pre> <code class="sql hljs"><span class="hljs-comment"><span class="hljs-comment">--   create database traflog character set utf8 collate utf8_bin; use traflog; --  create table traffic (id BIGINT UNSIGNED NOT NULL AUTO_INCREMENT PRIMARY KEY, datetime DATETIME, inif VARCHAR(20), outif VARCHAR(20), src VARCHAR(21), sport INT(5), dst VARCHAR(21), dport INT(5), smac VARCHAR(17), proto VARCHAR(4), flags VARCHAR(11), chain VARCHAR(8), logpref VARCHAR(24), len INT(5)) ENGINE=MYISAM; --  create user rsyslogger@localhost identified by '...'; grant all privileges on traflog.* to rsyslogger@localhost;</span></span></code> </pre><br>  La mesa est√° lista, el usuario s√≠. <br><br>  Ahora agregue un disparador, har√° lo que el registrador no logr√≥ separar la direcci√≥n del puerto, limpiar√° los nombres de las interfaces, eliminar√° los corchetes de la bandera: <br><br><pre> <code class="sql hljs"><span class="hljs-comment"><span class="hljs-comment">--   traffic DELIMITER // create TRIGGER delim_ip_port_flags BEFORE insert ON traffic FOR EACH ROW begin set NEW.inif = REGEXP_REPLACE ((NEW.inif), 'in:', '' ); set NEW.outif = REGEXP_REPLACE ((NEW.outif), 'out:', '' ); set NEW.sport = REGEXP_REPLACE ((NEW.src), '([0-9]+\.){3}[0-9]+:|([0-9]+\.){3}[0-9]+', '' ); set NEW.src = REGEXP_REPLACE ((NEW.src), ':[0-9]+', '' ); set NEW.dport = REGEXP_REPLACE ((NEW.dst), '([0-9]+\.){3}[0-9]+:|([0-9]+\.){3}[0-9]+', '' ); set NEW.dst = REGEXP_REPLACE ((NEW.dst), ':[0-9]+', '' ); set NEW.flags = REGEXP_REPLACE ((NEW.flags), '\\(|\\)', '' ); end // delimiter ;</span></span></code> </pre> <br>  REGEXP_REPLACE busca el segundo par√°metro despu√©s del punto decimal (temporada regular) y lo reemplaza con el tercer par√°metro, en nuestro caso no hay nada entre comillas, por lo tanto, simplemente elimina lo que encuentra. <br><br>  Hagamos un inserto de prueba, similar a c√≥mo lo har√° el registrador: <br><br><pre> <code class="sql hljs"><span class="hljs-comment"><span class="hljs-comment">--   insert into traffic (datetime, inif, outif, src, dst, smac, proto, chain, logpref) values (20180730075437, 'in:ether6', 'out:VLAN55', '192.168.0.234:4997', '192.168.6.18:65535', '00:15:17:31:b8:d7', 'TCP', '(SYN)', 'forward', 'BLOCKSMKNETS');</span></span></code> </pre> <br>  Veamos que pas√≥: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">select</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> tarffic;</code> </pre> <br>  Si todo est√° correcto, entonces sigue adelante.  Si no, busque el error. <br><br>  Agregue al menos un √≠ndice.  No soy un maestro en la creaci√≥n de √≠ndices, pero seg√∫n tengo entendido, en mysql es m√°s correcto usar √≠ndices con diferentes campos de uni√≥n para diferentes consultas, ya que una consulta puede usar solo un √≠ndice (¬øo me equivoco?).  Si lo comprende, h√°galo a su discreci√≥n. <br>  A menudo tengo que hacer solicitudes con un prefijo espec√≠fico, as√≠ que agregu√© este √≠ndice: <br><pre> <code class="sql hljs"><span class="hljs-comment"><span class="hljs-comment">--  create index traffic_index on traffic (datetime,logpref,src);</span></span></code> </pre> <br>  Listo <br><br>  Ahora debe comenzar a enviar en el enrutador, agregar la configuraci√≥n y la acci√≥n del servidor de registro remoto, agregar la opci√≥n de registro a una de las reglas del firewall, agregar un prefijo de no m√°s de 24 caracteres. <br><br>  En la consola Mikrotik, se ve m√°s o menos as√≠: <br><br><pre> <code class="plaintext hljs">/system logging action set 3 remote=192.168.0.94 src-address=192.168.0.230 add name=remote2 remote=192.168.0.19 syslog-facility=local6 target=remote /system logging add action=remote topics=error,account,critical,event,info add action=remote2 topics=firewall /ip firewall filter ... add action=drop chain=input comment="drop ssh brute forcers" dst-port=22,8291 log=yes log-prefix=DROP_SSH_BRUTE protocol=tcp src-address-list=ssh_blacklist ...</code> </pre><br>  Donde 192.168.0.230 es la direcci√≥n del enrutador, 192.168.0.19 es la direcci√≥n del servidor de registro para los registros del firewall y 192.168.0.94 es otro servidor de registro, tengo registros del sistema Mikrotik all√≠, no lo necesitamos ahora.  Nuestra configuraci√≥n es remota2. <br><br>  A continuaci√≥n, vea lo que cae en el archivo: <br><br><pre> <code class="plaintext hljs">tail -f /var/log/remote/192.168.0.230.log</code> </pre> <br>  Las l√≠neas del enrutador deben guardarse en el archivo, a menos que, por supuesto, su regla se active con bastante frecuencia. <br><br>  Si faltan algunos campos, es decir, no se sigue la secuencia datetime, inif, outif, src, dst, smac, proto, flags, chain, logpref, len, puede intentar cambiar el par√°metro en las plantillas de depuraci√≥n del registrador, reemplazar BLANK con DLFT.  Luego, en lugar del vac√≠o de cualquier campo, aparecer√°n algunas letras, ya no recuerdo cu√°les.  Si esto sucede, entonces algo est√° mal con el horario regular y necesita arreglarlo. <br><br>  Si todo sali√≥ como deber√≠a, apague las condiciones de prueba y la plantilla. <br><br>  Tambi√©n necesita ejecutar la configuraci√≥n predeterminada en /etc/rsyslog.d/ a continuaci√≥n, le cambi√© el nombre a 50-default.conf para que los registros remotos no se viertan en el registro del sistema / var / log / message <br>  Reinicie el registrador. <br><br>  Esperemos un poco hasta que nuestra base de datos est√© llena.  Entonces podemos comenzar la selecci√≥n. <br><br>  <b>Algunas consultas para un ejemplo:</b> <br><br><div class="spoiler">  <b class="spoiler_title">Para ver el tama√±o de la base de datos y el n√∫mero de filas:</b> <div class="spoiler_text"><pre> <code class="sql hljs">MariaDB [traflog]&gt; <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> table_schema <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-string"><span class="hljs-string">"database"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">round</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">sum</span></span>(data_length + index_length)/<span class="hljs-number"><span class="hljs-number">1024</span></span>/<span class="hljs-number"><span class="hljs-number">1024</span></span>,<span class="hljs-number"><span class="hljs-number">2</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-string"><span class="hljs-string">"size Mb"</span></span>, TABLE_ROWS <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-string"><span class="hljs-string">"count rows"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> information_schema.tables <span class="hljs-keyword"><span class="hljs-keyword">group</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> table_schema; +<span class="hljs-comment"><span class="hljs-comment">--------------------+---------+------------+ | database | size Mb | count rows | +--------------------+---------+------------+ | information_schema | 0.17 | NULL | | traflog | 3793.39 | 21839553 | +--------------------+---------+------------+ 2 rows in set (0.48 sec)</span></span></code> </pre><br>  Casi 4 GB han crecido en un mes, pero depende del n√∫mero y las propiedades de las reglas de firewall registradas <br></div></div><br><div class="spoiler">  <b class="spoiler_title">N√∫mero de prefijos registrados</b> <div class="spoiler_text">  El n√∫mero de prefijos registrados no es igual al n√∫mero de reglas, algunas reglas funcionan con un prefijo, pero ¬øcu√°ntos prefijos totales hay?  y cu√°ntas reglas se han elaborado para ellos? <br><br><pre> <code class="sql hljs">MariaDB [traflog]&gt; <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> logpref,<span class="hljs-keyword"><span class="hljs-keyword">count</span></span>(logpref) <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> traffic <span class="hljs-keyword"><span class="hljs-keyword">group</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> logpref <span class="hljs-keyword"><span class="hljs-keyword">order</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> <span class="hljs-keyword"><span class="hljs-keyword">count</span></span>(logpref) <span class="hljs-keyword"><span class="hljs-keyword">desc</span></span>; +<span class="hljs-comment"><span class="hljs-comment">----------------------+----------------+ | logpref | count(logpref) | +----------------------+----------------+ | ACCEPT_TORF_INET | 14582602 | | ACCEPT_SMK_PPP | 1085791 | | DROP_FORWARD_INVALID | 982374 | | REJECT_BNK01 | 961503 | | ACCEPT_MMAX_TORF | 802455 | | ACCEPT_TORF_PPP | 736803 | | SMTP_DNAT | 689533 | | ACCEPT_SMK_INET | 451411 | | ACCEPT_INET_TORF | 389857 | | BLOCK_SMKNETS | 335424 | | DROP_SMTP_BRUTE | 285850 | | ACCEPT_ROZN_TORF | 154811 | | ACCEPT_TORF_MMAX | 148393 | | DROP_ETHALL_ETHALL | 80679 | | ACCEPT_SMTP | 48921 | | DROP_SMTP_DDOS | 32190 | | RDP_DNAT | 28757 | | ACCEPT_TORF_ROZN | 18456 | | SIP_DNAT | 15494 | | 1CWEB_DNAT | 6406 | | BLOCKSMKNETS | 5789 | | DROP_SSH_BRUTE | 3162 | | POP_DNAT | 1997 | | DROP_RDP_BRUTE | 442 | | DROP_BNK01 | 291 | | DROPALL | 138 | | ACCEPT_RTP_FORWARD | 90 | | REJECT_SMTP_BRUTE | 72 | | L2TP_INPUT_ACCEPT | 33 | +----------------------+----------------+ 29 rows in set (2 min 51.03 sec)</span></span></code> </pre> <br>  ACCEPT_TORF_INET es el l√≠der, con este prefijo puede encontrar a todos los que ingresaron a Internet desde nuestra red local, se registran protocolos y puertos, llegar√° el momento y se cerrar√° el acceso para algunos.  Hay datos de referencia para futuros trabajos sobre errores. <br></div></div><br><div class="spoiler">  <b class="spoiler_title">Smtp lanza l√≠der</b> <div class="spoiler_text">  Veamos qui√©n trat√≥ hoy de llegar al servidor smtp: <br><br><pre> <code class="sql hljs">MariaDB [traflog]&gt; <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> src,<span class="hljs-keyword"><span class="hljs-keyword">count</span></span>(dport) <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> traffic <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> logpref=<span class="hljs-string"><span class="hljs-string">'SMTP_DNAT'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> datetime &gt; <span class="hljs-string"><span class="hljs-string">'2018101600000000'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">group</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> src <span class="hljs-keyword"><span class="hljs-keyword">order</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> <span class="hljs-keyword"><span class="hljs-keyword">count</span></span>(dport) <span class="hljs-keyword"><span class="hljs-keyword">desc</span></span> <span class="hljs-keyword"><span class="hljs-keyword">limit</span></span> <span class="hljs-number"><span class="hljs-number">10</span></span>; +<span class="hljs-comment"><span class="hljs-comment">----------------+--------------+ | src | count(dport) | +----------------+--------------+ | 191.96.249.92 | 12440 | | 191.96.249.24 | 4556 | | 191.96.249.61 | 4537 | | 185.255.31.122 | 3119 | | 178.57.79.250 | 226 | | 185.36.81.174 | 216 | | 185.234.219.32 | 211 | | 89.248.162.145 | 40 | | 45.125.66.157 | 32 | | 188.165.124.31 | 21 | +----------------+--------------+ 10 rows in set, 1 warning (21.36 sec)</span></span></code> </pre> <br>  Claramente, el nodo 191.96.249.92 es el ganador hoy.  Veamos en qu√© reglas registradas todav√≠a apareci√≥: <br><br><pre> <code class="sql hljs">MariaDB [traflog]&gt; <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> src,dport,<span class="hljs-keyword"><span class="hljs-keyword">count</span></span>(dport),logpref <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> traffic <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> src=<span class="hljs-string"><span class="hljs-string">'191.96.249.92'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">group</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> logpref <span class="hljs-keyword"><span class="hljs-keyword">order</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> <span class="hljs-keyword"><span class="hljs-keyword">count</span></span>(dport) <span class="hljs-keyword"><span class="hljs-keyword">desc</span></span>; +<span class="hljs-comment"><span class="hljs-comment">---------------+-------+--------------+-----------------+ | src | dport | count(dport) | logpref | +---------------+-------+--------------+-----------------+ | 191.96.249.92 | 25 | 226989 | SMTP_DNAT | | 191.96.249.92 | 25 | 170714 | DROP_SMTP_BRUTE | | 191.96.249.92 | 25 | 2907 | DROP_SMTP_DDOS | | 191.96.249.92 | 25 | 2061 | ACCEPT_SMTP | +---------------+-------+--------------+-----------------+ 4 rows in set (10 min 44.21 sec)</span></span></code> </pre><br>  Este se especializa solo en smtp, ~ 1% de aciertos por tratar de adivinar la contrase√±a o intentar enviar algo de basura, el resto fue a la casa de ba√±os. <br><br>  La solicitud tard√≥ 10 minutos, esto es mucho, los √≠ndices actuales no son adecuados para ello, o puede reformular la solicitud, pero ahora no hablaremos de eso. <br></div></div><br>  En el futuro, est√° previsto atornillar la interfaz web con consultas y formularios est√°ndar. <br>  El vector est√° dado, espero que este art√≠culo sea √∫til. <br><br>  Gracias a todos! <br><br>  <b>Referencias</b> <br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Documentaci√≥n de Rsyslog</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Documentaci√≥n de MySQL</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Documentaci√≥n de registro de Mikrotik</a> <br><br>  Gracias a la comunidad LOR por los <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">consejos.</a> <br><br>  <b>UPD.1</b> <br>  Se agreg√≥ el campo de banderas a la base de datos, ahora puede rastrear la duraci√≥n de la conexi√≥n capturando SYN, FIN. <br>  Se corrigieron algunos errores en los regulares de rsyslog, as√≠ como tambi√©n en los desencadenantes de mysql. <br><br>  Curiosamente, la regla predeterminada defconf: drop invalid deja todos los paquetes finales de conexiones TCP, como resultado, todos los nodos que intentan cerrar la conexi√≥n en ciencia fallan, enviando varios FIN.  ¬øEs esto correcto? <br><br>  Agregu√© una regla que permite el recorrido TCP con ACK, banderas FIN. <br><br>  Bajo el spoiler de SQL, un procedimiento que muestra el tiempo de las conexiones TCP en los √∫ltimos cinco minutos <br><div class="spoiler">  <b class="spoiler_title">connections_list ()</b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">DROP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">PROCEDURE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXISTS</span></span> connections_list; DELIMITER // <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">PROCEDURE</span></span> connections_list() <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> logid <span class="hljs-built_in"><span class="hljs-built_in">BIGINT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">UNSIGNED</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> done <span class="hljs-built_in"><span class="hljs-built_in">INT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-literal"><span class="hljs-literal">FALSE</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> datefin DATETIME; <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> datesyn DATETIME; <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> conntime <span class="hljs-built_in"><span class="hljs-built_in">TIME</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> connsport <span class="hljs-built_in"><span class="hljs-built_in">INT</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> conndport <span class="hljs-built_in"><span class="hljs-built_in">INT</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> connsrc <span class="hljs-built_in"><span class="hljs-built_in">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">21</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> conndst <span class="hljs-built_in"><span class="hljs-built_in">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">21</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> cur <span class="hljs-keyword"><span class="hljs-keyword">CURSOR</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FOR</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">id</span></span>,datetime,src,sport,dst,dport <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> conn_syn_fin <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> flags=<span class="hljs-string"><span class="hljs-string">'SYN'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> CONTINUE <span class="hljs-keyword"><span class="hljs-keyword">HANDLER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FOR</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FOUND</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> done=<span class="hljs-literal"><span class="hljs-literal">TRUE</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">DROP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXISTS</span></span> conn_syn_fin; <span class="hljs-keyword"><span class="hljs-keyword">DROP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXISTS</span></span> connless; <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">temporary</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> connless(datestart DATETIME,dateend DATETIME,<span class="hljs-keyword"><span class="hljs-keyword">duration</span></span> <span class="hljs-built_in"><span class="hljs-built_in">TIME</span></span>,src <span class="hljs-built_in"><span class="hljs-built_in">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">21</span></span>),sport <span class="hljs-built_in"><span class="hljs-built_in">INT</span></span>,dst <span class="hljs-built_in"><span class="hljs-built_in">VARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">21</span></span>),dport <span class="hljs-built_in"><span class="hljs-built_in">INT</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">temporary</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> conn_syn_fin (<span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> traffic <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> datetime &gt; <span class="hljs-keyword"><span class="hljs-keyword">now</span></span>() - <span class="hljs-built_in"><span class="hljs-built_in">interval</span></span> <span class="hljs-number"><span class="hljs-number">5</span></span> <span class="hljs-keyword"><span class="hljs-keyword">minute</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> src <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">select</span></span> src <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> traffic <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> datetime &gt; <span class="hljs-keyword"><span class="hljs-keyword">now</span></span>() - <span class="hljs-built_in"><span class="hljs-built_in">interval</span></span> <span class="hljs-number"><span class="hljs-number">5</span></span> <span class="hljs-keyword"><span class="hljs-keyword">minute</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> logpref=<span class="hljs-string"><span class="hljs-string">'TCP_FIN'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> flags <span class="hljs-keyword"><span class="hljs-keyword">like</span></span> <span class="hljs-string"><span class="hljs-string">'%FIN%'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> (flags <span class="hljs-keyword"><span class="hljs-keyword">like</span></span> <span class="hljs-string"><span class="hljs-string">'%SYN%'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> flags <span class="hljs-keyword"><span class="hljs-keyword">like</span></span> <span class="hljs-string"><span class="hljs-string">'%FIN%'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">order</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> <span class="hljs-keyword"><span class="hljs-keyword">id</span></span>); OPEN cur; read_loop: LOOP FETCH cur INTO logid,datesyn,connsrc,connsport,conndst,conndport; IF done THEN LEAVE read_loop; <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> datefin=(<span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> datetime <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> conn_syn_fin <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">id</span></span>&gt;logid <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> src=connsrc <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> sport=connsport <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> flags <span class="hljs-keyword"><span class="hljs-keyword">like</span></span> <span class="hljs-string"><span class="hljs-string">'%FIN%'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> dst=conndst <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> dport=conndport <span class="hljs-keyword"><span class="hljs-keyword">limit</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> conntime=(<span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">timediff</span></span>(datefin,datesyn)); <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> connless (datestart,dateend,<span class="hljs-keyword"><span class="hljs-keyword">duration</span></span>,src,sport,dst,dport) <span class="hljs-keyword"><span class="hljs-keyword">value</span></span> (datesyn,datefin,conntime,connsrc,connsport,conndst,conndport); <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> <span class="hljs-keyword"><span class="hljs-keyword">LOOP</span></span>; CLOSE cur; <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> connless; <span class="hljs-keyword"><span class="hljs-keyword">END</span></span>; // DELIMITER ;</code> </pre><br></div></div><br>  Como resultado del procedimiento, se crear√°n dos tablas temporales. <br>  La tabla <b>conn_syn_fin</b> contiene entradas de registro con los indicadores SYN y FIN, luego se realiza una b√∫squeda utilizando el cursor en esta tabla. <br>  La tabla <b>sinn</b> contiene una lista de conexiones, abiertas y completadas, completadas tienen una duraci√≥n de abierto, respectivamente, no. <br>  Tenga en cuenta el tiempo de muestreo menos cinco minutos desde la hora actual.  Mi pedido es lento  Lentamente busca a trav√©s del cursor, procesa alrededor de 10 registros por segundo, intenta acelerarlo en todos los sentidos, pero el tiempo de ejecuci√≥n es siempre el mismo. <br>  Tambi√©n tenga en cuenta que este procedimiento es solo para fines de demostraci√≥n.  Si necesita hacer una selecci√≥n para un src / sport / dst / dport espec√≠fico, es mejor hacer un procedimiento separado similar a este.  Si eres un maestro SQL, entonces puedes escribir mejor tu consulta. <br><br><div class="spoiler">  <b class="spoiler_title">llamar a connections_list ();</b> <div class="spoiler_text"><pre> <code class="sql hljs">MariaDB [traflog]&gt; <span class="hljs-keyword"><span class="hljs-keyword">call</span></span> connections_list(); +<span class="hljs-comment"><span class="hljs-comment">---------------------+---------------------+----------+---------------+-------+-----------------+-------+ | datestart | dateend | duration | src | sport | dst | dport | +---------------------+---------------------+----------+---------------+-------+-----------------+-------+ | 2019-03-20 14:12:19 | 2019-03-20 14:13:14 | 00:00:55 | 192.168.0.81 | 41868 | 87.250.250.207 | 443 | | 2019-03-20 14:12:25 | NULL | NULL | 192.168.0.65 | 49311 | 52.5.23.125 | 443 | | 2019-03-20 14:12:31 | 2019-03-20 14:12:51 | 00:00:20 | 192.168.0.104 | 54433 | 217.69.139.42 | 443 | | 2019-03-20 14:12:31 | 2019-03-20 14:12:51 | 00:00:20 | 192.168.0.104 | 54434 | 217.69.139.42 | 443 | | 2019-03-20 14:12:32 | NULL | NULL | 192.168.0.119 | 37977 | 209.85.233.95 | 443 | ... | 2019-03-20 14:17:12 | NULL | NULL | 192.168.0.119 | 39331 | 91.213.158.131 | 443 | | 2019-03-20 14:17:13 | NULL | NULL | 192.168.0.90 | 63388 | 87.240.185.236 | 443 | +---------------------+---------------------+----------+---------------+-------+-----------------+-------+ 399 rows in set (33.17 sec) Query OK, 0 rows affected (33.18 sec)</span></span></code> </pre><br></div></div><br><br>  Una vez completado el procedimiento, las tablas temporales <b>conn_syn_fin</b> y <b>connless</b> permanecen, puede verlas con m√°s detalle si encuentra algo sospechoso o no confiable.  Despu√©s de comenzar el procedimiento, se eliminan las tablas antiguas y aparecen las nuevas.  Escribe si encuentras un error. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/es427159/">https://habr.com/ru/post/es427159/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../es427147/index.html">"Modelo de referencia BIAN" para la industria bancaria o c√≥mo dejar de reinventar la rueda</a></li>
<li><a href="../es427149/index.html">Altavoces RADIOTEHNIKA S-30 viejos a nuevos</a></li>
<li><a href="../es427151/index.html">El proceso educativo en TI: Olimpiadas, becas, programas de apoyo y comunidades de la Universidad ITMO.</a></li>
<li><a href="../es427153/index.html">ADN Mecanismos para almacenar y procesar informaci√≥n. Parte II</a></li>
<li><a href="../es427155/index.html">Southampton Filter Bus - El primer paso para ciudades m√°s limpias</a></li>
<li><a href="../es427163/index.html">El nuevo material ayudar√° a que las plantas de energ√≠a solar t√©rmica sean m√°s eficientes</a></li>
<li><a href="../es427165/index.html">C√≥mo desarrollar pruebas de integraci√≥n para Atlassian Jira Server (jira-func-test-plugin)</a></li>
<li><a href="../es427169/index.html">Tesla silenciosamente elimin√≥ la opci√≥n de piloto autom√°tico completo</a></li>
<li><a href="../es427171/index.html">La seguridad te deja</a></li>
<li><a href="../es427173/index.html">¬øLa telefon√≠a es m√°s barata que gratuita?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>