<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ü§Ωüèæ ‚ö°Ô∏è üë©üèæ‚Äçüç≥ Distribuidor de jato ok.ru/music ‚úåüèæ üë©üèæ‚Äçüé§ üèÇüèº</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Trabalho na equipe da plataforma Odnoklassniki e hoje falarei sobre os detalhes de arquitetura, design e implementa√ß√£o do servi√ßo de distribui√ß√£o de m...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Distribuidor de jato ok.ru/music</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/odnoklassniki/blog/434206/"><img src="https://habrastorage.org/webt/m8/yb/sn/m8ybsnu0c1bqakexungs-hkisui.png"><br><br>  Trabalho na equipe da plataforma Odnoklassniki e hoje falarei sobre os detalhes de arquitetura, design e implementa√ß√£o do servi√ßo de distribui√ß√£o de m√∫sicas. <br><a name="habracut"></a><br><blockquote>  O artigo √© uma transcri√ß√£o do <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">relat√≥rio</a> no <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Joker 2018</a> . </blockquote><br><h1>  Algumas estat√≠sticas </h1><br>  Primeiro, algumas palavras sobre OK.  Este √© um servi√ßo gigantesco usado por mais de 70 milh√µes de usu√°rios.  S√£o atendidos por 7 mil carros em 4 data centers.  Recentemente, ultrapassamos a marca de tr√°fego de 2 Tb / s sem levar em conta os in√∫meros sites da CDN.  Tiramos o m√°ximo proveito do nosso hardware, os servi√ßos mais carregados atendem at√© 100.000 solicita√ß√µes por segundo a partir de um n√≥ quad-core.  Al√©m disso, quase todos os servi√ßos s√£o escritos em Java. <br><br>  H√° muitas se√ß√µes em OK, uma das mais populares √© "M√∫sica".  Nele, os usu√°rios podem fazer upload de suas faixas, comprar e baixar m√∫sicas de qualidade diferente.  A se√ß√£o possui um cat√°logo maravilhoso, sistema de recomenda√ß√£o, r√°dio e muito mais.  Mas o principal objetivo do servi√ßo, √© claro, √© tocar m√∫sica. <br><br>  O distribuidor de m√∫sica √© respons√°vel por transferir dados para players do usu√°rio e aplicativos m√≥veis.  Voc√™ pode captur√°-lo no inspetor da web se observar as solicita√ß√µes para o dom√≠nio musicd.mycdn.me.  A API do distribuidor √© extremamente simples.  Ele responde √†s solicita√ß√µes <code>GET</code> HTTP e emite o intervalo de faixas solicitado. <br><br><img src="https://habrastorage.org/webt/j9/va/ze/j9vazesvr2fuqtpvhec0uj7gbmq.png"><br><br>  No pico, a carga atinge 100 Gb / s atrav√©s de meio milh√£o de conex√µes.  De fato, o distribuidor de m√∫sica √© uma interface de cache em frente ao nosso reposit√≥rio interno de faixas, que √© baseado no <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">One Blob Storage</a> e <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">One Cold Storage</a> e cont√©m petabytes de dados. <br><br>  Desde que eu falei sobre cache, vejamos as estat√≠sticas de reprodu√ß√£o.  Vemos um TOP pronunciado. <br><br><img src="https://habrastorage.org/webt/q6/jv/pc/q6jvpcopw2t0xt29sl84lwp1gkg.png"><br><br>  Aproximadamente 140 faixas cobrem 10% de todas as execu√ß√µes por dia.  Se queremos que nosso servidor de cache tenha um hit de cache de pelo menos 90%, precisamos de meio milh√£o de faixas para caber nele.  95% - quase um milh√£o de faixas. <br><br><h1>  Requisitos do Distribuidor </h1><br>  Que objetivos nos estabelecemos ao desenvolver a pr√≥xima vers√£o do distribuidor? <br><br>  Quer√≠amos que um n√≥ pudesse armazenar 100 mil conex√µes.  E essas s√£o conex√µes lentas do cliente: um monte de navegadores e aplicativos m√≥veis em redes com velocidades variadas.  Ao mesmo tempo, o servi√ßo, como todos os nossos sistemas, deve ser escal√°vel e tolerante a falhas. <br><br>  Antes de tudo, precisamos escalar a largura de banda do cluster para acompanhar a crescente popularidade do servi√ßo e poder fornecer mais e mais tr√°fego.  Tamb√©m √© necess√°rio poder dimensionar a capacidade total do cache do cluster, porque o acerto do cache e a porcentagem de solicita√ß√µes que cair√£o no armazenamento de trilhas dependem diretamente dele. <br><br>  Hoje √© necess√°rio poder escalar qualquer sistema distribu√≠do horizontalmente, ou seja, adicionar m√°quinas e data centers.  Mas tamb√©m quer√≠amos implementar a escala vertical.  Nosso servidor moderno t√≠pico cont√©m 56 n√∫cleos, 0,5-1 TB de RAM, uma interface de rede de 10 ou 40 Gb e uma d√∫zia de discos SSD. <br><br>  Falando em escalabilidade horizontal, surge um efeito interessante: quando voc√™ tem milhares de servidores e dezenas de milhares de discos, algo constantemente quebra.  A falha no disco √© uma rotina, n√≥s as alteramos de 20 a 30 pe√ßas por semana.  E as falhas no servidor n√£o surpreendem ningu√©m; 2-3 carros por dia est√£o sendo substitu√≠dos.  Eu tamb√©m tive que lidar com falhas no data center, por exemplo, em 2018, ocorreram tr√™s falhas, e essa provavelmente n√£o √© a √∫ltima vez. <br><br>  Por que eu sou tudo isso?  Quando projetamos qualquer sistema, sabemos que eles ser√£o interrompidos mais cedo ou mais tarde.  Portanto, sempre <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">estudamos cuidadosamente os</a> cen√°rios de falha de todos os componentes do sistema.  A principal maneira de lidar com falhas √© atrav√©s da replica√ß√£o de dados: v√°rias c√≥pias dos dados s√£o armazenadas em n√≥s diferentes. <br><br>  Tamb√©m reservamos largura de banda da rede.  Isso √© importante porque se um componente do sistema falhar, n√£o ser√° permitido o carregamento da carga nos componentes restantes. <br><br><h1>  Balanceamento </h1><br>  Primeiro, voc√™ precisa aprender a equilibrar as consultas dos usu√°rios entre os data centers e faz√™-lo automaticamente.  Isso ocorre caso voc√™ precise realizar um trabalho em rede ou se o data center falhar.  Mas o balanceamento tamb√©m √© necess√°rio dentro dos data centers.  E queremos distribuir solicita√ß√µes entre n√≥s n√£o aleatoriamente, mas com pesos.  Por exemplo, quando carregamos uma nova vers√£o de um servi√ßo e queremos inserir sem problemas um novo n√≥ em rota√ß√£o.  Os pesos tamb√©m ajudam bastante durante o teste de estresse: aumentamos o peso e colocamos uma carga muito mais pesada no n√≥ para entender os limites de suas capacidades.  E quando um n√≥ falha sob carga, rapidamente zeramos o peso e o removemos da rota√ß√£o usando mecanismos de balanceamento. <br><br>  Como √© o caminho da solicita√ß√£o do usu√°rio para o n√≥, que retornar√° os dados levando em considera√ß√£o o balanceamento? <br><br><img src="https://habrastorage.org/webt/uu/tz/uf/uutzuf3bnfpetnns91ca-rcf5mc.png"><br><br>  O usu√°rio efetua login pelo site ou aplicativo m√≥vel e recebe o URL da faixa: <br><br> <code>musicd.mycdn.me/v0/stream?id=...</code> <br> <br>  Para obter o endere√ßo IP do nome do host na URL, o cliente entra em contato com o DNS GSLB, que conhece todos os nossos datacenters e sites CDN.  O DNS GSLB fornece ao cliente o endere√ßo IP do balanceador de um dos data centers, e o cliente estabelece uma conex√£o com ele.  O balanceador conhece todos os n√≥s nos datacenters e seu peso.  Ele, em nome do usu√°rio, estabelece uma conex√£o com um dos n√≥s.  Usamos <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">balanceadores L4 baseados em N4Ware</a> .  Noda fornece os dados do usu√°rio diretamente, ignorando o balanceador.  Em servi√ßos como um distribuidor, o tr√°fego de sa√≠da √© significativamente maior que o de entrada. <br><br>  Se um data center falha, o GSLB DNS detecta isso e o remove rapidamente da rota√ß√£o: deixa de fornecer aos usu√°rios o endere√ßo IP do balanceador desse data center.  Se um n√≥ no datacenter falhar, seu peso ser√° redefinido e o balanceador dentro do datacenter deixar√° de enviar solicita√ß√µes para ele. <br><br>  Agora considere equilibrar as faixas por n√≥s dentro de um datacenter.  Consideraremos os data centers como unidades aut√¥nomas independentes, cada um deles viver√° e trabalhar√°, mesmo que todos os outros tenham morrido.  As faixas precisam ser equilibradas entre as m√°quinas de maneira uniforme para que n√£o haja distor√ß√µes de carga e replic√°-las em n√≥s diferentes.  Se um n√≥ falhar, a carga dever√° ser distribu√≠da igualmente entre os demais. <br><br>  Este problema pode ser <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">resolvido de diferentes maneiras</a> .  Decidimos <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">um hash consistente</a> .  Envolvemos todo o intervalo poss√≠vel de hashes de identificadores de faixa em um anel e, em seguida, cada faixa √© exibida em um ponto desse anel.  Em seguida, distribu√≠mos de maneira mais ou menos uniforme os intervalos de an√©is entre os n√≥s no cluster.  Os n√≥s que armazenam a faixa s√£o selecionados com hash das faixas at√© um ponto no anel e movendo no sentido hor√°rio. <br><br><img src="https://habrastorage.org/webt/qr/ty/xf/qrtyxfbchjhlp5taqfs0fbicnk0.jpeg"><br><br>  Mas esse esquema tem uma desvantagem: em caso de falha do n√≥ N2, por exemplo, toda a sua carga cair√° na pr√≥xima r√©plica no anel - N3.  E se ele n√£o tiver uma margem dupla de desempenho - e isso n√£o for economicamente justificado -, provavelmente o segundo n√≥ tamb√©m ter√° problemas.  N3 com um alto grau de probabilidade se desenvolver√°, a carga ir√° para N4 e assim por diante - haver√° uma falha em cascata ao longo de todo o anel. <br><br>  Esse problema pode ser resolvido aumentando o n√∫mero de r√©plicas, mas a capacidade √∫til total do cluster no anel diminui.  Portanto, fazemos o contr√°rio.  Com o mesmo n√∫mero de n√≥s, o anel √© dividido em um n√∫mero significativamente maior de intervalos espalhados aleatoriamente pelo anel.  As r√©plicas para a faixa s√£o selecionadas de acordo com o algoritmo acima. <br><br><img src="https://habrastorage.org/webt/kc/uf/5-/kcuf5-1mmekp60d5emkp5ckkgps.png"><br><br>  No exemplo acima, cada n√≥ √© respons√°vel por dois intervalos.  Se um dos n√≥s falhar, sua carga inteira n√£o ficar√° no pr√≥ximo n√≥ do anel, mas ser√° distribu√≠da entre os outros dois n√≥s do cluster. <br><br>  O anel √© calculado com base em um pequeno conjunto de par√¢metros algoritmicamente e √© determinado em cada n√≥.  Ou seja, n√£o o armazenamos em algum tipo de configura√ß√£o.  Temos mais de cem mil dessas faixas em produ√ß√£o e, em caso de falha de qualquer um dos n√≥s, a carga √© distribu√≠da de maneira absolutamente uniforme entre todos os outros n√≥s vivos. <br><br>  Como √© a faixa de retorno para o usu√°rio em um sistema com hash consistente? <br><br>  O usu√°rio atrav√©s do balanceador L4 chega a um n√≥ aleat√≥rio.  A sele√ß√£o do n√≥ √© aleat√≥ria, porque o balanceador n√£o sabe nada sobre a topologia.  Mas todas as r√©plicas do cluster sabem disso.  O n√≥ que recebeu a solicita√ß√£o determina se √© uma r√©plica da faixa solicitada.  Caso contr√°rio, alterna para o modo proxy com uma das r√©plicas, estabelece uma conex√£o com ela e procura dados em seu armazenamento local.  Se a faixa n√£o estiver l√°, a r√©plica a puxa do armazenamento de faixas, salva no armazenamento local e fornece o proxy, que redireciona os dados para o usu√°rio. <br><br><img src="https://habrastorage.org/webt/c5/pu/wl/c5puwlig-lfxy20leny4y4utqig.png"><br><br>  Se a unidade na r√©plica falhar, os dados do armazenamento ser√£o transferidos diretamente para o usu√°rio.  E se a r√©plica falhar, o proxy conhecer√° todas as outras r√©plicas dessa faixa, estabelecer√° uma conex√£o com outra r√©plica ao vivo e receber√° dados dela.  Portanto, garantimos que, se um usu√°rio solicitar uma faixa e pelo menos uma r√©plica estiver ativa, ele receber√° uma resposta. <br><br><h1>  Como um n√≥ funciona? </h1><br><img src="https://habrastorage.org/webt/2m/up/ob/2mupob-rqyqsbic50lc-qn2xwqe.png"><br><br>  Um n√≥ √© um pipeline de um conjunto de est√°gios pelos quais a solicita√ß√£o de um usu√°rio passa.  Primeiro, a solicita√ß√£o vai para uma API externa (enviamos tudo via HTTPS).  Em seguida, a solicita√ß√£o √© validada - as assinaturas s√£o verificadas.  Em seguida, as tags IDv3 s√£o constru√≠das, se necess√°rio, por exemplo, ao comprar uma faixa.  A solicita√ß√£o vai para o est√°gio de roteamento, onde, com base na topologia do cluster, √© determinado como os dados ser√£o retornados: ou o n√≥ atual √© uma r√©plica para essa trilha ou faremos proxy de outro n√≥.  No segundo caso, o n√≥ atrav√©s do cliente proxy estabelece uma conex√£o com a r√©plica por meio da API HTTP interna sem verifica√ß√£o de assinaturas.  A r√©plica procura dados no armazenamento local, se encontrar uma faixa, fornece-os a partir do seu disco;  e, se n√£o, ele pega faixas do armazenamento, armazena em cache e d√°. <br><br><h1>  Carga do n√≥ </h1><br>  Vamos estimar qual carga um n√≥ deve conter nessa configura√ß√£o.  Vamos ter tr√™s data centers com quatro n√≥s cada. <br><br><img src="https://habrastorage.org/webt/in/-z/nz/in-znz1gekgg217y9oxdlm5pv-g.png"><br><br>  Todo o servi√ßo deve servir 120 Gbit / s, ou seja, 40 Gbit / s por data center.  Suponha que os operadores de rede tenham feito manobras ou que tenham ocorrido um acidente e que restem dois data centers DC1 e DC3.  Agora, cada um deles deve fornecer 60 Gbit / s.  Mas aqui cabia aos desenvolvedores lan√ßar alguma atualiza√ß√£o, em cada data center havia 3 n√≥s ativos restantes e cada um deles deveria fornecer 20 Gbit / s. <br><br><img src="https://habrastorage.org/webt/6q/tc/sz/6qtcszoeoi4w1zjxvh_o1u35vni.png"><br><br>  Por√©m, inicialmente em cada data center havia 4 n√≥s.  E se armazenarmos duas r√©plicas no data center, com uma probabilidade de 50%, o n√≥ que recebeu a solicita√ß√£o n√£o ser√° uma r√©plica da faixa solicitada e far√° proxy dos dados.  Ou seja, metade do tr√°fego dentro do datacenter √© proxy. <br><br><img src="https://habrastorage.org/webt/yi/aj/tc/yiajtck3angspynaidxuar_t5gm.png"><br><br>  Portanto, um n√≥ deve fornecer aos usu√°rios 20 Gb / s.  Destes, 10 Gb / s s√£o extra√≠dos de seus vizinhos no data center.  Mas o esquema √© sim√©trico: o n√≥ fornece os mesmos 10 Gb / s para os vizinhos no data center.  Acontece que 30 Gbit / s saem do n√≥, dos quais 20 Gbit / s devem ser atendidos por si s√≥, uma vez que √© uma r√©plica dos dados solicitados.  Al√©m disso, os dados ser√£o provenientes de discos ou da RAM, que cont√©m cerca de 50 mil faixas "quentes".  Com base em nossas estat√≠sticas de reprodu√ß√£o, isso permite remover 60 a 70% da carga dos discos e permanecer√° em torno de 8 Gb / s.  Esse segmento √© capaz de fornecer uma d√∫zia de SSDs. <br><br><h1>  Armazenamento de dados em um n√≥ </h1><br>  Se voc√™ colocar cada faixa em um arquivo separado, a sobrecarga de gerenciamento desses arquivos ser√° enorme.  Mesmo reiniciando os n√≥s e varrendo os dados nos discos levar√° minutos, se n√£o dezenas de minutos. <br><br>  Existem limita√ß√µes menos √≥bvias para esse esquema.  Por exemplo, voc√™ pode carregar faixas apenas desde o in√≠cio.  E se o usu√°rio solicitou a reprodu√ß√£o do meio e o cache foi perdido, n√£o poderemos enviar um √∫nico byte at√© carregarmos os dados no local desejado no reposit√≥rio de trilhas.  Al√©m disso, podemos armazenar as faixas apenas como um todo, mesmo que seja um audiolivro gigante que elas parem de ouvir no terceiro minuto.  Ele continuar√° a ter peso morto no disco, desperdi√ßar espa√ßo caro e reduzir a ocorr√™ncia de cache desse n√≥. <br><br>  Portanto, fazemos isso de uma maneira completamente diferente: dividimos as faixas em blocos de 256 KB, porque isso se correlaciona com o tamanho do bloco no SSD e j√° estamos operando com esses blocos.  Um disco de 1 TB cont√©m 4 milh√µes de blocos.  Cada disco em um n√≥ √© um armazenamento independente e todos os blocos de cada faixa s√£o distribu√≠dos por todos os discos. <br><br>  N√£o chegamos imediatamente a esse esquema, a princ√≠pio todos os blocos de uma faixa estavam em um disco.  Mas isso levou a uma forte distor√ß√£o da carga entre os discos, pois se uma faixa popular atingir um dos discos, todos os pedidos de dados ser√£o direcionados para um disco.  Para evitar isso, distribu√≠mos os blocos de cada trilha em todos os discos, equilibrando a carga. <br><br>  Al√©m disso, n√£o esquecemos que temos um monte de RAM, mas decidimos n√£o fazer o cache sem√¢ntico, pois temos um maravilhoso cache de p√°ginas no Linux. <br><br>  Como armazenar blocos em discos? <br><br>  Primeiro, decidimos obter um arquivo XFS gigante do tamanho de um disco e colocar todos os blocos nele.  Ent√£o surgiu a ideia de trabalhar diretamente com um dispositivo de bloco.  Implementamos as duas op√ß√µes, comparamos-as e, ao trabalhar diretamente com um dispositivo de bloco, a grava√ß√£o √© 1,5 vezes mais r√°pida, o tempo de resposta √© 2-3 vezes menor, a carga total do sistema √© 2 vezes menor. <br><br><h1>  √çndice </h1><br>  Mas n√£o basta armazenar blocos; voc√™ precisa manter um √≠ndice de blocos de faixas de m√∫sica para blocos em disco. <br><br><img src="https://habrastorage.org/webt/me/4y/0b/me4y0bk_xbwco9r_5y6smyhmxmc.png"><br><br>  Acabou sendo bastante compacto, uma entrada de √≠ndice leva apenas 29 bytes.  Para um armazenamento de 10 TB, o √≠ndice √© um pouco acima de 1 GB. <br><br>  H√° um ponto interessante aqui.  Em cada um desses registros, voc√™ deve armazenar o tamanho total de toda a faixa.  Este √© um exemplo cl√°ssico de desnormaliza√ß√£o.  O motivo √© que, de acordo com a especifica√ß√£o na resposta do intervalo HTTP, devemos retornar o tamanho total do recurso, bem como formar um cabe√ßalho de comprimento de conte√∫do.  Se n√£o fosse isso, tudo seria ainda mais compacto. <br><br>  Formulamos v√°rios requisitos para o √≠ndice: trabalhar rapidamente (de prefer√™ncia armazenado na RAM), ser compacto e n√£o ocupar espa√ßo no cache da p√°gina.  Outro √≠ndice deve ser persistente.  Se o perdermos, perderemos informa√ß√µes sobre o local no disco em que faixa est√° armazenada e isso equivale √† limpeza dos discos.  E, em geral, eu gostaria que os blocos antigos, que n√£o s√£o acessados ‚Äã‚Äãh√° muito tempo, fossem de alguma forma suplantados, abrindo espa√ßo para faixas mais populares.  Escolhemos <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">a pol√≠tica de exclus√£o de LRU</a> : os blocos s√£o bloqueados a cada minuto, 1% dos blocos s√£o mantidos livres.  Obviamente, a estrutura do √≠ndice deve ser segura para threads, porque temos 100 mil conex√µes por n√≥.  Todas essas condi√ß√µes s√£o idealmente satisfeitas pelo <code>SharedMemoryFixedMap</code> da nossa biblioteca de c√≥digo aberto <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">one-nio</a> . <br><br>  Colocamos o √≠ndice em <code>tmpfs</code> , ele funciona rapidamente, mas h√° uma nuance.  Quando a m√°quina √© reiniciada, tudo o que estava no <code>tmpfs</code> , incluindo o √≠ndice, √© perdido.  Al√©m disso, se devido ao <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><code> sun.misc.Unsafe</code></a> nosso processo travou, n√£o est√° claro em que estado o √≠ndice permaneceu.  Portanto, fazemos uma impress√£o disso uma vez por hora.  Mas isso n√£o √© suficiente: como usamos a extrus√£o de bloco, precisamos oferecer suporte ao <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">WAL</a> , no qual escrevemos informa√ß√µes sobre blocos extrudados.  Entradas sobre blocos em elencos e WALs precisam ser classificadas de alguma forma durante a recupera√ß√£o.  Para fazer isso, usamos o bloco de gera√ß√£o.  Ele desempenha o papel de um contador de transa√ß√µes globais e √© incrementado sempre que o √≠ndice √© alterado.  Vejamos um exemplo de como isso funciona. <br><br>  Fa√ßa um √≠ndice com tr√™s entradas: dois blocos da faixa n¬∫ 1 e um bloco da faixa n¬∫ 2. <br><br><img src="https://habrastorage.org/webt/l6/ux/51/l6ux512_lbpedki0bb3g0ouggau.png"><br><br>  O fluxo de cria√ß√£o de lan√ßamentos √© despertado e iterado por este √≠ndice: a primeira e a segunda tuplas se enquadram no elenco.  Em seguida, o fluxo de aglomera√ß√£o se volta para o √≠ndice, percebe que o s√©timo bloco n√£o foi acessado por um longo tempo e decide us√°-lo para outra coisa.  O processo for√ßa o bloqueio e grava um registro no WAL.  Ele chega ao bloco 9, v√™ que ele n√£o √© contatado h√° muito tempo e tamb√©m o marca como lotado.  Aqui, o usu√°rio acessa o sistema e ocorre uma falha no cache - √© solicitada uma faixa que n√£o temos.  N√≥s salvamos o bloco dessa faixa em nosso reposit√≥rio, substituindo o bloco 9.  Ao mesmo tempo, a gera√ß√£o √© incrementada e se torna igual a 22. Em seguida, √© ativado o processo de cria√ß√£o de um molde, que n√£o concluiu seu trabalho, atinge o √∫ltimo registro e o grava no molde.  Como resultado, temos dois registros ao vivo no √≠ndice, um elenco e o WAL. <br><br><img src="https://habrastorage.org/webt/sy/vj/0_/syvj0_-kknmn4i5pulf_p8bclc4.png"><br><br>  Quando o n√≥ atual cai, ele restaurar√° o estado inicial do √≠ndice da seguinte maneira.  Primeiro, verifique o WAL e crie um mapa de blocos sujo.  O cart√£o armazena o mapeamento do n√∫mero do bloco at√© a gera√ß√£o em que esse bloco foi substitu√≠do. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/9p/g5/gn/9pg5gn-8atbixm4swmytkscxwpm.png" width="300"></div><br><br>  Depois disso, come√ßamos a iterar sobre o molde usando o mapa como filtro.  Olhamos para o primeiro registro do elenco, que se refere ao bloco n√∫mero 3.  Ele n√£o √© mencionado entre os sujos, o que significa que ele est√° vivo e entra no √≠ndice.  Chegamos ao bloco n√∫mero 7 com a d√©cima oitava gera√ß√£o, mas o mapa sujo diz-nos que apenas na 18¬™ gera√ß√£o o bloco estava lotado.  Portanto, ele n√£o se enquadra no √≠ndice.  Chegamos ao √∫ltimo registro, que descreve o conte√∫do do bloco 9 com 22 gera√ß√µes.  Este bloco √© mencionado no mapa de blocos sujo, mas foi substitu√≠do anteriormente.  Portanto, √© reutilizado para novos dados e entra no √≠ndice.  O objetivo √© alcan√ßado. <br><br><h1>  Otimiza√ß√µes </h1><br>  Mas isso n√£o √© tudo, vamos mais fundo. <br><br>  Vamos come√ßar com o cache da p√°gina.  Contamos com isso inicialmente, mas quando come√ßamos a realizar testes de carga da primeira vers√£o, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">a</a> taxa de acertos no cache da p√°gina n√£o atingiu 20%.  Eles sugeriram que o problema fosse lido adiante: n√£o armazenamos arquivos, mas bloqueia, enquanto servimos v√°rias conex√µes e, nessa configura√ß√£o, trabalhar com o disco √© aleatoriamente eficiente.  Quase nunca lemos nada sequencialmente.  Felizmente, no Linux, existe uma chamada <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><code>posix_fadvise</code></a> que permite que voc√™ informe ao kernel como vamos trabalhar com o descritor de arquivo - em particular, podemos dizer que n√£o precisamos ler adiante, passando a flag <code>POSIX_FADV_RANDOM</code> .  Essa chamada do sistema est√° dispon√≠vel no <a href="">one-nio</a> .  Em opera√ß√£o, nosso acerto de cache √© de 70 a 80%.  O n√∫mero de leituras f√≠sicas de discos diminuiu mais de 2 vezes, o atraso na resposta HTTP diminuiu 20%. <br><br>  .     heap.    TLB- ,   Huge Pages   Java-.          (GC Time/Safepoint Total Time  20-30% ),     ,    HTTP latency    . <br><br><h1>  </h1><br>       ( ) . <br><br>             .  ,     ,           ,    ,      .        ,   - .   ,    .  ,        ,    .   ,     Daft Punk    ‚Ññ2  sdc,            sdd. <br><br><img src="https://habrastorage.org/webt/9q/pu/9g/9qpu9gxbc-uph2jp7tsjkup4b5a.png"><br><br> ,            .    Linux <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="></a> :      ,      . <br><br><img src="https://habrastorage.org/webt/3s/y-/vm/3sy-vmtyncu3miiwjhzyu0j9xi4.png"><br><br>   .        ID.   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">WWN</a>           ,   WAL.      ,      ,             . <br><br><h1>   </h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A an√°lise de problemas nesses sistemas distribu√≠dos √© dif√≠cil porque uma solicita√ß√£o do usu√°rio passa por muitos est√°gios e atravessa os limites dos n√≥s. No caso da CDN, tudo se torna ainda mais complicado, porque, para a CDN, o upstream √© o data center dom√©stico. Pode haver muitas dessas esperan√ßas. Al√©m disso, o sistema atende centenas de milhares de conex√µes de usu√°rios. √â muito dif√≠cil entender em que est√°gio h√° um problema no processamento de uma solicita√ß√£o de um usu√°rio espec√≠fico. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">N√≥s simplificamos nossas vidas assim. No login, marcamos todas as solicita√ß√µes com uma tag semelhante a </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Open Tracing</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> e </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Zipkin</font></font></a> .      ,    .          ,    ,       HTTP-    .      ,   ,  ,   ,     ,   ,        . <br><br><h1>   </h1><br>         . ,  :  ,     ,    . <br><br><pre> <code class="java hljs">ByteBuffer buffer = ByteBuffer.allocate(size); <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> count = fileChannel.read(buffer, position); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (count &lt;= <span class="hljs-number"><span class="hljs-number">0</span></span>) { <span class="hljs-comment"><span class="hljs-comment">// ... } buffer.flip(); socketChannel.write(buffer);</span></span></code> </pre> <br>        ,       : <br><br><ul><li>       <code>FileChannel.read()</code>    kernel space  user space; </li><li>            <code>SocketChannel.write()</code> ,    user space  kernel space. </li></ul><br>  ,  Linux   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><code>sendfile()</code></a> ,              ,    user space.  ,     <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">one-nio</a> .                ,      <code>sendfile()</code> ‚Äî    10 /   <code>sendfile()</code>    0. <br><br>     user-space SSL-     <code>sendfile()</code>      ,        .       .     <code>SocketChannel</code>  <code>FileChannel</code> ,   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Async Profiler</a>         ,         <code>sun.nio.ch.IOUtil</code> ,      <code>read()</code>  <code>write()</code>   .    . <br><br><pre> <code class="java hljs">ByteBuffer bb = Util.getTemporaryDirectBuffer(dst.remaining()); <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> n = readIntoNativeBuffer(fd, bb, position, nd); bb.flip(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (n &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) dst.put(bb); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> n; } <span class="hljs-keyword"><span class="hljs-keyword">finally</span></span> { Util.offerFirstTemporaryDirectBuffer(bb); }</code> </pre> <br>    .       heap <code>ByteBuffer</code> ,         ,    ,     heap <code>ByteBuffer</code> ,       .        . <br><br>  .      <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">one-nio</a> .   <code>MallocMT</code> ‚Äî  ,   .    SSL       ,     Java heap,    <code>ByteBuffer</code> ,      <code>FileChannel</code>       .      . <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Allocator allocator = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> MallocMT(size, concurrency); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">write</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Socket socket)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (socket.getSslContext() != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> address = allocator.malloc(size); ByteBuffer buf = DirectMemory.wrap(address, size); <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> available = channel.read(buf, offset); socket.writeRaw(address, available, flags);</code> </pre><br><h1> 100 000    </h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mas o sucesso do sistema n√£o √© garantido por uma implementa√ß√£o razo√°vel nos n√≠veis mais baixos. H√° outro problema aqui. O transportador em cada n√≥ atende at√© 100 mil conex√µes simult√¢neas. Como organizar os c√°lculos nesse sistema? </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A primeira coisa que vem √† mente √© criar um encadeamento de execu√ß√£o para cada cliente ou conex√£o, e nele realizamos os est√°gios do pipeline um ap√≥s o outro. Se necess√°rio, bloqueie e siga em frente. Mas, com esse esquema, os custos das trocas de contexto e das pilhas de fluxos ser√£o excessivos, pois estamos falando de um distribuidor e h√° muitos fluxos. Portanto, seguimos o outro caminho.</font></font><br><br><img src="https://habrastorage.org/webt/mt/vg/eo/mtvgeoszcpcv6zpc-qi_rbqeyhy.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Um pipeline l√≥gico √© criado para cada conex√£o, que consiste em est√°gios interagindo entre si de forma ass√≠ncrona. Cada est√°gio tem uma curva que armazena solicita√ß√µes recebidas. Para a execu√ß√£o de est√°gios, pequenos conjuntos de encadeamentos comuns s√£o usados. Se voc√™ precisar processar uma mensagem da fila de solicita√ß√µes, pegamos um fluxo do pool, processamos a mensagem e retornamos o fluxo ao pool. Com esse esquema, os dados s√£o enviados do armazenamento para o cliente.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mas esse esquema n√£o √© isento de falhas. Os back-ends s√£o muito mais r√°pidos que as conex√µes do usu√°rio. Quando os dados passam pelo pipeline, eles se acumulam no est√°gio mais lento, ou seja, no est√°gio de grava√ß√£o de blocos no soquete de conex√£o do cliente. Cedo ou tarde, isso levar√° ao colapso do sistema. Se voc√™ tentar limitar as filas nesses est√°gios, tudo ser√° interrompido instantaneamente, porque os pipelines da cadeia para o soquete do usu√°rio ser√£o bloqueados. E como eles usam conjuntos de encadeamentos compartilhados, eles bloquear√£o todos os encadeamentos neles. Precisa de contrapress√£o. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Para fazer isso, usamos </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">fluxos de jato</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. A ess√™ncia da abordagem √© que o assinante controla a velocidade dos dados provenientes do editor usando a demanda. Demanda significa quanto mais dados o assinante est√° pronto para processar, juntamente com a demanda anterior que j√° sinalizou. O editor tem o direito de enviar dados, mas n√£o excedendo a demanda total acumulada no momento, menos os dados j√° enviados.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Assim, o sistema alterna dinamicamente entre os modos push e pull. </font><font style="vertical-align: inherit;">No modo push, o assinante √© mais r√°pido que o editor, o que significa que o editor sempre tem uma demanda insatisfat√≥ria do assinante, mas n√£o h√° dados. </font><font style="vertical-align: inherit;">Assim que os dados aparecem, ele os envia imediatamente para o assinante. </font><font style="vertical-align: inherit;">O modo pull ocorre quando o editor √© mais r√°pido que o assinante. </font><font style="vertical-align: inherit;">Ou seja, o editor ficaria feliz em enviar dados, apenas a demanda √© zero. </font><font style="vertical-align: inherit;">Assim que o assinante diz que est√° pronto para processar um pouco mais, o editor envia imediatamente um peda√ßo de dados como parte da demanda. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nosso transportador se transforma em um fluxo de jato. </font><font style="vertical-align: inherit;">Cada est√°gio se transforma em editor para o est√°gio anterior e assinante no pr√≥ximo. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A interface dos fluxos de jato parece extremamente simples. </font></font><code>Publisher</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">vamos assinar</font></font><code>Subscriber</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , e ele deve implementar apenas quatro manipuladores: </font></font><br><br><pre> <code class="java hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Publisher</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">T</span></span></span><span class="hljs-class">&gt; </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">subscribe</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Subscriber&lt;? </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">super</span></span></span></span><span class="hljs-function"><span class="hljs-params"> T&gt; s)</span></span></span></span>; } <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Subscriber</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">T</span></span></span><span class="hljs-class">&gt; </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onSubscribe</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Subscription s)</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onNext</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(T t)</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onError</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Throwable t)</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onComplete</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; } <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Subscription</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">request</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">long</span></span></span></span><span class="hljs-function"><span class="hljs-params"> n)</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">cancel</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; }</code> </pre> <br> <code>Subscription</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> permite sinalizar a demanda e cancelar a inscri√ß√£o. </font></font> Nenhum lugar √© mais f√°cil. <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Como elemento de dados, n√£o passamos matrizes de bytes, mas uma abstra√ß√£o como chunk. </font><font style="vertical-align: inherit;">Fazemos isso para n√£o arrastar os dados na pilha, se poss√≠vel. </font><font style="vertical-align: inherit;">Chunk √© um link de dados com uma interface muito limitada que permite apenas ler dados </font></font><code>ByteBuffer</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, gravar em um soquete ou em um arquivo.</font></font><br><br><pre> <code class="java hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Chunk</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">read</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ByteBuffer dst)</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">write</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Socket socket)</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">write</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(FileChannel channel, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">long</span></span></span></span><span class="hljs-function"><span class="hljs-params"> offset)</span></span></span></span>; }</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Existem muitas implementa√ß√µes de chunks: </font></font><br><br><ul><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O mais popular, usado no caso de acerto no cache e ao enviar dados do disco, √© a implementa√ß√£o no topo </font></font><code>RandomAccessFile</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">O peda√ßo cont√©m apenas um link para o arquivo, o deslocamento nesse arquivo e o tamanho dos dados. </font><font style="vertical-align: inherit;">Ele percorre todo o pipeline, atinge o soquete de conex√£o do usu√°rio e ali se transforma em uma chamada </font></font><code>sendfile()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Ou seja, a mem√≥ria n√£o √© consumida.</font></font></li><li>   cache miss   :             .     , ‚Äî  ,     , ‚Äî      . </li><li> ,    -      heap.        <code>ByteBuffer</code> . </li></ul><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Apesar da simplicidade desta API, ela deve ser segura por thread por especifica√ß√£o e a maioria dos m√©todos deve ser sem bloqueio. </font><font style="vertical-align: inherit;">Escolhemos o caminho no esp√≠rito do Modelo de ator digitado, inspirado em </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">exemplos</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> do </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">reposit√≥rio oficial de </font></font></a> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">jet stream</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Para fazer chamadas de m√©todo sem bloqueio, quando chamamos o m√©todo, pegamos todos os par√¢metros, envolvemos em uma mensagem, colocamos na fila para execu√ß√£o e retornamos o controle. </font><font style="vertical-align: inherit;">As mensagens da fila s√£o processadas estritamente em sequ√™ncia.</font></font><br><br><div class="spoiler"> <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sem sincroniza√ß√£o, o c√≥digo √© simples e direto.</font></font></b> <div class="spoiler_text">     .   publisher  subscriber   ,    ,   executor,       . <code>AtomicBoolean</code>  happens before   . <br><br><pre> <code class="java hljs"><span class="hljs-comment"><span class="hljs-comment">// Incoming messages final Queue&lt;M&gt; mailbox; // Message processing works here final Executor executor; // To ensure HB relationship between runs final AtomicBoolean on = new AtomicBoolean();</span></span></code> </pre> <br>    : <br><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">request</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">long</span></span></span></span><span class="hljs-function"><span class="hljs-params"> n)</span></span></span><span class="hljs-function"> </span></span>{ enqueue(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Request(n)); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">enqueue</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> M message)</span></span></span><span class="hljs-function"> </span></span>{ mailbox.offer(message); tryScheduleToExecute(); }</code> </pre> <br>  <code>tryScheduleToExecute()</code> : <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (on.compareAndSet(<span class="hljs-keyword"><span class="hljs-keyword">false</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>)) { <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { executor.execute(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (Exception e) { ... } }</code> </pre> <br>  <code>run()</code> : <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (on.get()) <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { dequeueAndProcess(); } <span class="hljs-keyword"><span class="hljs-keyword">finally</span></span> { on.set(<span class="hljs-keyword"><span class="hljs-keyword">false</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!messages.isEmpty()) { tryScheduleToExecute(); } } }</code> </pre> <br>  <code>dequeueAndProcess()</code> : <br><br><pre> <code class="java hljs">M message; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> ((message = mailbox.poll()) != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { <span class="hljs-comment"><span class="hljs-comment">// Pattern match if (message instanceof Request) { doRequest(((Request) message).n); } else { ‚Ä¶ } }</span></span></code> </pre> </div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Temos uma implementa√ß√£o completamente sem bloqueio. </font><font style="vertical-align: inherit;">c√≥digo simples e consistente, sem </font></font><code>volatile</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, </font></font><code>Atomic*</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, conten√ß√£o, e outros. </font><font style="vertical-align: inherit;">Em todo o nosso sistema, h√° um total de 200 threads para atender 100.000 conex√µes.</font></font><br><br><h1>  No final </h1><br>  production   12 ,          .        10 /    .     .    Java  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">one-nio</a> . <br><br><img src="https://habrastorage.org/webt/oa/pz/cq/oapzcqjf6y9ccxrnk1wzrpaigdy.jpeg"><br><br>     ,     . 99-  20 .   ‚Äî    HTTPS-.   ‚Äî         <code>sendfile()</code>  HTTP. <br><br>    cache hit  production 97%,    latency   ,         ,   ,   . <br><br><img src="https://habrastorage.org/webt/xp/fd/eq/xpfdequddx6cnglrzrgdxtbspuc.jpeg"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Se voc√™ observar o 75¬∫ percentil ao retornar de discos, o primeiro byte voar√° para o usu√°rio ap√≥s 1 ms. </font><font style="vertical-align: inherit;">As r√©plicas dentro do cluster se comunicam com velocidade ainda maior - elas s√£o respons√°veis ‚Äã‚Äãpor 300 Œºs.</font></font> I.e.<font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0,7 ms √© o custo de proxy. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Neste artigo, quer√≠amos demonstrar como constru√≠mos sistemas escal√°veis ‚Äã‚Äãe altamente carregados, com alta velocidade e excelente toler√¢ncia a falhas. </font><font style="vertical-align: inherit;">Esperamos ter conseguido.</font></font></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt434206/">https://habr.com/ru/post/pt434206/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt434194/index.html">Desenvolvimento de habilidades para Alice. Experi√™ncia com interfaces de voz, dicas para iniciantes</a></li>
<li><a href="../pt434196/index.html">3CX v16 Alpha 2 e planos para o novo ano</a></li>
<li><a href="../pt434198/index.html">Escolhendo um modo operacional de servidor da Web com base na experi√™ncia pessoal</a></li>
<li><a href="../pt434200/index.html">A ferrugem √© t√£o terr√≠vel quanto √© pintada</a></li>
<li><a href="../pt434202/index.html">4 segredos sobre como n√£o perder o emprego na ci√™ncia de dados</a></li>
<li><a href="../pt434208/index.html">Como foi salvo nossa sexta-feira negra</a></li>
<li><a href="../pt434210/index.html">An√°lise do concurso de question√°rios Android do estande do HeadHunter no Mobius 2018 Moscow</a></li>
<li><a href="../pt434212/index.html">Torre Tesla. O que acontece dentro e perto de um arranha-c√©u quando um raio cai?</a></li>
<li><a href="../pt434214/index.html">Proxy din√¢mico Java: o que √© e como us√°-lo?</a></li>
<li><a href="../pt434216/index.html">Ataques de for√ßa bruta usando o Kali Linux</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>