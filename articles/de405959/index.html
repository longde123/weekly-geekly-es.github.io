<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üîê ‚èØÔ∏è üë©‚Äç‚ù§Ô∏è‚Äçüíã‚Äçüë© Blinkende LED im STM32 im Assembler ü§µüèº üì© ü•É</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Vor einiger Zeit wollte ich Assembler lernen, und nachdem ich die einschl√§gige Literatur gelesen hatte, war es Zeit zum √úben. Eigentlich wird es weite...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Blinkende LED im STM32 im Assembler</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/405959/">  Vor einiger Zeit wollte ich Assembler lernen, und nachdem ich die einschl√§gige Literatur gelesen hatte, war es Zeit zum √úben.  Eigentlich wird es weiter diskutiert.  Zuerst √ºbte ich auf Arduino Uno (Atmega328p), jetzt entschied ich mich weiterzumachen und nahm STM32 auf.  STM32F103C8 fiel mir tats√§chlich in die H√§nde und es werden weitere Experimente durchgef√ºhrt. <br><br><h2>  Die Werkzeuge </h2><br>  Ich habe die folgenden Tools verwendet: <br><br><ul><li>  Notepad ++ - zum Schreiben von Code </li><li>  GNU Assembler Compiler </li><li>  STM32 ST-LINK-Dienstprogramm + ST-LINK V2 - zum Flashen des Codes auf dem Mikrocontroller und zum Debuggen </li></ul><br><h2>  Starten Sie </h2><br>  Der Hauptzweck der Assemblersprache ist f√ºr mich das Lernen.  Da Sie nie wissen, wo Sie auf ein anderes interessantes Problem sto√üen k√∂nnen, wurde beschlossen, alles von Grund auf neu zu schreiben.  Die Hauptaufgabe bestand darin, die Funktionsweise des Interrupt-Vektors zu verstehen.  Im Gegensatz zu Atmega in STM32 enth√§lt der Interrupt-Vektor keine Sprunganweisungen: <br><br><pre><code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">jmp</span></span> main</code> </pre> <br>  Darin sind bestimmte Adressen geschrieben, und w√§hrend der Unterbrechung ersetzt der Prozessor selbst die im Vektor im PC-Register angegebene Adresse.  Hier ist ein Beispiel f√ºr meinen Interrupt-Vektor: <br><br><pre> <code class="hljs css"><span class="hljs-selector-class"><span class="hljs-selector-class">.org</span></span> 0<span class="hljs-selector-tag"><span class="hljs-selector-tag">x00000000</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">SP</span></span>: <span class="hljs-selector-class"><span class="hljs-selector-class">.word</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">STACKINIT</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">RESET</span></span>: <span class="hljs-selector-class"><span class="hljs-selector-class">.word</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">main</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">NMI_HANDLER</span></span>: <span class="hljs-selector-class"><span class="hljs-selector-class">.word</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">nmi_fault</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">HARD_FAULT</span></span>: <span class="hljs-selector-class"><span class="hljs-selector-class">.word</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">hard_fault</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">MEMORY_FAULT</span></span>: <span class="hljs-selector-class"><span class="hljs-selector-class">.word</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">memory_fault</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">BUS_FAULT</span></span>: <span class="hljs-selector-class"><span class="hljs-selector-class">.word</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">bus_fault</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">USAGE_FAULT</span></span>: <span class="hljs-selector-class"><span class="hljs-selector-class">.word</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">usage_fault</span></span> <span class="hljs-selector-class"><span class="hljs-selector-class">.org</span></span> 0<span class="hljs-selector-tag"><span class="hljs-selector-tag">x000000B0</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">TIMER2_INTERRUPT</span></span>: <span class="hljs-selector-class"><span class="hljs-selector-class">.word</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">timer2_interupt</span></span> + 1</code> </pre><br>  Ich m√∂chte den Leser darauf aufmerksam machen, dass die erste Zeile nicht der R√ºcksetzvektor ist, sondern die Werte, mit denen der Stapel initialisiert wird.  Unmittelbar danach gibt es einen R√ºcksetzvektor, gefolgt von 5 obligatorischen Interruptvektoren (NMI_HANDLER - USAGE_FAULT). <br><a name="habracut"></a><br><h2>  Entwicklung </h2><br>  Das erste, woran ich festhielt, war die ARM-Assembler-Syntax.  Sogar w√§hrend des Studiums des Interrupt-Vektors stie√ü ich auf Hinweise darauf, dass ARM zwei Arten von Anweisungen hat: Daumen und nicht Daumen.  Und dieser Cortex-M3 (STM32F103C8, n√§mlich Cortex-M3) unterst√ºtzt nur einen Satz von Thumb-Anweisungen.  Ich habe Anweisungen streng nach der Dokumentation geschrieben, aber aus irgendeinem Grund hat der Assembler sie beschimpft. <blockquote>  nicht verschobenes Register erforderlich </blockquote>  Es stellte sich heraus, dass zu Beginn des Programms <blockquote>  .syntax vereinheitlicht </blockquote>  Dies teilt dem Assembler mit, dass Sie Thumb- und Nicht-Thumb-Anweisungen gleichzeitig verwenden k√∂nnen. <br><br>  Als n√§chstes stie√ü ich auf die deaktivierten Standard-GPOI-Ports.  Damit sie funktionieren, m√ºssen Sie unter anderem die entsprechenden Werte in den RCC-Registern (Reset and Clock Control) festlegen.  Ich habe PORT C verwendet. Es kann durch Setzen von Bit 4 (Nummerierung der Bits von Grund auf neu) in RCC_APB2ENR (Peripherie-Clock-Enable-Register 2) aktiviert werden. <br><br>  Weitere blinkende LED.  Zun√§chst m√ºssen Sie wie in Arduino einen Pin f√ºr die Aufnahme setzen.  Dies erfolgt √ºber GPIOx_CRL (Steuerregister niedrig) oder GPIOx_CRH (Steuerregister hoch).  Hier muss aufgehoben werden, dass f√ºr jeden Pin 4 Bits in einem dieser Register (32-Bit-Register) verantwortlich sind.  2 Bit (MODEy) bestimmen die maximale Datenrate und die 2 Bit (CNF) -Pin-Konfiguration.  Ich habe PORT C Pin 14 verwendet, daf√ºr habe ich die Bits [25:24] = 10 und die Bits [27:26] = 00 im GPIOx_CRH-Register gesetzt. <br><br>  Damit die Diode brennt, m√ºssen Sie das entsprechende Bit in GPIOx_ODR (Ausgangsdatenregister) setzen.  In meinem Fall Bit 14. Dies k√∂nnte dieses einfache Beispiel beenden, indem eine Verz√∂gerungsfunktion erstellt und alles in eine Schleife gestellt wird, aber ich konnte dies nicht tun.  Ich habe beschlossen, Timer-Interrupts einzustellen ... Wie sich herausstellte, war es vergebens, vor allem, weil die Timer f√ºr diese Art von Aufgabe zu schnell sind. <br><br>  Ich werde die Timer-Einstellungen, die sich f√ºr den Code auf <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Github</a> interessieren, nicht im Detail beschreiben.  Die Idee war einfach: Senden Sie den Prozessor in einem Zyklus in den Leerlauf, beenden Sie den Leerlauf per Timer, um die LED ein- und auszuschalten, und erneut in den Leerlauf.  Aber der Timer arbeitete viel schneller als ich es geschafft hatte, all das zu tun, weshalb ich einen zus√§tzlichen Z√§hler eingeben musste. <br><br>  Der Z√§hler ist eine 32-Bit-Variable, die sich im SRAM befinden sollte.  Und dann wartete ein weiterer Rechen auf mich.  Als ich in Atmega programmierte, eine Variable in SRAM zu platzieren, stellte ich √ºber .org die Adresse des Anfangs des Speichers ein, an dem der Datenblock tats√§chlich platziert wurde.  Nachdem ich ein wenig √ºber die Speicherinitialisierung gelesen habe, bin ich mir nicht sicher, ob dies korrekt war, aber es hat funktioniert.  Und ich habe beschlossen, dasselbe mit STM32 zu drehen.  Die Speicherstartadresse in STM32F103C8 lautet 0x20000000.  Und als ich .org an dieser Adresse gemacht habe, habe ich eine 512-MB-Bin√§rdatei erhalten.  Dies schickte mich ein paar N√§chte, um Handb√ºcher zu rauchen.  Ich verstehe immer noch nicht 100%, wie das funktioniert, aber soweit ich verstehe, platziert der Abschnitt .data die Werte, mit denen die Variablen initialisiert werden m√ºssen, in einer ausf√ºhrbaren Datei, aber zur Laufzeit muss der Programmierer die Variablenwerte im Speicher initialisieren.  Korrigieren Sie mich bitte, wenn ich falsch liege.  Am Ende habe ich eine Variable wie diese erstellt: <br><br><pre> <code class="hljs css"><span class="hljs-selector-class"><span class="hljs-selector-class">.section</span></span> <span class="hljs-selector-class"><span class="hljs-selector-class">.bss</span></span> <span class="hljs-selector-class"><span class="hljs-selector-class">.offset</span></span> 0<span class="hljs-selector-tag"><span class="hljs-selector-tag">x20000000</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">flash_counter</span></span>: <span class="hljs-selector-class"><span class="hljs-selector-class">.word</span></span></code> </pre><br>  Initialisiert es zu Beginn der Hauptfunktion und die LED blinkt.  Ich hoffe dieser Artikel hilft jemandem.  Wenn Sie Fragen haben, beantworte ich diese gerne. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de405959/">https://habr.com/ru/post/de405959/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de405949/index.html">Wie ein Elektronenbecher t√∂tete</a></li>
<li><a href="../de405951/index.html">Modernisierung der "Platte" unter der Lampe GX70</a></li>
<li><a href="../de405953/index.html">Neurobiologische Neuigkeiten: Das schlaflose Gehirn frisst sich selbst, der magische Hut von Elon Mask, der Switch-Cutter und etwas anderes</a></li>
<li><a href="../de405955/index.html">Die Versuche der Wissenschaftler, Impfmythen zu zerstreuen, verst√§rkten nur die Wahnvorstellungen der Menschen</a></li>
<li><a href="../de405957/index.html">Ein Softwarefehler hat Hunderte von intelligenten Sperren zum Absturz gebracht</a></li>
<li><a href="../de405961/index.html">ARMOR BOOT 2017: Gr√∂√üer, k√ºhler, st√§rker</a></li>
<li><a href="../de405963/index.html">Ein Anruf vom Mond: Ein deutsches Startup ist dabei, eine LTE-Basisstation auf dem Erdsatelliten einzurichten</a></li>
<li><a href="../de405965/index.html">Geolocation-APIs: IP- oder W3C-Geolocation?</a></li>
<li><a href="../de405967/index.html">Geheime Waffen oder warum Wolkenkratzert√ºrme</a></li>
<li><a href="../de405969/index.html">Die Big Four-Betreiber erf√ºllten nicht die FAS-Anforderung, das nationale Roaming in der Russischen F√∂deration abzubrechen</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>