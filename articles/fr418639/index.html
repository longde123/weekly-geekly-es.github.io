<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ü§≤ üè† üé∂ Akka Streams pour les simples mortels üëåüèø ‚òéÔ∏è üë©üèΩ‚Äçüöí</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Comment puis-je imprimer un flux continu de messages de Twitter avec quelques lignes de code en ajoutant des donn√©es m√©t√©orologiques aux endroits o√π v...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Akka Streams pour les simples mortels</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/jugru/blog/418639/">  Comment puis-je imprimer un flux continu de messages de Twitter avec quelques lignes de code en ajoutant des donn√©es m√©t√©orologiques aux endroits o√π vivent leurs auteurs?  Et comment pouvez-vous limiter la vitesse des demandes au fournisseur m√©t√©o pour qu'il ne nous liste pas? <br><br>  Aujourd'hui, nous vous expliquerons comment proc√©der, mais nous d√©couvrirons tout d'abord la technologie Akka Streams, qui rend le travail avec les flux de donn√©es en temps r√©el aussi simple que les programmeurs travaillant avec des expressions LINQ sans n√©cessiter la mise en ≈ìuvre d'acteurs individuels ou d'interfaces Reactive Streams . <br><br><iframe width="560" height="315" src="https://www.youtube.com/embed/ibpnza_PCr0" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br>  L'article est bas√© sur une transcription du <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">rapport de Vagif Abilov</a> de notre conf√©rence de d√©cembre DotNext 2017 Moscou. <br><a name="habracut"></a><br>  Je m'appelle Vagif, je travaille pour la soci√©t√© norv√©gienne Miles.  Aujourd'hui, nous allons parler de la biblioth√®que Akka Streams. <br><br>  Akka et Reactive Streams sont l'intersection d'ensembles assez √©troits, et on pourrait avoir l'impression que c'est une niche telle que vous devez avoir une grande connaissance pour entrer, mais juste le contraire.  Et cet article est destin√© √† montrer qu'en utilisant Akka Streams, vous pouvez √©viter la programmation de bas niveau qui est requise lors de l'utilisation de Reactive Streams et Akka.NET.  Pour l'avenir, je peux dire imm√©diatement: si au tout d√©but de notre projet, sur lequel nous utilisons Akka, nous connaissions l'existence d'Akka Streams, nous √©cririons beaucoup diff√©remment, nous √©conomiserions √† la fois du temps et du code. <br><blockquote> <i>"Peut-√™tre que le pire que vous puissiez faire est d'amener les personnes qui ne souffrent pas √† prendre votre aspirine."</i> <br>  Max Kreminski <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">¬´Portes ferm√©es, maux de t√™te et besoins intellectuels¬ª</a> </blockquote>  Avant d'entrer dans les d√©tails techniques, un peu sur ce que votre chemin vers Akka Streams peut s'av√©rer √™tre et ce qui peut vous y conduire.  Un jour, je suis tomb√© sur le blog de Max Kreminski, o√π il a pos√© une telle question philosophique aux programmeurs: comment ou pourquoi il est impossible pour un programmeur d'expliquer ce que sont les monades.  Il l'a expliqu√© de cette fa√ßon: tr√®s souvent, les gens vont imm√©diatement aux d√©tails techniques, expliquant √† quel point la programmation est magnifiquement fonctionnelle et √† quel point il y a du sens dans la monade, sans prendre la peine de se demander pourquoi le programmeur pourrait en avoir besoin.  Dessiner une analogie, c'est comme essayer de vendre de l'aspirine sans se soucier de savoir si votre patient souffre. <br><br>  En utilisant cette analogie, je voudrais poser la question suivante: si Akka Streams est de l'aspirine, quelle devrait √™tre la douleur qui vous y conduira? <br><br><h1>  Flux de donn√©es </h1><br>  Parlons d'abord des flux de donn√©es.  Le flux peut √™tre assez simple, lin√©aire. <br><br><div class="oembed"><div><div style="left: 0; width: 100%; height: 0; position: relative; padding-bottom: 56.25%;"><video controls="" style="top: 0; left: 0; width: 100%; height: 100%; position: absolute;">  Votre navigateur ne prend pas en charge la vid√©o HTML5. <source src="https://media.giphy.com/media/ZNejul2eTftImnVrsY/giphy.mp4" type="video/mp4"></video></div></div></div><br>  Ici, nous avons un certain consommateur de donn√©es (un lapin dans la vid√©o).  Il consomme des donn√©es √† une vitesse qui lui convient.  Il s'agit de l'interaction id√©ale du consommateur avec le flux: elle √©tablit la bande passante et les donn√©es y circulent tranquillement.  Ce flux de donn√©es simple peut √™tre infini ou se terminer. <br><br>  Mais le flux peut √™tre plus complexe.  Si vous plantez plusieurs lapins c√¥te √† c√¥te, nous aurons d√©j√† une parall√©lisation des flux.  Ce que Reactive Streams essaie de r√©soudre, c'est pr√©cis√©ment comment nous pouvons communiquer avec les flux √† un niveau plus conceptuel, c'est-√†-dire, que nous parlions simplement d'une sorte de mesure de capteur de temp√©rature, o√π les mesures lin√©aires entrent en jeu. , ou nous avons des mesures en continu de milliers de capteurs de temp√©rature entrant dans le syst√®me via des files d'attente RabbitMQ et stock√©s dans les journaux syst√®me.  Tout ce qui pr√©c√®de peut √™tre consid√©r√© comme un seul flux composite.  Si vous allez encore plus loin, la gestion automatis√©e de la production (par exemple, par une boutique en ligne) peut √©galement √™tre r√©duite √† un flux de donn√©es, et ce serait formidable si nous pouvions parler de la planification d'un tel flux, quelle que soit sa complexit√©. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/a7c/fa0/3af/a7cfa03af65ad4d88c1ce13d316e272e.jpg"><br><br>  Pour les projets modernes, le support des threads n'est pas tr√®s bon.  Si je me souviens bien, Aaron Stannard, dont vous voyez le tweet dans l'image, voulait obtenir un flux d'un fichier de plusieurs gigaoctets contenant CSV, c'est-√†-dire  texte, et il s'est av√©r√© qu'il n'y a rien que vous pouvez simplement prendre et utiliser imm√©diatement, sans un tas d'actions suppl√©mentaires.  Mais il n'a tout simplement pas pu obtenir un flux de valeurs CSV, ce qui l'a attrist√©.  Il y a peu de solutions (√† l'exception de certaines zones sp√©ciales), beaucoup est r√©alis√© par les anciennes m√©thodes, lorsque nous ouvrons tout cela, commen√ßons la lecture, la mise en m√©moire tampon, dans le pire des cas, nous obtenons quelque chose comme le bloc-notes, qui dit que le fichier est trop gros. <br><br>  √Ä un niveau conceptuel √©lev√©, nous sommes tous engag√©s dans le traitement des flux de donn√©es, et Akka Streams vous aidera si: <br><br><ul><li>  Vous connaissez Akka, mais vous voulez vous √©pargner les d√©tails associ√©s √† l'√©criture du code d'acteur et √† sa coordination; <br></li><li>  Vous connaissez les flux r√©actifs et souhaitez utiliser une impl√©mentation pr√™te √† l'emploi de leurs sp√©cifications; <br></li><li>  Les √©l√©ments de bloc Akka Streams pour les √©tapes conviennent √† la mod√©lisation de votre processus; <br></li><li>  Vous souhaitez profiter de la contre-pression (contre-pression) d'Akka Streams pour g√©rer et affiner dynamiquement les √©tapes de d√©bit de votre flux de travail. <br></li></ul><br><h1>  Des acteurs aux Akka Streams </h1><br><img src="https://habrastorage.org/getpro/habr/post_images/9e2/067/5d1/9e20675d1a251ffc62b578eba2e7167d.jpg"><br><br>  La premi√®re fa√ßon est celle des acteurs aux Akka Streams, √† ma fa√ßon. <br><br>  La photo montre pourquoi nous avons commenc√© √† utiliser le mod√®le d'acteur.  Nous √©tions √©puis√©s par le contr√¥le manuel des flux, l'√©tat partag√©, c'est tout.  Tous ceux qui ont travaill√© avec de grands syst√®mes, avec plusieurs threads, comprennent combien cela prend du temps et combien il est facile de s'y tromper, ce qui peut √™tre fatal pour l'ensemble du processus.  Cela nous a conduit au mod√®le des acteurs.  Nous ne regrettons pas le choix fait, mais, bien s√ªr, lorsque vous commencez √† travailler et √† programmer davantage, ce n'est pas que l'enthousiasme initial c√®de la place √† autre chose, mais vous commencez √† r√©aliser que quelque chose pourrait √™tre fait encore plus efficacement. <br><blockquote>  <i>¬´Par d√©faut, les destinataires de leurs messages sont entr√©s dans le code des acteurs.</i>  <i>Si je cr√©e un acteur A qui envoie un message √† l'acteur B et que vous souhaitez remplacer le destinataire par l'acteur C, dans le cas g√©n√©ral, cela ne fonctionnera pas pour vous. ¬ª</i> <br>  Noel Welch (underscore.io) </blockquote>  Les acteurs critiqu√©s pour ne pas avoir compos√©.  L'un des premiers √† √©crire √† ce sujet sur son blog a √©t√© Noel Welch, l'un des d√©veloppeurs d'Underscore.  Il a remarqu√© que le syst√®me d'acteurs ressemble √† ceci: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/d8f/e3b/3dd/d8fe3b3dd378bb187c4a85de3e982960.jpg"><br><br>  Si vous n'utilisez aucun √©l√©ment suppl√©mentaire, comme une injection de d√©pendance, l'adresse de son destinataire est cousue dans l'acteur. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/3df/62f/78b/3df62f78bf5f64bda875c5f448057427.jpg"><br><br>  Quand ils commencent √† s'envoyer des messages, vous d√©finissez tout cela √† l'avance, en programmant les acteurs.  Et sans astuces suppl√©mentaires, un tel syst√®me rigide est obtenu. <br>  Un des d√©veloppeurs d'Akka, Roland Kuhn, a <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">expliqu√©</a> ce que l'on entend g√©n√©ralement par mauvaise disposition.  La m√©thode acteur est bas√©e sur la m√©thode tell, c'est-√†-dire les messages unidirectionnels: elle est de type void, c'est-√†-dire qu'elle ne renvoie rien (ou unit√©, selon la langue).  Il est donc impossible de construire une description du processus √† partir d'une cha√Æne d'acteurs.  Alors tu as envoy√© dire, alors quoi?  Arr√™ter  Nous sommes devenus nuls.  Vous pouvez le comparer, par exemple, avec des expressions LINQ, o√π chaque √©l√©ment de l'expression renvoie IQueryable, IEnumerable, et tout cela peut √™tre facilement compil√©.  Les acteurs ne donnent pas une telle opportunit√©.  Dans le m√™me temps, Roland Kuhn s'est oppos√© au fait qu'ils, disent-ils, ne composent pas en principe, affirmant qu'en fait ils sont compil√©s d'autres mani√®res, dans le m√™me sens o√π la soci√©t√© humaine se pr√™te √† l'agencement.  Cela ressemble √† un argument philosophique, mais si vous y r√©fl√©chissez, l'analogie est logique - oui, les acteurs s'envoient des messages unidirectionnels, mais nous communiquons √©galement les uns avec les autres, en pronon√ßant des messages unidirectionnels, mais en m√™me temps, nous interagissons assez efficacement, c'est-√†-dire que nous cr√©ons des syst√®mes complexes.  N√©anmoins, une telle critique des acteurs existe. <br><br><pre><code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">SampleActor</span></span> : <span class="hljs-title"><span class="hljs-title">ReceiveActor</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">SampleActor</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { Idle(); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">PreStart</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-comment"><span class="hljs-comment">/* ... */</span></span> } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Idle</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { Receive&lt;Job&gt;(job =&gt; <span class="hljs-comment"><span class="hljs-comment">/* ... */</span></span>); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Working</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { Receive&lt;Cancel&gt;(job =&gt; <span class="hljs-comment"><span class="hljs-comment">/* ... */</span></span>); } }</code> </pre> <br>  De plus, l'impl√©mentation de l'acteur n√©cessite au moins d'√©crire une classe si vous travaillez en C #, ou des fonctions si vous travaillez en F #.  Dans l'exemple ci-dessus - code passe-partout, que vous devez de toute fa√ßon √©crire.  Bien qu'il ne soit pas tr√®s volumineux, c'est un certain nombre de lignes que vous devrez toujours √©crire √† ce bas niveau.  Presque tout le code qui est pr√©sent ici est une sorte de c√©r√©monie.  Ce qui se passe lorsqu'un acteur re√ßoit directement un message ne s'affiche pas du tout ici.  Et tout cela doit √™tre √©crit.  Bien s√ªr, ce n'est pas beaucoup, mais c'est la preuve que nous travaillons avec des acteurs de bas niveau, cr√©ant de telles m√©thodes de vide. <br><br>  Et si nous pouvions passer √† un niveau diff√©rent et sup√©rieur, nous poser des questions sur la mod√©lisation de notre processus, qui comprend le traitement de donn√©es provenant de diverses sources qui sont m√©lang√©es, converties et transf√©r√©es? <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> results = db.Companies .Join(db.People, c =&gt; c.CompanyID, p =&gt; p.PersonID, (c, p) =&gt; <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> { c, p }) .Where(z =&gt; zcCreated &gt;= fromDate) .OrderByDescending(z =&gt; zcCreated) .Select(z =&gt; zp) .ToList();</code> </pre> <br>  Un analogue de cette approche peut √™tre ce que nous avons tous l'habitude de travailler avec LINQ depuis dix ans.  Nous ne nous demandons pas comment fonctionne Join.  Nous savons qu'il existe un tel fournisseur LINQ qui fera tout cela pour nous, et nous sommes int√©ress√©s √† un niveau sup√©rieur pour r√©pondre √† la demande.  Et nous pouvons g√©n√©ralement m√©langer les bases de donn√©es ici, nous pouvons envoyer des demandes distributives.  Et si vous pouviez d√©crire le processus de cette fa√ßon? <br><br><pre> <code class="cs hljs">HttpGet pageUrl |&gt; fun s -&gt; Regex.Replace(s, <span class="hljs-string"><span class="hljs-string">"[^A-Za-z']"</span></span>, <span class="hljs-string"><span class="hljs-string">" "</span></span>) |&gt; fun s -&gt; Regex.Split(s, <span class="hljs-string"><span class="hljs-string">" +"</span></span>) |&gt; Set.ofArray |&gt; Set.filter (fun word -&gt; not (Spellcheck word)) |&gt; Set.iter (fun word -&gt; printfn <span class="hljs-string"><span class="hljs-string">" %s"</span></span> word)</code> </pre> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">(Source)</a> <br><br>  Ou, par exemple, des transformations fonctionnelles.  Ce que beaucoup de gens aiment √† propos de la programmation fonctionnelle, c'est que vous pouvez transmettre des donn√©es √† travers une s√©rie de transformations, et vous obtenez un code compact assez clair, quelle que soit la langue dans laquelle vous l'√©crivez.  C'est assez facile √† lire.  Le code de l'image est sp√©cialement √©crit en F #, mais en g√©n√©ral, probablement, tout le monde comprend ce qui se passe ici. <br><br><pre> <code class="cs hljs">val <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> = Source(<span class="hljs-number"><span class="hljs-number">1</span></span> to <span class="hljs-number"><span class="hljs-number">10</span></span>) val <span class="hljs-keyword"><span class="hljs-keyword">out</span></span> = Sink.ignore val bcast = builder.<span class="hljs-keyword"><span class="hljs-keyword">add</span></span>(Broadcast[Int](<span class="hljs-number"><span class="hljs-number">2</span></span>)) val merge = builder.<span class="hljs-keyword"><span class="hljs-keyword">add</span></span>(Merge[Int](<span class="hljs-number"><span class="hljs-number">2</span></span>)) val f1,f2,f3,f4 = Flow[Int].map(_ + <span class="hljs-number"><span class="hljs-number">10</span></span>) source ~&gt; f1 ~&gt; bcast ~&gt; f2 ~&gt; merge ~&gt; f3 ~&gt; sink bcast ~&gt; f4 ~&gt; merge ~&gt;</code> </pre> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">(Source)</a> <br><br>  Et alors?  Dans l'exemple ci-dessus, nous avons une source de donn√©es source, qui se compose d'entiers de 1 √† 10. C'est ce qu'on appelle le DSL graphique (langage sp√©cifique au domaine).  Les √©l√©ments de la langue du domaine dans l'exemple ci-dessus sont des fl√®ches unidirectionnelles - ce sont des op√©rateurs suppl√©mentaires d√©finis par des outils de langue qui montrent graphiquement la direction du flux.  Nous passons Source √† travers une s√©rie de transformations - pour faciliter la d√©monstration, elles ajoutent toutes un dix au nombre.  Vient ensuite la diffusion: nous multiplions les canaux, c'est-√†-dire que chaque num√©ro entre dans deux canaux.  Ensuite, nous ajoutons √† nouveau 10, m√©langons nos flux de donn√©es, obtenons un nouveau flux, en ajoutons √©galement 10, et tout cela va √† notre flux de donn√©es, dans lequel rien ne se passe.  Il s'agit du vrai code √©crit en Scala, qui fait partie d'Akka Streams, impl√©ment√© dans ce langage.  C'est-√†-dire que vous sp√©cifiez les phases de la transformation de vos donn√©es, indiquez quoi en faire, sp√©cifiez la source, le stock, certains points de contr√¥le, puis formez un tel graphique √† l'aide du DSL graphique.  C'est tout le code pour un seul programme.  Quelques lignes de code montrent ce qui se passe dans le processus. <br><br>  Oublions comment √©crire le code de d√©finition pour les acteurs individuels et apprenons plut√¥t les primitives de mise en page de haut niveau qui cr√©eront et connecteront les acteurs requis en eux-m√™mes.  Lorsque nous ex√©cutons un tel graphique, le syst√®me qui fournit Akka Streams cr√©era lui-m√™me l'acteur requis, y enverra toutes ces donn√©es, les traitera comme il se doit et les transmettra finalement au destinataire final. <br><br><pre> <code class="hljs pgsql">var runnable = Source .<span class="hljs-keyword"><span class="hljs-keyword">From</span></span>(Enumerable.Range(<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">1000</span></span>)) .Via(Flow.<span class="hljs-keyword"><span class="hljs-keyword">Create</span></span>&lt;<span class="hljs-type"><span class="hljs-type">int</span></span>&gt;().<span class="hljs-keyword"><span class="hljs-keyword">Select</span></span>(x =&gt; x * <span class="hljs-number"><span class="hljs-number">2</span></span>) .<span class="hljs-keyword"><span class="hljs-keyword">To</span></span>(Sink.<span class="hljs-keyword"><span class="hljs-keyword">ForEach</span></span>&lt;<span class="hljs-type"><span class="hljs-type">int</span></span>&gt;(x =&gt; Console.<span class="hljs-keyword"><span class="hljs-keyword">Write</span></span>(x.ToString));</code> </pre> <br>  L'exemple ci-dessus montre √† quoi cela pourrait ressembler en C #.  La mani√®re la plus simple: nous avons une source de donn√©es - ce sont des nombres de 1 √† 1000 (comme vous pouvez le voir, dans Akka Streams, tout IEnumerable peut devenir une source de flux de donn√©es, ce qui est tr√®s pratique).  Nous faisons un calcul simple, disons, nous multiplions par deux, puis sur le flux de donn√©es tout cela est affich√© √† l'√©cran. <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> graph = GraphDsl.Create(builder =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> bcast = builder.Add(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Broadcast&lt;<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>&gt;(<span class="hljs-number"><span class="hljs-number">2</span></span>)); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> merge = builder.Add(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Merge&lt;<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">int</span></span>&gt;(<span class="hljs-number"><span class="hljs-number">2</span></span>)); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> count = Flow.FromFunction(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Func&lt;<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">int</span></span>&gt;(x =&gt; <span class="hljs-number"><span class="hljs-number">1</span></span>)); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> sum = Flow.Create&lt;<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>&gt;().Sum((x, y) =&gt; x + y); builder.From(bcast.Out(<span class="hljs-number"><span class="hljs-number">0</span></span>)).To(merge.In(<span class="hljs-number"><span class="hljs-number">0</span></span>)); builder.From(bcast.Out(<span class="hljs-number"><span class="hljs-number">1</span></span>)).Via(count).Via(sum).To(merge.In(<span class="hljs-number"><span class="hljs-number">1</span></span>)); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> FlowShape&lt;<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">int</span></span>&gt;(bcast.In, merge.Out); });</code> </pre> <br>  Ce qui est illustr√© dans l'exemple ci-dessus est appel√© ¬´DSL graphique en C #¬ª.  En fait, il n'y a pas de graphiques ici, c'est un port avec Scala, mais en C # il n'y a aucun moyen de d√©finir les op√©rateurs de cette fa√ßon, donc cela semble un peu plus encombrant, mais toujours assez compact pour comprendre ce qui se passe ici.  Donc, nous cr√©ons un certain graphique (il existe diff√©rents types de graphiques, ici on l'appelle FlowShape) √† partir de diff√©rents composants, o√π il y a une source de donn√©es et il y a des transformations.  Nous envoyons des donn√©es √† un canal dans lequel nous g√©n√©rons le comptage, c'est-√†-dire le nombre d'√©l√©ments de donn√©es √† transmettre, et dans l'autre, nous g√©n√©rons la somme, puis nous m√©langons le tout.  Ensuite, nous verrons des exemples plus int√©ressants que le simple traitement de nombres entiers. <br>  C'est le premier chemin qui peut vous conduire √† Akka Streams, si vous avez de l'exp√©rience avec un mod√®le d'acteur et que vous avez pens√© √† √©crire manuellement chacun, m√™me l'acteur le plus simple.  La deuxi√®me fa√ßon dont Akka Streams arrive √† travers Reactive Streams. <br><br><h1>  Des flux r√©actifs aux flux Akka </h1><br>  Qu'est-ce que les <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">flux r√©actifs</a> ?  Il s'agit d'une initiative conjointe visant √† d√©velopper une norme pour le traitement asynchrone des flux de donn√©es.  Il d√©finit l'ensemble minimal d'interfaces, de m√©thodes et de protocoles qui d√©crivent les op√©rations et entit√©s n√©cessaires pour atteindre l'objectif - traitement asynchrone des donn√©es en temps r√©el avec une contre-pression non bloquante (contre-pression).  Il permet diverses impl√©mentations utilisant diff√©rents langages de programmation. <br><br>  Reactive Streams vous permet de traiter un nombre potentiellement illimit√© d'√©l√©ments dans une s√©quence et de transf√©rer des √©l√©ments de mani√®re asynchrone entre les composants avec une contre-pression non bloquante. <br><br>  La liste des initiateurs de la cr√©ation de Reactive Streams est assez impressionnante: voici Netflix, Oracle et Twitter. <br><br>  La sp√©cification est tr√®s simple pour rendre l'impl√©mentation dans diff√©rentes langues et plates-formes aussi accessible que possible.  Les principaux composants de l'API Reactive Streams: <br><br><ol><li>  √âditeur <br></li><li>  Abonn√© <br></li><li>  Abonnement <br></li><li>  Processeur <br></li></ol><br>  Essentiellement, cette sp√©cification n'implique pas que vous commencerez manuellement √† impl√©menter ces interfaces.  Il est entendu que certains d√©veloppeurs de biblioth√®ques le feront pour vous.  Et Akka Streams est l'une des impl√©mentations de cette sp√©cification. <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">interface</span></span> <span class="hljs-title"><span class="hljs-title">IPublisher</span></span>&lt;<span class="hljs-title"><span class="hljs-title">out</span></span> <span class="hljs-title"><span class="hljs-title">T</span></span>&gt; { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Subscribe</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">ISubscriber&lt;T&gt; subscriber</span></span></span><span class="hljs-function">)</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">interface</span></span> <span class="hljs-title"><span class="hljs-title">ISubscriber</span></span>&lt;<span class="hljs-title"><span class="hljs-title">in</span></span> <span class="hljs-title"><span class="hljs-title">T</span></span>&gt; { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OnSubscribe</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">ISubscription subscription</span></span></span><span class="hljs-function">)</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OnNext</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">T element</span></span></span><span class="hljs-function">)</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OnError</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Exception cause</span></span></span><span class="hljs-function">)</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OnComplete</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span>; }</code> </pre> <br>  Les interfaces, comme vous pouvez le voir dans l'exemple, sont vraiment tr√®s simples: par exemple, Publisher ne contient qu'une seule m√©thode - ¬´s'abonner¬ª.  L'abonn√©, l'abonn√©, ne contient que quelques r√©actions √† l'√©v√©nement. <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">interface</span></span> <span class="hljs-title"><span class="hljs-title">ISubscription</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Request</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">long</span></span></span></span><span class="hljs-function"><span class="hljs-params"> n</span></span></span><span class="hljs-function">)</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Cancel</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">interface</span></span> <span class="hljs-title"><span class="hljs-title">IProcessor</span></span>&lt;<span class="hljs-title"><span class="hljs-title">in</span></span> <span class="hljs-title"><span class="hljs-title">T1</span></span>, <span class="hljs-title"><span class="hljs-title">out</span></span> <span class="hljs-title"><span class="hljs-title">T2</span></span>&gt; : <span class="hljs-title"><span class="hljs-title">ISubscriber</span></span>&lt;<span class="hljs-title"><span class="hljs-title">T1</span></span>&gt;, <span class="hljs-title"><span class="hljs-title">IPublisher</span></span>&lt;<span class="hljs-title"><span class="hljs-title">T2</span></span>&gt; { }</code> </pre> <br>  Enfin, l'abonnement contient deux m√©thodes - ¬´d√©marrer¬ª et ¬´refuser¬ª.  Le processeur ne d√©finit aucune nouvelle m√©thode, il associe un √©diteur et un abonn√©. <br><br>  Qu'est-ce qui distingue les flux r√©actifs des autres impl√©mentations de flux?  Reactive Streams combine des mod√®les push et pull.  Pour le support, il s'agit du sc√©nario de performances le plus efficace.  Supposons que vous ayez un abonn√© lent aux donn√©es.  Dans ce cas, pousser pour lui peut √™tre fatal: si vous lui envoyez une √©norme quantit√© de donn√©es, il ne pourra pas les traiter.  Il est pr√©f√©rable d'utiliser pull pour que l'abonn√© r√©cup√®re lui-m√™me les donn√©es de l'√©diteur.  Mais si l'√©diteur est lent, il s'av√®re que l'abonn√© est bloqu√© tout le temps, attendant tout le temps.  Une solution interm√©diaire peut √™tre la configuration: nous avons un fichier de configuration dans lequel nous d√©terminons lequel est le plus rapide.  Et si leurs vitesses changent? <br><br>  Ainsi, l'impl√©mentation la plus √©l√©gante est celle dans laquelle nous pouvons changer dynamiquement les mod√®les push et pull. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/971/ab6/298/971ab6298b3f313b90503cf6a860e188.png"><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">(Source (Apache Flink))</a> <br><br>  Le diagramme montre comment cela peut se produire.  Cette d√©mo utilise Apache Flink.  Yellow est un √©diteur, producteur de donn√©es, il √©tait fix√© √† environ 50% de ses capacit√©s.  L'abonn√© essaie de choisir la meilleure strat√©gie - elle se r√©v√®le √™tre push.  Ensuite, nous avons r√©initialis√© l'abonn√© √† une vitesse d'environ 20%, et il passe pour tirer.  Ensuite, nous allons √† 100%, revenons √† nouveau √† 20%, au mod√®le de traction, etc. Tout cela se produit dans la dynamique, vous n'avez pas besoin d'arr√™ter le service, entrez quelque chose dans la configuration.  Ceci est une illustration du fonctionnement de la contre-pression dans Akka Streams. <br><br><h1>  Principes d'Akka Streams </h1><br>  Bien s√ªr, Akka Streams ne gagnerait pas en popularit√© s'il n'y avait pas de blocs int√©gr√©s tr√®s faciles √† utiliser.  Il y en a beaucoup.  Ils sont divis√©s en trois groupes principaux: <br><br><ol><li>  Source de donn√©es (Source) - √©tape de traitement avec une sortie. <br></li><li>  Le r√©cepteur est une √©tape de traitement √† entr√©e unique. <br></li><li>  Checkpoint (Flow) - √©tape de traitement avec une entr√©e et une sortie.  Des transformations fonctionnelles ont lieu ici, et pas n√©cessairement dans la m√©moire: il peut s'agir, par exemple, d'un appel √† un service web, √† certains √©l√©ments de parall√©lisme, multi-thread. <br></li></ol><br>  De ces trois types, des graphiques peuvent √™tre form√©s.  Ce sont d√©j√† des √©tapes de traitement plus complexes, qui sont construites √† partir de sources, de drains et de points de contr√¥le.  Mais tous les graphiques ne peuvent pas √™tre ex√©cut√©s: s'il y a des trous dedans, c'est-√†-dire des entr√©es et des sorties ouvertes, alors ce graphique n'est pas ex√©cut√©. <br>  Un graphe est un graphe ex√©cutable, s'il est ferm√©, c'est-√†-dire qu'il y a une sortie pour chaque entr√©e: si les donn√©es sont entr√©es, elles doivent √™tre all√©es quelque part. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/41f/059/a3c/41f059a3cebba7f1e023c8036a29cc8e.jpg"><br><br>  Akka Streams a des sources int√©gr√©es: dans l'image, vous voyez combien d'entre elles.  Leurs noms sont √† peu pr√®s un √† un et refl√®tent ce que Scala ou la JVM a, √† l'exception de certaines sources utiles sp√©cifiques √† .NET.  Les deux premiers (FromEnumerator et From) sont parmi les plus importants: toute num√©rotation, tout ienumerable peut √™tre transform√© en source de flux. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/504/3cb/0e7/5043cb0e7cd9fb15e6b00582b5230103.jpg"><br><br>  Il existe des drains int√©gr√©s: certains d'entre eux ressemblent aux m√©thodes LINQ, par exemple, First, Last, FirstOrDefault.  Bien s√ªr, tout ce que vous obtenez, vous pouvez le vider dans des fichiers, dans des flux, non pas dans des flux Akka, mais dans des flux .NET.  Et encore une fois, si vous avez des acteurs dans votre syst√®me, vous pouvez les utiliser √† la fois en entr√©e et en sortie du syst√®me, c'est-√†-dire, si vous le souhaitez, les int√©grer dans votre syst√®me fini. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/0a6/947/229/0a6947229a7ddbb5577b39634a4b6c11.jpg"><br><br>  Et il existe un grand nombre de points de contr√¥le int√©gr√©s, qui rappellent peut-√™tre encore plus LINQ, car ici il y a Select, SelectMany et GroupBy, c'est-√†-dire tout ce que nous avons l'habitude de travailler avec LINQ. <br><br>  Par exemple, Select in Scala est appel√© SelectAsync: il est suffisamment puissant car il prend le niveau de parall√©lisme comme l'un des arguments.  Autrement dit, vous pouvez indiquer que, par exemple, Select envoie des donn√©es √† un service Web en parall√®le sur dix threads, puis elles sont toutes collect√©es et transmises.  En fait, vous d√©terminez le degr√© de mise √† l'√©chelle du point de contr√¥le avec une ligne de code. <br><br>  Une d√©claration de flux est son plan d'ex√©cution, c'est-√†-dire qu'un graphique, m√™me un graphique d'ex√©cution, ne peut pas √™tre ex√©cut√© comme √ßa - il doit √™tre mat√©rialis√©.  Il doit y avoir un syst√®me instanci√©, un syst√®me d'acteur, vous devez lui donner un flux, ce plan d'ex√©cution, puis il sera ex√©cut√©.  De plus, au moment de l'ex√©cution, il est hautement optimis√©, tout comme lorsque vous envoyez une expression LINQ √† une base de donn√©es: un fournisseur peut optimiser votre SQL pour une sortie de donn√©es plus efficace, en rempla√ßant essentiellement la commande de requ√™te par une autre.  M√™me chose avec Akka Streams: √† partir de la version 2.0, vous pouvez d√©finir un certain nombre de points de contr√¥le, et le syst√®me comprendra que certains d'entre eux peuvent √™tre combin√©s afin qu'ils soient ex√©cut√©s par un seul acteur (fusion d'op√©rateur).  Les points de contr√¥le, en r√®gle g√©n√©rale, conservent l'ordre des √©l√©ments de traitement. <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> results = db.Companies .Join(db.People, c =&gt; c.CompanyID, p =&gt; p.PersonID, (c, p) =&gt; <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> { c, p }) .Where(z =&gt; zcCreated &gt;= fromDate) .OrderByDescending(z =&gt; zcCreated) .Select(z =&gt; zp) .ToList();</code> </pre> <br>  La mat√©rialisation du flux peut √™tre compar√©e au dernier √©l√©ment ToList de l'expression LINQ dans l'exemple ci-dessus.  Si nous n'√©crivons pas ToList, nous obtenons alors une expression LINQ non mat√©rialis√©e qui n'entra√Ænera pas le transfert des donn√©es vers le serveur SQL ou Oracle, car la plupart des fournisseurs LINQ prennent en charge l'ex√©cution dite de requ√™te diff√©r√©e (ex√©cution de requ√™te retard√©e), t c'est-√†-dire que la demande n'est ex√©cut√©e que lorsqu'une commande est donn√©e pour donner un r√©sultat.  Selon ce qui est demand√© - une liste ou le premier r√©sultat - l'√©quipe la plus efficace sera form√©e.  Lorsque nous disons ToList, nous demandons ainsi au fournisseur LINQ de nous donner le r√©sultat final. <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> runnable = Source .From(Enumerable.Range(<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">1000</span></span>)) .Via(Flow.Create&lt;<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>&gt;().Select(x =&gt; x * <span class="hljs-number"><span class="hljs-number">2</span></span>) .To(Sink.ForEach&lt;<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>&gt;(x =&gt; Console.Write(x.ToString));</code> </pre> <br>  Akka Streams fonctionne de la m√™me mani√®re.  Dans l'image est notre graphique lanc√©, qui se compose d'une source de points de contr√¥le et de ruissellement, et nous voulons maintenant l'ex√©cuter. <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> runnable = Source .From(Enumerable.Range(<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">1000</span></span>)) .Via(Flow.Create&lt;<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>&gt;().Select(x =&gt; x * <span class="hljs-number"><span class="hljs-number">2</span></span>) .To(Sink.ForEach&lt;<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>&gt;(x =&gt; Console.Write(x.ToString)); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> system = ActorSystem.Create(<span class="hljs-string"><span class="hljs-string">"MyActorSystem"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> materializer = ActorMaterializer.Create(system)) { <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> runnable.Run(materializer); }</code> </pre> <br>  Pour que cela se produise, nous devons cr√©er un syst√®me d'acteurs, en lui il y a un mat√©rialisant, lui passer notre graphique, et il l'ex√©cutera.  Si nous le recr√©ons, il l'ex√©cutera √† nouveau et d'autres r√©sultats pourront √™tre obtenus. <br><br>  En plus de la mat√©rialisation du flux, en parlant de la partie mat√©rielle d'Akka Streams, il convient de mentionner les valeurs mat√©rialis√©es. <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> output = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> List&lt;<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> source1 = Source.From(Enumerable.Range(<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">1000</span></span>)); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> sink1 = Sink.ForEach&lt;<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>&gt;(output.Add); IRunnableGraph&lt;NotUsed&gt; runnable1 = source1.To(sink1); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> source2 = Source.From(Enumerable.Range(<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">1000</span></span>)); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> sink2 = Sink.Sum&lt;<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>&gt;((x,y) =&gt; x + y); IRunnableGraph&lt;Task&lt;<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>&gt;&gt; runnable2 = source2.ToMaterialized(sink2, Keep.Right);</code> </pre> <br>  Lorsque nous avons un flux qui va de la source aux points de contr√¥le vers le drain, alors si nous ne demandons pas de valeurs interm√©diaires, elles ne sont pas disponibles, car elles seront ex√©cut√©es de la mani√®re la plus efficace.  C'est comme une bo√Æte noire.  Mais il peut √™tre int√©ressant pour nous de retirer certaines valeurs interm√©diaires, car √† chaque point √† gauche, certaines valeurs entrent, d'autres valeurs sortent √† droite, et vous pouvez sp√©cifier un graphique pour indiquer ce qui vous int√©resse.  Dans l'exemple ci-dessus, un graphique de d√©part dans lequel NotUsed est indiqu√©, c'est-√†-dire qu'aucune valeur mat√©rialis√©e ne nous int√©resse.  Ci-dessous, nous le cr√©ons avec l'indication que sur le c√¥t√© droit du ruissellement, c'est-√†-dire, une fois toutes les transformations termin√©es, nous devons donner des valeurs mat√©rialis√©es.  Nous obtenons la t√¢che graphique - une t√¢che, √† la fin de laquelle nous obtenons un int, c'est-√†-dire ce qui se passe √† la fin de ce graphique.  Vous pouvez indiquer dans chaque paragraphe que vous avez besoin d'une sorte de valeurs mat√©rialis√©es, tout cela sera progressivement collect√©. <br><br>  Pour transf√©rer des donn√©es dans les flux Akka Streams ou pour les retirer de l√†, bien s√ªr, une sorte d'interaction avec le monde ext√©rieur est n√©cessaire.  Les √©tages source int√©gr√©s contiennent une large gamme de flux de donn√©es r√©actifs: <br><br><ul><li>  Source.FromEnumerator et Source.From vous permettent de transf√©rer des donn√©es √† partir de n'importe quelle source qui impl√©mente IEnumerable; <br></li><li>  D√©plier et D√©plierAsync g√©n√®rent les r√©sultats des calculs de fonction √† condition qu'il renvoie des valeurs non nulles; <br></li><li>  FromInputStream transforme un flux; <br></li><li>  FromFile analyse le contenu du fichier dans le flux r√©actif; <br></li><li>  ActorPublisher convertit les messages des acteurs. <br></li></ul><br>  Comme je l'ai d√©j√† dit, pour les d√©veloppeurs .NET, il est tr√®s productif d'utiliser Enumerator ou IEnumerable, mais parfois c'est trop primitif, trop inefficace pour acc√©der aux donn√©es.  Des sources plus complexes contenant une grande quantit√© de donn√©es n√©cessitent des connecteurs sp√©ciaux.  Ces connecteurs sont √©crits.  Il existe un projet open source Alpakka, qui est apparu √† l'origine dans Scala et est maintenant dans .NET.  De plus, Akka a des acteurs dits persistants et ils ont leurs propres flux qui peuvent √™tre utilis√©s (par exemple, Akka Persistence Query forme le flux de contenu du Akka Event Journal). <br><br><img src="https://habrastorage.org/getpro/habr/post_images/109/c40/b29/109c40b2934e0a4a4e280b27d2cd1e8b.jpg"><br><br>  Si vous travaillez avec Scala, le moyen le plus simple est pour vous: il existe un grand nombre de connecteurs et vous trouverez s√ªrement quelque chose √† votre go√ªt.  Pour information, Kafka est la soi-disant Reactive Kafka, pas Kafka Streams.  Pour autant que je sache, Kafka Streams ne supporte pas la contre-pression.  Reactive Kafka est une impl√©mentation de flux de Kafka qui prend en charge Reactive Streams. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/f24/160/09d/f2416009d41f26f08e665b2d510aa7db.jpg"><br><br>  La liste des connecteurs Alpakka .NET est plus modeste, mais elle est r√©approvisionn√©e et il y a un √©l√©ment de concurrence.  Il y a un tweet de demi-an de David Fowler de Microsoft, qui a d√©clar√© que SignalR peut d√©sormais √©changer des donn√©es avec Reactive Extensions, et l'un des d√©veloppeurs d'Akka a r√©pondu qu'il se trouvait en fait dans Akka Streams depuis un certain temps.  Akka prend en charge divers services de Microsoft Azure.  CSV est le r√©sultat de la frustration d'Aaron Stannard lorsqu'il a d√©couvert qu'il n'y avait pas de bon flux pour CSV: maintenant Akka a son propre flux pour CSV XML.  Il y a AMQP (en r√©alit√©, RabbitMQ), il est en cours de d√©veloppement, mais est disponible pour utilisation, √ßa marche.  Kafka est √©galement en cours de d√©veloppement.  Cette liste continuera de s'√©tendre. <br><br>  Quelques mots sur les alternatives, car si vous travaillez avec des flux de donn√©es, Akka Streams n'est bien s√ªr pas le seul moyen de g√©rer ces flux.  Tr√®s probablement, dans votre projet, le choix de la fa√ßon d'impl√©menter les threads d√©pendra de nombreux autres facteurs qui peuvent devenir essentiels.  Par exemple, si vous travaillez beaucoup avec Microsoft Azure et Orl√©ans est organiquement int√©gr√© aux besoins de votre projet avec leur prise en charge des acteurs virtuels, ou, comme ils les appellent, grains, alors ils ont leur propre impl√©mentation qui ne r√©pond pas √† la sp√©cification Reactive Streams - Orleans Streams, qui il sera le plus proche de vous et il est logique que vous y pr√™tiez attention.  Si vous travaillez beaucoup avec TPL, il y a TPL DataFlow - cela peut √™tre l'analogie la plus proche des flux Akka: il existe √©galement des primitives pour lier les flux de donn√©es, ainsi que des outils de mise en m√©moire tampon et de limitation de la bande passante (BoundedCapacity, MaxMessagePerTask).  Si les id√©es du mod√®le d'acteur sont proches de vous, alors Akka Streams est un moyen de r√©soudre ce probl√®me et de gagner beaucoup de temps sans avoir √† √©crire chaque acteur manuellement. <br><br><h1>  Exemple d'impl√©mentation: flux du journal des √©v√©nements </h1><br>  Regardons quelques exemples d'impl√©mentation.   ‚Äî     ,    .        Akka Streams,   ,        - ,     . <br><br><img src="https://habrastorage.org/getpro/habr/post_images/43e/de0/51f/43ede051f01ec132e11502f9cebaccaf.png"><br><br>      .     :    15  23 ,   7 .           ‚Äî      .     Kibana Dashboard. <br> Kibana    Elasticsearch ,   Elasticsearch  ,    ,      ,        ,    .     ,      ,    , . .    .      (event journal) Akka,      Microsoft SQL Server.    ,          . <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> EventJournal ( Ordering <span class="hljs-built_in"><span class="hljs-built_in">BIGINT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IDENTITY</span></span>(<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-number"><span class="hljs-number">1</span></span>) PRIMARY <span class="hljs-keyword"><span class="hljs-keyword">KEY</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, PersistenceID <span class="hljs-keyword"><span class="hljs-keyword">NVARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">255</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, SequenceNr <span class="hljs-built_in"><span class="hljs-built_in">BIGINT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-built_in"><span class="hljs-built_in">Timestamp</span></span> <span class="hljs-built_in"><span class="hljs-built_in">BIGINT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, IsDeleted <span class="hljs-built_in"><span class="hljs-built_in">BIT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, Manifest <span class="hljs-keyword"><span class="hljs-keyword">NVARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">500</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, Payload VARBINARY(<span class="hljs-keyword"><span class="hljs-keyword">MAX</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, Tags <span class="hljs-keyword"><span class="hljs-keyword">NVARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">100</span></span>) <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CONSTRAINT</span></span> QU_EventJournal <span class="hljs-keyword"><span class="hljs-keyword">UNIQUE</span></span> (PersistenceID, SequenceNr) )</code> </pre> <br>   ,  ,   ,  ,   SQL Server,     eventstore   Akka, eventJournal.     eventstore. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/cae/28e/b8e/cae28eb8efd64485e534c63d90550ce2.jpg"><br><br>    ,     .  ,    ,       ,      ,   -    :     ,  .      ,         . . .  -  .       ,    .       ,   .    ,     Akka  persistence query. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/6b2/bb9/08b/6b2bb908be095a552de279cbefad7f1b.jpg"><br><br>          ,   ,          . <br><br>   (persistence queries): <br><br><ul><li> AllPersistencelds </li><li> CurrentPersistencelds </li><li> EventsByPersistenceld </li><li> CurrentEventsByPersistenceld </li><li> EventsByTag </li><li> CurrentEventsByTag </li></ul><br>      ,    , ,   Current ‚Äî  ,      .     ‚Äî    .   EventsByTag. <br><br><pre> <code class="hljs kotlin">let system = mailbox.Context.System let queries = PersistenceQuery.Get(system) .ReadJournalFor&lt;SqlReadJournal&gt;(SqlReadJournal.Identifier) let mat = ActorMaterializer.Create(system) let offset = getCurrentOffset client config let ks = KillSwitches.Shared <span class="hljs-string"><span class="hljs-string">"persistence-elastic"</span></span> let task = queries.EventsByTag(PersistenceUtils.anyEventTag, offset) .Select(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> e -&gt; ElasticTypes.EventEnvelope.FromAkka e) .</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GroupedWithin</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(config.BatchSize, config.BatchTimeout)</span></span></span></span> .Via(ks.Flow()) .RunForeach((<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> batch -&gt; processItems client batch), mat) .</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ContinueWith</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(handleStreamError mailbox, TaskContinuationOptions.OnlyOnFaulted)</span></span></span></span> |&gt; Async.AwaitTaskVoid</code> </pre> <br>  ,    .     F#,   C#      .   EventsByTag,    Akka Streams,      ,     Elasticsearch. . .   -   ,       ,   ,    ‚Äî          .        . <br><br>       .   ,       ,    ,       ,  Twitter      ,   ‚Äî  ,   , ,    .     ,   Akka Streams. <br><br><h1>  :   </h1><br>    Akka  Scala,  Akka.NET,      ,      ,        ,      , . .          -  .     <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Tweetinvi</a> ‚Äî   ,     Twitter,         .      Reactive Streams, . .      ,    ,     ,  ,   -  Akka,      ,     . <br><br><img src="https://habrastorage.org/getpro/habr/post_images/acf/ac1/103/acfac11035eee1b69f2eb4c148f2f7f4.jpg"><br><br>       ,      , . .  Broadcast-.        ,     ,       .         :     ,         ,    ,    ,          . <br><br>      GitHub-,  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">AkkaStreamsDemo</a> .    (      <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">   </a> ). <br><br>  Commen√ßons par un simple.        Twitter:   Program.cs <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> useCachedTweets = <span class="hljs-literal"><span class="hljs-literal">false</span></span></code> </pre> <br>  ,     Twitter,     ,  .      RunnableGraph. <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> IRunnableGraph&lt;IActorRef&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CreateRunnableGraph</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> tweetSource = Source.ActorRef&lt;ITweet&gt;(<span class="hljs-number"><span class="hljs-number">100</span></span>, OverflowStrategy.DropHead); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> formatFlow = Flow.Create&lt;ITweet&gt;().Select(Utils.FormatTweet); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> writeSink = Sink.ForEach&lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>&gt;(Console.WriteLine); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> tweetSource.Via(formatFlow).To(writeSink); }</code> </pre> <br> ( <a href=""></a> ) <br><br>      ,     .   ,      ,  (     )      . <br><br> StartTweetStream ‚Äî      Tweetinvi. <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">StartTweetStream</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">IActorRef actor</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> stream = Stream.CreateSampleStream(); stream.TweetReceived += (_, arg) =&gt; { arg.Tweet.Text = arg.Tweet.Text.Replace(<span class="hljs-string"><span class="hljs-string">"\r"</span></span>, <span class="hljs-string"><span class="hljs-string">" "</span></span>).Replace(<span class="hljs-string"><span class="hljs-string">"\n"</span></span>, <span class="hljs-string"><span class="hljs-string">" "</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> json = JsonConvert.SerializeObject(arg.Tweet); File.AppendAllText(<span class="hljs-string"><span class="hljs-string">"tweets.txt"</span></span>, <span class="hljs-string"><span class="hljs-string">$"</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{json}</span></span></span><span class="hljs-string">\r\n"</span></span>); actor.Tell(arg.Tweet); }; stream.StartStream(); }</code> </pre> <br> ( <a href=""></a> ) <br><br>  CreateSampleStream    ,       .      ,   ,    ,  : ¬´  ¬ª.     IEnumerable,       . <br><br>  <a href="">TweetEnumerator</a>   :     ,     Current, MoveNext, Reset,   Dispose,    .    ,      .   ,      .      . <br><br>     useCachedTweets  true,    . CashedTweets ‚Äî    ,       50000 ,     , ,    .    ,         ,   .   ‚Äî    .          ,   . <br><br> TweetsWithBroadcast: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> graph = GraphDsl.Create(b =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> broadcast = b.Add(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Broadcast&lt;ITweet&gt;(<span class="hljs-number"><span class="hljs-number">2</span></span>)); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> merge = b.Add(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Merge&lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>&gt;(<span class="hljs-number"><span class="hljs-number">2</span></span>)); b.From(broadcast.Out(<span class="hljs-number"><span class="hljs-number">0</span></span>)) .Via(Flow.Create&lt;ITweet&gt;().Select(tweet =&gt; tweet.CreatedBy)) .Via(formatUser) .To(merge.In(<span class="hljs-number"><span class="hljs-number">0</span></span>)); b.From(broadcast.Out(<span class="hljs-number"><span class="hljs-number">1</span></span>)) .Via(Flow.Create&lt;ITweet&gt;().Select(tweet =&gt; tweet.Coordinates)) .Via(formatCoordinates) .To(merge.In(<span class="hljs-number"><span class="hljs-number">1</span></span>)); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> FlowShape&lt;ITweet, <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>&gt;(broadcast.In, merge.Out); });</code> </pre> <br> ( <a href=""></a> ) <br><br>   Scala,    ,   DSL.    Broadcast    ‚Äî out(0), out(1) ‚Äî      CreatedBy,    ,        .    . <br><br>     ‚Äî   .    . <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> graph = GraphDsl.Create(b =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> broadcast = b.Add(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Broadcast&lt;ITweet&gt;(<span class="hljs-number"><span class="hljs-number">2</span></span>)); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> merge = b.Add(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Merge&lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>&gt;(<span class="hljs-number"><span class="hljs-number">2</span></span>)); b.From(broadcast.Out(<span class="hljs-number"><span class="hljs-number">0</span></span>)) .Via(Flow.Create&lt;ITweet&gt;().Select(tweet =&gt; tweet.CreatedBy) .Throttle(<span class="hljs-number"><span class="hljs-number">10</span></span>, TimeSpan.FromSeconds(<span class="hljs-number"><span class="hljs-number">1</span></span>), <span class="hljs-number"><span class="hljs-number">1</span></span>, ThrottleMode.Shaping)) .Via(formatUser) .To(merge.In(<span class="hljs-number"><span class="hljs-number">0</span></span>)); b.From(broadcast.Out(<span class="hljs-number"><span class="hljs-number">1</span></span>)) .Via(Flow.Create&lt;ITweet&gt;().Select(tweet =&gt; tweet.Coordinates) .Buffer(<span class="hljs-number"><span class="hljs-number">10</span></span>, OverflowStrategy.DropNew) .Throttle(<span class="hljs-number"><span class="hljs-number">1</span></span>, TimeSpan.FromSeconds(<span class="hljs-number"><span class="hljs-number">1</span></span>), <span class="hljs-number"><span class="hljs-number">10</span></span>, ThrottleMode.Shaping)) .Via(formatCoordinates) .To(merge.In(<span class="hljs-number"><span class="hljs-number">1</span></span>)); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> FlowShape&lt;ITweet, <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>&gt;(broadcast.In, merge.Out); });}</code> </pre> <br> ( <a href=""></a> ) <br><br>          10   ,               10.    ,    ,  ,    . , ,   Akka Streams   Reactive Streams:     .   ,     ,   ,  ,    -  .    , ,    ,          .    ,      .   ,    ,    .     Buffer(10, OverFlowStrategy.DropHead).      ,         .      10        ,      .  , ,  - ,   ‚Äî      - ,   , ,   , . .          . ,      . <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> graph = GraphDsl.Create(b =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> broadcast = b.Add(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Broadcast&lt;ITweet&gt;(<span class="hljs-number"><span class="hljs-number">2</span></span>)); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> merge = b.Add(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Merge&lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>&gt;(<span class="hljs-number"><span class="hljs-number">2</span></span>)); b.From(broadcast.Out(<span class="hljs-number"><span class="hljs-number">0</span></span>)) .Via(Flow.Create&lt;ITweet&gt;().Select(tweet =&gt; tweet.CreatedBy) .Throttle(<span class="hljs-number"><span class="hljs-number">10</span></span>, TimeSpan.FromSeconds(<span class="hljs-number"><span class="hljs-number">1</span></span>), <span class="hljs-number"><span class="hljs-number">1</span></span>, ThrottleMode.Shaping)) .Via(formatUser) .To(merge.In(<span class="hljs-number"><span class="hljs-number">0</span></span>)); b.From(broadcast.Out(<span class="hljs-number"><span class="hljs-number">1</span></span>)) .Via(Flow.Create&lt;ITweet&gt;().Select(tweet =&gt; tweet.Coordinates) .Buffer(<span class="hljs-number"><span class="hljs-number">10</span></span>, OverflowStrategy.DropNew) .Throttle(<span class="hljs-number"><span class="hljs-number">1</span></span>, TimeSpan.FromSeconds(<span class="hljs-number"><span class="hljs-number">1</span></span>), <span class="hljs-number"><span class="hljs-number">10</span></span>, ThrottleMode.Shaping)) .Via(Flow.Create&lt;ICoordinates&gt;().SelectAsync(<span class="hljs-number"><span class="hljs-number">5</span></span>, Utils.GetWeatherAsync)) .Via(formatTemperature) .To(merge.In(<span class="hljs-number"><span class="hljs-number">1</span></span>)); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> FlowShape&lt;ITweet, <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>&gt;(broadcast.In, merge.Out); });</code> </pre> <br> ( <a href=""></a> ) <br><br>     ,    SelectAsync,     .         ,    ,        5:  ,    5  ,     ,       .    ,    ,     . <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">async</span></span></span><span class="hljs-function"> Task&lt;</span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">decimal</span></span></span><span class="hljs-function">&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetWeatherAsync</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">ICoordinates coordinates</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> httpClient = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> HttpClient(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> requestUrl = <span class="hljs-string"><span class="hljs-string">$"http://api.met.no/weatherapi/locationforecast/1.9/?lat=</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{coordinates.Latitude}</span></span></span><span class="hljs-string">;lon=</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{coordinates.Latitude}</span></span></span><span class="hljs-string">"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> result = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> httpClient.GetStringAsync(requestUrl); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> doc = XDocument.Parse(result); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> temp = doc.Root.Descendants(<span class="hljs-string"><span class="hljs-string">"temperature"</span></span>).First().Attribute(<span class="hljs-string"><span class="hljs-string">"value"</span></span>).Value; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">decimal</span></span>.Parse(temp); }</code> </pre> <br> ( <a href=""></a> ) <br><br>    .     -,      ,   -  ,   HttpClient   ,   XML,   ,     . <br><br>  ,   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">  </a> ,      ,      .     10     10    ,          ,   . <br><br>  ,    ‚Äî   ,       .     ,     Akka Streams,   ,    . ,       ,  . <br><br>      , ,  ,       Akka Streams,        .  ,        ,      Akka Streams,       C#      ,      ,        ,    ,    . <br><br><h1>   </h1><br><img src="https://habrastorage.org/getpro/habr/post_images/17a/f2f/c2b/17af2fc2bfbacfc95fbe5bc9504a346e.jpg"><br><br>    Akka Streams   ,         ?  DotNext 2017 Moscow    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">  </a>  Azure Functions.   -     ,      deployment,    ,      (      - ,     ,   ),            .     ,        ,    ,        .        ,      ,    Akka Streams, ..    ,            .                 . <br><br>  Akka Streams       , ,   ,     ,   ,      .    ,         ,     ,      ,    ,           .   Akka Streams ‚Äî  ,     ,          . <br><br>        ,       Akka Streams,  ¬´Akka Stream Rap¬ª.  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="></a>  ,    . <br><br><iframe width="560" height="315" src="https://www.youtube.com/embed/1Ct3eIQ0Tgc" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><blockquote> <i>This is the Akka Stream. <br><br> This is the Source that feeds the Akka Stream. <br><br> This is the MapAsync that maps from the Source that feeds the Akka Stream. <br><br> This is the Broadcast that forks the MapAsync that maps from the Source that feeds the Akka Stream. <br><br> This is the Merge that collects from the Broadcast that forks the MapAsync that maps from the Source that feeds the Akka Stream. <br><br> This is the FilterNot that selects from the Merge that collects from the Broadcast that forks the MapAsync that maps from the Source that feeds the Akka Streams. <br><br> This is the Balance that splits the FilterNot that selects from the Merge that collects from the Broadcast that forks the MapAsync that maps from the Source that feeds the Akka Stream. <br><br> This is the Zip that combines from the Balance that splits the FilterNot that selects from the Merge that collects from the Broadcast that forks the MapAsync that maps from the Source that feeds the Akka Stream. <br><br> This is the Drop that removes from the Zip that combines from the Balance that splits the FilterNot that selects from the Merge that collects from the Broadcast that forks the MapAsync that maps from the Source that feeds the Akka Stream. <br><br> This is TakeWhile that pulls from the Drop that removes from the Zip that combines from the Balance that splits the FilterNot that selects from the Merge that collects from the Broadcast that forks the MapAsync that maps from the Source that feeds the Akka Stream. <br><br> This is the Throttle that speeds down the TakeWhile that pulls from the Drop that removes from the Zip that combines from the Balance that splits the FilterNot that selects from the Merge that collects from the Broadcast that forks the MapAsync that maps from the Source that feeds the Akka Stream. <br><br> This is the Bidiflow that turns back the Throttle that speeds down the TakeWhile that pulls from the Drop that removes from the Zip that combines from the Balance that splits the FilterNot that selects from the Merge that collects from the Broadcast that forks the MapAsync that maps from the source that feeds the Akka Streams. <br><br> This is the Sink that is filled from the Bidiflow that turns back the Throttle that speeds down the TakeWhile that pulls from the Drop that removes from the Zip that combines from the Balance that splits the FilterNot that selects from the Merge that collects from the Broadcast that forks the MapAsync that maps from the Source that feeds the Akka Stream.</i> </blockquote> <b> .</b>         ‚Äî 22-23      <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">DotNext 2018 Moscow</a> ,        .  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="> </a>    (     ). </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr418639/">https://habr.com/ru/post/fr418639/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr418629/index.html">Comment v√©rifier ind√©pendamment si vous pouvez breveter votre produit et effectuer une recherche de brevets</a></li>
<li><a href="../fr418631/index.html">7 directives de code javascript</a></li>
<li><a href="../fr418633/index.html">R√©activit√© JavaScript: un exemple simple et intuitif</a></li>
<li><a href="../fr418635/index.html">Cr√©ation d'une machine d'arcade d'√©mulation. Partie 1</a></li>
<li><a href="../fr418637/index.html">Kubernetes aux masses: Slurm d√©marre le 3 ao√ªt</a></li>
<li><a href="../fr418641/index.html">Une erreur qui emp√™che un designer de grandir</a></li>
<li><a href="../fr418643/index.html">Assis vs debout: comment mieux travailler?</a></li>
<li><a href="../fr418645/index.html">Articles de la conf√©rence de printemps C ++ Russie 2018</a></li>
<li><a href="../fr418647/index.html">TESS lance la recherche d'exoplan√®tes</a></li>
<li><a href="../fr418649/index.html">La g√©n√©ration continue de versions alternatives de TLS r√©soudra le probl√®me d'ossification de l'ancien protocole</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>