<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>âœŠğŸ» ğŸ§‘ğŸ¼â€ğŸ¤â€ğŸ§‘ğŸ» ğŸ’¨ åœ¨Androidï¼ˆNDKï¼‰ä¸­ä½¿ç”¨JNIå›è°ƒå®ç°â€œè§‚å¯Ÿè€…-è®¢é˜…è€…â€æ¨¡å¼ ğŸ’® âŒšï¸ ğŸšµğŸ¾</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="JNIå›è°ƒçš„Androidï¼ˆNDKï¼‰å®ç°ï¼Œå¸¦æœ‰NDKå’Œå›è°ƒçš„Observer- Subscriberæ¨¡å¼ï¼Œè‡ªå†™çš„EventBusæˆ–Rx 
 ... æˆ‘çŸ¥é“â€œé‡Œé¢æ²¡æœ‰ç”¨æˆ·å¯ç»´ä¿®çš„é›¶ä»¶â€ã€‚ æˆ‘æƒ³çœ‹çœ‹é‚£é‡Œæ˜¯ä»€ä¹ˆã€‚ 
 -ä¿„ç½—æ–¯åµŒå¥—å¨ƒå¨ƒåˆ°æœ€æ·±å¤„ã€‚ çœŸçš„ï¼Œå¥¥ç½—æ–¯ç§‘å—ï¼Ÿ èƒ¡å®‰æ²¡æœ‰çœ‹ä¿„ç½—æ–¯åµŒå¥—å¨ƒå¨ƒæ˜¯ä»€ä¹ˆã€‚ 
 â€œ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>åœ¨Androidï¼ˆNDKï¼‰ä¸­ä½¿ç”¨JNIå›è°ƒå®ç°â€œè§‚å¯Ÿè€…-è®¢é˜…è€…â€æ¨¡å¼</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/420389/"><p>  JNIå›è°ƒçš„Androidï¼ˆNDKï¼‰å®ç°ï¼Œå¸¦æœ‰NDKå’Œå›è°ƒçš„<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Observer-</a> Subscriberæ¨¡å¼ï¼Œè‡ªå†™çš„EventBusæˆ–Rx </p><a name="habracut"></a><br><blockquote>  ... æˆ‘çŸ¥é“â€œé‡Œé¢æ²¡æœ‰ç”¨æˆ·å¯ç»´ä¿®çš„é›¶ä»¶â€ã€‚ æˆ‘æƒ³çœ‹çœ‹é‚£é‡Œæ˜¯ä»€ä¹ˆã€‚ <br>  -ä¿„ç½—æ–¯åµŒå¥—å¨ƒå¨ƒåˆ°æœ€æ·±å¤„ã€‚ çœŸçš„ï¼Œå¥¥ç½—æ–¯ç§‘å—ï¼Ÿ èƒ¡å®‰æ²¡æœ‰çœ‹ä¿„ç½—æ–¯åµŒå¥—å¨ƒå¨ƒæ˜¯ä»€ä¹ˆã€‚ <br>  â€œè¿™æ˜¯åƒåœ¾ï¼Œé¡¾æ•™æˆã€‚â€ è°éœ€è¦å®ƒ-æç ¸äº†å—ï¼Ÿ <br>  â€œå½©è™¹çš„å°½å¤´â€ Vinge Vernor </blockquote><p>æœ‰å¾ˆå¤šAndroidåº”ç”¨ç¨‹åºå°†C ++å’ŒJavaä»£ç ç»“åˆåœ¨ä¸€èµ·ã€‚  Javaå®ç°ä¸šåŠ¡é€»è¾‘ï¼Œè€ŒC ++å®Œæˆé€šå¸¸åœ¨éŸ³é¢‘å¤„ç†ä¸­å‘ç°çš„æ‰€æœ‰è®¡ç®—å·¥ä½œã€‚ éŸ³é¢‘æµåœ¨å†…éƒ¨æŸå¤„è¿›è¡Œå¤„ç†ï¼Œæ¥¼ä¸Šæ˜¾ç¤ºå¸¦æœ‰æ²¹é—¨å’Œç¦»åˆå™¨çš„åˆ¶åŠ¨å™¨ï¼Œä»¥åŠå„ç§æœ‰è¶£å›¾ç‰‡çš„æ•°æ®ã€‚ <br> å¥½å§ï¼Œç”±äºReactiveXå·²ç»å¾ˆç†Ÿæ‚‰äº†ï¼Œä¸ºäº†ä¸æ”¹æ‰‹ï¼Œå¹¶ä»¥ç†Ÿæ‚‰çš„æ–¹å¼ä½¿ç”¨JNIåœ°ç‰¢ï¼Œæ‚¨é€šå¸¸éœ€è¦åœ¨å¸¦æœ‰NDKçš„é¡¹ç›®ä¸­å®ç°Observeræ¨¡å¼ã€‚ å¥½å§ï¼Œä¸æ­¤åŒæ—¶ï¼Œä»£ç çš„å¯ç†è§£æ€§ <del> è€ƒå¤å­¦å®¶ </del> é‚£äº›ä¸å¹¸â€œç†è§£åˆ«äººçš„ä»£ç â€çš„äººå¢åŠ äº†ã€‚ <br> å› æ­¤ï¼Œæœ€å¥½çš„å­¦ä¹ æ–¹æ³•æ˜¯è‡ªå·±åšã€‚ <br> å‡è®¾æˆ‘ä»¬çƒ­çˆ±å¹¶çŸ¥é“å¦‚ä½•å†™è‡ªè¡Œè½¦ã€‚ ç»“æœæ˜¯ï¼š </p><br><ul><li> åƒæ˜¯ä»C ++ä»£ç å›å‘ç»™ç­¾åè€…ä¸€æ ·ï¼› </li><li> ä»¥æœ¬æœºä»£ç è¿›è¡Œå¤„ç†çš„ç®¡ç†ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œåœ¨æ²¡æœ‰è®¢é˜…è€…ä¸”æ²¡æœ‰äººå‘é€çš„æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å¯èƒ½ä¸ä¼šè¢«è¿«è§£å†³ã€‚ </li><li> ä¸åŒçš„JVMä¹‹é—´å¯èƒ½éœ€è¦æ•°æ®ä¼ è¾“ï¼› </li><li> ä¸ºäº†é¿å…èµ·åºŠä¸¤æ¬¡ï¼ŒåŒæ—¶åœ¨é¡¹ç›®æµä¸­å‘é€æ¶ˆæ¯ã€‚ </li></ul><br><p> å®Œæ•´çš„å·¥ä½œä»£ç å¯åœ¨<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">GitHubä¸Šè·å¾—</a> ã€‚ æœ¬æ–‡ä»…æä¾›æ‘˜å½•ã€‚ </p><br><p>  <strong>ä¸€ç‚¹ç†è®ºå’Œå†å²</strong> </p><br><p> æœ€è¿‘ï¼Œæˆ‘åœ¨RXä¼šè®®ä¸Šï¼Œå¯¹ä»¥ä¸‹é—®é¢˜æ„Ÿåˆ°æƒŠè®¶ï¼šReactiveXæœ‰å¤šå¿«ä»¥åŠå®ƒå¦‚ä½•å·¥ä½œã€‚ <br> å¯¹äºReactiveXï¼Œæˆ‘åªèƒ½è¯´å¯¹äºJavaï¼Œå®ƒçš„é€Ÿåº¦åœ¨å¾ˆå¤§ç¨‹åº¦ä¸Šå–å†³äºå®ƒçš„ä½¿ç”¨æ–¹å¼ï¼›å¦‚æœä½¿ç”¨æ­£ç¡®ï¼Œå®ƒçš„é€Ÿåº¦å°±è¶³å¤Ÿäº†ã€‚ <br> æˆ‘ä»¬çš„è‡ªè¡Œè½¦é‡é‡æ›´è½»ï¼Œä½†æ˜¯ä¾‹å¦‚ï¼Œå¦‚æœæ‚¨éœ€è¦ä¸€ä¸ªæ¶ˆæ¯é˜Ÿåˆ—ï¼ˆå¦‚å¯æµåŠ¨çš„ï¼‰ï¼Œåˆ™éœ€è¦è‡ªå·±ç¼–å†™ã€‚ å› ä¸ºæ‚¨çŸ¥é“æ‰€æœ‰æ•…éšœéƒ½æ˜¯æ‚¨çš„ã€‚ <br> ç†è®ºä¸Šçš„ä¸€ç‚¹ï¼š <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">è§‚å¯Ÿè€…ï¼</a>è®¢é˜…è€…æ¨¡å¼æ˜¯ä¸€ç§æœºåˆ¶ï¼Œå®ƒå…è®¸å¯¹è±¡æ¥æ”¶æœ‰å…³å…¶ä»–å¯¹è±¡çŠ¶æ€å˜åŒ–çš„è­¦æŠ¥ï¼Œä»è€Œè§‚å¯Ÿå®ƒä»¬ã€‚ è¿™æ ·åšæ˜¯ä¸ºäº†å‡å°‘è½¯ä»¶ç»„ä»¶ä¹‹é—´çš„è¿æ¥æ€§å’Œä¾èµ–æ€§ï¼Œä»è€Œå¯ä»¥æ›´æœ‰æ•ˆåœ°ä½¿ç”¨å’Œæµ‹è¯•å®ƒä»¬ã€‚ è¯­è¨€æ¦‚å¿µæ‰€åŸºäºçš„ç”ŸåŠ¨ä»£è¡¨å°±æ˜¯ä¸€åˆ‡-Smalltalkï¼Œå…¨éƒ¨åŸºäºå‘é€æ¶ˆæ¯çš„æ€æƒ³ã€‚ å—å½±å“çš„Objective-Cã€‚ </p><br><p>  <strong>å®ä½œ</strong> </p><br><p> è®©æˆ‘ä»¬å°è¯•DIYçš„æœ€ä½³ä¼ ç»Ÿï¼Œå¯ä»¥è¯´æ˜¯â€œé—ªçƒLEDâ€ã€‚ å¦‚æœä½¿ç”¨JNIï¼Œåˆ™åœ¨Android NDKä¸–ç•Œä¸­ï¼Œå¯ä»¥åœ¨ä»»ä½•çº¿ç¨‹ä¸­å¼‚æ­¥è¯·æ±‚Javaæ–¹æ³•ã€‚ è¿™å°±æ˜¯æˆ‘ä»¬ç”¨æ¥æ„å»ºâ€œè§‚å¯Ÿè€…â€çš„ä¸œè¥¿ã€‚ </p><br><p> è¯¥æ¼”ç¤ºé¡¹ç›®åŸºäºAndroid Studioä¸­çš„æ–°é¡¹ç›®æ¨¡æ¿ã€‚ </p><br><p> è¿™æ˜¯ä¸€ç§è‡ªåŠ¨ç”Ÿæˆçš„æ–¹æ³•ã€‚ ä»–è¯„è®ºè¯´ï¼š </p><br><pre><code class="java hljs"><span class="hljs-comment"><span class="hljs-comment">// Used to load the 'native-lib' library on application startup. static { System.loadLibrary("native-lib"); }</span></span></code> </pre> <br><p> ç°åœ¨ä¸ºæ‚¨è‡ªå·±ã€‚ ç¬¬ä¸€æ­¥æ˜¯<code>nsubscribeListener</code>æ–¹æ³•ã€‚ </p><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">native</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">nsubscribeListener</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(JNIListener JNIListener)</span></span></span></span>;</code> </pre> <br><p> å®ƒå…è®¸C ++ä»£ç è·å–åˆ°Javaä»£ç çš„é“¾æ¥ï¼Œä»¥å®ç°å¯¹å®ç°<code>JNIListener.</code>æ¥å£çš„å¯¹è±¡çš„å›è°ƒ<code>JNIListener.</code> </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">JNIListener</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onAcceptMessage</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String string)</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onAcceptMessageVal</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> messVal)</span></span></span></span>; }</code> </pre> <br><p> å€¼å°†è¢«è½¬ç§»åˆ°å…¶æ–¹æ³•çš„æ‰§è¡Œä¸­ã€‚ </p><br><p> ä¸ºäº†æœ‰æ•ˆåœ°ç¼“å­˜åˆ°è™šæ‹Ÿæœºçš„é“¾æ¥ï¼Œæˆ‘ä»¬è¿˜å°†é“¾æ¥ä¿å­˜åˆ°å¯¹è±¡ã€‚ æˆ‘ä»¬ä¸ºæ­¤è·å¾—äº†å…¨çƒé“¾æ¥ã€‚ </p><br><pre> <code class="java hljs">Java_ua_zt_mezon_myjnacallbacktest_MainActivity_nsubscribeListener(JNIEnv *env, jobject instance, jobject listener) { env-&gt;GetJavaVM(&amp;jvm); <span class="hljs-comment"><span class="hljs-comment">//store jvm reference for later call store_env = env; jweak store_Wlistener = env-&gt;NewWeakGlobalRef(listener);</span></span></code> </pre> <br><p> ç«‹å³è®¡æ•°å¹¶ä¿å­˜æŒ‡å‘æ–¹æ³•çš„é“¾æ¥ã€‚ è¿™æ„å‘³ç€å®Œæˆå›è°ƒæ‰€éœ€çš„æ“ä½œè¾ƒå°‘ã€‚ </p><br><pre> <code class="java hljs">jclass clazz = env-&gt;GetObjectClass(store_Wlistener); jmethodID store_method = env-&gt;GetMethodID(clazz, <span class="hljs-string"><span class="hljs-string">"onAcceptMessage"</span></span>, <span class="hljs-string"><span class="hljs-string">"(Ljava/lang/String;)V"</span></span>); jmethodID store_methodVAL = env-&gt;GetMethodID(clazz, <span class="hljs-string"><span class="hljs-string">"onAcceptMessageVal"</span></span>, <span class="hljs-string"><span class="hljs-string">"(I)V"</span></span>);</code> </pre> <br><p> è®¢æˆ·æ•°æ®å­˜å‚¨ä¸º<code>ObserverChain</code>ç±»è®°å½•ã€‚ </p><br><pre> <code class="java hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ObserverChain</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span>: ObserverChain(jweak pJobject, jmethodID pID, jmethodID pJmethodID); jweak store_Wlistener=NULL; jmethodID store_method = NULL; jmethodID store_methodVAL = NULL; };</code> </pre> <br><p> å°†è®¢æˆ·ä¿å­˜åˆ°åŠ¨æ€æ•°ç»„store_Wlistener_vectorã€‚ </p><br><pre> <code class="cpp hljs">ObserverChain *tmpt = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ObserverChain(store_Wlistener, store_method, store_methodVAL); store_Wlistener_vector.push_back(tmpt);</code> </pre> <br><p> ç°åœ¨ä»‹ç»å¦‚ä½•ä¼ è¾“æ¥è‡ªJavaä»£ç çš„æ¶ˆæ¯ã€‚ </p><br><p> å‘é€åˆ°nonNextæ–¹æ³•çš„æ¶ˆæ¯å°†å‘é€ç»™æ‰€æœ‰ç­¾åè€…ã€‚ </p><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">native</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">nonNext</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String message)</span></span></span></span>;</code> </pre> <br><p> å®ç°æ–¹å¼ï¼š </p><br><pre> <code class="java hljs">Java_ua_zt_mezon_myjnacallbacktest_MainActivity_nonNext(JNIEnv *env, jobject instance, jstring message_) { txtCallback(env, message_); }</code> </pre> <br><p> å‡½æ•°txtCallbackï¼ˆenvï¼Œmessage_ï¼‰; å‘é€æ¶ˆæ¯ç»™æ‰€æœ‰ç­¾ç½²è€…ã€‚ </p><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">txtCallback</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(JNIEnv *env, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> _jstring *message_)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!store_Wlistener_vector.empty()) { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; store_Wlistener_vector.size(); i++) { env-&gt;CallVoidMethod(store_Wlistener_vector[i]-&gt;store_Wlistener, store_Wlistener_vector[i]-&gt;store_method, message_); } } }</code> </pre> <br><p> è¦è½¬å‘æ¥è‡ªC ++æˆ–Cä»£ç çš„æ¶ˆæ¯ï¼Œæˆ‘ä»¬ä½¿ç”¨test_string_callback_fom_cå‡½æ•° </p><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">test_string_callback_fom_c</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *val)</span></span></span></span></code> </pre> <br><p> å¥¹ä»ä¸€å¼€å§‹å°±æ£€æŸ¥æ˜¯å¦æœ‰è®¢æˆ·ã€‚ </p><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (store_Wlistener_vector.empty()) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>;</code> </pre> <br><p> å¾ˆå®¹æ˜“çœ‹å‡ºï¼Œä½¿ç”¨ç›¸åŒçš„txtCallbackå‡½æ•°å‘é€æ¶ˆæ¯ï¼š </p><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">test_string_callback_fom_c</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *val)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (store_Wlistener_vector.empty()) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; __android_log_print(ANDROID_LOG_VERBOSE, <span class="hljs-string"><span class="hljs-string">"GetEnv:"</span></span>, <span class="hljs-string"><span class="hljs-string">" start Callback to JNL [%d] \n"</span></span>, val); JNIEnv *g_env; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-literal"><span class="hljs-literal">NULL</span></span> == jvm) { __android_log_print(ANDROID_LOG_ERROR, <span class="hljs-string"><span class="hljs-string">"GetEnv:"</span></span>, <span class="hljs-string"><span class="hljs-string">" No VM \n"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; } <span class="hljs-comment"><span class="hljs-comment">// double check it's all ok JavaVMAttachArgs args; args.version = JNI_VERSION_1_6; // set your JNI version args.name = NULL; // you might want to give the java thread a name args.group = NULL; // you might want to assign the java thread to a ThreadGroup int getEnvStat = jvm-&gt;GetEnv((void **) &amp;g_env, JNI_VERSION_1_6); if (getEnvStat == JNI_EDETACHED) { __android_log_print(ANDROID_LOG_ERROR, "GetEnv:", " not attached\n"); if (jvm-&gt;AttachCurrentThread(&amp;g_env, &amp;args) != 0) { __android_log_print(ANDROID_LOG_ERROR, "GetEnv:", " Failed to attach\n"); } } else if (getEnvStat == JNI_OK) { __android_log_print(ANDROID_LOG_VERBOSE, "GetEnv:", " JNI_OK\n"); } else if (getEnvStat == JNI_EVERSION) { __android_log_print(ANDROID_LOG_ERROR, "GetEnv:", " version not supported\n"); } jstring message = g_env-&gt;NewStringUTF(val);// txtCallback(g_env, message); if (g_env-&gt;ExceptionCheck()) { g_env-&gt;ExceptionDescribe(); } if (getEnvStat == JNI_EDETACHED) { jvm-&gt;DetachCurrentThread(); } }</span></span></code> </pre> <br><p> åœ¨MainActivityä¸­ï¼Œæˆ‘ä»¬åˆ›å»ºä¸¤ä¸ªæ–‡æœ¬è§†å›¾å’Œä¸€ä¸ªEditViewã€‚ </p><br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">TextView</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"@+id/sample_text_from_Presenter"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:layout_width</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"wrap_content"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:layout_height</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"wrap_content"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:layout_weight</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"1"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:padding</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"25dp"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:text</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Hello World!from_Presenter"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">app:layout_constraintBottom_toTopOf</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"parent"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">app:layout_constraintEnd_toStartOf</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"parent"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">app:layout_constraintStart_toStartOf</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"parent"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">app:layout_constraintTop_toTopOf</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"parent"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">TextView</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"@+id/sample_text_from_act"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:layout_width</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"wrap_content"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:layout_height</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"wrap_content"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:layout_weight</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"1"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:text</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Hello World from_ac!"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">app:layout_constraintBottom_toTopOf</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"parent"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">app:layout_constraintStart_toStartOf</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"@+id/sample_text_from_Presenter"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">app:layout_constraintTop_toTopOf</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"parent"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">EditText</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"@+id/edit_text"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:layout_width</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"wrap_content"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:layout_height</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"wrap_content"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:text</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Hello World!"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">app:layout_constraintBottom_toTopOf</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"parent"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">app:layout_constraintStart_toStartOf</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"@+id/sample_text_from_act"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">app:layout_constraintTop_toTopOf</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"parent"</span></span></span><span class="hljs-tag"> /&gt;</span></span></code> </pre> <br><p> åœ¨OnCreateä¸­ï¼Œæˆ‘ä»¬å°†Viewä¸å˜é‡ç»‘å®šï¼Œå¹¶æè¿°åœ¨EditTextä¸­æ›´æ”¹æ–‡æœ¬æ—¶ï¼Œå°†å‘è®¢é˜…è€…å‘é€ä¸€æ¡æ¶ˆæ¯ã€‚ </p><br><pre> <code class="java hljs">mEditText = findViewById(R.id.edit_text); mEditText.addTextChangedListener(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> TextWatcher() { <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">beforeTextChanged</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(CharSequence charSequence, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> i, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> i1, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> i2)</span></span></span><span class="hljs-function"> </span></span>{ } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onTextChanged</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(CharSequence charSequence, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> i, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> i1, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> i2)</span></span></span><span class="hljs-function"> </span></span>{ nonNext(charSequence.toString()); } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">afterTextChanged</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Editable editable)</span></span></span><span class="hljs-function"> </span></span>{ } }); tvPresenter = (TextView) findViewById(R.id.sample_text_from_Presenter); tvAct = (TextView) findViewById(R.id.sample_text_from_act);</code> </pre> <br><p> æˆ‘ä»¬å¼€å§‹å¹¶æ³¨å†Œè®¢æˆ·ï¼š </p><br><pre> <code class="java hljs">mPresenter = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> MainActivityPresenterImpl(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>); nsubscribeListener((MainActivityPresenterImpl) mPresenter); nlistener = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> JNIListener() { <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onAcceptMessage</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String string)</span></span></span><span class="hljs-function"> </span></span>{ printTextfrActObj(string); } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onAcceptMessageVal</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> messVal)</span></span></span><span class="hljs-function"> </span></span>{ } }; nsubscribeListener(nlistener);</code> </pre> <br><p> çœ‹èµ·æ¥åƒè¿™æ ·ï¼š </p><br><p><img src="https://habrastorage.org/webt/n2/yk/9a/n2yk9aykepfz92zblbxd_lej4xy.gif"></p><br><p> å®Œæ•´çš„å·¥ä½œä»£ç ä½äºGitHub <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">https://github.com/NickZt/MyJNACallbackTest</a> <br> åœ¨è¯„è®ºä¸­è®©æˆ‘ä»¬çŸ¥é“è¦è¯¦ç»†æè¿°çš„å†…å®¹ã€‚ </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN420389/">https://habr.com/ru/post/zh-CN420389/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN420377/index.html">æˆ‘ä»¬å¦‚ä½•å¼€å§‹è§†é¢‘é€šè¯</a></li>
<li><a href="../zh-CN420381/index.html">ä¸ºä»€ä¹ˆå°†ç¥ç»ç½‘ç»œè§†ä¸ºé»‘åŒ£å­å°±è¶³å¤Ÿäº†ï¼Ÿ</a></li>
<li><a href="../zh-CN420383/index.html">â€œ Yandex.Moneyå¯¹æ‚¨è¾“å…¥åº”ç”¨ç¨‹åºä¸æ„Ÿå…´è¶£ã€‚â€</a></li>
<li><a href="../zh-CN420385/index.html">åŸºäºå®¹å™¨çš„é›†æˆæµ‹è¯•</a></li>
<li><a href="../zh-CN420387/index.html">ä¸‰ç§æ™ºèƒ½é­”æ–¹ï¼šå°ç±³ï¼ŒRooboå’ŒGoCube</a></li>
<li><a href="../zh-CN420391/index.html">2018å¹´ä¸­çš„ITè–ªèµ„</a></li>
<li><a href="../zh-CN420393/index.html">PHPï¼ŒYII2å’Œå¤§å‹Excelæ–‡ä»¶çš„å½¢æˆ</a></li>
<li><a href="../zh-CN420395/index.html">å›šçŠ¯çš„â€œå…è´¹â€å¹³æ¿ç”µè„‘-ä¸€ç‚¹éƒ½ä¸å…è´¹</a></li>
<li><a href="../zh-CN420397/index.html">ç§‘å­¦å®¶æ‰¾åˆ°äº†ä¸€ç§é€†è½¬ç»†èƒè¡°è€è¿‡ç¨‹çš„æ–¹æ³•</a></li>
<li><a href="../zh-CN420405/index.html">ç ”ç©¶ITé”€å”®æµç¨‹</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>