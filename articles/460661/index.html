<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ü§∞üèª üçå üëèüèº Todo lo que necesitas saber sobre Node.js üÜó üñïüèª üëò</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hola Habr! Te presento la traducci√≥n del art√≠culo "Todo lo que necesitas saber sobre Node.js" de Jorge Ram√≥n. 





 Hoy en d√≠a, la plataforma Node.js...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Todo lo que necesitas saber sobre Node.js</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/460661/"><p>  Hola Habr!  Te presento la traducci√≥n del art√≠culo <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">"Todo lo que necesitas saber sobre Node.js"</a> de Jorge Ram√≥n. </p><br><p><img src="https://habrastorage.org/webt/ua/qz/gr/uaqzgrarpig3cxhjdiuiutbxbms.jpeg"></p><br><p>  Hoy en d√≠a, la plataforma Node.js es una de las plataformas m√°s populares para construir API REST eficientes y escalables.  Tambi√©n es adecuado para crear aplicaciones m√≥viles h√≠bridas, programas de escritorio e incluso para IoT. </p><br><p>  He estado trabajando con la plataforma Node.js durante m√°s de 6 a√±os y realmente me encanta.  Esta publicaci√≥n trata principalmente de ser una gu√≠a de c√≥mo funciona Node.js en realidad. </p><a name="habracut"></a><br><p>  ¬°Comencemos! </p><br><p>  <strong>Lo que se discutir√°:</strong> </p><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Mundo antes de Node.js</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Problema C10K</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Node.js y el bucle de eventos</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">El problema de las tareas intensivas en CPU</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Los trabajadores y sus flujos.</a> </li></ul><br><a name="p1"></a><br><h3 id="mir-do-nodejs">  Mundo antes de Node.js </h3><br><p>  <strong>Servidor multiproceso</strong> </p><br><p>  Las aplicaciones web escritas siguiendo la arquitectura cliente / servidor funcionan de la siguiente manera: el cliente solicita el recurso necesario del servidor y el servidor env√≠a el recurso en respuesta.  En este esquema, el servidor responde a la solicitud y finaliza la conexi√≥n. </p><br><p>  Este modelo es efectivo porque cada solicitud al servidor consume recursos (memoria, tiempo de procesador, etc.).  Para procesar cada solicitud posterior del cliente, el servidor debe completar el procesamiento de la anterior. </p><br><p>  ¬øSignifica esto que el servidor solo puede procesar una solicitud a la vez?  En realidad no!  Cuando el servidor recibe una nueva solicitud, crea un <strong>hilo</strong> separado para procesarla. </p><br><p>  <em>El flujo</em> , en palabras simples, es el tiempo y los recursos que la CPU asigna para ejecutar un peque√±o bloque de instrucciones.  Dicho esto, el servidor puede procesar varias solicitudes a la vez, pero solo una por subproceso.  Tal modelo tambi√©n se llama modelo de <strong>subproceso por solicitud</strong> . </p><br><p><img src="https://habrastorage.org/webt/mm/ns/gn/mmnsgnzvz7aptv62xrbo6zxju-w.jpeg"></p><br><p>  Para procesar N solicitudes, el servidor necesita N subprocesos.  Si el servidor recibe solicitudes N + 1, debe esperar hasta que uno de los hilos est√© disponible. </p><br><p>  En la figura anterior, el servidor puede procesar hasta 4 solicitudes (subprocesos) a la vez y cuando recibe las siguientes 3 solicitudes, estas solicitudes deben esperar hasta que alguno de estos 4 subprocesos est√© disponible. </p><br><p>  Una forma de deshacerse de las restricciones es agregar m√°s recursos (memoria, n√∫cleos de procesador, etc.) al servidor, pero esta no es la mejor soluci√≥n ... </p><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/yb/qz/zl/ybqzzljzkgej-kirqwza-43amcw.gif"></div><br><p>  Y, por supuesto, no te olvides de las limitaciones tecnol√≥gicas. </p><br><p>  <strong>Bloqueo de entrada / salida</strong> </p><br><p>  El n√∫mero limitado de subprocesos en el servidor no es el √∫nico problema.  ¬øQuiz√°s se pregunt√≥ por qu√© un solo hilo no puede procesar m√∫ltiples solicitudes al mismo tiempo?  todo debido al <strong>bloqueo de operaciones de E / S.</strong> </p><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/ei/ao/02/eiao02s-dtpki8au6sybf8-dmbu.gif"></div><br><p>  Supongamos que est√° desarrollando una tienda en l√≠nea y necesita una p√°gina donde el usuario pueda ver una lista de todos los productos. </p><br><p>  El usuario llama a <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">http://yourstore.com/products</a> y el servidor procesa un archivo HTML con todos los productos de la base de datos en respuesta.  Para nada complicado, ¬øverdad? </p><br><p>  ¬øPero qu√© pasa detr√°s de escena? </p><br><ul><li> Cuando un usuario llama a <code>/products</code> , se debe ejecutar <code>/products</code> m√©todo o funci√≥n particular para procesar la solicitud.  Un peque√±o fragmento de c√≥digo (el suyo o su marco) analiza la URL de solicitud y busca un m√©todo o funci√≥n adecuados.  <strong>La corriente se est√° ejecutando</strong> . <img width="20" src="https://habrastorage.org/webt/o1/sw/x5/o1swx5v-gnn2ptqjjzonhq3oew0.png"></li><li>  Ahora se ejecuta el m√©todo o funci√≥n deseada, como en el primer p√°rrafo, el <strong>hilo funciona.</strong> <img width="20" src="https://habrastorage.org/webt/o1/sw/x5/o1swx5v-gnn2ptqjjzonhq3oew0.png"></li><li>  Como es un buen desarrollador, guarda todos los registros del sistema en un archivo y, por supuesto, para asegurarse de que el enrutador realiza el m√©todo / funci√≥n deseados, tambi√©n registra la l√≠nea "¬°M√©todo X en ejecuci√≥n!". Pero todo esto es operaciones de bloqueo el <strong>flujo de</strong> entrada / salida <strong>est√° esperando</strong> . <img width="20" src="https://habrastorage.org/webt/bq/lm/cq/bqlmcq7ntk4kpr2gncodmxpqqee.png"></li><li>  Todos los registros se guardan y se ejecutan las siguientes l√≠neas de funci√≥n.  <strong>El hilo est√° funcionando de nuevo</strong> . <img width="20" src="https://habrastorage.org/webt/o1/sw/x5/o1swx5v-gnn2ptqjjzonhq3oew0.png"></li><li>  Es hora de acceder a la base de datos y obtener todos los productos: una consulta simple como <code>SELECT * FROM products</code> hace su trabajo, pero ¬øadivina qu√©?  S√≠, esta es una operaci√≥n de bloqueo de E / S.  <strong>La corriente est√° esperando</strong> . <img width="20" src="https://habrastorage.org/webt/bq/lm/cq/bqlmcq7ntk4kpr2gncodmxpqqee.png"></li><li>  Ha recibido una matriz o una lista de todos los productos, pero aseg√∫rese de haber prometido todo esto.  <strong>La corriente est√° esperando</strong> . <img width="20" src="https://habrastorage.org/webt/bq/lm/cq/bqlmcq7ntk4kpr2gncodmxpqqee.png"></li><li>  Ahora tiene todos los productos y es hora de presentar la plantilla para la p√°gina futura, pero antes de eso debe leerlos.  <strong>La corriente est√° esperando</strong> . <img width="20" src="https://habrastorage.org/webt/bq/lm/cq/bqlmcq7ntk4kpr2gncodmxpqqee.png"></li><li>  El motor de renderizado hace su trabajo y env√≠a una respuesta al cliente.  <strong>El hilo est√° funcionando de nuevo</strong> . <img width="20" src="https://habrastorage.org/webt/o1/sw/x5/o1swx5v-gnn2ptqjjzonhq3oew0.png"></li><li>  El flujo es libre, como un p√°jaro en el cielo. <img width="20" src="https://habrastorage.org/webt/wr/vg/0_/wrvg0_hul5qltn9qpyg9fv6beua.png"></li></ul><br><p>  ¬øQu√© tan lentas son las operaciones de E / S?  Bueno, depende de lo espec√≠fico.  Miremos la mesa: </p><br><div class="scrollable-table"><table><tbody><tr><th>  <b>Operaci√≥n</b> </th><th>  <b>Ciclos de CPU</b> </th></tr><tr><td>  Registros de CPU </td><td>  3 medidas </td></tr><tr><td>  Cach√© L1 </td><td>  8 medidas </td></tr><tr><td>  Cach√© L2 </td><td>  12 medidas </td></tr><tr><td>  RAM </td><td>  150 medidas </td></tr><tr><td>  Disco </td><td>  30,000,000 medidas </td></tr><tr><td>  Red </td><td>  250,000,000 medidas </td></tr></tbody></table></div><br><p>  Las operaciones de red y lectura de disco son demasiado lentas.  Imagine cu√°ntas solicitudes o llamadas a API externas podr√≠a manejar su sistema durante este tiempo. </p><br><p>  Para resumir: las operaciones de E / S hacen que el hilo espere y desperdicie recursos. </p><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/bg/qm/k1/bgqmk13cgzyfg7vmynzpkxdxbdc.gif"></div><br><a name="p2"></a><br><h3 id="problema-c10k">  Problema C10K </h3><br><p>  <strong>El problema</strong> </p><br><p>  <b>C10k</b> (eng. <i>C10k; 10k conexiones</i> - problema de 10 mil conexiones) </p><br><p>  A principios de la d√©cada de 2000, las m√°quinas de servidor y cliente eran lentas.  El problema surgi√≥ al procesar 10,000 conexiones de clientes a la misma m√°quina en paralelo. </p><br><p>  Pero, ¬øpor qu√© el modelo tradicional de subprocesos por solicitud (subproceso a pedido) no puede resolver este problema?  Bueno, usemos un poco de matem√°tica. </p><br><p>  La implementaci√≥n nativa de subprocesos asigna m√°s de 1 MB de memoria por flujo, dejando esto: para 10 mil subprocesos, se requieren 10 GB de RAM y esto es solo para la pila de flujo.  ¬°S√≠, y no lo olviden, estamos a principios de la d√©cada de 2000! </p><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/af/99/xc/af99xcxnykot0wq-zv20o-6cvps.jpeg"></div><br><p>  Hoy en d√≠a, las computadoras del servidor y del cliente funcionan de manera m√°s r√°pida y eficiente, y casi cualquier lenguaje o marco de programaci√≥n puede hacer frente a este problema.  Pero, de hecho, el problema no est√° resuelto.  Para 10 millones de conexiones de clientes a una m√°quina, el problema vuelve nuevamente (pero ahora es el <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">problema C10M</a> ). </p><br><p>  <strong>Rescate de JavaScript?</strong> </p><br><p>  Spoilers de precauci√≥n <img width="70" src="https://habrastorage.org/webt/vl/iw/8n/vliw8nxrmg8paobiiyvuozjxpdc.png">  !!! <br>  Node.js en realidad resuelve el problema C10K ... pero ¬øc√≥mo? </p><br><p>  El JavaScript del lado del servidor no era algo nuevo e inusual a principios de la d√©cada de 2000, en ese momento ya hab√≠a implementaciones en la parte superior de la JVM (m√°quina virtual java): RingoJS y AppEngineJS, que funcionaban en el modelo de subprocesos por solicitud. </p><br><p>  Pero si no pod√≠an resolver el problema, ¬øc√≥mo podr√≠a Node.js?  Todo porque JavaScript es de un <strong>solo subproceso</strong> . </p><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/lp/nx/vh/lpnxvhxjbmqmkzmblpqqmfcxq0s.gif"></div><br><a name="p3"></a><br><h3 id="nodejs-i-cikl-sobytiy">  Node.js y el bucle de eventos </h3><br><p>  <strong>Node.js</strong> </p><br><p>  Node.js es una plataforma de servidor que se ejecuta en el motor Google Chrome - V8, que puede compilar c√≥digo JavaScript en c√≥digo m√°quina. </p><br><p>  Node.js utiliza un modelo <strong>controlado por eventos</strong> y una arquitectura de <strong>E / S sin bloqueo</strong> , lo que lo hace ligero y eficiente.  Esto no es un marco, ni una biblioteca, es un tiempo de ejecuci√≥n de JavaScript. </p><br><p>  Escribamos un peque√±o ejemplo: </p><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">// Importing native http module const http = require('http'); // Creating a server instance where every call // the message 'Hello World' is responded to the client const server = http.createServer(function(request, response) { response.write('Hello World'); response.end(); }); // Listening port 8080 server.listen(8080);</span></span></code> </pre> <br><p>  <strong>E / S sin bloqueo</strong> </p><br><p>  Node.js utiliza operaciones de entrada / salida sin bloqueo, ¬øqu√© significa esto: </p><br><ul><li>  El hilo principal no ser√° bloqueado por las operaciones de E / S. </li><li>  El servidor continuar√° atendiendo solicitudes. </li><li>  Tendremos que trabajar con <strong>c√≥digo asincr√≥nico</strong> . </li></ul><br><p>  Escribamos un ejemplo en el que el servidor env√≠a una p√°gina HTML en respuesta a una solicitud a <code>/home</code> , y para todas las dem√°s solicitudes: 'Hello World'.  Para enviar una p√°gina HTML, primero debe leerla desde un archivo. </p><br><p> <code>home.html</code> </p> <br><pre> <code class="html hljs xml"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">html</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">body</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">h1</span></span></span><span class="hljs-tag">&gt;</span></span>This is home page<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">h1</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">body</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">html</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br><p> <code>index.js</code> </p> <br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> http = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'http'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> fs = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'fs'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> server = http.createServer(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">request, response</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (request.url === <span class="hljs-string"><span class="hljs-string">'/home'</span></span>) { fs.readFile(<span class="hljs-string"><span class="hljs-string">`</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${ __dirname }</span></span></span><span class="hljs-string">/home.html`</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">err, content</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!err) { response.setHeader(<span class="hljs-string"><span class="hljs-string">'Content-Type'</span></span>, <span class="hljs-string"><span class="hljs-string">'text/html'</span></span>); response.write(content); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { response.statusCode = <span class="hljs-number"><span class="hljs-number">500</span></span>; response.write(<span class="hljs-string"><span class="hljs-string">'An error has ocurred'</span></span>); } response.end(); }); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { response.write(<span class="hljs-string"><span class="hljs-string">'Hello World'</span></span>); response.end(); } }); server.listen(<span class="hljs-number"><span class="hljs-number">8080</span></span>);</code> </pre> <br><p>  Si la url solicitada es <code>/home</code> , el m√≥dulo <code>fs</code> nativo se usa para leer el archivo <code>home.html</code> . </p><br><p>  Las funciones que se <code>http.createServer</code> en <code>http.createServer</code> y <code>fs.readFile</code> como argumentos son <strong>devoluciones de llamada</strong> .  Estas funciones se realizar√°n en alg√∫n momento en el futuro (el primero, tan pronto como el servidor recibe la solicitud, y el segundo, cuando el archivo se lee del disco y se coloca en el b√∫fer). </p><br><p>  Mientras el archivo se lee desde el disco, Node.js puede procesar otras solicitudes e incluso leer el archivo nuevamente y todo esto en una secuencia ... ¬°pero c√≥mo? </p><br><p>  <strong>Bucle de eventos</strong> </p><br><p>  <strong>El bucle de eventos</strong> es la magia que ocurre dentro de Node.js.  Esto es literalmente un bucle sin fin y en realidad un hilo. </p><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/f_/sc/go/f_scgo68j5gpf0xsnzklzdr9cjc.jpeg"></div><br><p>  <strong>Libuv</strong> es una biblioteca C que implementa este patr√≥n y es parte del n√∫cleo Node.js.  Puedes aprender m√°s sobre libuv <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">aqu√≠</a> . </p><br><p>  Un ciclo de eventos tiene 6 fases, cada ejecuci√≥n de las 6 fases se llama <strong>tick</strong> . </p><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/2k/xy/eq/2kxyeqk7srzdocs9egzl5zlpwhm.png"></div><br><ul><li>  <strong>temporizadores</strong> : en esta fase, se ejecutan devoluciones de llamada programadas por los <code>setTimeout()</code> y <code>setInterval()</code> ; </li><li>  <strong>devoluciones de llamada pendientes</strong> : casi todas las <strong>devoluciones de llamada</strong> se ejecutan, excepto los eventos <code>close</code> , temporizadores y <code>setImmediate()</code> ; </li><li>  <strong>inactivo, preparar</strong> : utilizado solo para fines internos; </li><li>  <strong>encuesta</strong> : responsable de recibir nuevos eventos de E / S.  Node.js puede bloquearse en este punto; </li><li>  <strong>check</strong> : las devoluciones de llamada causadas por el m√©todo <code>setImmediate()</code> se ejecutan en esta etapa; </li><li>  <strong>devoluciones de llamada cercanas</strong> : por ejemplo <code>socket.on('close', ...)</code> ; </li></ul><br><p>  Bueno, solo hay un hilo, y este hilo es un bucle de eventos, pero ¬øqui√©n realiza todas las E / S? </p><br><p>  Presta atencion <img width="60" src="https://habrastorage.org/webt/92/8i/lj/928iljyzpqhkbczypvvqgkx0zc0.png">  !!! <br>  Cuando un bucle de eventos necesita realizar una operaci√≥n de E / S, utiliza el subproceso del sistema operativo del grupo de subprocesos, y cuando se completa la tarea, la devoluci√≥n de llamada se pone en cola durante la fase de <em>devoluciones de llamada pendientes</em> . </p><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/lz/z7/uw/lzz7uwcdvm1xd1yr6utj7cae36g.png"></div><br><p>  ¬øNo es genial? </p><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/it/yo/bh/ityobhc10qgnkk5m9yk5xp94ble.gif"></div><br><a name="p4"></a><br><h3 id="problema-cpu-yomkih-zadach">  El problema de las tareas intensivas en CPU </h3><br><p>  ¬°Node.js parece perfecto!  Puedes crear lo que quieras. </p><br><p>  Escribamos una API para calcular n√∫meros primos. </p><br><p>  Un n√∫mero primo es un n√∫mero entero (natural) mayor que uno y divisible por solo 1 y por s√≠ mismo. </p><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/nl/kn/7f/nlkn7fwr_kxhtktm-_gt0ci7ask.jpeg"></div><br><p>  Dado un n√∫mero N, la API debe calcular y devolver los primeros N primos en la lista (o matriz). </p><br><p> <code>primes.js</code> </p> <br><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">isPrime</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">n</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">let</span></span> i = <span class="hljs-number"><span class="hljs-number">2</span></span>, s = <span class="hljs-built_in"><span class="hljs-built_in">Math</span></span>.sqrt(n); i &lt;= s; i++) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(n % i === <span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> n &gt; <span class="hljs-number"><span class="hljs-number">1</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">nthPrime</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">n</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> counter = n; <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> iterator = <span class="hljs-number"><span class="hljs-number">2</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> result = []; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span>(counter &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) { isPrime(iterator) &amp;&amp; result.push(iterator) &amp;&amp; counter--; iterator++; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> result; } <span class="hljs-built_in"><span class="hljs-built_in">module</span></span>.exports = { isPrime, nthPrime };</code> </pre> <br><p> <code>index.js</code> </p> <br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> http = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'http'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> url = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'url'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> primes = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'./primes'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> server = http.createServer(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">request, response</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> { pathname, query } = url.parse(request.url, <span class="hljs-literal"><span class="hljs-literal">true</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (pathname === <span class="hljs-string"><span class="hljs-string">'/primes'</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> result = primes.nthPrime(query.n || <span class="hljs-number"><span class="hljs-number">0</span></span>); response.setHeader(<span class="hljs-string"><span class="hljs-string">'Content-Type'</span></span>, <span class="hljs-string"><span class="hljs-string">'application/json'</span></span>); response.write(<span class="hljs-built_in"><span class="hljs-built_in">JSON</span></span>.stringify(result)); response.end(); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { response.statusCode = <span class="hljs-number"><span class="hljs-number">404</span></span>; response.write(<span class="hljs-string"><span class="hljs-string">'Not Found'</span></span>); response.end(); } }); server.listen(<span class="hljs-number"><span class="hljs-number">8080</span></span>);</code> </pre> <br><p>  <code>prime.js</code> es la implementaci√≥n de los c√°lculos necesarios: la funci√≥n <code>isPrime</code> comprueba si el n√∫mero es primo y nthPrime devuelve N tales n√∫meros. </p><br><p>  El archivo <code>index.js</code> es responsable de crear el servidor y utiliza el m√≥dulo <code>prime.js</code> para procesar cada solicitud de <code>/primes</code> .  El n√∫mero N se lanza a trav√©s de la cadena de consulta en la URL. </p><br><p>  Para obtener los primeros 20 primos, debemos realizar una solicitud a <code>http://localhost:8080/primes?n=20</code> . </p><br><p>  Supongamos que tenemos 3 clientes que nos llaman e intentan acceder a nuestra API de E / S sin bloqueo: </p><br><ul><li>  La primera consulta 5 primos por segundo. </li><li>  El segundo pide 1000 primos por segundo </li><li>  El tercero solicita 10,000,000,000 primos, pero ... </li></ul><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/pz/rx/bl/pzrxblziplf06w7-kzbyojhafhg.gif"></div><br><p>  Cuando el tercer cliente env√≠a una solicitud, el subproceso principal se bloquea y este es el s√≠ntoma principal del problema de <strong>las tareas intensivas</strong> de <strong>CPU</strong> .  Cuando el hilo principal est√° ocupado realizando una tarea "pesada", se vuelve inaccesible para otras tareas. </p><br><p>  ¬øPero qu√© hay de libuv?  Si recuerda, esta biblioteca ayuda a Node.js a realizar operaciones de entrada / salida utilizando hilos del sistema operativo evitando bloquear el hilo principal y tiene toda la raz√≥n, esta es la soluci√≥n a nuestro problema, pero para que esto sea posible, nuestro m√≥dulo debe estar escrito en el idioma C ++ para que libuv pueda trabajar con √©l. </p><br><p>  Afortunadamente, a partir de v10.5, el m√≥dulo nativo de <strong>subprocesos de trabajo</strong> se ha agregado a Node.js. </p><br><a name="p5"></a><br><h3 id="vorkery-i-ih-potoki">  Los trabajadores y sus flujos. </h3><br><p>  Como nos dice la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">documentaci√≥n</a> : </p><br><blockquote>  Los trabajadores son √∫tiles para realizar operaciones JavaScript intensivas en CPU;  no los use para operaciones de entrada / salida, los mecanismos ya integrados en Node.js hacen frente de manera m√°s eficiente a esas tareas que el subproceso Worker. </blockquote><p>  <strong>C√≥digo fijo</strong> </p><br><p>  Es hora de reescribir nuestro c√≥digo: </p><br><p> <code>primes-workerthreads.js</code> </p> <br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> { workerData, parentPort } = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'worker_threads'</span></span>); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">isPrime</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">n</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">let</span></span> i = <span class="hljs-number"><span class="hljs-number">2</span></span>, s = <span class="hljs-built_in"><span class="hljs-built_in">Math</span></span>.sqrt(n); i &lt;= s; i++) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(n % i === <span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> n &gt; <span class="hljs-number"><span class="hljs-number">1</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">nthPrime</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">n</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> counter = n; <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> iterator = <span class="hljs-number"><span class="hljs-number">2</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> result = []; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span>(counter &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) { isPrime(iterator) &amp;&amp; result.push(iterator) &amp;&amp; counter--; iterator++; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> result; } parentPort.postMessage(nthPrime(workerData.n));</code> </pre> <br><p> <code>index-workerthreads.js</code> </p> <br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> http = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'http'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> url = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'url'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> { Worker } = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'worker_threads'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> server = http.createServer(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">request, response</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> { pathname, query } = url.parse(request.url, <span class="hljs-literal"><span class="hljs-literal">true</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (pathname === <span class="hljs-string"><span class="hljs-string">'/primes'</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> worker = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Worker(<span class="hljs-string"><span class="hljs-string">'./primes-workerthreads.js'</span></span>, { <span class="hljs-attr"><span class="hljs-attr">workerData</span></span>: { <span class="hljs-attr"><span class="hljs-attr">n</span></span>: query.n || <span class="hljs-number"><span class="hljs-number">0</span></span> } }); worker.on(<span class="hljs-string"><span class="hljs-string">'error'</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ response.statusCode = <span class="hljs-number"><span class="hljs-number">500</span></span>; response.write(<span class="hljs-string"><span class="hljs-string">'Oops there was an error...'</span></span>); response.end(); }); <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> result; worker.on(<span class="hljs-string"><span class="hljs-string">'message'</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">message</span></span></span><span class="hljs-function">) </span></span>{ result = message; }); worker.on(<span class="hljs-string"><span class="hljs-string">'exit'</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ response.setHeader(<span class="hljs-string"><span class="hljs-string">'Content-Type'</span></span>, <span class="hljs-string"><span class="hljs-string">'application/json'</span></span>); response.write(<span class="hljs-built_in"><span class="hljs-built_in">JSON</span></span>.stringify(result)); response.end(); }); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { response.statusCode = <span class="hljs-number"><span class="hljs-number">404</span></span>; response.write(<span class="hljs-string"><span class="hljs-string">'Not Found'</span></span>); response.end(); } }); server.listen(<span class="hljs-number"><span class="hljs-number">8080</span></span>);</code> </pre> <br><p>  En el <code>index-workerthreads.js</code> , cada solicitud a <code>/primes</code> crea una instancia de la clase <code>Worker</code> (desde el m√≥dulo nativo <code>worker_threads</code> ) para cargar y ejecutar el <code>primes-workerthreads.js</code> en el subproceso de trabajo.  Cuando la lista de n√∫meros primos se calcula y est√° lista, se activa el evento del <code>message</code> : el resultado cae en la secuencia principal debido a que el trabajador no tiene trabajo restante, tambi√©n activa el evento de <code>exit</code> , permitiendo que la secuencia principal env√≠e datos al cliente. </p><br><p>  <code>primes-workerthreads.js</code> cambiado un poco.  Importa <code>workerData</code> (esta es una copia de los par√°metros pasados ‚Äã‚Äãdel hilo principal) y <code>parentPort</code> trav√©s del cual el resultado del trabajo del trabajador se devuelve al hilo principal. </p><br><p>  Ahora intentemos nuestro ejemplo nuevamente y veamos qu√© sucede: </p><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/zu/vk/gh/zuvkghy8dnhjryfdf5b62ped8dw.gif"></div><br><p>  El hilo principal ya no est√° bloqueado <img width="115" src="https://habrastorage.org/webt/nn/hs/r3/nnhsr3jiw_4aed53jye8gokutpy.png">  !!!!! </p><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/tt/ij/el/ttijelgt36k_vbengx3qjaaajlc.gif"></div><br><p>  Ahora todo funciona como deber√≠a, pero producir trabajadores sin ninguna raz√≥n todav√≠a no es una buena pr√°ctica; crear hilos no es un placer barato.  Aseg√∫rese de crear un grupo de subprocesos antes de esto. </p><br><h4 id="zaklyuchenie">  Conclusi√≥n </h4><br><p>  Node.js es una tecnolog√≠a poderosa que debe explorarse siempre que sea posible. <br>  Mi recomendaci√≥n personal: ¬°siempre ten curiosidad!  Si sabe c√≥mo funciona algo desde adentro, puede trabajar con √©l de manera m√°s eficiente. </p><br><p>  Eso es todo por hoy chicos.  Espero que esta publicaci√≥n te haya sido √∫til y hayas aprendido algo nuevo sobre Node.js. </p><br><p>  Gracias por leer y nos vemos en las pr√≥ximas publicaciones. <img width="20" src="https://habrastorage.org/webt/bd/lk/kd/bdlkkdf7adtljydvhxyw22y3cfi.png">  . </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/460661/">https://habr.com/ru/post/460661/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../460645/index.html">Hacer el bien haciendo el mal: escribir c√≥digo malvado con Go, Parte 1</a></li>
<li><a href="../460647/index.html">Resolver un trabajo con pwnable.kr 05 - c√≥digo de acceso. Vuelva a escribir la tabla de enlaces del procedimiento a trav√©s de la vulnerabilidad de cadena de formato</a></li>
<li><a href="../460651/index.html">Reuni√≥n de la Society of Anonymous Testers: TMS, monitoreo de monitoreo, evaluaci√≥n de calidad de b√∫squeda y pruebas nativas de iOS</a></li>
<li><a href="../460655/index.html">C√≥mo romp√≠ Telegram</a></li>
<li><a href="../460659/index.html">Usando tuber√≠as para pivotar</a></li>
<li><a href="../460665/index.html">Preguntas frecuentes preliminares: ¬øPor qu√© los est√°ndares C ++ salen cada tres a√±os?</a></li>
<li><a href="../460667/index.html">Automatizaci√≥n de pruebas de servicios pagos en iOS</a></li>
<li><a href="../460669/index.html">C√≥mo garantizar la seguridad del desarrollo, ahorrando tiempo y nervios</a></li>
<li><a href="../460671/index.html">Propiedad y endeudamiento en D</a></li>
<li><a href="../460673/index.html">Exponer la magia de DiffUtil</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>