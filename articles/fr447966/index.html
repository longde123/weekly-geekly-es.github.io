<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üçõ üòò ‚öíÔ∏è Comment connecter GitLab et Pantheon et optimiser les workflows Drupal et WordPress üë∂üèø üë©üèª‚Äç‚úàÔ∏è üë©üèª‚Äçüéì</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Notre invit√©, cr√©ateur des outils de d√©veloppement Pantheon, explique comment automatiser les d√©ploiements WordPress √† l'aide de GitLab CI / CD. 


 A...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Comment connecter GitLab et Pantheon et optimiser les workflows Drupal et WordPress</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/southbridge/blog/447966/"><p><img src="https://habrastorage.org/webt/ja/h2/ef/jah2efouevm2la2v9vkt3vuojm8.png"></p><br><p>  Notre invit√©, cr√©ateur des outils de d√©veloppement Pantheon, explique comment automatiser les d√©ploiements WordPress √† l'aide de GitLab CI / CD. </p><br><p>  Au <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Panth√©on,</a> je m'occupe des relations avec les d√©veloppeurs, donc je suis toujours √† la recherche de nouvelles fa√ßons d'aider les d√©veloppeurs WordPress et Drupal √† r√©soudre les probl√®mes d'automatisation dans leurs flux de travail.  Pour ce faire, j'aime exp√©rimenter de nouveaux outils et les combiner entre eux pour un travail efficace. </p><br><p>  <strong>Je vois souvent des d√©veloppeurs tourment√©s avec un seul serveur de d√©veloppement.</strong> </p><br><p> Amusant - attendre votre tour pour utiliser un serveur ou envoyer aux clients une URL avec une note: "Regardez ici, mais pas ici." </p><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Les environnements multid√©v</a> - l'un des outils sympas du Panth√©on - r√©solvent ce probl√®me, car avec eux, vous pouvez cr√©er des environnements pour les branches Git sur demande.  Chaque environnement multidev poss√®de sa propre URL et sa propre base de donn√©es, de sorte que les d√©veloppeurs travaillent en silence, v√©rifient la qualit√© et obtiennent l'approbation sans marcher les uns sur les autres. </p><br><p>  Mais Pantheon n'a pas d'outils pour le contr√¥le de version ou l'int√©gration et le d√©ploiement continus (CI / CD).  Mais il s'agit d'une plate-forme flexible avec laquelle vous pouvez int√©grer tous les outils. </p><br><p>  <strong>J'ai √©galement remarqu√© que pour le d√©veloppement de l'√©quipe, ils utilisent un seul outil, et pour l'assemblage et le d√©ploiement - d'autres.</strong> </p><br><p>  Par exemple, ils ont diff√©rents outils pour le contr√¥le de version et CI / CD.  Vous devez jouer et basculer entre les outils pour modifier le code et diagnostiquer les probl√®mes. </p><a name="habracut"></a><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">GitLab</a> dispose d'un ensemble complet d'outils de d√©veloppement: pour le contr√¥le de version, les tickets, les demandes de fusion, le meilleur pipeline CI / CD de la classe, un registre de conteneurs et tout √ßa.  Je n'ai pas rencontr√© d'applications dans lesquelles il y aurait tellement de choses √† g√©rer le flux de travail de d√©veloppement. </p><br><p>  J'adore l'automatisation, j'ai donc appris √† connecter Pantheon √† GitLab pour que les validations de la branche principale de GitLab soient d√©ploy√©es dans l'environnement de d√©veloppement principal de Pantheon.  Et les demandes de fusion sur GitLab peuvent cr√©er et d√©ployer du code dans des environnements multi-vid√©os du Panth√©on. </p><br><p>  Dans ce guide, je vais vous montrer comment configurer une connexion entre GitLab et Pantheon et optimiser votre flux de travail WordPress et Drupal. </p><br><p>  Vous pouvez, bien s√ªr, mettre en <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">miroir le r√©f√©rentiel GitLab</a> , mais nous ferons tout avec des plumes pour creuser dans <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">GitLab CI</a> et utiliser cet outil non seulement pour le d√©ploiement √† l'avenir. </p><br><h3 id="vvedenie">  Pr√©sentation </h3><br><p>  Pour cet article, vous devez comprendre que Pantheon divise chaque site en trois √©l√©ments: code, base de donn√©es et fichiers. </p><br><p>  Le code comprend des fichiers CMS, tels que le noyau, les plugins et les th√®mes WordPress.  Ces fichiers sont g√©r√©s dans <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">le r√©f√©rentiel Git</a> h√©berg√© par Pantheon, c'est-√†-dire que nous pouvons d√©ployer le code de GitLab vers Pantheon avec Git. <br>  Les fichiers du Panth√©on sont appel√©s fichiers multim√©dias, c'est-√†-dire des images pour le site.  Habituellement, ils sont t√©l√©charg√©s par les utilisateurs et Git les ignore. </p><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Cr√©ez un compte gratuit</a> , apprenez-en plus sur <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">le flux de travail de Pantheon</a> ou <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">inscrivez-vous pour une d√©monstration</a> sur pantheon.io. </p><br><h3 id="predpolozheniya">  Hypoth√®ses </h3><br><p> Mon projet sur Pantheon et GitLab s'appelle <code>pantheon-gitlab-blog-demo</code> .  Le nom du projet doit √™tre unique.  Ici, nous travaillerons avec le site WordPress.  Vous pouvez prendre Drupal, mais vous devrez changer quelque chose. </p><br><p>  J'utiliserai la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ligne de commande Git</a> , et vous pouvez travailler dans l' <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">interface graphique</a> si vous le souhaitez. </p><br><h3 id="sozdaem-proekt">  Cr√©er un projet </h3><br><p>  Pour commencer, cr√©ez <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">un projet GitLab</a> (nous y reviendrons). </p><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Cr√©ez</a> maintenant <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">un site WordPress sur Panth√©on</a> .  Installez ensuite WordPress pour le site du tableau de bord. </p><br><blockquote>  Si vos mains vous d√©mangent, changez quelque chose, par exemple, supprimez et ajoutez des plugins, soyez patient.  Le site n'est pas encore connect√© √† GitLab, et nous voulons que toutes les modifications de code passent par GitLab. </blockquote><p>  Lorsque nous installons WordPress, nous revenons au tableau de bord du site Web du Panth√©on et changeons le mode de d√©veloppement en Git. </p><br><p> <a href=""><img src="https://habrastorage.org/webt/up/zf/50/upzf50ocuma107rer9uxiybvjnc.png"></a> </p><br><h3 id="nachalnyy-kommit-na-gitlab">  Commit initial de GitLab </h3><br><p>  Vous devez maintenant transf√©rer le code WordPress initial du site Web du Panth√©on vers GitLab.  Pour ce faire, nous clonons le code du r√©f√©rentiel Git du site Pantheon localement, puis l'envoyons au r√©f√©rentiel GitLab. </p><br><p>  Pour le rendre plus simple et plus s√ªr, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">nous ajouterons une cl√© SSH √† Pantheon</a> et nous n'entrerons pas le mot de passe √† chaque fois que nous clonerons le d√©p√¥t Pantheon Git.  Dans le m√™me temps, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">nous ajouterons une cl√© SSH √† GitLab</a> . </p><br><p>  Pour ce faire, nous clonons le site Panth√©on localement en copiant la commande du champ Cloner avec Git sur le tableau de bord du site. </p><br><p> <a href=""><img src="https://habrastorage.org/webt/em/qz/ga/emqzgamloafdlzbj3xp0ssrt2o0.png"></a> <br>  <em>Si vous avez besoin d'aide, lisez la documentation <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Git Getting Started pour Pantheon</a> .</em> </p><br><p>  Maintenant, changez <code>git remote origin</code> pour pointer vers GitLab au lieu de Pantheon.  Cela peut √™tre fait <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><code> git remote</code></a> . </p><br><p>  Passons au projet GitLab et copions l'URL du r√©f√©rentiel √† partir de la liste d√©roulante Clone sur la page des d√©tails du projet.  Nous allons s√©lectionner l'option Cloner avec SSH, car nous avons d√©j√† configur√© la cl√© SSH. </p><br><p> <a href=""><img src="https://habrastorage.org/webt/6m/4o/ea/6m4oeailmhmcggywg27uptq7aio.png"></a> </p><br><p>  Par d√©faut, <code>git remote</code> pour la copie locale du r√©f√©rentiel de code est <code>origin</code> .  Cela peut √™tre modifi√© avec <code>git remote set-url origin [URL  GitLab]</code> , o√π au lieu des crochets, nous entrons l'URL r√©elle. </p><br><p>  Enfin, ex√©cutez <code>git push origin master --force</code> pour soumettre votre code WordPress de Pantheon √† GitLab. </p><br><blockquote>  L'option ‚Äìforce n'est n√©cessaire qu'une seule fois.  Ensuite, dans <code>git push</code> commandes <code>git push</code> sur GitLab, ce ne sera pas le cas. </blockquote><br><h3 id="nastraivaem-uchetnye-dannye-i-peremennye">  Configurer les informations d'identification et les variables </h3><br><p>  Rappelez-vous comment nous avons ajout√© localement une cl√© SSH pour vous connecter √† Pantheon et GitLab?  Le jeton SSH peut √™tre utilis√© pour autoriser GitLab et Pantheon. </p><br><p>  GitLab a une excellente documentation.  Voyons la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">section sur les cl√©s SSH lors de l'utilisation de l'ex√©cuteur Docker dans le document sur l'utilisation des cl√©s SSH avec GitLab CI / CD</a> . </p><br><p>  Nous allons maintenant terminer les deux premi√®res √©tapes: <em>cr√©er une nouvelle paire de cl√©s SSH localement avec ssh-keygen et ajouter la cl√© priv√©e en tant que variable au projet</em> . </p><br><p>  Ensuite, nous d√©finissons <code>SSH_PRIVATE_KEY</code> comme <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">variable d'environnement GitLab CI / CD</a> dans les param√®tres du projet. <br>  Dans les troisi√®me et quatri√®me √©tapes, cr√©ez un <code>.gitlab-ci.yml</code> avec le contenu suivant: </p><br><pre> <code class="plaintext hljs">before_script: # See https://docs.gitlab.com/ee/ci/ssh_keys/README.html - eval $(ssh-agent -s) - echo "$SSH_PRIVATE_KEY" | tr -d '\r' | ssh-add - &gt; /dev/null - mkdir -p $HOME/.ssh &amp;&amp; echo "StrictHostKeyChecking no" &gt;&gt; "$HOME/.ssh/config" - git config --global user.email "$GITLAB_USER_EMAIL" - git config --global user.name "Gitlab CI"</code> </pre> <br><p>  Jusqu'√† ce que nous <code>.gitlab-ci.yml</code> , quelque chose d'autre doit y √™tre ajout√©. </p><br><p>  Maintenant, nous effectuons la cinqui√®me √©tape et <em>ajoutons la cl√© publique que nous avons cr√©√©e dans la premi√®re √©tape aux services auxquels vous devez acc√©der dans l'environnement de g√©n√©ration</em> . </p><br><p>  Dans notre cas, nous voulons avoir acc√®s au Panth√©on depuis GitLab.  Suivez les instructions du document Pantheon pour <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ajouter une cl√© SSH √† Pantheon</a> et terminez cette √©tape. </p><br><blockquote>  Rappelez-vous: SSH ferm√© dans GitLab, ouvert au Panth√©on. </blockquote><p>  Configurez quelques variables d'environnement suppl√©mentaires.  Le premier s'appelle PANTHEON_SITE.  Sa signification est le nom du site du Panth√©on sur votre machine. </p><br><p>  Le nom sur la machine est indiqu√© √† la fin de la commande Cloner avec Git.  Vous avez d√©j√† clon√© le site localement, ce sera donc le nom du r√©pertoire du r√©f√©rentiel local. </p><br><p> <a href=""><img src="https://habrastorage.org/webt/rf/3p/gb/rf3pgbmo_2u0xsri8d1hq5f-xxw.png"></a> </p><br><p>  Ensuite, configurez la <code>PANTHEON_GIT_URL</code> environnement <code>PANTHEON_GIT_URL</code> .  Il s'agit de l'URL du r√©f√©rentiel Git pour le site du Panth√©on que nous avons d√©j√† utilis√©. </p><br><blockquote>  Nous entrons uniquement l'URL du r√©f√©rentiel SSH, sans <code>git clone</code> et le nom du site sur la machine √† la fin. </blockquote><p>  Fuh.  C'est fait, maintenant nous pouvons terminer notre <code>.gitlab-ci.yml</code> . </p><br><h3 id="sozdaem-zadachu-deploya">  Cr√©er une t√¢che de d√©ploiement </h3><br><p>  Ce que nous ferons initialement avec GitLab CI est tr√®s similaire √† ce que nous avons fait avec les r√©f√©rentiels Git auparavant.  Mais cette fois, ajoutez le r√©f√©rentiel Pantheon comme deuxi√®me source Git distante, puis envoyez le code de GitLab √† Pantheon. </p><br><p>  Pour ce faire, configurez <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">l'√©tape de</a> <code>deploy</code> et <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">la t√¢che</a> <code>deploy:dev</code> , car nous d√©ploierons dans l'environnement de d√©veloppement sur Pantheon.  Par cons√©quent, le <code>.gitlab-ci.yml</code> ressemblera √† ceci: </p><br><pre> <code class="plaintext hljs">stages: - deploy before_script: # See https://docs.gitlab.com/ee/ci/ssh_keys/README.html - eval $(ssh-agent -s) - echo "$SSH_PRIVATE_KEY" | tr -d '\r' | ssh-add - &gt; /dev/null - mkdir -p $HOME/.ssh &amp;&amp; echo "StrictHostKeyChecking no" &gt;&gt; "$HOME/.ssh/config" - git config --global user.email "$GITLAB_USER_EMAIL" - git config --global user.name "Gitlab CI" deploy:dev: stage: deploy environment: name: dev url: https://dev-$PANTHEON_SITE.pantheonsite.io/ script: - git remote add pantheon $PANTHEON_GIT_URL - git push pantheon master --force only: - master</code> </pre> <br><p>  Les variables <code>SSH_PRIVATE_KEY, PANTHEON_SITE</code> et <code>PANTHEON_GIT_URL</code> devraient sembler famili√®res - nous avons configur√© ces variables d'environnement plus t√¥t.  Avec ces variables, nous pouvons utiliser les valeurs du <code>.gitlab-ci.yml</code> plusieurs fois, et nous n'aurons besoin de les mettre √† jour qu'au m√™me endroit. </p><br><p>  Enfin, ajoutez, <code>.gitlab-ci.yml</code> et <code>.gitlab-ci.yml</code> √† GitLab. </p><br><h3 id="proveryaem-deploy">  V√©rifier le d√©ploiement </h3><br><p>  Si nous avons tout fait correctement, la t√¢che <code>deploy:dev</code> r√©ussira dans GitLab CI / CD et enverra le <code>.gitlab-ci.yml</code> √† Pantheon.  Voyons voir. </p><br><p> <a href=""><img src="https://habrastorage.org/webt/ex/pu/to/exputo8aihdn0sxv1aavrpa-rg4.png"></a> </p><br><p> <a href=""><img src="https://habrastorage.org/webt/2w/4_/zs/2w4_zszf0r6dxu8jvgo-ogfzzqi.png"></a> </p><br><p> <a href=""><img src="https://habrastorage.org/webt/6z/tk/ir/6ztkirsm-22bbcegra12_lyx3zg.png"></a> </p><br><h3 id="otpravlyaem-vetki-merzh-rekvestov-v-pantheon">  Nous envoyons des branches de demandes de fusion au Panth√©on </h3><br><p>  Ici, nous utiliserons ma fonctionnalit√© Pantheon pr√©f√©r√©e - <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">multidev</a> , o√π vous pouvez cr√©er des environnements Pantheon suppl√©mentaires pour les succursales Git sur demande. </p><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">L'acc√®s √† plusieurs vid√©os est limit√©</a> , cette section est donc <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">facultative</a> .  Mais si vous y avez acc√®s, vous pouvez s√©rieusement augmenter la productivit√© en configurant la cr√©ation automatique d'environnements multid√©v sur Panth√©on √† partir des demandes de fusion GitLab. </p><br><p>  Commencez par cr√©er une nouvelle branche Git localement en utilisant <code>git checkout -b multidev-support</code> .  Maintenant, encore une fois, quelque chose va changer dans <code>.gitlab-ci.yml</code> . </p><br><p>  J'aime indiquer le num√©ro de demande de fusion dans le nom de l'environnement Pantheon.  Par exemple, la premi√®re demande de fusion est <code>mr-1</code> , la seconde est <code>mr-2</code> , etc. </p><br><p>  La demande de fusion est en train de changer, nous devons donc identifier dynamiquement les noms des succursales du Panth√©on.  Sur GitLab, c'est simple - vous devez utiliser <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">des variables d'environnement pr√©d√©finies</a> . </p><br><p>  Nous pouvons prendre <code>$CI_MERGE_REQUEST_IID</code> pour indiquer le num√©ro de demande de fusion.  Appliquons tout cela avec les variables d'environnement global que nous avons sp√©cifi√©es pr√©c√©demment, et ajoutons une nouvelle t√¢che deploy: multidev √† la fin du <code>.gitlab-ci.yml</code> . </p><br><pre> <code class="plaintext hljs">deploy:multidev: stage: deploy environment: name: multidev/mr-$CI_MERGE_REQUEST_IID url: https://mr-$CI_MERGE_REQUEST_IID-$PANTHEON_SITE.pantheonsite.io/ script: # Checkout the merge request source branch - git checkout $CI_COMMIT_REF_NAME # Add the Pantheon git repository as an additional remote - git remote add pantheon $PANTHEON_GIT_URL # Push the merge request source branch to Pantheon - git push pantheon $CI_COMMIT_REF_NAME:mr-$CI_MERGE_REQUEST_IID --force only: - merge_requests</code> </pre> <br><p>  Il sera similaire √† notre t√¢che <code>deploy:dev</code> , seule la branche est envoy√©e au Panth√©on, et non au <code>master</code> . </p><br><p>  Nous avons ajout√© et <code>.gitlab-ci.yml</code> mis √† jour, et envoyons maintenant une nouvelle branche √† GitLab avec le <code>git push -u origin multidev-support</code> . </p><br><p>  Cr√©ez maintenant une nouvelle <em>demande</em> de <em>fusion √†</em> partir de la branche <code>multidev-support</code> en cliquant sur <em>Cr√©er une demande de fusion</em> . </p><br><p> <a href=""><img src="https://habrastorage.org/webt/bi/bv/gt/bibvgthkwykacqew-cswygjdmig.png"></a> </p><br><p>  Apr√®s avoir cr√©√© la demande de fusion, nous examinons comment la <code>deploy:multidev</code> CI / CD <code>deploy:multidev</code> . </p><br><p> <a href=""><img src="https://habrastorage.org/webt/ck/ev/lq/ckevlqnrfbfanoj0dlmjt26wxpw.png"></a> </p><br><p>  Voir - une nouvelle branche a √©t√© envoy√©e au Panth√©on.  Mais si nous allons dans la section multidev du tableau de bord du site du Panth√©on, nous n'y verrons pas le nouvel environnement. </p><br><p> <a href=""><img src="https://habrastorage.org/webt/yy/yy/bz/yyyybzmedtphnsj-6humcyu2hmu.png"></a> </p><br><p>  Jetez un ≈ìil √† la section Git Branches. </p><br><p> <a href=""><img src="https://habrastorage.org/webt/hp/_o/bl/hp_obl6r7pv4ihuot7i6gx4rqwm.png"></a> </p><br><p>  En cons√©quence, notre succursale <code>mr-1</code> a atteint le Panth√©on.  Cr√©ez un environnement √† partir de la branche <code>mr-1</code> . </p><br><p> <a href=""><img src="https://habrastorage.org/webt/2v/xg/ez/2vxgez9ugraihe2bdyn-5cxevjm.png"></a> </p><br><p>  Nous avons cr√©√© un environnement multidev et revenons maintenant √† GitLab et regardons la section <em>Op√©rations&gt; Environnements</em> .  Nous verrons des entr√©es pour <code>dev</code> et <code>mr-1</code> . </p><br><p>  En effet, nous avons ajout√© une entr√©e d' <code>environment</code> nomm√©e <code>name</code> et <code>url</code> aux t√¢ches CI / CD.  Si nous cliquons sur l'ic√¥ne d'environnement ouvert, nous irons √† l'URL de l'environnement Pantheon multidev. </p><br><h3 id="avtomatiziruem-sozdanie-multidev">  Automatisez la cr√©ation de multidev </h3><br><p>  En principe, vous pouvez vous arr√™ter ici et n'oubliez pas de cr√©er un environnement multid√©v pour chaque demande de fusion, mais ce processus peut √™tre automatis√©. </p><br><p>  Pantheon dispose d'un outil de ligne de commande <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Terminus</a> o√π vous pouvez travailler avec la plate-forme automatiquement.  Dans Terminus, vous pouvez cr√©er des environnements multi-vid√©os √† partir de la ligne de commande - id√©al pour <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">GitLab CI</a> . </p><br><p>  Nous avons besoin d'une nouvelle demande de fusion pour la tester.  Cr√©ez une nouvelle branche en utilisant <code>git checkout -b auto-multidev-creation</code> . </p><br><p>  Pour utiliser Terminus dans les t√¢ches GitLab CI / CD, vous avez besoin d'un jeton de machine pour l'authentification dans Terminus et d'une image de conteneur avec Terminus. </p><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Cr√©ez un jeton de machine Pantheon</a> , enregistrez-le dans un endroit s√ªr et ajoutez-le en tant que variable d'environnement global dans GitLab avec le nom <code>PANTHEON_MACHINE_TOKEN</code> . </p><br><blockquote>  Si vous avez oubli√© comment ajouter des variables d'environnement GitLab, revenez √† l'endroit o√π nous avons d√©fini <code>PANTHEON_SITE</code> . </blockquote><br><h3 id="sozdaem-dockerfile-s-terminus">  Cr√©er un Dockerfile avec Terminus </h3><br><p>  Si vous n'utilisez pas Docker ou n'aimez pas <code>Dockerfile</code> , prenez mon <code>registry.gitlab.com/ataylorme/pantheon-gitlab-blog-demo:latest</code> image et ignorez cette section. </p><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">GitLab a un registre de conteneurs</a> o√π vous pouvez cr√©er et h√©berger un Dockerfile pour notre projet.  Cr√©ons un Dockerfile avec Terminus pour travailler avec Pantheon. </p><br><p>  Terminus est un outil en ligne de commande en PHP, alors commen√ßons par l'image PHP.  J'installe Terminus via Composer, je vais donc prendre l' <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">image officielle de Docker Composer</a> comme base.  Cr√©ez un <code>Dockerfile</code> dans le r√©pertoire du r√©f√©rentiel local avec le contenu suivant: </p><br><pre> <code class="plaintext hljs"># Use the official Composer image as a parent image FROM composer:1.8 # Update/upgrade apk RUN apk update RUN apk upgrade # Make the Terminus directory RUN mkdir -p /usr/local/share/terminus # Install Terminus 2.x with Composer RUN /usr/bin/env COMPOSER_BIN_DIR=/usr/local/bin composer -n --working-dir=/usr/local/share/terminus require pantheon-systems/terminus:"^2"</code> </pre> <br><p>  Suivez les instructions pour assembler et envoyer des images √† partir de la section <em>Cr√©er</em> et envoyer des images dans la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">documentation du registre de conteneurs</a> pour collecter l'image √† partir du <code>Dockerfile</code> et l'envoyer √† GitLab. </p><br><p>  Ouvrez la section <em>Registre</em> dans le projet GitLab.  Si tout se passe comme pr√©vu, il y aura notre image.  Enregistrez le lien vers la balise image - nous en avons besoin pour le <code>.gitlab-ci.yml</code> . </p><br><p> <a href=""><img src="https://habrastorage.org/webt/_x/ta/yn/_xtayn5xz10hq5kuv7abvqvskgq.png"></a> </p><br><p>  La section de <code>script</code> de la <code>deploy:multidev</code> commence √† cro√Ætre, nous allons donc la d√©placer vers un fichier s√©par√©.  Cr√©ez un nouveau <code>private/multidev-deploy.sh:</code> </p><br><pre> <code class="plaintext hljs">#!/bin/bash # Store the mr- environment name export PANTHEON_ENV=mr-$CI_MERGE_REQUEST_IID # Authenticate with Terminus terminus auth:login --machine-token=$PANTHEON_MACHINE_TOKEN # Checkout the merge request source branch git checkout $CI_COMMIT_REF_NAME # Add the Pantheon Git repository as an additional remote git remote add pantheon $PANTHEON_GIT_URL # Push the merge request source branch to Pantheon git push pantheon $CI_COMMIT_REF_NAME:$PANTHEON_ENV --force # Create a function for determining if a multidev exists TERMINUS_DOES_MULTIDEV_EXIST() { # Stash a list of Pantheon multidev environments PANTHEON_MULTIDEV_LIST="$(terminus multidev:list ${PANTHEON_SITE} --format=list --field=id)" while read -r multiDev; do if [[ "${multiDev}" == "$1" ]] then return 0; fi done &lt;&lt;&lt; "$PANTHEON_MULTIDEV_LIST" return 1; } # If the mutltidev doesn't exist if ! TERMINUS_DOES_MULTIDEV_EXIST $PANTHEON_ENV then # Create it with Terminus echo "No multidev for $PANTHEON_ENV found, creating one..." terminus multidev:create $PANTHEON_SITE.dev $PANTHEON_ENV else echo "The multidev $PANTHEON_ENV already exists, skipping creating it..." fi</code> </pre> <br><p>  Le script se trouve dans un r√©pertoire priv√© et <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ne fournit pas d'acc√®s Web sur Pantheon</a> .  Nous avons un script pour notre logique multid√©v.  Mettons maintenant √† jour la <code>deploy:multidev</code> fichier <code>.gitlab-ci.yml</code> pour obtenir ceci: </p><br><pre> <code class="plaintext hljs">deploy:multidev: stage: deploy environment: name: multidev/mr-$CI_MERGE_REQUEST_IID url: https://mr-$CI_MERGE_REQUEST_IID-$PANTHEON_SITE.pantheonsite.io/ script: # Run the multidev deploy script - "/bin/bash ./private/multidev-deploy.sh" only: - merge_requests</code> </pre> <br><p>  Nous devons nous assurer que nos t√¢ches sont effectu√©es dans l'image personnalis√©e cr√©√©e, nous ajoutons donc l' <code>image</code> d√©finition avec l'URL de registre dans <code>.gitlab-ci.yml</code> .  En cons√©quence, nous avons obtenu le <code>.gitlab-ci.yml</code> : </p><br><pre> <code class="plaintext hljs">image: registry.gitlab.com/ataylorme/pantheon-gitlab-blog-demo:latest stages: - deploy before_script: # See https://docs.gitlab.com/ee/ci/ssh_keys/README.html - eval $(ssh-agent -s) - echo "$SSH_PRIVATE_KEY" | tr -d '\r' | ssh-add - &gt; /dev/null - mkdir -p $HOME/.ssh &amp;&amp; echo "StrictHostKeyChecking no" &gt;&gt; "$HOME/.ssh/config" - git config --global user.email "$GITLAB_USER_EMAIL" - git config --global user.name "Gitlab CI" deploy:dev: stage: deploy environment: name: dev url: https://dev-$PANTHEON_SITE.pantheonsite.io/ script: - git remote add pantheon $PANTHEON_GIT_URL - git push pantheon master --force only: - master deploy:multidev: stage: deploy environment: name: multidev/mr-$CI_MERGE_REQUEST_IID url: https://mr-$CI_MERGE_REQUEST_IID-$PANTHEON_SITE.pantheonsite.io/ script: # Run the multidev deploy script - "/bin/bash ./private/multidev-deploy.sh" only: - merge_requests</code> </pre> <br><p>  Ajoutez, <code>private/multidev-deploy.sh</code> et envoyez <code>private/multidev-deploy.sh</code> et <code>.gitlab-ci.yml</code> .  Revenons maintenant √† GitLab et attendez la fin de la t√¢che CI / CD.  Soyez patient: plusieurs vid√©os peuvent prendre plusieurs minutes. </p><br><p>  Ensuite, nous allons regarder la liste multidev sur Panth√©on.  Oh miracle!  L'environnement multidev <code>mr-2</code> est d√©j√† l√†. </p><br><p> <a href=""><img src="https://habrastorage.org/webt/gx/jf/ab/gxjfabnawlvvtncrg268q7nwkiw.png"></a> </p><br><h3 id="zaklyuchenie">  Conclusion </h3><br><p>  Mon √©quipe s'est beaucoup plus amus√©e lorsque nous avons commenc√© √† ouvrir des demandes de fusion et √† cr√©er des environnements automatiquement. </p><br><p>  Avec les puissants outils GitLab et Pantheon, vous pouvez connecter GitLab √† Pantheon automatiquement. </p><br><p>  Une fois que nous utilisons GitLab CI / CD, notre flux de travail sera l'endroit o√π grandir.  Voici quelques id√©es pour commencer: </p><br><ul><li>  Ajoutez une √©tape de g√©n√©ration. </li><li>  Ajoutez des tests automatis√©s. </li><li>  Ajoutez une t√¢che pour garantir la conformit√© aux normes de code. </li><li>  Ajoutez <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">des tests de s√©curit√© d'application dynamiques</a> . </li></ul><br><p>  √âcrivez ce que vous pensez du GitLab, du Panth√©on et de l'automatisation. </p><br><p>  PS Saviez-vous que Terminus, l'outil en ligne de commande du Panth√©on, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">peut √™tre √©tendu via des plugins</a> ? </p><br><p>  Chez Pantheon, nous avons travaill√© dur sur la version 2 de notre <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">plugin pour les outils de construction Terminus</a> compatibles GitLab.  Si vous ne voulez pas bricoler les param√®tres de chaque projet, essayez ce plugin et aidez-nous √† tester la b√™ta v2.  Pour la commande Terminus <code>build:project:create</code> , vous n'avez besoin que du token Pantheon et du token GitLab.  Elle d√©ploiera un exemple de projet avec Composer et des tests automatis√©s, cr√©era un nouveau projet dans GitLab, le nouveau site Pantheon, et les connectera √† l'aide de variables d'environnement et de cl√©s SSH. </p><br><h3 id="ob-avtore">  √Ä propos de l'auteur </h3><br><p>  Andrew Taylor cr√©e des outils de d√©veloppement au <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Panth√©on</a> . </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr447966/">https://habr.com/ru/post/fr447966/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr447956/index.html">Communications quantiques √† l'Universit√© ITMO - un projet de syst√®mes de transfert de donn√©es incassables</a></li>
<li><a href="../fr447958/index.html">CJM pour faux d√©clenchement de l'antivirus DrWeb</a></li>
<li><a href="../fr447960/index.html">Veeam Linux Backup sur Elbrus OS. Substitution d'importation ['?' | "." | '!']</a></li>
<li><a href="../fr447962/index.html">Les pirates peuvent contr√¥ler √† distance Tesla Model S en utilisant le syst√®me de pilote automatique</a></li>
<li><a href="../fr447964/index.html">Test de micro-ordinateur pour l'IoT</a></li>
<li><a href="../fr447968/index.html">√âcriture en rouille + CUDA C</a></li>
<li><a href="../fr447970/index.html">Journalisation Javascript super simple - Deux d√©corateurs et termin√©</a></li>
<li><a href="../fr447976/index.html">D√©veloppement et assemblage d'une lampe photo</a></li>
<li><a href="../fr447980/index.html">Pourquoi est-il imp√©ratif d'investir et de d√©velopper une application Taxi de marque pour votre entreprise?</a></li>
<li><a href="../fr447982/index.html">Digest: 10 documents sur les √©crans et les projecteurs pour le home cin√©ma</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>