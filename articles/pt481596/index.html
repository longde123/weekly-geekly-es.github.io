<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>‚òÄÔ∏è üë©üèø‚ÄçüöÄ ‚è¨ Analisando as configura√ß√µes do ELK 7.5 para an√°lise de log do Mikrotik üìå üñêüèº üëáüèº</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="H√° muito tempo √© uma ideia ver o que voc√™ pode fazer com o ELK e fontes improvisadas de logs e estat√≠sticas. Nas p√°ginas do Habr, pretendo mostrar um ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Analisando as configura√ß√µes do ELK 7.5 para an√°lise de log do Mikrotik</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/481596/">  H√° muito tempo √© uma ideia ver o que voc√™ pode fazer com o ELK e fontes improvisadas de logs e estat√≠sticas.  Nas p√°ginas do Habr, pretendo mostrar um exemplo pr√°tico de como, usando um mini-servidor dom√©stico, voc√™ pode criar, por exemplo, honeypot com um sistema de an√°lise de logs baseado na pilha ELK.  Neste artigo, mostrarei o exemplo mais simples de an√°lise de logs de firewall usando a pilha ELK.  No futuro, gostaria de descrever as configura√ß√µes do ambiente para analisar o tr√°fego do Netflow e os dumps de pcap do Zeek. <br><br><img src="https://habrastorage.org/webt/ze/cb/qx/zecbqxrubn4v0mutaoewxzsp1zm.png"><br><br>  Se voc√™ tiver um endere√ßo IP p√∫blico e um dispositivo mais ou menos inteligente como gateway / firewall, poder√° organizar um honeypot passivo configurando solicita√ß√µes de entrada para ‚Äúdeliciosas‚Äù portas TCP e UDP.  H√° um exemplo de configura√ß√£o de um roteador Mikrotik sob um gato, mas se voc√™ tiver um roteador de fornecedor diferente (ou algum outro sistema de seguran√ßa) em m√£os, precisar√° descobrir alguns formatos de dados e configura√ß√µes espec√≠ficas do fornecedor, e obter√° o mesmo resultado. <br><br><h3>  Isen√ß√£o de responsabilidade </h3><br>  O artigo n√£o pretende ser original, n√£o trata de quest√µes de toler√¢ncia a falhas de servi√ßos, seguran√ßa, pr√°ticas recomendadas etc.  √â necess√°rio considerar este material como acad√™mico, adequado para familiarizar-se com a funcionalidade b√°sica da pilha ELK e o mecanismo de an√°lise de log do dispositivo de rede.  No entanto, tamb√©m pode ser interessante para um iniciante. <br><br>  O projeto √© iniciado a partir do arquivo docker-compose, e √© muito f√°cil implantar seu ambiente semelhante, mesmo que voc√™ tenha um roteador de outro fornecedor dispon√≠vel, voc√™ s√≥ precisa entender um pouco sobre os formatos de dados e as configura√ß√µes espec√≠ficas do fornecedor.  De resto, tentei descrever o m√°ximo poss√≠vel todas as nuances associadas √† configura√ß√£o dos pipelines do Logstash e dos mapeamentos do Elasticsearch na vers√£o atual do ELK.  Todos os componentes deste sistema est√£o hospedados no <a href="https://github.com/mekhanme/elk-mikrot" rel="nofollow">github</a> , incluindo configura√ß√µes de servi√ßo.  No final do artigo, farei a se√ß√£o Solu√ß√£o de problemas, que descrever√° as etapas para diagnosticar os problemas populares rec√©m-chegados a esse neg√≥cio. <br><a name="habracut"></a><br><h3>  1. Introdu√ß√£o </h3><br>  No pr√≥prio servidor, instalei o sistema de virtualiza√ß√£o Proxmox, nele, na m√°quina KVM, os cont√™ineres Docker s√£o iniciados.  Sup√µe-se que voc√™ saiba como o docker e o docker-componham funcionam, pois h√° exemplos de configura√ß√£o suficientes sobre o uso da Internet.  N√£o falarei sobre os problemas de instala√ß√£o do Docker, vou escrever um pouco sobre o docker-compone. <br><br>  A id√©ia de lan√ßar o honeypot surgiu no processo de estudo do Elasticsearch, Logstash e Kibana.  Na minha carreira profissional, nunca estive envolvido na administra√ß√£o e no uso geral dessa pilha, mas tenho projetos de hobby, gra√ßas aos quais desenvolvi um grande interesse em explorar as possibilidades oferecidas pelo mecanismo de pesquisa Elasticsearch e Kibana, com o qual √© poss√≠vel analisar e visualizar dados. <br><br>  Meu n√£o √© o mais novo servidor mini NUC com 8 GB de RAM √© suficiente para iniciar a pilha ELK com um n√≥ Elastic.  Em ambientes de produ√ß√£o, isso, obviamente, n√£o √© recomendado, mas apenas adequado para treinamento.  Em rela√ß√£o √† quest√£o da seguran√ßa, h√° uma observa√ß√£o no final do artigo. <br><br>  A Internet est√° cheia de instru√ß√µes para instalar e configurar a pilha ELK para tarefas semelhantes (por exemplo, <a href="https://habr.com/ru/post/324760/">analisar ataques de for√ßa bruta no ssh usando o Logstash vers√£o 2</a> , <a href="https://habr.com/ru/post/431600/">analisando os logs do Suricata usando o Filebeat vers√£o 6</a> ), mas, na maioria dos casos, n√£o √© dada a devida aten√ß√£o aos detalhes. 90% do material ser√° das vers√µes 1 a 6 (no momento da reda√ß√£o deste documento, a vers√£o atual do ELK √© 7.5.0).  Isso √© importante porque, a partir da vers√£o 6, o Elasticsearch <a href="https://www.elastic.co/guide/en/elasticsearch/reference/6.7/removal-of-types.html" rel="nofollow">decidiu remover a</a> entidade do tipo de mapeamento, alterando a sintaxe da consulta e a estrutura de mapeamento.  O modelo de mapeamento no Elastic geralmente √© um objeto muito importante e, para que mais tarde n√£o haja problemas com a amostragem e visualiza√ß√£o de dados, aconselho que voc√™ n√£o se envolva em copiar e colar e tente entender o que est√° fazendo.  Al√©m disso, tentarei explicar claramente o significado das opera√ß√µes e configura√ß√µes descritas. <br><br><h2>  Configura√ß√£o do roteador </h2><br>  Para a rede dom√©stica, eu uso o Mikrotik como roteador, ent√£o um exemplo ser√° para ele.  Mas quase qualquer sistema pode ser configurado para enviar syslog para um servidor remoto, seja um roteador, um servidor ou algum outro sistema de seguran√ßa que possa registrar. <br><br><h3>  Enviando mensagens syslog para um servidor remoto </h3><br>  No Mikrotik, para configurar o registro em um servidor remoto atrav√©s da CLI, basta digitar alguns comandos: <br><br><pre><code class="plaintext hljs">/system logging action add remote=192.168.88.130 remote-port=5145 src-address=192.168.88.1 name=logstash target=remote /system logging add action=logstash topics=info</code> </pre> <br><h3>  Configurando regras de firewall com log </h3><br>  Estamos interessados ‚Äã‚Äãapenas em determinados dados (nome do host, endere√ßo IP, nome de usu√°rio, URL etc.), dos quais voc√™ pode obter uma bela visualiza√ß√£o ou sele√ß√£o.  No caso mais simples, para obter informa√ß√µes sobre varreduras de portas e tentativas de acesso, voc√™ precisa configurar o componente do firewall para registrar os acionadores de regras.  No Mikrotik, configurei as regras na tabela NAT, n√£o no Filter, j√° que no futuro vou colocar chanipots que emular√£o o trabalho dos servi√ßos, isso permitir√° que eu investigue mais informa√ß√µes sobre o comportamento das redes bot, mas esse √© um cen√°rio mais avan√ßado e n√£o sobre esse momento. <br><br>  Aten√ß√£o!  Na configura√ß√£o abaixo, a porta TCP padr√£o do servi√ßo SSH (22) √© colocada em loop na rede local.  Se voc√™ usar o SSH para acessar o roteador de fora e as configura√ß√µes tiverem a porta 22 ( <i>servi√ßo IP impresso</i> nos <i>servi√ßos</i> CLI e <i>ip&gt;</i> no Winbox), voc√™ deve atribuir novamente a porta ao SSH de gerenciamento ou n√£o inserir a √∫ltima regra na tabela. <br>  Al√©m disso, dependendo do nome da interface WAN (se a ponte WAN n√£o for usada), voc√™ precisar√° alterar o par√¢metro <i>in-interface</i> para o apropriado. <br><br><pre> <code class="plaintext hljs">/ip firewall nat add action=netmap chain=dstnat comment="HONEYPOT RDP" dst-port=3389 in-interface=bridge-wan log=yes log-prefix=honeypot_rdp protocol=tcp to-addresses=192.168.88.201 to-ports=3389 add action=netmap chain=dstnat comment="HONEYPOT ELASTIC" dst-port=9200 in-interface=bridge-wan log=yes log-prefix=honeypot_elastic protocol=tcp to-addresses=192.168.88.201 to-ports=9211 add action=netmap chain=dstnat comment=" HONEYPOT TELNET" dst-port=23 in-interface=bridge-wan log=yes log-prefix=honeypot_telnet protocol=tcp to-addresses=192.168.88.201 to-ports=2325 add action=netmap chain=dstnat comment="HONEYPOT DNS" dst-port=53 in-interface=bridge-wan log=yes log-prefix=honeypot_dns protocol=udp to-addresses=192.168.88.201 to-ports=9953 add action=netmap chain=dstnat comment="HONEYPOT FTP" dst-port=21 in-interface=bridge-wan log=yes log-prefix=honeypot_ftp protocol=tcp to-addresses=192.168.88.201 to-ports=9921 add action=netmap chain=dstnat comment="HONEYPOT SMTP" dst-port=25 in-interface=bridge-wan log=yes log-prefix=honeypot_smtp protocol=tcp to-addresses=192.168.88.201 to-ports=9925 add action=netmap chain=dstnat comment="HONEYPOT SMB" dst-port=445 in-interface=bridge-wan log=yes log-prefix=honeypot_smb protocol=tcp to-addresses=192.168.88.201 to-ports=9445 add action=netmap chain=dstnat comment="HONEYPOT MQTT" dst-port=1883 in-interface=bridge-wan log=yes log-prefix=honeypot_mqtt protocol=tcp to-addresses=192.168.88.201 to-ports=9883 add action=netmap chain=dstnat comment="HONEYPOT SIP" dst-port=5060 in-interface=bridge-wan log=yes log-prefix=honeypot_sip protocol=tcp to-addresses=192.168.88.201 to-ports=9060 add action=dst-nat chain=dstnat comment="HONEYPOT SSH" dst-port=22 in-interface=bridge-wan log=yes log-prefix=honeypot_ssh protocol=tcp to-addresses=192.168.88.201 to-ports=9922</code> </pre> <br><img src="https://habrastorage.org/webt/of/dm/jo/ofdmjo5n3f8fi54udyvbixhaifm.png"><br><br>  No Winbox, o mesmo est√° configurado na <i>guia IP&gt; Firewall&gt; NAT</i> . <br><br>  Agora, o roteador redirecionar√° os pacotes recebidos para o endere√ßo local 192.168.88.201 e a porta personalizada.  No momento, ningu√©m est√° ouvindo essas portas, portanto as conex√µes ser√£o interrompidas.  No futuro, na janela de encaixe, voc√™ poder√° executar o honeypot, dos quais existem muitos para cada servi√ßo.  Se isso n√£o for planejado, em vez das regras NAT, voc√™ deve escrever uma regra com a a√ß√£o de queda na cadeia Filtro. <br><br><h3>  Iniciando o ELK com docker-compose </h3><br>  Em seguida, voc√™ pode come√ßar a configurar o componente que processar√° os logs.  Eu aconselho voc√™ a praticar imediatamente e clonar o reposit√≥rio para ver os arquivos de configura√ß√£o completamente.  Todas as configura√ß√µes descritas podem ser vistas l√°. No texto do artigo, copiarei apenas parte das configura√ß√µes. <br><br><pre> <code class="plaintext hljs">‚ùØ‚ùØ git clone https://github.com/mekhanme/elk-mikrot.git</code> </pre> <br><img src="https://habrastorage.org/webt/95/_b/9g/95_b9gu4scfg99nwtyfph-0pf7o.png"><br><br>  Em um ambiente de teste ou desenvolvimento, √© mais conveniente executar cont√™ineres do docker usando o docker-compose.  Neste projeto, eu uso o arquivo docker-compose da <a href="https://docs.docker.com/compose/compose-file/" rel="nofollow">vers√£o</a> mais <a href="https://docs.docker.com/compose/compose-file/" rel="nofollow">recente 3.7</a> no momento, ele requer o mecanismo docker vers√£o 18.06.0+, portanto, vale a pena atualizar o <a href="https://docs.docker.com/install/linux/docker-ce/centos/" rel="nofollow">docker</a> , bem como o <a href="https://docs.docker.com/compose/install/" rel="nofollow">docker-compose</a> . <br><br><pre> <code class="plaintext hljs">‚ùØ‚ùØ curl -L "https://github.com/docker/compose/releases/download/1.25.0/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose ‚ùØ‚ùØ chmod +x /usr/local/bin/docker-compose</code> </pre> <br>  Como nas vers√µes recentes do docker-compose, o par√¢metro mem_limit foi <i>cortado</i> e a <i>implementa√ß√£o foi</i> adicionada, que √© executada apenas no modo enxame ( <i>implanta√ß√£o da pilha do docker</i> ), o lan√ßamento da configura√ß√£o do <i>docker-compose</i> com limites leva a um erro.  Como n√£o uso o enxame e quero ter limites de recursos, tenho que inici√°-lo com a op√ß√£o <i>--compatibility</i> , que converte os limites de novas vers√µes do docker-componha para o equivalente n√£o-sold√°vel. <br><br>  Execu√ß√£o de teste de todos os cont√™ineres (no segundo plano -d): <br><br><pre> <code class="plaintext hljs">‚ùØ‚ùØ docker-compose --compatibility up -d</code> </pre> <br>  Voc√™ ter√° que esperar at√© que todas as imagens sejam baixadas e, ap√≥s a conclus√£o da inicializa√ß√£o, voc√™ pode verificar o status dos cont√™ineres com o comando: <br><br><pre> <code class="plaintext hljs">‚ùØ‚ùØ docker-compose --compatibility ps</code> </pre> <br>  Devido ao fato de todos os cont√™ineres estarem na mesma rede (se voc√™ n√£o especificar explicitamente a rede, uma nova ponte ser√° criada, o que √© adequado nesse cen√°rio) e o docker-compose.yml cont√©m o par√¢metro container_name para todos os <i>cont√™ineres</i> , os cont√™ineres j√° ter√£o conectividade por meio do DNS interno janela de encaixe.  Como resultado, n√£o √© necess√°rio registrar endere√ßos IP nas configura√ß√µes de cont√™iner.  Na configura√ß√£o do Logstash, a sub-rede 192.168.88.0/24 √© registrada como local. Al√©m disso, na configura√ß√£o, haver√° explica√ß√µes mais detalhadas, segundo as quais voc√™ pode desviar o exemplo da configura√ß√£o antes de iniciar. <br><br><h2>  Configurar servi√ßos ELK </h2><br>  Al√©m disso, haver√° explica√ß√µes sobre como configurar a funcionalidade dos componentes ELK, al√©m de mais algumas a√ß√µes que precisar√£o ser executadas no Elasticsearch. <br><br>  Para determinar as coordenadas geogr√°ficas por endere√ßo IP, voc√™ precisar√° fazer o download do banco de dados <a href="https://dev.maxmind.com/geoip/geoip2/geolite2/" rel="nofollow">GeoLite2</a> gratuito do MaxMind: <br><br><pre> <code class="plaintext hljs">‚ùØ‚ùØ cd elk-mikrot &amp;&amp; mkdir logstash/geoip_db ‚ùØ‚ùØ curl -O https://geolite.maxmind.com/download/geoip/database/GeoLite2-City-CSV.zip &amp;&amp; unzip GeoLite2-City-CSV.zip -d logstash/geoip_db &amp;&amp; rm -f GeoLite2-City-CSV.zip ‚ùØ‚ùØ curl -O https://geolite.maxmind.com/download/geoip/database/GeoLite2-ASN-CSV.zip &amp;&amp; unzip GeoLite2-ASN-CSV.zip -d logstash/geoip_db &amp;&amp; rm -f GeoLite2-ASN-CSV.zip</code> </pre> <br><h3>  Configura√ß√£o do Logstash </h3><br>  O arquivo de configura√ß√£o principal √© <i>logstash.yml</i> , onde registrei a op√ß√£o de recarregar automaticamente a configura√ß√£o, o restante das configura√ß√µes do ambiente de teste n√£o s√£o significativas.  A configura√ß√£o do processamento de dados (logs) no Logstash √© descrita em arquivos <i>conf</i> separados, geralmente armazenados no diret√≥rio de <i>pipeline</i> .  No esquema, quando <a href="https://www.elastic.co/guide/en/logstash/current/multiple-pipelines.html" rel="nofollow">v√°rios pipelines</a> s√£o usados, o arquivo <a href="https://www.elastic.co/guide/en/logstash/current/multiple-pipelines.html" rel="nofollow">pipelines.yml</a> descreve os <i>pipelines</i> ativados.  Um pipeline √© uma cadeia de a√ß√µes em dados n√£o estruturados para receber dados com uma estrutura espec√≠fica na sa√≠da.  Um esquema com <i>pipelines.yml</i> configurado separadamente √© opcional, voc√™ pode fazer isso sem fazer o download de todas as configura√ß√µes do diret√≥rio de <i>pipeline</i> montado, no entanto, com um arquivo <i>pipelines.yml</i> espec√≠fico, a configura√ß√£o √© mais flex√≠vel, pois √© poss√≠vel ativar e desativar os arquivos <i>conf</i> do diret√≥rio de <i>pipeline</i> configura√ß√µes necess√°rias.  Al√©m disso, recarregar configura√ß√µes s√≥ funciona no esquema de v√°rios pipelines. <br><br><pre> <code class="plaintext hljs">‚ùØ‚ùØ cat logstash/config/pipelines.yml - pipeline.id: logstash-mikrot path.config: "pipeline/logstash-mikrot.conf"</code> </pre> <br>  Em seguida, vem a parte mais importante da configura√ß√£o do Logstash.  A descri√ß√£o do pipeline consiste em v√°rias se√ß√µes - no in√≠cio, os plugins s√£o indicados na se√ß√£o <i>Entrada</i> com a ajuda da qual o Logstash recebe dados.  A maneira mais f√°cil de coletar o syslog de um dispositivo de rede √© usar os plugins de entrada <a href="https://www.elastic.co/guide/en/logstash/current/plugins-inputs-tcp.html" rel="nofollow">tcp</a> / <a href="https://www.elastic.co/guide/en/logstash/current/plugins-inputs-udp.html" rel="nofollow">udp</a> .  O √∫nico par√¢metro necess√°rio para esses plug-ins √© <i>porta</i> , ele deve ser especificado da mesma forma que nas configura√ß√µes do roteador. <br><br>  A segunda se√ß√£o √© <i>Filtro</i> , que prescreve a√ß√µes adicionais com dados que ainda n√£o foram estruturados.  No meu exemplo, mensagens syslog desnecess√°rias de um roteador com determinado texto s√£o exclu√≠das.  Isso √© feito usando a condi√ß√£o e a a√ß√£o de descarte padr√£o, que descarta a mensagem inteira se a condi√ß√£o for atendida.  Na <a href="https://www.elastic.co/guide/en/logstash/7.5/event-dependent-configuration.html" rel="nofollow">condi√ß√£o</a> , o campo da <i>mensagem</i> √© verificado quanto √† presen√ßa de determinado texto. <br><br><img src="https://habrastorage.org/webt/iq/j0/ut/iqj0utufb6itcsrwspxi9qw4e2c.png"><br><br>  Se a mensagem n√£o cair, ela desce mais a corrente e entra no filtro do <a href="https://www.elastic.co/guide/en/logstash/7.5/plugins-filters-grok.html" rel="nofollow"><i>grok</i></a> .  Como a documenta√ß√£o diz, o <i>grok √© uma √≥tima maneira de analisar dados de log n√£o estruturados em algo estruturado e consult√°vel</i> .  Este filtro √© usado para processar logs de v√°rios sistemas (syslog linux, servidor web, banco de dados, dispositivos de rede, etc.).  Com base em <a href="https://github.com/logstash-plugins/logstash-patterns-core/tree/master/patterns" rel="nofollow">padr√µes prontos,</a> voc√™ pode, sem gastar muito tempo, criar um analisador para qualquer sequ√™ncia mais ou menos repetitiva.  √â conveniente usar um <a href="http://grokdebug.herokuapp.com/" rel="nofollow">analisador online</a> para valida√ß√£o (na vers√£o mais recente do Kibana, funcionalidade semelhante est√° na se√ß√£o <i>Ferramentas de Desenvolvimento</i> ). <br><br><img src="https://habrastorage.org/webt/_g/9q/ky/_g9qkyst3-na7a2i8mhxwf8avw0.gif"><br><br>  O volume <i>"./logstash/patterns:/usr/share/logstash/patterns" est√°</i> registrado no <i>docker-compose.yml</i> <i>,</i> no diret√≥rio <i>patterns</i> existe um arquivo com padr√µes da comunidade padr√£o (apenas por conveni√™ncia, veja se eu esqueci), bem como um arquivo com padr√µes de v√°rios tipos de mensagens Mikrotik (m√≥dulos <i>Firewall</i> e <i>Auth)</i> , por analogia, voc√™ pode adicionar seus pr√≥prios modelos para mensagens de uma estrutura diferente. <br><br>  As op√ß√µes padr√£o <i>add_field</i> e <i>remove_field</i> permitem adicionar ou remover campos da mensagem que est√° sendo processada dentro de qualquer filtro.  Nesse caso, o campo <i>host</i> √© exclu√≠do, que cont√©m o nome do host do qual a mensagem foi recebida.  No meu exemplo, h√° apenas um host, portanto n√£o h√° nenhum ponto nesse campo. <br><br>  Al√©m disso, na mesma se√ß√£o <i>Filtro</i> , registrei o filtro <a href="https://www.elastic.co/guide/en/logstash/7.5/plugins-filters-cidr.html" rel="nofollow"><i>cidr</i></a> , que verifica o campo com o endere√ßo IP quanto √† conformidade com a condi√ß√£o de entrada na sub-rede fornecida e coloca a tag.  Com base na tag na cadeia adicional, as a√ß√µes ser√£o executadas ou n√£o (se especificamente, isso √© para n√£o fazer uma pesquisa geogr√°fica para endere√ßos locais no futuro). <br><br>  Pode haver qualquer n√∫mero de se√ß√µes <i>Filtro</i> , para que haja menos condi√ß√µes em uma se√ß√£o. Na nova se√ß√£o, defini a√ß√µes para mensagens sem a tag <i>src_local</i> , ou seja, os eventos do firewall s√£o processados ‚Äã‚Äãaqui, nos quais estamos interessados ‚Äã‚Äãno endere√ßo de origem. <br><br>  Agora precisamos conversar um pouco mais sobre de onde o Logstash obt√©m as informa√ß√µes do GeoIP.  O Logstash suporta bancos de dados GeoLite2.  Existem v√°rias op√ß√µes de banco de dados, eu uso dois bancos de dados: GeoLite2 City (que cont√©m informa√ß√µes sobre o pa√≠s, cidade, fuso hor√°rio) e GeoLite2 ASN (informa√ß√µes sobre o sistema aut√¥nomo ao qual o endere√ßo IP pertence). <br><br><img src="https://habrastorage.org/webt/gf/ps/a1/gfpsa18cwgwa-7bcadoca7qyhtk.png"><br><br>  O plug-in <a href="https://www.elastic.co/guide/en/logstash/7.3/plugins-filters-geoip.html" rel="nofollow"><i>geoip</i></a> tamb√©m est√° envolvido na adi√ß√£o de informa√ß√µes de GeoIP √† mensagem.  A partir dos par√¢metros, voc√™ deve especificar o campo que cont√©m o endere√ßo IP, a base usada e o nome do novo campo no qual as informa√ß√µes ser√£o gravadas.  No meu exemplo, o mesmo √© feito para o endere√ßo IP de destino, mas at√© agora neste cen√°rio simples essas informa√ß√µes n√£o ser√£o interessantes, pois o endere√ßo de destino sempre ser√° o endere√ßo do roteador.  No entanto, no futuro, ser√° poss√≠vel adicionar logs a esse pipeline n√£o apenas do firewall, mas tamb√©m de outros sistemas em que ser√° relevante examinar os dois endere√ßos. <br><br>  O filtro <a href="https://www.elastic.co/guide/en/logstash/7.3/plugins-filters-mutate.html" rel="nofollow"><i>mutate</i></a> permite alterar os campos da mensagem e modificar o texto nos pr√≥prios campos; a documenta√ß√£o descreve em detalhes muitos exemplos do que voc√™ pode fazer.  Nesse caso, √© usado para adicionar uma tag, renomear campos (para visualiza√ß√£o adicional de logs no Kibana, √© necess√°rio um determinado formato do objeto de <a href="https://www.elastic.co/guide/en/elasticsearch/reference/7.3/geo-point.html" rel="nofollow"><i>ponto geogr√°fico</i></a> , tocarei nesse t√≥pico mais adiante) e excluir campos desnecess√°rios. <br><br><img src="https://habrastorage.org/webt/kn/9l/qf/kn9lqfj3uwaqh0fhh-tir-f7zr4.png"><br><br>  Isso encerra a se√ß√£o de processamento de dados e pode indicar apenas para onde enviar uma mensagem estruturada.  Nesse caso, o Elasticsearch coletar√° dados; voc√™ s√≥ precisar√° inserir o endere√ßo IP, a porta e o nome do √≠ndice.  √â recomend√°vel que voc√™ insira o √≠ndice com um campo de data vari√°vel, para que um novo √≠ndice seja criado todos os dias. <br><br><img src="https://habrastorage.org/webt/ve/sk/ec/veskecc3kqsidcymnbkafoa3spo.png"><br><br><h3>  Configurando o Elasticsearch </h3><br>  Voltar para Elasticsearch.  Primeiro, voc√™ precisa se certificar de que o servidor esteja em funcionamento.  O Elastic √© interagido com mais efici√™ncia por meio da API Rest na CLI.  Usando curl, voc√™ pode ver o estado do n√≥ (substitua localhost pelo endere√ßo IP do docker do host): <br><br><pre> <code class="plaintext hljs">‚ùØ‚ùØ curl localhost:9200</code> </pre> <br>  Depois, voc√™ pode tentar abrir o Kibana em <a href="http://localhost:5601/" rel="nofollow"></a>  <a href="http://localhost/" rel="nofollow"><i>localhost</i></a> : 5601.  N√£o h√° necessidade de configurar nada na interface da web do Kibana (a menos que mude o tema para escuro).  Estamos interessados ‚Äã‚Äãem ver se um √≠ndice foi criado.Para fazer isso, abra a se√ß√£o <i>Gerenciamento</i> e selecione <i>Elasticsearch Index Management</i> no canto superior esquerdo.  Aqui voc√™ pode ver quantos documentos est√£o indexados, quanto ocupa espa√ßo em disco, al√©m de informa√ß√µes √∫teis sobre mapeamento de √≠ndice. <br><br><img src="https://habrastorage.org/webt/kl/yp/vv/klypvvi1aa2zlueq98960wdut90.png"><br><br>  Nesse momento, voc√™ precisa registrar o modelo de mapeamento correto.  Essas informa√ß√µes s√£o necess√°rias para o Elastic para que ele entenda quais tipos de dados e quais campos pertencem.  Por exemplo, para fazer sele√ß√µes especiais baseadas em endere√ßos IP, para o campo <i>src_ip</i> , <i>voc√™</i> deve especificar explicitamente o tipo de dados <i>ip</i> e para determinar a localiza√ß√£o geogr√°fica, √© necess√°rio definir o campo <i>geoip.location</i> em um formato espec√≠fico e registrar o tipo <i>geo_point</i> .  Todos os campos poss√≠veis n√£o precisam ser descritos, pois para novos campos o tipo de dados √© determinado automaticamente com base em padr√µes din√¢micos ( <i>longo</i> para n√∫meros e <i>palavra</i> - <i>chave</i> para cadeias). <br><br>  Voc√™ pode escrever um novo modelo usando curl ou diretamente no console do Kibana (se√ß√£o <i>Dev Tools</i> ). <br><br><pre> <code class="plaintext hljs">‚ùØ‚ùØ curl -X POST -H "Content-Type: application/json" -d @elasticsearch/logstash_mikrot-template.json http://192.168.88.130:9200/_template/logstash-mikrot</code> </pre> <br>  Ap√≥s alterar o mapeamento, voc√™ precisa excluir o √≠ndice: <br><br><pre> <code class="plaintext hljs">‚ùØ‚ùØ curl -X DELETE http://192.168.88.130:9200/logstash-mikrot-2019.12.16</code> </pre> <br>  Quando pelo menos uma mensagem chegar no √≠ndice, verifique o mapeamento: <br><br><pre> <code class="plaintext hljs">‚ùØ‚ùØ curl http://192.168.88.130:9200/logstash-mikrot-2019.12.16/_mapping</code> </pre> <br>  Para uso adicional dos dados no Kibana, voc√™ precisa criar um <i>padr√£o</i> em <i>Gerenciamento&gt; Padr√£o de √çndice Kibana</i> .  Digite o <i>nome</i> do <i>√≠ndice</i> com o s√≠mbolo * ( <i>logstash-mikrot *)</i> para que todos os √≠ndices correspondam, selecione o campo de <i>registro de</i> data e hora como o campo com a data e a hora.  No campo <i>ID do padr√£o de √≠ndice customizado</i> , √© poss√≠vel inserir o ID do padr√£o (por exemplo, <i>logstash-mikrot</i> ); no futuro, isso pode simplificar o acesso ao objeto. <br><br><h2>  An√°lise e visualiza√ß√£o de dados em Kibana </h2><br>  Depois de criar o <i>padr√£o de √≠ndice</i> , voc√™ pode prosseguir para a parte mais interessante - an√°lise e visualiza√ß√£o de dados.  O Kibana tem muitas funcionalidades e se√ß√µes, mas at√© agora estaremos interessados ‚Äã‚Äãem apenas dois. <br><br><h3>  Descobrir </h3><br>  Aqui voc√™ pode visualizar documentos em √≠ndices, filtrar, pesquisar e visualizar as informa√ß√µes recebidas.  √â importante n√£o esquecer a linha do tempo, que define o per√≠odo nas condi√ß√µes de pesquisa. <br><br><img src="https://habrastorage.org/webt/vk/wn/ta/vkwntasygmykelzligkpf3flsxu.gif"><br><br><h3>  Visualize </h3><br>  Nesta se√ß√£o, voc√™ pode criar a visualiza√ß√£o com base nos dados coletados.  O mais simples √© exibir as fontes das redes de bots de varredura em um mapa geogr√°fico, pontilhado ou na forma de um mapa de calor.  Tamb√©m existem muitas maneiras de criar gr√°ficos, fazer sele√ß√µes etc. <br><br><img src="https://habrastorage.org/webt/f_/rx/p2/f_rxp2xbq4necn0dcsyw2mxkfuy.gif"><br><br>  No futuro, pretendo contar com mais detalhes sobre processamento de dados, possivelmente visualiza√ß√£o, talvez algo mais interessante.  No processo de estudo, tentarei complementar o tutorial. <br><br><h2>  Solu√ß√£o de problemas </h2><br>  Se o √≠ndice n√£o aparecer no Elasticsearch, verifique primeiro os logs do Logstash: <br><br><pre> <code class="plaintext hljs">‚ùØ‚ùØ docker logs logstash --tail 100 -f</code> </pre> <br>  O Logstash n√£o funcionar√° se n√£o houver conectividade com o Elasticsearch, ou se um erro na configura√ß√£o do pipeline for o principal motivo e isso se tornar claro ap√≥s um estudo cuidadoso dos logs que s√£o gravados no json docker por padr√£o. <br><br>  Se n√£o houver erros no log, voc√™ precisar√° garantir que o Logstash capture mensagens no soquete configurado.  Para fins de depura√ß√£o, voc√™ pode usar <i>stdout</i> como <i>sa√≠da</i> : <br><br><pre> <code class="plaintext hljs">stdout { codec =&gt; rubydebug }</code> </pre> <br>  Depois disso, o Logstash gravar√° informa√ß√µes de debag quando a mensagem for recebida diretamente no log. <br><br>  A verifica√ß√£o do Elasticsearch √© muito simples - basta fazer uma solicita√ß√£o GET se curvar no endere√ßo IP e na porta do servidor ou em um terminal de API espec√≠fico.  Por exemplo, observe o status dos √≠ndices em uma tabela leg√≠vel por humanos: <br><br><pre> <code class="plaintext hljs">‚ùØ‚ùØ curl -s 'http://192.168.88.130:9200/_cat/indices?v'</code> </pre> <br><img src="https://habrastorage.org/webt/of/ke/v_/ofkev_rfp6uo9x5rf4tcey0egbm.gif"><br><br>  O Kibana tamb√©m n√£o ser√° iniciado se n√£o houver conex√£o com o Elasticsearch; √© f√°cil ver isso pelos logs. <br><br>  Se a interface da web n√£o abrir, verifique se o firewall est√° configurado ou desativado corretamente no Linux (no Centos houve problemas com o <i>iptables</i> e o <i>docker</i> , eles foram resolvidos com base nas recomenda√ß√µes do <a href="https://stackoverflow.com/questions/31667160/running-docker-container-iptables-no-chain-target-match-by-that-name" rel="nofollow">t√≥pico</a> ).  Tamb√©m vale a pena considerar que, em equipamentos pouco produtivos, todos os componentes podem carregar por v√°rios minutos.  Com falta de mem√≥ria, os servi√ßos podem n√£o carregar.  Exibir o uso de recursos do cont√™iner: <br><br><pre> <code class="plaintext hljs">‚ùØ‚ùØ docker stats</code> </pre> <br>  Se de repente algu√©m n√£o souber como alterar corretamente a configura√ß√£o de cont√™ineres no <i>arquivo docker-compose.yml</i> e reiniciar os cont√™ineres, isso ser√° feito editando o <i>docker-compose.yml</i> e usando o mesmo comando com os mesmos par√¢metros, reinicie: <br><br><pre> <code class="plaintext hljs">‚ùØ‚ùØ docker-compose --compatibility up -d</code> </pre> <br>  Ao mesmo tempo, nas se√ß√µes alteradas, objetos antigos (cont√™ineres, redes, volumes) s√£o apagados e novos s√£o recriados de acordo com a configura√ß√£o.  Os dados dos servi√ßos n√£o s√£o perdidos ao mesmo tempo, uma vez que <i>s√£o usados ‚Äã‚Äãvolumes nomeados</i> , que n√£o s√£o exclu√≠dos com o cont√™iner e as configura√ß√µes s√£o montadas no sistema host, o Logstash pode at√© monitorar os arquivos de configura√ß√£o e reiniciar a configura√ß√£o do pipeline quando o arquivo √© alterado. <br><br>  Voc√™ pode reiniciar o servi√ßo separadamente com o <i>comando docker restart</i> (n√£o √© necess√°rio estar no diret√≥rio com <i>docker-compose.yml)</i> : <br><br><pre> <code class="plaintext hljs">‚ùØ‚ùØ docker restart logstash</code> </pre> <br>  Voc√™ pode ver a configura√ß√£o do objeto <i>docker</i> com o <i>comando docker inspecionar</i> ; √© mais conveniente us√°-lo com <i><a href="https://stedolan.github.io/jq/tutorial/" rel="nofollow">jq</a></i> . <br><br><img src="https://habrastorage.org/webt/vw/l0/-v/vwl0-vgzu8snbp16vgzet9lsa64.gif"><br><br><h2>  Conclus√£o </h2><br>  Quero observar que a seguran√ßa neste projeto n√£o foi relatada porque √© um ambiente de teste (dev) e n√£o est√° planejada para ser lan√ßada fora do roteador.  Se voc√™ implant√°-lo para uso mais s√©rio, precisar√° seguir as pr√°ticas recomendadas, instalar certificados para HTTPS, fazer backups, monitoramento normal (que n√£o inicia pr√≥ximo ao sistema principal).  A prop√≥sito, o Traefik √© executado na minha janela de encaixe no meu servidor, que √© um proxy reverso para alguns servi√ßos, e tamb√©m encerra o TLS em si mesmo e faz autentica√ß√£o.  Ou seja, gra√ßas ao DNS configurado e ao proxy reverso, √© poss√≠vel acessar a interface da web do Kibana da Internet com HTTPS n√£o configurado e uma senha (como eu o entendo, na vers√£o da comunidade, o Kibana n√£o suporta prote√ß√£o de senha para a interface da web).  Pretendo descrever melhor minha experi√™ncia na configura√ß√£o do Traefik para uso em uma rede dom√©stica com o Docker. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt481596/">https://habr.com/ru/post/pt481596/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt481584/index.html">Ao gerenciar uma equipe, quebre todas as regras</a></li>
<li><a href="../pt481586/index.html">Tend√™ncias de tecnologia de com√©rcio eletr√¥nico 2020: Era das tecnologias imersivas</a></li>
<li><a href="../pt481588/index.html">Exerc√≠cios para isolar Runet come√ßaram. Vamos monitorar?</a></li>
<li><a href="../pt481592/index.html">Seis op√ß√µes de presente de Ano Novo para um motorista com um bom desconto</a></li>
<li><a href="../pt481594/index.html">Desenvolvimento de um "gerador de tens√£o simples" de acordo com GOST R IEC 61508 (IEC 61508)</a></li>
<li><a href="../pt481598/index.html">Uma pequena contribui√ß√£o para a luta contra as plataformas do zool√≥gico Avalonia UI</a></li>
<li><a href="../pt481600/index.html">Bonsai Family Wiki Engine: resultados de 2019</a></li>
<li><a href="../pt481604/index.html">Qu√£o severos desenvolvedores de Chelyabinsk criam jogos para o Google Play e as redes sociais</a></li>
<li><a href="../pt481606/index.html">Assinatura est√°tica usando o modelo Observer usando C ++ e o microcontrolador Cortex M4</a></li>
<li><a href="../pt481610/index.html">Antipadr√µes do PostgreSQL: atualizando uma tabela grande sob carga</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>