<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üõåüèΩ üë©üèª‚Äç‚öñÔ∏è üí± Selbst gemachte drahtlose Fenstersensoren: STM32L051 + RFM69 + Android üöµ üóΩ üé≤</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Guten Tag, liebe Chabrowiter! Vor einigen Jahren habe ich eine bunte zWave-Anzeige gekauft und Fenstersensoren installiert, die auf diesem Protokoll b...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Selbst gemachte drahtlose Fenstersensoren: STM32L051 + RFM69 + Android</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/482858/"> Guten Tag, liebe Chabrowiter!  Vor einigen Jahren habe ich eine bunte zWave-Anzeige gekauft und Fenstersensoren installiert, die auf diesem Protokoll basieren.  Ein USB-zWave-Stick wurde an den Heimserver angeschlossen, der die Rolle eines Controllers spielte, ein kleines Java-Modul wurde geschrieben, das Daten von diesem Controller empfing, und eine kleine Anwendung f√ºr Android wurde geschrieben, die den Status aller Sensoren auf wunderbare Weise anzeigt.  Batterien eingelegt, Sensoren am Controller angemeldet, alles funktioniert.  Aber nach ein paar Monaten gab es eine schreckliche Entt√§uschung.  Erstens funktionieren diese zWave-Sensoren nach dem Prinzip "Senden Sie eine Nachricht und schlafen Sie ein, ohne auf die Best√§tigung zu warten".  In meinem Fall f√ºhrte dies dazu, dass das Signal der am weitesten vom Controller entfernten Sensoren einfach nicht zum Controller gelangte.  Auch die Installation eines zus√§tzlichen zWave-Repeaters hat nicht geholfen.  Zum anderen wurde der Akku so schnell entladen, dass nach etwa sechs Monaten alle Sensoren nicht mehr funktionierten.  Der Grund ist, dass sie jede Stunde aufwachten, um den Controller √ºber ihren Zustand zu informieren.  Deaktivieren oder √Ñndern dieser Option funktionierte nicht, da Standardsoftware dies kategorisch nicht zulie√ü.  Nach zwei Jahren der Qual mit dieser rohen, unzuverl√§ssigen und unfreundlichen Technologie entschied ich, dass ich genug hatte.  Aber anstatt alles wegzulegen und wegzuwerfen, kam mir die Idee, die Koffer zu verlassen, aber die Elektronik darin zu √§ndern.  Die Wahl fiel auf einen relativ einfachen RFM69-Transceiver (433 MHz), auf dessen Grundlage sowohl eine Platine f√ºr den Sensor als auch eine √ºber USB mit dem Server verbundene Steuerung hergestellt werden konnten.  Das neue System ist bereits seit 5 Monaten in Betrieb, die Zuverl√§ssigkeit liegt nahe bei 100% (es gab jedoch noch einige Ausf√§lle), die Batterien scheinen noch nicht leer zu sein.  Das hei√üt, es ist bereits sichtbar, dass alle M√§ngel des alten Systems, das auf zWave basiert, beseitigt wurden, und ich m√∂chte die technischen Details dieses Artikels teilen, siehe das Bild. <br><br><img src="https://habrastorage.org/webt/n-/gz/rd/n-gzrd4pxnz2h38utebhqhtakjg.png"><br><br>  Wen k√ºmmert es, bitte, unter der Katze. <br><a name="habracut"></a><br>  Es scheint mir, dass sich zWave in meinem Fall aus zwei Gr√ºnden als nicht funktionsf√§hig herausgestellt hat: Das Haus hat zwei Etagen mit Stahlbetonb√∂den und eine gro√üe Fl√§che (das hei√üt, eine erhebliche Entfernung einiger Sensoren von der Steuerung).  Nun, Fehler in der propriet√§ren Software, die es nicht erm√∂glichten, das periodische Aufwecken der Sensoren zu deaktivieren, was zu einer schnellen Batterieentladung f√ºhrte.  Als sich herausstellte, dass ich nicht mit zWave unterwegs war, suchte ich nach anderen Optionen, die in dasselbe Sensorgeh√§use gesteckt werden konnten. <br><br>  Mein erster Prototyp von Sensoren basierte auf dem ESP8266.  Der Controller - auf der Grundlage meiner Zahlung, √ºber die ich bereits <a href="https://habr.com/en/post/413101">auf Habr√© geschrieben habe</a> .  Das System hat sogar als Prototyp funktioniert, aber ich musste es aus zwei Gr√ºnden aufgeben.  Der erste Grund ist der gleiche: Im Haus gab es Ecken mit einem sehr niedrigen WLAN-Signalpegel, was beim Aufwachen zu einer sehr langen Aktivierungszeit des ESP8266 und damit zu einer starken Batterieentladung f√ºhrte.  Obwohl ich zugebe, dass ich gerade nicht wei√ü, wie man diesen ESP8266 kocht (Artikel <a href="https://habr.com/ru/post/480316">wie dieser</a> best√§tigen diese These).  Aber der zweite Grund war ernster.  Da ich mich entschlossen habe, nicht nur das Geh√§use, sondern auch das Batteriefach zu belassen, war ich auf eine CR123A-Batterie beschr√§nkt, die 3,0 Volt betr√§gt.  Das hei√üt, der Preis und die Komplexit√§t des Sensors nahmen aufgrund des zunehmenden DC / DC-Wandlers zu.  Obwohl <a href="https://habr.com/ru/post/304936">es</a> zu diesem Thema <a href="https://habr.com/ru/post/304936">einen wunderbaren Artikel</a> √ºber Habr√© gibt.  Aber diese beiden Gr√ºnde √ºberwogen und ich lehnte ESP8266 ab. <br><br>  Der zweite Prototyp wurde verkabelt.  Ich habe einen Prototyp sowohl des Sensors als auch des USB-Controllers erstellt und ein Servermodul hinzugef√ºgt, damit er diesen Controller zus√§tzlich zum zWave-Stick versteht.  Es gab die Idee, die Dr√§hte und den Sensor nach und nach zu ziehen, um die zWave-Platine in eine verkabelte zu verwandeln.  Aber am Ende hat er keine W√§nde ausgesucht und diesen Prototyp auch weggeworfen. <br><br>  Dann entschied er sich f√ºr die Funkmodule mit 433 und 868 MHz und bestellte mehrere Module f√ºr Experimente: <a href="https://www.sparkfun.com/products/13910" rel="nofollow">RFM69HCW</a> , <a href="https://www.mouser.de/datasheet/2/21/A110LR09A_ProductBrief-1511797.pdf" rel="nofollow">A110LR09A</a> und <a href="https://www.mouser.de/datasheet/2/268/70651A-60467.pdf" rel="nofollow">MRF89XAM8A</a> .  In Bezug auf Modulgr√∂√üe, Preis und auch aufgrund der Verf√ºgbarkeit von Bibliotheken und <a href="https://learn.sparkfun.com/tutorials/rfm69hcw-hookup-guide" rel="nofollow">guten Beispielen habe ich mich</a> f√ºr RFM69HCW entschieden, das die Basis des Systems bildete. <br><br>  Das System besteht nur aus vier Komponenten: <br><br><ul><li>  drahtlose Sensoren (433 MHz, CR123A 3.0V Batterie), </li><li>  Netzwerkcontroller (433 MHz, Stromversorgung √ºber USB vom Server) </li><li>  den Server (√ºber den ich <a href="https://habr.com/en/post/268197">in diesem Artikel</a> bereits √ºber Habr√© geschrieben <a href="https://habr.com/en/post/268197">habe</a> ) und das Server-Programm-Modul </li><li>  Mobiler Client (Android-Anwendung) </li></ul><br>  Im Folgenden werde ich jedes Modul detailliert beschreiben und am Ende Statistiken √ºber den Betrieb des Systems in den letzten Betriebsmonaten geben. <br><br><h3>  Sensoren </h3><br>  Die Sensoren verwenden das <a href="https://www.sparkfun.com/products/13910" rel="nofollow">Funkmodul RFM69HCW</a> .  Es hat einen weiten Betriebsspannungsbereich (1,8 V - 2,4 V, 17 dBm, 2,4 V - 3,6 V, 20 dBm) und wird √ºber SPI gesteuert.  Das hei√üt, Sie ben√∂tigen einen Mikrocontroller.  Vor einiger Zeit habe ich die STM32L-Serie kennengelernt und den STM32L051 f√ºr Experimente bestellt.  Es bestach mich als kleinen Strom im Schlafmodus (0,27 ŒºA) und die Betriebsspannung, fast identisch mit der Spannung des Funkmoduls (1,65 V - 3,6 V).  Plus niedriger Preis. <br><br>  Es stellte sich folgendes Schema heraus: <br><br><img src="https://habrastorage.org/webt/0b/xx/kb/0bxxkbtvavy113lz23izewdi4yk.png" alt="Bild"><br><br>  Die Versorgungsspannung des Mikrocontrollers und des Funkmoduls ist so bemessen, dass sie direkt vom CR123A-Element gespeist werden k√∂nnen.  STM32L051 verf√ºgt √ºber eine interne Spannungsreferenz, die an ADC-Kanal 17 angeschlossen ist, sowie den Kalibrierungswert dieser Quelle, mit dem Sie den aktuellen Wert der Versorgungsspannung VDD messen k√∂nnen.  Das Funkmodul wird √ºber das Q1-Feldger√§t mit Strom versorgt, sodass Sie die Stromversorgung √ºber den Mikrocontroller steuern k√∂nnen. <br><br>  Der Schlafmodus wird durch Versetzen des Mikrocontrollers in "Standby" implementiert.  In diesem Modus verf√ºgt der STM32L051 √ºber einen deaktivierten Kern, fast alle Peripherieger√§te und einen internen Spannungsregler, der einen Verbrauch von 0,29 ŒºA (bei deaktivierter Echtzeituhr) gew√§hrleistet.  In diesem Modus gibt es jedoch eine Besonderheit: Der Mikrocontroller wird nur mit der ansteigenden Flanke des Signals am WKUP-Pin (A0) aktiviert.  Da ein Magnetschalter verwendet wird, der ein- und ausgeschaltet ist (geschlossen oder ge√∂ffnet), ben√∂tigen Sie einen kleinen Block, der sowohl beim Schlie√üen als auch beim √ñffnen eines Magnetkontakts einen Impuls von kurzer Dauer erzeugt.  Dieser Impuls wird dem Eingang A0 des Mikrocontrollers zugef√ºhrt und weckt diesen.  Ein solcher Wandler ist auf dem Exklusiv-ODER-Chip IC3 der energieeffizienten 74AUP-Serie (74AUP1G86) implementiert, der im Spannungsbereich von 0,8 V - 3,6 V arbeitet und 0,2 ŒºA verbraucht.  Daher sollte der Gesamtverbrauch im Schlafmodus bei etwa 0,5 ŒºA liegen, was durch Messungen an einem vollst√§ndig montierten Sensor best√§tigt wird. <br><br>  Wenn der Mikrocontroller aufwacht, misst er zuerst die Versorgungsspannung und wenn sie weniger als 1,8 Volt betr√§gt, ist es kein Schicksal - der Sender kann nicht gestartet werden und der Mikrocontroller schl√§ft zur√ºck. <br><br>  Ist die Batteriespannung gr√∂√üer als 1,8 Volt, schaltet der Mikrocontroller ein und initialisiert das Funkmodul, √ºbertr√§gt den Status an den Netzwerkcontroller und wartet auf Best√§tigung.  Das Datenpaket enth√§lt eine eindeutige 32-Bit-Paket- (Ereignis-) Nummer, Batteriespannung, Temperatur, Magnetkontaktstatus und Steuerbyte (CRC7).  Bei erfolgreicher Best√§tigung schl√§ft der Mikrocontroller wieder ein.  Wenn nicht, wird der Status erneut gesendet, jedoch maximal 10 Mal.  Ich habe diese Grenze so festgelegt, dass der Sensor in einer Situation, in der der Netzwerkcontroller einfach ausgeschaltet ist, nicht auf unbestimmte Zeit auf eine Antwort wartet.  Die zuletzt √ºbertragene eindeutige Ereignisnummer wird im internen EEPROM des Mikrocontrollers gespeichert. <br><br>  W√§hrend der Daten√ºbertragung blinkt auf dem Mikrocontroller eine LED (wo ohne).  Das Einschalten der LED erfolgt √ºber PWM, wobei das Tastverh√§ltnis vom aktuellen Spannungswert abh√§ngt. Dadurch k√∂nnen Sie in nahezu allen Betriebsspannungsbereichen nahezu die gleiche Helligkeit erzielen. <br><br>  Die Boards sind in EagleCAD gestaltet, das Board-Design finden Sie <a href="https://github.com/mkulesh/stm32WindowSensor/tree/master/pcb" rel="nofollow">hier</a> .  Die Platinen sind doppelseitig: Der Mikrocontroller und sein Kabelbaum befinden sich auf der dem Fensterrahmen zugewandten Oberseite und das Funkmodul und die LED auf der dem Raum zugewandten Unterseite.  Ich habe in China bestellt, mich in einem herk√∂mmlichen K√ºchenofen (oberste Schicht) und einem Haartrockner (unterste Schicht) verl√∂tet. <br><br><img src="https://habrastorage.org/webt/rj/io/9l/rjio9lhfs3psrwyw8_xefn1lcmi.jpeg" alt="Bild"><br><br>  Das Funkmodul ben√∂tigt eine Antenne.  Dies ist nur ein 164 mm langes St√ºck Draht. <br><br>  Nach der Installation muss jeder Sensor programmiert werden, f√ºr den ein SWD-Anschluss bereitgestellt wird.  Die verbleibenden Kontakte habe ich f√ºr m√∂gliche zuk√ºnftige Experimente an der Tafel gelassen. <br>  Die Firmware ist in C ++ geschrieben, ein Teil des Codes wird in ziemlich universellen Basisklassen ausgef√ºhrt, die Aufrufe an die ST HAL-Bibliothek kapseln.  Der Quellcode <a href="https://github.com/mkulesh/stm32WindowSensor/tree/master/src" rel="nofollow">ist hier</a> .  F√ºr die Entwicklung wurde die System Workbench f√ºr STM32 verwendet.  Die Gr√∂√üe der endg√ºltigen bin√§ren Firmwaredatei betr√§gt 22 kB. <br><br>  Und hier ist der Sensor im Fall: <br><br><img src="https://habrastorage.org/webt/91/fx/ap/91fxapzu7uwnpr0wp2cjydbpwaa.jpeg" alt="Bild"><br><br>  Abh√§ngig von der Position des Sensors habe ich bei einigen Sensoren die Antenne drau√üen gelassen (vor dem Hintergrund des wei√üen Rahmens ist sie jedoch nicht sichtbar), und bei einigen Sensoren habe ich den Draht in den Rahmen gebogen und ihn vollst√§ndig in das Geh√§use gepfercht. <br><br>  Aus Gr√ºnden des Interesses habe ich die Kosten der Komponenten f√ºr einen Sensor berechnet (zu den Preisen des Mouser-Katalogs, Preis und Gesamtpreis in Euro) <br><table cellspacing="0" border="0"><tbody><tr><td align="left">  <b><font>Artikel</font></b> </td><td align="left">  <b><font>Beschreibung</font></b> </td><td align="left">  <b><font>Wert</font></b> </td><td align="left">  <b><font>MOUSER-Nummer</font></b> </td><td align="left">  <b><font>Menge</font></b> </td><td align="left">  <b><font>Kosten</font></b> </td></tr><tr><td align="left">  <font>IC3</font> </td><td align="left">  <font>Exklusives ODER</font> </td><td align="left">  <font>1G86</font> </td><td align="left">  <font>771-74AUP1G86GW-G</font> </td><td align="left">  <font>1</font> </td><td align="left">  <font>0,254</font> </td></tr><tr><td align="left">  <font>IC1</font> </td><td align="left">  <font>Mikrocontroller</font> </td><td align="left">  <font>STM32L051</font> </td><td align="left">  <font>511-STM32L051K6T6</font> </td><td align="left">  <font>1</font> </td><td align="left">  <font>2.14</font> </td></tr><tr><td align="left">  <font>SV1</font> </td><td align="left">  <font>Stecker</font> </td><td align="left">  <font>Swd</font> </td><td align="left">  <font>68602-406HLF</font> </td><td align="left">  <font>1</font> </td><td align="left">  <font>0,157</font> </td></tr><tr><td align="left">  <font>LED1</font> </td><td align="left">  <font>LED 3 mm</font> </td><td align="left">  <font>3mm</font> </td><td align="left">  <font>630-HLMP-K155</font> </td><td align="left">  <font>1</font> </td><td align="left">  <font>0,351</font> </td></tr><tr><td align="left">  <font>Q1</font> </td><td align="left">  <font>P-Mosfet</font> </td><td align="left">  <font>BSH205</font> </td><td align="left">  <font>771-BSH205G2R</font> </td><td align="left">  <font>1</font> </td><td align="left">  <font>0,276</font> </td></tr><tr><td align="left">  <font>S1</font> </td><td align="left">  <font>Magnetischer Kontakt</font> </td><td align="left">  <font>ORD211-0810</font> </td><td align="left">  <font>876-ORD211-0810</font> </td><td align="left">  <font>1</font> </td><td align="left">  <font>0,625</font> </td></tr><tr><td align="left">  <font>IC2</font> </td><td align="left">  <font>RFM69HCW Funkmodul</font> </td><td align="left">  <font>RFM69HCW</font> </td><td align="left">  <font>474-COM-13910</font> </td><td align="left">  <font>1</font> </td><td align="left">  <font>5,36</font> </td></tr><tr><td align="left">  <font>C1, C2, C3, C6</font> </td><td align="left">  <font>SMD-Kondensator</font> </td><td align="left">  <font>0,1 uF</font> </td><td align="left">  <font>80-C0805C104J5RAC</font> </td><td align="left">  <font>4</font> </td><td align="left">  <font>0,1</font> </td></tr><tr><td align="left">  <font>C5</font> </td><td align="left">  <font>SMD-Kondensator</font> </td><td align="left">  <font>0,4 nF</font> </td><td align="left">  <font>C0805C471K8HACTU</font> </td><td align="left">  <font>1</font> </td><td align="left">  <font>0,021</font> </td></tr><tr><td align="left">  <font>C4</font> </td><td align="left">  <font>SMD-Kondensator (Tantal)</font> </td><td align="left">  <font>47uF</font> </td><td align="left">  <font>581-TAJR225K016RNJ</font> </td><td align="left">  <font>1</font> </td><td align="left">  <font>0,334</font> </td></tr><tr><td align="left">  <font>R1</font> </td><td align="left">  <font>SMD-Widerstand</font> </td><td align="left">  <font>10K</font> </td><td align="left">  <font>660-RK73H2ATTDD1002F</font> </td><td align="left">  <font>1</font> </td><td align="left">  <font>0,01</font> </td></tr><tr><td align="left">  <font>R10</font> </td><td align="left">  <font>SMD-Widerstand</font> </td><td align="left">  <font>330</font> </td><td align="left">  <font>660-RK73H2ATTDD3300F</font> </td><td align="left">  <font>1</font> </td><td align="left">  <font>0,01</font> </td></tr><tr><td align="left">  <font>R3, R4, R6, R7, R8, R11</font> </td><td align="left">  <font>SMD-Widerstand</font> </td><td align="left">  <font>47K</font> </td><td align="left">  <font>660-RK73H2ATTDD4702F</font> </td><td align="left">  <font>6</font> </td><td align="left">  <font>0,06</font> </td></tr><tr><td align="left">  <font>R5</font> </td><td align="left">  <font>SMD-Widerstand</font> </td><td align="left">  <font>56</font> </td><td align="left">  <font>660-RK73H2ATTD56R0F</font> </td><td align="left">  <font>1</font> </td><td align="left">  <font>0,013</font> </td></tr><tr><td align="left">  <font>R9</font> </td><td align="left">  <font>SMD-Widerstand</font> </td><td align="left">  <font>56M</font> </td><td align="left">  <font>603-RC0805JR-0756ML</font> </td><td align="left">  <font>1</font> </td><td align="left">  <font>0,037</font> </td></tr><tr><td align="left"></td><td align="left"></td><td align="left"></td><td align="left"></td><td align="left"></td><td align="left">  <b><font>9.748</font></b> </td></tr></tbody></table><br>  √úbrigens ist es genau dreimal billiger als der urspr√ºngliche zWave-Sensor.  Dies ist zwar nur die Kosten f√ºr Teile ohne den Fall.  Aber meiner Meinung nach sind zWave-Sensoren im Einzelhandel zu teuer. <br><br><h3>  Netzwerkcontroller </h3><br>  F√ºr den Controller wurden das gleiche Funkmodul und der gleiche Mikrocontroller wie f√ºr die Sensoren verwendet.  Dadurch konnte der gr√∂√üte Teil des Firmware-Codes wiederverwendet werden.  F√ºr den Controller habe ich diesen Formfaktor des Boards gew√§hlt, um das fertige Geh√§use von Raspberry Pi zu verwenden.  Im Vergleich zum Sensor wurden ein externer Antennenanschluss und eine USB-Schleife basierend auf dem FT232RL und dem SI-8621-Isolator hinzugef√ºgt.  Stattdessen k√∂nnte man nat√ºrlich STM32 mit USB an Bord nehmen.  Aber dann m√ºsste man erstens den Firmware-Code trennen und zweitens die Software-Implementierung von USB selbst durchf√ºhren.  Die Option mit einem externen FT232RL ist zwar teurer, aber zuverl√§ssiger und schneller zu implementieren.  Das Ergebnis ist das <a href="https://github.com/mkulesh/stm32WindowSensor/tree/master/pcb" rel="nofollow">folgende Schema</a> : <br><br><img src="https://habrastorage.org/webt/wh/ij/_k/whij_k04j8jqetojnlz0hblpnom.png" alt="Bild"><br><br>  Und in zusammengesetzter Form stellte sich Folgendes heraus: <br><br><img src="https://habrastorage.org/webt/f2/-4/io/f2-4iog6apig6hfmq-6zhhxmzno.jpeg" alt="Bild"><br><br><img src="https://habrastorage.org/webt/dp/gg/cu/dpggcuqsrdegbwobtujrbf1rlck.jpeg" alt="Bild"><br><br>  Der Mikrocontroller geht hier nicht in den Ruhezustand, das Funkmodul arbeitet f√ºr den Empfang, aber nachdem ein Paket von einem der Sensoren erfolgreich empfangen wurde, wechselt das Modul in den Sendemodus und sendet eine Best√§tigung.  Dar√ºber hinaus wird jedes erfolgreich empfangene Paket √ºber USB an den Server √ºbertragen.  Das Paketformat ist eine Folge von Werten, die durch das Symbol ‚Äû;‚Äú getrennt sind: <br>  GW; 3; 12; -57; 0; 146; 30; 18 <br>  wo: <br><br><ul><li>  erste Stelle ist der Paketaufkleber (immer "GW") </li><li>  zweite Position - Datentyp (Sensorstatus oder Fehlercode) </li><li>  dritte Position - Sensornummer </li><li>  vierte Position - Signalqualit√§t auf der Seite des Netzwerkcontrollers (RFM69HCW erh√§lt die Signalqualit√§t w√§hrend des Empfangs und erm√∂glicht es Ihnen, sie abzufragen, wenn der Empfang beendet ist) </li><li>  f√ºnfte Position - Fensterzustand (0 offen, 1 geschlossen) </li><li>  sechste Position - eine eindeutige Nummer des Pakets (Ereignisses) vom Sensor.  Mit dieser Nummer k√∂nnen Sie serverseitig steuern, ob alle Ereignisse vom Server empfangen wurden oder ein oder mehrere Ereignisse verloren gingen. </li><li>  siebte Position - aktuelle Batteriespannung (30 entspricht 3,0 V) </li><li>  Die letzte, achte Position ist die Temperatur vom internen Sensor des Mikrocontrollers.  Ich habe noch nicht herausgefunden, wie man es benutzt </li></ul><br>  Der Quellcode f√ºr die Firmware befindet sich <a href="https://github.com/mkulesh/stm32WindowSensor/tree/master/src" rel="nofollow">an derselben Stelle wie f√ºr den Sensor</a> .  Sie haben eine gemeinsame Hauptdatei und eine gemeinsame Bibliothek von Basisklassen.  Die Firmware-Option (Sensor oder Controller) wird mithilfe der Direktive define in der Datei main.cpp ausgew√§hlt. <br><br>  Die Kosten f√ºr den Netzwerkcontroller sind aufgrund der USB-Schaltung, der Antenne und zus√§tzlicher Anschl√ºsse h√∂her.  Dieser Zusatz kann aber vernachl√§ssigt werden, da es nur einen Regler gibt.  Aber auch mit dieser Erg√§nzung stellte sich heraus, dass es dreimal billiger ist als der zWave-Stick, der zuvor an seiner Stelle stand. <br><br><h3>  Servermodul </h3><br>  Der Netzwerkcontroller ist mit einem Server verbunden, auf dem CentOS 7 ausgef√ºhrt wird. Auf dem Server wird ein in Java geschriebenes Programm ausgef√ºhrt.  Und in seiner Struktur, in seiner Implementierung und in seinen Aufgaben ist das Programm recht einfach: <br><br><ul><li>  Mit einer sehr alten und anscheinend nicht mehr unterst√ºtzten <a href="http://rxtx.qbang.org/wiki/index.php/Main_Page" rel="nofollow">RxTx-</a> Bibliothek wird der in der Konfiguration angegebene USB-Port √ºberwacht (in meinem Fall / dev / ttyUSB0).  Derzeit ist dies der am schlechtesten optimierte Teil des Gesamtsystems, da die Bibliothek den Serverprozessor stark belastet. </li><li>  Wenn Daten vom USB-Anschluss empfangen werden, werden sie in einer Protokolldatei aufgezeichnet und in der Sensorstatusklasse gespeichert.  Wenn Sie den Server neu starten, geht der Status verloren.  Um es wiederherzustellen, m√ºssen Sie um das Haus herumgehen und alle Fenster manuell √∂ffnen und schlie√üen.  Dies ist wahrscheinlich der gr√∂√üte Nachteil meines Systems, aber ich habe mich ganz bewusst geweigert, regelm√§√üig Sensoren abzufragen, um die Batterien zu schonen. </li><li>  Die Anwendung ist auch ein kleiner TCP / IP-Server und √ºberwacht den in der Konfiguration angegebenen TCP / IP-Port.  An diesem Port k√∂nnen Verbindungen von einem mobilen Client akzeptiert werden. </li><li>  Wenn der mobile Client eine Verbindung zum Server herstellt, sendet er den aktuellen Status aller Sensoren.  Mit Hilfe von periodischen Heartbit-Nachrichten √ºberwacht der Server auch die Aktivit√§t der Verbindung. </li><li>  Der Server und der mobile Client tauschen Nachrichten im XML-Format aus.  Diese Nachrichten werden in Form einer kleinen <a href="https://github.com/mkulesh/stm32WindowSensor/tree/master/zNetMonitor/common" rel="nofollow">Java-Bibliothek</a> implementiert, die sowohl auf der Serverseite als auch auf der Seite der mobilen Android-Anwendung gemeinsam genutzt wird. </li><li>  Obwohl dies aus Gr√ºnden des Interesses nicht sehr sinnvoll ist, habe ich die Funktion der Autorisierung eines mobilen Clients √ºber IMEI sowie die AES-Verschl√ºsselung von Nachrichten zwischen dem Server und dem Client mithilfe eines im Quellcode eingen√§hten Schl√ºssels (Java-Paket javax.crypto) hinzugef√ºgt.  Dies ist jedoch rein experimentell, da der TCP / IP-Port dieses Servermoduls nur vom internen Netzwerk aus zug√§nglich und von au√üen nicht sichtbar ist.  Obwohl, wenn ich diesen Hafen f√ºr die gro√üe Welt √∂ffnen m√∂chte, wird es jetzt nicht mehr so ‚Äã‚Äãbe√§ngstigend sein, es zu tun. </li></ul><br>  Wen k√ºmmert es, der Quellcode des Servermoduls ist <a href="https://github.com/mkulesh/stm32WindowSensor/tree/master/zNetMonitor/server" rel="nofollow">hier</a> . <br><br><h3>  Mobiler Client (Android-Anwendung) </h3><br>  Sie werden hier nicht viel schreiben, obwohl diese Anwendung das Endergebnis des gesamten Projekts ist.  Dies ist eine standardm√§√üige und sehr einfache Java-Anwendung mit drei Registerkarten: dem Zustand der Fenster im ersten Stock, dem Zustand im zweiten Stock und einer kleinen Telemetrie des Servers (siehe den <a href="https://github.com/mkulesh/stm32WindowSensor/tree/master/zNetMonitor/app" rel="nofollow">Quellcode hier</a> ): <br><br><img src="https://habrastorage.org/webt/j5/hz/hd/j5hzhduedoxedwhuuhrpe0e4s8e.png" alt="Bild"><br><br>  Die Grafiken basieren auf einer Reihe von SVG-Dateien, die je nach Zustand der Sensoren √ºbereinander gestapelt sind.  Ein langes Dr√ºcken wird im Bereich jedes Fensters unterst√ºtzt. Danach wird ein Hinweis mit der Uhrzeit angezeigt, zu der dieses Fenster ge√∂ffnet war: <br><br><img src="https://habrastorage.org/webt/4e/_z/42/4e_z42j_o2j11j7tl9lzzefeffi.png" alt="Bild"><br><br>  Grunds√§tzlich hindert Sie nichts daran, diesem Tooltipp ein Batteriesymbol hinzuzuf√ºgen, aber Ihre H√§nde haben es noch nicht erreicht. <br><br><h3>  Betriebserfahrung </h3><br>  "Jedes Niesen" wird in einer Protokolldatei auf der Serverseite aufgezeichnet.  Die Analyse dieser Dateien in den letzten 5 Monaten erm√∂glicht es uns, die Funktionsweise dieses Systems etwas detaillierter zu verstehen. <br><br>  Die Analyse ist sehr einfach - sehen Sie sich einfach den Ordner mit den Protokolldateien auf dem Server an. <br><br>  Wie viele Fehler gab es bei der Daten√ºbertragung auf dem Funkkanal?  Innerhalb von 5 Monaten wurden 8 Fehler aufgezeichnet, wenn die Nachricht in der falschen Gr√∂√üe und 25 Fehler in der falschen CRC empfangen wurden.  In beiden F√§llen k√∂nnen Sie nicht direkt sagen, welcher Sensor Probleme hatte, da das Datenpaket in diesem Fall vollst√§ndig besch√§digt ist.  Da der Netzwerkcontroller in all diesen F√§llen den Datenempfang nicht best√§tigt, sollte der Sensor die Daten auf eine neue Weise senden, wodurch diese Fehler in den meisten F√§llen behoben werden. <br><br>  Und hier ist eine √úbersichtstabelle √ºber den Betrieb von Sensoren f√ºr 5 Monate. <br><table cellspacing="0" border="0"><tbody><tr><td align="center">  <b><font>Boden</font></b> </td><td align="center">  <b><font>Sensor</font></b> </td><td align="center">  <b><font>Menge</font></b> <b><font><br></font></b>  <b><font>Von Ereignissen</font></b> </td><td align="center">  <b><font>Von den Verlorenen</font></b> <b><font><br></font></b>  <b><font>Von Ereignissen</font></b> </td><td align="center">  <b><font>Spannung</font></b> <b><font><br></font></b>  <b><font>Batterien</font></b> </td><td align="center">  <b><font>Median</font></b> <b><font><br></font></b>  <b><font>Macht</font></b> <b><font><br></font></b>  <b><font>Signal</font></b> </td></tr><tr><td align="center">  <font>1</font> </td><td align="center">  <font>10</font> </td><td align="center">  <font>105</font> </td><td align="center">  <font>0</font> </td><td align="center">  <font color="#800000">3.1</font> </td><td align="center">  <font>-66</font> </td></tr><tr><td align="center">  <font>1</font> </td><td align="center">  <font>11</font> </td><td align="center">  <font>52</font> </td><td align="center">  <font>0</font> </td><td align="center">  <font>3.3</font> </td><td align="center">  <font>-70</font> </td></tr><tr><td align="center">  <font>1</font> </td><td align="center">  <font>12</font> </td><td align="center">  <font>122</font> </td><td align="center">  <font>0</font> </td><td align="center">  <font>3.3</font> </td><td align="center">  <font>-61</font> </td></tr><tr><td align="center">  <font>1</font> </td><td align="center">  <font>13</font> </td><td align="center">  <font>89</font> </td><td align="center">  <font>0</font> </td><td align="center">  <font>3.3</font> </td><td align="center">  <font>-74</font> </td></tr><tr><td align="center">  <font>1</font> </td><td align="center">  <font>14</font> </td><td align="center">  <font>2573</font> </td><td align="center">  <font>0</font> </td><td align="center">  <font>3.3</font> </td><td align="center">  <font>-68</font> </td></tr><tr><td align="center">  <font>1</font> </td><td align="center">  <font>15</font> </td><td align="center">  <font>261</font> </td><td align="center">  <font>0</font> </td><td align="center">  <font>3.3</font> </td><td align="center">  <font>-60</font> </td></tr><tr><td align="center">  <font>1</font> </td><td align="center">  <font>16</font> </td><td align="center">  <font>543</font> </td><td align="center">  <font color="#800000">2</font> </td><td align="center">  <font>3.3</font> </td><td align="center">  <font>-70</font> </td></tr><tr><td align="center">  <font>1</font> </td><td align="center">  <font>17</font> </td><td align="center">  <font>156</font> </td><td align="center">  <font color="#800000">2</font> </td><td align="center">  <font>3.3</font> </td><td align="center">  <font>-74</font> </td></tr><tr><td align="center">  <font>1</font> </td><td align="center">  <font>18</font> </td><td align="center">  <font>177</font> </td><td align="center">  <font color="#800000">2</font> </td><td align="center">  <font>3.2</font> </td><td align="center">  <font>-68</font> </td></tr><tr><td align="center">  <font>1</font> </td><td align="center">  <font>19</font> </td><td align="center">  <font>384</font> </td><td align="center">  <font color="#800000">3</font> </td><td align="center">  <font>3.3</font> </td><td align="center">  <font>-56</font> </td></tr><tr><td align="center">  <font>2</font> </td><td align="center">  <font>3</font> </td><td align="center">  <font>368</font> </td><td align="center">  <font color="#800000">2</font> </td><td align="center">  <font>3.3</font> </td><td align="center">  <font>-62</font> </td></tr><tr><td align="center">  <font>2</font> </td><td align="center">  <font>4</font> </td><td align="center">  <font>86</font> </td><td align="center">  <font>0</font> </td><td align="center">  <font>3.3</font> </td><td align="center">  <font>-71</font> </td></tr><tr><td align="center">  <font>2</font> </td><td align="center">  <font>5</font> </td><td align="center">  <font>521</font> </td><td align="center">  <font color="#800000">2</font> </td><td align="center">  <font>3.3</font> </td><td align="center">  <font>-59</font> </td></tr><tr><td align="center">  <font>2</font> </td><td align="center">  <font>6</font> </td><td align="center">  <font>115</font> </td><td align="center">  <font>0</font> </td><td align="center">  <font>3.3</font> </td><td align="center">  <font>-62</font> </td></tr><tr><td align="center">  <font>2</font> </td><td align="center">  <font>7</font> </td><td align="center">  <font>316</font> </td><td align="center">  <font color="#800000">2</font> </td><td align="center">  <font>3.3</font> </td><td align="center">  <font>-63</font> </td></tr><tr><td align="center">  <font>2</font> </td><td align="center">  <font>8</font> </td><td align="center">  <font>419</font> </td><td align="center">  <font color="#800000">1</font> </td><td align="center">  <font>3.3</font> </td><td align="center">  <font>-60</font> </td></tr><tr><td align="center">  <font>2</font> </td><td align="center">  <font>9</font> </td><td align="center">  <font>89</font> </td><td align="center">  <font>0</font> </td><td align="center">  <font>3.3</font> </td><td align="center">  <font>-68</font> </td></tr></tbody></table><br>  Sensor Nr. 10 friert einmal ein.  Dies f√ºhrte anscheinend zu einer signifikanten Abnahme der Batteriespannung.  Der Grund f√ºr das Einfrieren ist noch nicht klar.  Es h√§ngt wieder, du musst es herausfinden. <br><br>  Der Sensor Nr. 14 ist an der Vordert√ºr installiert, weshalb er so viele Reaktionen hat.  Eine derart gro√üe Anzahl von Fahrten hat die Batteriespannung jedoch noch nicht beeinflusst. <br><br>  Ein verlorenes Ereignis liegt vor, wenn der Sensor versucht hat, einen Status zu senden, der Server dies jedoch nicht best√§tigt hat.  Alle verlorenen Ereignisse sind darauf zur√ºckzuf√ºhren, dass ich den Server f√ºr etwa einen halben Tag zum Reinigen ausgeschaltet habe. <br><br>  In der Spalte Median Signal Strength Median wird der Median-RSSI-Wert (in dBm) angezeigt, bei dem jeder einzelne Wert nach dem Empfang jedes Pakets ermittelt wird.  Der Sensor mit dem besten Signal (Nr. 19, -56 dBm) befindet sich in einer Entfernung von 2 Metern in direkter Sichtweite zum Netzwerkcontroller. Die Antenne in diesem Sensor ist jedoch mit einem Rahmen im Inneren des Geh√§uses gefaltet.  Der Netzwerkcontroller selbst befindet sich im Erdgeschoss.  Das Signal von den Sensoren im zweiten Stock ist jedoch sehr gut.  Dies ist darauf zur√ºckzuf√ºhren, dass bei allen Sensoren der zweiten Etage die Antenne aus dem Sensorgeh√§use entfernt ist. <br><br><h3>  Anstelle eines Nachwortes </h3><br>  Einerseits bin ich froh, dass ich als Hobby von Grund auf ein System dieses Niveaus entwerfen, zusammenbauen und betreiben konnte.  Und umso mehr freut es mich, dass es besser funktioniert als das "propriet√§re" System, das auf der zWave-Hype-Technologie basiert.  Es gibt auch Raum f√ºr die Entwicklung und Verbesserung dieses Systems.  Ich nage nur einen kleinen Zweifel.  Das hei√üt, dass ein Mensch ohne spezielle elektrische Ausbildung etwas auf seinem Knie sammelt, das zuverl√§ssiger funktioniert als Markenprodukte, die in engen Kreisen von IOT-Marken bekannt sind.  Wahrscheinlich hat sich der Fortschritt in die falsche Richtung gedreht. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de482858/">https://habr.com/ru/post/de482858/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de482848/index.html">Live Bot, Teil 2</a></li>
<li><a href="../de482850/index.html">Perspektiven f√ºr Biokraftstoffe in der Luftfahrt</a></li>
<li><a href="../de482852/index.html">Die √Ñra des kompakten Audios: Wie B√§nder in Autos kamen</a></li>
<li><a href="../de482854/index.html">√úber Sch√§tzung</a></li>
<li><a href="../de482856/index.html">G√∂ttlicher Fremder</a></li>
<li><a href="../de482860/index.html">Ich war Leiter der internationalen Beziehungen bei Google. Deshalb bin ich gegangen</a></li>
<li><a href="../de482862/index.html">Gibt es ein GameDev in Sachalin? 1.V</a></li>
<li><a href="../de482864/index.html">Heimvideo√ºberwachung. Schema zur Pflege eines Videoarchivs ohne Home Registrar</a></li>
<li><a href="../de482866/index.html">Lohnt sich der Kauf von Bitcoin im n√§chsten Jahr und wie viel wird es kosten?</a></li>
<li><a href="../de482870/index.html">Wie ich bei eBay einen gesperrten Laptop gekauft und versucht habe, meinen AntiTheft auf IntelAMT-Basis zu machen</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>