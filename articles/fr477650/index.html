<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>‚ò¶Ô∏è üò® üë©üèø‚Äçü§ù‚Äçüë®üèæ Cryptage du trafic TLS selon les algorithmes GOST-2012 avec Stunnel üöÅ üéÖ ü§∞üèø</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Dans cet article, je veux montrer comment configurer Stunnel pour utiliser des algorithmes cryptographiques russes dans le protocole TLS. En prime, je...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Cryptage du trafic TLS selon les algorithmes GOST-2012 avec Stunnel</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/aktiv-company/blog/477650/"><img src="https://habrastorage.org/webt/zc/ye/bj/zcyebjoqvyhnnaiux68xagkfkz8.png"><br><p>  Dans cet article, je veux montrer comment configurer Stunnel pour utiliser des algorithmes cryptographiques russes dans le protocole TLS.  En prime, je montrerai comment chiffrer un canal TLS en utilisant des algorithmes GOST impl√©ment√©s dans le c≈ìur de chiffrement Rutoken EDS 2.0. </p><br><p>  Mais d'abord, d√©couvrons √† quoi sert Stunnel.  En un mot - c'est un programme sur lequel vous pouvez d√©placer toute la logique du chiffrement du trafic entre le serveur et le client.  Cela se fait comme suit: supposons que vous ayez un client et un serveur qui communiquent entre eux sans utiliser de chiffrement, d'authentification et de v√©rification d'int√©grit√©.  Vous pouvez r√©√©crire le client et le serveur afin que tous les messages sortants et entrants soient transmis entre eux, en tenant compte de tous ces points, mais pourquoi de telles difficult√©s, si vous pouvez simplement le d√©placer sur les √©paules d'une autre application?  Pour r√©soudre ce probl√®me, Stunnel est parfait. </p><a name="habracut"></a><br><p>  Vous avez juste besoin de configurer le client pour que tout son trafic soit transmis au client Stunnel, √† son tour, il √©tablit une connexion s√©curis√©e au serveur, envoyant des donn√©es au serveur Stunnel.  Stunnel sur le serveur d√©chiffre le trafic entrant et redirige les donn√©es vers l'entr√©e du serveur.  Ce qui pr√©c√®de est plus facile √† r√©aliser en regardant ce diagramme. </p><br><p><img src="https://habrastorage.org/webt/vb/vk/9u/vbvk9u4vm7rf6jxcfr3gsqrboea.png"></p><br><p>  Il convient de noter que le serveur n'a pas besoin d'√™tre exactement Stunnel pour fonctionner avec des algorithmes cryptographiques.  C'est formidable qu'il existe des stands de d√©monstration pr√™ts √† l'emploi qui prennent en charge la cryptographie russe, dont la liste est dans la <a href="https://www.xn--h1adndcbfmd.xn--p1ai/resource/archive/rc2019/files/01_Smyshlyaev.pdf">pr√©sentation avec RusCrypto'2019</a> . </p><br><p>  Nous avons besoin de serveurs stables qui fournissent une authentification bidirectionnelle. <br>  Nous avons s√©lectionn√© les serveurs CryptoPro comme les plus fiables avec la mise en ≈ìuvre compl√®te de la norme GOST TLS.  Merci √† eux pour √ßa :) </p><br><p>  Cela semble assez simple, essayons d'organiser ce processus. </p><br><h2 id="podgotovitelnyy-shag">  √âtape pr√©paratoire </h2><br><p>  Nous aurons besoin de: </p><br><ol><li>  Openssl </li><li>  Stunnel </li><li>  rtengine </li><li>  Acc√®s aux serveurs de test CryptoPro pour v√©rifier la connexion TLS </li></ol><br><p>  OpenSSL pour Windows peut √™tre r√©cup√©r√© √† <a href="https://slproweb.com/products/Win32OpenSSL.html">partir d'ici</a> et pour les utilisateurs de Linux - √† partir de r√©f√©rentiels ou collect√© en t√©l√©chargeant la derni√®re version √† <a href="https://www.openssl.org/source/">partir d'ici</a> .  Elle peut √©galement √™tre extraite du <a href="https://www.rutoken.ru/developers/sdk/">SDK Rutoken</a> , du <a href="https://www.rutoken.ru/developers/sdk/">r√©pertoire</a> <strong>openssl \ openssl-tool-1.1</strong> , cette archive nous sera utile davantage, car  il contient la gamme qui nous int√©resse.  Stunnel peut √™tre trouv√© <a href="https://www.stunnel.org/downloads.html">ici</a> .  La version&gt; = 5.56 est requise pour le fonctionnement. </p><br><p>  Vous pouvez t√©l√©charger rtengine √† partir du <a href="https://www.rutoken.ru/developers/sdk/">SDK Rutoken</a> , il se trouve dans le <strong>r√©pertoire openssl \ rtengine \ bin</strong> .  Vous devez le d√©poser l√† o√π tous les moteurs openssl sont stock√©s.  Vous pouvez trouver le chemin vers eux en utilisant </p><br><pre><code class="bash hljs">openssl.exe version -a</code> </pre> <br><p>  Mais il ne suffit pas de d√©placer le moteur vers le dossier souhait√©; vous devez toujours configurer openssl lui-m√™me pour fonctionner avec.  Nous d√©couvrons o√π se trouve le fichier de configuration <strong>openssl.cnf</strong> avec la m√™me commande que ci-dessus (sous le stunnel Windows est livr√© avec sa propre version de openssl, donc le fichier de configuration se trouve dans le <strong>chemin \ to \ stunnel \ config \ openssl.cnf</strong> </p><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#   : openssl_conf = openssl_def ... #   : # OpenSSL default section [openssl_def] engines = engine_section [engine_section] rtengine = rtengine_section [rtengine_section] engine_id = rtengine dynamic_path = /path/to/rtengine.so MODULE_PATH = /usr/lib/librtpkcs11ecp.so default_algorithms = CIPHERS, DIGEST, PKEY, RAND</span></span></code> </pre><br><p>  V√©rifions que rtengine est connect√©, pour cela nous connectons un token et listons tous les algorithmes de cryptage: </p><br><pre> <code class="bash hljs">openssl ciphers -v</code> </pre> <br><p>  Permettez-moi de vous rappeler que dans Windows, vous devez v√©rifier pour openssl, qui se trouve √† c√¥t√© de stunnel <br>  Si parmi eux nos GOST seront pr√©sents, alors tout est correctement configur√©. </p><br><p>  Le moment est venu pour le plus int√©ressant: v√©rifier la connexion avec les serveurs de test GOST CryptoPro.  Une liste de ces serveurs est d√©crite ici ( <a href="https://www.cryptopro.ru/products/csp/tc26tls">https://www.cryptopro.ru/products/csp/tc26tls</a> ).  Chacun de ces serveurs fonctionne avec ses propres algorithmes d'authentification et de chiffrement.  De plus, sur les ports 443, 1443, 2443, ... des services sont lanc√©s qui n'acceptent que certains param√®tres.  Ainsi, par exemple, sur <a href="http://tlsgost-256auth.cryptopro.ru/">http://tlsgost-256auth.cryptopro.ru</a> , le cryptage est effectu√© avec authentification √† l'aide des algorithmes GOST2012-GOST8912-GOST8912 et d'une cl√© de 256 bits.  De plus, le port 443 utilise XchA-ParamSet, le port 1443 utilise XchB-ParamSet, le port 2443 utilise A-ParamSet, etc. </p><br><p>  Maintenant que nous savons de quelle cl√© nous avons besoin, r√©cup√©rons le certificat racine du serveur de test, √©tablissons les cl√©s de travail et signons la demande de notre certificat. </p><br><h3 id="prostoy-sposob-rabotaet-pod-windows-i-linux">  Mani√®re simple (fonctionne sous Windows et Linux) </h3><br><ol><li>  Pour obtenir le certificat racine, nous allons nous rendre sur le <a href="http://testgost2012.cryptopro.ru/certsrv/">site du test CA LLC "CRIPTO-PRO"</a> .  Et cliquez sur le bouton pour obtenir un certificat.  Un nouvel onglet appara√Ætra, sur lequel vous devrez s√©lectionner la m√©thode de cryptage Base64 et cliquer sur le bouton <strong>"T√©l√©charger le certificat CA"</strong> .  Le fichier <strong>certnew.cer</strong> r√©sultant <strong>est</strong> enregistr√©. </li><li>  Suivez le <a href="https://ra.rutoken.ru/devices">lien</a> .  Installez tous les plugins qui nous sont demand√©s.  Nous cliquons sur le bouton <strong>"Cr√©er une cl√©"</strong> , et s√©lectionnons l'algorithme "GOST R 34.10-2012 256 bits" pour la g√©n√©ration.  Ensuite, cr√©ez une demande de certificat, dans la colonne <strong>"Application"</strong> vous pouvez tout s√©lectionner.  Dans la colonne Application suppl√©mentaire: Authentification client et utilisateur du centre d'inscription CryptoPro. </li><li>  Nous ouvrons √† nouveau le site de l'AC de test, mais cette fois nous cliquons sur le bouton <strong>"Envoyer la demande pr√™te PKCS # 10 ou PKCS # 7 encod√©e en Base64"</strong> .  Nous collons le contenu de notre demande dans le champ, cliquons sur le bouton ¬´Issue¬ª et chargeons le certificat <em>user.crt</em> au format Base64.  Le fichier r√©sultant est enregistr√©. </li></ol><br><h3 id="cherez-komandnuyu-stroku">  Via la ligne de commande </h3><br><ol><li><p>  Pour obtenir le certificat racine, nous allons nous rendre sur le <a href="http://testgost2012.cryptopro.ru/certsrv/">site du test CA LLC "CRIPTO-PRO"</a> .  Et cliquez sur le bouton pour obtenir un certificat.  Un nouvel onglet appara√Ætra, dans lequel vous devrez s√©lectionner la m√©thode de cryptage Base64 et cliquer sur le bouton <strong>"T√©l√©charger le certificat CA"</strong> .  Le fichier <strong>certnew.cer</strong> r√©sultant <strong>est</strong> enregistr√©. </p><br></li><li><p>  G√©n√©rez maintenant les cl√©s. </p><br><pre> <code class="bash hljs">pkcs11-tool --module /usr/lib/librtpkcs11ecp.so --keypairgen --key-type GOSTR3410-2012-256:B -l --id 45 <span class="hljs-comment"><span class="hljs-comment"># 45 --   ASII id  (E)</span></span></code> </pre> <br><p>  Il convient de noter que les cl√©s g√©n√©r√©es sur le jeton ne peuvent pas √™tre copi√©es √† partir du jeton.  C'est l'un des principaux avantages de leur utilisation. </p><br></li><li><p>  Cr√©ez une demande de certificat: </p><br><pre> <code class="bash hljs">openssl req -engine rtengine -new -key=<span class="hljs-string"><span class="hljs-string">"pkcs11:id=E"</span></span> -keyform engine -out client.req</code> </pre> <br></li><li><p>  Nous ouvrons √† nouveau le site de l'AC de test, mais cette fois nous cliquons sur le bouton <strong>"Envoyer la demande pr√™te PKCS # 10 ou PKCS # 7 encod√©e en Base64"</strong> .  Nous collons le contenu de notre demande dans le champ, cliquez sur le bouton √âmettre et t√©l√©chargeons le certificat <em>user.crt</em> au format Base64.  Le fichier r√©sultant est enregistr√©. </p><br></li></ol><br><p>  Il y avait la derni√®re question: pourquoi tout √ßa ???  Pourquoi avons-nous obtenu tous ces certificats, cl√©s et demandes? </p><br><p>  Le fait est qu'ils sont n√©cessaires au protocole TLS pour l'authentification bidirectionnelle.  Cela fonctionne tr√®s simplement. </p><br><p>  Nous avons un certificat de serveur et nous le consid√©rons comme fiable. </p><br><p>  Notre client v√©rifie que le serveur avec lequel nous travaillons poss√®de un certificat similaire. <br>  Le serveur veut s'assurer qu'il fonctionne avec l'utilisateur qu'il conna√Æt.  Pour cela, nous avons cr√©√© une demande de certificat pour travailler √† travers nos cl√©s. </p><br><p>  Nous avons envoy√© cette demande et le serveur l'a sign√©e avec sa signature num√©rique.  Nous pouvons maintenant pr√©senter ce certificat √† chaque fois, sign√© par l'autorit√© de certification racine, confirmant ainsi que nous sommes nous. </p><br><h2 id="konfigurirovanie-stunnel">  Configuration de Stunnel </h2><br><p>  Il ne reste plus qu'√† configurer correctement notre tunnel.  Pour ce faire, cr√©ez un fichier <strong>stunnel.conf</strong> avec les param√®tres Stunnel par d√©faut et √©crivez ce qui suit: </p><br><pre> <code class="bash hljs">;      - debug = 7 output = /path/to/stunnel.log ;    TLSv1 sslVersion=TLSv1 ;  . engine=rtengine ;     [remote system] client=yes ;  engine,     engineId=rtengine ;   2 (  ) verify = 2 ;     CAFile = /path/to/certnew.cer ;     cert=/path/to/user.crt ;     . key=pkcs11:model=Rutoken%20ECP;manufacturer=Aktiv%20Co.;id=E ;   Stunnel      accept = localhost:8080 connect = tlsgost-256auth.cryptopro.ru:2443</code> </pre><br><p>  Maintenant, si tout est fait correctement, vous pouvez d√©marrer Stunnel avec notre configuration et vous connecter au serveur: </p><br><pre> <code class="bash hljs">stunnel.exe /path/to/stunnel.conf</code> </pre> <br><p>  Ouvrez le navigateur et acc√©dez √† localhost: 8080.  Si tout est correct, les informations suivantes s'affichent: </p><br><img src="https://habrastorage.org/webt/x3/lx/ti/x3lxtimldg9tcdnyojmwfhgcpu4.png"><br><p>  Sinon, nous examinons les journaux et utilisons le d√©bogueur pour comprendre quel est le probl√®me. </p><br><p>  Si vous avez des questions, n'h√©sitez pas √† commenter :) </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr477650/">https://habr.com/ru/post/fr477650/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr477638/index.html">Achet√©! = Le v√¥tre: John Deere prive les agriculteurs du droit de r√©parer leurs propres tracteurs</a></li>
<li><a href="../fr477642/index.html">La vision (radio) de la machine voit √† travers les murs</a></li>
<li><a href="../fr477644/index.html">Restauration d'UNIX v0 sur PDP-7: D√©tails de l'arri√®re-boutique</a></li>
<li><a href="../fr477646/index.html">Les math√©maticiens coupent des formes √† la recherche de parties d'√©quations</a></li>
<li><a href="../fr477648/index.html">MVCC dans PostgreSQL-3. Versions en ligne</a></li>
<li><a href="../fr477654/index.html">Essayer l'op√©rateur instanceof am√©lior√© dans Java 14</a></li>
<li><a href="../fr477656/index.html">Alors, pourquoi avez-vous besoin de faire?</a></li>
<li><a href="../fr477658/index.html">Active Restore: la reprise apr√®s sinistre peut-elle √™tre plus rapide? Beaucoup plus vite?</a></li>
<li><a href="../fr477662/index.html">Acc√®s aux pneus Redd sur les ponts FTDI</a></li>
<li><a href="../fr477668/index.html">29 novembre, 18 h - devleads-mitap</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>