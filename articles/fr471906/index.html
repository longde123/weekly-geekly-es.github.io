<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ğŸ· ğŸ‘¦ğŸ¿ ğŸ›„ Les dangers des optimisations incorrectes ğŸ’— ğŸ˜ ğŸ‘¦</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Quand il s'agit d'optimiser le systÃ¨me pour des performances maximales, il peut Ãªtre trÃ¨s facile de faire des erreurs si vous appliquez imprudemment l...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Les dangers des optimisations incorrectes</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/471906/"> Quand il s'agit d'optimiser le systÃ¨me pour des performances maximales, il peut Ãªtre trÃ¨s facile de faire des erreurs si vous appliquez imprudemment les pratiques des autres.  L'une de ces pratiques consiste Ã  spÃ©cifier nobarrier lors du montage de systÃ¨mes de fichiers. <br><br><a name="habracut"></a><h2>  Comment est nÃ©e cette note </h2><br>  Je travaille en tant qu'ingÃ©nieur chez Mail.Ru Cloud Solutions et traite principalement toutes sortes de problÃ¨mes Â«autour et autourÂ» du stockage en bloc sur lequel se trouvent les machines virtuelles de nos utilisateurs - et, en consÃ©quence, des cas intÃ©ressants se posent souvent liÃ©s aux performances et Ã  la stabilitÃ© des machines virtuelles fonctionnant dans applications - et en particulier les bases de donnÃ©es. <br><br>  En rÃ¨gle gÃ©nÃ©rale, dans presque la moitiÃ© des cas pendant le Â«dÃ©briefingÂ», nous voyons la mÃªme chose - un systÃ¨me de fichiers montÃ© avec l'option nobarrier.  Et quand nous demandons - "pourquoi avez-vous Ã©crit cette option", alors nous obtenons presque toujours l'une des options de rÃ©ponse "on m'a dit que c'Ã©tait plus rapide / j'ai lu que c'Ã©tait plus rapide / j'ai Ã©tÃ© configurÃ© comme Ã§a" - aprÃ¨s quoi nous essayons poliment et soigneusement d'expliquer cela Donc pas besoin.  Pourquoi?  Parce que c'est la premiÃ¨re Ã©tape confiante sur la voie de la perte de donnÃ©es. <br><br><h2>  Petite excursion </h2><br>  SystÃ¨me de fichiers - la structure est trÃ¨s complexe et trÃ¨s chargÃ©e.  Pour garantir des performances maximales, la mise en cache et l'enregistrement parallÃ¨le sont activement utilisÃ©s dans le processus.  En consÃ©quence, une partie des donnÃ©es va dans le cache et est supprimÃ©e chaque fois que cela est possible / nÃ©cessaire ou Â«Ã  la demandeÂ».  Une barriÃ¨re est une opÃ©ration spÃ©ciale pour forcer le vidage de tous les caches sur le disque. <br><br>  En ce qui concerne les bases de donnÃ©es, nous devons Ãªtre sÃ»rs que la transaction confirmÃ©e au client (application client) a Ã©tÃ© persistante et ne disparaÃ®tra pas, d'une part, et d'autre part, les SGBD utilisent activement leur propre cache pour obtenir des performances maximales - et pour garantir la cohÃ©rence, la journalisation est utilisÃ©e - la modification est Ã©crite dans le journal, le journal est Â«synchronisÃ©Â», puis la modification est Ã©crite dans les donnÃ©es (et lorsqu'elle est Ã©crite, elle entre dans le cache).  Lorsque le journal est plein, une synchronisation forcÃ©e est effectuÃ©e sur toutes les donnÃ©es du cache et le journal recommence Ã  se remplir. <br><br><h2>  OpÃ©ration de synchronisation </h2><br>  Lorsque la synchronisation est exÃ©cutÃ©e, le systÃ¨me d'exploitation vide non seulement le cache de page, mais envoie par dÃ©faut une commande pour vider tous les caches de disque (et, Ã©ventuellement, le fait Ã  plusieurs reprises) - le soi-disant  <b>rincer</b> .  L'opÃ©ration de vidage des tampons est Â«coÃ»teuseÂ» et prend beaucoup de temps - mais elle est nÃ©cessaire, car dans les systÃ¨mes de fichiers, l'ordre d'Ã©criture est important - s'il est violÃ©, alors (par exemple) il peut s'avÃ©rer que lors d'un redÃ©marrage soudain du fichier, il y aura des ordures au lieu de donnÃ©es - puisque l'appareil a dÃ©cidÃ© de rÃ©organiser le disque.  Et lorsque le rinÃ§age vide tous les caches de force - cela garantit que tout ce qui est avant le rinÃ§age est Ã©crit, et ensuite seulement ce qui s'est passÃ© aprÃ¨s - c'est-Ã -dire qu'une Â«barriÃ¨reÂ» est crÃ©Ã©e divisant les entrÃ©es en Â«avant la barriÃ¨reÂ» et Â«aprÃ¨s la barriÃ¨reÂ» (Ã  partir d'ici et le nom Â«barriÃ¨re d'Ã©critureÂ») - et cela permet de garantir que les enregistrements aprÃ¨s la barriÃ¨re ne seront pas appliquÃ©s plus tÃ´t que les enregistrements avant la barriÃ¨re. <br><br><h2>  Effet Nobarrier </h2><br>  L'option nobarrier dÃ©sactive l'envoi de vidage forcÃ© pendant que le systÃ¨me de fichiers est en cours d'exÃ©cution.  Cela conduit au fait que les enregistrements peuvent Ãªtre rÃ©organisÃ©s - et si une dÃ©faillance se produit, le systÃ¨me de fichiers (et gÃ©nÃ©ralement les donnÃ©es dans le cas gÃ©nÃ©ral) peut ne pas Ãªtre cohÃ©rent - rappelons ce qui a Ã©tÃ© mentionnÃ© dans le paragraphe prÃ©cÃ©dent sur l'ordre d'enregistrement. <br><br>  Pourquoi cette option est-elle incluse?  Pour les SSD Ã  faible coÃ»t, l'opÃ©ration de vidage est trÃ¨s coÃ»teuse - par exemple, les SSD Ã  faible coÃ»t (et de nombreux coÃ»teux qui sont positionnÃ©s en tant que Â«serveursÂ») effectuent 10 Ã  20 000 opÃ©rations d'Ã©criture par seconde sans vidage, et avec vidage activÃ©, ils tombent Ã  1 Ã  2 000.  Dans de tels cas, nobarrier fournit une amÃ©lioration significative des performances, crÃ©ant les risques pour l'intÃ©gritÃ© des donnÃ©es dÃ©crits ci-dessus. <br><br><h2>  Environnement virtuel </h2><br>  Dans le cas d'une machine virtuelle - si, par exemple, nous parlons de la configuration classique de machines virtuelles sur un hyperviseur Linux, nous avons QEMU - un processus qui est en fait responsable de l'Ã©mulation des E / S pour le systÃ¨me d'exploitation invitÃ©.  Et surtout, si nous utilisons des disques non sauvegardÃ©s dans une machine virtuelle, le cache d'un tel disque virtuel (soudain!?) Se trouve dans l'espace utilisateur - dans l'espace adresse du processus QEMU correspondant.  Et si ce processus se bloque - par exemple, selon SEGFAULT / SIGSEGV - alors tous ses caches mourront avec lui.  Un exemple d'un tel pilote de pÃ©riphÃ©rique de bloc est le pilote RBD (Ceph). <br><br>  Et mÃªme si vous n'utilisez pas Ceph mais iSCSI / FC, par exemple, le niveau de dÃ©faillance ne disparaÃ®t pas - il passe simplement de QEMU au systÃ¨me d'exploitation hÃ´te (hyperviseur).  L'hyperviseur est tombÃ© - son cache de page est mort (cela est vrai pour io = 'threads' en combinaison avec cache = 'writeback' ou cache = 'unsafe').  Oups <br><br><h2>  s / Cloud / Ordinateur Ã©tranger / g </h2><br>  Lorsque votre machine virtuelle est dÃ©ployÃ©e dans le cloud ... Ensuite, vous ne savez pas comment l'hyperviseur est configurÃ©, comment QEMU est configurÃ©, quels pilotes de disque sont impliquÃ©s, si le cache de la page hÃ´te fonctionne, etc., et vous ne pouvez pas influencer cela dans la grande majoritÃ© des cas.  Et mÃªme si c'est votre cloud - oÃ¹ vous savez tout cela et le contrÃ´lez plus ou moins, ce n'est pas du tout un fait que votre hyperviseur ne Â«tomberaÂ» pas - enterrant tout le cache de donnÃ©es. <br><br><h2>  RÃ©sumÃ© </h2><br>  L'utilisation de nobarrier dans le cloud signifie que vous risquez fort de mettre vos donnÃ©es en danger.  ÃŠtes-vous sÃ»r de vouloir rÃ©aliser des gains de productivitÃ© au prix de ces risques? </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr471906/">https://habr.com/ru/post/fr471906/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr471886/index.html">VMmanager 6: prÃ©sentation de la box et comparaison avec la gÃ©nÃ©ration prÃ©cÃ©dente</a></li>
<li><a href="../fr471890/index.html">InfÃ©rence variationnelle - qu'est-ce que c'est et que mange-t-elle?</a></li>
<li><a href="../fr471892/index.html">6 histoires pratiques de nos jours de semaine SRE</a></li>
<li><a href="../fr471896/index.html">Le livre de jeu intÃ©rieur. FonctionnalitÃ©s rÃ©seau dans le nouveau moteur Ansible 2.9</a></li>
<li><a href="../fr471904/index.html">Planificateur de ressources chez HPE InfoSight</a></li>
<li><a href="../fr471908/index.html">La beautÃ© inattendue des nombres premiers</a></li>
<li><a href="../fr471912/index.html">Apprendre l'anglais: 7 faÃ§ons pratiques d'Ã©largir votre vocabulaire</a></li>
<li><a href="../fr471914/index.html">Fonctionnement du systÃ¨me graphique Sega Mega Drive: processeur d'affichage vidÃ©o</a></li>
<li><a href="../fr471918/index.html">SwiftUI: Connaissance</a></li>
<li><a href="../fr471924/index.html">PrÃ©sentation des modules Sass</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>