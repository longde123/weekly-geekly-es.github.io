<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>📏 ⌨️ 📂 Le cluster Kubernetes est-il facile et pratique à préparer? Annoncer l'opérateur d'addon 👏🏿 👆🏿 ⛑️</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Après l' opérateur shell, nous présentons son frère aîné - opérateur addon . Il s'agit d'un projet Open Source utilisé pour installer des composants s...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Le cluster Kubernetes est-il facile et pratique à préparer? Annoncer l'opérateur d'addon</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/flant/blog/455543/"><img src="https://habrastorage.org/webt/bs/rd/gp/bsrdgphybyglvkpf6vxtw-agpvk.png"><br><br>  Après l' <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">opérateur shell,</a> nous présentons son frère aîné - <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">opérateur addon</a> .  Il s'agit d'un projet Open Source utilisé pour installer des composants système dans le cluster Kubernetes, qui peut être appelé un mot courant - modules complémentaires. <a name="habracut"></a><br><br><h2>  Pourquoi faire des ajouts? </h2><br>  Ce n'est un secret pour personne que Kubernetes n'est pas un produit fini tout-en-un, et divers ajouts seront nécessaires pour créer un cluster «adulte».  Addon-operator vous aidera à installer, configurer et maintenir ces modules complémentaires à jour. <br><br>  Le besoin de composants supplémentaires dans le cluster est révélé dans un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">rapport de</a> collègues <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" class="user_link">driusha</a> .  En bref, la situation avec Kubernetes en ce moment est que pour une installation simple, vous pouvez "jouer" avec des composants prêts à l'emploi, pour les développeurs et les tests, vous pouvez ajouter Ingress, mais pour une installation complète, que vous pouvez dire "votre production est prête", vous devez ajouter une douzaine de modules complémentaires différents: quelque chose pour la surveillance, quelque chose pour les journaux, n'oubliez pas l'entrée et le gestionnaire de certificats, sélectionnez des groupes de nœuds, ajoutez des stratégies réseau, assaisonnez avec sysctl et les paramètres de mise à l'échelle automatique des pods ... <br><br><img src="https://habrastorage.org/webt/tv/2e/fb/tv2efbqltghsfxe7aibe0oor-qi.png"><br><br><h2>  Quelles sont les spécificités de travailler avec eux? </h2><br>  Comme le montre la pratique, le cas n'est pas limité à une seule installation.  Pour un travail confortable avec le cluster, les modules complémentaires devront être mis à jour, désactivés (supprimés du cluster) et vous voudrez tester quelque chose avant de l'installer dans le cluster de production. <br><br>  Alors peut-être qu'Ansible suffit ici?  C'est possible.  Mais les <b>ajouts à part entière dans le cas général ne vivent pas sans paramètres</b> .  Ces paramètres peuvent varier en fonction de l'option de cluster (aws, gce, azure, bare-metal, do, ...).  Certains paramètres ne peuvent pas être définis à l'avance - ils doivent être obtenus à partir du cluster.  Et le cluster n'est pas statique: pour certains paramètres, vous devrez suivre les modifications.  Et ici Ansible manque déjà: nous avons besoin d'un programme qui vit dans un cluster, c'est-à-dire  Opérateur Kubernetes. <br><br>  Ceux qui ont essayé l' <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">opérateur shell</a> en fonctionnement diront que les tâches d'installation et de mise à jour des modules complémentaires et des paramètres de suivi peuvent être complètement résolues à l'aide de <a href="">crochets</a> pour l'opérateur shell.  Vous pouvez écrire un script qui <code>kubectl apply</code> et surveillera <code>kubectl apply</code> , par exemple, ConfigMap, où les paramètres seront stockés.  C'est approximativement ce qui est implémenté dans addon-operator. <br><br><h2>  Comment est-ce organisé en addon-operator? </h2><br>  Pour créer une nouvelle solution, nous sommes partis des principes suivants: <br><br><ul><li>  Le programme d'installation du module complémentaire doit prendre en charge les <b>modèles et la configuration déclarative</b> .  Nous ne faisons pas de scripts magiques qui installent des modules complémentaires.  L'opérateur d'addon utilise Helm pour installer les modules complémentaires.  Pour installer, vous devez créer un graphique et mettre en évidence les valeurs qui seront utilisées pour configurer. </li><li>  Les paramètres peuvent être <b>générés lors de l'installation</b> , ils peuvent être <b>obtenus à partir du cluster</b> ou <b>recevoir des mises</b> à <b>jour</b> en surveillant les ressources du cluster.  Ces opérations peuvent être implémentées à l'aide de crochets. </li><li>  Les paramètres peuvent être <b>stockés dans un cluster</b> .  Pour stocker les paramètres dans le cluster, ConfigMap / addon-operator est créé et Addon-operator surveille les modifications de ce ConfigMap.  Addon-operator donne aux hooks accès aux paramètres à l'aide de conventions simples. </li><li>  <b>L'addition dépend des paramètres</b> .  Si les paramètres ont changé, l'opérateur Addon déploie le Helm-chart avec de nouvelles valeurs.  L'union du graphique Helm, ses valeurs et les crochets que nous avons appelés le module (voir ci-dessous pour plus de détails). </li><li>  <b>Mise en scène</b> .  Aucun script de sortie magique.  Le mécanisme de mise à jour est similaire à une application classique - collectez des modules complémentaires et un opérateur de module complémentaire dans une image, testez et déployez. </li><li>  <b>Contrôle du résultat</b> .  L'opérateur d'addon peut fournir des métriques pour Prometheus. </li></ul><br><h2>  Qu'est-ce que l'addon dans addon-operator? </h2><br>  Un ajout peut être considéré comme tout ce qui ajoute de nouvelles fonctions au cluster.  Par exemple, l'installation d'Ingress est un excellent exemple de module complémentaire.  Il peut s'agir de n'importe quel opérateur ou contrôleur avec son propre CRD: prometheus-operator, cert-manager, kube-controller-manager, etc.  Ou quelque chose de petit, mais simplifiant l'opération - par exemple, un copieur secret, la copie des secrets du registre vers de nouveaux espaces de noms, ou un tuner sysctl, la configuration des paramètres sysctl sur de nouveaux nœuds. <br><br>  Addon-operator propose plusieurs concepts pour implémenter des modules complémentaires: <br><br><ul><li>  <b>Le graphique Helm est</b> utilisé pour installer divers logiciels dans le cluster - par exemple, Prometheus, Grafana, nginx-ingress.  Si le composant requis possède un graphique Helm, son installation à l'aide de l'opérateur Addon sera très simple. </li><li>  <b>Réserve de valeurs</b> .  Les graphiques Helm ont généralement de nombreux paramètres différents qui peuvent changer au fil du temps.  Addon-operator prend en charge le stockage de ces paramètres et est capable de surveiller leurs modifications afin de réinitialiser le Helm-chart avec de nouvelles valeurs. </li><li>  <b>Les hooks</b> sont des fichiers exécutables que l'opérateur Addon exécute sur des événements et qui accèdent au magasin de valeurs.  Le hook peut surveiller les modifications dans le cluster et mettre à jour les valeurs dans le magasin de valeurs.  C'est-à-dire  à l'aide de hooks, vous pouvez effectuer une découverte pour collecter des valeurs du cluster au démarrage ou selon un calendrier, ou une découverte continue, en collectant des valeurs du cluster par des modifications dans le cluster. </li><li>  <b>Un module</b> est une union d'un graphique Helm, de valeurs de stockage et de crochets.  Les modules peuvent être activés et désactivés.  La désactivation d'un module entraîne la suppression de toutes les versions du graphique Helm.  Les modules peuvent s'activer dynamiquement, par exemple, si tous les modules dont il a besoin sont inclus ou si la découverte a trouvé les paramètres nécessaires dans les hooks - cela se fait à l'aide d'un script activé auxiliaire. </li><li>  <b>Crochets mondiaux</b>  Il s'agit de hooks «autonomes», ils ne sont pas inclus dans les modules et ont accès au stockage de valeurs globales, dont les valeurs sont disponibles pour tous les hooks des modules. </li></ul><br>  Comment ces pièces fonctionnent-elles ensemble?  Considérez l'image de la documentation: <br><br><img src="https://habrastorage.org/webt/d3/ws/wj/d3wswjubdglnla2eg0icgl8-uhe.gif"><br><br>  Deux scénarios de travail: <br><br><ol><li>  Un hook global est déclenché par un événement - par exemple, lorsqu'une ressource d'un cluster change.  Ce hook traite les modifications et écrit les nouvelles valeurs dans le stockage de valeurs globales.  L'opérateur de l'addon remarque que le stockage global a changé et lance tous les modules.  Chaque module, à l'aide de ses crochets, détermine s'il doit être activé et met à jour son magasin de valeurs.  Si le module est activé, l'opérateur Addon démarre l'installation du Helm-chart.  Dans ce cas, les valeurs de la mémoire du module et de la mémoire globale sont accessibles au Helm-chart. </li><li>  Le deuxième scénario est plus simple: un hook de module est déclenché par un événement, modifie les valeurs dans le stockage des valeurs du module.  Addon-operator le remarque et lance le graphique Helm avec des valeurs mises à jour. </li></ol><br>  L'add-on peut être implémenté comme un seul crochet ou comme un Helm-chart, ou <b>même comme plusieurs modules dépendants</b> - cela dépend de la complexité du composant installé dans le cluster et du niveau souhaité de flexibilité de configuration.  Par exemple, dans le référentiel ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">/ examples</a> ), il y a un module complémentaire sysctl-tuner, qui est implémenté à la fois comme un module simple avec un crochet et un graphique Helm, et en utilisant le stockage des valeurs, qui permet d'ajouter des paramètres en modifiant ConfigMap. <br><br><h2>  Mettre à jour la livraison </h2><br>  Quelques mots sur l'organisation des mises à jour des composants que l'opérateur Addon installe. <br><br>  Pour exécuter Addon-operator dans un cluster, vous devez <b>collecter une image avec des ajouts</b> sous la forme de fichiers de graphique de hook et de barre, ajouter le fichier binaire d' <code>addon-operator</code> et tout ce qui est nécessaire pour les hooks: <code>bash</code> , <code>kubectl</code> , <code>jq</code> , <code>python</code> , etc.  De plus, cette image peut être déployée sur le cluster en tant qu'application régulière, et vous souhaiterez probablement organiser tel ou tel schéma de balisage.  S'il y a peu de clusters, la même approche qu'avec les applications peut convenir: une nouvelle version, une nouvelle version, parcourez tous les clusters et corrigez l'image des Pods.  Cependant, dans le cas d'un déploiement vers un nombre notable de clusters, le concept d'auto-renouvellement à partir du canal nous convenait mieux. <br><br>  Nous l'avons arrangé comme ceci: <br><br><ul><li>  Un canal est essentiellement un identifiant qui peut être défini par n'importe qui (par exemple, dev / stage / ea / stable). </li><li>  Le nom du canal est la balise d'image.  Lorsque vous devez déployer des mises à jour de la chaîne, une nouvelle image est collectée et étiquetée avec le nom de la chaîne. </li><li>  Lorsqu'une nouvelle image apparaît dans le registre, l'opérateur Addon redémarre et démarre avec la nouvelle image. </li></ul><br>  Ce n'est pas une bonne pratique, comme décrit dans la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">documentation de Kubernetes</a> .  Ce n'est pas recommandé, mais nous parlons d'une <i>application régulière qui vit dans un cluster</i> .  Dans le cas de Addon-operator, une application est un grand nombre de déploiements répartis sur plusieurs clusters, et l'auto-mise à jour est très utile et simplifie la vie. <br><br>  Les canaux aident <b>au test</b> : s'il existe un cluster auxiliaire, vous pouvez le configurer sur le canal de <code>stage</code> et y effectuer des mises à jour avant de le déployer sur <code>stable</code> canaux <code>ea</code> et <code>stable</code> .  Si une erreur se produit avec le cluster sur le canal <code>ea</code> , vous pouvez le basculer sur <code>stable</code> pendant qu'une enquête sur le problème avec ce cluster est en cours.  Si le cluster est retiré du support actif, il passe à son canal «gelé» - par exemple, <code>freeze-2019-03-20</code> . <br><br>  Outre la mise à jour des crochets et des graphiques Helm, vous devrez peut-être <b>mettre</b> à <b>jour un composant tiers</b> .  Par exemple, vous avez remarqué une erreur dans l'exportateur de nœuds conditionnel et avez même compris comment le corriger.  Ensuite, nous avons ouvert PR et attendons une nouvelle version pour parcourir tous les clusters et augmenter la version de l'image.  Afin de ne pas attendre indéfiniment, vous pouvez récupérer votre nœud-exportateur et y basculer avant d'accepter le PR. <br><br>  En général, cela peut être fait sans Addon-operator, mais avec Addon-operator, le module d'installation de node-exporter sera visible dans un référentiel, vous pouvez conserver le Dockerfile pour construire votre image là, il devient plus facile pour tous les participants au processus de comprendre que arrive ... Et s'il y a plusieurs clusters, il devient plus facile à la fois de tester votre PR et d'enrouler une nouvelle version! <br><br>  Cette organisation des mises à jour des composants fonctionne avec succès avec nous, mais vous pouvez implémenter tout autre schéma approprié, car <b>dans ce cas, Addon-operator est un simple fichier binaire</b> . <br><br><h2>  Conclusion </h2><br>  Les principes mis en œuvre dans Addon-operator vous permettent de créer un processus transparent de création, de test, d'installation et de mise à jour de modules complémentaires dans un cluster, similaire aux processus de développement d'applications ordinaires. <br><br>  Les modules complémentaires pour l'opérateur Addon au format des modules (Helm-chart + hooks) peuvent être téléchargés au public.  Nous, la société Flant, prévoyons de présenter nos réalisations au cours de l'été sous la forme de tels ajouts.  Rejoignez le développement sur GitHub ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">shell-operator</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><b>addon-operator</b></a> ), essayez de faire votre ajout à partir d' <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">exemples</a> et de <a href="">documentation</a> , attendez les nouvelles sur le Habré et sur notre <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">chaîne YouTube</a> ! <br><br>  <i><b>MISE À JOUR (14 juin)</b> : Si vous avez des collègues anglophones qui pourraient être intéressés par l'opérateur d'addon, alors l'annonce correspondante pour eux est disponible dans <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">notre blog sur Medium</a> .</i> <br><br><h2>  PS </h2><br>  Lisez aussi dans notre blog: <br><br><ul><li>  « <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Étendre et compléter Kubernetes (revue et reportage vidéo)</a> »; </li><li>  « <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Présentation de l'opérateur shell: faciliter encore plus les opérateurs pour Kubernetes</a> .» </li></ul></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr455543/">https://habr.com/ru/post/fr455543/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr455529/index.html">Inverser et pirater le disque dur externe à chiffrement automatique d'Aigo. Partie 2: Dump avec Cypress PSoC</a></li>
<li><a href="../fr455533/index.html">Bubble Physics: A Search for Foam Destruction Mechanism</a></li>
<li><a href="../fr455535/index.html">Gérer les certificats SSL / TLS dans les nuages ​​et les conteneurs - pas du travail humain</a></li>
<li><a href="../fr455537/index.html">Optimisation de la recherche étendue: comment traiter un graphique avec 10 milliards d'états</a></li>
<li><a href="../fr455539/index.html">Voyants mobiles: 10 nouveaux faits sur la façon dont les appareils portables vous regardent</a></li>
<li><a href="../fr455545/index.html">Construire des processus à partir de zéro: du chaos à l'ordre</a></li>
<li><a href="../fr455547/index.html">Internet des objets en russe. Baseband Hotel LoRaWAN pour les propriétaires de RTL-SDR</a></li>
<li><a href="../fr455549/index.html">Comment utiliser les groupes Facebook pour promouvoir: créer un site Web</a></li>
<li><a href="../fr455553/index.html">Nous nous battons avec trop de Msg dans les applications Elm</a></li>
<li><a href="../fr455555/index.html">Pièce pour le gestionnaire mécanique</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>