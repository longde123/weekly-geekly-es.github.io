<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>⚡️ ♈️ 🤴🏽 打破统一垃圾收集规则 👩🏽‍🤝‍👨🏾 👩‍❤️‍💋‍👩 🐬</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="曾几何时，有一个统一的游戏程序员叫Lancelot。 我会说，这是一个非常热情的人。 他还不知道，但是最终他将面对Unity垃圾回收的最黑暗的一面。 


 兰斯洛特一直在寻找越来越多的作品。 因此，他努力工作，以获得在游戏行业的巨大机会。 

 他知道这并不容易。 

 游戏行业中的这些位置过去是...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>打破统一垃圾收集规则</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/484710/">曾几何时，有一个统一的游戏程序员叫Lancelot。 我会说，这是一个非常热情的人。 他还不知道，但是最终他将面对Unity垃圾回收的最黑暗的一面。 <br><br><div style="text-align:center;"><img src="https://thegamedevguru.b-cdn.net/wp-content/uploads/2019/12/GC-GarbageCollection-Thumbnail.jpg" alt="图片"></div><br> 兰斯洛特一直在寻找越来越多的作品。 因此，他努力工作，以获得在游戏行业的巨大机会。 <br><br> 他知道这并不容易。 <br><a name="habracut"></a><br> 游戏行业中的这些位置过去是，现在仍然是为少数游戏程序员保留的。 而且他不确定自己是否会达到标准。 <br><br> 但是他坚持并继续提高编程技巧。 <br><br> 兰斯洛特开始从事小型游戏。 他想，也许在某个时候，他将获得他寻找的巨大机会。 <br><br> 几年过去了，直到他获得了等待的机会。 他被要求将大型VR游戏移植到移动平台上。 他像兰斯洛特（Lancelot）一样兴奋，不禁怀疑自己是否<b>足够胜任</b>这项任务。 这令人生畏，但他接受了挑战。 他知道自己只能从中成长。 <br><br> 兰斯洛特最大的担忧是需要大幅提高游戏性能。 实际上，这是双重挑战。 对于一个<b>功能不那么强大的平台，</b>他必须将<b>性能提高20％</b> 。 <br><br> 经过几个月的不间断工作，他终于设法对游戏进行了足够的优化，以达到坚实的性能基准。 <br><br> 然而，一个意想不到的问题迫在眉睫... <br><br> 统一的分析器向他显示，每隔几秒钟他的帧率就会大幅下降。 这让他感到担心，因为那将不允许他发布游戏。 游戏发布处于危险之中。 那使他完全不舒服。 <br><br> 根据他以前的经验，兰斯洛特迅速怀疑了<b>垃圾收集器</b> 。 毕竟，他知道在游戏中过多分配临时内存可能会导致这些性能峰值。 就像每个人厨房中的垃圾桶一样，当垃圾量达到其容量的80％时，就该清理它了。 <br><br> 因此，他花了几天的时间来解决烦人的内存分配问题。 他执行了他能想到的所有类型的优化。 对象池，数据缓存，数据结构优化... <br><br> 这些天的花费优化使他在性能旅程中遥遥领先。 兰斯洛特为自己的工作感到骄傲，但是直到他看到垃圾收集器每15秒仍在运行时，他的担忧才会增加。 <br><br> 在这些性能下降的情况下在VR中玩游戏会使人显得苍白。 <br><br>  “那怎么可能？”他想知道。 <br><br> 经过更多的耐心和挖掘，Lancelot发现了他之前从未见过的第二个内存分配来源。 那些事发生在<b>第三党图书馆</b> 。 <br><br> 他看了一眼，很快意识到自己处于有史以来最糟糕的位置：该库是封闭源代码。 不仅如此，他还尝试使用Unity的<b>增量垃圾收集器，</b>但他负担不起性能的代价。 <br><br>  Lancelot的选项已用完。 <br><br> 他感到绝望，但设法保持镇定。 毕竟他一直处在更糟糕的情况下。 <br><br> 他可以对库进行<b>反向工程</b> ，然后自己进行内存分配优化。 问题是许可证不允许这种事情。 而且他还太年轻，无法入狱。 <br><br> 他考虑的第二个选项是在堆上<b>预分配</b>大量内存。 他知道，当堆使用率达到一定百分比时，团结会触发垃圾回收过程。 因此，增加堆应该给他更多的时间来进行垃圾回收。 <br><br> 可悲的是，这还不够。 <br><br> 慢慢地，他感觉好像无法控制局势。 这很艰难，但他又<b>坚持了下来</b> 。 <br><br> 因此，兰斯洛特想出了一个<b>疯狂的主意</b> 。 如果他完全禁用垃圾收集怎么办？ 那有可能吗？ 他觉得自己的想法多么危险。 他不想增加游戏崩溃的可能性。 上一次他检查时，对于球员来说这并不有趣。 也许时代确实发生了变化，但总比后悔好。 <br><br> 最重要的是，他担心推迟游戏的发布。 他不想让他的球员在圣诞节错过这个冠军。 他记得在这些假期里玩EverQuest有多少乐​​趣。 他不会从球员身上夺走这些。 <br><br> 达到这一点，他除了禁用垃圾收集器外别无选择。 <br><br> 他进入研究模式，发现他确实<b>可以手动禁用垃圾收集</b> 。 他进行了数十次实验，以查看游戏在不耗尽内存的情况下能保持多长时间。 他做了各种各样的测试来强调系统。 单击各处，四处走动，在不同的应用程序之间切换。 <br><br>  <b>数字</b>开始出现在他的电子表格中：25分钟，28分钟，30分钟……他还指出了堆使用量随时间增加的方式，以确保他永远不会超过安全预算。 <br><br> 有了这些数字，兰斯洛特建立了足够的<b>安全余量，</b>并准备了一个<b>原型</b> 。 他将在加载屏幕期间和每隔几分钟手动运行垃圾收集。 <br><br> 他又有了希望。 <br><br> 他彬彬有礼地要求质量检查人员进行数十遍游戏。 <br><br> 内存总是在预算之内。 没有崩溃。 无副作用。 <br><br> 漫长的旅程将他带到了能够<b>运送</b>游戏的地步。 <br><br> 你猜怎么着？ 在圣诞节期间，数百名玩家正在享受它。 <br><br> 一开始，他对这种解决方案不满意。 这是一个冒险的举动，他知道。 但是他设法做到了。 <br><br> 兰斯洛特学会了与<b>不适相处</b> 。 他学会了更加<b>务实</b> 。 因为有时候必须要有程序员。 <br><br> 故事有什么响吗？ 如果是这样，您的直觉可能是正确的。 <br><br> 那个程序员就是我。 <br><br> 在您需要的时候，这是管理垃圾收集器的方式： <br><br> 该代码段向您展示了如何禁用自动垃圾收集。 它每分钟以及可能在屏幕转换（淡入黑色）期间手动运行GC流程。 <br><br> 请注意其可能的副作用： <br><br><ul><li>  <b>崩溃</b> ：如果您的游戏不够安全，将耗尽内存。 更糟糕的是，当您在应用程序之间切换时，操作系统可能会杀死您的游戏 </li><li>  <b>更长的垃圾收集时间</b> ：增加堆将使以后的垃圾收集速度变慢 </li></ul><br> 如果您需要产生大量的垃圾，这是一个可以使用的简单方法： <br><br><pre><code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">GenerousGarbageCreator</span></span> : <span class="hljs-title"><span class="hljs-title">MonoBehaviour</span></span> { [SerializeField] <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> garbageCreationRate = <span class="hljs-number"><span class="hljs-number">1024</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span>[] _garbage; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Update</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { _garbage = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span>[garbageCreationRate]; } }</code> </pre> <br> 这是您将在探查器中获得的内容： <br><br><img src="https://thegamedev.guru/wp-content/uploads/2019/12/GC-Garbage-Collection-Management-Highlight.gif" alt="图片"><br>  <i>Unity垃圾收集：基于时间的手动触发器</i> <br><br> 在那里，您看到内存使用率不断增加。 不断增长的堆使用情况突出显示为“单”。 对我们来说幸运的是，我们每3秒运行一次手动垃圾收集器。 <br><br> 您可以在探查器图中清楚地看到此垃圾生成清除周期。 对于那些研究物理的游戏开发人员，您可能会认为它是锯齿波形。 <br><br> 如果您想要该项目的源代码，则知道在哪里可以找到它（扰流器：此处）。 <br><br> 有关更常规的内存优化，您可能对Unity可寻址对象感兴趣。 使用可寻址对象，您可以减少总的内存使用量，从而可以减少触发垃圾回收的频率。 反过来，这将减少您的播放器将遇到的性能峰值。 <br><br> 我期待在2020年与大家一起工作。 <br> 鲁本 </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN484710/">https://habr.com/ru/post/zh-CN484710/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN484692/index.html">维生素C-我需要服用补充剂还是商业用途？</a></li>
<li><a href="../zh-CN484700/index.html">Java 14：记录预览</a></li>
<li><a href="../zh-CN484702/index.html">2020年的Prestashop替代品：顶级电子商务平台</a></li>
<li><a href="../zh-CN484706/index.html">练习使用Redd综合工厂的定制轮胎</a></li>
<li><a href="../zh-CN484708/index.html">理查德·汉明 “不存在的章节”：我们如何知道我们所知道的（完整版本）</a></li>
<li><a href="../zh-CN484712/index.html">相对二进制兼容性：我们如何提供它</a></li>
<li><a href="../zh-CN484716/index.html">停止调用一切AI</a></li>
<li><a href="../zh-CN484718/index.html">HP现代打印机拒绝不使用墨水而无法工作</a></li>
<li><a href="../zh-CN484720/index.html">带管弦乐队的城市音乐会：谁和为什么录制日常生活的声音</a></li>
<li><a href="../zh-CN484722/index.html">哪种Ruby on Rails开发工具适合您的项目：2020年顶级Ruby on Rails宝石</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>