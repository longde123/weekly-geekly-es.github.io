<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ğŸ§–ğŸ¾ ğŸ–ï¸ ğŸš‰ äº‹ä»¶æœºå™¨å®ˆæŠ¤ç”Ÿå‘½å‘¨æœŸ â™»ï¸ ğŸ‘¨ğŸ½â€ğŸ’» ğŸŠ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="å…è´£å£°æ˜ï¼šæœ¬æ–‡ä»‹ç»äº†éæ˜¾è€Œæ˜“è§çš„é—®é¢˜çš„éæ˜¾è€Œæ˜“è§çš„è§£å†³æ–¹æ¡ˆã€‚ èµ¶ä¹‹å‰  é¸¡è›‹  ä»˜è¯¸å®è·µï¼Œæˆ‘å»ºè®®è¯»å®Œæ–‡ç« å¹¶ä¸‰æ€è€Œåè¡Œã€‚ 




å¤§å®¶å¥½ï¼ åœ¨å¤„ç†ä»£ç æ—¶ï¼Œæˆ‘ä»¬å¸¸å¸¸ä¸å¾—ä¸å¤„ç†state ã€‚ ä¸€ç§è¿™æ ·çš„æƒ…å†µæ˜¯å¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸã€‚ ç®¡ç†å…·æœ‰å‡ ç§å¯èƒ½çŠ¶æ€çš„å¯¹è±¡å¯èƒ½æ˜¯ä¸€é¡¹éå¸¸è‰°å·¨çš„ä»»åŠ¡ã€‚ åœ¨æ­¤å¤„æ·»åŠ å¼‚æ­¥æ‰§è¡Œï¼Œä»»åŠ¡...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>äº‹ä»¶æœºå™¨å®ˆæŠ¤ç”Ÿå‘½å‘¨æœŸ</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/431048/"><blockquote> å…è´£å£°æ˜ï¼šæœ¬æ–‡ä»‹ç»äº†éæ˜¾è€Œæ˜“è§çš„é—®é¢˜çš„éæ˜¾è€Œæ˜“è§çš„è§£å†³æ–¹æ¡ˆã€‚ èµ¶ä¹‹å‰ <del> é¸¡è›‹ </del> ä»˜è¯¸å®è·µï¼Œæˆ‘å»ºè®®è¯»å®Œæ–‡ç« å¹¶ä¸‰æ€è€Œåè¡Œã€‚ </blockquote><p><img src="https://habrastorage.org/webt/sb/cj/hs/sbcjhsnrjjqhgrl0xcpicmvzn40.png" alt="ä½†æ˜¯"></p><br><p>å¤§å®¶å¥½ï¼ åœ¨å¤„ç†ä»£ç æ—¶ï¼Œæˆ‘ä»¬å¸¸å¸¸ä¸å¾—ä¸å¤„ç†<em>state</em> ã€‚ ä¸€ç§è¿™æ ·çš„æƒ…å†µæ˜¯å¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸã€‚ ç®¡ç†å…·æœ‰å‡ ç§å¯èƒ½çŠ¶æ€çš„å¯¹è±¡å¯èƒ½æ˜¯ä¸€é¡¹éå¸¸è‰°å·¨çš„ä»»åŠ¡ã€‚ åœ¨æ­¤å¤„æ·»åŠ å¼‚æ­¥æ‰§è¡Œï¼Œä»»åŠ¡å°†å¤æ‚ä¸€ä¸ªæ•°é‡çº§ã€‚ æœ‰ä¸€ä¸ªæœ‰æ•ˆè€Œè‡ªç„¶çš„è§£å†³æ–¹æ¡ˆã€‚ åœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘å°†è®¨è®ºäº‹ä»¶æœºå™¨ä»¥åŠå¦‚ä½•åœ¨Goä¸­å®ç°å®ƒã€‚ </p><a name="habracut"></a><br><h2 id="zachem-upravlyat-sostoyaniem"> ä¸ºä»€ä¹ˆè¦ç®¡ç†å›½å®¶ï¼Ÿ </h2><br><p> é¦–å…ˆï¼Œè®©æˆ‘ä»¬å®šä¹‰æ¦‚å¿µæœ¬èº«ã€‚ çŠ¶æ€çš„æœ€ç®€å•ç¤ºä¾‹ï¼šæ–‡ä»¶å’Œå„ç§è¿æ¥ã€‚ æ‚¨ä¸ä»…å¯ä»¥è¯»å–æ–‡ä»¶ã€‚ å®ƒå¿…é¡»é¦–å…ˆæ‰“å¼€ï¼Œæœ€å <del> æœ€å¥½ </del> ç¡®ä¿å…³é—­ã€‚ äº‹å®è¯æ˜ï¼Œå½“å‰åŠ¨ä½œå–å†³äºä¸Šä¸€ä¸ªåŠ¨ä½œçš„ç»“æœï¼šè¯»å–å–å†³äºå¼€å¤´ã€‚ ä¿å­˜çš„ç»“æœæ˜¯çŠ¶æ€ã€‚ </p><br><p> çŠ¶æ€çš„ä¸»è¦é—®é¢˜æ˜¯å¤æ‚æ€§ã€‚ ä»»ä½•çŠ¶æ€éƒ½ä¼šè‡ªåŠ¨ä½¿ä»£ç å¤æ‚åŒ–ã€‚ æ‚¨å¿…é¡»å°†æ“ä½œç»“æœå­˜å‚¨åœ¨å†…å­˜ä¸­ï¼Œå¹¶å‘é€»è¾‘æ·»åŠ å„ç§æ£€æŸ¥ã€‚ è¿™å°±æ˜¯ä¸ºä»€ä¹ˆæ— çŠ¶æ€æ¶æ„å¯¹ç¨‹åºå‘˜å¦‚æ­¤å¸å¼•äººçš„åŸå› -æ²¡æœ‰äººæƒ³è¦ <del> éº»çƒ¦ </del> å›°éš¾ã€‚ å¦‚æœæ“ä½œç»“æœä¸å½±å“æ‰§è¡Œé€»è¾‘ï¼Œåˆ™ä¸éœ€è¦çŠ¶æ€ã€‚ </p><br><p> ä½†æ˜¯ï¼Œæœ‰ä¸€ä¸ªå±æ€§ä½¿æ‚¨æ— æ³•è§£å†³å›°éš¾ã€‚ çŠ¶æ€è¦æ±‚æ‚¨éµå¾ªç‰¹å®šçš„æ“ä½œé¡ºåºã€‚ é€šå¸¸ï¼Œåº”é¿å…è¿™ç§æƒ…å†µï¼Œä½†è¿™å¹¶ä¸æ€»æ˜¯å¯èƒ½çš„ã€‚ ä¸€ä¸ªç¤ºä¾‹æ˜¯ç¨‹åºå¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸã€‚ ç”±äºå…·æœ‰è‰¯å¥½çš„çŠ¶æ€ç®¡ç†ï¼Œå› æ­¤å¯ä»¥è·å¾—å…·æœ‰å¤æ‚ç”Ÿå‘½å‘¨æœŸçš„å¯¹è±¡çš„å¯é¢„æµ‹è¡Œä¸ºã€‚ </p><br><p> ç°åœ¨è®©æˆ‘ä»¬å¼„æ¸…æ¥šå¦‚ä½•åšåˆ°è¿™ä¸€ç‚¹ã€‚ </p><br><h2 id="avtomat-kak-sposob-resheniya-problem"> è‡ªåŠ¨è§£å†³é—®é¢˜ </h2><br><p><img src="https://habrastorage.org/webt/eg/qd/1o/egqd1oejaztizauope6waesapm0.jpeg" alt="AK74"></p><br><p> å½“äººä»¬è°ˆè®ºçŠ¶æ€æ—¶ï¼Œç«‹å³æƒ³åˆ°æœ‰é™çŠ¶æ€æœºã€‚ è¿™æ˜¯åˆä¹é€»è¾‘çš„ï¼Œå› ä¸ºè‡ªåŠ¨æœºæ˜¯ç®¡ç†çŠ¶æ€çš„æœ€è‡ªç„¶çš„æ–¹æ³•ã€‚ </p><br><blockquote> æˆ‘ä¸ä¼šæ·±å…¥ç ”ç©¶<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">è‡ªåŠ¨æœºç†è®º</a> ï¼› Internetä¸Šæœ‰è¶³å¤Ÿçš„ä¿¡æ¯ã€‚ </blockquote><p> å¦‚æœæ‚¨å¯»æ‰¾Goçš„æœ‰é™çŠ¶æ€æœºç¤ºä¾‹ï¼Œé‚£ä¹ˆæ‚¨è‚¯å®šä¼šé‡åˆ°<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Rob Pike</a>çš„<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">è¯æ³•åˆ†æå™¨</a> ã€‚ è‡ªåŠ¨æœºçš„ä¸€ä¸ªå¾ˆå¥½çš„ä¾‹å­ï¼Œå…¶ä¸­å¤„ç†çš„æ•°æ®æ˜¯è¾“å…¥å­—æ¯ã€‚ è¿™æ„å‘³ç€çŠ¶æ€è½¬æ¢æ˜¯ç”±è¯æ³•åˆ†æå™¨å¤„ç†çš„æ–‡æœ¬å¼•èµ·çš„ã€‚ ä¼˜é›…åœ°è§£å†³ç‰¹å®šé—®é¢˜ã€‚ </p><br><p> è¦äº†è§£çš„ä¸»è¦å†…å®¹æ˜¯ï¼Œè‡ªåŠ¨æœºæ˜¯å¯¹ä¸¥æ ¼ç‰¹å®šé—®é¢˜çš„è§£å†³æ–¹æ¡ˆã€‚ å› æ­¤ï¼Œåœ¨è€ƒè™‘å°†å…¶ä½œä¸ºæ‰€æœ‰é—®é¢˜çš„è¡¥æ•‘æªæ–½ä¹‹å‰ï¼Œæ‚¨å¿…é¡»å®Œå…¨ç†è§£è¯¥ä»»åŠ¡ã€‚ å…·ä½“æ¥è¯´ï¼Œæ‚¨è¦æ§åˆ¶çš„å®ä½“ï¼š </p><br><ul><li> çŠ¶æ€-ç”Ÿå‘½å‘¨æœŸï¼› </li><li> äº‹ä»¶-åˆ°åº•æ˜¯ä»€ä¹ˆå¯¼è‡´äº†å‘æ¯ä¸ªçŠ¶æ€çš„è½¬å˜ï¼Ÿ </li><li> å·¥ä½œç»“æœ-è¾“å‡ºæ•°æ®ï¼› </li><li> æ‰§è¡Œæ¨¡å¼ï¼ˆåŒæ­¥/å¼‚æ­¥ï¼‰ï¼› </li><li> ä¸»è¦ç”¨ä¾‹ã€‚ </li></ul><br><p> è¯æ³•åˆ†æå™¨å¾ˆæ¼‚äº®ï¼Œä½†æ˜¯å®ƒä»…ç”±äºå…¶è‡ªèº«å¤„ç†çš„æ•°æ®è€Œæ”¹å˜çŠ¶æ€ã€‚ ä½†æ˜¯ï¼Œå½“ç”¨æˆ·è°ƒç”¨è½¬æ¢æ—¶ï¼Œæƒ…å†µåˆå¦‚ä½•å‘¢ï¼Ÿ è¿™æ˜¯äº‹ä»¶æœºå™¨å¯ä»¥æä¾›å¸®åŠ©çš„åœ°æ–¹ã€‚ </p><br><h2 id="realnyy-primer"> çœŸå®çš„ä¾‹å­ </h2><br><p>ä¸ºäº†æ›´åŠ æ¸…æ¥šï¼Œæˆ‘å°†åˆ†æ<code>phono</code>åº“ä¸­çš„ç¤ºä¾‹ã€‚ </p><br><blockquote> è¦å®Œå…¨æ²‰æµ¸åœ¨ä¸Šä¸‹æ–‡ä¸­ï¼Œæ‚¨å¯ä»¥é˜…è¯»<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">ä»‹ç»æ€§æ–‡ç« </a> ã€‚ å¯¹äºæœ¬ä¸»é¢˜ï¼Œè¿™ä¸æ˜¯å¿…éœ€çš„ï¼Œä½†å®ƒå°†æœ‰åŠ©äºæ›´å¥½åœ°äº†è§£æˆ‘ä»¬æ­£åœ¨ç®¡ç†çš„å†…å®¹ã€‚ </blockquote><br><h3 id="a-chem-upravlyaem"> æˆ‘ä»¬è¦ç®¡ç†ä»€ä¹ˆï¼Ÿ </h3><br><p>  <code>phono</code>åŸºäºDSPç®¡çº¿ã€‚ å®ƒåŒ…æ‹¬ä¸‰ä¸ªå¤„ç†é˜¶æ®µã€‚ æ¯ä¸ªé˜¶æ®µå¯èƒ½åŒ…æ‹¬ä¸€ä¸ªåˆ°å‡ ä¸ªç»„ä»¶ï¼š </p><br><p><img src="https://habrastorage.org/webt/go/ym/ep/goymepjg4pds_picireejjsshnq.png" alt="pipe_diagram"></p><br><ol><li>  <code>pipe.Pump</code> ï¼ˆè‹±æ–‡æ³µï¼‰æ˜¯<strong>æ¥æ”¶</strong>å£°éŸ³çš„å¿…ä¸å¯å°‘çš„é˜¶æ®µï¼Œæ€»æ˜¯åªæœ‰ä¸€ä¸ªç»„æˆéƒ¨åˆ†ã€‚ </li><li>  <code>pipe.Processor</code> ï¼ˆè‹±è¯­å¤„ç†ç¨‹åºï¼‰-å£°éŸ³<strong>å¤„ç†</strong>çš„å¯é€‰é˜¶æ®µï¼Œä»0åˆ°Nä¸ªç»„ä»¶ã€‚ </li><li>  <code>pipe.Sink</code> ï¼ˆè‹±æ–‡æ°´æ§½ï¼‰-å£°éŸ³<strong>ä¼ è¾“</strong>çš„å¼ºåˆ¶é˜¶æ®µï¼Œä»1åˆ°Nä¸ªåˆ†é‡ã€‚ </li></ol><br><p> å®é™…ä¸Šï¼Œæˆ‘ä»¬å°†ç®¡ç†è¾“é€æœºçš„ç”Ÿå‘½å‘¨æœŸã€‚ </p><br><h3 id="zhiznennyy-cikl"> ç”Ÿå‘½å‘¨æœŸ </h3><br><p> è¿™å°±æ˜¯<code>pipe.Pipe</code>çŠ¶æ€å›¾çš„æ ·å­ã€‚ </p><br><p><img src="https://habrastorage.org/webt/le/ni/xq/lenixqpvoh0zaq9j2aftrqprtvg.png" alt="pipe_lifecycle"></p><br><p>  <em>æ–œä½“</em>è¡¨ç¤ºç”±å†…éƒ¨æ‰§è¡Œé€»è¾‘å¼•èµ·çš„è½¬æ¢ã€‚  <strong>ç²—ä½“</strong> -äº‹ä»¶å¼•èµ·çš„è¿‡æ¸¡ã€‚ è¯¥å›¾æ˜¾ç¤ºäº†çŠ¶æ€åˆ†ä¸ºä¸¤ç§ç±»å‹ï¼š </p><br><ul><li>  <strong>é™æ€</strong> - <code>ready</code>å’Œå·²<code>paused</code> ï¼Œæ‚¨åªèƒ½æŒ‰äº‹ä»¶ä»å®ƒä»¬ä¸­è·³è½¬ </li><li>  <em>æ´»åŠ¨çŠ¶æ€</em> - <code>running</code>å’Œ<code>pausing</code> ï¼Œäº‹ä»¶è½¬æ¢ä»¥åŠæ‰§è¡Œé€»è¾‘ </li></ul><br><p> åœ¨å¯¹ä»£ç è¿›è¡Œè¯¦ç»†åˆ†æä¹‹å‰ï¼Œå…ˆç®€å•è¯´æ˜ä¸€ä¸‹æ‰€æœ‰çŠ¶æ€çš„ç”¨æ³•ï¼š </p><br><pre> <code class="go hljs"><span class="hljs-comment"><span class="hljs-comment">// PlayWav  .wav    portaudio  -. func PlayWav(wavFile string) error { bufferSize := phono.BufferSize(512) //      w, err := wav.NewPump(wavFile, bufferSize) //  wav pump if err != nil { return err } pa := portaudio.NewSink( //  portaudio sink bufferSize, w.WavSampleRate(), w.WavNumChannels(), ) p := pipe.New( //  pipe.Pipe    ready w.WavSampleRate(), pipe.WithPump(w), pipe.WithSinks(pa), ) p.Run() //    running   p.Run() errc := p.Pause() //    pausing   p.Pause() err = pipe.Wait(errc) //     paused if err != nil { return err } errc = p.Resume() //    running   p.Resume() err = pipe.Wait(errc) //     ready if err != nil { return err } return pipe.Wait(p.Close()) //      }</span></span></code> </pre> <br><p> ç°åœ¨ï¼Œé¦–å…ˆæ˜¯ç¬¬ä¸€ä»¶äº‹ã€‚ </p><br><blockquote> æ‰€æœ‰æºä»£ç éƒ½å¯ä»¥åœ¨<a href="">èµ„æºåº“ä¸­æ‰¾åˆ°</a> ã€‚ </blockquote><br><h3 id="sostoyaniya-i-sobytiya"> çŠ¶æ€å’Œäº‹ä»¶ </h3><br><p> è®©æˆ‘ä»¬ä»æœ€é‡è¦çš„äº‹æƒ…å¼€å§‹ã€‚ </p><br><pre> <code class="go hljs"><span class="hljs-comment"><span class="hljs-comment">// state      . type state interface { listen(*Pipe, target) (state, target) //    transition(*Pipe, eventMessage) (state, error) //   } // idleState  .        . type idleState interface { state } // activeState  .         //   . type activeState interface { state sendMessage(*Pipe) state //    } //  . type ( idleReady struct{} activeRunning struct{} activePausing struct{} idlePaused struct{} ) //  . var ( ready idleReady running activeRunning paused idlePaused pausing activePausing )</span></span></code> </pre> <br><p> ç”±äºä½¿ç”¨äº†ä¸åŒçš„ç±»å‹ï¼Œè¿˜å¯ä»¥ä¸ºæ¯ä¸ªçŠ¶æ€åˆ†åˆ«å£°æ˜è½¬æ¢ã€‚ è¿™æ ·å¯ä»¥é¿å…å·¨å¤§çš„ <del> é¦™è‚  </del> å…·æœ‰åµŒå¥—<code>switch</code>è½¬æ¢å‡½æ•°ã€‚ çŠ¶æ€æœ¬èº«ä¸åŒ…å«ä»»ä½•æ•°æ®æˆ–é€»è¾‘ã€‚ å¯¹äºä»–ä»¬ï¼Œæ‚¨å¯ä»¥åœ¨åŒ…çº§åˆ«å£°æ˜å˜é‡ï¼Œè¿™æ ·å°±ä¸å¿…æ¯æ¬¡éƒ½è¿™æ ·åšã€‚ å¤šæ€æ€§éœ€è¦<code>state</code>æ¥å£ã€‚  <code>activeState</code> <code>idleState</code>è®¨è®º<code>activeState</code>å’Œ<code>idleState</code> ã€‚ </p><br><p> æˆ‘ä»¬æœºå™¨çš„ç¬¬äºŒä¸ªæœ€é‡è¦çš„éƒ¨åˆ†æ˜¯äº‹ä»¶ã€‚ </p><br><pre> <code class="go hljs"><span class="hljs-comment"><span class="hljs-comment">// event  . type event int //  . const ( run event = iota pause resume push measure cancel ) // target      . type target struct { state idleState //   errc chan error //   ,     } // eventMessage   ,    . type eventMessage struct { event //   params params //   components []string // id  target //      }</span></span></code> </pre> <br><p> è¦äº†è§£ä¸ºä»€ä¹ˆéœ€è¦<code>target</code>ç±»å‹ï¼Œè¯·è€ƒè™‘ä¸€ä¸ªç®€å•çš„ç¤ºä¾‹ã€‚ æˆ‘ä»¬åˆ›å»ºäº†ä¸€ä¸ªæ–°çš„ä¼ é€å¸¦ï¼Œå®ƒå·²ç»<code>ready</code> ã€‚ ç°åœ¨ä½¿ç”¨<code>p.Run()</code>è¿è¡Œå®ƒã€‚  <code>run</code>äº‹ä»¶å‘é€åˆ°è®¡ç®—æœºï¼Œç®¡é“è¿›å…¥<code>running</code>çŠ¶æ€ã€‚ å¦‚ä½•æ‰¾å‡ºè¾“é€æœºä½•æ—¶å®Œæˆï¼Ÿ è¿™æ˜¯<code>target</code>ç±»å‹å°†ä¸ºæˆ‘ä»¬æä¾›å¸®åŠ©çš„åœ°æ–¹ã€‚ å®ƒæŒ‡ç¤ºäº‹ä»¶åæœŸæœ›çš„ä¼‘æ¯çŠ¶æ€ã€‚ åœ¨æˆ‘ä»¬çš„ç¤ºä¾‹ä¸­ï¼Œå·¥ä½œå®Œæˆåï¼Œç®¡é“å°†å†æ¬¡è¿›å…¥<code>ready</code>çŠ¶æ€ã€‚ å›¾ä¸­çš„ç›¸åŒå†…å®¹ï¼š </p><br><p><img src="https://habrastorage.org/webt/h8/4i/xv/h84ixvb5dd_2gdbnrcd3kggwyzg.png"></p><br><p> ç°åœ¨æ›´å¤šå…³äºçŠ¶æ€ç±»å‹ã€‚ æ›´ç¡®åˆ‡åœ°è¯´ï¼Œå…³äº<code>idleState</code>å’Œ<code>activeState</code> ã€‚ è®©æˆ‘ä»¬çœ‹ä¸€ä¸‹ä¸åŒç±»å‹çš„é˜¶æ®µçš„<code>listen(*Pipe, target) (state, target)</code>åŠŸèƒ½ï¼š </p><br><pre> <code class="go hljs"><span class="hljs-comment"><span class="hljs-comment">// listen     ready. func (s idleReady) listen(p *Pipe, t target) (state, target) { return p.idle(s, t) } // listen     running. func (s activeRunning) listen(p *Pipe, t target) (state, target) { return p.active(s, t) }</span></span></code> </pre> <br><p>  <code>pipe.Pipe</code>å…·æœ‰ä¸åŒçš„åŠŸèƒ½ï¼Œä»¥ç­‰å¾…è½¬æ¢ï¼ é‚£é‡Œæœ‰ä»€ä¹ˆï¼Ÿ </p><br><pre> <code class="go hljs"><span class="hljs-comment"><span class="hljs-comment">// idle     .    . func (p *Pipe) idle(s idleState, t target) (state, target) { if s == t.state || s == ready { t = t.dismiss() //  ,  target } for { var newState state var err error select { case e := &lt;-p.events: //   newState, err = s.transition(p, e) //    if err != nil { e.target.handle(err) } else if e.hasTarget() { t.dismiss() t = e.target } } if s != newState { return newState, t // ,    } } } // active     .     , //   . func (p *Pipe) active(s activeState, t target) (state, target) { for { var newState state var err error select { case e := &lt;-p.events: //   newState, err = s.transition(p, e) //    if err != nil { //  ? e.target.handle(err) // ,    } else if e.hasTarget() { // ,  target t.dismiss() //   t = e.target //   } case &lt;-p.provide: //     newState = s.sendMessage(p) //    case err, ok := &lt;-p.errc: //   if ok { //   ,  interrupt(p.cancel) //   t.handle(err) //    } //    ,  return ready, t //    ready } if s != newState { return newState, t // ,    } } }</span></span></code> </pre> <br><p> å› æ­¤ï¼Œæˆ‘ä»¬å¯ä»¥æ”¶å¬å¤„äºä¸åŒçŠ¶æ€çš„ä¸åŒé¢‘é“ã€‚ ä¾‹å¦‚ï¼Œè¿™å…è®¸æ‚¨åœ¨æš‚åœæœŸé—´ä¸å‘é€æ¶ˆæ¯-æˆ‘ä»¬åªæ˜¯ä¸æ”¶å¬ç›¸åº”çš„é¢‘é“ã€‚ </p><br><h3 id="konstruktor-i-start-avtomata"> æœºå™¨çš„æ„é€ å™¨å’Œå¯åŠ¨ </h3><br><p><img src="https://habrastorage.org/webt/bk/h2/zn/bkh2znujbo_omto9lyhcq-ixp-e.png"></p><br><pre> <code class="go hljs"><span class="hljs-comment"><span class="hljs-comment">// New      . //      ready. func New(sampleRate phono.SampleRate, options ...Option) *Pipe { p := &amp;Pipe{ UID: phono.NewUID(), sampleRate: sampleRate, log: log.GetLogger(), processors: make([]*processRunner, 0), sinks: make([]*sinkRunner, 0), metrics: make(map[string]measurable), params: make(map[string][]phono.ParamFunc), feedback: make(map[string][]phono.ParamFunc), events: make(chan eventMessage, 1), //    cancel: make(chan struct{}), //     provide: make(chan struct{}), consume: make(chan message), } for _, option := range options { //   option(p)() } go p.loop() //    return p }</span></span></code> </pre> <br><p> é™¤äº†åˆå§‹åŒ–å’Œ<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">åŠŸèƒ½é€‰é¡¹ä¹‹å¤–</a> ï¼Œè¿˜æœ‰ä¸€ä¸ªå•ç‹¬çš„goroutineä¸ä¸»å¾ªç¯ä¸€èµ·å¼€å§‹ã€‚ å¥½å§ï¼Œçœ‹ç€ä»–ï¼š </p><br><pre> <code class="go hljs"><span class="hljs-comment"><span class="hljs-comment">// loop ,     nil . func (p *Pipe) loop() { var s state = ready //   t := target{} for s != nil { s, t = s.listen(p, t) //      p.log.Debug(fmt.Sprintf("%v is %T", p, s)) } t.dismiss() close(p.events) //    } // listen     ready. func (s idleReady) listen(p *Pipe, t target) (state, target) { return p.idle(s, t) } // transition       . func (s idleReady) transition(p *Pipe, e eventMessage) (state, error) { switch e.event { case cancel: interrupt(p.cancel) return nil, nil case push: e.params.applyTo(p.ID()) p.params = p.params.merge(e.params) return s, nil case measure: for _, id := range e.components { e.params.applyTo(id) } return s, nil case run: if err := p.start(); err != nil { return s, err } return running, nil } return s, ErrInvalidState }</span></span></code> </pre> <br><p> ä¼ é€å¸¦æ˜¯åœ¨å‘ç”Ÿäº‹ä»¶æ—¶å†»ç»“çš„ã€‚ </p><br><h3 id="pora-rabotat"> ä¸Šç­æ—¶é—´ </h3><br><p> è‡´ç”µ<code>p.Run()</code> ï¼ </p><br><p><img src="https://habrastorage.org/webt/wv/vi/vs/wvvivsokwwjkjvvcibg-kyvi9m0.png"></p><br><pre> <code class="go hljs"><span class="hljs-comment"><span class="hljs-comment">// Run   run  . //     pipe.Close  . func (p *Pipe) Run() chan error { runEvent := eventMessage{ event: run, target: target{ state: ready, //    errc: make(chan error, 1), }, } p.events &lt;- runEvent return runEvent.target.errc } // listen     running. func (s activeRunning) listen(p *Pipe, t target) (state, target) { return p.active(s, t) } // transition       . func (s activeRunning) transition(p *Pipe, e eventMessage) (state, error) { switch e.event { case cancel: interrupt(p.cancel) err := Wait(p.errc) return nil, err case measure: e.params.applyTo(p.ID()) p.feedback = p.feedback.merge(e.params) return s, nil case push: e.params.applyTo(p.ID()) p.params = p.params.merge(e.params) return s, nil case pause: return pausing, nil } return s, ErrInvalidState } // sendMessage   . func (s activeRunning) sendMessage(p *Pipe) state { p.consume &lt;- p.newMessage() return s }</span></span></code> </pre> <br><p>  <code>running</code>ç”Ÿæˆæ¶ˆæ¯å¹¶ä¸€ç›´è¿è¡Œï¼Œç›´åˆ°ç®¡é“å®Œæˆã€‚ </p><br><h3 id="sdelay-pauzu"> æš‚åœ </h3><br><p> åœ¨æ‰§è¡Œä¼ é€å¸¦æœŸé—´ï¼Œæˆ‘ä»¬å¯ä»¥æš‚åœå®ƒã€‚ åœ¨è¿™ç§çŠ¶æ€ä¸‹ï¼Œç®¡é“å°†ä¸ä¼šç”Ÿæˆæ–°æ¶ˆæ¯ã€‚ ä¸ºæ­¤ï¼Œè¯·è°ƒç”¨<code>p.Pause()</code>æ–¹æ³•ã€‚ </p><br><p><img src="https://habrastorage.org/webt/-2/9k/xz/-29kxztxwy56ftsphj9-blcbkei.png"></p><br><pre> <code class="go hljs"><span class="hljs-comment"><span class="hljs-comment">// Pause   pause  . //     pipe.Close  . func (p *Pipe) Pause() chan error { pauseEvent := eventMessage{ event: pause, target: target{ state: paused, //    errc: make(chan error, 1), }, } p.events &lt;- pauseEvent return pauseEvent.target.errc } // listen     pausing. func (s activePausing) listen(p *Pipe, t target) (state, target) { return p.active(s, t) } // transition       . func (s activePausing) transition(p *Pipe, e eventMessage) (state, error) { switch e.event { case cancel: interrupt(p.cancel) err := Wait(p.errc) return nil, err case measure: e.params.applyTo(p.ID()) p.feedback = p.feedback.merge(e.params) return s, nil case push: e.params.applyTo(p.ID()) p.params = p.params.merge(e.params) return s, nil } return s, ErrInvalidState } // sendMessage   .   -, //      .    //    ,      .  , // ,   , : // 1.     // 2.      func (s activePausing) sendMessage(p *Pipe) state { m := p.newMessage() if len(m.feedback) == 0 { m.feedback = make(map[string][]phono.ParamFunc) } var wg sync.WaitGroup //     wg.Add(len(p.sinks)) //   Sink for _, sink := range p.sinks { param := phono.ReceivedBy(&amp;wg, sink.ID()) // - m.feedback = m.feedback.add(param) } p.consume &lt;- m //   wg.Wait() // ,     return paused }</span></span></code> </pre> <br><p> ä¸€æ—¦æ‰€æœ‰æ”¶ä»¶äººéƒ½æ”¶åˆ°é‚®ä»¶ï¼Œç®¡é“å°†<code>paused</code>çŠ¶æ€ã€‚ å¦‚æœæ¶ˆæ¯æ˜¯æœ€åä¸€æ¡æ¶ˆæ¯ï¼Œåˆ™å°†å‘ç”Ÿåˆ°<code>ready</code>çŠ¶æ€çš„è½¬æ¢ã€‚ </p><br><h3 id="snova-za-rabotu"> å›å»ä¸Šç­ï¼ </h3><br><p> è¦é€€å‡º<code>paused</code>çŠ¶æ€ï¼Œè¯·è°ƒç”¨<code>p.Resume()</code> ã€‚ </p><br><p><img src="https://habrastorage.org/webt/vq/gu/dj/vqgudjnhdlifwyb6acyrkpbmkek.png"></p><br><pre> <code class="go hljs"><span class="hljs-comment"><span class="hljs-comment">// Resume   resume  . //     pipe.Close  . func (p *Pipe) Resume() chan error { resumeEvent := eventMessage{ event: resume, target: target{ state: ready, errc: make(chan error, 1), }, } p.events &lt;- resumeEvent return resumeEvent.target.errc } // listen     paused. func (s idlePaused) listen(p *Pipe, t target) (state, target) { return p.idle(s, t) } // transition       . func (s idlePaused) transition(p *Pipe, e eventMessage) (state, error) { switch e.event { case cancel: interrupt(p.cancel) err := Wait(p.errc) return nil, err case push: e.params.applyTo(p.ID()) p.params = p.params.merge(e.params) return s, nil case measure: for _, id := range e.components { e.params.applyTo(id) } return s, nil case resume: return running, nil } return s, ErrInvalidState }</span></span></code> </pre> <br><p> è¿™é‡Œçš„ä¸€åˆ‡å¾®ä¸è¶³é“ï¼Œç®¡é“å†æ¬¡è¿›å…¥<code>running</code>çŠ¶æ€ã€‚ </p><br><h3 id="svorachivaemsya"> å·èµ· </h3><br><p> ä¼ é€å¸¦å¯ä»¥ä»ä»»ä½•çŠ¶æ€åœæ­¢ã€‚ æœ‰<code>p.Close()</code> ã€‚ </p><br><p><img src="https://habrastorage.org/webt/va/lt/tz/valttzm_l7cqsibb6mi1ntxh6vy.png"></p><br><pre> <code class="go hljs"><span class="hljs-comment"><span class="hljs-comment">// Close   cancel  . //      . //    ,   . func (p *Pipe) Close() chan error { resumeEvent := eventMessage{ event: cancel, target: target{ state: nil, //   errc: make(chan error, 1), }, } p.events &lt;- resumeEvent return resumeEvent.target.errc }</span></span></code> </pre> <br><h2 id="komu-eto-nado"> è°éœ€è¦è¿™ä¸ªï¼Ÿ </h2><br><p> ä¸é€‚åˆæ‰€æœ‰äººã€‚ è¦ç¡®åˆ‡äº†è§£å¦‚ä½•ç®¡ç†çŠ¶æ€ï¼Œæ‚¨éœ€è¦äº†è§£æ‚¨çš„ä»»åŠ¡ã€‚ å¯ä»¥åœ¨ä¸¤ç§æƒ…å†µä¸‹ä½¿ç”¨åŸºäºäº‹ä»¶çš„å¼‚æ­¥è®¡ç®—æœºï¼š </p><br><ol><li> å¤æ‚çš„ç”Ÿå‘½å‘¨æœŸ-å­˜åœ¨å…·æœ‰éçº¿æ€§è½¬æ¢çš„ä¸‰ä¸ªæˆ–æ›´å¤šçŠ¶æ€ã€‚ </li><li> ä½¿ç”¨å¼‚æ­¥æ‰§è¡Œã€‚ </li></ol><br><p> å°½ç®¡äº‹ä»¶æœºè§£å†³äº†è¯¥é—®é¢˜ï¼Œä½†è¿™æ˜¯ä¸€ä¸ªç›¸å½“å¤æ‚çš„æ¨¡å¼ã€‚ å› æ­¤ï¼Œåªæœ‰åœ¨å…¨é¢äº†è§£æ‰€æœ‰ä¼˜ç¼ºç‚¹ä¹‹åï¼Œæ‰åº”æ ¼å¤–å°å¿ƒåœ°ä½¿ç”¨å®ƒã€‚ </p><br><h2 id="ssylki"> å‚è€ƒæ–‡çŒ® </h2><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">å”±æœº</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">lexer Rob Pike</a> </li></ul></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN431048/">https://habr.com/ru/post/zh-CN431048/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN431036/index.html">â€œæ•´ä¸ªä¸–ç•Œ-åˆ†æâ€æˆ–â€œåˆ†æâ€</a></li>
<li><a href="../zh-CN431040/index.html">ä¸Šå‘¨ç¬¬340å‘¨ï¼ˆ2018å¹´11æœˆ19æ—¥è‡³25æ—¥ï¼‰çš„å‰ç«¯ä¸–ç•Œæ‘˜è¦</a></li>
<li><a href="../zh-CN431042/index.html">PHPæ–‡æ‘˜ç¬¬144å·ï¼ˆ2018å¹´11æœˆ12æ—¥è‡³26æ—¥ï¼‰</a></li>
<li><a href="../zh-CN431044/index.html">æ£€å¯Ÿå®˜åŠå…¬å®¤å°†é¦–æ¬¡ä¸ºéæ³•é˜»æ­¢è¯¥ç½‘ç«™ä»˜æ¬¾</a></li>
<li><a href="../zh-CN431046/index.html">Z-indexå®é™…å¦‚ä½•å·¥ä½œ</a></li>
<li><a href="../zh-CN431050/index.html">çº¯å‡€çš„å¹»è§‰ï¼šæ°´çš„çŸ¿åŒ–æ˜¯å¦ä¼šå½±å“å…¶è´¨é‡ï¼ŒTDSè®¡å°†å¦‚ä½•å¸®åŠ©æˆ‘ä»¬ï¼Ÿ</a></li>
<li><a href="../zh-CN431052/index.html">å‰ç«¯å¼€å‘æ—¥ï¼šåœ°å›¾ï¼Œå›¢é˜Ÿï¼Œä¸¤ä¸ªæŸ¥è¯¢</a></li>
<li><a href="../zh-CN431058/index.html">Unicorn Engineçš„ç¬¬ä¸€æ­¥</a></li>
<li><a href="../zh-CN431060/index.html">åœ¨å¾·å›½é€šè¿‡åœ¨çº¿èº«ä»½éªŒè¯å’Œéš¾æ°‘èèµ„è¿›è¡Œçš„å¾·å›½èº«ä»½è¯æ¬ºéª—</a></li>
<li><a href="../zh-CN431064/index.html">åˆšæ€§ç¨‹åºå‘˜å®£è¨€</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>