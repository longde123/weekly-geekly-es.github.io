<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üßï üíä ü§ß Caja negra de fumador ‚ú°Ô∏è üê≥ üìú</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Muchas personas fuman demasiado, especialmente cuando son adictas a algo y no se dan cuenta de c√≥mo fuman un cigarrillo tras otro. La caja negra del f...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Caja negra de fumador</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/402867/">  Muchas personas fuman demasiado, especialmente cuando son adictas a algo y no se dan cuenta de c√≥mo fuman un cigarrillo tras otro.  La caja negra del fumador (CJK) no le permite tomar el pr√≥ximo cigarrillo hasta que haya pasado un cierto per√≠odo de tiempo.  En este art√≠culo, prestar√© atenci√≥n a algunos detalles que pueden ser √∫tiles para otros desarrollos, especialmente el no tan famoso controlador LC Teensy (familia Arduino). <br><br><iframe width="560" height="315" src="https://www.youtube.com/embed/mRDSiEAsiAI" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><a name="habracut"></a><br>  <b>La mecanica</b> <br><br>  Los detalles de ChYAK se imprimen en una impresora 3D y despu√©s del ensamblaje de las partes inferior, media y superior se unen. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/353/eb5/369/353eb5369a304723be064ac6e07722e9.jpg"></div><br><br>  El mecanismo de bloqueo est√° hecho de forma electromec√°nica, mientras que las funciones b√°sicas de bloqueo se realizan de forma puramente mec√°nica, esto hace que sea dif√≠cil romper el NJC manipulando los espacios y retirando las bater√≠as. <br><br>  El sistema de bloqueo consiste en un estante con dientes y un trinquete biestable, que permite que la bandeja se mueva solo en la direcci√≥n de cierre.  Al alcanzar un per√≠odo de tiempo predeterminado, el servo realiza un solo movimiento hacia adelante y hacia atr√°s y empuja el trinquete, que se establece en el segundo estado estable "abierto".  El CFC permanece abierto hasta que el usuario extraiga mec√°nicamente la bandeja.  Cuando se extiende, la bandeja empuja el trinquete y lo coloca nuevamente en el estado armado. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/a0b/9a1/c0e/a0b9a1c0eaf74795b582073f40f55b93.jpg"></div><br><br>  El cargador est√° hecho en forma de tambor con 4 cavidades para cigarrillos.  Para evitar tratar de hacer pasar un cigarrillo a trav√©s del cargador, el mecanismo de trinquete no permite el movimiento en la direcci√≥n opuesta, desde el lado del cual est√°n hechos los parachoques. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/69b/1af/cb9/69b1afcb91214e94a40b24be99f6895e.jpg"></div><br><br>  Las ranuras se hicieron en la tapa superior, le permiten eliminar posibles distorsiones de los cigarrillos dentro de la caja y sacudir las chispas de tabaco. <br><br>  <b>Interfaz</b> <br><br>  Para controlar el tiempo, la cantidad de cigarrillos en CHYAK y la cantidad de cigarrillos sacados, se monitoriza la pantalla OLED.  Se apaga casi todo el tiempo para no descargar la bater√≠a y se enciende solo por una se√±al del sensor capacitivo central, que se activa cuando se acerca una mano al CHYAK o una se√±al del bot√≥n al cargar cigarrillos.  Otro bot√≥n captura el momento en que se cierra la bandeja y comienza el siguiente ciclo de retraso.  Dos sensores capacitivos adicionales se encuentran en la pared posterior y se utilizan para ajustar los contadores de cigarrillos (necesarios, por ejemplo, al cambiar las bater√≠as). <br><br>  <b>Electr√≥nica</b> <br><br>  El microcontrolador es un Teensy LC.  Este dispositivo tipo arduin, compatible con la mayor√≠a de las bibliotecas Arduino, fue elegido porque tiene soporte para sensores capacitivos (interfaz de detecci√≥n t√°ctil (TSI)).  Los sensores son tan sensibles que pueden sentir f√°cilmente la mano levantada a una distancia de un cent√≠metro.  Teensy LC tiene el llamado modo LLWU, en este modo todos los m√≥dulos est√°n en modo de suspensi√≥n, con la excepci√≥n del oscilador de 1 kHz.  Puede salir de este modo de suspensi√≥n de 4 maneras: a) obtenga una interrupci√≥n del sensor capacitivo, b) obtenga una interrupci√≥n del pin, c) obtenga un desbordamiento del contador de 1 kHz (temporizador de baja potencia, LPTMR), d) obtenga una interrupci√≥n de la alarma. <br><br>  Aqu√≠ el autor estaba en problemas: en los planes iniciales era usar TSI para despertarse cuando se presentaba una mano, y LPTMR para interrupciones peri√≥dicas para ajustar los niveles de TSI (dependiendo de las condiciones ambientales) y el control del tiempo.  Pero result√≥ que LPTMR se usa para el funcionamiento de TSI y, en consecuencia, no se puede usar como contador de tiempo.  (La interrupci√≥n de desbordamiento de LPTMR es activaci√≥n de hardware para TSI y, por supuesto, debe ser r√°pida para monitorear el sensor. Por lo general, este contador est√° preestablecido en menos uno para que TSI se sondee con la frecuencia m√°s alta posible de 1 kHz). <br><br>  Otra posibilidad ser√≠a utilizar la alarma de alarma RTC, pero el hecho es que Tenncy LC no tiene un reloj de tiempo real (RTC).  Por el contrario, RTC est√° en el procesador, pero no hay cableado para el cuarzo RTC en la placa.  Sin embargo, el desarrollador del procesador ha dejado algunas lagunas para las mentes inquisitivas.  El oscilador de 1 kHz (que funciona en modo de suspensi√≥n) se puede utilizar como fuente para los registros RTC del controlador.  Entonces resulta que RTC no puede contar segundos intervalos (como cuando se usa cuarzo a 32 kHz), sino 32 segundos si se usa un oscilador de 1 kHz.  Esta precisi√≥n, por supuesto, no es suficiente.  Pero hay una salida. <br><br>  As√≠ es como funciona: <br><br>  Hay un registro de preescalador de tiempo RTC (RTC_TPR).  Este registro de 16 bits cuenta los pulsos del oscilador.  Cuando se desborda, el Registro de segundos de tiempo RTC (RTC_TSR) aumenta en uno.  En el modo cl√°sico, estos son los segundos, que se comparan con el Registro de alarma de tiempo RTC (RTC_TAR), y cuando coinciden, se genera una interrupci√≥n de alarma.  Cuando se utiliza cuarzo normal de 32 kHz, RTC_TSR no est√° preinstalado, sino que se cuenta desde cero cada vez (32768 a desbordamiento (segundos)).  Pero si preinstalamos RTC_TSR cada vez, teniendo en cuenta que tenemos un oscilador lento de 1 kHz, podemos obtener una alarma de interrupci√≥n de hasta milisegundos de precisi√≥n (sin tener en cuenta la inexactitud del oscilador).  Por supuesto, RTC_TAR tambi√©n debe recalcularse en consecuencia. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/719/cc7/057/719cc7057df74632be110832ac93d99b.png"></div><br><br>  Por ejemplo, si queremos establecer el per√≠odo en 87 segundos, debemos escribir 2 en RTC_TSR (2 * 32768 = 65536ms = 65.536s), 2 en RTC_TAR y 32768- (87 * 1000-65536) = 11304 en RTC_TSR.  Luego pasar√°n 32.768-11.304 = 21.464 segundos antes del primer desbordamiento RTC_TPR, y se les agregar√°n dos ciclos completos 2 * 32.768 = 65.536, que ser√°n solo 21.464 + 65.536 = 87 segundos <br>  En general, as√≠: <br><br><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setAlarm</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint32_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> seconds )</span></span></span><span class="hljs-function"> </span></span>{ RTC_SR = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-comment"><span class="hljs-comment">//disable RTC RTC_TPR=32768-(seconds*1000%32768); RTC_TSR=0; //RTC counter RTC_SR = RTC_SR_TCE; //enable RTC RTC_TAR = seconds*1000/32768; }</span></span></code> </pre> <br>  E incluso podemos controlar el tiempo total (hasta un error de 1 kHz del oscilador), por ejemplo, si al comienzo del programa todos los registros RTC eran cero: <br><br><pre> <code class="hljs lisp">timeEllapsed=(<span class="hljs-name"><span class="hljs-name">RTC_TSR*32768+RTC_TPR</span></span>)/1000</code> </pre> <br>  La precisi√≥n del oscilador de 1 kHz es peque√±a, pero para nuestros prop√≥sitos ser√° suficiente.  Debe tenerse en cuenta que al iniciar una nueva alarma, modificamos los registros RTC, por lo que si necesita controlar el tiempo, debe recordarlos antes de que comience la alarma, y ‚Äã‚Äãdespu√©s de salir de la interrupci√≥n de la alarma, se recalculan nuevamente teniendo en cuenta el tiempo pasado en hibernaci√≥n.  Lo describ√≠ en detalle aqu√≠: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">sobre RTC para Teency LC</a> <br><br>  En CJC, una interrupci√≥n cada 10 minutos mide y almacena el nivel de se√±al de los sensores capacitivos en ausencia de una mano.  Esto se hace para poder seguir de manera confiable los cambios en las se√±ales a medida que se acercan.  Con un fondo de ~ 500 unidades, utilizamos un nivel de exceso de ~ 20 unidades, esto hace posible sentir la mano a una distancia de 5-10 mm.  El nivel de fondo depende de la temperatura y la humedad, por lo que, para mayor fiabilidad, debe ajustarse peri√≥dicamente.  Esto, creo, es una falla en los desarrolladores de procesadores.  ¬øPor qu√© no dieron la oportunidad de despertarse de TSI y alg√∫n otro contador de baja potencia al mismo tiempo (solo agregue un registro m√°s), ya que el ajuste peri√≥dico de los niveles de TSI es casi obligatorio, incluso si no necesita un temporizador para otros fines! <br><br>  Ahora sobre la energ√≠a consumida.  En el modo de reposo LLWU, el Teensy LC consume alrededor de 15 uA cuando no hay un kit para el cuerpo.  Tuvimos que conectar otra pantalla OLED y un servo.  Ambos dispositivos tienen grandes corrientes de fuga incluso en estado pasivo. <br><br>  Todo es simple con OLED, esta es la pantalla OLED Adafruit 0.96 ‚Äùmonocrom√°tica de 128x64, est√° alimentada por 3.3V, consume corriente de aproximadamente 20 mA cuando est√° encendida (dependiendo del n√∫mero de p√≠xeles involucrados) y es controlada por SPI.  Es decir, simplemente conecte su entrada de potencia a la salida de 20 miliamperios del Teensy LC (Teency tiene diferentes tipos de salidas) y listo.  Cuando todos duermen, esta salida simplemente se transfiere al tercer estado y la corriente no pasa por la pantalla, con la activaci√≥n, la salida se transfiere al estado alto de salida y se convierte en Vcc para la pantalla. <br><br>  El servo es un poco m√°s complicado.  El servo en modo de espera consume una corriente de aproximadamente 2 mA, que, por supuesto, no es aceptable.  Por lo tanto, debe apagarlo por completo mientras duerme.  A diferencia del Arduin cl√°sico, Teensy LC tiene una selecci√≥n bastante peque√±a de fuentes de alimentaci√≥n: ya sea 1.7-3.3 V conectadas directamente, o 2.6-5.5 V (con el regulador de voltaje interno encendido).  Por lo general, los servos accesibles funcionan desde al menos 1S Lipo, y esto es 3.3-4.2 V. Por lo tanto, necesitamos encender tres bater√≠as est√°ndar en serie para tener de 3.3 (descarga) a 4.6 V (nuevo).  Para la mayor√≠a de los servos, 3.3 V est√° en el l√≠mite de operaci√≥n, por lo que no se pueden usar directamente las salidas Teensy (como para OLED).  S√≠, y la corriente durante la rotaci√≥n es de aproximadamente 50 mA, que es un poco demasiado para el Teensy LC.  Por lo tanto, el servo se enciende a trav√©s de MOSFET: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/d87/121/7a3/d871217a39f04ecfb537dff032ac7fb1.png"></div><br><br>  Con este encendido, puede parecer que no es seguro, ya que cuando el MOSFET est√° apagado, el voltaje en la entrada de control PWM supera los 3,3 V, y las entradas LC Tennsy no son tolerantes a 5V (a diferencia del Arduin cl√°sico).  Pero no debe tener miedo de esto, recordando que el PWM ctrl actual es muy peque√±o, y no hay que tener miedo del diodo limitante en la entrada del procesador (la raz√≥n de la inadmisibilidad de exceder Vcc + 0.5 est√° en este diodo), adem√°s, en corrientes comparables a las corrientes del diodo cerrado √©l ni siquiera estar√° en el estado abierto. <br><br>  en CHYAK utilizo HK282 con un umbral de 3.3V (solo porque lo ten√≠a).  Se puede alimentar alg√∫n tipo de servo de bajo voltaje y baja potencia directamente desde las salidas Teensy, de acuerdo con el esquema utilizado para OLED. <br><br>  Como resultado, la corriente en el modo de suspensi√≥n result√≥ ser de aproximadamente 50 uA, probablemente fue posible reducirla a√∫n m√°s, pero decid√≠ que esto era suficiente (si solo estaba dormido, las bater√≠as deber√≠an durar m√°s de 4 a√±os: 2000mAh / 0.05mA). <br><br>  <b>T√©cnica</b> <br><br>  Impreso en una impresora Monoprice Ultimate 3D, pl√°stico PLA, boquilla de 0.4 mm, capa de 0.2 mm.  Para detalles del mecanismo de bloqueo, una capa de 0.1 mm para mayor precisi√≥n.  Los resortes tambi√©n se imprimen en una impresora 3D.  Escribe durante mucho tiempo.  Por ejemplo, la mayor parte del medio (tiene muchas partes internas y paredes dobles para electr√≥nica y cables) se imprimi√≥ durante 20 horas.  Estaba pegado con pegamento de acrilato de cian.  Si algo se rompe por dentro, es imposible distinguirlo (protecci√≥n contra los fumadores man√≠acos), tendr√° que romperlo como una alcanc√≠a e imprimir nuevamente (un argumento a favor de las impresoras 3D).  Los dibujos y las animaciones se realizan en SolidWorks, el entorno de desarrollo de AtmelStudio (s√≠, AVR (adolescencia) es compatible desde el primer momento, como Arduino, a trav√©s de VisualMicro). </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/es402867/">https://habr.com/ru/post/es402867/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../es402853/index.html">La tercera ola de soluciones blockchain trae tecnolog√≠a CAT</a></li>
<li><a href="../es402859/index.html">Port√°tiles al servicio de la polic√≠a.</a></li>
<li><a href="../es402861/index.html">Primera vez: para el estreno</a></li>
<li><a href="../es402863/index.html">Un modelo de contrato honesto como mecanismo de autorregulaci√≥n de las relaciones p√∫blicas.</a></li>
<li><a href="../es402865/index.html">Dos vuelos de una etapa Falcon 9 en un video</a></li>
<li><a href="../es402869/index.html">Rastreadores de moda a la moda: Samsung, Polar, Withings, que no se esperaban</a></li>
<li><a href="../es402871/index.html">C√≥mo abrir un banco en Europa: licencias y blockchain</a></li>
<li><a href="../es402873/index.html">El libro "No te mueras! Comida en la lucha por la vida "</a></li>
<li><a href="../es402875/index.html">Matrices para c√°maras de CCTV. ¬øA qu√© prestar atenci√≥n?</a></li>
<li><a href="../es402877/index.html">Presentaci√≥n de impresoras de chocolate</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>