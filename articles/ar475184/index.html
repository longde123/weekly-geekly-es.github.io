<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>๐๐พ ๐ง๐ฝ ๐ง๐ป ูุธุงู ููููุณ ุงูููู ูุฏุนู ๐ฆ ๐ฐ๏ธ ๐ฉ๐พโ๐ป</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="ูุงุฐุง ูุฑู ูุจุฑูุฌ ุนูุฏ ุงูุจุฏุก ูู ุงูุนูู ูุน ูุบุฉ Cุ ูุฑู fopen ุ printf ุ scanf ูุงูุนุฏูุฏ ูู ุงููุธุงุฆู ุงูุฃุฎุฑู. ูุฑู ุฌููุน ุฃููุงุน open ู mmap - ูุจุฏู ุ ููุงุฐุง ุชุณููุท ุงูุถู...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>ูุธุงู ููููุณ ุงูููู ูุฏุนู</h1><div class="post__body post__body_full" style=";text-align:right;direction:rtl"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/475184/" style=";text-align:right;direction:rtl"><p style=";text-align:right;direction:rtl"> <a href=""><img alt="ls / usr / share / ุฑุฌู / man2 /" src="https://habrastorage.org/webt/ej/cn/w4/ejcnw4zqrqo_wee6kw-evxqziui.png"></a> </p><br><p style=";text-align:right;direction:rtl"> ูุงุฐุง ูุฑู ูุจุฑูุฌ ุนูุฏ ุงูุจุฏุก ูู ุงูุนูู ูุน ูุบุฉ Cุ  ูุฑู <code>fopen</code> ุ <code>printf</code> ุ <code>scanf</code> ูุงูุนุฏูุฏ ูู ุงููุธุงุฆู ุงูุฃุฎุฑู.  ูุฑู ุฌููุน ุฃููุงุน <code>open</code> ู <code>mmap</code> - ูุจุฏู ุ ููุงุฐุง ุชุณููุท ุงูุถูุก ุนูููุงุ  ูููู ุ ุนูู ุนูุณ ุงููุฌููุนุฉ ุงูุฃููู ุ ูุฅู ูุงุชูู ุงููุธููุชูู ุนูุฏ ุชูููุฐููุง ุนูู Linux kernel ููุง ููุงููุงุช ุงููุธุงู (ูู <em>ุงููุงูุน ูุง</em> ุ ูุง ูููู ุงุณุชุฏุนุงุก ููุงููุฉ ุงููุธุงู ุฃุจุฏูุง ุจุจุณุงุทุฉ ูุฏุงูุฉ ุ ูุจุงูุชุงูู ูุญุชูู <code>libc</code> ุนูู ุฃุบููุฉ ุชููู ุจุฅุนุงุฏุฉ ุญุฒู ุงููุณุงุฆุท ูุฃุญูุงููุง ุ ููุง ูู ุงูุญุงู ูุน <code>open</code> ุ ุงุณุชุจุฏุงู ููุงููุงุช ุงููุธุงู ุงููุฏูู ุจููุงููุงุช ุฌุฏูุฏุฉ ุฃูุซุฑ ุนููููุฉ).  ุจุดูู ุนุงู ุ ุนูู ุนูุณ ุงูุขูุงู ูู ูุธุงุฆู ุงูููุชุจุฉ ุงููุชููุฑุฉ ุนูู ูุธุงู ุฌูู / ููููุณ ุงููููุฐุฌู ุ ุชุญุชูู ูุงุฌูุฉ kernel ุนูู ุนุฏุฏ ูุญุฏูุฏ ูู ููุงุท ุงูุฏุฎูู - ูู ุฃุฌู ุนุฏุฉ ูุฆุงุช ุ ูููู ุจุงููุณุจุฉ ููุณุงุญุฉ ุงููุณุชุฎุฏู ุ ูุฅูู ูุชุนุทู (ุนูู ุณุจูู ุงููุซุงู ุ ุงููุตูู ุฅูู ุตูุญุฉ ููููุฏุฉ) ุ ุจุงููุณุจุฉ ุฅูู kernel - ุงููุถุน ุงูุงูุชุฑุงุถู ููุนูููุฉ. </p><br><p style=";text-align:right;direction:rtl">  ูู ูุฐู ุงูููุงูุฉ ุณุฃุฎุจุฑู ุจุจุนุถ ุงูุญูุงุฆู ุงููุซูุฑุฉ ูู ุฑุฃูู.  ูู ูููู ููุง ุชูุงุตูู ุชูููุฐ ููููุฉ ุฃุฎุฑู (ุนูู ุงูุฃุฑุฌุญ).  ุณูููู ุงูุณุจุจ ุงูุฑุฆูุณู ูุฑุงุก ุฑุฏุฉ ูุนูู "ููุงุฐุง ูููู ุฃู ูููู ูุฐููุ!ุ". </p><a name="habracut"></a><br><p style=";text-align:right;direction:rtl">  ุฃููุงู ุ ุจุนุถ ุงูุชุนูููุงุช ุนูู ุงููุต ูุจู kat: ุชุญุชูู ุจุนุถ ููุงููุงุช ุงููุธุงู ุนูู ูุงุฌูุฉ ุงุฎุชูุงุฑูุฉ ูู ุดูู ุฏุงูุฉ ูู ูุงุฆู ูุดุชุฑู ูุณูู <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">vDSO</a> ุ ูุงูุฐู ูุถุนู kernel ูู ุงูุนูููุฉ.  ููุงู ุนุฏุฏ ูููู ูู ูุฐู ุงููุธุงุฆู (ุดูุก ูุง ุญูุงูู ุฃุฑุจุนุฉ ุ ูููู ุงููููุฉ ุงููุญุฏุฏุฉ ุ ุนูู ูุง ูุจุฏู ุ ูุฏ ุชุนุชูุฏ ุนูู ุฅุตุฏุงุฑ kernel ูุงูููุฏุณุฉ ุงููุนูุงุฑูุฉ) - ูู ูุฐู ุฃููุงุน ูู <code>time</code> ู <code>gettimeofday</code> ุ ูุงูุชู ุ ูู ูุงุญูุฉ ุ ูุชู ุงุณุชุฎุฏุงููุง ูู ูุซูุฑ ูู ุงูุฃุญูุงู ุ ููู ูุงุญูุฉ ุฃุฎุฑู ุ ุชู ุชูููุฐูุง ุฏูู ุชุบููุฑ ุณูุงู ุงูููุงุฉ. </p><br><p style=";text-align:right;direction:rtl">  ุซุงููุงู ุ ูุง ููุชูู SIGSEGV ุฏุงุฆููุง ุจุชุนุทู ุงูุนูููุฉ ุ ููููุง ุณูุชุญุฏุซ ุนู ุฐูู <code>userfaultfd</code> ุนูุฏูุง ูุชุนูู ุงูุฃูุฑ <code>userfaultfd</code> . </p><br><p style=";text-align:right;direction:rtl">  <strong>ุชูููู:</strong> ุชุฐูุฑ ุฃูู ุจุงุณุชุฎุฏุงู ูุนุธู ุงูููุฒุงุช ุงููุนุฑูุถุฉ ููุง ุ ูุฃูุช ุชููู ุจุฑุจุท ุจุฑูุงูุฌ Linux ุงูุฎุงุต ุจู.  ูุฐุง ุฃูุฑ ุทุจูุนู ุฅุฐุง ููุช ุจูุฐู ุงูุทุฑููุฉ ุจุงูุชุญุณูู ุงูุงุฎุชูุงุฑู ูููุน ูุนูู ูู ุงููุธุงู ุฃู ููุฒุฉ ุฅุถุงููุฉ ูู ุชูู ููุฌูุฏุฉ.  ููู ุนูู ุฎูุงู ุฐูู ุ ุฃูุตู ุจุงูุชูููุฑ ูู ููููุฉ ุนูู ุงุญุชูุงุทู ุนุจุฑ ุงููุธุงู ุงูุฃุณุงุณู. </p><br><h2 id="obschie-voprosy" style=";text-align:right;direction:rtl">  ุฃุณุฆูุฉ ุนุงูุฉ </h2><br><p style=";text-align:right;direction:rtl">  ุจุงููุณุจุฉ ูููุจุชุฏุฆูู ุ ููู ูููู ุชุตุญูุญ ูู ูุฐุงุ  ุจุงูุทุจุน ุณูู ูุณุงุนุฏูุง <code>strace</code> !  ูุธุฑูุง ูุฃู ูุฌููุนุฉ ููุงููุงุช ุงููุธุงู ูุญุฏูุฏุฉ ุ ููุนุฑู ูุนุธู <code>strace</code> "ุนู ุทุฑูู ุงูุจุตุฑ" ุ ูุฅูู ูู ูุธูุฑ ููุท "ุชู ุชูุฑูุฑ ุงููุคุดุฑ 0x12345678" ุ ููููู ุณูุตู ูุง ูุชู ูููู ูู ูุฐุง ุงูุงุชุฌุงู ุฃู ุฐุงู ูู ูุฐุง ุงููููู.  ุฅุฐุง ูุงู <code>strace</code> ูุงููุฉ ุ ูููููู ุจุงุณุชุฎุฏุงู ุงูุฎูุงุฑ <code>-k</code> ุฃู ุชุทูุจ ููู ุฅุตุฏุงุฑ ููุฏุณ ููููุงููุงุช. </p><br><div class="spoiler" style=";text-align:right;direction:rtl">  <b class="spoiler_title">ูุจุฏู ุดูุก ูู ูุฐุง ุงููุจูู</b> <div class="spoiler_text" style=";text-align:right;direction:rtl"><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">$ strace -k sleep 1 execve("/bin/sleep", ["sleep", "1"], 0x7ffe9f9cce30 /* 60 vars */) = 0 &gt; /lib/x86_64-linux-gnu/libc-2.30.so(execve+0xb) [0xe601b] &gt; /usr/bin/strace(+0x0) [0xa279c] &gt; /usr/bin/strace(+0x0) [0xa41d2] &gt; /usr/bin/strace(+0x0) [0x7090b] &gt; /lib/x86_64-linux-gnu/libc-2.30.so(__libc_start_main+0xf3) [0x271e3] &gt; /usr/bin/strace(+0x0) [0x7112a] brk(NULL) = 0x558936ded000 &gt; /lib/x86_64-linux-gnu/ld-2.30.so(_dl_catch_error+0x20b) [0x1ccdb] &gt; /lib/x86_64-linux-gnu/ld-2.30.so(__get_cpu_features+0x1cd2) [0x1b872] &gt; /lib/x86_64-linux-gnu/ld-2.30.so() [0x203c] &gt; /lib/x86_64-linux-gnu/ld-2.30.so() [0x1108] arch_prctl(0x3001 /* ARCH_??? */, 0x7fff593c0070) = -1 EINVAL ( ) &gt; /lib/x86_64-linux-gnu/ld-2.30.so(__get_cpu_features+0x1e25) [0x1b9c5] &gt; /lib/x86_64-linux-gnu/ld-2.30.so() [0x203c] &gt; /lib/x86_64-linux-gnu/ld-2.30.so() [0x1108] access("/etc/ld.so.preload", R_OK) = -1 ENOENT (    ) &gt; /lib/x86_64-linux-gnu/ld-2.30.so(_dl_catch_error+0x10cb) [0x1db9b] &gt; /lib/x86_64-linux-gnu/ld-2.30.so() [0x3c12] &gt; /lib/x86_64-linux-gnu/ld-2.30.so(__get_cpu_features+0x1e7b) [0x1ba1b] &gt; /lib/x86_64-linux-gnu/ld-2.30.so() [0x203c] &gt; /lib/x86_64-linux-gnu/ld-2.30.so() [0x1108] openat(AT_FDCWD, "/etc/ld.so.cache", O_RDONLY|O_CLOEXEC) = 3 &gt; /lib/x86_64-linux-gnu/ld-2.30.so(_dl_catch_error+0x1238) [0x1dd08] &gt; /lib/x86_64-linux-gnu/ld-2.30.so(_dl_debug_state+0x73a) [0x11d4a] &gt; /lib/x86_64-linux-gnu/ld-2.30.so(_dl_exception_free+0x908) [0x189c8] &gt; /lib/x86_64-linux-gnu/ld-2.30.so() [0xa362] &gt; /lib/x86_64-linux-gnu/ld-2.30.so(_dl_rtld_di_serinfo+0x41b5) [0xeb35] &gt; /lib/x86_64-linux-gnu/ld-2.30.so(_dl_catch_exception+0x65) [0x1ca85] &gt; /lib/x86_64-linux-gnu/ld-2.30.so(_dl_rtld_di_serinfo+0x4603) [0xef83] &gt; /lib/x86_64-linux-gnu/ld-2.30.so() [0x3c55] &gt; /lib/x86_64-linux-gnu/ld-2.30.so(__get_cpu_features+0x1e7b) [0x1ba1b] &gt; /lib/x86_64-linux-gnu/ld-2.30.so() [0x203c] &gt; /lib/x86_64-linux-gnu/ld-2.30.so() [0x1108] fstat(3, {st_mode=S_IFREG|0644, st_size=254851, ...}) = 0 &gt; /lib/x86_64-linux-gnu/ld-2.30.so(_dl_catch_error+0x1009) [0x1dad9] &gt; /lib/x86_64-linux-gnu/ld-2.30.so(_dl_debug_state+0x761) [0x11d71] &gt; /lib/x86_64-linux-gnu/ld-2.30.so(_dl_exception_free+0x908) [0x189c8] &gt; /lib/x86_64-linux-gnu/ld-2.30.so() [0xa362] &gt; /lib/x86_64-linux-gnu/ld-2.30.so(_dl_rtld_di_serinfo+0x41b5) [0xeb35] &gt; /lib/x86_64-linux-gnu/ld-2.30.so(_dl_catch_exception+0x65) [0x1ca85] &gt; /lib/x86_64-linux-gnu/ld-2.30.so(_dl_rtld_di_serinfo+0x4603) [0xef83] &gt; /lib/x86_64-linux-gnu/ld-2.30.so() [0x3c55] &gt; /lib/x86_64-linux-gnu/ld-2.30.so(__get_cpu_features+0x1e7b) [0x1ba1b] &gt; /lib/x86_64-linux-gnu/ld-2.30.so() [0x203c] &gt; /lib/x86_64-linux-gnu/ld-2.30.so() [0x1108] mmap(NULL, 254851, PROT_READ, MAP_PRIVATE, 3, 0) = 0x7fc49621c000 &gt; /lib/x86_64-linux-gnu/ld-2.30.so(_dl_catch_error+0x1426) [0x1def6] &gt; /lib/x86_64-linux-gnu/ld-2.30.so(_dl_debug_state+0x79d) [0x11dad] &gt; /lib/x86_64-linux-gnu/ld-2.30.so(_dl_exception_free+0x908) [0x189c8] &gt; /lib/x86_64-linux-gnu/ld-2.30.so() [0xa362] &gt; /lib/x86_64-linux-gnu/ld-2.30.so(_dl_rtld_di_serinfo+0x41b5) [0xeb35] &gt; /lib/x86_64-linux-gnu/ld-2.30.so(_dl_catch_exception+0x65) [0x1ca85] &gt; /lib/x86_64-linux-gnu/ld-2.30.so(_dl_rtld_di_serinfo+0x4603) [0xef83] &gt; /lib/x86_64-linux-gnu/ld-2.30.so() [0x3c55] &gt; /lib/x86_64-linux-gnu/ld-2.30.so(__get_cpu_features+0x1e7b) [0x1ba1b] &gt; /lib/x86_64-linux-gnu/ld-2.30.so() [0x203c] &gt; /lib/x86_64-linux-gnu/ld-2.30.so() [0x1108] close(3) = 0 &gt; /lib/x86_64-linux-gnu/ld-2.30.so(_dl_catch_error+0x10fb) [0x1dbcb] &gt; /lib/x86_64-linux-gnu/ld-2.30.so(_dl_debug_state+0x780) [0x11d90] &gt; /lib/x86_64-linux-gnu/ld-2.30.so(_dl_exception_free+0x908) [0x189c8] &gt; /lib/x86_64-linux-gnu/ld-2.30.so() [0xa362] &gt; /lib/x86_64-linux-gnu/ld-2.30.so(_dl_rtld_di_serinfo+0x41b5) [0xeb35] &gt; /lib/x86_64-linux-gnu/ld-2.30.so(_dl_catch_exception+0x65) [0x1ca85] &gt; /lib/x86_64-linux-gnu/ld-2.30.so(_dl_rtld_di_serinfo+0x4603) [0xef83] &gt; /lib/x86_64-linux-gnu/ld-2.30.so() [0x3c55] &gt; /lib/x86_64-linux-gnu/ld-2.30.so(__get_cpu_features+0x1e7b) [0x1ba1b] &gt; /lib/x86_64-linux-gnu/ld-2.30.so() [0x203c] &gt; /lib/x86_64-linux-gnu/ld-2.30.so() [0x1108] openat(AT_FDCWD, "/lib/x86_64-linux-gnu/libc.so.6", O_RDONLY|O_CLOEXEC) = 3 &gt; /lib/x86_64-linux-gnu/ld-2.30.so(_dl_catch_error+0x1238) [0x1dd08] &gt; /lib/x86_64-linux-gnu/ld-2.30.so() [0x7d40] &gt; /lib/x86_64-linux-gnu/ld-2.30.so() [0xa3a8] &gt; /lib/x86_64-linux-gnu/ld-2.30.so(_dl_rtld_di_serinfo+0x41b5) [0xeb35] &gt; /lib/x86_64-linux-gnu/ld-2.30.so(_dl_catch_exception+0x65) [0x1ca85] &gt; /lib/x86_64-linux-gnu/ld-2.30.so(_dl_rtld_di_serinfo+0x4603) [0xef83] &gt; /lib/x86_64-linux-gnu/ld-2.30.so() [0x3c55] &gt; /lib/x86_64-linux-gnu/ld-2.30.so(__get_cpu_features+0x1e7b) [0x1ba1b] &gt; /lib/x86_64-linux-gnu/ld-2.30.so() [0x203c] &gt; /lib/x86_64-linux-gnu/ld-2.30.so() [0x1108] read(3, "\177ELF\2\1\1\3\0\0\0\0\0\0\0\0\3\0&gt;\0\1\0\0\0\360r\2\0\0\0\0\0"..., 832) = 832 &gt; /lib/x86_64-linux-gnu/ld-2.30.so(_dl_catch_error+0x12f8) [0x1ddc8] &gt; /lib/x86_64-linux-gnu/ld-2.30.so() [0x7d79] &gt; /lib/x86_64-linux-gnu/ld-2.30.so() [0xa3a8] &gt; /lib/x86_64-linux-gnu/ld-2.30.so(_dl_rtld_di_serinfo+0x41b5) [0xeb35] &gt; /lib/x86_64-linux-gnu/ld-2.30.so(_dl_catch_exception+0x65) [0x1ca85] &gt; /lib/x86_64-linux-gnu/ld-2.30.so(_dl_rtld_di_serinfo+0x4603) [0xef83] &gt; /lib/x86_64-linux-gnu/ld-2.30.so() [0x3c55] &gt; /lib/x86_64-linux-gnu/ld-2.30.so(__get_cpu_features+0x1e7b) [0x1ba1b] &gt; /lib/x86_64-linux-gnu/ld-2.30.so() [0x203c] &gt; /lib/x86_64-linux-gnu/ld-2.30.so() [0x1108] ...    ... brk(NULL) = 0x558936ded000 &gt; /lib/x86_64-linux-gnu/libc-2.30.so(brk+0xb) [0x11755b] &gt; /lib/x86_64-linux-gnu/libc-2.30.so(__sbrk+0x67) [0x117617] &gt; /lib/x86_64-linux-gnu/libc-2.30.so(__default_morecore+0xd) [0x9fd3d] &gt; /lib/x86_64-linux-gnu/libc-2.30.so(thrd_yield+0x2725) [0x9a745] &gt; /lib/x86_64-linux-gnu/libc-2.30.so(thrd_yield+0x3943) [0x9b963] &gt; /lib/x86_64-linux-gnu/libc-2.30.so(thrd_yield+0x3b2b) [0x9bb4b] &gt; /lib/x86_64-linux-gnu/libc-2.30.so(thrd_yield+0x4d9e) [0x9cdbe] &gt; /lib/x86_64-linux-gnu/libc-2.30.so(textdomain+0x740) [0x3be70] &gt; /lib/x86_64-linux-gnu/libc-2.30.so(setlocale+0x1d35) [0x35515] &gt; /lib/x86_64-linux-gnu/libc-2.30.so(setlocale+0xbdf) [0x343bf] &gt; /lib/x86_64-linux-gnu/libc-2.30.so(setlocale+0x215) [0x339f5] &gt; /bin/sleep() [0x25f0] &gt; /lib/x86_64-linux-gnu/libc-2.30.so(__libc_start_main+0xf3) [0x271e3] &gt; /bin/sleep() [0x287e] brk(0x558936e0e000) = 0x558936e0e000 &gt; /lib/x86_64-linux-gnu/libc-2.30.so(brk+0xb) [0x11755b] &gt; /lib/x86_64-linux-gnu/libc-2.30.so(__sbrk+0x91) [0x117641] &gt; /lib/x86_64-linux-gnu/libc-2.30.so(__default_morecore+0xd) [0x9fd3d] &gt; /lib/x86_64-linux-gnu/libc-2.30.so(thrd_yield+0x2725) [0x9a745] &gt; /lib/x86_64-linux-gnu/libc-2.30.so(thrd_yield+0x3943) [0x9b963] &gt; /lib/x86_64-linux-gnu/libc-2.30.so(thrd_yield+0x3b2b) [0x9bb4b] &gt; /lib/x86_64-linux-gnu/libc-2.30.so(thrd_yield+0x4d9e) [0x9cdbe] &gt; /lib/x86_64-linux-gnu/libc-2.30.so(textdomain+0x740) [0x3be70] &gt; /lib/x86_64-linux-gnu/libc-2.30.so(setlocale+0x1d35) [0x35515] &gt; /lib/x86_64-linux-gnu/libc-2.30.so(setlocale+0xbdf) [0x343bf] &gt; /lib/x86_64-linux-gnu/libc-2.30.so(setlocale+0x215) [0x339f5] &gt; /bin/sleep() [0x25f0] &gt; /lib/x86_64-linux-gnu/libc-2.30.so(__libc_start_main+0xf3) [0x271e3] &gt; /bin/sleep() [0x287e] openat(AT_FDCWD, "/usr/lib/locale/locale-archive", O_RDONLY|O_CLOEXEC) = 3 &gt; /lib/x86_64-linux-gnu/libc-2.30.so(__open64_nocancel+0x4c) [0x11679c] &gt; /lib/x86_64-linux-gnu/libc-2.30.so(setlocale+0x1ce9) [0x354c9] &gt; /lib/x86_64-linux-gnu/libc-2.30.so(setlocale+0xbdf) [0x343bf] &gt; /lib/x86_64-linux-gnu/libc-2.30.so(setlocale+0x215) [0x339f5] &gt; /bin/sleep() [0x25f0] &gt; /lib/x86_64-linux-gnu/libc-2.30.so(__libc_start_main+0xf3) [0x271e3] &gt; /bin/sleep() [0x287e] fstat(3, {st_mode=S_IFREG|0644, st_size=8994080, ...}) = 0 &gt; /lib/x86_64-linux-gnu/libc-2.30.so(__fxstat64+0x19) [0x1107b9] &gt; /lib/x86_64-linux-gnu/libc-2.30.so(setlocale+0x1e33) [0x35613] &gt; /lib/x86_64-linux-gnu/libc-2.30.so(setlocale+0xbdf) [0x343bf] &gt; /lib/x86_64-linux-gnu/libc-2.30.so(setlocale+0x215) [0x339f5] &gt; /bin/sleep() [0x25f0] &gt; /lib/x86_64-linux-gnu/libc-2.30.so(__libc_start_main+0xf3) [0x271e3] &gt; /bin/sleep() [0x287e] mmap(NULL, 8994080, PROT_READ, MAP_PRIVATE, 3, 0) = 0x7fc495795000 &gt; /lib/x86_64-linux-gnu/libc-2.30.so(mmap64+0x26) [0x11baf6] &gt; /lib/x86_64-linux-gnu/libc-2.30.so(setlocale+0x1e5d) [0x3563d] &gt; /lib/x86_64-linux-gnu/libc-2.30.so(setlocale+0xbdf) [0x343bf] &gt; /lib/x86_64-linux-gnu/libc-2.30.so(setlocale+0x215) [0x339f5] &gt; /bin/sleep() [0x25f0] &gt; /lib/x86_64-linux-gnu/libc-2.30.so(__libc_start_main+0xf3) [0x271e3] &gt; /bin/sleep() [0x287e] close(3) = 0 &gt; /lib/x86_64-linux-gnu/libc-2.30.so(__close_nocancel+0xb) [0x1165bb] &gt; /lib/x86_64-linux-gnu/libc-2.30.so(setlocale+0x1eab) [0x3568b] &gt; /lib/x86_64-linux-gnu/libc-2.30.so(setlocale+0xbdf) [0x343bf] &gt; /lib/x86_64-linux-gnu/libc-2.30.so(setlocale+0x215) [0x339f5] &gt; /bin/sleep() [0x25f0] &gt; /lib/x86_64-linux-gnu/libc-2.30.so(__libc_start_main+0xf3) [0x271e3] &gt; /bin/sleep() [0x287e] nanosleep({tv_sec=1, tv_nsec=0}, NULL) = 0 &gt; /lib/x86_64-linux-gnu/libc-2.30.so(nanosleep+0x17) [0xe5d17] &gt; /bin/sleep() [0x5827] &gt; /bin/sleep() [0x5600] &gt; /bin/sleep() [0x27b0] &gt; /lib/x86_64-linux-gnu/libc-2.30.so(__libc_start_main+0xf3) [0x271e3] &gt; /bin/sleep() [0x287e] close(1) = 0 &gt; /lib/x86_64-linux-gnu/libc-2.30.so(__close_nocancel+0xb) [0x1165bb] &gt; /lib/x86_64-linux-gnu/libc-2.30.so(_IO_file_close_it+0x70) [0x92fc0] &gt; /lib/x86_64-linux-gnu/libc-2.30.so(fclose+0x166) [0x85006] &gt; /bin/sleep() [0x5881] &gt; /bin/sleep() [0x2d27] &gt; /lib/x86_64-linux-gnu/libc-2.30.so(__libc_secure_getenv+0x127) [0x49ba7] &gt; /lib/x86_64-linux-gnu/libc-2.30.so(exit+0x20) [0x49d60] &gt; /lib/x86_64-linux-gnu/libc-2.30.so(__libc_start_main+0xfa) [0x271ea] &gt; /bin/sleep() [0x287e] close(2) = 0 &gt; /lib/x86_64-linux-gnu/libc-2.30.so(__close_nocancel+0xb) [0x1165bb] &gt; /lib/x86_64-linux-gnu/libc-2.30.so(_IO_file_close_it+0x70) [0x92fc0] &gt; /lib/x86_64-linux-gnu/libc-2.30.so(fclose+0x166) [0x85006] &gt; /bin/sleep() [0x5881] &gt; /bin/sleep() [0x2d4d] &gt; /lib/x86_64-linux-gnu/libc-2.30.so(__libc_secure_getenv+0x127) [0x49ba7] &gt; /lib/x86_64-linux-gnu/libc-2.30.so(exit+0x20) [0x49d60] &gt; /lib/x86_64-linux-gnu/libc-2.30.so(__libc_start_main+0xfa) [0x271ea] &gt; /bin/sleep() [0x287e] exit_group(0) = ? +++ exited with 0 +++ &gt; /lib/x86_64-linux-gnu/libc-2.30.so(_exit+0x36) [0xe5fe6] &gt; /lib/x86_64-linux-gnu/libc-2.30.so(__libc_secure_getenv+0x242) [0x49cc2] &gt; /lib/x86_64-linux-gnu/libc-2.30.so(exit+0x20) [0x49d60] &gt; /lib/x86_64-linux-gnu/libc-2.30.so(__libc_start_main+0xfa) [0x271ea] &gt; /bin/sleep(+0x0) [0x287e]</code> </pre> </div></div><br><p style=";text-align:right;direction:rtl">  ุตุญูุญ ุ ูุง ูุชู ุนุฑุถ ุฃุณูุงุก ุงููููุงุช ุงููุตุฏุฑ ูุฃุฑูุงู ุงูุฃุณุทุฑ ููุง.  <code>addr2line</code> (ุฅุฐุง ูุงูุช ูุฐู ุงููุนูููุงุช ููุฌูุฏุฉ ูู ุญูุซ ุงููุจุฏุฃ ุ ุจุงูุทุจุน). </p><br><p style=";text-align:right;direction:rtl">  ููุงู ุณุคุงู ุซุงูู: ุจุนุถ ููุงููุงุช ุงููุธุงู ูุง ุชุญุชูู ุนูู ุฃุบููุฉ ูู <code>libc</code> .  ุจุนุฏ ุฐูู ููููู ุงุณุชุฎุฏุงู ุงููุฌูุน ุงูุดุงูู ุงููุณูู <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u="><code>syscall</code></a> : </p><br><pre style=";text-align:right;direction:rtl"> <code class="cpp hljs"> syscall(SYS_kcmp, getpid(), getpid(), KCMP_FILE, <span class="hljs-number"><span class="hljs-number">1</span></span>, fd)</code> </pre> <br><h2 id="fayl-----eto-ochen-uzh-strannyy-predmet" style=";text-align:right;direction:rtl">  ุงูููู ุดูุก ุบุฑูุจ ุฌุฏุง ... </h2><br><p style=";text-align:right;direction:rtl">  ููุณุช ููุงููุงุช ุงููุธุงู ูุฌุฑุฏ ูุณููุฉ ูุทูุจ ุงูููุงุฉ ุงููุตูู ุฅูู ุงูุฌูุงุฒ ููุงุจุฉ ุนู ุงูุนูููุฉ.  ุฅููุง ุฃูุถูุง ูุงุฌูุฉ ุจุฑูุฌุฉ ุชุทุจููุงุช ุนุงูููุฉ ูููููุฉ ูุฌููุน ุงูููุชุจุงุช ูู ุงููุธุงู.  ูุฐูู ุ ุฅุฐุง ูุงูุช ุงููุธููุฉ ุงูุชู ุชุญุชุงุฌูุง ุบูุฑ ูุฏุนููุฉ ูู ุงูููุชุจุฉ ุ ูุณุชุนูู ุนูู ุงูุฃุฑุฌุญ ุชููุงุฆููุง ุฅุฐุง ุทูุจุช ุงูููุงุฉ ุจุดูู ุตุญูุญ.  ุจุงูุฅุถุงูุฉ ุฅูู ุฐูู ุ ูุชู ุชูุฑูุซ ุฌุฒุก ูู "ุงูุฅุนุฏุงุฏุงุช" ููุนูููุฉ ุจูุงุณุทุฉ <code>execve</code> ุ ูุฐูู ููููู ูุญุงููุฉ ุงูููุงู ุจุฐูู ุฏูู ุนูุงุฒุงุช ูุนูุฏุฉ ุจูุฌุฑุฏ ุชุดููู ุงูุญุงูุฉ ุจุดูู ุตุญูุญ ูุจู ุจุฏุก ุงูุนูููุฉ (ุดูุก ูุซู "ููุงุฐุง ููู <code>stderr</code> ูุฏูููุง ุฅูู ููู ุ ุฅุฐุง ูุงู ููููู ููุท ูุชุญ ุงูููู ูุงูููุงู ุจุฐูู ูู FD # 2 ููุนูููุฉ ุงููุฑุนูุฉ "). </p><br><p style=";text-align:right;direction:rtl">  ูุฑุฉ ูุงุญุฏุฉ ุ ููุช ุจุญุงุฌุฉ ูุทุฑุญ ุณูุณูุฉ ูู ุญุฒู ุงูุดุจูุฉ ูู ููู.  ูู ูุฑุญูุฉ ูุง ุ ุชุฌุงูุฒ ุนุฏุฏ ุงูุนูุงุฒุงุช ุฌููุน ุงูุญุฏูุฏ ุงููุนูููุฉ ุ ููุฑุฑุช ุฃูู ูู ุบูุฑ ุงููุฑุฌุญ ุฃู ูููู <code>libpcap</code> ุฃูุซุฑ ุชุนููุฏูุง ููุง ูุชุจุช ุ ุนูุงูุฉ ุนูู ุฐูู ุ ูุงู ูุฐุง ูู ุงููุนูุงุฑ ุ ููุงูุช ููุงู ุฃุฏูุงุช ููุจููุฉ ุนููููุง ููุชุญ ูุฐู ุงููููุงุช.  ุงุชุถุญ ุฃู ุงุณุชุฎุฏุงู <code>libpcap</code> ููุฑุงุกุฉ ุงูููุงูุจ ูุนุฏ ุฃูุฑูุง ุตุนุจูุง ูุซู <code>fopen</code> ููุฑุงุกุฉ ุงููููุงุช: ููููู ุจุจุณุงุทุฉ ูุชุญ ููู ุงูุชูุฑูุบ ุจุงุณุชุฎุฏุงู <code>pcap_(f)open_offline</code> ุงูุญุฒู ูู ุฎูุงู <code>pcap_next_ex</code> .  ูุฐุง ูู ุดุฆ!  ุญุณููุง ุ ูุง ุฒุงู ุงูุฃูุฑ ูุณุชุญู ุฅุบูุงู ุงูุชูุฑูุบ ุนูุฏ ุงูุงูุชูุงุก ูู ุงูุนูู ... </p><br><p style=";text-align:right;direction:rtl">  ูููู ููุง ุชููู ุงููุดููุฉ: ูุจุฏู ุฃู <code>libpcap</code> ูุง ููููู ุงููุฑุงุกุฉ ูู ุงูุฐุงูุฑุฉ.  ุฑุจูุง ูุณุชุทูุน ุ ุจุทุจูุนุฉ ุงูุญุงู ุ ุฅุฐุง ุจุญุซุช ููู ุ ูููู ุจุงููุณุจุฉ ูู "ูุฎุชุจุฑูุง" ุ ุณูุชุฎูู ุฃูู ูุง ูุณุชุทูุน ุฐูู. </p><br><p style=";text-align:right;direction:rtl">  ุนูู ุณุจูู ุงููุซุงู ุ ูุซุงู ุนูู ุฐูู: ูุญู ููุชุธุฑ <code>stdin</code> ูุณูุณูุฉ ูู ุงูุจุงูุชุงุช ุ ูุจุนุฏ ุฐูู ููุฌุฏ ุชูุฑูุบ ูุญุงุฐู ุจูุงุณุทุฉ 4 ุจุงูุช.  ุฃุฏุฑู ุฃูู ููููู ุงุณุชุฎุฏุงู ุงููุฏุฎูุงุช ุงููุฎุฒูุฉ ูุคูุชูุง ูุจุนุถ <code>ungetc</code> (ูุธุฑูุง ูุฃู <code>libpcap</code> ูุง ูุฒุงู ูุชุทูุจ <code>FILE *</code> ) ุ ูููู ูู ุงูุญุงูุฉ ุงูุนุงูุฉ ุ ูููููุง ูููุง ุฃุซูุงุก ุงูุชููู ุ ุนูู ุณุจูู ุงููุซุงู ุ ุฃู ูููู ููููุชุจุฉ ุงูุนูู ูุจุงุดุฑุฉ ูุน <code>read</code> / <code>write</code> . </p><br><h3 id="reshenie-1-memfd_create" style=";text-align:right;direction:rtl">  ุงูุญู 1: memfd_create </h3><br><p style=";text-align:right;direction:rtl">  ููุงููุฉ ุงููุธุงู <code>memfd_create</code> ุชุณูุญ <code>memfd_create</code> ุจุฅูุดุงุก ูุงุตู ููู "ูุฌูููุฉ ุนููููุง".  ุงูููู ููุฌูุฏ ูู ุงูุฐุงูุฑุฉ ููู ููุฌูุฏ ุจูููุง ูููู ููุงู ูุงุตู ูุงุญุฏ ุนูู ุงูุฃูู ููุชูุญูุง ุนููู.  ูู ุฃุจุณุท ุงูุญุงูุงุช ุ ููููู ููุท ุงูุญุตูู ุนูู ูุซู ูุฐุง ุงููุงุตู ุ ูุชุงุจุฉ ุงูุจูุงูุงุช ุฅููู ูู ุฎูุงู <code>write</code> ุ ุงูุชุฑุฌูุน <code>lseek</code> ุ ููุน <code>lseek</code> ุฏุน <code>libc</code> ูุนุฑู ุนูู: </p><br><pre style=";text-align:right;direction:rtl"> <code class="cpp hljs"> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> fd = memfd_create(<span class="hljs-string"><span class="hljs-string">"pcap-dump-contents"</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>); write(fd, buf, length); lseek(fd, <span class="hljs-number"><span class="hljs-number">0</span></span>, SEEK_SET); FILE *file = fdopen(fd, <span class="hljs-string"><span class="hljs-string">"r"</span></span>);</code> </pre> <br><p style=";text-align:right;direction:rtl">  ุณูุชู ุนุฑุถ ุงุณู ุงูููู ุงูุฐู ุชู ุชูุฑูุฑู ุจุงุณุชุฎุฏุงู ุงููุณูุทุฉ ุงูุฃููู ูู ุงุฑุชุจุงุท ูู <code>/proc/&lt;PID&gt;/fd</code> : </p><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">$ ls -l /proc/31747/fd  0 lr-x------ 1 trosinenko trosinenko 64  10 13:12 0 -&gt; /path/to/128test.pcap lrwx------ 1 trosinenko trosinenko 64  10 13:12 1 -&gt; /dev/pts/17 lrwx------ 1 trosinenko trosinenko 64  10 13:12 2 -&gt; /dev/pts/17 lrwx------ 1 trosinenko trosinenko 64  10 13:12 23 -&gt; '/home/trosinenko/.cache/appstream-cache-AH3OA0.mdb (deleted)' lrwx------ 1 trosinenko trosinenko 64  10 13:12 3 -&gt; '/memfd:pcap-dump-contents (deleted)' lrwx------ 1 trosinenko trosinenko 64  10 13:12 57 -&gt; 'socket:[41036]'</code> </pre> <br><h3 id="reshenie-2-open-s-flagom-o_tmpfile" style=";text-align:right;direction:rtl">  ุงูุญู 2: ูุชุญ ุจุงุณุชุฎุฏุงู ุนูุงูุฉ O_TMPFILE </h3><br><p style=";text-align:right;direction:rtl">  ุนูู ูุธุงู Linux ุ ุจุฏุกูุง ูู ุฅุตุฏุงุฑ ุ ุนูุฏ ุฅูุดุงุก ููู ุ ููููู <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u="><code>  O_TMPFILE</code></a> ูุงุณู ุงูุฏููู ุจุฏูุงู ูู ุงุณู ุงูููู.  ูุชูุฌุฉู ูุฐูู ุ ูุจุฏู ุฃู ุงูููู ุ ูุญุฑู ุฃุฏุจู ูุงุญุฏ ูุณุชุฎุฏู ูู ุงูููู (ุชูุฑูุจูุง) ุ <em>ููุฌูุฏ ุ ูููู ุบูุฑ ููุฌูุฏ</em> ... ูุง ุฃุนุฑู ุฅุฐุง ูุง ูุงูุช ุงูุจูุงูุงุช ููุชูุจุฉ ุนูู ุงููุฑุต ุ ููู ูู ุงููุญุชูู ุฃู ูุนุชูุฏ ุนูู ูุธุงู ุงููููุงุช (ุจุงูููุงุณุจุฉ ุ ูุฌุจ ุฃู ูุฏุนู ูุฐุง ุงููุถุน) .  ูุง ูุฒุงู ุงูููู ูุฎุชูู ุนูุฏ ุฅุบูุงู ุงูุฑุงุจุท ุงูุฃุฎูุฑ ุ ูููู ูููู ุฅุฑูุงูู ุจุดุฌุฑุฉ ุงูุฏููู ุจุงุณุชุฎุฏุงู <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u="><code>linkat</code></a> : </p><br><pre style=";text-align:right;direction:rtl"> <code class="cpp hljs"> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> fd = open(<span class="hljs-string"><span class="hljs-string">"."</span></span>, O_RDWR | O_TMPFILE, S_IRUSR | S_IWUSR); assert(fd != <span class="hljs-number"><span class="hljs-number">-1</span></span>); assert(write(fd, buffer + offset, len - offset) == len - offset); assert(lseek(fd, <span class="hljs-number"><span class="hljs-number">0</span></span>, SEEK_SET) == <span class="hljs-number"><span class="hljs-number">0</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> *link_to = getenv(<span class="hljs-string"><span class="hljs-string">"LINK_TO"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (link_to != <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> path[<span class="hljs-number"><span class="hljs-number">128</span></span>]; <span class="hljs-built_in"><span class="hljs-built_in">snprintf</span></span>(path, <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(path), <span class="hljs-string"><span class="hljs-string">"/proc/self/fd/%d"</span></span>, fd); linkat(AT_FDCWD, path, AT_FDCWD, link_to, AT_SYMLINK_FOLLOW); }</code> </pre> <br><p style=";text-align:right;direction:rtl">  ุจุงูุฅุถุงูุฉ ุฅูู ูุฑุตุฉ ุนุฏู ุงูุชุนุฑุถ ูุชุณููุฉ ุงูููู ุ ูุฅูู ูุฌุนู ูู ุงููููู ููุก ุงูููู ุ ูุชูููู ุงูุญููู ุ ููุง ุฅูู ุฐูู ุ ุซู ุงูุงุฑุชุจุงุท ุฐุฑููุง ุจุดุฌุฑุฉ ุงูุฏููู. </p><br><div class="spoiler" style=";text-align:right;direction:rtl">  <b class="spoiler_title">ูุซุงู (ูููุง ุงูููุฌูู)</b> <div class="spoiler_text" style=";text-align:right;direction:rtl"><pre style=";text-align:right;direction:rtl"> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> _GNU_SOURCE #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">ifdef</span></span></span><span class="hljs-meta"> NDEBUG </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">//    assert  -   # undef NDEBUG #endif #include &lt;sys/mman.h&gt; #include &lt;unistd.h&gt; #include &lt;stdio.h&gt; #include &lt;stdlib.h&gt; #include &lt;assert.h&gt; #include &lt;signal.h&gt; #include &lt;sys/types.h&gt; #include &lt;sys/stat.h&gt; #include &lt;fcntl.h&gt; #include &lt;pcap.h&gt; //     PCAP (   -- . ) static const uint32_t pcap_mgc = 0xA1B2C3D4; char buffer[1 &lt;&lt; 20]; int main() { int len = read(0, buffer, sizeof(buffer)); //  -      "", //     pcap_mgc,   //   4  .   ... int offset = -1; for (int i = 0; i &lt; len; i += 4) { if (*(uint32_t *)(buffer + i) == pcap_mgc) { offset = i; break; } } if (offset &gt;= 0) { printf("Found PCAP dump at offset %d\n", offset); } else { fprintf(stderr, "No PCAP dump found.\n"); exit(1); } //   ,  libpcap ,   //   . #if 0 int fd = memfd_create("pcap-dump-contents", 0); assert(fd != -1); assert(write(fd, buffer + offset, len - offset) == len - offset); assert(lseek(fd, 0, SEEK_SET) == 0); #else int fd = open(".", O_RDWR | O_TMPFILE, S_IRUSR | S_IWUSR); assert(fd != -1); assert(write(fd, buffer + offset, len - offset) == len - offset); assert(lseek(fd, 0, SEEK_SET) == 0); const char *link_to = getenv("LINK_TO"); if (link_to != NULL) { char path[128]; snprintf(path, sizeof(path), "/proc/self/fd/%d", fd); linkat(AT_FDCWD, path, AT_FDCWD, link_to, AT_SYMLINK_FOLLOW); } #endif raise(SIGSTOP); //    /proc/PID/fd/ //      - ... FILE *file = fdopen(fd, "r"); char errbuf[PCAP_ERRBUF_SIZE]; pcap_t * dump = pcap_fopen_offline(file, errbuf); assert(dump != NULL); struct pcap_pkthdr *hdr; const uint8_t *data; while (pcap_next_ex(dump, &amp;hdr, &amp;data) == 1) { printf("Read packet: full length = %d bytes, available %d bytes.\n", hdr-&gt;len, hdr-&gt;caplen); } return 0; }</span></span></span></span></code> </pre> <br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">$ fallocate -l 128 zero128 $ cat zero128 test.pcap &gt; 128test.pcap $ ./memfd &lt; 128test.pcap Found PCAP dump at offset 128 Read packet: full length = 105 bytes, available 105 bytes. Read packet: full length = 105 bytes, available 105 bytes. Read packet: full length = 66 bytes, available 66 bytes. Read packet: full length = 385 bytes, available 385 bytes. Read packet: full length = 66 bytes, available 66 bytes. ...</code> </pre> </div></div><br><h2 id="userfaultfd-obrabotka-oshibok-pamyati-v-userspace" style=";text-align:right;direction:rtl">  userfaultfd: ูุนุงูุฌุฉ ุฃุฎุทุงุก ุงูุฐุงูุฑุฉ ูู userpace </h2><br><p style=";text-align:right;direction:rtl">  ุฃุนุชูุฏ ุฃูู ูู ูููู ููุงู ุดูุก ุฌุฏูุฏ ุฌุฏูุง ูู ุงูููู ุฅูู ูู ุงูุฃูุธูุฉ ุงููุดุงุจูุฉ ูู UNIX ุ ูุง ุชุดูุฑ ูุงุตูุงุช ุงููููุงุช ุฅูู ุฃู ุดูุก.  ุนูู ุณุจูู ุงููุซุงู ุ ุนูู Linux ุ ูููู ุฃู ูููู ูุฃุฎุฐ ุชูุตูู ุฃู ุชูุฌูู ุฅุฎุฑุงุฌ ุฃู eventfd ุฃู ุญุชู ุฑุงุจุทูุง ูุจุฑูุงูุฌ ebpf.  ูููู ุฑุจูุง ูุง ูุฒุงู ูุฐุง ุงููุซุงู ููุงุฌุฃุฉ ูู.  ูู ุจุฏุงูุฉ ุงูููุงู ุชุญุฏุซุช ุนู ุญูููุฉ ุฃู ุฃุฎุทุงุก ุงูุตูุญุงุช ูู ุฃูุฑ ุดุงุฆุน ุจุงููุณุจุฉ ููููุงุฉ: ุชุจุงุฏู ุ ูุณุฎ ุนูู ุ ูุฐุง ูู ุดูุก ... ุนูุฏูุง "ุชููุช" ุนูููุฉ ุงููุณุชุฎุฏู ุ ูุชู ุฅุฑุณุงู SIGSEGV ุฅูููุง.  ุนูู ุญุฏ ุนููู ุ ูุฅู ุฅุนุงุฏุฉ ุงูุชุญูู ูู ูุนุงูุฌ SIGSEGV ุงูุฐู ุชู ุฅูุดุงุคู ุจูุงุณุทุฉ kernel ูู ุณููู ุบูุฑ ูุญุฏุฏ ุ ููุน ุฐูู ุ ุชูุฌุฏ ููุชุจุฉ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">GNU libsigsegv</a> ุงูุชู ุชุนูู ุนูู ุชุนููู ููุฒุงุช ูุนุงูุฌุฉ ุฃุฎุทุงุก ุงููุตูู ุฅูู ุงูุฐุงูุฑุฉ ุนูู ุงูุนุฏูุฏ ูู ุงูุฃูุธูุฉ ุงูุฃุณุงุณูุฉ ุ ุญุชู Windows <strong>(ATTENTION: GPL license ุ ุฅู ูู ุชูู ุฌุงูุฒุฉ ูู ุชูุฒูุน ุงูุจุฑูุงูุฌ ุงูุฎุงุต ุจู ุ ูุง ุชุณุชุฎุฏู libsigsegv)</strong> .  ููุฐ ููุช ููุณ ุจุจุนูุฏ ุ ุธูุฑุช ุทุฑููุฉ ููุซูุฉ ุจุงููุงูู ูู Linux ุ ุชุณูู <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u="><code>userfaultfd</code></a> : ุจุงุณุชุฎุฏุงู ุงุณุชุฏุนุงุก ุงููุธุงู ุงูุฐู ูุญูู ููุณ ุงูุงุณู ุ ููููู ูุชุญ ูุงุตู ูููููุงุช ุ ูุงููุฑุงุกุฉ ูุงููุชุงุจุฉ ุงูุชู ุชุนุฏ ุงูููุงูู ุงูุฎุงุตุฉ ุฃูุงูุฑ ููุง. </p><br><p style=";text-align:right;direction:rtl">  ุจุงุณุชุฎุฏุงู ูุงุตู ุงููููุงุช ูุฐุง ุ ููููู ูุถุน ุนูุงูุฉ ุนูู ูุฌููุนุฉ ูู ุงูุนูุงููู ุงูุงูุชุฑุงุถูุฉ ูุนูููุฉ ุงูุฎุงุต ุจู.  ุจุนุฏ ุฐูู ุ ุนูุฏ ุฃูู ูุตูู ุฅูู ูู ุตูุญุฉ ูู ุตูุญุงุช ุงูุฐุงูุฑุฉ ุ ุณูุบูู ุงูุชุฏูู ุ ูุณุชุนูุฏ ุงููุฑุงุกุฉ ูู ูุงุตู ุงูููู ุฅูู ูุนูููุงุช ุญูู ูุง ุญุฏุซ.  ุจุนุฏ ุฐูู ุ ุณูู ูููู ุงููุนุงูุฌ ุจููุก ุจููุฉ ุงูุงุณุชุฌุงุจุฉ ุจูุคุดุฑ ููุจูุงูุงุช ุงูุชู ูุฌุจ ุงุณุชุฎุฏุงููุง ูุชููุฆุฉ ุตูุญุฉ "ุงููุดููุฉ" ุ ูุณุชููู ุงูููุงุฉ ุจุชููุฆุชูุง ูุงุณุชููุงุธ ุงูุฎูุท ุงูุฐู ุชุญูู.  ูู ูุฐู ุงูุญุงูุฉ ุ ูููุชุฑุถ ูุฌูุฏ ุฏูู ูููุตู ุ ุชุชุถูู ูุงุฌุจุงุชู ุฃูุงูุฑ ุงููุฑุงุกุฉ ูู ุงููุงุตู ูุฅุตุฏุงุฑ ุงูุฅุฌุงุจุงุช.  <em>ุจุดูู ุนุงู ุ ูููู <code>userfaultfd</code> ุงูุญุตูู ุนูู ูุนูููุงุช ุฃุฎุฑู ูู ุฎูุงู <code>userfaultfd</code> ุ ุนูู ุณุจูู ุงููุซุงู ุ ุจุนุถ ุงูุฅุนูุงูุงุช ุญูู ุชุบููุฑ ุงูุจุทุงูุฉ ุงูุงูุชุฑุงุถูุฉ ููุนูููุฉ.</em> </p><br><div class="spoiler" style=";text-align:right;direction:rtl">  <b class="spoiler_title">ูุซุงู ููุงุณุชุฎุฏุงู</b> <div class="spoiler_text" style=";text-align:right;direction:rtl"><pre style=";text-align:right;direction:rtl"> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> _GNU_SOURCE #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">ifdef</span></span></span><span class="hljs-meta"> NDEBUG </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">//    assert  -   # undef NDEBUG #endif #include &lt;linux/userfaultfd.h&gt; #include &lt;syscall.h&gt; #include &lt;sys/mman.h&gt; #include &lt;sys/ioctl.h&gt; #include &lt;unistd.h&gt; #include &lt;pthread.h&gt; #include &lt;assert.h&gt; #include &lt;stdint.h&gt; #include &lt;stdio.h&gt; #include &lt;stdlib.h&gt; #include &lt;string.h&gt; // -,   sysconf... #define PAGE_SIZE 4096 #define PAGE_MASK (PAGE_SIZE - 1) static void *thread_fn(void * arg) { int uffd = (intptr_t)arg; struct uffd_msg msg; // ,    hugepages... uint8_t *replacement_page = mmap(NULL, PAGE_SIZE, PROT_READ | PROT_WRITE, MAP_PRIVATE | MAP_ANONYMOUS, -1 ,0); while(1) { assert(read(uffd, &amp;msg, sizeof msg) &gt; 0); //    ,    if (msg.event == UFFD_EVENT_PAGEFAULT) { uintptr_t addr = msg.arg.pagefault.address; fprintf(stderr, "Fault: addr = 0x%zx\n", addr); //       uint8_t *page_addr = (uint8_t *)((uintptr_t)addr &amp; ~PAGE_MASK); //  "" ,  ""! memset(replacement_page, 0xAB, PAGE_SIZE); //     struct uffdio_copy copy; copy.src = (uintptr_t)replacement_page; copy.dst = (uintptr_t)page_addr; copy.mode = 0; // ,  --   copy.copy = 0; //   --      copy.len = PAGE_SIZE; assert(ioctl(uffd, UFFDIO_COPY, &amp;copy) != -1); } } } static int init_userfaultfd(void) { //   int uffd = syscall(__NR_userfaultfd, 0); // ,       struct uffdio_api api; api.api = UFFD_API; api.features = 0; assert(ioctl(uffd, UFFDIO_API, &amp;api) != -1); fprintf(stderr, "UFFD open\n"); //  - pthread_t thread; memset(&amp;thread, 0, sizeof(thread)); // ...    int  void *? pthread_create(&amp;thread, 0, thread_fn, (void *)(intptr_t)uffd); return uffd; } static void register_region(int uffd, void * aligned_addr, size_t size) { struct uffdio_register reg; memset(&amp;reg, 0, sizeof reg); reg.range.start = (uintptr_t)aligned_addr; reg.range.len = size; reg.mode = UFFDIO_REGISTER_MODE_MISSING; assert (ioctl(uffd, UFFDIO_REGISTER, &amp;reg) != -1); } int main() { void *addr = mmap(NULL, PAGE_SIZE, PROT_READ | PROT_WRITE, MAP_PRIVATE | MAP_ANONYMOUS, -1, 0); int uffd = init_userfaultfd(); register_region(uffd, addr, PAGE_SIZE); fprintf(stderr, "Before reading\n"); fprintf(stderr, "Data at %p: %x\n", addr, *(volatile int *)addr); return 0; }</span></span></span></span></code> </pre> <br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">$ ./userfaultfd UFFD open Before reading Fault: addr = 0x7f46f40d5000 Data at 0x7f46f40d5000: abababab</code> </pre> </div></div><br><h2 id="laquoklyuchevoy-vopros-matematiki-ne-vsyo-li-ravnoraquo-c" style=";text-align:right;direction:rtl">  "ุงูุณุคุงู ุงูุฃุณุงุณู ููุฑูุงุถูุงุช: ูู ูู ูู ููุณุ" ยฉ </h2><br><p style=";text-align:right;direction:rtl">  ูุงุฐุง ูู ููุช ุจุญุงุฌุฉ ููุนุฑูุฉ ูุง ุฅุฐุง ูุงู ูุงุตู ุงูููู ูุฐุง ูุดูุฑ ุฅูู <code>stdin</code> ุ  ูุจุฏู ุฃูู <code>if (fd == 0) ...</code> - ููุฐุง ูู ุดูุก.  ุญุณูุง ุ ุญุณูุง ... </p><br><pre style=";text-align:right;direction:rtl"> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> _GNU_SOURCE #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;unistd.h&gt; #include &lt;stdio.h&gt; int main() { int fd = dup(0); printf("stdin is fd %d, too\n", fd); if (fd == 0) printf("stdin"); else printf("not stdin"); return 0; }</span></span></span></span></code> </pre> <br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">$ gcc kcmp.c -o kcmp $ ./kcmp stdin is fd 3, too not stdin</code> </pre> <br><p style=";text-align:right;direction:rtl">  ุนูููุง ... ุงูููุจุถ ูุดุจู ููุนูุง ูุง ุ ููู ุงูุฃุณูุงุก ุงููุณุชุนุงุฑุฉ ูุฎุชููุฉ.  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">CRIU</a> - ููุทุฉ ุชูุชูุด / ุงุณุชุนุงุฏุฉ ูู Userspace <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">ุณุชุณุงุนุฏูุง</a> .  ,     ,      .     userspace-,    ,   ,      <code>kcmp</code> :    PID,   , ,  ,   ,          : </p><br><pre style=";text-align:right;direction:rtl"> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> _GNU_SOURCE #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;linux/kcmp.h&gt; #include &lt;syscall.h&gt; #include &lt;unistd.h&gt; #include &lt;stdio.h&gt; int main() { int fd = dup(0); printf("stdin is fd %d, too\n", fd); int pid = getpid(); if (syscall(SYS_kcmp, pid, pid, KCMP_FILE /*    _FILES! */, 0 /* stdin fd */, fd) == 0) printf("stdin\n"); else printf("not stdin\n"); if (syscall(SYS_kcmp, pid, pid, KCMP_FILE, 1 /* stdout fd */, fd) == 0) printf("stdout\n"); else printf("not stdout\n"); return 0; }</span></span></span></span></code> </pre> <br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">$ ./kcmp stdin is fd 3, too stdin stdout</code> </pre> <br><p style=";text-align:right;direction:rtl">   !  ,   ... </p><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">$ ls -l /proc/self/fd  0 lrwx------ 1 trosinenko trosinenko 64  10 14:45 0 -&gt; /dev/pts/17 lrwx------ 1 trosinenko trosinenko 64  10 14:45 1 -&gt; /dev/pts/17 lrwx------ 1 trosinenko trosinenko 64  10 14:45 2 -&gt; /dev/pts/17 lrwx------ 1 trosinenko trosinenko 64  10 14:45 23 -&gt; '/home/trosinenko/.cache/appstream-cache-AH3OA0.mdb (deleted)' lr-x------ 1 trosinenko trosinenko 64  10 14:45 3 -&gt; /proc/17265/fd lrwx------ 1 trosinenko trosinenko 64  10 14:45 57 -&gt; 'socket:[41036]'</code> </pre> <br><p style=";text-align:right;direction:rtl"> ,   ,   ,  ,       .  ,  bash        ,    <code>ls</code> ! </p><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">$ ./kcmp &lt; kcmp.c stdin is fd 3, too stdin not stdout</code> </pre> <br><p style=";text-align:right;direction:rtl">   ,       โ         -,   best effort   -    . </p><br><h2 id="obo-vsyom-i-ponemnozhku" style=";text-align:right;direction:rtl">     </h2><br><p style=";text-align:right;direction:rtl">   , ... </p><br><ul style=";text-align:right;direction:rtl"><li style=";text-align:right;direction:rtl"> โฆ      JIT-    userspace?  ,         <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u="> eBPF-</a> .       ,  ( ,   ,      -)  . .,    JIT-,  . ,      , BPF. </li><li style=";text-align:right;direction:rtl"> โฆ        ?  ,      <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u="><code>sigaltstack</code></a> . </li><li style=";text-align:right;direction:rtl"> โฆ       ,     : <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u="><code>readahead</code></a> </li></ul><br><p style=";text-align:right;direction:rtl">           <code>oldolduname</code> ... </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/ar475184/">https://habr.com/ru/post/ar475184/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ar475172/index.html">5 ุทุฑู ูุงุณุชุฎุฏุงู ุงูุชูุช ุจู ูููุฏ ุงูุฌุฒุก ุงูุซุงูุซ</a></li>
<li><a href="../ar475174/index.html">ููู ุชููุน ุนูู ุงูุจุทุงุฑูุงุช ุฃู ูุธุฑูุฉ ููููุง ูู paramotor ุงูููุฑุจุงุฆูุฉ. ุงูุฌุฒุก 1</a></li>
<li><a href="../ar475178/index.html">ุงุณุชุจุฏุงู EAV ูุน JSONB ูู ุจูุณุชุฌุฑุณ</a></li>
<li><a href="../ar475180/index.html">ููู ุชููุน ุนูู ุงูุจุทุงุฑูุงุช ุฃู ููุงุฑุณุฉ ุชุดุบูู paramotor ุงูููุฑุจุงุฆูุฉ SkyMax. ุงูุฌุฒุก 2</a></li>
<li><a href="../ar475182/index.html">ููู ูุฑุฑุช ูุณุงุจูุฉ ุชุนูู ุงูุขูุฉ ุงูุดุจููุฉ ุจุงูุจูุงูุงุช</a></li>
<li><a href="../ar475188/index.html">ุฎูุงุฑุฒููุฉ ููุถุน ุงูุชุฌุงูุจ ุงููุงุฆูุฉ ุนูู ุงูููุฏ</a></li>
<li><a href="../ar475192/index.html">ููู ุชุฌุฏ ูุธููุฉ ูู ุดุฑูุฉ ุชุณุงุนุฏ ูู ููุงูุญุฉ ุธุงูุฑุฉ ุงูุงุญุชุจุงุณ ุงูุญุฑุงุฑูุ</a></li>
<li><a href="../ar475194/index.html">ูุชุงุจุฉ ุงูุชูุฑุงุฑ ุจูุงุณุทุฉ SOLID</a></li>
<li><a href="../ar475196/index.html">ููุฎุต ุงูููุงุฏ ุงููุซูุฑุฉ ููุงูุชูุงู ููุทูุฑ ุงูุฌูุงู ุฑูู 321 (ูู 4 ุฅูู 10 ููููุจุฑ)</a></li>
<li><a href="../ar475200/index.html">ุฃุฎุจุงุฑ ูู ุฎุฑูุทุฉ ุงูุดุงุฑุน ุงูููุชูุญ ุฑูู 484 (10.22.2019 - 28.10.2019)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>