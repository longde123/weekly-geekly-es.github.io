<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üïå üöÅ üóíÔ∏è N√≥s perfilamos o carregamento do Habr ou como 189 solicita√ß√µes na p√°gina tornam a influ√™ncia üçï ‚ôçÔ∏è üóº</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="H√° algum tempo, me interessei pelo desempenho do site, pelas otimiza√ß√µes de download e similares. E agora, mais uma vez indo ao Habr, pensei que estav...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>N√≥s perfilamos o carregamento do Habr ou como 189 solicita√ß√µes na p√°gina tornam a influ√™ncia</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/454444/"><p><img src="https://habrastorage.org/webt/dg/5m/ab/dg5mabkefi6xhfiovvydhay2fkw.jpeg" alt="Tomo suco de cereja grosso"></p><br><p>  H√° algum tempo, me interessei pelo desempenho do site, pelas otimiza√ß√µes de download e similares.  E agora, mais uma vez indo ao Habr, pensei que estava acostumado a perceber um carregamento de recursos bastante r√°pido como um dado, sem sequer pensar em como isso foi alcan√ßado.  Por isso, decidi combinar neg√≥cios com prazer - para ver como est√£o as coisas com o desempenho da Habr e quais solu√ß√µes t√©cnicas foram feitas para otimiz√°-lo. </p><br><p>  Para aqueles que est√£o interessados ‚Äã‚Äãem saber o que foi feito para que possamos receber o conte√∫do o mais r√°pido poss√≠vel e como √© o download do Habr da Argentina - por favor, abaixo do gato. </p><a name="habracut"></a><br><h2 id="podgotovka">  Prepara√ß√£o </h2><br><p>  Precisamos de uma vers√£o nova do Chrome / Canary funcionando no modo an√¥nimo (verifique se todas as extens√µes est√£o desativadas).  Al√©m disso, no Developer Console (Developer Tools - F12), na guia rede, voc√™ deve definir o sinalizador de desativar cache, porque  <strong>Vamos tra√ßar o perfil apenas da primeira inicializa√ß√£o, embora ainda n√£o haja recursos no cache.</strong> </p><br><h2 id="etap-pervyy---po-verham">  Est√°gio Um - "No andar de cima" </h2><br><p>  O principal objetivo desta parte √© familiarizar-se com o site como um todo, entender sua estrutura e descobrir quais recursos espec√≠ficos ele precisa. </p><br><p>  Abrimos as ferramentas do desenvolvedor, acessamos a guia rede, abrimos o site e, na parte inferior da guia, analisamos as estat√≠sticas de uso da rede: </p><br><p><img src="https://habrastorage.org/webt/ni/fs/yb/nifsybxewz18qswerh5jubfsn1a.png" alt="E uma capa de uma m√£e branca."></p><br><p>  Todo o site foi carregado em 2,02 segundos, o que parece √≥timo (considerando a carga do Habr).  O evento <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">DomContentLoaded</a> (daqui em diante simplesmente DCL) geralmente apareceu em 1,01 segundos, o que parece ainda melhor.  Com tudo isso, o site faz 189 solicita√ß√µes e carrega 9,6MB de recursos.  Isso nos diz que ou a equipe Habra √© um g√™nio (pode muito bem ser), e o artigo deve ser finalizado aqui (e pe√ßa para a equipe tomar caf√© e biscoitos), ou lembre-se de que eu tenho um canal de 100 Mb / s e o Core I7 .  I.e.  voc√™ precisa se aproximar um pouco da realidade e, pelo menos, limitar a largura do canal. </p><br><p>  Ativamos o modo 3G R√°pido e olhamos novamente: </p><br><p><img src="https://habrastorage.org/webt/bp/ov/lk/bpovlkvte1ojvmuamwcoki4uniq.png" alt="Despeje delicadamente o suco na capa -"></p><br><p>  O DCL piorou para 3,48 segundos, o que ainda √© razoavelmente aceit√°vel.  Mas finalmente o site carregou em ateus 54,76 segundos.  Agora tudo est√° l√≥gico - voc√™ n√£o pode baixar e baixar quase 10 megabytes quando a conex√£o est√° fraca.  Provavelmente, os caras fizeram um bom trabalho para nos mostrar o conte√∫do o mais r√°pido poss√≠vel (isso √© evidenciado pelo fato de que mesmo no modo fast3g o DCL surge r√°pido o suficiente), e tudo o que n√£o era cr√≠tico foi deixado em segundo plano.  Vamos verificar isso um pouco mais tarde, e agora vamos ver por que carregamos tanto tempo.  Classifique todas as solicita√ß√µes por tempo de carregamento: </p><br><p><img src="https://habrastorage.org/webt/el/jv/uc/eljvucnzbn0d83cd2konxv8ff-8.png" alt="Um ponto ser√° exibido."><br>  <a href="">Clic√°vel</a> </p><br><p>  As imagens (top 7) s√£o carregadas por mais tempo e um arquivo JavaScript √© prebid.js.  Se observarmos o tamanho deles, podemos assumir que esse √© precisamente o motivo do carregamento lento. </p><br><div class="spoiler">  <b class="spoiler_title">Sobre suposi√ß√µes</b> <div class="spoiler_text"><p>  Com suposi√ß√µes, voc√™ precisa ser extremamente cuidadoso.  Por exemplo, um carregamento longo de um recurso pode ser causado n√£o apenas pelo tamanho do arquivo, mas tamb√©m, por exemplo, problemas com DNS, pico de carga de armazenamento ou um cache frio do servidor.  Portanto, uma suposi√ß√£o n√£o verificada pode fazer com que voc√™ perca tempo resolvendo um problema que nem existe. </p></div></div><br><p>  Observando as estat√≠sticas ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">TTFB</a> : 0,610 ms, carga: 40 000 ms), podemos concluir que nossa suposi√ß√£o √© bastante prov√°vel.  Vamos admirar o nosso TOP 1 (png, 1560X780, 24 bits): </p><br><p><img src="https://habrastorage.org/webt/61/ts/aj/61tsajb8gnvzqjaw0cg-mqdj32e.png" alt="Agora que n√£o h√° lugar"></p><br><p>  De fato, problemas com imagens s√£o principalmente problemas do nosso tr√°fego com voc√™.  Imagens (diferentemente de estilos e scripts) n√£o bloqueiam a renderiza√ß√£o de uma p√°gina da Web e, portanto, apesar da presen√ßa de tais pesos pesados ‚Äã‚Äã(pode ser pior, eles viram), isso quase n√£o afeta o desempenho.  Embora, √© claro, a otimiza√ß√£o nessa dire√ß√£o (por exemplo, transcodificar para jpeg2000 ou webp ou carregamento progressivo n√£o seja sup√©rflua). </p><br><div class="spoiler">  <b class="spoiler_title">Sobre imagens</b> <div class="spoiler_text"><p>  Como escrevi acima, as imagens n√£o bloqueiam a renderiza√ß√£o da p√°gina.  Mas eles usam nosso pool de conex√µes e, no http 1.x, o n√∫mero deles √© limitado, e no http 2.xe no Chrome tamb√©m, nem tudo √© t√£o bom quanto eu ouvi.  Portanto, mesmo aqui, existe a chance de alguma imagem retardar o carregamento de um script s√≠ncrono e que, por sua vez, j√° pare de renderizar a p√°gina.  Al√©m disso, o carregamento da imagem tamb√©m pode causar uma recontagem do layout, diminuindo a velocidade da renderiza√ß√£o.  Se observarmos a marca√ß√£o Habr, quase todas as tags img t√™m largura e altura.  Isso elimina a necessidade de reflow para impactar positivamente o desempenho do download.  Voc√™ pode ler mais sobre isso <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">aqui</a> . </p></div></div><br><p>  Vamos ver quais outros recursos o Habr extrai - analisaremos os tipos e os classificaremos pelo tempo de carregamento.  Vamos come√ßar com JavaScript </p><br><h3 id="javascript">  Javascript </h3><br><div class="spoiler">  <b class="spoiler_title">Sobre javascript</b> <div class="spoiler_text"><p>  JavaScript tem v√°rios problemas em termos de desempenho do site.  Em primeiro lugar (todo mundo sabe disso h√° muito tempo), o js s√≠ncrono bloqueia a renderiza√ß√£o adicional da p√°gina.  I.e.  at√© recebermos e executarmos nosso JavaScript, o navegador aguardar√° (na verdade, n√£o exatamente, o navegador, especialmente o Chrome, poder√° otimizar, mas essa √© outra hist√≥ria) e n√£o renderizar√° mais conte√∫do.  Usando scripts s√≠ncronos na cabe√ßa, adiamos o momento em que o usu√°rio v√™ pelo menos alguma coisa (mesmo texto).  Portanto, todo mundo est√° tentando lan√ßar Js no final da p√°gina ou at√© torn√°-lo ass√≠ncrono.  Isso funciona, mas n√£o resolve o segundo problema que nos traz o fato de que o JavaScript ainda √© uma linguagem de script.  Portanto, o navegador n√£o √© suficiente apenas para baix√°-lo - ele tamb√©m precisa ser "entendido".  E aqui, verifica-se que isso √© um problema, porque processadores fracos (por exemplo, em telefones baratos ou netbooks, ou mesmo bons laptops em modo de desempenho limitado) fazem isso lentamente, bloqueando o segmento principal!  Abaixo est√° um exemplo de como um script de publicidade ass√≠ncrono entrou na se√ß√£o cr√≠tica da renderiza√ß√£o Habr e, embora um pouco, mas ainda prejudicou o desempenho.  Se algu√©m estiver interessado, h√° um artigo muito (muito, muito) bom sobre <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">esse t√≥pico.</a> </p></div></div><br><p>  Os scripts Habr carregam muito - 1,1 MB (e isso j√° est√° em um formato compactado) para 40 solicita√ß√µes.  Isso √© francamente significativo, ainda volta para n√≥s e precisamos fazer algo sobre isso.  Classifique nossos scripts "pela cachoeira".  Nossa tarefa √© encontrar scripts carregados ANTES da linha azul, pois s√£o eles (provavelmente) que nos impedem de renderizar o site o mais r√°pido poss√≠vel. </p><br><p><img src="https://habrastorage.org/webt/0m/8g/u4/0m8gu4f9s-odx2kf7xg8jiweuke.png" alt="Na capa da minha m√£e"><br>  <a href="">Clic√°vel</a> </p><br><p>  Abrimos o html que o Habr nos deu (√© importante olhar para a resposta, pois o html final ter√° uma apar√™ncia diferente) e passamos pela lista.  Como voc√™ pode ver - jQuery, raven.js, advertise.js e adriver.js s√£o carregados de forma s√≠ncrona diretamente da tag head (ou seja, eles bloqueiam tudo).  O Gpt e o editor s√£o carregados do cabe√ßalho, mas j√° de forma ass√≠ncrona (ou seja, eles n√£o bloqueiam nada, o navegador renderiza a p√°gina ainda mais durante o carregamento).  Os fornecedores, Main e Math, checklogin s√£o carregados no final, mas de forma s√≠ncrona (ou seja, o texto j√° est√° l√°, podemos l√™-lo, mas o DCL n√£o aparecer√° at√© o carregamento).  O restante n√£o aparece na resposta inicial - eles s√£o adicionados dinamicamente, mas esse √© outro t√≥pico. </p><br><p>  Ent√£o, encontramos os scripts que de alguma forma afetam a rapidez com que vemos o texto na p√°gina.  Estes s√£o os primeiros candidatos √† otimiza√ß√£o.  Idealmente, eles devem ser ass√≠ncronos ou colocados o mais baixo poss√≠vel para permitir que o navegador renderize conte√∫do para n√≥s.  No entanto, o ideal n√£o √© poss√≠vel, pois provavelmente existem outros scripts no site que dependem do mesmo jQuery.  O desejo de baixar o raven o mais r√°pido poss√≠vel - uma biblioteca para rastrear v√°rios erros que ocorrem no cliente, tamb√©m pode ser entendido.  Mas advertise.js e adriver.js j√° s√£o verdadeiros candidatos a pelo menos descer a p√°gina e, no m√°ximo, tamb√©m no modo ass√≠ncrono.  Uma hist√≥ria semelhante com gpt e editora.  Sim, eles s√£o carregados de forma ass√≠ncrona, mas, no entanto, eles podem (e ir√£o) interferir conosco durante o carregamento.  Portanto, eles tamb√©m podem ser enviados para o final da p√°gina.  Al√©m disso, voc√™ pode tentar usar os atributos de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Dicas de recursos</a> - preload / prefetch / dns-prefetch para informar ao navegador o que carregar antecipadamente.  A prop√≥sito, recomendo que voc√™ leia sobre as Dicas de recursos - uma ferramenta muito interessante, embora com suporte limitado (at√© o momento). </p><br><p>  Agora classifique a lista por tamanho de arquivo: </p><br><p><img src="https://habrastorage.org/webt/r-/om/kq/r-omkqj5qrslwffj42o5eogv_3s.png" alt="A capa deve ser dobrada inteira"><br>  https://github.com/Drag13/articles/blob/habrformance/habrformance/scripts.PNG </p><br><p>  Vemos um script que carrega duas vezes (pubads).  Tamb√©m observamos que o prebid.js √© carregado na pasta not-for-prod </p><br><p><img src="https://habrastorage.org/webt/4e/su/7w/4esu7wsvwdpgmbw8nscc_sqcgmo.png" alt="Em suco de cereja grosso."></p><br><p>  Para limpar nossa consci√™ncia, verificamos se todos os scripts est√£o minificados.  De repente, os scripts check-login.js e adriver.js n√£o foram minificados.  Especialmente satisfeito com o conte√∫do deste √∫ltimo: </p><br><p><img src="https://habrastorage.org/webt/6q/nv/q8/6qnvq8dimcd_5m3w77mr3mkjlea.png" alt="Pegue a capa de uma m√£e de cereja"></p><br><p>  E com scripts voc√™ pode terminar temporariamente. </p><br><h3 id="stili">  Estilos </h3><br><div class="spoiler">  <b class="spoiler_title">Sobre estilos</b> <div class="spoiler_text"><p>  Com estilos, tudo tamb√©m n√£o √© t√£o simples.  Primeiro, o carregamento s√≠ncrono de estilos tamb√©m bloqueia o encadeamento principal (embora eles sejam analisados ‚Äã‚Äãrapidamente, mais rapidamente que o JavaScript).  E segundo, tudo √© um pouco mais complicado.  Por que o navegador precisa de CSS?  Para criar <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">CSSOM</a> .  O que o JavaScript pode fazer com CSS?  Isso mesmo - mude.  E o que acontecer√° se o CSSOM ainda n√£o estiver constru√≠do e o js j√° estiver tentando alterar alguma coisa l√°?  A resposta √© quem sabe.  Portanto, o navegador atrasa a execu√ß√£o do JavaScript at√© que o CSSOM seja calculado.  Como corretamente escrito em outro <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">artigo muito √∫til</a> - sem CSS = sem JavaScript.  Portanto, carregar CSS bloqueia a execu√ß√£o JS. </p></div></div><br><p>  Aqui est√£o os estilos que Habr carrega: </p><br><p><img src="https://habrastorage.org/webt/nm/6y/a7/nm6ya7qcp1bdqcp5sl2fiingrp8.png" alt="E uma caneca de leite."><br>  <a href="">Clic√°vel</a> </p><br><p>  Como voc√™ pode ver, existem apenas tr√™s deles, com o segundo e o terceiro carregados em um quadro separado, por isso os ignoramos.  Mas o primeiro conjunto de estilos √© crucial para todo o site.  E n√≥s o baixamos por muito tempo.  Porque  Primeiro, eles esperaram muito tempo por uma resposta do servidor (TTFB 570 ms, retornaremos a ele na terceira se√ß√£o) e, em segundo lugar, 713 ms foram carregados por um longo tempo.  O que pode ser feito aqui.  A primeira e mais simples √© tentar adicionar o atributo preload.  Isso solicitar√° que o navegador comece a carregar o CSS o mais cedo poss√≠vel.  A segunda op√ß√£o √© real√ßar o CSS cr√≠tico e incorpor√°-lo diretamente na p√°gina da web, e carregar o restante de forma s√≠ncrona (ou at√© ass√≠ncrona).  Isso levar√° a um aumento no tamanho da p√°gina (mas j√° n√£o √© pequeno e + 5kb n√£o estragar√° nada) e a um poss√≠vel redesenho do layout (perda de tempo), mas voc√™ pode tentar. </p><br><p>  Eu nem vou mostrar fontes.  Ele est√° l√° sozinho, embora por algum motivo ele seja carregado diretamente do servidor Habr, em vez da CDN (e provavelmente por um motivo).  Mas vou agradecer pelo fato de haver apenas uma fonte. </p><br><p>  Com isso, a parte geral da an√°lise do site pode ser considerada conclu√≠da.  Hora de ir mais fundo. </p><br><h2 id="etap-vtoroy---ruchnoy-rezhim">  Est√°gio Dois - "Modo Manual" </h2><br><p>  Na √∫ltima etapa, vimos <em>que</em> Habr carrega.  Agora vamos ver <em>como</em> isso √© renderizado. </p><br><p>  V√° para a guia de cria√ß√£o de perfil.  Verificamos o que √© a desacelera√ß√£o fast3g (depois executamos novamente sem restri√ß√µes) e executamos.  Antes de tudo, estamos interessados ‚Äã‚Äãem tudo o que acontece antes do evento <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Primeira pintura com conte√∫do (FCP)</a> e, apenas no caso, em DCL.  Selecionamos a √°rea desde o in√≠cio do carregamento at√© o FCP e olhamos para o diagrama final. </p><br><p><img src="https://habrastorage.org/webt/1s/nb/qi/1snbqidqssgm4mxoulzysms7swu.png" alt="Despeje o leite ordenadamente -"></p><br><p>  Tudo acontece muito rapidamente - 2,161 segundos antes do FCP (era mais r√°pido, mas aparentemente algo havia mudado), mas como voc√™ pode ver, na maioria das vezes o navegador estava ocioso.  A carga √∫til levou apenas 14% do tempo (cerca de 310 ms).  Idealmente, o segmento principal do navegador √© executado continuamente - analisando html, CSS, executa JS.  E aqui - nada.  Porque  Porque o navegador simplesmente n√£o tinha nada para fazer.  Lembra-se de reduzir o tr√°fego?  O navegador enviou solicita√ß√µes e agora aguarda a conclus√£o.  Se abrirmos o diagrama dos processos de rede (o mais alto), tudo ficar√° imediatamente claro. </p><br><p><img src="https://habrastorage.org/webt/uf/1-/gt/uf1-gt0kx7rkdpd9tzeod3hv99o.png" alt="Um ponto ser√° exibido."><br>  <a href="">Clic√°vel</a> </p><br><p>  Em 2029, o navegador viu main.bundle.css, enviou uma solicita√ß√£o para receb√™-lo e come√ßou a esperar.  No momento, o pr√©-scanner (smart chrome, pode executar adiante) descobriu que existem scripts s√≠ncronos abaixo e, sem esperar a chegada do css, enviou uma solicita√ß√£o de scripts.  Em seguida, o an√∫ncio e o carregador s√£o carregados (mas lembramos que, embora o CSSOM n√£o seja criado, voc√™ n√£o pode tocar em JS), o navegador os ignorou.  Depois disso, o gpt e o raven foram carregados, mas o CSS ainda estava carregando, ent√£o eles tamb√©m foram ignorados.  Por fim, foi carregado o CSS, que o navegador analisou em 12 ms e imediatamente analisou o JS incorporado na p√°gina.  Em seguida, o navegador novamente "adormeceu" a quase 150 ms, aguardando o jQuery.min.js.  Depois disso, eu j√° comecei a trabalhar seriamente - descobri o jQuery carregado (20ms), analisou raven.js (4ms), analisou quase a p√°gina inteira (36ms), recontou os estilos (28ms), calculei o layout (78 ms + 8 ms) e, finalmente, por ~ 6 ms, pintamos a p√°gina.  Aqui temos o FCP.  Em seguida, analisamos a p√°gina, analisamos os scripts - ol√° para ningu√©m (publishertag.js, gpt.js que entrou no segmento principal antes do DCL), brincamos um pouco com os estilos (o que causou uma ligeira perda de tempo devido ao rec√°lculo do layout) e come√ßamos a aguardar os fornecedores. bundle.js.  Para aguardar os fornecedores, passamos quase 1100 ms inativos.  √â verdade que, paralelamente, tamb√©m carregamos o main.bundle.js (que, ali√°s, inicializou mais rapidamente), para que nem tudo seja t√£o ruim.  Ent√£o tudo correu bem novamente.  Analisamos os fornecedores, analisamos o pacote principal, analisamos Math.Jax e finalmente analisamos a p√°gina e obtivemos o DCL.  √â verdade que algum tipo de manipulador funcionou ali, que no meu I7 parou o segmento principal em 80 ms (ou seja, o site parecia congelar em 80 ms).  Agora quase n√£o percebemos isso, mas em um processador fraco, teoricamente, isso pode ser percebido.Se voc√™ vir isso depois que o conte√∫do for renderizado, esta √© uma ocasi√£o para verificar o JS. </p><br><p>  O que posso dizer?  Novamente, apesar de parecer muito bom.  Os principais problemas foram entregues a n√≥s: </p><br><ul><li>  Um navegador grande e simples (inclusive devido ao desequil√≠brio artificial entre a capacidade de computa√ß√£o do computador e a largura do canal, mas esse tamb√©m √© um cen√°rio bastante v√°lido) </li><li>  Carregamento longo de CSS que atrasou o trabalho com js cr√≠ticos </li><li>  Carregamento s√≠ncrono de jQuery, fornecedores e principais pacotes que interromperam a apar√™ncia do conte√∫do. </li></ul><br><p>  O que podemos fazer com isso j√° discutimos: </p><br><ul><li>  Tente adicionar o atributo preload para CSS e talvez alguns JS </li><li>  Reduzir ou CSS embutido </li><li>  Tente jogar geralmente scripts fora do carregamento s√≠ncrono (pelo menos alguns) </li></ul><br><p>  Agora vamos repetir a mesma coisa sem restri√ß√µes na largura do canal.  A imagem j√° est√° muito melhor: 0,452 segundo a FMP, a mais simples de todas!  13 ms.  DCL - 953 ms, 15 ms simples.  √â assim que o download dos meus sonhos se parece.  Foi exatamente o que aconteceu porque eu abri uma nova guia e n√£o removi o cache.  Vamos tentar a mesma coisa, mas sem um cache: </p><br><p><img src="https://habrastorage.org/webt/g5/ji/5q/g5ji5qscsjud50jdqkoazqoxsga.png" alt="Agora que n√£o h√° lugar"></p><br><p>  Tudo tamb√©m √© muito bom, FCP / FMP - 1689, carga √∫til de 45%.  A prop√≥sito, ajustar a carga para 100% tamb√©m √© ruim, pois as m√°quinas mais fracas ser√£o sobrecarregadas.  Portanto, √© melhor ter uma reserva para o tempo de inatividade.  Mas aqui, inesperadamente, muito tempo foi gasto na renderiza√ß√£o - 400 ms para o FMP.  Desses, 200 ms entraram em rec√°lculo de estilos e rec√°lculo de layout. </p><br><p>  A prop√≥sito, outro ponto interessante.  Lembra dos scripts de an√∫ncio - gpt.js e publishertag.js mencionados na primeira parte?  Agora voc√™ pode ver que, apesar da assincronia, eles foram capazes (embora um pouco) de arruinar nossas estat√≠sticas.  Isso aconteceu porque a execu√ß√£o de scripts ass√≠ncronos √© feita de acordo com a disponibilidade dos pr√≥prios scripts.  I.e.  isso pode acontecer a qualquer momento, inclusive antes do FCP / DCL, que ocorreu em 3309. </p><br><p>  Ent√£o, fizemos a desmontagem manual.  √â hora de descobrir a automa√ß√£o. </p><br><h2 id="etap-tretiy---s-etogo-nado-bylo-nachinat">  Etapa Tr√™s - "Tivemos que come√ßar com isso" </h2><br><div class="spoiler">  <b class="spoiler_title">Sobre a fazenda coletiva</b> <div class="spoiler_text"><p>  Acho que todo mundo entende que este estudo √© muito arbitr√°rio.  Pelo menos, porque todo o tempo em que eu estava testando novos artigos apareceu, a carga no servidor e a carga nos backbones da rede mudaram.  De uma maneira boa, voc√™ precisa implantar um servidor dedicado no qual ningu√©m escrever√° nada, emular√° a carga relevante com atrasos relevantes e somente ent√£o criar√° um perfil de algo.  Caso contr√°rio, voc√™ pode fazer algumas suposi√ß√µes (por exemplo, sobre a necessidade de adicionar um atributo de pr√©-carregamento no CSS), adicion√°-lo, implant√°-lo na produ√ß√£o e, em seguida, verifica-se que a carga durante o teste aumentou acentuadamente e o servidor nos forneceu o mesmo estilo 500 ms depois.  E acontece que a pr√©-carga √© ruim - apenas piorou tudo.  E o autor √© o √∫ltimo rabanete.  Al√©m disso, a cria√ß√£o de perfil manual (como na segunda parte), at√© voc√™ executar todas as ferramentas autom√°ticas e resolver os problemas encontrados l√°, tamb√©m faz pouco sentido, porque ap√≥s as primeiras altera√ß√µes, a imagem muda. </p><br><p>  Portanto, antes de qualquer experimento, precisamos do ambiente mais est√°vel.  Desta vez.  A segunda - voc√™ nunca deve se aprofundar (por exemplo, na cria√ß√£o de perfil) desde o in√≠cio.  Inicie as ferramentas autom√°ticas primeiro, deixe-as trabalhar para voc√™.  Colete relat√≥rios, veja o que pode ser feito da melhor maneira poss√≠vel em tempo m√≠nimo.  Tente fazer isso.  Se poss√≠vel, voc√™ j√° pode ter o suficiente.  Por exemplo, seu css.bundle pesa 100kb, mas na realidade voc√™ precisa de 45kb (a prop√≥sito, a situa√ß√£o real: eles usaram o bootstrap inteiro, mas apenas a grade era necess√°ria).  Reduziram o tamanho dos estilos e ganharam meio segundo praticamente por nada.  Estes s√£o dois.  Sempre verifique.  Parece que os estilos est√£o alinhados, tudo deve melhorar, mas piora.  Porque  E porque nos estilos de 50kb imagens base64, e nossa p√°gina carregava apenas 200kb de recursos.  Lembre-se de que n√£o h√° bala de prata e scripts universais.  Estes s√£o tr√™s.  E a √∫ltima, mesmo que contradiga a frase anterior.  Se voc√™ n√£o possui um site complicado, basta monitorar o TTFB (problemas do servidor), o tamanho dos recursos baixados (ol√° para os logotipos de 2 MB) e n√£o conceder acesso ao Gerenciador de tags do Google.  Muito provavelmente isso ser√° suficiente. </p></div></div><br><p>  N√£o iremos muito longe, nas mesmas Ferramentas do desenvolvedor, abra a guia auditoria e inicie o LightHouse (LH) com as seguintes configura√ß√µes: √°rea de trabalho, somente desempenho, sem limita√ß√£o, armazenamento limpo.  Depois de esperar um pouco (n√£o deixe a p√°gina em que a auditoria est√° sendo conduzida e n√£o fa√ßa nada melhor), obtemos n√∫meros fant√°sticos (mesmo com o cache desativado) </p><br><p><img src="https://habrastorage.org/webt/cg/cu/rc/cgcurczrbd7r4xhjqrtqgw-pj5s.png" alt="Na capa da minha m√£e"></p><br><p>  Parece-me at√© que eles foram especialmente adaptados a esses n√∫meros. </p><br><p>  No entanto, o LH ainda reclama sobre: </p><br><ul><li>  Formato de imagem desatualizado (sugere o uso de webp, jpeg2000, etc.) </li><li>  DOM node ‚Äì    : 2533,   1500. </li><li>    </li><li>     ‚Äî     23  </li><li>  document.write </li></ul><br><p>   .     (), DOM ‚Äî      node (-),      (  ),   document.write-  writer ( -    ) </p><br><div class="spoiler"> <b class="spoiler_title"> </b> <div class="spoiler_text"><p>    (       )   .    ,  ,  , .  ,   ,      .       CSS, ‚Äî      ,   ,      JavaScript. ,        ,     .                       . </p></div></div><br><p>     ,       fast3g , ,      ( I7,  celeron): </p><br><p><img src="https://habrastorage.org/webt/td/ei/3j/tdei3jxtwbcvda5csqvvmgz2tua.png" alt="A capa deve ser dobrada inteira"></p><br><p>      ( FCP   3500 ms, FMP 5.7): </p><br><ul><li>   ,   . LH    next-gen  ,  ,   ,     11   </li><li>      .       adriver.js  advertise.js  50 ,     . </li><li>    CSS    ,    5kb  45kb. </li><li>      main thread.           JavaScript ‚Äî (8.5   script evaluation   2186 ms   raven.js).   ? </li></ul><br><p>     ?         .    -    .  : </p><br><ul><li>   </li><li>   DOM </li><li>   JavaScript   </li></ul><br><p>    ,        ,         (,  raven.js). </p><br><p>  ,      ,       ‚Äî <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">webpagetest.org</a> </p><br><p>    ‚Äî   ,  ,  .        ‚Äî     ,      .   ,    .   ,    ,   . ,       ,      ,   ‚Äî  -. </p><br><p>      <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">https://habr.com</a> ( ru/en ). </p><br><p><img src="https://habrastorage.org/webt/qz/hb/gn/qzhbgnvpgll4xbdlvejmvfzpndm.png" alt="Em uma panela com leite."></p><br><p> ( ,   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="></a> ) </p><br><p>    .     ( )    DNS (500 ms   ),     , ssl   .   ,    1150 ms    c      (    ). ,     (    habrastorage). </p><br><p>      main.bundle.css. ,     dr.habracdn.net ,     dns lookup ‚Äî 36 ms (     400 ms).  SSL negotiation 606 ms,  TTFB 601 ms,   .    .       DCL ‚Äî 4100 ms   ,   . </p><br><p>     image analysis , ,        .  -      PNG  1.4,   webp + downscaling ( ,   ) ‚Äî 17.7 KB.  ,       ,     png  154.          . ,  : </p><br><ul><li>         (   ,        , ..    ). </li><li>   .   ,    . </li><li>  TTFB (webpagetest    F  ) ‚Äî     </li><li>       ,       (         ) </li></ul><br><h2 id="vyvody">  Conclus√µes </h2><br><p>      .     : </p><br><p>  : </p><br><ul><li>  TTFB   500 ms      ( <strong></strong> dns, ssl  initial connection) </li><li>  habrastorage </li></ul><br><p>  : </p><br><ul><li>    </li><li>   DOM-a </li><li>       </li></ul><br><p>  , ,      .      ,     ,    . ,   SPA,       ,    JS   ‚Äî    .     .       //,           </p><br><h2 id="poleznye-ssylki">   </h2><br><ul><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">  </a> </li><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="> </a> </li><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">   </a> </li><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Webpagetest</a> </li><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">  webpagetest</a> </li><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">   1</a> </li><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">   2</a> </li><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="> FCP</a> </li></ul><br><p>  PS.<font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pe√ßo desculpas pelo grande n√∫mero de anglicismos (especialmente pelo layout) e pelo Longrid. </font><font style="vertical-align: inherit;">Mas sem eles, √© realmente dif√≠cil, e todas essas partes 1, 2, 3, eu j√° cansei do pedido.</font></font></p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt454444/">https://habr.com/ru/post/pt454444/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt454432/index.html">Arqueologia divertida: o guia de estilo R sob a lupa</a></li>
<li><a href="../pt454434/index.html">PDA (Pocket Travel Computer): registrador GPS de circuitos</a></li>
<li><a href="../pt454436/index.html">Mesquinho alegria mesquinho # 1: loguru</a></li>
<li><a href="../pt454440/index.html">Petty Little Fun # 2: Estrelinha</a></li>
<li><a href="../pt454442/index.html">Como escolher uma rede proxy para o seu neg√≥cio: 3 dicas pr√°ticas</a></li>
<li><a href="../pt454446/index.html">O que h√° de novo no C # 8?</a></li>
<li><a href="../pt454450/index.html">Como Edison inventou o wireless e n√£o entendeu nada</a></li>
<li><a href="../pt454452/index.html">Exibimos conte√∫do na imagem reconhecida de acordo com certas regras</a></li>
<li><a href="../pt454456/index.html">Treinamento Cisco 200-125 CCNA v3.0. Dia 7. FAQ</a></li>
<li><a href="../pt454458/index.html">Teste metam√≥rfico: por que quase ningu√©m sabe sobre essa t√©cnica promissora</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>