<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë©üèø‚Äçüíº üåç üèπ Problemas do processamento em lote de solicita√ß√µes e suas solu√ß√µes (parte 2) üîú ü§¥üèø üßùüèº</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Esta √© uma continua√ß√£o do artigo ‚ÄúProblemas do processamento em lote de solicita√ß√µes e suas solu√ß√µes . √â recomend√°vel que voc√™ se familiarize primeiro...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Problemas do processamento em lote de solicita√ß√µes e suas solu√ß√µes (parte 2)</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/custis/blog/467919/"><img src="https://habrastorage.org/webt/ad/_6/oe/ad_6oeq50j8z5q33t5ixjrcssqs.jpeg"><br>  Esta √© uma continua√ß√£o do artigo <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">‚ÄúProblemas do processamento em lote de solicita√ß√µes e suas solu√ß√µes</a> .  √â recomend√°vel que voc√™ se familiarize primeiro com a primeira parte, pois ela descreve em detalhes a ess√™ncia do problema e algumas abordagens para sua solu√ß√£o.  Aqui n√≥s olhamos para outros m√©todos. <br><a name="habracut"></a><br><div class="spoiler">  <b class="spoiler_title">Conte√∫do</b> <div class="spoiler_text">  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Breve repeti√ß√£o da tarefa</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Aumentar pacotes</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Engenharia reversa</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Coletar todos os pedidos</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Paralelismo</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Os problemas</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Conclus√µes</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Heur√≠stica de neg√≥cios</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Resolvendo um problema de contrato</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Procure limita√ß√µes √∫teis</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Erros heur√≠sticos</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Conclus√µes</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Unidades no estilo DDD</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">L√≥gica de encaminhamento de consultas em um agregado</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">L√≥gica para agregar consultas fora do agregado</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Conclus√µes</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Proxy e chamada dupla</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Resolvendo um problema de contrato</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Conclus√µes</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Conclus√£o</a> </div></div><br><a name="Revision"></a><h2>  Breve repeti√ß√£o da tarefa </h2><br>  H√° um bate-papo para coordenar o documento com um conjunto predefinido de participantes.  As mensagens cont√™m texto e arquivos.  E, como nos chats regulares, as mensagens podem ser respondidas e encaminhadas. <br><br><div class="spoiler">  <b class="spoiler_title">Modelo de mensagem de bate-papo</b> <div class="spoiler_text"><code><font color="7f0055"><b>data class</b></font> <font color="3e7eff"><b>ChatMessage</b></font> <font color="000066">(</font> <br> <font color="3f7f5f">// nullable      persist</font> <br> <font color="7f0055"><b>val</b></font> <font color="566874">id</font> : <font color="3e7eff"><b>Long</b></font> ? <font color="333333">=</font> <font color="7f0055"><b>null</b></font> <font color="333333">,</font> <br> <font color="395da1">/**    */</font> <br> <font color="7f0055"><b>val</b></font> <font color="566874">author</font> : <font color="3e7eff"><b>UserReference</b></font> <font color="333333">,</font> <br> <font color="395da1">/**  */</font> <br> <font color="7f0055"><b>val</b></font> <font color="566874">message</font> : <font color="3e7eff"><b>String</b></font> <font color="333333">,</font> <br> <font color="395da1">/**    */</font> <br> <font color="3f7f5f">// -   JPA+    null,   </font> <br> <font color="7f0055"><b>val</b></font> <font color="566874">files</font> : <font color="3e7eff"><b>List</b></font> <font color="333333">&lt;</font> <font color="3e7eff"><b>FileReference</b></font> <font color="333333">&gt;</font> ? <font color="333333">=</font> <font color="7f0055"><b>null</b></font> <font color="333333">,</font> <br> <font color="395da1">/**   ,     */</font> <br> <font color="7f0055"><b>val</b></font> <font color="566874">replyTo</font> : <font color="3e7eff"><b>ChatMessage</b></font> ? <font color="333333">=</font> <font color="7f0055"><b>null</b></font> <font color="333333">,</font> <br> <font color="395da1">/**   ,     */</font> <br> <font color="7f0055"><b>val</b></font> <font color="566874">forwardFrom</font> : <font color="3e7eff"><b>ChatMessage</b></font> ? <font color="333333">=</font> <font color="7f0055"><b>null</b></font> <br> <font color="000066">)</font></code> </div> </div><br><div class="spoiler">  <b class="spoiler_title">Atrav√©s da inje√ß√£o de depend√™ncia, podemos implementar os seguintes servi√ßos externos:</b> <div class="spoiler_text"> <code><font color="7f0055"><b>interface</b></font> <font color="3e7eff"><b>ChatMessageRepository</b></font> <font color="000066">{</font> <br> <font color="7f0055"><b>fun</b></font> <font color="170591"><b>findLast</b></font> <font color="000066">(</font> <font color="000066"><i>n</i></font> : <font color="3e7eff"><b>Int</b></font> <font color="000066">)</font> : <font color="3e7eff"><b>List</b></font> <font color="333333">&lt;</font> <font color="3e7eff"><b>ChatMessage</b></font> <font color="333333">&gt;</font> <br> <font color="000066">}</font> <br> <br> <font color="7f0055"><b>data class</b></font> <font color="3e7eff"><b>FileHeadRemote</b></font> <font color="000066">(</font> <br> <font color="7f0055"><b>val</b></font> <font color="566874">id</font> : <font color="3e7eff"><b>FileReference</b></font> <font color="333333">,</font> <br> <font color="7f0055"><b>val</b></font> <font color="566874">name</font> : <font color="3e7eff"><b>String</b></font> <br> <font color="000066">)</font> <br> <br> <font color="7f0055"><b>interface</b></font> <font color="3e7eff"><b>FileRemoteApi</b></font> <font color="000066">{</font> <br> <font color="7f0055"><b>fun</b></font> <font color="170591"><b>getHeadById</b></font> <font color="000066">(</font> <font color="000066"><i>id</i></font> : <font color="3e7eff"><b>FileReference</b></font> <font color="000066">)</font> : <font color="3e7eff"><b>FileHeadRemote</b></font> <br> <font color="3e7eff"><b>&nbsp;&nbsp;</b></font> <font color="7f0055"><b>fun</b></font> <font color="170591"><b>getHeadsByIds</b></font> <font color="000066">(</font> <font color="000066"><i>id</i></font> : <font color="3e7eff"><b>Set</b></font> <font color="333333">&lt;</font> <font color="3e7eff"><b>FileReference</b></font> <font color="333333">&gt;</font> <font color="000066">)</font> : <font color="3e7eff"><b>Set</b></font> <font color="333333">&lt;</font> <font color="3e7eff"><b>FileHeadRemote</b></font> <font color="333333">&gt;</font> <br> <font color="7f0055"><b>fun</b></font> <font color="170591"><b>getHeadsByIds</b></font> <font color="000066">(</font> <font color="000066"><i>id</i></font> : <font color="3e7eff"><b>List</b></font> <font color="333333">&lt;</font> <font color="3e7eff"><b>FileReference</b></font> <font color="333333">&gt;</font> <font color="000066">)</font> : <font color="3e7eff"><b>List</b></font> <font color="333333">&lt;</font> <font color="3e7eff"><b>FileHeadRemote</b></font> <font color="333333">&gt;</font> <br> <font color="000066">}</font> <br> <br> <font color="7f0055"><b>data class</b></font> <font color="3e7eff"><b>UserRemote</b></font> <font color="000066">(</font> <br> <font color="7f0055"><b>val</b></font> <font color="566874">id</font> : <font color="3e7eff"><b>UserReference</b></font> <font color="333333">,</font> <br> <font color="7f0055"><b>val</b></font> <font color="566874">name</font> : <font color="3e7eff"><b>String</b></font> <br> <font color="000066">)</font> <br> <br> <font color="7f0055"><b>interface</b></font> <font color="3e7eff"><b>UserRemoteApi</b></font> <font color="000066">{</font> <br> <font color="7f0055"><b>fun</b></font> <font color="170591"><b>getUserById</b></font> <font color="000066">(</font> <font color="000066"><i>id</i></font> : <font color="3e7eff"><b>UserReference</b></font> <font color="000066">)</font> : <font color="3e7eff"><b>UserRemote</b></font> <br> <font color="3e7eff"><b>&nbsp;&nbsp;</b></font> <font color="7f0055"><b>fun</b></font> <font color="170591"><b>getUsersByIds</b></font> <font color="000066">(</font> <font color="000066"><i>id</i></font> : <font color="3e7eff"><b>Set</b></font> <font color="333333">&lt;</font> <font color="3e7eff"><b>UserReference</b></font> <font color="333333">&gt;</font> <font color="000066">)</font> : <font color="3e7eff"><b>Set</b></font> <font color="333333">&lt;</font> <font color="3e7eff"><b>UserRemote</b></font> <font color="333333">&gt;</font> <br> <font color="7f0055"><b>fun</b></font> <font color="170591"><b>getUsersByIds</b></font> <font color="000066">(</font> <font color="000066"><i>id</i></font> : <font color="3e7eff"><b>List</b></font> <font color="333333">&lt;</font> <font color="3e7eff"><b>UserReference</b></font> <font color="333333">&gt;</font> <font color="000066">)</font> : <font color="3e7eff"><b>List</b></font> <font color="333333">&lt;</font> <font color="3e7eff"><b>UserRemote</b></font> <font color="333333">&gt;</font> <br> <font color="000066">}</font></code> </div> </div><br>  Precisamos implementar um controlador REST: <br><br> <code><font color="7f0055"><b>interface</b></font> <font color="3e7eff"><b>ChatRestApi</b></font> <font color="000066">{</font> <br> <font color="7f0055"><b>fun</b></font> <font color="170591"><b>getLast</b></font> <font color="000066">(</font> <font color="000066"><i>n</i></font> : <font color="3e7eff"><b>Int</b></font> <font color="000066">)</font> : <font color="3e7eff"><b>List</b></font> <font color="333333">&lt;</font> <font color="3e7eff"><b>ChatMessageUI</b></font> <font color="333333">&gt;</font> <br> <font color="000066">}</font></code> <br> <br><div class="spoiler">  <b class="spoiler_title">Onde:</b> <div class="spoiler_text"> <code><font color="395da1">/**          */</font> <br> <font color="7f0055"><b>data class</b></font> <font color="3e7eff"><b>ReferenceUI</b></font> <font color="000066">(</font> <br> <font color="395da1">/**   url */</font> <br> <font color="7f0055"><b>val</b></font> <font color="566874">ref</font> : <font color="3e7eff"><b>String</b></font> <font color="333333">,</font> <br> <font color="395da1">/**     */</font> <br> <font color="7f0055"><b>val</b></font> <font color="566874">name</font> : <font color="3e7eff"><b>String</b></font> <br> <font color="000066">)</font> <br> <br> <font color="7f0055"><b>data class</b></font> <font color="3e7eff"><b>ChatMessageUI</b></font> <font color="000066">(</font> <br> <font color="7f0055"><b>val</b></font> <font color="566874">id</font> : <font color="3e7eff"><b>Long</b></font> <font color="333333">,</font> <br> <font color="395da1">/**    */</font> <br> <font color="7f0055"><b>val</b></font> <font color="566874">author</font> : <font color="3e7eff"><b>ReferenceUI</b></font> <font color="333333">,</font> <br> <font color="395da1">/**  */</font> <br> <font color="7f0055"><b>val</b></font> <font color="566874">message</font> : <font color="3e7eff"><b>String</b></font> <font color="333333">,</font> <br> <font color="395da1">/**    */</font> <br> <font color="7f0055"><b>val</b></font> <font color="566874">files</font> : <font color="3e7eff"><b>List</b></font> <font color="333333">&lt;</font> <font color="3e7eff"><b>ReferenceUI</b></font> <font color="333333">&gt;,</font> <br> <font color="395da1">/**   ,     */</font> <br> <font color="7f0055"><b>val</b></font> <font color="566874">replyTo</font> : <font color="3e7eff"><b>ChatMessageUI</b></font> ? <font color="333333">=</font> <font color="7f0055"><b>null</b></font> <font color="333333">,</font> <br> <font color="395da1">/**   ,     */</font> <br> <font color="7f0055"><b>val</b></font> <font color="566874">forwardFrom</font> : <font color="3e7eff"><b>ChatMessageUI</b></font> ? <font color="333333">=</font> <font color="7f0055"><b>null</b></font> <br> <font color="000066">)</font> <br></code> </div></div><br>  Na parte anterior, vimos a implementa√ß√£o ing√™nua de um servi√ßo usando o processamento em lote e v√°rias maneiras de aceler√°-lo.  Esses m√©todos s√£o muito simples, mas seu aplicativo n√£o fornece desempenho suficientemente bom. <br><br><a name="Enlargement"></a><h2>  Aumentar pacotes </h2><br>  O principal problema das solu√ß√µes ing√™nuas era o tamanho pequeno dos pacotes. <br><br>  Para agrupar chamadas em pacotes maiores, √© necess√°rio acumular solicita√ß√µes de alguma forma.  Esta linha n√£o implica o ac√∫mulo de solicita√ß√µes: <br><br> <code><font color="4a86e8">author =</font> <font color="566874">userRepository</font> <font color="333333">.</font> <font color="170591">getUserById</font> <font color="000066">(</font> <font color="566874">author</font> <font color="000066">)</font> <font color="333333">.</font> <i><b>toFrontReference</b></i> <font color="000066">()</font> <font color="333333">,</font></code> <br> <br>  Agora, em nosso tempo de execu√ß√£o, n√£o h√° um lugar especial para armazenar a lista de usu√°rios - ela est√° sendo formada gradualmente.  Isso ter√° que mudar. <br><br>  Primeiro, voc√™ precisa separar a l√≥gica da aquisi√ß√£o de dados do mapeamento no m√©todo ChatMessage.toFrontModel: <br><br> <code><font color="7f0055"><b>private fun</b></font> <font color="3e7eff"><b>ChatMessage</b></font> <font color="333333">.</font> <font color="170591"><b>toFrontModel</b></font> <font color="000066">(</font> <br> <font color="000066"><i>getUser</i></font> : <font color="000066">(</font> <font color="3e7eff"><b>UserReference</b></font> <font color="000066">) -&gt;</font> <font color="3e7eff"><b>UserRemote</b></font> <font color="333333">,</font> <br> <font color="000066"><i>getFile</i></font> : <font color="000066">(</font> <font color="3e7eff"><b>FileReference</b></font> <font color="000066">) -&gt;</font> <font color="3e7eff"><b>FileHeadRemote</b></font> <font color="333333">,</font> <br> <font color="000066"><i>serializeMessage</i></font> : <font color="000066">(</font> <font color="3e7eff"><b>ChatMessage</b></font> <font color="000066">) -&gt;</font> <font color="3e7eff"><b>ChatMessageUI</b></font> <br> <font color="000066">)</font> : <font color="3e7eff"><b>ChatMessageUI</b></font> <font color="333333">=</font> <br> <font color="170591">ChatMessageUI</font> <font color="000066">(</font> <br> <font color="4a86e8">id =</font> <font color="566874">id</font> ?: <font color="7f0055"><b>throw</b></font> <font color="170591">IllegalStateException</font> <font color="000066">(</font> <b>"</b> <font color="333333"><b>$</b></font> <font color="7f0055"><b>this</b></font> <b>must be persisted"</b> <font color="000066">)</font> <font color="333333">,</font> <br> <font color="4a86e8">author =</font> <font color="000066"><i>getUser</i></font> <font color="000066">(</font> <font color="566874">author</font> <font color="000066">)</font> <font color="333333">.</font> <i><b>toFrontReference</b></i> <font color="000066">()</font> <font color="333333">,</font> <br> <font color="4a86e8">message =</font> <font color="566874">message</font> <font color="333333">,</font> <br> <font color="4a86e8">files =</font> <font color="566874">files</font> <font color="333333">?.</font> <i><b>let</b></i> <font color="000066"><b>{</b></font> <br> <font color="000066"><b>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</b></font> <b>it</b> <font color="333333">.</font> <i><b>map</b></i> <font color="000066">(</font> <font color="000066"><i>getFile</i></font> <font color="000066">)</font> <font color="333333">.</font> <i><b>map</b></i> <font color="000066"><b>{</b></font> <font color="000066"><i>it</i></font> <font color="333333">.</font> <i><b>toFrontReference</b></i> <font color="000066">()</font> <font color="000066"><b>}</b></font> <br> <font color="000066"><b>}</b></font> ?: <i><b>listOf</b></i> <font color="000066">()</font> <font color="333333">,</font> <br> <font color="4a86e8">forwardFrom =</font> <font color="566874">forwardFrom</font> <font color="333333">?.</font> <i><b>let</b></i> <font color="000066">(</font> <font color="000066"><i>serializeMessage</i></font> <font color="000066">)</font> <font color="333333">,</font> <br> <font color="4a86e8">replyTo =</font> <font color="566874">replyTo</font> <font color="333333">?.</font> <i><b>let</b></i> <font color="000066">(</font> <font color="000066"><i>serializeMessage</i></font> <font color="000066">)</font> <br> <font color="000066">)</font></code> <br> <br>  Acontece que essa fun√ß√£o depende apenas de tr√™s fun√ß√µes externas (e n√£o de classes inteiras, como era no in√≠cio). <br><br>  Ap√≥s esse retrabalho, o corpo da fun√ß√£o n√£o ficou menos claro e o contrato ficou mais dif√≠cil (isso tem pr√≥s e contras). <br><br>  De fato, voc√™ n√£o pode fazer esse estreitamento do contrato e deixar depend√™ncias nas interfaces.  O principal √© que definitivamente n√£o h√° nada sup√©rfluo neles, pois precisaremos fazer implementa√ß√µes alternativas. <br><br>  Como a fun√ß√£o serializeMessage √© semelhante a uma fun√ß√£o recursiva, isso pode ser feito como uma recurs√£o expl√≠cita na primeira etapa da refatora√ß√£o: <br><br> <code><font color="7f0055"><b>class</b></font> <font color="3e7eff"><b>ChatRestController</b></font> <font color="000066">(</font> <br> <font color="7f0055"><b>private val</b></font> <font color="566874">messageRepository</font> : <font color="3e7eff"><b>ChatMessageRepository</b></font> <font color="333333">,</font> <br> <font color="7f0055"><b>private val</b></font> <font color="566874">userRepository</font> : <font color="3e7eff"><b>UserRemoteApi</b></font> <font color="333333">,</font> <br> <font color="7f0055"><b>private val</b></font> <font color="566874">fileRepository</font> : <font color="3e7eff"><b>FileRemoteApi</b></font> <br> <font color="000066">)</font> : <font color="3e7eff"><b>ChatRestApi</b></font> <font color="000066">{</font> <br> <font color="7f0055"><b>override fun</b></font> <font color="170591"><b>getLast</b></font> <font color="000066">(</font> <font color="000066"><i>n</i></font> : <font color="3e7eff"><b>Int</b></font> <font color="000066">)</font> <font color="333333">=</font> <br> <font color="566874">messageRepository</font> <font color="333333">.</font> <font color="170591">findLast</font> <font color="000066">(</font> <font color="000066"><i>n</i></font> <font color="000066">)</font> <br> <font color="333333">.</font> <i><b>map</b></i> <font color="000066"><b>{</b></font> <font color="000066"><i>it</i></font> <font color="333333">.</font> <i><b>toFrontModel</b></i> <font color="000066">()</font> <font color="000066"><b>}</b></font></code> <br> <br>  Fiz um stub para o m√©todo toFrontModel, que at√© agora funciona exatamente da mesma forma que em nossa primeira implementa√ß√£o ing√™nua (a implementa√ß√£o de todas as tr√™s fun√ß√µes externas permanece a mesma). <br><br> <code><font color="7f0055"><b>private fun</b></font> <font color="3e7eff"><b>ChatMessage</b></font> <font color="333333">.</font> <font color="170591"><b>toFrontModel</b></font> <font color="000066">()</font> : <font color="3e7eff"><b>ChatMessageUI</b></font> <font color="333333">=</font> <br> <i><b>toFrontModel</b></i> <font color="000066">(</font> <br> <font color="4a86e8">getUser =</font> <font color="566874">userRepository</font> ::getUserById <font color="333333">,</font> <br> <font color="4a86e8">getFile =</font> <font color="566874">fileRepository</font> ::getHeadById <font color="333333">,</font> <br> <font color="4a86e8">serializeMessage =</font> <font color="000066"><b>{</b></font> <font color="000066"><i>it</i></font> <font color="333333">.</font> <i><b>toFrontModel</b></i> <font color="000066">()</font> <font color="000066"><b>}</b></font> <br> <font color="000066"><b>&nbsp;&nbsp;</b></font> <font color="000066">)</font></code> <br> <br>  Mas precisamos fazer com que as fun√ß√µes getUser, getFile e serializeMessage funcionem com efici√™ncia, ou seja, envie solicita√ß√µes para os servi√ßos apropriados em pacotes do tamanho certo (teoricamente, esse tamanho pode ser diferente para cada servi√ßo) ou geralmente uma solicita√ß√£o por servi√ßo, se solicita√ß√µes ilimitadas forem permitidas. <br><br>  A maneira mais f√°cil de obter esse agrupamento √© se tivermos todas as consultas necess√°rias em m√£os antes de iniciar o processamento.  Para fazer isso, antes de chamar oFrontModel, colete todos os links necess√°rios, fa√ßa o processamento em lote e use o resultado. <br><br>  Voc√™ tamb√©m pode tentar o esquema com o ac√∫mulo de solicita√ß√µes e sua execu√ß√£o gradual.  No entanto, esses esquemas exigir√£o execu√ß√£o ass√≠ncrona, mas, por enquanto, focaremos nos s√≠ncronos. <br><br>  Portanto, para come√ßar a usar o processamento em lote, de uma forma ou de outra, teremos que descobrir com anteced√™ncia o maior n√∫mero poss√≠vel de solicita√ß√µes (de prefer√™ncia todas) que precisaremos fazer.  Se estamos falando de um controlador REST, seria bom combinar solicita√ß√µes para cada servi√ßo ao longo da sess√£o. <br><br><div class="spoiler">  <b class="spoiler_title">Agrupar todas as chamadas</b> <div class="spoiler_text">  Em algumas situa√ß√µes, todos os dados necess√°rios dentro da sess√£o podem ser obtidos imediatamente e n√£o causar√£o problemas com os recursos, desde o iniciador da solicita√ß√£o ou do executor.  Nesse caso, n√£o podemos limitar o tamanho do pacote para chamar o servi√ßo e receber imediatamente todos os dados de uma s√≥ vez. <br><br>  Outra suposi√ß√£o que facilita muito a vida √© supor que o iniciador tenha recursos suficientes para processar todos os dados.  Solicita√ß√µes para servi√ßos externos tamb√©m podem ser enviadas em pacotes limitados, se necess√°rio. <br><br>  A simplifica√ß√£o da l√≥gica, neste caso, diz respeito a como os locais onde os dados s√£o necess√°rios ser√£o comparados com os resultados das chamadas.  Se considerarmos que os recursos do iniciador s√£o muito limitados e, ao mesmo tempo, tentar minimizar o n√∫mero de chamadas externas, teremos uma tarefa bastante dif√≠cil para o corte ideal do gr√°fico.  Provavelmente, voc√™ s√≥ precisa sacrificar o desempenho para reduzir o consumo de recursos. <br><br>  Consideraremos que, especificamente em nosso projeto de demonstra√ß√£o, o iniciador n√£o √© particularmente limitado em recursos, ele pode receber todos os dados necess√°rios e armazen√°-los at√© o final da sess√£o.  Se houver problemas com os recursos, faremos apenas uma pagina√ß√£o menor. <br><br>  Como, na minha pr√°tica, apenas essa abordagem √© mais procurada, outros exemplos envolver√£o essa op√ß√£o. </div></div><br>  Podemos distinguir esses m√©todos de obter grandes conjuntos de consultas: <br><br><ul><li>  engenharia reversa; </li><li>  heur√≠stica de neg√≥cios; </li><li>  agregados no estilo de DDD; </li><li>  proxying e chamada dupla. </li></ul><br>  Vamos analisar todas as op√ß√µes no exemplo do nosso projeto. <br><br><a name="ReverseEngineering"></a><h4>  Engenharia reversa </h4><br><a name="RequirementsGathering"></a>  <b>Coletar todos os pedidos</b> <br><br>  Como temos um c√≥digo para implementar todas as fun√ß√µes envolvidas na coleta de informa√ß√µes e na convers√£o para o front-end, podemos fazer engenharia reversa e, a partir desse c√≥digo, podemos entender quais ser√£o as solicita√ß√µes: <br><br> <code><font color="7f0055"><b>class</b></font> <font color="3e7eff"><b>ChatRestController</b></font> <font color="000066">(</font> <br> <font color="7f0055"><b>private val</b></font> <font color="566874">messageRepository</font> : <font color="3e7eff"><b>ChatMessageRepository</b></font> <font color="333333">,</font> <br> <font color="7f0055"><b>private val</b></font> <font color="566874">userRepository</font> : <font color="3e7eff"><b>UserRemoteApi</b></font> <font color="333333">,</font> <br> <font color="7f0055"><b>private val</b></font> <font color="566874">fileRepository</font> : <font color="3e7eff"><b>FileRemoteApi</b></font> <br> <font color="000066">)</font> : <font color="3e7eff"><b>ChatRestApi</b></font> <font color="000066">{</font> <br> <font color="7f0055"><b>override fun</b></font> getLast <font color="000066">(</font> <font color="000066"><i>n</i></font> : <font color="3e7eff"><b>Int</b></font> <font color="000066">)</font> <font color="333333">=</font> <br> <font color="566874">messageRepository</font> <font color="333333">.</font> <font color="170591">findLast</font> <font color="000066">(</font> <font color="000066"><i>n</i></font> <font color="000066">)</font> <br> <font color="333333">.</font> <i><b>let</b></i> <font color="000066"><b>{</b></font> <font color="000066"><i>messages</i></font> <font color="000066"><b>-&gt;</b></font> <br> <font color="000066"><b>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</b></font> <font color="3f7f5f">//    ,  forward  reply</font> <br> <font color="7f0055"><b>val</b></font> <font color="170591">allMessages</font> <font color="333333">=</font> <font color="000066"><i>messages</i></font> <font color="333333">.</font> <i><b>asSequence</b></i> <font color="000066">()</font> <font color="333333">.</font> <i><b>flatMap</b></i> <font color="000066"><b>{</b></font> <br> <font color="000066"><b>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</b></font> <i><b>sequenceOf</b></i> <font color="000066">(</font> <font color="000066"><i>it</i></font> <font color="333333">,</font> <font color="000066"><i>it</i></font> <font color="333333">.</font> <font color="566874">forwardFrom</font> <font color="333333">,</font> <b>it</b> <font color="333333">.</font> <font color="566874">replyTo</font> <font color="000066">)</font> <font color="333333">.</font> <i><b>filterNotNull</b></i> <font color="000066">()</font> <br> <font color="000066"><b>}</b></font> <font color="333333">.</font> <i><b>toSet</b></i> <font color="000066">()</font> <br> <font color="7f0055"><b>val</b></font> <font color="170591">allUserReq</font> <font color="333333">=</font> <font color="170591">allMessages</font> <font color="333333">.</font> <i><b>map</b></i> <font color="000066"><b>{</b></font> <b>it</b> <font color="333333">.</font> <font color="566874">author</font> <font color="000066"><b>}</b></font> <br> <font color="000066"><b>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</b></font> <font color="7f0055"><b>val</b></font> <font color="170591">allFileReq</font> <font color="333333">=</font> <font color="170591">allMessages</font> <font color="333333">.</font> <i><b>flatMap</b></i> <font color="000066"><b>{</b></font> <font color="000066"><i>it</i></font> <font color="333333">.</font> <font color="566874">files</font> ?: <i><b>listOf</b></i> <font color="000066">()</font> <font color="000066"><b>}</b></font> <font color="333333">.</font> <i><b>toSet</b></i> <font color="000066">()</font></code> <br> <br>  Todas as solicita√ß√µes s√£o coletadas, agora voc√™ precisa fazer o processamento em lote real. <br><br>  Para allUserReq e allFileReq, fazemos consultas externas e as agrupamos por ID.  Se n√£o houver restri√ß√µes no tamanho do pacote, ser√° algo parecido com isto: <br><br> <code><font color="566874">userRepository</font> <font color="333333">.</font> <font color="170591">getUsersByIds</font> <font color="000066">(</font> <font color="170591">allMessages</font> <font color="333333">.</font> <i><b>map</b></i> <font color="000066"><b>{</b></font> <b>it</b> <font color="333333">.</font> <font color="566874">author</font> <font color="000066"><b>}</b></font> <font color="333333">.</font> <i><b>toSet</b></i> <font color="000066">())</font> <br> <font color="333333">.</font> <i><b>associateBy</b></i> <font color="000066"><b>{</b></font> <b>it</b> <font color="333333">.</font> <font color="566874">id</font> <font color="000066"><b>}</b></font> ::get <br> <font color="566874">fileRepository</font> <font color="333333">.</font> <font color="170591">getHeadsByIds</font> <font color="000066">(</font> <font color="170591">allMessages</font> <font color="333333">.</font> <i><b>flatMap</b></i> <font color="000066"><b>{</b></font> <b>it</b> <font color="333333">.</font> <font color="566874">files</font> ?: <i><b>listOf</b></i> <font color="000066">()</font> <font color="000066"><b>}</b></font> <font color="333333">.</font> <i><b>toSet</b></i> <font color="000066">())</font> <br> <font color="333333">.</font> <i><b>associateBy</b></i> <font color="000066"><b>{</b></font> <font color="000066"><i>it</i></font> <font color="333333">.</font> <font color="566874">id</font> <font color="000066"><b>}</b></font> ::get</code> <br> <br>  Se houver uma restri√ß√£o, o c√≥digo assumir√° o seguinte formato: <br><br> <code><font color="7f0055"><b>val</b></font> <font color="170591">userApiChunkLimit</font> <font color="333333">=</font> <font color="333333"><b>100</b></font> <br> <font color="170591">allMessages</font> <font color="333333">.</font> <i><b>map</b></i> <font color="000066"><b>{</b></font> <b>it</b> <font color="333333">.</font> <font color="566874">author</font> <font color="000066"><b>}</b></font> <font color="333333">.</font> <i><b>asSequence</b></i> <font color="000066">()</font> <font color="333333">.</font> <i><b>distinct</b></i> <font color="000066">()</font> <br> <font color="333333">.</font> <i><b>chunked</b></i> <font color="000066">(</font> <font color="170591">userApiChunkLimit</font> <font color="333333">,</font> <font color="566874">userRepository</font> ::getUsersByIds <font color="000066">)</font> <br> <font color="333333">.</font> <i><b>flatten</b></i> <font color="000066">()</font> <br> <font color="333333">.</font> <i><b>associateBy</b></i> <font color="000066"><b>{</b></font> <font color="000066"><i>it</i></font> <font color="333333">.</font> <font color="566874">id</font> <font color="000066"><b>}</b></font> ::get</code> <br> <br>  Infelizmente, ao contr√°rio do Stream, o Sequence n√£o pode alternar facilmente para uma solicita√ß√£o de pacote paralelo. <br><br>  Se voc√™ considerar uma consulta paralela v√°lida e necess√°ria, poder√° fazer, por exemplo, o seguinte: <br><br> <code><font color="170591">allMessages</font> <font color="333333">.</font> <i><b>map</b></i> <font color="000066"><b>{</b></font> <font color="000066"><i>it</i></font> <font color="333333">.</font> <font color="566874">author</font> <font color="000066"><b>}</b></font> <font color="333333">.</font> <font color="170591">parallelStream</font> <font color="000066">()</font> <font color="333333">.</font> <font color="170591">distinct</font> <font color="000066">()</font> <br> <font color="333333">.</font> <i><b>chunked</b></i> <font color="000066">(</font> <font color="05314d"><b>userApiChunkLimit</b></font> <font color="333333">,</font> <font color="566874">userRepository</font> ::getUsersByIds <font color="000066">)</font> <br> <font color="333333">.</font> <i><b>flatten</b></i> <font color="000066">()</font> <br> <font color="333333">.</font> <i><b>associateBy</b></i> <font color="000066"><b>{</b></font> <font color="000066"><i>it</i></font> <font color="333333">.</font> <font color="566874">id</font> <font color="000066"><b>}</b></font> ::get</code> <br> <br>  Pode-se ver que nada mudou muito.  O uso de uma certa quantidade de magia Kotlin nos ajudou com isso: <br><br> <code><font color="7f0055"><b>fun</b></font> <font color="333333">&lt;</font> <font color="000066"><i>T</i></font> <font color="333333">,</font> <font color="000066"><i>R</i></font> <font color="333333">&gt;</font> <font color="3e7eff"><b>Stream</b></font> <font color="333333">&lt;</font> <font color="7f0055"><b>out</b></font> <font color="000066"><i>T</i></font> <font color="333333">&gt;.</font> <font color="170591"><b>chunked</b></font> <font color="000066">(</font> <font color="000066"><i>size</i></font> : <font color="3e7eff"><b>Int</b></font> <font color="333333">,</font> <font color="000066"><i>transform</i></font> : <font color="000066">(</font> <font color="3e7eff"><b>List</b></font> <font color="333333">&lt;</font> <font color="000066"><i>T</i></font> <font color="333333">&gt;</font> <font color="000066">) -&gt;</font> <font color="000066"><i>R</i></font> <font color="000066">)</font> : <font color="3e7eff"><b>Stream</b></font> <font color="333333">&lt;</font> <font color="7f0055"><b>out</b></font> <font color="000066"><i>R</i></font> <font color="333333">&gt; =</font> <br> <i><b>batches</b></i> <font color="000066">(</font> <font color="7f0055"><b>this</b></font> <font color="333333">,</font> <font color="000066"><i>size</i></font> <font color="000066">)</font> <font color="333333">.</font> <font color="170591">map</font> <font color="000066">(</font> <font color="000066"><i>transform</i></font> <font color="000066">)</font> <br> <br> <font color="7f0055"><b>fun</b></font> <font color="333333">&lt;</font> <font color="000066"><i>T</i></font> <font color="333333">&gt;</font> <font color="3e7eff"><b>Stream</b></font> <font color="333333">&lt;</font> <font color="7f0055"><b>out</b></font> <font color="3e7eff"><b>Collection</b></font> <font color="333333">&lt;</font> <font color="000066"><i>T</i></font> <font color="333333">&gt;&gt;.</font> <font color="170591"><b>flatten</b></font> <font color="000066">()</font> : <font color="3e7eff"><b>Stream</b></font> <font color="333333">&lt;</font> <font color="000066"><i>T</i></font> <font color="333333">&gt; =</font> <br> <font color="170591">flatMap</font> <font color="000066"><b>{</b></font> <font color="000066"><i>it</i></font> <font color="333333">.</font> <font color="170591">stream</font> <font color="000066">()</font> <font color="000066"><b>}</b></font> <br> <br> <font color="7f0055"><b>fun</b></font> <font color="333333">&lt;</font> <font color="000066"><i>T</i></font> <font color="333333">,</font> <font color="000066"><i>K</i></font> <font color="333333">&gt;</font> <font color="3e7eff"><b>Stream</b></font> <font color="333333">&lt;</font> <font color="000066"><i>T</i></font> <font color="333333">&gt;.</font> <font color="170591"><b>associateBy</b></font> <font color="000066">(</font> <font color="000066"><i>keySelector</i></font> : <font color="000066">(</font> <font color="000066"><i>T</i></font> <font color="000066">) -&gt;</font> <font color="000066"><i>K</i></font> <font color="000066">)</font> : <font color="3e7eff"><b>Map</b></font> <font color="333333">&lt;</font> <font color="000066"><i>K</i></font> <font color="333333">,</font> <font color="000066"><i>T</i></font> <font color="333333">&gt; =</font> <br> <font color="170591">collect</font> <font color="000066">(</font> <font color="3e7eff"><b>Collectors</b></font> <font color="333333">.</font> <font color="170591">toMap</font> <font color="000066">(</font> <font color="000066"><i>keySelector</i></font> <font color="333333">,</font> <font color="000066"><b>{</b></font> <b>it</b> <font color="000066"><b>}</b></font> <font color="000066">))</font></code> <br> <br><div class="spoiler">  <b class="spoiler_title">Agora resta juntar tudo:</b> <div class="spoiler_text"> <code><font color="7f0055"><b>override fun</b></font> <font color="170591"><b>getLast</b></font> <font color="000066">(</font> <font color="000066"><i>n</i></font> : <font color="3e7eff"><b>Int</b></font> <font color="000066">)</font> <font color="333333">=</font> <br> <font color="566874">messageRepository</font> <font color="333333">.</font> <font color="170591">findLast</font> <font color="000066">(</font> <font color="000066"><i>n</i></font> <font color="000066">)</font> <br> <font color="333333">.</font> <i><b>let</b></i> <font color="000066"><b>{</b></font> <font color="000066"><i>messages</i></font> <font color="000066"><b>-&gt;</b></font> <br> <font color="000066"><b>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</b></font> <font color="3f7f5f">//    ,  forward  reply</font> <br> <font color="7f0055"><b>val</b></font> <font color="170591">allMessages</font> <font color="333333">=</font> <font color="000066"><i>messages</i></font> <font color="333333">.</font> <i><b>asSequence</b></i> <font color="000066">()</font> <font color="333333">.</font> <i><b>flatMap</b></i> <font color="000066"><b>{</b></font> <font color="000066"><i>message</i></font> <font color="000066"><b>-&gt;</b></font> <br> <font color="000066"><b>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</b></font> <i><b>sequenceOf</b></i> <font color="000066">(</font> <font color="000066"><i>message</i></font> <font color="333333">,</font> <font color="000066"><i>message</i></font> <font color="333333">.</font> <font color="566874">forwardFrom</font> <font color="333333">,</font> <font color="000066"><i>message</i></font> <font color="333333">.</font> <font color="566874">replyTo</font> <font color="000066">)</font> <br> <font color="333333">.</font> <i><b>filterNotNull</b></i> <font color="000066">()</font> <br> <font color="000066"><b>}</b></font> <font color="333333">.</font> <i><b>toSet</b></i> <font color="000066">()</font> <br> <br> <font color="000066"><i>messages</i></font> <font color="333333">.</font> <i><b>map</b></i> <font color="000066">(</font> <font color="170591">ValueHolder</font> <font color="333333">&lt;</font> <font color="000066">(</font> <font color="3e7eff"><b>ChatMessage</b></font> <font color="000066">) -&gt;</font> <font color="3e7eff"><b>ChatMessageUI</b></font> <font color="333333">&gt;</font> <font color="000066">()</font> <font color="333333">.</font> <i><b>apply</b></i> <font color="000066"><b>{</b></font> <br> <font color="000066"><b>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</b></font> <font color="566874">value</font> <font color="333333">=</font> <i><b>memoize</b></i> <font color="000066"><b>{</b></font> <font color="000066"><i>message</i></font> : <font color="3e7eff"><b>ChatMessage</b></font> <font color="000066"><b>-&gt;</b></font> <br> <font color="000066"><b>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</b></font> <font color="000066"><i>message</i></font> <font color="333333">.</font> <i><b>toFrontModel</b></i> <font color="000066">(</font> <br> <font color="3f7f5f">//       ,    </font> <br> <font color="4a86e8">getUser =</font> <font color="3e7eff"><b>allMessages</b></font> <font color="333333">.</font> <i><b>map</b></i> <font color="000066"><b>{</b></font> <b>it</b> <font color="333333">.</font> <font color="566874">author</font> <font color="000066"><b>}</b></font> <font color="333333">.</font> <font color="170591">parallelStream</font> <font color="000066">()</font> <font color="333333">.</font> <font color="170591">distinct</font> <font color="000066">()</font> <br> <font color="333333">.</font> <i><b>chunked</b></i> <font color="000066">(</font> <font color="05314d"><b>userApiChunkLimit</b></font> <font color="333333">,</font> <font color="566874">userRepository</font> ::getUsersByIds <font color="000066">)</font> <br> <font color="333333">.</font> <i><b>flatten</b></i> <font color="000066">()</font> <br> <font color="333333">.</font> <i><b>associateBy</b></i> <font color="000066"><b>{</b></font> <b>it</b> <font color="333333">.</font> <font color="566874">id</font> <font color="000066"><b>}</b></font> ::get <font color="333333">.</font> <i><b>orThrow</b></i> <font color="000066"><b>{</b></font> <font color="170591">IllegalArgumentException</font> <font color="000066">(</font> <b>"User</b> <font color="333333"><b>$</b></font> <b>it"</b> <font color="000066">)</font> <font color="000066"><b>}</b></font> <font color="333333">,</font> <br> <font color="3f7f5f">//        </font> <br> <font color="4a86e8">getFile =</font> <font color="566874">fileRepository</font> <font color="333333">.</font> <font color="170591">getHeadsByIds</font> <font color="000066">(</font> <font color="3e7eff"><b>allMessages</b></font> <font color="333333">.</font> <i><b>flatMap</b></i> <font color="000066"><b>{</b></font> <font color="000066"><i>it</i></font> <font color="333333">.</font> <font color="566874">files</font> ?: <i><b>listOf</b></i> <font color="000066">()</font> <font color="000066"><b>}</b></font> <font color="333333">.</font> <i><b>toSet</b></i> <font color="000066">())</font> <br> <font color="333333">.</font> <i><b>associateBy</b></i> <font color="000066"><b>{</b></font> <font color="000066"><i>it</i></font> <font color="333333">.</font> <font color="566874">id</font> <font color="000066"><b>}</b></font> ::get <font color="333333">.</font> <i><b>orThrow</b></i> <font color="000066"><b>{</b></font> <font color="170591">IllegalArgumentException</font> <font color="000066">(</font> <b>"File</b> <font color="333333"><b>$</b></font> <b>it"</b> <font color="000066">)</font> <font color="000066"><b>}</b></font> <font color="333333">,</font> <br> <font color="3f7f5f">//       </font> <br> <font color="4a86e8">serializeMessage =</font> <font color="566874">value</font> <br> <font color="000066">)</font> <br> <font color="000066"><b>}</b></font> <br> <font color="000066"><b>}</b></font> <font color="333333">.</font> <font color="566874">value</font> <font color="000066">)</font> <br> <font color="000066"><b>}</b></font></code> </div> </div><br><div class="spoiler">  <b class="spoiler_title">Explica√ß√µes e simplifica√ß√µes</b> <div class="spoiler_text">  A primeira coisa que certamente chamar√° sua aten√ß√£o √© a fun√ß√£o de memoriza√ß√£o.  O fato √© que a fun√ß√£o serializeMessage quase certamente ser√° chamada v√°rias vezes para as mesmas mensagens (devido √† resposta e encaminhamento).  N√£o est√° claro por que devemos fazer o toFrontModel separadamente para cada uma dessas mensagens (em alguns casos, isso pode ser necess√°rio, mas n√£o o nosso).  Portanto, voc√™ pode executar memoriza√ß√£o para a fun√ß√£o serializeMessage.  Isso √© implementado, por exemplo, da seguinte maneira: <br><br> <code><font color="7f0055"><b>fun</b></font> <font color="333333">&lt;</font> <font color="000066"><i>A</i></font> <font color="333333">,</font> <font color="000066"><i>R</i></font> <font color="333333">&gt;</font> <font color="170591"><b>memoize</b></font> <font color="000066">(</font> <font color="000066"><i>func</i></font> : <font color="000066">(</font> <font color="000066"><i>A</i></font> <font color="000066">) -&gt;</font> <font color="000066"><i>R</i></font> <font color="000066">)</font> <font color="333333">=</font> <font color="000066"><i>func</i></font> <font color="7f0055"><b>as?</b></font> <font color="3e7eff"><b>Memoize2</b></font> ?: <font color="170591">Memoize2</font> <font color="000066">(</font> <font color="000066"><i>func</i></font> <font color="000066">)</font> <br> <font color="7f0055"><b>class</b></font> <font color="3e7eff"><b>Memoize2</b></font> <font color="333333">&lt;</font> <font color="000066"><i>A</i></font> <font color="333333">,</font> <font color="000066"><i>R</i></font> <font color="333333">&gt;</font> <font color="000066">(</font> <font color="7f0055"><b>val</b></font> <font color="566874">func</font> : <font color="000066">(</font> <font color="000066"><i>A</i></font> <font color="000066">) -&gt;</font> <font color="000066"><i>R</i></font> <font color="000066">)</font> : <font color="000066">(</font> <font color="000066"><i>A</i></font> <font color="000066">) -&gt;</font> <font color="000066"><i>R</i></font> <font color="333333">,</font> java <font color="333333">.</font> util <font color="333333">.</font> function <font color="333333">.</font> <font color="3e7eff"><b>Function</b></font> <font color="333333">&lt;</font> <font color="000066"><i>A</i></font> <font color="333333">,</font> <font color="000066"><i>R</i></font> <font color="333333">&gt;</font> <font color="000066">{</font> <br> <font color="7f0055"><b>private val</b></font> <font color="566874">cache</font> <font color="333333">=</font> <i><b>hashMapOf</b></i> <font color="333333">&lt;</font> <font color="000066"><i>A</i></font> <font color="333333">,</font> <font color="000066"><i>R</i></font> <font color="333333">&gt;</font> <font color="000066">()</font> <br> <font color="7f0055"><b>override fun</b></font> <font color="170591"><b>invoke</b></font> <font color="000066">(</font> <font color="000066"><i>p1</i></font> : <font color="000066"><i>A</i></font> <font color="000066">)</font> <font color="333333">=</font> <font color="566874">cache</font> <font color="333333">.</font> <i><b>getOrPut</b></i> <font color="000066">(</font> <font color="000066"><i>p1</i></font> <font color="333333">,</font> <font color="000066"><b>{</b></font> <font color="566874">func</font> <font color="000066">(</font> <font color="000066"><i>p1</i></font> <font color="000066">)</font> <font color="000066"><b>}</b></font> <font color="000066">)</font> <br> <font color="7f0055"><b>override fun</b></font> <font color="170591"><b>apply</b></font> <font color="000066">(</font> <font color="000066"><i>t</i></font> : <font color="000066"><i>A</i></font> <font color="000066">)</font> : <font color="000066"><i>R</i></font> <font color="333333">=</font> <font color="170591">invoke</font> <font color="000066">(</font> <font color="000066"><i>t</i></font> <font color="000066">)</font> <br> <font color="000066">}</font></code> <br> <br>  Em seguida, precisamos construir uma fun√ß√£o memorizada serializeMessage, mas ao mesmo tempo ser√° usada dentro dela.  √â importante usar exatamente a mesma inst√¢ncia da fun√ß√£o dentro, caso contr√°rio, toda a memoriza√ß√£o ir√° pelo ralo.  Para resolver essa colis√£o, usamos a classe ValueHolder, que simplesmente armazena uma refer√™ncia ao valor (voc√™ pode usar algo padr√£o em vez disso, por exemplo, AtomicReference).  Para encurtar o registro de recurs√£o, voc√™ pode fazer o seguinte: <br><br> <code><font color="7f0055"><b>inline fun</b></font> <font color="333333">&lt;</font> <font color="000066"><i>A</i></font> <font color="333333">,</font> <font color="000066"><i>R</i></font> <font color="333333">&gt;</font> <font color="170591"><b>recursiveMemoize</b></font> <font color="000066">(</font> <font color="7f0055"><b>crossinline</b></font> <font color="000066"><i>func</i></font> : <font color="000066">(</font> <font color="000066"><i>A</i></font> <font color="333333">,</font> <font color="000066">(</font> <font color="000066"><i>A</i></font> <font color="000066">) -&gt;</font> <font color="000066"><i>R</i></font> <font color="000066">) -&gt;</font> <font color="000066"><i>R</i></font> <font color="000066">)</font> : <font color="000066">(</font> <font color="000066"><i>A</i></font> <font color="000066">) -&gt;</font> <font color="000066"><i>R</i></font> <font color="333333">=</font> <br> <font color="170591">ValueHolder</font> <font color="333333">&lt;</font> <font color="000066">(</font> <font color="000066"><i>A</i></font> <font color="000066">) -&gt;</font> <font color="000066"><i>R</i></font> <font color="333333">&gt;</font> <font color="000066">()</font> <font color="333333">.</font> <i><b>apply</b></i> <font color="000066"><b>{</b></font> <br> <font color="000066"><b>&nbsp;&nbsp;&nbsp;&nbsp;</b></font> <font color="566874">value</font> <font color="333333">=</font> <i><b>memoize</b></i> <font color="000066"><b>{</b></font> <font color="000066"><i>a</i></font> <font color="000066"><b>-&gt;</b></font> <font color="3e7eff"><b>func</b></font> <font color="000066">(</font> <font color="000066"><i>a</i></font> <font color="333333">,</font> <font color="566874">value</font> <font color="000066">)</font> <font color="000066"><b>}</b></font> <br> <font color="000066"><b>}</b></font> <font color="333333">.</font> <font color="566874">value</font></code> <br> <br>  Se voc√™ conseguiu entender esse silogismo da flecha pela primeira vez - parab√©ns, voc√™ √© um programador funcional :-) <br><br>  Agora o c√≥digo ficar√° assim: <br><br> <code><font color="7f0055"><b>override fun</b></font> <font color="170591"><b>getLast</b></font> <font color="000066">(</font> <font color="000066"><i>n</i></font> : <font color="3e7eff"><b>Int</b></font> <font color="000066">)</font> <font color="333333">=</font> <br> <font color="566874">messageRepository</font> <font color="333333">.</font> <font color="170591">findLast</font> <font color="000066">(</font> <font color="000066"><i>n</i></font> <font color="000066">)</font> <br> <font color="333333">.</font> <i><b>let</b></i> <font color="000066"><b>{</b></font> <font color="000066"><i>messages</i></font> <font color="000066"><b>-&gt;</b></font> <br> <font color="000066"><b>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</b></font> <font color="3f7f5f">//    ,  forward  reply</font> <br> <font color="7f0055"><b>val</b></font> <font color="170591">allMessages</font> <font color="333333">=</font> <font color="000066"><i>messages</i></font> <font color="333333">.</font> <i><b>asSequence</b></i> <font color="000066">()</font> <font color="333333">.</font> <i><b>flatMap</b></i> <font color="000066"><b>{</b></font> <font color="000066"><i>message</i></font> <font color="000066"><b>-&gt;</b></font> <br> <font color="000066"><b>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</b></font> <i><b>sequenceOf</b></i> <font color="000066">(</font> <font color="000066"><i>message</i></font> <font color="333333">,</font> <font color="000066"><i>message</i></font> <font color="333333">.</font> <font color="566874">forwardFrom</font> <font color="333333">,</font> <font color="000066"><i>message</i></font> <font color="333333">.</font> <font color="566874">replyTo</font> <font color="000066">)</font> <br> <font color="333333">.</font> <i><b>filterNotNull</b></i> <font color="000066">()</font> <br> <font color="000066"><b>}</b></font> <font color="333333">.</font> <i><b>toSet</b></i> <font color="000066">()</font> <br> <br> <font color="3f7f5f">//       ,    </font> <br> <font color="7f0055"><b>val</b></font> <font color="170591">getUser</font> <font color="333333">=</font> <font color="170591">allMessages</font> <font color="333333">.</font> <i><b>map</b></i> <font color="000066"><b>{</b></font> <b>it</b> <font color="333333">.</font> <font color="566874">author</font> <font color="000066"><b>}</b></font> <font color="333333">.</font> <font color="170591">parallelStream</font> <font color="000066">()</font> <font color="333333">.</font> <font color="170591">distinct</font> <font color="000066">()</font> <br> <font color="333333">.</font> <i><b>chunked</b></i> <font color="000066">(</font> <font color="05314d"><b>userApiChunkLimit</b></font> <font color="333333">,</font> <font color="566874">userRepository</font> ::getUsersByIds <font color="000066">)</font> <br> <font color="333333">.</font> <i><b>flatten</b></i> <font color="000066">()</font> <br> <font color="333333">.</font> <i><b>associateBy</b></i> <font color="000066"><b>{</b></font> <font color="000066"><i>it</i></font> <font color="333333">.</font> <font color="566874">id</font> <font color="000066"><b>}</b></font> ::get <font color="333333">.</font> <i><b>orThrow</b></i> <font color="000066"><b>{</b></font> <font color="170591">IllegalArgumentException</font> <font color="000066">(</font> <b>"User</b> <font color="333333"><b>$</b></font> <font color="000066"><i>it</i></font> <b>"</b> <font color="000066">)</font> <font color="000066"><b>}</b></font> <br> <br> <font color="000066"><b>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</b></font> <font color="3f7f5f">//        </font> <br> <font color="7f0055"><b>val</b></font> <font color="170591">getFile</font> <font color="333333">=</font> <font color="566874">fileRepository</font> <font color="333333">.</font> <font color="170591">getHeadsByIds</font> <font color="000066">(</font> <font color="170591">allMessages</font> <font color="333333">.</font> <i><b>flatMap</b></i> <font color="000066"><b>{</b></font> <b>it</b> <font color="333333">.</font> <font color="566874">files</font> ?: <i><b>listOf</b></i> <font color="000066">()</font> <font color="000066"><b>}</b></font> <font color="333333">.</font> <i><b>toSet</b></i> <font color="000066">())</font> <br> <font color="333333">.</font> <i><b>associateBy</b></i> <font color="000066"><b>{</b></font> <font color="000066"><i>it</i></font> <font color="333333">.</font> <font color="566874">id</font> <font color="000066"><b>}</b></font> ::get <font color="333333">.</font> <i><b>orThrow</b></i> <font color="000066"><b>{</b></font> <font color="170591">IllegalArgumentException</font> <font color="000066">(</font> <b>"File</b> <font color="333333"><b>$</b></font> <b>it"</b> <font color="000066">)</font> <font color="000066"><b>}</b></font> <br> <br> <font color="000066"><b>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</b></font> <font color="000066"><i>messages</i></font> <font color="333333">.</font> <i><b>map</b></i> <font color="000066">(</font> <i><b>recursiveMemoize</b></i> <font color="000066"><b>{</b></font> <font color="000066"><i>message</i></font> <font color="333333">,</font> <font color="000066"><i>memoized</i></font> : <font color="000066">(</font> <font color="3e7eff"><b>ChatMessage</b></font> <font color="000066">) -&gt;</font> <font color="3e7eff"><b>ChatMessageUI</b></font> <font color="000066"><b>-&gt;</b></font> <br> <font color="000066"><b>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</b></font> <font color="000066"><i>message</i></font> <font color="333333">.</font> <i><b>toFrontModel</b></i> <font color="000066">(</font> <br> <font color="4a86e8">getUser =</font> <font color="170591">getUser</font> <font color="333333">,</font> <br> <font color="4a86e8">getFile =</font> <font color="170591">getFile</font> <font color="333333">,</font> <br> <font color="3f7f5f">//       </font> <br> <font color="4a86e8">serializeMessage =</font> <font color="000066"><i>memoized</i></font> <br> <font color="000066"><i>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</i></font> <font color="000066">)</font> <br> <font color="000066"><b>}</b></font> <font color="000066">)</font></code> <br> <br>  Voc√™ tamb√©m pode observar o orThrow, que √© definido assim: <br><br> <code><font color="395da1">/**  </font> <font color="3d3d3d"><i><b>[exception]</b></i></font> <font color="395da1">,    null */</font> <br> <font color="7f0055"><b>fun</b></font> <font color="333333">&lt;</font> <font color="000066"><i>P</i></font> <font color="333333">,</font> <font color="000066"><i>R</i></font> <font color="333333">&gt;</font> <font color="000066">((</font> <font color="000066"><i>P</i></font> <font color="000066">) -&gt;</font> <font color="000066"><i>R</i></font> ? <font color="000066">)</font> <font color="333333">.</font> <font color="170591"><b>orThrow</b></font> <font color="000066">(</font> <font color="000066"><i>exception</i></font> : <font color="000066">(</font> <font color="000066"><i>P</i></font> <font color="000066">) -&gt;</font> <font color="3e7eff"><b>Exception</b></font> <font color="000066">)</font> : <font color="000066">(</font> <font color="000066"><i>P</i></font> <font color="000066">) -&gt;</font> <font color="000066"><i>R</i></font> <font color="333333">=</font> <br> <font color="000066"><b>{</b></font> <font color="000066"><i>p</i></font> <font color="000066"><b>-&gt;</b></font> <font color="170591">invoke</font> <font color="000066">(</font> <font color="000066"><i>p</i></font> <font color="000066">)</font> <font color="333333">.</font> <i><b>let</b></i> <font color="000066"><b>{</b></font> <b>it</b> ?: <font color="7f0055"><b>throw</b></font> <font color="3e7eff"><b>exception</b></font> <font color="000066">(</font> <font color="000066"><i>p</i></font> <font color="000066">)</font> <font color="000066"><b>} }</b></font></code> <br> <br>  Se n√£o houver dados sobre nosso ID em servi√ßos externos e isso for considerado uma situa√ß√£o legal, voc√™ precisar√° lidar com isso de alguma maneira diferente. <br><br>  Ap√≥s essa corre√ß√£o, espera-se que o tempo de execu√ß√£o getLast seja de cerca de 300 ms.  Al√©m disso, esse tempo aumentar√° um pouco, mesmo que as solicita√ß√µes n√£o se ajustem mais √†s restri√ß√µes no tamanho dos pacotes (j√° que os pacotes s√£o solicitados em paralelo).  Deixe-me lembr√°-lo de que nossa meta m√≠nima √© de 500 ms e 250 ms podem ser considerados um trabalho normal. </div></div><br><a name="Parallelism"></a>  <b>Paralelismo</b> <br><br>  Mas voc√™ precisa seguir em frente.  As chamadas para userRepository e fileRepository s√£o completamente independentes e podem ser facilmente paralelizadas, em teoria aproximando-se de 200 ms. <br><br><div class="spoiler">  <b class="spoiler_title">Por exemplo, atrav√©s da nossa fun√ß√£o de jun√ß√£o:</b> <div class="spoiler_text"> <code><font color="7f0055"><b>override fun</b></font> <font color="170591"><b>getLast</b></font> <font color="000066">(</font> <font color="000066"><i>n</i></font> : <font color="3e7eff"><b>Int</b></font> <font color="000066">)</font> <font color="333333">=</font> <br> <font color="566874">messageRepository</font> <font color="333333">.</font> <font color="170591">findLast</font> <font color="000066">(</font> <font color="000066"><i>n</i></font> <font color="000066">)</font> <br> <font color="333333">.</font> <i><b>let</b></i> <font color="000066"><b>{</b></font> <font color="000066"><i>messages</i></font> <font color="000066"><b>-&gt;</b></font> <br> <font color="000066"><b>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</b></font> <font color="3f7f5f">//    ,  forward  reply</font> <br> <font color="7f0055"><b>val</b></font> <font color="170591">allMessages</font> <font color="333333">=</font> <font color="000066"><i>messages</i></font> <font color="333333">.</font> <i><b>asSequence</b></i> <font color="000066">()</font> <font color="333333">.</font> <i><b>flatMap</b></i> <font color="000066"><b>{</b></font> <font color="000066"><i>message</i></font> <font color="000066"><b>-&gt;</b></font> <br> <font color="000066"><b>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</b></font> <i><b>sequenceOf</b></i> <font color="000066">(</font> <font color="000066"><i>message</i></font> <font color="333333">,</font> <font color="000066"><i>message</i></font> <font color="333333">.</font> <font color="566874">forwardFrom</font> <font color="333333">,</font> <font color="000066"><i>message</i></font> <font color="333333">.</font> <font color="566874">replyTo</font> <font color="000066">)</font> <br> <font color="333333">.</font> <i><b>filterNotNull</b></i> <font color="000066">()</font> <br> <font color="000066"><b>}</b></font> <font color="333333">.</font> <i><b>toSet</b></i> <font color="000066">()</font> <br> <br> <i><b>join</b></i> <font color="000066">(</font> <font color="000066"><b>{</b></font> <br> <font color="000066"><b>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</b></font> <font color="3f7f5f">//       ,    </font> <br> <font color="3e7eff"><b>allMessages</b></font> <font color="333333">.</font> <i><b>map</b></i> <font color="000066"><b>{</b></font> <b>it</b> <font color="333333">.</font> <font color="566874">author</font> <font color="000066"><b>}</b></font> <font color="333333">.</font> <font color="170591">parallelStream</font> <font color="000066">()</font> <font color="333333">.</font> <font color="170591">distinct</font> <font color="000066">()</font> <br> <font color="333333">.</font> <i><b>chunked</b></i> <font color="000066">(</font> <font color="05314d"><b>userApiChunkLimit</b></font> <font color="333333">,</font> <font color="566874">userRepository</font> ::getUsersByIds <font color="000066">)</font> <br> <font color="333333">.</font> <i><b>flatten</b></i> <font color="000066">()</font> <br> <font color="333333">.</font> <i><b>associateBy</b></i> <font color="000066"><b>{</b></font> <font color="000066"><i>it</i></font> <font color="333333">.</font> <font color="566874">id</font> <font color="000066"><b>}</b></font> <br> <font color="000066"><b>}</b></font> <font color="333333">,</font> <font color="000066"><b>{</b></font> <br> <font color="000066"><b>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</b></font> <font color="3f7f5f">//        </font> <br> <font color="566874">fileRepository</font> <font color="333333">.</font> <font color="170591">getHeadsByIds</font> <font color="000066">(</font> <font color="3e7eff"><b>allMessages</b></font> <font color="333333">.</font> <i><b>flatMap</b></i> <font color="000066"><b>{</b></font> <font color="000066"><i>it</i></font> <font color="333333">.</font> <font color="566874">files</font> ?: <i><b>listOf</b></i> <font color="000066">()</font> <font color="000066"><b>}</b></font> <font color="333333">.</font> <i><b>toSet</b></i> <font color="000066">())</font> <br> <font color="333333">.</font> <i><b>associateBy</b></i> <font color="000066"><b>{</b></font> <b>it</b> <font color="333333">.</font> <font color="566874">id</font> <font color="000066"><b>}</b></font> <br> <font color="000066"><b>}</b></font> <font color="000066">)</font> <font color="333333">.</font> <i><b>let</b></i> <font color="000066"><b>{</b></font> <font color="000066">(</font> <font color="170591">users</font> <font color="333333">,</font> <font color="170591">files</font> <font color="000066">)</font> <font color="000066"><b>-&gt;</b></font> <br> <font color="000066"><b>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</b></font> <font color="000066"><i>messages</i></font> <font color="333333">.</font> <i><b>map</b></i> <font color="000066">(</font> <i><b>recursiveMemoize</b></i> <font color="000066"><b>{</b></font> <font color="000066"><i>message</i></font> <font color="333333">,</font> <font color="000066"><i>memoized</i></font> : <font color="000066">(</font> <font color="3e7eff"><b>ChatMessage</b></font> <font color="000066">) -&gt;</font> <font color="3e7eff"><b>ChatMessageUI</b></font> <font color="000066"><b>-&gt;</b></font> <br> <font color="000066"><b>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</b></font> <font color="000066"><i>message</i></font> <font color="333333">.</font> <i><b>toFrontModel</b></i> <font color="000066">(</font> <br> <font color="4a86e8">getUser =</font> <font color="170591">users</font> ::get <font color="333333">.</font> <i><b>orThrow</b></i> <font color="000066"><b>{</b></font> <font color="170591">IllegalArgumentException</font> <font color="000066">(</font> <b>"User</b> <font color="333333"><b>$</b></font> <b>it"</b> <font color="000066">)</font> <font color="000066"><b>}</b></font> <font color="333333">,</font> <br> <font color="4a86e8">getFile =</font> <font color="170591">files</font> ::get <font color="333333">.</font> <i><b>orThrow</b></i> <font color="000066"><b>{</b></font> <font color="170591">IllegalArgumentException</font> <font color="000066">(</font> <b>"File</b> <font color="333333"><b>$</b></font> <font color="000066"><i>it</i></font> <b>"</b> <font color="000066">)</font> <font color="000066"><b>}</b></font> <font color="333333">,</font> <br> <font color="3f7f5f">//       </font> <br> <font color="4a86e8">serializeMessage =</font> <font color="000066"><i>memoized</i></font> <br> <font color="000066"><i>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</i></font> <font color="000066">)</font> <br> <font color="000066"><b>}</b></font> <font color="000066">)</font> <br> <font color="000066"><b>}</b></font> <br> <font color="000066"><b>}</b></font></code> </div> </div><br>  Como mostra a pr√°tica, a execu√ß√£o leva cerca de 200 ms e √© muito importante que o tempo n√£o cres√ßa muito com um aumento no n√∫mero de mensagens. <br><br><a name="Problems"></a>  <b>Os problemas</b> <br><br>  Em geral, o c√≥digo tornou-se, √© claro, menos leg√≠vel que a nossa primeira vers√£o ing√™nua, mas √© bom que a pr√≥pria serializa√ß√£o (a implementa√ß√£o do toFrontModel) quase n√£o tenha mudado e permane√ßa completamente leg√≠vel.  Toda a l√≥gica do trabalho astuto com servi√ßos externos vive em um s√≥ lugar. <br><br>  A desvantagem dessa abordagem √© que nossa abstra√ß√£o est√° em andamento. <br><br>  Se precisarmos fazer altera√ß√µes no toFrontModel, quase certamente teremos que fazer altera√ß√µes na fun√ß√£o getLast, que viola o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">princ√≠pio da substitui√ß√£o Barbara Liskov</a> (Princ√≠pio da Substitui√ß√£o Liskov). <br><br>  Por exemplo, concordamos em descriptografar os arquivos anexados apenas nas mensagens principais, mas n√£o nas respostas e encaminhamentos (resposta / encaminhamento), ou apenas nas respostas e encaminhamentos do primeiro n√≠vel.  Nesse caso, depois de fazer altera√ß√µes no c√≥digo toFrontModel, voc√™ precisar√° fazer as corre√ß√µes correspondentes no c√≥digo de coleta de solicita√ß√£o de arquivos.  Al√©m disso, a corre√ß√£o n√£o ser√° trivial: <br><br> <code><font color="566874">fileRepository</font> <font color="333333">.</font> <font color="170591">getHeadsByIds</font> <font color="000066">(</font> <br> <font color="3e7eff"><b>allMessages</b></font> <font color="333333">.</font> <i><b>flatMap</b></i> <font color="000066"><b>{</b></font> <font color="000066"><i>it</i></font> <font color="333333">.</font> <font color="566874">files</font> ?: <i><b>listOf</b></i> <font color="000066">()</font> <font color="000066"><b>}</b></font> <font color="333333">.</font> <i><b>toSet</b></i> <font color="000066">()</font> <br> <font color="000066">)</font></code> <br> <br>  E aqui estamos abordando sem problemas outro problema que est√° intimamente relacionado ao anterior: a opera√ß√£o correta do c√≥digo como um todo depende da alfabetiza√ß√£o da engenharia reversa.  Em alguns casos complexos, o c√≥digo pode n√£o funcionar corretamente com precis√£o devido √† cole√ß√£o de consultas incorreta.  N√£o h√° garantia de que voc√™ ser√° capaz de apresentar rapidamente testes de unidade que cobrir√£o todas essas situa√ß√µes complicadas. <br><br><a name="Summary1"></a>  <b>Conclus√µes</b> <br><br>  Pr√≥s: <br><br><ol><li>  Uma maneira √≥bvia de pr√©-receber solicita√ß√µes, que √© facilmente separada do c√≥digo principal. </li><li>  A quase completa aus√™ncia de sobrecarga de mem√≥ria e tempo associada ao uso apenas dos dados que teriam sido recebidos de qualquer maneira. </li><li>  Boa escala e capacidade de criar um servi√ßo, que em teoria ser√° respons√°vel por um tempo previs√≠vel, independentemente do tamanho da solicita√ß√£o externa. </li></ol><br>  Contras: <br><br><ol><li>  C√≥digo bastante complexo para o processamento em lote. </li><li>  Trabalho grande e respons√°vel na an√°lise de solicita√ß√µes na implementa√ß√£o existente. </li><li>  A abstra√ß√£o fluida e, como conseq√º√™ncia, a fragilidade de todo o esquema em rela√ß√£o √†s mudan√ßas na implementa√ß√£o. </li><li>  Dificuldades no suporte: √© dif√≠cil distinguir os erros no bloco de previs√£o de consultas dos erros no c√≥digo principal.  Idealmente, voc√™ precisa usar o dobro de testes de unidade; portanto, procedimentos com erros de produ√ß√£o ser√£o duas vezes mais dif√≠ceis. </li><li>  Cumprindo os princ√≠pios do SOLID ao escrever o c√≥digo: o c√≥digo deve ser preparado para alienar a l√≥gica do processamento em lote.  A introdu√ß√£o desses princ√≠pios por si s√≥ fornecer√° algumas vantagens, portanto esse menos √© o mais insignificante. </li></ol><br>  √â importante observar que voc√™ pode usar esse m√©todo sem fazer engenharia reversa.  Precisamos obter um contrato getLast, do qual o contrato para o c√°lculo preliminar de solicita√ß√µes depende (daqui em diante - pr√©-busca).  Nesse caso, fizemos isso observando a implementa√ß√£o de getLast (engenharia reversa).  No entanto, com essa abordagem, surgem dificuldades: a edi√ß√£o desses dois peda√ßos de c√≥digo sempre deve ser s√≠ncrona e √© imposs√≠vel garantir isso (lembre-se de hashCode e igual, existe exatamente a mesma coisa).  A pr√≥xima abordagem, que eu gostaria de mostrar, √© projetada para resolver esse problema (ou pelo menos atenuar). <br><br><a name="BusinessHeuristics"></a><h4>  Heur√≠stica de neg√≥cios </h4><br><a name="ManagingContractProblem1"></a>  <b>Resolvendo um problema de contrato</b> <br><br>  E se operarmos n√£o com um contrato exato e, portanto, com um conjunto exato de solicita√ß√µes, mas com um contrato aproximado?  Al√©m disso, criaremos um conjunto aproximado para incluir estritamente o conjunto exato e basear-se nas caracter√≠sticas da √°rea de assunto. <br><br>  Portanto, em vez da depend√™ncia do contrato de pr√©-busca no getLast, estabelecemos a depend√™ncia de ambos em algum contrato comum que ser√° ditado pelo usu√°rio.  A principal dificuldade ser√° de alguma forma incorporar esse contrato geral na forma de c√≥digo. <br><br><a name="UsefulRestrictions"></a>  <b>Procure limita√ß√µes √∫teis</b> <br><br>  Vamos tentar fazer isso com o nosso exemplo. <br>  No nosso caso, existem os seguintes recursos comerciais: <br><br><ul><li>  a lista de participantes do bate-papo √© predefinida; </li><li>  os chats s√£o completamente isolados um do outro; </li><li>  o aninhamento de cadeias de resposta / encaminhamento √© pequeno (~ 2 a 3 mensagens). </li></ul><br>  Desde a primeira restri√ß√£o, segue-se que voc√™ n√£o precisa contornar as mensagens, ver quais usu√°rios existem, escolher os √∫nicos e fazer um pedido por eles.  Voc√™ pode simplesmente consultar uma lista predefinida.  Se voc√™ concordou com esta afirma√ß√£o, eu te peguei. <br><br>  De fato, nem tudo √© t√£o simples.  Uma lista pode ser predefinida, mas pode haver milhares de usu√°rios.  Tais coisas precisam ser esclarecidas.  No nosso caso, normalmente haver√° dois ou tr√™s participantes no chat, raramente mais.  Portanto, √© perfeitamente aceit√°vel receber dados sobre todos eles. <br><br>  Al√©m disso, se a lista de usu√°rios de bate-papo for predeterminada, mas essas informa√ß√µes n√£o estiverem no servi√ßo do usu√°rio (o que √© muito prov√°vel), n√£o haver√° sentido nessas informa√ß√µes.  Faremos um pedido extra para a lista de usu√°rios do bate-papo, e voc√™ ainda precisar√° fazer o pedido para o servi√ßo do usu√°rio. <br><br>  Suponha que as informa√ß√µes sobre a conex√£o de usu√°rios e bate-papo sejam armazenadas no servi√ßo do usu√°rio.  No nosso caso, √© assim, pois a conex√£o √© determinada pelos direitos do usu√°rio.  Em seguida, para os usu√°rios, o c√≥digo de pr√©-busca ser√° exibido: <br><br>  Pode parecer surpreendente aqui que n√£o estamos passando nenhum identificador de bate-papo.  Fiz isso intencionalmente para n√£o bagun√ßar o c√≥digo de exemplo. <br><br>  √Ä primeira vista, nada segue da segunda restri√ß√£o.  De qualquer forma, ainda n√£o consegui nada √∫til dele. <br><br>  J√° usamos a terceira restri√ß√£o anteriormente.  Pode ter um impacto significativo em como armazenamos e recebemos conversas.  N√£o come√ßaremos a desenvolver este t√≥pico, pois ele n√£o tem nada a ver com o controlador REST e o processamento em lote. <br><br>  O que fazer com os arquivos?  Gostaria de obter uma lista de todos os arquivos de bate-papo em uma solicita√ß√£o simples.  Sob os termos da API, precisamos apenas de cabe√ßalhos de arquivo, sem corpos, para que isso n√£o pare√ßa uma tarefa perigosa e que consome muitos recursos. <br><br>  Por outro lado, devemos lembrar que n√£o recebemos todas as mensagens de bate-papo, mas apenas o √∫ltimo N, e pode facilmente acontecer que elas n√£o contenham nenhum arquivo. <br><br>  N√£o pode haver resposta universal: tudo depende das especifica√ß√µes comerciais e dos casos de uso.  Ao criar uma solu√ß√£o de produto, voc√™ pode ter problemas se definir uma heur√≠stica para um caso de uso e, em seguida, os usu√°rios trabalhar√£o com a funcionalidade de uma maneira diferente.  Para demonstra√ß√µes e pr√©-vendas, essa √© uma boa op√ß√£o, mas agora estamos tentando criar um servi√ßo de produ√ß√£o honesto. <br><br>  Portanto, ser√° poss√≠vel fazer heur√≠sticas de neg√≥cios para arquivos aqui apenas com base nos resultados da opera√ß√£o e na coleta de estat√≠sticas (ou ap√≥s uma avalia√ß√£o de um especialista). <br><br>  Como ainda queremos aplicar nosso m√©todo de alguma forma, suponha que as estat√≠sticas mostrem o seguinte: <br><br><ol><li>  Uma conversa t√≠pica come√ßa com uma mensagem que inclui um ou mais arquivos, seguida por mensagens de resposta sem arquivos. </li><li>  Quase todas as mensagens v√™m em conversas t√≠picas. </li><li>  O n√∫mero esperado de arquivos exclusivos em um √∫nico bate-papo √© de ~ 20. </li></ol><br>  Daqui resulta que, para exibir quase todas as mensagens, voc√™ precisar√° obter os cabe√ßalhos de alguns arquivos (porque o ChatMessageUI √© organizado) e que o n√∫mero total de arquivos √© pequeno.  Nesse caso, parece razo√°vel receber todos os arquivos de bate-papo em uma solicita√ß√£o.  Para fazer isso, teremos que adicionar o seguinte √† nossa API para arquivos: <br><br> <code><font color="7f0055"><b>fun</b></font> <font color="170591"><b>getHeadsByChat</b></font> <font color="000066">()</font> : <font color="3e7eff"><b>List</b></font> <font color="333333">&lt;</font> <font color="3e7eff"><b>FileHeadRemote</b></font> <font color="333333">&gt;</font></code> <br> <br>  O m√©todo getHeadsByChat n√£o parece exagerado e criado puramente devido ao nosso desejo de otimizar o desempenho (embora esse tamb√©m seja um bom motivo).  Com frequ√™ncia, nas salas de bate-papo com arquivos, os usu√°rios desejam ver todos os arquivos usados ‚Äã‚Äãe na ordem em que foram adicionados (portanto, usamos Lista). <br><br>  A implementa√ß√£o dessa conex√£o expl√≠cita exigir√° o armazenamento de informa√ß√µes adicionais em um servi√ßo de arquivo ou em nosso aplicativo.  Tudo depende de em qual √°rea de responsabilidade, em nossa opini√£o, essas informa√ß√µes redundantes sobre a conex√£o do arquivo com o bate-papo devem ser armazenadas.  √â redundante porque a mensagem j√° est√° associada ao arquivo e, por sua vez, est√° associada ao bate-papo.  Voc√™ n√£o pode usar a desnormaliza√ß√£o, mas extraia essas informa√ß√µes rapidamente de mensagens, isto √©, dentro do SQL, receba imediatamente todos os arquivos em todo o bate-papo (isso est√° em nosso aplicativo) e solicite todos de uma vez no servi√ßo de arquivos.  Essa op√ß√£o funcionar√° pior se houver muitas mensagens de bate-papo, mas n√£o precisamos de desnormaliza√ß√£o.  Eu ocultaria as duas op√ß√µes atr√°s de getHeadsByChat. <br><br>  O c√≥digo √© o seguinte: <br><br> <code><font color="7f0055"><b>override fun</b></font> getLast <font color="000066">(</font> <font color="000066"><i>n</i></font> : <font color="3e7eff"><b>Int</b></font> <font color="000066">)</font> <font color="333333">=</font> <br> <font color="566874">messageRepository</font> <font color="333333">.</font> <font color="170591">findLast</font> <font color="000066">(</font> <font color="000066"><i>n</i></font> <font color="000066">)</font> <br> <font color="333333">.</font> <i><b>let</b></i> <font color="000066"><b>{</b></font> <font color="000066"><i>messages</i></font> <font color="000066"><b>-&gt;</b></font> <br> <font color="000066"><b>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</b></font> <i><b>join</b></i> <font color="000066">(</font> <br> <font color="000066"><b>{</b></font> <font color="566874">userRepository</font> <font color="333333">.</font> <font color="170591">getUsersByChat</font> <font color="000066">()</font> <font color="333333">.</font> <i><b>associateBy</b></i> <font color="000066"><b>{</b></font> <font color="000066"><i>it</i></font> <font color="333333">.</font> <font color="566874">id</font> <font color="000066"><b>} }</b></font> <font color="333333">,</font> <br> <font color="000066"><b>{</b></font> <font color="566874">fileRepository</font> <font color="333333">.</font> <font color="170591">getHeadsByChat</font> <font color="000066">()</font> <font color="333333">.</font> <i><b>associateBy</b></i> <font color="000066"><b>{</b></font> <b>it</b> <font color="333333">.</font> <font color="566874">id</font> <font color="000066"><b>} }</b></font> <br> <font color="000066"><b>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</b></font> <font color="000066">)</font> <br> <font color="333333">.</font> <i><b>let</b></i> <font color="000066"><b>{</b></font> <font color="3f7f5f">//    </font> <br> <font color="000066"><b>}</b></font> <br> <font color="000066"><b>}</b></font></code> <br> <br>  Pode-se observar que, em compara√ß√£o com a vers√£o anterior, muito pouco mudou e apenas a parte de pr√©-busca foi afetada, o que √© √≥timo. <br><br>  O c√≥digo de pr√©-busca se tornou muito mais curto e claro. <br><br>  O tempo de execu√ß√£o n√£o mudou, o que √© l√≥gico, pois o n√∫mero de solicita√ß√µes permanece o mesmo.  Teoricamente, existem casos em que o dimensionamento ser√° melhor que a engenharia reversa honesta (apenas devido √† remo√ß√£o do link do c√°lculo complexo).  No entanto, situa√ß√µes opostas s√£o igualmente prov√°veis: as heur√≠sticas enfileiram demais.  Como mostra a pr√°tica, se voc√™ conseguir obter heur√≠sticas adequadas, n√£o haver√° altera√ß√µes especiais no tempo de execu√ß√£o. <br><br>  No entanto, isso n√£o √© tudo.  N√£o levamos em conta que agora o recebimento de dados detalhados sobre usu√°rios e arquivos n√£o est√° relacionado ao recebimento de mensagens e solicita√ß√µes podem ser iniciadas em paralelo: <br><br>  Esta op√ß√£o fornece 100 ms est√°veis ‚Äã‚Äãpor solicita√ß√£o. <br><br><a name="Mistakes"></a>  <b>Erros heur√≠sticos</b> <br><br>  E se, ao usar heur√≠sticas, o conjunto de consultas n√£o for maior, mas um pouco menor do que deveria?  Para a maioria das op√ß√µes, essas heur√≠sticas funcionar√£o, mas haver√° exce√ß√µes para as quais voc√™ precisar√° fazer uma solicita√ß√£o separada.  Na minha pr√°tica, essas decis√µes n√£o tiveram √™xito, pois cada exce√ß√£o teve um grande impacto no desempenho e, no final, algum usu√°rio fez uma solicita√ß√£o que consistia inteiramente em exce√ß√µes.  Eu diria que em tais situa√ß√µes √© melhor usar a engenharia reversa, mesmo que o algoritmo de coleta de consultas seja assustador e ileg√≠vel, mas, √© claro, tudo depende da criticidade do servi√ßo. <br><br><a name="Summary2"></a>  <b>Conclus√µes</b> <br><br>  Pr√≥s: <br><br><ol><li>  A l√≥gica das heur√≠sticas de neg√≥cios √© f√°cil de ler e geralmente trivial.  Isso √© bom para entender os limites de aplicabilidade, verificar e modificar o contrato de pr√©-busca. </li><li>  A escalabilidade √© t√£o boa quanto a engenharia reversa. </li><li>  A coer√™ncia do c√≥digo sobre os dados √© reduzida, o que pode levar a uma melhor paraleliza√ß√£o do c√≥digo. </li><li>  A l√≥gica de pr√©-busca, como a l√≥gica principal do controlador REST, √© baseada em requisitos.  Esta √© uma vantagem fraca se os requisitos mudarem com frequ√™ncia. </li></ol><br>  Contras: <br><br><ol><li>  Dos requisitos, n√£o √© t√£o f√°cil derivar heur√≠sticas para previs√µes de consulta.  O esclarecimento dos requisitos pode ser necess√°rio, na medida em que seja pouco compat√≠vel com o √°gil. </li><li>  Voc√™ pode obter dados extras. </li><li>  Para garantir que o contrato de pr√©-busca funcione efetivamente, provavelmente ser√° necess√°rio desnormalizar o armazenamento de dados.<font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Esse √© um sinal de menos, pois essas otimiza√ß√µes seguem a l√≥gica de neg√≥cios e, portanto, provavelmente ser√£o reivindicadas por diferentes processos. </font></font></li></ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Do nosso exemplo, podemos concluir que a aplica√ß√£o dessa abordagem √© muito dif√≠cil e o jogo n√£o vale a pena. </font><font style="vertical-align: inherit;">De fato, em projetos de neg√≥cios reais, o n√∫mero de restri√ß√µes √© enorme e, a partir dessa pilha, voc√™ geralmente consegue obter algo √∫til, o que permite particionar dados ou prever estat√≠sticas. </font><font style="vertical-align: inherit;">A principal vantagem dessa abordagem √© que as restri√ß√µes utilizadas s√£o interpretadas pelos neg√≥cios, portanto, s√£o facilmente compreendidas e validadas. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Geralmente, o maior problema ao tentar usar essa abordagem √© a separa√ß√£o de atividades. </font><font style="vertical-align: inherit;">O desenvolvedor deve estar bem imerso na l√≥gica de neg√≥cios e fazer perguntas aos analistas que esclarecem perguntas, o que exige um certo n√≠vel de iniciativa.</font></font><br><br><a name="DDDAgregates"></a><h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Unidades no estilo DDD </font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Em projetos grandes, geralmente √© poss√≠vel ver o uso de pr√°ticas DDD, pois elas permitem estruturar seu c√≥digo com efici√™ncia. </font><font style="vertical-align: inherit;">N√£o √© necess√°rio usar todos os modelos DDD no projeto - √†s vezes voc√™ pode obter bons retornos mesmo com a introdu√ß√£o de um. </font><font style="vertical-align: inherit;">Considere o conceito de DDD como um agregado. </font><font style="vertical-align: inherit;">Um agregado √© uma uni√£o de entidades logicamente conectadas, cujo trabalho √© realizado apenas atrav√©s da raiz do agregado (geralmente essa √© uma entidade que √© a parte superior do gr√°fico de conectividade da entidade). </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Do ponto de vista da obten√ß√£o de dados, o principal no agregado √© que toda a l√≥gica de trabalhar com listas de entidades est√° em um √∫nico local - o agregado. </font><font style="vertical-align: inherit;">Existem duas abordagens para o que deve ser transferido para a unidade durante sua constru√ß√£o:</font></font><br><br><ol><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Transferimos fun√ß√µes para a unidade para obter dados externos. </font><font style="vertical-align: inherit;">A l√≥gica para determinar os dados necess√°rios vive dentro da unidade.</font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Transferimos todos os dados necess√°rios. </font><font style="vertical-align: inherit;">A l√≥gica para determinar os dados necess√°rios est√° fora do agregado.</font></font></li></ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A escolha da abordagem depende em grande parte da facilidade com que a pr√©-busca pode ser movida para fora do agregado. </font><font style="vertical-align: inherit;">Se a l√≥gica de pr√©-busca √© baseada em heur√≠sticas de neg√≥cios, geralmente √© f√°cil separ√°-la do agregado. </font><font style="vertical-align: inherit;">Levar a l√≥gica al√©m do escopo de um agregado com base na an√°lise de seu uso (engenharia reversa) pode ser perigoso, pois podemos distribuir c√≥digos relacionados logicamente em diferentes classes.</font></font><br><br><a name="EnlargementInside"></a> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A l√≥gica de ampliar consultas dentro de um agregado</font></font></b> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Vamos tentar esbo√ßar um agregado que corresponda ao conceito de "bate-papo". Nossas classes ChatMessage, UserReference, FileReference correspondem ao modelo de armazenamento, para que possam ser renomeadas com algum prefixo apropriado, mas como temos um projeto pequeno, vamos deix√°-lo como est√°. Chamamos o assembly de Chat, e seus componentes s√£o ChatPage e ChatPageMessage: </font><font style="vertical-align: inherit;">At√© o momento, √© obtida muita duplica√ß√£o sem sentido. Isso se deve ao fato de nosso modelo de assunto ser semelhante ao modelo de armazenamento e ambos serem semelhantes ao modelo de front-end. </font><font style="vertical-align: inherit;">Eu uso as classes FileHeadRemote e UserRemote diretamente, para n√£o escrever c√≥digo desnecess√°rio, embora geralmente no dom√≠nio voc√™ deva evitar o uso dessas classes diretamente.</font></font><br><br> <code><font color="7f0055"><b>interface</b></font> <font color="3e7eff"><b>Chat</b></font> <font color="000066">{</font> <br> <font color="7f0055"><b>fun</b></font> <font color="170591"><b>getLastPage</b></font> <font color="000066">(</font> <font color="000066"><i>n</i></font> : <font color="3e7eff"><b>Int</b></font> <font color="000066">)</font> : <font color="3e7eff"><b>ChatPage</b></font> <br> <font color="000066">}</font> <br> <br> <font color="7f0055"><b>interface</b></font> <font color="3e7eff"><b>ChatPage</b></font> <font color="000066">{</font> <br> <font color="7f0055"><b>val</b></font> <font color="566874">messages</font> : <font color="3e7eff"><b>List</b></font> <font color="333333">&lt;</font> <font color="3e7eff"><b>ChatPageMessage</b></font> <font color="333333">&gt;</font> <br> <font color="000066">}</font> <br> <br> <font color="7f0055"><b>data class</b></font> <font color="3e7eff"><b>ChatPageMessage</b></font> <font color="000066">(</font> <br> <font color="7f0055"><b>val</b></font> <font color="566874">id</font> : <font color="3e7eff"><b>Long</b></font> <font color="333333">,</font> <br> <font color="7f0055"><b>val</b></font> <font color="566874">author</font> : <font color="3e7eff"><b>UserRemote</b></font> <font color="333333">,</font> <br> <font color="7f0055"><b>val</b></font> <font color="566874">message</font> : <font color="3e7eff"><b>String</b></font> <font color="333333">,</font> <br> <font color="7f0055"><b>val</b></font> <font color="566874">files</font> : <font color="3e7eff"><b>List</b></font> <font color="333333">&lt;</font> <font color="3e7eff"><b>FileHeadRemote</b></font> <font color="333333">&gt;,</font> <br> <font color="7f0055"><b>val</b></font> <font color="566874">replyTo</font> : <font color="3e7eff"><b>ChatPageMessage</b></font> ? <font color="333333">,</font> <br> <font color="7f0055"><b>val</b></font> <font color="566874">forwardFrom</font> : <font color="3e7eff"><b>ChatPageMessage</b></font> ? <br> <font color="000066">)</font></code> <br> <br><font style="vertical-align: inherit;"></font><br><br><font style="vertical-align: inherit;"></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Se voc√™ usar esse agregado, nosso controlador REST poder√° ser reescrito da seguinte maneira: </font><font style="vertical-align: inherit;">Essa op√ß√£o lembra muito nossa primeira implementa√ß√£o ing√™nua, mas possui uma vantagem importante: o controlador n√£o est√° mais envolvido em receber dados diretamente e n√£o depende das classes associadas ao armazenamento de dados, mas depende somente a partir da unidade, que √© definida atrav√©s das interfaces. </font><font style="vertical-align: inherit;">Portanto, a l√≥gica de pr√©-busca n√£o est√° mais no controlador. </font><font style="vertical-align: inherit;">O controlador lida apenas com a convers√£o da unidade em um modelo front-end, o que nos d√° conformidade com o Princ√≠pio de Responsabilidade √önica (SRP). </font><font style="vertical-align: inherit;">Infelizmente, para todos os m√©todos descritos em conjunto, voc√™ precisar√° escrever uma implementa√ß√£o.</font></font><br><br> <code><font color="7f0055"><b>class</b></font> <font color="3e7eff"><b>ChatRestController</b></font> <font color="000066">(</font> <br> <font color="7f0055"><b>private val</b></font> <font color="566874">chat</font> : <font color="3e7eff"><b>Chat</b></font> <br> <font color="000066">)</font> : <font color="3e7eff"><b>ChatRestApi</b></font> <font color="000066">{</font> <br> <font color="7f0055"><b>override fun</b></font> <font color="170591"><b>getLast</b></font> <font color="000066">(</font> <font color="000066"><i>n</i></font> : <font color="3e7eff"><b>Int</b></font> <font color="000066">)</font> <font color="333333">=</font> <br> <font color="566874">chat</font> <font color="333333">.</font> <font color="170591">getLastPage</font> <font color="000066">(</font> <font color="000066"><i>n</i></font> <font color="000066">)</font> <font color="333333">.</font> <i><b>toFrontModel</b></i> <font color="000066">()</font> <br> <br> <font color="7f0055"><b>private fun</b></font> <font color="3e7eff"><b>ChatPage</b></font> <font color="333333">.</font> <font color="170591"><b>toFrontModel</b></font> <font color="000066">()</font> <font color="333333">=</font> <br> <font color="566874">messages</font> <font color="333333">.</font> <i><b>map</b></i> <font color="000066"><b>{</b></font> <b>it</b> <font color="333333">.</font> <i><b>toFrontModel</b></i> <font color="000066">()</font> <font color="000066"><b>}</b></font> <br> <br> <font color="000066"><b>&nbsp;&nbsp;</b></font> <font color="7f0055"><b>private fun</b></font> <font color="3e7eff"><b>ChatPageMessage</b></font> <font color="333333">.</font> <font color="170591"><b>toFrontModel</b></font> <font color="000066">()</font> : <font color="3e7eff"><b>ChatMessageUI</b></font> <font color="333333">=</font> <br> <font color="170591">ChatMessageUI</font> <font color="000066">(</font> <br> <font color="4a86e8">id =</font> <font color="566874">id</font> <font color="333333">,</font> <br> <font color="4a86e8">author =</font> <font color="566874">author</font> <font color="333333">.</font> <i><b>toFrontReference</b></i> <font color="000066">()</font> <font color="333333">,</font> <br> <font color="4a86e8">message =</font> <font color="566874">message</font> <font color="333333">,</font> <br> <font color="4a86e8">files =</font> <font color="566874">files</font> <font color="333333">.</font> <i><b>toFrontReference</b></i> <font color="000066">()</font> <font color="333333">,</font> <br> <font color="4a86e8">forwardFrom =</font> <font color="566874">forwardFrom</font> <font color="333333">?.</font> <i><b>toFrontModel</b></i> <font color="000066">()</font> <font color="333333">,</font> <br> <font color="4a86e8">replyTo =</font> <font color="566874">replyTo</font> <font color="333333">?.</font> <i><b>toFrontModel</b></i> <font color="000066">()</font> <br> <font color="000066">)</font> <br> <font color="000066">}</font></code> <br> <br><font style="vertical-align: inherit;"></font><br><br><font style="vertical-align: inherit;"></font><br><br><div class="spoiler"> <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Vamos tentar apenas salvar a l√≥gica do controlador implementada ao usar heur√≠sticas de neg√≥cios.</font></font></b> <div class="spoiler_text"> <code><font color="7f0055"><b>class</b></font> <font color="3e7eff"><b>ChatImpl</b></font> <font color="000066">(</font> <br> <font color="7f0055"><b>private val</b></font> <font color="566874">messageRepository</font> : <font color="3e7eff"><b>ChatMessageRepository</b></font> <font color="333333">,</font> <br> <font color="7f0055"><b>private val</b></font> <font color="566874">userRepository</font> : <font color="3e7eff"><b>UserRemoteApi</b></font> <font color="333333">,</font> <br> <font color="7f0055"><b>private val</b></font> <font color="566874">fileRepository</font> : <font color="3e7eff"><b>FileRemoteApi</b></font> <br> <font color="000066">)</font> : <font color="3e7eff"><b>Chat</b></font> <font color="000066">{</font> <br> <font color="7f0055"><b>override fun</b></font> <font color="170591"><b>getLastPage</b></font> <font color="000066">(</font> <font color="000066"><i>n</i></font> : <font color="3e7eff"><b>Int</b></font> <font color="000066">)</font> <font color="333333">=</font> <font color="7f0055"><b>object</b></font> : <font color="3e7eff"><b>ChatPage</b></font> <font color="000066">{</font> <br> <font color="7f0055"><b>override val</b></font> <font color="566874">messages</font> : <font color="3e7eff"><b>List</b></font> <font color="333333">&lt;</font> <font color="3e7eff"><b>ChatPageMessage</b></font> <font color="333333">&gt;</font> <br> <font color="7f0055"><b>get</b></font> <font color="000066">()</font> <font color="333333">=</font> <br> <i><b>runBlocking</b></i> <font color="000066">(</font> <font color="05314d"><b>IO</b></font> <font color="000066">)</font> <font color="000066"><b>{</b></font> <br> <font color="000066"><b>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</b></font> <font color="7f0055"><b>val</b></font> <font color="170591">prefetch</font> <font color="333333">=</font> <i><b>async</b></i> <font color="000066">(</font> <br> <font color="000066"><b>{</b></font> <font color="566874">userRepository</font> <font color="333333">.</font> <font color="170591">getUsersByChat</font> <font color="000066">()</font> <font color="333333">.</font> <i><b>associateBy</b></i> <font color="000066"><b>{</b></font> <b>it</b> <font color="333333">.</font> <font color="566874">id</font> <font color="000066"><b>} }</b></font> <font color="333333">,</font> <br> <font color="000066"><b>{</b></font> <font color="566874">fileRepository</font> <font color="333333">.</font> <font color="170591">getHeadsByChat</font> <font color="000066">()</font> <font color="333333">.</font> <i><b>associateBy</b></i> <font color="000066"><b>{</b></font> <font color="000066"><i>it</i></font> <font color="333333">.</font> <font color="566874">id</font> <font color="000066"><b>} }</b></font> <br> <font color="000066"><b>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</b></font> <font color="000066">)</font> <br> <br> <i><b>withContext</b></i> <font color="000066">(</font> <font color="05314d"><b>IO</b></font> <font color="000066">)</font> <font color="000066"><b>{</b></font> <font color="566874">messageRepository</font> <font color="333333">.</font> <font color="170591">findLast</font> <font color="000066">(</font> <font color="3e7eff"><b>n</b></font> <font color="000066">)</font> <font color="000066"><b>}</b></font> <br> <font color="000066"><b>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</b></font> <font color="333333">.</font> <i><b>map</b></i> <font color="000066">(</font> <br> <font color="170591">prefetch</font> <font color="333333">.</font> <font color="170591">await</font> <font color="000066">()</font> <font color="333333">.</font> <i><b>let</b></i> <font color="000066"><b>{</b></font> <font color="000066">(</font> <font color="170591">users</font> <font color="333333">,</font> <font color="170591">files</font> <font color="000066">)</font> <font color="000066"><b>-&gt;</b></font> <br> <font color="000066"><b>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</b></font> <i><b>recursiveMemoize</b></i> <font color="000066"><b>{</b></font> <font color="000066"><i>message</i></font> <font color="333333">,</font> <font color="000066"><i>memoized</i></font> : <font color="000066">(</font> <font color="3e7eff"><b>ChatMessage</b></font> <font color="000066">) -&gt;</font> <font color="3e7eff"><b>ChatPageMessage</b></font> <font color="000066"><b>-&gt;</b></font> <br> <font color="000066"><b>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</b></font> <font color="000066"><i>message</i></font> <font color="333333">.</font> <i><b>toDomainModel</b></i> <font color="000066">(</font> <br> <font color="4a86e8">getUser =</font> <font color="170591">users</font> ::get <font color="333333">.</font> <i><b>orThrow</b></i> <font color="000066"><b>{</b></font> <font color="170591">IllegalArgumentException</font> <font color="000066">(</font> <b>"User</b> <font color="333333"><b>$</b></font> <font color="000066"><i>it</i></font> <b>"</b> <font color="000066">)</font> <font color="000066"><b>}</b></font> <font color="333333">,</font> <br> <font color="4a86e8">getFile =</font> <font color="170591">files</font> ::get <font color="333333">.</font> <i><b>orThrow</b></i> <font color="000066"><b>{</b></font> <font color="170591">IllegalArgumentException</font> <font color="000066">(</font> <b>"File</b> <font color="333333"><b>$</b></font> <font color="000066"><i>it</i></font> <b>"</b> <font color="000066">)</font> <font color="000066"><b>}</b></font> <font color="333333">,</font> <br> <font color="3f7f5f">//       </font> <br> <font color="4a86e8">serializeMessage =</font> <font color="000066"><i>memoized</i></font> <br> <font color="000066"><i>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</i></font> <font color="000066">)</font> <br> <font color="000066"><b>}</b></font> <br> <font color="000066"><b>}</b></font> <br> <font color="000066"><b>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</b></font> <font color="000066">)</font> <br> <font color="000066"><b>}</b></font> <br> <font color="000066"><b>&nbsp;&nbsp;</b></font> <font color="000066">}</font> <br> <font color="000066">}</font> <br> <br> <font color="7f0055"><b>private fun</b></font> <font color="3e7eff"><b>ChatMessage</b></font> <font color="333333">.</font> <font color="170591"><b>toDomainModel</b></font> <font color="000066">(</font> <br> <font color="000066"><i>getUser</i></font> : <font color="000066">(</font> <font color="3e7eff"><b>UserReference</b></font> <font color="000066">) -&gt;</font> <font color="3e7eff"><b>UserRemote</b></font> <font color="333333">,</font> <br> <font color="000066"><i>getFile</i></font> : <font color="000066">(</font> <font color="3e7eff"><b>FileReference</b></font> <font color="000066">) -&gt;</font> <font color="3e7eff"><b>FileHeadRemote</b></font> <font color="333333">,</font> <br> <font color="000066"><i>serializeMessage</i></font> : <font color="000066">(</font> <font color="3e7eff"><b>ChatMessage</b></font> <font color="000066">) -&gt;</font> <font color="3e7eff"><b>ChatPageMessage</b></font> <br> <font color="000066">)</font> <font color="333333">=</font> <font color="170591">ChatPageMessage</font> <font color="000066">(</font> <br> <font color="4a86e8">id =</font> <font color="566874">id</font> ?: <font color="7f0055"><b>throw</b></font> <font color="170591">IllegalStateException</font> <font color="000066">(</font> <b>"</b> <font color="333333"><b>$</b></font> <font color="7f0055"><b>this</b></font> <b>must be persisted"</b> <font color="000066">)</font> <font color="333333">,</font> <br> <font color="4a86e8">author =</font> <font color="000066"><i>getUser</i></font> <font color="000066">(</font> <font color="566874">author</font> <font color="000066">)</font> <font color="333333">,</font> <br> <font color="4a86e8">message =</font> <font color="566874">message</font> <font color="333333">,</font> <br> <font color="4a86e8">files =</font> <font color="566874">files</font> <font color="333333">?.</font> <i><b>map</b></i> <font color="000066">(</font> <font color="000066"><i>getFile</i></font> <font color="000066">)</font> ?: <i><b>listOf</b></i> <font color="000066">()</font> <font color="333333">,</font> <br> <font color="4a86e8">forwardFrom =</font> <font color="566874">forwardFrom</font> <font color="333333">?.</font> <i><b>let</b></i> <font color="000066">(</font> <font color="000066"><i>serializeMessage</i></font> <font color="000066">)</font> <font color="333333">,</font> <br> <font color="4a86e8">replyTo =</font> <font color="566874">replyTo</font> <font color="333333">?.</font> <i><b>let</b></i> <font color="000066">(</font> <font color="000066"><i>serializeMessage</i></font> <font color="000066">)</font> <br> <font color="000066">)</font> <br></code> </div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Verificou-se que a pr√≥pria fun√ß√£o getLastPage possui uma estrat√©gia de aquisi√ß√£o de dados, incluindo pr√©-busca, e a fun√ß√£o toDomainModel √© puramente t√©cnica e √© respons√°vel pela convers√£o de modelos armazenados em um modelo de dom√≠nio. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Reescrevi as chamadas paralelas para userRepository, fileRepository e messageRepository de uma forma mais familiar para o Kotlin. Espero que a compreensibilidade do c√≥digo n√£o tenha sofrido por causa disso. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Em geral, esse m√©todo j√° √© totalmente funcional; o desempenho ao aplic√°-lo ser√° o mesmo que com o simples uso de engenharia reversa ou heur√≠stica de neg√≥cios.</font></font><br><br><a name="EnlargementOutside"></a> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A l√≥gica de ampliar consultas fora do agregado</font></font></b> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> No processo de cria√ß√£o do agregado, encontraremos imediatamente um problema: para construir o ChatPage, o tamanho da p√°gina precisar√° ser definido como constante ao criar o Chat, e n√£o pass√°-lo para getLast (), como de costume. Vai ter que me mudar interface de agregado: </font><font style="vertical-align: inherit;">Uma vez que temos dochitka outras mensagens e queremos fortemente para obter toda a parte externa de dados da unidade, teremos de optar por sair do n√≠vel agregado de conversar e fazer ChatPage root: </font><font style="vertical-align: inherit;">Em seguida, voc√™ precisa criar um c√≥digo de pr√©-busca, se separar da unidade: </font><font style="vertical-align: inherit;">Agora, a fim Para criar um agregado, voc√™ precisa acopl√°-lo √† pr√©-busca. No DDD, esse tipo de orquestra√ß√£o √© feito pelo Application Services.</font></font><br><br> <code><font color="7f0055"><b>interface</b></font> <font color="3e7eff"><b>Chat</b></font> <font color="000066">{</font> <br> <font color="7f0055"><b>fun</b></font> <font color="170591"><b>getPage</b></font> <font color="000066">()</font> : <font color="3e7eff"><b>ChatPage</b></font> <br> <font color="000066">}</font></code> <br> <br><font style="vertical-align: inherit;"></font><br><br> <code><font color="7f0055"><b>class</b></font> <font color="3e7eff"><b>ChatPageImpl</b></font> <font color="000066">(</font> <br> <font color="7f0055"><b>private val</b></font> <font color="566874">messageData</font> : <font color="3e7eff"><b>List</b></font> <font color="333333">&lt;</font> <font color="3e7eff"><b>ChatMessage</b></font> <font color="333333">&gt;,</font> <br> <font color="7f0055"><b>private val</b></font> <font color="566874">userData</font> : <font color="3e7eff"><b>List</b></font> <font color="333333">&lt;</font> <font color="3e7eff"><b>UserRemote</b></font> <font color="333333">&gt;,</font> <br> <font color="7f0055"><b>private val</b></font> <font color="566874">fileData</font> : <font color="3e7eff"><b>List</b></font> <font color="333333">&lt;</font> <font color="3e7eff"><b>FileHeadRemote</b></font> <font color="333333">&gt;</font> <br> <font color="000066">)</font> : <font color="3e7eff"><b>ChatPage</b></font> <font color="000066">{</font> <br> <font color="7f0055"><b>override val</b></font> <font color="566874">messages</font> : <font color="3e7eff"><b>List</b></font> <font color="333333">&lt;</font> <font color="3e7eff"><b>ChatPageMessage</b></font> <font color="333333">&gt;</font> <br> <font color="7f0055"><b>get</b></font> <font color="000066">()</font> <font color="333333">=</font> <br> <font color="566874">messageData</font> <font color="333333">.</font> <i><b>map</b></i> <font color="000066">(</font> <br> <font color="000066">(</font> <font color="566874">userData</font> <font color="333333">.</font> <i><b>associateBy</b></i> <font color="000066"><b>{</b></font> <b>it</b> <font color="333333">.</font> <font color="566874">id</font> <font color="000066"><b>}</b></font> <i><b>to</b></i> <font color="566874">fileData</font> <font color="333333">.</font> <i><b>associateBy</b></i> <font color="000066"><b>{</b></font> <font color="000066"><i>it</i></font> <font color="333333">.</font> <font color="566874">id</font> <font color="000066"><b>}</b></font> <font color="000066">)</font> <br> <font color="333333">.</font> <i><b>let</b></i> <font color="000066"><b>{</b></font> <font color="000066">(</font> <font color="170591">users</font> <font color="333333">,</font> <font color="170591">files</font> <font color="000066">)</font> <font color="000066"><b>-&gt;</b></font> <br> <font color="000066"><b>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</b></font> <i><b>recursiveMemoize</b></i> <font color="000066"><b>{</b></font> <font color="000066"><i>message</i></font> <font color="333333">,</font> <font color="000066"><i>self</i></font> : <font color="000066">(</font> <font color="3e7eff"><b>ChatMessage</b></font> <font color="000066">) -&gt;</font> <font color="3e7eff"><b>ChatPageMessage</b></font> <font color="000066"><b>-&gt;</b></font> <br> <font color="000066"><b>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</b></font> <font color="000066"><i>message</i></font> <font color="333333">.</font> <i><b>toDomainModel</b></i> <font color="000066">(</font> <br> <font color="4a86e8">getUser =</font> <font color="170591">users</font> ::get <font color="333333">.</font> <i><b>orThrow</b></i> <font color="000066">()</font> <font color="333333">,</font> <br> <font color="4a86e8">getFile =</font> <font color="170591">files</font> ::get <font color="333333">.</font> <i><b>orThrow</b></i> <font color="000066">()</font> <font color="333333">,</font> <br> <font color="3f7f5f">//       </font> <br> <font color="4a86e8">serializeMessage =</font> <font color="000066"><i>self</i></font> <br> <font color="000066"><i>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</i></font> <font color="000066">)</font> <br> <font color="000066"><b>}</b></font> <br> <font color="000066"><b>}</b></font> <br> <font color="000066"><b>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</b></font> <font color="000066">)</font> <br> <font color="000066">}</font></code> <br> <br><font style="vertical-align: inherit;"></font><br><br> <code><font color="7f0055"><b>fun</b></font> <font color="170591"><b>chatPagePrefetch</b></font> <font color="000066">(</font> <br> <font color="000066"><i>pageSize</i></font> : <font color="3e7eff"><b>Int</b></font> <font color="333333">,</font> <br> <font color="000066"><i>messageRepository</i></font> : <font color="3e7eff"><b>ChatMessageRepository</b></font> <font color="333333">,</font> <br> <font color="000066"><i>userRepository</i></font> : <font color="3e7eff"><b>UserRemoteApi</b></font> <font color="333333">,</font> <br> <font color="000066"><i>fileRepository</i></font> : <font color="3e7eff"><b>FileRemoteApi</b></font> <br> <font color="000066">)</font> <font color="333333">=</font> <br> <i><b>runBlocking</b></i> <font color="000066">(</font> <font color="05314d"><b>IO</b></font> <font color="000066">)</font> <font color="000066"><b>{</b></font> <br> <font color="000066"><b>&nbsp;&nbsp;&nbsp;&nbsp;</b></font> <i><b>async</b></i> <font color="000066">(</font> <br> <font color="000066"><b>{</b></font> <font color="3e7eff"><b>userRepository</b></font> <font color="333333">.</font> <font color="170591">getUsersByChat</font> <font color="000066">()</font> <font color="000066"><b>}</b></font> <font color="333333">,</font> <br> <font color="000066"><b>{</b></font> <font color="3e7eff"><b>fileRepository</b></font> <font color="333333">.</font> <font color="170591">getHeadsByChat</font> <font color="000066">()</font> <font color="000066"><b>}</b></font> <font color="333333">,</font> <br> <font color="000066"><b>{</b></font> <font color="3e7eff"><b>messageRepository</b></font> <font color="333333">.</font> <font color="170591">findLast</font> <font color="000066">(</font> <font color="3e7eff"><b>pageSize</b></font> <font color="000066">)</font> <font color="000066"><b>}</b></font> <br> <font color="000066"><b>&nbsp;&nbsp;&nbsp;&nbsp;</b></font> <font color="000066">)</font> <br> <font color="000066"><b>}</b></font></code> <br> <br><font style="vertical-align: inherit;"></font><br><br> <code><font color="7f0055"><b>class</b></font> <font color="3e7eff"><b>ChatService</b></font> <font color="000066">(</font> <br> <font color="7f0055"><b>private val</b></font> <font color="566874">messageRepository</font> : <font color="3e7eff"><b>ChatMessageRepository</b></font> <font color="333333">,</font> <br> <font color="7f0055"><b>private val</b></font> <font color="566874">userRepository</font> : <font color="3e7eff"><b>UserRemoteApi</b></font> <font color="333333">,</font> <br> <font color="7f0055"><b>private val</b></font> <font color="566874">fileRepository</font> : <font color="3e7eff"><b>FileRemoteApi</b></font> <br> <font color="000066">) {</font> <br> <font color="7f0055"><b>private fun</b></font> <font color="170591"><b>chatPagePrefetch</b></font> <font color="000066">(</font> <font color="000066"><i>pageSize</i></font> : <font color="3e7eff"><b>Int</b></font> <font color="000066">)</font> <font color="333333">=</font> <br> <i><b>runBlocking</b></i> <font color="000066">(</font> <font color="05314d"><b>IO</b></font> <font color="000066">)</font> <font color="000066"><b>{</b></font> <br> <font color="000066"><b>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</b></font> <i><b>async</b></i> <font color="000066">(</font> <br> <font color="000066"><b>{</b></font> <font color="566874">messageRepository</font> <font color="333333">.</font> <font color="170591">findLast</font> <font color="000066">(</font> <font color="3e7eff"><b>pageSize</b></font> <font color="000066">)</font> <font color="000066"><b>}</b></font> <font color="333333">,</font> <br> <font color="000066"><b>{</b></font> <font color="566874">userRepository</font> <font color="333333">.</font> <font color="170591">getUsersByChat</font> <font color="000066">()</font> <font color="000066"><b>}</b></font> <font color="333333">,</font> <br> <font color="000066"><b>{</b></font> <font color="566874">fileRepository</font> <font color="333333">.</font> <font color="170591">getHeadsByChat</font> <font color="000066">()</font> <font color="000066"><b>}</b></font> <br> <font color="000066"><b>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</b></font> <font color="000066">)</font> <font color="333333">.</font> <font color="170591">await</font> <font color="000066">()</font> <br> <font color="000066"><b>}</b></font> <br> <br> <font color="000066"><b>&nbsp;&nbsp;</b></font> <font color="7f0055"><b>fun</b></font> <font color="170591"><b>getLastPage</b></font> <font color="000066">(</font> <font color="000066"><i>n</i></font> : <font color="3e7eff"><b>Int</b></font> <font color="000066">)</font> : <font color="3e7eff"><b>ChatPage</b></font> <font color="333333">=</font> <br> <font color="170591">chatPagePrefetch</font> <font color="000066">(</font> <font color="000066"><i>n</i></font> <font color="000066">)</font> <br> <font color="333333">.</font> <i><b>let</b></i> <font color="000066"><b>{</b></font> <font color="000066">(</font> <font color="170591">messageData</font> <font color="333333">,</font> <font color="170591">userData</font> <font color="333333">,</font> <font color="170591">fileData</font> <font color="000066">)</font> <font color="000066"><b>-&gt;</b></font> <br> <font color="000066"><b>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</b></font> <font color="170591">ChatPageImpl</font> <font color="000066">(</font> <font color="170591">messageData</font> <font color="333333">,</font> <font color="170591">userData</font> <font color="333333">,</font> <font color="170591">fileData</font> <font color="000066">)</font> <br> <font color="000066"><b>}</b></font> <br> <font color="000066">}</font></code> <br> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bem, o controlador n√£o muda muito, voc√™ s√≥ precisa usar ChatService :: getLastPage em vez de Chat :: getLastPage. </font><font style="vertical-align: inherit;">Ou seja, o c√≥digo mudar√° assim:</font></font><br><br> <code><font color="7f0055"><b>class</b></font> ChatRestController <font color="000066">(</font> <br> <font color="7f0055"><b>private val</b></font> <font color="566874">chat</font> : <font color="3e7eff"><b>ChatService</b></font> <br> <font color="000066">)</font> : <font color="3e7eff"><b>ChatRestApi</b></font> <br></code> <br><br><a name="Summary3"></a>  <b>Conclus√µes</b> <br><br><ol><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> A l√≥gica de pr√©-busca pode ser colocada dentro da unidade ou em um local separado. </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Se a l√≥gica de pr√©-busca estiver fortemente relacionada √† l√≥gica interna do agregado, √© melhor n√£o remov√™-la, pois isso pode interromper o encapsulamento. </font><font style="vertical-align: inherit;">Pessoalmente, n√£o vejo muito sentido em mover a pr√©-busca do agregado, pois isso limita muito as possibilidades e aumenta a coer√™ncia impl√≠cita do c√≥digo.</font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> A pr√≥pria organiza√ß√£o agregada tem um efeito positivo no desempenho do processamento em lote, √† medida que o controle sobre solicita√ß√µes pesadas se torna maior e o local da l√≥gica de pr√©-busca se torna bastante definido. </font></font></li></ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> No pr√≥ximo cap√≠tulo, consideraremos uma implementa√ß√£o de pr√©-busca que n√£o pode ser implementada isoladamente da fun√ß√£o principal. </font></font><br><br><a name="Proxying"></a><h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Proxy e chamada dupla </font></font></h4><br><a name="ManagingContractProblem2"></a> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Resolvendo o problema do contrato</font></font></b> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Como j√° vimos nas partes anteriores, o principal problema do contrato de pr√©-busca √© que ele est√° fortemente conectado ao contrato da fun√ß√£o para a qual deve preparar os dados. </font><font style="vertical-align: inherit;">Para ser mais preciso, depende de quais dados a fun√ß√£o principal pode precisar. </font><font style="vertical-align: inherit;">E se n√£o tentarmos prever, mas tentar fazer engenharia reversa usando o pr√≥prio c√≥digo? </font><font style="vertical-align: inherit;">Em situa√ß√µes simples, a abordagem de proxy normalmente usada nos testes pode nos ajudar. </font><font style="vertical-align: inherit;">Bibliotecas como o Mockito geram classes com implementa√ß√µes de interface, que tamb√©m podem acumular informa√ß√µes sobre chamadas. </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Uma abordagem semelhante √© usada em nossa biblioteca</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Se voc√™ chamar a fun√ß√£o principal com reposit√≥rios com proxy e coletar informa√ß√µes sobre os dados necess√°rios, poder√° obter esses dados na forma de um pacote e chamar novamente a fun√ß√£o principal para obter o resultado final. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A principal condi√ß√£o √© a seguinte: os dados solicitados n√£o devem afetar solicita√ß√µes subsequentes. O proxy n√£o retornar√° dados reais, mas apenas alguns stubs; portanto, todas as ramifica√ß√µes e recebimento dos dados associados desaparecer√£o. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">No nosso caso, isso significa que √© in√∫til proxy messageRepository, pois solicita√ß√µes adicionais s√£o feitas com base nos resultados da solicita√ß√£o de mensagem. Isso n√£o √© um problema, pois temos apenas uma solicita√ß√£o para messageRepository, portanto, nenhum processamento em lote √© necess√°rio aqui.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Como proxy das fun√ß√µes simples UserReference-&gt; UserRemote e FileReference-&gt; FileHeadRemote, voc√™ s√≥ precisa acumular duas listas de argumentos. </font></font><br><br><div class="spoiler"> <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Como resultado, obtemos o seguinte:</font></font></b> <div class="spoiler_text"> <code><font color="7f0055"><b>class</b></font> <font color="3e7eff"><b>ChatRestController</b></font> <font color="000066">(</font> <br> <font color="7f0055"><b>private val</b></font> <font color="566874">messageRepository</font> : <font color="3e7eff"><b>ChatMessageRepository</b></font> <font color="333333">,</font> <br> <font color="7f0055"><b>private val</b></font> <font color="566874">userRepository</font> : <font color="3e7eff"><b>UserRemoteApi</b></font> <font color="333333">,</font> <br> <font color="7f0055"><b>private val</b></font> <font color="566874">fileRepository</font> : <font color="3e7eff"><b>FileRemoteApi</b></font> <br> <font color="000066">)</font> : <font color="3e7eff"><b>ChatRestApi</b></font> <font color="000066">{</font> <br> <font color="7f0055"><b>override fun</b></font> <font color="170591"><b>getLast</b></font> <font color="000066">(</font> <font color="000066"><i>n</i></font> : <font color="3e7eff"><b>Int</b></font> <font color="000066">)</font> : <font color="3e7eff"><b>List</b></font> <font color="333333">&lt;</font> <font color="3e7eff"><b>ChatMessageUI</b></font> <font color="333333">&gt;</font> <font color="000066">{</font> <br> <font color="7f0055"><b>val</b></font> <font color="170591">messages</font> <font color="333333">=</font> <font color="566874">messageRepository</font> <font color="333333">.</font> <font color="170591">findLast</font> <font color="000066">(</font> <font color="000066"><i>n</i></font> <font color="000066">)</font> <br> <br> <font color="3f7f5f">//    </font> <br> <font color="7f0055"><b>fun</b></font> <font color="170591"><b>transform</b></font> <font color="000066">(</font> <br> <font color="000066"><i>getUser</i></font> : <font color="000066">(</font> <font color="3e7eff"><b>UserReference</b></font> <font color="000066">) -&gt;</font> <font color="3e7eff"><b>UserRemote</b></font> <font color="333333">,</font> <br> <font color="000066"><i>getFile</i></font> : <font color="000066">(</font> <font color="3e7eff"><b>FileReference</b></font> <font color="000066">) -&gt;</font> <font color="3e7eff"><b>FileHeadRemote</b></font> <br> <font color="3e7eff"><b>&nbsp;&nbsp;&nbsp;&nbsp;</b></font> <font color="000066">)</font> : <font color="3e7eff"><b>List</b></font> <font color="333333">&lt;</font> <font color="3e7eff"><b>ChatMessageUI</b></font> <font color="333333">&gt; =</font> <br> <font color="3e7eff"><b>messages</b></font> <font color="333333">.</font> <i><b>map</b></i> <font color="000066">(</font> <br> <i><b>recursiveMemoize</b></i> <font color="000066"><b>{</b></font> <font color="000066"><i>message</i></font> <font color="333333">,</font> <font color="000066"><i>self</i></font> <font color="000066"><b>-&gt;</b></font> <br> <font color="000066"><b>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</b></font> <font color="000066"><i>message</i></font> <font color="333333">.</font> <i><b>toFrontModel</b></i> <font color="000066">(</font> <font color="000066"><i>getUser</i></font> <font color="333333">,</font> <font color="000066"><i>getFile</i></font> <font color="333333">,</font> <font color="000066"><i>self</i></font> <font color="000066">)</font> <br> <font color="000066"><b>}</b></font> <br> <font color="000066"><b>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</b></font> <font color="000066">)</font> <br> <br> <font color="3f7f5f">//  </font> <br> <font color="7f0055"><b>val</b></font> <font color="170591">userIds</font> <font color="333333">=</font> <i><b>mutableSetOf</b></i> <font color="333333">&lt;</font> <font color="3e7eff"><b>UserReference</b></font> <font color="333333">&gt;</font> <font color="000066">()</font> <br> <font color="7f0055"><b>val</b></font> <font color="170591">fileIds</font> <font color="333333">=</font> <i><b>mutableSetOf</b></i> <font color="333333">&lt;</font> <font color="3e7eff"><b>FileReference</b></font> <font color="333333">&gt;</font> <font color="000066">()</font> <br> <font color="170591">transform</font> <font color="000066">(</font> <br> <font color="000066"><b>{</b></font> <font color="3e7eff"><b>userIds</b></font> <font color="333333">+=</font> <b>it</b> <font color="333333">;</font> <font color="170591">UserRemote</font> <font color="000066">(</font> <font color="333333"><b>0L</b></font> <font color="333333">,</font> <b>""</b> <font color="000066">)</font> <font color="000066"><b>}</b></font> <font color="333333">,</font> <br> <font color="000066"><b>{</b></font> <font color="3e7eff"><b>fileIds</b></font> <font color="333333">+=</font> <font color="000066"><i>it</i></font> <font color="333333">;</font> <font color="170591">FileHeadRemote</font> <font color="000066">(</font> <font color="333333"><b>0L</b></font> <font color="333333">,</font> <b>""</b> <font color="000066">)</font> <font color="000066"><b>}</b></font> <br> <font color="000066"><b>&nbsp;&nbsp;&nbsp;&nbsp;</b></font> <font color="000066">)</font> <br> <br> <font color="7f0055"><b>return</b></font> <i><b>runBlocking</b></i> <font color="000066">(</font> <font color="05314d"><b>IO</b></font> <font color="000066">)</font> <font color="000066"><b>{</b></font> <br> <font color="000066"><b>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</b></font> <font color="3f7f5f">//      </font> <br> <i><b>async</b></i> <font color="000066">(</font> <br> <font color="000066"><b>{</b></font> <font color="566874">userRepository</font> <font color="333333">.</font> <font color="170591">getUsersByIds</font> <font color="000066">(</font> <font color="3e7eff"><b>userIds</b></font> <font color="000066">)</font> <font color="333333">.</font> <i><b>associateBy</b></i> <font color="000066"><b>{</b></font> <font color="000066"><i>it</i></font> <font color="333333">.</font> <font color="566874">id</font> <font color="000066"><b>}</b></font> ::get <font color="333333">.</font> <i><b>orThrow</b></i> <font color="000066">()</font> <font color="000066"><b>}</b></font> <font color="333333">,</font> <br> <font color="000066"><b>{</b></font> <font color="566874">fileRepository</font> <font color="333333">.</font> <font color="170591">getHeadsByIds</font> <font color="000066">(</font> <font color="3e7eff"><b>fileIds</b></font> <font color="000066">)</font> <font color="333333">.</font> <i><b>associateBy</b></i> <font color="000066"><b>{</b></font> <font color="000066"><i>it</i></font> <font color="333333">.</font> <font color="566874">id</font> <font color="000066"><b>}</b></font> ::get <font color="333333">.</font> <i><b>orThrow</b></i> <font color="000066">()</font> <font color="000066"><b>}</b></font> <br> <font color="000066"><b>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</b></font> <font color="000066">)</font> <font color="333333">.</font> <font color="170591">await</font> <font color="000066">()</font> <font color="333333">.</font> <i><b>let</b></i> <font color="000066"><b>{</b></font> <font color="000066">(</font> <font color="170591">getUser</font> <font color="333333">,</font> <font color="170591">getFile</font> <font color="000066">)</font> <font color="000066"><b>-&gt;</b></font> <br> <font color="000066"><b>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</b></font> <font color="170591">transform</font> <font color="000066">(</font> <font color="170591">getUser</font> <font color="333333">,</font> <font color="170591">getFile</font> <font color="000066">)</font> <br> <font color="000066"><b>}</b></font> <br> <font color="000066"><b>}</b></font> <br> <font color="000066"><b>&nbsp;&nbsp;</b></font> <font color="000066">}</font> <br> <font color="000066">}</font></code> </div> </div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Se voc√™ medir o desempenho, acontece que, com essa abordagem, n√£o √© pior do que usar m√©todos de engenharia reversa, embora chamemos a fun√ß√£o duas vezes. Isso se deve ao fato de que, comparado ao tempo de execu√ß√£o de consultas externas, o tempo de execu√ß√£o da fun√ß√£o de convers√£o pode ser negligenciado (no nosso caso). </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Comparado com o desempenho ao usar heur√≠sticas de neg√≥cios, no nosso caso, o ac√∫mulo de consultas ser√° menos eficaz. Mas lembre-se de que nem sempre √© poss√≠vel encontrar heur√≠sticas t√£o boas. Por exemplo, se o n√∫mero de usu√°rios no bate-papo for grande, assim como o n√∫mero de arquivos e os arquivos raramente forem anexados √†s mensagens, nosso algoritmo de heur√≠stica de neg√≥cios come√ßar√° a perder imediatamente ao receber honestamente uma lista de solicita√ß√µes.</font></font><br><br><a name="Summary4"></a>  <b>Conclus√µes</b> <br><br>  Pr√≥s: <br><br><ol><li>   prefetch   -   . </li><li>          prefetch. </li><li>    ,   -. </li></ol><br>  Contras: <br><br><ol><li>       . </li><li>  ,     . </li></ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Apesar do aparente exotismo, o ac√∫mulo de solicita√ß√µes por meio de proxy e recall √© bastante aplic√°vel em situa√ß√µes em que a l√≥gica da fun√ß√£o principal n√£o est√° ligada aos dados recebidos. A principal dificuldade aqui √© a mesma da engenharia reversa: estamos trabalhando na implementa√ß√£o atual da fun√ß√£o, embora em uma extens√£o muito menor (apenas no fato de que as consultas a seguir n√£o dependem dos resultados de consultas anteriores). </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O desempenho cair√° um pouco, mas no c√≥digo de pr√©-busca, voc√™ n√£o precisar√° levar em considera√ß√£o todas as nuances da implementa√ß√£o da fun√ß√£o principal. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Voc√™ pode usar essa abordagem quando n√£o puder criar boas heur√≠sticas de neg√≥cios para previs√£o de consultas e desejar reduzir a conectividade de pr√©-busca e fun√ß√£o.</font></font><br><br><a name="Conclusion"></a><h2>  Conclus√£o </h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Usar o processamento em lote n√£o √© t√£o simples quanto parece √† primeira vista. Eu acho que todos os padr√µes de design t√™m essa propriedade (lembre-se do cache). </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Para um processamento eficiente de solicita√ß√µes em lote, √© importante que o chamador colete o maior n√∫mero poss√≠vel de solicita√ß√µes, o que geralmente √© dificultado pela estrutura do aplicativo. H√° duas maneiras: projetar o aplicativo com o objetivo de trabalhar com dados com efici√™ncia (pode muito bem levar a um dispositivo reativo do aplicativo) ou, como geralmente acontece, tentar implementar o processamento em lote em um aplicativo existente sem uma reestrutura√ß√£o significativa.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A maneira mais √≥bvia de acumular consultas √© fazer a engenharia reversa do c√≥digo existente em busca de consultas pesadas. </font><font style="vertical-align: inherit;">A principal desvantagem dessa abordagem ser√° um aumento na conectividade impl√≠cita do c√≥digo. </font><font style="vertical-align: inherit;">Uma alternativa √© usar informa√ß√µes sobre os recursos de neg√≥cios para dividir os dados em partes, que geralmente s√£o compartilhadas e o todo. </font><font style="vertical-align: inherit;">√Äs vezes, para uma separa√ß√£o t√£o eficaz, ser√° necess√°rio desnormalizar o armazenamento, mas, se for bem-sucedido, a l√≥gica do processamento em lote ser√° determinada pela √°rea de assunto, o que √© bom. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Uma maneira menos √≥bvia de obter todas as solicita√ß√µes √© implementar duas passagens. </font><font style="vertical-align: inherit;">Na primeira etapa, coletamos todas as solicita√ß√µes necess√°rias, na segunda trabalhamos com os dados j√° recebidos. </font><font style="vertical-align: inherit;">A aplicabilidade dessa abordagem √© limitada pelo requisito de independ√™ncia de solicita√ß√µes entre si.</font></font></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt467919/">https://habr.com/ru/post/pt467919/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt467907/index.html">Pr√≥s e contras da terceiriza√ß√£o</a></li>
<li><a href="../pt467909/index.html">Bate-papo no iOS: usando soquetes</a></li>
<li><a href="../pt467913/index.html">Como melhorar o ‚Äúmineral bastardo‚Äù ou a nova interface para o painel solar</a></li>
<li><a href="../pt467915/index.html">Monitorando o postgres dentro do Openshift</a></li>
<li><a href="../pt467917/index.html">Modelos de Gerenciamento</a></li>
<li><a href="../pt467921/index.html">Retire canetas empoeiradas: a caligrafia √© boa para o c√©rebro</a></li>
<li><a href="../pt467923/index.html">Ent√£o, voc√™ quer se tornar um analista no campo da seguran√ßa de rede ...</a></li>
<li><a href="../pt467925/index.html">Por que os desenvolvedores amam tanto o tema sombrio</a></li>
<li><a href="../pt467929/index.html">Organizamos o caos ou como implementar uma abordagem de processo em uma organiza√ß√£o</a></li>
<li><a href="../pt467933/index.html">E, no entanto, por que o Posit √© uma alternativa digna do IEEE 754</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>