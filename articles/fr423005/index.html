<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üëß üõÇ ü•ú Comment Yandex.Zen, le plugin de mise en cache WordPress et l'h√©bergement ont stimul√© ma pression üéõÔ∏è üÜó üìá</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Cet article est plut√¥t issu d'une s√©rie de ¬´notes d'h√¥tesse¬ª. Eh bien, un peu plus sur les exp√©riences personnelles et le gougeage. 

 Si vous devez g...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Comment Yandex.Zen, le plugin de mise en cache WordPress et l'h√©bergement ont stimul√© ma pression</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/423005/"><img src="https://habrastorage.org/webt/12/3o/cf/123ocfvpows898t7vrwuhhveguo.jpeg" alt="image" width="100%"><br><br>  Cet article est plut√¥t issu d'une s√©rie de ¬´notes d'h√¥tesse¬ª.  Eh bien, un peu plus sur les exp√©riences personnelles et le gougeage. <br><br>  Si vous devez g√©rer des sites WordPress sur lesquels le plug-in de mise en cache WP Super Cache est install√©, l'article peut vous √™tre utile.  Sinon, ce n'est qu'une courte histoire. <br><a name="habracut"></a><br>  Bref, le d√©but de l'histoire est le suivant: il y avait un site.  Nouvelles et informations th√©matiques.  Fabriqu√© par un assistant inconnu sur CMS WordPress.  Et fait exactement ce qui √©tait permis √† ce moment-l√† par le biais de son propri√©taire.  Au fil du temps, le site a gagn√© en popularit√©, le nombre de visiteurs a augment√©.  Le site lui-m√™me a "gagn√©" sur la publicit√©.  C'est-√†-dire  plus il y a de visiteurs, mieux c'est.  √Ä un moment donn√©, lors des pics de charge, le site a commenc√© √† se plier: des pages charg√©es lentement et tout √ßa.  Mais, bien s√ªr, jusqu'√† ce que le coq picore, personne ne bougeait vraiment.  Le coq est apparu au moment o√π le site √©tait cens√© couvrir un √©v√©nement qui a attir√© l'attention du public.  Les visiteurs se sont pr√©cipit√©s, le site est tomb√© en panne et tous les revenus estim√©s fondaient sous nos yeux.  En raison des circonstances, j'ai d√ª agir comme r√©animateur.  J'ai alors √©crit <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">un article</a> √† ce sujet.  Ma d√©cision √©tait effrayante (ne r√©p√©tez pas), mais l'objectif principal a √©t√© atteint - les r√™ves ont √©t√© enregistr√©s.  Surtout. <br><br>  Bien s√ªr, personne n'√©tait int√©ress√© √† r√©p√©ter une situation similaire et a travaill√© sur le site.  Tout d'abord, ils ont d√©couvert les raisons de la chute et de la forte charge sur le serveur.  Ils √©taient monnaie courante: l'absence d'un site de mise en cache en tant que tel et un m√©canisme mal impl√©ment√© pour enregistrer et afficher le nombre de vues d'articles.  Ce dernier a lui-m√™me cr√©√© une charge d√©cente: √† chaque demande de page d'article, il a extrait de la base de donn√©es le nombre de vues de cet article, l'affichait, puis en ajoutait une et la r√©√©crivait dans la base de donn√©es.  Dans le m√™me temps, la table <b>wp_postmeta</b> avec m√©tadonn√©es a √©t√© utilis√©e pour le stockage (comme elle semble √™tre appel√©e dans WP).  Dans lequel la masse √©tait stock√©e sans rapport avec les vues comptables de l'information et qui √©tait tr√®s importante. <br><br>  Le probl√®me de mise en cache a √©t√© r√©solu simplement: dans un environnement calme, le plugin WP Super Cache a √©t√© install√© normalement.  Ce que beaucoup, si je me souviens bien, m'a conseill√© de faire √† la place de la b√©quille √©trange que j'ai construite dans les commentaires sur cet article.  Honn√™tement, j'ai alors et maintenant mal navigu√© dans l'√©cosyst√®me WordPress et donc cette b√©quille est apparue.  Le plugin de mise en cache a √©t√© install√© et configur√© par des personnes connaissant d√©j√†, et il est sorti imm√©diatement de la bo√Æte.  Ainsi, le probl√®me de mise en cache a √©t√© r√©solu.  Pourquoi ce plugin a √©t√© choisi, je ne sais pas avec certitude.  Pour autant que je sache, c'est l'un des plugins les plus populaires de ce type pour WP. <br><br>  Compte tenu des points de vue, ils ont agi quelque peu diff√©remment.  Il est clair que le m√©canisme d'origine a d√ª √™tre abandonn√©.  Je ne voulais pas refuser de prendre en compte les opinions elles-m√™mes: au moins un bloc montrant comme "les articles les plus populaires de la semaine" y √©tait li√©.  Tous les plugins pour l'enregistrement des vues, m√™me s'ils √©taient ¬´amis¬ª avec le plugin de mise en cache, se sont av√©r√©s tr√®s voraces et, le plus souvent, ont impl√©ment√© le m√™me m√©canisme avec l'√©criture et l'extraction de donn√©es de wp_postmeta.  Pour un petit site, cela convient parfaitement.  Pour un site avec des taux de fr√©quentation de pointe assez solides - plus: trop gourmand pour une si petite fonction.  Ensuite, au fait, j'ai trouv√© un h√©bergement payant et inutilis√© pour les ann√©es √† venir.  Le plus simple et le moins cher.  Les responsabilit√©s de stockage, d'enregistrement et de retour des donn√©es sur les vues lui incombaient.  Tout est asynchrone, c'est-√†-dire  m√™me s'il tombe, le site principal continuera √† afficher tranquillement des articles, des publicit√©s et tout ce qu'il devrait afficher.  Le stockage en ligne des donn√©es de visualisation a √©t√© attribu√© √† Redis et le stockage √† long terme √† MySQL.  Il tourne donc, il ne demande pas vraiment et mange 1 √† 2% de la charge maximale autoris√©e sur cet h√©bergement. <br><br>  Et donc, un temps assez long passe.  Encore et toujours une vieille histoire.  Un trafic assez puissant va sur le site et le site commence √† chuter.  Et encore une fois, je suis le seul sp√©cialiste conditionnel √©veill√© dans la r√©gion.  Bien s√ªr, je suis surpris de la r√©p√©tition des √©v√©nements.  Ma premi√®re pens√©e est que quelqu'un a accidentellement d√©sactiv√© la mise en cache.  Mais non, dans le code source de la page du site que me donne le serveur tombant, je vois des signes d'un plugin de mise en cache qui fonctionne.  Tout devrait bien se passer.  Mais dans le panneau de contr√¥le du serveur, je vois qu'il n'y a plus de RAM, le nombre de requ√™tes de base de donn√©es est incroyable et tout est mauvais.  Tout d'abord, j'ouvre la page avec la description du plugin, traverse rapidement ses yeux, ne trouve rien et quitte cette activit√©.  L'√©tape suivante consiste √† voir les statistiques.  Je vois que le flux de trafic principal afflue sur le site √† partir de Yandex.Zen.  Et la demande qui m√®ne l'utilisateur vers le site ressemble √† ceci: <br><br><blockquote>  https://example.com <b>? utm_referrer = https:% 2F% 2Fzen.yandex.com</b> </blockquote><br>  C'est-√†-dire  Yandex.Zen ajoute sa balise utm √† l'adresse.  √âtant donn√© que le serveur est d√©j√† compl√®tement couch√© et ne me donne que 500, pour une raison quelconque, je ne peux pas v√©rifier clairement la th√©orie selon laquelle les pages avec une telle "pond√©ration" ne sont pas mises en cache.  Par cons√©quent, une autre ¬´b√©quille¬ª est n√©e (elle a √©t√© remplac√©e par la suite): une redirection est ajout√©e √† .htaccess, qui convertit la demande avec les balises utm en une demande sans eux avant que WordPress et tous ses plugins puissants entrent en jeu.  La machine red√©marre et, le tour est jou√©, tout fonctionne: le site se charge rapidement, le serveur bruit tranquillement √† basse vitesse.  Comme rien ne s'est pass√©. <br><br>  Ensuite, je me suis d√©tendu et j'ai grimp√© calmement en regardant les param√®tres du plugin de mise en cache.  Tout d'abord, la case √† cocher ¬´Ne pas mettre en cache les pages avec les param√®tres GET¬ª, qui est l√†.  Tout va bien, elle n'en vaut pas la peine.  De plus, comme l'exp√©rience l'a montr√©, le plugin g√®re la mise en cache des requ√™tes avec n'importe quel ensemble de param√®tres arbitraires.  S'il ne s'agit pas de balises utm (en fait, je n'ai redirig√© que les demandes d'un certain type et je n'ai pas coup√© toutes les balises utm). <br><br>  Ici, j'ai soigneusement (en utilisant CTRL + F) regard√© la page du plugin.  Et j'ai trouv√© dans la FAQ le glorieux paragraphe "Comment utiliser au mieux les outils de suivi utm_source dans Google Analytics avec ce plugin?".  Il est clair que lors du premier examen superficiel, je l'ai ignor√© en toute s√©curit√©: il ne semble y avoir rien √† voir avec le probl√®me.  En m√™me temps, d'ailleurs, ce n'est pas tr√®s informatif et n'offre aucune solution sp√©cifique. <br><br>  <b>La seule conclusion utile possible dans l'article:</b> si vous avez un site WP avec le plugin WP Super Cache, alors v√©rifiez ce qu'il fait (ou pas), si vous soumettez une demande avec les param√®tres ¬´? Utm_referrer = https:% 2F% 2Fzen. yandex.com ", etc.  Je ne suis pas s√ªr que lors de l'installation de ce plugin, tout le monde lit sa FAQ si attentivement.  L'impl√©mentation sp√©cifique, apparemment, reste aux propri√©taires du site: la derni√®re fois que j'ai regard√© la mise √† jour de ce plugin, je n'ai vu aucun changement concernant sa r√©action √©trange aux balises utm. <br><br>  Mais l'histoire aurait √©t√© incompl√®te (et je ne l'aurais pas racont√©e) s'il n'y avait pas eu une autre confirmation de la loi de Murphy.  Pendant que nous correspondions pacifiquement avec le propri√©taire du site et regardions comment le site fonctionnait tranquillement pendant environ une heure ... le site est tomb√©.  De fa√ßon inattendue et enfin.  Il n'y a pas d'acc√®s au panneau de contr√¥le du serveur, FTP, SSH et tout le reste ne fonctionne pas.  Rien ne marche.  Si avant cela ma pression n'a √©t√© que l√©g√®rement augment√©e en r√©solvant le probl√®me que J. Zen et le plugin de mise en cache ont provoqu√© (apr√®s tout, c'est un plaisir particulier de comprendre rapidement et de r√©parer quelque chose dans une dispute facile), alors une attaque de mini-panique enti√®re m'est arriv√©e.  Et seul le vague sentiment que quelques lignes dans .htaccess ne peuvent pas tout tuer une heure apr√®s avoir fait ces lignes n'a pas laiss√© le ¬´mini¬ª se transformer en quelque chose de plus complet.  En g√©n√©ral, apr√®s quelques minutes d'√©change de messages surpris, nous sommes mont√©s sur le compte personnel du fournisseur d'h√©bergement o√π r√©side le serveur.  Et l√†, dans les tickets, nous avons trouv√© un avertissement concernant "le travail technique de X √† Y sur MSC".  La chose la plus int√©ressante est qu'au bureau de poste, quelle que soit la fa√ßon dont nous avons cherch√©, nous n'avons trouv√© aucun message de l'h√©bergeur √† propos de ces travaux.  Le billet avait au moins un jour.  Avant cela, de tels messages √©taient envoy√©s par la poste, et personne ne regarde g√©n√©ralement les tickets du service d'assistance (et du bureau d'accueil lui-m√™me) g√©n√©ralement sans aucun besoin particulier.  Par cons√©quent, ce qui s'est pass√© a √©t√© une grosse surprise.  Apr√®s cela, nous avons grond√© les yeux de l'h√©bergeur, ri, attendu que tout fonctionne et nous nous endormions. <br><br>  Voici une histoire. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr423005/">https://habr.com/ru/post/fr423005/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr422989/index.html">Une base de donn√©es n'est pas seulement un entrep√¥t de donn√©es</a></li>
<li><a href="../fr422993/index.html">Graver des t√©l√©viseurs OLED dans de vrais tests</a></li>
<li><a href="../fr422995/index.html">Mitap QA √† Redmadrobot</a></li>
<li><a href="../fr422997/index.html">Le livre "PHP moderne"</a></li>
<li><a href="../fr422999/index.html">Cr√©ez votre propre jeu de donn√©es extraterrestre</a></li>
<li><a href="../fr423007/index.html">"Malyavki, mais bon": comment nous avons amen√© les √©tudiants √† la pratique</a></li>
<li><a href="../fr423009/index.html">Diagnostics SENS. Biomarqueurs de glycation des prot√©ines</a></li>
<li><a href="../fr423011/index.html">Gestion des microservices avec Kubernetes et Istio</a></li>
<li><a href="../fr423013/index.html">Comment organiser vos d√©pendances dans une application Vue</a></li>
<li><a href="../fr423015/index.html">Git: erreurs courantes et comment les corriger</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>