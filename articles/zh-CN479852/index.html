<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🔭 👲🏽 👨🏻‍🏭 幕后视频通话：每天从数百万到一次会议的100位参与者 🦀 👊🏾 ❇️</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="现在，没有呼叫功能似乎找不到信使。 这对用户来说很方便，因为所有通信都可以在一个应用程序中进行。 如果我们结合媒体上所有可用的统计信息，结果表明人们每天通过Internet进行的通话时间超过十亿分钟。 随着技术的发展，视频通信的份额正在增加，因为视频可以更好地传达对话者的情绪，并允许您创建在场效果。...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>幕后视频通话：每天从数百万到一次会议的100位参与者</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/odnoklassniki/blog/479852/"> 现在，没有呼叫功能似乎找不到信使。 这对用户来说很方便，因为所有通信都可以在一个应用程序中进行。 如果我们结合媒体上所有可用的统计信息，结果表明人们每天通过Internet进行的通话时间超过十亿分钟。 随着技术的发展，视频通信的份额正在增加，因为视频可以更好地传达对话者的情绪，并允许您创建在场效果。 <br><br> 视频通话服务的新挑战是立即聚集一个来自世界各地的全家人或一群朋友，或在同一项目上远程工作的同事进行计划。 <br><img src="https://habrastorage.org/webt/mh/zl/8a/mhzl8ar7wkjk2akfni3vzzbiufi.jpeg"><br> 视频和磁带平台的开发负责人Alexander Tobol（ <a href="https://habr.com/ru/users/alatobol/" class="user_link">alatobol</a> ）将向您展示<a href="https://habr.com/ru/users/alatobol/" class="user_link">幕后</a>有一个视频呼叫服务，使用哪些技术和黑客技术来制作会议服务器以及如何正确传输视频。 快来学习如何将一对一呼叫服务转移到100人的团体呼叫中，以及为什么需要这么多参与者的支持。 <br><a name="habracut"></a><br><iframe width="560" height="315" src="https://www.youtube.com/embed/2z4XO3fyn3U" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br> 本文基于有关<a href="https://www.highload.ru/">HighLoad ++ Siberia</a>的报告，其中Alexander Tobol试图给出完整的图片。 如果您已经熟悉该主题的其他材料（例如， <a href="https://habr.com/ru/company/oleg-bunin/blog/428217/">有关视频传输</a>和<a href="https://habr.com/ru/company/oleg-bunin/blog/461829/">网络协议的功能</a> ），则可以跳过理论部分，直接进入<a href="https://habr.com/ru/company/odnoklassniki/blog/479852/">解决方案</a> 。 <br><br>  <strong>文章概述：</strong> <br><br><ul><li> 历史记录和设备调用。 </li><li>  <a href="https://habr.com/ru/company/odnoklassniki/blog/479852/">从一对一呼叫转换为群呼。</a> </li><li>  <a href="https://habr.com/ru/company/odnoklassniki/blog/479852/">DIY群呼服务。</a> </li><li>  <a href="https://habr.com/ru/company/odnoklassniki/blog/479852/">会议服务器：探索竞争对手并做得更好。</a> </li></ul><br><h2> 通话记录 </h2><br> 带有视频的第一个著名的通话应用程序是Skype，它于2006年问世。 在Odnoklassniki中，我们在2010-2012年基于Adobe的解决方案发起了呼叫。几年前，我们在WebRTC上完全重做了它（有关此发布的更多信息），去年我们添加了群组呼叫。 本文将讨论这种过渡。 <br><img src="https://habrastorage.org/webt/5v/-d/9o/5v-d9oc0kvmij7u43f4q8dihyoa.jpeg"><br> 为什么我可以告诉您该怎么做？ 因为我们每月使用电话的听众超过1000万人，而<strong>我们每天有超过200万的电话</strong> 。 此外，其中一半以上是通过移动平台发生的。 <br><br> 群组通话是增长最快的服务，我们的目标是100个同时参加的会议。 为什么这么多？ 首先，有时您想与您的朋友和同学分享美丽的镜头或举办研讨会。 其次，即使您认为您的服务不需要什么，一切也会改变。 <br><br> 现在看来，不需要100个参与者的视频会议，而五年前，他们问我为什么要启动4K视频。 现在4K电视已司空见惯，而我们早在2014年就已准备就绪。 <br><blockquote> 关键不是提前。 如果您想提供优质的服务，请提高您的要求标准。 </blockquote> 如果您可以拨打50到100人的电话，那么对于6到10个用户来说，一切都会很好。 <br><br> 每个呼叫服务具有4个相对独立的组件： <br><br><ul><li>  <strong>发信号</strong> 任务是呼叫订户，交换初始数据，告知每个订户可以做什么，然后建立一个通道，通过该通道可以传输视频数据。 </li><li>  <strong>视频/音频。</strong> 视频和音频数据使用编解码器压缩。 </li><li>  <strong>网络。</strong> 有必要确保在不良网络中工作，实现数据包恢复，p2p连接等。 </li><li>  <strong>拓扑</strong> -在组呼叫的情况下添加。 </li></ul><br> 您可以单独讨论这些部分中的任何一个。 但是，我想大致了解通话的工作原理，因此我将尽力使所有内容都适合一个故事。 <br><br> 在开始使用该服务之前，您需要确定以下<strong>要求</strong> ： <br><br><ul><li>  <strong>快速建立连接，</strong>以便在对话者拿起电话后立即建立连接。 </li><li>  <strong>高通话质量，</strong>因此视频不会崩溃也不冻结。 </li><li>  <strong>通话中的参与者人数</strong> ，以便您可以聊天，最多100位参与者。 </li><li>  <strong>呼叫者之间的等待时间短。</strong> 由于Polycom根本不适合我们，因此延迟时间为1.3 s。 </li></ul><br> 以下是表达这些对群呼要求的具体含义：呼叫开始不超过1秒；  300 Kbps视频稳定运行的网络； 从呼叫者到收听者的等待时间不超过0.5秒； 一次通话100个用户。 <br><br><h2> 怎么了？ </h2><br> 如您所知，网络中的数据以数据包的形式传输：有一个套接字，向其中发送数据流，所有内容都飞走了，就好像在黑盒子中一样，它已经组装好并且可以工作了。 <br><img src="https://habrastorage.org/webt/e4/pa/vy/e4pavyyaikufar_cl4sqw1karxe.jpeg"><br> 但是网络是不同的。 一半的通话是通过移动网络进行的，它们并不总是看起来像高速公路。 <br><img src="https://habrastorage.org/webt/ck/62/va/ck62vamogxhsgqdjuvvmoa1jlrq.jpeg"><br> 网络可能会过载，然后数据将丢失，必须将其还原，从而进一步加载网络。 有些网络似乎一切正常，但数据包仍然消失-例如，由于Wi-Fi路由器位于钢筋混凝土墙后面。 <br><br><h2> 网络功能 </h2><br> 我们将分析描述网络质量的主要特征。 <br><br><h3>  RTT </h3><br> 往返时间-服务器将数据发送到客户端到收到确认之间的时间。 <br><br> 记住，我们要在1秒内建立连接。 如果往返时间为200毫秒，则在建立连接（例如，通过TCP加上一些TLS）的情况下， <strong>仅在连接上可能会丢失500毫秒</strong> 。 仅剩500毫秒，即 还有几个请求，之后应该建立连接。 因此，对于RTT的额外要求，您需要非常谨慎地工作。 <br><br> 一个例子： <br><br><pre><code class="xml hljs">$ ping google.com 64 bytes from 173.194.73.139: icmp_seq=5 ttl=44 time=211.847 ms round-trip min/avg/max/stddev = 209.471/220.238/266.304/19.062 ms RTT = 220ms $ curl -o /dev/null -w "HTTP time taken: %{time_connect}\nHTTPS time taken: %{time_appconnect}\n" -s https://www.google.com HTTP time taken: 0.231 HTTPS time taken: 0.797 HTTP = 230ms HTTPS = 800ms</code> </pre> <br> 使用RTT = 220ms时，通过https接收响应最多需要800 ms。 因此，如果您具有Web套接字安全连接，则使用ping命令将使整秒钟消失。 <br><img src="https://habrastorage.org/webt/h7/jz/fz/h7jzfzctyl9uto140qct-vu05um.jpeg"><br> 该表显示了在移动网络中测量的握手延迟（在<a href="https://youtu.be/0xKAR0AHIdY">此</a>报告中，有关移动网络中应用程序操作的更多详细信息）。 <br><br><h3> 通量 </h3><br> 您可以根据需要将数据包发送到网络：分批发送或立即将所有内容放入缓冲区，它们仍将均匀地到达客户端。 每秒的数据包或数据数量是带宽或带宽。 <br><br> 问题在于<strong>移动网络的带宽在不断变化</strong> 。 如果它急剧下降，并且数据以相同的比特率传输，则它们显然会丢失，用户的呼叫将“挂起”。 这也必须进行斗争。 <br><br><h3> 丢包 </h3><br> 传输数据时，数据包可能会丢失。 在这种情况下，可以选择：跳过部分数据包并获得失真，或者尝试重新传输数据包并获得冻结帧。 <br><br><h3> 抖动 </h3><br> 事实是，数据包一次不会均匀到达，而是以一定间隔进入捆绑数据包。 <br><br><img src="https://habrastorage.org/webt/zs/hc/fu/zshcfujfcg6helcc8rnx8pyfor4.jpeg"><br> 抖动易于测量： <br><br><pre> <code class="xml hljs">PING highload.ru (178.248.233.16): 56 data bytes icmp_seq=11 ttl=43 time=117.177 ms icmp_seq=12 ttl=43 time=132.868 ms icmp_seq=13 ttl=43 time=176.413 ms icmp_seq=14 ttl=43 time=225.981 ms</code> </pre> <br>  Pinganuli highload.ru几次（ping是一个不稳定值，有必要进行平均），我们得到的平均抖动为： <code>((132-117)+(176-132)+(225-176)) / 3 = (14 + 44 + 79) / 3 = 46 </code> 。 <br><img src="https://habrastorage.org/webt/zj/4n/wp/zj4nwpcfmrefzo989lg_ipmbffy.jpeg"><br> 假设我们传输视频，并且一帧是网络数据包。 连续播放了几帧，但第三只鸟由于抖动而延迟-我们得到了冻结帧。 因此，您需要在某个位置累积软件包并均衡该效果。 <br><br> 也就是说，要表征无线网络，只需知道以下值即可：RTT（往返时间）； 带宽BW（带宽）； 丢包率； 抖动。 <br><br><h2> 用户是什么样的？ </h2><br> 在开始优化网络工作之前，您需要确定用户拥有哪种Internet-也许每个人都有一个完美的网络，任何解决方案都可以使用。 <br><br> 在80％的情况下，最终用户使用无线连接：它是移动网络或Wi-Fi。 <br><br><img src="https://habrastorage.org/webt/ub/_w/ep/ub_wepc3hzha5g1vmnbcuvu5758.jpeg"><br><br> 在俄罗斯，西部地区和大城市以外，平均网络特征为：RTT-200毫秒，带宽-1.1 Mbps，数据包丢失-0.6％，抖动-5ms。 <br><br> 我们将这些价值按网络类型划分，并意识到有必要进行学习。 <br><br><img src="https://habrastorage.org/webt/vb/mk/6u/vbmk6ue1tjohnzk9dmybx7jgiq4.jpeg"><br><br><h2> 通话开发功能 </h2><br> 许多人忘记了，但是LTE和3G是不对称的通信通道：下行链路始终大于上行链路。 根据协议类型的不同，此比率可以从15/85到30/70不等。 设计呼叫时，这一点很重要。 <br><br> 如何检查您的客户拥有哪个渠道？ <br><br><img src="https://habrastorage.org/webt/9y/kz/pj/9ykzpjasmaqko3glxox9ps6tkgs.jpeg"><br><br> 您可以看一下speedtest，移动和固定Internet之间的速度之比是多少。 事实证明，在世界范围内，固定互联网也是不对称的。 幸运的是，在俄罗斯，它是对称的：在俄罗斯，通过Wi-Fi固定的互联网上的上下行比率为50/50。 我们将专注于这样的价值观。 <br><br><img src="https://habrastorage.org/webt/al/6o/zb/al6ozb-zf_b_f8vecacwryr-gce.jpeg"><br><br>  <strong>底线：</strong>无线网络非常流行且不稳定。 <br><br><ul><li> 超过80％的客户使用无线互联网。 </li><li> 无线设置正在动态变化。 </li><li> 无线网络具有很高的丢包率，抖动率和重新排序率。 </li><li> 不对称的上/下行信道比例为30/70。 </li></ul><br><h2> 来电 </h2><br> 有了这些知识，让我们返回到组调用的实现。 考虑一个简单的组调用算法，然后对其进行优化。 <br><br>  <strong>步骤1.</strong>爱丽丝想打电话给鲍里斯（Boris）并向他发送一个要约，其中要报告她所能提供的一切，其中包括协议，设置等。 <br><img src="https://habrastorage.org/webt/k-/gr/xz/k-grxzwigzw4xaqgctisb27xalq.jpeg"><br>  <strong>步骤2.</strong> Boris回答Alice，之后建立传输连接。 <br><img src="https://habrastorage.org/webt/qf/yp/my/qfypmyzwq5sjl8et0tg2ju6vddm.jpeg"><br>  <strong>步骤3.</strong>之后，音频/视频数据的交换开始。 <br><img src="https://habrastorage.org/webt/rb/7w/hh/rb7whhnevjv6s15l0nmvftyx2lq.jpeg"><br> 任何呼叫的架构看起来都类似于下图。 <br><img src="https://habrastorage.org/webt/_n/6g/7o/_n6g7ohpbtl7wonvxjfrdcb8w2a.jpeg"><br> 总有一个共享服务器，但是建立连接后，用户已经可以传输p2p数据或通过第三方服务器进行传输。 <br><br> 摄像机捕获数据，然后将其编码在设备上并将其发送到套接字连接。 它们通过网络，由编解码器在另一端播放，并显示在屏幕上。 <br><br> 详细考虑算法的所有步骤，并尝试从一对一呼叫切换为群组呼叫。 <br><br><h2> 发信号 </h2><br> 任务：报告呼叫并建立数据连接。 <br><br> 一切都非常简单： <br><br><ul><li> 爱丽丝打电话，通知会发送到移动设备或浏览器上的鲍里斯。 </li><li>  Web套接字或任何其他连接已建立。 </li><li> 此后，进行协商-爱丽丝（Alice）和鲍里斯（Boris）同意。 </li><li> 在一部设备上拿起听筒后，通话会在另一部设备上自动结束。 </li></ul><br><img src="https://habrastorage.org/webt/x8/p8/4a/x8p84akywewgezvufnt64jqfmp8.jpeg"><br>  Odnoklassniki中的呼叫平台支持各种客户端和传输。 它们都靠近某种服务器，该服务器用于服务呼叫和转发消息。 <br><img src="https://habrastorage.org/webt/on/3v/9s/on3v9swzgtmfub9c_ru18qwjl1m.jpeg"><br> 如果服务器崩溃或安装了更新，则存在一个永久性存储，其中记录了所有消息。 万一服务器丢失，您可以轻松切换到另一台服务器。 这就是ZooKeeper所做的。 <br><br> 唯一的困难是<strong>一次</strong> 。 我们不想两次应用某些消息。 这个问题很简单地解决了：所有消息都有序列号-单个消息两次都不会到达。 <br><br> 另外，在创建呼叫时需要小心。 一个人可以创建呼叫，挂断并创建另一个呼叫。 或者它可能不会挂起，但仍会创建另一个。 所有这些呼叫都是唯一的-尚不清楚这是中继还是用户双击呼叫按钮。 它很容易修复：在客户端上生成唯一的ID，并在其上执行重复数据删除。 原则上， <strong>发信号没有困难</strong> 。 <br><br> 轻松完成向群组发送的p2p信号。 <br><img src="https://habrastorage.org/webt/7q/y6/zh/7qy6zhw2z72nbjcazwlx681hrau.jpeg"><br> 现在，爱丽丝不仅发送给鲍里斯，而且还发送给迪玛。 他们收到了他们的同意，数据交换渠道出现在他们之间。 <br><br><h2> 音频/视频 </h2><br> 为了应付小组通话并了解需要什么技术，我们将不得不谈一谈什么是视频。 <br><br> 视频为每秒24或60帧。 为了压缩它们，使用了编解码器。 编解码器的主要本质是每隔几帧就有一个参考帧（例如JPEG），中间帧是通过更改来确定的。 <br><img src="https://habrastorage.org/webt/yl/2d/fs/yl2dfs-nsm6cmuifnpaykbyhnkg.jpeg"><br> 在上图中，机器的第一帧是参考帧，在下一帧中，仅对更改（机器的运动）进行编码，而在下一次仅对更改进行编码。 <br><br> 这称为图片组-可以解码的一组独立的互连帧。 编解码器是帧之间转换的算法。 编解码器越陡，压缩数据就越好，并且需要更多的资源。 <br><div class="scrollable-table"><table><tbody><tr><td> 质素 </td><td> 权限 </td><td> 最低比特率 </td></tr><tr><td> 全高清 </td><td>  1920x1080 </td><td>  4 Mbps的 </td></tr><tr><td> 高画质 </td><td>  1280x720 </td><td>  1.5 Mbps的 </td></tr><tr><td> 低 </td><td>  640x360 </td><td>  600 kbps </td></tr><tr><td> 最低的 </td><td>  426x240 </td><td>  300 kbps </td></tr></tbody></table></div> 关于编解码器比特率的比率，有一些通用规则（请参阅<a href="https://youtu.be/e1JYFRwHzkQ">链接</a> ）。 <br><br> 用于呼叫的最受欢迎的编解码器是<strong>H.264和VP8</strong> 。  H.264之所以出色，是因为它在任何地方都可以正常工作并且不会消耗电池。 但是通常在电话上只有一个编码器（编码器）和四个解码器。 对于其他所有内容，您都需要消耗大量电池的VP8软件。 值得将组呼叫的优先级更改为H.264（请参阅有关如何执行此操作的<a href="https://is.gd/5WaBAP">链接</a> ）。 <br><br> 编解码器可以使用可变（可变比特率）或恒定比特率（恒定比特率）进行编码。 设备上的许多编解码器不支持恒定的比特率，因此您必须忍受左侧的图片。 <br><img src="https://habrastorage.org/webt/6r/ej/mt/6rejmtldwpgvu2an6bbjwu7-xoq.jpeg"><br><br><h3> 音频编解码器 </h3><br> 有各种传统的音频编解码器，例如G711。  Opus编解码器非常受欢迎-它解决了低比特率和高比特率的编码问题，因为其中包含Skype的SILK和音乐的CELT编解码器。 <br><br> 值得一提的是，Opus具有前向纠错（FEC）主动纠错算法。 对于音频，此算法的工作方式如下：在每个数据包中，存在高质量的数据，并且一段时间内来自较低质量的前一帧的数据。 因此，如果先前的数据包丢失了，您可能会以低质量获得先前数据包的数据，并以某种方式丢失。 平均而言，结果还不错。 <br><br> 使用音频编解码器时，有趣的是该图，该图显示了输入信号质量与比特率的比率。 <br><img src="https://habrastorage.org/webt/_r/wd/em/_rwdemfrce5rw2njez4pge9wgr0.jpeg"><br> 可以看出，Opus解决了几乎所有问题。 有趣的是，要注意在各种托管服务中对视频进行编码时使用的AAC，以及仅用于音频且最高32 Kbps正常工作的旧Speex编解码器。 <br><br><h3> 媒体病理数据 </h3><br> 为了了解拓扑如何工作，拓扑具有什么功能，您需要了解视频编解码器如何处理损耗。 <br><img src="https://habrastorage.org/webt/vt/dn/zm/vtdnzmfdmc8n8bxq_rmmfoscpls.jpeg"><br> 在第一种情况下，什么也没有丢失，我们看到了一张好照片。 在第二行中，丢失了一个随机帧-图片中有小的伪像。 在第三种情况下，参考系消失了，因此，直到下一个参考系，将显示彼此随机重叠的变化。 <br><br> 显然，制作参考帧通常很昂贵，因为比特率不断增长。 因此，几乎所有的呼叫服务都以某种方式支持在丢失的情况下请求参考帧的能力。 在WebRTC中，这称为完整INTRA帧。 <br><br> 最简单的拓扑是将所有视频发送给所有其他会议参与者。 <br><img src="https://habrastorage.org/webt/st/mt/bu/stmtbu09eze8vg6letvekimnosu.jpeg"><br> 我们启动一个编解码器，然后开始传输视频。 爱丽丝打开摄像机（编解码器），将视频发送给鲍里斯和迪玛。 但是，如果Dima的互联网质量不佳，鲍里斯（Boris）就会受苦，因为您需要降低整个视频的质量。 如果迪马（Dima）丢了球并要求提供一杆，鲍里斯（Boris）也会得到，尽管他不需要他。 <br><br> 另一方面，您可以将所有视频粘贴在一个流中。 这将需要特殊的设备，并且可能会有额外的延迟，但是这种解决方案也存在。 <br><br><h3> 以最小的延迟传输或交付视频和音频 </h3><br> 我们可以选择TCP或UDP协议。 <br><div class="scrollable-table"><table><tbody><tr><td>  TCP协议 </td><td>  UDP协议 </td></tr><tr><td> 可靠的 </td><td> 不可靠 </td></tr><tr><td> 面向连接 </td><td> 无连接 </td></tr><tr><td> 通过窗口进行段重传和流控制 </td><td> 没有开窗或重新传输 </td></tr><tr><td> 段测序 </td><td> 没有排序 </td></tr><tr><td> 确认序列 </td><td> 没有回音 </td></tr></tbody></table></div> 可能每个人都记得TCP是一种可靠的协议，在丢包的情况下，TCP会再次发送它们。 这就是为什么可以按以下顺序排列帧的原因。 <br><img src="https://habrastorage.org/webt/si/qm/rc/siqmrcta6lzauazsdsbitbkifvo.jpeg"><br> 如果数据包中缺少数据包，则可以随意跳过视频中24帧中的这一帧，但是TCP将不允许您接收以下内容，除非您发送丢失的帧。  <strong>通过TCP传输视频效率极低。</strong> 建议将UDP用于此类任务，并且所有呼叫服务都应使用UDP。 <br><br>  <a href="https://habr.com/ru/company/oleg-bunin/blog/461829/">本文</a>提供了这两种协议的所有功能，并解释了为什么所有流都可以在UDP上工作。 作为今天主题的一部分，足以让我们知道UDP并非在任何地方都可用，它不能在3％的网络中工作。 <br><img src="https://habrastorage.org/webt/tv/ky/jz/tvkyjzwzytjo2pgxmfgek1afv_8.jpeg"><br> 通常，用户可以在他们之间建立P2P连接。 <br><img src="https://habrastorage.org/webt/xe/nj/ew/xenjewfqamelio5eqywflbiyn54.jpeg"><br> 这是最有利可图的，因为如果我们在新西伯利亚互相打​​电话，最好是直接通信而不使用额外的服务器来提供杠杆作用。 <br><br> 但是NAT存在，现在有97％以上的用户位于其后面-很少有外部IP。 一方面，IPv6迟早会解决此问题。 顺便说一下，在俄罗斯，MTS是第一个启动它的公司。 现在，他们完全支持IPv6，并且所有客户端都具有白色IP。 <br><br>  NAT可能会突破，也可能不会突破，然后您将不得不通过服务器使用回退。 还有<a href="https://habr.com/ru/company/oleg-bunin/blog/428217/">一篇有关</a>如何突破NAT的<a href="https://habr.com/ru/company/oleg-bunin/blog/428217/">文章</a> 。 <br><br><h3> 传输和帧之间的抖动缓冲区 </h3><br> 我们继续前进。 现在我们需要抖动缓冲器来均衡抖动的影响 <br><img src="https://habrastorage.org/webt/od/eb/m5/odebm5kla1eprghttikfis_tzm8.jpeg"><br> 我们主动开始显示具有某些延迟的帧，与此同时，我们在缓冲区中以相同间隔排列帧。 <br><br> 缓冲区动态增加。 <br><img src="https://habrastorage.org/webt/_q/-s/o4/_q-so4lqgyenwyrlcbk2u141h2k.jpeg"><br> 如果丢失了帧，并且图片被冻结，则缓冲区增加，然后我们已经在使用这种大小的缓冲区。 <br><br> 但是当您需要减少缓冲区时，可能会出现相反的情况。 例如，网络已经稳定，需要花费时间。 如果您只是减少缓冲，那将是荒谬的，人们将开始以侏儒的声音非常快速地讲话。 因此，有一些特殊的算法会无意识地调节音频速度：消除单词之间的停顿或语音中声音过长的崩溃声音。 <br><br> 如果要对视频进行转码并修复某些内容，则首先需要具有抖动缓冲区，其延迟将不小于此网络的延迟抖动。 也就是说，它肯定会增加延迟，并且我们记住我们确实希望保持在0.5 s之内。 <br><img src="https://habrastorage.org/webt/um/vs/2i/umvs2isu-bjnd2sp4u7ke7sqyv4.jpeg"><br> 呼气-理论结束了！ <br><br><h2><a name="ok-call"></a> 通话确定 </h2><br> 在进行群组通话之前，我们进行了p2p通话，使用了WebRTC库，收集了Web和移动客户端，并编写了信令。 <br><img src="https://habrastorage.org/webt/kj/sl/uo/kjsluoez0wxxhsya9ttbfaev--k.jpeg"><br><br><h3> 竞争对手分析 </h3><br> 当您不知道该怎么做时，请看看您的竞争对手。 作为参考，我们选择了一组：Skype，WhatsApp，环聊，ICQ，缩放。 我们测量了群组通话的最大参与者人数，延迟，电池消耗和质量。 <br><br> 最有趣的是确定延迟。 我们这样做：打开计时器，开始拍摄视频，打个电话。 <br><img src="https://habrastorage.org/webt/0k/_q/ct/0k_qctbyc9_eenat32mcm3zbz10.jpeg"><br>  100毫秒-从视频到达镜头那一刻起，到在手机矩阵上绘制视频之前的摄像头延迟。 之后，视频将发送到网络，并且通话中已经存在310毫秒的延迟。 <br><img src="https://habrastorage.org/webt/eg/oi/g5/egoig53tzrzn-1byodqkwmfcfsq.jpeg"><br> 不要忘记测量设备上的CPU使用率。 从iOS 12开始，可以系统地执行此操作，但是我们以旧的方式使用高温计。 <br><br> 得到了以下结果： <br><img src="https://habrastorage.org/webt/mk/tu/1s/mktu1se2wjoa_lwb842wsfkyouk.jpeg"><br>  WhatsApp和ICQ最多有4个呼叫参与者，Skype有25个（Skype for Business 250），而Hangouts和Zoom每个都有100个参与者。 环聊曾经有大约35位成员，现在他跳到了100+部分。 <br><br> 缩放的延迟时间略长，但是环聊会消耗更多电池电量。 在我看来，Zoom具有更好的质量，但是有些文章则相反-这是一个主观指标。 <br><img src="https://habrastorage.org/webt/mu/sa/9b/musa9bet2chfnzj55svmkj5j9qk.jpeg"><br> 一些服务使用开放的WebRTC，其他服务使用专有协议。 但是很明显，您在下面使用哪种传输方式不会影响通话的参与者数量。 解决方案有100个呼叫，各自的协议（Zoom）和WebRTC（环聊）。 <br><br><h3> 从2到N </h3><br> 考虑一个有趣的情况：有一个客户端具有非对称通道，输入3 Mbit / s，输出1.5 Mbit / s，丢包0.6％，抖动50毫秒。 分辨率为600 bps的高清视频（1280x720）的比特率为1.5 Mbps，分辨率为640x360的视频（我们称之为LOW）。 我们要传输很酷的视频。 <br><br> 如果有两个人呼叫p2p，那么一切都很简单。 他们有足够的输入网络，输出网络足够紧，因为通道是非对称的，并且编解码器没有问题-所有编解码器都是免费的。 <br><br> 当我们开始进行群组通话时，我们需要重新连接所有人。 拓扑的最简单版本是<strong>Mesh</strong>或“ all to all”。 <br><img src="https://habrastorage.org/webt/xt/zk/th/xtzkthwsqgph-xmvnpzufncfl6o.jpeg"><br> 不需要中间服务器真是太好了，但是为所有人提供具有此类特征的客户的视频变得越来越成问题。 而且，如果客户不能将视频单独分发给某人，则您需要降低质量，因为通用流是为每个人编码的。 <br><br> 在这种情况下，对于5个参与者，3或4 Mbps都不够。 <br><img src="https://habrastorage.org/webt/ah/h5/rf/ahh5rfvgcjjkm70qhzv1ruduaws.jpeg"><br> 因此，在群组通话中的WhatsApp中，最多有4个参与者，并且只要他们使用Mesh，就不再是参与者。 <br><br> 另一种选择是<strong>在服务器上收集</strong>整个图片。 这对客户端来说是最有利可图的：它与服务器建立了一个连接，服务器收集了图片，客户端将其收回。 <br><img src="https://habrastorage.org/webt/bg/_3/qh/bg_3qhrgkt1izvjkwciy4pfegbm.jpeg"><br> 但是，假设我们来自Petropavlovsk-Kamchatsky，Komsomolsk-on-Amur和新西伯利亚的用户希望通过Moscow服务器聊天。 自然，结果将非常糟糕。  CDN的存在会有所帮助，但仍然会获得大量的抖动缓冲区，这将总体上增加延迟。 <br><br> 下一个拓扑- <strong>结束混合</strong> -建议不要在服务器上收集一般图片以避免这些延迟，而只是抛出数据包。 <br><img src="https://habrastorage.org/webt/1k/aj/cc/1kajccrtduezyvharoklxqwlv0e.jpeg"><br> 也就是说，这种拓扑中的服务器只是传输数据的中继。 <br><br> 一切都变得更好了：用户收到呼叫中所有其他参与者的信息流，并且仅发送一次自己的信息。 但是同样存在问题： <br><br><ul><li>  <strong>质量</strong> 您的信息流的所有收件人都具有不同的网络。 如果一个人的互联网连接不佳，则视频需要以低分辨率传送给他，因此，图像将对所有人不利。 </li><li>  <strong>风暴参考系</strong> 。 如果互联网状况不佳的人不断要求提供参考框架，那么每个人也都会收到意见。 这是比特率的低效使用，质量再次下降。 </li></ul><br><img src="https://habrastorage.org/webt/26/wj/bv/26wjbvlg4tlfijnuif4dwzpfc8m.jpeg"><br> 如果使用<strong>集中式系统</strong> ，即所有视频都收集在服务器上。 这需要许多编码阶段，这既增加了等待时间，又需要额外的硬件。 相反，在End混合中，一切都是快速而简单的。 <br><br>  <strong>缺点拓扑：</strong> <br><br><ul><li> 网格-最多4个成员。 </li><li> 集中式-转码和抖动问题。 </li><li> 结束混合-质量限制和风暴参考帧。 </li></ul><br> 只有ICQ和Skype可以在网状拓扑上工作，其余所有都是端混合。 但是，正如我们所记得的，所有服务的特征都是不同的-这意味着不仅有End混合，还有其他。 <br><br> 环聊通过结束混音来解决问题。 <br><img src="https://habrastorage.org/webt/pm/uy/25/pmuy25cx0untfvn3gbk0qmcehay.jpeg"><br> 每个客户端上都会启动两种编码器：高质量的H.264和低质量的VP8。 因此，对于具有良好Internet的用户，服务器将传输高质量的视频，而对于那些Internet较差的用户，情况会更糟，并且质量较差的视频会适应最差的网络。 两种品质都不错，但这是来自客户的额外流量和电池消耗。 但是没有抖动缓冲区 <br><br> 该表显示，环聊运行时，手机最容易发热，延迟最小，但是质量受到影响，因为低质量仍然会吞噬高比特率。 <br><img src="https://habrastorage.org/webt/na/6n/2f/na6n2fs0u3ebkqez1jjntk3kel0.jpeg"><br>    ,    : -      ,  H.264,         (    )   End mixing   .      centralized-,    ,    ,       ,     . <br><img src="https://habrastorage.org/webt/db/15/pw/db15pwl1tkdxpxd4xpz8gp-sba4.jpeg"><br> ,      :      .   ,        , ,     ,   -     .    ,           . <br><br>        . <br><img src="https://habrastorage.org/webt/0o/9y/6b/0o9y6bt7zahjvydljkpnkvaxvyk.jpeg"><br> ,  ,    ,       latency     .    ,        , ,   ,       .                 centralized,    ,  ,   jitter-  .          ,            ,   . <br><br>        «»,   .          100,  50,   20   .           . <br><img src="https://habrastorage.org/webt/du/88/yt/du88ytnejvtsgryudgkdfntv7pg.jpeg"><br>         —  ,       5 .      .    :  ,     ,      ,      —      . <br><br>  «»      , ,    , —  .       :   ,    - ,    fps.  ,          —  .    - ,  .    ,     . <br><br><h2><a name="fin"></a>   </h2><br>    Mesh  3-4       latency,    ,         Mesh.      ,   HD   End mixing, a SD —  centralized. <br><br>       Zoom. <br><img src="https://habrastorage.org/webt/h9/5q/2q/h95q2que4mihuktnf2mz18zsjua.jpeg"><br> ,    -    ,   Zoom  ,    WebRTC.   <strong>   WebRTC</strong> ,        . <br><br><h2>  </h2><br>      . <br><br> <strong>CPU   ,  .</strong>       — ,    ,   ,   ,   CPU ,  .     ,       . <br><br>   :   ,    ,      . <br><br> <strong> screen sharing   .</strong>    screen sharing,       ,    .   screen sharing  .  ,   fps — ,    ,    . <br><br> <strong>        .</strong>    —     centralized,      ,       .    ,   . <br><img src="https://habrastorage.org/webt/kd/b4/zt/kdb4ztkg9daqyfjryhpzg4u7uac.jpeg"><br>  ,        ,    ,     .         ,    ,                 . <br><br><h2><a name="server"></a>   </h2><br> ,   ,  -     .               . <br><img src="https://habrastorage.org/webt/ga/ve/43/gave43pdwqyaly4pm7b1amurzxc.jpeg"><br><br><h3> Packet pacing </h3><br> -,  UDP-     .   UDP   pacing.    UDP-  ,     . <br><img src="https://habrastorage.org/webt/mc/mb/t3/mcmbt33ngipgrs1xlf3hvhbx6d8.jpeg"><br>   ,      UDP ,   21       100%.           —     . <br><br>     pacing?    ,         (   <a href=""></a> ) —   ,  .  ,         ,  , ,  ,     ,   -             . <br><br>   : <br><br><ul><li>  pacing,     . </li><li>   pacing, ,  ,   ,      . </li></ul><br>     :        ,  pacing ,    —. <br><br>    packet pacing? <br><img src="https://habrastorage.org/webt/wp/y3/vx/wpy3vxtcvgzvn8lukrnrpm2sx2w.jpeg"><br>   ,   (    )      ,   ,  - .   (  ),     ,       ,     . <br><br>    — packet loss ,   pacing. <br><br><h3> MTU </h3><br> TCP  ,       MTU.      UDP,     ,  MTU —    ,      . <br><br>       MTU 1500,        MTU 1100,   . ,    ,        , , ,    (   ).       ,   MTU . <br><img src="https://habrastorage.org/webt/rc/r7/jv/rcr7jvrykz5mtbajkmskh-s9if0.jpeg"><br>  TCP  ,       .   ,   MTU:   -   ,    , ,    MTU.         ,   MTU,    ,  . <br><br>   . <br><img src="https://habrastorage.org/webt/mp/fx/ct/mpfxctwu5bck6fnp2_nr_lsmugc.jpeg"><br>   ,     :      ,  ,      .  98%          1350.    <strong>MTU = 1350</strong> ,    ,    2%    —  ,  . <br><br><h3>   </h3><br> WebRTC  SACK, NACK, FEC.       . <br><br>   ,   1–3%     —  ,      . <br><br>  WebRTC      negative acknowledgement (NACK). <br><img src="https://habrastorage.org/webt/n4/ik/zh/n4ikzhbxffmdjuf-a79snq2vaum.jpeg"><br>         ,  ,  -  ,  . <br><br>  , TCP   acknowledgement,     selective acknowledgement.  negative acknowledgement  ,        FEC (Forward Error Correction). <br><br>     ,   SACK, NACK, FEC,   <a href="https://youtu.be/e1JYFRwHzkQ"></a> . <br><br>  FEC ,   ,   .  :      ,   ,         .     , ,    —   . <br><img src="https://habrastorage.org/webt/fo/dw/-s/fodw-s_sepjc4qkhonlbr_k-6pq.jpeg"><br>    FEC —  XOR,      , ,  .       ,     -  . <br><br>  <a href="https://tools.ietf.org/html/draft-ietf-payload-flexible-fec-scheme-20"></a>   ,       .     ,        ,     ,     FEC-.  ,   ,         , ,          . <br><br> ,   , <strong>   </strong> .    , : <br><br><ul><li>  90%     500 /. </li><li>    — 3-4,        Mesh  End mixing. </li><li>      —  27  (,  ). </li></ul><br><h2> Check List </h2><br>          : <br><br><ul><li> Packet pacing. </li><li> MTU discovery. </li><li>  . </li><li> C    . </li></ul><br>    ,     signalling,   WebRTC,   ,   ,     - . <br><br>       ,     : <br><br><ul><li> <strong>Packet loss:</strong> , packet pacing, FEC,  MTU. </li><li> <strong>   :</strong>    back pressure  ,         FEC-. </li><li> <strong>Jitter</strong>     jitter buffer,     latency. </li><li> <strong>RTT:</strong>   ,      signaling. </li></ul><br><h1>      </h1><br> WebRTC —    .  RTP,        ,    ,   .     WebRTC  . <br><br>    ,   Zoom, Skype  Line,    .      .         . ,    ,     <a href="https://habr.com/ru/company/oleg-bunin/blog/413479/"></a>   UDP- (      ,   WebRTC),   .   ,    ,    . ,    Google STADIA. <br><br> STADIA —   ,       .    WebRTC,  ,     .  Google      WebRTC.     WebRTC     SRTP WebRTC  QUIC.  ,    ,    . <br><br>   QUIC,     .    Chrome  c Android   Google  YouTube,    TCP —  QUIC  UDP  Google.     30%   QUIC/UDP. <br><br>     QUIC     20-30%,  TCP.    - QUIC    ,       . <br><br><h1> 结论 </h1><br>     ,           .  ,     : signaling; / ;   . ,     ,    . <br><br>     ? <br><br><ul><li>  ,     - ,    . </li><li>       ,    . </li></ul><br>      /     . <br><br>  ,    , — <strong>   </strong> .        ,  latency,  . ,    !   -       :) <br><br><blockquote>    HighLoad++     . <a href="https://www.highload.ru/spb/2020"> </a> (      )   ,  <a href="https://conf.ontico.ru/lectures/propose%3Fconference%3Dhl2020-spb"> </a>   6-7  2020   .    ,   <a href="http://eepurl.com/VYVaf"></a> . </blockquote></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN479852/">https://habr.com/ru/post/zh-CN479852/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN479836/index.html">国家杜马通过了微型发电方面的电力法修正案。 替代品会快乐吗？</a></li>
<li><a href="../zh-CN479842/index.html">巴塔大学创建了一个电子模拟神经元</a></li>
<li><a href="../zh-CN479844/index.html">召集一个UX设计师团队，由于雇用错误而损失700万</a></li>
<li><a href="../zh-CN479848/index.html">我们的2019年象限！ Gartner Meeting Solutions视频会议分析报告在过去五年中发生了怎样的变化</a></li>
<li><a href="../zh-CN479850/index.html">在Windows Server Core 2019上安装Exchange 2019</a></li>
<li><a href="../zh-CN479854/index.html">12月12日上午Java摘要</a></li>
<li><a href="../zh-CN479858/index.html">寻找LD_PRELOAD</a></li>
<li><a href="../zh-CN479860/index.html">生活建模主题的变体。 第二部分</a></li>
<li><a href="../zh-CN479862/index.html">注册软件时如何节省15000卢布</a></li>
<li><a href="../zh-CN479864/index.html">16年内在WinForms + C＃上进行游戏（第2部分）</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>