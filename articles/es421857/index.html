<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>‚õé üèÖ üë®üèΩ‚Äçüè≠ ToFoIn v 1. Reserva de puertas de enlace y cambio entre canales externos en FreeBSD üõÑ üçä ü§õ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Anotaci√≥n 
 En un art√≠culo anterior, se consider√≥ la organizaci√≥n de la redundancia para las puertas de enlace LAN. Como soluci√≥n, se propuso un scrip...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>ToFoIn v 1. Reserva de puertas de enlace y cambio entre canales externos en FreeBSD</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/421857/"><h3>  Anotaci√≥n </h3><br>  En un art√≠culo anterior, se consider√≥ la organizaci√≥n de la redundancia para las puertas de enlace LAN.  Como soluci√≥n, se propuso un script que en ese momento solucion√≥ el problema, pero ten√≠a varios inconvenientes.  Despu√©s de un tiempo, result√≥ eliminar estas deficiencias, reescribir parcialmente el c√≥digo y obtener algo aceptable en la salida.  Ahora podemos decir que las secuencias de comandos se prueban lo suficiente como para ser llamadas estables.  Para simplificar la comprensi√≥n de todo el sistema, los puntos principales para configurar servicios secundarios (en t√©rminos del tema del art√≠culo) se duplicar√°n parcialmente a continuaci√≥n.  La raz√≥n es simple: durante este tiempo las reglas de ipfw tambi√©n fueron modificadas, dns se fue a vivir en AD en Samba4 con un bind-frontend y registros actualizados de forma segura desde isc-dhcpd usando kerberos, as√≠ como servidores dns secundarios como bind en las puertas de enlace, CARP configurada ... En general, se ha vuelto mucho m√°s interesante, pero a continuaci√≥n encontrar√° m√°s informaci√≥n sobre qu√© y c√≥mo funciona.  Todo lo que se puede dar con referencias a la fuente se dise√±ar√° de tal manera que no produzca esencia.  Lo que se tom√≥ de otros lugares, pero que ya no est√° disponible, se dar√° aqu√≠ con comentarios relevantes. <br><a name="habracut"></a><br><h3>  Introduccion </h3><br>  Por lo tanto, hay dos formas de aumentar la inmunidad al ruido del canal de comunicaci√≥n con el mundo exterior por parte del consumidor: copia de seguridad de la puerta de enlace y reserva del punto de conexi√≥n.  En otras palabras, en el primer caso, se configura una segunda puerta de enlace, que se activar√° si falla la primera, en el segundo caso, se organizar√° un canal de Internet de respaldo en caso de problemas con el principal, y cuanto m√°s se crucen, mejor, obviamente.  Si <abbr title="Protocolo com√∫n de redundancia de direcciones">CARP</abbr> resuelve la primera tarea para FreeBSD, la segunda, despu√©s de organizar el segundo canal externo, puede, de nuevo, resolverse de varias maneras.  Como m√≠nimo, puede organizar el equilibrio del tr√°fico o cambiar entre canales.  Debido a la gran diferencia en el ancho de banda de los canales externos, la primera opci√≥n no me <abbr title="Toogle Failover de Internet">conven√≠a</abbr> , por lo que el principal culpable de la publicaci√≥n fue escrito: <abbr title="Toogle Failover de Internet">ToFoIn</abbr> , un conjunto de scripts de bash que tiene como objetivo resolver problemas de diagn√≥stico y cambiar a un canal externo que funcione.  Despu√©s del refinamiento, se puede aplicar a n puertas de enlace ym canales.  La situaci√≥n es d√©bil, donde n y m son m√°s de 2, pero los siguientes scripts deber√≠an funcionar con valores grandes de n y m, porque  L√≥gicamente, el l√≠mite no est√° establecido.  En general, sospecho que usando estos scripts es posible resolver una gama bastante amplia de tareas, dependiendo del estado de la conexi√≥n, limitada, tal vez, solo por imaginaci√≥n. <br><br><img src="https://habrastorage.org/webt/2e/yw/s8/2eyws8o9hbu3cxfpo0yja6dm_ea.png" width="500" align="left"><br>  Aproximadamente, una topolog√≠a de red de este tipo supone en la forma m√°s simple el uso de un conjunto de scripts ToFoIn.  Por supuesto, los scripts deben funcionar en el caso de un solo enrutador, pero en este caso, tendr√° que cambiar el m√≥dulo Daemon fuertemente para eliminar la dependencia de la secuencia de acciones en el estado CARP, que simplemente estar√° ausente en el sistema.  La reserva adicional de estos y otros nodos depende solo del grado de importancia de los servicios correspondientes. <br><br><h3>  Metas y objetivos </h3><br>  El objetivo del proyecto, como antes, es crear un paquete de software universal y f√°cilmente escalable enfocado en identificar problemas en conexiones externas e internas y cambiar autom√°ticamente a conexiones viables.  En t√©rminos generales, la l√≥gica es la siguiente: <br><br><ul><li>  Hay n "enrutadores" con m canales externos en cada uno.  Adem√°s, todos los "enrutadores" est√°n en una jerarqu√≠a estricta y est√°n conectados entre s√≠ mediante CARP en todas las interfaces necesarias. </li><li>  Un agente trabaja independientemente en cada m√°quina, cuya tarea se basa en el estado CARP actual de su m√°quina: <br><ul><li>  Si es una copia de seguridad: detecte y configure la m√°quina en un enrutador que actualmente es el maestro; </li><li>  Si es maestro: verifique el estado de las conexiones en el momento actual y, si es necesario, cambie entre canales externos. </li></ul></li></ul><br><h3>  Soluci√≥n </h3><br>  La red interna tiene CARP, que proporciona puertas de enlace de respaldo y le permite no cambiar la configuraci√≥n de otros dispositivos de red en la red interna al cambiar de canal. <br><br>  Dhcpd funciona en modo primario - secundario y, en general, no importa qu√© otras funciones juegue su m√°quina: la conexi√≥n entre dhcpd se produce en la red interna, que los enrutadores siempre observan. <br><br>  El enlace maestro se elimina en AD, que est√° oculto en la red local, mientras que los servidores de enlace secundario trabajan en los enrutadores de la puerta de enlace en igualdad de condiciones. <br><br>  Las reglas de ipfw difieren dependiendo de qu√© canal se considera el canal principal en un momento dado y son reiniciadas por el m√≥dulo Daemon cuando se cambian los roles. <br><br>  Finalmente sobre los propios guiones.  Ahora los archivos se encuentran en los directorios apropiados, funcionan desde su usuario y tienen un script de inicio en rc.d.  Sudo resuelve las tareas que requieren acceso a la ra√≠z.  Existe un script de instalaci√≥n que tiene en cuenta la posible presencia de una versi√≥n instalada, as√≠ como un archivo de configuraci√≥n bastante detallado.  Los m√≥dulos son los mismos con cambios menores, algunos casi no cambiaron en funcionalidad: <br><br>  <b>Daemon</b> , como su nombre lo indica, es el proceso principal que ejecuta la prueba y cambia los m√≥dulos en un temporizador, y tambi√©n monitorea CARP. <br>  <b>Probador</b> : a√∫n prueba las comunicaciones externas con el comando ping.  (si se est√° ejecutando, considera que la m√°quina tiene CARP en el estado Maestro) <br>  <b>Juez</b> : en funci√≥n de los resultados de la prueba, determina qu√© canal externo funciona y si la conmutaci√≥n es necesaria, realiza la conmutaci√≥n (si est√° en funcionamiento, considera que la m√°quina tiene CARP en el estado Maestro). <br>  <b>Scout</b> es un nuevo m√≥dulo.  Se inicia cuando CARP est√° en estado de copia de seguridad.  Es necesario determinar cu√°l de los enrutadores restantes es actualmente el principal. <br>  <b>Registrador</b> : responsable del registro de eventos.  Es necesario para que la informaci√≥n sobre eventos no se duplique y la revista sea m√°s f√°cil de leer. <br>  <b>Watchdog</b> : se ejecuta seg√∫n el cronograma de crontab.  Determina la "congelaci√≥n" de todos los m√≥dulos y (siempre que sea posible) intenta resolver los problemas que han surgido.  Es decir  clavar a todos, simplemente poner. <br><br>  Adem√°s de los scripts en s√≠, vale la pena considerar algunos archivos m√°s importantes: <br><br>  <b>Tofoin.conf</b> : un √∫nico archivo de configuraci√≥n. <br>  <b>Tofoin.log</b> : un √∫nico archivo de registro de eventos. <br>  <b>Result_</b> &lt;n√∫mero de canal interno&gt; es el archivo de trabajo, los resultados de la prueba se agregan aqu√≠, creados en / tmp junto a .pid y otros archivos de trabajo. <br><br>  Con gusto puedo responder las preguntas sobre el funcionamiento de los m√≥dulos, explicando las soluciones en los comentarios. <br><br><h3>  Parte t√©cnica </h3><br><h4>  Equipo </h4><br>  En comparaci√≥n con el tiempo anterior, las puertas de enlace se trasladaron a P4, recibieron 1536 Mb de RAM y tres discos duros de 40 Gb (espejo + repuesto).  Las tarjetas de red siguen siendo PCI, las PSU son normales, naturalmente en presencia de un UPS. <br>  El aumento de la capacidad est√° asociado con el hierro liberado y la actualizaci√≥n excesivamente tediosa de la fuente, pero principalmente la primera.  Sistema operativo FreeBSD 11.1, FS zfs. <br><br><h4>  Configuraci√≥n de componentes del sistema </h4><br><div class="spoiler">  <b class="spoiler_title">M√°s detalles</b> <div class="spoiler_text">  El n√∫cleo se compila con dichos par√°metros adicionales (tambi√©n se puede configurar algo en el cargador, pero es mejor as√≠): <br><br><pre><code class="bash hljs">options IPFIREWALL <span class="hljs-comment"><span class="hljs-comment"># ipfw firewall options IPFIREWALL_VERBOSE options IPFIREWALL_VERBOSE_LIMIT=50 options IPFIREWALL_NAT options LIBALIAS options DUMMYNET options HZ=1000 options ROUTETABLES=4 options KSTACK_PAGES=4 options KVA_PAGES=512 device carp</span></span></code> </pre> <br>  Configuraci√≥n /boot/loader.conf: <br><pre> <code class="bash hljs">geom_mirror_load=<span class="hljs-string"><span class="hljs-string">"YES"</span></span> zfs_load=<span class="hljs-string"><span class="hljs-string">"YES"</span></span> kern.geom.label.gptid.enable=<span class="hljs-string"><span class="hljs-string">"0"</span></span> vm.kmem_size=<span class="hljs-string"><span class="hljs-string">"1024M"</span></span> vm.kmem_size_max=<span class="hljs-string"><span class="hljs-string">"1024M"</span></span> vfs.zfs.arc_max=<span class="hljs-string"><span class="hljs-string">"512M"</span></span> vfs.zfs.vdev.cache.size=<span class="hljs-string"><span class="hljs-string">"30M"</span></span> vfs.zfs.prefetch_disable=1 kern.vty=vt</code> </pre> <br>  Configuraci√≥n /etc/rc.conf en la primera m√°quina (la configuraci√≥n CARP es de gran inter√©s): <br><pre> <code class="bash hljs">ifconfig_eth0=<span class="hljs-string"><span class="hljs-string">"up"</span></span> vlans_eth0=<span class="hljs-string"><span class="hljs-string">"vlan111 vlan222"</span></span> create_args_vlan111=<span class="hljs-string"><span class="hljs-string">"vlan 111"</span></span> create_args_vlan222=<span class="hljs-string"><span class="hljs-string">"vlan 222"</span></span> ifconfig_eth1=<span class="hljs-string"><span class="hljs-string">"up"</span></span> vlans_eth1=<span class="hljs-string"><span class="hljs-string">"vlan333 vlan444 vlan555"</span></span> create_args_vlan333=<span class="hljs-string"><span class="hljs-string">"vlan 333"</span></span> create_args_vlan444=<span class="hljs-string"><span class="hljs-string">"vlan 444"</span></span> create_args_vlan555=<span class="hljs-string"><span class="hljs-string">"vlan 555"</span></span> ifconfig_eth2=<span class="hljs-string"><span class="hljs-string">"up"</span></span> vlans_eth2=<span class="hljs-string"><span class="hljs-string">"vlan666 vlan777 vlan888"</span></span> create_args_vlan666=<span class="hljs-string"><span class="hljs-string">"vlan 666"</span></span> create_args_vlan777=<span class="hljs-string"><span class="hljs-string">"vlan 777"</span></span> create_args_vlan888=<span class="hljs-string"><span class="hljs-string">"vlan 888"</span></span> ifconfig_vlan666=<span class="hljs-string"><span class="hljs-string">"inet 192.168.0.1/24"</span></span> ifconfig_vlan666_alias0=<span class="hljs-string"><span class="hljs-string">"vhid 1 advskew 100 pass MyPassword alias 192.168.0.5/32"</span></span> ifconfig_vlan777=<span class="hljs-string"><span class="hljs-string">"inet 192.168.1.1/24"</span></span> ifconfig_vlan777_alias0=<span class="hljs-string"><span class="hljs-string">"vhid 1 advskew 100 pass MyPassword alias 192.168.1.5/32"</span></span> ifconfig_vlan888=<span class="hljs-string"><span class="hljs-string">"inet 192.168.2.1/24"</span></span> ifconfig_vlan888_alias0=<span class="hljs-string"><span class="hljs-string">"vhid 1 advskew 100 pass MyPassword alias 192.168.2.5/32"</span></span> ifconfig_vlan111=<span class="hljs-string"><span class="hljs-string">"inet 192.168.3.1/30"</span></span> ifconfig_vlan111_alias0=<span class="hljs-string"><span class="hljs-string">"vhid 1 advskew 100 pass MyPassword alias 1.1.1.2/24"</span></span> ifconfig_vlan222=<span class="hljs-string"><span class="hljs-string">"inet 192.168.4.1/30"</span></span> ifconfig_vlan333=<span class="hljs-string"><span class="hljs-string">"inet 192.168.5.1/30"</span></span> ifconfig_vlan333_alias0=<span class="hljs-string"><span class="hljs-string">"vhid 1 advskew 100 pass MyPassword alias 2.2.2.2/30"</span></span> ifconfig_vlan444=<span class="hljs-string"><span class="hljs-string">"inet 192.168.6.1/30"</span></span> ifconfig_vlan444_alias0=<span class="hljs-string"><span class="hljs-string">"vhid 1 advskew 100 pass MyPassword alias 3.3.3.2/30"</span></span> ifconfig_vlan555=<span class="hljs-string"><span class="hljs-string">"inet 192.168.7.1/30"</span></span> defaultrouter=<span class="hljs-string"><span class="hljs-string">"1.1.1.1"</span></span> setfib1_enable=<span class="hljs-string"><span class="hljs-string">"YES"</span></span> setfib1_defaultrouter=<span class="hljs-string"><span class="hljs-string">"3.3.3.1"</span></span> setfib2_enable=<span class="hljs-string"><span class="hljs-string">"YES"</span></span> setfib2_defaultrouter=<span class="hljs-string"><span class="hljs-string">"2.2.2.1"</span></span> zfs_enable=<span class="hljs-string"><span class="hljs-string">"YES"</span></span> named_enable=<span class="hljs-string"><span class="hljs-string">"YES"</span></span> dhcpd_enable=<span class="hljs-string"><span class="hljs-string">"YES"</span></span> firewall_enable=<span class="hljs-string"><span class="hljs-string">"YES"</span></span> firewall_logging=<span class="hljs-string"><span class="hljs-string">"YES"</span></span> firewall_script=<span class="hljs-string"><span class="hljs-string">"/etc/firewall.sh"</span></span> gateway_enable=<span class="hljs-string"><span class="hljs-string">"YES"</span></span> tofoin_enable=<span class="hljs-string"><span class="hljs-string">"YES"</span></span></code> </pre> <br>  <i>Leyenda:</i> <i><br></i>  <i>eth0, eth1, eth2 - adaptadores f√≠sicos</i> <i><br></i>  <i>vlan666, vlan777, vlan888 - adaptadores de LAN virtuales,</i> <i><br></i>  <i>vlan222 y vlan555: adaptadores para la comunicaci√≥n redundante entre tarjetas de red externas (puede que ya no sean necesarias, se utilizaron activamente antes)</i> <i><br></i>  <i>vlan111 - el canal externo principal</i> <i><br></i>  <i>vlan444 - canal externo de respaldo</i> <i><br></i>  <i>vlan333 - telefon√≠a</i> <br>  Configuraci√≥n /etc/rc.conf en la segunda m√°quina (la configuraci√≥n CARP es de gran inter√©s, se eliminan algunas de las l√≠neas duplicadas): <br><pre> <code class="bash hljs">ifconfig_vlan666=<span class="hljs-string"><span class="hljs-string">"inet 192.168.0.2/24"</span></span> ifconfig_vlan666_alias0=<span class="hljs-string"><span class="hljs-string">"vhid 1 advskew 0 pass MyPassword alias 192.168.0.5/32"</span></span> ifconfig_vlan777=<span class="hljs-string"><span class="hljs-string">"inet 192.168.1.2/24"</span></span> ifconfig_vlan777_alias0=<span class="hljs-string"><span class="hljs-string">"vhid 1 advskew 0 pass MyPassword alias 192.168.1.5/32"</span></span> ifconfig_vlan888=<span class="hljs-string"><span class="hljs-string">"inet 192.168.2.2/24"</span></span> ifconfig_vlan888_alias0=<span class="hljs-string"><span class="hljs-string">"vhid 1 advskew 0 pass MyPassword alias 192.168.2.5/32"</span></span> ifconfig_vlan111=<span class="hljs-string"><span class="hljs-string">"inet 192.168.3.2/30"</span></span> ifconfig_vlan111_alias0=<span class="hljs-string"><span class="hljs-string">"vhid 1 advskew 0 pass MyPassword alias 1.1.1.2/24"</span></span> ifconfig_vlan222=<span class="hljs-string"><span class="hljs-string">"inet 192.168.4.2/30"</span></span> ifconfig_vlan333=<span class="hljs-string"><span class="hljs-string">"inet 192.168.5.2/30"</span></span> ifconfig_vlan333_alias0=<span class="hljs-string"><span class="hljs-string">"vhid 1 advskew 0 pass MyPassword alias 2.2.2.2/30"</span></span> ifconfig_vlan444=<span class="hljs-string"><span class="hljs-string">"inet 192.168.6.2/30"</span></span> ifconfig_vlan444_alias0=<span class="hljs-string"><span class="hljs-string">"vhid 1 advskew 0 pass MyPassword alias 3.3.3.2/30"</span></span> ifconfig_vlan555=<span class="hljs-string"><span class="hljs-string">"inet 192.168.7.2/30"</span></span> defaultrouter=<span class="hljs-string"><span class="hljs-string">"1.1.1.1"</span></span> setfib1_enable=<span class="hljs-string"><span class="hljs-string">"YES"</span></span> setfib1_defaultrouter=<span class="hljs-string"><span class="hljs-string">"3.3.3.1"</span></span> setfib2_enable=<span class="hljs-string"><span class="hljs-string">"YES"</span></span> setfib2_defaultrouter=<span class="hljs-string"><span class="hljs-string">"2.2.2.1"</span></span></code> </pre> <br>  Algunas reglas que resultan √∫tiles al configurar ipfw (nat) son: <br>  Para permitir el tr√°fico de CARP: <br><pre> <code class="bash hljs">/sbin/ipfw -q add allow carp from any to any</code> </pre> <br>  Nat "nuclear": <br><pre> <code class="bash hljs">/sbin/ipfw -q nat 1 config <span class="hljs-built_in"><span class="hljs-built_in">log</span></span> ip vlan111 reset same_ports deny_in unreg_only /sbin/ipfw -q add nat 1 ip from any to any <span class="hljs-keyword"><span class="hljs-keyword">in</span></span></code> </pre> <br>  Uso de tablas de enrutamiento espec√≠ficas con adaptadores espec√≠ficos: <br><pre> <code class="bash hljs">/sbin/ipfw -q add setfib 0 all from any to any via vlan666</code> </pre> <br>  En general, podr√≠a escribir un art√≠culo separado sobre la configuraci√≥n de ipfw que utilic√©, pero este es otro momento. <br></div></div><br><h4>  Software de terceros </h4><br><div class="spoiler">  <b class="spoiler_title">M√°s detalles</b> <div class="spoiler_text">  Dado que existe la necesidad de trabajar simult√°neamente con dos o m√°s canales externos, para esto es conveniente tener varias tablas de enrutamiento, una para cada canal.  Y ser√≠a bueno si estas tablas se crearan en el inicio.  El script rc.d setfib te ayudar√°.  La l√≥gica utilizada en ToFoIn supone que el nombre del archivo (setfib1, setfib2, etc.) coincide con el n√∫mero de la tabla en la que un solo script agrega una ruta predeterminada.  La tabla por defecto tiene el n√∫mero "0". <br>  Los servidores DNS con Bind en el rol principal funcionan en modo secundario, el principal es samba4 + bind, oculto en la red local.  La configuraci√≥n del enlace secundario se revela maravillosamente en el libro de Cricket Lee y Paul Albitz "DNS and BIND".  No recuerdo ning√∫n requisito especial que tenga en cuenta el uso de samba4 para servidores secundarios, y no los menciono en el archivo de configuraci√≥n.  A menos que, para diferentes canales de Internet, es posible que deba crear 2 archivos diferentes, que luego ser√°n copiados por el script ToFoIn en el lugar desde el cual se leer√° el enlace.  Esto se debe al hecho de que al especificar las direcciones de los servidores DNS de ambos proveedores en el mismo archivo, teniendo en cuenta que bind funciona con una sola tabla de enrutamiento, surge un problema con respecto a la resoluci√≥n de direcciones de servidores ascendentes que son inaccesibles en un momento determinado. <br>  Failover isc-dhcpd.  Dhcpd no es esencial para ToFoIn, adem√°s, su ausencia no afectar√° a los scripts en absoluto, sin embargo, como me parece, es bastante l√≥gico colocar servidores dhcp en las puertas de enlace y luego surge la pregunta de conmutaci√≥n por error.  Y aqu√≠, en comparaci√≥n con la √∫ltima vez, se volvi√≥ m√°s interesante ... Adem√°s de la configuraci√≥n necesaria para la conmutaci√≥n por error, que describ√≠ la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">√∫ltima vez</a> (el comienzo de la secci√≥n "preestablecida" dentro del men√∫ desplegable). <br>  Tambi√©n necesitar√° un script para actualizar de manera segura los registros dns en AD usando samba4.  El servidor samba4 en s√≠ solo debe instalarse.  La configuraci√≥n y el lanzamiento no son obligatorios, solo estamos interesados ‚Äã‚Äãen las herramientas de administraci√≥n que vienen con el kit.  Aquellos que lo deseen pueden encontrar otra informaci√≥n en la secci√≥n "DHCP con actualizaciones din√°micas de DNS" <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">en</a> . <br>  Parece aterrador, pero funciona. <br>  En esto con la configuraci√≥n del software de terceros ha terminado. <br></div></div><br><h4>  Un poco sobre ToFoIn </h4><br>  Todo el texto del proyecto junto con el script de instalaci√≥n est√° disponible en <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">gitlab</a> . <br><br><div class="spoiler">  <b class="spoiler_title">En conclusi√≥n, se considera un ejemplo de par√°metros del archivo de configuraci√≥n ToFoIn:</b> <div class="spoiler_text">  El n√∫mero de enrutadores utilizados en el sistema: <br><pre> <code class="bash hljs">RNUMBER=2</code> </pre> <br>  Cuando use subredes adicionales, debe establecer una ruta predeterminada cuando el enrutador se convierta en el primario.  Aqu√≠ puede especificar el n√∫mero del archivo setfib correspondiente que se reiniciar√°.  En este ejemplo, setfib2: <br><pre> <code class="bash hljs">ADDITLAN=2</code> </pre> <br>  Nombre del adaptador interno: <br><pre> <code class="bash hljs">INT_IF=vlan666</code> </pre> <br>  Todas las dem√°s interfaces en las que los enrutadores est√°n conectados a trav√©s de CARP.  Necesario para controlar y mantener el mismo estado de todas las interfaces: <br><pre> <code class="bash hljs">ALL_IF=<span class="hljs-string"><span class="hljs-string">"vlan111 vlan333 vlan444 vlan666 vlan777 vlan888"</span></span></code> </pre> <br>  vhid que se us√≥ al configurar CARP: <br><pre> <code class="bash hljs">CARP_VHID=1</code> </pre> <br>  Las direcciones IP en la red interna de otros enrutadores en orden de importancia, si es necesario, entonces simplemente se usan ASERV_IP_2, ASERV_IP_3, etc. <br><pre> <code class="bash hljs">ASERV_IP_1=192.168.0.2</code> </pre> <br>  N√∫mero de canales de conexi√≥n externos: <br><pre> <code class="bash hljs">CNUMBER=2</code> </pre> <br>  Configuraciones para el canal de conexi√≥n externo principal: <br>  Nombre del adaptador: <br><pre> <code class="bash hljs">EXT_0_IF=vlan111</code> </pre> <br>  N√∫mero de tabla de enrutamiento: <br><pre> <code class="bash hljs">RTABLE_0=0</code> </pre> <br>  Puerta de enlace predeterminada: <br><pre> <code class="bash hljs">DEFAULT_GATEWAY=2.2.2.1</code> </pre> <br>  Configuraciones para el canal de conexi√≥n externa de respaldo: <br>  Nombre del adaptador: <br><pre> <code class="bash hljs">EXT_1_IF=vlan444</code> </pre> <br>  N√∫mero de tabla de enrutamiento: <br><pre> <code class="bash hljs">RTABLE_1=1</code> </pre> <br>  No se requiere una puerta de enlace predeterminada, porque para todas las tablas de enrutamiento, excepto la principal, se usa el script rc.d setfib &lt;n√∫mero de tabla&gt; que, como asume la l√≥gica, debe coincidir con el n√∫mero de la tabla. <br>  Par√°metros del m√≥dulo de prueba: <br>  El n√∫mero de direcciones a verificar: <br><pre> <code class="bash hljs">TNUMBER=2</code> </pre> <br>  Direcciones de las m√°quinas por las cuales se env√≠an las solicitudes de ping.  Es mejor usar el nombre de dominio en el primer caso, y solo despu√©s de eso la direcci√≥n IP: <br><pre> <code class="bash hljs">PTARGET_0=ya.ru PTARGET_1=8.8.8.8</code> </pre> <br>  El n√∫mero de paquetes de ping enviados por destino: <br><pre> <code class="bash hljs">PNUMBER=2</code> </pre> <br>  Configuraci√≥n del m√≥dulo de jueces <br>  El n√∫mero de pruebas exitosas del canal principal antes de volver a √©l.  El tiempo de retorno al canal principal despu√©s de la reanudaci√≥n de su funcionamiento se calcula aproximadamente mediante la f√≥rmula: (WNUMBER + 1) * JUDGEPERIOD segundos. <br><pre> <code class="bash hljs">WNUMBER=3</code> </pre> <br>  Configuraci√≥n del m√≥dulo de registrador <br>  Estos 2 par√°metros indican con qu√© frecuencia el registrador registrar√° eventos recurrentes.  Despu√©s de grabar el evento, la pr√≥xima vez que se informe el n√∫mero de intentos de LOGFREQ1, entonces LOGFREQ2 es el n√∫mero de intentos.  Solo se tienen en cuenta los eventos seguidos. <br><pre> <code class="bash hljs">LOGFREQ1=5 LOGFREQ2=20</code> </pre> <br>  Temporizadores de inicio del m√≥dulo en segundos <br>  El per√≠odo de lanzamiento del m√≥dulo Tester.  Tiene sentido confiar en el tiempo de intentos fallidos de probar todos los objetivos. <br><pre> <code class="bash hljs">TESTERPERIOD=240</code> </pre> <br>  El per√≠odo de lanzamiento del m√≥dulo Juez.  No instale menos de TESTERPERIOD. <br><pre> <code class="bash hljs">JUDGEPERIOD=300</code> </pre> <br>  El per√≠odo de lanzamiento del m√≥dulo Scout. <br><pre> <code class="bash hljs">SCOUTPERIOD=360</code> </pre> <br>  El per√≠odo de espera antes de verificar los temporizadores de inicio de los m√≥dulos Tester y Judge.  Es l√≥gico establecer menos o igual que el valor de TESTERPERIOD. <br><pre> <code class="bash hljs">SENSITIVITY=60</code> </pre> <br>  El tiempo despu√©s del cual un m√≥dulo de trabajo se considera colgado.  Utilizado por el m√≥dulo Watchdog. <br><pre> <code class="bash hljs">TESTERLIMIT=40 JUDGELIMIT=30 LOGGERLIMIT=20 SCOUTLIMIT=120 WATCHDOGLIMIT=150</code> </pre> <br>  Rutas a archivos y directorios <br>  Ruta al script ipfw. <br><pre> <code class="bash hljs">FIRESCRIPT=/etc/firewall.sh</code> </pre> <br>  Configuraci√≥n de ipfw.  Si la configuraci√≥n de ipfw no se mueve a un archivo separado, FIRESCRIPT = FIRESETDEF. <br><pre> <code class="bash hljs">FIRESETDEF=/etc/firewall/config</code> </pre> <br>  Ruta a la configuraci√≥n de ipfw para el canal externo principal: <br><pre> <code class="bash hljs">FIRESET_0=/etc/firewall/config_0</code> </pre> <br>  La ruta a la configuraci√≥n de ipfw para el canal externo de respaldo, si es necesario, puede continuar m√°s FIRESET_2, etc. <br><pre> <code class="bash hljs">FIRESET_1=/etc/firewall/config_1</code> </pre> <br>  Rutas para enlazar configuraciones <br><pre> <code class="bash hljs">BINDSETDEF=/usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/etc/namedb/named.conf</code> </pre> <br>  Configuraci√≥n de enlace para el canal externo principal: <br><pre> <code class="bash hljs">BINDSET_0=/usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/etc/namedb/named.conf.0</code> </pre> <br>  Configuraci√≥n de enlace para el canal externo de respaldo, si es necesario, puede continuar m√°s BINDSET_2, etc. <br><pre> <code class="bash hljs">BINDSET_1=/usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/etc/namedb/named.conf.1</code> </pre> <br>  Rutas a todos los ejecutables de ToFoIn: <br><pre> <code class="bash hljs">DAEMON=/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/sbin/tofoin/daemon.sh TESTER=/usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/sbin/tofoin/tester.sh JUDGE=/usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/sbin/tofoin/judge.sh LOGGER=/usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/sbin/tofoin/logger.sh SCOUT=/usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/sbin/tofoin/scout.sh WATCHDOG=/usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/sbin/tofoin/watchdog.sh</code> </pre> <br>  Registro de eventos  Este archivo NO se crea en la instalaci√≥n ahora: <br><pre> <code class="bash hljs">LOGFILE=/var/<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>/tofoin.log</code> </pre> <br>  Los archivos y directorios temporales se crean cuando se inician los m√≥dulos correspondientes, algunos se eliminan cuando se detienen: <br><pre> <code class="bash hljs">DIR_TMP=/tmp/tofoin DIR_PID=/var/run/tofoin JUDGEMETER=/tmp/tofoin/judgemeter PREVSTATE=/tmp/tofoin/prevstate SCOUTGATE=/tmp/tofoin/scoutgate LOGTMP=/tmp/tofoin/logger.tmp LOGMETER=/tmp/tofoin/logmeter DAEMON_PID=/var/run/tofoin/daemon.pid TESTER_PID=/var/run/tofoin SCOUT_PID=/var/run/tofoin/scout.pid JUDGE_PID=/var/run/tofoin/judge.pid LOGGER_PID=/var/run/tofoin/logger.pid WATCHDOG_PID=/var/run/tofoin_watchdog.pid</code> </pre> <br></div></div><br><h3>  Resumen </h3><br>  Result√≥ ser un conjunto de scripts totalmente funcional y confiable que se adapta bien a la tarea de cambiar al canal de trabajo en el caso de 2 enrutadores con 2 canales de comunicaci√≥n externos. <br><br><h3>  Planes </h3><br>  Mis planes para este proyecto se relacionan, quiz√°s, con la reescritura de bash a pure sh para eliminar el software innecesario en el servidor.  Por otro lado, ahora todo funciona incre√≠blemente y realmente no tengo ganas de interferir en este proceso, adem√°s, cambiar a sh est√° plagado de construcciones de lenguaje m√°s terribles necesarias para lograr el mismo resultado. <br>  Por lo dem√°s, probablemente, valdr√≠a la pena considerar la mejor implementaci√≥n de los m√≥dulos de prueba. <br><br><h3>  Referencias </h3><br>  ‚Üê <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Art√≠culo anterior</a> <br>  ‚Üí <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">P√°gina del proyecto ToFoIn en gitlab</a> <br><div class="spoiler">  <b class="spoiler_title">El resto</b> <div class="spoiler_text">  DNS BIND 9: <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Lee K., Albitz P. - DNS y BIND (5a edici√≥n)</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Servidor DNS BIND</a> <br>  DHCP: <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">DHCP de conmutaci√≥n por error</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">DHCP con actualizaciones din√°micas de DNS</a> <br>  <a href="">samba-dnsupdate</a> <br>  SETFIB: <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">M√∫ltiples rutas predeterminadas en FreeBSD sin BGP o similar</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">setfib y cambiar entre tablas de enrutamiento</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">FreeBSD dos proveedores.</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">setfib</a> <br>  IPFW + NAT: <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Manual detallado de ipfw nat</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">FreeBSD 9 + ipfw + ipfw nat</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Manual detallado de ipfw nat</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Dummynet</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Kernel NAT</a> <br>  BASH: <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Conceptos b√°sicos de BASH.</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Parte 2</a> <br>  <a href="">Gu√≠a avanzada de secuencias de comandos Bash</a> <br></div></div></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/es421857/">https://habr.com/ru/post/es421857/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../es421845/index.html">¬øQu√© hacen realmente los analistas de datos? Hallazgos de 35 entrevistas</a></li>
<li><a href="../es421847/index.html">Salta a la nube. Creaci√≥n de una soluci√≥n de IoT econ√≥mica en NodeMCU + Azure IoT Hub</a></li>
<li><a href="../es421849/index.html">Eventos para RRHH en TI en septiembre de 2018: My Circle Digest</a></li>
<li><a href="../es421851/index.html">Problemas de b√∫ho y globo: conectando dos ensamblajes con espacios de nombres y nombres de clase id√©nticos</a></li>
<li><a href="../es421855/index.html">Proyectores caseros: los mejores "seg√∫n versi√≥n", enfoque ultracorto, campeones en brillo y velocidad</a></li>
<li><a href="../es421859/index.html">Notas del proveedor de IoT. Dispositivos y superados</a></li>
<li><a href="../es421863/index.html">Una nueva forma de crear nanotubos: ahora en color</a></li>
<li><a href="../es421867/index.html">C√≥mo hacer que el c√≥digo sea legible</a></li>
<li><a href="../es421869/index.html">Cree una aplicaci√≥n de Android para la detecci√≥n de rostros en tiempo real con el kit Firebase ML</a></li>
<li><a href="../es421871/index.html">C√≥mo fallar miserablemente de la migraci√≥n de Java a Kotlin en una aplicaci√≥n de Android</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>