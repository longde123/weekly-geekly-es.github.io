<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üëãüèø üë®üèΩ‚Äç‚öïÔ∏è üïâÔ∏è Reaccionar: levantar el estado est√° matando tu aplicaci√≥n üôèüèø üë®üèæ‚Äçü§ù‚Äçüë®üèΩ üìñ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="¬øHas o√≠do hablar de "levantar el estado"? Supongo que s√≠, y esa es la raz√≥n exacta por la que est√°s aqu√≠. ¬øC√≥mo podr√≠a ser posible que uno de los 12 c...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Reaccionar: levantar el estado est√° matando tu aplicaci√≥n</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/471300/"><p><img src="https://habrastorage.org/webt/gd/9i/zn/gd9iznyftdnoffeagz18yy8aqeu.jpeg" alt="Cubierta"></p><br><p>  ¬øHas o√≠do hablar de "levantar el estado"?  Supongo que s√≠, y esa es la raz√≥n exacta por la que est√°s aqu√≠.  ¬øC√≥mo podr√≠a ser posible que <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">uno de los 12 conceptos principales enumerados en la documentaci√≥n oficial de React</a> conduzca a un bajo rendimiento?  Dentro de este art√≠culo, consideraremos una situaci√≥n en la que es realmente el caso. </p><a name="habracut"></a><br><h2 id="step-1-lift-it-up">  Paso 1: lev√°ntalo </h2><br><p>  Te sugiero que crees un juego simple de tres en raya.  Para el juego necesitaremos: </p><br><ul><li><p> Alg√∫n estado del juego.  No hay l√≥gica de juego real para saber si ganamos o perdemos.  Solo una simple matriz bidimensional llena de <code>undefined</code> , <code>"x"</code> o <code>"0".</code> </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> size = <span class="hljs-number"><span class="hljs-number">10</span></span> <span class="hljs-comment"><span class="hljs-comment">// Two-dimensional array (size * size) filled with `undefined`. Represents an empty field. const initialField = new Array(size).fill(new Array(size).fill(undefined))</span></span></code> </pre> <br></li><li><p>  Un contenedor principal para alojar el estado de nuestro juego. </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> App = <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> =&gt;</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> [field, setField] = useState(initialField) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"> &lt;div&gt; {field.map((row, rowI</span></span></span><span class="hljs-function">) =&gt;</span></span> ( <span class="xml"><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">div</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> {row.map((cell, cellI) =&gt; ( </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">Cell</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">content</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">{cell}</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">setContent</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">{</span></span></span></span><span class="xml"><span class="hljs-tag"> // </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">Update</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">a</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">single</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">cell</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">of</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">a</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">two-dimensional</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">array</span></span></span></span><span class="xml"><span class="hljs-tag"> // </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">and</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">return</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">a</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">new</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">two</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">dimensional</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">array</span></span></span></span><span class="xml"><span class="hljs-tag"> (</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">newContent</span></span></span></span><span class="xml"><span class="hljs-tag">) =&gt;</span></span></span><span class="xml"> setField([ // Copy rows before our target row ...field.slice(0, rowI), [ // Copy cells before our target cell ...field[rowI].slice(0, cellI), newContent, // Copy cells after our target cell ...field[rowI].slice(cellI + 1), ], // Copy rows after our target row ...field.slice(rowI + 1), ]) } /&gt; ))} </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">div</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> ))} </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">div</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span></span> ) }</code> </pre> <br></li><li><p>  Un componente hijo para mostrar el estado de una sola celda. </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> randomContent = <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> =&gt;</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">Math</span></span>.random() &gt; <span class="hljs-number"><span class="hljs-number">0.5</span></span> ? <span class="hljs-string"><span class="hljs-string">'x'</span></span> : <span class="hljs-string"><span class="hljs-string">'0'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> Cell = <span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">{ content, setContent }</span></span></span><span class="hljs-function">) =&gt;</span></span> ( <span class="xml"><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">div</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">onClick</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">{()</span></span></span></span><span class="xml"><span class="hljs-tag"> =&gt;</span></span></span><span class="xml"> setContent(randomContent())}&gt;{content}</span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">div</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span></span> )</code> </pre> <br></li></ul><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Demo en vivo # 1</a> </p><br><p>  Hasta ahora se ve bien.  Un campo perfectamente reactivo con el que puedes interactuar a la velocidad de la luz :) Aumentemos el tama√±o.  Digamos, a 100. S√≠, es hora de hacer clic en ese enlace de demostraci√≥n y cambiar la variable de <code>size</code> en la parte superior.  ¬øTodav√≠a r√°pido para ti?  Pruebe 200 o use <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">la aceleraci√≥n de la CPU integrada en Chrome</a> .  ¬øVe ahora un retraso significativo entre el momento en que hace clic en una celda y el momento en que cambia su contenido? </p><br><p>  Cambiemos el <code>size</code> a 10 y agreguemos algunos perfiles para investigar la causa. </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> Cell = <span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">{ content, setContent }</span></span></span><span class="hljs-function">) =&gt;</span></span> { <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-string"><span class="hljs-string">'cell rendered'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="xml"><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">div</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">onClick</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">{()</span></span></span></span><span class="xml"><span class="hljs-tag"> =&gt;</span></span></span><span class="xml"> setContent(randomContent())}&gt;{content}</span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">div</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span></span> }</code> </pre> <br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Demo en vivo # 2</a> </p><br><p>  S√≠, eso es todo.  <code>console.log</code> simple ser√≠a suficiente ya que se ejecuta en cada render. </p><br><p>  Entonces, ¬øqu√© vemos?  Seg√∫n el n√∫mero en las declaraciones de "celda representada" (para <code>size</code> = N deber√≠a ser N) en nuestra consola, parece que todo el campo se vuelve a representar cada vez que cambia una celda. </p><br><p>  Lo m√°s obvio es agregar algunas claves como <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">sugiere la documentaci√≥n de React</a> . </p><br><pre> <code class="javascript hljs">&lt;div&gt; {field.map(<span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">row, rowI</span></span></span><span class="hljs-function">) =&gt;</span></span> ( <span class="xml"><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">div</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">key</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">{rowI}</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> {row.map((cell, cellI) =&gt; ( </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">Cell</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">key</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">{</span></span></span></span><span class="xml"><span class="hljs-tag">`</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">row</span></span></span></span><span class="xml"><span class="hljs-tag">${</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">rowI</span></span></span></span><span class="xml"><span class="hljs-tag">}</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">cell</span></span></span></span><span class="xml"><span class="hljs-tag">${</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">cellI</span></span></span></span><span class="xml"><span class="hljs-tag">}`} </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">content</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">{cell}</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">setContent</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">{(newContent)</span></span></span></span><span class="xml"><span class="hljs-tag"> =&gt;</span></span></span><span class="xml"> setField([ ...field.slice(0, rowI), [ ...field[rowI].slice(0, cellI), newContent, ...field[rowI].slice(cellI + 1), ], ...field.slice(rowI + 1), ]) } /&gt; ))} </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">div</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> ))} </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">div</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span></span></code> </pre> <br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Demo en vivo # 3</a> </p><br><p>  Sin embargo, despu√©s de aumentar el <code>size</code> nuevamente, vemos que ese problema todav√≠a est√° ah√≠.  Si tan solo pudi√©ramos ver por qu√© se renderiza cualquier componente ... Afortunadamente, podemos <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">hacerlo</a> con la ayuda de los incre√≠bles <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">React DevTools</a> .  Es capaz de registrar por qu√© se procesan los componentes.  Sin embargo, debe habilitarlo manualmente. </p><br><p><img src="https://habrastorage.org/webt/36/ms/b4/36msb4eskbqe6txnqv5j3phjfda.png" alt="React configuraci√≥n de DevTools"></p><br><p>  Una vez que est√° habilitado, podemos ver que todas las celdas se volvieron a representar porque sus accesorios cambiaron, espec√≠ficamente, <code>setContent</code> prop. </p><br><p><img src="https://habrastorage.org/webt/nv/3o/on/nv3oon4uvu6om8oea4fnnaun8m4.png" alt="Informe de DevTools # 1 de React"></p><br><p>  Cada celda tiene dos accesorios: <code>content</code> y <code>setContent</code> .  Si la celda [0] [0] cambia, el contenido de la celda [0] [1] no cambia.  Por otro lado, <code>setContent</code> captura <code>field</code> , <code>cellI</code> y <code>rowI</code> en su cierre.  <code>cellI</code> y <code>rowI</code> permanecen igual, pero el <code>field</code> cambia con cada cambio de cualquier celda. </p><br><p>  Refactoricemos nuestro c√≥digo y mantengamos <code>setContent</code> igual. </p><br><p>  Para mantener la referencia a <code>setContent</code> igual, debemos deshacernos de los cierres.  Podr√≠amos eliminar el cierre de <code>cellI</code> y <code>rowI</code> haciendo que nuestra <code>Cell</code> pase expl√≠citamente <code>cellI</code> y <code>rowI</code> a <code>setContent</code> .  En cuanto al <code>field</code> , podr√≠amos utilizar una caracter√≠stica ordenada de <code>setState</code> : <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">acepta devoluciones de llamada</a> . </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> [field, setField] = useState(initialField) <span class="hljs-comment"><span class="hljs-comment">// `useCallback` keeps reference to `setCell` the same. const setCell = useCallback( (rowI, cellI, newContent) =&gt; setField((oldField) =&gt; [ ...oldField.slice(0, rowI), [ ...oldField[rowI].slice(0, cellI), newContent, ...oldField[rowI].slice(cellI + 1), ], ...oldField.slice(rowI + 1), ]), [], )</span></span></code> </pre> <br><p>  Lo que hace que la <code>App</code> vea as√≠ </p><br><pre> <code class="javascript hljs">&lt;div&gt; {field.map(<span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">row, rowI</span></span></span><span class="hljs-function">) =&gt;</span></span> ( <span class="xml"><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">div</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">key</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">{rowI}</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> {row.map((cell, cellI) =&gt; ( </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">Cell</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">key</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">{</span></span></span></span><span class="xml"><span class="hljs-tag">`</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">row</span></span></span></span><span class="xml"><span class="hljs-tag">${</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">rowI</span></span></span></span><span class="xml"><span class="hljs-tag">}</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">cell</span></span></span></span><span class="xml"><span class="hljs-tag">${</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">cellI</span></span></span></span><span class="xml"><span class="hljs-tag">}`} </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">content</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">{cell}</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">rowI</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">{rowI}</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">cellI</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">{cellI}</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">setContent</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">{setCell}</span></span></span></span><span class="xml"><span class="hljs-tag"> /&gt;</span></span></span><span class="xml"> ))} </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">div</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> ))} </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">div</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span></span></code> </pre> <br><p>  Ahora <code>Cell</code> tiene que pasar <code>cellI</code> y <code>rowI</code> al <code>setContent</code> . </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> Cell = <span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">{ content, rowI, cellI, setContent }</span></span></span><span class="hljs-function">) =&gt;</span></span> { <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-string"><span class="hljs-string">'cell render'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"> &lt;div onClick={(</span></span></span><span class="hljs-function">) =&gt;</span></span> setContent(rowI, cellI, randomContent())}&gt; {content} &lt;<span class="hljs-regexp"><span class="hljs-regexp">/div&gt; ) }</span></span></code> </pre> <br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Demo en vivo # 4</a> </p><br><p>  Echemos un vistazo al informe DevTools. </p><br><p><img src="https://habrastorage.org/webt/63/i5/po/63i5poiao3t3rt62mr_zubgycjw.png" alt="Informe de DevTools # 2 de React"></p><br><p>  Que?  ¬øPor qu√© diablos dice "los accesorios de los padres cambiaron"?  Entonces, la cosa es que cada vez que se actualiza nuestro campo, la <code>App</code> se vuelve a representar.  Por lo tanto, sus componentes secundarios se vuelven a representar.  Ok  ¬øStackoverflow dice algo √∫til sobre la optimizaci√≥n del rendimiento de React?  Internet sugiere usar <code>shouldComponentUpdate</code> o sus parientes cercanos: <code>PureComponent</code> y <code>memo</code> . </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> Cell = memo(<span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">{ content, rowI, cellI, setContent }</span></span></span><span class="hljs-function">) =&gt;</span></span> { <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-string"><span class="hljs-string">'cell render'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"> &lt;div onClick={(</span></span></span><span class="hljs-function">) =&gt;</span></span> setContent(rowI, cellI, randomContent())}&gt; {content} &lt;<span class="hljs-regexp"><span class="hljs-regexp">/div&gt; ) })</span></span></code> </pre> <br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Demo en vivo # 5</a> </p><br><p>  Yay  Ahora solo se vuelve a representar una celda una vez que cambia su contenido.  Pero espera ... ¬øHubo alguna sorpresa?  Seguimos las mejores pr√°cticas y obtuvimos el resultado esperado. </p><br><p>  Se supon√≠a que una risa malvada estaba aqu√≠.  Como no estoy contigo, por favor, intenta lo m√°s posible imaginarlo.  Siga adelante y aumente el <code>size</code> en la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">demostraci√≥n</a> en <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">vivo # 5</a> .  Esta vez es posible que tenga que ir con un n√∫mero un poco mayor.  Sin embargo, el retraso sigue ah√≠.  ¬øPor qu√©? </p><br><p>  Echemos un vistazo al informe de DebTools nuevamente. </p><br><p><img src="https://habrastorage.org/webt/ls/w8/gs/lsw8gsgvp_bnjvnxjramglhrnng.png" alt="Reaccione el informe de DevTools # 3"></p><br><p>  Solo hay un render de <code>Cell</code> y fue bastante r√°pido, pero tambi√©n hay un render de <code>App</code> , que tom√≥ bastante tiempo.  La cuesti√≥n es que con cada nueva versi√≥n de la <code>App</code> cada <code>Cell</code> tiene que comparar sus nuevos accesorios con sus accesorios anteriores.  Incluso si decide no renderizar (que es precisamente nuestro caso), esa comparaci√≥n todav√≠a lleva tiempo.  O (1), pero ese O (1) ocurre <code>size</code> * <code>size</code> veces! </p><br><h2 id="step-2-move-it-down">  Paso 2: mu√©velo hacia abajo </h2><br><p>  ¬øQu√© podemos hacer para solucionarlo?  Si renderizar la <code>App</code> nos cuesta demasiado, tenemos que dejar de renderizar la <code>App</code> .  No es posible si sigue alojando nuestro estado en la <code>App</code> usando <code>useState</code> , porque eso es exactamente lo que desencadena los renders.  Entonces tenemos que mover nuestro estado hacia abajo y dejar que cada <code>Cell</code> suscriba al estado por s√≠ solo. </p><br><p>  Creemos una clase dedicada que ser√° un contenedor para nuestro estado. </p><br><pre> <code class="javascript hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Field</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">constructor</span></span>(fieldSize) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.size = fieldSize <span class="hljs-comment"><span class="hljs-comment">// Copy-paste from `initialState` this.data = new Array(this.size).fill(new Array(this.size).fill(undefined)) } cellContent(rowI, cellI) { return this.data[rowI][cellI] } // Copy-paste from old `setCell` setCell(rowI, cellI, newContent) { console.log('setCell') this.data = [ ...this.data.slice(0, rowI), [ ...this.data[rowI].slice(0, cellI), newContent, ...this.data[rowI].slice(cellI + 1), ], ...this.data.slice(rowI + 1), ] } map(cb) { return this.data.map(cb) } } const field = new Field(size)</span></span></code> </pre> <br><p>  Entonces nuestra <code>App</code> podr√≠a verse as√≠: </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> App = <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> =&gt;</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"> &lt;div&gt; {</span></span><span class="hljs-regexp"><span class="hljs-function"><span class="hljs-params"><span class="hljs-regexp">//</span></span></span></span><span class="hljs-function"><span class="hljs-params"> As you can see we still need to iterate over our state to get indexes. field.map((row, rowI</span></span></span><span class="hljs-function">) =&gt;</span></span> ( <span class="xml"><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">div</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">key</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">{rowI}</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> {row.map((cell, cellI) =&gt; ( </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">Cell</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">key</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">{</span></span></span></span><span class="xml"><span class="hljs-tag">`</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">row</span></span></span></span><span class="xml"><span class="hljs-tag">${</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">rowI</span></span></span></span><span class="xml"><span class="hljs-tag">}</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">cell</span></span></span></span><span class="xml"><span class="hljs-tag">${</span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">cellI</span></span></span></span><span class="xml"><span class="hljs-tag">}`} </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">rowI</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">{rowI}</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">cellI</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">{cellI}</span></span></span></span><span class="xml"><span class="hljs-tag"> /&gt;</span></span></span><span class="xml"> ))} </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">div</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> ))} </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">div</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span></span> ) }</code> </pre> <br><p>  Y nuestra <code>Cell</code> puede mostrar el contenido del <code>field</code> por s√≠ solo: </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> Cell = <span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">{ rowI, cellI }</span></span></span><span class="hljs-function">) =&gt;</span></span> { <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-string"><span class="hljs-string">'cell render'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> content = field.cellContent(rowI, cellI) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"> &lt;div onClick={(</span></span></span><span class="hljs-function">) =&gt;</span></span> field.setCell(rowI, cellI, randomContent())}&gt; {content} &lt;<span class="hljs-regexp"><span class="hljs-regexp">/div&gt; ) }</span></span></code> </pre> <br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Demo en vivo # 6</a> </p><br><p>  En este punto, podemos ver c√≥mo se representa nuestro campo.  Sin embargo, si hacemos clic en una celda, no pasa nada.  En los registros podemos ver "setCell" para cada clic, pero la celda permanece en blanco.  La raz√≥n aqu√≠ es que nada le dice a la celda que vuelva a renderizar.  Nuestro estado fuera de React cambia, pero React no lo sabe.  Eso tiene que cambiar. </p><br><p>  ¬øC√≥mo podemos activar un renderizado mediante programaci√≥n? </p><br><p>  Con las clases tenemos <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">forceUpdate</a> .  ¬øSignifica que tenemos que volver a escribir nuestro c√≥digo en las clases?  En realidad no  Lo que podemos hacer con los componentes funcionales es introducir un estado ficticio, que cambiamos solo para obligar a nuestro componente a volver a renderizar. </p><br><p>  As√≠ es como podemos crear un enlace personalizado para forzar los renders. </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> useForceRender = <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> =&gt;</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> [, setDummy] = useState(<span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> forceRender = useCallback(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> =&gt;</span></span> setDummy(<span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">oldVal</span></span></span><span class="hljs-function">) =&gt;</span></span> oldVal + <span class="hljs-number"><span class="hljs-number">1</span></span>), []) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> forceRender }</code> </pre> <br><p>  Para activar una nueva representaci√≥n cuando nuestro campo se actualiza, tenemos que saber cu√°ndo se actualiza.  Significa que tenemos que poder suscribirnos de alguna manera a las actualizaciones de campo. </p><br><pre> <code class="javascript hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Field</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">constructor</span></span>(fieldSize) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.size = fieldSize <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.data = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Array</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.size).fill(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Array</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.size).fill(<span class="hljs-literal"><span class="hljs-literal">undefined</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.subscribers = {} } _cellSubscriberId(rowI, cellI) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">`row</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${rowI}</span></span></span><span class="hljs-string">cell</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${cellI}</span></span></span><span class="hljs-string">`</span></span> } cellContent(rowI, cellI) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.data[rowI][cellI] } setCell(rowI, cellI, newContent) { <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-string"><span class="hljs-string">'setCell'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.data = [ ...this.data.slice(<span class="hljs-number"><span class="hljs-number">0</span></span>, rowI), [ ...this.data[rowI].slice(<span class="hljs-number"><span class="hljs-number">0</span></span>, cellI), newContent, ...this.data[rowI].slice(cellI + <span class="hljs-number"><span class="hljs-number">1</span></span>), ], ...this.data.slice(rowI + <span class="hljs-number"><span class="hljs-number">1</span></span>), ] <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> cellSubscriber = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.subscribers[<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>._cellSubscriberId(rowI, cellI)] <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (cellSubscriber) { cellSubscriber() } } map(cb) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.data.map(cb) } <span class="hljs-comment"><span class="hljs-comment">// Note that we subscribe not to updates of the whole filed, but to updates of one cell only subscribeCellUpdates(rowI, cellI, onSetCellCallback) { this.subscribers[this._cellSubscriberId(rowI, cellI)] = onSetCellCallback } }</span></span></code> </pre> <br><p>  Ahora podemos suscribirnos a las actualizaciones de campo. </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> Cell = <span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">{ rowI, cellI }</span></span></span><span class="hljs-function">) =&gt;</span></span> { <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-string"><span class="hljs-string">'cell render'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> forceRender = useForceRender() useEffect(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> =&gt;</span></span> field.subscribeCellUpdates(rowI, cellI, forceRender), [ forceRender, ]) <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> content = field.cellContent(rowI, cellI) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"> &lt;div onClick={(</span></span></span><span class="hljs-function">) =&gt;</span></span> field.setCell(rowI, cellI, randomContent())}&gt; {content} &lt;<span class="hljs-regexp"><span class="hljs-regexp">/div&gt; ) }</span></span></code> </pre> <br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Demo en vivo # 7</a> </p><br><p>  Juguemos con el <code>size</code> con esta implementaci√≥n.  Intente aumentarlo a los valores que antes se sent√≠an rezagados.  Y ... ¬°es hora de abrir una buena botella de champ√°n!  ¬°Tenemos una aplicaci√≥n que representa una celda y una celda solo cuando cambia el estado de esa celda! </p><br><p>  Echemos un vistazo al informe DevTools. </p><br><p><img src="https://habrastorage.org/webt/qm/yw/3y/qmyw3yetdbimipruhngx5pa_chu.png" alt="Reaccionar el informe de DevTools # 4"></p><br><p>  Como podemos ver ahora, solo se est√° procesando <code>Cell</code> y es una locura r√°pida. </p><br><p>  ¬øQu√© pasa si digo que ahora el c√≥digo de nuestra <code>Cell</code> es una posible causa de una p√©rdida de memoria?  Como puede ver, en <code>useEffect</code> nos suscribimos a las actualizaciones de la celda, pero nunca nos damos de baja.  Significa que incluso cuando <code>Cell</code> se destruye, su suscripci√≥n contin√∫a.  Cambiemos eso. </p><br><p>  Primero, debemos ense√±arle a <code>Field</code> lo que significa darse de baja. </p><br><pre> <code class="javascript hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Field</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">// ... unsubscribeCellUpdates(rowI, cellI) { delete this.subscribers[this._cellSubscriberId(rowI, cellI)] } }</span></span></code> </pre> <br><p>  Ahora podemos aplicar <code>unsubscribeCellUpdates</code> a nuestra <code>Cell</code> . </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> Cell = <span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">{ rowI, cellI }</span></span></span><span class="hljs-function">) =&gt;</span></span> { <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-string"><span class="hljs-string">'cell render'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> forceRender = useForceRender() useEffect(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> =&gt;</span></span> { field.subscribeCellUpdates(rowI, cellI, forceRender) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> =&gt;</span></span> field.unsubscribeCellUpdates(rowI, cellI) }, [forceRender]) <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> content = field.cellContent(rowI, cellI) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"> &lt;div onClick={(</span></span></span><span class="hljs-function">) =&gt;</span></span> field.setCell(rowI, cellI, randomContent())}&gt; {content} &lt;<span class="hljs-regexp"><span class="hljs-regexp">/div&gt; ) }</span></span></code> </pre> <br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Demo en vivo # 8</a> </p><br><p>  Entonces, ¬øcu√°l es la lecci√≥n aqu√≠?  ¬øCu√°ndo tiene sentido mover el estado hacia abajo del √°rbol de componentes?  Nunca!  Bueno, en realidad no :) Ap√©guese a las mejores pr√°cticas hasta que fallen y no realice optimizaciones prematuras.  Honestamente, el caso que consideramos anteriormente es algo espec√≠fico, sin embargo, espero que lo recuerde si alguna vez necesita mostrar una lista realmente grande. </p><br><h2 id="bonus-step-real-world-refactoring">  Paso adicional: refactorizaci√≥n del mundo real </h2><br><p>  En la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">demostraci√≥n en vivo # 8</a> utilizamos el <code>field</code> global, que no deber√≠a ser el caso en una aplicaci√≥n del mundo real.  Para resolverlo, podr√≠amos alojar el <code>field</code> en nuestra <code>App</code> y pasarlo por el √°rbol usando [context] (). </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> AppContext = createContext() <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> App = <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> =&gt;</span></span> { <span class="hljs-comment"><span class="hljs-comment">// Note how we used a factory to initialize our state here. // Field creation could be quite expensive for big fields. // So we don't want to create it each time we render and block the event loop. const [field] = useState(() =&gt; new Field(size)) return ( &lt;AppContext.Provider value={field}&gt; &lt;div&gt; {field.map((row, rowI) =&gt; ( &lt;div key={rowI}&gt; {row.map((cell, cellI) =&gt; ( &lt;Cell key={`row${rowI}cell${cellI}`} rowI={rowI} cellI={cellI} /&gt; ))} &lt;/div&gt; ))} &lt;/div&gt; &lt;/AppContext.Provider&gt; ) }</span></span></code> </pre> <br><p>  Ahora podemos consumir el <code>field</code> del contexto en nuestra <code>Cell</code> . </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> Cell = <span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">{ rowI, cellI }</span></span></span><span class="hljs-function">) =&gt;</span></span> { <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-string"><span class="hljs-string">'cell render'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> forceRender = useForceRender() <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> field = useContext(AppContext) useEffect(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> =&gt;</span></span> { field.subscribeCellUpdates(rowI, cellI, forceRender) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> =&gt;</span></span> field.unsubscribeCellUpdates(rowI, cellI) }, [forceRender]) <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> content = field.cellContent(rowI, cellI) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"> &lt;div onClick={(</span></span></span><span class="hljs-function">) =&gt;</span></span> field.setCell(rowI, cellI, randomContent())}&gt; {content} &lt;<span class="hljs-regexp"><span class="hljs-regexp">/div&gt; ) }</span></span></code> </pre> <br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Demo en vivo # 9</a> </p><br><p>  Con suerte, has encontrado algo √∫til para tu proyecto.  ¬°No dudes en comunicarme tus comentarios!  Aprecio mucho cualquier cr√≠tica y pregunta. </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/471300/">https://habr.com/ru/post/471300/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../471282/index.html">Buscando neumon√≠a en rayos X con Fast.ai</a></li>
<li><a href="../471288/index.html">Creando la cara de un personaje para el juego "OnAir"</a></li>
<li><a href="../471294/index.html">Poemas sobre Haskell, C ++ y programadores.</a></li>
<li><a href="../471296/index.html">Lean Manufacturing: una herramienta para la eficiencia</a></li>
<li><a href="../471298/index.html">Bieber y Bilan agitan un bol√≠grafo. AI ahora est√° cantando canciones</a></li>
<li><a href="../471302/index.html">Verificaci√≥n de usuario en China y cr√©dito social</a></li>
<li><a href="../471304/index.html">Empire ERP. Contabilidad entretenida: libro mayor, cuentas, saldo</a></li>
<li><a href="../471306/index.html">Desarrollo del complemento VPN Continent-AP para el sistema operativo Sailfish</a></li>
<li><a href="../471310/index.html">Mi opini√≥n muy subjetiva sobre la educaci√≥n profesional y no solo en TI</a></li>
<li><a href="../471312/index.html">Preparaci√≥n para la certificaci√≥n profesional de primavera. Bota de primavera</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>