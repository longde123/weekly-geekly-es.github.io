<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👢 💸 🤭 Penulisan OS: Multitasking 🚂 🔆 🏼</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Selamat siang, pembaca yang budiman, kemungkinan besar, Anda melihat artikel saya sebelumnya bahwa Anda sendiri dapat menulis OS yang bisa dikerjakan ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Penulisan OS: Multitasking</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/426807/"><img src="https://habrastorage.org/webt/dh/hl/fa/dhhlfalcgjm7ig8emfavk3uoji8.png" alt="gambar"><br>  Selamat siang, pembaca yang budiman, kemungkinan besar, Anda melihat artikel saya sebelumnya bahwa Anda sendiri dapat menulis OS yang bisa dikerjakan dalam waktu yang cukup singkat.  Nah, hari ini kita akan berbicara tentang implementasi multitasking di OS saya. <a name="habracut"></a><br><br>  Yah, Anda mungkin tidak dapat membayangkan OS satu-tugas pada tahun 2018, jadi saya memutuskan untuk berbicara tentang implementasi multitasking di OS saya.  Jadi, hal pertama - Anda perlu memutuskan jenis multitasking, saya memilih preemptive. <br>  Seperti apa dia?  Preemptive multitasking adalah sistem untuk mendistribusikan daya komputasi prosesor antar proses: masing-masing memiliki kuantum waktu sendiri, masing-masing memiliki prioritas sendiri.  Dan masalah pertama adalah panjang kuantum mana yang harus dipilih, bagaimana cara menghentikan proses agar tidak berjalan setelah kuantum berakhir?  Bahkan, semuanya lebih mudah dari sebelumnya!  Kami akan menggunakan PIT dengan frekuensi yang awalnya ditetapkan 10026 dengan uang interupsi per detik, di sana kami memecahkan satu masalah lagi: kami sudah menghentikan proses sebelumnya.  Jadi, mari kita mulai dengan PIT. <br><br><h2>  Lubang </h2><br>  PIT - Timer Interval yang Dapat Diprogram - penghitung yang, setelah mencapai jumlah kenaikan terprogram, memberikan sinyal.  Juga, dengan menggunakan pengatur waktu ini, Anda dapat mencicit alat pencekik di komputer (benda yang mencicit setelah melewati tes perangkat).  Maka, ia menghitung dengan frekuensi 1193182 hertz, yang berarti bahwa kita perlu memprogramnya pada 119 (1193182/119 kira-kira sama dengan 10026).  Untuk melakukan ini, kirim 2 byte ke port generator pertama, pertama byte rendah, lalu tinggi: <br><br><pre><code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">short</span></span> hz = <span class="hljs-number"><span class="hljs-number">119</span></span>; outportb(<span class="hljs-number"><span class="hljs-number">0x43</span></span>, <span class="hljs-number"><span class="hljs-number">0x34</span></span>); outportb(<span class="hljs-number"><span class="hljs-number">0x40</span></span>, (<span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span>)hz &amp; <span class="hljs-number"><span class="hljs-number">0xFF</span></span>); <span class="hljs-comment"><span class="hljs-comment">//Low outportb(0x40, (unsigned char)(hz &gt;&gt; 8) &amp; 0xFF); //Hight, about 10026 times per second</span></span></code> </pre> <br><br>  Sekarang layak memulai pemrograman interupsi dari PIT, ia memiliki IRQ 0, dan setelah remap PIC akan menjadi 0x20m.  Untuk IRQ dari PIC pertama, saya menulis makro ini: <br><br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">//PIC#0; port 0x20 #define IRQ_HANDLER(func) char func = 0x90;\ __asm__(#func ": \npusha \n call __"#func " \n movb $0x20,\ %al \n outb %al, $0x20 \n popa \n iret \n");\ void _## func()</span></span></code> </pre> <br><br><h2>  Struktur dan proses </h2><br>  Jadi, seperti yang Anda pahami, kami perlu mengembangkan struktur untuk setiap proses, serta struktur yang memungkinkan saya mengingat semua alokasi memori saya. <br>  Inilah yang saya miliki: <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">typedef</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> _</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">pralloc</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> * addr; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> _</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">pralloc</span></span></span><span class="hljs-class"> * </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">next</span></span></span><span class="hljs-class">;</span></span> } processAlloc; <span class="hljs-keyword"><span class="hljs-keyword">typedef</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> * entry; processAlloc *allocs; } ELF_Process; <span class="hljs-keyword"><span class="hljs-keyword">typedef</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> __</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">attribute__</span></span></span><span class="hljs-class">((</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">packed</span></span></span><span class="hljs-class">)) _</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">E</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> eax;<span class="hljs-comment"><span class="hljs-comment">//4 unsigned int ebx;//8 unsigned int ecx;//12 unsigned int edx;//16 unsigned int ebp;//20 unsigned int esp;//24 unsigned int esi;//28 unsigned int edi;//32 unsigned int eflags;//36 unsigned int state;//40 void * startAddr;//44 void * currentAddr;//48 void * stack;//52 unsigned int sse[4 * 8];// unsigned int mmx[2 * 8];//244 unsigned int priority;//248 unsigned int priorityL;//252 void * elf_process;//256 char ** argv;//260 unsigned int argc;//264 unsigned int runnedFrom;//268 char * workingDir;//272 unsigned int cs;//276 - pop is 4 byte in IRET unsigned int ds;//280 } Process;</span></span></code> </pre><br><br>  Untuk memulainya, kita perlu memahami hal-hal berikut: kita dapat berada di suatu tempat di alamat global, misalnya, di 0xDEAD menuliskan jumlah proses yang sedang berjalan, kemudian ketika menjalankan kode apa pun, kita dapat yakin: kita memiliki jumlah proses yang sedang berjalan, ini berarti bahwa saat mengakses malloc, kami tahu kepada siapa kami mengalokasikan memori, dan kami dapat segera menambahkan alamat memori yang dialokasikan ke daftar allocs. <br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">addProcessAlloc</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ELF_Process * p, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params"> * addr)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> * z = p-&gt;allocs; p-&gt;allocs = malloc_wo_adding_to_process(<span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(processAlloc)); p-&gt;allocs-&gt;addr = addr; p-&gt;allocs-&gt;next = z; }</code> </pre> <br><br>  Nah, kami menulis struktur tabel dengan deskripsi proses, apa selanjutnya, bagaimana beralih tugas? <br>  Untuk memulainya, saya ingin mencatat bahwa, sebagai contoh, dalam handler, variabel lokal disimpan pada stack, yang berarti bahwa setelah memasukkan handler, kompiler merusak kita esp.  Untuk mencegah hal ini terjadi, buat variabel dengan alamat absolut, dan sebelum memanggil handler, kita akan meletakkan ESP di sana.  Di handler, kita perlu mengirim EOI ke PIC pertama dan menemukan proses yang kita perlu beralih (saya tidak akan menjelaskan mekanisme prioritas: sederhana, seperti kemacetan lalu lintas).  Berikutnya - kita perlu menyimpan semua register dan flag dari proses saat ini, jadi sebelum memasukkan ESP ke dalam variabel, kita akan menyimpan semua register (termasuk yang segment) ke stack.  Dalam handler itu sendiri, kita harus dengan hati-hati menghapusnya dari tumpukan, sembari menjaga bendera dan mengembalikan alamat.  Saya ingin mencatat bahwa tumpukan tumbuh (mis., ESP berkurang), yang berarti bahwa register terakhir yang Anda simpan di tumpukan akan di ESP, yang kedua dari belakang akan menjadi ESP +4, dll .: <br><img src="https://habrastorage.org/webt/jz/ab/8j/jzab8jy-woe0_y1qpngddrl6pfi.png" alt="gambar"><br>  Sekarang tinggal kita untuk meletakkan nilai register proses ke dalam register yang kita gunakan untuk beralih dan menjalankan IRET.  Untung! <br><br><h2>  Proses dimulai </h2><br>  Saat memulai proses, cukup bagi kami untuk mengalokasikan tumpukan untuk proses, dan kemudian meletakkan argc dan argv di dalamnya, alamat fungsi yang akan diberikan kontrol setelah proses selesai.  Anda juga perlu mengatur flag prosesor ke nilai yang Anda butuhkan, misalnya, untuk OS saya 0x216, Anda dapat membaca tentang register flag di Wikipedia. <br><br>  Pada akhirnya saya ingin Anda sukses, segera saya akan menulis tentang bekerja dengan memori dan artikel lain yang menarik bagi Anda. <br>  Semoga beruntung, dan peretasan etis! </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/id426807/">https://habr.com/ru/post/id426807/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../id426793/index.html">DotNext - ada pahlawan lain</a></li>
<li><a href="../id426797/index.html">Neural Network Menggunakan TensorFlow: Klasifikasi Gambar</a></li>
<li><a href="../id426799/index.html">Apakah Anda benar-benar membutuhkan kepercayaan atau izin laravel untuk mengimplementasikan otorisasi Anda?</a></li>
<li><a href="../id426803/index.html">Gambaran Umum Teknik Adaptasi Domain Jauh Dasar (Bagian 1)</a></li>
<li><a href="../id426805/index.html">Peredam kejut, bantalan roda, rem, motor listrik - sumber panas masa depan untuk mobil listrik?</a></li>
<li><a href="../id426809/index.html">Zeev Surasky: Masa Depan Zend Engine dan Zend Framework</a></li>
<li><a href="../id426811/index.html">Parkour, tarian dan pekerjaan konstruksi dari Boston Dynamics</a></li>
<li><a href="../id426813/index.html">? Skype telah menjadi sangat membosankan ... dan produk yang memungkinkan Anda mendapatkan akses penuh ke sistem Anda? Apakah ada harapan?</a></li>
<li><a href="../id426815/index.html">Bagaimana cara mendapatkan hibah pengembangan proyek jika Anda seorang siswa yang miskin? Dan apakah itu sepadan</a></li>
<li><a href="../id426817/index.html">CommuniGate Pro Private Key dan Web API</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>