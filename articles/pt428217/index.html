<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üõÖ üêª üï∫üèº Milh√µes de v√≠deo chamadas por dia ou "Ligue para a m√£e!" üë®üèø‚Äçüåæ üõ∑ üåπ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Do ponto de vista do usu√°rio, os servi√ßos de chamada parecem bem simples: voc√™ acessa a p√°gina para outro usu√°rio, liga, ele pega o telefone, conversa...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Milh√µes de v√≠deo chamadas por dia ou "Ligue para a m√£e!"</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/odnoklassniki/blog/428217/">  Do ponto de vista do usu√°rio, os servi√ßos de chamada parecem bem simples: voc√™ acessa a p√°gina para outro usu√°rio, liga, ele pega o telefone, conversa com ele.  L√° fora, parece que tudo √© simples, mas poucos sabem como fazer esse servi√ßo.  Mas Alexander Tobol ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" class="user_link">alatobol</a> ) n√£o apenas sabe, mas tamb√©m compartilha de bom grado sua experi√™ncia. <br><br><img src="https://habrastorage.org/webt/rq/un/cx/rquncxhtqvyydpdbneoatkwfvke.jpeg"><br><br>  Al√©m disso, a vers√£o em texto do relat√≥rio sobre o HighLoad ++ Siberia, com a qual voc√™ aprender√°: <br><br><ul><li>  como os servi√ßos de videochamada funcionam sob o cap√¥; </li><li>  qu√£o bonito √© romper o NAT - isso ser√° interessante para especialistas em jogos que precisam de uma conex√£o ponto a ponto; </li><li>  como o WebRTC funciona, quais protocolos ele inclui; </li><li>  como posso ajustar o WebRTC atrav√©s do BigData. </li></ul><br><iframe width="560" height="315" src="https://www.youtube.com/embed/MnEXuKHjIOU" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br>  <strong>Sobre o palestrante:</strong> Alexander Tobol lidera o desenvolvimento das plataformas de v√≠deo e fita em ok.ru. <br><a name="habracut"></a><br><h2>  Hist√≥rico de videochamadas <br></h2><br>  O primeiro dispositivo de videochamada apareceu em 1960, era chamado de picherphone, usava redes dedicadas e era extremamente caro.  Em 2006, o Skype adicionou videochamadas √† sua aplica√ß√£o.  Em 2010, o Flash suportou o protocolo RTMFP e, em Odnoklassniki, lan√ßamos videochamadas em Flash.  Em 2016, o Chrome parou de oferecer suporte ao Flash e, em agosto de 2017, reiniciamos as chamadas com a nova tecnologia, sobre a qual falarei hoje.  Ap√≥s finalizar o servi√ßo, por mais seis meses, recebemos um aumento significativo nas chamadas conclu√≠das com sucesso.  Recentemente, tamb√©m temos m√°scaras nas chamadas. <br><img src="https://habrastorage.org/webt/kn/9u/uy/kn9uuyg18yggcfabvmzgs-cfygg.jpeg"><br><br><h2>  Arquitetura e TK <br></h2><br>  Como trabalhamos em uma rede social, n√£o temos tarefas t√©cnicas e n√£o sabemos o que √© TK.  Geralmente, a ideia se encaixa em uma p√°gina e se parece com isso. <br><img src="https://habrastorage.org/webt/qf/9x/ju/qf9xjum4vvjczd3-momvzhht9cw.jpeg"><br><br>  O usu√°rio deseja ligar para outros usu√°rios usando um aplicativo da Web ou iOS / Android.  Outro usu√°rio pode ter v√°rios dispositivos.  A chamada chega a todos os dispositivos, o usu√°rio pega o telefone em um deles e eles conversam.  Tudo √© simples. <br><br><h2>  Especifica√ß√µes t√©cnicas <br></h2><br>  Para fazer um servi√ßo de chamada de qualidade, precisamos entender quais caracter√≠sticas queremos rastrear.  Decidimos come√ßar procurando o que mais incomoda o usu√°rio. <br><br>  O usu√°rio fica definitivamente irritado se ele atender o telefone e for√ßado a esperar at√© que a conex√£o seja estabelecida. <br><img src="https://habrastorage.org/webt/8g/kk/qb/8gkkqbq6ioqxnn0ro6dcq9kwhno.jpeg"><br><br>  O usu√°rio fica irritado se a qualidade da chamada for ruim - algo √© interrompido, o v√≠deo est√° espalhado, o som est√° borbulhando. <br><img src="https://habrastorage.org/webt/2l/rt/ud/2lrtudpp-tw5cjsknhzamgj--pi.jpeg"><br><br>  Mas acima de tudo, o usu√°rio fica irritado com o atraso nas chamadas.  Lat√™ncia √© uma das caracter√≠sticas importantes das chamadas.  Com lat√™ncia em uma conversa da ordem de 5 segundos, √© absolutamente imposs√≠vel conduzir um di√°logo. <br><img src="https://habrastorage.org/webt/z-/tn/lf/z-tnlfghw6laz3j25e3kbwob9mi.jpeg"><br><br>  Determinamos por n√≥s mesmos caracter√≠sticas aceit√°veis: <br><br><ul><li>  <strong>Iniciar</strong> - decidimos que era bom iniciar a chamada em um segundo.  I.e.  conectar ap√≥s a resposta do usu√°rio, n√£o deve demorar mais de 1 segundo. </li><li>  <strong>A qualidade</strong> √© um indicador muito subjetivo.  Voc√™ pode medir, por exemplo, a rela√ß√£o sinal-ru√≠do (SNR), mas ainda faltam quadros e outros artefatos.  Medimos a qualidade de maneira subjetiva e depois avaliamos a felicidade dos usu√°rios. </li><li>  <strong>A lat√™ncia</strong> deve ser menor que 0,5 segundos.  Se a lat√™ncia for superior a 0,5 segundos, voc√™ j√° ouvir√° atrasos e come√ßar√° a se interromper. </li></ul><br><img src="https://habrastorage.org/webt/cl/yx/j0/clyxj0ajsqq5coamt5orttz-kxc.jpeg"><br><br>  Polycom √© um sistema de confer√™ncia instalado em nossos escrit√≥rios.  Temos lat√™ncias m√©dias do polycom da ordem de 1,3 segundos.  Com esse atraso, voc√™ nem sempre se entende.  Se o atraso aumentar para 2 segundos, o di√°logo n√£o ser√° poss√≠vel. <br><img src="https://habrastorage.org/webt/3_/yy/qq/3_yyqqbvvq5zoavfa5q9tzvqhiq.jpeg"><br><br>  Como j√° lan√ßamos a plataforma, esper√°vamos aproximadamente um milh√£o de chamadas por dia.  S√£o mil chamadas em paralelo.  Se todas as chamadas forem iniciadas pelo servidor, haver√° mil megabits por chamada.  Isso √© apenas 1 gigabit / s, um servidor de ferro ser√° suficiente. <br><br><h2>  Internet vs TTX <br></h2><br>  O que pode impedir voc√™ de obter recursos interessantes?  A Internet! <br><img src="https://habrastorage.org/webt/qb/aq/sy/qbaqsyfaf6vln4e882armfugx1g.jpeg"><br><br>  Na Internet, existem coisas como tempo de ida e volta (RTT), que n√£o podem ser superadas, h√° uma largura de banda vari√°vel, h√° NAT. <br><br>  Anteriormente, medimos a velocidade de transmiss√£o nas redes de nossos usu√°rios. <br><img src="https://habrastorage.org/webt/bm/ge/z6/bmgez6efih7z_lqwidcknso8edw.jpeg"><br><br>  N√≥s a dividimos de acordo com o tipo de conex√£o, analisamos o RTT m√©dio, a perda de pacotes, a velocidade e decidimos testar as chamadas nos valores m√©dios de cada uma dessas redes. <br><img src="https://habrastorage.org/webt/ui/o4/k8/uio4k8pmxmyxyclfwwawehqijes.jpeg"><br><br>  Existem outros problemas na Internet: <br><br><ul><li>  <strong>Perda de pacote</strong> - medimos 0,6% de perda aleat√≥ria de pacotes (n√£o consideramos a perda de pacotes de congestionamento com um n√∫mero excessivo de pacotes). </li><li>  <strong>Reordena√ß√£o</strong> - voc√™ envia pacotes na mesma ordem e a rede os ordena novamente. </li><li>  <strong>Tremula√ß√£o</strong> - envie um fluxo de v√≠deo ou √°udio em um determinado intervalo e os pacotes se re√∫nem no lado do cliente em pacotes, por exemplo, devido ao armazenamento em buffer nos dispositivos de rede. </li><li>  <strong>NAT</strong> - descobriu-se que mais de 97% dos usu√°rios est√£o atr√°s do NAT.  Falaremos sobre o porqu√™, o que e como. </li></ul><br><img src="https://habrastorage.org/webt/z_/uo/mc/z_uomck64smc12_beaupdnutgp4.jpeg"><br><br>  Considere as configura√ß√µes de rede listadas acima com um exemplo simples. <br><br>  Procurei no meu escrit√≥rio o site da Universidade Estadual de Novosibirsk e recebi um ping t√£o estranho. <br><img src="https://habrastorage.org/webt/wi/am/at/wiamatloo1eviw58g3zgzbrsc2e.jpeg"><br><br>  A tremula√ß√£o m√©dia neste exemplo √© de 30 ms, ou seja, o intervalo m√©dio entre os tempos de ping adjacentes √© de cerca de 30 ms e o ping m√©dio √© de 105 ms. <br><br>  O que √© importante nas chamadas, por que lutaremos pelo p2p? <br><img src="https://habrastorage.org/webt/gb/ny/yx/gbnyyxij20hrfo96scwubxdzovu.jpeg"><br><br>  Obviamente, se conseguirmos estabelecer uma conex√£o P2P entre nossos usu√°rios que est√£o tentando conversar entre si em S√£o Petersburgo, e n√£o atrav√©s de um servidor localizado em Novosibirsk, economizaremos cerca de 100 ms de ida e volta e tr√°fego para este servi√ßo. <br><br>  Portanto, a maior parte do artigo √© dedicada a como obter boas p2p. <br><br><h2>  Hist√≥ria ou legado <br></h2><br>  Como eu disse, temos um servi√ßo de chamadas desde 2010 e agora o reiniciamos. <br><img src="https://habrastorage.org/webt/si/ru/lu/sirulur_jaalnldpkmvbjx7ct-q.jpeg"><br><br>  Em 2006, quando o Skype come√ßou, o Flash comprou a Amicima, que fabricava a RTMFP.  O Flash j√° possu√≠a RTMP, que em princ√≠pio pode ser usado para chamadas e geralmente √© usado para streaming.  Mais tarde, o Flash abriu a especifica√ß√£o RTMP.  Eu me pergunto por que eles precisavam de RTMFP?  Em 2010, usamos o RTMFP. <br><br>  Compare os requisitos para protocolos de chamada e protocolos de streaming reais e veja onde fica essa borda. <br><img src="https://habrastorage.org/webt/ih/j9/xi/ihj9xiris6praclbyxpxelwc1i4.jpeg"><br><br>  <strong>O RTMP</strong> √© mais um protocolo de streaming de v√≠deo.  Ele usa TCP, possui atraso cumulativo.  Se voc√™ tiver uma boa conex√£o com a Internet, as chamadas para RTMP funcionar√£o. <br><br>  <strong>O protocolo RTMFP</strong> , apesar da diferen√ßa em apenas uma letra, √© o protocolo UDP.  Est√° livre de problemas de buffer - aqueles que est√£o no TCP;  √â privado de bloqueio de linha de frente - √© quando voc√™ perde um pacote e o TCP n√£o retorna os seguintes pacotes at√© que seja hora de enviar o perdido novamente.  O RTMFP conseguiu lidar com o NAT e estava enfrentando uma altera√ß√£o no endere√ßo IP dos clientes.  Portanto, lan√ßamos a web no RTMFP em 2010. <br><img src="https://habrastorage.org/webt/pv/rx/16/pvrx163tvieetirsg8nkfrov7qm.jpeg"><br><br>  S√≥ em 2011 apareceu o rascunho inicial do WebRTC, que ainda n√£o estava totalmente operacional.  Em 2012, come√ßamos a oferecer suporte a chamadas no iOS / Android, e aconteceu outra coisa, e em 2016 o Chrome parou de oferecer suporte ao Flash.  N√≥s tivemos que fazer alguma coisa. <br><img src="https://habrastorage.org/webt/uu/ub/cs/uuubcssxa_w9-ost03_y6dqq6ic.jpeg"><br><br>  Analisamos todos os protocolos de VoIP: como sempre, para fazer algo, come√ßamos a olhar para os concorrentes. <br><br><h2>  Concorrentes ou por onde come√ßar <br></h2><br>  Escolhemos os concorrentes mais populares: Skype, WhatsApp, Google Duo (semelhante ao Hangouts) e ICQ. <br><br>  Para come√ßar, medimos o atraso. <br><img src="https://habrastorage.org/webt/yv/br/d2/yvbrd2tluf9yzf-xqqibngdooh8.jpeg"><br><br>  √â f√°cil de fazer.  Acima est√° uma fotografia na qual: <br><br><ul><li>  Cron√¥metro (consulte o telefone no canto superior esquerdo), que mostra a hora (03:08). </li><li>  O telefone pr√≥ximo faz uma chamada e leva o primeiro telefone como um v√≠deo.  A partir do momento em que a imagem entrou na c√¢mera do telefone, e voc√™ a viu, foram necess√°rios cerca de 100 ms. </li><li>  Uma chamada para outro telefone (branco) e mais uma vez.  Aqui o atraso √© de cerca de 310 ms no Google Duo. </li></ul><br>  Ainda n√£o revelo todas as placas, mas garantimos que esses dispositivos n√£o pudessem estabelecer conex√µes p2p.  Obviamente, as medi√ß√µes foram realizadas em redes diferentes, e este √© apenas um exemplo. <br><img src="https://habrastorage.org/webt/rn/xz/ee/rnxzee4grukafmg0gu3cunpemsi.jpeg"><br><br>  O Skype ainda interrompe um pouco.  Descobriu-se que, com o Skype, caso n√£o consiga conectar o p2p, o atraso √© de 1,1 s. <br><br>  Nosso ambiente de teste foi complicado.  Testamos em diferentes condi√ß√µes (EDGE, 3G, LTE, WiFi), levamos em conta que os canais s√£o assim√©tricos e eu dou os valores m√©dios de todas as medi√ß√µes. <br><img src="https://habrastorage.org/webt/gb/pp/6s/gbpp6sc5jugssoov8nmzvajlifo.jpeg"><br><br>  Para estimar o consumo da bateria, a carga do processador e tudo o mais, decidimos que voc√™ pode simplesmente medir a temperatura do telefone com um pir√¥metro e assumir que essa √© uma carga m√©dia na GPU do telefone por processador, bateria.  Em princ√≠pio, √© muito desagrad√°vel levar um telefone quente ao ouvido e at√© segur√°-lo nas m√£os.  Parece ao usu√°rio que agora o aplicativo consumir√° toda a bateria. <br><img src="https://habrastorage.org/webt/dl/ck/vd/dlckvdbr8we75haadv9qkgk1jxk.jpeg"><br><br>  O resultado √©: <br><br><ul><li>  Os mais lentos <strong>no atraso</strong> foram ICQ e Skype, e os mais r√°pidos - Telegram.  Esta n√£o √© uma compara√ß√£o completamente correta, pois o Telegram n√£o possui videochamadas, mas elas t√™m lat√™ncia m√≠nima no √°udio.  WhatsApp (cerca de 200 ms) e Hangouts - 390 ms funcionam muito bem. </li><li>  <strong>Por temperatura, o</strong> Telegram come menos sem v√≠deo e o Skype mais. </li><li>  Em termos de tempo de <strong>resposta</strong> , o Telegram estabelece a conex√£o <strong>por</strong> mais tempo e o mais r√°pido WhatsApp e Google Duo. </li></ul><br>  √ìtimo, temos algumas m√©tricas! <br><img src="https://habrastorage.org/webt/t8/mb/n0/t8mbn0vv_g1utslspeeevk8g5ie.jpeg"><br><br>  Testamos a qualidade do v√≠deo e da voz em redes diferentes, com quedas diferentes e tudo mais.  Como resultado, chegamos √† conclus√£o de que o <strong>v√≠deo</strong> da <strong>mais alta qualidade est√° no Google Duo e a voz est√° no Skype</strong> , mas isso ocorre em redes "ruins" quando j√° h√° distor√ß√£o.  Em geral, todo mundo trabalha aproximadamente med√≠ocre.  O WhatsApp tem a imagem mais desfocada. <br><br>  Vamos ver no que tudo est√° implementado. <br><img src="https://habrastorage.org/webt/ih/ap/1i/ihap1infndlvdjllso8eszhjnla.jpeg"><br><br>  O Skype tem seu pr√≥prio protocolo propriet√°rio e todos os outros usam uma modifica√ß√£o do WebRTC ou, geralmente, diretamente do WebRTC.  Hangouts, Google Duo, WhatsApp e Facebook Messenger podem trabalhar com a Web, e todos eles t√™m o WebRTC sob o cap√¥.  Eles s√£o todos t√£o diferentes, com caracter√≠sticas diferentes, e todos eles t√™m um WebRTC!  Ent√£o, voc√™ precisa ser capaz de cozinh√°-lo corretamente.  Al√©m disso, h√° o Telegram, pelo qual algumas partes do WebRTC s√£o respons√°veis ‚Äã‚Äãpela parte de √°udio, h√° o ICQ, que bifurcou o WebRTC por um longo tempo e continuou desenvolvendo seu pr√≥prio caminho. <br><br><h2>  WebRTC  Arquitetura <br></h2><br><img src="https://habrastorage.org/webt/3q/0x/-c/3q0x-cy-45bblq5lgoayq2awd5u.jpeg"><br><br>  O WebRTC implica a presen√ßa de um servidor de sinaliza√ß√£o, um intermedi√°rio entre clientes, que √© usado para trocar mensagens durante o estabelecimento de uma conex√£o p2p entre eles.  Depois de estabelecer uma conex√£o direta, os clientes come√ßam a trocar dados de m√≠dia entre si. <br><br><h2>  WebRTC  Demo <br></h2><br>  Vamos come√ßar com uma demonstra√ß√£o simples.  Existem 5 etapas simples para estabelecer uma conex√£o WebRTC. <br><br><div class="spoiler">  <b class="spoiler_title">C√≥digo de exemplo detalhado</b> <div class="spoiler_text"><pre><code class="javascript hljs"><span class="hljs-number"><span class="hljs-number">1.</span></span> <span class="hljs-comment"><span class="hljs-comment">// Step #1: Getting local video stream and initializing a peer connection with it (both caller and callee) 2. 3. var localStream = null; 4. var localVideo = document.getElementById('localVideo'); 5. 6. navigator 7. .mediaDevices 8. .getUserMedia({ audio: true, video: true }) 9. .then(stream =&gt; { 10. localVideo.srcObject = stream; 11. localStream = stream; 12. }); 13. 14. var pc = new RTCPeerConnection({ iceServers: [...] }); 15. 16. localStream 17. .getTracks() 18. .forEach(track =&gt; pc.addTrack(track, localStream)); 19. 20. // Step #2: Creating SDP offer (caller) 21. 22. pc.createOffer({ offerToReceiveAudio: true, offerToReceiveVideo: true }) 23. .then(offer =&gt; signaling.send('offer', offer)); 24. 25. // Step #3: Handling SDP offer and sending SDP answer (callee) 26. 27. signaling.on('offer', offer =&gt; { 28. pc.setRemoteDescription(offer) 29. .then(() =&gt; pc.createAnswer()) 30. .then(answer =&gt; signaling.send('answer', answer)) 31. }); 32. 33. // Step #4: Handling SDP answer (calleer) 34. 35. signaling.on('answer', answer =&gt; pc.setRemoteDescription(answer)); 36. 37. // Step #5: Exchanging ICE candidates 38. 39. pc.onicecandidate = event =&gt; signaling.send('candidate', event.candidate); 40. 41. signaling.on('candidate', candidate =&gt; pc.addIceCandidate(candidate)); 42. 43. // Step #6: Getting remote video stream (both caller and callee) 44. 45. var remoteVideo = document.getElementById('remoteVideo'); 46. 47. pc.onaddstream = event =&gt; remoteVideo.srcObject = event.streams[0];</span></span></code> </pre> <br></div></div><br>  Diz o seguinte: <br><br><ol><li>  Assista a um v√≠deo e estabele√ßa uma conex√£o entre colegas, transfira algum tipo de iceServers (n√£o est√° claro imediatamente o que √©). <br></li><li>  Crie uma oferta SDP e envie-a para sinaliza√ß√£o, e a WebRTC de sinaliza√ß√£o n√£o ser√° implementada de forma alguma. <br></li><li>  Ent√£o voc√™ precisa criar um wrapper para o que vem da sinaliza√ß√£o, e isso tamb√©m n√£o faz parte do WebRTC. <br></li><li>  Al√©m disso, troque alguns candidatos. <br></li><li>  Finalmente, obtenha o fluxo de v√≠deo remoto. <br></li></ol><br>  Vamos descobrir o que est√° acontecendo l√° e o que precisamos nos implementar. <br><img src="https://habrastorage.org/webt/wx/fz/fn/wxfzfnkuw7smjite-bdpmadb_ro.jpeg"><br><br>  Olhamos para a foto de baixo para cima.  Existe uma biblioteca WebRTC que j√° est√° embutida no navegador, suportada pelo Chrome, Firefox etc. Voc√™ pode compil√°-la no Android / iOS e se comunicar com ela por meio da API e SDP (Session Description Protocol), que descreve a pr√≥pria sess√£o.  Abaixo vou lhe dizer o que est√° inclu√≠do nele.  Para usar esta biblioteca em seu aplicativo, voc√™ deve estabelecer uma conex√£o entre assinantes por meio de sinaliza√ß√£o.  A sinaliza√ß√£o tamb√©m √© o seu servi√ßo que voc√™ deve escrever por si pr√≥prio, o WebRTC n√£o o fornece. <br><br>  Ainda neste artigo, discutiremos a rede em ordem, depois em v√≠deo / √°udio e, no final, escreveremos nossa sinaliza√ß√£o. <br><br><h2>  Rede WebRTC ou p2p (na verdade, c2s2c) <br></h2><br>  Configurar uma conex√£o p2p parece ser bastante simples. <br><img src="https://habrastorage.org/webt/he/7h/so/he7hsoyzqklbzj715slypgychgc.jpeg"><br><br>  Temos Alice e Bob que desejam estabelecer uma conex√£o p2p.  Eles pegam seus endere√ßos IP, t√™m um servidor de sinaliza√ß√£o ao qual est√£o conectados e pelo qual podem trocar esses endere√ßos.  Eles trocam endere√ßos, e oh!  Eles t√™m os mesmos endere√ßos, algo deu errado! <br><img src="https://habrastorage.org/webt/rn/hc/uj/rnhcujxoa5k0tni2oquj-tx3hfi.jpeg"><br><br>  De fato, √© prov√°vel que ambos os usu√°rios estejam atr√°s de roteadores Wi-Fi e esses sejam seus endere√ßos IP cinza locais.  O roteador fornece a eles um recurso como o Network Address Translation (NAT).  Como ela trabalha? <br><img src="https://habrastorage.org/webt/yr/xu/r0/yrxur0s_xhoye3i36zod4ropbec.jpeg"><br><br>  Voc√™ tem uma sub-rede cinza e um endere√ßo IP externo.  Voc√™ envia um pacote para a Internet a partir do seu endere√ßo cinza, o NAT o substitui por branco e lembra o mapeamento: de qual porta ele foi enviado, para qual usu√°rio e qual porta ele corresponde.  Quando o pacote de retorno chega, ele √© resolvido por esse mapeamento e o envia ao remetente.  Tudo √© simples. <br><br>  Abaixo est√° uma ilustra√ß√£o de como fica minha casa. <br><img src="https://habrastorage.org/webt/ud/ar/da/udardacyxvmzt5mq0modbosd-mc.jpeg"><br><br>  Este √© o meu endere√ßo IP interno e o endere√ßo do roteador (a prop√≥sito, tamb√©m cinza).  Se voc√™ rastrear e ver a rota, veremos meu roteador Wi-Fi: um pacote de endere√ßos de provedores cinza e um IP branco externo.  Portanto, de fato, terei dois NATs: um no qual estou no Wi-Fi e outro no provedor, a menos que, √© claro, eu comprei um endere√ßo IP externo dedicado. <br><br>  <strong>O NAT √© t√£o popular porque:</strong> <br><br><ul><li>  muitos IPv4s ainda est√£o faltando e n√£o h√° endere√ßos suficientes; </li><li>  O NAT parece proteger a rede; </li><li>  esta √© uma fun√ß√£o padr√£o do roteador: conecte-se ao Wi-Fi, existe NAT ali mesmo, funciona. </li></ul><br>  Portanto, apenas 3% dos usu√°rios ficam com um IP externo, enquanto todo o resto passa pelo NAT. <br><br>  O NAT permite que voc√™ v√° com seguran√ßa para qualquer endere√ßo em branco.  Mas se voc√™ n√£o foi a lugar algum, ningu√©m poder√° procur√°-lo. <br><img src="https://habrastorage.org/webt/j7/cl/j2/j7clj2pypnpwv_p-odndgflgzpk.jpeg"><br><br>  Estabelecer uma conex√£o P2P √© um problema.  De fato, Alice e Bob n√£o podem enviar pacotes um para o outro se ambos estiverem atr√°s do NAT. <br><br>  O WebRTC possui <strong>um protocolo STUN</strong> para resolver esse problema.  Prop√µe-se implantar um servidor STUN.  Em seguida, Alice se conecta ao servidor STUN, obt√©m seu endere√ßo IP, envia para Bob via sinaliza√ß√£o.  Bob tamb√©m obt√©m seu endere√ßo IP e o envia para Alice.  Eles enviam pacotes um para o outro e, assim, rompem o NAT. <br><img src="https://habrastorage.org/webt/1m/mq/iz/1mmqiz57zbyzzahdgng_y_3hywo.jpeg"><br><br>  <strong>Pergunta</strong> : Alice tem uma porta espec√≠fica aberta, o NAT / Firewall j√° foi invadido por essa porta e Bob est√° aberto.  Eles conhecem os endere√ßos um do outro.  Alice tenta enviar o pacote para Bob, ele envia o pacote para Alice.  Voc√™ acha que eles podem conversar ou n√£o? <br><br>  De fato, voc√™ est√° certo em qualquer caso, o resultado depende do tipo de par NAT que os usu√°rios possuem. <br><img src="https://habrastorage.org/webt/te/hd/hj/tehdhjdvyvfv9dcrxng950n98h8.jpeg"><br><br><h3>  Convers√£o de endere√ßos de rede <br></h3><br>  Existem 4 tipos de NAT: <br><br><ol><li>  NAT de cone completo; <br></li><li>  Cone restrito NAT; <br></li><li>  Cone de porta restrita NAT; <br></li><li>  NAT sim√©trico <br></li></ol><br>  Na vers√£o b√°sica, Alice envia um pacote para o servidor STUN, ela abre alguma porta.  De alguma forma, Bob descobre sua porta e envia um pacote de devolu√ß√£o.  Se esse √© o <strong>NAT de cone completo</strong> - o mais f√°cil que mapeia a porta externa para a porta interna, Bob poder√° enviar imediatamente um pacote para Alice, estabelecer uma conex√£o e eles falar√£o. <br><img src="https://habrastorage.org/webt/ph/kp/zr/phkpzrkuy3k2uzqsl4sub-sla7o.jpeg"><br><br>  Abaixo est√° o esquema de intera√ß√£o: Alice de alguma porta envia um pacote para a porta STUN, STUN responde com seu endere√ßo externo.  O STUN pode responder de qualquer endere√ßo, se for NAT de cone completo, ele ainda perfurar√° o NAT e Bob poder√° responder no mesmo endere√ßo. <br><img src="https://habrastorage.org/webt/dl/pp/3a/dlpp3anl2az479kengmx5easix4.jpeg"><br><br>  No caso do <strong>cone restrito NAT, as</strong> coisas s√£o um pouco mais complicadas.  Ele se lembra n√£o apenas da porta da qual voc√™ precisa mapear para o endere√ßo interno, mas tamb√©m do endere√ßo externo para o qual voc√™ foi.  Ou seja, se voc√™ estabeleceu uma conex√£o apenas com o servidor IP STUN, ningu√©m mais na rede poder√° responder e o pacote de Bob n√£o chegar√°. <br><img src="https://habrastorage.org/webt/yt/-g/sg/yt-gsg5yyrf99ywt77j2ydntyzy.jpeg"><br><br>  Como esse problema √© resolvido?  Em um esquema simples (veja a ilustra√ß√£o abaixo) assim: Alice envia um pacote para STUN, ele responde com seu IP.  O STUN pode responder a partir de qualquer porta, desde que seja um cone restrito NAT.  Bob n√£o pode responder Alice porque ele tem um endere√ßo diferente.  Alice responde com um pacote, sabendo o endere√ßo IP de Bob.  Ela abre o NAT para Bob, Bob responde.  Viva, eles conversaram. <br><img src="https://habrastorage.org/webt/iz/ji/ar/izjiare3mege16iftxwal3haqye.jpeg"><br><br>  Uma op√ß√£o um pouco mais complicada √© o <strong>NAT de cone restrito √† porta</strong> .  Mesmo assim, apenas o STUN deve responder exatamente da porta √† qual foi acessado.  Tudo vai funcionar tamb√©m. <br><br>  A coisa mais prejudicial √© o <strong>NAT sim√©trico</strong> . <br><img src="https://habrastorage.org/webt/p-/se/fu/p-sefuxnvpapxpuf8-wqavqkd0u.jpeg"><br><br>  No come√ßo, tudo funciona exatamente da mesma maneira - Alice envia o pacote para o servidor STUN, ele responde da mesma porta.  Bob n√£o pode responder Alice, mas ela envia o pacote para Bob.  E aqui, apesar do fato de Alice enviar um pacote para a porta 4444, o mapeamento aloca uma nova porta para ela.  O NAT sim√©trico √© diferente quando cada nova conex√£o √© estabelecida, cada vez que emite uma nova porta no roteador.  Conseq√ºentemente, Bob est√° batendo na porta da qual Alice foi para STUN, e eles n√£o podem se conectar. <br><br>  Na dire√ß√£o oposta, se Bob tiver um endere√ßo IP aberto, Alice poder√° procur√°-lo e eles estabelecer√£o uma conex√£o. <br><br>  Todas as op√ß√µes s√£o coletadas em uma tabela abaixo. <br><img src="https://habrastorage.org/webt/-c/jf/o9/-cjfo9dclflwku9qz-2p4wl_hre.jpeg"><br><br>  Isso mostra que quase tudo √© poss√≠vel, exceto quando tentamos estabelecer conex√µes por meio de NAT sim√©trico com cone de porta restrito NAT ou NAT sim√©trico na outra extremidade. <br><img src="https://habrastorage.org/webt/gp/lk/_d/gplk_darehdjbaxktic84liuwto.jpeg"><br><br>  Como descobrimos, o p2p n√£o tem pre√ßo para n√≥s em termos de lat√™ncia, mas se n√£o foi poss√≠vel instal√°-lo, o WebRTC nos oferece um servidor TURN.  Quando percebemos que o p2p n√£o ser√° instalado, basta conectar-se ao TURN, que far√° proxy de todo o tr√°fego.  No entanto, ao mesmo tempo, voc√™ pagar√° pelo tr√°fego e os usu√°rios poder√£o ter alguns atrasos adicionais. <br><br><h2>  Pr√°tica <br></h2><br>  O Google tem servidores STUN gratuitos.  Voc√™ pode coloc√°-los na biblioteca, ele funcionar√°. <br><br>  Os servidores TURN possuem credenciais (login e senha).  Muito provavelmente, voc√™ ter√° que criar o seu pr√≥prio, √© bastante dif√≠cil encontrar gratuitamente. <br><br>  Exemplos de servidores STUN gratuitos do Google: <br><br><ul><li>  atordoamento: stun.l.google.com: 19302 </li><li>  atordoamento: stun1.l.google.com: 19302 </li><li>  atordoamento: stun2.l.google.com: 19302 </li><li>  atordoamento: stun3.l.google.com: 19302 </li></ul><br>  E um servidor TURN gratuito com senhas: url: 'turn: 192.158.29.39: 3478? Transport = udp', credencial: 'JZEOEt2V3Qb0y27GRntt2u2PAYA =', nome de usu√°rio: '28224511: 1379330808'. <br><br>  Usamos <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">coturno</a> . <br><img src="https://habrastorage.org/webt/yj/_d/zv/yj_dzvkvpkhmol2a8ryscucgoli.jpeg"><br><br>  Como resultado, 34% do tr√°fego passa pela conex√£o p2p, todo o resto √© proxy atrav√©s do servidor TURN. <br><br><h4>  O que mais √© interessante no protocolo STUN? <br></h4><br>  STUN permite determinar o tipo de NAT. <br><img src="https://habrastorage.org/webt/nj/lo/7h/njlo7h_sounawjxlwk-pxsiejy0.jpeg"><br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><em>Link do</em></a> <em>slide</em> <br><br>  Ao enviar um pacote, voc√™ pode indicar que deseja receber uma resposta da mesma porta ou solicitar ao STUN que responda de uma porta diferente, de um IP diferente ou mesmo de um IP e porta diferentes.  Assim, <strong>para 4 consultas ao servidor STUN, voc√™ pode determinar o tipo de NAT</strong> . <br><img src="https://habrastorage.org/webt/og/0m/2h/og0m2hawerjjdabsr43zwygz_cy.jpeg"><br><br>  Contamos os tipos de NAT e constatamos que quase todos os usu√°rios t√™m NAT sim√©trico ou NAT de cone restrito √† porta.  Portanto, acontece que apenas um ter√ßo dos usu√°rios pode estabelecer uma conex√£o p2p. <br><br>  Voc√™ pode perguntar por que estou lhe dizendo tudo isso, se voc√™ pudesse pegar o STUN do Google, coloc√°-lo no WebRTC e parece que tudo vai funcionar. <br><br>  Porque voc√™ pode realmente determinar o tipo de NAT voc√™ mesmo. <br><img src="https://habrastorage.org/webt/ih/qn/8j/ihqn8j2nm2dumsstvyopem7ljxk.jpeg"><br><br>  Este √© um <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">link</a> para um aplicativo Java que n√£o faz nada de complicado: apenas envia portas e servidores STUN diferentes e analisa a porta que v√™ no final.  Se voc√™ tiver o NAT de cone aberto completo, o servidor STUN ter√° a mesma porta.  Com o cone restrito NAT, voc√™ ter√° portas diferentes para cada solicita√ß√£o de STUN. <br><img src="https://habrastorage.org/webt/ve/qf/t1/veqft1dee6wstziwrkrbemxj5da.jpeg"><br><br>  Com o NAT sim√©trico, acontece assim no meu escrit√≥rio.  Existem portas completamente diferentes. <br><br>  Mas, √†s vezes, h√° um padr√£o interessante de que para cada conex√£o, o n√∫mero da porta aumenta em um. <br><img src="https://habrastorage.org/webt/2n/7e/ro/2n7ero_besx7rzunsjuzfjplfpy.jpeg"><br><br>  Ou seja, muitos NATs s√£o configurados para aumentar ou diminuir a porta em uma constante.  Essa constante pode ser encontrada e, assim, rompe o NAT sim√©trico. <br><img src="https://habrastorage.org/webt/te/6n/bf/te6nbfknmebcz7zmrtk35jqwfpk.jpeg"><br><br>  Assim, rompemos o NAT - vamos para um servidor STUN, para outro, observamos a diferen√ßa, comparamos e tentamos novamente fornecer nossa porta j√° com esse incremento ou decr√©scimo.  Ou seja, Alice est√° tentando dar a Bob seu porto, j√° ajustado para uma constante, sabendo que da pr√≥xima vez ser√° exatamente isso. <br><img src="https://habrastorage.org/webt/l1/re/-m/l1re-mp1om6zkjqm0j1n5rfh004.jpeg"><br><br>  Ent√£o, conseguimos soldar <strong>outros 12% ponto a ponto</strong> . <br><br>  De fato, algumas vezes roteadores externos com o mesmo IP se comportam da mesma maneira.  Portanto, se as estat√≠sticas forem coletadas e se o Symmetric NAT for um recurso do provedor e n√£o um roteador Wi-Fi do usu√°rio, o delta poder√° ser previsto, enviando-o imediatamente ao usu√°rio para que ele o use e n√£o gaste muito tempo determinando-o. <br><br><h2>  Rel√© CDN ou o que fazer se voc√™ n√£o conseguir estabelecer uma conex√£o P2P <br></h2><br>  Se ainda usarmos o servidor TURN e n√£o trabalharmos em p2p, mas no modo real, passando todo o tr√°fego pelo servidor, ainda podemos adicionar uma CDN.  A menos, √© claro, que voc√™ tenha um playground.  N√≥s temos nossos pr√≥prios sites CDN, ent√£o para n√≥s foi bastante simples.  Mas era necess√°rio determinar onde √© melhor enviar uma pessoa: para um site da CDN ou, digamos, para um canal para Moscou.  Como n√£o √© uma tarefa muito trivial, fizemos o seguinte: <br><br><ol><li>  Acidentalmente emitido para alguns usu√°rios do site de Moscou, alguns - remotos. <br></li><li>  Coletamos estat√≠sticas sobre o IP do usu√°rio, sobre servidores e sobre as caracter√≠sticas da rede. <br></li><li>  Pelo maxMind, agrupamos as sub-redes, analisamos as estat√≠sticas e conseguimos entender por IP qual usu√°rio tinha o servidor TURN mais pr√≥ximo para a conex√£o. <br></li></ol><br><img src="https://habrastorage.org/webt/ql/dg/sy/qldgsyqtvaeqqdvyctilcipatau.jpeg"><br><br>  H√° uma CDN em Novosibirsk.  Se tudo funcionar para voc√™ em Moscou, o 99¬∫ percentil de RTT ser√° de 1,3 segundos.  Atrav√©s da CDN, tudo funciona muito mais r√°pido (0,4 segundos). <br><br>  √â sempre melhor usar uma conex√£o P2P e n√£o usar um servidor?  Um exemplo interessante s√£o os dois provedores de Krasnoyarsk, Optibyte e Mobra (os nomes podem ter sido alterados).  Por alguma raz√£o, a conex√£o entre eles no p2p √© muito pior do que atrav√©s do MSK.  Provavelmente eles n√£o s√£o amigos um do outro. <br><img src="https://habrastorage.org/webt/yq/en/dm/yqendmksjs7vila8zpra1xu_2uc.jpeg"><br><br>  Analisamos todos esses casos, enviando usu√°rios aleatoriamente para p2p ou via MSK, coletamos estat√≠sticas e constru√≠mos previs√µes.  Sabemos que as estat√≠sticas precisam ser atualizadas; portanto, para alguns usu√°rios, estabelecemos conex√µes diferentes para verificar se alguma coisa mudou nas redes. <br><br>  Medimos caracter√≠sticas simples como tempo de rodada, perda de pacotes, largura de banda - resta saber como compar√°-las corretamente. <br><img src="https://habrastorage.org/webt/yu/l-/nb/yul-nbvpnw5za6ixc80wlgumrse.jpeg"><br><br>  Como entender o que √© melhor: Internet de 2 Mbit / s, RTT de 400 ms e perda de pacotes de 5% ou 100 Kbit / s, atraso de 100 ms e escassa perda de pacotes? <br><br>  N√£o h√° resposta exata, a avalia√ß√£o da qualidade das chamadas de v√≠deo √© muito subjetiva.  Portanto, ap√≥s o t√©rmino da chamada, pedimos aos usu√°rios que avaliassem a qualidade em asteriscos e definissem as constantes de acordo com os resultados.  Descobriu-se que, por exemplo, o RTT √© inferior a 300 ms - n√£o importa mais, a taxa de bits √© mais importante. <br><br>  Maiores classifica√ß√µes de usu√°rios no Android e iOS.  √â visto que os usu√°rios do iOS t√™m maior probabilidade de colocar uma unidade e mais frequentemente cinco.  N√£o sei por que, provavelmente, as especificidades da plataforma.  Mas puxamos as constantes ao longo delas, para que tiv√©ssemos, como nos parece, boas. <br><br>  De volta ao nosso esbo√ßo do artigo, ainda estamos discutindo a rede. <br><br>  <strong>Como √© a configura√ß√£o da conex√£o?</strong> <br><img src="https://habrastorage.org/webt/-o/0b/zz/-o0bzzfolvd5rhfysec57ebndda.jpeg"><br><br>  Enviamos servidores STUN e TURN para PeerConnection (), uma conex√£o √© estabelecida.  Alice descobre seu IP, envia-o para sinalizar;  Bob aprende sobre o IP de Alice.  Alice recebe o IP de Bob.  Eles trocam pacotes, talvez rompam com o NAT, talvez configurem TURN e se comuniquem. <br><img src="https://habrastorage.org/webt/yz/oa/rv/yzoarv064wp3s6zwwjpy0ec68hk.jpeg"><br><br>  Nas 5 etapas para estabelecer a conex√£o que discutimos anteriormente, descobrimos os servidores, descobrimos onde obt√™-los e que os candidatos a ICE s√£o endere√ßos IP externos que trocamos por sinaliza√ß√£o.  Os endere√ßos IP internos dos clientes, se estiverem dentro do alcance de um Wi-Fi, tamb√©m podem ser tentados. <br><br>  Vamos passar para a parte do v√≠deo. <br><br><h2>  V√≠deo e √°udio <br></h2><br>  O WebRTC suporta um determinado conjunto de codecs de v√≠deo e √°udio, mas voc√™ pode adicionar seu pr√≥prio codec l√°.  Basicamente suportado pelo <strong>H.264 e VP8 para v√≠deo</strong> .  O VP8 √© um codec de software, portanto, consome muita bateria.  O H.264 n√£o est√° dispon√≠vel em todos os dispositivos (geralmente √© nativo); portanto, a prioridade padr√£o est√° no VP8. <br><br>  Dentro do SDP (Session Description Protocol), h√° negocia√ß√£o de codecs: quando um cliente envia uma lista de seus codecs, o outro envia seus pr√≥prios com prioridade e eles concordam com quais codecs ser√£o usados ‚Äã‚Äãpara comunica√ß√£o.  Se desejar, voc√™ pode alterar a prioridade dos codecs VP8 e H.264 e, devido a isso, pode economizar bateria em alguns dispositivos, onde 264 √© nativo.  Aqui est√° <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">um exemplo</a> de como isso pode ser feito.  Fizemos isso, parecia-nos que os usu√°rios n√£o reclamavam da qualidade, mas ao mesmo tempo a carga da bateria era consumida muito menos. <br><br>  Para √°udio, o WebRTC possui o <strong>OPUS ou o G711</strong> , geralmente todos os OPUS sempre funcionam, nada precisa ser feito com ele. <br><br>  Abaixo est√£o as medi√ß√µes de temperatura ap√≥s 10 minutos de uso. <br><img src="https://habrastorage.org/webt/pf/-q/pj/pf-qpjvwi8myzm7_q1zlmpe2zbs.jpeg"><br><br>  √â claro que testamos diferentes dispositivos.  Este √© um exemplo de iPhone e, nele, o aplicativo OK usa menos a bateria, porque a temperatura do dispositivo √© m√≠nima. <br><br>  A segunda coisa que voc√™ pode ativar se usar o WebRTC √© <strong>desligar automaticamente o v√≠deo quando a conex√£o estiver muito ruim</strong> . <br><img src="https://habrastorage.org/webt/xg/kx/ab/xgkxab9ccijdbomfmja0rtrhfpg.jpeg"><br><br>  Se voc√™ tiver menos de 40 Kbps, o v√≠deo ser√° desligado.  Voc√™ s√≥ precisa marcar a caixa ao criar a conex√£o, o valor limite pode ser configurado atrav√©s da interface.  Voc√™ tamb√©m pode definir a taxa de bits inicial m√≠nima e m√°xima. <br><img src="https://habrastorage.org/webt/xw/7d/ts/xw7dtsmnuz7pe0ujabtjapnnkxg.jpeg"><br><br>  Isso √© uma coisa muito √∫til.  Se, ao estabelecer uma conex√£o, voc√™ souber antecipadamente qual taxa de bits espera, poder√° transferi-la, a chamada ser√° iniciada a partir dela e voc√™ n√£o precisar√° adapt√°-la.  Al√©m disso, se voc√™ sabe que costuma ter perda de pacotes ou rebaixamentos de largura de banda em seu canal, o valor m√°ximo tamb√©m pode ser limitado. <br><br>  O WhatsApp funciona com v√≠deos muito ensaboados, mas com pequenos atrasos, pois comprime agressivamente a taxa de bits por cima. <br><br>  Coletamos estat√≠sticas usando o MaxMind e as mapeamos. <br><img src="https://habrastorage.org/webt/la/1b/kq/la1bkqswv6zqpbqdd7zrjarq0xu.jpeg"><br><br>  Essa √© uma qualidade inicial aproximada que usamos para chamadas em diferentes regi√µes da R√∫ssia. <br><br><h2>  Sinaliza√ß√£o <br></h2><br>  Voc√™ provavelmente ter√° que escrever esta parte se quiser fazer chamadas.  Existem todos os tipos de armadilhas.  Lembre-se da apar√™ncia. <br><img src="https://habrastorage.org/webt/ip/iv/er/ipiverlo5evjhsixis-obij86vs.jpeg"><br><br>  H√° um aplicativo com sinaliza√ß√£o que se conecta e troca com o SDP, e o SDP abaixo √© a interface para o WebRTC. <br><br>  √â assim que a sinaliza√ß√£o simples se parece: <br><img src="https://habrastorage.org/webt/y3/zl/ih/y3zlihhnt8w32ukv-ms7sbelbgm.jpeg"><br><br>  Alice liga para Bob.  Ele se conecta, por exemplo, atrav√©s de uma conex√£o de soquete da web.  Bob recebe um empurr√£o no seu celular ou navegador, ou em alguma conex√£o aberta, se conecta por um soquete da Web e, depois disso, o telefone come√ßa a tocar no bolso.  Bob atende o telefone, Alice envia a ele seus codecs e outros recursos do WebRTC que ela suporta.  Bob responde a mesma coisa e depois trocam os candidatos que viram.  Viva, ligue! <br><br>  Tudo parece bem longo.  Primeiro, at√© que voc√™ estabele√ßa uma conex√£o de soquete da Web, at√© que o push chegue e tudo mais, o telefone de Bob n√£o tocar√° no bolso.  Alice vai esperar o tempo todo, pensar onde Bob est√°, por que ele n√£o atende o telefone.  Ap√≥s a confirma√ß√£o, tudo leva segundos e, mesmo em boas conex√µes, pode levar de 3 a 5 segundos, e em conex√µes ruins, todos os 10. <br><br>  N√≥s devemos fazer algo sobre isso!  Voc√™ vai me dizer que tudo pode ser feito de maneira muito simples. <br><br><img src="https://habrastorage.org/webt/kz/q0/ym/kzq0ymgejzqqpmlyso5ri8mvz-k.jpeg"><br><br>  Se voc√™ j√° possui uma conex√£o aberta para o seu aplicativo, pode enviar imediatamente um push para estabelecer uma conex√£o, conectar-se ao servidor de sinaliza√ß√£o desejado e come√ßar imediatamente a fazer chamadas. <br><br>  Depois, outra otimiza√ß√£o.  Mesmo se o telefone ainda estiver tocando no seu bolso e voc√™ n√£o o atender, voc√™ poder√° realmente trocar informa√ß√µes sobre os codecs suportados, endere√ßos IP externos, come√ßar a enviar pacotes de v√≠deo vazios e, em geral, tudo ser√° aquecido.  Depois de atender o telefone, tudo ficar√° √≥timo. <br><br>  Fizemos isso e parecia que tudo estava legal.  Mas n√£o. <br><img src="https://habrastorage.org/webt/hh/m5/t6/hhm5t6dtihar96isxhtsm92pums.jpeg"><br><br>  O primeiro problema √© que os usu√°rios frequentemente cancelam a chamada.  Eles clicam em "Ligar" e cancelam imediatamente.  Consequentemente, o push vai para a chamada e o usu√°rio desaparece (ele perdeu a Internet ou outra coisa).  Enquanto isso, o telefone de algu√©m toca, ele atende o telefone e ele n√£o √© esperado l√°.  Portanto, nossa otimiza√ß√£o primitiva para iniciar a chamada o mais r√°pido poss√≠vel n√£o funciona realmente. <br><img src="https://habrastorage.org/webt/xy/we/gy/xywegygpnsrlns4osq7nn4i71f0.jpeg"><br><br>  Com um cancelamento r√°pido de chamada, h√° uma segunda coisa prejudicial.  Se voc√™ gerar o ID da sua conversa no servidor, precisar√° aguardar uma resposta.  Ou seja, voc√™ cria uma chamada, obt√©m um ID e somente depois pode fazer o que quiser: enviar pacotes, trocar, inclusive cancelar a chamada.  Essa √© uma hist√≥ria muito ruim, porque, at√© que a resposta chegue, voc√™ n√£o pode realmente cancelar nada do cliente.  Portanto, √© melhor gerar algum tipo de ID no cliente, como um GUID, e dizer que voc√™ iniciou a chamada.  As pessoas costumam fazer isso: ligaram, cancelaram e ligaram imediatamente novamente.  Para evitar que isso estrague, fa√ßa um GUID e envie-o. <br><img src="https://habrastorage.org/webt/1e/he/ob/1eheobd8oyf6z-je6j0puuj7psy.jpeg"><br><br>  Parece n√£o ser nada, mas h√° outro problema.  Se Bob tiver dois telefones, ou em algum outro lugar em que o navegador permanecer aberto, todo o nosso esquema m√°gico para trocar pacotes, estabelecer uma conex√£o n√£o funcionar√° se ele responder de repente a partir de outro dispositivo. <br><br>  O que fazer?  Vamos voltar ao nosso esquema b√°sico de sinaliza√ß√£o lenta simples e otimizar, enviar o push um pouco antes.  O usu√°rio come√ßar√° a se conectar mais rapidamente, mas isso economizar√° alguns centavos. <br><img src="https://habrastorage.org/webt/ap/k3/kx/apk3kx9qq3nsrzmrervqa548e-g.jpeg"><br><br>  O que fazer com a parte mais longa depois que ele pegou o telefone e iniciou a troca? <br><img src="https://habrastorage.org/webt/ff/bj/qv/ffbjqvge9liirsi6spjc7ttlyby.jpeg"><br><br>  Voc√™ pode fazer o seguinte.  √â claro que Alice j√° conhece todos os seus codecs e pode envi√°-los para os dois telefones de Bob.  Ela pode resolver todos os seus endere√ßos IP e tamb√©m envi√°-los para sinaliza√ß√£o, o que os manter√° em sua fila, mas n√£o os enviar√° a nenhum cliente, para que eles comecem a estabelecer uma conex√£o com ela com anteced√™ncia. <br><br>   ?  offer,   ,    ,   , ,    ,   .     ,    codec negotiation,  signaling             ,   ,     . Candidates         signaling. <br><br>   ,   signaling               .    ,          ,       . <br><br>    .           Google Duo  WhatsApp. <br><img src="https://habrastorage.org/webt/qr/gs/ry/qrgsry_mx3ahy48v6gvw1l49uau.jpeg"><br><br> ,   -  . ,      signaling,     ,   ,  , ,  ,    .     . <br><br> <strong>    ?</strong> <br><img src="https://habrastorage.org/webt/tp/fn/p3/tpfnp3a3cqrv_pdv31x7m4tirxi.jpeg"><br><br>      :   ,    .   ,      , ‚Äî   signaling  ,  ,   -  ,     ,     ,     . <br><img src="https://habrastorage.org/webt/so/mv/go/somvgopdt0c3zi5kksffvtpogz4.jpeg"><br><br>  ,   ,  ,      .          . ,     ,       ,   ,    .       ,    . <br><br>          ,     24/7,      -,      . <br><img src="https://habrastorage.org/webt/3a/uh/au/3auhaued9dsrfuwyhffcubvuqpy.jpeg"><br><br> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><em></em></a> <em>       <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="> </a></em> <br><br>    web-socket  - load balancer,    signaling-   -,       .  Zookeeper   Leader Election,     signaling,     conversation.       conversation,      . <br><br>      ,    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">NewSQL  Cassandra</a> .     ,  .       ,    signaling,   ,    signaling,     - ,  Leader Election  Zookeeper,   ,   ,         . <br><br>   : <br><br><ul><li>   - , ,   IP  signaling </li><li> Signaling ,   . </li><li>  ,  ,   , ,     . </li><li>       . </li></ul><br>     ,   . <br><br>           Cassandra,       ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="></a>    ). <br><br> <strong>,  :</strong> <br><br><ul><li>   iceServers    ; </li><li>   Session Description Protocol; </li><li>         ; </li><li>      signaling    WebRTC   ,   IP ; </li><li>    ! </li></ul><br><img src="https://habrastorage.org/webt/6j/hp/6k/6jhp6kn6luheqat6jepleauq1me.jpeg"><br><br> <strong> :</strong> <br><br><ul><li>   delay    ; </li><li>     ; </li><li>        . </li></ul><br>  Uau! <br><img src="https://habrastorage.org/webt/97/ru/zy/97ruzyu7gams8pyk2ktcoqb9yim.jpeg"><br><br><h2> Security. Man in the middle attack for WebRTC <br></h2><br>   man in the middle attack for WebRTC.   , WebRTC      ,     RTP,   1996 ,  SDP   1998  SIP. <br><img src="https://habrastorage.org/webt/yi/zm/7k/yizm7kvtjfnpnphvmuwiduk6yua.jpeg"><br><br>    ‚Äî   RFC     RTP,    RTP WebRTC. <br><br>      RFC ‚Äî       audio level,   ,     audio level  ,   . ,    SDP,   ,     .      congestion,       -. <br><br>  WebRTC  .  2011     ,  2013    Firefox,      iOS/Android,  2014 Opera.  , -   ,         . <br><img src="https://habrastorage.org/webt/53/s2/31/53s231p3esxh8vt9ls8dn8szgqi.jpeg"><br><br>       signaling,      ,  DTLS Handshake   .  ,       signaling,         ¬´¬ª   ,   ,      ,   . <br><img src="https://habrastorage.org/webt/i-/lq/uh/i-lquhbrd0eltgcqorvk1bu2gjs.jpeg"><br><br>       , , ,    HTTPS, WSS  ..     ‚Äî ZRTP,  , , Telegram. <br><br>    Telegram ,   ,     .       ,    ,  ,     ,       p2p . <br><br>   ? <br><img src="https://habrastorage.org/webt/rx/0-/ws/rx0-wsjwmt6y8fboqtzsgyzpqos.jpeg"><br><br>          ‚Äî .    ,    ,  .          .              K,    ,     ,        . <br><br>       ,       ,     K <sub>1</sub>  K <sub>2</sub> .       .    .   K <sub>1</sub>  K <sub>2</sub>     ,         .       K <sub>1</sub>  K <sub>2</sub>     :  ,   ‚Äî  ,   ‚Äî       ,  .        ,     ,  -    , ,   . <br><br><h2> <strong></strong> <br></h2><br><ul><li>  ¬´¬ª NAT type   symmetric NAT. </li><li>  ,  : 2  relay, , CDN;         . </li><li>   ,   . </li><li>    signaling. </li></ul><br><img src="https://habrastorage.org/webt/xr/h6/2i/xrh62iyyd4cb5ynwfa66atogljm.jpeg"><br><br>   ,       RTMFP, ,     WebRTC,   ,    .    !           4 . <br><br><h2> <strong> </strong> <br></h2><br>      ,    : <br><br><ul><li>   WebRTC  ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">https://webrtc.org/native-code/development/</a> ),    iOS/Android,      ; </li><li>    coturn ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">https://github.com/coturn/coturn</a> ); </li><li>  signaling. </li></ul><br>   ,    . <br><br><div class="spoiler"> <b class="spoiler_title">     </b> <div class="spoiler_text"><iframe width="560" height="315" src="https://www.youtube.com/embed/MnEXuKHjIOU" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br></div></div><br><blockquote>        HighLoad++  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="></a>      4-. <br><br>     ,   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="></a> .    ,  19  (10    9    -)  ,   -    .  ,       ,   . <br></blockquote></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt428217/">https://habr.com/ru/post/pt428217/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt428203/index.html">Observamos os gr√°ficos: estimativas e previs√µes para o mercado de computa√ß√£o em nuvem, dados em 2018</a></li>
<li><a href="../pt428205/index.html">Lifehacks NaviHaka</a></li>
<li><a href="../pt428209/index.html">Livro de receitas do desenvolvedor: Receitas de Design Orientado a Dom√≠nio (Parte 2, estrutura e intera√ß√£o)</a></li>
<li><a href="../pt428211/index.html">O livro ‚ÄúArquitetura Evolucion√°ria. Suporte para mudan√ßa cont√≠nua "</a></li>
<li><a href="../pt428213/index.html">Como interpretar previs√µes de modelo no SHAP</a></li>
<li><a href="../pt428219/index.html">De onde veio a pr√°tica de realoca√ß√£o em massa de pessoal qualificado?</a></li>
<li><a href="../pt428221/index.html">Gera√ß√£o AI de rostos realistas</a></li>
<li><a href="../pt428223/index.html">Cidades e seus Big Data</a></li>
<li><a href="../pt428225/index.html">Como fazer an√°lises da Web para SaaS por meio do Google Analytics: introdu√ß√£o e rastreamento de um funil</a></li>
<li><a href="../pt428227/index.html">Machine Learning: previs√£o de pre√ßos de a√ß√µes no mercado de a√ß√µes</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>