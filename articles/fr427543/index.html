<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë®üèø‚Äçü§ù‚Äçüë®üèæ üêÄ üë®üèæ‚Äçüîß Validation dans les applications Java üîè üÜì üë®üèæ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Ce texte est consacr√© √† diff√©rentes approches de la validation des donn√©es: sur quels pi√®ges un projet peut-il tomber et quelles m√©thodes et technolog...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Validation dans les applications Java</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/haulmont/blog/427543/"><p>  <em>Ce texte est consacr√© √† diff√©rentes approches de la validation des donn√©es: sur quels pi√®ges un projet peut-il tomber et quelles m√©thodes et technologies doivent √™tre suivies lors de la validation des donn√©es dans les applications Java.</em> </p><br><p><img src="https://habrastorage.org/webt/cj/yc/yj/cjycyj3zf_l1ai9ch_vsgzisstk.png" alt="Validation"></p><br><p>  J'ai souvent vu des projets dont les cr√©ateurs n'ont pas pris la peine de choisir une approche de validation des donn√©es.  Les √©quipes ont travaill√© sur le projet sous une pression incroyable sous la forme de d√©lais et d'exigences vagues, et en cons√©quence, elles n'ont tout simplement pas eu le temps d'une validation pr√©cise et coh√©rente.  Par cons√©quent, leur code de validation est dispers√© partout: dans les extraits de code Javascript, les contr√¥leurs d'√©cran, dans les bacs de logique m√©tier, les entit√©s de domaine, les d√©clencheurs et les contraintes de base de donn√©es.  Ce code √©tait plein de d√©clarations if-else, il a jet√© un tas d'exceptions et a essay√© de comprendre o√π cette donn√©e particuli√®re est valid√©e l√†-bas ... En cons√©quence, au fur et √† mesure que le projet se d√©veloppe, il devient difficile et co√ªteux de se conformer aux exigences (souvent assez d√©routant), et uniformit√© des approches de validation des donn√©es. </p><br><p>  Existe-t-il un moyen simple et √©l√©gant de valider les donn√©es?  Existe-t-il un moyen qui nous prot√©gera du p√©ch√© d'illisibilit√©, un moyen qui r√©unira toute la logique de validation, et qui a d√©j√† √©t√© cr√©√© pour nous par les d√©veloppeurs de frameworks Java populaires? </p><br><p>  Oui, il existe un tel moyen. </p><a name="habracut"></a><br><p>  Pour nous, les d√©veloppeurs de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">la plateforme CUBA</a> , il est tr√®s important que vous utilisiez les meilleures pratiques.  Nous pensons que le code de validation devrait: </p><br><ol><li>  √ätre r√©utilisable et suivre le principe DRY; </li><li>  Soyez naturel et compr√©hensible; </li><li>  Plac√© l√† o√π le d√©veloppeur s'attend √† le voir; </li><li>  √ätre capable de v√©rifier les donn√©es de diff√©rentes sources: interface utilisateur, appels SOAP, REST, etc. </li><li>  Travailler dans un environnement multi-thread sans probl√®mes; </li><li>  Appel√© automatiquement dans l'application, sans qu'il soit n√©cessaire d'ex√©cuter des v√©rifications manuellement; </li><li>  Pour donner √† l'utilisateur des messages clairs et localis√©s dans des bo√Ætes de dialogue concises; </li><li>  Suivez les normes. </li></ol><br><p>  Voyons comment cela peut √™tre impl√©ment√© √† l'aide d'un exemple d'application √©crit √† l'aide du cadre de la plateforme CUBA.  Cependant, puisque CUBA est bas√© sur Spring et EclipseLink, la plupart des techniques utilis√©es ici fonctionneront sur toute autre plate-forme Java prenant en charge les sp√©cifications JPA et Bean Validation. </p><br><h2 id="validaciya-s-ispolzovaniem-database-constraints">  Validation √† l'aide de contraintes de base de donn√©es </h2><br><p> La fa√ßon la plus courante et la plus √©vidente de valider les donn√©es est peut-√™tre d'utiliser des restrictions au niveau de la base de donn√©es, par exemple, l'indicateur requis (pour les champs dont la valeur ne peut pas √™tre vide), la longueur de la cha√Æne, les index uniques, etc.  Cette m√©thode convient le mieux aux applications d'entreprise, car ce type de logiciel est g√©n√©ralement strictement ax√© sur le traitement des donn√©es.  Cependant, m√™me ici, les d√©veloppeurs font souvent des erreurs en fixant des limites s√©par√©ment pour chaque niveau de l'application.  Le plus souvent, la raison r√©side dans la r√©partition des responsabilit√©s entre les d√©veloppeurs. </p><br><p>  Prenons un exemple que la plupart d'entre nous connaissent, certains m√™me d'apr√®s notre propre exp√©rience ... Si la sp√©cification indique qu'il devrait y avoir 10 caract√®res dans le champ du num√©ro de passeport, il est tr√®s probable que cela sera v√©rifi√© par tout le monde: un architecte DB en DDL, un d√©veloppeur backend dans l'entit√© correspondante et Services REST, et enfin, le d√©veloppeur de l'interface utilisateur directement sur le c√¥t√© client.  Ensuite, cette exigence change et le champ passe √† 15 caract√®res.  Les Devops modifient les valeurs des contraintes dans la base de donn√©es, mais rien ne change pour l'utilisateur, car c√¥t√© client la restriction est la m√™me ... </p><br><p>  Tout d√©veloppeur sait comment √©viter ce probl√®me - la validation doit √™tre centralis√©e!  Dans CUBA, une telle validation se trouve dans les annotations d'entit√© JPA.  Sur la base de ces m√©ta-informations, CUBA Studio va g√©n√©rer le script DDL correct et appliquer les validateurs c√¥t√© client appropri√©s. </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/118/a16/f17/118a16f1705740a1676eb2c0ea164ef4.png" alt="Exemple de contraintes"></p><br><p>  Si les annotations changent, CUBA mettra √† jour les scripts DDL et g√©n√©rera les scripts de migration, de sorte que la prochaine fois que vous d√©ploierez le projet, de nouvelles restrictions bas√©es sur JPA entreront en vigueur √† la fois dans l'interface et dans la base de donn√©es d'application. </p><br><p> Malgr√© la simplicit√© et l'impl√©mentation au niveau de la base de donn√©es, ce qui donne une fiabilit√© absolue √† cette m√©thode, la port√©e des annotations JPA est limit√©e aux cas les plus simples qui peuvent √™tre exprim√©s dans la norme DDL et n'incluent pas les d√©clencheurs de base de donn√©es ou les proc√©dures stock√©es.  Ainsi, les contraintes bas√©es sur JPA peuvent rendre un champ d'entit√© unique ou obligatoire ou d√©finir une longueur de colonne maximale.  Vous pouvez m√™me d√©finir une restriction unique sur la combinaison de colonnes √† l'aide de l'annotation <code>@UniqueConstraint</code> .  Mais c'est probablement tout. </p><br><p>  Quoi qu'il en soit, dans les cas n√©cessitant une logique de validation plus complexe, comme la v√©rification d'une valeur minimale / maximale dans un champ, la validation avec une expression r√©guli√®re ou la r√©alisation d'une v√©rification personnalis√©e sp√©cifique √† votre application uniquement, l'approche connue sous le nom de <strong>¬´validation de bean¬ª</strong> est appliqu√©e. . </p><br><h2 id="bean-validation">  Validation du bean </h2><br><p>  Tout le monde sait que c'est une bonne pratique de suivre des normes qui ont un long cycle de vie, dont l'efficacit√© a √©t√© prouv√©e sur des milliers de projets.  Java Bean Validation est une approche document√©e dans <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">JSR 380, 349 et 303</a> et leurs applications: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Hibernate Validator</a> et <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Apache BVal</a> . </p><br><p>  Bien que cette approche soit famili√®re √† de nombreux d√©veloppeurs, elle est souvent sous-estim√©e.  C'est un moyen facile d'int√©grer la validation des donn√©es m√™me dans les projets h√©rit√©s, qui vous permet de cr√©er des validations de mani√®re claire, simple, fiable et aussi proche que possible de la logique m√©tier. </p><br><p>  L'utilisation de Bean Validation offre au projet de nombreux avantages: </p><br><ul><li>  La logique de validation se situe √† c√¥t√© du domaine: la d√©finition des restrictions pour les champs et les m√©thodes du bac se fait de mani√®re naturelle et v√©ritablement orient√©e objet. </li><li>  La norme de validation de bean nous donne des dizaines d' <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">annotations</a> de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">validation d√®s la sortie de la bo√Æte</a> , par exemple: <code>@NotNull</code> , <code>@Size</code> , <code>@Min</code> , <code>@Max</code> , <code>@Pattern</code> , <code>@Email</code> , <code>@Past</code> , pas tout √† fait standard <code>@URL</code> , <code>@Length</code> , le <code>@Length</code> le plus puissant et bien d'autres encore . </li><li>  La norme ne nous limite pas aux annotations toutes faites et nous permet de cr√©er les n√¥tres.  Nous pouvons √©galement cr√©er une nouvelle annotation en combinant plusieurs autres, ou la d√©finir en utilisant une classe Java distincte comme validateur. <br>  Par exemple, dans l'exemple ci-dessus, nous pouvons d√©finir l'annotation de niveau de la classe <code>@ValidPassportNumber</code> pour v√©rifier que le num√©ro de passeport correspond au format en fonction de la valeur du champ <code>country</code> . </li><li>  Les contraintes peuvent √™tre d√©finies non seulement sur des champs ou des classes, mais √©galement sur des m√©thodes et leurs param√®tres.  Cette approche est appel√©e <strong>¬´validation par contrat¬ª</strong> et sera discut√©e un peu plus loin. </li></ul><br><p>  Lorsque l'utilisateur soumet les informations saisies, la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">plate-forme CUBA</a> <em>(comme certains autres cadres)</em> d√©marre automatiquement la validation du bean, de sorte qu'elle affiche instantan√©ment un message d'erreur si la validation √©choue, et nous n'avons pas besoin d'ex√©cuter les validateurs de bac manuellement. </p><br><p>  Revenons √† l'exemple avec le num√©ro de passeport, mais cette fois nous allons le compl√©ter avec plusieurs restrictions de l'entit√© Personne: </p><br><ul><li>  Le champ du <code>name</code> doit contenir au moins 2 caract√®res et doit √™tre valide.  (Comme vous pouvez le voir, l'expression rationnelle n'est pas simple, mais "Charles Ogier de Batz de Castelmore Comte d'Artagnan" passera le test, mais "R2D2" ne le sera pas); </li><li>  <code>height</code> (hauteur) doit √™tre dans l'intervalle suivant: <code>0 &lt; height &lt;= 300</code> cm; </li><li>  Le champ de l' <code>email</code> doit contenir une cha√Æne qui correspond au format de l'e-mail correct. </li></ul><br><p>  Avec toutes ces v√©rifications, la classe Person ressemblera √† ceci: </p><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Listeners</span></span>(<span class="hljs-string"><span class="hljs-string">"passportnumber_PersonEntityListener"</span></span>) <span class="hljs-meta"><span class="hljs-meta">@NamePattern</span></span>(<span class="hljs-string"><span class="hljs-string">"%s|name"</span></span>) <span class="hljs-meta"><span class="hljs-meta">@Table</span></span>(name = <span class="hljs-string"><span class="hljs-string">"PASSPORTNUMBER_PERSON"</span></span>) <span class="hljs-meta"><span class="hljs-meta">@Entity</span></span>(name = <span class="hljs-string"><span class="hljs-string">"passportnumber$Person"</span></span>) <span class="hljs-meta"><span class="hljs-meta">@ValidPassportNumber</span></span>(groups = {Default.class, UiCrossFieldChecks.class}) <span class="hljs-meta"><span class="hljs-meta">@FraudDetectionFlag</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Person</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">StandardEntity</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> serialVersionUID = -<span class="hljs-number"><span class="hljs-number">9150857881422152651L</span></span>; <span class="hljs-meta"><span class="hljs-meta">@Pattern</span></span>(message = <span class="hljs-string"><span class="hljs-string">"Bad formed person name: ${validatedValue}"</span></span>, regexp = <span class="hljs-string"><span class="hljs-string">"^[AZ][az]*(\\s(([az]{1,3})|(([az]+\\')?[AZ][az]*)))*$"</span></span>) <span class="hljs-meta"><span class="hljs-meta">@Length</span></span>(min = <span class="hljs-number"><span class="hljs-number">2</span></span>) <span class="hljs-meta"><span class="hljs-meta">@NotNull</span></span> <span class="hljs-meta"><span class="hljs-meta">@Column</span></span>(name = <span class="hljs-string"><span class="hljs-string">"NAME"</span></span>, nullable = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> String name; <span class="hljs-meta"><span class="hljs-meta">@Email</span></span>(message = <span class="hljs-string"><span class="hljs-string">"Email address has invalid format: ${validatedValue}"</span></span>, regexp = <span class="hljs-string"><span class="hljs-string">"^[a-zA-Z0-9_.+-]+@[a-zA-Z0-9-]+\\.[a-zA-Z0-9-.]+$"</span></span>) <span class="hljs-meta"><span class="hljs-meta">@Column</span></span>(name = <span class="hljs-string"><span class="hljs-string">"EMAIL"</span></span>, length = <span class="hljs-number"><span class="hljs-number">120</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> String email; <span class="hljs-meta"><span class="hljs-meta">@DecimalMax</span></span>(message = <span class="hljs-string"><span class="hljs-string">"Person height can not exceed 300 centimeters"</span></span>, value = <span class="hljs-string"><span class="hljs-string">"300"</span></span>) <span class="hljs-meta"><span class="hljs-meta">@DecimalMin</span></span>(message = <span class="hljs-string"><span class="hljs-string">"Person height should be positive"</span></span>, value = <span class="hljs-string"><span class="hljs-string">"0"</span></span>, inclusive = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>) <span class="hljs-meta"><span class="hljs-meta">@Column</span></span>(name = <span class="hljs-string"><span class="hljs-string">"HEIGHT"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> BigDecimal height; <span class="hljs-meta"><span class="hljs-meta">@NotNull</span></span> <span class="hljs-meta"><span class="hljs-meta">@Column</span></span>(name = <span class="hljs-string"><span class="hljs-string">"COUNTRY"</span></span>, nullable = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> Integer country; <span class="hljs-meta"><span class="hljs-meta">@NotNull</span></span> <span class="hljs-meta"><span class="hljs-meta">@Column</span></span>(name = <span class="hljs-string"><span class="hljs-string">"PASSPORT_NUMBER"</span></span>, nullable = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>, length = <span class="hljs-number"><span class="hljs-number">15</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> String passportNumber; ... }</code> </pre> <br><p>  <a href="">Person.java</a> </p><br><p>  Je pense que l'utilisation d'annotations telles que <code>@NotNull</code> , <code>@DecimalMin</code> , <code>@Length</code> , <code>@Pattern</code> et similaires est assez √©vidente et ne n√©cessite aucun commentaire.  Examinons de plus pr√®s l'impl√©mentation de l'annotation <code>@ValidPassportNumber</code> . </p><br><p>  Notre tout nouveau <code>@ValidPassportNumber</code> v√©rifie que <code>Person#passportNumber</code> correspond au mod√®le d'expression r√©guli√®re pour chaque pays sp√©cifi√© par le champ <code>Person#country</code> . </p><br><p>  Tout d'abord, regardons la documentation (les manuels <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">CUBA</a> ou <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Hibernate</a> sont tr√®s bien), selon elle, nous devons marquer notre classe avec cette nouvelle annotation et lui passer le param√®tre <code>groups</code> , o√π <code>UiCrossFieldChecks.class</code> signifie que cette validation doit √™tre ex√©cut√©e au niveau crois√©. validations - apr√®s avoir v√©rifi√© tous les champs individuels, et <code>Default.class</code> enregistre la restriction dans le groupe de validation par d√©faut. </p><br><p>  La description de l'annotation ressemble √† ceci: </p><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Target</span></span>(ElementType.TYPE) <span class="hljs-meta"><span class="hljs-meta">@Retention</span></span>(RetentionPolicy.RUNTIME) <span class="hljs-meta"><span class="hljs-meta">@Constraint</span></span>(validatedBy = ValidPassportNumberValidator.class) <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-meta"><span class="hljs-meta">@interface</span></span> ValidPassportNumber { <span class="hljs-function"><span class="hljs-function">String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">message</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">default</span></span></span><span class="hljs-function"> "Passport number is not valid"</span></span>; Class&lt;?&gt;[] groups() <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> {}; Class&lt;? extends Payload&gt;[] payload() <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> {}; }</code> </pre> <br><p>  <a href="">ValidPassportNumber.java</a> </p><br><p>  Ici, <code>@Target(ElementType.TYPE)</code> indique que le but de cette annotation d'ex√©cution est la classe, et <code>@Constraint(validatedBy = ‚Ä¶ )</code> d√©termine que la validation est effectu√©e par la classe <code>ValidPassportNumberValidator</code> qui impl√©mente l'interface <code>ConstraintValidator&lt;...&gt;</code> .  Le code de validation lui-m√™me se trouve dans la <code>isValid(...)</code> , qui effectue la v√©rification proprement dite de mani√®re assez simple: </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ValidPassportNumberValidator</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ConstraintValidator</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ValidPassportNumber</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Person</span></span></span><span class="hljs-class">&gt; </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">initialize</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ValidPassportNumber constraint)</span></span></span><span class="hljs-function"> </span></span>{ } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">isValid</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Person person, ConstraintValidatorContext context)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (person == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (person.country == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span> || person.passportNumber == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> doPassportNumberFormatCheck(person.getCountry(), person.getPassportNumber()); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">doPassportNumberFormatCheck</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(CountryCode country, String passportNumber)</span></span></span><span class="hljs-function"> </span></span>{ ... } }</code> </pre> <br><p>  <a href="">ValidPassportNumberValidator.java</a> </p><br><p>  C‚Äôest tout.  Avec la plateforme CUBA, nous n'avons pas besoin d'√©crire autre chose qu'une ligne de code qui fera fonctionner notre validation personnalis√©e et donnera des messages d'erreur √† l'utilisateur. <br>  Rien de compliqu√©, non? </p><br><p>  Voyons maintenant comment tout cela fonctionne.  Ici, CUBA a d'autres nishtyaki: il montre non seulement √† l'utilisateur un message d'erreur, mais met √©galement en √©vidence dans les champs rouges qui n'ont pas pass√© la validation du bean: </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/310/83d/b2b/31083db2b14d67d88de169542b59748a.png" alt="Repr√©sentation de l'interface utilisateur"></p><br><p>  N'est-ce pas une solution √©l√©gante?  Vous obtenez un affichage ad√©quat des erreurs de validation dans l'interface utilisateur en ajoutant seulement quelques annotations Java aux entit√©s du domaine. </p><br><p>  Pour r√©sumer la section, √©num√©rons bri√®vement les avantages de la validation du bean pour les entit√©s: </p><br><ol><li>  C'est compr√©hensible et lisible; </li><li>  Vous permet de d√©finir des contraintes de valeur directement dans les classes d'entit√©s; </li><li>  Il peut √™tre personnalis√© et compl√©t√©; </li><li>  Int√©gr√© dans les ORM populaires, et les v√©rifications sont ex√©cut√©es automatiquement avant que les modifications ne soient enregistr√©es dans la base de donn√©es; </li><li>  Certains frameworks ex√©cutent √©galement la validation du bean automatiquement lorsque l'utilisateur envoie des donn√©es √† l'interface utilisateur (et sinon, il est facile d'appeler manuellement l'interface <code>Validator</code> ); </li><li>  Bean Validation est une norme reconnue et regorge de documentation sur Internet. </li></ol><br><p>  Mais que faire si vous devez d√©finir une restriction sur une m√©thode, un constructeur ou une adresse REST pour valider les donn√©es provenant d'un syst√®me externe?  Ou si vous devez v√©rifier de mani√®re d√©clarative les valeurs des param√®tres de la m√©thode, sans √©crire de code ennuyeux avec de nombreuses conditions if-else dans chaque m√©thode test√©e? </p><br><p>  La r√©ponse est simple: la validation du bean s'applique √©galement aux m√©thodes! </p><br><h2 id="validation-by-contract">  Validation par contrat </h2><br><p>  Il faut parfois d√©passer la validation de l'√©tat du mod√®le de donn√©es.  De nombreuses m√©thodes peuvent b√©n√©ficier de la validation automatique des param√®tres et de la valeur de retour.  Cela peut √™tre n√©cessaire non seulement pour v√©rifier les donn√©es allant aux adresses REST ou SOAP, mais aussi dans les cas o√π nous voulons noter les conditions pr√©alables et postconditions des appels de m√©thode pour nous assurer que les donn√©es entr√©es ont √©t√© v√©rifi√©es avant l'ex√©cution du corps de la m√©thode ou que la valeur de retour est dans la plage attendue, ou par exemple, nous avons juste besoin de d√©crire de mani√®re d√©clarative les plages de valeurs des param√®tres d'entr√©e pour am√©liorer la lisibilit√© du code. </p><br><p>  En utilisant la validation du bean, des restrictions peuvent √™tre appliqu√©es aux param√®tres d'entr√©e et aux valeurs de retour des m√©thodes et constructeurs pour v√©rifier les conditions pr√©alables et postconditions de leurs appels dans n'importe quelle classe Java.  Ce chemin pr√©sente plusieurs avantages par rapport aux m√©thodes traditionnelles de v√©rification de la validit√© des param√®tres et des valeurs de retour: </p><br><ol><li>  Il n'est pas n√©cessaire d'effectuer des v√©rifications manuellement dans un style imp√©ratif (par exemple, en lan√ßant <code>IllegalArgumentException</code> , etc.).  Vous pouvez d√©finir des contraintes de mani√®re d√©clarative et rendre le code plus compr√©hensible et expressif; </li><li>  Les contraintes peuvent √™tre configur√©es, r√©utilis√©es et configur√©es: vous n'avez pas besoin d'√©crire de logique de validation pour chaque v√©rification.  Moins de code signifie moins de bugs. </li><li>  Si la classe, la valeur de retour de la m√©thode ou son param√®tre est marqu√© avec l'annotation <code>@Validated</code> , les v√©rifications seront automatiquement effectu√©es par la plateforme √† chaque appel de la m√©thode. </li><li>  Si l'ex√©cutable est marqu√© avec l'annotation <code>@Documented</code> , ses pr√© et postconditions seront incluses dans le JavaDoc g√©n√©r√©. </li></ol><br><p>  En utilisant la <strong>¬´validation de contrat¬ª,</strong> nous obtenons un code clair, compact et facile √† maintenir. </p><br><p>  Pour un exemple, regardons l'interface du contr√¥leur REST d'une application CUBA.  L'interface <code>PersonApiService</code> vous permet d'obtenir une liste de personnes √† partir de la base de donn√©es √† l'aide de la m√©thode <code>getPersons()</code> et d'ajouter une nouvelle personne √† l'aide de l' <code>addNewPerson(...)</code> . </p><br><p>  Et n'oubliez pas que la validation du bean est h√©rit√©e!  En d'autres termes, si nous annotons une certaine classe, ou champ, ou m√©thode, toutes les classes qui h√©ritent de cette classe ou impl√©mentent cette interface seront soumises √† la m√™me annotation de validation. </p><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Validated</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PersonApiService</span></span></span><span class="hljs-class"> </span></span>{ String NAME = <span class="hljs-string"><span class="hljs-string">"passportnumber_PersonApiService"</span></span>; <span class="hljs-meta"><span class="hljs-meta">@NotNull</span></span> <span class="hljs-meta"><span class="hljs-meta">@Valid</span></span> <span class="hljs-meta"><span class="hljs-meta">@RequiredView</span></span>(<span class="hljs-string"><span class="hljs-string">"_local"</span></span>) <span class="hljs-function"><span class="hljs-function">List&lt;Person&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getPersons</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">addNewPerson</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( @NotNull @Length(min = </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">2</span></span></span></span><span class="hljs-function"><span class="hljs-params">, max = </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">255</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> @</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Pattern</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(message = </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"Bad formed person name: ${validatedValue}"</span></span></span></span><span class="hljs-function"><span class="hljs-params">, regexp = </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"^[AZ][az]*(\\s(([az]{1,3})|(([az]+\\')?[AZ][az]*)))*$"</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> String name, @</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">DecimalMax</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(message = </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"Person height can not exceed 300 cm"</span></span></span></span><span class="hljs-function"><span class="hljs-params">, value = </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"300"</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> @</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">DecimalMin</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(message = </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"Person height should be positive"</span></span></span></span><span class="hljs-function"><span class="hljs-params">, value = </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"0"</span></span></span></span><span class="hljs-function"><span class="hljs-params">, inclusive = </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">false</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> BigDecimal height, @NotNull CountryCode country, @NotNull String passportNumber )</span></span>; }</code> </pre> <br><p>  <a href="">PersonApiService.java</a> </p><br><p>  Ce morceau de code est-il suffisamment clair? <br>  _ (√Ä l'exception de l'annotation <code>@RequiredView(‚Äú_local‚Äù)</code> , qui est sp√©cifique √† la plate-forme CUBA et v√©rifie que l'objet <code>Person</code> retourn√© contient tous les champs de la table <code>PASSPORTNUMBER_PERSON</code> ) ._ </p><br><p>  L' <code>@Valid</code> d√©finit que chaque objet de collection retourn√© par la m√©thode <code>getPersons()</code> doit √©galement √™tre valid√© par rapport aux restrictions de la classe <code>Person</code> . </p><br><p>  Dans une application CUBA, ces m√©thodes sont disponibles aux adresses suivantes: </p><br><ul><li>  / app / rest / v2 / services / passportnumber_PersonApiService / getPersons </li><li>  / app / rest / v2 / services / passportnumber_PersonApiService / addNewPerson </li></ul><br><p>  Ouvrons l'application Postman et assurons-nous que la validation fonctionne comme il se doit: </p><br><p><img src="https://habrastorage.org/webt/qg/ra/qj/qgraqjsxfyeqqa6qcjf2pkf7tcq.png" alt="Postman app"></p><br><p>  Comme vous l'avez peut-√™tre remarqu√©, le num√©ro de passeport n'est pas valid√© dans l'exemple ci-dessus.  En effet, ce champ n√©cessite une v√©rification crois√©e des param√®tres de la m√©thode <code>addNewPerson</code> , car le choix d'un mod√®le d'expression r√©guli√®re pour valider <code>passportNumber</code> d√©pend de la valeur du champ <code>country</code> .  Cette validation crois√©e est un analogue complet des restrictions d'entit√© au niveau de la classe! </p><br><p>  La validation crois√©e des param√®tres est prise en charge par JSR 349 ‚Äã‚Äãet 380. Vous pouvez lire la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">documentation de mise en veille prolong√©e</a> pour savoir comment impl√©menter votre propre validation crois√©e des m√©thodes de classe / interface. </p><br><h2 id="za-predelami-bean-validation">  Validation du bean ext√©rieur </h2><br><p>  Il n'y a pas de perfection dans le monde, la validation du bean a donc ses inconv√©nients et ses limites: </p><br><ol><li>  Parfois, il suffit de v√©rifier l'√©tat d'un graphe complexe d'objets avant d'enregistrer les modifications dans la base de donn√©es.  Par exemple, vous devez vous assurer que tous les √©l√©ments d'une commande client sont plac√©s dans un seul colis.  C'est une op√©ration assez difficile, et la r√©aliser √† chaque fois que l'utilisateur ajoute de nouveaux articles √† la commande n'est pas une bonne id√©e.  Par cons√©quent, une telle v√©rification peut √™tre n√©cessaire une seule fois: avant d'enregistrer l'objet <code>Order</code> et ses sous-objets <code>OrderItem</code> dans la base de donn√©es. </li><li>  Certains contr√¥les doivent √™tre effectu√©s √† l'int√©rieur d'une transaction.  Par exemple, le syst√®me de magasin √©lectronique doit v√©rifier s'il y a suffisamment de copies des marchandises pour ex√©cuter la commande avant de les enregistrer dans la base de donn√©es.  Un tel contr√¥le ne peut √™tre effectu√© qu'√† l'int√©rieur d'une transaction, car  Le syst√®me est multithread et la quantit√© de marchandises en stock peut changer √† tout moment. </li></ol><br><p>  La plateforme CUBA propose deux m√©canismes de validation des donn√©es avant validation appel√©s <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">√©couteurs d'entit√©</a> et <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">√©couteurs de transaction</a> .  Examinons-les plus en d√©tail. </p><br><h3 id="entity-listemers">  Listeurs d'entit√©s </h3><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Les √©couteurs d'entit√© dans CUBA sont</a> tr√®s similaires aux <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><code>PreInsertEvent</code> , <code>PreUpdateEvent</code> et <code>PredDeleteEvent</code></a> que JPA propose au d√©veloppeur.  Les deux m√©canismes vous permettent de v√©rifier les objets d'entit√© avant et apr√®s leur stockage dans la base de donn√©es. </p><br><p>  Dans CUBA, il est facile de cr√©er et de connecter un √©couteur d'entit√©, pour cela, vous avez besoin de deux choses: </p><br><ol><li>  Cr√©ez un bean g√©r√© qui impl√©mente l'une des interfaces d'√©coute d'entit√©.  3 interfaces sont importantes pour la validation: <br>  <code>BeforeDeleteEntityListener&lt;T&gt;</code> , <br>  <code>BeforeInsertEntityListener&lt;T&gt;</code> , <br> <code>BeforeUpdateEntityListener&lt;T&gt;</code> </li> <li>  Ajoutez l'annotation <code>@Listeners</code> √† l'objet entit√© que vous pr√©voyez de suivre. </li></ol><br><p>  Et c'est tout. </p><br><p>  Par rapport √† la norme JPA (JSR 338, section 3.5), les interfaces d'√©coute de la plateforme CUBA sont typ√©es, vous n'avez donc pas besoin de convertir un argument avec un type d' <code>Object</code> un type d'entit√© pour commencer √† travailler avec lui.  La plate-forme CUBA ajoute des entit√©s li√©es ou des appelants EntityManager la possibilit√© de charger et de modifier d'autres entit√©s.  Toutes ces modifications invoqueront √©galement l'√©couteur d'entit√© correspondant. </p><br><p>  La plate-forme CUBA prend √©galement en charge la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">¬´suppression logicielle¬ª</a> , une approche o√π au lieu de supprimer r√©ellement les enregistrements de la base de donn√©es, ils sont uniquement marqu√©s comme supprim√©s et deviennent inaccessibles pour une utilisation normale.  Ainsi, pour la suppression <code>BeforeDeleteEntityListener</code> , la plate-forme appelle les <code>BeforeDeleteEntityListener</code> / <code>AfterDeleteEntityListener</code> , tandis que les impl√©mentations standard appellent les <code>PreUpdate</code> / <code>PostUpdate</code> . </p><br><p>  Regardons un exemple.  Ici, le bean <code>@Listeners</code> √©v√©nement se connecte √† la classe d'entit√© avec une seule ligne de code: l'annotation <code>@Listeners</code> , qui prend le nom de la classe d'√©coute: </p><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Listeners</span></span>(<span class="hljs-string"><span class="hljs-string">"passportnumber_PersonEntityListener"</span></span>) <span class="hljs-meta"><span class="hljs-meta">@NamePattern</span></span>(<span class="hljs-string"><span class="hljs-string">"%s|name"</span></span>) <span class="hljs-meta"><span class="hljs-meta">@Table</span></span>(name = <span class="hljs-string"><span class="hljs-string">"PASSPORTNUMBER_PERSON"</span></span>) <span class="hljs-meta"><span class="hljs-meta">@Entity</span></span>(name = <span class="hljs-string"><span class="hljs-string">"passportnumber$Person"</span></span>) <span class="hljs-meta"><span class="hljs-meta">@ValidPassportNumber</span></span>(groups = {Default.class, UiCrossFieldChecks.class}) <span class="hljs-meta"><span class="hljs-meta">@FraudDetectionFlag</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Person</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">StandardEntity</span></span></span><span class="hljs-class"> </span></span>{ ... }</code> </pre> <br><p>  <a href="">Person.java</a> </p><br><p>  L'impl√©mentation de l'√©couteur elle-m√™me ressemble √† ceci: </p><br><pre> <code class="java hljs"><span class="hljs-comment"><span class="hljs-comment">/** * Checks that there are no other persons with the same * passport number and country code * Ignores spaces in the passport number for the check. * So numbers "12 45 768007" and "1245 768007" and "1245768007" * are the same for the validation purposes. */</span></span> <span class="hljs-meta"><span class="hljs-meta">@Component</span></span>(<span class="hljs-string"><span class="hljs-string">"passportnumber_PersonEntityListener"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PersonEntityListener</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BeforeDeleteEntityListener</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Person</span></span></span><span class="hljs-class">&gt;, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BeforeInsertEntityListener</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Person</span></span></span><span class="hljs-class">&gt;, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BeforeUpdateEntityListener</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Person</span></span></span><span class="hljs-class">&gt; </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onBeforeDelete</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Person person, EntityManager entityManager)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!checkPassportIsUnique(person.getPassportNumber(), person.getCountry(), entityManager)) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ValidationException( <span class="hljs-string"><span class="hljs-string">"Passport and country code combination isn't unique"</span></span>); } } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onBeforeInsert</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Person person, EntityManager entityManager)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">// use entity argument to validate the Person object // entityManager could be used to access database // if you need to check the data // throw ValidationException object if validation check failed if (!checkPassportIsUnique(person.getPassportNumber(), person.getCountry(), entityManager)) throw new ValidationException( "Passport and country code combination isn't unique"); } @Override public void onBeforeUpdate(Person person, EntityManager entityManager) { if (!checkPassportIsUnique(person.getPassportNumber(), person.getCountry(), entityManager)) throw new ValidationException( "Passport and country code combination isn't unique"); } ... }</span></span></code> </pre> <br><p>  <a href="">PersonEntityListener.java</a> </p><br><p>  Les auditeurs d'entit√©s sont un excellent choix si: </p><br><ul><li>  Il est n√©cessaire de v√©rifier les donn√©es √† l'int√©rieur de la transaction avant que l'objet entit√© ne soit stock√© dans la base de donn√©es; </li><li>  Il est n√©cessaire de v√©rifier les donn√©es dans la base de donn√©es pendant le processus de validation, par exemple, pour v√©rifier qu'il y a suffisamment de produit en stock pour accepter la commande; </li><li>  Vous devez regarder non seulement l'objet entit√©, tel que <code>Order</code> , mais √©galement les entit√©s li√©es, par exemple, <code>OrderItems</code> pour l'entit√© <code>Order</code> ; </li><li>  Nous voulons suivre les op√©rations d'insertion, de mise √† jour ou de suppression uniquement pour certaines classes d'entit√©s, par exemple, uniquement pour les <code>OrderItem</code> <code>Order</code> et <code>OrderItem</code> , et nous n'avons pas besoin de v√©rifier les changements dans d'autres classes d'entit√©s pendant la transaction. </li></ul><br><h3 id="transaction-listeners">  Auditeurs de transactions </h3><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Les √©couteurs de transaction CUBA</a> agissent √©galement dans le contexte des transactions, mais, par rapport aux √©couteurs d'entit√©, ils sont appel√©s pour chaque transaction de base de donn√©es. </p><br><p>  Cela leur donne un super pouvoir: </p><br><ul><li>  rien ne peut leur √©chapper. </li></ul><br><p>  Mais la m√™me chose est d√©termin√©e par leurs lacunes: </p><br><ul><li>  ils sont plus difficiles √† √©crire; </li><li>  ils peuvent r√©duire consid√©rablement les performances; </li><li>  Ils doivent √™tre √©crits tr√®s attentivement: un bogue dans l'√©couteur de transactions peut interf√©rer m√™me avec le chargement initial de l'application. </li></ul><br><p>  Ainsi, les √©couteurs de transactions sont une bonne solution lorsque vous devez inspecter diff√©rents types d'entit√©s √† l'aide du m√™me algorithme, par exemple, en v√©rifiant toutes les donn√©es pour d√©tecter la fraude informatique avec un seul service qui dessert tous vos objets m√©tier. </p><br><p><img src="https://habrastorage.org/webt/km/v9/co/kmv9cougmokpc3opta_dfk4egqk.jpeg" alt="Tu ne passeras pas!"></p><br><p>  Jetez un ≈ìil √† un exemple qui v√©rifie si l'entit√© a une annotation <code>@FraudDetectionFlag</code> et, le cas √©ch√©ant, d√©marre un d√©tecteur de fraude.  Je r√©p√®te: gardez √† l'esprit que cette m√©thode est appel√©e sur le syst√®me <strong>avant de valider chaque transaction de base de donn√©es</strong> , donc le code doit essayer de v√©rifier le moins d'objets possible. </p><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Component</span></span>(<span class="hljs-string"><span class="hljs-string">"passportnumber_ApplicationTransactionListener"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ApplicationTransactionListener</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BeforeCommitTransactionListener</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Logger log = LoggerFactory.getLogger(ApplicationTransactionListener.class); <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">beforeCommit</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(EntityManager entityManager, Collection&lt;Entity&gt; managedEntities)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (Entity entity : managedEntities) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (entity <span class="hljs-keyword"><span class="hljs-keyword">instanceof</span></span> StandardEntity &amp;&amp; !((StandardEntity) entity).isDeleted() &amp;&amp; entity.getClass().isAnnotationPresent(FraudDetectionFlag.class) &amp;&amp; !fraudDetectorFeedAndFastCheck(entity)) { logFraudDetectionFailure(log, entity); String msg = String.format( <span class="hljs-string"><span class="hljs-string">"Fraud detection failure in '%s' with id = '%s'"</span></span>, entity.getClass().getSimpleName(), entity.getId()); <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ValidationException(msg); } } } ... }</code> </pre> <br><p>  <a href="">ApplicationTransactionListener.java</a> </p><br><p>  Pour devenir un √©couteur de transactions, un bean g√©r√© doit impl√©menter l'interface <code>BeforeCommitTransactionListener</code> et la m√©thode <code>beforeCommit</code> .  Les √©couteurs de transactions se lient automatiquement au d√©marrage de l'application.  CUBA enregistre toutes les classes qui impl√©mentent <code>BeforeCommitTransactionListener</code> ou <code>AfterCompleteTransactionListener</code> comme √©couteurs de transactions. </p><br><h2 id="zaklyuchenie">  Conclusion </h2><br><p>  La validation du bean <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">(JPA 303, 349 et 980)</a> est une approche qui peut servir de base fiable pour 95% des cas de validation de donn√©es rencontr√©s dans un projet d'entreprise.  Le principal avantage de cette approche est que la majeure partie de la logique de validation est concentr√©e directement dans les classes de mod√®le de domaine.  Par cons√©quent, il est facile √† trouver, √† lire et √† entretenir.  Spring, CUBA et de nombreuses autres biblioth√®ques prennent en charge ces normes et effectuent automatiquement des v√©rifications de validation lors de la r√©ception de donn√©es sur la couche d'interface utilisateur, de l'appel de m√©thodes valid√©es ou du stockage de donn√©es via ORM, de sorte que la validation Bean ressemble souvent √† de la magie du point de vue du d√©veloppeur. </p><br><p>  Certains d√©veloppeurs de logiciels consid√®rent que la validation au niveau des classes du mod√®le sujet n'est pas naturelle et trop complexe, ils disent que la validation des donn√©es au niveau de l'interface utilisateur est une strat√©gie assez efficace.  Cependant, je crois que de nombreux points de validation dans les composants et les contr√¥leurs d'interface utilisateur ne sont pas l'approche la plus rationnelle.   ,  ,  ,    ,     ,       listener'        . </p><br><p>  ,  ,     : </p><br><ol><li> <strong>JPA </strong>   ,          ,        DDL. </li><li> <strong>Bean Validation</strong> ‚Äî , , ,             .      ,       . </li><li> <strong>  </strong>  bean validation,    .        , ,   REST. </li><li> <strong>Entity listeners:</strong>      ,   Bean Validation,             . ,         .  Hibernate    . </li><li> <strong>Transaction listeners</strong> ‚Äî ,   ,    .  ,      ,                    . </li></ol><br><p> <em>PS: ,              Java,      ,    ,    .</em> </p><br><hr><br><h2 id="poleznye-ssylki">  Liens utiles </h2><br><div class="spoiler">  <b class="spoiler_title">Texte masqu√©</b> <div class="spoiler_text"><h3 id="standarty-i-ih-realizacii"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Normes et leur mise en ≈ìuvre </font></font></h3><br><ul><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">JSR 303 - Bean Validation 1.0</font></font></a> </li><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">JSR 349 ‚Äã‚Äã- Bean Validation 1.1</font></font></a> </li><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">JSR 349, sp√©cification de validation du bean</font></font></a> </li><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">JSR 380, sp√©cification de validation du bean</font></font></a> </li><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Hibernate Validator 5.4.2 (JSR 349) reference</a> </li><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Hibernate Validator 6.10 (JSR 380) reference</a> </li><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Hibernate Validator main page</a> </li><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Hibernate validator 6.10 API docs</a> </li><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">HV 6.10: Declaring and validating method constraints</a> </li><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">HV 6.10: Cross parameter constraints</a> </li></ul><br><h3 id="biblioteki">  </h3><br><ul><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">CUBA bean validation</a> </li><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Validation cookbook for CUBA applications</a> </li><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">JavaFX with Bean Validation and CDI 2.0</a> </li><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">OVal ‚Äî non a JSR 303, 349, 380 compliant validation framework</a> </li><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Spring, Java Bean Validation Basics</a> </li><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Validation, Data Binding, and Type Conversion in Spring 4.1</a> </li></ul><br><h3 id="filosofiya-validacii-dannyh">    </h3><br><ul><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Form validation best practices</a> </li><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">JavaFX Form Validation</a> </li><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Blah vs Bean Validation: you missed the point like Mars Climate Orbiter</a> </li><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Avoiding Many If Blocks For Validation Checking</a> </li></ul><br><h3 id="materialy-dlya-dalneyshego-chteniya">     </h3><br><ul><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Validation cookbook for CUBA applications</a> </li></ul></div></div></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr427543/">https://habr.com/ru/post/fr427543/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr427533/index.html">Montres intelligentes qui ne n√©cessitent pas de charge. Y en a-t-il beaucoup?</a></li>
<li><a href="../fr427535/index.html">Nous lan√ßons un choix collectif de solutions</a></li>
<li><a href="../fr427537/index.html">Comment devenir un chef de produit performant: des cours o√π vous √™tes form√© en ce moment</a></li>
<li><a href="../fr427539/index.html">La derni√®re fois que l'Europe r√®gle l'heure pour l'hiver</a></li>
<li><a href="../fr427541/index.html">Amazon exhorte Bloomberg √† abandonner les r√©clamations tr√®s m√©diatis√©es dans un article sur les modules de logiciels espions chinois dans les serveurs</a></li>
<li><a href="../fr427545/index.html">Syst√®mes d'information ¬´Atterrissage attendu¬ª pour l'enregistrement du transport a√©rien en Russie</a></li>
<li><a href="../fr427549/index.html">Rapport du Club de Rome 2018, chapitre 1.6: jokers technologiques</a></li>
<li><a href="../fr427551/index.html">Pourquoi ne pouvons-nous pas abandonner le clavier QWERTY</a></li>
<li><a href="../fr427555/index.html">Les animaux que les humains ont appris √† suivre √† l'aide de la technologie de reconnaissance faciale</a></li>
<li><a href="../fr427557/index.html">R√©sum√© des √©v√©nements informatiques en novembre (premi√®re partie)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>