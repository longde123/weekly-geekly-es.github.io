<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👨🏿‍🤝‍👨🏾 🐀 👨🏾‍🔧 Validation dans les applications Java 🔏 🆓 👨🏾</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Ce texte est consacré à différentes approches de la validation des données: sur quels pièges un projet peut-il tomber et quelles méthodes et technolog...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Validation dans les applications Java</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/haulmont/blog/427543/"><p>  <em>Ce texte est consacré à différentes approches de la validation des données: sur quels pièges un projet peut-il tomber et quelles méthodes et technologies doivent être suivies lors de la validation des données dans les applications Java.</em> </p><br><p><img src="https://habrastorage.org/webt/cj/yc/yj/cjycyj3zf_l1ai9ch_vsgzisstk.png" alt="Validation"></p><br><p>  J'ai souvent vu des projets dont les créateurs n'ont pas pris la peine de choisir une approche de validation des données.  Les équipes ont travaillé sur le projet sous une pression incroyable sous la forme de délais et d'exigences vagues, et en conséquence, elles n'ont tout simplement pas eu le temps d'une validation précise et cohérente.  Par conséquent, leur code de validation est dispersé partout: dans les extraits de code Javascript, les contrôleurs d'écran, dans les bacs de logique métier, les entités de domaine, les déclencheurs et les contraintes de base de données.  Ce code était plein de déclarations if-else, il a jeté un tas d'exceptions et a essayé de comprendre où cette donnée particulière est validée là-bas ... En conséquence, au fur et à mesure que le projet se développe, il devient difficile et coûteux de se conformer aux exigences (souvent assez déroutant), et uniformité des approches de validation des données. </p><br><p>  Existe-t-il un moyen simple et élégant de valider les données?  Existe-t-il un moyen qui nous protégera du péché d'illisibilité, un moyen qui réunira toute la logique de validation, et qui a déjà été créé pour nous par les développeurs de frameworks Java populaires? </p><br><p>  Oui, il existe un tel moyen. </p><a name="habracut"></a><br><p>  Pour nous, les développeurs de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">la plateforme CUBA</a> , il est très important que vous utilisiez les meilleures pratiques.  Nous pensons que le code de validation devrait: </p><br><ol><li>  Être réutilisable et suivre le principe DRY; </li><li>  Soyez naturel et compréhensible; </li><li>  Placé là où le développeur s'attend à le voir; </li><li>  Être capable de vérifier les données de différentes sources: interface utilisateur, appels SOAP, REST, etc. </li><li>  Travailler dans un environnement multi-thread sans problèmes; </li><li>  Appelé automatiquement dans l'application, sans qu'il soit nécessaire d'exécuter des vérifications manuellement; </li><li>  Pour donner à l'utilisateur des messages clairs et localisés dans des boîtes de dialogue concises; </li><li>  Suivez les normes. </li></ol><br><p>  Voyons comment cela peut être implémenté à l'aide d'un exemple d'application écrit à l'aide du cadre de la plateforme CUBA.  Cependant, puisque CUBA est basé sur Spring et EclipseLink, la plupart des techniques utilisées ici fonctionneront sur toute autre plate-forme Java prenant en charge les spécifications JPA et Bean Validation. </p><br><h2 id="validaciya-s-ispolzovaniem-database-constraints">  Validation à l'aide de contraintes de base de données </h2><br><p> La façon la plus courante et la plus évidente de valider les données est peut-être d'utiliser des restrictions au niveau de la base de données, par exemple, l'indicateur requis (pour les champs dont la valeur ne peut pas être vide), la longueur de la chaîne, les index uniques, etc.  Cette méthode convient le mieux aux applications d'entreprise, car ce type de logiciel est généralement strictement axé sur le traitement des données.  Cependant, même ici, les développeurs font souvent des erreurs en fixant des limites séparément pour chaque niveau de l'application.  Le plus souvent, la raison réside dans la répartition des responsabilités entre les développeurs. </p><br><p>  Prenons un exemple que la plupart d'entre nous connaissent, certains même d'après notre propre expérience ... Si la spécification indique qu'il devrait y avoir 10 caractères dans le champ du numéro de passeport, il est très probable que cela sera vérifié par tout le monde: un architecte DB en DDL, un développeur backend dans l'entité correspondante et Services REST, et enfin, le développeur de l'interface utilisateur directement sur le côté client.  Ensuite, cette exigence change et le champ passe à 15 caractères.  Les Devops modifient les valeurs des contraintes dans la base de données, mais rien ne change pour l'utilisateur, car côté client la restriction est la même ... </p><br><p>  Tout développeur sait comment éviter ce problème - la validation doit être centralisée!  Dans CUBA, une telle validation se trouve dans les annotations d'entité JPA.  Sur la base de ces méta-informations, CUBA Studio va générer le script DDL correct et appliquer les validateurs côté client appropriés. </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/118/a16/f17/118a16f1705740a1676eb2c0ea164ef4.png" alt="Exemple de contraintes"></p><br><p>  Si les annotations changent, CUBA mettra à jour les scripts DDL et générera les scripts de migration, de sorte que la prochaine fois que vous déploierez le projet, de nouvelles restrictions basées sur JPA entreront en vigueur à la fois dans l'interface et dans la base de données d'application. </p><br><p> Malgré la simplicité et l'implémentation au niveau de la base de données, ce qui donne une fiabilité absolue à cette méthode, la portée des annotations JPA est limitée aux cas les plus simples qui peuvent être exprimés dans la norme DDL et n'incluent pas les déclencheurs de base de données ou les procédures stockées.  Ainsi, les contraintes basées sur JPA peuvent rendre un champ d'entité unique ou obligatoire ou définir une longueur de colonne maximale.  Vous pouvez même définir une restriction unique sur la combinaison de colonnes à l'aide de l'annotation <code>@UniqueConstraint</code> .  Mais c'est probablement tout. </p><br><p>  Quoi qu'il en soit, dans les cas nécessitant une logique de validation plus complexe, comme la vérification d'une valeur minimale / maximale dans un champ, la validation avec une expression régulière ou la réalisation d'une vérification personnalisée spécifique à votre application uniquement, l'approche connue sous le nom de <strong>«validation de bean»</strong> est appliquée. . </p><br><h2 id="bean-validation">  Validation du bean </h2><br><p>  Tout le monde sait que c'est une bonne pratique de suivre des normes qui ont un long cycle de vie, dont l'efficacité a été prouvée sur des milliers de projets.  Java Bean Validation est une approche documentée dans <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">JSR 380, 349 et 303</a> et leurs applications: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Hibernate Validator</a> et <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Apache BVal</a> . </p><br><p>  Bien que cette approche soit familière à de nombreux développeurs, elle est souvent sous-estimée.  C'est un moyen facile d'intégrer la validation des données même dans les projets hérités, qui vous permet de créer des validations de manière claire, simple, fiable et aussi proche que possible de la logique métier. </p><br><p>  L'utilisation de Bean Validation offre au projet de nombreux avantages: </p><br><ul><li>  La logique de validation se situe à côté du domaine: la définition des restrictions pour les champs et les méthodes du bac se fait de manière naturelle et véritablement orientée objet. </li><li>  La norme de validation de bean nous donne des dizaines d' <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">annotations</a> de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">validation dès la sortie de la boîte</a> , par exemple: <code>@NotNull</code> , <code>@Size</code> , <code>@Min</code> , <code>@Max</code> , <code>@Pattern</code> , <code>@Email</code> , <code>@Past</code> , pas tout à fait standard <code>@URL</code> , <code>@Length</code> , le <code>@Length</code> le plus puissant et bien d'autres encore . </li><li>  La norme ne nous limite pas aux annotations toutes faites et nous permet de créer les nôtres.  Nous pouvons également créer une nouvelle annotation en combinant plusieurs autres, ou la définir en utilisant une classe Java distincte comme validateur. <br>  Par exemple, dans l'exemple ci-dessus, nous pouvons définir l'annotation de niveau de la classe <code>@ValidPassportNumber</code> pour vérifier que le numéro de passeport correspond au format en fonction de la valeur du champ <code>country</code> . </li><li>  Les contraintes peuvent être définies non seulement sur des champs ou des classes, mais également sur des méthodes et leurs paramètres.  Cette approche est appelée <strong>«validation par contrat»</strong> et sera discutée un peu plus loin. </li></ul><br><p>  Lorsque l'utilisateur soumet les informations saisies, la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">plate-forme CUBA</a> <em>(comme certains autres cadres)</em> démarre automatiquement la validation du bean, de sorte qu'elle affiche instantanément un message d'erreur si la validation échoue, et nous n'avons pas besoin d'exécuter les validateurs de bac manuellement. </p><br><p>  Revenons à l'exemple avec le numéro de passeport, mais cette fois nous allons le compléter avec plusieurs restrictions de l'entité Personne: </p><br><ul><li>  Le champ du <code>name</code> doit contenir au moins 2 caractères et doit être valide.  (Comme vous pouvez le voir, l'expression rationnelle n'est pas simple, mais "Charles Ogier de Batz de Castelmore Comte d'Artagnan" passera le test, mais "R2D2" ne le sera pas); </li><li>  <code>height</code> (hauteur) doit être dans l'intervalle suivant: <code>0 &lt; height &lt;= 300</code> cm; </li><li>  Le champ de l' <code>email</code> doit contenir une chaîne qui correspond au format de l'e-mail correct. </li></ul><br><p>  Avec toutes ces vérifications, la classe Person ressemblera à ceci: </p><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Listeners</span></span>(<span class="hljs-string"><span class="hljs-string">"passportnumber_PersonEntityListener"</span></span>) <span class="hljs-meta"><span class="hljs-meta">@NamePattern</span></span>(<span class="hljs-string"><span class="hljs-string">"%s|name"</span></span>) <span class="hljs-meta"><span class="hljs-meta">@Table</span></span>(name = <span class="hljs-string"><span class="hljs-string">"PASSPORTNUMBER_PERSON"</span></span>) <span class="hljs-meta"><span class="hljs-meta">@Entity</span></span>(name = <span class="hljs-string"><span class="hljs-string">"passportnumber$Person"</span></span>) <span class="hljs-meta"><span class="hljs-meta">@ValidPassportNumber</span></span>(groups = {Default.class, UiCrossFieldChecks.class}) <span class="hljs-meta"><span class="hljs-meta">@FraudDetectionFlag</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Person</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">StandardEntity</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> serialVersionUID = -<span class="hljs-number"><span class="hljs-number">9150857881422152651L</span></span>; <span class="hljs-meta"><span class="hljs-meta">@Pattern</span></span>(message = <span class="hljs-string"><span class="hljs-string">"Bad formed person name: ${validatedValue}"</span></span>, regexp = <span class="hljs-string"><span class="hljs-string">"^[AZ][az]*(\\s(([az]{1,3})|(([az]+\\')?[AZ][az]*)))*$"</span></span>) <span class="hljs-meta"><span class="hljs-meta">@Length</span></span>(min = <span class="hljs-number"><span class="hljs-number">2</span></span>) <span class="hljs-meta"><span class="hljs-meta">@NotNull</span></span> <span class="hljs-meta"><span class="hljs-meta">@Column</span></span>(name = <span class="hljs-string"><span class="hljs-string">"NAME"</span></span>, nullable = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> String name; <span class="hljs-meta"><span class="hljs-meta">@Email</span></span>(message = <span class="hljs-string"><span class="hljs-string">"Email address has invalid format: ${validatedValue}"</span></span>, regexp = <span class="hljs-string"><span class="hljs-string">"^[a-zA-Z0-9_.+-]+@[a-zA-Z0-9-]+\\.[a-zA-Z0-9-.]+$"</span></span>) <span class="hljs-meta"><span class="hljs-meta">@Column</span></span>(name = <span class="hljs-string"><span class="hljs-string">"EMAIL"</span></span>, length = <span class="hljs-number"><span class="hljs-number">120</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> String email; <span class="hljs-meta"><span class="hljs-meta">@DecimalMax</span></span>(message = <span class="hljs-string"><span class="hljs-string">"Person height can not exceed 300 centimeters"</span></span>, value = <span class="hljs-string"><span class="hljs-string">"300"</span></span>) <span class="hljs-meta"><span class="hljs-meta">@DecimalMin</span></span>(message = <span class="hljs-string"><span class="hljs-string">"Person height should be positive"</span></span>, value = <span class="hljs-string"><span class="hljs-string">"0"</span></span>, inclusive = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>) <span class="hljs-meta"><span class="hljs-meta">@Column</span></span>(name = <span class="hljs-string"><span class="hljs-string">"HEIGHT"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> BigDecimal height; <span class="hljs-meta"><span class="hljs-meta">@NotNull</span></span> <span class="hljs-meta"><span class="hljs-meta">@Column</span></span>(name = <span class="hljs-string"><span class="hljs-string">"COUNTRY"</span></span>, nullable = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> Integer country; <span class="hljs-meta"><span class="hljs-meta">@NotNull</span></span> <span class="hljs-meta"><span class="hljs-meta">@Column</span></span>(name = <span class="hljs-string"><span class="hljs-string">"PASSPORT_NUMBER"</span></span>, nullable = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>, length = <span class="hljs-number"><span class="hljs-number">15</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> String passportNumber; ... }</code> </pre> <br><p>  <a href="">Person.java</a> </p><br><p>  Je pense que l'utilisation d'annotations telles que <code>@NotNull</code> , <code>@DecimalMin</code> , <code>@Length</code> , <code>@Pattern</code> et similaires est assez évidente et ne nécessite aucun commentaire.  Examinons de plus près l'implémentation de l'annotation <code>@ValidPassportNumber</code> . </p><br><p>  Notre tout nouveau <code>@ValidPassportNumber</code> vérifie que <code>Person#passportNumber</code> correspond au modèle d'expression régulière pour chaque pays spécifié par le champ <code>Person#country</code> . </p><br><p>  Tout d'abord, regardons la documentation (les manuels <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">CUBA</a> ou <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Hibernate</a> sont très bien), selon elle, nous devons marquer notre classe avec cette nouvelle annotation et lui passer le paramètre <code>groups</code> , où <code>UiCrossFieldChecks.class</code> signifie que cette validation doit être exécutée au niveau croisé. validations - après avoir vérifié tous les champs individuels, et <code>Default.class</code> enregistre la restriction dans le groupe de validation par défaut. </p><br><p>  La description de l'annotation ressemble à ceci: </p><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Target</span></span>(ElementType.TYPE) <span class="hljs-meta"><span class="hljs-meta">@Retention</span></span>(RetentionPolicy.RUNTIME) <span class="hljs-meta"><span class="hljs-meta">@Constraint</span></span>(validatedBy = ValidPassportNumberValidator.class) <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-meta"><span class="hljs-meta">@interface</span></span> ValidPassportNumber { <span class="hljs-function"><span class="hljs-function">String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">message</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">default</span></span></span><span class="hljs-function"> "Passport number is not valid"</span></span>; Class&lt;?&gt;[] groups() <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> {}; Class&lt;? extends Payload&gt;[] payload() <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> {}; }</code> </pre> <br><p>  <a href="">ValidPassportNumber.java</a> </p><br><p>  Ici, <code>@Target(ElementType.TYPE)</code> indique que le but de cette annotation d'exécution est la classe, et <code>@Constraint(validatedBy = … )</code> détermine que la validation est effectuée par la classe <code>ValidPassportNumberValidator</code> qui implémente l'interface <code>ConstraintValidator&lt;...&gt;</code> .  Le code de validation lui-même se trouve dans la <code>isValid(...)</code> , qui effectue la vérification proprement dite de manière assez simple: </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ValidPassportNumberValidator</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ConstraintValidator</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ValidPassportNumber</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Person</span></span></span><span class="hljs-class">&gt; </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">initialize</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ValidPassportNumber constraint)</span></span></span><span class="hljs-function"> </span></span>{ } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">isValid</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Person person, ConstraintValidatorContext context)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (person == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (person.country == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span> || person.passportNumber == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> doPassportNumberFormatCheck(person.getCountry(), person.getPassportNumber()); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">doPassportNumberFormatCheck</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(CountryCode country, String passportNumber)</span></span></span><span class="hljs-function"> </span></span>{ ... } }</code> </pre> <br><p>  <a href="">ValidPassportNumberValidator.java</a> </p><br><p>  C’est tout.  Avec la plateforme CUBA, nous n'avons pas besoin d'écrire autre chose qu'une ligne de code qui fera fonctionner notre validation personnalisée et donnera des messages d'erreur à l'utilisateur. <br>  Rien de compliqué, non? </p><br><p>  Voyons maintenant comment tout cela fonctionne.  Ici, CUBA a d'autres nishtyaki: il montre non seulement à l'utilisateur un message d'erreur, mais met également en évidence dans les champs rouges qui n'ont pas passé la validation du bean: </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/310/83d/b2b/31083db2b14d67d88de169542b59748a.png" alt="Représentation de l'interface utilisateur"></p><br><p>  N'est-ce pas une solution élégante?  Vous obtenez un affichage adéquat des erreurs de validation dans l'interface utilisateur en ajoutant seulement quelques annotations Java aux entités du domaine. </p><br><p>  Pour résumer la section, énumérons brièvement les avantages de la validation du bean pour les entités: </p><br><ol><li>  C'est compréhensible et lisible; </li><li>  Vous permet de définir des contraintes de valeur directement dans les classes d'entités; </li><li>  Il peut être personnalisé et complété; </li><li>  Intégré dans les ORM populaires, et les vérifications sont exécutées automatiquement avant que les modifications ne soient enregistrées dans la base de données; </li><li>  Certains frameworks exécutent également la validation du bean automatiquement lorsque l'utilisateur envoie des données à l'interface utilisateur (et sinon, il est facile d'appeler manuellement l'interface <code>Validator</code> ); </li><li>  Bean Validation est une norme reconnue et regorge de documentation sur Internet. </li></ol><br><p>  Mais que faire si vous devez définir une restriction sur une méthode, un constructeur ou une adresse REST pour valider les données provenant d'un système externe?  Ou si vous devez vérifier de manière déclarative les valeurs des paramètres de la méthode, sans écrire de code ennuyeux avec de nombreuses conditions if-else dans chaque méthode testée? </p><br><p>  La réponse est simple: la validation du bean s'applique également aux méthodes! </p><br><h2 id="validation-by-contract">  Validation par contrat </h2><br><p>  Il faut parfois dépasser la validation de l'état du modèle de données.  De nombreuses méthodes peuvent bénéficier de la validation automatique des paramètres et de la valeur de retour.  Cela peut être nécessaire non seulement pour vérifier les données allant aux adresses REST ou SOAP, mais aussi dans les cas où nous voulons noter les conditions préalables et postconditions des appels de méthode pour nous assurer que les données entrées ont été vérifiées avant l'exécution du corps de la méthode ou que la valeur de retour est dans la plage attendue, ou par exemple, nous avons juste besoin de décrire de manière déclarative les plages de valeurs des paramètres d'entrée pour améliorer la lisibilité du code. </p><br><p>  En utilisant la validation du bean, des restrictions peuvent être appliquées aux paramètres d'entrée et aux valeurs de retour des méthodes et constructeurs pour vérifier les conditions préalables et postconditions de leurs appels dans n'importe quelle classe Java.  Ce chemin présente plusieurs avantages par rapport aux méthodes traditionnelles de vérification de la validité des paramètres et des valeurs de retour: </p><br><ol><li>  Il n'est pas nécessaire d'effectuer des vérifications manuellement dans un style impératif (par exemple, en lançant <code>IllegalArgumentException</code> , etc.).  Vous pouvez définir des contraintes de manière déclarative et rendre le code plus compréhensible et expressif; </li><li>  Les contraintes peuvent être configurées, réutilisées et configurées: vous n'avez pas besoin d'écrire de logique de validation pour chaque vérification.  Moins de code signifie moins de bugs. </li><li>  Si la classe, la valeur de retour de la méthode ou son paramètre est marqué avec l'annotation <code>@Validated</code> , les vérifications seront automatiquement effectuées par la plateforme à chaque appel de la méthode. </li><li>  Si l'exécutable est marqué avec l'annotation <code>@Documented</code> , ses pré et postconditions seront incluses dans le JavaDoc généré. </li></ol><br><p>  En utilisant la <strong>«validation de contrat»,</strong> nous obtenons un code clair, compact et facile à maintenir. </p><br><p>  Pour un exemple, regardons l'interface du contrôleur REST d'une application CUBA.  L'interface <code>PersonApiService</code> vous permet d'obtenir une liste de personnes à partir de la base de données à l'aide de la méthode <code>getPersons()</code> et d'ajouter une nouvelle personne à l'aide de l' <code>addNewPerson(...)</code> . </p><br><p>  Et n'oubliez pas que la validation du bean est héritée!  En d'autres termes, si nous annotons une certaine classe, ou champ, ou méthode, toutes les classes qui héritent de cette classe ou implémentent cette interface seront soumises à la même annotation de validation. </p><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Validated</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PersonApiService</span></span></span><span class="hljs-class"> </span></span>{ String NAME = <span class="hljs-string"><span class="hljs-string">"passportnumber_PersonApiService"</span></span>; <span class="hljs-meta"><span class="hljs-meta">@NotNull</span></span> <span class="hljs-meta"><span class="hljs-meta">@Valid</span></span> <span class="hljs-meta"><span class="hljs-meta">@RequiredView</span></span>(<span class="hljs-string"><span class="hljs-string">"_local"</span></span>) <span class="hljs-function"><span class="hljs-function">List&lt;Person&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getPersons</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">addNewPerson</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( @NotNull @Length(min = </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">2</span></span></span></span><span class="hljs-function"><span class="hljs-params">, max = </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">255</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> @</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Pattern</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(message = </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"Bad formed person name: ${validatedValue}"</span></span></span></span><span class="hljs-function"><span class="hljs-params">, regexp = </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"^[AZ][az]*(\\s(([az]{1,3})|(([az]+\\')?[AZ][az]*)))*$"</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> String name, @</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">DecimalMax</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(message = </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"Person height can not exceed 300 cm"</span></span></span></span><span class="hljs-function"><span class="hljs-params">, value = </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"300"</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> @</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">DecimalMin</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(message = </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"Person height should be positive"</span></span></span></span><span class="hljs-function"><span class="hljs-params">, value = </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"0"</span></span></span></span><span class="hljs-function"><span class="hljs-params">, inclusive = </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">false</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> BigDecimal height, @NotNull CountryCode country, @NotNull String passportNumber )</span></span>; }</code> </pre> <br><p>  <a href="">PersonApiService.java</a> </p><br><p>  Ce morceau de code est-il suffisamment clair? <br>  _ (À l'exception de l'annotation <code>@RequiredView(“_local”)</code> , qui est spécifique à la plate-forme CUBA et vérifie que l'objet <code>Person</code> retourné contient tous les champs de la table <code>PASSPORTNUMBER_PERSON</code> ) ._ </p><br><p>  L' <code>@Valid</code> définit que chaque objet de collection retourné par la méthode <code>getPersons()</code> doit également être validé par rapport aux restrictions de la classe <code>Person</code> . </p><br><p>  Dans une application CUBA, ces méthodes sont disponibles aux adresses suivantes: </p><br><ul><li>  / app / rest / v2 / services / passportnumber_PersonApiService / getPersons </li><li>  / app / rest / v2 / services / passportnumber_PersonApiService / addNewPerson </li></ul><br><p>  Ouvrons l'application Postman et assurons-nous que la validation fonctionne comme il se doit: </p><br><p><img src="https://habrastorage.org/webt/qg/ra/qj/qgraqjsxfyeqqa6qcjf2pkf7tcq.png" alt="Postman app"></p><br><p>  Comme vous l'avez peut-être remarqué, le numéro de passeport n'est pas validé dans l'exemple ci-dessus.  En effet, ce champ nécessite une vérification croisée des paramètres de la méthode <code>addNewPerson</code> , car le choix d'un modèle d'expression régulière pour valider <code>passportNumber</code> dépend de la valeur du champ <code>country</code> .  Cette validation croisée est un analogue complet des restrictions d'entité au niveau de la classe! </p><br><p>  La validation croisée des paramètres est prise en charge par JSR 349 ​​et 380. Vous pouvez lire la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">documentation de mise en veille prolongée</a> pour savoir comment implémenter votre propre validation croisée des méthodes de classe / interface. </p><br><h2 id="za-predelami-bean-validation">  Validation du bean extérieur </h2><br><p>  Il n'y a pas de perfection dans le monde, la validation du bean a donc ses inconvénients et ses limites: </p><br><ol><li>  Parfois, il suffit de vérifier l'état d'un graphe complexe d'objets avant d'enregistrer les modifications dans la base de données.  Par exemple, vous devez vous assurer que tous les éléments d'une commande client sont placés dans un seul colis.  C'est une opération assez difficile, et la réaliser à chaque fois que l'utilisateur ajoute de nouveaux articles à la commande n'est pas une bonne idée.  Par conséquent, une telle vérification peut être nécessaire une seule fois: avant d'enregistrer l'objet <code>Order</code> et ses sous-objets <code>OrderItem</code> dans la base de données. </li><li>  Certains contrôles doivent être effectués à l'intérieur d'une transaction.  Par exemple, le système de magasin électronique doit vérifier s'il y a suffisamment de copies des marchandises pour exécuter la commande avant de les enregistrer dans la base de données.  Un tel contrôle ne peut être effectué qu'à l'intérieur d'une transaction, car  Le système est multithread et la quantité de marchandises en stock peut changer à tout moment. </li></ol><br><p>  La plateforme CUBA propose deux mécanismes de validation des données avant validation appelés <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">écouteurs d'entité</a> et <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">écouteurs de transaction</a> .  Examinons-les plus en détail. </p><br><h3 id="entity-listemers">  Listeurs d'entités </h3><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Les écouteurs d'entité dans CUBA sont</a> très similaires aux <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><code>PreInsertEvent</code> , <code>PreUpdateEvent</code> et <code>PredDeleteEvent</code></a> que JPA propose au développeur.  Les deux mécanismes vous permettent de vérifier les objets d'entité avant et après leur stockage dans la base de données. </p><br><p>  Dans CUBA, il est facile de créer et de connecter un écouteur d'entité, pour cela, vous avez besoin de deux choses: </p><br><ol><li>  Créez un bean géré qui implémente l'une des interfaces d'écoute d'entité.  3 interfaces sont importantes pour la validation: <br>  <code>BeforeDeleteEntityListener&lt;T&gt;</code> , <br>  <code>BeforeInsertEntityListener&lt;T&gt;</code> , <br> <code>BeforeUpdateEntityListener&lt;T&gt;</code> </li> <li>  Ajoutez l'annotation <code>@Listeners</code> à l'objet entité que vous prévoyez de suivre. </li></ol><br><p>  Et c'est tout. </p><br><p>  Par rapport à la norme JPA (JSR 338, section 3.5), les interfaces d'écoute de la plateforme CUBA sont typées, vous n'avez donc pas besoin de convertir un argument avec un type d' <code>Object</code> un type d'entité pour commencer à travailler avec lui.  La plate-forme CUBA ajoute des entités liées ou des appelants EntityManager la possibilité de charger et de modifier d'autres entités.  Toutes ces modifications invoqueront également l'écouteur d'entité correspondant. </p><br><p>  La plate-forme CUBA prend également en charge la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">«suppression logicielle»</a> , une approche où au lieu de supprimer réellement les enregistrements de la base de données, ils sont uniquement marqués comme supprimés et deviennent inaccessibles pour une utilisation normale.  Ainsi, pour la suppression <code>BeforeDeleteEntityListener</code> , la plate-forme appelle les <code>BeforeDeleteEntityListener</code> / <code>AfterDeleteEntityListener</code> , tandis que les implémentations standard appellent les <code>PreUpdate</code> / <code>PostUpdate</code> . </p><br><p>  Regardons un exemple.  Ici, le bean <code>@Listeners</code> événement se connecte à la classe d'entité avec une seule ligne de code: l'annotation <code>@Listeners</code> , qui prend le nom de la classe d'écoute: </p><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Listeners</span></span>(<span class="hljs-string"><span class="hljs-string">"passportnumber_PersonEntityListener"</span></span>) <span class="hljs-meta"><span class="hljs-meta">@NamePattern</span></span>(<span class="hljs-string"><span class="hljs-string">"%s|name"</span></span>) <span class="hljs-meta"><span class="hljs-meta">@Table</span></span>(name = <span class="hljs-string"><span class="hljs-string">"PASSPORTNUMBER_PERSON"</span></span>) <span class="hljs-meta"><span class="hljs-meta">@Entity</span></span>(name = <span class="hljs-string"><span class="hljs-string">"passportnumber$Person"</span></span>) <span class="hljs-meta"><span class="hljs-meta">@ValidPassportNumber</span></span>(groups = {Default.class, UiCrossFieldChecks.class}) <span class="hljs-meta"><span class="hljs-meta">@FraudDetectionFlag</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Person</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">StandardEntity</span></span></span><span class="hljs-class"> </span></span>{ ... }</code> </pre> <br><p>  <a href="">Person.java</a> </p><br><p>  L'implémentation de l'écouteur elle-même ressemble à ceci: </p><br><pre> <code class="java hljs"><span class="hljs-comment"><span class="hljs-comment">/** * Checks that there are no other persons with the same * passport number and country code * Ignores spaces in the passport number for the check. * So numbers "12 45 768007" and "1245 768007" and "1245768007" * are the same for the validation purposes. */</span></span> <span class="hljs-meta"><span class="hljs-meta">@Component</span></span>(<span class="hljs-string"><span class="hljs-string">"passportnumber_PersonEntityListener"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PersonEntityListener</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BeforeDeleteEntityListener</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Person</span></span></span><span class="hljs-class">&gt;, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BeforeInsertEntityListener</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Person</span></span></span><span class="hljs-class">&gt;, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BeforeUpdateEntityListener</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Person</span></span></span><span class="hljs-class">&gt; </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onBeforeDelete</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Person person, EntityManager entityManager)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!checkPassportIsUnique(person.getPassportNumber(), person.getCountry(), entityManager)) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ValidationException( <span class="hljs-string"><span class="hljs-string">"Passport and country code combination isn't unique"</span></span>); } } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onBeforeInsert</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Person person, EntityManager entityManager)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">// use entity argument to validate the Person object // entityManager could be used to access database // if you need to check the data // throw ValidationException object if validation check failed if (!checkPassportIsUnique(person.getPassportNumber(), person.getCountry(), entityManager)) throw new ValidationException( "Passport and country code combination isn't unique"); } @Override public void onBeforeUpdate(Person person, EntityManager entityManager) { if (!checkPassportIsUnique(person.getPassportNumber(), person.getCountry(), entityManager)) throw new ValidationException( "Passport and country code combination isn't unique"); } ... }</span></span></code> </pre> <br><p>  <a href="">PersonEntityListener.java</a> </p><br><p>  Les auditeurs d'entités sont un excellent choix si: </p><br><ul><li>  Il est nécessaire de vérifier les données à l'intérieur de la transaction avant que l'objet entité ne soit stocké dans la base de données; </li><li>  Il est nécessaire de vérifier les données dans la base de données pendant le processus de validation, par exemple, pour vérifier qu'il y a suffisamment de produit en stock pour accepter la commande; </li><li>  Vous devez regarder non seulement l'objet entité, tel que <code>Order</code> , mais également les entités liées, par exemple, <code>OrderItems</code> pour l'entité <code>Order</code> ; </li><li>  Nous voulons suivre les opérations d'insertion, de mise à jour ou de suppression uniquement pour certaines classes d'entités, par exemple, uniquement pour les <code>OrderItem</code> <code>Order</code> et <code>OrderItem</code> , et nous n'avons pas besoin de vérifier les changements dans d'autres classes d'entités pendant la transaction. </li></ul><br><h3 id="transaction-listeners">  Auditeurs de transactions </h3><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Les écouteurs de transaction CUBA</a> agissent également dans le contexte des transactions, mais, par rapport aux écouteurs d'entité, ils sont appelés pour chaque transaction de base de données. </p><br><p>  Cela leur donne un super pouvoir: </p><br><ul><li>  rien ne peut leur échapper. </li></ul><br><p>  Mais la même chose est déterminée par leurs lacunes: </p><br><ul><li>  ils sont plus difficiles à écrire; </li><li>  ils peuvent réduire considérablement les performances; </li><li>  Ils doivent être écrits très attentivement: un bogue dans l'écouteur de transactions peut interférer même avec le chargement initial de l'application. </li></ul><br><p>  Ainsi, les écouteurs de transactions sont une bonne solution lorsque vous devez inspecter différents types d'entités à l'aide du même algorithme, par exemple, en vérifiant toutes les données pour détecter la fraude informatique avec un seul service qui dessert tous vos objets métier. </p><br><p><img src="https://habrastorage.org/webt/km/v9/co/kmv9cougmokpc3opta_dfk4egqk.jpeg" alt="Tu ne passeras pas!"></p><br><p>  Jetez un œil à un exemple qui vérifie si l'entité a une annotation <code>@FraudDetectionFlag</code> et, le cas échéant, démarre un détecteur de fraude.  Je répète: gardez à l'esprit que cette méthode est appelée sur le système <strong>avant de valider chaque transaction de base de données</strong> , donc le code doit essayer de vérifier le moins d'objets possible. </p><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Component</span></span>(<span class="hljs-string"><span class="hljs-string">"passportnumber_ApplicationTransactionListener"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ApplicationTransactionListener</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BeforeCommitTransactionListener</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Logger log = LoggerFactory.getLogger(ApplicationTransactionListener.class); <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">beforeCommit</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(EntityManager entityManager, Collection&lt;Entity&gt; managedEntities)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (Entity entity : managedEntities) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (entity <span class="hljs-keyword"><span class="hljs-keyword">instanceof</span></span> StandardEntity &amp;&amp; !((StandardEntity) entity).isDeleted() &amp;&amp; entity.getClass().isAnnotationPresent(FraudDetectionFlag.class) &amp;&amp; !fraudDetectorFeedAndFastCheck(entity)) { logFraudDetectionFailure(log, entity); String msg = String.format( <span class="hljs-string"><span class="hljs-string">"Fraud detection failure in '%s' with id = '%s'"</span></span>, entity.getClass().getSimpleName(), entity.getId()); <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ValidationException(msg); } } } ... }</code> </pre> <br><p>  <a href="">ApplicationTransactionListener.java</a> </p><br><p>  Pour devenir un écouteur de transactions, un bean géré doit implémenter l'interface <code>BeforeCommitTransactionListener</code> et la méthode <code>beforeCommit</code> .  Les écouteurs de transactions se lient automatiquement au démarrage de l'application.  CUBA enregistre toutes les classes qui implémentent <code>BeforeCommitTransactionListener</code> ou <code>AfterCompleteTransactionListener</code> comme écouteurs de transactions. </p><br><h2 id="zaklyuchenie">  Conclusion </h2><br><p>  La validation du bean <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">(JPA 303, 349 et 980)</a> est une approche qui peut servir de base fiable pour 95% des cas de validation de données rencontrés dans un projet d'entreprise.  Le principal avantage de cette approche est que la majeure partie de la logique de validation est concentrée directement dans les classes de modèle de domaine.  Par conséquent, il est facile à trouver, à lire et à entretenir.  Spring, CUBA et de nombreuses autres bibliothèques prennent en charge ces normes et effectuent automatiquement des vérifications de validation lors de la réception de données sur la couche d'interface utilisateur, de l'appel de méthodes validées ou du stockage de données via ORM, de sorte que la validation Bean ressemble souvent à de la magie du point de vue du développeur. </p><br><p>  Certains développeurs de logiciels considèrent que la validation au niveau des classes du modèle sujet n'est pas naturelle et trop complexe, ils disent que la validation des données au niveau de l'interface utilisateur est une stratégie assez efficace.  Cependant, je crois que de nombreux points de validation dans les composants et les contrôleurs d'interface utilisateur ne sont pas l'approche la plus rationnelle.   ,  ,  ,    ,     ,       listener'        . </p><br><p>  ,  ,     : </p><br><ol><li> <strong>JPA </strong>   ,          ,        DDL. </li><li> <strong>Bean Validation</strong> — , , ,             .      ,       . </li><li> <strong>  </strong>  bean validation,    .        , ,   REST. </li><li> <strong>Entity listeners:</strong>      ,   Bean Validation,             . ,         .  Hibernate    . </li><li> <strong>Transaction listeners</strong> — ,   ,    .  ,      ,                    . </li></ol><br><p> <em>PS: ,              Java,      ,    ,    .</em> </p><br><hr><br><h2 id="poleznye-ssylki">  Liens utiles </h2><br><div class="spoiler">  <b class="spoiler_title">Texte masqué</b> <div class="spoiler_text"><h3 id="standarty-i-ih-realizacii"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Normes et leur mise en œuvre </font></font></h3><br><ul><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">JSR 303 - Bean Validation 1.0</font></font></a> </li><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">JSR 349 ​​- Bean Validation 1.1</font></font></a> </li><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">JSR 349, spécification de validation du bean</font></font></a> </li><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">JSR 380, spécification de validation du bean</font></font></a> </li><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Hibernate Validator 5.4.2 (JSR 349) reference</a> </li><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Hibernate Validator 6.10 (JSR 380) reference</a> </li><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Hibernate Validator main page</a> </li><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Hibernate validator 6.10 API docs</a> </li><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">HV 6.10: Declaring and validating method constraints</a> </li><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">HV 6.10: Cross parameter constraints</a> </li></ul><br><h3 id="biblioteki">  </h3><br><ul><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">CUBA bean validation</a> </li><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Validation cookbook for CUBA applications</a> </li><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">JavaFX with Bean Validation and CDI 2.0</a> </li><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">OVal — non a JSR 303, 349, 380 compliant validation framework</a> </li><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Spring, Java Bean Validation Basics</a> </li><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Validation, Data Binding, and Type Conversion in Spring 4.1</a> </li></ul><br><h3 id="filosofiya-validacii-dannyh">    </h3><br><ul><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Form validation best practices</a> </li><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">JavaFX Form Validation</a> </li><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Blah vs Bean Validation: you missed the point like Mars Climate Orbiter</a> </li><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Avoiding Many If Blocks For Validation Checking</a> </li></ul><br><h3 id="materialy-dlya-dalneyshego-chteniya">     </h3><br><ul><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Validation cookbook for CUBA applications</a> </li></ul></div></div></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr427543/">https://habr.com/ru/post/fr427543/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr427533/index.html">Montres intelligentes qui ne nécessitent pas de charge. Y en a-t-il beaucoup?</a></li>
<li><a href="../fr427535/index.html">Nous lançons un choix collectif de solutions</a></li>
<li><a href="../fr427537/index.html">Comment devenir un chef de produit performant: des cours où vous êtes formé en ce moment</a></li>
<li><a href="../fr427539/index.html">La dernière fois que l'Europe règle l'heure pour l'hiver</a></li>
<li><a href="../fr427541/index.html">Amazon exhorte Bloomberg à abandonner les réclamations très médiatisées dans un article sur les modules de logiciels espions chinois dans les serveurs</a></li>
<li><a href="../fr427545/index.html">Systèmes d'information «Atterrissage attendu» pour l'enregistrement du transport aérien en Russie</a></li>
<li><a href="../fr427549/index.html">Rapport du Club de Rome 2018, chapitre 1.6: jokers technologiques</a></li>
<li><a href="../fr427551/index.html">Pourquoi ne pouvons-nous pas abandonner le clavier QWERTY</a></li>
<li><a href="../fr427555/index.html">Les animaux que les humains ont appris à suivre à l'aide de la technologie de reconnaissance faciale</a></li>
<li><a href="../fr427557/index.html">Résumé des événements informatiques en novembre (première partie)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>