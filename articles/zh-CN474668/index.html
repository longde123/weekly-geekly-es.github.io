<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🏣 ❤️ 👩🏼‍🏭 GitHub Actions作为CI / CD，用于静态生成器和GitHub Pages上的站点 👦🏻 🌊 👨‍⚕️</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Habr感到惊讶的是，关于（beta-）GitHub功能-Actions的文章很少发表。 


 似乎可以通过以下事实来解释这种轻描淡写的事实：该功能仍在测试中，尽管是“ beta”。 但这是一项有用的Beta功能，可让您在私人存储库中使用此工具。 我将在本文中讨论有关使用该技术的问题。 
 史前史...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>GitHub Actions作为CI / CD，用于静态生成器和GitHub Pages上的站点</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/474668/"><p><img src="https://habrastorage.org/webt/n5/yi/0w/n5yi0witxomvduoy-ncm1mfctwo.png"></p><br><p>  Habr感到惊讶的是，关于（beta-）GitHub功能-Actions的文章很少发表。 </p><br><p> 似乎可以通过以下事实来解释这种轻描淡写的事实：该功能仍在测试中，尽管是“ beta”。 但这是一项有用的Beta功能，可让您在私人存储库中使用此工具。 我将在本文中讨论有关使用该技术的问题。 </p><a name="habracut"></a><br><h1 id="predistoriya"> 史前史 </h1><br><p> 如果您是按顺序开始的，那么您可能应该提到一下，在寻找一种快速，方便，轻松和免费的方式来存储您的个人网站“关于我”的过程中，我不得不度过了数个晚上，并且阅读了许多文章。 </p><br><p>有人选择托管，有人选择云服务器，以及那些不想了解所有工作，交互和付款的人-例如将静态网站上传到存储库，因为现在可以在GitHub和GitLab上完成。 </p><br><p>  <em>当然，这是每个人的个人选择。</em> </p><br><p> 我的最终选择是选择GitHub Pages。 </p><br><div class="spoiler">  <b class="spoiler_title">关于页面</b> <div class="spoiler_text"><p>谁都不知道， <code>gh-pages</code>是一种以网站形式存储文档的选项，它是免费提供的，并且除了文档以外，它还建议用于存储个人网站。 该功能由GitHub提供给所有用户，可在存储库设置中使用。 </p><br><p> 对于项目存储库，使用<code>gh-pages</code>分支，对于用户站点，使用单独的存储库，名为<code>username.github.io</code> ， <code>master</code>站点中包含站点的源代码。 </p><br><p> 您可以查看<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">文档以获取</a>更多详细信息，但我只会注意到GitHub具有惊人的慷慨性，每个人都可以通过简单地添加带有域名的<code>CNAME</code>文件并在GitHub服务器上设置其域名提供商的DNS来将自己的域绑定到这样的站点。 </p><br><p>  <em>我敢肯定，有很多关于如何部署这样一个站点的文章，所以这不是关于这个的。</em> </p></div></div><br><h1 id="vozniknovenie-problemy"> 发生问题 </h1><br><p> 问题是，当使用静态生成器时，需要组成其他 <del> 拐杖 </del> 脚本并使用库来简化生成页面并将其加载到存储库中的过程。 简而言之，如果将源代码存储在单独的私有存储库中，则每次对站点进行任何更改时，都必须部署本地环境，以便随后生成静态页面并在主站点存储库中进行发布。 </p><br><p> 有大量的<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">静态生成器</a> ，它们都有相同的问题。 这些操作需要花费大量时间和精力，最终它们会停止站点上的工作，尤其是在从OS到OS的几次迁移或硬盘驱动器上的数据丢失事件之后<em>（在我的情况下就是这样）</em> 。 </p><br><p> 就在最近，无论是在网站上的弹出式通知中，还是在GitHub的时事通讯中，都注意到了新构建的CI / CD，从而使这些操作可以轻松完成。 </p><br><div class="spoiler">  <b class="spoiler_title">关于静态页面生成器</b> <div class="spoiler_text"><p> 我不会专注于本项，但是我将分享在选择和使用这些子句时遇到的几个问题： </p><br><p>  1）值得为您的编程语言选择一种生成器，或者尽可能清晰的一种。 我是在我自己不得不为站点添加一些功能，放下拐杖以提高其稳定性和自动化性的时候才想到这个主意的。 此外，这是以插件形式编写其他功能的一个很好的理由。 </p><br><p>  2）驻留在哪个生成器上是一个个人选择，但是值得考虑的是，对于最初沉浸在GitHub Pages功能的功能中，您必须首先安装<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Jekyll</a> 。 幸运的是，它使您可以直接从资源库中的源生成站点<em>（我将选择重复进行此操作）</em> 。 </p><br><p> 我对发电机的选择基于第一点。 用Python编写的<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Pelican</a>很容易取代了我对Jekyll的陌生人<em>（使用了将近一年）</em> 。 结果，即使创建和编辑文章，站点上的机器人也为我提供了一种有趣的语言的额外体验。 </p><br><p>  __ </p></div></div><br><h1 id="postanovka-zadachi"> 问题陈述 </h1><br><p> 主要任务是编写一个脚本（实际上是配置文件），该脚本将自动从私有存储库生成静态页面。 该解决方案将使用虚拟环境的功能。 脚本本身会将完成的页面添加到公共存储库中。 </p><br><h2 id="instrumenty-dlya-resheniya"> 解决方案工具 </h2><br><p> 我们将用来解决问题的工具： </p><br><ul><li>  GitHub动作； </li><li>  Python 3.7 </li><li> 鹈鹕; </li><li> 吉特 </li><li>  GitHub页面。 </li></ul><br><h1 id="reshenie-problemy"> 解决问题 </h1><br><p> 总体而言，在对文档有所了解并弄清楚如何为Actions编写脚本之后，很明显，该机制将完全解决问题。  <em>在撰写本文时，要使用此功能，您必须订阅</em> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">beta测试</a> <em>！</em> </p><br><p><img src="https://habrastorage.org/webt/1r/wl/7r/1rwl7rpify7aeplohqqizaiknli.png"><br>  <em>Github对新功能的描述</em> </p><br><p> 要编写Actions脚本，首先需要在<code>.github</code>文件夹及其子文件夹<code>workflows</code>创建一个命名文件。 您可以手动执行此操作，也可以从存储库页面上“操作”选项卡中的编辑器中执行此操作。 </p><br><p><img src="https://habrastorage.org/webt/sj/bg/jw/sjbgjwz5huh8pw6x3lnkfj6iw-y.png"><br>  <em>空白脚本形式示例</em> </p><br><div class="spoiler">  <b class="spoiler_title">简短评论表格</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">name: CI #  :     Actions on: [push] # ,      jobs: # ,    build: # , .. runs-on: ubuntu-latest # ..      steps: #        - uses: actions/checkout@v1 #      - name: Run a one-line script #    1 run: echo Hello, world! #    1 (bash-    ) - name: Run a multi-line script #    2 run: | #    2 () echo Add other actions to build, echo test, and deploy your project.</code> </pre> </div></div><br><p> 让我们根据模板编写自己的代码： </p><br><p>  0） <em>可以保留名称和“ CI”。</em>  <em>这是一个品味问题。</em> </p><br><p>  1）接下来，您需要选择将导致脚本启动的操作/触发器，在我们的情况下，这通常是将新提交提交到存储库的操作。 </p><br><pre> <code class="plaintext hljs">on: push</code> </pre> <br><p>  2）也将以启动脚本为基础的映像作为示例，因为Ubuntu对必要的功能非常满意。 查看<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">可用的工具</a> ，您可以清楚地知道这可以是任何必要的图像，也可以只是方便的图像（或基于该图像的docker容器）。 </p><br><pre> <code class="plaintext hljs"> build: runs-on: ubuntu-latest</code> </pre> <br><p>  3）在步骤中，首先设置环境以准备主要工作。 </p><br><p>  3.1）转到我们需要的分支（标准<code>checkout</code>步骤）： </p><br><pre> <code class="plaintext hljs">- uses: actions/checkout@v1</code> </pre> <br><p>  3.2）安装Python： </p><br><pre> <code class="plaintext hljs"> - name: Set up Python uses: actions/setup-python@v1 with: python-version: 3.7</code> </pre> <br><p>  3.3）设置生成器的依赖项： </p><br><pre> <code class="plaintext hljs"> - name: Install dependencies run: | python -m pip install --upgrade pip pip install -r requirements.txt</code> </pre> <br><p>  3.4）创建将在其中生成站点页面的目录： </p><br><pre> <code class="plaintext hljs"> - name: Make output folder run: mkdir output</code> </pre> <br><p>  4）为了使站点上的工作保持一致，即不删除以前的更改并在不冲突的情况下向站点存储库添加更改，下一步是每次都克隆站点存储库： </p><br><pre> <code class="plaintext hljs"> - name: Clone master branch run: git clone "https://${{ secrets.ACCESS_TOKEN }}@github.com/${GITHUB_ACTOR}/${GITHUB_ACTOR}.github.io.git" --branch master --single-branch ./output</code> </pre> <br><p> 此步骤调用系统变量： </p><br><ul><li>  <code>GITHUB_ACTOR</code> GitHub设置变量本身，这是导致脚本运行的用户名； </li><li>  <code>secrets.ACCESS_TOKEN</code>变量是生成的<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">用于控制Github的令牌</a> ，我们可以通过在<code>Secrets</code>选项卡中设置存储库的设置将其作为环境变量进行传输。  <em>请注意，在生成令牌时，将仅向我们提供一次，将无法再使用它。</em>  <em>以及“秘密”的价值。</em> </li></ul><br><p>  5）我们继续生成页面： </p><br><pre> <code class="plaintext hljs"> - name: Generate static pages run: pelican content -o output -s publishconf.py</code> </pre> <br><p> 传递给生成器的参数负责生成文件的发送目录（ <code>-o output</code> ）和我们用于生成的配置文件（ <code>-s publishconf.py</code> ； <em>您可以在Pelican文档中了解共享本地配置和配置以供发布的方法</em> ） 。 </p><br><p>  <em>让我提醒您，该网站的存储库已被克隆到<code>output</code>文件夹中。</em> </p><br><p>  6）配置git并索引修改后的文件： </p><br><pre> <code class="plaintext hljs"> - name: Set git config and add changes run: | git config --global user.email "${GITHUB_ACTOR}@https://users.noreply.github.com/" git config --global user.name "${GITHUB_ACTOR}" git add --all working-directory: ./output</code> </pre> <br><p>  <em>本段使用已知的变量，并指示将在其中启动此步骤中的命令的工作目录。</em>  <em>否则，转到工作目录的命令看起来像<code>cd output</code> 。</em> </p><br><p>  7）生成提交消息，提交更改并将其推送到存储库中。 为了确保提交不被浪费，并且因此不会在bash中产生错误（输出不是<code>0</code> ），我们首先检查是否有必要提交并推送某些内容。 为此，我们使用<code>git diff-index --quiet --cached HEAD --</code>如果相对于该站点的先前版本没有任何更改，则将输出<code>0</code> ，并且有<code>1</code>此类更改。 然后，我们处理此命令的结果。 因此，我们将在此阶段在有关脚本执行的信息中写入有关站点状态的有用信息，而不是自动崩溃并向我们发送有关脚本崩溃的报告。 </p><br><p>  <em>我们还会在带有现成页面的目录中执行这些操作。</em> </p><br><pre> <code class="plaintext hljs"> - name: Push and send notification run: | COMMIT_MESSAGE="Update pages on $(date +'%Y-%m-%d %H:%M:%S')" git diff-index --quiet --cached HEAD -- &amp;&amp; echo "No changes!" &amp;&amp; exit 0 || echo $COMMIT_MESSAGE # Only if repo have changes git commit -m "${COMMIT_MESSAGE}" git push https://${{ secrets.ACCESS_TOKEN }}@github.com/${GITHUB_ACTOR}/${GITHUB_ACTOR}.github.io.git master working-directory: ./output</code> </pre> <br><h1 id="rezultat"> 结果 </h1><br><p> 结果，这样的脚本使您不必考虑创建静态页面。 通过直接将更改添加到私有存储库，无论是在任何系统下使用git还是通过GitHub的Web界面创建文件，Actions都可以自己完成。  <em>如果脚本意外删除，则会向邮件发送通知。</em> </p><br><div class="spoiler">  <b class="spoiler_title">完整代码</b> <div class="spoiler_text"><p> 我将保留我的工作版本，它在最后一步中添加了有关已将提交启动到主存储库的通知。 </p><br><p>  <em>上述机密信息用于在其中添加了机器人令牌和要将消息发送到的用户ID。</em> </p><br><pre> <code class="plaintext hljs">name: Push content to the user's GitHub pages repository on: push jobs: build: runs-on: ubuntu-latest steps: - uses: actions/checkout@v1 - name: Set up Python uses: actions/setup-python@v1 with: python-version: 3.7 - name: Install dependencies run: | python -m pip install --upgrade pip pip install -r requirements.txt - name: Make output folder run: mkdir output - name: Clone master branch run: git clone "https://${{ secrets.ACCESS_TOKEN }}@github.com/${GITHUB_ACTOR}/${GITHUB_ACTOR}.github.io.git" --branch master --single-branch ./output - name: Generate static pages run: pelican content -o output -s publishconf.py - name: Set git config and add changes run: | git config --global user.email "${GITHUB_ACTOR}@https://users.noreply.github.com/" git config --global user.name "${GITHUB_ACTOR}" git add --all working-directory: ./output - name: Push and send notification run: | COMMIT_MESSAGE="Update pages on $(date +'%Y-%m-%d %H:%M:%S')" git diff-index --quiet --cached HEAD -- &amp;&amp; echo "No changes!" &amp;&amp; exit 0 || echo $COMMIT_MESSAGE git commit -m "${COMMIT_MESSAGE}" git push https://${{ secrets.ACCESS_TOKEN }}@github.com/${GITHUB_ACTOR}/${GITHUB_ACTOR}.github.io.git master curl "https://api.telegram.org/bot${{ secrets.BOT_TOKEN }}/sendMessage?text=$COMMIT_MESSAGE %0ALook at ${GITHUB_ACTOR}.github.io %0ARepository%3A github.com/${GITHUB_ACTOR}/${GITHUB_ACTOR}.github.io&amp;chat_id=${{ secrets.ADMIN_ID }}" working-directory: ./output</code> </pre> </div></div><br><div class="spoiler">  <b class="spoiler_title">屏幕截图</b> <div class="spoiler_text"><p><img src="https://habrastorage.org/webt/pu/3h/1f/pu3h1fvrcftcsps02q8s7fdtcws.png"><br>  <em>带有源的存储库的“操作”选项卡中显示的启动之一的结果</em> </p><br><p><img src="https://habrastorage.org/webt/pi/nv/hr/pinvhrnwylox0oacazhjjuysx04.png"><br>  <em>机器人发出的有关脚本完成的消息</em> </p></div></div><br><h1 id="poleznye-ssylki"> 有用的链接 </h1><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">动作概述</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">动作语法</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">触发清单</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">虚拟环境的变体</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Github页面</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">静态发生器列表</a> </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN474668/">https://habr.com/ru/post/zh-CN474668/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN474656/index.html">逆向MIPS和Golang-逆向基础。 用r0ot-mi解决换向问题。 第二部分</a></li>
<li><a href="../zh-CN474658/index.html">手腕疼痛和电脑鼠标</a></li>
<li><a href="../zh-CN474662/index.html">Beta测试：开发人员的开发-一个学习英语的平台</a></li>
<li><a href="../zh-CN474664/index.html">为了增加注意力，我们的大脑不会增加注意力，而是使用信息过滤器</a></li>
<li><a href="../zh-CN474666/index.html">如何不在Rust中重写项目</a></li>
<li><a href="../zh-CN474672/index.html">在没有Webpack的浏览器中进行React，JSX，ES模块的导入（包括动态）</a></li>
<li><a href="../zh-CN474674/index.html">机器视觉与医学</a></li>
<li><a href="../zh-CN474676/index.html">GLES3和WebGL2中GPU上成千上万个唯一粒子的交互算法</a></li>
<li><a href="../zh-CN474678/index.html">Khronos Group用Vulkan示例创建了一个统一的存储库</a></li>
<li><a href="../zh-CN474680/index.html">AI和2048。第2部分：Minimax + Alpha Beta剪切</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>