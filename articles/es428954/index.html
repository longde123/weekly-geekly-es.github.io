<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>锔   C贸mo nos disparamos en la pierna y tratamos de averiguar qu茅 es exactamente ぞ 锔 </title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Las publicaciones anteriores en el blog corporativo no conten铆an un solo equipo de consola, y decidimos ponernos al d铆a. 


 Nuestra empresa tiene una...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>C贸mo nos disparamos en la pierna y tratamos de averiguar qu茅 es exactamente</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/timeweb/blog/428954/"><p>  Las publicaciones anteriores en el blog corporativo no conten铆an un solo equipo de consola, y decidimos ponernos al d铆a. </p><br><p>  Nuestra empresa tiene una m茅trica dise帽ada para evitar grandes fakaps en hosting compartido.  En cada servidor de alojamiento compartido hay un sitio de prueba en WordPress, al que se accede peri贸dicamente. </p><br><p><img src="https://habrastorage.org/webt/g_/va/ot/g_vaotdagl43wnkctciq39tewes.png" alt="imagen"><br>  <em>As铆 es como se ve el sitio de prueba en cada servidor de alojamiento compartido</em> </p><br><p><a name="habracut"></a>  Se mide la velocidad y el 茅xito de la respuesta del sitio.  Cualquier empleado de la compa帽铆a puede mirar las estad铆sticas generales y ver qu茅 tan bien le est谩 yendo a la compa帽铆a.  Puede ver el porcentaje de respuestas exitosas de un sitio de prueba para todo el alojamiento o para un servidor espec铆fico.  No es necesario ser un empleado de la empresa: en el panel de control, los clientes tambi茅n ven estad铆sticas en el servidor donde se encuentra su cuenta. </p><br><p>  Llamamos a esta m茅trica de <strong>tiempo de actividad</strong> (el porcentaje de respuestas exitosas del sitio de prueba a todas las solicitudes al sitio de prueba).  No es un muy buen nombre, es f谩cil confundirlo con el <em>tiempo de actividad</em> , que es el <em>tiempo total despu茅s del 煤ltimo reinicio del servidor</em> . </p><br><p>  El verano pas贸 y el horario de actividad disminuy贸 lentamente. </p><br><p><img src="https://habrastorage.org/webt/h5/-h/n6/h5-hn6fmxnjepsbj8i7j1azozeu.png" alt="imagen"></p><br><p>  Los administradores identificaron de inmediato la raz贸n: falta de RAM.  Fue f谩cil ver los casos de OOM en los registros cuando el servidor se qued贸 sin memoria y el kernel mat贸 a nginx. </p><br><p>  El jefe del departamento, Andrey, divide una tarea en varias de la mano de un mago y las pone en paralelo con diferentes administradores.  Uno va a analizar la configuraci贸n de Apache, 驴tal vez la configuraci贸n no sea 贸ptima y con mucho tr谩fico Apache usa toda la memoria?  Otro analiza el consumo de memoria mysqld: de repente, 驴hay alguna configuraci贸n desactualizada desde el momento en que el alojamiento compartido utilizaba el sistema operativo Gentoo?  El tercero analiza los cambios recientes en la configuraci贸n de nginx. </p><br><p>  Uno por uno, los administradores regresan con resultados.  Cada uno logr贸 reducir el consumo de memoria en el 谩rea asignada a 茅l.  En el caso de nginx, por ejemplo, se detect贸 un mod_security incluido pero no utilizado.  OOM, mientras tanto, tambi茅n es frecuente. </p><br><p>  Finalmente, es posible notar que el consumo de memoria central (en particular, SUnreclaim) es terriblemente grande en algunos servidores.  隆Ni en la salida ps ni en htop es visible este par谩metro, por lo que no lo notamos de inmediato!  Ejemplo de servidor con SUnreclaim infernal: </p><br><pre><code class="hljs perl">root@vh28.timeweb.ru:~<span class="hljs-comment"><span class="hljs-comment"># grep SU /proc/meminfo SUnreclaim: 25842956 kB</span></span></code> </pre> <br><p>  Se le dan 24 gigabytes de RAM al kernel, 隆y el kernel los gasta porque nadie sabe qu茅! </p><br><p>  El administrador (llam茅mosle Gabriel) se apresura a la batalla.  Vuelve a ensamblar el kernel con las opciones KMEMLEAK para la detecci贸n de fugas. </p><br><div class="spoiler">  <b class="spoiler_title">Opciones para reconstruir</b> <div class="spoiler_text"><p>  Para habilitar KMEMLEAK, solo especifique las opciones enumeradas a continuaci贸n y cargue el kernel con el par谩metro kmemleak = on. </p><br><pre> <code class="hljs">CONFIG_HAVE_DEBUG_KMEMLEAK=y CONFIG_DEBUG_KMEMLEAK=y CONFIG_DEBUG_KMEMLEAK_DEFAULT_OFF=y CONFIG_DEBUG_KMEMLEAK_EARLY_LOG_SIZE=10000</code> </pre> </div></div><br><p>  KMEMLEAK escribe (en <code>/sys/kernel/debug/kmemleak</code> ) estas l铆neas: </p><br><pre> <code class="hljs powershell">unreferenced object <span class="hljs-number"><span class="hljs-number">0</span></span>xffff88013a028228 (size <span class="hljs-number"><span class="hljs-number">8</span></span>): comm <span class="hljs-string"><span class="hljs-string">"apache2"</span></span>, pid <span class="hljs-number"><span class="hljs-number">23254</span></span>, jiffies <span class="hljs-number"><span class="hljs-number">4346187846</span></span> (age <span class="hljs-number"><span class="hljs-number">1436.284</span></span>s) hex dump (first <span class="hljs-number"><span class="hljs-number">8</span></span> bytes): <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> ........ backtrace: [&lt;<span class="hljs-type"><span class="hljs-type">ffffffff818570c8</span></span>&gt;] kmemleak_alloc+<span class="hljs-number"><span class="hljs-number">0</span></span>x28/<span class="hljs-number"><span class="hljs-number">0</span></span>x50 [&lt;<span class="hljs-type"><span class="hljs-type">ffffffff811d450a</span></span>&gt;] kmem_cache_alloc_trace+<span class="hljs-number"><span class="hljs-number">0</span></span>xca/<span class="hljs-number"><span class="hljs-number">0</span></span>x1d0 [&lt;<span class="hljs-type"><span class="hljs-type">ffffffff8136dcc3</span></span>&gt;] apparmor_file_alloc_security+<span class="hljs-number"><span class="hljs-number">0</span></span>x23/<span class="hljs-number"><span class="hljs-number">0</span></span>x40 [&lt;<span class="hljs-type"><span class="hljs-type">ffffffff81332d63</span></span>&gt;] security_file_alloc+<span class="hljs-number"><span class="hljs-number">0</span></span>x33/<span class="hljs-number"><span class="hljs-number">0</span></span>x50 [&lt;<span class="hljs-type"><span class="hljs-type">ffffffff811f8013</span></span>&gt;] get_empty_filp+<span class="hljs-number"><span class="hljs-number">0</span></span>x93/<span class="hljs-number"><span class="hljs-number">0</span></span>x1c0 [&lt;<span class="hljs-type"><span class="hljs-type">ffffffff811f815b</span></span>&gt;] alloc_file+<span class="hljs-number"><span class="hljs-number">0</span></span>x1b/<span class="hljs-number"><span class="hljs-number">0</span></span>xa0 [&lt;<span class="hljs-type"><span class="hljs-type">ffffffff81728361</span></span>&gt;] sock_alloc_file+<span class="hljs-number"><span class="hljs-number">0</span></span>x91/<span class="hljs-number"><span class="hljs-number">0</span></span>x120 [&lt;<span class="hljs-type"><span class="hljs-type">ffffffff8172b52e</span></span>&gt;] SyS_socket+<span class="hljs-number"><span class="hljs-number">0</span></span>x7e/<span class="hljs-number"><span class="hljs-number">0</span></span>xc0 [&lt;<span class="hljs-type"><span class="hljs-type">ffffffff81003854</span></span>&gt;] do_syscall_64+<span class="hljs-number"><span class="hljs-number">0</span></span>x54/<span class="hljs-number"><span class="hljs-number">0</span></span>xc0 [&lt;<span class="hljs-type"><span class="hljs-type">ffffffff818618ab</span></span>&gt;] return_from_SYSCALL_64+<span class="hljs-number"><span class="hljs-number">0</span></span>x0/<span class="hljs-number"><span class="hljs-number">0</span></span>x6a [&lt;<span class="hljs-type"><span class="hljs-type">ffffffffffffffff</span></span>&gt;] <span class="hljs-number"><span class="hljs-number">0</span></span>xffffffffffffffff unreferenced object <span class="hljs-number"><span class="hljs-number">0</span></span>xffff880d67030280 (size <span class="hljs-number"><span class="hljs-number">624</span></span>): comm <span class="hljs-string"><span class="hljs-string">"hrrb"</span></span>, pid <span class="hljs-number"><span class="hljs-number">23713</span></span>, jiffies <span class="hljs-number"><span class="hljs-number">4346190262</span></span> (age <span class="hljs-number"><span class="hljs-number">1426.620</span></span>s) hex dump (first <span class="hljs-number"><span class="hljs-number">32</span></span> bytes): <span class="hljs-number"><span class="hljs-number">01</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">03</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> ff ff <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> ................ <span class="hljs-number"><span class="hljs-number">00</span></span> e7 <span class="hljs-number"><span class="hljs-number">1</span></span>a <span class="hljs-number"><span class="hljs-number">06</span></span> <span class="hljs-number"><span class="hljs-number">10</span></span> <span class="hljs-number"><span class="hljs-number">88</span></span> ff ff <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">81</span></span> <span class="hljs-number"><span class="hljs-number">76</span></span> <span class="hljs-number"><span class="hljs-number">6</span></span>e <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">88</span></span> ff ff ..........vn.... backtrace: [&lt;<span class="hljs-type"><span class="hljs-type">ffffffff818570c8</span></span>&gt;] kmemleak_alloc+<span class="hljs-number"><span class="hljs-number">0</span></span>x28/<span class="hljs-number"><span class="hljs-number">0</span></span>x50 [&lt;<span class="hljs-type"><span class="hljs-type">ffffffff811d4337</span></span>&gt;] kmem_cache_alloc+<span class="hljs-number"><span class="hljs-number">0</span></span>xc7/<span class="hljs-number"><span class="hljs-number">0</span></span>x1d0 [&lt;<span class="hljs-type"><span class="hljs-type">ffffffff8172a25d</span></span>&gt;] sock_alloc_inode+<span class="hljs-number"><span class="hljs-number">0</span></span>x1d/<span class="hljs-number"><span class="hljs-number">0</span></span>xc0 [&lt;<span class="hljs-type"><span class="hljs-type">ffffffff8121082d</span></span>&gt;] alloc_inode+<span class="hljs-number"><span class="hljs-number">0</span></span>x1d/<span class="hljs-number"><span class="hljs-number">0</span></span>x90 [&lt;<span class="hljs-type"><span class="hljs-type">ffffffff81212b01</span></span>&gt;] new_inode_pseudo+<span class="hljs-number"><span class="hljs-number">0</span></span>x11/<span class="hljs-number"><span class="hljs-number">0</span></span>x60 [&lt;<span class="hljs-type"><span class="hljs-type">ffffffff8172952a</span></span>&gt;] sock_alloc+<span class="hljs-number"><span class="hljs-number">0</span></span>x1a/<span class="hljs-number"><span class="hljs-number">0</span></span>x80 [&lt;<span class="hljs-type"><span class="hljs-type">ffffffff81729aef</span></span>&gt;] __sock_create+<span class="hljs-number"><span class="hljs-number">0</span></span>x7f/<span class="hljs-number"><span class="hljs-number">0</span></span>x220 [&lt;<span class="hljs-type"><span class="hljs-type">ffffffff8172b502</span></span>&gt;] SyS_socket+<span class="hljs-number"><span class="hljs-number">0</span></span>x52/<span class="hljs-number"><span class="hljs-number">0</span></span>xc0 [&lt;<span class="hljs-type"><span class="hljs-type">ffffffff81003854</span></span>&gt;] do_syscall_64+<span class="hljs-number"><span class="hljs-number">0</span></span>x54/<span class="hljs-number"><span class="hljs-number">0</span></span>xc0 [&lt;<span class="hljs-type"><span class="hljs-type">ffffffff818618ab</span></span>&gt;] return_from_SYSCALL_64+<span class="hljs-number"><span class="hljs-number">0</span></span>x0/<span class="hljs-number"><span class="hljs-number">0</span></span>x6a [&lt;<span class="hljs-type"><span class="hljs-type">ffffffffffffffff</span></span>&gt;] <span class="hljs-number"><span class="hljs-number">0</span></span>xffffffffffffffff</code> </pre> <br><p>  Gabriel no nos revel贸 todos sus secretos y no cont贸 c贸mo, en las l铆neas anteriores, descubri贸 la causa exacta de la p茅rdida de memoria.  Lo m谩s probable es que haya usado el <code>addr2line /usr/lib/debug/lib/modules/`uname -r`/vmlinux ffffffff81722361</code> para encontrar la l铆nea exacta.  O simplemente abri贸 el <code>net/socket.c</code> y lo mir贸 hasta que el archivo se volvi贸 inc贸modo. </p><br><p>  El problema result贸 ser un parche en el <code>net/socket.c</code> , que se agreg贸 a nuestro repositorio hace muchos a帽os.  Su prop贸sito es prohibir a los clientes el uso de la llamada al sistema bind (), esta es una protecci贸n simple contra el servidor proxy que inician los clientes.  El parche cumpli贸 su prop贸sito, pero no borr贸 la memoria despu茅s de s铆 mismo. <br>  Tal vez hubo un nuevo malware de moda en PHP que intent贸 ejecutar un servidor proxy en un bucle, lo que condujo a cientos de miles de llamadas bloqueadas bind () y perdi贸 gigabytes de RAM. </p><br><p>  Luego fue simple: Gabriel arregl贸 el parche y reconstruy贸 el n煤cleo.  Monitoreo agregado del valor de SUnreclaim en todos los servidores que ejecutan Linux.  Los ingenieros advirtieron a los clientes y reiniciaron el alojamiento en el nuevo n煤cleo. <br>  OOM desapareci贸. </p><br><h3 id="no-problema-s-dostupnostyu-saytov-ostalas">  Pero el problema con la disponibilidad de sitios permaneci贸 </h3><br><p>  En todos los servidores, el sitio de prueba dej贸 de responder varias veces al d铆a. </p><br><p>  Aqu铆, el autor comenzar铆a a rasgar el cabello en diferentes partes del cuerpo.  Pero Gabriel mantuvo la calma y activ贸 la grabaci贸n del tr谩fico a partes de los servidores de alojamiento. </p><br><p>  En el volcado de tr谩fico, se observ贸 que con mayor frecuencia la solicitud al sitio de prueba cae despu茅s de la recepci贸n repentina de un paquete <code>TCP RST</code> .  En otras palabras, la solicitud lleg贸 al servidor, pero la conexi贸n termin贸 siendo interrumpida por nginx. <br>  Adem谩s m谩s interesante!  La utilidad strace lanzada por Gabriel muestra que el demonio nginx <strong>no</strong> est谩 enviando este paquete.  驴C贸mo puede ser esto, porque solo nginx est谩 escuchando en el puerto 80? <br>  La raz贸n fue una combinaci贸n de varios factores: </p><br><ul><li>  en la configuraci贸n de nginx, se <code>reuseport</code> opci贸n de <code>reuseport</code> (incluida la <code>SO_REUSEPORT</code> socket <code>SO_REUSEPORT</code> ), que permite que diferentes procesos acepten conexiones en la misma direcci贸n y puerto </li><li>  en (en ese momento, la versi贸n m谩s reciente) de nginx 1.13.0 hay un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">error</a> debido al cual al iniciar la prueba de configuraci贸n de <code>nginx -t</code> trav茅s de <code>nginx -t</code> y al usar la <code>SO_REUSEPORT</code> este proceso de prueba de nginx realmente comenz贸 a escuchar el puerto 80 e interceptar solicitudes de clientes reales .  Y al final del proceso de prueba de configuraci贸n, los clientes recibieron el <code>Connection reset by peer</code> </li><li>  finalmente, al monitorear el zabbix, se configur贸 el monitoreo de correcci贸n de la configuraci贸n de nginx en todos los servidores con nginx instalado: se llam贸 al comando <code>nginx -t</code> una vez por minuto. </li></ul><br><p>  Solo despu茅s de actualizar nginx podr铆a exhalar con calma.  El gr谩fico de tiempo de actividad de los sitios ha aumentado. </p><br><p>  驴Cu谩l es la moraleja de toda esta historia?  Sea optimista y evite el uso de n煤cleos autoensamblados. </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/es428954/">https://habr.com/ru/post/es428954/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../es428940/index.html">GitLab 11.4 lanzado con una revisi贸n de solicitud de fusi贸n y caracter铆sticas de complemento</a></li>
<li><a href="../es428942/index.html">Pen煤ltima publicaci贸n</a></li>
<li><a href="../es428944/index.html">D贸nde trabajar en TI, problema 3: Badoo</a></li>
<li><a href="../es428946/index.html">Semana de la seguridad 45: algo sobre las vulnerabilidades de Bluetooth</a></li>
<li><a href="../es428950/index.html">Resolver el problema de "desplazamiento corto a la izquierda"</a></li>
<li><a href="../es428956/index.html">Drones en la ISS</a></li>
<li><a href="../es428960/index.html">Informe del Club de Roma 2018, Cap铆tulo 1.5: Desaf铆o clim谩tico</a></li>
<li><a href="../es428962/index.html">Reubicaci贸n en Luxoft: como queda la vida</a></li>
<li><a href="../es428964/index.html">Las vulnerabilidades de SSD cifradas por hardware permiten a los atacantes eludir f谩cilmente las medidas de protecci贸n</a></li>
<li><a href="../es428972/index.html">Integraci贸n continua en Yandex</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>