<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ğŸ›¤ï¸ ğŸšƒ ğŸšµ Scala + MXNet =äº§å“ä¸­å¸¦æœ‰ç¥ç»å…ƒçš„å¾®æœåŠ¡ ğŸ¤¸ğŸ½ ğŸ’• ğŸ¤²</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="äº’è”ç½‘ä¸Šæœ‰å¤§é‡çš„æ‰‹å†Œå’Œç¤ºä¾‹ï¼Œäº²çˆ±çš„è¯»è€…ä»¬ï¼Œåœ¨è¿™äº›æ‰‹å†Œå’Œç¤ºä¾‹çš„åŸºç¡€ä¸Šï¼Œæ‚¨å°†èƒ½å¤Ÿâ€œæ¯«æ— å›°éš¾â€åœ°ï¼Œä»¥â€œæœ€å°‘çš„â€æ—¶é—´æˆæœ¬ç¼–å†™ä»£ç ï¼Œä»¥åŒºåˆ†ç…§ç‰‡ä¸­çš„çŒ«å’Œç‹—ã€‚ é‚£ä¸ºä»€ä¹ˆè¿˜è¦åœ¨æœ¬æ–‡ä¸Šæµªè´¹æ—¶é—´å‘¢ï¼Ÿ 

 æˆ‘è®¤ä¸ºæ‰€æœ‰è¿™äº›ç¤ºä¾‹çš„ä¸»è¦ç¼ºç‚¹æ˜¯å¯èƒ½æ€§æœ‰é™ã€‚ æ‚¨ä¸¾äº†ä¸€ä¸ªä¾‹å­-ç”šè‡³ä½¿ç”¨äº†ä½œè€…æä¾›çš„åŸºæœ¬ç¥ç»ç½‘ç»œ-éƒ½å¯åŠ¨äº†å®ƒï¼Œä¹Ÿè®¸å®ƒç”š...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Scala + MXNet =äº§å“ä¸­å¸¦æœ‰ç¥ç»å…ƒçš„å¾®æœåŠ¡</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/mailru/blog/439226/"><div style="text-align:center;"><img src="https://habrastorage.org/webt/jw/cg/y4/jwcgy4upeqzycu6p2kxth9ok9iy.jpeg" width="500"></div><br> äº’è”ç½‘ä¸Šæœ‰å¤§é‡çš„æ‰‹å†Œå’Œç¤ºä¾‹ï¼Œäº²çˆ±çš„è¯»è€…ä»¬ï¼Œåœ¨è¿™äº›æ‰‹å†Œå’Œç¤ºä¾‹çš„åŸºç¡€ä¸Šï¼Œæ‚¨å°†èƒ½å¤Ÿâ€œæ¯«æ— å›°éš¾â€åœ°ï¼Œä»¥â€œæœ€å°‘çš„â€æ—¶é—´æˆæœ¬ç¼–å†™ä»£ç ï¼Œä»¥åŒºåˆ†ç…§ç‰‡ä¸­çš„çŒ«å’Œç‹—ã€‚ é‚£ä¸ºä»€ä¹ˆè¿˜è¦åœ¨æœ¬æ–‡ä¸Šæµªè´¹æ—¶é—´å‘¢ï¼Ÿ <br><br> æˆ‘è®¤ä¸ºæ‰€æœ‰è¿™äº›ç¤ºä¾‹çš„ä¸»è¦ç¼ºç‚¹æ˜¯å¯èƒ½æ€§æœ‰é™ã€‚ æ‚¨ä¸¾äº†ä¸€ä¸ªä¾‹å­-ç”šè‡³ä½¿ç”¨äº†ä½œè€…æä¾›çš„åŸºæœ¬ç¥ç»ç½‘ç»œ-éƒ½å¯åŠ¨äº†å®ƒï¼Œä¹Ÿè®¸å®ƒç”šè‡³èµ·ä½œç”¨äº†ï¼Œæ¥ä¸‹æ¥è¯¥æ€ä¹ˆåŠï¼Ÿ å¦‚ä½•ä½¿è¿™ä¸ªç®€å•çš„ä»£ç å¼€å§‹åœ¨ç”Ÿäº§æœåŠ¡å™¨ä¸Šå·¥ä½œï¼Ÿ å¦‚ä½•æ›´æ–°å’Œç»´æŠ¤å®ƒï¼Ÿ è¿™å°±æ˜¯ä¹è¶£çš„å¼€å§‹ã€‚ ä»â€œå¥½å§ï¼ŒMLå·¥ç¨‹å¸ˆè®­ç»ƒäº†ç¥ç»ç½‘ç»œâ€åˆ°â€œæœ€ç»ˆæˆ‘ä»¬å°†å…¶æ¨å¹¿åˆ°ç”Ÿäº§ä¸­â€é‚£ä¸€åˆ»ï¼Œæˆ‘æ‰¾ä¸åˆ°è¯¥è¿‡ç¨‹çš„å®Œæ•´æè¿°ã€‚ æˆ‘å†³å®šç¼©å°è¿™ä¸€å·®è·ã€‚ <br><a name="habracut"></a><br> æˆ‘ä¸ä¼šè°ˆè®ºå¦‚ä½•æ•™ç¥ç»ç½‘ç»œä¸€äº›æœ‰è¶£çš„æ–°äº‹ç‰©ï¼Œè¿™äº›äº‹ç‰©ä¼šå–æ‚¦æ‚¨å¹¶å¸®åŠ©æ‚¨èµšå–ä¸€å †é¦™è„†çš„é’ç¥¨ã€‚ è¿™æ˜¯å•ç‹¬æ’°å†™æ–‡ç« çš„é‡è¦è¯é¢˜ã€‚ ä¾‹å¦‚ï¼Œæˆ‘å°†ä½¿ç”¨å¯ä»¥å…è´¹ä¸‹è½½çš„ç¥ç»ç½‘ç»œã€‚ æˆ‘è®¾å®šçš„ä¸»è¦ä»»åŠ¡æ˜¯å…¨é¢ä»‹ç»å°†ç¥ç»ç½‘ç»œå¼•å…¥è¿è¥çš„è¿‡ç¨‹ã€‚ <br><br> æˆ‘ç«‹å³å›ç­”â€œä¸ºä»€ä¹ˆä¸ä½¿ç”¨Pythonï¼Ÿâ€è¿™ä¸ªé—®é¢˜ï¼šæˆ‘ä»¬å°†Scalaç”¨äºç”Ÿäº§è§£å†³æ–¹æ¡ˆï¼Œå› ä¸ºå®ƒæ›´åŠ æ–¹ä¾¿ï¼Œç¨³å®šåœ°ç¼–å†™äº†å¤šçº¿ç¨‹ä»£ç ã€‚ <br><br><h1> ç›®å½•å†…å®¹ </h1><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">1.é—®é¢˜é™ˆè¿°</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">2.ä½¿ç”¨çš„æŠ€æœ¯</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">3.å‡†å¤‡ä¸€ä¸ªåŸºæœ¬çš„Dockerå®¹å™¨</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">4.é¡¹ç›®ç»“æ„</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">5.ç¥ç»ç½‘ç»œåŠ è½½</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">6. REST APIå®æ–½</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">7.æµ‹è¯•</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">8.åŸºäºåŸºæœ¬æ˜ åƒç»„è£…å¾®æœåŠ¡</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">9.åœ¨å¸¦æœ‰GPUçš„ç”Ÿäº§æœåŠ¡å™¨ä¸Šå¯åŠ¨å¾®æœåŠ¡</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">ç»“è®º</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">å‚è€ƒæ–‡çŒ®</a> <br><br><a name="1"></a><h1>  1.é—®é¢˜é™ˆè¿° </h1><br> å‡è®¾æˆ‘ä»¬æœ‰ä¸€ä¸ªåŒ…å«ä¸åŒå¯¹è±¡çš„å¤§å‹ç…§ç‰‡æ•°æ®åº“ï¼Œæˆ‘ä»¬éœ€è¦åˆ¶ä½œä¸€ä¸ªå¾®æœåŠ¡ï¼Œè¯¥æœåŠ¡å°†ä»¥HTTP POSTè¯·æ±‚æ¥æ”¶å›¾ç‰‡å¹¶ä»¥JSONæ ¼å¼å“åº”ã€‚ ç­”æ¡ˆåº”åŒ…å«æ‰¾åˆ°çš„å¯¹è±¡åŠå…¶ç±»çš„æ•°é‡ï¼Œè¯¥å¯¹è±¡æ°å¥½æ˜¯æ‰€å£°æ˜ç±»çš„å¯¹è±¡çš„æ¦‚ç‡ä»¥åŠè¦†ç›–æ¯ä¸ªå¯¹è±¡è¾¹ç•Œçš„çŸ©å½¢çš„åæ ‡ã€‚ <br><br><a name="2"></a><h1>  2.ä½¿ç”¨çš„æŠ€æœ¯ </h1><br><ul><li>  Scala 2.12.7 +æœ€å°‘çš„é™„åŠ åº“é›†ï¼Œå¸¦æœ‰Sbt-pack 0.12æ’ä»¶çš„Sbt 1.2.6ï¼Œç”¨äºæ„å»ºæºä»£ç ã€‚ </li><li>  MXNet 1.3.1ï¼ˆåœ¨æ’°å†™æœ¬æ–‡æ—¶ä¸ºæœ€æ–°çš„ç¨³å®šç‰ˆæœ¬ï¼‰ï¼Œé’ˆå¯¹Scala 2.12è¿›è¡Œäº†ç¼–è¯‘ã€‚ </li><li> è£…æœ‰Nvidiaæ˜¾å¡çš„æœåŠ¡å™¨ã€‚ </li><li> æœåŠ¡å™¨ä¸Šå®‰è£…äº†Cuda 9.0å’ŒCudnn 7ã€‚ </li><li>  Java 8è¿è¡Œå·²ç¼–è¯‘çš„ä»£ç ã€‚ </li><li>  Dockerç®€åŒ–äº†æœåŠ¡å™¨ä¸Šå¾®æœåŠ¡çš„ç»„è£…ï¼Œäº¤ä»˜å’Œå¯åŠ¨ã€‚ </li></ul><br><a name="3"></a><h1>  3.å‡†å¤‡ä¸€ä¸ªåŸºæœ¬çš„Dockerå®¹å™¨ </h1><br> å¯¹äºæˆ‘ä»¬çš„å¾®æœåŠ¡ï¼Œæ‚¨å°†éœ€è¦ä¸€ä¸ªåŸºæœ¬çš„Dockeræ˜ åƒï¼Œå…¶ä¸­å°†å®‰è£…è¿è¡Œæ‰€éœ€çš„æœ€å°æ•°é‡çš„ä¾èµ–é¡¹ã€‚ å¯¹äºç»„è£…ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨å¸¦æœ‰é™„åŠ å®‰è£…çš„Sbtçš„æ˜ åƒã€‚ æ˜¯çš„ï¼Œæˆ‘ä»¬ä¸ä¼šåœ¨æœ¬åœ°ç¯å¢ƒä¸­è€Œæ˜¯åœ¨Dockerå®¹å™¨ä¸­æ„å»ºæºä»£ç æœ¬èº«ã€‚ è¿™å°†æœ‰åŠ©äºé€šè¿‡CIï¼ˆä¾‹å¦‚ï¼Œé€šè¿‡gitlab CIï¼‰è¿›ä¸€æ­¥è¿‡æ¸¡åˆ°ç¨‹åºé›†ã€‚ <br><br> èµ„æ–™å¤¹ç»“æ„ï¼š <br><br><pre><code class="plaintext hljs">\ | ----- install | | ----- java8.sh | | ----- mxnet_2_12.sh | | ----- opencv.sh | | ----- sbt.sh | | ----- scala.sh | | ----- timeZone.sh | ----- scala-mxnet-cuda-cudnn | ----- Dockerfile.2.12-1.3.1-9-7-builder | ----- Dockerfile.2.12-1.3.1-9-7-runtime</code> </pre> <br><h4>  Dockerfile.2.12-1.3.1-9-7-è¿è¡Œæ—¶ </h4><br> è¯¥å›¾åƒå°†ç”¨äºå¾®æœåŠ¡çš„æœ€ç»ˆå¯åŠ¨ã€‚ å®ƒåŸºäºNvidiaçš„å®˜æ–¹æ˜ åƒï¼Œå…¶ä¸­é¢„è£…äº†CUDA 9.0å’ŒCUDNN7ã€‚MXNet1.3.1çš„æ–‡æ¡£å£°ç§°å¯ä»¥ä¸CUDA 8.0ä¸€èµ·ä½¿ç”¨ï¼Œä½†æ˜¯ï¼Œæ­£å¦‚å®è·µæ‰€ç¤ºï¼Œä¸€åˆ‡éƒ½å¯ä»¥åœ¨9.0ç‰ˆä¸Šæ­£å¸¸è¿è¡Œï¼Œç”šè‡³æ›´å¿«ã€‚ <br><br> æ­¤å¤–ï¼Œæˆ‘ä»¬å°†å®‰è£…Java 8ï¼ŒMXNet 1.3.1ï¼ˆå°†åœ¨Scala 2.12ä¸‹æ„å»ºå®ƒï¼‰ï¼ŒOpenCV 3.4.3å’Œç”¨äºåœ¨æ­¤æ˜ åƒä¸­è®¾ç½®æ—¶åŒºçš„Linuxå®ç”¨ç¨‹åºã€‚ <br><br><pre> <code class="plaintext hljs">#        Nvidia  cuda 9.0  cudnn 7 FROM nvidia/cuda:9.0-cudnn7-devel AS builder #    ENV MXNET_VERSION 1.3.1 ENV MXNET_BUILD_OPT "USE_OPENCV=1 USE_BLAS=openblas USE_CUDA=1 USE_CUDA_PATH=/usr/local/cuda USE_CUDNN=1" ENV CUDA_STUBS_DIR "/usr/local/cuda-9.0/targets/x86_64-linux/lib/stubs" ENV OPEN_CV_VERSION 3.4.3 ENV OPEN_CV_INSTALL_PREFIX /usr/local ENV JAVA_HOME /usr/lib/jvm/java-8-oracle/ ENV TIME_ZONE Europe/Moscow #     COPY install /install RUN chmod +x -R /install/* #   RUN apt-get update WORKDIR /install RUN ./timeZone.sh ${TIME_ZONE} RUN ./java8.sh RUN ./mxnet_2_12.sh ${MXNET_VERSION} "${MXNET_BUILD_OPT}" ${CUDA_STUBS_DIR} RUN ./opencv.sh ${OPEN_CV_VERSION} ${OPEN_CV_INSTALL_PREFIX} #     RUN apt-get autoclean -y &amp;&amp; \ rm -rf /var/cache/* /install #       FROM nvidia/cuda:9.0-cudnn7-devel COPY --from=builder --chown=root:root / /</code> </pre> <br> è„šæœ¬timeZone.sh java8.shå’Œopencv.shéå¸¸çç¢ï¼Œå› æ­¤æˆ‘å°†ä¸å¯¹å…¶è¿›è¡Œè¯¦ç»†ä»‹ç»ï¼Œå®ƒä»¬åœ¨ä¸‹é¢ä»‹ç»ã€‚ <br><br><h4>  timeZone.sh </h4><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/sh #         TIME_ZONE=${1} #       apt-get install -y tzdata &amp;&amp; \ ln -sf /usr/share/zoneinfo/$TIME_ZONE /etc/localtime &amp;&amp; \ dpkg-reconfigure -f noninteractive tzdata</span></span></code> </pre> <br><h4>  java8.sh </h4><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/sh #  Java 8 apt-get install -y software-properties-common &amp;&amp; \ add-apt-repository ppa:webupd8team/java -y &amp;&amp; \ apt-get update &amp;&amp; \ echo "oracle-java8-installer shared/accepted-oracle-license-v1-1 select true" | debconf-set-selections &amp;&amp; \ apt-get install -y oracle-java8-installer</span></span></code> </pre> <br><h4>  opencv.sh </h4><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/sh #   OpenCV     OPEN_CV_VERSION=${1} #        OPEN_CV_INSTALL_PREFIX=${2} OPEN_CV_TAR="http://github.com/opencv/opencv/archive/${OPEN_CV_VERSION}.tar.gz" #  OpenCV apt-get install -y wget build-essential cmake &amp;&amp; \ wget -qO- ${OPEN_CV_TAR} | tar xzv -C /tmp &amp;&amp; \ mkdir /tmp/opencv-${OPEN_CV_VERSION}/build &amp;&amp; \ cd /tmp/opencv-${OPEN_CV_VERSION}/build &amp;&amp; \ cmake -DBUILD_JAVA=ON -DCMAKE_INSTALL_PREFIX:PATH=${OPEN_CV_INSTALL_PREFIX} .. &amp;&amp; \ make -j$((`nproc`+1)) &amp;&amp; \ make install &amp;&amp; \ rm -rf /tmp/opencv-${OPEN_CV_VERSION}</span></span></code> </pre> <br> å®‰è£…MXNetå¹¶éé‚£ä¹ˆç®€å•ã€‚ äº‹å®æ˜¯ï¼Œæ­¤Scalaåº“çš„æ‰€æœ‰ç¨‹åºé›†éƒ½æ˜¯åœ¨ç¼–è¯‘å™¨ç‰ˆæœ¬2.11çš„åŸºç¡€ä¸Šè¿›è¡Œçš„ï¼Œè¿™æ˜¯æœ‰é“ç†çš„ï¼Œå› ä¸ºè¯¥åº“åŒ…æ‹¬ä¸€ä¸ªç”¨äºSparkçš„æ¨¡å—ï¼Œè€Œè¯¥æ¨¡å—åˆç”±Scala 2.11ç¼–å†™ã€‚ è€ƒè™‘åˆ°æˆ‘ä»¬åœ¨å¼€å‘ä¸­ä½¿ç”¨Scala 2.12.7ï¼Œå› æ­¤ç¼–è¯‘åçš„åº“ä¸é€‚åˆæˆ‘ä»¬ï¼Œå› æ­¤æˆ‘ä»¬æ— æ³•ä½¿ç”¨2.11ç‰ˆæœ¬ã€‚*ç”±äºæ–°ç‰ˆæœ¬çš„Scalaå·²ç»ç¼–å†™äº†å¤§é‡ä»£ç ï¼Œå› æ­¤æˆ‘ä»¬ä¸èƒ½ã€‚ æ€ä¹ˆåŠ ä»æˆ‘ä»¬çš„Scalaç‰ˆæœ¬ä¸­è·å¾—ä»æºä»£ç æ”¶é›†MXNetçš„ä¹è¶£ã€‚ ä¸‹é¢ï¼Œæˆ‘å°†ç»™å‡ºä¸€ä¸ªè„šæœ¬ï¼Œç”¨äºä¸ºScala 2.12æ„å»ºå’Œå®‰è£…MXNet 1.3.1ã€‚*å¹¶å¯¹è¦ç‚¹è¿›è¡Œè¯„è®ºã€‚ <br><br><h4>  mxnet_2_12.sh </h4><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/sh #   MXNet     MXNET_VERSION=${1} #     ++  MXNet     MXNET_BUILD_OPT=${2} #       CUDA     CUDA_STUBS_DIR=${3} LD_LIBRARY_PATH="${LD_LIBRARY_PATH}:${CUDA_STUBS_DIR}" #       MXNet   apt-get install -y git build-essential libopenblas-dev libopencv-dev maven cmake &amp;&amp; \ git clone -b ${MXNET_VERSION} --recursive https://github.com/dmlc/mxnet /tmp/mxnet &amp;&amp; \ cd /tmp/mxnet &amp;&amp; \ make -j $(nproc) ${MXNET_BUILD_OPT} &amp;&amp; \ ln -s ${CUDA_STUBS_DIR}/libcuda.so ${CUDA_STUBS_DIR}/libcuda.so.1 &amp;&amp; \ sed -rim 's/([a-zA-Z])_2.11/\1_2.12/g' $(find scala-package -name pom.xml) &amp;&amp; \ sed -im 's/SCALA_VERSION_PROFILE := scala-2.11/SCALA_VERSION_PROFILE := scala-2.12/g' Makefile &amp;&amp; \ sed -im 's/&lt;module&gt;spark&lt;\/module&gt;/&lt;\!--&lt;module&gt;spark&lt;\/module&gt;--&gt;/g' scala-package/pom.xml &amp;&amp; \ make scalapkg ${MXNET_BUILD_OPT} &amp;&amp; \ mkdir -p /usr/local/share/mxnet/scala/linux-x86_64-gpu &amp;&amp; \ mv /tmp/mxnet/scala-package/assembly/linux-x86_64-gpu/target/mxnet-full_2.12-linux-x86_64-gpu-${MXNET_VERSION}-SNAPSHOT.jar /usr/local/share/mxnet/scala/linux-x86_64-gpu/mxnet-full_2.12-linux-x86_64-gpu-${MXNET_VERSION}-SNAPSHOT.jar &amp;&amp; \ rm -rf /tmp/mxnet &amp;&amp; rm -rf /root/.m2</span></span></code> </pre> <br> æœ€æœ‰è¶£çš„éƒ¨åˆ†ä»è¿™ä¸€è¡Œå¼€å§‹ï¼š <br><br><pre> <code class="bash hljs">ln -s <span class="hljs-variable"><span class="hljs-variable">${CUDA_STUBS_DIR}</span></span>/libcuda.so <span class="hljs-variable"><span class="hljs-variable">${CUDA_STUBS_DIR}</span></span>/libcuda.so.1 &amp;&amp; \</code> </pre> <br> å¦‚æœæŒ‰ç…§è¯´æ˜è¿è¡ŒMXNetç¨‹åºé›†ï¼Œæˆ‘ä»¬å°†æ”¶åˆ°é”™è¯¯æ¶ˆæ¯ã€‚ ç¼–è¯‘å™¨æ‰¾ä¸åˆ°libcuda.so.1åº“ï¼Œå› æ­¤æˆ‘ä»¬å°†ä»libcuda.soåº“é“¾æ¥åˆ°libcuda.so.1ã€‚ è¿™å¯èƒ½ä¸ä¼šæ‰“æ‰°æ‚¨ï¼Œå½“æ‚¨åœ¨ç”Ÿäº§æœåŠ¡å™¨ä¸Šå¯åŠ¨å®ƒæ—¶ï¼Œæˆ‘ä»¬å°†ç”¨æœ¬åœ°åº“æ›¿æ¢è¯¥åº“ã€‚ è¿˜è¦æ³¨æ„ï¼Œä»<code>CUDA_STUBS_DIR</code>ç¯å¢ƒå˜é‡åˆ°CUDAåº“çš„è·¯å¾„å·²æ·»åŠ åˆ°<code>LD_LIBRARY_PATH</code> ã€‚ å¦‚æœä¸è¿™æ ·åšï¼Œåˆ™ç»„è£…ä¹Ÿå°†å¤±è´¥ã€‚ <br><br> åœ¨è¿™äº›è¡Œä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨å®éªŒæ€§é€‰æ‹©çš„æ­£åˆ™è¡¨è¾¾å¼åœ¨æ‰€æœ‰å¿…éœ€çš„æ–‡ä»¶ä¸­ç”¨2.12æ›¿æ¢äº†Scala 2.11çš„ç‰ˆæœ¬ï¼Œè¿™æ˜¯å› ä¸ºå®ƒä¸è¶³ä»¥ç®€å•åœ°å°†2.11æ›¿æ¢ä¸º2.12ï¼š <br><br><pre> <code class="bash hljs">sed -rim <span class="hljs-string"><span class="hljs-string">'s/([a-zA-Z])_2.11/\1_2.12/g'</span></span> $(find scala-package -name pom.xml) &amp;&amp; \ sed -im <span class="hljs-string"><span class="hljs-string">'s/SCALA_VERSION_PROFILE := scala-2.11/SCALA_VERSION_PROFILE := scala-2.12/g'</span></span> Makefile &amp;&amp; \ sed -im <span class="hljs-string"><span class="hljs-string">'s/&lt;module&gt;spark&lt;\/module&gt;/&lt;\!--&lt;module&gt;spark&lt;\/module&gt;--&gt;/g'</span></span> scala-package/pom.xml &amp;&amp; \ make scalapkg <span class="hljs-variable"><span class="hljs-variable">${MXNET_BUILD_OPT}</span></span> &amp;&amp; \</code> </pre> <br> ç„¶åï¼Œè¯´æ˜å¯¹ä¸Sparké…åˆä½¿ç”¨çš„æ¨¡å—çš„ä¾èµ–æ€§ã€‚ å¦‚æœä¸è¿™æ ·åšï¼Œåº“å°†ä¸ä¼šè¢«æ±‡ç¼–ã€‚ <br><br> æ¥ä¸‹æ¥ï¼ŒæŒ‰ç…§è¯´æ˜ä¸­çš„è¯´æ˜è¿è¡Œç¨‹åºé›†ï¼Œå°†ç¨‹åºé›†åº“å¤åˆ¶åˆ°å…±äº«æ–‡ä»¶å¤¹ä¸­ï¼Œå¹¶åˆ é™¤åœ¨æ„å»ºè¿‡ç¨‹ä¸­MavenæŠ½å‡ºçš„æ‰€æœ‰åƒåœ¾ï¼ˆå¦‚æœä¸è¿™æ ·åšï¼Œæœ€ç»ˆæ˜ åƒå°†å¢åŠ çº¦3-4 GBï¼Œè¿™å¯èƒ½ä¼šå¯¼è‡´DevOpsç´§å¼ ï¼‰ã€‚ <br><br> æˆ‘ä»¬æ”¶é›†å›¾åƒï¼Œè¯¥å›¾åƒä½äºé¡¹ç›®çš„æ ¹ç›®å½•ä¸­ï¼ˆè¯·å‚é˜…æ–‡ä»¶å¤¹ç»“æ„ï¼‰ï¼š <br><br><pre> <code class="bash hljs">your@pc$ docker build -f Dockerfile.2.12-1.3.1-9-7-runtime -t entony/scala-mxnet-cuda-cudnn:2.12-1.3.1-9-7-runtime .</code> </pre> <br> è®©æˆ‘æé†’æ‚¨ï¼Œä»¥é˜²ä¸‡ä¸€æœ«å°¾çš„ç‚¹è¡¨ç¤ºæˆ‘ä»¬æ­£åœ¨å½“å‰ç›®å½•çš„ä¸Šä¸‹æ–‡ä¸­è¿›è¡Œæ±‡ç¼–ã€‚ <br><br> ç°åœ¨æ˜¯æ—¶å€™è®¨è®ºæ„å»ºæ˜ åƒäº†ã€‚ <br><br><h4>  Dockerfile.2.12-1.3.1-9-7-builder </h4><br><pre> <code class="plaintext hljs">#         runtime-,    FROM entony/scala-mxnet-cuda-cudnn:2.12-1.3.1-9-7-runtime #    ENV SCALA_VERSION 2.12.7 ENV SBT_VERSION 1.2.6 #     COPY install /install RUN chmod +x -R /install/* #       RUN apt-get update &amp;&amp; \ cd /install &amp;&amp; \ ./scala.sh ${SCALA_VERSION} &amp;&amp; \ ./sbt.sh ${SBT_VERSION} #   RUN rm -rf /install</code> </pre> <br> å¾ˆç®€å•ï¼Œæˆ‘ä»¬ä¸éœ€è¦Scalaå’ŒSbtæ¥å¯åŠ¨æˆ‘ä»¬çš„å¾®æœåŠ¡ï¼Œå› æ­¤å°†å®ƒä»¬æ‹–åˆ°å¯åŠ¨çš„åŸºæœ¬æ˜ åƒä¸­æ²¡æœ‰ä»»ä½•æ„ä¹‰ã€‚ å› æ­¤ï¼Œæˆ‘ä»¬å°†åˆ›å»ºä¸€ä¸ªå•ç‹¬çš„æ˜ åƒï¼Œè¯¥æ˜ åƒä»…ç”¨äºç»„è£…ã€‚  scala.shå’Œsbt.shè„šæœ¬éå¸¸ç®€å•ï¼Œæˆ‘å°†ä¸å¯¹å…¶è¿›è¡Œè¯¦ç»†ä»‹ç»ã€‚ <br><br><h4>  scala.sh </h4><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/sh #   Scala     SCALA_VERSION=${1} SCALA_DEB="http://www.scala-lang.org/files/archive/scala-${SCALA_VERSION}.deb" #  Scala apt-get install -y wget &amp;&amp; \ wget -q ${SCALA_DEB} -O /tmp/scala.deb &amp;&amp; dpkg -i /tmp/scala.deb &amp;&amp; \ scala -version &amp;&amp; \ rm /tmp/scala.deb</span></span></code> </pre> <br><h4>  sbt.sh </h4><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/sh #   Sbt     SBT_VERSION=${1} SBT_DEB="http://dl.bintray.com/sbt/debian/sbt-${SBT_VERSION}.deb" #  Sbt apt-get install -y wget &amp;&amp; \ wget -q ${SBT_DEB} -O /tmp/sbt.deb &amp;&amp; dpkg -i /tmp/sbt.deb &amp;&amp; \ sbt sbtVersion &amp;&amp; \ rm /tmp/sbt.deb</span></span></code> </pre> <br> æˆ‘ä»¬æ”¶é›†å›¾åƒï¼Œè¯¥å›¾åƒä½äºé¡¹ç›®çš„æ ¹ç›®å½•ä¸­ï¼ˆè¯·å‚é˜…æ–‡ä»¶å¤¹ç»“æ„ï¼‰ï¼š <br><br><pre> <code class="bash hljs">your@pc$ docker build -f Dockerfile.2.12-1.3.1-9-7-builder -t entony/scala-mxnet-cuda-cudnn:2.12-1.3.1-9-7-builder .</code> </pre> <br> åœ¨æ–‡ç« çš„ç»“å°¾ï¼Œæœ‰æŒ‡å‘æ‰€æœ‰è¿™äº›æ–‡ä»¶çš„å­˜å‚¨åº“çš„é“¾æ¥ã€‚ <br><br><a name="4"></a><h1>  4.é¡¹ç›®ç»“æ„ </h1><br> å®Œæˆé¡¹ç›®ç»„è£…çš„å‡†å¤‡å·¥ä½œåï¼Œè®©æˆ‘ä»¬åšæ‚¨å†³å®šèŠ±äº›æ—¶é—´åœ¨æœ¬æ–‡ä¸Šçš„äº‹æƒ…ã€‚ <br><br> æˆ‘ä»¬çš„å¾®æœåŠ¡é¡¹ç›®å°†å…·æœ‰ä»¥ä¸‹ç»“æ„ï¼š <br><br><pre> <code class="plaintext hljs">\ | ----- dependencies | | ----- mxnet-full_2.12-linux-x86_64-gpu-1.3.1-SNAPSHOT.jar | ----- models | | ----- resnet50_ssd_model-0000.params | | ----- resnet50_ssd_model-symbol.json | | ----- synset.txt | ----- project | | ----- build.properties | | ----- plugins.sbt | ----- src | | ----- main | | | ----- resources | | | | ----- cat_and_dog.jpg | | | ----- scala | | | | ----- simple.predictor | | | | ----- Config | | | | ----- Model | | | | ----- Server | | | | ----- Run | | ----- test | | | ----- scala | | | | ----- simple.predictor | | | | ----- ServerTest | ----- build.sbt | ----- Dockerfile</code> </pre> <br> è¿™æ˜¯æ ‡å‡†çš„Scalaé¡¹ç›®ç»“æ„ï¼Œä½†ä¾èµ–é¡¹å’Œæ¨¡å‹ç›®å½•é™¤å¤–ã€‚ <br> ä¾èµ–å…³ç³»ç›®å½•åŒ…å«Scalaçš„MXNetåº“ã€‚ å®ƒå¯ä»¥é€šè¿‡ä¸¤ç§æ–¹å¼è·å¾—ï¼š <br><br><ul><li> åœ¨æ‚¨è¦å¼€å‘çš„æœºå™¨ä¸Šæ„å»ºMXNetï¼ˆè¯·æ³¨æ„ï¼Œè¯¥åº“ä¸æ˜¯è·¨å¹³å°çš„ï¼›å¦‚æœæ‚¨åœ¨Linuxä¸Šæ„å»ºå®ƒï¼Œé‚£ä¹ˆå®ƒå°†æ— æ³•åœ¨Mac OSä¸Šè¿è¡Œï¼‰ï¼Œ </li><li> æˆ–å°†å…¶ä»æˆ‘ä»¬ä¹‹å‰æ„å»ºçš„Dockeræ˜ åƒä¸­æ‹‰å‡ºã€‚ å¦‚æœæ‚¨å†³å®šåœ¨æœ¬åœ°ç¯å¢ƒä¸­æ„å»ºMXNetï¼Œåˆ™mxnet_2.12.shè„šæœ¬å°†ä¸ºæ‚¨æä¾›å¸®åŠ©ã€‚ </li></ul><br> æ‚¨å¯ä»¥åƒè¿™æ ·ä»Dockeré•œåƒä¸­æå–åº“ï¼š <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#   your@pc$ mkdir dependencies #  Docker-    your@pc$ docker run -it --rm -v $(pwd)/dependencies:/tmp/dependencies entony/scala-mxnet-cuda-cudnn:2.12-1.3.1-9-7-runtime #          ab38e73d93@root$ cp /usr/local/share/mxnet/scala/linux-x86_64-gpu/mxnet-full_2.12-linux-x86_64-gpu-1.3.1-SNAPSHOT.jar /tmp/dependencies/mxnet-full_2.12-linux-x86_64-gpu-1.3.1-SNAPSHOT.jar ab38e73d93@root$ exit #  , ! your@pc$ ls dependencies/ mxnet-full_2.12-linux-x86_64-gpu-1.3.1-SNAPSHOT.jar</span></span></code> </pre> <br>  modelsç›®å½•åŒ…å«å—è¿‡è®­ç»ƒçš„ç¥ç»ç½‘ç»œçš„æ–‡ä»¶ï¼Œæ‚¨å¯ä»¥æŒ‰ä»¥ä¸‹æ–¹å¼å…è´¹ä¸‹è½½å®ƒä»¬ï¼š <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#   your@pc$ mkdir models #     your@pc$ wget https://s3.amazonaws.com/model-server/models/resnet50_ssd/resnet50_ssd_model-symbol.json -P models your@pc$ wget https://s3.amazonaws.com/model-server/models/resnet50_ssd/resnet50_ssd_model-0000.params -P models your@pc$ wget https://s3.amazonaws.com/model-server/models/resnet50_ssd/synset.txt -P models</span></span></code> </pre> <br> è¿›ä¸€æ­¥ç®€è¦ä»‹ç»ä¸ç‰¹åˆ«æ„Ÿå…´è¶£ä½†åœ¨é¡¹ç›®ä¸­èµ·ä½œç”¨çš„æ–‡ä»¶ã€‚ <br><br><h4> é¡¹ç›®/ build.properties </h4><br><pre> <code class="scala hljs">#   <span class="hljs-type"><span class="hljs-type">Sbt</span></span>,   sbt.version = <span class="hljs-number"><span class="hljs-number">1.2</span></span><span class="hljs-number"><span class="hljs-number">.6</span></span></code> </pre> <br><h4> é¡¹ç›®/ plugins.sbt </h4><br><pre> <code class="scala hljs"><span class="hljs-comment"><span class="hljs-comment">//    sbt-pack addSbtPlugin("org.xerial.sbt" % "sbt-pack" % "0.12")</span></span></code> </pre> <br><h4>  src /ä¸»/èµ„æº/ cat_and_dog.jpg </h4><br> å¦‚æ­¤ç¾å¦™çš„å›¾ç”»ï¼Œå…¶ä¸­æˆ‘ä»¬çš„ç¥ç»ç½‘ç»œå°†å¯»æ‰¾çŒ«å’Œç‹—ã€‚ <br><img src="https://habrastorage.org/getpro/habr/post_images/b6b/8ed/425/b6b8ed425ab6affb5cce1e83731b35a9.png"><br><br><h4>  build.sbt </h4><br><pre> <code class="scala hljs">enablePlugins(<span class="hljs-type"><span class="hljs-type">PackPlugin</span></span>) name := <span class="hljs-string"><span class="hljs-string">"simple-predictor"</span></span> version := <span class="hljs-string"><span class="hljs-string">"0.1"</span></span> scalaVersion := <span class="hljs-string"><span class="hljs-string">"2.12.7"</span></span> unmanagedBase := baseDirectory.value / <span class="hljs-string"><span class="hljs-string">"dependencies"</span></span> <span class="hljs-comment"><span class="hljs-comment">//  (   ) libraryDependencies ++= Seq( "org.json4s" %% "json4s-native" % "3.6.1", "org.scalatest" %% "scalatest" % "3.0.5" % Test, "org.scalaj" %% "scalaj-http" % "2.4.1" % Test ) //       packMain := Map("simple-predictor" -&gt; "simple.predictor.Runs") //    bat-,      ,   Linux packGenerateWindowsBatFile := false //    JVM packJvmOpts := Map("simple-predictor" -&gt; Seq( "-Xms3g", "-Xmx5g"))</span></span></code> </pre> <br><h4>  simple.predictor.Config </h4><br> æ­¤å¯¹è±¡å­˜å‚¨å…¨å±€å˜é‡ï¼Œå…¶å€¼æ˜¯ä»ç¯å¢ƒå˜é‡ä¸­è¯»å–çš„æˆ–é»˜è®¤è®¾ç½®çš„ã€‚ <br><br><pre> <code class="scala hljs"><span class="hljs-keyword"><span class="hljs-keyword">package</span></span> simple.predictor <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.apache.mxnet.<span class="hljs-type"><span class="hljs-type">Context</span></span> <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> scala.util.<span class="hljs-type"><span class="hljs-type">Try</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">object</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Config</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//    REST API val host: String = env("REST_HOST") getOrElse "0.0.0.0" //    REST API val port: Int = env("REST_PORT") flatMap (p =&gt; Try(p.toInt).toOption) getOrElse 8080 // URL,     POST-   val entryPoint: String = env("REST_ENTRY_POINT") getOrElse "/predict" //  ,       val threshold: Float = env("PROBABILITY_MORE") flatMap (p =&gt; Try(p.toFloat).toOption) getOrElse 0.5f //        val modelPrefix: String = env("MODEL_PREFIX") getOrElse "models/resnet50_ssd_model" //    (    ...-0000.params) val modemEpoch: Int = env("MODEL_EPOCH") flatMap (p =&gt; Try(p.toInt).toOption) getOrElse 0 //   ,     ,    512 val modemEdge: Int = env("MODEL_EDGE") flatMap (p =&gt; Try(p.toInt).toOption) getOrElse 512 //  ,   CPU ( ).  production  GPU val context: Context = env("MODEL_CONTEXT_GPU") flatMap { isGpu =&gt; Try(if (isGpu.toBoolean) Context.gpu() else Context.cpu()).toOption } getOrElse Context.cpu() private def env(name: String) = Option(System.getenv(name)) }</span></span></code> </pre> <br><h4>  simple.predictor.Run </h4><br> è¿è¡Œå¯¹è±¡æ˜¯åº”ç”¨ç¨‹åºçš„å…¥å£ç‚¹ã€‚ <br><br><pre> <code class="scala hljs"><span class="hljs-keyword"><span class="hljs-keyword">package</span></span> simple.predictor <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.net.<span class="hljs-type"><span class="hljs-type">InetSocketAddress</span></span> <span class="hljs-comment"><span class="hljs-comment">//     import simple.predictor.Config._ object Run extends App { //     REST- val model = new Model(modelPrefix, modemEpoch, modemEdge, threshold, context) val server = new Server(new InetSocketAddress(host, port), entryPoint, model) //   Ctrl + C    Runtime.getRuntime.addShutdownHook(new Thread(() =&gt; server.stop())) //      try server.start() catch { case ex: Exception =&gt; ex.printStackTrace() } }</span></span></code> </pre> <br><a name="5"></a><h1>  5.ç¥ç»ç½‘ç»œåŠ è½½ </h1><br> ç¥ç»ç½‘ç»œè¢«åŠ è½½åˆ°<code>simple.predictor.Model</code>ç±»çš„æ„é€ å‡½æ•°ä¸­ã€‚ <br><br><h4>  simple.predictor.Model </h4><br><pre> <code class="scala hljs"><span class="hljs-keyword"><span class="hljs-keyword">package</span></span> simple.predictor <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.awt.image.<span class="hljs-type"><span class="hljs-type">BufferedImage</span></span> <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.apache.mxnet._ <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.apache.mxnet.infer.<span class="hljs-type"><span class="hljs-type">ObjectDetector</span></span> <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> simple.predictor.<span class="hljs-type"><span class="hljs-type">Model</span></span>.<span class="hljs-type"><span class="hljs-type">Prediction</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Model</span></span></span><span class="hljs-class">(</span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">prefix: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">String</span></span></span></span><span class="hljs-class"><span class="hljs-params">, epoch: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Int</span></span></span></span><span class="hljs-class"><span class="hljs-params">, imageEdge: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Int</span></span></span></span><span class="hljs-class"><span class="hljs-params">, threshold: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Float</span></span></span></span><span class="hljs-class"><span class="hljs-params">, context: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Context</span></span></span></span></span><span class="hljs-class">) </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//       val initShape = Shape(1, 3, imageEdge, imageEdge) val initData = DataDesc(name = "data", initShape, DType.Float32, Layout.NCHW) //           val model = new ObjectDetector(prefix, IndexedSeq(initData), context, Option(epoch)) //         ,       JSON private def toPrediction(originWidth: Int, originHeight: Int)(predict: (String, Array[Float])): Prediction = { val (objectClass, Array(probability, kx, ky, kw, kh)) = predict //        val x = (originWidth * kx).toInt val y = (originHeight * ky).toInt val w = (originWidth * kw).toInt val h = (originHeight * kh).toInt val width = if ((x + w) &lt; originWidth) w else originWidth - x val height = if (y + h &lt; originHeight) h else originHeight - y Prediction(objectClass, probability, x, y, width, height) } //     ,         ,     threshold def predict(image: BufferedImage): Seq[Prediction] = model.imageObjectDetect(image).head map toPrediction(image.getWidth, image.getHeight) filter (_.probability &gt; threshold) } object Model { //   case class Prediction(objectClass: String, probability: Float, x: Int, y: Int, width: Int, height: Int) }</span></span></code> </pre> <br> åœ¨<code>     </code>éƒ¨åˆ†ä¸­<code>     </code>æ‚¨è¯´åœ¨ç¥ç»ç½‘ç»œä¸­å®ƒå°†ä¸å°ºå¯¸ä¸º1 x 3 x 512 x 512çš„<code>NDArray</code>ä¸€èµ·ä½¿ç”¨ï¼Œå…¶ä¸­1æ˜¯NDArrayä¸­åŒ…å«çš„å›¾åƒæ•°ï¼Œ3æ˜¯é¢œè‰²æ•°ï¼Œè€Œ512 x 512 -å›¾åƒå¤§å°ï¼ˆåœ¨<code>simple.predict.Config</code>å¯¹è±¡ä¸­è®¾ç½®äº†<code>imageEdge = 12</code>çš„å€¼ï¼Œè¿™æ˜¯ç”¨äºè®­ç»ƒç¥ç»ç½‘ç»œçš„å›¾åƒçš„ä¾§é¢å¤§å°ï¼‰ã€‚ æ‰€æœ‰è¿™äº›æ•°æ®æè¿°éƒ½ä¼ é€’ç»™<code>ObjectDetector</code> ã€‚ <br><br> å¦ä¸€ä¸ªæœ‰è¶£çš„éƒ¨åˆ†æ˜¯<code>      </code> ã€‚ <br><br> é€šè¿‡ç¥ç»ç½‘ç»œè¿è¡Œå›¾åƒåï¼Œç»“æœä¸º<code>Seq[Seq[(String, Array[Float])]]</code> ã€‚ ç¬¬ä¸€ä¸ªé›†åˆä»…åŒ…å«ä¸€ä¸ªç»“æœï¼ˆæ•°æ®æ ¼å¼ç”±ç‰¹å®šçš„ç¥ç»ç½‘ç»œç¡®å®šï¼‰ï¼Œç„¶åä¸‹ä¸€ä¸ªé›†åˆçš„æ¯ä¸ªå…ƒç´ éƒ½æ˜¯ä¸¤ä¸ªå…ƒç´ çš„å…ƒç»„ï¼š <br><br><ol><li> ç±»åˆ«åç§°ï¼ˆâ€œçŒ«â€ï¼Œâ€œç‹—â€ï¼Œ...ï¼‰ï¼Œ </li><li> ä¸€ä¸ªç”±äº”ä¸ªæµ®ç‚¹æ•°ç»„æˆçš„æ•°ç»„ï¼šç¬¬ä¸€ä¸ªæ˜¯æ¦‚ç‡ï¼Œç¬¬äºŒä¸ªæ˜¯ç”¨äºè®¡ç®—<code>x</code>åæ ‡çš„ç³»æ•°ï¼Œç¬¬ä¸‰ä¸ªæ˜¯ç”¨äºè®¡ç®—<code>y</code>åæ ‡çš„ç³»æ•°ï¼Œç¬¬å››ä¸ªæ˜¯ç”¨äºè®¡ç®—çŸ©å½¢å®½åº¦çš„ç³»æ•°ï¼Œç¬¬äº”ä¸ªæ˜¯ç”¨äºè®¡ç®—çŸ©å½¢é«˜åº¦çš„ç³»æ•°ã€‚ </li></ol><br> è¦è·å¾—çŸ©å½¢åæ ‡å’Œå°ºå¯¸çš„å®é™…å€¼ï¼Œæ‚¨éœ€è¦å°†å›¾åƒçš„åŸå§‹å®½åº¦å’Œé«˜åº¦ä¹˜ä»¥ç›¸åº”çš„ç³»æ•°ã€‚ <br> æˆ‘å¯¹<code>NDArray</code>çš„è¯é¢˜<code>NDArray</code> ã€‚ è¿™æ˜¯MXNetåœ¨ç»™å®šä¸Šä¸‹æ–‡ï¼ˆCPUæˆ–GPUï¼‰ä¸­åˆ›å»ºçš„å¤šç»´æ•°ç»„ã€‚ åˆ›å»ºNDArrayæ—¶ï¼Œä¼šå½¢æˆä¸€ä¸ªC ++å¯¹è±¡ï¼Œè¯¥å¯¹è±¡å¯ä»¥éå¸¸å¿«é€Ÿåœ°æ‰§è¡Œæ“ä½œï¼ˆå¦‚æœåœ¨GPUä¸Šä¸‹æ–‡ä¸­åˆ›å»ºï¼Œåˆ™å‡ ä¹æ˜¯ç¬æ—¶çš„ï¼‰ï¼Œä½†æ˜¯æ‚¨å¿…é¡»ä¸ºæ­¤ä»˜å‡ºä»£ä»·ã€‚ ç»“æœï¼ˆè‡³å°‘åœ¨MXNet 1.3.1ç‰ˆæœ¬ä¸­ï¼‰ï¼Œæ‚¨éœ€è¦ç‹¬ç«‹ç®¡ç†ä¸º<code>NDArray</code>åˆ†é…çš„å†…å­˜ï¼Œå¹¶ä¸”ä¸è¦å¿˜è®°åœ¨ä½¿ç”¨å®Œè¿™äº›å¯¹è±¡åä»å†…å­˜ä¸­å¸è½½è¿™äº›å¯¹è±¡ã€‚ å¦åˆ™ï¼Œå°†ä¼šæœ‰ç›¸å½“å¤§ä¸”ç›¸å½“å¿«çš„å†…å­˜æ³„æ¼ï¼Œè¿™éå¸¸ä¸ä¾¿äºç›‘è§†ï¼Œå› ä¸ºç”¨äºJVMæ€§èƒ½åˆ†æçš„ç¨‹åºçœ‹ä¸åˆ°å®ƒã€‚ å¦‚æœæ‚¨åœ¨GPUä¸Šä¸‹æ–‡ä¸­å·¥ä½œï¼Œåˆ™å†…å­˜é—®é¢˜ä¼šæ›´åŠ ä¸¥é‡ï¼Œå› ä¸ºè§†é¢‘å¡æ²¡æœ‰å¤§é‡å†…å­˜ï¼Œå¹¶ä¸”åº”ç”¨ç¨‹åºå¾ˆå¿«å´©æºƒè€Œå¯¼è‡´å†…å­˜ä¸è¶³ã€‚ <br><br> å¦‚ä½•è§£å†³å†…å­˜æ³„æ¼é—®é¢˜ï¼Ÿ <br><br> åœ¨ä¸Šé¢çš„ç¤ºä¾‹ä¸­ï¼Œåœ¨å°†<code>model.imageObjectDetect(image).head map toPrediction(image.getWidth, image.getHeight) filter (_.probability &gt; threshold)</code> ï¼Œ <code>imageObjectDetect</code>æ–¹æ³•ç”¨äºé€šè¿‡ç¥ç»ç½‘ç»œè¿è¡Œå›¾åƒï¼Œè¯¥ç¥ç»ç½‘ç»œæ¥æ”¶<code>BufferedImage</code>è¾“å…¥ã€‚  <code>NDArray</code>æ‰€æœ‰<code>NDArray</code>è½¬æ¢å‡åœ¨æ–¹æ³•å†…éƒ¨å®Œæˆï¼Œæ‚¨æ— éœ€è€ƒè™‘å†…å­˜é‡Šæ”¾é—®é¢˜ã€‚ å¦ä¸€æ–¹é¢ï¼Œåœ¨å°†<code>BufferedImage</code>è½¬æ¢ä¸º<code>NDArray</code>ä¹‹å‰ï¼Œ <code>NDArray</code> 512 x 512çš„å¤§å°è¿›è¡Œ<code>NDArray</code> ï¼Œå¹¶ä½¿ç”¨<code>BufferedImage</code>ç±»å‹çš„å¯¹è±¡çš„æ–¹æ³•å¯¹å›¾åƒè¿›è¡Œè§„èŒƒåŒ–ã€‚ ä¾‹å¦‚ï¼Œè¿™ç§æƒ…å†µæ¯”ä½¿ç”¨OpenCVå‘ç”Ÿçš„æ—¶é—´æ›´é•¿ï¼Œä½†æ˜¯å®ƒè§£å†³äº†åœ¨ä½¿ç”¨<code>NDArray</code>ä¹‹åé‡Šæ”¾å†…å­˜çš„é—®é¢˜ã€‚ <br><br> å½“ç„¶ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨OpenCVå¹¶è‡ªå·±æ§åˆ¶å†…å­˜ï¼Œä¸ºæ­¤ï¼Œæ‚¨åªéœ€è¦è°ƒç”¨<code>dispose</code>çš„<code>NDArray</code>æ–¹æ³•<code>dispose</code> ï¼Œä½†æ˜¯ç”±äºæŸç§åŸå› ï¼Œæ‚¨å¿˜è®°äº†åœ¨Scalaçš„å®˜æ–¹MXNetæ–‡æ¡£ä¸­æåŠæ­¤é—®é¢˜ã€‚ <br><br>  MXNetè¿˜æœ‰ä¸€ç§ä¸å¤ªæ–¹ä¾¿çš„æ–¹æ³•æ¥æ§åˆ¶ç”±äº<code>NDArray</code>å‘ç”Ÿçš„å†…å­˜æ³„æ¼ã€‚ ä¸ºæ­¤ï¼Œè¯·ä½¿ç”¨JVMå‚æ•°<code>Dmxnet.traceLeakedObjects=true</code>è¿è¡Œåº”ç”¨ç¨‹åºã€‚ å¦‚æœMXNetæ³¨æ„åˆ°ä¸€ä¸ªæœªä½¿ç”¨ä½†æŒ‚åœ¨å†…å­˜ä¸­çš„<code>NDArray</code> ï¼Œæ‚¨å°†å¾—åˆ°ä¸€ä¸ªå¼‚å¸¸ï¼ŒæŒ‡ç¤ºå‘½è¿å¤šçš„<code>NDArray</code>å“ªä¸€è¡Œä»£ç <code>NDArray</code> ã€‚ <br><br> æˆ‘çš„å»ºè®®æ˜¯ï¼šç›´æ¥ä¸NDArrayä¸€èµ·ä½¿ç”¨ï¼Œä»”ç»†ç›‘è§†å†…å­˜å¹¶è‡ªè¡Œç¼–å†™è§„èŒƒåŒ–ï¼Œå¹¶ä¸”äº‹å…ˆæŒ‡å®šäº†MLå·¥ç¨‹å¸ˆåœ¨è®­ç»ƒç¥ç»ç½‘ç»œæ—¶é‡‡ç”¨çš„ç®—æ³•ï¼Œå¦åˆ™ç»“æœå°†å®Œå…¨ä¸åŒã€‚  <code>ObjectDetector</code>æœ‰ä¸€ä¸ª<code>objectDetectWithNDArray</code>æ–¹æ³•ï¼Œæ‚¨å¯ä»¥å°†<code>NDArray</code>ä¼ é€’ç»™è¯¥æ–¹æ³•ã€‚ ä¸ºäº†å®ç°æ›´é€šç”¨çš„åŠ è½½ç¥ç»ç½‘ç»œçš„æ–¹æ³•ï¼Œæˆ‘å»ºè®®ä½¿ç”¨<code>org.apache.mxnet.module.Module</code>å¯¹è±¡ã€‚ ä»¥ä¸‹æ˜¯ä½¿ç”¨ç¤ºä¾‹ã€‚ <br><br><pre> <code class="scala hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.apache.mxnet._ <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.apache.mxnet.io.<span class="hljs-type"><span class="hljs-type">NDArrayIter</span></span> <span class="hljs-comment"><span class="hljs-comment">//      val model: Module = { val model = Module.loadCheckpoint(modelPrefix, modelEpoch, contexts = contexts) model.bind( forTraining = false, inputsNeedGrad = false, forceRebind = false, dataShape = DataDesc(name = "data", Shape(1, 3, 512, 512), DType.Float32, Layout.NCHW)) model.initParams() model } // NDArray  1  3  512  512 val image: NDArray = ??? //  dataBatch      val iterator = new NDArrayIter(IndexedSeq(image)) val dataBatch = iterator.next() image.dispose() //   val result: Seq[Array[Float]] = model.predict(dataBatch) map { ndArray =&gt; val array = ndArray.toArray ndArray.dispose() array } dataBatch.dispose()</span></span></code> </pre> <br><a name="6"></a><h1>  6. REST APIå®æ–½ </h1><br>  <code>simple.predictor.Server</code>ç±»è´Ÿè´£å®ç°REST APIã€‚ è¯¥æœåŠ¡å™¨åŸºäºJavaä¸­åŒ…å«çš„JavaæœåŠ¡å™¨ã€‚ <br><br><h4>  simple.predictor.Server </h4><br><pre> <code class="scala hljs"><span class="hljs-keyword"><span class="hljs-keyword">package</span></span> simple.predictor <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.net.<span class="hljs-type"><span class="hljs-type">InetSocketAddress</span></span> <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.sun.net.httpserver.{<span class="hljs-type"><span class="hljs-type">HttpExchange</span></span>, <span class="hljs-type"><span class="hljs-type">HttpServer</span></span>} <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> javax.imageio.<span class="hljs-type"><span class="hljs-type">ImageIO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.json4s.<span class="hljs-type"><span class="hljs-type">DefaultFormats</span></span> <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.json4s.native.<span class="hljs-type"><span class="hljs-type">Serialization</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Server</span></span></span><span class="hljs-class">(</span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">address: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">InetSocketAddress</span></span></span></span><span class="hljs-class"><span class="hljs-params">, entryPoint: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">String</span></span></span></span><span class="hljs-class"><span class="hljs-params">, model: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Model</span></span></span></span></span><span class="hljs-class">) </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//   HTTP-,     java private val server = HttpServer.create(address, 0) //      URL server.createContext(entryPoint, (http: HttpExchange) =&gt; { //   HTTP-     val header = http.getRequestHeaders val (httpCode, json) = if (header.containsKey("Content-Type") &amp;&amp; header.getFirst("Content-Type") == "image/jpeg") { //          ,      200 val image = ImageIO.read(http.getRequestBody) val predictionSeq = model.predict(image) (200, Map("prediction" -&gt; predictionSeq)) } else (400, Map("error" -&gt; "Invalid content")) //       400 //    JSON    val responseJson = Serialization.write(json)(DefaultFormats) val httpOs = http.getResponseBody http.getResponseHeaders.set("Content-Type", "application/json") http.sendResponseHeaders(httpCode, responseJson.length) httpOs.write(responseJson.getBytes) httpOs.close() }) def start(): Unit = server.start() def stop(): Unit = server.stop(0) }</span></span></code> </pre> <br><a name="7"></a><h1>  7.æµ‹è¯• </h1><br> è¦è¿›è¡Œæ£€æŸ¥ï¼Œè¯·å¯åŠ¨æœåŠ¡å™¨å¹¶å‘é€æµ‹è¯•å›¾ç‰‡src / main / resources / cat_and_dog.jpgã€‚ æˆ‘ä»¬å°†è§£æä»æœåŠ¡å™¨æ¥æ”¶åˆ°çš„JSONï¼Œæ£€æŸ¥ç¥ç»ç½‘ç»œåœ¨å›¾ç‰‡ä¸­æ‰¾åˆ°äº†å¤šå°‘ä¸ªå¯¹è±¡ï¼Œå¹¶åœ¨å›¾ç‰‡ä¸­åœˆå‡ºäº†å¯¹è±¡ã€‚ <br><br><h4>  simple.predictor.ServerTest </h4><br><pre> <code class="scala hljs"><span class="hljs-keyword"><span class="hljs-keyword">package</span></span> simple.predictor <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.awt.{<span class="hljs-type"><span class="hljs-type">BasicStroke</span></span>, <span class="hljs-type"><span class="hljs-type">Color</span></span>, <span class="hljs-type"><span class="hljs-type">Font</span></span>} <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.awt.image.<span class="hljs-type"><span class="hljs-type">BufferedImage</span></span> <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.io.{<span class="hljs-type"><span class="hljs-type">ByteArrayOutputStream</span></span>, <span class="hljs-type"><span class="hljs-type">File</span></span>} <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.net.<span class="hljs-type"><span class="hljs-type">InetSocketAddress</span></span> <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> javax.imageio.<span class="hljs-type"><span class="hljs-type">ImageIO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.scalatest.{<span class="hljs-type"><span class="hljs-type">FlatSpec</span></span>, <span class="hljs-type"><span class="hljs-type">Matchers</span></span>} <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> scalaj.http.<span class="hljs-type"><span class="hljs-type">Http</span></span> <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.json4s.{<span class="hljs-type"><span class="hljs-type">DefaultFormats</span></span>, <span class="hljs-type"><span class="hljs-type">Formats</span></span>} <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.json4s.native.<span class="hljs-type"><span class="hljs-type">JsonMethods</span></span>.parse <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> simple.predictor.<span class="hljs-type"><span class="hljs-type">Config</span></span>._ <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> simple.predictor.<span class="hljs-type"><span class="hljs-type">Model</span></span>.<span class="hljs-type"><span class="hljs-type">Prediction</span></span> <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> scala.concurrent.<span class="hljs-type"><span class="hljs-type">Future</span></span> <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> scala.concurrent.<span class="hljs-type"><span class="hljs-type">ExecutionContext</span></span>.<span class="hljs-type"><span class="hljs-type">Implicits</span></span>.global <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ServerTest</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">FlatSpec</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">with</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Matchers</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">implicit</span></span> <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> formats: <span class="hljs-type"><span class="hljs-type">Formats</span></span> = <span class="hljs-type"><span class="hljs-type">DefaultFormats</span></span> <span class="hljs-string"><span class="hljs-string">"Service"</span></span> should <span class="hljs-string"><span class="hljs-string">"find a cat and a dog on photo"</span></span> in { <span class="hljs-comment"><span class="hljs-comment">//      val model = new Model(modelPrefix, modemEpoch, modemEdge, threshold, context) val server = new Server(new InetSocketAddress(host, port), entryPoint, model) //      Future(server.start()) Thread.sleep(5000) //         val image = ImageIO.read(getClass.getResourceAsStream("/cat_and_dog.jpg")) val byteOS = new ByteArrayOutputStream() ImageIO.write(image, "jpg", byteOS) val data = byteOS.toByteArray //      ,     200 val response = Http(s"http://$host:$port$entryPoint").header("Content-Type", "image/jpeg").postData(data).asString response.code shouldEqual 200 //  JSON-, ,       val prediction = parse(response.body) \\ "prediction" prediction.children.size shouldEqual 2 //     , ,     ,    val objectClassList = (prediction \\ "objectClass").children map (_.extract[String]) objectClassList.head shouldEqual "cat" objectClassList.tail.head shouldEqual "dog" //   ,   val bBoxCoordinates = prediction.children.map(_.extract[Prediction]) //   ,     val imageWithBoundaryBoxes = new BufferedImage(image.getWidth, image.getHeight, image.getType) val graph = imageWithBoundaryBoxes.createGraphics() graph.drawImage(image, 0, 0, null) graph.setColor(Color.RED) graph.setStroke(new BasicStroke(5)) graph.setFont(new Font(Font.SANS_SERIF, Font.TRUETYPE_FONT, 30)) bBoxCoordinates foreach { case Prediction(obj, prob, x, y, width, height) =&gt; graph.drawRect(x, y, width, height) graph.drawString(s"$obj, prob: $prob", x + 15, y + 30) } graph.dispose() //         ImageIO.write(imageWithBoundaryBoxes, "jpg", new File("./test.jpg")) } }</span></span></code> </pre> <br>     ,       . <br><br><img src="https://habrastorage.org/getpro/habr/post_images/ea2/454/57d/ea245457d175d072a8eb8c98ef4551ce.png"><br><br><a name="8"></a><h1> 8.       </h1><br>  ,      .     Docker   ,    . <br><br><h4> Dockerfile </h4><br><pre> <code class="plaintext hljs">#       Sbt FROM entony/scala-mxnet-cuda-cudnn:2.12-1.3.1-9-7-builder AS builder #       RUN mkdir /tmp/source /tmp/source/dependencies COPY project /tmp/source/project COPY src /tmp/source/src COPY build.sbt /tmp/source/build.sbt #     MXNet,       RUN ln -s /usr/local/share/mxnet/scala/linux-x86_64-gpu/mxnet-full_2.12-linux-x86_64-gpu-1.3.1-SNAPSHOT.jar /tmp/source/dependencies/mxnet-full_2.12-linux-x86_64-gpu-1.3.1-SNAPSHOT.jar &amp;&amp; \ cd /tmp/source/ &amp;&amp; sbt pack #      FROM entony/scala-mxnet-cuda-cudnn:2.12-1.3.1-9-7-runtime #   LD   Cuda   Java ENV LD_LIBRARY_PATH /usr/local/cuda-9.0/targets/x86_64-linux/lib/stubs:/usr/local/share/OpenCV/java #            /opt/app/models ENV MODEL_PREFIX "/opt/app/models/resnet50_ssd_model" #            RUN mkdir -p /opt/app COPY --from=builder --chown=root:root /tmp/source/target/pack /opt/app COPY models /opt/app/models #      ENTRYPOINT /opt/app/bin/simple-predictor</code> </pre> <br>         <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># ,    ,   Dockerfile your@pc$ docker build -f Dockerfile -t entony/simple-predictor:1.0.0 . #   docker hub your@pc$ docker push entony/simple-predictor:1.0.0</span></span></code> </pre> <br><a name="9"></a><h1> 9.    production-  GPU </h1><br> ,      docker hub,      Nvidia,  8080    Docker, Cuda 9.0  Cudnn 7. <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#     Docker hub your@server-with-gpu$ docker pull entony/simple-predictor:1.0.0 #     your@server-with-gpu$ docker run -d \ -p 8080:8080 \ -e MODEL_CONTEXT_GPU=true \ -e MXNET_CUDNN_AUTOTUNE_DEFAULT=0 \ --name 'simple_predictor' \ --device /dev/nvidia0:/dev/nvidia0 \ --device /dev/nvidiactl:/dev/nvidiactl \ --device /dev/nvidia-uvm:/dev/nvidia-uvm \ -v /usr/lib/x86_64-linux-gnu/libcuda.so.1:/usr/local/cuda-9.0/targets/x86_64-linux/lib/stubs/libcuda.so.1:ro \ -v /usr/lib/nvidia-396/libnvidia-fatbinaryloader.so.396.54:/usr/local/cuda-9.0/targets/x86_64-linux/lib/stubs/libnvidia-fatbinaryloader.so.396.54:ro \ entony/simple-predictor:1.0.0</span></span></code> </pre> <br>         Docker-   <code>--device</code>   Cuda-   <code>-v</code> . <br><br>   <code>MODEL_CONTEXT_GPU</code>     GPU-,  <code>MXNET_CUDNN_AUTOTUNE_DEFAULT</code>          (  ,      ,     ,  ). <br><br>      : <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#  your@server-with-gpu$ curl -X POST -H 'Content-Type: image/jpeg' --data-binary '@src/main/resources/cat_and_dog.jpg' http://0.0.0.0:8080/predict #  { "prediction":[ { "objectClass":"cat", "probability":0.9959417, "x":72,"y":439, "width":950, "height":987 }, { "objectClass":"dog", "probability":0.81277525, "x":966, "y":100, "width":870, "height":1326 } ] }</span></span></code> </pre> <br><a name="10"></a><h1> ç»“è®º </h1><br> MXNet   ,    -    .  ,    ,   ,     production. <br><br>   , ,   MXNet    ,      Python      production  Scala, Java  ++. <br><br>        ,                   . <br><br> ,        .          . è°¢è°¢æ‚¨çš„å…³æ³¨ã€‚ <br><br><a name="11"></a><h1> å‚è€ƒæ–‡çŒ® </h1><br><ul><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Git   Docker-</a> </li><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Git    </a> </li><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">     MXNet</a> </li></ul></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN439226/">https://habr.com/ru/post/zh-CN439226/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN439216/index.html">åœ¨golangä¸Špudge 500è¡Œå¯åµŒå…¥æ•°æ®åº“</a></li>
<li><a href="../zh-CN439218/index.html">VKæœºå™¨äººè·ªåœ¨åœ°ä¸Šï¼Œæˆ–å¦‚ä½•åœ¨2æœˆ14æ—¥å–æ‚¦äººä»¬</a></li>
<li><a href="../zh-CN439220/index.html">Unityä¸Šç§»åŠ¨è®¾å¤‡çš„å¤§åŸå¸‚ã€‚ å¼€å‘å’Œä¼˜åŒ–ç»éªŒ</a></li>
<li><a href="../zh-CN439222/index.html">ä»€ä¹ˆæ˜¯APIç®¡ç†ï¼Ÿ</a></li>
<li><a href="../zh-CN439224/index.html">å…³äºVoronoiå›¾</a></li>
<li><a href="../zh-CN439232/index.html">JAMstackï¼šå¦‚ä½•ä½¿ç”¨Gatsby + Contentful + Netlifyåˆ›å»ºè‡ªå·±çš„åšå®¢</a></li>
<li><a href="../zh-CN439234/index.html">å¼€æºå¼€å‘äººå‘˜åœ¨GIFä¸­çš„ç”Ÿæ´»</a></li>
<li><a href="../zh-CN439236/index.html">xenvmanï¼šçµæ´»çš„å¾®æœåŠ¡æµ‹è¯•ç¯å¢ƒï¼ˆä»¥åŠæ›´å¤šï¼‰</a></li>
<li><a href="../zh-CN439238/index.html">Playå•†åº—ç°åœ¨æ¥å—æ¸è¿›å¼Webåº”ç”¨ç¨‹åºï¼ˆPWAï¼‰</a></li>
<li><a href="../zh-CN439240/index.html">2019å¹´1æœˆçš„Joomlaæ‘˜è¦</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>