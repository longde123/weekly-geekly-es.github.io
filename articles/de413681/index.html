<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üìù üí© üëÜüèº Die Technik zur Entwicklung hochzuverl√§ssiger Server auf Go üéØ üë®üèø‚Äçü§ù‚Äçüë®üèº ‚è©</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Von Zeit zu Zeit stehen Webprogrammierer vor Aufgaben, die sogar Profis erschrecken k√∂nnen. Wir sprechen √ºber die Entwicklung von Serveranwendungen, d...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Die Technik zur Entwicklung hochzuverl√§ssiger Server auf Go</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/ruvds/blog/413681/">  Von Zeit zu Zeit stehen Webprogrammierer vor Aufgaben, die sogar Profis erschrecken k√∂nnen.  Wir sprechen √ºber die Entwicklung von Serveranwendungen, die nicht das Recht haben, Fehler zu machen, √ºber Projekte, bei denen die Ausfallkosten extrem hoch sind.  Der Autor des Materials, dessen √úbersetzung wir heute ver√∂ffentlichen, wird dar√ºber sprechen, wie solche Aufgaben angegangen werden sollen. <br><br> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><img src="https://habrastorage.org/webt/2r/ma/ty/2rmaty9ihtz7cjzhhvzqgm5e7ia.jpeg"></a> <br><a name="habracut"></a><br><h2>  <font color="#3AC1EF">Welches Ma√ü an Zuverl√§ssigkeit ben√∂tigt Ihr Projekt?</font> </h2><br>  Bevor Sie sich mit den Details der Entwicklung hochzuverl√§ssiger Serveranwendungen befassen, sollten Sie sich fragen, ob Ihr Projekt wirklich das h√∂chstm√∂gliche Ma√ü an Zuverl√§ssigkeit ben√∂tigt.  Der Prozess der Entwicklung von Systemen f√ºr Arbeitsszenarien, in denen der Fehler einer universellen Katastrophe √§hnelt, kann f√ºr die meisten Projekte, in denen die Folgen m√∂glicher Fehler nicht besonders be√§ngstigend sind, unangemessen kompliziert sein. <br><br>  Wenn sich die Kosten des Fehlers nicht als extrem hoch herausstellen, ist ein Ansatz akzeptabel, bei dessen Implementierung der Entwickler die vern√ºnftigsten Anstrengungen unternimmt, um die Funktionsf√§higkeit des Projekts sicherzustellen, und wenn Probleme auftreten, versteht er sie einfach.  Moderne √úberwachungstools und kontinuierliche Softwarebereitstellungsprozesse erm√∂glichen es Ihnen, Produktionsprobleme schnell zu identifizieren und fast sofort zu beheben.  In vielen F√§llen ist dies ausreichend. <br><br>  In dem Projekt, an dem ich heute arbeite, ist das nicht so.  Wir sprechen √ºber die Implementierung von <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Blockchain</a> - einer verteilten Serverinfrastruktur f√ºr die sichere Ausf√ºhrung von Code in einer Umgebung mit geringem Vertrauen und Konsens.  Eine Anwendung dieser Technologie sind digitale W√§hrungen.  Dies ist ein klassisches Beispiel f√ºr ein System mit extrem hohen Fehlerkosten.  In diesem Fall m√ºssen die Projektentwickler es wirklich sehr, sehr zuverl√§ssig machen. <br><br>  Bei einigen anderen Projekten ist das Streben nach h√∂chster Codezuverl√§ssigkeit jedoch sinnvoll, auch wenn sie nicht mit der Finanzierung zusammenh√§ngen.  Die Kosten f√ºr die Wartung einer h√§ufig fehlerhaften Codebasis k√∂nnen sehr schnell astronomische Werte erreichen.  Die F√§higkeit, Probleme in den fr√ºhen Phasen des Entwicklungsprozesses zu identifizieren, wenn die Kosten f√ºr ihre Behebung noch niedrig sind, scheint eine echte Belohnung f√ºr die rechtzeitige Investition von Zeit und M√ºhe in die Entwicklungsmethodik hochzuverl√§ssiger Systeme zu sein. <br><br><h2>  <font color="#3AC1EF">Vielleicht ist die L√∂sung TDD?</font> </h2><br>  Entwicklung durch Testen ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Test Driven Development</a> , TDD) wird oft als das beste Heilmittel f√ºr schlechten Code angesehen.  TDD ist eine puristische Entwicklungsmethode, bei deren Anwendung zuerst Tests geschrieben werden und erst dann - Code, der dem Projekt nur hinzugef√ºgt wird, wenn die Tests, die es √ºberpr√ºfen, keine Fehler mehr generieren.  Dieser Prozess garantiert eine 100% ige Abdeckung des Codes mit Tests und gibt oft die Illusion, dass der Code in allen m√∂glichen Varianten seiner Verwendung getestet wird. <br><br>  Dies ist jedoch nicht so.  TDD ist eine gro√üartige Methode, die in einigen Bereichen gut funktioniert, aber wirklich zuverl√§ssigen Code zu entwickeln, reicht einfach nicht aus.  Schlimmer noch, TDD inspiriert den Entwickler mit falschem Vertrauen und die Anwendung dieser Methodik kann dazu f√ºhren, dass er aus Faulheit einfach keine Tests schreibt, um das System auf Fehler in Situationen zu √ºberpr√ºfen, deren Auftreten aus Sicht des gesunden Menschenverstandes fast unm√∂glich ist.  Wir werden sp√§ter dar√ºber sprechen. <br><br><h2>  <font color="#3AC1EF">Tests sind der Schl√ºssel zur Zuverl√§ssigkeit</font> </h2><br>  Tats√§chlich spielt es keine Rolle, ob Sie Tests vor dem Schreiben von Code erstellen oder danach, ob Sie eine Entwicklungsmethode wie TDD verwenden oder nicht.  Die Hauptsache ist die Tatsache, Tests zu haben.  Tests sind die beste defensive Verst√§rkung, die Ihren Code vor Produktionsproblemen sch√ºtzt. <br><br>  Da wir unsere Tests sehr oft ausf√ºhren werden, idealerweise nach dem Hinzuf√ºgen jeder neuen Zeile zum Code, ist es erforderlich, dass die Tests automatisiert werden.  Unser Vertrauen in die Qualit√§t des Codes sollte in keiner Weise auf seinen manuellen √úberpr√ºfungen beruhen.  Die Sache ist, dass Menschen dazu neigen, Fehler zu machen.  Die Liebe zum Detail einer Person wird geschw√§cht, nachdem sie dieselbe entmutigende Aufgabe viele Male hintereinander erledigt hat. <br><br>  Tests sollten schnell sein.  Sehr schnell. <br><br>  Wenn die Fertigstellung der Testsuite l√§nger als ein paar Sekunden dauert, sind Entwickler h√∂chstwahrscheinlich faul und f√ºgen dem Projekt Code hinzu, ohne es zu testen.  Geschwindigkeit ist eine der gr√∂√üten St√§rken von Go.  Das Entwicklungs-Toolkit in dieser Sprache ist eines der schnellsten unter den vorhandenen.  Das Kompilieren, Neuerstellen und Testen von Projekten erfolgt in Sekundenschnelle. <br><br>  Dar√ºber hinaus sind Tests eine der wichtigsten Triebkr√§fte von Open Source-Projekten.  Dies gilt beispielsweise f√ºr alles, was mit Blockchain-Technologie zu tun hat.  Open Source ist hier fast eine Religion.  Die Codebasis muss offen sein, um Vertrauen in diejenigen zu gewinnen, die sie verwenden werden.  Dies erm√∂glicht beispielsweise die Durchf√ºhrung der Pr√ºfung und schafft eine Atmosph√§re der Dezentralisierung, in der es keine bestimmten Stellen gibt, die das Projekt kontrollieren. <br><br>  Es macht keinen Sinn, auf einen signifikanten Beitrag externer Entwickler zum Open Source-Projekt zu warten, wenn dieses Projekt keine Qualit√§tstests enth√§lt.  Externe Projektteilnehmer ben√∂tigen Mechanismen, um schnell die Kompatibilit√§t ihrer Texte mit den bereits zum Projekt hinzugef√ºgten Informationen zu √ºberpr√ºfen.  Tats√§chlich sollte der gesamte Testsatz nach Eingang jeder Anforderung zum Hinzuf√ºgen neuen Codes zum Projekt automatisch durchgef√ºhrt werden.  Wenn etwas, das mittels einer solchen Anfrage zum Projekt hinzugef√ºgt werden soll, etwas kaputt macht, sollte der Test dies sofort melden. <br><br>  Die vollst√§ndige Abdeckung der Codebasis mit Tests ist eine tr√ºgerische, aber wichtige Metrik.  Das Ziel, eine 100% ige Codeabdeckung mit Tests zu erreichen, mag √ºbertrieben erscheinen. Wenn Sie jedoch dar√ºber nachdenken, stellt sich heraus, dass ein Teil des Codes ohne √úberpr√ºfung an die Produktion gesendet wird, wenn der Code nicht vollst√§ndig durch Tests abgedeckt ist, was noch nie zuvor ausgef√ºhrt wurde. <br><br>  Die vollst√§ndige Abdeckung des Codes mit Tests bedeutet nicht unbedingt, dass das Projekt gen√ºgend Tests enth√§lt, und bedeutet nicht, dass es sich um Tests handelt, die absolut alle Optionen f√ºr die Verwendung des Codes bieten.  Mit Sicherheit k√∂nnen wir nur sagen, dass der Entwickler sich der absoluten Zuverl√§ssigkeit des Codes nicht sicher sein kann, wenn das Projekt nicht zu 100% in Tests behandelt wird, da einige Teile des Codes niemals getestet werden. <br><br>  Trotzdem gibt es Situationen, in denen zu viele Tests durchgef√ºhrt werden.  Im Idealfall sollte jeder m√∂gliche Fehler zum Scheitern eines Tests f√ºhren.  Wenn die Anzahl der Tests zu hoch ist, dh verschiedene Tests dieselben Codefragmente pr√ºfen, f√ºhrt das √Ñndern des vorhandenen Codes und das √Ñndern des vorhandenen Systemverhaltens dazu, dass die Verarbeitung der vorhandenen Tests zu dem neuen Code zu lange dauert . <br><br><h2>  <font color="#3AC1EF">Warum ist Go eine gute Wahl f√ºr hochzuverl√§ssige Projekte?</font> </h2><br>  Go ist eine statisch typisierte Sprache.  Typen sind ein Vertrag zwischen verschiedenen Codeteilen, die zusammen ausgef√ºhrt werden.  Ohne automatische Typpr√ºfung w√§hrend des Projektzusammenstellungsprozesses m√ºssten wir Tests implementieren, die diese ‚ÄûVertr√§ge‚Äú selbst √ºberpr√ºfen, wenn Sie strenge Regeln f√ºr das Abdecken von Code mit Tests einhalten m√ºssen.  Dies geschieht beispielsweise in Server- und Clientprojekten, die auf JavaScript basieren.  Das Schreiben komplexer Tests, die nur auf die √úberpr√ºfung von Typen abzielen, bedeutet viel zus√§tzlichen Aufwand, der im Fall von Go vermieden werden kann. <br><br>  Go ist eine einfache und dogmatische Sprache.  Wie Sie wissen, enth√§lt Go viele traditionelle Ideen f√ºr Programmiersprachen, wie beispielsweise die klassische OOP-Vererbung.  Komplexit√§t ist der schlimmste Feind zuverl√§ssigen Codes.  Probleme neigen dazu, sich an den Fugen komplexer Strukturen zu verstecken.  Dies dr√ºckt sich in der Tatsache aus, dass typische Optionen f√ºr die Verwendung eines bestimmten Designs zwar leicht zu testen sind, es jedoch bizarre Grenzf√§lle gibt, √ºber die der Testentwickler m√∂glicherweise nicht einmal nachdenkt.  Das Projekt wird am Ende nur einen dieser F√§lle zum Erliegen bringen.  In diesem Sinne ist auch Dogmatismus n√ºtzlich.  In Go gibt es oft nur einen Weg, eine Aktion auszuf√ºhren.  Dies mag wie ein Faktor erscheinen, der den freien Geist des Programmierers zur√ºckh√§lt, aber wenn etwas nur auf eine Weise getan werden kann, ist es schwierig, etwas falsch zu machen. <br><br>  Go ist pr√§gnant, aber ausdrucksstark.  Lesbarer Code ist einfacher zu analysieren und zu pr√ºfen.  Wenn der Code zu ausf√ºhrlich ist, kann sein Hauptzweck im "Rauschen" von Hilfskonstruktionen ertrinken.  Wenn der Code zu pr√§zise ist, k√∂nnen die darauf enthaltenen Programme schwer zu lesen und zu verstehen sein.  Go h√§lt ein Gleichgewicht zwischen Pr√§gnanz und Ausdruckskraft.  Zum Beispiel enth√§lt es nicht viele Hilfskonstrukte, wie in Sprachen wie Java oder C ++.  Gleichzeitig sind Go-Konstruktionen, die sich beispielsweise auf Bereiche wie die Fehlerbehandlung beziehen, sehr klar und sehr detailliert, was die Arbeit des Programmierers vereinfacht und ihm hilft, beispielsweise sicherzustellen, dass er alles √ºberpr√ºft hat, was m√∂glich ist. <br><br>  Go verf√ºgt √ºber eindeutige Fehlerbehandlungs- und Wiederherstellungsmechanismen nach Abst√ºrzen.  Gut abgestimmte Mechanismen zur Behandlung von Laufzeitfehlern sind der Grundstein f√ºr hochzuverl√§ssigen Code.  Go hat strenge Regeln f√ºr die R√ºckgabe und Verteilung von Fehlern.  In Umgebungen wie Node.js f√ºhrt das Verwechseln von Ans√§tzen zur Steuerung des Programmflusses wie R√ºckrufen, Versprechungen und asynchronen Funktionen h√§ufig zu unbehandelten Fehlern, z. B. einer <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">unbehandelten Ablehnung eines Versprechens</a> .  Das Wiederherstellen des Programms nach √§hnlichen Ereignissen ist fast <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">unm√∂glich</a> . <br><br>  Go verf√ºgt √ºber eine umfangreiche Standardbibliothek.  Abh√§ngigkeiten sind ein Risiko, insbesondere wenn ihre Quelle Projekte sind, bei denen der Zuverl√§ssigkeit des Codes nicht gen√ºgend Aufmerksamkeit geschenkt wird.  Eine Serveranwendung, die in Produktion geht, enth√§lt alle Abh√§ngigkeiten.  Wenn etwas schief geht, ist der Entwickler der fertigen Anwendung daf√ºr verantwortlich und nicht derjenige, der eine der von ihm verwendeten Bibliotheken erstellt hat.  In Umgebungen, in denen Projekte geschrieben wurden, f√ºr die kleine Abh√§ngigkeiten bestehen, ist es daher schwieriger, zuverl√§ssige Anwendungen zu erstellen. <br><br>  Abh√§ngigkeiten stellen auch ein Sicherheitsrisiko dar, da die Schwachstellenstufe eines Projekts der Schwachstellenstufe seiner <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">unsichersten Abh√§ngigkeit entspricht</a> .  Die umfangreiche Standardbibliothek Go wird von ihren Entwicklern in einem sehr guten Zustand gehalten, ihre Existenz reduziert den Bedarf an externen Abh√§ngigkeiten. <br><br>  Hohe Entwicklungsgeschwindigkeit.  Ein wesentliches Merkmal von Umgebungen wie Node.js ist der extrem kurze Entwicklungszyklus.  Das Schreiben von Code nimmt weniger Zeit in Anspruch, wodurch der Programmierer produktiver wird. <br><br>  Go hat auch eine hohe Entwicklungsgeschwindigkeit.  Eine Reihe von Tools zum Erstellen von Projekten ist schnell genug, um den Code sofort in Aktion anzeigen zu k√∂nnen.  Die Kompilierungszeit ist extrem kurz. Daher wird das Ausf√ºhren von Code auf Go so wahrgenommen, als ob er nicht kompiliert, sondern interpretiert wurde.  Dar√ºber hinaus verf√ºgt die Sprache √ºber gen√ºgend Abstraktionen, z. B. ein Garbage Collection-System, mit dem Entwickler die Bem√ºhungen zur Implementierung der Funktionalit√§t ihres Projekts lenken und keine Hilfsaufgaben l√∂sen k√∂nnen. <br><br><h2>  <font color="#3AC1EF">Praktisches Experiment</font> </h2><br>  Nachdem wir genug allgemeine Punkte ge√§u√üert haben, ist es Zeit, einen Blick auf den Code zu werfen.  Wir brauchen ein Beispiel, das einfach genug ist, damit wir uns w√§hrend des Studiums auf die Entwicklungsmethodik konzentrieren k√∂nnen, aber gleichzeitig sollte es so weit fortgeschritten sein, dass wir bei der Erforschung etwas zu besprechen haben.  Ich entschied, dass es am einfachsten w√§re, etwas von dem zu nehmen, was ich t√§glich mache.  Daher schlage ich vor, die Erstellung eines Servers zu analysieren, der etwas verarbeitet, das Finanztransaktionen √§hnelt.  Benutzer dieses Servers k√∂nnen den mit ihren Konten verkn√ºpften Kontostand √ºberpr√ºfen.  Dar√ºber hinaus k√∂nnen sie Geld von einem Konto auf ein anderes √ºberweisen. <br><br>  Wir werden versuchen, dieses Beispiel nicht zu komplizieren.  Unser System wird einen Server haben.  Wir werden keine Authentifizierungs- und Kryptografiesysteme kontaktieren.  Dies sind integrale Bestandteile von Arbeitsprojekten.  Wir m√ºssen uns jedoch auf den Kern eines solchen Projekts konzentrieren, um zu zeigen, wie es so zuverl√§ssig wie m√∂glich gemacht werden kann. <br><br><h3>  <font color="#3AC1EF">‚ñçAufteilen eines komplexen Projekts in Teile, die bequem zu verwalten sind</font> </h3><br>  Komplexit√§t ist der schlimmste Feind der Zuverl√§ssigkeit.  Einer der besten Ans√§tze bei der Arbeit mit komplexen Systemen ist die Anwendung des seit langem bekannten Prinzips "Teilen und Erobern".  Die Aufgabe muss in kleine Unteraufgaben unterteilt und einzeln gel√∂st werden.  Welche Seite soll sich der Aufteilung unserer Aufgabe n√§hern?  Wir werden dem Prinzip der <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">geteilten Verantwortung</a> folgen.  Jeder Teil unseres Projekts sollte seinen eigenen Verantwortungsbereich haben. <br><br>  Diese Idee passt perfekt zur beliebten <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Microservice-</a> Architektur.  Unser Server wird aus separaten Diensten bestehen.  Jeder Dienst verf√ºgt √ºber einen klar definierten Verantwortungsbereich und eine klar beschriebene Schnittstelle f√ºr die Interaktion mit anderen Diensten. <br><br>  Nachdem wir den Server auf diese Weise strukturiert haben, k√∂nnen wir Entscheidungen dar√ºber treffen, wie die einzelnen Dienste funktionieren sollen.  Alle Dienste k√∂nnen zusammen im selben Prozess ausgef√ºhrt werden. Von jedem von ihnen k√∂nnen Sie einen separaten Server erstellen und ihre Interaktion mithilfe von RPC herstellen. Sie k√∂nnen die Dienste trennen und jeden von ihnen auf einem separaten Computer ausf√ºhren. <br><br>  Wir werden die Aufgabe nicht erneut verkomplizieren, sondern die einfachste Option w√§hlen.  Alle Dienste werden n√§mlich im selben Prozess ausgef√ºhrt, sie tauschen Informationen wie Bibliotheken direkt aus.  Bei Bedarf kann diese Architekturl√∂sung in Zukunft leicht √ºberpr√ºft und ge√§ndert werden. <br><br>  Welche Dienstleistungen brauchen wir also?  Unser Server ist vielleicht zu einfach, um ihn in Teile zu unterteilen, aber zu Bildungszwecken werden wir ihn dennoch aufteilen.  Wir m√ºssen auf Client-HTTP-Anfragen antworten, um Salden zu √ºberpr√ºfen und Transaktionen auszuf√ºhren.  Einer der Dienste kann mit einer HTTP-Schnittstelle f√ºr Clients arbeiten.  Nennen <code>PublicApi</code> es <code>PublicApi</code> .  Ein anderer Dienst besitzt Informationen √ºber den Zustand des Systems - die Bilanz.  Nennen <code>StateStorage</code> es <code>StateStorage</code> .  Der dritte Dienst wird die beiden oben beschriebenen kombinieren und die Logik von ‚ÄûVertr√§gen‚Äú implementieren, die darauf abzielen, die Salden zu √§ndern.  Die Aufgabe des dritten Dienstes wird die Ausf√ºhrung von Vertr√§gen sein.  Nennen <code>VirtualMachine</code> es <code>VirtualMachine</code> . <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/8a2/a04/79b/8a2a0479b551df5fd2a3c46e67bb46a7.png"></div><br>  <i><font color="#999999">Anwendungsserver-Architektur</font></i> <br><br>  Platzieren Sie den Code dieser Dienste in den Projektordnern <code>/services/publicapi</code> , <code>/services/virtualmachine</code> und <code>/services/statestorage</code> . <br><br><h3>  <font color="#3AC1EF">‚ñç Klare Definition der Serviceverantwortlichkeiten</font> </h3><br>  W√§hrend der Implementierung von Diensten m√∂chten wir in der Lage sein, mit jedem von ihnen individuell zu arbeiten.  Es ist sogar m√∂glich, die Entwicklung dieser Dienste auf verschiedene Programmierer aufzuteilen.  Da die Dienste voneinander abh√§ngig sind und wir ihre Entwicklung parallelisieren m√∂chten, m√ºssen wir mit einer klaren Definition der Schnittstellen arbeiten, √ºber die sie miteinander interagieren.  Mithilfe dieser Schnittstellen k√∂nnen wir Dienste autonom testen, indem wir Stubs f√ºr alles vorbereiten, was sich au√üerhalb der einzelnen Schnittstellen befindet. <br><br>  Wie beschreibe ich die Schnittstelle?  Eine der Optionen besteht darin, alles zu dokumentieren, aber die Dokumentation hat die Eigenschaft, veraltet zu werden. W√§hrend der Arbeit an einem Projekt h√§ufen sich Unterschiede zwischen der Dokumentation und dem Code.  Dar√ºber hinaus k√∂nnen wir Go-Schnittstellendeklarationen verwenden.  Dies ist eine interessante Option, aber es ist besser, die Schnittstelle zu beschreiben, damit diese Beschreibung nicht von einer bestimmten Programmiersprache abh√§ngt.  Dies ist f√ºr uns in einer sehr realen Situation n√ºtzlich, wenn bei der Arbeit an einem Projekt beschlossen wird, einige seiner Dienste in anderen Sprachen zu implementieren, deren F√§higkeiten besser zur L√∂sung ihrer Probleme geeignet sind. <br><br>  Eine M√∂glichkeit zur Beschreibung von Schnittstellen ist die Verwendung von <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Protobuf</a> .  Dies ist ein einfaches sprach- und sprachunabh√§ngiges Protokoll zur Beschreibung von Nachrichten und Dienstendpunkten. <br><br>  Beginnen wir mit der Schnittstelle f√ºr den <code>StateStorage</code> Dienst.  Wir werden den Status der Anwendung in Form einer Schl√ºsselwertansichtsstruktur darstellen.  Hier ist der Code f√ºr die Datei <code>statestorage.proto</code> : <br><br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">syntax</span></span> = <span class="hljs-string"><span class="hljs-string">"proto3"</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">package</span></span> statestorage; <span class="hljs-attribute"><span class="hljs-attribute">service</span></span> StateStorage { <span class="hljs-attribute"><span class="hljs-attribute">rpc</span></span> WriteKey (WriteKeyInput) returns (WriteKeyOutput); <span class="hljs-attribute"><span class="hljs-attribute">rpc</span></span> ReadKey (ReadKeyInput) returns (ReadKeyOutput); } <span class="hljs-attribute"><span class="hljs-attribute">message</span></span> WriteKeyInput { <span class="hljs-attribute"><span class="hljs-attribute">string</span></span> key = <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">int32</span></span> value = <span class="hljs-number"><span class="hljs-number">2</span></span>; } <span class="hljs-attribute"><span class="hljs-attribute">message</span></span> WriteKeyOutput { } <span class="hljs-attribute"><span class="hljs-attribute">message</span></span> ReadKeyInput { <span class="hljs-attribute"><span class="hljs-attribute">string</span></span> key = <span class="hljs-number"><span class="hljs-number">1</span></span>; } <span class="hljs-attribute"><span class="hljs-attribute">message</span></span> ReadKeyOutput { <span class="hljs-attribute"><span class="hljs-attribute">int32</span></span> value = <span class="hljs-number"><span class="hljs-number">1</span></span>; }</code> </pre> <br>  Obwohl Clients HTTP √ºber den <code>PublicApi</code> Dienst verwenden, beeintr√§chtigt es auch nicht die √ºbersichtliche Schnittstelle, die auf die gleiche Weise wie oben beschrieben wurde (die Datei <code>publicapi.proto</code> ): <br><br><pre> <code class="hljs pgsql">syntax = "proto3"; package publicapi; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> "protocol/transactions.proto"; service PublicApi { rpc Transfer (TransferInput) <span class="hljs-keyword"><span class="hljs-keyword">returns</span></span> (TransferOutput); rpc GetBalance (GetBalanceInput) <span class="hljs-keyword"><span class="hljs-keyword">returns</span></span> (GetBalanceOutput); } message TransferInput { protocol.<span class="hljs-keyword"><span class="hljs-keyword">Transaction</span></span> <span class="hljs-keyword"><span class="hljs-keyword">transaction</span></span> = <span class="hljs-number"><span class="hljs-number">1</span></span>; } message TransferOutput { string success = <span class="hljs-number"><span class="hljs-number">1</span></span>; int32 result = <span class="hljs-number"><span class="hljs-number">2</span></span>; } message GetBalanceInput { protocol.Address <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> = <span class="hljs-number"><span class="hljs-number">1</span></span>; } message GetBalanceOutput { string success = <span class="hljs-number"><span class="hljs-number">1</span></span>; int32 result = <span class="hljs-number"><span class="hljs-number">2</span></span>; }</code> </pre> <br>  Nun m√ºssen wir die <code>Transaction</code> und <code>Address</code> ( <code>transactions.proto</code> Datei) beschreiben: <br><br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">syntax</span></span> = <span class="hljs-string"><span class="hljs-string">"proto3"</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">package</span></span> protocol; <span class="hljs-attribute"><span class="hljs-attribute">message</span></span> Address { <span class="hljs-attribute"><span class="hljs-attribute">string</span></span> username = <span class="hljs-number"><span class="hljs-number">1</span></span>; } <span class="hljs-attribute"><span class="hljs-attribute">message</span></span> Transaction { <span class="hljs-attribute"><span class="hljs-attribute">Address</span></span> from = <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">Address</span></span> to = <span class="hljs-number"><span class="hljs-number">2</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">int32</span></span> amount = <span class="hljs-number"><span class="hljs-number">3</span></span>; }</code> </pre> <br>  Im Projekt werden Protobeschreibungen f√ºr Dienste im Ordner <code>/types/services</code> und Beschreibungen allgemeiner Datenstrukturen im Ordner <code>/types/protocol</code> abgelegt. <br><br>  Sobald die Schnittstellenbeschreibungen fertig sind, k√∂nnen sie in Go-Code <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">kompiliert</a> werden. <br><br>  Die Vorteile dieses Ansatzes bestehen darin, dass Code, der nicht mit der Schnittstellenbeschreibung √ºbereinstimmt, einfach nicht in den Kompilierungsergebnissen angezeigt wird.  Die Verwendung alternativer Methoden w√ºrde erfordern, dass wir spezielle Tests schreiben, um zu √ºberpr√ºfen, ob der Code mit den Schnittstellenbeschreibungen √ºbereinstimmt. <br><br>  Vollst√§ndige Definitionen, generierte Go-Dateien und Kompilierungsanweisungen finden Sie <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">hier</a> .  Dies ist dank <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Square Engineering</a> und der Entwicklung von <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Goprotowrap m√∂glich</a> . <br><br>  Bitte beachten Sie, dass in unserem Projekt die Transportschicht-RPC nicht implementiert ist und der Datenaustausch zwischen Diensten wie normale Bibliotheksaufrufe aussieht.  Wenn wir bereit sind, Dienste auf verschiedenen Servern zu verteilen, k√∂nnen wir dem System eine Transportschicht wie <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">gRPC</a> hinzuf√ºgen. <br><br><h3>  <font color="#3AC1EF">‚ñç Arten von Tests, die im Projekt verwendet werden</font> </h3><br>  Da Tests der Schl√ºssel zu hochzuverl√§ssigem Code sind, empfehle ich, zun√§chst dar√ºber zu sprechen, welche Tests wir f√ºr unser Projekt schreiben werden. <br><br><h4>  Unit-Tests </h4><br>  Unit-Tests bilden den Kern <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">der Testpyramide</a> .  Wir werden jedes Modul einzeln testen.  Was ist ein Modul?  In Go k√∂nnen wir Module als separate Dateien in einem Paket wahrnehmen.  Wenn wir beispielsweise die Datei <code>/services/publicapi/handlers.go</code> , platzieren wir den <code>/services/publicapi/handlers.go</code> im selben Paket unter <code>/services/publicapi/handlers_test.go</code> . <br><br>  Es ist am besten, Komponententests im selben Paket wie den Testcode zu platzieren, damit die Tests auf nicht exportierte Variablen und Funktionen zugreifen k√∂nnen. <br><br><h4>  Servicetests </h4><br>  Die folgende Art von Test ist unter verschiedenen Namen bekannt.  Dies sind die sogenannten Service-, Integrations- oder Komponententests.  Ihre Essenz besteht darin, mehrere Module zu belegen und ihre gemeinsame Arbeit zu testen.  Diese Tests sind eine Stufe h√∂her als die Einheitentests in der Testpyramide.  In unserem Fall verwenden wir Integrationstests, um den gesamten Service zu testen.  Diese Tests bestimmen die Spezifikationen f√ºr den Service.  Beispielsweise werden Tests f√ºr den <code>StateStorage</code> Dienst im Ordner <code>/services/statestorage/spec</code> . <br><br>  Es ist am besten, diese Tests in einem Paket zu platzieren, das sich von dem unterscheidet, in dem sich der getestete Code befindet, damit der Zugriff auf die Funktionen dieses Codes nur √ºber exportierte Schnittstellen erfolgt. <br><br><h4>  End-to-End-Tests </h4><br>  Diese Tests stehen ganz oben in der Testpyramide und helfen dabei, das gesamte System und alle seine Dienste zu √ºberpr√ºfen.  Solche Tests beschreiben die End-to-End-e2e-Spezifikation f√ºr das System, daher werden sie im Ordner <code>/e2e/spec</code> . <br><br>  End-to-End-Tests sowie Servicetests m√ºssen in einem anderen Paket als dem, in dem sich der getestete Code befindet, abgelegt werden, damit das System nur √ºber exportierte Schnittstellen betrieben werden kann. <br><br>  Welche Tests sollten zuerst geschrieben werden?  Beginnen Sie mit dem Fundament der "Pyramide" und bewegen Sie sich nach oben?  Oder oben anfangen und runter gehen?  Jeder dieser Ans√§tze hat das Recht auf Leben.  Die Vorteile eines Top-Down-Ansatzes liegen darin, dass zuerst die Spezifikation f√ºr das gesamte System erstellt wird.  Es ist normalerweise am einfachsten, zu Beginn der Arbeit √ºber die Merkmale des Gesamtsystems zu diskutieren.  Auch wenn wir das System falsch in separate Dienste aufteilen, bleiben die Systemspezifikationen unver√§ndert.  Dies hilft uns au√üerdem zu verstehen, dass etwas auf einer niedrigeren Ebene falsch gemacht wird. <br><br>  Das Minus des Top-Down-Ansatzes ist, dass End-to-End-Tests diejenigen Tests sind, die nach allen anderen verwendet werden, wenn das gesamte zu entwickelnde System erstellt wird.  Dies bedeutet, dass sie lange Zeit Fehler erzeugen.  Wenn wir Tests f√ºr unser Projekt schreiben, werden wir genau diesen Ansatz verwenden. <br><br><h3>  <font color="#3AC1EF">EstTestentwicklung</font> </h3><br><h4>  End-to-End-Testentwicklung </h4><br>  Bevor wir Tests erstellen, m√ºssen wir entscheiden, ob wir sie schreiben, ohne zus√§tzliche Tools oder ein Framework zu verwenden.  Sich auf das Framework zu verlassen und es als Entwicklungsabh√§ngigkeit zu verwenden, ist weniger gef√§hrlich als sich auf das Framework im Code zu verlassen, der in die Produktion kommt.  In unserem Fall w√§hlen wir eine Arbeitsoption, die die Verwendung eines Frameworks umfasst, da die Standard-Go-Bibliothek keine angemessene <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">BDD-</a> Unterst√ºtzung bietet und dieses Format sich hervorragend zur Beschreibung von Spezifikationen eignet. <br><br>  Es gibt viele gro√üartige Frameworks, die das geben, was wir brauchen.  Unter ihnen sind <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">GoConvey</a> und <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Ginkgo</a> . <br><br>  Pers√∂nlich verwende ich gerne eine Kombination aus <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Ginkgo</a> und <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Gomega</a> (schreckliche Namen, aber was zu tun ist), die syntaktische Konstrukte wie <code>Describe()</code> und <code>It()</code> . <br><br>  Wie werden unsere Tests aussehen?  Hier ist zum Beispiel ein Test f√ºr den Mechanismus zur √úberpr√ºfung des Benutzerguthaben (Datei <code>sanity.go</code> ): <br><br><pre> <code class="hljs go"><span class="hljs-keyword"><span class="hljs-keyword">package</span></span> spec <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> ... <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> _ = Describe(<span class="hljs-string"><span class="hljs-string">"Sanity"</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> ( node services.Node ) BeforeEach(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { node = services.NewNode() node.Start() }) AfterEach(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { node.Stop() }) It(<span class="hljs-string"><span class="hljs-string">"should show balances with GET /api/balance"</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { resp, err := http.Get(<span class="hljs-string"><span class="hljs-string">"http://localhost:8080/api/balance?from=user1"</span></span>) Expect(err).ToNot(HaveOccurred()) Expect(resp.StatusCode).To(Equal(http.StatusOK)) Expect(ResponseBodyAsString(resp)).To(Equal(<span class="hljs-string"><span class="hljs-string">"0"</span></span>)) }) })</code> </pre> <br>  Da der Server von au√üen √ºber HTTP zug√§nglich ist, werden wir mit seiner Web-API √ºber <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=https://golang.org/pkg/net/">http.Get arbeiten</a> .  Was ist mit Transaktionstests?  Hier ist der Code f√ºr den entsprechenden Test: <br><br><pre> <code class="hljs lisp">It(<span class="hljs-string"><span class="hljs-string">"should transfer funds with POST /api/transfer"</span></span>, func() { resp, err <span class="hljs-symbol"><span class="hljs-symbol">:=</span></span> http.Get(<span class="hljs-string"><span class="hljs-string">"http://localhost:8080/api/transfer?from=user1&amp;to=user2&amp;amount=17"</span></span>) Expect(<span class="hljs-name"><span class="hljs-name">err</span></span>).ToNot(<span class="hljs-name"><span class="hljs-name">HaveOccurred</span></span>()) Expect(<span class="hljs-name"><span class="hljs-name">resp</span></span>.StatusCode).To(<span class="hljs-name"><span class="hljs-name">Equal</span></span>(<span class="hljs-name"><span class="hljs-name">http</span></span>.StatusOK)) Expect(<span class="hljs-name"><span class="hljs-name">ResponseBodyAsString</span></span>(<span class="hljs-name"><span class="hljs-name">resp</span></span>)).To(<span class="hljs-name"><span class="hljs-name">Equal</span></span>(<span class="hljs-string"><span class="hljs-string">"-17"</span></span>)) resp, err = http.Post(<span class="hljs-string"><span class="hljs-string">"http://localhost:8080/api/balance?from=user2"</span></span>, <span class="hljs-string"><span class="hljs-string">"text/plain"</span></span>, <span class="hljs-literal"><span class="hljs-literal">nil</span></span>) Expect(<span class="hljs-name"><span class="hljs-name">err</span></span>).ToNot(<span class="hljs-name"><span class="hljs-name">HaveOccurred</span></span>()) Expect(<span class="hljs-name"><span class="hljs-name">resp</span></span>.StatusCode).To(<span class="hljs-name"><span class="hljs-name">Equal</span></span>(<span class="hljs-name"><span class="hljs-name">http</span></span>.StatusOK)) Expect(<span class="hljs-name"><span class="hljs-name">ResponseBodyAsString</span></span>(<span class="hljs-name"><span class="hljs-name">resp</span></span>)).To(<span class="hljs-name"><span class="hljs-name">Equal</span></span>(<span class="hljs-string"><span class="hljs-string">"17"</span></span>)) })</code> </pre><br>  Der Testcode beschreibt ihre Essenz perfekt und kann sogar die Dokumentation ersetzen.  Wie Sie sehen k√∂nnen, geben wir das Vorhandensein negativer Benutzerkontost√§nde zu.  Dies ist ein Merkmal unseres Projekts.  Wenn es verboten w√§re, w√ºrde sich diese Entscheidung im Test widerspiegeln. <br><br>  ‚Üí <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Hier ist der</a> vollst√§ndige Testcode <br><br><h4>  Service Test Entwicklung </h4><br>  Nachdem wir End-to-End-Tests entwickelt haben, gehen wir die Testpyramide entlang und erstellen Servicetests.  Solche Tests werden f√ºr jeden einzelnen Dienst entwickelt.  Wir w√§hlen einen Dienst, der von einem anderen Dienst abh√§ngig ist, da dieser Fall interessanter ist als die Entwicklung von Tests f√ºr einen unabh√§ngigen Dienst. <br><br>  Beginnen wir mit dem <code>VirtualMachine</code> Dienst.  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Hier</a> finden Sie die Schnittstelle mit Protobeschreibungen f√ºr diesen Dienst.  Da der <code>VirtualMachine</code> Dienst auf dem <code>StateStorage</code> Dienst <code>StateStorage</code> und ihn aufruft, m√ºssen wir ein <code>StateStorage</code> f√ºr den <code>StateStorage</code> Dienst erstellen, um den <code>VirtualMachine</code> Dienst isoliert zu testen.  Mit dem Stub-Objekt k√∂nnen wir die <code>StateStorage</code> Antworten w√§hrend des Tests steuern. <br><br>  Wie implementiere ich ein Stub-Objekt in Go?  Dies kann ausschlie√ülich √ºber die Sprache ohne Hilfsmittel erfolgen, oder Sie k√∂nnen auf die entsprechende Bibliothek zur√ºckgreifen, die es zus√§tzlich erm√∂glicht, mit den Anweisungen im Testprozess zu arbeiten.  Zu diesem Zweck bevorzuge ich die <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Go-Mock-</a> Bibliothek. <br><br>  Wir werden den Stub-Code in die Datei <code>/services/statestorage/mock.go</code> .  Es ist am besten, Stub-Objekte an derselben Stelle wie die von ihnen nachgeahmten Entit√§ten zu platzieren, um ihnen Zugriff auf nicht exportierte Variablen und Funktionen zu gew√§hren.  Der Stub in dieser Phase ist eine schematische Implementierung des Dienstes, aber w√§hrend sich der Dienst entwickelt, m√ºssen wir m√∂glicherweise die Implementierung des Stubs entwickeln.  Hier ist der Code f√ºr das Stub-Objekt ( <code>mock.go</code> Datei): <br><br><pre> <code class="hljs go"><span class="hljs-keyword"><span class="hljs-keyword">package</span></span> statestorage <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> ... <span class="hljs-keyword"><span class="hljs-keyword">type</span></span> MockService <span class="hljs-keyword"><span class="hljs-keyword">struct</span></span> { mock.Mock } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(s *MockService)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Start</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { s.Called() } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(s *MockService)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Stop</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { s.Called() } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(s *MockService)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">IsStarted</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">bool</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> s.Called().Bool(<span class="hljs-number"><span class="hljs-number">0</span></span>) } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(s *MockService)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">WriteKey</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(input *statestorage.WriteKeyInput)</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(*statestorage.WriteKeyOutput, error)</span></span></span></span> { ret := s.Called(input) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ret.Get(<span class="hljs-number"><span class="hljs-number">0</span></span>).(*statestorage.WriteKeyOutput), ret.Error(<span class="hljs-number"><span class="hljs-number">1</span></span>) } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(s *MockService)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ReadKey</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(input *statestorage.ReadKeyInput)</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(*statestorage.ReadKeyOutput, error)</span></span></span></span> { ret := s.Called(input) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ret.Get(<span class="hljs-number"><span class="hljs-number">0</span></span>).(*statestorage.ReadKeyOutput), ret.Error(<span class="hljs-number"><span class="hljs-number">1</span></span>) }</code> </pre> <br>  Wenn Sie die Entwicklung einzelner Dienste an verschiedene Programmierer weitergeben, ist es sinnvoll, zuerst Stubs zu erstellen und diese an das Team weiterzugeben. <br><br>  <code>VirtualMachine</code> wir zur√ºck zur Entwicklung eines Servicetests f√ºr <code>VirtualMachine</code> .  Welches Szenario soll ich hier √ºberpr√ºfen?  Am besten konzentrieren Sie sich auf <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">die</a> Serviceschnittstelle und die Designtests f√ºr jeden Endpunkt.  Wir implementieren einen Test f√ºr den <code>CallContract()</code> mit einem Argument, das die <code>"GetBalance"</code> Methode darstellt.  Hier ist der entsprechende Code ( <code>contracts.go</code> Datei): <br><br><pre> <code class="hljs go"><span class="hljs-keyword"><span class="hljs-keyword">package</span></span> spec <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> ... <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> _ = Describe(<span class="hljs-string"><span class="hljs-string">"Contracts"</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> ( service uut.Service stateStorage *_statestorage.MockService ) BeforeEach(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { service = uut.NewService() stateStorage = &amp;_statestorage.MockService{} service.Start(stateStorage) }) AfterEach(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { service.Stop() }) It(<span class="hljs-string"><span class="hljs-string">"should support 'GetBalance' contract method"</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { stateStorage.When(<span class="hljs-string"><span class="hljs-string">"ReadKey"</span></span>, &amp;statestorage.ReadKeyInput{Key: <span class="hljs-string"><span class="hljs-string">"user1"</span></span>}).Return(&amp;statestorage.ReadKeyOutput{Value: <span class="hljs-number"><span class="hljs-number">100</span></span>}, <span class="hljs-literal"><span class="hljs-literal">nil</span></span>).Times(<span class="hljs-number"><span class="hljs-number">1</span></span>) addr := protocol.Address{Username: <span class="hljs-string"><span class="hljs-string">"user1"</span></span>} out, err := service.CallContract(&amp;virtualmachine.CallContractInput{Method: <span class="hljs-string"><span class="hljs-string">"GetBalance"</span></span>, Arg: &amp;addr}) Expect(err).ToNot(HaveOccurred()) Expect(out.Result).To(BeEquivalentTo(<span class="hljs-number"><span class="hljs-number">100</span></span>)) Expect(stateStorage).To(ExecuteAsPlanned()) }) })</code> </pre><br>  Beachten Sie, dass der von uns getestete Dienst <code>StateStorage</code> in der <code>Start()</code> -Methode √ºber einen einfachen Abh√§ngigkeitsinjektionsmechanismus einen Zeiger auf seine Abh√§ngigkeit <code>VirtualMachine</code> erh√§lt.  Hier √ºbergeben wir die Instanz des Stub-Objekts.  <code>stateStorage.When("ReadKey", &amp;statestorage.ReadKeyInput{Key‚Ä¶</code> die Zeile <code>stateStorage.When("ReadKey", &amp;statestorage.ReadKeyInput{Key‚Ä¶</code> , in der wir dem Stub-Objekt mitteilen, wie es sich beim Zugriff verhalten soll. Wenn die <code>ReadKey</code> Methode <code>ReadKey</code> , sollte sie einen Wert zur√ºckgeben 100. Dann √ºberpr√ºfen wir in der Zeile <code>Expect(stateStorage).To(ExecuteAsPlanned())</code> , ob dieser Befehl genau einmal aufgerufen wird. <br><br>  √Ñhnliche Tests werden zu Spezifikationen f√ºr den Dienst.  Die vollst√§ndigen Tests f√ºr den <code>VirtualMachine</code> Dienst finden Sie <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">hier</a> .  Testsuiten f√ºr andere Dienstleistungen unseres Projekts finden Sie <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">hier</a> und <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">hier</a> . <br><br><h4>  Unit Test Entwicklung </h4><br>  M√∂glicherweise ist die Implementierung des Vertrags f√ºr die <code>"GetBalance"</code> Methode zu einfach. <code>"GetBalance"</code> √ºber die Implementierung einer etwas komplexeren <code>"Transfer"</code> sprechen.  Der Vertrag f√ºr die √úberweisung von Geldern von einem Konto auf ein anderes, dargestellt durch diese Methode, muss Daten √ºber die Guthaben des Absenders und Empf√§ngers von Geldern lesen, neue Guthaben berechnen und aufzeichnen, was im Antragsstatus passiert ist.  Der Servicetest f√ºr all dies ist dem gerade implementierten sehr √§hnlich ( <code>transactions.go</code> Datei): <br><br><pre> <code class="hljs lisp">It(<span class="hljs-string"><span class="hljs-string">"should support 'Transfer' transaction method"</span></span>, func() { stateStorage.When(<span class="hljs-string"><span class="hljs-string">"ReadKey"</span></span>, <span class="hljs-symbol"><span class="hljs-symbol">&amp;statestorage</span></span>.ReadKeyInput{Key: <span class="hljs-string"><span class="hljs-string">"user1"</span></span>}).Return(<span class="hljs-name"><span class="hljs-name">&amp;statestorage</span></span>.ReadKeyOutput{Value: <span class="hljs-number"><span class="hljs-number">100</span></span>}, <span class="hljs-literal"><span class="hljs-literal">nil</span></span>).Times(<span class="hljs-number"><span class="hljs-number">1</span></span>) stateStorage.When(<span class="hljs-string"><span class="hljs-string">"ReadKey"</span></span>, <span class="hljs-symbol"><span class="hljs-symbol">&amp;statestorage</span></span>.ReadKeyInput{Key: <span class="hljs-string"><span class="hljs-string">"user2"</span></span>}).Return(<span class="hljs-name"><span class="hljs-name">&amp;statestorage</span></span>.ReadKeyOutput{Value: <span class="hljs-number"><span class="hljs-number">50</span></span>}, <span class="hljs-literal"><span class="hljs-literal">nil</span></span>).Times(<span class="hljs-number"><span class="hljs-number">1</span></span>) stateStorage.When(<span class="hljs-string"><span class="hljs-string">"WriteKey"</span></span>, <span class="hljs-symbol"><span class="hljs-symbol">&amp;statestorage</span></span>.WriteKeyInput{Key: <span class="hljs-string"><span class="hljs-string">"user1"</span></span>, Value: <span class="hljs-number"><span class="hljs-number">90</span></span>}).Return(<span class="hljs-name"><span class="hljs-name">&amp;statestorage</span></span>.WriteKeyOutput{}, <span class="hljs-literal"><span class="hljs-literal">nil</span></span>).Times(<span class="hljs-number"><span class="hljs-number">1</span></span>) stateStorage.When(<span class="hljs-string"><span class="hljs-string">"WriteKey"</span></span>, <span class="hljs-symbol"><span class="hljs-symbol">&amp;statestorage</span></span>.WriteKeyInput{Key: <span class="hljs-string"><span class="hljs-string">"user2"</span></span>, Value: <span class="hljs-number"><span class="hljs-number">60</span></span>}).Return(<span class="hljs-name"><span class="hljs-name">&amp;statestorage</span></span>.WriteKeyOutput{}, <span class="hljs-literal"><span class="hljs-literal">nil</span></span>).Times(<span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-literal"><span class="hljs-literal">t</span></span> <span class="hljs-symbol"><span class="hljs-symbol">:=</span></span> protocol.Transaction{From: <span class="hljs-symbol"><span class="hljs-symbol">&amp;protocol</span></span>.Address{Username: <span class="hljs-string"><span class="hljs-string">"user1"</span></span>}, To: <span class="hljs-symbol"><span class="hljs-symbol">&amp;protocol</span></span>.Address{Username: <span class="hljs-string"><span class="hljs-string">"user2"</span></span>}, Amount: <span class="hljs-number"><span class="hljs-number">10</span></span>} out, err <span class="hljs-symbol"><span class="hljs-symbol">:=</span></span> service.ProcessTransaction(<span class="hljs-name"><span class="hljs-name">&amp;virtualmachine</span></span>.ProcessTransactionInput{Method: <span class="hljs-string"><span class="hljs-string">"Transfer"</span></span>, Arg: <span class="hljs-symbol"><span class="hljs-symbol">&amp;t</span></span>}) Expect(<span class="hljs-name"><span class="hljs-name">err</span></span>).ToNot(<span class="hljs-name"><span class="hljs-name">HaveOccurred</span></span>()) Expect(<span class="hljs-name"><span class="hljs-name">out</span></span>.Result).To(<span class="hljs-name"><span class="hljs-name">BeEquivalentTo</span></span>(<span class="hljs-number"><span class="hljs-number">90</span></span>)) Expect(<span class="hljs-name"><span class="hljs-name">stateStorage</span></span>).To(<span class="hljs-name"><span class="hljs-name">ExecuteAsPlanned</span></span>()) })</code> </pre> <br>  W√§hrend der Arbeit an dem Projekt k√∂nnen wir endlich seine internen Mechanismen erstellen und ein Modul in der Datei <code>processor.go</code> erstellen, das die Implementierung des Vertrags enth√§lt.  Hier ist die Originalversion ( <code>processor.go</code> Datei): <br><br><pre> <code class="hljs go"><span class="hljs-keyword"><span class="hljs-keyword">package</span></span> virtualmachine <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> ... <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(s *service)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">processTransfer</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(fromUsername </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params">, toUsername </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params">, amount </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int32</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int32</span></span></span></span><span class="hljs-function"><span class="hljs-params">, error)</span></span></span></span> { fromBalance, err := s.stateStorage.ReadKey(&amp;statestorage.ReadKeyInput{Key: fromUsername}) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> err != <span class="hljs-literal"><span class="hljs-literal">nil</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>, err } toBalance, err := s.stateStorage.ReadKey(&amp;statestorage.ReadKeyInput{Key: toUsername}) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> err != <span class="hljs-literal"><span class="hljs-literal">nil</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>, err } _, err = s.stateStorage.WriteKey(&amp;statestorage.WriteKeyInput{Key: fromUsername, Value: fromBalance.Value - amount}) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> err != <span class="hljs-literal"><span class="hljs-literal">nil</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>, err } _, err = s.stateStorage.WriteKey(&amp;statestorage.WriteKeyInput{Key: toUsername, Value: toBalance.Value + amount}) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> err != <span class="hljs-literal"><span class="hljs-literal">nil</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>, err } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> fromBalance.Value - amount, <span class="hljs-literal"><span class="hljs-literal">nil</span></span> }</code> </pre><br>  Dieses Design erf√ºllt den Servicetest, in unserem Fall enth√§lt der Integrationstest jedoch nur einen Test des Basisszenarios.  Was ist mit Grenzf√§llen und m√∂glichen Fehlern?  Wie Sie sehen, kann jeder <code>StateStorage</code> von <code>StateStorage</code> fehlschlagen.  Wenn eine 100% ige Abdeckung des Codes mit Tests erforderlich ist, m√ºssen alle diese Situationen √ºberpr√ºft werden.  Der Unit-Test eignet sich hervorragend zur Durchf√ºhrung solcher Tests. <br><br>  Da wir die Funktion mehrmals mit unterschiedlichen Eingabedaten aufrufen und die Parameter zum Erreichen aller Zweige des Codes simulieren werden, k√∂nnen wir auf tabellenbasierte Tests zur√ºckgreifen, um diesen Prozess effizienter zu gestalten.  Go neigt dazu, exotische Unit-Test-Frameworks zu vermeiden.  Wir k√∂nnen <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Ginkgo</a> ablehnen, aber wahrscheinlich sollten wir <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Gomega</a> verlassen.  Infolgedessen √§hneln die hier durchgef√ºhrten √úberpr√ºfungen denen, die wir in fr√ºheren Tests durchgef√ºhrt haben.  Hier ist der Testcode (Datei <code>processor_test.go</code> ): <br><br><pre> <code class="hljs lua"><span class="hljs-built_in"><span class="hljs-built_in">package</span></span> virtualmachine import ... var transferTable = []struct{ to <span class="hljs-built_in"><span class="hljs-built_in">string</span></span> //  ,    read1Err <span class="hljs-built_in"><span class="hljs-built_in">error</span></span> //       read2Err <span class="hljs-built_in"><span class="hljs-built_in">error</span></span> //       write1Err <span class="hljs-built_in"><span class="hljs-built_in">error</span></span> //       write2Err <span class="hljs-built_in"><span class="hljs-built_in">error</span></span> //       <span class="hljs-built_in"><span class="hljs-built_in">output</span></span> int32 //   errs bool //        }{ {<span class="hljs-string"><span class="hljs-string">"user2"</span></span>, errors.New(<span class="hljs-string"><span class="hljs-string">"a"</span></span>), <span class="hljs-literal"><span class="hljs-literal">nil</span></span>, <span class="hljs-literal"><span class="hljs-literal">nil</span></span>, <span class="hljs-literal"><span class="hljs-literal">nil</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-literal"><span class="hljs-literal">true</span></span>}, {<span class="hljs-string"><span class="hljs-string">"user2"</span></span>, <span class="hljs-literal"><span class="hljs-literal">nil</span></span>, errors.New(<span class="hljs-string"><span class="hljs-string">"a"</span></span>), <span class="hljs-literal"><span class="hljs-literal">nil</span></span>, <span class="hljs-literal"><span class="hljs-literal">nil</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-literal"><span class="hljs-literal">true</span></span>}, {<span class="hljs-string"><span class="hljs-string">"user2"</span></span>, <span class="hljs-literal"><span class="hljs-literal">nil</span></span>, <span class="hljs-literal"><span class="hljs-literal">nil</span></span>, errors.New(<span class="hljs-string"><span class="hljs-string">"a"</span></span>), <span class="hljs-literal"><span class="hljs-literal">nil</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-literal"><span class="hljs-literal">true</span></span>}, {<span class="hljs-string"><span class="hljs-string">"user2"</span></span>, <span class="hljs-literal"><span class="hljs-literal">nil</span></span>, <span class="hljs-literal"><span class="hljs-literal">nil</span></span>, <span class="hljs-literal"><span class="hljs-literal">nil</span></span>, errors.New(<span class="hljs-string"><span class="hljs-string">"a"</span></span>), <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-literal"><span class="hljs-literal">true</span></span>}, {<span class="hljs-string"><span class="hljs-string">"user2"</span></span>, <span class="hljs-literal"><span class="hljs-literal">nil</span></span>, <span class="hljs-literal"><span class="hljs-literal">nil</span></span>, <span class="hljs-literal"><span class="hljs-literal">nil</span></span>, <span class="hljs-literal"><span class="hljs-literal">nil</span></span>, <span class="hljs-number"><span class="hljs-number">90</span></span>, <span class="hljs-literal"><span class="hljs-literal">false</span></span>}, } func TestTransfer(t *testing.T) { Œ© := NewGomegaWithT(t) <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> _, tt := range transferTable { s := NewService() ss := &amp;_statestorage.MockService{} s.Start(ss) ss.When(<span class="hljs-string"><span class="hljs-string">"ReadKey"</span></span>, &amp;statestorage.ReadKeyInput{Key: <span class="hljs-string"><span class="hljs-string">"user1"</span></span>}).Return(&amp;statestorage.ReadKeyOutput{Value: <span class="hljs-number"><span class="hljs-number">100</span></span>}, tt.read1Err) ss.When(<span class="hljs-string"><span class="hljs-string">"ReadKey"</span></span>, &amp;statestorage.ReadKeyInput{Key: <span class="hljs-string"><span class="hljs-string">"user2"</span></span>}).Return(&amp;statestorage.ReadKeyOutput{Value: <span class="hljs-number"><span class="hljs-number">50</span></span>}, tt.read2Err) ss.When(<span class="hljs-string"><span class="hljs-string">"WriteKey"</span></span>, &amp;statestorage.WriteKeyInput{Key: <span class="hljs-string"><span class="hljs-string">"user1"</span></span>, Value: <span class="hljs-number"><span class="hljs-number">90</span></span>}).Return(&amp;statestorage.WriteKeyOutput{}, tt.write1Err) ss.When(<span class="hljs-string"><span class="hljs-string">"WriteKey"</span></span>, &amp;statestorage.WriteKeyInput{Key: <span class="hljs-string"><span class="hljs-string">"user2"</span></span>, Value: <span class="hljs-number"><span class="hljs-number">60</span></span>}).Return(&amp;statestorage.WriteKeyOutput{}, tt.write2Err) <span class="hljs-built_in"><span class="hljs-built_in">output</span></span>, err := s.(*service).processTransfer(<span class="hljs-string"><span class="hljs-string">"user1"</span></span>, tt.to, <span class="hljs-number"><span class="hljs-number">10</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> tt.errs { Œ©.Expect(err).To(HaveOccurred()) } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { Œ©.Expect(err).ToNot(HaveOccurred()) Œ©.Expect(<span class="hljs-built_in"><span class="hljs-built_in">output</span></span>).To(BeEquivalentTo(tt.<span class="hljs-built_in"><span class="hljs-built_in">output</span></span>)) } } }</code> </pre> <br>     ¬´Œ©¬ª ‚Äî  ,    ‚Äî    (     <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Gomega</a> ).          . <br><br>        ,        TDD,          ,     ,     .       <code>processTransfer()</code>         . <br><br>       <code>VirtualMachine</code>   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="></a> .       <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="></a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="></a> . <br><br>    100%   .    ,    .             . <br><br>   ,        ?   .        , ,    ,     . <br><br><h3> <font color="#3AC1EF">‚ñç  -</font> </h3><br>              .         ?  HTTP-  Go     (goroutine).     ,  ‚Äî        ,     . ,      ,  ,   . <br><br>           -               . ,   ,   ,          ,        .  -     <code>/e2e/stress</code> .   - ( <code>stress.go</code> ): <br><br><pre> <code class="hljs perl"><span class="hljs-keyword"><span class="hljs-keyword">package</span></span> stress import ... const NUM_TRANSACTIONS = <span class="hljs-number"><span class="hljs-number">20000</span></span> const NUM_USERS = <span class="hljs-number"><span class="hljs-number">100</span></span> const TRANSACTIONS_PER_BATCH = <span class="hljs-number"><span class="hljs-number">200</span></span> const BATCHES_PER_SEC = <span class="hljs-number"><span class="hljs-number">40</span></span> var <span class="hljs-number"><span class="hljs-number">_</span></span> = Describe(<span class="hljs-string"><span class="hljs-string">"Transaction Stress Test"</span></span>, func() { var ( node services.Node ) BeforeEach(func() { node = services.NewNode() node.Start() }) AfterEach(func() { node.Stop() }) It(<span class="hljs-string"><span class="hljs-string">"should handle lots and lots of transactions"</span></span>, func() { <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>  HTTP-     transport := http.Transport{ IdleConnTimeout: time.Second*<span class="hljs-number"><span class="hljs-number">20</span></span>, MaxIdleConns: TRANSACTIONS_PER_BATCH*<span class="hljs-number"><span class="hljs-number">10</span></span>, MaxIdleConnsPerHost: TRANSACTIONS_PER_BATCH*<span class="hljs-number"><span class="hljs-number">10</span></span>, } client := &amp;http.Client{Transport: &amp;transport} //      ledger := <span class="hljs-keyword"><span class="hljs-keyword">map</span></span>[string]int32{} <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> i := <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; NUM_USERS; i++ { ledger[fmt.Sprintf(<span class="hljs-string"><span class="hljs-string">"user%d"</span></span>, i+<span class="hljs-number"><span class="hljs-number">1</span></span>)] = <span class="hljs-number"><span class="hljs-number">0</span></span> } //     HTTP   rand.Seed(<span class="hljs-number"><span class="hljs-number">42</span></span>) done := make(chan error, TRANSACTIONS_PER_BATCH) <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> i := <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; NUM_TRANSACTIONS / TRANSACTIONS_PER_BATCH; i++ { log.Printf(<span class="hljs-string"><span class="hljs-string">"Sending %d transactions... (batch %d out of %d)"</span></span>, TRANSACTIONS_PER_BATCH, i+<span class="hljs-number"><span class="hljs-number">1</span></span>, NUM_TRANSACTIONS / TRANSACTIONS_PER_BATCH) time.Sleep(time.Second / BATCHES_PER_SEC) <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> j := <span class="hljs-number"><span class="hljs-number">0</span></span>; j &lt; TRANSACTIONS_PER_BATCH; j++ { from := randomizeUser() to := randomizeUser() amount := randomizeAmount() ledger[from] -= amount ledger[to] += amount go sendTransaction(client, from, to, amount, &amp;done) } <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> j := <span class="hljs-number"><span class="hljs-number">0</span></span>; j &lt; TRANSACTIONS_PER_BATCH; j++ { err := &lt;- done Expect(err).ToNot(HaveOccurred()) } } //   <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> i := <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; NUM_USERS; i++ { user := fmt.Sprintf(<span class="hljs-string"><span class="hljs-string">"user%d"</span></span>, i+<span class="hljs-number"><span class="hljs-number">1</span></span>) resp, err := client.Get(fmt.Sprintf(<span class="hljs-string"><span class="hljs-string">"http://localhost:8080/api/balance?from=%s"</span></span>, user)) Expect(err).ToNot(HaveOccurred()) Expect(resp.StatusCode).To(Equal(http.StatusOK)) Expect(ResponseBodyAsString(resp)).To(Equal(fmt.Sprintf(<span class="hljs-string"><span class="hljs-string">"%d"</span></span>, ledger[user]))) } }) }) func randomizeUser() string { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> fmt.Sprintf(<span class="hljs-string"><span class="hljs-string">"user%d"</span></span>, rand.Intn(NUM_USERS)+<span class="hljs-number"><span class="hljs-number">1</span></span>) } func randomizeAmount() int32 { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> rand.Int31n(<span class="hljs-number"><span class="hljs-number">1000</span></span>)+<span class="hljs-number"><span class="hljs-number">1</span></span> } func sendTransaction(client *http.Client, from string, to string, amount int32, done *chan error) { url := fmt.Sprintf(<span class="hljs-string"><span class="hljs-string">"http://localhost:8080/api/transfer?from=%s&amp;to=%s&amp;amount=%d"</span></span>, from, to, amount) resp, err := client.Post(url, <span class="hljs-string"><span class="hljs-string">"text/plain"</span></span>, nil) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> err == nil { ioutil.ReadAll(resp.Body) resp.Body.Close() } *done &lt;- err }</code> </pre> <br>    ,  -   .           (       <code>rand.Seed(42)</code> )  ,    .         .     ,            ,  ‚Äî ,     . <br><br>    -  HTTP   ,    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="></a>          TCP- (     ,     ,           ).  ,  ,              200     <code>IdleConnection</code>    TCP-   .       ,      100. <br><br>  ‚Ä¶   : <br><br><pre> <code class="hljs go">fatal error: concurrent <span class="hljs-keyword"><span class="hljs-keyword">map</span></span> writes goroutine <span class="hljs-number"><span class="hljs-number">539</span></span> [running]: runtime.throw(<span class="hljs-number"><span class="hljs-number">0x147bf</span></span>60, <span class="hljs-number"><span class="hljs-number">0x15</span></span>) /usr/local/<span class="hljs-keyword"><span class="hljs-keyword">go</span></span>/src/runtime/<span class="hljs-built_in"><span class="hljs-built_in">panic</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">go</span></span>:<span class="hljs-number"><span class="hljs-number">616</span></span> +<span class="hljs-number"><span class="hljs-number">0x81</span></span> fp=<span class="hljs-number"><span class="hljs-number">0xc4207159d</span></span>8 sp=<span class="hljs-number"><span class="hljs-number">0xc4207159b8</span></span> pc=<span class="hljs-number"><span class="hljs-number">0x102ca01</span></span> runtime.mapassign_faststr(<span class="hljs-number"><span class="hljs-number">0x13f</span></span>5140, <span class="hljs-number"><span class="hljs-number">0xc4201ca0c0</span></span>, <span class="hljs-number"><span class="hljs-number">0xc4203a8097</span></span>, <span class="hljs-number"><span class="hljs-number">0x6</span></span>, <span class="hljs-number"><span class="hljs-number">0x1012001</span></span>) /usr/local/<span class="hljs-keyword"><span class="hljs-keyword">go</span></span>/src/runtime/hashmap_fast.<span class="hljs-keyword"><span class="hljs-keyword">go</span></span>:<span class="hljs-number"><span class="hljs-number">703</span></span> +<span class="hljs-number"><span class="hljs-number">0x3e9</span></span> fp=<span class="hljs-number"><span class="hljs-number">0xc420715a48</span></span> sp=<span class="hljs-number"><span class="hljs-number">0xc4207159d</span></span>8 pc=<span class="hljs-number"><span class="hljs-number">0x100d</span></span>879 services/statestorage.(*service).WriteKey(<span class="hljs-number"><span class="hljs-number">0xc42000c060</span></span>, <span class="hljs-number"><span class="hljs-number">0xc4209e6800</span></span>, <span class="hljs-number"><span class="hljs-number">0xc4206491a0</span></span>, <span class="hljs-number"><span class="hljs-number">0x0</span></span>, <span class="hljs-number"><span class="hljs-number">0x0</span></span>) services/statestorage/methods.<span class="hljs-keyword"><span class="hljs-keyword">go</span></span>:<span class="hljs-number"><span class="hljs-number">15</span></span> +<span class="hljs-number"><span class="hljs-number">0x10c</span></span> fp=<span class="hljs-number"><span class="hljs-number">0xc420715a88</span></span> sp=<span class="hljs-number"><span class="hljs-number">0xc420715a48</span></span> pc=<span class="hljs-number"><span class="hljs-number">0x138339c</span></span> services/virtualmachine.(*service).processTransfer(<span class="hljs-number"><span class="hljs-number">0xc4201ca090</span></span>, <span class="hljs-number"><span class="hljs-number">0xc4203a8097</span></span>, <span class="hljs-number"><span class="hljs-number">0x6</span></span>, <span class="hljs-number"><span class="hljs-number">0xc4203a80a1</span></span>, <span class="hljs-number"><span class="hljs-number">0x6</span></span>, <span class="hljs-number"><span class="hljs-number">0x2a4</span></span>, <span class="hljs-number"><span class="hljs-number">0xc420715b30</span></span>, <span class="hljs-number"><span class="hljs-number">0x1012928</span></span>, <span class="hljs-number"><span class="hljs-number">0x40</span></span>) services/virtualmachine/processor.<span class="hljs-keyword"><span class="hljs-keyword">go</span></span>:<span class="hljs-number"><span class="hljs-number">19</span></span> +<span class="hljs-number"><span class="hljs-number">0x16e</span></span> fp=<span class="hljs-number"><span class="hljs-number">0xc420715ad</span></span>0 sp=<span class="hljs-number"><span class="hljs-number">0xc420715a88</span></span> pc=<span class="hljs-number"><span class="hljs-number">0x13840ee</span></span> services/virtualmachine.(*service).ProcessTransaction(<span class="hljs-number"><span class="hljs-number">0xc4201ca090</span></span>, <span class="hljs-number"><span class="hljs-number">0xc4209e67c0</span></span>, <span class="hljs-number"><span class="hljs-number">0x30</span></span>, <span class="hljs-number"><span class="hljs-number">0x1433660</span></span>, <span class="hljs-number"><span class="hljs-number">0x12a1d</span></span>01) Ginkgo ran <span class="hljs-number"><span class="hljs-number">1</span></span> suite in <span class="hljs-number"><span class="hljs-number">1.288879763s</span></span> Test Suite Failed</code> </pre> <br>  Was ist passiert?   <code>StateStorage</code>       ( <code>map</code> ),   . ,     ,            .     ,           <code>map</code>     <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">sync.map</a> .     . <br><br>     <a href="">processTransfer()</a> .         ,   ‚Äî      .         , ,         ,        ,     .     ,          <code>processTransfer()</code> . <a href=""></a>  . <br><br>    ,   . ,    ,     . <br><br><pre> <code class="hljs go">e2e/stress/transactions.<span class="hljs-keyword"><span class="hljs-keyword">go</span></span>:<span class="hljs-number"><span class="hljs-number">44</span></span> Expected &lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>&gt;: <span class="hljs-number"><span class="hljs-number">-7498</span></span> to equal &lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>&gt;: <span class="hljs-number"><span class="hljs-number">-7551</span></span> e2e/stress/transactions.<span class="hljs-keyword"><span class="hljs-keyword">go</span></span>:<span class="hljs-number"><span class="hljs-number">82</span></span> ------------------------------ Ginkgo ran <span class="hljs-number"><span class="hljs-number">1</span></span> suite in <span class="hljs-number"><span class="hljs-number">5.251593179s</span></span> Test Suite Failed</code> </pre> <br>       ,    . ,   ,          ( ,           ).    ,   <a href=""></a> ,    . <br><br>  ‚Äî  .    TDD         .  Wie ist das m√∂glich?           ,       100%?!   ,    ‚Äî      .    <code>processTransfer()</code>      ,       ,    . <br><br>             .  ,       <a href=""></a>   ,   . <a href=""></a>    . <br><br><h2>  <font color="#3AC1EF">Zusammenfassung</font> </h2><br> , ,  ,     -,      ,      ,  ?     ?   ‚Äî . <br><br>       ,     -.  ,  ¬´¬ª  <code>processTransfer()</code>      .  ,  ,    <a href=""></a> .         ,   ‚Äî .    ,      -       .     ,        ,        . <br><br>     . ,         <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="></a> .  ,     <code>StateStorage</code>   <code>WriteKey</code> ,     , , ,     <code>WriteKeys</code>    ,         ,       . <br><br>   ,        :          .            ¬´ ¬ª.       -,        ,  ,     ,    ,      .   ‚Äî     .     ,   ,    ‚Äî      . <br><br>       ,       ‚Äî   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="></a>  GitHub.          .  ,   ,    , , ,     ,      . <br><br>  <b>Liebe Leser!</b>        ? <br><br> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><img src="https://habrastorage.org/files/1ba/550/d25/1ba550d25e8846ce8805de564da6aa63.png"></a> </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de413681/">https://habr.com/ru/post/de413681/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de413669/index.html">Samsung IT School: Unterrichten von Sch√ºlern in der Entwicklung mobiler Anwendungen</a></li>
<li><a href="../de413673/index.html">Zum Thema Leistung alter und neuer Versionen eines Knotens</a></li>
<li><a href="../de413675/index.html">Joker 2018: Club anonymer Java-Entwickler</a></li>
<li><a href="../de413677/index.html">ROS-Start auf dem selbstausgleichenden EduMIP-Roboter</a></li>
<li><a href="../de413679/index.html">Angular6. PWA. Faule Lademodule. Automatische Bereitstellung in Firebase</a></li>
<li><a href="../de413683/index.html">ILV hat 7 Millionen IP-Adressen entsperrt. Bleiben Sie 4 Millionen gesperrt</a></li>
<li><a href="../de413689/index.html">Debian + Postfix + Dovecot + Multidomain + SSL + IPv6 + OpenVPN + Multi-Interfaces + SpamAssassin-Learn + Bind</a></li>
<li><a href="../de413691/index.html">Starten Sie</a></li>
<li><a href="../de413693/index.html">Handmade: Programmierbare Tastatur f√ºr den Online-Handel zum Selbermachen</a></li>
<li><a href="../de413695/index.html">Messenger-Sicherheit: Warum das Speichern von Nachrichten in der Blockchain eine gute Idee sein k√∂nnte</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>