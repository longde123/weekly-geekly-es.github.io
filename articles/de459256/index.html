<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>📦 ◻️ 🧙 Wie wir unser Themenkrankenhaus für verschiedene Plattformen optimiert haben 🤰🏽 💪🏻 🧒🏼</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Project Hospital ist ein Spiel über die Verwaltung eines Krankenhausgebäudes mit allen Standardaspekten des Genres: vom Spieler erstellte dynamische S...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Wie wir unser Themenkrankenhaus für verschiedene Plattformen optimiert haben</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/459256/"><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/d81/165/b28/d81165b28ad475a63a06e9d674be2bd7.png" alt="Bild"></div><br>  Project Hospital ist ein Spiel über die Verwaltung eines Krankenhausgebäudes mit allen Standardaspekten des Genres: vom Spieler erstellte dynamische Szenen, viele aktive Charaktere und Objekte, die vom UI-System bereitgestellt werden.  Damit das Spiel auf verschiedenen Geräten funktioniert, mussten wir viele Anstrengungen unternehmen. Dies war ein großartiges Beispiel für den berüchtigten „Tod durch tausend Schnitte“ - viele kleine Schritte, die eine Reihe sehr spezifischer Probleme lösen und viel Zeit für die Profilerstellung aufwenden. <br><br><h2>  Leistungsniveau: Was wir erreichen wollten </h2><br>  In einem frühen Entwicklungsstadium haben wir uns für die Hauptparameter entschieden: die maximale Größe der Szenen, das Leistungsniveau und die Systemanforderungen. <br><br>  Wir haben uns die Aufgabe gestellt, mindestens hundert aktive und vollständig animierte Charaktere auf einem Bildschirm, insgesamt dreihundert aktive Charaktere, Kachelkarten mit einer Größe von ca. 100 x 100 und bis zu vier Stockwerken im Gebäude zu unterstützen. <br><br>  Wir waren fest davon überzeugt, dass das Spiel auch auf integrierten Grafikkarten in 1080p mit einer anständigen Bildrate funktionieren sollte, und an sich war dieses Ziel nicht so schwer zu erreichen: Der Hauptbeschränkungsfaktor ist die CPU, insbesondere bei einer Zunahme des Krankenhausvolumens.  Moderne integrierte Grafikkarten treten erst bei Auflösungen von ca. 2560 x 1440 auf. <br><br>  Um die Unterstützung von Mods zu vereinfachen, wurden die meisten Daten geöffnet, dh wir mussten auf die Leistung verzichten, die durch das Packen der Dateien erzielt wurde. Dies hatte jedoch bis auf eine etwas längere Downloadzeit keine besonders starken Auswirkungen. <br><a name="habracut"></a><br><h2>  Grafik </h2><br>  Project Hospital ist ein „klassisches“ isometrisches 2D-Spiel, sodass Sie verstehen können, dass alles von hinten nach vorne gezeichnet wird. In Unity werden dazu die entsprechenden Werte entlang der Z-Achse (oder des Abstands zur Kamera) für einzelne Grafikobjekte festgelegt.  Wenn möglich, sind Objekte, die nicht miteinander interagieren, in Schichten angeordnet. Beispielsweise sind die Stockwerke unabhängig von Objekten und Charakteren. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/8a5/951/079/8a59510793f4c7eb1be7b2dd206c1c17.png"></div><br>  Die gesamte Geometrie in einer isometrisch gerenderten Szene wird dynamisch in C # erstellt. Einer der beiden wichtigsten Aspekte für die Grafikleistung ist daher die Häufigkeit der Neuerstellung der Geometrie.  Der zweite Aspekt ist die Anzahl der Draw Calls. <br><br><h2>  Anrufe zeichnen </h2><br>  Die Anzahl der einzelnen Objekte, die unabhängig von ihrer Einfachheit in einem Frame gezeichnet werden, ist die Hauptbeschränkung, insbesondere bei schlechten Geräten (außerdem erhöht die Unity-Engine selbst den übermäßigen Ressourcenverbrauch).  Die naheliegende Lösung besteht darin, so viele Grafikobjekte wie möglich in einem Zeichnungsaufruf zu gruppieren (zu stapeln).  So können Sie einige interessante Ergebnisse erzielen, z. B. Objekte gruppieren, die sich im gleichen Abstand von der Kamera befinden, sodass der Rest der Grafiken korrekt hinter oder vor ihnen gerendert wird. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/fde/96e/f3d/fde96ef3dd1e2f0f4b6972e8b947654b.png"></div><br>  Hier einige Zahlen: Auf einer 96 x 96-Kachel können Sie theoretisch 9216 Objekte platzieren, für die 9216 Zeichenaufrufe erforderlich wären.  Nach dem Stapeln sinkt diese Zahl auf 192. <br><br>  Im wirklichen Leben ist jedoch alles etwas komplizierter, da Sie nur Objekte mit derselben Textur gruppieren können, was die Ergebnisse etwas weniger optimal macht, aber das System funktioniert immer noch recht gut. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/93d/306/134/93d3061341005108c6638c2ad67f17bd.png"></div><br>  Die meisten Chargen werden manuell durchgeführt, um die Kontrolle über die Ergebnisse zu haben.  Darüber hinaus verwenden wir als letzten Ausweg auch das dynamische Batching von Unity. Dies ist jedoch ein zweischneidiges Schwert. Es hilft zwar, die Anzahl der Draw-Aufrufe zu verringern, führt jedoch zu unnötigen Ressourcen in jedem Frame und kann in einigen Fällen unvorhersehbar sein.  Beispielsweise können zwei überlagerte Sprites im gleichen Abstand von der Kamera in unterschiedlichen Frames in einer unterschiedlichen Reihenfolge gerendert werden, was zu Flackern führt, das beim manuellen Stapeln nicht auftritt. <br><br><h2>  Mehrstöckig </h2><br>  Spieler können Gebäude mit mehreren Stockwerken bauen, was die Komplexität erhöht, aber überraschenderweise die Leistung verbessert.  Nur Charaktere auf der aktiven Etage und auf der Straße müssen gerendert und animiert werden, und alles auf den anderen Etagen des Krankenhauses kann ausgeblendet werden. <br><br><h2>  Shader </h2><br>  Das Projektkrankenhaus verwendet relativ einfache selbstgeschriebene Shader mit kleinen Tricks wie Farbwechsel.  Angenommen, ein Zeichen-Shader kann bis zu fünf Farben ersetzen (abhängig von den Bedingungen im Shader-Code) und ist daher recht teuer. Dies scheint jedoch keine Probleme zu verursachen, da Zeichen selten viel Platz auf dem Bildschirm einnehmen.  Der Shader begründete den Aufwand, da die Möglichkeit, unendlich viele Kleidungsfarben zu verwenden, die Variabilität der Charaktere und der Umgebung erheblich erhöhen kann. <br><br>  Außerdem haben wir schnell genug gelernt, die Angabe von Shader-Parametern zu vermeiden, und stattdessen, wann immer möglich, Scheitelpunktfarben verwendet. <br><br><h2>  Texturqualität </h2><br>  Eine interessante Tatsache - in Project Hospital verwenden wir keine Texturkomprimierung: Die Grafiken werden in einem Vektorstil erstellt, und bei einigen Texturen sieht die Komprimierung sehr schlecht aus. <br><br>  Um CPU-Speicher in Systemen mit weniger als 1 GB zu sparen, reduzieren wir die Größe von Texturen im Spiel automatisch auf die halbe Auflösung (mit Ausnahme von Texturen auf der Benutzeroberfläche). Dies lässt sich anhand des Parameters „Texturqualität: niedrig“ in den Optionen verstehen.  UI-Texturen behalten ihre ursprüngliche Auflösung bei. <br><br><h2>  Optimieren Sie die CPU-Leistung - Multithreading </h2><br>  Obwohl die Unity-Skriptlogik im Wesentlichen Single-Threaded ist, können wir immer mehrere Threads direkt in C # ausführen.  Möglicherweise ist dieser Ansatz nicht für die Spielelogik geeignet, aber häufig gibt es zeitkritische Aufgaben, die in separaten Threads ausgeführt werden können, indem ein Aufgabensystem organisiert wird.  In unserem Fall wurden Threads für zwei Funktionen verwendet: <br><br>  1. Die Suche nach einem Pfad, insbesondere auf großen Karten mit einer verwirrenden Anordnung, kann bis zu Hunderten von Millisekunden dauern. Dies war also der Hauptkandidat für die Übertragung vom Hauptstrom.  Parallele Aufgaben berücksichtigen die Anzahl der Hardware-Threads einer Maschine. <br><br>  2. Beleuchtungskarten können auch in einem separaten Stream aktualisiert werden, jedoch jeweils nur in einer Etage - dies ist kein kritisches System, und automatische Lampen in den Räumen gehen mit einer solchen Geschwindigkeit aus, dass eine seltene Aktualisierung ausreicht. <br><br><h2>  Animationen </h2><br>  Fast zu Beginn der Entwicklung haben wir uns für ein zweidimensionales Skelettanimationssystem entschieden.  Nachdem wir verschiedene moderne Animationsprogramme studiert hatten, beschlossen wir schließlich, ein einfaches System, das ich vor einigen Jahren erstellt hatte (im Wesentlichen als Hobbyprojekt), zu modifizieren und es an die Bedürfnisse des Projektkrankenhauses anzupassen - es ähnelt einer vereinfachten Wirbelsäule mit direkter Unterstützung für die Erstellung von Charaktervariationen.  Wie bei Spine wird die C # -Laufzeit verwendet, die offensichtlich teurer als der native Code ist. Daher haben wir während des Entwicklungsprozesses einige Optimierungszyklen durchgeführt.  Glücklicherweise sind unsere Rigs recht einfach, nur etwa 20 Knochen pro Charakter. <br><br>  Eine merkwürdige Tatsache: Die nützlichste Verbesserung bei der Optimierung des Zugriffs auf die Transformation einzelner Knochen war der Übergang von der Kartensuche zur einfachen Indizierung von Arrays. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/462/f1e/440/462f1e440f6dbc3f7e77f4ff42986966.png"></div><br>  Neben der Tatsache, dass die Zeichen nicht außerhalb der Kamera animiert werden, gibt es noch einen weiteren Trick: Die hinter den Fenstern der Hauptbenutzeroberfläche versteckten Zeichen müssen auch nicht animiert werden.  Leider haben wir in der endgültigen Version des Spiels auf eine durchscheinende Benutzeroberfläche umgestellt, sodass wir sie nicht verwenden konnten. <br><br><h2>  Caching </h2><br>  Wenn möglich, versuchen wir, die teuersten Berechnungen nur mit Änderungen durchzuführen, die sich auf deren Werte auswirken.  Das beste Beispiel hierfür sind Räume und Aufzüge: Wenn ein Spieler einen Aufzug platziert oder Wände baut, führen wir einen Füllalgorithmus aus, der Kacheln markiert, von denen Aufzüge und Räume verfügbar sind.  Dies beschleunigt die nachfolgende Suche nach Pfaden und kann verwendet werden, um dem Spieler anzuzeigen, welche Räume noch nicht verfügbar sind. <br><br><h2>  Verstreute und verzögerte Updates </h2><br>  In einigen Fällen ist es logisch, bestimmte Aktualisierungen nur teilweise durchzuführen.  Hier einige Beispiele: <br><br>  Einige Aktualisierungen können in jedem Frame nur für einen Teil der Zeichen durchgeführt werden. Beispielsweise werden die Verhaltensskripte der Hälfte der Patienten nur in ungeraden Frames und in der zweiten Hälfte in geraden Frames aktualisiert (obwohl Animationen und Bewegungen reibungslos ausgeführt werden). <br><br>  Unter bestimmten Bedingungen, insbesondere wenn sich Zeichen im Standby-Modus befinden, aber teure Teile des Codes aufrufen (z. B. Mitarbeiter, die prüfen, was gefüllt werden muss, und nach nicht besetzten Geräten suchen), werden Vorgänge nur in bestimmten Intervallen ausgeführt, z. B. einmal pro Sekunde. <br><br>  Eine der teuersten und gleichzeitig häufigsten Herausforderungen besteht darin, zu überprüfen, welche Tests für jeden Patienten verfügbar sind.  Gleichzeitig müssen viele Faktoren bewertet werden - zum Beispiel, welches Personal der Abteilung derzeit beschäftigt ist und welche Ausrüstung reserviert ist.  Darüber hinaus sind diese Informationen nicht allen Patienten gemeinsam, da sie beispielsweise von dem ihnen zugewiesenen Arzt und ihrer Sprechfähigkeit beeinflusst werden.  Es ist notwendig, Dutzende verfügbarer Analysetypen zu überprüfen. Daher wird die Aktualisierung in einem Frame nur für einige durchgeführt und im nächsten fortgesetzt. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/014/1a6/e24/0141a6e2458e7edb58a0d96072faab8e.png"></div><br><h2>  Fazit </h2><br>  Die Optimierung eines Spielmanagers mit vielen interagierenden Teilen hat sich als langwieriger Prozess erwiesen.  Ich musste regelmäßig mit dem Unity-Profiler arbeiten und die offensichtlichsten Probleme beheben. Dies ist ein wesentlicher Bestandteil des Entwicklungsprozesses geworden. <br><br>  Natürlich gibt es immer Raum für Verbesserungen, aber wir sind sehr zufrieden mit den Ergebnissen.  Das Spiel bewältigt unsere Aufgaben und die Spieler erstellen ständig Mods dafür, die das ursprüngliche Limit für die Anzahl der Charaktere deutlich überschreiten. <br><br>  Es ist auch erwähnenswert, dass ich selbst im Vergleich zu einigen AAA-Spielen, an denen ich gearbeitet habe, im Project Hospital die komplexeste Spielelogik in meiner Praxis getroffen habe, weshalb viele der Probleme spezifisch für dieses Projekt waren.  Trotzdem empfehle ich, in jedem Projekt genügend Zeit für die Optimierung entsprechend der Komplexität des Spiels zu lassen. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de459256/">https://habr.com/ru/post/de459256/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de459246/index.html">Warum nimmt die Site-Conversion ab? Beispiele für 60 Design- und Usability-Fehler</a></li>
<li><a href="../de459248/index.html">Digitale Veranstaltungen in Moskau vom 9. bis 14. Juli</a></li>
<li><a href="../de459250/index.html">WAL in PostgreSQL: 2. Protokoll aufzeichnen</a></li>
<li><a href="../de459252/index.html">Sicherheitswoche 28: Ein Smart Home hacken</a></li>
<li><a href="../de459254/index.html">Noch bessere Reißverschlussbombe</a></li>
<li><a href="../de459258/index.html">14.000 Meilen nicht haken</a></li>
<li><a href="../de459262/index.html">Mit 22 in den Ruhestand getreten</a></li>
<li><a href="../de459264/index.html">Verlassen von Tarantool-Netzwerken. Knotensynchronisation beim Filtern des Datenverkehrs</a></li>
<li><a href="../de459272/index.html">Schreiben einer API für React-Komponenten, Teil 1: Erstellen Sie keine widersprüchlichen Requisiten</a></li>
<li><a href="../de459274/index.html">Sicherheitsanfälligkeit bezüglich Bildschirmsperre in Astra Linux Special Edition (Smolensk)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>