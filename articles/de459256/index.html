<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üì¶ ‚óªÔ∏è üßô Wie wir unser Themenkrankenhaus f√ºr verschiedene Plattformen optimiert haben ü§∞üèΩ üí™üèª üßíüèº</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Project Hospital ist ein Spiel √ºber die Verwaltung eines Krankenhausgeb√§udes mit allen Standardaspekten des Genres: vom Spieler erstellte dynamische S...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Wie wir unser Themenkrankenhaus f√ºr verschiedene Plattformen optimiert haben</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/459256/"><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/d81/165/b28/d81165b28ad475a63a06e9d674be2bd7.png" alt="Bild"></div><br>  Project Hospital ist ein Spiel √ºber die Verwaltung eines Krankenhausgeb√§udes mit allen Standardaspekten des Genres: vom Spieler erstellte dynamische Szenen, viele aktive Charaktere und Objekte, die vom UI-System bereitgestellt werden.  Damit das Spiel auf verschiedenen Ger√§ten funktioniert, mussten wir viele Anstrengungen unternehmen. Dies war ein gro√üartiges Beispiel f√ºr den ber√ºchtigten ‚ÄûTod durch tausend Schnitte‚Äú - viele kleine Schritte, die eine Reihe sehr spezifischer Probleme l√∂sen und viel Zeit f√ºr die Profilerstellung aufwenden. <br><br><h2>  Leistungsniveau: Was wir erreichen wollten </h2><br>  In einem fr√ºhen Entwicklungsstadium haben wir uns f√ºr die Hauptparameter entschieden: die maximale Gr√∂√üe der Szenen, das Leistungsniveau und die Systemanforderungen. <br><br>  Wir haben uns die Aufgabe gestellt, mindestens hundert aktive und vollst√§ndig animierte Charaktere auf einem Bildschirm, insgesamt dreihundert aktive Charaktere, Kachelkarten mit einer Gr√∂√üe von ca. 100 x 100 und bis zu vier Stockwerken im Geb√§ude zu unterst√ºtzen. <br><br>  Wir waren fest davon √ºberzeugt, dass das Spiel auch auf integrierten Grafikkarten in 1080p mit einer anst√§ndigen Bildrate funktionieren sollte, und an sich war dieses Ziel nicht so schwer zu erreichen: Der Hauptbeschr√§nkungsfaktor ist die CPU, insbesondere bei einer Zunahme des Krankenhausvolumens.  Moderne integrierte Grafikkarten treten erst bei Aufl√∂sungen von ca. 2560 x 1440 auf. <br><br>  Um die Unterst√ºtzung von Mods zu vereinfachen, wurden die meisten Daten ge√∂ffnet, dh wir mussten auf die Leistung verzichten, die durch das Packen der Dateien erzielt wurde. Dies hatte jedoch bis auf eine etwas l√§ngere Downloadzeit keine besonders starken Auswirkungen. <br><a name="habracut"></a><br><h2>  Grafik </h2><br>  Project Hospital ist ein ‚Äûklassisches‚Äú isometrisches 2D-Spiel, sodass Sie verstehen k√∂nnen, dass alles von hinten nach vorne gezeichnet wird. In Unity werden dazu die entsprechenden Werte entlang der Z-Achse (oder des Abstands zur Kamera) f√ºr einzelne Grafikobjekte festgelegt.  Wenn m√∂glich, sind Objekte, die nicht miteinander interagieren, in Schichten angeordnet. Beispielsweise sind die Stockwerke unabh√§ngig von Objekten und Charakteren. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/8a5/951/079/8a59510793f4c7eb1be7b2dd206c1c17.png"></div><br>  Die gesamte Geometrie in einer isometrisch gerenderten Szene wird dynamisch in C # erstellt. Einer der beiden wichtigsten Aspekte f√ºr die Grafikleistung ist daher die H√§ufigkeit der Neuerstellung der Geometrie.  Der zweite Aspekt ist die Anzahl der Draw Calls. <br><br><h2>  Anrufe zeichnen </h2><br>  Die Anzahl der einzelnen Objekte, die unabh√§ngig von ihrer Einfachheit in einem Frame gezeichnet werden, ist die Hauptbeschr√§nkung, insbesondere bei schlechten Ger√§ten (au√üerdem erh√∂ht die Unity-Engine selbst den √ºberm√§√üigen Ressourcenverbrauch).  Die naheliegende L√∂sung besteht darin, so viele Grafikobjekte wie m√∂glich in einem Zeichnungsaufruf zu gruppieren (zu stapeln).  So k√∂nnen Sie einige interessante Ergebnisse erzielen, z. B. Objekte gruppieren, die sich im gleichen Abstand von der Kamera befinden, sodass der Rest der Grafiken korrekt hinter oder vor ihnen gerendert wird. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/fde/96e/f3d/fde96ef3dd1e2f0f4b6972e8b947654b.png"></div><br>  Hier einige Zahlen: Auf einer 96 x 96-Kachel k√∂nnen Sie theoretisch 9216 Objekte platzieren, f√ºr die 9216 Zeichenaufrufe erforderlich w√§ren.  Nach dem Stapeln sinkt diese Zahl auf 192. <br><br>  Im wirklichen Leben ist jedoch alles etwas komplizierter, da Sie nur Objekte mit derselben Textur gruppieren k√∂nnen, was die Ergebnisse etwas weniger optimal macht, aber das System funktioniert immer noch recht gut. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/93d/306/134/93d3061341005108c6638c2ad67f17bd.png"></div><br>  Die meisten Chargen werden manuell durchgef√ºhrt, um die Kontrolle √ºber die Ergebnisse zu haben.  Dar√ºber hinaus verwenden wir als letzten Ausweg auch das dynamische Batching von Unity. Dies ist jedoch ein zweischneidiges Schwert. Es hilft zwar, die Anzahl der Draw-Aufrufe zu verringern, f√ºhrt jedoch zu unn√∂tigen Ressourcen in jedem Frame und kann in einigen F√§llen unvorhersehbar sein.  Beispielsweise k√∂nnen zwei √ºberlagerte Sprites im gleichen Abstand von der Kamera in unterschiedlichen Frames in einer unterschiedlichen Reihenfolge gerendert werden, was zu Flackern f√ºhrt, das beim manuellen Stapeln nicht auftritt. <br><br><h2>  Mehrst√∂ckig </h2><br>  Spieler k√∂nnen Geb√§ude mit mehreren Stockwerken bauen, was die Komplexit√§t erh√∂ht, aber √ºberraschenderweise die Leistung verbessert.  Nur Charaktere auf der aktiven Etage und auf der Stra√üe m√ºssen gerendert und animiert werden, und alles auf den anderen Etagen des Krankenhauses kann ausgeblendet werden. <br><br><h2>  Shader </h2><br>  Das Projektkrankenhaus verwendet relativ einfache selbstgeschriebene Shader mit kleinen Tricks wie Farbwechsel.  Angenommen, ein Zeichen-Shader kann bis zu f√ºnf Farben ersetzen (abh√§ngig von den Bedingungen im Shader-Code) und ist daher recht teuer. Dies scheint jedoch keine Probleme zu verursachen, da Zeichen selten viel Platz auf dem Bildschirm einnehmen.  Der Shader begr√ºndete den Aufwand, da die M√∂glichkeit, unendlich viele Kleidungsfarben zu verwenden, die Variabilit√§t der Charaktere und der Umgebung erheblich erh√∂hen kann. <br><br>  Au√üerdem haben wir schnell genug gelernt, die Angabe von Shader-Parametern zu vermeiden, und stattdessen, wann immer m√∂glich, Scheitelpunktfarben verwendet. <br><br><h2>  Texturqualit√§t </h2><br>  Eine interessante Tatsache - in Project Hospital verwenden wir keine Texturkomprimierung: Die Grafiken werden in einem Vektorstil erstellt, und bei einigen Texturen sieht die Komprimierung sehr schlecht aus. <br><br>  Um CPU-Speicher in Systemen mit weniger als 1 GB zu sparen, reduzieren wir die Gr√∂√üe von Texturen im Spiel automatisch auf die halbe Aufl√∂sung (mit Ausnahme von Texturen auf der Benutzeroberfl√§che). Dies l√§sst sich anhand des Parameters ‚ÄûTexturqualit√§t: niedrig‚Äú in den Optionen verstehen.  UI-Texturen behalten ihre urspr√ºngliche Aufl√∂sung bei. <br><br><h2>  Optimieren Sie die CPU-Leistung - Multithreading </h2><br>  Obwohl die Unity-Skriptlogik im Wesentlichen Single-Threaded ist, k√∂nnen wir immer mehrere Threads direkt in C # ausf√ºhren.  M√∂glicherweise ist dieser Ansatz nicht f√ºr die Spielelogik geeignet, aber h√§ufig gibt es zeitkritische Aufgaben, die in separaten Threads ausgef√ºhrt werden k√∂nnen, indem ein Aufgabensystem organisiert wird.  In unserem Fall wurden Threads f√ºr zwei Funktionen verwendet: <br><br>  1. Die Suche nach einem Pfad, insbesondere auf gro√üen Karten mit einer verwirrenden Anordnung, kann bis zu Hunderten von Millisekunden dauern. Dies war also der Hauptkandidat f√ºr die √úbertragung vom Hauptstrom.  Parallele Aufgaben ber√ºcksichtigen die Anzahl der Hardware-Threads einer Maschine. <br><br>  2. Beleuchtungskarten k√∂nnen auch in einem separaten Stream aktualisiert werden, jedoch jeweils nur in einer Etage - dies ist kein kritisches System, und automatische Lampen in den R√§umen gehen mit einer solchen Geschwindigkeit aus, dass eine seltene Aktualisierung ausreicht. <br><br><h2>  Animationen </h2><br>  Fast zu Beginn der Entwicklung haben wir uns f√ºr ein zweidimensionales Skelettanimationssystem entschieden.  Nachdem wir verschiedene moderne Animationsprogramme studiert hatten, beschlossen wir schlie√ülich, ein einfaches System, das ich vor einigen Jahren erstellt hatte (im Wesentlichen als Hobbyprojekt), zu modifizieren und es an die Bed√ºrfnisse des Projektkrankenhauses anzupassen - es √§hnelt einer vereinfachten Wirbels√§ule mit direkter Unterst√ºtzung f√ºr die Erstellung von Charaktervariationen.  Wie bei Spine wird die C # -Laufzeit verwendet, die offensichtlich teurer als der native Code ist. Daher haben wir w√§hrend des Entwicklungsprozesses einige Optimierungszyklen durchgef√ºhrt.  Gl√ºcklicherweise sind unsere Rigs recht einfach, nur etwa 20 Knochen pro Charakter. <br><br>  Eine merkw√ºrdige Tatsache: Die n√ºtzlichste Verbesserung bei der Optimierung des Zugriffs auf die Transformation einzelner Knochen war der √úbergang von der Kartensuche zur einfachen Indizierung von Arrays. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/462/f1e/440/462f1e440f6dbc3f7e77f4ff42986966.png"></div><br>  Neben der Tatsache, dass die Zeichen nicht au√üerhalb der Kamera animiert werden, gibt es noch einen weiteren Trick: Die hinter den Fenstern der Hauptbenutzeroberfl√§che versteckten Zeichen m√ºssen auch nicht animiert werden.  Leider haben wir in der endg√ºltigen Version des Spiels auf eine durchscheinende Benutzeroberfl√§che umgestellt, sodass wir sie nicht verwenden konnten. <br><br><h2>  Caching </h2><br>  Wenn m√∂glich, versuchen wir, die teuersten Berechnungen nur mit √Ñnderungen durchzuf√ºhren, die sich auf deren Werte auswirken.  Das beste Beispiel hierf√ºr sind R√§ume und Aufz√ºge: Wenn ein Spieler einen Aufzug platziert oder W√§nde baut, f√ºhren wir einen F√ºllalgorithmus aus, der Kacheln markiert, von denen Aufz√ºge und R√§ume verf√ºgbar sind.  Dies beschleunigt die nachfolgende Suche nach Pfaden und kann verwendet werden, um dem Spieler anzuzeigen, welche R√§ume noch nicht verf√ºgbar sind. <br><br><h2>  Verstreute und verz√∂gerte Updates </h2><br>  In einigen F√§llen ist es logisch, bestimmte Aktualisierungen nur teilweise durchzuf√ºhren.  Hier einige Beispiele: <br><br>  Einige Aktualisierungen k√∂nnen in jedem Frame nur f√ºr einen Teil der Zeichen durchgef√ºhrt werden. Beispielsweise werden die Verhaltensskripte der H√§lfte der Patienten nur in ungeraden Frames und in der zweiten H√§lfte in geraden Frames aktualisiert (obwohl Animationen und Bewegungen reibungslos ausgef√ºhrt werden). <br><br>  Unter bestimmten Bedingungen, insbesondere wenn sich Zeichen im Standby-Modus befinden, aber teure Teile des Codes aufrufen (z. B. Mitarbeiter, die pr√ºfen, was gef√ºllt werden muss, und nach nicht besetzten Ger√§ten suchen), werden Vorg√§nge nur in bestimmten Intervallen ausgef√ºhrt, z. B. einmal pro Sekunde. <br><br>  Eine der teuersten und gleichzeitig h√§ufigsten Herausforderungen besteht darin, zu √ºberpr√ºfen, welche Tests f√ºr jeden Patienten verf√ºgbar sind.  Gleichzeitig m√ºssen viele Faktoren bewertet werden - zum Beispiel, welches Personal der Abteilung derzeit besch√§ftigt ist und welche Ausr√ºstung reserviert ist.  Dar√ºber hinaus sind diese Informationen nicht allen Patienten gemeinsam, da sie beispielsweise von dem ihnen zugewiesenen Arzt und ihrer Sprechf√§higkeit beeinflusst werden.  Es ist notwendig, Dutzende verf√ºgbarer Analysetypen zu √ºberpr√ºfen. Daher wird die Aktualisierung in einem Frame nur f√ºr einige durchgef√ºhrt und im n√§chsten fortgesetzt. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/014/1a6/e24/0141a6e2458e7edb58a0d96072faab8e.png"></div><br><h2>  Fazit </h2><br>  Die Optimierung eines Spielmanagers mit vielen interagierenden Teilen hat sich als langwieriger Prozess erwiesen.  Ich musste regelm√§√üig mit dem Unity-Profiler arbeiten und die offensichtlichsten Probleme beheben. Dies ist ein wesentlicher Bestandteil des Entwicklungsprozesses geworden. <br><br>  Nat√ºrlich gibt es immer Raum f√ºr Verbesserungen, aber wir sind sehr zufrieden mit den Ergebnissen.  Das Spiel bew√§ltigt unsere Aufgaben und die Spieler erstellen st√§ndig Mods daf√ºr, die das urspr√ºngliche Limit f√ºr die Anzahl der Charaktere deutlich √ºberschreiten. <br><br>  Es ist auch erw√§hnenswert, dass ich selbst im Vergleich zu einigen AAA-Spielen, an denen ich gearbeitet habe, im Project Hospital die komplexeste Spielelogik in meiner Praxis getroffen habe, weshalb viele der Probleme spezifisch f√ºr dieses Projekt waren.  Trotzdem empfehle ich, in jedem Projekt gen√ºgend Zeit f√ºr die Optimierung entsprechend der Komplexit√§t des Spiels zu lassen. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de459256/">https://habr.com/ru/post/de459256/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de459246/index.html">Warum nimmt die Site-Conversion ab? Beispiele f√ºr 60 Design- und Usability-Fehler</a></li>
<li><a href="../de459248/index.html">Digitale Veranstaltungen in Moskau vom 9. bis 14. Juli</a></li>
<li><a href="../de459250/index.html">WAL in PostgreSQL: 2. Protokoll aufzeichnen</a></li>
<li><a href="../de459252/index.html">Sicherheitswoche 28: Ein Smart Home hacken</a></li>
<li><a href="../de459254/index.html">Noch bessere Rei√üverschlussbombe</a></li>
<li><a href="../de459258/index.html">14.000 Meilen nicht haken</a></li>
<li><a href="../de459262/index.html">Mit 22 in den Ruhestand getreten</a></li>
<li><a href="../de459264/index.html">Verlassen von Tarantool-Netzwerken. Knotensynchronisation beim Filtern des Datenverkehrs</a></li>
<li><a href="../de459272/index.html">Schreiben einer API f√ºr React-Komponenten, Teil 1: Erstellen Sie keine widerspr√ºchlichen Requisiten</a></li>
<li><a href="../de459274/index.html">Sicherheitsanf√§lligkeit bez√ºglich Bildschirmsperre in Astra Linux Special Edition (Smolensk)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>