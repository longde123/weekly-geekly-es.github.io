<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üçπ üåî üíæ Django Channels - die Antwort auf das moderne Web üë©‚Äç‚ù§Ô∏è‚Äçüíã‚Äçüë® üî† ü•ü</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In der Welt von Django wird das Add-On Django Channels immer beliebter. Diese Bibliothek sollte Django die asynchrone Netzwerkprogrammierung bringen, ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Django Channels - die Antwort auf das moderne Web</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/oleg-bunin/blog/418445/">  In der Welt von Django wird das Add-On Django Channels immer beliebter.  Diese Bibliothek sollte Django die asynchrone Netzwerkprogrammierung bringen, auf die wir gewartet haben.  <strong>Artyom Malyshev</strong> auf der Moscow Python Conf 2017 erkl√§rte, wie die erste Version der Bibliothek dies tut (jetzt hat der Autor bereits Kan√§le gezippt2), warum sie es tut und √ºberhaupt tut. <br><br>  Zun√§chst sagt Zen Zen, dass jede L√∂sung die einzige sein sollte.  Daher <strong>gibt es in Python jeweils mindestens drei</strong> .  Es gibt bereits viele asynchrone Netzwerk-Frameworks: <br><br><ul><li>  Verdreht <br></li><li>  Eventlet <br></li><li>  Gevent <br></li><li>  Tornado; <br></li><li>  Asyncio <br></li></ul><br>  Es scheint, warum eine andere Bibliothek schreiben und ob es √ºberhaupt notwendig ist. <br><br><iframe width="560" height="315" src="https://www.youtube.com/embed/ij0PiSlYBu0" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br>  <strong><em>√úber den Sprecher:</em></strong> Artyom Malyshev ist ein unabh√§ngiger Python-Entwickler.  Er besch√§ftigt sich mit der Entwicklung verteilter Systeme und spricht auf Konferenzen √ºber Python.  Artyom kann unter dem Spitznamen <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" class="user_link">PROOFIT404</a> auf Github und in sozialen Netzwerken gefunden werden. <br><a name="habracut"></a><br>  <strong>Django ist per Definition synchron</strong> .  Wenn es sich um ORM handelt, kostet der synchrone Zugriff auf die Datenbank w√§hrend des Attributzugriffs, wenn wir beispielsweise post.author.username schreiben, nichts. <br><br>  Dar√ºber hinaus ist Django ein WSGI-Framework. <br><br><h2>  WSGI <br></h2><br>  WSGI ist eine synchrone Schnittstelle f√ºr die Arbeit mit Webservern. <br><br><pre><code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">app</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(environ, callback)</span></span></span><span class="hljs-function"> :</span></span> status, headers = <span class="hljs-string"><span class="hljs-string">'200 OK'</span></span>, [] callback (status, headers) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> [<span class="hljs-string"><span class="hljs-string">'Hello world!\n'</span></span>]</code> </pre> <br>  Das Hauptmerkmal ist, dass wir eine Funktion haben, die ein Argument akzeptiert und sofort einen Wert zur√ºckgibt.  Das ist alles, was der Webserver von uns erwarten kann.  <strong>Nicht asynchron und riecht nicht</strong> . <br><br>  Dies geschah vor langer Zeit, im Jahr 2003, als das Web einfach war, Benutzer alle Arten von Nachrichten im Internet lasen und in G√§steb√ºcher gingen.  Es gen√ºgte, die Anfrage anzunehmen und zu bearbeiten.  Geben Sie eine Antwort und vergessen Sie, dass dieser Benutzer √ºberhaupt war. <br><img src="https://habrastorage.org/webt/-a/3e/ly/-a3elynsjri1d0qbc73yl256qbo.jpeg"><br><br>  Aber f√ºr eine Sekunde ist jetzt nicht das Jahr 2003, also wollen die Benutzer viel mehr von uns. <br><img src="https://habrastorage.org/webt/-j/fp/nz/-jfpnzpcfn0w2hpbvmcejswxnaw.jpeg"><br>  Sie m√∂chten eine Rich-Webanwendung und Live-Inhalte. Sie m√∂chten, dass die Anwendung auf dem Desktop, auf dem Laptop, auf anderen Seiten und auf der Uhr hervorragend funktioniert.  Am wichtigsten ist, dass <strong>Benutzer F5 nicht dr√ºcken m√∂chten</strong> , da beispielsweise Tablets keine solche Taste haben. <br><br><img src="https://habrastorage.org/webt/bq/gi/ql/bqgiql6zzob87g74yngfmwvkehs.jpeg"><br><br>  Webbrowser kommen nat√ºrlich auf uns zu - sie f√ºgen neue Protokolle und neue Funktionen hinzu.  Wenn Sie und ich nur das Frontend entwickeln w√ºrden, w√ºrden wir den Browser einfach als Plattform nehmen und seine Kernfunktionen nutzen, da er bereit ist, sie uns zur Verf√ºgung zu stellen. <br><br>  <strong>F√ºr Backend-Programmierer hat sich jedoch alles stark ver√§ndert</strong> .  Web-Sockets, HTTP2 und dergleichen sind ein gro√üer Schmerz in Bezug auf die Architektur, da es sich um langlebige Verbindungen zu ihren Zust√§nden handelt, die irgendwie behandelt werden m√ºssen. <br><img src="https://habrastorage.org/webt/g1/pn/gi/g1pngi6z8op3aesfec2rtiodv4q.jpeg"><br><br>  Dies ist das Problem, das Django Channels for Django zu l√∂sen versucht.  Diese Bibliothek wurde entwickelt, um Ihnen die M√∂glichkeit zu geben, Verbindungen zu handhaben, wobei der gewohnte Django Core v√∂llig unver√§ndert bleibt. <br><br>  Er wurde von <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><strong>Andrew Godwin</strong></a> , dem Besitzer eines schrecklichen englischen Akzents, der sehr schnell spricht, zu einer wundervollen Person gemacht.  Sie sollten es an solchen Dingen wie den l√§ngst vergessenen Django South- und Django-Migrationen erkennen, die uns ab Version 1.7 zur Verf√ºgung standen.  Seit er die Migrationen f√ºr Django repariert hat, hat er begonnen, Web-Sockets und HTTP2 zu reparieren. <br><br>  Wie hat er das gemacht?  Es war einmal ein solches Bild im Internet: leere Quadrate, Pfeile, die Aufschrift ‚ÄûGute Architektur‚Äú - Sie geben Ihre Lieblingstechnologien in diese kleinen Quadrate ein und erhalten eine Website, die sich gut skalieren l√§sst. <br><br><img src="https://habrastorage.org/webt/r1/rz/z9/r1rzz99ck74ggy5uy8vnn7kebks.jpeg"><br><br>  Andrew Godwin hat in diesen Feldern einen Server eingegeben, der vorne steht und alle Anfragen akzeptiert, sei es asynchron, synchron, E-Mail, was auch immer.  Dazwischen befindet sich die sogenannte Kanalschicht, in der empfangene Nachrichten in einem Format gespeichert werden, auf das der Pool synchroner Mitarbeiter zugreifen kann.  Sobald die asynchrone Verbindung etwas an uns gesendet hat, zeichnen wir es in der Kanalebene auf, und der Synchronarbeiter kann es von dort abholen und auf dieselbe Weise wie jede Django-Ansicht oder irgendetwas anderes synchron verarbeiten.  Sobald der synchrone Code eine Antwort an Channel Layer zur√ºckgesendet hat, gibt der asynchrone Server sie, √ºbertr√§gt sie und tut, was immer er ben√∂tigt.  Somit wird eine Abstraktion durchgef√ºhrt. <br><br>  Dies impliziert mehrere Implementierungen, und in der Produktion wird vorgeschlagen, <strong>Twisted als asynchronen Server zu verwenden</strong> , der das Frontend f√ºr Django implementiert, und <strong>Redis</strong> , der der gleiche Kommunikationskanal zwischen synchronem Django und asynchronem Twisted sein wird. <br><br><blockquote>  Die gute Nachricht: Um Django-Kan√§le nutzen zu k√∂nnen, m√ºssen Sie weder Twisted noch Redis kennen - dies sind alles Implementierungsdetails.  Ihre DevOps werden dies wissen, oder Sie werden sich treffen, wenn Sie um drei Uhr morgens eine heruntergefallene Produktion reparieren. </blockquote><br><h2>  ASGI </h2><br>  Abstraktion ist ein Protokoll namens ASGI.  Dies ist die Standardschnittstelle zwischen jeder Netzwerkschnittstelle und jedem Server, unabh√§ngig davon, ob es sich um ein synchrones oder asynchrones Protokoll handelt, und Ihrer Anwendung.  Sein Hauptkonzept ist der Kanal. <br><br><h3>  Kanal </h3><br>  Ein Kanal ist eine First-In-First-Out-Warteschlange von Nachrichten mit einer Lebensdauer.  Diese Nachrichten k√∂nnen null oder einmal zugestellt werden und k√∂nnen nur von einem Verbraucher empfangen werden. <br><br><h3>  Verbraucher </h3><br>  Bei Consumer schreiben Sie nur Ihren Code. <br><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ws_message</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(message)</span></span></span><span class="hljs-function"> :</span></span> message.reply_channel.send ( { <span class="hljs-string"><span class="hljs-string">'text'</span></span>: message.content [<span class="hljs-string"><span class="hljs-string">'text'</span></span>], } )</code> </pre><br>  Eine Funktion, die eine Nachricht akzeptiert, sendet m√∂glicherweise mehrere Antworten oder √ºberhaupt keine Antwort.  Der einzige Unterschied besteht darin, dass es keine R√ºckgabefunktion gibt, sodass wir dar√ºber sprechen k√∂nnen, wie viele Antworten wir von der Funktion zur√ºckgeben. <br><br>  Wir f√ºgen diese Funktion dem Routing hinzu, h√§ngen sie beispielsweise auf, um eine Nachricht an einem Web-Socket zu empfangen. <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> channels.routing <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> route <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> myapp.consumers <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> ws_message channel_routing = [ route (<span class="hljs-string"><span class="hljs-string">'websocket.receive'</span></span> ws_message), }</code> </pre><br>  Wir schreiben dies in die Django-Einstellungen, so wie die Datenbank vorgeschrieben w√§re. <br><br><pre> <code class="python hljs">CHANNEL_LAYERS = { <span class="hljs-string"><span class="hljs-string">'default'</span></span>: { <span class="hljs-string"><span class="hljs-string">'BACKEND'</span></span>: <span class="hljs-string"><span class="hljs-string">'asgiref.inmemory'</span></span>, <span class="hljs-string"><span class="hljs-string">'ROUTING'</span></span>: <span class="hljs-string"><span class="hljs-string">'myproject.routing'</span></span>, }, }</code> </pre><br>  Ein Projekt kann mehrere Kanalebenen haben, genauso wie es mehrere Datenbanken geben kann.  Dieses Ding ist dem DB-Router sehr √§hnlich, wenn jemand es benutzt hat. <br><br>  Als n√§chstes definieren wir unsere ASGI-Anwendung.  Es synchronisiert, wie Twisted startet und wie synchronisierte Worker starten - alle ben√∂tigen diese Anwendung. <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> os <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> channels.asgi <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> get_channel_layer os.environ.setdefault( <span class="hljs-string"><span class="hljs-string">'DJANGO_SETTINGS_MODULE'</span></span>, <span class="hljs-string"><span class="hljs-string">'myproject.settings'</span></span>, ) channel_layer = get_channel_layer()</code> </pre><br>  Stellen Sie danach den Code bereit: F√ºhren Sie gunicorn aus und senden Sie standardm√§√üig eine HTTP-Anfrage synchron mit der Ansicht, wie Sie es gewohnt sind.  Wir starten den asynchronen Server, der die Vorderseite vor unserem synchronen Django sein wird, und die Mitarbeiter, die die Nachrichten verarbeiten. <br><br><pre> <code class="python hljs">$ gunicorn myproject.wsgi $ daphne myproject.asgi:channel_layer $ django-admin runworker</code> </pre><br><h3>  Antwortkanal </h3><br>  Wie wir gesehen haben, hat Nachricht ein Konzept wie Antwortkanal.  Warum wird das ben√∂tigt? <br><br>  Kanal unidirektional bzw. WebSocket empfangen, WebSocket verbinden, WebSocket trennen - Dies ist ein allgemeiner Kanal f√ºr eingehende Nachrichten zum System.  Ein Antwortkanal ist ein Kanal, der streng an die Verbindung des Benutzers gebunden ist.  Dementsprechend hat die Nachricht einen Eingangs- und Ausgangskanal.  Mit diesem Paar k√∂nnen Sie identifizieren, von wem diese Nachricht stammt. <br><img src="https://habrastorage.org/webt/rp/_k/wm/rp_kwmeuccjs2bunsar-hoei9au.jpeg"><br><br><h3>  Gruppen </h3><br>  Eine Gruppe ist eine Sammlung von Kan√§len.  Wenn wir eine Nachricht an eine Gruppe senden, wird diese automatisch an alle Kan√§le dieser Gruppe gesendet.  Dies ist praktisch, da niemand gerne f√ºr Schleifen schreibt.  Au√üerdem erfolgt die Implementierung von Gruppen normalerweise mithilfe der nativen Funktionen der Kanalebene. Dies ist also schneller als nur das Senden von Nachrichten nacheinander. <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> channels <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> Group <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ws_connect</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(message)</span></span></span><span class="hljs-function">:</span></span> Group (<span class="hljs-string"><span class="hljs-string">'chat'</span></span>).add (message.reply_channel) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ws_disconnect</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(message)</span></span></span><span class="hljs-function">:</span></span> Group (<span class="hljs-string"><span class="hljs-string">'chat'</span></span>).discard(message.reply_channel) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ws_message</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(message)</span></span></span><span class="hljs-function">:</span></span> Group (<span class="hljs-string"><span class="hljs-string">'chat'</span></span>). Send ({ <span class="hljs-string"><span class="hljs-string">'text'</span></span>: message.content [<span class="hljs-string"><span class="hljs-string">'text'</span></span>], })</code> </pre><br>  Auf die gleiche Weise werden auch Gruppen zum Routing hinzugef√ºgt. <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> channels.routing <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> route <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> myapp.consumers <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> * channel_routing = [ route (<span class="hljs-string"><span class="hljs-string">'websocket.connect'</span></span> , ws_connect), route (<span class="hljs-string"><span class="hljs-string">'websocket.disconnect'</span></span> , ws_disconnect), route (<span class="hljs-string"><span class="hljs-string">'websocket.receive'</span></span> , ws_message), ]</code> </pre><br>  Sobald der Kanal zur Gruppe hinzugef√ºgt wurde, geht die Antwort an alle Benutzer, die mit unserer Website verbunden sind, und nicht nur an die Echoantwort an uns. <br><br><h3>  Generische Verbraucher </h3><br>  Wof√ºr ich Django liebe, ist deklarativ.  Ebenso gibt es deklarative Verbraucher. <br><br>  Base Consumer ist ein Basis-Consumer. Er kann nur den Kanal zuordnen, den Sie f√ºr eine Methode definiert haben, und ihn aufrufen. <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> channels.generic <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> BaseConsumer <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MyComsumer</span></span></span><span class="hljs-class"> </span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(BaseConsumer)</span></span></span><span class="hljs-class"> :</span></span> method_mapping = { <span class="hljs-string"><span class="hljs-string">'channel.name.here'</span></span>: <span class="hljs-string"><span class="hljs-string">'method_name'</span></span>, } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">method_name</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, message, **kwargs)</span></span></span><span class="hljs-function"> :</span></span> <span class="hljs-keyword"><span class="hljs-keyword">pass</span></span></code> </pre><br>  Es gibt eine gro√üe Anzahl vordefinierter Konsumenten mit absichtlich erweitertem Verhalten, z. B. WebSocket Consumer, das vorab festlegt, ob WebSocket Connect, WebSocket Receive und WebSocket Disconnect verarbeitet werden.  Sie k√∂nnen sofort angeben, in welchen Gruppen ein Antwortkanal hinzugef√ºgt werden soll. Sobald Sie self.send verwenden, wird er verstehen, ob dies an eine Gruppe oder an einen Benutzer gesendet werden soll. <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> channels.generic <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> WebsocketConsumer <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MyConsumer</span></span></span><span class="hljs-class"> </span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(WebsocketConsumer)</span></span></span><span class="hljs-class"> :</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">connection_groups</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function"> :</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> [<span class="hljs-string"><span class="hljs-string">'chat'</span></span>] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">connect</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, message)</span></span></span><span class="hljs-function"> :</span></span> <span class="hljs-keyword"><span class="hljs-keyword">pass</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">receive</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, text=None, bytes=None)</span></span></span><span class="hljs-function"> :</span></span> self.send (text=text, bytes=bytes)</code> </pre><br>  Es gibt auch eine WebSocket-Consumer-Option mit JSON, dh kein Text, keine Bytes, aber bereits analysiertes JSON wird empfangen, was praktisch ist. <br><br>  Beim Routing wird es auf die gleiche Weise √ºber route_class hinzugef√ºgt.  Myapp wird in route_class √ºbernommen, das vom Verbraucher bestimmt wird, alle Kan√§le werden von dort √ºbernommen und alle in myapp angegebenen Kan√§le werden weitergeleitet.  Schreiben Sie weniger auf diese Weise. <br><br><h2>  Routing </h2><br>  Lassen Sie uns im Detail √ºber das Routing und dessen M√∂glichkeiten sprechen. <br><br>  Erstens sind dies Filter. <br><br><pre> <code class="python hljs">// app.js S = new WebSocket (<span class="hljs-string"><span class="hljs-string">'ws://localhost:8000/chat/'</span></span>) <span class="hljs-comment"><span class="hljs-comment"># routing.py route('websocket.connect', ws_connect, path=r'^/chat/$')</span></span></code> </pre><br>  Dies kann der Pfad sein, der vom URI der Web-Socket-Verbindung oder der http-Anforderungsmethode zu uns gekommen ist.  Dies kann ein beliebiges Nachrichtenfeld aus dem Kanal sein, z. B. f√ºr E-Mails: Text, Text, Durchschlag, was auch immer.  Die Anzahl der Schl√ºsselwortargumente f√ºr die Route ist beliebig. <br><br>  Mit Routing k√∂nnen Sie verschachtelte Routen erstellen.  Wenn mehrere Verbraucher durch einige gemeinsame Merkmale bestimmt werden, ist es zweckm√§√üig, sie zu gruppieren und alle gleichzeitig zur Route hinzuzuf√ºgen. <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> channels <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> route, include blog_routes = [ route ( <span class="hljs-string"><span class="hljs-string">'websocket.connect'</span></span>, blog, path = <span class="hljs-string"><span class="hljs-string">r'^/stream/'</span></span>) , ] routing = [ include (blog_routes, path= <span class="hljs-string"><span class="hljs-string">r'^/blog'</span></span> ), ]</code> </pre><br><h2>  Multiplexing </h2><br>  Wenn wir mehrere Web-Sockets √∂ffnen, hat jeder einen anderen URI und wir k√∂nnen mehrere Handler daran h√§ngen.  Aber um ehrlich zu sein, sieht es nicht nach einem technischen Ansatz aus, mehrere Verbindungen zu √∂ffnen, um im Backend etwas Sch√∂nes zu tun. <br><br>  Daher ist es m√∂glich, mehrere Handler an einem Web-Socket aufzurufen.  Wir definieren einen solchen WebsocketDemultiplexer, der nach dem Konzept des Streams innerhalb eines einzelnen Web-Sockets arbeitet.  √úber diesen Stream wird Ihre Nachricht auf einen anderen Kanal umgeleitet. <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> channels <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> WebsocketDemultiplexer <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Demultiplexer</span></span></span><span class="hljs-class"> </span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(WebsocketDemultiplexer)</span></span></span><span class="hljs-class"> :</span></span> mapping = { <span class="hljs-string"><span class="hljs-string">'intval'</span></span>: <span class="hljs-string"><span class="hljs-string">'binding.intval'</span></span>, }</code> </pre><br>  Beim Routing wird der Multiplexer auf dieselbe Weise hinzugef√ºgt wie bei jeder anderen deklarativen Consumer-Routenklasse. <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> channels <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> route_class, route <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> .consumers <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> Demultiplexer, ws_message channel_routing = [ route_class (Demultiplexer, path=<span class="hljs-string"><span class="hljs-string">'^/binding/'</span></span>) , route (<span class="hljs-string"><span class="hljs-string">'binding.intval'</span></span>, ws_message ) , ]</code> </pre><br>  Das Stream-Argument wird der Nachricht hinzugef√ºgt, damit der Multiplexer herausfinden kann, wo die angegebene Nachricht abgelegt werden soll.  Das Payload-Argument enth√§lt alles, was in den Kanal gelangt, nachdem der Multiplexer ihn verarbeitet hat. <br><br>  Es ist sehr wichtig zu beachten, dass in der Kanalebene die Nachricht <strong>zweimal angezeigt wird</strong> : vor dem Multiplexer und nach dem Multiplexer.  Sobald Sie den Multiplexer verwenden, f√ºgen Sie Ihren Anforderungen automatisch eine Latenz hinzu. <br><br><pre> <code class="python hljs">{ <span class="hljs-string"><span class="hljs-string">"stream"</span></span> : <span class="hljs-string"><span class="hljs-string">"intval"</span></span>, <span class="hljs-string"><span class="hljs-string">"payload"</span></span> : { ‚Ä¶ } }</code> </pre><br><h2>  Sitzungen </h2><br>  Jeder Kanal hat seine eigenen Sitzungen.  Dies ist beispielsweise sehr praktisch, um den Status zwischen Aufrufen von Handlern zu speichern.  Sie k√∂nnen sie nach Antwortkanal gruppieren, da dies eine Kennung ist, die dem Benutzer geh√∂rt.  Die Sitzung wird in derselben Engine wie die regul√§re http-Sitzung gespeichert.  Signierte Cookies werden aus offensichtlichen Gr√ºnden nicht unterst√ºtzt, sie befinden sich einfach nicht im Web-Socket. <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> channels.sessions <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> channel_session @channel_session <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ws_connect</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(message)</span></span></span><span class="hljs-function"> :</span></span> room=message.content [<span class="hljs-string"><span class="hljs-string">'path'</span></span>] message.channel_session [<span class="hljs-string"><span class="hljs-string">'room'</span></span>] = room Croup (<span class="hljs-string"><span class="hljs-string">'chat-%s'</span></span> % room).add ( message.reply_channel )</code> </pre><br>  W√§hrend der Verbindung k√∂nnen Sie eine http-Sitzung abrufen und in Ihrem Consumer verwenden.  Im Rahmen des Verhandlungsprozesses beim Einrichten einer Web-Socket-Verbindung werden Cookies an den Benutzer gesendet.  Dementsprechend k√∂nnen Sie eine Benutzersitzung abrufen und das Benutzerobjekt abrufen, das Sie zuvor in Django verwendet haben, als w√ºrden Sie mit der Ansicht arbeiten. <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> channels.sessions <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> http_session_user @http_session_user <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ws_connect</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(message)</span></span></span><span class="hljs-function"> :</span></span> message.http_session [<span class="hljs-string"><span class="hljs-string">'room'</span></span>] = room <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> message.user.username : ‚Ä¶</code> </pre><br><h2>  Nachrichtenreihenfolge </h2><br>  Kan√§le k√∂nnen ein sehr wichtiges Problem l√∂sen.  Wenn wir eine Verbindung zu einem Web-Socket herstellen und sofort senden, f√ºhrt dies dazu, dass die beiden Ereignisse - WebSocket Connect und WebSocket Receive - zeitlich sehr nahe beieinander liegen.  Es ist sehr wahrscheinlich, dass Verbraucher f√ºr diese Web-Sockets parallel ausgef√ºhrt werden.  Das Debuggen wird viel Spa√ü machen. <br><br>  Mit Django-Kan√§len k√∂nnen Sie zwei Arten von Sperren eingeben: <br><br><ol><li>  <strong>Einfache</strong> <strong>Verriegelung</strong> .  Mithilfe des Sitzungsmechanismus garantieren wir, dass wir keine Nachricht auf Web-Sockets verarbeiten, bis der Verbraucher zum Empfang einer Nachricht verarbeitet wird.  Nachdem die Verbindung hergestellt wurde, ist die Reihenfolge beliebig, eine parallele Ausf√ºhrung ist m√∂glich. </li><li>  <strong>Hard</strong> <strong>Lock</strong> - Es wird jeweils nur ein Verbraucher eines bestimmten Benutzers ausgef√ºhrt.  Dies ist ein Overhead f√ºr die Synchronisation, da eine langsame Sitzungs-Engine verwendet wird.  Trotzdem gibt es eine solche M√∂glichkeit. </li></ol><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> channels.generic <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> WebsocketConsumer <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MyConsumer</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(WebsocketConsumer)</span></span></span><span class="hljs-class"> :</span></span> http_user = <span class="hljs-keyword"><span class="hljs-keyword">True</span></span> slight_ordering = <span class="hljs-keyword"><span class="hljs-keyword">True</span></span> strict_ordering = <span class="hljs-keyword"><span class="hljs-keyword">False</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">connection_groups</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, **kwargs)</span></span></span><span class="hljs-function"> :</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> [<span class="hljs-string"><span class="hljs-string">'chat'</span></span>]</code> </pre><br>  Um dies zu schreiben, gibt es dieselben Dekorateure, die wir zuvor in http session, channel session gesehen haben.  Im deklarativen Consumer k√∂nnen Sie einfach Attribute schreiben. Sobald Sie diese schreiben, gilt dies automatisch f√ºr alle Methoden dieses Consumer. <br><br><h2>  Datenbindung </h2><br>  Zu einer Zeit wurde Meteor ber√ºhmt f√ºr Datenbindung. <br><br>  Wir √∂ffnen zwei Browser, gehen zur gleichen Seite und klicken in einem von ihnen auf die Bildlaufleiste.  Gleichzeitig √§ndert die Bildlaufleiste im zweiten Browser auf dieser Seite ihren Wert.  Das ist cool. <br><br><pre> <code class="python hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">IntegerValueBinding</span></span></span><span class="hljs-class"> </span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(WebsocketBinding)</span></span></span><span class="hljs-class"> :</span></span> model = IntegerValue stream = intval<span class="hljs-string"><span class="hljs-string">' fields= ['</span></span>name<span class="hljs-string"><span class="hljs-string">', '</span></span>value<span class="hljs-string"><span class="hljs-string">'] def group_names (self, instance, action ) : return ['</span></span>intval-updates<span class="hljs-string"><span class="hljs-string">'] def has_permission (self, user, action, pk) : return True</span></span></code> </pre><br>  Django macht jetzt genau das Gleiche. <br><br>  Dies wird mithilfe von Hooks implementiert, die von <strong>Django Signals</strong> bereitgestellt werden.  Wenn f√ºr das Modell eine Bindung definiert ist, werden alle Verbindungen, die sich in der Gruppe f√ºr diese Instanz des Modells befinden, √ºber jedes Ereignis benachrichtigt.  Wir haben ein Modell erstellt, das Modell ge√§ndert, es gel√∂scht - all dies ist eine Warnung.  Die Benachrichtigung erfolgt in den angegebenen Feldern: Der Wert dieses Feldes hat sich ge√§ndert - es wird eine Nutzlast gebildet, die √ºber den Web-Socket gesendet wird.  Das ist bequem. <br><br>  Es ist wichtig zu verstehen, dass, wenn wir in unserem Beispiel st√§ndig auf die Bildlaufleiste klicken, st√§ndig Nachrichten gesendet werden und das Modell gespeichert wird.  Dies funktioniert bis zu einer bestimmten Last, dann liegt alles an der Basis an. <br><br><h2>  Redis Schicht </h2><br>  Lassen Sie uns etwas mehr dar√ºber sprechen, wie die beliebteste Channel-Ebene f√ºr die Produktion angeordnet ist - Redis. <br><br>  Es ist gut arrangiert: <br><br><ul><li>  arbeitet mit synchronen Verbindungen auf der Ebene der Arbeiter; </li><li>  sehr freundlich zu Twisted, verlangsamt sich nicht, wo es besonders notwendig ist, dh auf Ihrem Front-End-Server; </li><li>  MSGPACK wird zum Serialisieren von Nachrichten in Redis verwendet, wodurch der Platzbedarf f√ºr jede Nachricht verringert wird. </li><li>  Sie k√∂nnen die Last auf mehrere Redis-Instanzen verteilen. Sie wird automatisch mithilfe des konsistenten Hash-Algorithmus gemischt.  Somit verschwindet ein einzelner Fehlerpunkt. </li></ul><br>  Ein Kanal ist nur eine ID-Liste von Redis.  By id ist der Wert einer bestimmten Nachricht.  Dies geschieht, damit Sie die Lebensdauer jeder Nachricht und jedes Kanals separat steuern k√∂nnen.  Dies ist im Prinzip logisch. <br><br><pre> <code class="python hljs">&gt;&gt; SET <span class="hljs-string"><span class="hljs-string">"b6dc0dfce"</span></span> <span class="hljs-string"><span class="hljs-string">" \x81\xa4text\xachello"</span></span> &gt;&gt; RPUSH <span class="hljs-string"><span class="hljs-string">"websocket.send!sGOpfny"</span></span> <span class="hljs-string"><span class="hljs-string">"b6dc0dfce"</span></span> &gt;&gt; EXPIRE <span class="hljs-string"><span class="hljs-string">"b6dc0dfce"</span></span> <span class="hljs-string"><span class="hljs-string">"60"</span></span> &gt;&gt; EXPIRE <span class="hljs-string"><span class="hljs-string">"websocket.send!sGOpfny"</span></span> <span class="hljs-string"><span class="hljs-string">"61"</span></span></code> </pre><br>  Gruppen werden durch sortierte Mengen implementiert.  Die Verteilung an Gruppen erfolgt innerhalb des Lua-Skripts - dies ist sehr schnell. <br><br><pre> <code class="python hljs">&gt;&gt; type group:chat zset &gt;&gt; ZRANGE group:chat <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> WITHSCORES <span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-string"><span class="hljs-string">"websocket.send!sGOpfny"</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span>) <span class="hljs-string"><span class="hljs-string">"1476199781.8159261"</span></span></code> </pre><br><h2>  Probleme </h2><br>  Mal sehen, welche Probleme dieser Ansatz hat. <br><br><h3>  R√ºckruf H√∂lle </h3><br>  Das erste Problem ist die neu erfundene R√ºckrufh√∂lle.  Es ist sehr wichtig zu verstehen, dass die meisten Probleme mit den Kan√§len, auf die Sie sto√üen werden, stilvoll sind: Dem Verbraucher kamen Argumente, die er nicht erwartet hatte.  Woher sie kamen, wer sie auf Redis setzte - all dies ist eine zweifelhafte Ermittlungsaufgabe.  Debuggen verteilter Systeme im Allgemeinen f√ºr Willensstarke.  AsyncIO l√∂st dieses Problem. <br><br><h3>  Sellerie </h3><br>  Im Internet schreiben sie, dass Django Channels ein Ersatz f√ºr Sellerie ist. <br><img src="https://habrastorage.org/webt/x9/be/j8/x9bej8oul6vevk2r8e12q9-i_ia.jpeg"><br>  Ich habe schlechte Nachrichten f√ºr dich - nein, das ist es nicht. <br><br>  In Kan√§len: <br><br><ul><li>  Kein erneuter Versuch, Sie k√∂nnen die Ausf√ºhrung eines Handlers nicht verz√∂gern. <br></li><li>  Keine Leinwand - nur ein R√ºckruf.  Sellerie bietet auch Gruppen, Ketten, meinen Lieblingsakkord, der nach paralleler Ausf√ºhrung von Gruppen einen weiteren R√ºckruf mit Synchronisation verursacht.  All dies ist nicht in Kan√§len; </li><li>  Es gibt keine Einstellung der Ankunftszeit von Nachrichten, einige Systeme ohne diese sind einfach nicht zu entwerfen. </li></ul><br><blockquote>  Ich sehe die Zukunft als offizielle Unterst√ºtzung f√ºr die gemeinsame Nutzung von Kan√§len und Sellerie mit minimalen Kosten und minimalem Aufwand.  Aber Django Channels ist kein Ersatz f√ºr Sellerie. <br></blockquote><br><h2>  Django f√ºr modernes Web </h2><br>  Django Channels ist Django f√ºr das moderne Web.  Dies ist derselbe Django, den wir alle gewohnt sind: synchron, deklarativ, mit vielen Batterien.  Django Channels ist nur plus eine Batterie.  Sie m√ºssen immer verstehen, wo Sie es verwenden und ob es sich lohnt, es zu tun.  Wenn Django im Projekt nicht ben√∂tigt wird, werden dort auch keine Kan√§le ben√∂tigt.  Sie sind nur in solchen Projekten n√ºtzlich, in denen Django gerechtfertigt ist. <br><br><blockquote>  <strong><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Moskau Python Conf ++</a></strong> <br><br>  Eine professionelle Konferenz f√ºr Python-Entwickler erreicht ein neues Niveau - <strong>am 22. und 23. Oktober</strong> 2018 werden wir die 600 besten Python-Programmierer in Russland zusammenbringen, die interessantesten Berichte pr√§sentieren und nat√ºrlich mit Unterst√ºtzung des Ontiko-Teams eine Umgebung f√ºr die Vernetzung in den besten Traditionen der Moskauer Python-Community schaffen. <br><br>  Wir laden Experten ein, einen Bericht zu erstellen.  Das Programmkomitee arbeitet bereits und nimmt <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Bewerbungen</a> bis zum 7. September entgegen. <br><br>  F√ºr die Teilnehmer wird ein Online-Brainstorming-Programm durchgef√ºhrt.  Sie k√∂nnen diesem <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Dokument</a> oder den Rednern, deren Reden f√ºr Sie von Interesse sind, sofort fehlende Themen hinzuf√ºgen.  Das Dokument wird in der Tat aktualisiert, sobald Sie die Programmbildung verfolgen k√∂nnen. <br></blockquote></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de418445/">https://habr.com/ru/post/de418445/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de418433/index.html">4. August Peter. Die erste Fahrradsuche f√ºr Programmierer</a></li>
<li><a href="../de418437/index.html">Oc Team zur Rettung</a></li>
<li><a href="../de418439/index.html">Progressive Webanwendungsgrundlagen</a></li>
<li><a href="../de418441/index.html">Grundlagen der Windows-Berechtigungseskalation</a></li>
<li><a href="../de418443/index.html">GObject: Kapselung, Instanziierung, Selbstbeobachtung</a></li>
<li><a href="../de418447/index.html">Warum Moscow Python Conf jetzt ++ ist</a></li>
<li><a href="../de418449/index.html">Bin√§rmodule f√ºr Python</a></li>
<li><a href="../de418451/index.html">3D-Druckunterricht. Effektive Unterst√ºtzung und √Ñnderung der Schichth√∂he in der Praxis von 3Dtool</a></li>
<li><a href="../de418453/index.html">GRAVITY-Beobachtungen best√§tigen die allgemeine Relativit√§tstheorie weiter</a></li>
<li><a href="../de418455/index.html">Offenes Webinar ‚ÄûSpezialist am Ruder: Erste Erfahrungen und Fehler‚Äú</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>