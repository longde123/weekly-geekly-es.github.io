<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë¶üèæ ü§∏üèø üéÆ Como o BGP funciona üçØ üßùüèø üçπ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hoje analisamos o protocolo BGP. N√£o falaremos por muito tempo por que √© e por que √© usado como o √∫nico protocolo. Muita informa√ß√£o est√° sobre este as...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Como o BGP funciona</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/450814/">  Hoje analisamos o protocolo BGP.  N√£o falaremos por muito tempo por que √© e por que √© usado como o √∫nico protocolo.  Muita informa√ß√£o est√° sobre este assunto, por exemplo <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">aqui</a> . <br><br>  Ent√£o, o que √© BGP?  O BGP √© um protocolo de roteamento din√¢mico que √© o √∫nico protocolo EGP (External Gateway Protocol).  Este protocolo √© usado para criar roteamento na Internet.  Considere como a vizinhan√ßa entre dois roteadores BGP √© constru√≠da. <br><br> <a href=""><img src="https://habrastorage.org/getpro/habr/post_images/3fa/da6/dd3/3fada6dd3c41923367af475da9b0ae10.jpg" alt="Minha imagem"></a> <br>  Considere a vizinhan√ßa entre o Roteador1 e o Roteador3.  Vamos configur√°-los usando os seguintes comandos: <a name="habracut"></a><br><pre><code class="plaintext hljs">router bgp 10 network 192.168.12.0 network 192.168.13.0 neighbor 192.168.13.3 remote-as 10 router bgp 10 network 192.168.13.0 network 192.168.24.0 neighbor 192.168.13.1 remote-as 10</code> </pre> <br>  A vizinhan√ßa em um sistema aut√¥nomo √© AS 10. Depois de inserir dados em um roteador, por exemplo, no roteador1, este roteador tenta estabelecer um relacionamento de vizinhan√ßa com o roteador3.  O estado inicial quando nada acontece √© chamado de <b>inativo</b> .  Assim que o bgp estiver configurado no roteador1, ele come√ßar√° a escutar a porta TCP 179 - entrar√° no estado <b>Connect</b> e, quando tentar abrir uma sess√£o com o roteador3, entrar√° no estado <b>ativo</b> . <br><br>  Depois que a sess√£o √© estabelecida entre o Roteador1 e o Roteador3, ocorre uma troca de mensagens aberta.  Quando esta mensagem √© enviada pelo Roteador1, esse estado ser√° chamado de <b>Aberto Enviado</b> .  E quando receber uma mensagem de abertura do roteador3, entrar√° no estado de <b>confirma√ß√£o de abertura</b> .  Considere a publica√ß√£o aberta com mais detalhes: <br><br> <a href=""><img src="https://habrastorage.org/getpro/habr/post_images/d9d/231/607/d9d2316070de22049a24da6d86cecb2b.jpg" alt="Minha imagem"></a> <br>  Esta mensagem transmite informa√ß√µes sobre o protocolo BGP que o roteador usa.  Ao trocar mensagens abertas, o Roteador1 e o Roteador3 comunicam informa√ß√µes sobre suas configura√ß√µes entre si.  Os seguintes par√¢metros s√£o passados: <br><blockquote><ul><li>  <b>Vers√£o</b> : inclui a vers√£o BGP que o roteador est√° usando.  A vers√£o atual do BGP √© a vers√£o 4, descrita na RFC 4271. Dois roteadores BGP tentar√£o negociar uma vers√£o compat√≠vel, quando houver uma incompatibilidade, n√£o haver√° sess√£o BGP. </li><li>  <b>Meu AS</b> : inclui o n√∫mero AS do roteador BGP, os roteadores ter√£o que concordar com o (s) n√∫mero (s) AS e tamb√©m define se eles estar√£o executando o iBGP ou o eBGP. </li><li>  <b>Tempo de espera</b> : se o BGP n√£o receber nenhuma mensagem de keepalive ou atualiza√ß√£o do outro lado durante o tempo de espera, ele declarar√° o outro lado 'morto' e interromper√° a sess√£o do BGP.  Por padr√£o, o tempo de espera √© definido como 180 segundos nos roteadores Cisco IOS, a mensagem de manuten√ß√£o da atividade √© enviada a cada 60 segundos.  Ambos os roteadores precisam concordar com o tempo de espera ou n√£o haver√° uma sess√£o BGP. </li><li>  <b>Identificador BGP</b> : este √© o ID do roteador BGP local, eleito exatamente como o OSPF: <br><ul><li>  Use o ID do roteador que foi configurado manualmente com o comando bgp router-id. </li><li>  Use o endere√ßo IP mais alto em uma interface de loopback. </li><li>  Use o endere√ßo IP mais alto em uma interface f√≠sica. </li></ul></li><li>  <b>Par√¢metros opcionais</b> : aqui voc√™ encontrar√° alguns recursos opcionais do roteador BGP.  Este campo foi adicionado para que novos recursos pudessem ser adicionados ao BGP sem a necessidade de criar uma nova vers√£o. As coisas que voc√™ pode encontrar aqui s√£o: <br><br><ul><li>  suporte para MP-BGP (Multi Protocol BGP). </li><li>  suporte para atualiza√ß√£o de rota. </li><li>  suporte para n√∫meros AS de 4 octetos. </li></ul></li></ul></blockquote>  Para estabelecer um bairro, as seguintes condi√ß√µes devem ser atendidas: <br><br><ul><li>  N√∫mero da vers√£o  Vers√£o atual 4. </li><li>  O n√∫mero do AS deve corresponder ao n√∫mero configurado como <b>vizinho 192.168.13.3 remoto como 10</b> . </li><li>  O ID do roteador deve ser diferente do vizinho. </li></ul><br>  Se algum dos par√¢metros n√£o atender a essas condi√ß√µes, o roteador enviar√° uma mensagem de <b>notifica√ß√£o</b> onde indica um erro.  Depois de enviar e receber mensagens abertas, o relacionamento de vizinhan√ßa entra no estado <b>ESTABELECIDO</b> .  Depois disso, os roteadores podem trocar informa√ß√µes sobre rotas e fazer isso usando as mensagens de <b>atualiza√ß√£o</b> .  Aqui est√° uma mensagem de atualiza√ß√£o que envia o roteador1 para o roteador3: <br><br> <a href=""><img src="https://habrastorage.org/getpro/habr/post_images/853/f42/1f0/853f421f0a69f407c5ae4eae3423240c.jpg" alt="Minha imagem"></a> <br><br>  Aqui, indique as redes relatadas pelos atributos Router1 e Path, que s√£o an√°logas √†s m√©tricas.  Falaremos sobre os atributos do caminho em mais detalhes.  Al√©m disso, as mensagens keepalive s√£o transmitidas dentro da sess√£o TCP.  Eles s√£o transmitidos, por padr√£o, a cada 60 segundos.  Este √© um temporizador Keepalive.  Se a mensagem Keepalive n√£o for recebida durante o Hold Timer, isso significar√° perda de comunica√ß√£o com o vizinho.  Por padr√£o, √© igual a - 180 segundos. <br><br>  Prato √∫til: <br><br> <a href=""><img src="https://habrastorage.org/getpro/habr/post_images/853/f42/1f0/853f421f0a69f407c5ae4eae3423240c.jpg" alt="Minha imagem"></a> <br><br>  Parece ter descoberto como os roteadores transmitem informa√ß√µes um para o outro, agora vamos tentar descobrir a l√≥gica do protocolo BGP. <br><br>  Para anunciar uma rota para a tabela BGP, como nos protocolos IGP, o comando network √© usado, mas a l√≥gica da opera√ß√£o √© diferente.  Se no IGP, depois de especificar uma rota no comando de rede, o IGP examina quais interfaces pertencem a esta sub-rede e as inclui em sua tabela, o comando de rede no BGP procura na tabela de roteamento e procura uma correspond√™ncia <b>exata</b> com a rota no comando de rede.  Se estes forem encontrados, essas rotas cair√£o na tabela BGP. <br><blockquote>  Procure uma rota na tabela de roteamento IP atual do roteador que corresponda exatamente aos par√¢metros do comando network;  se a rota IP existir, coloque o NLRI equivalente na tabela BGP local. </blockquote>  Agora, aumentaremos o BGP para todos os demais e veremos como a rota √© selecionada dentro de um AS.  Depois que o roteador BGP recebe rotas do vizinho, a sele√ß√£o da rota ideal come√ßa.  Aqui voc√™ precisa entender que tipo de vizinhos pode ser - interno e externo.  O roteador de configura√ß√£o entende se o vizinho configurado √© interno ou externo?  Se em uma equipe: <br><br><pre> <code class="plaintext hljs">neighbor 192.168.13.3 remote-as 10</code> </pre> <br>  como o par√¢metro remote-as, o AS √© especificado, configurado no pr√≥prio roteador no comando router bgp 10. As rotas que v√™m do AS interno s√£o consideradas internas e as rotas do AS externo s√£o consideradas externas.  E com rela√ß√£o a cada uma, uma l√≥gica diferente de recebimento e envio de obras.  Considere a seguinte topologia: <br><br> <a href=""><img src="https://habrastorage.org/getpro/habr/post_images/cea/5f8/2b0/cea5f82b050662b2632cab01f3de8e24.jpg" alt="Minha imagem"></a> <br><br>  Cada roteador possui uma interface de loopback configurada com ip: xxxx 255.255.255.0 - em que x √© o n√∫mero do roteador.  No roteador9, temos uma interface de loopback com o endere√ßo - 9.9.9.9 255.255.255.0.  O anunciaremos no BGP e veremos como √© distribu√≠do.  Essa rota ser√° transmitida ao roteador8 e ao roteador12.  Com o Router8, essa rota ir√° para o Router6, mas no Router5 n√£o estar√° na tabela de roteamento.  Al√©m disso, no roteador12, essa rota entra na tabela, mas no roteador11 tamb√©m n√£o ser√°.  Vamos tentar descobrir.  Considere quais dados e par√¢metros est√£o sendo transmitidos pelo roteador9 para seus vizinhos, relatando esta rota.  O pacote abaixo ser√° enviado do roteador9 para o roteador8. <br><br> <a href=""><img src="https://habrastorage.org/getpro/habr/post_images/5e7/80b/ca0/5e780bca084e8f42dab14d03f62723b6.jpg" alt="Minha imagem"></a> <br>  As informa√ß√µes da rota consistem em atributos do caminho. <br><br>  Os atributos do caminho s√£o divididos em 4 categorias: <br><br><ol><li>  <b>Obrigat√≥rio conhecido</b> - Todos os roteadores BGP devem reconhecer esses atributos.  Deve estar presente em todas as atualiza√ß√µes. </li><li>  <b>Bem conhecido discricion√°rio</b> - Todos os roteadores BGP devem reconhecer esses atributos.  Eles podem estar presentes nas atualiza√ß√µes, mas sua presen√ßa n√£o √© necess√°ria. </li><li>  <b>Transitivo opcional</b> - pode n√£o ser reconhecido por todas as implementa√ß√µes de BGP.  Se o roteador n√£o reconhecer o atributo, ele marcar√° a atualiza√ß√£o como parcial e a enviar√° ainda mais aos vizinhos, preservando o atributo n√£o reconhecido. </li><li>  <b>N√£o transitivo opcional</b> - pode n√£o ser reconhecido por todas as implementa√ß√µes de BGP.  Se o roteador n√£o reconhecer o atributo, ele ser√° ignorado e descartado durante a transmiss√£o aos vizinhos. </li></ol><br>  Exemplos de atributos BGP: <br><br><ul><li>  <b>Obrigat√≥rio conhecido</b> : <br><ul><li>  Caminho do sistema aut√¥nomo </li><li>  Pr√≥ximo salto </li><li>  Origem </li></ul><br></li><li>  <b>Bem conhecido discricion√°rio</b> : <br><ul><li>  Prefer√™ncia local </li><li>  Agregado at√¥mico </li></ul></li><li>  <b>Transitivo opcional</b> : <br><ul><li>  Agregador </li><li>  Comunidades </li></ul></li><li>  <b>N√£o transitivo opcional</b> : <br><ul><li>  Discriminador de m√∫ltiplas sa√≠das (MED) </li><li>  ID do originador </li><li>  Lista de clusters </li></ul></li></ul><br>  Nesse caso, estaremos interessados ‚Äã‚Äãem Origin, Next-hop, AS Path.  Como a rota passa entre o Roteador8 e o Roteador9, ou seja, dentro do mesmo AS, ela √© considerada interna e prestaremos aten√ß√£o ao Origin. <br><br>  Atributo de origem - indica como a rota foi recebida na atualiza√ß√£o.  Poss√≠veis valores de atributo: <br><br><ul><li>  0 - IGP: NLRI obtido dentro do sistema aut√¥nomo original; </li><li>  1 - EGP: NLRI aprendido pelo Exterior Gateway Protocol (EGP).  Predecessor BGP, n√£o usado </li><li>  2 - Incompleto: a NLRI foi aprendida de outra maneira </li></ul><br>  No nosso caso, como pode ser visto no pacote, √© 0. Quando essa rota √© transmitida ao roteador12, esse c√≥digo ter√° o c√≥digo - 1. <br><br>  Pr√≥ximo, salto seguinte.  Atributo do pr√≥ximo salto <br><br><ul><li>  Este √© o endere√ßo IP do roteador eBGP atrav√©s do qual o caminho para a rede de destino percorre. </li><li>  O atributo muda quando o prefixo √© passado para outro AS. </li></ul><br>  No caso do iBGP, ou seja, dentro de um AS, o salto seguinte ser√° indicado aquele que aprendeu ou contou sobre essa rota.  No nosso caso, ser√° 192.168.89.9.  Mas quando ele transferir essa rota do roteador8 para o roteador6, o roteador8 ir√° alter√°-lo e substitu√≠-lo pelo seu.  O pr√≥ximo salto ser√° - 192.168.68.8.  Isso nos leva a duas regras: <br><br><ol><li>  Se o roteador passa a rota para seu vizinho interno, ele n√£o altera o par√¢metro Next-hop. </li><li>  Se o roteador envia a rota para seu vizinho externo, ele altera o salto seguinte para o ip da interface da qual esse roteador envia. </li></ol><br>  Isso nos leva a entender o primeiro problema - Por que n√£o haver√° rota na tabela de roteamento no Router5 e Router11.  Vamos considerar em mais detalhes.  Portanto, o Router6 recebeu as informa√ß√µes de rota 9.9.9.0/24 e as adicionou √† tabela de roteamento com seguran√ßa: <br><br><pre> <code class="plaintext hljs">Router6#show ip route bgp Codes: L - local, C - connected, S - static, R - RIP, M - mobile, B - BGP D - EIGRP, EX - EIGRP external, O - OSPF, IA - OSPF inter area N1 - OSPF NSSA external type 1, N2 - OSPF NSSA external type 2 E1 - OSPF external type 1, E2 - OSPF external type 2 i - IS-IS, su - IS-IS summary, L1 - IS-IS level-1, L2 - IS-IS level-2 ia - IS-IS inter area, * - candidate default, U - per-user static route o - ODR, P - periodic downloaded static route, H - NHRP, l - LISP a - application route + - replicated route, % - next hop override, p - overrides from PfR Gateway of last resort is not set 9.0.0.0/24 is subnetted, 1 subnets B 9.9.9.0 [20/0] via 192.168.68.8, 00:38:25</code> </pre> <br>  Agora o Router6 passou a rota do Router5 e n√£o alterou a primeira regra do Pr√≥ximo salto.  Ou seja, o roteador5 deve adicionar <b>9.9.9.0 [20/0] via 192.168.68.8</b> , mas n√£o possui uma rota para 192.168.68.8 e, portanto, essa rota n√£o ser√° adicionada, embora as informa√ß√µes sobre essa rota sejam armazenadas na tabela BGP: <br><br><pre> <code class="plaintext hljs">&lt;b&gt;Router5#show ip bgp BGP table version is 1, local router ID is 5.5.5.5 Status codes: s suppressed, d damped, h history, * valid, &gt; best, i - internal, r RIB-failure, S Stale, m multipath, b backup-path, f RT-Filter, x best-external, a additional-path, c RIB-compressed, Origin codes: i - IGP, e - EGP, ? - incomplete RPKI validation codes: V valid, I invalid, N Not found Network Next Hop Metric LocPrf Weight Path * i 9.9.9.0/24 192.168.68.8 0 100 0 45 i&lt;/b&gt;</code> </pre> <br>  A mesma situa√ß√£o ocorrer√° entre o roteador11-roteador12.  Para evitar tal situa√ß√£o, √© necess√°rio configurar para que o Roteador6 ou o Roteador12, passando a rota para seus vizinhos internos, substituam seu endere√ßo IP como Pr√≥ximo salto.  Isso √© feito usando o comando: <br><br><pre> <code class="plaintext hljs">neighbor 192.168.56.5 next-hop-self</code> </pre> <br>  Ap√≥s esse comando, o roteador6 enviar√° uma mensagem de atualiza√ß√£o, onde para as rotas como salto seguinte ser√° indicado o ip da interface Gi0 / 0 do roteador6 - 192.168.56.6, ap√≥s o qual essa rota j√° estar√° na tabela de roteamento. <br><br>  Vamos em frente e ver se esta rota aparece no roteador7 e no roteador10.  Ele n√£o aparecer√° na tabela de roteamento e podemos pensar que o problema √© como o primeiro com o par√¢metro Next-hop, mas se observarmos a sa√≠da do comando show ip bgp, veremos que a rota n√£o foi recebida, mesmo com o Next-hop errado, o que significa que a rota nem foi transmitida.  E isso nos levar√° √† exist√™ncia de outra regra: <br><blockquote>  As rotas recebidas de vizinhos internos n√£o s√£o transferidas para outros vizinhos internos. </blockquote>  Como o Router5 recebeu a rota do Router6, ele n√£o ser√° transmitido ao seu outro vizinho interno.  Para que a transfer√™ncia ocorra, voc√™ deve configurar a fun√ß√£o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Route Reflector</a> ou configurar as rela√ß√µes de vizinhan√ßa totalmente conectadas (malha completa), ou seja, o roteador5-7 ser√° vizinho de cada um.  Usaremos o refletor de rota neste caso.  No Router5, voc√™ deve usar este comando: <br><br><pre> <code class="plaintext hljs">neighbor 192.168.57.7 route-reflector-client</code> </pre> <br>  O Refletor de Rota altera o comportamento do BGP ao transmitir uma rota para um vizinho interno.  Se o vizinho interno for especificado como <b>cliente-refletor de rota</b> , as rotas internas ser√£o anunciadas para esses clientes. <br><br>  A rota n√£o apareceu no Router7?  N√£o se esque√ßa do Next-hop tamb√©m.  Ap√≥s essas manipula√ß√µes, a rota tamb√©m deve ser feita no roteador7, mas isso n√£o acontece.  Isso nos leva a outra regra: <br><blockquote>  A regra do pr√≥ximo salto funciona apenas para rotas externas.  Para rotas internas, o atributo do pr√≥ximo salto n√£o √© substitu√≠do. </blockquote><br>  E temos uma situa√ß√£o em que voc√™ precisa criar um ambiente usando roteamento est√°tico ou IGP para informar os roteadores sobre todas as rotas dentro do AS.  Registraremos as rotas est√°ticas no Router6 e Router7 e, depois disso, obteremos a rota desejada na tabela do roteador.  No AS 678, agiremos de maneira um pouco diferente - escreveremos as rotas est√°ticas para 192.168.112.0/24 no roteador10 e 192.168.110.0/24 no roteador12.  Em seguida, estabelecemos o relacionamento de vizinhan√ßa entre o roteador10 e o roteador12.  Tamb√©m configuramos o Router12 para enviar o pr√≥ximo salto para o Router10: <br><br><pre> <code class="plaintext hljs">neighbor 192.168.110.10 next-hop-self</code> </pre> <br>  O resultado ser√° que o roteador10 receber√° a rota 9.9.9.0/24, ser√° recebido do roteador7 e do roteador12.  Vamos ver que escolha o Router10 faz: <br><br><pre> <code class="plaintext hljs">Router10#show ip bgp BGP table version is 3, local router ID is 6.6.6.6 Status codes: s suppressed, d damped, h history, * valid, &gt; best, i - internal, r RIB-failure, S Stale, m multipath, b backup-path, f RT-Filter, x best-external, a additional-path, c RIB-compressed, Origin codes: i - IGP, e - EGP, ? - incomplete RPKI validation codes: V valid, I invalid, N Not found Network Next Hop Metric LocPrf Weight Path *&gt;i 9.9.9.0/24 192.168.112.12 0 100 0 45 i 192.168.107.7 0 123 45 i</code> </pre> <br>  Como podemos ver, duas rotas e uma seta (&gt;) significam que a rota atrav√©s de 192.168.112.12 est√° selecionada. <br>  Vamos ver como o processo de sele√ß√£o de rota ocorre: <br><br><ol><li>  Antes de mais nada, ap√≥s o recebimento da rota, a disponibilidade do seu salto seguinte √© verificada.  √â por isso que, quando recebemos uma rota no Roteador5 sem definir o Next-hop-self, essa rota n√£o foi enviada mais para processamento. </li><li>  Em seguida √© o par√¢metro Weight.  Este par√¢metro n√£o √© um atributo de caminho (PA) e n√£o √© transmitido em mensagens BGP.  Ele √© configurado localmente em cada roteador e √© usado apenas para manipular a sele√ß√£o de rota no pr√≥prio roteador.  Considere um exemplo.  √â mostrado acima que o Router10 escolheu a rota para 9.9.9.0/24 via Router12 (192.168.112.12).  Para alterar o par√¢metro Wieght, voc√™ pode usar o mapa de rotas para definir rotas espec√≠ficas ou atribuir peso ao seu vizinho usando o comando: <br><br><pre> <code class="plaintext hljs"> neighbor 192.168.107.7 weight 200</code> </pre> <br>  Agora todas as rotas deste vizinho ter√£o esse peso.  Vamos ver como a escolha da rota muda ap√≥s esta manipula√ß√£o: <br><br><pre> <code class="plaintext hljs">Router10#show bgp *Mar 2 11:58:13.956: %SYS-5-CONFIG_I: Configured from console by console BGP table version is 2, local router ID is 6.6.6.6 Status codes: s suppressed, d damped, h history, * valid, &gt; best, i - internal, r RIB-failure, S Stale, m multipath, b backup-path, f RT-Filter, x best-external, a additional-path, c RIB-compressed, Origin codes: i - IGP, e - EGP, ? - incomplete RPKI validation codes: V valid, I invalid, N Not found Network Next Hop Metric LocPrf Weight Path *&gt; 9.9.9.0/24 192.168.107.7 200 123 45 i * i 192.168.112.12 0 100 0 45 i</code> </pre> <br>  Como voc√™ pode ver, a rota atrav√©s do roteador7 agora est√° selecionada, mas isso n√£o ter√° nenhum efeito nos outros roteadores. </li><li>  Em terceiro lugar, temos - Prefer√™ncia Local.  Este par√¢metro √© um atributo discricion√°rio conhecido, o que significa que sua presen√ßa √© opcional.  Este par√¢metro √© v√°lido apenas dentro de um AS e afeta a escolha do caminho apenas para vizinhos internos.  Por isso, ele √© transmitido apenas nas mensagens de Atualiza√ß√£o destinadas ao vizinho interno.  Em Mensagens de atualiza√ß√£o para vizinhos externos, ele est√° ausente.  Portanto, ele foi designado para o bem conhecido discricion√°rio.  Vamos tentar aplic√°-lo no Router5.  No roteador 5, devemos ter duas rotas para 9.9.9.0/24 - uma atrav√©s do roteador6 e a segunda atrav√©s do roteador7. <br><br>  N√≥s olhamos: <br><br><pre> <code class="plaintext hljs">Router5#show bgp BGP table version is 2, local router ID is 5.5.5.5 Status codes: s suppressed, d damped, h history, * valid, &gt; best, i - internal, r RIB-failure, S Stale, m multipath, b backup-path, f RT-Filter, x best-external, a additional-path, c RIB-compressed, Origin codes: i - IGP, e - EGP, ? - incomplete RPKI validation codes: V valid, I invalid, N Not found Network Next Hop Metric LocPrf Weight Path *&gt;i 9.9.9.0/24 192.168.56.6 0 100 0 45 i</code> </pre> <br>  Mas como voc√™ pode ver uma rota atrav√©s do roteador6.  E onde √© a rota atrav√©s do Router7?  Talvez nem exista no Router7?  N√≥s olhamos: <br><br><pre> <code class="plaintext hljs">Router#show bgp BGP table version is 10, local router ID is 7.7.7.7 Status codes: s suppressed, d damped, h history, * valid, &gt; best, i - internal, r RIB-failure, S Stale, m multipath, b backup-path, f RT-Filter, x best-external, a additional-path, c RIB-compressed, Origin codes: i - IGP, e - EGP, ? - incomplete RPKI validation codes: V valid, I invalid, N Not found Network Next Hop Metric LocPrf Weight Path *&gt;i 9.9.9.0/24 192.168.56.6 0 100 0 45 i 192.168.107.10 0 678 45 i</code> </pre> <br>  Estranho, tudo parece estar em ordem.  Por que n√£o est√° sendo transmitido para o Router5?  A quest√£o √© que o BGP tem uma regra: <br><blockquote>  O roteador transmite apenas as rotas que ele pr√≥prio usa. </blockquote><br>  O roteador7 usa a rota atrav√©s do roteador5; portanto, a rota atrav√©s do roteador10 n√£o ser√° transmitida.  Voltar para a prefer√™ncia local.  Vamos definir a prefer√™ncia local no roteador7 e ver como o roteador5 responde a isso: <br><br><pre> <code class="plaintext hljs">route-map BGP permit 10 match ip address 10 set local-preference 250 access-list 10 permit any router bgp 123 neighbor 192.168.107.10 route-map BGP in&lt;/b&gt;</code> </pre> <br>  Ent√£o, criamos um mapa de rota no qual todas as rotas se enquadram e pedimos ao Router7 para alterar o par√¢metro de prefer√™ncia local para 250 ap√≥s o recebimento, por padr√£o, √© 100. Vemos o que aconteceu no roteador5: <br><br><pre> <code class="plaintext hljs">Router5#show bgp BGP table version is 8, local router ID is 5.5.5.5 Status codes: s suppressed, d damped, h history, * valid, &gt; best, i - internal, r RIB-failure, S Stale, m multipath, b backup-path, f RT-Filter, x best-external, a additional-path, c RIB-compressed, Origin codes: i - IGP, e - EGP, ? - incomplete RPKI validation codes: V valid, I invalid, N Not found Network Next Hop Metric LocPrf Weight Path *&gt;i 9.9.9.0/24 192.168.57.7 0 250 0 678 45 i</code> </pre> <br>  Como vemos agora, o roteador5 prefere a rota pelo roteador7.  A mesma imagem estar√° no roteador6, embora seja mais lucrativo para ele escolher uma rota atrav√©s do roteador8.  Tamb√©m adicionamos que uma altera√ß√£o nesse par√¢metro requer uma reinicializa√ß√£o do bairro para que a altera√ß√£o entre em vigor.  Leia <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">aqui</a> .  Com a prefer√™ncia local resolvida.  V√° para o pr√≥ximo par√¢metro. </li><li>  Prefer√™ncia de rota com o par√¢metro 0.0.0.0 do pr√≥ximo salto, ou seja, rotas locais ou agregadas.  Ap√≥s inserir o comando de rede, essas rotas recebem automaticamente o par√¢metro Weight igual ao m√°ximo - 32678: <br><br><pre> <code class="plaintext hljs">Router#show bgp BGP table version is 2, local router ID is 9.9.9.9 Status codes: s suppressed, d damped, h history, * valid, &gt; best, i - internal, r RIB-failure, S Stale, m multipath, b backup-path, f RT-Filter, x best-external, a additional-path, c RIB-compressed, Origin codes: i - IGP, e - EGP, ? - incomplete RPKI validation codes: V valid, I invalid, N Not found Network Next Hop Metric LocPrf Weight Path *&gt; 9.9.9.0/24 0.0.0.0 0 32768 i</code> </pre> </li><li>  O caminho mais curto atrav√©s do AS.  O menor par√¢metro AS_Path est√° selecionado.  Quanto menos a rota passar, melhor ser√°.  Considere a rota para 9.9.9.0/24 no roteador10: <br><br><pre> <code class="plaintext hljs">Router10#show bgp BGP table version is 2, local router ID is 6.6.6.6 Status codes: s suppressed, d damped, h history, * valid, &gt; best, i - internal, r RIB-failure, S Stale, m multipath, b backup-path, f RT-Filter, x best-external, a additional-path, c RIB-compressed, Origin codes: i - IGP, e - EGP, ? - incomplete RPKI validation codes: V valid, I invalid, N Not found Network Next Hop Metric LocPrf Weight Path * 9.9.9.0/24 192.168.107.7 0 123 45 i *&gt;i 192.168.112.12 0 100 0 45 i</code> </pre> <br>  Como voc√™ pode ver, o Router10 escolheu a rota atrav√©s de 192.168.112.12 porque o par√¢metro AS_Path cont√©m apenas 45 para esta rota e 123 e 45 no outro caso. </li><li>  O pr√≥ximo par√¢metro √© Origem.  O IGP (rota obtida usando o BGP) √© melhor que o EGP (rota obtida usando o BGP predecessor, agora n√£o usado) e o EGP √© melhor que o Incompleto?  (recebido de alguma outra maneira, por exemplo, por redistribui√ß√£o). </li><li>  O pr√≥ximo par√¢metro √© MED.  T√≠nhamos o Wieght, que s√≥ funcionava localmente no roteador.  Havia uma prefer√™ncia local que funcionava apenas dentro de um sistema aut√¥nomo.  Como voc√™ pode imaginar, o MED √© um par√¢metro que ser√° transmitido entre sistemas aut√¥nomos.  Muito bom <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">artigo</a> sobre esta op√ß√£o. </li></ol><br>  Mais atributos n√£o ser√£o usados, mas se as duas rotas tiverem os mesmos atributos, as seguintes regras ser√£o usadas: <br><br><ol><li>  Escolha um caminho atrav√©s do vizinho IGP mais pr√≥ximo. </li><li>  Selecione a rota mais antiga para o caminho do eBGP. </li><li>  Escolha um caminho atrav√©s do vizinho com o menor ID do roteador BGP. </li><li>  Escolha um caminho atrav√©s do vizinho com o menor endere√ßo IP. </li></ol><br>  <b>Agora considere a quest√£o da converg√™ncia BGP.</b> <br><br>  Vamos ver o que acontece se, por exemplo, o roteador6 perder a rota 9.9.9.0/24 atrav√©s do roteador9.  Desligamos a interface Gi0 / 1 Router6, que imediatamente entende que a sess√£o BGP com o Router8 est√° desconectada e o vizinho desapareceu, o que significa que a rota recebida dele n√£o √© v√°lida.  O roteador6 envia imediatamente as mensagens de atualiza√ß√£o onde indica a rede 9.9.9.0/24 no campo Rotas retiradas.  Assim que o Router5 receber uma mensagem semelhante, envie-a para o Router7.  Mas como o Router7 possui uma rota atrav√©s do Router10, ele envia imediatamente a Atualiza√ß√£o com uma nova rota em resposta.  Se a queda do vizinho n√£o puder ser detectada pelo estado da interface, √© necess√°rio aguardar o tempo de espera para disparar. <br><br>  <b>Confedera√ß√£o.</b> <br><br>  Se voc√™ se lembra, falamos sobre o fato de voc√™ frequentemente precisar usar uma topologia totalmente conectada.  Com um grande n√∫mero de roteadores em um AS, isso pode causar grandes problemas; para evitar isso, √© necess√°rio usar confedera√ß√µes.  Um AS √© dividido em v√°rios sub-ASs, o que permite que ele funcione sem a necessidade de uma topologia totalmente conectada. <br><br> <a href=""><img src="https://habrastorage.org/getpro/habr/post_images/d55/6a8/741/d556a874120b70319381332cdddf739b.jpg" alt="Minha imagem"></a> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Aqui est√° um link para este </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">laborat√≥rio</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , e </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">aqui est√° a</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> configura√ß√£o para o GNS3. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Por exemplo, com essa topologia, ter√≠amos que conectar todos os roteadores no AS 2345, mas, usando a Confedera√ß√£o, podemos estabelecer rela√ß√µes de vizinhan√ßa apenas entre os roteadores conectados diretamente um ao outro. Vamos falar sobre isso em detalhes. Se tiv√©ssemos apenas o AS 2345, </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">laForge faria</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> uma marcha de </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Picard para</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> contar aos </font><b><font style="vertical-align: inherit;">roteadores </font></b></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Data</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> e </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Worf</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , mas eles n√£o contariam a </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Crusher</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> sobre isso </font><font style="vertical-align: inherit;">. Al√©m disso, as rotas que o pr√≥prio roteador rasprastranyaet </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Laforge</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , n√£o seria transferida </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Crusher</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ou</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Worf</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , nem </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Data</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Eu teria que estabelecer um roteador-refletor ou um relacionamento de vizinhan√ßa totalmente conectado. </font><font style="vertical-align: inherit;">Ao dividir um AS 2345 em 4 sub-ASs (2,3,4,5) para cada roteador, acabamos com uma l√≥gica de opera√ß√£o diferente. </font><font style="vertical-align: inherit;">Tudo est√° perfeitamente descrito </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">aqui</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fontes:</font></font><br><br><ol><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Guia Oficial de Certifica√ß√£o e Roteamento CCIE v5.0, Volume 2, Quinta Edi√ß√£o, Narbik Kocharians, Terry Vinson. </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Site </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">xgu.ru</font></font></a> </li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Site </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GNS3Vault</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font></li></ol></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt450814/">https://habr.com/ru/post/pt450814/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt450802/index.html">Interrup√ß√£o herdada</a></li>
<li><a href="../pt450804/index.html">Impress√£o de metal 3D na ind√∫stria automotiva: comece pequeno</a></li>
<li><a href="../pt450806/index.html">Quando uma vari√°vel de ambiente acelera o processo em 40 vezes</a></li>
<li><a href="../pt450810/index.html">As 7 principais maneiras de verificar rapidamente as compet√™ncias dos especialistas em TI antes da entrevista</a></li>
<li><a href="../pt450812/index.html">PSR-14 - o principal evento em PHP</a></li>
<li><a href="../pt450816/index.html">Cabe√ßalhos HTTP para o desenvolvedor respons√°vel</a></li>
<li><a href="../pt450818/index.html">Da alta lat√™ncia do Ceph ao patch do kernel com o eBPF / BCC</a></li>
<li><a href="../pt450820/index.html">Comit√™ do programa FrontendConf: estruturas, horizontes, experi√™ncia mundial e miss√£o da confer√™ncia</a></li>
<li><a href="../pt450822/index.html">Estruturas desaparecendo</a></li>
<li><a href="../pt450824/index.html">O estado do css</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>