<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üëãüèª üö† üôã Comment nous avons perc√© le grand pare-feu chinois (partie 2) üé∑ üéÜ üë©üèø‚Äçüè´</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Salut 


 Nikita est √† nouveau avec vous - un ing√©nieur syst√®me de SEMrush . Et avec cet article, je continue l'histoire de la fa√ßon dont nous avons t...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Comment nous avons perc√© le grand pare-feu chinois (partie 2)</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/semrush/blog/458840/"><p>  Salut </p><br><p>  Nikita est √† nouveau avec vous - un ing√©nieur syst√®me de <strong>SEMrush</strong> .  Et avec cet article, je continue l'histoire de la fa√ßon dont nous avons trouv√© une solution pour contourner le <em>pare-feu chinois</em> pour notre service semrush.com. </p><br><p>  Dans la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">partie pr√©c√©dente,</a> j'ai dit: </p><br><ul><li>  quels probl√®mes apparaissent apr√®s qu'une d√©cision a √©t√© prise "Nous devons faire fonctionner notre service en Chine" </li><li>  Quels sont les probl√®mes d'Internet chinois </li><li>  pourquoi ai-je besoin d'une licence ICP </li><li>  comment et pourquoi nous avons d√©cid√© de tester nos bancs d'essai en utilisant le point de capture </li><li>  quel a √©t√© le r√©sultat de notre premi√®re solution bas√©e sur Cloudflare China Network </li><li>  comment nous avons trouv√© un bogue dans DNS Cloudflare </li></ul><br><img src="https://habrastorage.org/webt/c8/e0/wt/c8e0wt5ps6j4bkc8glimogfgtxg.png"><br><p>  Cette partie est la plus int√©ressante, √† mon avis, car elle se concentre sur des impl√©mentations techniques sp√©cifiques de la mise en sc√®ne.  Et nous allons commencer, ou plut√¥t continuer, avec <strong>Alibaba Cloud</strong> . </p><a name="habracut"></a><br><h2 id="alibaba-cloud">  Nuage d'Alibaba </h2><br><p>  <strong>Alibaba Cloud</strong> est un fournisseur de cloud assez important, qui poss√®de tous les services qui lui permettent de s'appeler honn√™tement un fournisseur de cloud.  C'est bien qu'ils aient la possibilit√© de s'inscrire aupr√®s d'utilisateurs √©trangers, et que la plupart du site a √©t√© traduit en anglais (pour la Chine c'est un luxe).  Dans ce nuage, vous pouvez travailler avec de nombreuses r√©gions du monde, la Chine continentale, ainsi que l'Asie oc√©anique (Hong Kong, Taiwan, etc.). </p><br><h3 id="ipsec">  IPSEC </h3><br><p>  Commenc√© par la g√©ographie.  Comme notre site de test √©tait situ√© sur Google Cloud, nous avons d√ª ¬´lier¬ª Alibaba Cloud √† GCP, nous avons donc ouvert une liste des emplacements o√π Google est pr√©sent.  √Ä ce moment-l√†, ils n'avaient pas encore leur propre centre de donn√©es √† Hong Kong. <br>  La r√©gion la plus proche √©tait l' <strong>Asie-Est1</strong> (Ta√Øwan).  Ali avait <strong>cn-shenzhen</strong> (Shenzhen) comme r√©gion la plus proche de la Chine continentale √† Taiwan. </p><br><p>  √Ä l'aide de <strong>terraform, ils ont</strong> d√©crit et augment√© l'ensemble de l'infrastructure de GCP et Ali.  Le tunnel de 100 Mbps entre les nuages ‚Äã‚Äãs'est √©lev√© presque instantan√©ment.  Du c√¥t√© de Shenzhen et de Taiwan, ils ont cr√©√© des machines virtuelles proxy.  √Ä Shenzhen, le trafic des utilisateurs est interrompu, achemin√© via un tunnel vers Ta√Øwan, et √† partir de l√†, il va directement √† l'adresse IP externe de notre service aux √âtats-Unis (c√¥te est des √âtats-Unis).  Ping entre les virtuels sur le tunnel de <strong>24 ms</strong> , ce qui n'est pas si mal. </p><br><p>  Dans le m√™me temps, nous avons plac√© une zone de test dans <strong>Alibaba Cloud DNS</strong> .  Apr√®s avoir d√©l√©gu√© la zone √† NS Ali, le temps de r√©solution est pass√© de 470 ms √† <strong>50 ms</strong> .  Avant cela, la zone √©tait √©galement sur Cloudlfare. </p><br><p> Parall√®lement au tunnel vers l' <em>Asie-Est1</em> , un autre tunnel a √©t√© √©lev√© de Shenzhen directement vers <em>nous-Est4</em> .  L√†, ils ont cr√©√© plus de machines virtuelles proxy et ont commenc√© √† mesurer les deux solutions, en acheminant le trafic de test √† l'aide de cookies ou DNS.  Le banc d'essai est d√©crit sch√©matiquement dans la figure suivante: </p><br><img src="https://habrastorage.org/webt/r8/c4/gv/r8c4gvhj7_joemea0hznmvo5gxk.png"><br><p>  La latence des tunnels est la suivante: <br>  <em>Ali CN-Shenzhen &lt;--&gt; GCP Asie-Est1 - 24ms</em> <em><br></em>  <em>Ali cn-shenzhen &lt;--&gt; GCP us-east4 - 200ms</em> </p><br><p>  Les tests du navigateur Catchpoint ont signal√© d'excellentes am√©liorations des performances. </p><br><img src="https://habrastorage.org/webt/e0/ku/am/e0kuamjpkkcbj737036tyuirbuk.png"><br><p>  Comparez les r√©sultats des tests pour les deux solutions: </p><br><div class="scrollable-table"><table><thead><tr><th>  Solution </th><th>  Upime </th><th>  M√©diane </th><th>  75 centile </th><th>  95 centile </th></tr></thead><tbody><tr><td>  Cloudflare </td><td>  86,6 </td><td>  18s </td><td>  Ann√©es 30 </td><td>  Ann√©es 60 </td></tr><tr><td>  <strong>IPsec</strong> </td><td>  <strong>99,79</strong> </td><td>  <strong>18s</strong> </td><td>  <strong>21s</strong> </td><td>  <strong>Ann√©es 30</strong> </td></tr></tbody></table></div><br><p>  Il s'agit des donn√©es de la solution utilisant le tunnel IPSEC via <b>asia-east1</b> .  Gr√¢ce √† us-east4, les r√©sultats √©taient pires et il y avait plus d'erreurs, donc je ne donnerai pas les r√©sultats. </p><br><p>  Selon les r√©sultats de ce test, deux tunnels, dont l'un est termin√© dans la r√©gion la plus proche de la Chine, et l'autre √† la destination finale, il est devenu clair qu'il est important de ¬´sortir¬ª sous le pare-feu chinois d√®s que possible, puis d'utiliser des r√©seaux rapides (fournisseurs CDN) , fournisseurs de cloud, etc.).  Pas besoin d'essayer d'un seul coup pour passer par le pare-feu et arriver √† destination.  Ce n'est pas le moyen le plus rapide. </p><br><p>  En g√©n√©ral, les r√©sultats ne sont pas mauvais, cependant, semrush.com a une m√©diane de 8,8 s et 75 centile de 9,4 s (sur le m√™me test). <br>  Et avant de continuer, je voudrais faire une digression. </p><br><h2 id="liricheskoe-otstuplenie">  Digression lyrique </h2><br><p>  Apr√®s que l'utilisateur a visit√© le site <em>www.semrushchina.cn</em> , qui se r√©sout via les serveurs DNS chinois ¬´rapides¬ª, la requ√™te HTTP passe par notre solution rapide.  La r√©ponse est renvoy√©e de la m√™me mani√®re, mais dans tous les scripts JS, pages HTML et autres √©l√©ments de la page Web, le domaine <em>semrush.com est indiqu√©</em> pour les ressources suppl√©mentaires qui doivent √™tre charg√©es lors du rendu de la page.  Autrement dit, le client r√©sout l'enregistrement ¬´principal¬ª A <em>www.semrushchina.c</em> n et se rend dans le tunnel rapide, re√ßoit rapidement une r√©ponse - une page HTML qui indique: </p><br><ul><li>  t√©l√©chargez tel ou tel js sur sso.semrush.com, </li><li>  Prenez les fichiers CSS de cdn.semrush.com, </li><li>  et prenez plus de photos de dab.semrush.com </li><li>  et ainsi de suite. </li></ul><br><p>  Le navigateur commence √† se rendre sur Internet ¬´externe¬ª pour ces ressources, passant √† chaque fois par un pare-feu d√©vorant le temps de r√©ponse. </p><br><p>  Mais dans le test pr√©c√©dent, les r√©sultats sont pr√©sent√©s lorsqu'il n'y a pas de ressources <em>semrush.com</em> sur la page, seul <em>semrushchina.cn</em> et * .semrushchina.cn sont r√©solus √† l'adresse de la machine virtuelle √† Shenzhen pour entrer dans le tunnel plus tard. </p><br><p>  Ce n'est que de cette fa√ßon, en jetant tout le trafic possible √† travers votre d√©cision de passer rapidement au maximum le pare-feu chinois, que vous pouvez obtenir des vitesses et des indicateurs de disponibilit√© du site acceptables, ainsi que des r√©sultats de test honn√™tes des solutions. <br>  Nous l'avons fait sans une seule modification de code du c√¥t√© des produits de l'√©quipe. </p><br><h3 id="subfilter">  Sous-filtre </h3><br><p>  La solution est n√©e presque imm√©diatement apr√®s l'apparition de ce probl√®me.  Nous avions besoin de <strong>PoC</strong> (Proof of Concept) pour que nos solutions de pare-feu fonctionnent vraiment bien.  Pour ce faire, vous devez maximiser tout le trafic vers le site dans cette solution.  Et nous avons appliqu√© <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=https://nginx.org/ru/docs/http/ngx_">un</a> sous- <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=https://nginx.org/ru/docs/http/ngx_">filtre</a> dans nginx. </p><br><p>  <b>Subfilter</b> est un module assez simple dans nginx qui vous permet de changer une ligne dans le corps d'une r√©ponse √† une autre ligne.  Nous avons donc chang√© toutes les occurrences de <em>semrush.com</em> en <em>semrushchina.cn</em> dans toutes les r√©ponses. </p><br><p>  Et ... cela n'a pas fonctionn√©, car nous avons re√ßu du contenu compress√© des backends, donc le sous-filtre n'a pas pu trouver la ligne n√©cessaire.  J'ai d√ª ajouter un autre serveur local √† nginx, ce qui a √©tendu la r√©ponse et l'a transmise au serveur local suivant, qui √©tait d√©j√† engag√© dans la substitution, la compression et la livraison de la ligne au prochain proxy de la cha√Æne. </p><br><img src="https://habrastorage.org/webt/pb/6m/jd/pb6mjdouldlxlm6hr1ilz9dpck0.png"><br><p>  Par cons√©quent, lorsque le client recevrait <strong>&lt;subdomain&gt; .semrush.com</strong> , il recevrait <strong>&lt;subdomain&gt; .semrushchina.cn</strong> et <strong>suivrait</strong> docilement notre d√©cision. </p><br><p>  Cependant, il ne suffit pas de changer le domaine dans une seule direction, car les backends attendent toujours semrush.com dans les requ√™tes ult√©rieures du client.  Par cons√©quent, sur le m√™me serveur o√π le remplacement est effectu√© dans une direction, en utilisant une simple expression r√©guli√®re, nous obtenons le sous-domaine de la demande, puis faisons <i>proxy_pass</i> avec la variable <i>$ host</i> d√©finie dans <b>$ subdomain.semrush.com</b> .  Cela peut sembler d√©routant, mais cela fonctionne.  Et √ßa marche bien.  Pour les domaines individuels qui n√©cessitent une logique diff√©rente, ils cr√©ent simplement leurs blocs de serveur et effectuent une configuration distincte.  Ci-dessous sont des configurations nginx raccourcies pour la clart√© et la d√©monstration de ce sch√©ma. </p><br><p>  La configuration suivante traite toutes les demandes de la Chine √† <i>.semrushchina.cn:</i> <br></p><pre><code class="plaintext hljs">listen 80; server_name ~^(?&lt;subdomain&gt;[\w\-]+)\.semrushchina.cn$; sub_filter '.semrush.com' '.semrushchina.cn'; sub_filter_last_modified on; sub_filter_once off; sub_filter_types *; gzip on; gzip_proxied any; gzip_types text/plain text/css application/json application/x-javascript text/xml application/xml application/xml+rss text/javascript application/javascript; location / { proxy_pass http://127.0.0.1:8083; proxy_set_header Accept-Encoding ""; proxy_set_header Host $subdomain.semrush.com; proxy_set_header X-Accept-Encoding $http_accept_encoding; } }</code> </pre> <br><p>  Cette configuration est dirig√©e par proxy vers <i>localhost</i> sur le port 83, et l√†, elle attend la configuration suivante: </p><br><pre> <code class="plaintext hljs"> listen 127.0.0.1:8083; server_name *.semrush.com; location / { resolver 8.8.8.8 ipv6=off; gunzip on; proxy_pass https://$host; proxy_set_header Accept-Encoding gzip; } }</code> </pre> <br><p>  Encore une fois, ce sont des configurations tronqu√©es. </p><br><p>  Quelque chose comme √ßa.  Cela peut sembler compliqu√©, mais c'est en mots.  En fait, tout est plus facile que le navet cuit √† la vapeur :) </p><br><h3 id="konec-liricheskogo-otstupleniya">  La fin de la digression lyrique </h3><br><p>  Pendant un certain temps, nous √©tions heureux car le mythe de la chute des tunnels IPSEC n'est pas confirm√©.  Mais alors les tunnels ont commenc√© √† tomber.  Plusieurs fois par jour pendant plusieurs minutes.  Un peu, mais cela ne nous convenait pas.  √âtant donn√© que les deux tunnels ont √©t√© termin√©s du c√¥t√© Ali sur le m√™me routeur, nous avons d√©cid√© qu'il s'agissait peut-√™tre d'un probl√®me r√©gional et que nous devions augmenter la r√©gion de sauvegarde. </p><br><p>  Ramass√©.  Les tunnels ont commenc√© √† tomber √† diff√©rents moments, mais nous avons eu un basculement fin au niveau en amont dans nginx.  Mais les tunnels ont commenc√© √† tomber √† peu pr√®s au m√™me moment :) Et encore, 502 et 504. La disponibilit√© a commenc√© √† se d√©t√©riorer, nous avons donc commenc√© √† travailler sur l'option avec <b>Alibaba CEN</b> (Cloud Enterprise Network). </p><br><h2 id="cen">  Cen </h2><br><p>  <b>CEN</b> est la connectivit√© de deux VPC de diff√©rentes r√©gions du cloud d'Alibaba, c'est-√†-dire que vous pouvez connecter les r√©seaux priv√©s de toutes les r√©gions du cloud.  Et le plus important: ce canal a un <em>SLA</em> plut√¥t strict.  Il est tr√®s stable en vitesse et en disponibilit√©.  Mais ce n'est jamais aussi simple: </p><br><ul><li>  il est TR√àS difficile √† obtenir si vous n'√™tes pas des citoyens chinois ou des personnes morales, </li><li>  vous devez payer pour chaque m√©gabit de bande passante. </li></ul><br><p>  Ayant l'opportunit√© de connecter <em>la Chine continentale</em> et l' <em>Outre</em> - <em>Mer</em> , nous avons cr√©√© un CEN entre deux r√©gions d'Ali: <b>cn-shenzhen</b> et <b>us-east-1</b> (le point le plus proche de us-east4).  Dans Ali <i>us-east-1, ils ont</i> lev√© une autre machine virtuelle pour avoir un autre <em>saut</em> . </p><br><p>  Il s'est av√©r√© comme ceci: </p><br><img src="https://habrastorage.org/webt/s5/0s/qs/s50sqsjxzjx0r1fqyx-cjsjkuvq.png"><br><p>  R√©sultats des tests du navigateur ci-dessous: </p><br><img src="https://habrastorage.org/webt/9b/p0/oq/9bp0oqtuludsve8g5tlnqfsa75k.png"><br><div class="scrollable-table"><table><thead><tr><th>  Solution </th><th>  Upime </th><th>  M√©diane </th><th>  75 centile </th><th>  95 centile </th></tr></thead><tbody><tr><td>  Cloudflare </td><td>  86,6 </td><td>  18s </td><td>  Ann√©es 30 </td><td>  Ann√©es 60 </td></tr><tr><td>  IPsec </td><td>  99,79 </td><td>  18s </td><td>  21s </td><td>  Ann√©es 30 </td></tr><tr><td>  <b>Cen</b> </td><td>  <b>99,75</b> </td><td>  <b>16s</b> </td><td>  <b>21s</b> </td><td>  <b>27s</b> </td></tr></tbody></table></div><br><p>  Les performances sont l√©g√®rement meilleures que IPSEC.  Mais via IPSEC, vous pouvez potentiellement t√©l√©charger √† une vitesse de 100 Mbps, et via CEN uniquement √† une vitesse de 5 Mbps et plus cher. </p><br><p>  Hybrid supplie, non?  Combinez vitesse IPSEC et stabilit√© CEN. </p><br><p>  C'est ce que nous avons fait en laissant le trafic passer par IPSEC et CEN en cas de crash d'un tunnel IPSEC.  Le temps de disponibilit√© est devenu beaucoup plus √©lev√©, mais la vitesse de chargement du site est m√©diocre.  Ensuite, j'ai dessin√© tous les sch√©mas que nous avons d√©j√† utilis√©s et test√©s, et j'ai d√©cid√© d'essayer d'ajouter un peu plus de GCP √† ce sch√©ma, √† savoir <strong>GLB</strong> . </p><br><h2 id="glb">  GLB </h2><br><p>  <strong>GLB</strong> est le <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Global Load Balancer</a> (ou Google Cloud Load Balancer).  Il a un avantage important pour nous: dans le contexte de CDN, il dispose d'une <strong>IP anycast</strong> , qui vous permet d'acheminer le trafic vers le centre de donn√©es le plus proche du client, gr√¢ce auquel le trafic arrive plus rapidement et moins sur le r√©seau rapide de Google via Internet "normal". </p><br><p>  Sans y r√©fl√©chir √† deux fois, nous avons augment√© <em>HTTP / HTTPS LB</em> √† GCP et mis nos machines virtuelles avec un backend de sous-filtre. </p><br><p>  Il y avait plusieurs r√©gimes: </p><br><ul><li>  Utilisez <em>Cloudflare China Network</em> , mais cette fois l'origine sp√©cifie l' <strong>IP GLB</strong> globale. </li><li>  Terminez les clients dans <em>cn-shenzhen</em> , et √† partir de l√†, le trafic proxy imm√©diatement vers <strong>GLB</strong> . </li><li>  Allez directement de la Chine au <strong>GLB</strong> . </li><li>  Terminez les clients √† <em>CN-Shenzhen</em> , de l√† proxy √† <em>asie-est1</em> via IPSEC (en <em>us-east4</em> via CEN), √† partir de l√† allez √† GLB (calmement, il y aura une photo et une explication ci-dessous) </li></ul><br><p>  Nous avons test√© toutes ces options et quelques autres hybrides: </p><br><ul><li>  <strong>Cloudflare + GLB</strong> </li></ul><br><img src="https://habrastorage.org/webt/aa/-z/5c/aa-z5cpge5r_2qazfvcsvne5loi.png"><br><p>  Ce sch√©ma ne nous convenait pas pour la disponibilit√© et les erreurs DNS.  Mais le test a √©t√© effectu√© avant de corriger le bug de la part de CF, peut-√™tre que maintenant c'est mieux (cependant, cela n'exclut pas les timeouts HTTP). </p><br><ul><li>  <strong>Ali + GLB</strong> </li></ul><br><img src="https://habrastorage.org/webt/mm/ef/id/mmefid6fj_5fwsbvtjwealb6wnu.png"><br><p>  Ce sch√©ma ne nous convenait pas non plus pour la disponibilit√©, car GLB a souvent abandonn√© en amont en raison de l'impossibilit√© de se connecter √† une heure ou un d√©lai acceptable, car pour un serveur en Chine, l'adresse GLB reste √† l'ext√©rieur, et donc derri√®re le pare-feu chinois.  La magie n'est pas arriv√©e. </p><br><ul><li>  <strong>GLB uniquement</strong> </li></ul><br><img src="https://habrastorage.org/webt/yg/l9/jc/ygl9jcr4ugsqil_ry6zf4kj4dhy.png"><br><p>  Une variante similaire √† la pr√©c√©dente, mais elle n'utilisait pas de serveurs en Chine m√™me: le trafic passait imm√©diatement √† GLB (enregistrements DNS modifi√©s).  En cons√©quence, les r√©sultats n'√©taient pas satisfaisants, car les clients chinois ordinaires utilisant les services de fournisseurs Internet ordinaires ont une situation bien pire en passant par le pare-feu qu'Ali Cloud. </p><br><ul><li>  <strong>Shenzhen -&gt; (CEN / IPSEC) -&gt; Proxy -&gt; GLB</strong> </li></ul><br><img src="https://habrastorage.org/webt/9f/v_/lw/9fv_lwec8yi4-rmuubqypun5mas.png"><br><p>  Ici, nous avons d√©cid√© d'utiliser la meilleure des solutions: </p><br><ul><li>  stabilit√© et garantie SLA du CEN </li><li>  haute vitesse de IPSEC </li><li>  Le r√©seau ¬´rapide¬ª de Google et son anycast. </li></ul><br><p>  Le sch√©ma ressemble √† ceci: le trafic utilisateur se termine sur une machine virtuelle √† <em>ch-shenzhen</em> .  Les param√®tres en amont Nginx y sont configur√©s, dont certains se r√©f√®rent √† des serveurs IP priv√©s situ√©s √† l'autre extr√©mit√© du tunnel IPSEC, et certaines connexions en amont √† des adresses de serveurs priv√©s de l'autre c√¥t√© du CEN.  IPSEC a √©t√© configur√© pour la r√©gion <em>Asie-Est1</em> dans GCP (c'√©tait la r√©gion la plus proche de la Chine au moment o√π la solution a √©t√© cr√©√©e. Maintenant, GCP est √©galement pr√©sent √† Hong Kong).  CEN - dans la r√©gion <em>us-east1</em> d'Ali Cloud. </p><br><p>  De plus, le trafic des deux extr√©mit√©s √©tait dirig√© vers <strong>anycast IP GLB</strong> , c'est-√†-dire vers le point de pr√©sence de Google le plus proche, et traversait ses r√©seaux vers la r√©gion <em>us-east4</em> dans GCP, dans laquelle il y avait des machines virtuelles de remplacement (avec sous-filtre dans nginx). </p><br><p>  Cette solution hybride, comme nous nous y attendions, nous a permis de profiter de chaque technologie.  En g√©n√©ral, le trafic passe par IPSEC rapide, mais si des probl√®mes commencent, nous jetons rapidement et pendant plusieurs minutes ces serveurs en amont et envoyons le trafic via CEN uniquement jusqu'√† ce que le tunnel se stabilise. </p><br><p>  Apr√®s avoir impl√©ment√© la 4√®me solution de la liste ci-dessus, nous avons r√©alis√© ce que nous voulions et ce que l'entreprise exigeait de nous √† l'√©poque. </p><br><p>  R√©sultats des tests du navigateur pour la nouvelle solution par rapport aux pr√©c√©dents: </p><br><div class="scrollable-table"><table><thead><tr><th>  Solution </th><th>  Upime </th><th>  M√©diane </th><th>  75 centile </th><th>  95 centile </th></tr></thead><tbody><tr><td>  Cloudflare </td><td>  86,6 </td><td>  18s </td><td>  Ann√©es 30 </td><td>  Ann√©es 60 </td></tr><tr><td>  IPsec </td><td>  99,79 </td><td>  18s </td><td>  21s </td><td>  Ann√©es 30 </td></tr><tr><td>  Cen </td><td>  99,75 </td><td>  16s </td><td>  21s </td><td>  27s </td></tr><tr><td>  <strong>CEN / IPsec + GLB</strong> </td><td>  <strong>99,79</strong> </td><td>  <strong>13s</strong> </td><td>  <strong>16s</strong> </td><td>  <strong>25s</strong> </td></tr></tbody></table></div><br><h2 id="cdn">  Cdn </h2><br><p>  Tout est bon dans la solution que nous avons mise en place, mais il n'y a pas de CDN qui pourrait acc√©l√©rer le trafic au niveau des r√©gions et m√™me des villes.  En th√©orie, cela devrait acc√©l√©rer le site pour les utilisateurs finaux gr√¢ce √† l'utilisation des canaux de communication rapides du fournisseur CDN.  Et nous y pensions tout le temps.  Et maintenant, le moment est venu pour la prochaine it√©ration du projet: rechercher et tester les fournisseurs CDN en Chine. </p><br><p>  Et je vais vous en parler dans la prochaine partie finale :) </p><br><h3 id="vse-chasti">  Toutes les pi√®ces </h3><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Partie 1</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">3e partie</a> </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr458840/">https://habr.com/ru/post/fr458840/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr458828/index.html">Pourquoi, pourquoi et quand utiliser ValueTask</a></li>
<li><a href="../fr458830/index.html">Webinaires sur les technologies Dell: tous les d√©tails de notre didacticiel</a></li>
<li><a href="../fr458832/index.html">Cinq √©tudiants et trois magasins de valeurs cl√©s distribu√©s</a></li>
<li><a href="../fr458834/index.html">C√¥t√© de la personnalit√© de Paul Allen, que peu de gens connaissaient comme je le souhaiterais</a></li>
<li><a href="../fr458836/index.html">Indice de Borsch. Une approche syst√©matique pour √©valuer, comparer, d√©terminer le rapport qualit√© / prix</a></li>
<li><a href="../fr458842/index.html">La patience et le travail vont extraire tout le texte</a></li>
<li><a href="../fr458844/index.html">Destruction des silos gr√¢ce √† l'approche d'adaptation VeriSM ‚Ñ¢</a></li>
<li><a href="../fr458846/index.html">Comment d√©velopper un autre jeu de plateforme en utilisant Unity. Un autre tutoriel</a></li>
<li><a href="../fr458848/index.html">Version Rust 1.36.0: futur trait, stabilisation de l'allocation et MaybeUninit <T></a></li>
<li><a href="../fr458850/index.html">Apprenez l'anglais √† moindre co√ªt et efficacement. 2e partie</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>