<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üéå ‚ÜóÔ∏è ü•¶ Machine virtuelle sur l'ESP8266 pour ex√©cuter des jeux üëú üì≥ üÜì</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="VM √©crite par une main incertaine des sciences humaines dans l'environnement de programmation Arduino √† l'aide de quickcode et de v√©los. Et il existe ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Machine virtuelle sur l'ESP8266 pour ex√©cuter des jeux</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/459714/"> VM √©crite par une main incertaine des sciences humaines dans l'environnement de programmation Arduino √† l'aide de quickcode et de v√©los.  Et il existe √©galement un compilateur √† partir d'un langage de type C, √©crit en JavaScript en utilisant les m√™mes m√©thodes.  Oui  Vous pouvez d√©j√† vous pr√©cipiter dans les commentaires, lancer des pierres.  Eh bien, pour ceux qui sont toujours int√©ress√©s, je vous invite √† continuer √† lire. <br><br><img src="https://habrastorage.org/webt/id/lf/6y/idlf6yqnyzplrex2cq3waeu0txc.png" alt="Trolleybus √† pain"><br><a name="habracut"></a><br>  En g√©n√©ral, mon travail a d√©j√† √©t√© un peu couvert par le respect√© <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" class="user_link">tormozedison</a> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ici</a> .  Mais √† cette √©poque, il y avait plut√¥t un prototype sph√©rique dans le vide.  Et maintenant, j'ai un appareil RomanS, qu'il m'a gentiment fourni pour des exp√©riences absolument gratuites.  Cet appareil s'appelle ESPboy.  Il se distingue des autres m√©tiers par sa compacit√© et sa fente d'expansion utilisant la puce MCP23017.  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Ici,</a> vous pouvez en savoir plus sur lui. <br><br>  Si quelqu'un est int√©ress√©, comment une id√©e aussi √©trange m'est venue √† l'esprit en tant que machine virtuelle sur un microcontr√¥leur, alors vous pouvez la lire sous le spoiler. <br><br><div class="spoiler">  <b class="spoiler_title">Contexte</b> <div class="spoiler_text">  Une fois √† l'√©cole, j'ai √©t√© emport√© par un joueur de jeu de yoyogames et, comme beaucoup, riv√© dessus, je ne comprends pas quoi.  Ces d√©mos mal √©crites et mal dessin√©es pouvaient encore se vanter aupr√®s d'amis, mais sur Internet, elles se noyaient parmi des similaires.  J'ai r√©alis√© combien il √©tait difficile d'√©crire moi-m√™me un jeu simple, sans parler d'un jeu s√©rieux dans lequel vous pourriez voler les vaches.  Mais l'envie d'√©crire des jeux n'a pas √©t√© perdue.  Quand j'ai eu un t√©l√©phone portable, j'ai d√©couvert Midlet Pascal et je me suis amus√© avec pendant plusieurs ann√©es.  Apr√®s tout, j'ai r√©alis√© qu'√©crire un jeu pour un appareil faible est plus facile que pour son grand fr√®re plus puissant.  Au moins, on pourrait toujours parler non pas de mains tordues, mais des capacit√©s limit√©es de la plate-forme.  Cependant, les joueurs de bouton ont laiss√© la place √† des capteurs une autre chance de conqu√©rir le monde a √©t√© manqu√©e.  N√©anmoins, √† un moment donn√©, j'ai r√©alis√© que je pouvais raviver mes r√™ves en utilisant un microcontr√¥leur. <br><br>  J'ai commenc√© par √©crire un jeu sous arduino uno, o√π iriez-vous sans.  Ensuite, elle √©tait ma seule et j'√©tais tr√®s inqui√®te de sa performance.  J'ai essay√© de flasher le moins possible.  Mais le chemin du r√¢teau va par petits pas.  Chaque petite modification du code le faisait clignoter encore et encore.  Et j'ai d√©cid√© d'√©crire une machine virtuelle empil√©e.  Apr√®s tout, il y a d'√©normes deux kilo-octets de RAM pour les octets de code et de donn√©es √† bord.  Mais comme c'√©tait lent, mais pour une raison inconnue, la m√©moire manquait constamment.  Le fait est que tous mes v√©los √©taient avec des roues carr√©es et roulaient lentement.  J'ai alors d√©cid√© d'√©crire un √©mulateur de puce 8 sur Arduino Mega qui vient d'arriver de Chine.  Bien s√ªr, j'ai alors voulu lui √©crire un √©mulateur de gameboy, la premi√®re playstation et un supercalculateur plus facile.  En cons√©quence, j'ai compris l'essentiel.  La machine virtuelle chip-8 √©tait tr√®s simple, trop simple.  √Ä tel point que lors de l'√©criture de vos jeux pour la multiplication ou la division, vous deviez √©crire un sous-programme lent s√©par√©.  Vous devez donc √©crire votre VM, en vous d√©barrassant d'une faille fatale.  A cette √©poque, plusieurs autres esp8266 sont arriv√©s, avec leur espace de 160MHz. <br></div></div><br>  S'il vous semble qu'une machine virtuelle est un gaspillage de ressources, j'ai √©galement r√©√©crit mon √©mulateur chip-8 pour cela.  Il s'est av√©r√© une machine virtuelle dans une machine virtuelle sur un microcontr√¥leur.  Vous pouvez probablement aller plus loin et √©crire une machine de Turing sur la puce 8. <br><br><h4>  Sp√©cifications du moteur de jeu ESP Little </h4><br>  Une machine virtuelle contient 16 registres de 16 bits chacun, un registre z√©ro est un pointeur de pile.  Chaque instruction est cod√©e sur deux octets, certaines instructions contiennent deux octets de donn√©es.  M√©moire adressable 64 Ko.  Dans le cas de l'ESP8266, 20 Ko sont disponibles.  Le programme peut √™tre t√©l√©charg√© depuis SPIFFS et UART.  Si vous le souhaitez, vous pouvez ajouter un t√©l√©chargement √† partir d'une carte m√©moire ou via WiFi.  En plus des instructions arithm√©tiques habituelles et des instructions pour d√©placer des donn√©es, il existe des instructions distinctes pour travailler avec les images-objets, l'√©cran et le son.  Taille d'√©cran 128 par 128 pixels.  √Ä 16 couleurs par point, l'√©cran prend 8 Ko de m√©moire, la m√™me quantit√© de tampon pour dessiner des sprites et des particules.  Bien que la biblioth√®que TFT_eSPI que j'utilise soit capable de mettre √† jour l'√©cran plus de 60 fois par seconde, j'ai d√ª me limiter √† 20 images par seconde.  Sinon, le temps processeur n'√©tait pas suffisant pour la machine virtuelle.  Vous pouvez dessiner des tuiles et 32 ‚Äã‚Äãsprites jusqu'√† 128x128 pixels avec la possibilit√© de rotation et de mise en miroir.  Pour √©conomiser de la m√©moire, vous pouvez utiliser des images mono-bit ou la compression RLE.  Il y a la physique simplifi√©e: d√©tection des collisions de sprites avec des sprites et des tuiles, r√©solution des collisions, gravit√©.  L'√©cran est mis √† jour ligne par ligne uniquement si une ligne a chang√© de pixels.  La vitesse de la machine virtuelle, en fonction du nombre de lignes trac√©es dans le cadre, varie de 100 000 √† 900 000 op√©rations par seconde.  Vous pouvez utiliser diff√©rents √©crans couleur, il y a un √©tirement doux de l'image dans les proportions souhait√©es. <br><br><img src="https://habrastorage.org/webt/jf/ai/mv/jfaimvgh6rbtnum5u-lpdsslpws.png"><br>  <i>Certains des jeux √©crits par moi peuvent √™tre consult√©s <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ici</a> .</i> <br><br>  En m√™me temps que VM pour ESP8266, j'ai √©crit un √©mulateur JavaScript pour le navigateur.  Afin de ne pas modifier le bytecode manuellement, un simple assembleur a √©t√© ajout√©, bas√© sur mon exp√©rience avec l'assembleur pour le MOS6502.  J'ai alors d√©cid√© d'ajouter une langue de niveau sup√©rieur.  N√©anmoins, ma t√¢che principale √©tait d'√©crire rapidement des jeux simples, et non un long code d'assemblage de d√©bogage.  Il m'a sembl√© que l'√©criture de votre compilateur serait plus facile que l'ajout de LLVM.  Et je l'ai √©crit en JavaScript, car je le connais pas aussi mal que d'autres langues.  Pour le moment, il est loin de supporter les standards C, et lors de la compilation, vous pouvez facilement rencontrer une erreur incompr√©hensible dans un endroit incompr√©hensible.  Mais c'est rapide, car il faut moins de 2000 lignes. <br><br>  Et maintenant √† la question, pourquoi ai-je √©crit tout cela ici.  D√©j√† maintenant, vous pouvez √©crire et ex√©cuter des jeux.  Cependant, la perfection est encore loin.  Si quelqu'un veut m'aider √† finaliser l'ESP LGE ou √† √©crire mon propre jeu, je serai tr√®s heureux.  Si vous pensiez que mon id√©e √©tait int√©ressante et que vous vouliez en savoir plus, je me ferai un plaisir de r√©pondre √† vos questions.  Je vous pr√©viens, le code pour Arduino est assez difficile √† lire.  En partie parce que je suis autodidacte.  En partie parce que j'ai essay√© de r√©duire le nombre d'appels de fonction afin d'augmenter la vitesse de travail.  En cons√©quence, de nombreuses fonctions contiennent d'√©normes traces de code.  Ne laissez donc pas les femmes enceintes et les enfants √† l'√©cran.  Petit √† petit, je vais essayer de r√©soudre ce probl√®me et d'am√©liorer la lisibilit√©. <br><br>  Et pour ceux qui ont lu, un exemple de jeu.  Il prend moins d'une centaine de lignes et moins de 1 Ko sous forme compil√©e. <br><br><pre><code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">int</span></span> stickCount; <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> key,previouseKey,takenSticks; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">redraw</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i; <span class="hljs-comment"><span class="hljs-comment">//   setcolor(2); //   for(i = 0; i &lt; stickCount; i++) line(22 + i * 6, 74, 22 + i * 6, 84); //   setcolor(11); //  for(i = stickCount; i &lt; 15; i++) line(22 + i * 6, 74, 22 + i * 6, 84); //     setcolor(1); //   delayredraw(); } void playersMove(){ //    ,     .  while(key == previouseKey){ key = getkey(); } while(key != KEY_LEFT &amp;&amp; key != KEY_DOWN &amp;&amp; key != KEY_RIGHT){ key = getkey(); } if(key &amp; KEY_LEFT){ takenSticks = 1; }else if(key &amp; KEY_DOWN){ takenSticks = 2; }else{ takenSticks = 3; } printf("%d, ", takenSticks); stickCount -= takenSticks; previouseKey = key; } void computersMove(){ if(stickCount % 4){ //   ,    takenSticks = stickCount % 4; }else{ //      takenSticks = 1 + random(1); } stickCount -= takenSticks; printf("%d, ", takenSticks); } void game(){ // stickCount = 15; clearscreen(); //       gotoxy(8,0); puts(""); gotoxy(2,1); puts(" 1,2  3 .  ,   . :\n"); // 27,25  26   printf(" %c 1 %c 2 %c 3", 27, 25, 26); gotoxy(0,12); redraw(); while(1){ playersMove(); if(stickCount &lt;= 0){ gotoxy(3,8); puts(" "); return; } redraw(); computersMove(); redraw(); if(stickCount &lt;= 0){ gotoxy(3,8); puts(" "); return; } } } void main(){ while(1){ game(); //  settimer(1,1000); while(gettimer(1)){} while(getkey() == 0){} previouseKey = key; } }</span></span></code> </pre> <br>  Vous pouvez le <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">tester</a> imm√©diatement.  Suivez le lien, puis cliquez sur compiler, puis ex√©cutez.  Si vous voulez en savoir plus sur les possibilit√©s de l'IDE, vous pouvez lire le <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">tutoriel</a> .  Merci de votre attention. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr459714/">https://habr.com/ru/post/fr459714/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr459704/index.html">LLVM IR and Go</a></li>
<li><a href="../fr459706/index.html">5 raisons pour lesquelles vous devriez oublier Redux dans les applications React</a></li>
<li><a href="../fr459708/index.html">Conception de l'interface de jeu. Brent Fox De quoi parle le livre?</a></li>
<li><a href="../fr459710/index.html">Survivre √† une collision frontale et pourquoi l'amn√©sie n'est pas ce que vous pensez</a></li>
<li><a href="../fr459712/index.html">Maman hackers √† un emploi officiel: ce que font les pentesters</a></li>
<li><a href="../fr459716/index.html">Quelques aspects de l'optimisation des requ√™tes LINQ dans C # .NET pour MS SQL Server</a></li>
<li><a href="../fr459718/index.html">10 conseils pour r√©viser le code que vous n'aimez pas</a></li>
<li><a href="../fr459722/index.html">Qu'est-ce que le d√©veloppement d'√©quipe et l'alpinisme ont en commun</a></li>
<li><a href="../fr459726/index.html">7 pi√®ces que vous n'avez absolument pas besoin de faire lors de l'ouverture d'un club de robotique. Ici, pas besoin de faire</a></li>
<li><a href="../fr459728/index.html">Smartphone avec la brise: ZTE Red Magic 3 avis</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>