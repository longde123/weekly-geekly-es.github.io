<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üßñüèº üçº üôáüèº Ciclo de desenvolvimento completo do dispositivo IoT para controle de aquecimento de piscinas no ESP8266 em um ambiente Arduino üë©üèø‚Äçü§ù‚Äçüë®üèΩ üèí üë∑üèª</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Nesta publica√ß√£o, compartilharei minha experi√™ncia sobre a cria√ß√£o de um dispositivo IoT do zero: desde o surgimento de uma ideia e sua implementa√ß√£o ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Ciclo de desenvolvimento completo do dispositivo IoT para controle de aquecimento de piscinas no ESP8266 em um ambiente Arduino</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/413955/"><p>  Nesta publica√ß√£o, compartilharei minha experi√™ncia sobre a cria√ß√£o de um dispositivo IoT do zero: desde o surgimento de uma ideia e sua implementa√ß√£o em hardware at√© a cria√ß√£o de firmware para um controlador e uma interface da web para gerenciar um dispositivo criado via Internet. </p><br><p>  Antes de criar este dispositivo, eu: </p><br><ul><li>  Quase n√£o entendi o circuito.  Somente no n√≠vel dos princ√≠pios de trabalho <br>  resistor / transistor ... Eu n√£o tinha experi√™ncia em criar circuitos complicados. </li><li>  Nunca projetou placas de circuito. </li><li>  Nunca componente SMD soldado.  O n√≠vel do ferro de solda estava no n√≠vel dos fios de solda e algum tipo de rel√©. </li><li>  Eu nunca escrevi programas t√£o complexos para um microcontrolador.  Toda a experi√™ncia foi no n√≠vel ‚Äúacenda o LED no Arduino‚Äù e conheci o controlador ESP8266. </li><li>  Eu escrevi bastante C ++ para o "irm√£o mais velho", mas isso foi h√° mais de uma d√∫zia de anos atr√°s e tudo foi esquecido h√° muito tempo. </li></ul><br><p>  Obviamente, a experi√™ncia de trabalhar como programador (principalmente o Microsoft .NET) e o pensamento sist√™mico me ajudaram a entender o t√≥pico.  Eu acho que o leitor ser√° capaz.  Links e artigos √∫teis sobre o mar da Internet.  O mais, na minha opini√£o, interessante e ajudando a entender o t√≥pico, trago o artigo. </p><a name="habracut"></a><br><h2>  Declara√ß√£o do problema </h2><br><p>  Eu moro em uma casa particular perto de Minsk, e minha pr√≥pria piscina, embora a mais simples, seja parte integrante do conjunto de ‚Äúbenef√≠cios‚Äù que muitas pessoas que vivem em uma casa de campo recebem.  Em nosso clima inst√°vel, verificou-se que nadar na piscina √© desconfort√°vel se estiver ao ar livre: a √°gua esfria √† noite e o tempo ventoso durante o dia n√£o torna a nata√ß√£o confort√°vel.  No ano passado, com minhas pr√≥prias m√£os, constru√≠ uma c√∫pula geod√©sica <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">mais</a> acima da piscina, montei uma colina e pendurei uma bungee - as crian√ßas est√£o felizes. </p><br><img src="https://habrastorage.org/webt/hh/ec/xp/hhecxpolfqsqevq41tmn-84npsg.jpeg"><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><em>Reportagem fotogr√°fica da</em> constru√ß√£o da c√∫pula no Flickr.</a> </p><br><p>  Este ano fui ainda mais longe e decidi organizar um aquecedor de piscina a partir de uma caldeira a g√°s, <br>  que serve para aquecer a casa no inverno e aquecer a √°gua quente no ver√£o. </p><br><p>  No ver√£o, o circuito de "aquecimento" da caldeira com a ajuda de v√°lvulas muda para aquecimento <br>  piscina.  A √°gua da piscina √© aquecida com a ajuda de um trocador de calor de tit√¢nio, cujo circuito prim√°rio passa o l√≠quido refrigerante (√°gua quente sem impurezas) do circuito de aquecimento e a √°gua secund√°ria da piscina, bombeada por uma bomba de recircula√ß√£o do sistema de filtragem.  Como eu uso a piscina com um clorador (muitos t√≥picos interessantes s√£o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">descritos</a> no <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">ForumHouse</a> ), a √°gua cont√©m um pouco de sal e √© necess√°rio um trocador de calor de tit√¢nio.  Voc√™ n√£o pode simplesmente pegar e deixar a √°gua entrar diretamente na caldeira - caso contr√°rio, voc√™ corroer√° todos os canos com sal. </p><br><img src="https://habrastorage.org/webt/d6/_k/pz/d6_kpzjpyzyvy2-vzk9aukvstko.png"><br><p>  Passando pelo trocador de calor, o transportador de calor aquecido pela caldeira a uma temperatura de cerca de 70-90 ¬∞ C libera calor da √°gua da piscina, aquecendo-a alguns graus.  O l√≠quido de refrigera√ß√£o em si esfria algumas dezenas de graus e retorna √† caldeira para ser novamente <br>  aquecido.  A propor√ß√£o entre o resfriamento da √°gua da caldeira e o aquecimento da √°gua da piscina depende de muitos fatores: a capacidade do trocador de calor e a velocidade da circula√ß√£o da √°gua nos circuitos prim√°rio e secund√°rio. </p><br><p>  Os tubos conectados da piscina ao trocador de calor s√£o tubos de polietileno comuns, aqueles que <br>  atualmente usado para fornecer √°gua fria a resid√™ncias particulares.  Barato, capacidade de suportar press√£o decente, aus√™ncia de corros√£o - essas s√£o as principais vantagens de tais tubos.  Para todos, sem exce√ß√£o, tubos de polietileno, a temperatura de opera√ß√£o √© limitada a 40 graus Celsius.  Em princ√≠pio, isso √© mais do que suficiente para a piscina. </p><br><p>  No entanto, existe uma alta probabilidade de emerg√™ncia, caso a bomba <br>  a recircula√ß√£o da √°gua da piscina ir√° parar por algum motivo e a caldeira continuar√° a aquecer o trocador de calor: nesse caso, a √°gua no circuito secund√°rio do trocador de calor aumentar√° r√°pido o suficiente para a temperatura do circuito prim√°rio, o que significa que as se√ß√µes dos tubos de polietileno adjacentes ao trocador de calor derreter√£o e a √°gua da piscina inundar√° todo o espa√ßo ao redor. </p><br><p>  Deve ser poss√≠vel proteger o superaquecimento do trocador de calor. </p><br><h2>  Solu√ß√£o r√°pida </h2><br><p>  Para resolver esse problema, um sensor de fluxo operando com o princ√≠pio do <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">efeito hall</a> foi inclu√≠do no circuito do circuito de recircula√ß√£o de √°gua da piscina.  Al√©m disso, sensores de temperatura localizados no circuito secund√°rio <br>  trocador de calor, forne√ßa um segundo n√≠vel de defesa, rastreando o poss√≠vel superaquecimento. </p><br><p>  √â imposs√≠vel controlar o superaquecimento apenas por sensores de temperatura: o sistema possui uma grande in√©rcia: ap√≥s uma parada repentina de √°gua no circuito da piscina, a <br>  desligando a caldeira, a temperatura continua a subir por algum tempo, pois  a caldeira ainda conduz a √°gua aquecida ao longo do circuito por in√©rcia, impedindo o superaquecimento de ‚Äúeu mesmo, meu amado‚Äù. </p><br><p>  Portanto, √© importante responder o mais r√°pido poss√≠vel: interromper o fluxo de √°gua no circuito <br>  piscina. </p><br><p>  Foi utilizado um sensor de fluxo.  A caixa de pl√°stico e a falta de contato do sensor com a √°gua permitem que ele seja usado em √°gua salgada. </p><br><p>  Sensores de temperatura, foi decidido usar o Dallas DS18B20, eles s√£o f√°ceis de conectar v√°rias pe√ßas ao mesmo tempo em um barramento de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">1 fio</a> . </p><br><img src="https://habrastorage.org/webt/nd/pj/d5/ndpjd5v3_0lbaklr-ogjnaxribi.jpeg"><br><p>  Foi decidido pendurar um par de sensores na entrada e na sa√≠da do secund√°rio e do prim√°rio <br>  circuito: total de 4 sensores.  Uma vantagem adicional dessa abordagem √© <br>  a capacidade de monitorar os par√¢metros do sistema: voc√™ pode monitorar quanto o l√≠quido de arrefecimento no circuito prim√°rio √© resfriado e quanta √°gua da piscina √© aquecida no circuito secund√°rio.  Ent√£o - para monitorar a otimiza√ß√£o do aquecimento e prever o tempo de aquecimento. </p><br><div class="spoiler">  <b class="spoiler_title">Localiza√ß√£o dos sensores nos trocadores de calor e nos tubos de entrada</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/en/vw/mi/envwmicj0l1hc76r23a_uvyjd3w.jpeg"></div></div><br><h2>  Par√¢metros do dispositivo </h2><br><p>  O primeiro prot√≥tipo do dispositivo foi constru√≠do com base no Arduino Uno e lan√ßado com sucesso. </p><br><img src="https://habrastorage.org/webt/ol/xh/rg/olxhrgxw-w4qqnjpzxkuhj7mc7u.png"><br><p>  Mas ent√£o ficou claro que eu gostaria de mais.  Aqueceu 16 metros c√∫bicos de √°gua, mesmo <br>  alguns graus n√£o √© r√°pido.  E eu gostaria de monitorar diretamente os par√¢metros de aquecimento do trabalho, ligar / desligar.  Mas, ao mesmo tempo, seria interessante filmar hor√°rios de aquecimento, por exemplo, por dia. </p><br><p>  Bem, como j√° estamos recebendo um dispositivo IoT, por que n√£o controlamos ao mesmo tempo a ativa√ß√£o remota do clorador de piscina e bombeamos para ele? </p><br><h2>  Termos de Refer√™ncia </h2><br><p>  Ent√£o, decidiu-se desenvolver um dispositivo - um controlador de piscina multifuncional.  Ele deve ser capaz de: </p><br><ul><li>  Para controlar o aquecimento da piscina atrav√©s do trocador de calor, ligue / desligue a caldeira a g√°s para aquecer a √°gua. </li><li>  Evite o superaquecimento do trocador de calor, monitorando a presen√ßa de um fluxo de √°gua da piscina no circuito secund√°rio e a temperatura excessiva do circuito secund√°rio. <br></li><li>  Exibir estat√≠sticas de aquecimento em tempo real (temperatura na entrada e sa√≠da de ambos os circuitos). </li><li>  Registre (log) os valores de temperatura na mem√≥ria flash.  Exibir dados para <br>  um certo per√≠odo na forma de um gr√°fico. </li><li>  Usando um rel√©, consiga ligar / desligar as bombas da piscina e o clorador. </li><li>  Gerencie todos os par√¢metros do dispositivo remotamente atrav√©s do servidor micro-web embutido. </li></ul><br><p>  Houve tamb√©m a tenta√ß√£o de ferrar Blink, MQTT.  Mas a partir desses "sinos e assobios" na primeira fase <br>  Foi decidido recusar.  E ainda mais, eu n√£o gostaria de assumir a possibilidade de controle em algum lugar externo.  O servidor da web embutido para meus prop√≥sitos √© suficiente.  E a seguran√ßa √© garantida pelo fato de que voc√™ pode entrar na rede dom√©stica do mundo externo apenas por meio de uma VPN. </p><br><h2>  Hardware </h2><br><p>  Como controlador, decidiu-se usar o barato e popular ESP8266.  Era perfeito para meus prop√≥sitos, exceto por uma coisa: combinar os n√≠veis de sinal dos sensores de 5 volts com a l√≥gica do controlador de 3,3 volts.  Em princ√≠pio, os sensores de Dallas parecem funcionar a 3 volts, mas eu tenho uma linha bastante longa do controlador aos sensores, cerca de 7 metros.  Portanto, √© melhor aumentar a tens√£o. </p><br><p>  Foi determinado que √© necess√°rio ter o hardware: </p><br><ul><li>  Controlador ESP8266 ou seu irm√£o mais velho, o ESP32 (como um m√≥dulo <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">DevKit</a> ). <br></li><li>  Alinhamento dos n√≠veis de sinal para sensores. </li><li>  O regulador de energia √© uma parte de 5 volts do circuito. </li><li>  M√≥dulo de controle de rel√©. </li><li>  Rel√≥gio RTC + mem√≥ria flash para registro. </li><li>  O display LCD de 2 linhas mais simples para exibir os valores atuais dos sensores e o status do dispositivo e do rel√©. </li><li>  V√°rios bot√µes f√≠sicos para controlar o estado do dispositivo sem acesso via web. </li></ul><br><p>  Muitos componentes da lista s√£o vendidos como m√≥dulos para o Arduino e muitos m√≥dulos s√£o compat√≠veis com a l√≥gica 3.3v.  No entanto, eu n√£o queria "congestionar" tudo isso na t√°bua de p√£o com feixes de arame, porque quero ter um belo "dispositivo" bonito.  Sim, e pelo dinheiro dado aos chineses pelos m√≥dulos, voc√™ pode desenhar e encomendar completamente sua placa de circuito impresso individual, e a expectativa de sua chegada ser√° compensada por uma instala√ß√£o relativamente r√°pida e confi√°vel. </p><br><p>  Mais uma vez, observo que esta √© minha primeira experi√™ncia em circuitos e no design do hardware de tais coisas.  Eu tive que estudar muito.  Afinal, na minha especialidade, estou um pouco longe dos microcontroladores.  Mas fazer tudo "de joelhos" n√£o permitiu o esp√≠rito de perfeccionismo que vive em mim. </p><br><h2>  Diagrama de circuito </h2><br><p>  H√° um grande n√∫mero de programas no mercado que permitem desenhar um circuito e uma placa de circuito impresso.  Sem experi√™ncia nesta √°rea, gostei imediatamente do <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">EasyEDA</a> - um editor on-line gratuito que permite pintar um diagrama de circuito, verificar se nada foi esquecido e se todos os componentes t√™m conex√µes, desenhar uma placa de circuito impresso e solicitar imediatamente sua produ√ß√£o. </p><br><p>  A primeira dificuldade que encontrei: existem muitas op√ß√µes para o controlador DevKit ESP8266 ou ESP32, algumas delas diferem na localiza√ß√£o dos pinos e em sua finalidade, e outras at√© em largura.  Foi decidido desenhar o circuito para que fosse poss√≠vel colocar o DevKit de qualquer largura e com qualquer localiza√ß√£o dos terminais, e nas laterais dele - 2 filas de pares de orif√≠cios de jumpers e, posteriormente, cablagem para conectar os terminais necess√°rios, com rela√ß√£o ao controlador adquirido especificamente. </p><br><p>  Coloque sob o controlador e 2 linhas de jumpers emparelhados: JH1 e JH2 no diagrama: </p><br><img src="https://habrastorage.org/webt/mz/a0/nl/mza0nlxbzvfaqjqcti7vc32ikbe.png"><br><p>  A localiza√ß√£o dos pinos da entrada 5v e da sa√≠da 3.3v da fonte de alimenta√ß√£o do estabilizador interno, bem como do GND, pareceu-me a mesma para o DevKit diferente, mas ainda assim decidi jogar pelo seguro e tamb√©m torn√°-los jumpers: JP1, JP2, JP3 no diagrama. </p><br><p>  Decidi assinar os jumpers conectando-os aos componentes do circuito com fun√ß√µes que eles provavelmente executar√£o. </p><br><div class="spoiler">  <b class="spoiler_title">E aqui est√° a apar√™ncia do DevKit ESP8266, que eu finalmente comprei e instalei</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/cg/3p/b5/cg3pb5pg7clju7haw77dah1udhs.png"></div></div><br><p>  Aqui, D1 (GPIO5) e D2 (GPIO4) s√£o respons√°veis ‚Äã‚Äãpelo barramento I2C, D5 (GPIO14) por 1 fio, D6 (GPIO12) - por receber pulsos do sensor de fluxo. </p><br><p>  Diagrama do circuito: </p><br><p> <a href=""><img src="https://habrastorage.org/webt/ar/jj/n3/arjjn3bgb-ffz_yjofhjy72q_cq.png"></a> <br>  (imagem clic√°vel) </p><br><p>  Apesar da presen√ßa a bordo do ESP8266 de um regulador de pot√™ncia embutido para 3.3v, ainda precisamos ter 5 volts para alimentar os sensores e o LCD e 12 volts para alimentar o rel√©.  Decidiu-se fazer a placa alimentar 12 volts e colocar o regulador de tens√£o AMS1117-5.0 na entrada, fornecendo os 5 volts desejados na sa√≠da. </p><br><p>  Para combinar os n√≠veis de sinal no barramento de 1 fio, usei um transistor de efeito de campo BSS138 c com "pull-ups" de tens√£o em ambos os lados. </p><br><img src="https://habrastorage.org/webt/y_/sx/st/y_sxstfcgm3kys4hntq5beb5xby.png"><br><p>  Muito bom sobre a correspond√™ncia de n√≠veis est√° escrito no artigo <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Correspond√™ncia de n√≠veis l√≥gicos de dispositivos 5V e 3.3V</a> . </p><br><p>  Para combinar os n√≠veis de sinal do sensor de fluxo, usei apenas um divisor de tens√£o entre os resistores.  O sensor de fluxo √© simplesmente um dispositivo <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">coletor aberto</a> .  Alguns sensores j√° podem ter um resistor de pull-up embutido, isso deve ser considerado: </p><br><img src="https://habrastorage.org/webt/9v/8e/br/9v8ebrvm_bsfzounu3kamf4grc8.png"><br><p>  Azul no diagrama √© uma designa√ß√£o esquem√°tica do conjunto do sensor de fluxo.  √Ä direita do conector est√£o os divisores de tens√£o selecionados por mim para ter um n√≠vel m√°ximo de 3,3 volts na sa√≠da. </p><br><p>  No barramento I2C, desliguei o rel√≥gio em tempo real DS3231SN e a mem√≥ria flash AT24C256C para armazenar logs.  A mem√≥ria flash incorporada no ESP8266 n√£o √© adequada, pois possui um pequeno n√∫mero de ciclos de reescrita (10 mil versus 1 milh√£o para o AT24Cxxx, de acordo com as fichas t√©cnicas). </p><br><p>  O controle do rel√© √© organizado em v√°rios chips PCF8574AT e ULN2803A. </p><br><img src="https://habrastorage.org/webt/9v/8e/br/9v8ebrvm_bsfzounu3kamf4grc8.png"><br><p>  O primeiro chip √© um expansor de porta de microcontrolador I2C.  O status da sa√≠da ou entrada ativa PCF8574AT √© selecionado selecionando um endere√ßo no barramento I2C. <br>  O chip possui alguns recursos interessantes, bem descritos no artigo <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">expansor de porta I2C PCF8574</a> . </p><br><p>  O chip n√£o pode controlar diretamente a carga (rel√©).  Para isso, √© utilizada uma matriz de transistor ULN2803A.  H√° uma caracter√≠stica: a matriz pode facilmente puxar suas sa√≠das com uma carga para o solo, o que significa que, se uma tens√£o de alimenta√ß√£o for aplicada ao segundo polo do rel√©, a corrente fluir√° atrav√©s do enrolamento do rel√© e os contatos do rel√© fechar√£o.  Infelizmente, com essa inclus√£o, obtemos um efeito colateral: o valor do sinal do controlador √© invertido e todos os rel√©s "clicam" quando o circuito √© ligado.  Ainda n√£o descobri como remover esse recurso. </p><br><p>  Mais informa√ß√µes sobre o chip s√£o descritas <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">aqui</a> . </p><br><p>  O expansor de porta PCF8574AT tamb√©m pode ser usado como entrada: bot√µes de hardware podem ser pendurados em algumas entradas, lendo seus valores no barramento I2C.  No diagrama, os pinos 4-7 podem ser usados ‚Äã‚Äãpara ler o status dos bot√µes.  O principal √© n√£o esquecer de ativar programaticamente o aperto interno das pernas correspondentes para nutri√ß√£o. </p><br><p>  Ao mesmo tempo, deixei a fia√ß√£o na matriz do transistor, caso voc√™ queira repentinamente conectar rel√©s adicionais.  Para poss√≠veis conex√µes, eu trouxe todos os fios para os conectores (mais precisamente, para os orif√≠cios sob eles onde os fios podem ser soldados ou o conector DIP padr√£o de 2,54 mm pode ser soldado). </p><br><p>  O pino do expansor de porta INT pode ser usado para responder rapidamente ao pressionamento de um bot√£o.  Ele pode ser conectado a uma porta livre no controlador e definir o gatilho de interrup√ß√£o para alterar o estado desse pino. </p><br><p>  O visor LCD de duas linhas tamb√©m √© controlado pelo expansor PCF8574AT.  O ponto principal: o monitor √© alimentado por 5 volts, enquanto o pr√≥prio monitor √© controlado pela l√≥gica de 3 volts.  A prop√≥sito, os adaptadores Arduino padr√£o para I2C n√£o s√£o projetados para voltagem dupla.  Eu encontrei a ideia dessa conex√£o em algum lugar da Internet, infelizmente, perdi o link, ent√£o n√£o cito a fonte. </p><br><h2>  Placa de circuito </h2><br><p>  Ao projetar a placa, as pe√ßas comuns com pernas ocupam muito espa√ßo e muitas fichas no design DIP n√£o s√£o f√°ceis de encontrar.  Depois de ler na Internet que a instala√ß√£o SMD n√£o √© t√£o complicada e, com a habilidade adequada, consome ainda menos tempo, decidi projetar a placa para pe√ßas SMD.  E n√£o me enganei.  Era uma placa-m√£e compacta e bonita, onde eu colocava facilmente tudo o que precisava.  As pe√ßas SMD, com um bom ferro de solda, fluxo e solda, se mostraram realmente muito f√°ceis de montar. </p><br><p>  No quadro, adicionei algumas margens quadradas de furos para prototipagem, se de repente eu quiser soldar outra coisa. </p><br><p>  Fiz uma placa de circuito impresso medindo 97x97 mm.  Cabe facilmente em uma caixa el√©trica de corte padr√£o.  Al√©m disso, placas com tamanhos inferiores a 100x100 s√£o baratas de fabricar.  A produ√ß√£o de um lote m√≠nimo de 5 placas, de acordo com o layout desenvolvido, custa 5 d√≥lares, e a entrega na Bielorr√∫ssia custa outros 9 d√≥lares. </p><br><img src="https://habrastorage.org/webt/u9/ov/ou/u9ovouhbfeuadqoixu_je1zjd54.png"><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">O design do quadro</a> est√° no site da EasyEDA e est√° dispon√≠vel para todos. </p><br><p>  Observo que na foto do controlador abaixo aparece a primeira amostra da placa, na qual eu "torci" muitas coisas desnecess√°rias e desnecess√°rias (na esperan√ßa de usar esse lote m√≠nimo de 5 placas em outros projetos).  Aqui e no EasyEDA, publiquei uma vers√£o "limpa" de todas essas coisas desnecess√°rias. </p><br><img src="https://habrastorage.org/webt/vb/jn/p9/vbjnp97xoyff3jde4oeyh2hkvpg.jpeg"><br><div class="spoiler">  <b class="spoiler_title">Fotos dos dois lados do quadro</b> <div class="spoiler_text"><p>  Frente: </p><br><img src="https://habrastorage.org/webt/fs/8_/it/fs8_itdlmt1qredzy8b2h0prk4k.jpeg"><br><p>  Verso: </p><br><img src="https://habrastorage.org/webt/l8/tc/bo/l8tcboqf53vonco7zla9koydq2s.jpeg"></div></div><br><h2>  Parte do software </h2><br>  Para programar o microcontrolador, devido ao atraso na forma de um prot√≥tipo no Arduino Uno, foi decidido usar o ambiente do Arduino com o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">ESP8266 Arduino Core</a> instalado.  Sim, voc√™ pode usar <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Lua</a> no ESP8266, mas eles dizem que h√° travamentos.  Eu, dada a fun√ß√£o cr√≠tica desempenhada, n√£o gostaria de faz√™-lo. <br>  O ambiente do Arduino em si parece um pouco desatualizado para mim, mas, felizmente, h√° uma <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">extens√£o</a> para o Visual Studio do Visual Micro.  O ambiente permite que voc√™ use as dicas de c√≥digo do IntelliSence, salte rapidamente para as declara√ß√µes de fun√ß√µes, refatore o c√≥digo: em geral, tudo o que o ambiente dos computadores "adultos" permite.  A vers√£o paga do Visual Micro tamb√©m permite que voc√™ depure convenientemente o c√≥digo, mas fiquei satisfeito com a op√ß√£o gratuita. <br><h2>  Estrutura do projeto </h2><br>  O projeto consiste nos seguintes arquivos: <br><div class="spoiler">  <b class="spoiler_title">Estrutura do projeto no Visual Studio</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/4i/dn/hu/4idnhu7toeunqk727_fnhcmpl34.png"></div></div><br><table><tbody><tr><th>  Ficheiro </th><th>  Nomea√ß√£o </th></tr><tr><td>  WaterpoolManager.ino <br></td><td>  Declara√ß√£o de vari√°veis ‚Äã‚Äãe constantes b√°sicas.  Inicializa√ß√£o.  La√ßo principal. <br></td></tr><tr><td>  HeaterMainLogic.ino <br></td><td>  A l√≥gica b√°sica do controle do rel√© da caldeira (de acordo com a temperatura) e dos rel√©s auxiliares. <br></td></tr><tr><td>  Sensors.ino <br></td><td>  Ler dados do sensor <br></td></tr><tr><td>  Settings.ino <br></td><td>  Configura√ß√µes do dispositivo, salvando-as na mem√≥ria flash do controlador <br></td></tr><tr><td>  LCD.ino <br></td><td>  Sa√≠da de informa√ß√µes no LCD <br></td></tr><tr><td>  ClockTimer.ino <br></td><td>  Leitura de rel√≥gio RTC ou simula√ß√£o de rel√≥gio <br></td></tr><tr><td>  Relays.ino <br></td><td>  Controle de rel√© on / off <br></td></tr><tr><td>  ButtonLogic.ino <br></td><td>  L√≥gica de rea√ß√£o ao estado dos bot√µes de hardware <br></td></tr><tr><td>  ReadButtonStates.ino <br></td><td>  Ler estados dos bot√µes de hardware <br></td></tr><tr><td>  EEPROM_Logging.ino <br></td><td>  Registro de dados do sensor na EEPROM <br></td></tr><tr><td>  WebServer.ino <br></td><td>  Servidor web incorporado para gerenciamento de dispositivos e exibi√ß√£o de status <br></td></tr><tr><td>  <b>P√°ginas da Web</b> <br></td><td>  As p√°ginas do servidor da Web s√£o armazenadas nesta pasta. <br></td></tr><tr><td>  index.h <br></td><td>  A p√°gina principal para exibir o status do dispositivo.  Lendo o estado atual com chamada ajax.  Atualize a cada 5 segundos. <br></td></tr><tr><td>  loggraph.h <br></td><td>  Exibe um log de dados do sensor e estados de retransmiss√£o em um gr√°fico.  A biblioteca jqPlot √© usada - toda a constru√ß√£o ocorre no lado do cliente.  A solicita√ß√£o para o controlador vai apenas para um arquivo bin√°rio - c√≥pias de dados da EEPROM. <br></td></tr><tr><td>  logtable.h <br></td><td>  tamb√©m, mas na forma de uma tabela <br></td></tr><tr><td>  settings.h <br></td><td>  Gerenciando configura√ß√µes do dispositivo: definindo limites para temperatura, fluxo de √°gua, frequ√™ncia do registro de dados <br></td></tr><tr><td>  time.h <br></td><td>  Configura√ß√£o da hora atual <br></td></tr><tr><td><br></td><td>  <b>Bibliotecas</b> <br></td></tr><tr><td>  EepromLogger.cpp <br></td><td>  Biblioteca de Logs Flash <br></td></tr><tr><td>  EepromLogger.h <br></td></tr><tr><td>  crc8.cpp <br></td><td>  8- CRC   <br></td></tr><tr><td> crc8.h <br></td></tr><tr><td> TimeSpan.cpp <br></td><td>      <br></td></tr><tr><td> TimeSpan.h <br></td></tr></tbody></table><br><h2>   </h2><br><p>          OneWire       tempSensAddr.              .       (    4    ): </p><br><pre><code class="hljs powershell"><span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (ds.search(tempSensAddr[<span class="hljs-type"><span class="hljs-type">lastSensorIndex</span></span>]) &amp;&amp; lastSensorIndex &lt; <span class="hljs-number"><span class="hljs-number">4</span></span>) { Serial.print(<span class="hljs-string"><span class="hljs-string">"ROM ="</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (byte i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; <span class="hljs-number"><span class="hljs-number">8</span></span>; i++) { Serial.print(<span class="hljs-string"><span class="hljs-string">' '</span></span>); Serial.print(tempSensAddr[<span class="hljs-type"><span class="hljs-type">lastSensorIndex</span></span>][<span class="hljs-type"><span class="hljs-type">i</span></span>], HEX); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (OneWire::crc8(tempSensAddr[<span class="hljs-type"><span class="hljs-type">lastSensorIndex</span></span>], <span class="hljs-number"><span class="hljs-number">7</span></span>) != tempSensAddr[<span class="hljs-type"><span class="hljs-type">lastSensorIndex</span></span>][<span class="hljs-number"><span class="hljs-number">7</span></span>]) { Serial.print(<span class="hljs-string"><span class="hljs-string">" CRC is not valid!"</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> lastSensorIndex++; Serial.println(); } ds.reset_search(); lastSensorIndex--; Serial.print(<span class="hljs-string"><span class="hljs-string">"\r\nTemperature sensor count: "</span></span>); Serial.print(lastSensorIndex + <span class="hljs-number"><span class="hljs-number">1</span></span>, DEC);  ,       ().       Serial   LCD  : // Read sensor values and print temperatures ds.reset(); ds.write(<span class="hljs-number"><span class="hljs-number">0</span></span>xCC, TEMP_SENSOR_POWER_MODE); // Request all sensors at the one time ds.write(<span class="hljs-number"><span class="hljs-number">0</span></span>x44, TEMP_SENSOR_POWER_MODE); // Acquire temperatures delay(<span class="hljs-number"><span class="hljs-number">1000</span></span>); // Delay is required by temp. sensors char tempString[<span class="hljs-number"><span class="hljs-number">10</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (byte addr = <span class="hljs-number"><span class="hljs-number">0</span></span>; addr &lt;= lastSensorIndex; addr++) { ds.reset(); ds.select(tempSensAddr[<span class="hljs-type"><span class="hljs-type">addr</span></span>]); ds.write(<span class="hljs-number"><span class="hljs-number">0</span></span>xBE, TEMP_SENSOR_POWER_MODE); // Read Scratchpad tempData[<span class="hljs-type"><span class="hljs-type">addr</span></span>] = ds.read() | (ds.read() &lt;&lt; <span class="hljs-number"><span class="hljs-number">8</span></span>); // Read first <span class="hljs-number"><span class="hljs-number">2</span></span> bytes which carry temperature <span class="hljs-keyword"><span class="hljs-keyword">data</span></span> int tempInCelsius = (tempData[<span class="hljs-type"><span class="hljs-type">addr</span></span>] + <span class="hljs-number"><span class="hljs-number">8</span></span>) &gt;&gt; <span class="hljs-number"><span class="hljs-number">4</span></span>; // <span class="hljs-keyword"><span class="hljs-keyword">In</span></span> celsius, with math rounding Serial.print(tempInCelsius, DEC); // Print temperature Serial.println(<span class="hljs-string"><span class="hljs-string">" C"</span></span>); }</code> </pre> <br><p>  De acordo com a folha de dados, os sensores requerem um atraso de pelo menos 750 ms entre solicitar um valor de temperatura e receber uma resposta do sensor.  Portanto, o c√≥digo introduziu um atraso com uma pequena margem. </p><br><p>  No entanto, esse atraso, quando todo o dispositivo est√° apenas aguardando uma resposta, √© aceit√°vel no in√≠cio, mas √© absolutamente inapropriado esperar sempre com a pesquisa regular dos sensores.  Portanto, o seguinte c√≥digo complicado foi escrito, chamado a cada 50 ms por timer: </p><br><pre> <code class="hljs lua">#define TEMP_MEASURE_PERIOD <span class="hljs-number"><span class="hljs-number">20</span></span> // Time of measuring, * TEMP_TIMER_PERIODICITY ms #define TEMP_TIMER_PERIODICITY <span class="hljs-number"><span class="hljs-number">50</span></span> // Periodicity of timer calling, ms timer.attach_ms(TEMP_TIMER_PERIODICITY, tempReadTimer); int tempMeasureCycleCount = <span class="hljs-number"><span class="hljs-number">0</span></span>; void tempReadTimer() // Called many times <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> second, perform only one small operation per call { tempMeasureCycleCount++; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (tempMeasureCycleCount &gt;= TEMP_MEASURE_PERIOD) { tempMeasureCycleCount = <span class="hljs-number"><span class="hljs-number">0</span></span>; // Start cycle again } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (tempMeasureCycleCount == <span class="hljs-number"><span class="hljs-number">0</span></span>) { ds.reset(); ds.<span class="hljs-built_in"><span class="hljs-built_in">write</span></span>(<span class="hljs-number"><span class="hljs-number">0xCC</span></span>, TEMP_SENSOR_POWER_MODE); // Request all sensors at the one <span class="hljs-built_in"><span class="hljs-built_in">time</span></span> ds.<span class="hljs-built_in"><span class="hljs-built_in">write</span></span>(<span class="hljs-number"><span class="hljs-number">0x44</span></span>, TEMP_SENSOR_POWER_MODE); // Acquire temperatures } // Between phases above <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> below should be &gt; <span class="hljs-number"><span class="hljs-number">750</span></span> ms int addr = TEMP_MEASURE_PERIOD - tempMeasureCycleCount - <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (addr &gt;= <span class="hljs-number"><span class="hljs-number">0</span></span> &amp;&amp; addr &lt;= lastSensorIndex) { ds.reset(); ds.<span class="hljs-built_in"><span class="hljs-built_in">select</span></span>(tempSensAddr[addr]); ds.<span class="hljs-built_in"><span class="hljs-built_in">write</span></span>(<span class="hljs-number"><span class="hljs-number">0xBE</span></span>, TEMP_SENSOR_POWER_MODE); // Read Scratchpad tempData[addr] = ds.<span class="hljs-built_in"><span class="hljs-built_in">read</span></span>() | (ds.<span class="hljs-built_in"><span class="hljs-built_in">read</span></span>() &lt;&lt; <span class="hljs-number"><span class="hljs-number">8</span></span>); // Read first <span class="hljs-number"><span class="hljs-number">2</span></span> bytes which carry temperature data } }</code> </pre> <br><p>  No in√≠cio de cada ciclo tempMeasureCycleCount, os sensores s√£o solicitados a ler seus valores.  Ap√≥s a passagem de cerca de 50 desses ciclos (e no total s√£o 50 * 20 = 1000 ms = 1 s), o valor de cada sensor √© lido, um de cada vez.  Todo o trabalho √© dividido em peda√ßos para que o c√≥digo executado na interrup√ß√£o do timer n√£o demore muito tempo no controlador. </p><br><p>  O valor do sensor de fluxo √© calculado da seguinte forma.  Ao interromper o pino no qual o sensor est√° pendurado, aumentamos o valor do contador de carrapatos provenientes do sensor de fluxo: </p><br><pre> <code class="hljs pgsql">pinMode(FLOW_SENSOR_PIN, <span class="hljs-keyword"><span class="hljs-keyword">INPUT</span></span>); attachInterrupt(digitalPinToInterrupt(FLOW_SENSOR_PIN), flow, RISING); // Setup Interrupt <span class="hljs-keyword"><span class="hljs-keyword">volatile</span></span> <span class="hljs-type"><span class="hljs-type">int</span></span> flow_frequency; // Flow sensor pulses <span class="hljs-type"><span class="hljs-type">int</span></span> flowMeasureCycleCount = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-type"><span class="hljs-type">void</span></span> flow() // Flow sensor interrupt <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> { flow_frequency++; }</code> </pre> <br><p>  No mesmo cron√¥metro em que os sensores de temperatura s√£o pesquisados, uma vez por segundo, pegamos esse valor de escala e o convertemos em litros usando a constante FLOW_SENSOR_CONST, cujo valor pode ser encontrado nas caracter√≠sticas do sensor: </p><br><pre> <code class="hljs pgsql">flowMeasureCycleCount++; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (flowMeasureCycleCount &gt;= <span class="hljs-number"><span class="hljs-number">1000</span></span> / TEMP_TIMER_PERIODICITY) { flowMeasureCycleCount = <span class="hljs-number"><span class="hljs-number">0</span></span>; litersInMinute = (flow_frequency / FLOW_SENSOR_CONST); // Pulse frequency (Hz) = FLOW_SENSOR_CONST*Q, Q <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> flow rate <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> L/min. flow_frequency = <span class="hljs-number"><span class="hljs-number">0</span></span>; // <span class="hljs-keyword"><span class="hljs-keyword">Reset</span></span> Counter }</code> </pre> <br><h2>  Registrando dados de sensores e status do dispositivo </h2><br><p>  No desenvolvimento do mecanismo de registro, o fato de o dispositivo poder ser desligado repentinamente, ou seja,  em quase qualquer momento.  Quando voc√™ para de gravar, devemos restaurar tudo o que foi gravado at√© o √∫ltimo momento.  Ao mesmo tempo, n√£o podemos reescrever constantemente a mesma √°rea da mem√≥ria flash (por exemplo, um determinado t√≠tulo em um determinado local, lembrando o endere√ßo da √∫ltima grava√ß√£o), para evitar a "limpeza" acelerada da unidade flash nesse local. </p><br><p>  Ap√≥s alguma ‚Äúacumula√ß√£o‚Äù, o seguinte modelo de grava√ß√£o foi inventado e implementado: </p><br><img src="https://habrastorage.org/webt/ue/zv/vg/uezvvgglwxhvsvn5uhdmkiic8ju.png"><br><p>  Cada registro √© um registro que cont√©m informa√ß√µes sobre o valor atual do fluxo de √°gua, as temperaturas do sensor e o status do dispositivo codificado no byte (bits individuais indicam se o rel√© est√° ligado ou n√£o, se o aquecimento est√° ativado ou n√£o): </p><br><pre> <code class="hljs cpp"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">LogEvent</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> litersInMinute = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> tempCelsius[<span class="hljs-number"><span class="hljs-number">4</span></span>]{ <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span> }; <span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> deviceStatus = <span class="hljs-number"><span class="hljs-number">0</span></span>; }</code> </pre> <br><p>  Ap√≥s cada registro, h√° um byte de soma de verifica√ß√£o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">CRC</a> , indicando se o registro foi gravado corretamente e, em geral, se pelo menos algo foi gravado nesse local de mem√≥ria. </p><br><p>  Como seria muito caro registrar dados no hor√°rio atual ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">registro de data</a> e <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">hora</a> ) para cada registro em termos de volume, os dados s√£o organizados em grandes blocos, com N registros em cada um.  O registro de data e hora de cada bloco √© registrado apenas uma vez, para o restante - √© calculado com base em informa√ß√µes sobre a frequ√™ncia do registro. </p><br><pre> <code class="hljs vhdl"><span class="hljs-built_in"><span class="hljs-built_in">unsigned</span></span> int logRecordsInBlock = <span class="hljs-number"><span class="hljs-number">60</span></span> * <span class="hljs-number"><span class="hljs-number">60</span></span> / loggingPeriodSeconds; // <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">block</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> hour <span class="hljs-built_in"><span class="hljs-built_in">unsigned</span></span> int block_size = sizeof(Block_Header) + logRecordsInBlock * (record_size + crcSize); <span class="hljs-built_in"><span class="hljs-built_in">unsigned</span></span> int block_count = total_storage_size / block_size;</code> </pre> <br><p>  Por exemplo, com uma frequ√™ncia de registro de uma vez a cada 30 segundos, teremos 120 entradas em um bloco e o tamanho do bloco ser√° de cerca de 840 bytes.  No total, podemos encaixar 39 blocos na mem√≥ria de uma unidade flash de 32 kilobytes de tamanho.  Com essa organiza√ß√£o, verifica-se que cada bloco inicia em um endere√ßo estritamente definido na mem√≥ria, e ‚Äúpercorrer‚Äù todos os blocos n√£o √© um problema. </p><br><p>  Dessa forma, com uma interrup√ß√£o repentina no registro durante o √∫ltimo desligamento do dispositivo, teremos um bloco inacabado (ou seja, no qual alguns dos registros est√£o ausentes).  Quando o dispositivo est√° ligado, o algoritmo procura o √∫ltimo cabe√ßalho de bloco v√°lido (timestamp + crc).  E continua a gravar, come√ßando no pr√≥ximo bloco.  A grava√ß√£o √© realizada ciclicamente: o √∫ltimo bloco substitui os dados do bloco mais antigo. </p><br><p>  Ao ler, todos os blocos s√£o lidos sequencialmente.  Blocos inv√°lidos (aqueles que n√£o passam no CRC para registro de data e hora) s√£o totalmente ignorados.  Os registros em cada bloco s√£o lidos at√© a reuni√£o do primeiro registro inv√°lido (ou seja, aquele em que a grava√ß√£o foi cortada pela √∫ltima vez se o bloco n√£o tiver sido gravado inteiramente).  O resto √© ignorado. <br>  Para cada registro, o tempo atual √© calculado com base no registro de data e hora do bloco e no n√∫mero de s√©rie do registro no bloco. </p><br><h2>  LCD </h2><br><p>  O dispositivo usa um display QC1602A, capaz de exibir 2 linhas de 16 caracteres.  A primeira linha exibe as informa√ß√µes atuais sobre os valores atuais dos sensores: vaz√£o e temperaturas.  Se o limite especificado for excedido, um ponto de exclama√ß√£o aparecer√° pr√≥ximo ao valor.  A segunda linha mostra o status do rel√© de aquecimento e da bomba, bem como o tempo decorrido desde que o aquecimento foi ligado ou desligado.  A cada 5 segundos, o display na segunda linha mostra brevemente os limites atuais.  As fotos da exibi√ß√£o em v√°rios modos s√£o mostradas no final da publica√ß√£o. </p><br><h2>  Gr√°ficos </h2><br><p>  Quando solicitado pelo servidor da web interno, os dados de log s√£o lidos em formato bin√°rio usando JavaScript: </p><br><pre> <code class="hljs javascript"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> xhttp = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> XMLHttpRequest(); xhttp.open(<span class="hljs-string"><span class="hljs-string">"GET"</span></span>, <span class="hljs-string"><span class="hljs-string">"logs.bin"</span></span>, <span class="hljs-literal"><span class="hljs-literal">true</span></span>); xhttp.responseType = <span class="hljs-string"><span class="hljs-string">"arraybuffer"</span></span>; xhttp.onprogress = updateProgress; xhttp.onload = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">oEvent</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> arrayBuffer = xhttp.response; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (arrayBuffer) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> byteArray = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Uint8Array</span></span>(arrayBuffer); ‚Ä¶ }}; xhttp.send(<span class="hljs-literal"><span class="hljs-literal">null</span></span>);</code> </pre> <br><p>  L√™-los em algum formato n√£o-bin√°rio popular, como o ajax, seria um luxo inadmiss√≠vel para o controlador, principalmente por causa da grande quantidade que o servidor http interno teria que retornar. </p><br><p>  Pelo mesmo motivo, a biblioteca JavaScript <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">jqPlot</a> √© usada para construir gr√°ficos e os pr√≥prios arquivos da biblioteca JS s√£o carregados a partir de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">CDNs</a> populares. </p><br><p>  Um exemplo da programa√ß√£o do dispositivo: </p><br><img src="https://habrastorage.org/webt/uh/kr/bc/uhkrbccsl1k8l6w_3am6tunwe5a.png"><br><p>  V√™-se claramente que, por volta das 9:35, o dispositivo foi ligado para aquecimento, a caldeira come√ßou a aquecer gradualmente o circuito de aquecimento (sensores T3, T4), ap√≥s o que a temperatura do circuito da piscina come√ßou a aumentar (sensores T1, T2).  Por volta das 10:20, a caldeira passou a aquecer √°gua quente em casa, a temperatura do circuito de aquecimento caiu.  Depois de mais 10 minutos, a caldeira voltou a aquecer a √°gua da piscina.  √Äs 10:50 ocorreu um acidente: a bomba de circula√ß√£o de √°gua na piscina foi desligada de repente.  O fluxo de √°gua caiu acentuadamente para zero, o rel√© de aquecimento desligado (linha pontilhada vermelha na 2¬™ tabela), impedindo o superaquecimento.  Mas o dispositivo ainda permaneceu em um estado de aquecimento (linha vermelha no 2¬∫ gr√°fico).  I.e.  se a bomba fosse ligada novamente e as temperaturas estivessem normais, o dispositivo retornaria ao aquecimento.  Observo que ap√≥s uma parada de emerg√™ncia da bomba, as temperaturas no circuito de √°gua da piscina (T1, T2) come√ßaram a aumentar acentuadamente devido ao superaquecimento do trocador de calor.  E se n√£o fosse por um desligamento acentuado da caldeira, haveria problemas. </p><br><h2>  Servidor da Web incorporado </h2><br><p>  Para se comunicar com o mundo exterior, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">√© usada a</a> classe padr√£o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">ESP8266WebServer</a> .  Quando o dispositivo √© iniciado, ele √© inicializado como um ponto de acesso com a senha padr√£o especificada em #define AP_PASS.  Uma p√°gina da web √© aberta automaticamente para selecionar uma rede wi-fi dispon√≠vel e inserir uma senha.  Ap√≥s digitar a senha, o dispositivo reinicia e se conecta ao ponto de acesso especificado. </p><br><h2>  Dispositivo acabado </h2><br><p>  O dispositivo acabado foi colocado em uma caixa de corte padr√£o para a fia√ß√£o.  Um orif√≠cio para o LCD foi cortado e orif√≠cios para os conectores. </p><br><img src="https://habrastorage.org/webt/dz/si/tx/dzsitx4tim2kcxqnticd7ln2vho.jpeg"><br><div class="spoiler">  <b class="spoiler_title">Fotos da fachada do dispositivo em diferentes modos</b> <div class="spoiler_text"><p>  Com a exibi√ß√£o do tempo decorrido ap√≥s a ativa√ß√£o: </p><br><img src="https://habrastorage.org/webt/fh/gn/fn/fhgnfnf-emu1rl31w7bm4fbmmvs.jpeg"><br><p>  Com os limites exibidos: </p><br><img src="https://habrastorage.org/webt/qi/8c/r2/qi8cr2ex8uwr3e9xgzs5ms__vou.jpeg"></div></div><br><h2>  Conclus√£o </h2><br><p>  Concluindo, quero dizer que, ao desenvolver um dispositivo como esse, adquiri grande experi√™ncia com circuitos, design de PCB, habilidades de instala√ß√£o de componentes SMD, na arquitetura e programa√ß√£o de microcontroladores, lembrei-me de C ++ quase esquecido e manuseio cuidadoso da mem√≥ria e outros recursos limitados do controlador.  O conhecimento de HTML5, JavaScript e habilidades de depura√ß√£o de scripts no navegador tamb√©m foram √∫teis em certa medida. </p><br><p>  Essas habilidades e o prazer recebido durante o desenvolvimento do dispositivo s√£o os principais benef√≠cios obtidos.  E os c√≥digos-fonte do dispositivo, diagrama de circuito, placas de circuito impresso - use, modifique.  Todos os <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">c√≥digos-fonte do projeto</a> est√£o no GitHab.  Hardware em um <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">projeto p√∫blico</a> no EasyEDA.  Coletei dados sobre os chips usados ‚Äã‚Äãno projeto em uma <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">unidade de rede</a> . </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt413955/">https://habr.com/ru/post/pt413955/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt413945/index.html">Mais f√°cil do que parece. Cap√≠tulos 4-5</a></li>
<li><a href="../pt413947/index.html">Implementa√ß√£o do trabalho com o servidor Long Poll no cliente VKontakte para Sailfish OS</a></li>
<li><a href="../pt413949/index.html">Por que ainda estamos lendo livros em papel?</a></li>
<li><a href="../pt413951/index.html">Ensine os outros a se tornarem melhores programadores</a></li>
<li><a href="../pt413953/index.html">Quando e por que vale a pena usar as fun√ß√µes de seta ES6 e quando n√£o</a></li>
<li><a href="../pt413957/index.html">Um exemplo de cria√ß√£o de um aplicativo esportivo em tempo real no Node.js</a></li>
<li><a href="../pt413959/index.html">Menor imagem do Docker - Menos de 1000 bytes</a></li>
<li><a href="../pt413963/index.html">Mini CRM para pequenas empresas</a></li>
<li><a href="../pt413965/index.html">Revis√£o de c√≥digo: voc√™ est√° fazendo errado</a></li>
<li><a href="../pt413967/index.html">Engenharia Reversa no Modo Desenvolvedor Animal Crossing</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>