<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🔋 👺 🙋🏿 Copias de seguridad con estado en Kubernetes 👨‍✈️ 🚢 👨🏽‍🏫</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Entonces, como todos saben con certeza, más recientemente DevOpsConfRussia2018 se celebró en Moscú en "Infraspace" el 1 y 2 de octubre. Para aquellos ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Copias de seguridad con estado en Kubernetes</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/nixys/blog/426543/"><p>  Entonces, como todos saben con certeza, más recientemente <b>DevOpsConfRussia2018</b> se celebró en Moscú en "Infraspace" el 1 y 2 de octubre.  Para aquellos que no se <b>sienten cómodos</b> , <b>DevOpsConf</b> es una conferencia profesional sobre la integración de procesos de desarrollo, prueba y operación. </p><br><p>  Nuestra empresa también participó en esta conferencia.  Éramos sus socios, representando a la compañía en nuestro stand, y también celebramos una pequeña reunión.  Por cierto, esta fue nuestra primera participación en este tipo de actividad.  La primera conferencia, el primer mitap, la primera experiencia. </p><br><p>  ¿De qué hablamos?  Mitap fue sobre el tema "Copias de seguridad en Kubernetes". </p><br><p>  Lo más probable es que escuchen este nombre, muchos dirán: “¿Por qué respaldar a Kubernetes?  No necesita ser respaldado, es apátrida ". </p><br><p><img src="https://habrastorage.org/webt/t7/qd/uy/t7qduyxlblaljfdfs_tduggq0w8.png"></p><a name="habracut"></a><br><h3>  Introducción ... </h3><br><p>  Comencemos con un poco de historia.  ¿Por qué se hizo necesario cubrir este tema y por qué es necesario? </p><br><p>  En 2016, nos familiarizamos con una tecnología como Kubernetes y comenzamos a aplicarla activamente a nuestros proyectos.  Por supuesto, estos son principalmente proyectos con arquitectura de microservicio, y esto a su vez implica el uso de una gran cantidad de software diverso. </p><br><p>  Con el primer proyecto en el que utilizamos Kubernetes, teníamos una pregunta sobre cómo hacer una copia de seguridad de los servicios de Stateful ubicados allí, que a veces por alguna razón u otra caen en k8. </p><br><p>  Comenzamos a estudiar y buscar prácticas existentes para resolver este problema.  Comuníquese con nuestros colegas y camaradas: "¿Y cómo llevan a cabo y construyen este proceso?" </p><br><p>  Después de hablar, nos dimos cuenta de que todo esto sucede por diferentes métodos, medios y con una gran cantidad de muletas.  Sin embargo, no seguimos ningún enfoque unificado, incluso <u>dentro del marco de un proyecto</u> . </p><br><p>  ¿Por qué es esto tan importante?  Dado que nuestra empresa presta servicios a proyectos basados ​​en k8, solo necesitábamos desarrollar una metodología estructurada para resolver este problema. </p><br><p>  Imagine que está trabajando con un proyecto específico en Coober.  Contiene algunos servicios con estado y necesita hacer una copia de seguridad de sus datos.  En principio, aquí puedes hacer un par de muletas y olvidarte de eso.  Pero, ¿y si ya tienes dos proyectos en k8s?  Y el segundo proyecto utiliza servicios completamente diferentes en su trabajo.  ¿Y si ya hay cinco proyectos?  Diez?  ¿O más de veinte? </p><br><p>  Por supuesto, ponerse muletas ya es difícil e inconveniente.  Necesitamos algún tipo de enfoque unificado que pueda usarse al trabajar con muchos proyectos en Cuba, y al mismo tiempo, para que el equipo de ingenieros pueda hacer los cambios necesarios en las copias de respaldo de estos proyectos de manera fácil y literal en cuestión de minutos. </p><br><p>  En el marco de este artículo, solo hablaremos sobre qué herramienta y qué práctica usamos para resolver este problema dentro de nuestra empresa. </p><br><h3>  ¿Cómo lo estamos haciendo? </h3><br><h6>  Nxs-backup, ¿qué es? </h6><br><p>  Para las copias de seguridad, utilizamos nuestra propia herramienta de código abierto: nxs-backup.  No entraremos en detalles de lo que pueda.  Más detalles se pueden encontrar en el siguiente <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">enlace</a> . </p><br><p> Ahora pasemos a la implementación de copias de seguridad en k8s.  Cómo y qué fue exactamente lo que hicimos nosotros. </p><br><h3>  ¿Qué es el respaldo? </h3><br><p>  Veamos un ejemplo de copia de seguridad de nuestra propia Redmine.  En él, haremos una copia de seguridad de la base de datos MySQL y los archivos de proyecto del usuario. </p><br><h3>  ¿Cómo hacemos esto? </h3><br><h6>  1 CronJob == 1 Servicio </h6><br><p>  En servidores comunes y clústeres en hardware, casi todas las herramientas de respaldo se lanzan principalmente a través de cron regular.  En k8s, para este propósito usamos CronJob's, es decir, creamos 1 CronJob para 1 servicio, del cual realizaremos una copia de seguridad.  Todos estos CronJob s se encuentran en el mismo espacio de nombres que el servicio en sí. </p><br><p>  Comencemos con la base de datos MySQL.  Para respaldar MySQL, necesitamos 4 elementos, como para casi cualquier otro servicio: </p><br><ul><li>  ConfigMap (nxs-backup.conf) </li><li>  ConfigMap (mysql.conf para nxs-backup) </li><li>  Secreto (los accesos al servicio se almacenan aquí, en este caso MySQL).  Por lo general, este elemento ya está definido para que el servicio funcione y se puede reutilizar. </li><li>  CronJob (para cada servicio propio) </li></ul><br><p>  Vamos en orden. </p><br><h6>  nxs-backup.conf </h6><br><pre><code class="hljs sql">apiVersion: v1 kind: ConfigMap metadata: name: nxs-<span class="hljs-keyword"><span class="hljs-keyword">backup</span></span>-conf <span class="hljs-keyword"><span class="hljs-keyword">data</span></span>: nxs-backup.conf: |- <span class="hljs-keyword"><span class="hljs-keyword">main</span></span>: server_name: Nixys k8s cluster admin_mail: admins@nixys.ru client_mail: - <span class="hljs-string"><span class="hljs-string">''</span></span> mail_from: <span class="hljs-keyword"><span class="hljs-keyword">backup</span></span>@nixys.ru level_message: <span class="hljs-keyword"><span class="hljs-keyword">error</span></span> block_io_read: <span class="hljs-string"><span class="hljs-string">''</span></span> block_io_write: <span class="hljs-string"><span class="hljs-string">''</span></span> blkio_weight: <span class="hljs-string"><span class="hljs-string">''</span></span> general_path_to_all_tmp_dir: /<span class="hljs-keyword"><span class="hljs-keyword">var</span></span>/nxs-<span class="hljs-keyword"><span class="hljs-keyword">backup</span></span> cpu_shares: <span class="hljs-string"><span class="hljs-string">''</span></span> log_file: /dev/stdout jobs: !<span class="hljs-keyword"><span class="hljs-keyword">include</span></span> [conf.d<span class="hljs-comment"><span class="hljs-comment">/*.conf]</span></span></code> </pre> <br><p>  Aquí establecemos los parámetros básicos que se pasan a nuestra herramienta, que son necesarios para su funcionamiento.  Este es el nombre del servidor, correo electrónico para notificaciones, restricción en el consumo de recursos y otros parámetros. </p><br><p>  Las configuraciones se pueden especificar en formato j2, lo que permite el uso de variables de entorno. </p><br><h6>  mysql.conf </h6><br><pre> <code class="hljs sql">apiVersion: v1 kind: ConfigMap metadata: name: mysql-conf data: service.conf.j2: |- - job: mysql type: mysql tmp_dir: /var/nxs-<span class="hljs-keyword"><span class="hljs-keyword">backup</span></span>/<span class="hljs-keyword"><span class="hljs-keyword">databases</span></span>/mysql/dump_tmp sources: - <span class="hljs-keyword"><span class="hljs-keyword">connect</span></span>: db_host: {{ db_host }} db_port: {{ db_port }} socket: <span class="hljs-string"><span class="hljs-string">''</span></span> db_user: {{ db_user }} db_password: {{ db_password }} target: - redmine_db gzip: yes is_slave: <span class="hljs-keyword"><span class="hljs-keyword">no</span></span> extra_keys: <span class="hljs-string"><span class="hljs-string">'--opt --add-drop-database --routines --comments --create-options --quote-names --order-by-primary --hex-blob'</span></span> storages: - <span class="hljs-keyword"><span class="hljs-keyword">storage</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> <span class="hljs-keyword"><span class="hljs-keyword">enable</span></span>: yes backup_dir: /<span class="hljs-keyword"><span class="hljs-keyword">var</span></span>/nxs-<span class="hljs-keyword"><span class="hljs-keyword">backup</span></span>/<span class="hljs-keyword"><span class="hljs-keyword">databases</span></span>/mysql/dump <span class="hljs-keyword"><span class="hljs-keyword">store</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">days</span></span>: <span class="hljs-number"><span class="hljs-number">6</span></span> weeks: <span class="hljs-number"><span class="hljs-number">4</span></span> <span class="hljs-keyword"><span class="hljs-keyword">month</span></span>: <span class="hljs-number"><span class="hljs-number">6</span></span></code> </pre> <br><p>  Este archivo describe la lógica de respaldo para el servicio correspondiente, en nuestro caso es MySQL. </p><br><p>  Aquí puedes especificar: </p><br><ul><li>  ¿Cuál es el nombre del trabajo (campo: trabajo) </li><li>  Tipo de trabajo (campo: tipo) </li><li>  El directorio temporal necesario para recopilar copias de seguridad (campo: tmp_dir) </li><li>  Opciones de conexión de MySQL (campo: conectar) </li><li>  Base de datos a respaldar (campo: destino) </li><li>  Necesita detener Slave antes de recolectar (campo: is_slave) </li><li>  Teclas adicionales para mysqldump (campo: extra_keys) </li><li>  Almacenamiento almacenamiento, es decir, en qué almacenamiento almacenaremos una copia (campo: almacenamiento) </li><li>  El directorio donde almacenaremos nuestras copias (campo: backup_dir) </li><li>  Esquema de almacenamiento (campo: tienda) </li></ul><br><p>  En nuestro ejemplo, el tipo de almacenamiento se establece en local, es decir, recopilamos y almacenamos copias de seguridad localmente en un directorio específico del pod lanzado. </p><br><p>  Aquí, por analogía con este archivo de configuración, puede especificar los mismos archivos de configuración para Redis, PostgreSQL o cualquier otro servicio necesario, si es compatible con nuestra herramienta.  El hecho de que es compatible se puede encontrar en el enlace proporcionado anteriormente. </p><br><h6>  Mysql secreto </h6><br><pre> <code class="hljs powershell">apiVersion: v1 kind: Secret metadata: name: app<span class="hljs-literal"><span class="hljs-literal">-config</span></span> <span class="hljs-keyword"><span class="hljs-keyword">data</span></span>: db_name: <span class="hljs-string"><span class="hljs-string">""</span></span> db_host: <span class="hljs-string"><span class="hljs-string">""</span></span> db_user: <span class="hljs-string"><span class="hljs-string">""</span></span> db_password: <span class="hljs-string"><span class="hljs-string">""</span></span> secret_token: <span class="hljs-string"><span class="hljs-string">""</span></span> smtp_address: <span class="hljs-string"><span class="hljs-string">""</span></span> smtp_domain: <span class="hljs-string"><span class="hljs-string">""</span></span> smtp_ssl: <span class="hljs-string"><span class="hljs-string">""</span></span> smtp_enable_starttls_auto: <span class="hljs-string"><span class="hljs-string">""</span></span> smtp_port: <span class="hljs-string"><span class="hljs-string">""</span></span> smtp_auth_type: <span class="hljs-string"><span class="hljs-string">""</span></span> smtp_login: <span class="hljs-string"><span class="hljs-string">""</span></span> smtp_password: <span class="hljs-string"><span class="hljs-string">""</span></span></code> </pre> <br><p>  Mantenemos acceso secreto para conectarse a MySQL y al servidor de correo.  Se pueden almacenar en un secreto separado o aprovechar el existente, por supuesto, si es así.  Nada interesante aquí  Nuestro secreto también contiene el secret_token, que es necesario para el funcionamiento de nuestra Redmine. </p><br><h6>  CronJob MySQL </h6><br><pre> <code class="hljs pgsql">apiVersion: batch/v1beta1 kind: CronJob metadata: <span class="hljs-type"><span class="hljs-type">name</span></span>: mysql spec: schedule: "00 00 * * *" jobTemplate: spec: <span class="hljs-keyword"><span class="hljs-keyword">template</span></span>: spec: affinity: nodeAffinity: requiredDuringSchedulingIgnoredDuringExecution: nodeSelectorTerms: - matchExpressions: - key: kubernetes.io/hostname <span class="hljs-keyword"><span class="hljs-keyword">operator</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">In</span></span> <span class="hljs-keyword"><span class="hljs-keyword">values</span></span>: - nxs-node5 containers: - <span class="hljs-type"><span class="hljs-type">name</span></span>: mysql-backup image: nixyslab/nxs-backup:latest env: - <span class="hljs-type"><span class="hljs-type">name</span></span>: DB_HOST valueFrom: secretKeyRef: <span class="hljs-type"><span class="hljs-type">name</span></span>: app-config key: db_host - <span class="hljs-type"><span class="hljs-type">name</span></span>: DB_PORT <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>: <span class="hljs-string"><span class="hljs-string">'3306'</span></span> - <span class="hljs-type"><span class="hljs-type">name</span></span>: DB_USER valueFrom: secretKeyRef: <span class="hljs-type"><span class="hljs-type">name</span></span>: app-config key: db_user - <span class="hljs-type"><span class="hljs-type">name</span></span>: DB_PASSWORD valueFrom: secretKeyRef: <span class="hljs-type"><span class="hljs-type">name</span></span>: app-config key: db_password - <span class="hljs-type"><span class="hljs-type">name</span></span>: SMTP_MAILHUB_ADDR valueFrom: secretKeyRef: <span class="hljs-type"><span class="hljs-type">name</span></span>: app-config key: smtp_address - <span class="hljs-type"><span class="hljs-type">name</span></span>: SMTP_MAILHUB_PORT valueFrom: secretKeyRef: <span class="hljs-type"><span class="hljs-type">name</span></span>: app-config key: smtp_port - <span class="hljs-type"><span class="hljs-type">name</span></span>: SMTP_USE_TLS <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>: <span class="hljs-string"><span class="hljs-string">'YES'</span></span> - <span class="hljs-type"><span class="hljs-type">name</span></span>: SMTP_AUTH_USER valueFrom: secretKeyRef: <span class="hljs-type"><span class="hljs-type">name</span></span>: app-config key: smtp_login - <span class="hljs-type"><span class="hljs-type">name</span></span>: SMTP_AUTH_PASS valueFrom: secretKeyRef: <span class="hljs-type"><span class="hljs-type">name</span></span>: app-config key: smtp_password - <span class="hljs-type"><span class="hljs-type">name</span></span>: SMTP_FROM_LINE_OVERRIDE <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>: <span class="hljs-string"><span class="hljs-string">'NO'</span></span> volumeMounts: - <span class="hljs-type"><span class="hljs-type">name</span></span>: mysql-conf mountPath: /usr/<span class="hljs-keyword"><span class="hljs-keyword">share</span></span>/nxs-backup/service.conf.j2 subPath: service.conf.j2 - <span class="hljs-type"><span class="hljs-type">name</span></span>: nxs-backup-conf mountPath: /etc/nxs-backup/nxs-backup.conf subPath: nxs-backup.conf - <span class="hljs-type"><span class="hljs-type">name</span></span>: backup-dir mountPath: /var/nxs-backup imagePullPolicy: <span class="hljs-keyword"><span class="hljs-keyword">Always</span></span> volumes: - <span class="hljs-type"><span class="hljs-type">name</span></span>: mysql-conf configMap: <span class="hljs-type"><span class="hljs-type">name</span></span>: mysql-conf items: - key: service.conf.j2 <span class="hljs-type"><span class="hljs-type">path</span></span>: service.conf.j2 - <span class="hljs-type"><span class="hljs-type">name</span></span>: nxs-backup-conf configMap: <span class="hljs-type"><span class="hljs-type">name</span></span>: nxs-backup-conf items: - key: nxs-backup.conf <span class="hljs-type"><span class="hljs-type">path</span></span>: nxs-backup.conf - <span class="hljs-type"><span class="hljs-type">name</span></span>: backup-dir hostPath: <span class="hljs-type"><span class="hljs-type">path</span></span>: /var/backups/k8s <span class="hljs-keyword"><span class="hljs-keyword">type</span></span>: Directory restartPolicy: OnFailure</code> </pre> <br><p>  Quizás este elemento sea el más interesante.  En primer lugar, para compilar el CronJob correcto, debe determinar dónde se almacenarán las copias de seguridad recopiladas. </p><br><p>  Para esto tenemos un servidor separado con la cantidad necesaria de recursos.  En el ejemplo, se asigna un nodo de clúster separado, nxs-node5, para recopilar copias de seguridad.  La restricción para iniciar CronJob en los nodos que necesitamos está establecida por la directiva nodeAffinity. </p><br><p>  Cuando se inicia CronJob, el directorio correspondiente se conecta a él a través de hostPath desde el sistema host, que se utiliza para almacenar copias de seguridad. </p><br><p>  A continuación, ConfigMaps se conecta al CronJob específico, que contiene la configuración para nxs-backup, es decir, los archivos nxs-backup.conf y mysql.conf de los que acabamos de hablar. </p><br><p>  Luego, se establecen todas las variables de entorno necesarias, que se definen directamente en el manifiesto o extraídas de Secret'ov. </p><br><p>  Entonces, las variables se transfieren al contenedor y, a través de docker-entrypoint.sh, se reemplazan en ConfigMaps en los lugares que necesitamos con los valores necesarios.  Para MySQL, esto es db_host, db_user, db_password.  En este caso, pasamos el puerto simplemente como un valor en el manifiesto de CronJob, porque no contiene ninguna información valiosa. </p><br><p>  Bueno, con MySQL todo parece estar claro.  Ahora veamos qué se necesita para hacer una copia de seguridad de los archivos de la aplicación Redmine. </p><br><h6>  desc_files.conf </h6><br><pre> <code class="hljs sql">apiVersion: v1 kind: ConfigMap metadata: name: desc-files-conf data: service.conf.j2: |- - job: desc-files type: desc_files tmp_dir: /var/nxs-<span class="hljs-keyword"><span class="hljs-keyword">backup</span></span>/files/<span class="hljs-keyword"><span class="hljs-keyword">desc</span></span>/dump_tmp sources: - target: - /<span class="hljs-keyword"><span class="hljs-keyword">var</span></span>/www/files gzip: yes storages: - <span class="hljs-keyword"><span class="hljs-keyword">storage</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> <span class="hljs-keyword"><span class="hljs-keyword">enable</span></span>: yes backup_dir: /<span class="hljs-keyword"><span class="hljs-keyword">var</span></span>/nxs-<span class="hljs-keyword"><span class="hljs-keyword">backup</span></span>/files/<span class="hljs-keyword"><span class="hljs-keyword">desc</span></span>/dump <span class="hljs-keyword"><span class="hljs-keyword">store</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">days</span></span>: <span class="hljs-number"><span class="hljs-number">6</span></span> weeks: <span class="hljs-number"><span class="hljs-number">4</span></span> <span class="hljs-keyword"><span class="hljs-keyword">month</span></span>: <span class="hljs-number"><span class="hljs-number">6</span></span></code> </pre> <br><p>  Este es un archivo de configuración que describe la lógica de respaldo para los archivos.  Aquí tampoco hay nada inusual, se establecen los mismos parámetros que para MySQL, con la excepción de los datos de autorización, porque simplemente no lo son.  Aunque pueden serlo, si están involucrados protocolos para la transferencia de datos: ssh, ftp, webdav, s3 y otros.  Consideraremos esta opción un poco más tarde. </p><br><h6>  CronJob desc_files </h6><br><pre> <code class="hljs pgsql">apiVersion: batch/v1beta1 kind: CronJob metadata: <span class="hljs-type"><span class="hljs-type">name</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">desc</span></span>-files spec: schedule: "00 00 * * *" jobTemplate: spec: <span class="hljs-keyword"><span class="hljs-keyword">template</span></span>: spec: affinity: nodeAffinity: requiredDuringSchedulingIgnoredDuringExecution: nodeSelectorTerms: - matchExpressions: - key: kubernetes.io/hostname <span class="hljs-keyword"><span class="hljs-keyword">operator</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">In</span></span> <span class="hljs-keyword"><span class="hljs-keyword">values</span></span>: - nxs-node5 containers: - <span class="hljs-type"><span class="hljs-type">name</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">desc</span></span>-files-backup image: nixyslab/nxs-backup:latest env: - <span class="hljs-type"><span class="hljs-type">name</span></span>: SMTP_MAILHUB_ADDR valueFrom: secretKeyRef: <span class="hljs-type"><span class="hljs-type">name</span></span>: app-config key: smtp_address - <span class="hljs-type"><span class="hljs-type">name</span></span>: SMTP_MAILHUB_PORT valueFrom: secretKeyRef: <span class="hljs-type"><span class="hljs-type">name</span></span>: app-config key: smtp_port - <span class="hljs-type"><span class="hljs-type">name</span></span>: SMTP_USE_TLS <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>: <span class="hljs-string"><span class="hljs-string">'YES'</span></span> - <span class="hljs-type"><span class="hljs-type">name</span></span>: SMTP_AUTH_USER valueFrom: secretKeyRef: <span class="hljs-type"><span class="hljs-type">name</span></span>: app-config key: smtp_login - <span class="hljs-type"><span class="hljs-type">name</span></span>: SMTP_AUTH_PASS valueFrom: secretKeyRef: <span class="hljs-type"><span class="hljs-type">name</span></span>: app-config key: smtp_password - <span class="hljs-type"><span class="hljs-type">name</span></span>: SMTP_FROM_LINE_OVERRIDE <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>: <span class="hljs-string"><span class="hljs-string">'NO'</span></span> volumeMounts: - <span class="hljs-type"><span class="hljs-type">name</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">desc</span></span>-files-conf mountPath: /usr/<span class="hljs-keyword"><span class="hljs-keyword">share</span></span>/nxs-backup/service.conf.j2 subPath: service.conf.j2 - <span class="hljs-type"><span class="hljs-type">name</span></span>: nxs-backup-conf mountPath: /etc/nxs-backup/nxs-backup.conf subPath: nxs-backup.conf - <span class="hljs-type"><span class="hljs-type">name</span></span>: target-dir mountPath: /var/www/files - <span class="hljs-type"><span class="hljs-type">name</span></span>: backup-dir mountPath: /var/nxs-backup imagePullPolicy: <span class="hljs-keyword"><span class="hljs-keyword">Always</span></span> volumes: - <span class="hljs-type"><span class="hljs-type">name</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">desc</span></span>-files-conf configMap: <span class="hljs-type"><span class="hljs-type">name</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">desc</span></span>-files-conf items: - key: service.conf.j2 <span class="hljs-type"><span class="hljs-type">path</span></span>: service.conf.j2 - <span class="hljs-type"><span class="hljs-type">name</span></span>: nxs-backup-conf configMap: <span class="hljs-type"><span class="hljs-type">name</span></span>: nxs-backup-conf items: - key: nxs-backup.conf <span class="hljs-type"><span class="hljs-type">path</span></span>: nxs-backup.conf - <span class="hljs-type"><span class="hljs-type">name</span></span>: backup-dir hostPath: <span class="hljs-type"><span class="hljs-type">path</span></span>: /var/backups/k8s <span class="hljs-keyword"><span class="hljs-keyword">type</span></span>: Directory - <span class="hljs-type"><span class="hljs-type">name</span></span>: target-dir persistentVolumeClaim: claimName: redmine-app-files restartPolicy: OnFailure</code> </pre> <br><p>  Nada nuevo, tampoco, con respecto a MySQL.  Pero aquí se monta un PV adicional (target-dir), que respaldaremos - / var / www / files.  De lo contrario, todo es igual, almacenamos copias localmente en el nodo que necesitamos, para lo cual se asigna CronJob. </p><br><h6>  Resumen </h6><br><p>  Para cada servicio que queremos respaldar, creamos un CronJob separado con todos los elementos relacionados necesarios: ConfigMaps y Secrets.  Por analogía con los ejemplos considerados, podemos respaldar cualquier servicio similar en el clúster. </p><br><p>  Creo que, en base a estos dos ejemplos, todos tienen alguna idea de cómo respaldamos los servicios estatales en Cuba.  Creo que no tiene sentido analizar en detalle los mismos ejemplos para otros servicios, porque básicamente son todos iguales y tienen ligeras diferencias. </p><br><p>  En realidad, esto es lo que queríamos lograr, es decir, algún tipo de <u>enfoque unificado</u> para construir el proceso de copia de seguridad.  Y para que este enfoque pueda aplicarse a una gran cantidad de proyectos diferentes basados ​​en k8. </p><br><h3>  ¿Dónde almacenamos? </h3><br><p>  En todos los ejemplos discutidos anteriormente, almacenamos copias en el directorio local del nodo en el que se ejecuta el contenedor.  Pero nadie se molesta en conectar el volumen persistente como un almacenamiento externo en funcionamiento y recopilar copias allí.  O solo puede sincronizarlos con una tienda remota utilizando el protocolo deseado sin guardar localmente.  Es decir, hay muchas variaciones.  Primero recolecta localmente, luego sincroniza.  O para recolectar y almacenar solo en un almacenamiento remoto, etc.  La configuración es bastante flexible. </p><br><h6>  mysql.conf + s3 </h6><br><p>  El siguiente es un ejemplo del archivo de configuración de respaldo de MySQL, donde las copias se almacenan localmente en el nodo donde se ejecuta CronJob, y también se sincronizan en s3. </p><br><pre> <code class="hljs sql">apiVersion: v1 kind: ConfigMap metadata: name: mysql-conf data: service.conf.j2: |- - job: mysql type: mysql tmp_dir: /var/nxs-<span class="hljs-keyword"><span class="hljs-keyword">backup</span></span>/<span class="hljs-keyword"><span class="hljs-keyword">databases</span></span>/mysql/dump_tmp sources: - <span class="hljs-keyword"><span class="hljs-keyword">connect</span></span>: db_host: {{ db_host }} db_port: {{ db_port }} socket: <span class="hljs-string"><span class="hljs-string">''</span></span> db_user: {{ db_user }} db_password: {{ db_password }} target: - redmine_db gzip: yes is_slave: <span class="hljs-keyword"><span class="hljs-keyword">no</span></span> extra_keys: <span class="hljs-string"><span class="hljs-string">' --opt --add-drop-database --routines --comments --create-options --quote-names --order-by-primary --hex-blob'</span></span> storages: - <span class="hljs-keyword"><span class="hljs-keyword">storage</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> <span class="hljs-keyword"><span class="hljs-keyword">enable</span></span>: yes backup_dir: /<span class="hljs-keyword"><span class="hljs-keyword">var</span></span>/nxs-<span class="hljs-keyword"><span class="hljs-keyword">backup</span></span>/<span class="hljs-keyword"><span class="hljs-keyword">databases</span></span>/mysql/dump <span class="hljs-keyword"><span class="hljs-keyword">store</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">days</span></span>: <span class="hljs-number"><span class="hljs-number">6</span></span> weeks: <span class="hljs-number"><span class="hljs-number">4</span></span> <span class="hljs-keyword"><span class="hljs-keyword">month</span></span>: <span class="hljs-number"><span class="hljs-number">6</span></span> - <span class="hljs-keyword"><span class="hljs-keyword">storage</span></span>: s3 <span class="hljs-keyword"><span class="hljs-keyword">enable</span></span>: yes backup_dir: /nxs-<span class="hljs-keyword"><span class="hljs-keyword">backup</span></span>/<span class="hljs-keyword"><span class="hljs-keyword">databases</span></span>/mysql/dump bucket_name: {{ bucket_name }} access_key_id: {{ access_key_id }} secret_access_key: {{ secret_access_key }} s3fs_opts: {{ s3fs_opts }} <span class="hljs-keyword"><span class="hljs-keyword">store</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">days</span></span>: <span class="hljs-number"><span class="hljs-number">2</span></span> weeks: <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">month</span></span>: <span class="hljs-number"><span class="hljs-number">6</span></span></code> </pre> <br><p>  Es decir, si no es suficiente almacenar copias localmente, puede sincronizarlas con cualquier almacenamiento remoto utilizando el protocolo apropiado.  El número de almacenamiento para almacenamiento puede ser cualquiera. </p><br><p>  Pero en este caso, aún necesita hacer algunos cambios adicionales, a saber: </p><br><ul><li>  Conecte el ConfigMap apropiado con el contenido necesario para la autorización con AWS S3, en formato j2 </li><li>  Crear un secreto apropiado para almacenar accesos de autorización </li><li>  Establezca las variables de entorno necesarias tomadas del secreto anterior </li><li>  Ajuste docker-entrypoint.sh para reemplazar las variables correspondientes en ConfigMap </li><li>  Reconstruya la imagen de Docker, agregando utilidades para trabajar con AWS S3 </li></ul><br><p>  Si bien este proceso está lejos de ser perfecto, estamos trabajando en ello.  Por lo tanto, en el futuro cercano agregaremos a nxs-backup la capacidad de definir parámetros en el archivo de configuración utilizando variables de entorno, lo que simplificará enormemente el trabajo con el archivo de punto de entrada y minimizará el tiempo dedicado a agregar soporte para la copia de seguridad de nuevos servicios. </p><br><h3>  Conclusión </h3><br><p>  Eso es probablemente todo. </p><br><p>  El uso del enfoque del que acabamos de hablar, en primer lugar, nos permite estructurar y hacer una copia de seguridad de la plantilla de los servicios de proyectos con estado en k8.  Es decir, esta es una solución lista para usar, y lo más importante, la práctica que puede aplicar en sus proyectos, sin perder tiempo y esfuerzo buscando y refinando soluciones de código abierto existentes. </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/es426543/">https://habr.com/ru/post/es426543/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../es426527/index.html">Buena vestimenta, mala vestimenta</a></li>
<li><a href="../es426531/index.html">Dell G3 15 (3579): una computadora portátil para juegos con un presupuesto mínimo</a></li>
<li><a href="../es426533/index.html">Noise Security Bit episodio 0x21 (Ficción y realidad: puertas traseras en hardware y firmware)</a></li>
<li><a href="../es426537/index.html">El libro "Aplicación desde cero"</a></li>
<li><a href="../es426541/index.html">Paul Allen, cofundador de Microsoft, falleció a la edad de 65 años.</a></li>
<li><a href="../es426545/index.html">Bonos Joker 2018: transmisión en línea gratuita, bofs, fiesta y mesa</a></li>
<li><a href="../es426547/index.html">Como el creador de Android está intentando lanzar el primer "anti-teléfono inteligente"</a></li>
<li><a href="../es426549/index.html">Un nuevo tipo de software para gerentes de producto</a></li>
<li><a href="../es426551/index.html">Trekz Air: cómo suenan realmente los auriculares de conducción ósea</a></li>
<li><a href="../es426553/index.html">Anuncios de banner en la aplicación iOS</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>