<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üÜí üî∂ üìπ Buat Penerbit Anda di Combine üöµüèæ üíà üë®üèø‚Äçü§ù‚Äçüë®üèæ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hari ini saya ingin menunjukkan kepada Anda bagaimana cara membuat Publisher Anda sendiri dalam kerangka kerja Combine baru Apple. 


 Jadi, sebagai p...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Buat Penerbit Anda di Combine</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/482690/"><p><img src="https://habrastorage.org/webt/yu/vm/d7/yuvmd7t0eg1ws5pi_ahqklv9bba.png"></p><br><p>  Hari ini saya ingin menunjukkan kepada Anda bagaimana cara membuat Publisher Anda sendiri dalam kerangka kerja Combine baru Apple. </p><a name="habracut"></a><br><p>  Jadi, sebagai permulaan, kita perlu mengingat secara singkat bagaimana bagian mendasar dari Combine, yaitu Publisher, Subscription, Subscriber, saling berinteraksi. </p><br><ul><li>  Pelanggan bergabung dengan Penerbit </li><li>  Penerbit mengirimkan Pelanggan Berlangganan </li><li>  Pelanggan meminta nilai N dari Langganan </li><li>  Penerbit mengirimkan nilai N atau kurang </li><li>  Penerbit mengirimkan sinyal penyelesaian </li></ul><br><h1 id="publisher">  Penerbit </h1><br><p>  Jadi mari kita mulai membuat Publisher kita.  Beralih ke dokumentasi Apple, kita akan melihat bahwa <a href="https://developer.apple.com/documentation/combine/publisher">Penerbit</a> adalah protokol. </p><br><pre><code class="swift hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">protocol</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Publisher</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">associatedtype</span></span> <span class="hljs-type"><span class="hljs-type">Output</span></span> <span class="hljs-keyword"><span class="hljs-keyword">associatedtype</span></span> <span class="hljs-type"><span class="hljs-type">Failure</span></span> : <span class="hljs-type"><span class="hljs-type">Error</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">receive</span></span></span><span class="hljs-function">&lt;S&gt;</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(subscriber: S)</span></span></span></span> <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> <span class="hljs-type"><span class="hljs-type">S</span></span> : <span class="hljs-type"><span class="hljs-type">Subscriber</span></span>, <span class="hljs-type"><span class="hljs-type">Self</span></span>.<span class="hljs-type"><span class="hljs-type">Failure</span></span> == <span class="hljs-type"><span class="hljs-type">S</span></span>.<span class="hljs-type"><span class="hljs-type">Failure</span></span>, <span class="hljs-type"><span class="hljs-type">Self</span></span>.<span class="hljs-type"><span class="hljs-type">Output</span></span> == <span class="hljs-type"><span class="hljs-type">S</span></span>.<span class="hljs-type"><span class="hljs-type">Input</span></span> }</code> </pre> <br><p>  Di mana Keluaran adalah jenis nilai yang diteruskan oleh Penerbit ini, Kegagalan adalah jenis kesalahan yang harus mengikuti protokol Kesalahan. </p><br><p>  Dan fungsi terima (_: Pelanggan), yang akan dipanggil untuk menambahkan Pelanggan ke Penerbit ini menggunakan berlangganan (_ :). </p><br><p>  Sebagai contoh, kami menerapkan Publisher, yang akan menghasilkan <a href="https://en.wikipedia.org/wiki/Fibonacci_number">angka Fibonacci</a> untuk kami. </p><br><pre> <code class="swift hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">FibonacciPublisher</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Publisher</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">typealias</span></span> <span class="hljs-type"><span class="hljs-type">Output</span></span> = <span class="hljs-type"><span class="hljs-type">Int</span></span> <span class="hljs-keyword"><span class="hljs-keyword">typealias</span></span> <span class="hljs-type"><span class="hljs-type">Failure</span></span> = <span class="hljs-type"><span class="hljs-type">Never</span></span> }</code> </pre> <br><p>  Karena urutannya terdiri dari angka, tipe output akan menjadi Output dari tipe Int, dan Kegagalan akan menjadi tipe khusus dari Never, menunjukkan bahwa Penerbit ini tidak akan pernah gagal. </p><br><p>  Untuk fleksibilitas, kami menentukan batas jumlah elemen yang ingin kami terima dan bungkus nilai ini di beberapa objek konfigurasi Penerbit kami. </p><br><pre> <code class="swift hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">FibonacciConfiguration</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> <span class="hljs-built_in"><span class="hljs-built_in">count</span></span>: <span class="hljs-type"><span class="hljs-type">UInt</span></span> }</code> </pre> <br><p>  Mari kita melihat lebih dekat pada kode ini, var count: UInt terlihat seperti opsi yang baik, tetapi penggunaannya membatasi kita pada kisaran nilai yang valid dari tipe UInt dan juga tidak sepenuhnya jelas apa yang harus ditunjukkan jika kita masih ingin memiliki urutan tanpa batas. </p><br><p>  Alih-alih UInt, kami akan menggunakan tipe Subscribers.Demand, yang didefinisikan dalam Combine, di mana juga digambarkan sebagai tipe yang dikirim dari Pelanggan ke Publisher melalui Berlangganan.  Secara sederhana, ini menunjukkan <em>kebutuhan</em> akan elemen, berapa banyak elemen yang diminta oleh Pelanggan.  tidak terbatas - tidak terbatas, tidak ada - tidak sama sekali, maks (N) - tidak lebih dari N kali. </p><br><pre> <code class="swift hljs"> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Demand</span></span></span><span class="hljs-class"> : </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Equatable</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Comparable</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Hashable</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Codable</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CustomStringConvertible</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> unlimited: <span class="hljs-type"><span class="hljs-type">Subscribers</span></span>.<span class="hljs-type"><span class="hljs-type">Demand</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> <span class="hljs-keyword"><span class="hljs-keyword">none</span></span>: <span class="hljs-type"><span class="hljs-type">Subscribers</span></span>.<span class="hljs-type"><span class="hljs-type">Demand</span></span> <span class="hljs-comment"><span class="hljs-comment">///  Demand.max(0) @inlinable public static func max(_ value: Int) -&gt; Subscribers.Demand .... }</span></span></code> </pre> <br><p>  Kami menulis ulang FibonacciConfiguration yang mengubah jenis menjadi yang baru untuk perhitungan. </p><br><pre> <code class="swift hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">FibonacciConfiguration</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> <span class="hljs-built_in"><span class="hljs-built_in">count</span></span>: <span class="hljs-type"><span class="hljs-type">Subscribers</span></span>.<span class="hljs-type"><span class="hljs-type">Demand</span></span> }</code> </pre> <br><p>  Mari kita kembali ke Publisher dan mengimplementasikan metode accept (_: Subscriber), seperti yang kita ingat, metode ini diperlukan untuk menambahkan Subscriber ke Publisher.  Dan dia melakukan ini dengan Langganan, Penerbit harus membuat langganan dan mentransfer langganan ke pelanggan. </p><br><pre> <code class="swift hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">receive</span></span></span><span class="hljs-function">&lt;S&gt;</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(subscriber: S)</span></span></span></span> <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> <span class="hljs-type"><span class="hljs-type">S</span></span> : <span class="hljs-type"><span class="hljs-type">Subscriber</span></span>, <span class="hljs-type"><span class="hljs-type">Failure</span></span> == <span class="hljs-type"><span class="hljs-type">S</span></span>.<span class="hljs-type"><span class="hljs-type">Failure</span></span>, <span class="hljs-type"><span class="hljs-type">Output</span></span> == <span class="hljs-type"><span class="hljs-type">S</span></span>.<span class="hljs-type"><span class="hljs-type">Input</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> subscription = <span class="hljs-type"><span class="hljs-type">FibonacciSubscription</span></span>(subscriber: subscriber, configuration: configuration) subscriber.receive(subscription: subscription) }</code> </pre> <br><p>  Ini adalah fungsi umum yang menggunakan Pelanggan sebagai parameter, dan nilai output Penerbit harus cocok dengan nilai input Pelanggan (Output == S.Input), sama untuk kesalahan.  Ini diperlukan untuk "menghubungkan" Publisher'a dan Subscriber'a. </p><br><p>  Dalam fungsinya sendiri, buat langganan FibonacciSubscription, di konstruktor kami mentransfer pelanggan dan konfigurasi.  Setelah itu, berlangganan ditransfer ke pelanggan. </p><br><p>  Penerbit kami siap, pada akhirnya kami memiliki: </p><br><pre> <code class="swift hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">FibonacciPublisher</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Publisher</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">typealias</span></span> <span class="hljs-type"><span class="hljs-type">Output</span></span> = <span class="hljs-type"><span class="hljs-type">Int</span></span> <span class="hljs-keyword"><span class="hljs-keyword">typealias</span></span> <span class="hljs-type"><span class="hljs-type">Failure</span></span> = <span class="hljs-type"><span class="hljs-type">Never</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> configuration: <span class="hljs-type"><span class="hljs-type">FibonacciConfiguration</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">receive</span></span></span><span class="hljs-function">&lt;S&gt;</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(subscriber: S)</span></span></span></span> <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> <span class="hljs-type"><span class="hljs-type">S</span></span> : <span class="hljs-type"><span class="hljs-type">Subscriber</span></span>, <span class="hljs-type"><span class="hljs-type">Failure</span></span> == <span class="hljs-type"><span class="hljs-type">S</span></span>.<span class="hljs-type"><span class="hljs-type">Failure</span></span>, <span class="hljs-type"><span class="hljs-type">Output</span></span> == <span class="hljs-type"><span class="hljs-type">S</span></span>.<span class="hljs-type"><span class="hljs-type">Input</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> subscription = <span class="hljs-type"><span class="hljs-type">FibonacciSubscription</span></span>(subscriber: subscriber, configuration: configuration) subscriber.receive(subscription: subscription) } }</code> </pre> <br><p>  Seperti yang Anda lihat, Penerbit itu sendiri tidak mengandung logika untuk menghasilkan urutan Fibonacci, semua logika akan berada di kelas berlangganan - FibonacciSubscription. </p><br><p>  Seperti yang sudah Anda tebak, kelas FibonacciSubscription akan mengikuti protokol Berlangganan, mari kita lihat definisi protokol ini. </p><br><pre> <code class="swift hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">protocol</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Subscription</span></span></span><span class="hljs-class"> : </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Cancellable</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CustomCombineIdentifierConvertible</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">request</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">_</span></span></span></span><span class="hljs-function"><span class="hljs-params"> demand: Subscribers.Demand)</span></span></span></span> }</code> </pre> <br><p>  Fungsi request (_: Subscribers.Demand) memberi tahu Publisher bahwa ia dapat mengirim lebih banyak nilai kepada pelanggan.  Dalam metode inilah logika pengiriman angka Fibonacci akan terjadi. <br>  Kita juga perlu menerapkan mengikuti protokol Cancellable dan mengimplementasikan fungsi cancel (). </p><br><pre> <code class="swift hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">protocol</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Cancellable</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">cancel</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> }</code> </pre> <br><p>  Dan cukup ikuti protokol CustomCombineIdentifierConvertible dan tentukan variabel readI only. </p><br><pre> <code class="swift hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">protocol</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CustomCombineIdentifierConvertible</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> combineIdentifier: <span class="hljs-type"><span class="hljs-type">CombineIdentifier</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> } }</code> </pre> <br><p>  Ada klarifikasi di sini, jika Anda menggulir tepat di bawah definisi protokol CustomCombineIdentifierConvertible di Combine, Anda dapat melihat bahwa Combine memberikan ekstensi untuk protokol ini, yang memiliki bentuk - </p><br><pre> <code class="swift hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extension</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CustomCombineIdentifierConvertible</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">where</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Self</span></span></span><span class="hljs-class"> : </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AnyObject</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> combineIdentifier: <span class="hljs-type"><span class="hljs-type">CombineIdentifier</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> } }</code> </pre> <br><p>  Yang memberitahu kita bahwa definisi dari variabel joinIdentifier: CombineIdentifier disediakan secara default jika tipe yang mengikuti protokol ini juga mengikuti protokol AnyObject, yaitu jika tipe ini adalah kelas.  FibonacciSubscription adalah kelas, jadi kami mendapatkan definisi variabel default. </p><br><h1 id="subscription">  Berlangganan </h1><br><p>  Maka kami akan mulai menerapkan FibonacciSubscription kami. </p><br><pre> <code class="swift hljs"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">FibonacciSubscription</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">S</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Subscriber</span></span></span><span class="hljs-class">&gt;: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Subscription</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">where</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">S</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Input</span></span></span><span class="hljs-class"> == </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Int</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> subscriber: <span class="hljs-type"><span class="hljs-type">S?</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> configuration: <span class="hljs-type"><span class="hljs-type">FibonacciConfiguration</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> <span class="hljs-built_in"><span class="hljs-built_in">count</span></span>: <span class="hljs-type"><span class="hljs-type">Subscribers</span></span>.<span class="hljs-type"><span class="hljs-type">Demand</span></span> <span class="hljs-keyword"><span class="hljs-keyword">init</span></span>(subscriber: <span class="hljs-type"><span class="hljs-type">S?</span></span>, configuration: <span class="hljs-type"><span class="hljs-type">FibonacciConfiguration</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.subscriber = subscriber <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.configuration = configuration <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.<span class="hljs-built_in"><span class="hljs-built_in">count</span></span> = configuration.<span class="hljs-built_in"><span class="hljs-built_in">count</span></span> } ... }</code> </pre> <br><p>  Seperti yang Anda lihat, FibonacciConfiguration berisi tautan yang kuat ke Pelanggan, dengan kata lain, adalah pemilik Pelanggan.  <strong>Ini adalah poin penting, langganan bertanggung jawab atas retensi pelanggan, dan itu harus menahannya sampai selesai bekerja, selesai dengan kesalahan atau dengan dibatalkan.</strong> </p><br><p>  Selanjutnya, kami menerapkan metode cancel () dari protokol Cancellable. </p><br><pre> <code class="swift hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">cancel</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { subscriber = <span class="hljs-literal"><span class="hljs-literal">nil</span></span> }</code> </pre> <br><p>  Menyetel pelanggan menjadi nol membuatnya tidak dapat diakses untuk berlangganan. </p><br><p>  Sekarang kita siap untuk memulai implementasi pengiriman nomor Fibonacci. <br>  kami menerapkan metode permintaan (_: Pelanggan. Permintaan). </p><br><pre> <code class="swift hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">request</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">_</span></span></span></span><span class="hljs-function"><span class="hljs-params"> demand: Subscribers.Demand)</span></span></span></span> { <span class="hljs-comment"><span class="hljs-comment">// 1 guard count &gt; .none else { subscriber?.receive(completion: .finished) return } // 2 count -= .max(1) subscriber?.receive(0) if count == .none { subscriber?.receive(completion: .finished) return } // 3 count -= .max(1) subscriber?.receive(1) if count == .none { subscriber?.receive(completion: .finished) return } // 4 var prev = 0 var current = 1 var temp: Int while true { temp = prev prev = current current += temp subscriber?.receive(current) count -= .max(1) if count == .none { subscriber?.receive(completion: .finished) return } } }</span></span></code> </pre> <br><p>  1) Dari awal, kami memeriksa berapa banyak elemen yang dapat diberikan penerbit, jika tidak sama sekali, maka selesaikan pengiriman dan kirim sinyal kepada Pelanggan bahwa pengiriman angka telah selesai. <br>  2) Jika ada kebutuhan, maka kurangi jumlah angka yang diminta dengan satu, kirim elemen pertama dari deret Fibonacci ke Pelanggan, yaitu 0 dan kemudian periksa lagi berapa banyak elemen yang dapat diberikan oleh Penerbit kepada kami, jika tidak, kirim sinyal ke Pelanggan untuk menyelesaikan . <br>  3) Pendekatan yang sama seperti pada 2) paragraf, tetapi hanya untuk elemen kedua dalam urutan Fibonacci. <br>  4) Jika diperlukan lebih dari 2 elemen, maka kami menerapkan algoritma berulang untuk menemukan angka Fibonacci, di mana pada setiap langkah kami akan mentransfer angka berikutnya dari urutan Fibonacci ke Pelanggan dan juga memeriksa berapa banyak elemen yang masih dapat disediakan Penerbit.  Jika Penerbit tidak lagi memberikan nomor baru, kirimkan sinyal penyelesaian kepada Pelanggan. </p><br><div class="spoiler">  <b class="spoiler_title">Saat ini, kami telah menulis kode seperti itu</b> <div class="spoiler_text"><pre> <code class="swift hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">FibonacciConfiguration</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> <span class="hljs-built_in"><span class="hljs-built_in">count</span></span>: <span class="hljs-type"><span class="hljs-type">Subscribers</span></span>.<span class="hljs-type"><span class="hljs-type">Demand</span></span> } <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">FibonacciPublisher</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Publisher</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">typealias</span></span> <span class="hljs-type"><span class="hljs-type">Output</span></span> = <span class="hljs-type"><span class="hljs-type">Int</span></span> <span class="hljs-keyword"><span class="hljs-keyword">typealias</span></span> <span class="hljs-type"><span class="hljs-type">Failure</span></span> = <span class="hljs-type"><span class="hljs-type">Never</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> configuration: <span class="hljs-type"><span class="hljs-type">FibonacciConfiguration</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">receive</span></span></span><span class="hljs-function">&lt;S&gt;</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(subscriber: S)</span></span></span></span> <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> <span class="hljs-type"><span class="hljs-type">S</span></span> : <span class="hljs-type"><span class="hljs-type">Subscriber</span></span>, <span class="hljs-type"><span class="hljs-type">Failure</span></span> == <span class="hljs-type"><span class="hljs-type">S</span></span>.<span class="hljs-type"><span class="hljs-type">Failure</span></span>, <span class="hljs-type"><span class="hljs-type">Output</span></span> == <span class="hljs-type"><span class="hljs-type">S</span></span>.<span class="hljs-type"><span class="hljs-type">Input</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> subscription = <span class="hljs-type"><span class="hljs-type">FibonacciSubscription</span></span>(subscriber: subscriber, configuration: configuration) subscriber.receive(subscription: subscription) } } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">FibonacciSubscription</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">S</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Subscriber</span></span></span><span class="hljs-class">&gt;: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Subscription</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">where</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">S</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Input</span></span></span><span class="hljs-class"> == </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Int</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> subscriber: <span class="hljs-type"><span class="hljs-type">S?</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> configuration: <span class="hljs-type"><span class="hljs-type">FibonacciConfiguration</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> <span class="hljs-built_in"><span class="hljs-built_in">count</span></span>: <span class="hljs-type"><span class="hljs-type">Subscribers</span></span>.<span class="hljs-type"><span class="hljs-type">Demand</span></span> <span class="hljs-keyword"><span class="hljs-keyword">init</span></span>(subscriber: <span class="hljs-type"><span class="hljs-type">S?</span></span>, configuration: <span class="hljs-type"><span class="hljs-type">FibonacciConfiguration</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.subscriber = subscriber <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.configuration = configuration <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.<span class="hljs-built_in"><span class="hljs-built_in">count</span></span> = configuration.<span class="hljs-built_in"><span class="hljs-built_in">count</span></span> } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">cancel</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { subscriber = <span class="hljs-literal"><span class="hljs-literal">nil</span></span> } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">request</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">_</span></span></span></span><span class="hljs-function"><span class="hljs-params"> demand: Subscribers.Demand)</span></span></span></span> { <span class="hljs-comment"><span class="hljs-comment">// 1 guard count &gt; .none else { subscriber?.receive(completion: .finished) return } // 2 count -= .max(1) subscriber?.receive(0) if count == .none { subscriber?.receive(completion: .finished) return } // 3 count -= .max(1) subscriber?.receive(1) if count == .none { subscriber?.receive(completion: .finished) return } // 4 var prev = 0 var current = 1 var temp: Int while true { temp = prev prev = current current += temp subscriber?.receive(current) count -= .max(1) if count == .none { subscriber?.receive(completion: .finished) return } } } }</span></span></code> </pre> </div></div><br><h3 id="pervoe-testirovanie">  Tes pertama </h3><br><p>  Sekarang kami akan menguji apa yang kami miliki, kami memiliki Penerbit dan Langganan kami, kami tidak memiliki cukup pelanggan, Combine menyediakan 2 pelanggan dari kotak: sink dan assign. </p><br><ul><li>  sink - metode ini membuat pelanggan dan segera meminta jumlah nilai yang <strong>tidak terbatas</strong> . </li><li>  assign - set setiap elemen dari Publisher ke properti objek. </li></ul><br><p>  wastafel sangat cocok untuk tujuan kita, perhatian khusus harus diberikan pada kenyataan bahwa ia meminta jumlah nilai yang tidak terbatas. </p><br><p>  Dan di sini kita perlu membuat perbedaan penting, Penerbit kita dalam variabel jumlah menentukan jumlah elemen yang dapat diberikan Penerbit kita dan ketentuan ini ditentukan oleh kita sendiri.  Pada prinsipnya, kita bisa melakukannya tanpa variabel ini dan tidak dibatasi dalam mentransmisikan angka Fibonacci, tetapi tidak lama lagi kita akan melampaui kisaran nilai yang dapat diterima dari tipe Int. <br>  Kasus dengan sink berbeda, setiap Pelanggan menentukan berapa banyak nilai yang ingin diterima, sink meminta jumlah nilai yang tidak terbatas, yang berarti bahwa ia akan menerima nilai sampai menerima sinyal penyelesaian, kesalahan atau pembatalan. </p><br><p>  Untuk kenyamanan menggunakan Penerbit kami, kami menambahkan pembuatannya ke ekstensi protokol Penerbit. </p><br><pre> <code class="swift hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extension</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Publishers</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">fibonacci</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(configuration: FibonacciConfiguration)</span></span></span></span> -&gt; <span class="hljs-type"><span class="hljs-type">FibonacciPublisher</span></span> { <span class="hljs-type"><span class="hljs-type">FibonacciPublisher</span></span>(configuration: configuration) } <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">fibonacci</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-params"><span class="hljs-built_in">count</span></span></span></span><span class="hljs-function"><span class="hljs-params">: Subscribers.Demand = .</span></span><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-params"><span class="hljs-built_in">max</span></span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"><span class="hljs-params">(</span></span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-params"><span class="hljs-number">6</span></span></span></span></span><span class="hljs-function"><span class="hljs-params"><span class="hljs-params">)</span></span></span></span></span></span>) -&gt; <span class="hljs-type"><span class="hljs-type">FibonacciPublisher</span></span> { <span class="hljs-type"><span class="hljs-type">FibonacciPublisher</span></span>(configuration: <span class="hljs-type"><span class="hljs-type">FibonacciConfiguration</span></span>(<span class="hljs-built_in"><span class="hljs-built_in">count</span></span>: <span class="hljs-built_in"><span class="hljs-built_in">count</span></span>)) } }</code> </pre> <br><p>  Maka cobalah Penerbit kami </p><br><pre> <code class="swift hljs"><span class="hljs-type"><span class="hljs-type">Publishers</span></span>.fibonacci(<span class="hljs-built_in"><span class="hljs-built_in">count</span></span>: .<span class="hljs-built_in"><span class="hljs-built_in">max</span></span>(<span class="hljs-number"><span class="hljs-number">10</span></span>)) .sink { value <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-built_in"><span class="hljs-built_in">print</span></span>(value, terminator: <span class="hljs-string"><span class="hljs-string">" "</span></span>) } <span class="hljs-comment"><span class="hljs-comment">// print 0 1 1 2 3 5 8 13 21 34 - OK</span></span></code> </pre> <br><p>  Dan sekarang batas kasus </p><br><pre> <code class="swift hljs"><span class="hljs-type"><span class="hljs-type">Publishers</span></span>.fibonacci(<span class="hljs-built_in"><span class="hljs-built_in">count</span></span>: .<span class="hljs-built_in"><span class="hljs-built_in">max</span></span>(<span class="hljs-number"><span class="hljs-number">1</span></span>)) .sink { value <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-built_in"><span class="hljs-built_in">print</span></span>(value, terminator: <span class="hljs-string"><span class="hljs-string">" "</span></span>) } <span class="hljs-comment"><span class="hljs-comment">// prinst 0 - OK Publishers.fibonacci(count: .max(2)) .sink { value in print(value, terminator: " ") } // prints 0 1 - OK Publishers.fibonacci(count: .none) .print() //    publisher'a .sink { value in print(value, terminator: " ") } // prints receive finished - OK</span></span></code> </pre> <br><p>  Tetapi apa yang terjadi jika Anda menentukan .unlimited? </p><br><pre> <code class="swift hljs"><span class="hljs-type"><span class="hljs-type">Publishers</span></span>.fibonacci(<span class="hljs-built_in"><span class="hljs-built_in">count</span></span>: .unlimited) .<span class="hljs-built_in"><span class="hljs-built_in">print</span></span>() .sink { value <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-built_in"><span class="hljs-built_in">print</span></span>(value, terminator: <span class="hljs-string"><span class="hljs-string">" "</span></span>) } <span class="hljs-comment"><span class="hljs-comment">// prints 0 1 1 2 3 5 8 13 21 ...   ,     Int.</span></span></code> </pre> <br><p>  Bagaimana Anda bisa menggunakan .unlimited, tetapi bisa menampilkan beberapa angka?  Untuk melakukan ini, kita memerlukan operator .prefix (_), yang bekerja dengan cara yang sama dengan .prefix (_) dari koleksi, yaitu, ia hanya menyisakan elemen N pertama. </p><br><pre> <code class="swift hljs"><span class="hljs-type"><span class="hljs-type">Publishers</span></span>.fibonacci(<span class="hljs-built_in"><span class="hljs-built_in">count</span></span>: .unlimited) .<span class="hljs-built_in"><span class="hljs-built_in">print</span></span>() .<span class="hljs-keyword"><span class="hljs-keyword">prefix</span></span>(<span class="hljs-number"><span class="hljs-number">5</span></span>) .sink { <span class="hljs-number"><span class="hljs-number">_</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> } <span class="hljs-comment"><span class="hljs-comment">// prints 0 1 1 2 3 cancel   ,       Int.</span></span></code> </pre> <br><p>  Apa masalahnya?  Mungkin di .prefix (_)?  Mari kita lakukan sedikit percobaan pada urutan standar dari Foundation. </p><br><pre> <code class="swift hljs"><span class="hljs-comment"><span class="hljs-comment">//   1 2 3 4 5 6 7 8 ... 1... .publisher .print() .prefix(5) .sink { _ in } // prints 1 2 3 4 5 cancel - </span></span></code> </pre> <br><p>  Seperti yang dapat kita lihat, kode di atas berfungsi dengan benar, maka masalahnya ada pada implementasi Penerbit kita. <br>  Kami melihat log dari .print () dan melihat bahwa setelah N meminta, dari .prefix (_), kami memanggil cancel () pada FibonacciSubscription kami, tempat kami mengatur pelanggan menjadi nihil. </p><br><pre> <code class="swift hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">cancel</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { subscriber = <span class="hljs-literal"><span class="hljs-literal">nil</span></span> }</code> </pre> <br><p>  Jika Anda membuka tumpukan panggilan, Anda dapat melihat bahwa membatalkan () dipanggil dari permintaan (_ :), yaitu selama panggilan ke pelanggan?. Menerima (_).  Dari mana kita dapat menyimpulkan bahwa pada suatu saat di dalam permintaan (_ :) pelanggan dapat menjadi nol dan kemudian kita perlu menghentikan pekerjaan menghasilkan nomor baru.  Tambahkan kondisi ini ke kode kami. </p><br><pre> <code class="swift hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">request</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">_</span></span></span></span><span class="hljs-function"><span class="hljs-params"> demand: Subscribers.Demand)</span></span></span></span> { <span class="hljs-comment"><span class="hljs-comment">// 1 guard count &gt; .none else { subscriber?.receive(completion: .finished) return } // 2 count -= .max(1) subscriber?.receive(0) guard let _ = subscriber else { return } // new if count == .none { subscriber?.receive(completion: .finished) return } // 3 count -= .max(1) subscriber?.receive(1) guard let _ = subscriber else { return } // new if count == .none { subscriber?.receive(completion: .finished) return } // 4 var prev = 0 var current = 1 var temp: Int while let subscriber = subscriber { // new temp = prev prev = current current += temp subscriber.receive(current) count -= .max(1) if count == .none { subscriber.receive(completion: .finished) return } } }</span></span></code> </pre> <br><p>  Sekarang jalankan kode pengujian kami. </p><br><pre> <code class="swift hljs"><span class="hljs-type"><span class="hljs-type">Publishers</span></span>.fibonacci(<span class="hljs-built_in"><span class="hljs-built_in">count</span></span>: .unlimited) .<span class="hljs-built_in"><span class="hljs-built_in">print</span></span>() .<span class="hljs-keyword"><span class="hljs-keyword">prefix</span></span>(<span class="hljs-number"><span class="hljs-number">5</span></span>) .sink { <span class="hljs-number"><span class="hljs-number">_</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> } <span class="hljs-comment"><span class="hljs-comment">// prints 0 1 1 2 3 cancel - </span></span></code> </pre> <br><p>  Mendapat perilaku yang diharapkan. </p><br><h1 id="subscriber">  Pelanggan </h1><br><p>  Dan apakah FibonacciSubscription kami sudah siap?  Tidak juga, dalam pengujian kami, kami hanya menggunakan pelanggan wastafel yang meminta jumlah angka yang tidak terbatas, tetapi bagaimana jika kami menggunakan pelanggan yang akan mengharapkan jumlah angka tertentu.  Combine tidak menyediakan pelanggan seperti itu, tetapi apa yang menghalangi kami untuk menulis sendiri?  Di bawah ini adalah implementasi dari FibonacciSubscriber kami. </p><br><pre> <code class="swift hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">FibonacciSubscriber</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Subscriber</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">typealias</span></span> <span class="hljs-type"><span class="hljs-type">Input</span></span> = <span class="hljs-type"><span class="hljs-type">Int</span></span> <span class="hljs-keyword"><span class="hljs-keyword">typealias</span></span> <span class="hljs-type"><span class="hljs-type">Failure</span></span> = <span class="hljs-type"><span class="hljs-type">Never</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> limit: <span class="hljs-type"><span class="hljs-type">Subscribers</span></span>.<span class="hljs-type"><span class="hljs-type">Demand</span></span> <span class="hljs-keyword"><span class="hljs-keyword">init</span></span>(limit: <span class="hljs-type"><span class="hljs-type">Subscribers</span></span>.<span class="hljs-type"><span class="hljs-type">Demand</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.limit = limit } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">receive</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(subscription: Subscription)</span></span></span></span> { subscription.request(limit) } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">receive</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">_</span></span></span></span><span class="hljs-function"><span class="hljs-params"> input: Input)</span></span></span></span> -&gt; <span class="hljs-type"><span class="hljs-type">Subscribers</span></span>.<span class="hljs-type"><span class="hljs-type">Demand</span></span> { .<span class="hljs-keyword"><span class="hljs-keyword">none</span></span> } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">receive</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(completion: Subscribers.Completion&lt;Failure&gt;)</span></span></span></span> { <span class="hljs-built_in"><span class="hljs-built_in">print</span></span>(<span class="hljs-string"><span class="hljs-string">"Subscriber's completion: \(completion)"</span></span>) } }</code> </pre> <br><p>  Dan FibonacciSubscriber kami memiliki properti batas, yang menentukan berapa banyak elemen yang ingin diterima oleh Pelanggan ini.  Dan ini dilakukan dalam metode terima (_: Berlangganan), di mana kami memberi tahu langganan berapa banyak elemen yang kami butuhkan.  Penting juga untuk mencatat fungsi terima (_: Input) -&gt; Pelanggan. Permintaan, fungsi ini dipanggil ketika nilai baru diterima, sebagai nilai balik kami menunjukkan berapa banyak elemen tambahan yang ingin kami terima:. Tidak ada - tidak sama sekali, .max (N) N , secara total, jumlah total elemen yang diterima akan sama dengan jumlah nilai langganan yang dikirim dalam penerimaan (_: Berlangganan) dan semua nilai pengembalian dari menerima (_: Input) -&gt; Pelanggan. Permintaan. </p><br><h3 id="vtoroe-testirovanie">  Tes kedua </h3><br><p>  Mari kita coba menggunakan FibonacciSubscriber. </p><br><pre> <code class="swift hljs"><span class="hljs-keyword"><span class="hljs-keyword">let</span></span> subscriber = <span class="hljs-type"><span class="hljs-type">FibonacciSubscriber</span></span>(limit: .<span class="hljs-built_in"><span class="hljs-built_in">max</span></span>(<span class="hljs-number"><span class="hljs-number">3</span></span>)) <span class="hljs-type"><span class="hljs-type">Publishers</span></span>.fibonacci(<span class="hljs-built_in"><span class="hljs-built_in">count</span></span>: .<span class="hljs-built_in"><span class="hljs-built_in">max</span></span>(<span class="hljs-number"><span class="hljs-number">5</span></span>)) .<span class="hljs-built_in"><span class="hljs-built_in">print</span></span>() .subscribe(subscriber) <span class="hljs-comment"><span class="hljs-comment">// prints 0 1 1 2 3 -     0 1 1</span></span></code> </pre> <br><p>  Seperti yang kita lihat Penerbit kita mengirim 5 nilai, bukan 3. Mengapa begitu?  Karena metode request (_: Subscribers.Demand) dari FibonacciSubscription'a tidak memperhitungkan kebutuhan pelanggan, mari perbaiki, untuk ini kami akan menambahkan properti tambahan yang diminta, di mana kami akan melacak kebutuhan pelanggan. </p><br><pre> <code class="swift hljs"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">FibonacciSubscription</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">S</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Subscriber</span></span></span><span class="hljs-class">&gt;: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Subscription</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">where</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">S</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Input</span></span></span><span class="hljs-class"> == </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Int</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> subscriber: <span class="hljs-type"><span class="hljs-type">S?</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> configuration: <span class="hljs-type"><span class="hljs-type">FibonacciConfiguration</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> <span class="hljs-built_in"><span class="hljs-built_in">count</span></span>: <span class="hljs-type"><span class="hljs-type">Subscribers</span></span>.<span class="hljs-type"><span class="hljs-type">Demand</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> requested: <span class="hljs-type"><span class="hljs-type">Subscribers</span></span>.<span class="hljs-type"><span class="hljs-type">Demand</span></span> = .<span class="hljs-keyword"><span class="hljs-keyword">none</span></span> <span class="hljs-comment"><span class="hljs-comment">// new init(subscriber: S?, configuration: FibonacciConfiguration) { self.subscriber = subscriber self.configuration = configuration self.count = configuration.count } func cancel() { subscriber = nil } func request(_ demand: Subscribers.Demand) { guard count &gt; .none else { subscriber?.receive(completion: .finished) return } requested += demand // new count -= .max(1) requested -= .max(1) // new requested += subscriber?.receive(0) ?? .none // new guard let _ = subscriber, requested &gt; .none else { return } // new if count == .none { subscriber?.receive(completion: .finished) return } count -= .max(1) requested -= .max(1) // new requested += subscriber?.receive(1) ?? .none // new guard let _ = subscriber, requested &gt; .none else { return } // new if count == .none { subscriber?.receive(completion: .finished) return } var prev = 0 var current = 1 var temp: Int while let subscriber = subscriber, requested &gt; .none { // new temp = prev prev = current current += temp requested += subscriber.receive(current) // new count -= .max(1) requested -= .max(1) // new if count == .none { subscriber.receive(completion: .finished) return } } } }</span></span></code> </pre> <br><h3 id="trete-testirovanie">  Pengujian ketiga </h3><br><pre> <code class="swift hljs"><span class="hljs-keyword"><span class="hljs-keyword">let</span></span> subscriber = <span class="hljs-type"><span class="hljs-type">FibonacciSubscriber</span></span>(limit: .<span class="hljs-built_in"><span class="hljs-built_in">max</span></span>(<span class="hljs-number"><span class="hljs-number">3</span></span>)) <span class="hljs-type"><span class="hljs-type">Publishers</span></span>.fibonacci(<span class="hljs-built_in"><span class="hljs-built_in">count</span></span>: .<span class="hljs-built_in"><span class="hljs-built_in">max</span></span>(<span class="hljs-number"><span class="hljs-number">5</span></span>)) .<span class="hljs-built_in"><span class="hljs-built_in">print</span></span>() .subscribe(subscriber) <span class="hljs-comment"><span class="hljs-comment">// prints 0 1 1 - OK</span></span></code> </pre> <br><p>  Penerbit sekarang berfungsi dengan benar. </p><br><div class="spoiler">  <b class="spoiler_title">Kode akhir</b> <div class="spoiler_text"><pre> <code class="swift hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> Foundation <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> Combine struct FibonacciConfiguration { var count: Subscribers.Demand } struct FibonacciPublisher: Publisher { typealias Output = Int typealias Failure = Never var configuration: FibonacciConfiguration func receive&lt;S&gt;(subscriber: S) where S : Subscriber, Failure == S.Failure, Output == S.Input { let subscription = FibonacciSubscription(subscriber: subscriber, configuration: configuration) subscriber.receive(subscription: subscription) } } private final class FibonacciSubscription&lt;S: Subscriber&gt;: Subscription where S.Input == Int { var subscriber: S? var configuration: FibonacciConfiguration var count: Subscribers.Demand var requested: Subscribers.Demand = .none init(subscriber: S?, configuration: FibonacciConfiguration) { self.subscriber = subscriber self.configuration = configuration self.count = configuration.count } func cancel() { subscriber = nil } func request(_ demand: Subscribers.Demand) { guard count &gt; .none else { subscriber?.receive(completion: .finished) return } requested += demand count -= .max(1) requested -= .max(1) requested += subscriber?.receive(0) ?? .none guard let _ = subscriber, requested &gt; .none else { return } if count == .none { subscriber?.receive(completion: .finished) return } count -= .max(1) requested -= .max(1) requested += subscriber?.receive(1) ?? .none guard let _ = subscriber, requested &gt; .none else { return } if count == .none { subscriber?.receive(completion: .finished) return } var prev = 0 var current = 1 var temp: Int while let subscriber = subscriber, requested &gt; .none { temp = prev prev = current current += temp requested += subscriber.receive(current) count -= .max(1) requested -= .max(1) if count == .none { subscriber.receive(completion: .finished) return } } } } extension Publishers { private static func fibonacci(configuration: FibonacciConfiguration) -&gt; FibonacciPublisher { FibonacciPublisher(configuration: configuration) } static func fibonacci(count: Subscribers.Demand = .max(6)) -&gt; FibonacciPublisher { FibonacciPublisher(configuration: FibonacciConfiguration(count: count)) } } class FibonacciSubscriber: Subscriber { typealias Input = Int typealias Failure = Never var limit: Subscribers.Demand init(limit: Subscribers.Demand) { self.limit = limit } func receive(subscription: Subscription) { subscription.request(limit) } func receive(_ input: Input) -&gt; Subscribers.Demand { .none } func receive(completion: Subscribers.Completion&lt;Failure&gt;) { print("Subscriber's completion: \(completion)") } } Publishers.fibonacci(count: .max(4)) .print() .sink { _ in } let subscriber = FibonacciSubscriber(limit: .max(3)) Publishers.fibonacci(count: .max(5)) .print() .subscribe(subscriber)</code> </pre></div></div><br><h1 id="rezultat">  Hasil </h1><br><p>  Saya harap artikel ini memberi Anda lebih banyak pemahaman tentang apa itu Penerbit, Berlangganan dan Pelanggan, bagaimana mereka berinteraksi satu sama lain, dan poin apa yang perlu Anda perhatikan ketika Anda memutuskan untuk mengimplementasikan Penerbit Anda.  Ada komentar, klarifikasi untuk artikel ini. </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/id482690/">https://habr.com/ru/post/id482690/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../id482678/index.html">Bagaimana saya memutuskan untuk melakukan pencarian teks untuk iOS dan apa yang terjadi</a></li>
<li><a href="../id482680/index.html">Crypt, XOR, meretas ZIP dan PRSP yang tidak terenkripsi. Pemecahan masalah dengan r0ot-mi Crypto. Bagian 2</a></li>
<li><a href="../id482682/index.html">Otomasi Alat Qt</a></li>
<li><a href="../id482684/index.html">Saya membuat dipfake saya sendiri dalam dua minggu dan $ 552</a></li>
<li><a href="../id482686/index.html">Para ilmuwan mengotomatiskan penelitian perilaku hewan untuk memecahkan kode fungsi otak</a></li>
<li><a href="../id482692/index.html">Rumah Intel NUC untuk Bekerja dan Virtualisasi</a></li>
<li><a href="../id482694/index.html">Apakah ada kehidupan setelah Windows atau di mana mengembangkan administrator / insinyur sistem Windows pada tahun 2020?</a></li>
<li><a href="../id482698/index.html">[Esai] Didedikasikan untuk Kantor Plankton. Saya tidak terinspirasi oleh pekerjaan saya</a></li>
<li><a href="../id482700/index.html">Cara "bercinta" Google dan Yandex: promosi situs hitam dan putih SEO. Shestakov | Orang PRO # 74</a></li>
<li><a href="../id482702/index.html">Apakah kita benar-benar membutuhkan TypeScript pada tahun 2020?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>