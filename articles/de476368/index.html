<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üòò üî¥ üêì Erstellen einer Home CI / CD mit GitHub Actions und Python üíÜüèø üë®üèΩ‚Äçüç≥ üë®üèø‚Äçüé®</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Eines Abends, als ich von der Arbeit nach Hause kam, beschloss ich, ein paar Hausaufgaben zu machen. Ich habe einige √Ñnderungen vorgenommen und wollte...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Erstellen einer Home CI / CD mit GitHub Actions und Python</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/476368/"><p> Eines Abends, als ich von der Arbeit nach Hause kam, beschloss ich, ein paar Hausaufgaben zu machen.  Ich habe einige √Ñnderungen vorgenommen und wollte sofort damit experimentieren.  Aber vor den Experimenten musste ich in die VPS gehen, √Ñnderungen vornehmen, den Container neu erstellen und ausf√ºhren.  Dann entschied ich, dass es Zeit war, sich um die kontinuierliche Lieferung zu k√ºmmern. <br><img src="https://habrastorage.org/webt/xa/l4/dm/xal4dmowtxwpuoxxrutujwwy4fm.jpeg"></p><a name="habracut"></a><br><p>  Anfangs hatte ich die Wahl zwischen Circle CI, Travis oder Jenkins.  Ich habe Jenkins fast sofort ausgeschlossen, weil ich kein so leistungsf√§higes Werkzeug ben√∂tigte.  Nach einer kurzen Lekt√ºre √ºber Travis kam ich zu dem Schluss, dass es praktisch ist, es zusammenzubauen und zu testen, aber Sie k√∂nnen sich keine Lieferung damit vorstellen.  Ich habe von Circle CI durch √ºberm√§√üig aufdringliche Anzeigen auf YouTube erfahren.  Ich habe angefangen, mit Beispielen zu experimentieren, aber irgendwann habe ich mich geirrt und hatte ewige Tests, die mich viele kostbare Minuten der Montage gekostet haben (Im Allgemeinen gibt es eine ausreichende Grenze, um mir keine Sorgen zu machen, aber es hat mich getroffen).  Ich nahm die Suche wieder auf und stolperte √ºber Github Actions.  Nachdem ich mit den Get Started-Beispielen gespielt hatte, hatte ich einen positiven Eindruck und nach einem kurzen Blick auf die Dokumentation kam ich zu dem Schluss, dass es sehr cool ist, Geheimnisse f√ºr die Montage, das Sammeln und die praktische Bereitstellung von Projekten an einem Ort aufzubewahren.  Mit leuchtenden Augen zeichnete er schnell den gew√ºnschten Kurs und die Zahnr√§der drehten sich. </p><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/h1/fp/rv/h1fprvm3jru4em3vj0ae6xruu5i.jpeg" alt="planen"></div><br><p>  Zuerst werden wir versuchen, die Tests durchzuf√ºhren.  Als Experiment habe ich einen einfachen Webserver auf Flask mit 2 Endpunkten geschrieben: </p><br><div class="spoiler">  <b class="spoiler_title">Auflisten einer einfachen Webanwendung</b> <div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> flask <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> Flask <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> flask <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> request, jsonify app = Flask(__name__) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">validate_post_data</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(data: dict)</span></span></span><span class="hljs-function"> -&gt; bool:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> isinstance(data, dict): <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">False</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> data.get(<span class="hljs-string"><span class="hljs-string">'name'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> isinstance(data[<span class="hljs-string"><span class="hljs-string">'name'</span></span>], str): <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">False</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> data.get(<span class="hljs-string"><span class="hljs-string">'age'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> isinstance(data[<span class="hljs-string"><span class="hljs-string">'age'</span></span>], int): <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">False</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">True</span></span> @app.route(<span class="hljs-string"><span class="hljs-string">'/'</span></span>, methods=[<span class="hljs-string"><span class="hljs-string">'GET'</span></span>]) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">hello</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">'Hello World!'</span></span> @app.route(<span class="hljs-string"><span class="hljs-string">'/api'</span></span>, methods=[<span class="hljs-string"><span class="hljs-string">'GET'</span></span>, <span class="hljs-string"><span class="hljs-string">'POST'</span></span>]) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">api</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-string"><span class="hljs-string">""" /api entpoint GET - returns json= {'status': 'test'} POST - { name - str not null age - int optional } :return: """</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> request.method == <span class="hljs-string"><span class="hljs-string">'GET'</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> jsonify({<span class="hljs-string"><span class="hljs-string">'status'</span></span>: <span class="hljs-string"><span class="hljs-string">'test'</span></span>}) <span class="hljs-keyword"><span class="hljs-keyword">elif</span></span> request.method == <span class="hljs-string"><span class="hljs-string">'POST'</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> validate_post_data(request.json): <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> jsonify({<span class="hljs-string"><span class="hljs-string">'status'</span></span>: <span class="hljs-string"><span class="hljs-string">'OK'</span></span>}) <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> jsonify({<span class="hljs-string"><span class="hljs-string">'status'</span></span>: <span class="hljs-string"><span class="hljs-string">'bad input'</span></span>}), <span class="hljs-number"><span class="hljs-number">400</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">:</span></span> app.run(host=<span class="hljs-string"><span class="hljs-string">'0.0.0.0'</span></span>, port=<span class="hljs-number"><span class="hljs-number">8080</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> __name__ == <span class="hljs-string"><span class="hljs-string">'__main__'</span></span>: main()</code> </pre> </div></div><br><p>  Und ein paar Tests: </p><br><div class="spoiler">  <b class="spoiler_title">Liste der Anwendungstests</b> <div class="spoiler_text"><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> unittest <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> app <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> tested_app <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> json <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">FlaskAppTests</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(unittest.TestCase)</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setUp</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> tested_app.app.config[<span class="hljs-string"><span class="hljs-string">'TESTING'</span></span>] = <span class="hljs-keyword"><span class="hljs-keyword">True</span></span> self.app = tested_app.app.test_client() <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">test_get_hello_endpoint</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> r = self.app.get(<span class="hljs-string"><span class="hljs-string">'/'</span></span>) self.assertEqual(r.data, <span class="hljs-string"><span class="hljs-string">b'Hello World!'</span></span>) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">test_post_hello_endpoint</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> r = self.app.post(<span class="hljs-string"><span class="hljs-string">'/'</span></span>) self.assertEqual(r.status_code, <span class="hljs-number"><span class="hljs-number">405</span></span>) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">test_get_api_endpoint</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> r = self.app.get(<span class="hljs-string"><span class="hljs-string">'/api'</span></span>) self.assertEqual(r.json, {<span class="hljs-string"><span class="hljs-string">'status'</span></span>: <span class="hljs-string"><span class="hljs-string">'test'</span></span>}) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">test_correct_post_api_endpoint</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> r = self.app.post(<span class="hljs-string"><span class="hljs-string">'/api'</span></span>, content_type=<span class="hljs-string"><span class="hljs-string">'application/json'</span></span>, data=json.dumps({<span class="hljs-string"><span class="hljs-string">'name'</span></span>: <span class="hljs-string"><span class="hljs-string">'Den'</span></span>, <span class="hljs-string"><span class="hljs-string">'age'</span></span>: <span class="hljs-number"><span class="hljs-number">100</span></span>})) self.assertEqual(r.json, {<span class="hljs-string"><span class="hljs-string">'status'</span></span>: <span class="hljs-string"><span class="hljs-string">'OK'</span></span>}) self.assertEqual(r.status_code, <span class="hljs-number"><span class="hljs-number">200</span></span>) r = self.app.post(<span class="hljs-string"><span class="hljs-string">'/api'</span></span>, content_type=<span class="hljs-string"><span class="hljs-string">'application/json'</span></span>, data=json.dumps({<span class="hljs-string"><span class="hljs-string">'name'</span></span>: <span class="hljs-string"><span class="hljs-string">'Den'</span></span>})) self.assertEqual(r.json, {<span class="hljs-string"><span class="hljs-string">'status'</span></span>: <span class="hljs-string"><span class="hljs-string">'OK'</span></span>}) self.assertEqual(r.status_code, <span class="hljs-number"><span class="hljs-number">200</span></span>) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">test_not_dict_post_api_endpoint</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> r = self.app.post(<span class="hljs-string"><span class="hljs-string">'/api'</span></span>, content_type=<span class="hljs-string"><span class="hljs-string">'application/json'</span></span>, data=json.dumps([{<span class="hljs-string"><span class="hljs-string">'name'</span></span>: <span class="hljs-string"><span class="hljs-string">'Den'</span></span>}])) self.assertEqual(r.json, {<span class="hljs-string"><span class="hljs-string">'status'</span></span>: <span class="hljs-string"><span class="hljs-string">'bad input'</span></span>}) self.assertEqual(r.status_code, <span class="hljs-number"><span class="hljs-number">400</span></span>) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">test_no_name_post_api_endpoint</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> r = self.app.post(<span class="hljs-string"><span class="hljs-string">'/api'</span></span>, content_type=<span class="hljs-string"><span class="hljs-string">'application/json'</span></span>, data=json.dumps({<span class="hljs-string"><span class="hljs-string">'age'</span></span>: <span class="hljs-number"><span class="hljs-number">100</span></span>})) self.assertEqual(r.json, {<span class="hljs-string"><span class="hljs-string">'status'</span></span>: <span class="hljs-string"><span class="hljs-string">'bad input'</span></span>}) self.assertEqual(r.status_code, <span class="hljs-number"><span class="hljs-number">400</span></span>) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">test_bad_age_post_api_endpoint</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> r = self.app.post(<span class="hljs-string"><span class="hljs-string">'/api'</span></span>, content_type=<span class="hljs-string"><span class="hljs-string">'application/json'</span></span>, data=json.dumps({<span class="hljs-string"><span class="hljs-string">'name'</span></span>: <span class="hljs-string"><span class="hljs-string">'Den'</span></span>, <span class="hljs-string"><span class="hljs-string">'age'</span></span>: <span class="hljs-string"><span class="hljs-string">'100'</span></span>})) self.assertEqual(r.json, {<span class="hljs-string"><span class="hljs-string">'status'</span></span>: <span class="hljs-string"><span class="hljs-string">'bad input'</span></span>}) self.assertEqual(r.status_code, <span class="hljs-number"><span class="hljs-number">400</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> __name__ == <span class="hljs-string"><span class="hljs-string">'__main__'</span></span>: unittest.main()</code> : <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> unittest <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> app <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> tested_app <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> json <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">FlaskAppTests</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(unittest.TestCase)</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setUp</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> tested_app.app.config[<span class="hljs-string"><span class="hljs-string">'TESTING'</span></span>] = <span class="hljs-keyword"><span class="hljs-keyword">True</span></span> self.app = tested_app.app.test_client() <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">test_get_hello_endpoint</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> r = self.app.get(<span class="hljs-string"><span class="hljs-string">'/'</span></span>) self.assertEqual(r.data, <span class="hljs-string"><span class="hljs-string">b'Hello World!'</span></span>) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">test_post_hello_endpoint</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> r = self.app.post(<span class="hljs-string"><span class="hljs-string">'/'</span></span>) self.assertEqual(r.status_code, <span class="hljs-number"><span class="hljs-number">405</span></span>) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">test_get_api_endpoint</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> r = self.app.get(<span class="hljs-string"><span class="hljs-string">'/api'</span></span>) self.assertEqual(r.json, {<span class="hljs-string"><span class="hljs-string">'status'</span></span>: <span class="hljs-string"><span class="hljs-string">'test'</span></span>}) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">test_correct_post_api_endpoint</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> r = self.app.post(<span class="hljs-string"><span class="hljs-string">'/api'</span></span>, content_type=<span class="hljs-string"><span class="hljs-string">'application/json'</span></span>, data=json.dumps({<span class="hljs-string"><span class="hljs-string">'name'</span></span>: <span class="hljs-string"><span class="hljs-string">'Den'</span></span>, <span class="hljs-string"><span class="hljs-string">'age'</span></span>: <span class="hljs-number"><span class="hljs-number">100</span></span>})) self.assertEqual(r.json, {<span class="hljs-string"><span class="hljs-string">'status'</span></span>: <span class="hljs-string"><span class="hljs-string">'OK'</span></span>}) self.assertEqual(r.status_code, <span class="hljs-number"><span class="hljs-number">200</span></span>) r = self.app.post(<span class="hljs-string"><span class="hljs-string">'/api'</span></span>, content_type=<span class="hljs-string"><span class="hljs-string">'application/json'</span></span>, data=json.dumps({<span class="hljs-string"><span class="hljs-string">'name'</span></span>: <span class="hljs-string"><span class="hljs-string">'Den'</span></span>})) self.assertEqual(r.json, {<span class="hljs-string"><span class="hljs-string">'status'</span></span>: <span class="hljs-string"><span class="hljs-string">'OK'</span></span>}) self.assertEqual(r.status_code, <span class="hljs-number"><span class="hljs-number">200</span></span>) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">test_not_dict_post_api_endpoint</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> r = self.app.post(<span class="hljs-string"><span class="hljs-string">'/api'</span></span>, content_type=<span class="hljs-string"><span class="hljs-string">'application/json'</span></span>, data=json.dumps([{<span class="hljs-string"><span class="hljs-string">'name'</span></span>: <span class="hljs-string"><span class="hljs-string">'Den'</span></span>}])) self.assertEqual(r.json, {<span class="hljs-string"><span class="hljs-string">'status'</span></span>: <span class="hljs-string"><span class="hljs-string">'bad input'</span></span>}) self.assertEqual(r.status_code, <span class="hljs-number"><span class="hljs-number">400</span></span>) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">test_no_name_post_api_endpoint</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> r = self.app.post(<span class="hljs-string"><span class="hljs-string">'/api'</span></span>, content_type=<span class="hljs-string"><span class="hljs-string">'application/json'</span></span>, data=json.dumps({<span class="hljs-string"><span class="hljs-string">'age'</span></span>: <span class="hljs-number"><span class="hljs-number">100</span></span>})) self.assertEqual(r.json, {<span class="hljs-string"><span class="hljs-string">'status'</span></span>: <span class="hljs-string"><span class="hljs-string">'bad input'</span></span>}) self.assertEqual(r.status_code, <span class="hljs-number"><span class="hljs-number">400</span></span>) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">test_bad_age_post_api_endpoint</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> r = self.app.post(<span class="hljs-string"><span class="hljs-string">'/api'</span></span>, content_type=<span class="hljs-string"><span class="hljs-string">'application/json'</span></span>, data=json.dumps({<span class="hljs-string"><span class="hljs-string">'name'</span></span>: <span class="hljs-string"><span class="hljs-string">'Den'</span></span>, <span class="hljs-string"><span class="hljs-string">'age'</span></span>: <span class="hljs-string"><span class="hljs-string">'100'</span></span>})) self.assertEqual(r.json, {<span class="hljs-string"><span class="hljs-string">'status'</span></span>: <span class="hljs-string"><span class="hljs-string">'bad input'</span></span>}) self.assertEqual(r.status_code, <span class="hljs-number"><span class="hljs-number">400</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> __name__ == <span class="hljs-string"><span class="hljs-string">'__main__'</span></span>: unittest.main()</code> </pre> </div></div><br><p>  Coverage-Ausgabe: </p><br><pre> <code class="plaintext hljs">coverage report Name Stmts Miss Cover ------------------------------------------------------------------ src/app.py 28 2 93% src/tests.py 37 0 100% ------------------------------------------------------------------ TOTAL 65 2 96%</code> </pre> <br><p>  Erstellen Sie nun unsere erste Aktion, mit der die Tests ausgef√ºhrt werden.  Gem√§√ü der Dokumentation sollten alle Aktionen in einem speziellen Verzeichnis gespeichert werden: </p><br><pre> <code class="bash hljs">$ mkdir -p .github/workflows $ touch .github/workflows/test_on_push.yaml</code> </pre> <br><p>  Ich m√∂chte, dass diese Aktion bei jedem Push-Ereignis in jedem Zweig ausgef√ºhrt wird, mit Ausnahme von Releases (Tags, da separate Tests durchgef√ºhrt werden): </p><br><pre> <code class="plaintext hljs">on: push: tags: - '!refs/tags/*' branches: - '*'</code> </pre> <br><p>  Dann erstellen wir eine Aufgabe, die in der neuesten verf√ºgbaren Version von Ubuntu ausgef√ºhrt wird: </p><br><pre> <code class="plaintext hljs">jobs: run_tests: runs-on: [ubuntu-latest]</code> </pre> <br><p>  In Schritten √ºberpr√ºfen wir den Code, installieren Python, installieren Abh√§ngigkeiten, f√ºhren Tests durch und zeigen die Abdeckung an: </p><br><pre> <code class="plaintext hljs">steps: #   - uses: actions/checkout@master #  python   - uses: actions/setup-python@v1 with: python-version: '3.8' architecture: 'x64' - name: Install requirements #   run: pip install -r requirements.txt - name: Run tests run: coverage run src/tests.py - name: Tests report run: coverage report</code> </pre> <br><div class="spoiler">  <b class="spoiler_title">Alle zusammen</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">name: Run tests on any Push event #    push    ,    . #      on: push: tags: - '!refs/tags/*' branches: - '*' jobs: run_tests: runs-on: [ubuntu-latest] steps: #   - uses: actions/checkout@master #  python   - uses: actions/setup-python@v1 with: python-version: '3.8' architecture: 'x64' - name: Install requirements #   run: pip install -r requirements.txt - name: Run tests run: coverage run src/tests.py - name: Tests report run: coverage report</code> </pre> </div></div><br><p>  Versuchen wir, ein Commit zu erstellen und zu sehen, wie unsere Aktion funktioniert. <br><img src="https://habrastorage.org/webt/qy/v7/by/qyv7byybfnvpnkurriqvydsp_xk.png"><br>  <em>Bestehen von Tests in der Aktionsoberfl√§che</em> </p><br><p>  Hurra, wir haben es geschafft, die erste Aktion zu erstellen und auszuf√ºhren!  Versuchen wir einen Test zu unterbrechen und schauen uns die Ausgabe an: <br><img src="https://habrastorage.org/webt/dr/vn/_s/drvn_sgrq-esw6sgxjiylhhy02w.png"><br>  <em>Testet den Absturz in der Aktionsoberfl√§che</em> </p><br><p>  Die Tests sind fehlgeschlagen.  Die Anzeige wurde rot und erhielt sogar eine Benachrichtigung per E-Mail.  Was du brauchst!  3 der 8 Punkte kann eine Zielschaltung konfiguriert betrachtet werden.  Versuchen Sie nun mit der Montage, um herauszufinden, halten unsere Docker Bilder. </p><br><p>  <strong>Hinweis!</strong>  <strong>Als n√§chstes ben√∂tigen wir ein <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Docker-</a> Konto</strong> </p><br><p>  Zuerst schreiben wir ein einfaches Dockerfile, in dem unsere Anwendung ausgef√ºhrt wird. </p><br><div class="spoiler">  <b class="spoiler_title">Dockerfile</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">#     FROM python:3.8-alpine #        /app  COPY ./ /app #    RUN apk update &amp;&amp; pip install -r /app/requirements.txt --no-cache-dir #   (  Distutils) RUN pip install -e /app #      EXPOSE 8080 #       CMD web_server #    distutils      #CMD python /app/src/app.py</code> </pre> </div></div><br><p>  Um den Container an den Hub zu senden, muss man sich beim Docker anmelden. Da ich aber nicht m√∂chte, dass die ganze Welt das Kennwort f√ºr das Konto erf√§hrt, verwende ich die in GitHub integrierten Geheimnisse.  Im Allgemeinen k√∂nnen nur Passw√∂rter in Geheimnisse gesteckt werden, und der Rest wird in * .yaml fest codiert, und dies wird funktionieren.  Aber ich m√∂chte meine Aktionen ohne √Ñnderungen kopieren und alle spezifischen Informationen aus den Geheimnissen herausholen. </p><br><p><img src="https://habrastorage.org/webt/2c/h8/5t/2ch85tdbuovsc7ywejh5gmrmvgw.png"><br>  <em>Github-Geheimnisse</em> </p><br><p>  DOCKER_LOGIN - Anmeldung in hub.docker.com <br>  DOCKER_PWD - Passwort <br>  DOCKER_NAME - Name des Docker-Repositorys f√ºr dieses Projekt (muss im Voraus erstellt werden) </p><br><p>  Okay, die Vorbereitung ist abgeschlossen, jetzt erstellen wir unsere zweite Aktion: </p><br><pre> <code class="bash hljs">$ touch .github/workflows/pub_on_release.yaml</code> </pre> <br><p>  Wir kopieren die Tests von der vorherigen Aktion, mit Ausnahme des Starttriggers (ich konnte die Aktionen nicht importieren).  Wir ersetzen es durch "Launch on Release": </p><br><pre> <code class="plaintext hljs">on: release: types: [published]</code> </pre> <br><p>  <strong>WICHTIG!</strong>  <strong>Es ist sehr wichtig, die richtige Bedingung f√ºr das Ereignis zu erf√ºllen</strong> <br>  Wenn on.release beispielsweise keine Typen angibt, l√∂st dieses Ereignis mindestens zwei Ereignisse aus: ver√∂ffentlicht und erstellt.  Dass es wird einmal 2 des Montageprozesses gestartet werden. </p><br><p>  Nun werden wir in der gleichen Datei eine weitere Aufgabe ausf√ºhren, abh√§ngig von der ersten: </p><br><pre> <code class="plaintext hljs">build_and_pub: needs: [run_tests]</code> </pre> <br><p>  needs - sagt, dass diese Task erst startet, wenn run_tests endet </p><br><p>  <strong>WICHTIG!</strong>  <strong>Wenn Sie √ºber mehrere Aktionsdateien und mehrere Aufgaben verf√ºgen, werden diese gleichzeitig in verschiedenen Umgebungen ausgef√ºhrt.</strong>  F√ºr jede Aufgabe wird unabh√§ngig von anderen Aufgaben eine separate Umgebung erstellt.  Wenn Sie keine Anforderungen angeben, werden die Testaufgabe und die Assemblys gleichzeitig und unabh√§ngig voneinander gestartet. </p><br><p>  F√ºgen Sie Umgebungsvariablen hinzu, in denen unsere Geheimnisse sein werden: </p><br><pre> <code class="plaintext hljs">env: LOGIN: ${{ secrets.DOCKER_LOGIN }} NAME: ${{ secrets.DOCKER_NAME }}</code> </pre> <br><p>  In diesen Schritten m√ºssen wir uns beim Docker anmelden, den Container sammeln und in der Registrierung ver√∂ffentlichen: </p><br><pre> <code class="plaintext hljs">steps: - name: Login to docker.io run: echo ${{ secrets.DOCKER_PWD }} | docker login -u ${{ secrets.DOCKER_LOGIN }} --password-stdin - uses: actions/checkout@master - name: Build image run: docker build -t $LOGIN/$NAME:${GITHUB_REF:11} -f Dockerfile . - name: Push image to docker.io run: docker push $LOGIN/$NAME:${GITHUB_REF:11}</code> </pre> <br><p>  $ {GITHUB_REF: 11} ist eine Github-Variable, die eine Zeile mit einem Verweis auf das Ereignis speichert, f√ºr das der Trigger ausgef√ºhrt wurde (Zweigname, Tag usw.). Wenn wir Tags im Format "v0.0.0" haben, m√ºssen Sie die ersten 11 abschneiden Zeichen, dann bleibt "0.0.0". </p><br><p>  Gib den Code ein und erstelle ein neues Tag.  Und wir sehen, dass unser Container erfolgreich zusammengestellt und an die Registrierung gesendet wurde, und wir haben unser Passwort nirgendwo aufleuchten lassen. </p><br><p><img src="https://habrastorage.org/webt/mg/yt/i-/mgyti-mww_fcqsmbiqk6zli7swo.png"><br>  <em>Erstellen und versenden Sie Container in der Aktionsoberfl√§che</em> </p><br><p>  √úberpr√ºfen Sie den Hub: </p><br><p><img src="https://habrastorage.org/webt/ut/nw/vd/utnwvdtcprbqfpavnnirqmqim0s.png"><br>  <em>Container in Docker-Hub gespeichert</em> </p><br><p>  Alles funktioniert, aber die schwierigste Aufgabe bleibt - Bereitstellung.  Hier ben√∂tigen Sie bereits einen VPS und eine wei√üe IP-Adresse, wo wir den Container bereitstellen und wo Sie den Hook senden k√∂nnen.  Theoretisch k√∂nnen Sie auf der Seite des VPS oder des Heimservers ein Skript auf der Krone ausf√ºhren, das bei einem neuen Image ausgel√∂st wird, oder auf irgendeine Weise mit dem Telegramm-Bot spielen.  Es gibt sicherlich unz√§hlige M√∂glichkeiten, dies zu tun.  Aber ich werde mit externer ip arbeiten.  Um nicht schlau zu sein, habe ich einen kleinen Webservice in Flask mit einer einfachen API geschrieben. <br>  Kurz gesagt, es gibt 1 Endpunkt ‚Äû/‚Äú. <br>  Eine GET-Anforderung gibt json mit allen aktiven Containern auf dem Host zur√ºck. <br>  POST - empf√§ngt die Daten im Format: </p><br><pre> <code class="json hljs">{ <span class="hljs-attr"><span class="hljs-attr">"owner"</span></span>: <span class="hljs-string"><span class="hljs-string">"  "</span></span>, <span class="hljs-attr"><span class="hljs-attr">"repository"</span></span>: <span class="hljs-string"><span class="hljs-string">"  "</span></span>, <span class="hljs-attr"><span class="hljs-attr">"tag"</span></span>: <span class="hljs-string"><span class="hljs-string">"v0.0.1"</span></span>, #    <span class="hljs-attr"><span class="hljs-attr">"ports"</span></span>: {<span class="hljs-attr"><span class="hljs-attr">"8080"</span></span>: <span class="hljs-number"><span class="hljs-number">8080</span></span>, ‚Äú443‚Äù: <span class="hljs-number"><span class="hljs-number">443</span></span>} #      }</code> </pre> <br><p>  Was passiert auf dem Host: </p><br><ol><li>  vom empfangenen json wird der name des neuen bildes abgeholt </li><li>  ein neues Bild ist gew√∂lbt </li><li>  Wenn das Bild heruntergeladen wurde, wird der aktuelle Container angehalten und gel√∂scht </li><li>  ein neuer Container wird gestartet, mit der Ver√∂ffentlichung von Ports (-p Flag) </li></ol><br><p>  Alle Arbeiten mit Docker werden mit der <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Docker-Py-</a> Bibliothek durchgef√ºhrt </p><br><p>  Es w√§re sehr falsch, einen solchen Dienst ohne minimalen Schutz im Internet zu ver√∂ffentlichen, und ich habe einen Anschein von API KEY gemacht, der Dienst liest das Token aus den Umgebungsvariablen und vergleicht es dann mit dem Header {Authorization: CI_TOKEN} </p><br><div class="spoiler">  <b class="spoiler_title">Webserverliste f√ºr die Bereitstellung</b> <div class="spoiler_text"><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment"># coding=utf-8 import os import sys import logging import logging.config import logging.handlers from flask import Flask from flask import request, jsonify import docker log = logging.getLogger(__name__) app = Flask(__name__) docker_client = docker.from_env() MY_AUTH_TOKEN = os.getenv('CI_TOKEN', None) #       def init_logging(): """   :return: """ log_format = f"[%(asctime)s] [ CI/CD server ] [%(levelname)s]:%(name)s:%(message)s" formatters = {'basic': {'format': log_format}} handlers = {'stdout': {'class': 'logging.StreamHandler', 'formatter': 'basic'}} level = 'INFO' handlers_names = ['stdout'] loggers = { '': { 'level': level, 'propagate': False, 'handlers': handlers_names }, } logging.basicConfig(level='INFO', format=log_format) log_config = { 'version': 1, 'disable_existing_loggers': False, 'formatters': formatters, 'handlers': handlers, 'loggers': loggers } logging.config.dictConfig(log_config) def get_active_containers(): """     :return: """ containers = docker_client.containers.list() result = [] for container in containers: result.append({ 'short_id': container.short_id, 'container_name': container.name, 'image_name': container.image.tags, 'created': container.attrs['Created'], 'status': container.status, 'ports': container.ports, }) return result def get_container_name(item: dict) -&gt; [str, str]: """   image  POST  :param item: :return: """ if not isinstance(item, dict): return '' owner = item.get('owner') repository = item.get('repository') tag = item.get('tag', 'latest').replace('v', '') if owner and repository and tag: return f'{owner}/{repository}:{tag}', repository if repository and tag: return f'{repository}:{tag}', repository return '', '' def kill_old_container(container_name: str) -&gt; bool: """    ,   :param container_name: :return: """ try: #    container = docker_client.containers.get(container_name) #  container.kill() except Exception as e: #       log.warning(f'Error while delete container {container_name}, {e}') return False finally: #   ,     log.debug(docker_client.containers.prune()) log.info(f'Container deleted. container_name = {container_name}') return True def deploy_new_container(image_name: str, container_name: str, ports: dict = None): try: #   image  docker hub'a log.info(f'pull {image_name}, name={container_name}') docker_client.images.pull(image_name) log.debug('Success') kill_old_container(container_name) log.debug('Old killed') #    docker_client.containers.run(image=image_name, name=container_name, detach=True, ports=ports) except Exception as e: log.error(f'Error while deploy container {container_name}, \n{e}') return {'status': False, 'error': str(e)}, 400 log.info(f'Container deployed. container_name = {container_name}') return {'status': True}, 200 @app.route('/', methods=['GET', 'POST']) def MainHandler(): """ GET -      POST -      : { "owner": "gonfff", "repository": "ci_example", "tag": "v0.0.1", "ports": {"8080": 8080} } :return: """ if request.headers.get('Authorization') != MY_AUTH_TOKEN: return jsonify({'message': 'Bad token'}), 401 if request.method == 'GET': return jsonify(get_active_containers()) elif request.method == 'POST': log.debug(f'Recieved {request.data}') image_name, container_name = get_container_name(request.json) ports = request.json.get('ports') if request.json.get('ports') else None result, status = deploy_new_container(image_name, container_name, ports) return jsonify(result), status def main(): init_logging() if not MY_AUTH_TOKEN: log.error('There is no auth token in env') sys.exit(1) app.run(host='0.0.0.0', port=5000) if __name__ == '__main__': main()</span></span></code> Sie <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment"># coding=utf-8 import os import sys import logging import logging.config import logging.handlers from flask import Flask from flask import request, jsonify import docker log = logging.getLogger(__name__) app = Flask(__name__) docker_client = docker.from_env() MY_AUTH_TOKEN = os.getenv('CI_TOKEN', None) #       def init_logging(): """   :return: """ log_format = f"[%(asctime)s] [ CI/CD server ] [%(levelname)s]:%(name)s:%(message)s" formatters = {'basic': {'format': log_format}} handlers = {'stdout': {'class': 'logging.StreamHandler', 'formatter': 'basic'}} level = 'INFO' handlers_names = ['stdout'] loggers = { '': { 'level': level, 'propagate': False, 'handlers': handlers_names }, } logging.basicConfig(level='INFO', format=log_format) log_config = { 'version': 1, 'disable_existing_loggers': False, 'formatters': formatters, 'handlers': handlers, 'loggers': loggers } logging.config.dictConfig(log_config) def get_active_containers(): """     :return: """ containers = docker_client.containers.list() result = [] for container in containers: result.append({ 'short_id': container.short_id, 'container_name': container.name, 'image_name': container.image.tags, 'created': container.attrs['Created'], 'status': container.status, 'ports': container.ports, }) return result def get_container_name(item: dict) -&gt; [str, str]: """   image  POST  :param item: :return: """ if not isinstance(item, dict): return '' owner = item.get('owner') repository = item.get('repository') tag = item.get('tag', 'latest').replace('v', '') if owner and repository and tag: return f'{owner}/{repository}:{tag}', repository if repository and tag: return f'{repository}:{tag}', repository return '', '' def kill_old_container(container_name: str) -&gt; bool: """    ,   :param container_name: :return: """ try: #    container = docker_client.containers.get(container_name) #  container.kill() except Exception as e: #       log.warning(f'Error while delete container {container_name}, {e}') return False finally: #   ,     log.debug(docker_client.containers.prune()) log.info(f'Container deleted. container_name = {container_name}') return True def deploy_new_container(image_name: str, container_name: str, ports: dict = None): try: #   image  docker hub'a log.info(f'pull {image_name}, name={container_name}') docker_client.images.pull(image_name) log.debug('Success') kill_old_container(container_name) log.debug('Old killed') #    docker_client.containers.run(image=image_name, name=container_name, detach=True, ports=ports) except Exception as e: log.error(f'Error while deploy container {container_name}, \n{e}') return {'status': False, 'error': str(e)}, 400 log.info(f'Container deployed. container_name = {container_name}') return {'status': True}, 200 @app.route('/', methods=['GET', 'POST']) def MainHandler(): """ GET -      POST -      : { "owner": "gonfff", "repository": "ci_example", "tag": "v0.0.1", "ports": {"8080": 8080} } :return: """ if request.headers.get('Authorization') != MY_AUTH_TOKEN: return jsonify({'message': 'Bad token'}), 401 if request.method == 'GET': return jsonify(get_active_containers()) elif request.method == 'POST': log.debug(f'Recieved {request.data}') image_name, container_name = get_container_name(request.json) ports = request.json.get('ports') if request.json.get('ports') else None result, status = deploy_new_container(image_name, container_name, ports) return jsonify(result), status def main(): init_logging() if not MY_AUTH_TOKEN: log.error('There is no auth token in env') sys.exit(1) app.run(host='0.0.0.0', port=5000) if __name__ == '__main__': main()</span></span></code> Sie <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment"># coding=utf-8 import os import sys import logging import logging.config import logging.handlers from flask import Flask from flask import request, jsonify import docker log = logging.getLogger(__name__) app = Flask(__name__) docker_client = docker.from_env() MY_AUTH_TOKEN = os.getenv('CI_TOKEN', None) #       def init_logging(): """   :return: """ log_format = f"[%(asctime)s] [ CI/CD server ] [%(levelname)s]:%(name)s:%(message)s" formatters = {'basic': {'format': log_format}} handlers = {'stdout': {'class': 'logging.StreamHandler', 'formatter': 'basic'}} level = 'INFO' handlers_names = ['stdout'] loggers = { '': { 'level': level, 'propagate': False, 'handlers': handlers_names }, } logging.basicConfig(level='INFO', format=log_format) log_config = { 'version': 1, 'disable_existing_loggers': False, 'formatters': formatters, 'handlers': handlers, 'loggers': loggers } logging.config.dictConfig(log_config) def get_active_containers(): """     :return: """ containers = docker_client.containers.list() result = [] for container in containers: result.append({ 'short_id': container.short_id, 'container_name': container.name, 'image_name': container.image.tags, 'created': container.attrs['Created'], 'status': container.status, 'ports': container.ports, }) return result def get_container_name(item: dict) -&gt; [str, str]: """   image  POST  :param item: :return: """ if not isinstance(item, dict): return '' owner = item.get('owner') repository = item.get('repository') tag = item.get('tag', 'latest').replace('v', '') if owner and repository and tag: return f'{owner}/{repository}:{tag}', repository if repository and tag: return f'{repository}:{tag}', repository return '', '' def kill_old_container(container_name: str) -&gt; bool: """    ,   :param container_name: :return: """ try: #    container = docker_client.containers.get(container_name) #  container.kill() except Exception as e: #       log.warning(f'Error while delete container {container_name}, {e}') return False finally: #   ,     log.debug(docker_client.containers.prune()) log.info(f'Container deleted. container_name = {container_name}') return True def deploy_new_container(image_name: str, container_name: str, ports: dict = None): try: #   image  docker hub'a log.info(f'pull {image_name}, name={container_name}') docker_client.images.pull(image_name) log.debug('Success') kill_old_container(container_name) log.debug('Old killed') #    docker_client.containers.run(image=image_name, name=container_name, detach=True, ports=ports) except Exception as e: log.error(f'Error while deploy container {container_name}, \n{e}') return {'status': False, 'error': str(e)}, 400 log.info(f'Container deployed. container_name = {container_name}') return {'status': True}, 200 @app.route('/', methods=['GET', 'POST']) def MainHandler(): """ GET -      POST -      : { "owner": "gonfff", "repository": "ci_example", "tag": "v0.0.1", "ports": {"8080": 8080} } :return: """ if request.headers.get('Authorization') != MY_AUTH_TOKEN: return jsonify({'message': 'Bad token'}), 401 if request.method == 'GET': return jsonify(get_active_containers()) elif request.method == 'POST': log.debug(f'Recieved {request.data}') image_name, container_name = get_container_name(request.json) ports = request.json.get('ports') if request.json.get('ports') else None result, status = deploy_new_container(image_name, container_name, ports) return jsonify(result), status def main(): init_logging() if not MY_AUTH_TOKEN: log.error('There is no auth token in env') sys.exit(1) app.run(host='0.0.0.0', port=5000) if __name__ == '__main__': main()</span></span></code> </pre> </div></div><br><p>  F√ºr diese Anwendung habe ich auch setup.py verwendet, um sie auf dem System zu installieren.  Sie k√∂nnen es installieren mit: </p><br><pre> <code class="bash hljs">$ python3 setup.sy install</code> </pre> <br><p>  vorausgesetzt, Sie haben die Dateien heruntergeladen und befinden sich im Verzeichnis dieser Anwendung. <br>  Nach der Installation m√ºssen Sie die Anwendung als Dienst aktivieren, damit sie sich beim Neustart des Servers von selbst startet. Hierzu verwenden wir <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">systemd</a> <br>  Hier ist eine Beispielkonfigurationsdatei: </p><br><pre> <code class="plaintext hljs">[Unit] Description=Deployment web server After=network-online.target [Service] Type=simple RestartSec=3 ExecStart=/usr/local/bin/ci_example Environment=CI_TOKEN=#&lt;I generate it with $(openssl rand -hex 20)&gt; [Install] WantedBy=multi-user.target</code> </pre><br><p>  Es bleibt nur zu laufen: </p><br><pre> <code class="bash hljs">$ sudo systemctl daemon-reload $ sudo systemctl <span class="hljs-built_in"><span class="hljs-built_in">enable</span></span> ci_example.service $ sudo systemctl start ci_example.service</code> </pre> <br><p>  Mit dem Befehl k√∂nnen Sie das Protokoll des Web Delivery-Servers anzeigen </p><br><pre> <code class="bash hljs">$ sudo systemctl status ci_example.service</code> </pre> <br><p>  Der Serverteil ist fertig, es bleibt nur noch ein Hook zu unserer Aktion hinzuzuf√ºgen.  F√ºgen Sie dazu die Geheimnisse der IP-Adresse unseres Servers und die CI_TOKEN hinzu, die wir bei der Installation der Anwendung generiert haben. <br>  Zuerst wollte ich eine bereit, Ma√ünahmen zu locken verwenden, um von marketpleysa Github, aber leider, entfernt er die Zitate aus der POST-Anfrage K√∂rper, dass es unm√∂glich zu analysieren json macht.  Dies passte offensichtlich nicht zu mir und ich entschied mich f√ºr die eingebaute Locke in Ubuntu (auf der ich Container sammle), was sich im √úbrigen positiv auf die Leistung auswirkte, da keine Montage eines zus√§tzlichen Containers erforderlich ist: </p><br><pre> <code class="plaintext hljs">deploy: needs: [build_and_pub] runs-on: [ubuntu-latest] steps: - name: Set tag to env run: echo ::set-env name=TAG::$(echo ${GITHUB_REF:11}) - name: Send webhook for deploy run: "curl --silent --show-error --fail -X POST ${{ secrets.DEPLOYMENT_SERVER }} -H 'Authorization: ${{ secrets.DEPLOYMENT_TOKEN }}' -H 'Content-Type: application/json' -d '{\"owner\": \"${{ secrets.DOCKER_LOGIN }}\", \"repository\": \"${{ secrets.DOCKER_NAME }}\", \"tag\": \"${{ env.TAG }}\", \"ports\": {\"8080\": 8080}}'"</code> </pre><br><p>  <strong>Hinweis: Es ist sehr wichtig, den Schalter --fail anzugeben, da andernfalls jede Anforderung erfolgreich ist, auch wenn als Antwort ein Fehler empfangen wurde.</strong> <br>  Beachten Sie auch, dass die Variablen in der Abfrage verwendet wird, nicht tats√§chlich Variablen und spezielle Funktionsaufrufe au√üer GITHUB_REF aufgrund dessen, was ich f√ºr eine lange Zeit haben, konnte nicht verstehen, warum die Anforderung nicht richtig funktioniert.  Aber nachdem gab sie alles passiert ist. </p><br><div class="spoiler">  <b class="spoiler_title">Action wird erstellt und bereitgestellt</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">name: Publish on Docker Hub and Deploy on: release: types: [published] #       jobs: run_tests: #          runs-on: [ubuntu-latest] steps: #   - uses: actions/checkout@master #  python   - uses: actions/setup-python@v1 with: python-version: '3.8' architecture: 'x64' - name: Install requirements #   run: pip install -r requirements.txt - name: Run tests #   run: coverage run src/tests.py - name: Tests report run: coverage report build_and_pub: #      needs: [run_tests] runs-on: [ubuntu-latest] env: LOGIN: ${{ secrets.DOCKER_LOGIN }} NAME: ${{ secrets.DOCKER_NAME }} steps: - name: Login to docker.io #     docker.io run: echo ${{ secrets.DOCKER_PWD }} | docker login -u ${{ secrets.DOCKER_LOGIN }} --password-stdin #   - uses: actions/checkout@master - name: Build image #  image        hub.docker .. login/repository:version run: docker build -t $LOGIN/$NAME:${GITHUB_REF:11} -f Dockerfile . - name: Push image to docker.io #    registry run: docker push $LOGIN/$NAME:${GITHUB_REF:11} deploy: #         registry,      #    curl   needs: [build_and_pub] runs-on: [ubuntu-latest] steps: - name: Set tag to env run: echo ::set-env name=RELEASE_VERSION::$(echo ${GITHUB_REF:11}) - name: Send webhook for deploy run: "curl --silent --show-error --fail -X POST ${{ secrets.DEPLOYMENT_SERVER }} -H 'Authorization: ${{ secrets.DEPLOYMENT_TOKEN }}' -H 'Content-Type: application/json' -d '{\"owner\": \"${{ secrets.DOCKER_LOGIN }}\", \"repository\": \"${{ secrets.DOCKER_NAME }}\", \"tag\": \"${{ env.RELEASE_VERSION }}\", \"ports\": {\"8080\": 8080}}'"</code> $ NAME: $ {GITHUB_REF: <code class="plaintext hljs">name: Publish on Docker Hub and Deploy on: release: types: [published] #       jobs: run_tests: #          runs-on: [ubuntu-latest] steps: #   - uses: actions/checkout@master #  python   - uses: actions/setup-python@v1 with: python-version: '3.8' architecture: 'x64' - name: Install requirements #   run: pip install -r requirements.txt - name: Run tests #   run: coverage run src/tests.py - name: Tests report run: coverage report build_and_pub: #      needs: [run_tests] runs-on: [ubuntu-latest] env: LOGIN: ${{ secrets.DOCKER_LOGIN }} NAME: ${{ secrets.DOCKER_NAME }} steps: - name: Login to docker.io #     docker.io run: echo ${{ secrets.DOCKER_PWD }} | docker login -u ${{ secrets.DOCKER_LOGIN }} --password-stdin #   - uses: actions/checkout@master - name: Build image #  image        hub.docker .. login/repository:version run: docker build -t $LOGIN/$NAME:${GITHUB_REF:11} -f Dockerfile . - name: Push image to docker.io #    registry run: docker push $LOGIN/$NAME:${GITHUB_REF:11} deploy: #         registry,      #    curl   needs: [build_and_pub] runs-on: [ubuntu-latest] steps: - name: Set tag to env run: echo ::set-env name=RELEASE_VERSION::$(echo ${GITHUB_REF:11}) - name: Send webhook for deploy run: "curl --silent --show-error --fail -X POST ${{ secrets.DEPLOYMENT_SERVER }} -H 'Authorization: ${{ secrets.DEPLOYMENT_TOKEN }}' -H 'Content-Type: application/json' -d '{\"owner\": \"${{ secrets.DOCKER_LOGIN }}\", \"repository\": \"${{ secrets.DOCKER_NAME }}\", \"tag\": \"${{ env.RELEASE_VERSION }}\", \"ports\": {\"8080\": 8080}}'"</code> </pre> </div></div><br><p>  Okay, wir haben alles zusammengestellt. Jetzt erstellen wir ein neues Release und sehen uns die Aktionen an. <br><img src="https://habrastorage.org/webt/07/dn/5q/07dn5qrqodyyfaulm6gpey7w8my.png"><br>  <em>Webhook zur Aktionsschnittstelle der Bereitstellungsanwendung</em> </p><br><p>  Es stellte sich heraus, dass wir eine GET-Anfrage an den Bereitstellungsservice senden (zeigt alle aktiven Container auf dem Host an): <br><img src="https://habrastorage.org/webt/gq/1w/yg/gq1wygbewjefugj8itjchn2ucki.png"><br>  <em>Wird auf dem VPS-Container bereitgestellt</em> </p><br><p>  Jetzt senden wir Anforderungen an unsere bereitgestellte Anwendung: <br><img src="https://habrastorage.org/webt/hs/9x/hz/hs9xhzawrwliyoptcccjd-48bco.png"><br>  <em>GET-Anforderung an implementierten Container</em> </p><br><img src="https://habrastorage.org/webt/jf/fy/xc/jffyxcdf8zyzfylylyufv8wlcp0.png" alt="POST-Anforderung an implementierten Container"><br><p>  <em>POST-Anforderung an implementierten Container</em> </p><br><p>  <strong>Schlussfolgerungen</strong> <br>  GitHub Aktionen sind sehr bequem und flexibles Werkzeug, das verwendet werden kann, eine Menge Dinge zu tun, die das Leben erheblich vereinfachen kann.  Es h√§ngt alles von der Vorstellungskraft ab. <br>  Sie unterst√ºtzen Integrationstests mit Services. <br>  Als logische Fortsetzung dieses Projekts k√∂nnen Sie webhook die M√∂glichkeit hinzuf√ºgen, benutzerdefinierte Parameter zum Starten des Containers zu √ºbergeben. <br>  In Zukunft werde ich versuchen, dieses Projekt als Grundlage f√ºr den Einsatz von Steuerkarten zu nehmen, wenn ich mit k8s studiere und experimentiere </p><br><p>  Wenn Sie ein Home-Projekt haben, k√∂nnen GitHub-Aktionen die Arbeit mit dem Repository erheblich vereinfachen. </p><br><p>  Syntaxdetails finden Sie <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">hier.</a> <br>  Alle Projektquellen </p><cut text=" "></cut></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de476368/">https://habr.com/ru/post/de476368/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de476348/index.html">Wie Chemiker einer staatlichen Universit√§t IT-Prinzipien in ihre Arbeit einf√ºhrten und Teamleiter wurden</a></li>
<li><a href="../de476352/index.html">Field Service Management und Au√üendienst. Hat Russland es geschafft, Au√üendiensttechniker zu managen?</a></li>
<li><a href="../de476354/index.html">Drei praktische Schritte zum Speichern der Ressourcen Ihres Startups</a></li>
<li><a href="../de476358/index.html">Servicegitter f√ºr Microservices. Teil I</a></li>
<li><a href="../de476366/index.html">Das Dach ging: wie man versteht, dass es Zeit f√ºr einen Therapeuten ist und wie man ihn findet</a></li>
<li><a href="../de476370/index.html">Die offizielle JetBrains-Website ist jetzt in russischer Sprache verf√ºgbar</a></li>
<li><a href="../de476372/index.html">Die Kategorietheorie erm√∂glicht es der Mathematik, Gleichheiten aufzugeben</a></li>
<li><a href="../de476374/index.html">Die Gebr√ºder Wright: Erste Patenttrolle</a></li>
<li><a href="../de476378/index.html">Wiederherstellen, CUDA - Intel k√ºndigt 7-nm-GPU f√ºr Rechenzentren an</a></li>
<li><a href="../de476380/index.html">Kryptow√§hrungshandel - Wie man eine nachhaltige Strategie entwickelt</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>