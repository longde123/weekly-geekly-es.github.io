<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>😃 🛫 👨🏼‍⚕️ L'inverse du neuromancien. Partie 4: Son, Animation, Huffman, Github 🥂 👇 👨🏽‍🔧</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Bonjour, comme vous l'avez déjà compris, ceci est la continuation de mon histoire d'ingénierie inverse et de portage de Neuromant. 

 L'inverse du neu...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>L'inverse du neuromancien. Partie 4: Son, Animation, Huffman, Github</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/417639/"><p>  Bonjour, comme vous l'avez déjà compris, ceci est la continuation de mon histoire d'ingénierie inverse et de portage de Neuromant. </p><br><img src="https://habrastorage.org/webt/-g/ru/d_/-grud_xhetuzh4znt4rbkeakxyi.png"><br><blockquote>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">L'inverse du neuromancien.</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Partie 1: Sprites</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">L'inverse du neuromancien.</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Partie 2: police de rendu</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">L'inverse du neuromancien.</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Partie 3: Rendu fini, faites le jeu</a> </blockquote><p> Aujourd'hui, commençons par deux bonnes nouvelles: </p><br><ul><li>  premièrement, je ne suis plus seul - l’utilisateur <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" class="user_link">viiri</a> a déjà rejoint le projet et a déjà apporté une contribution significative; </li><li>  deuxièmement, nous avons maintenant un référentiel ouvert sur <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><em>github</em></a> . </li></ul><br><p>  En général, les choses vont très bien, et peut-être que bientôt nous aurons au moins une version jouable.  Et sous la coupe, comme d'habitude, parlons de ce qui <em>a</em> été réalisé et de la <em>façon dont il a</em> été réalisé en ce moment. </p><a name="habracut"></a><br><hr><br><p>  Il a commencé à gérer le son.  Hélas, parmi les ressources du jeu, il n'y avait rien de similaire à l'audio, et comme je n'avais aucune idée du fonctionnement de la musique dans <em>MS-DOS</em> , il était extrêmement difficile de savoir par où commencer.  Après avoir lu un peu sur toutes sortes de <em>SoundBlaster</em> , le mieux que j'ai trouvé est de faire défiler le code désassemblé dans l'espoir de voir des signatures familières.  Et quiconque cherche, il trouve généralement, même si ce n'est pas tout à fait ce qu'il cherchait (commentaires dénoncés par <em>Ida</em> ): </p><br><pre><code class="hljs vhdl">sub_20416: ... mov ax, [si+<span class="hljs-number"><span class="hljs-number">8</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">out</span></span> <span class="hljs-number"><span class="hljs-number">42</span></span>h, al ; <span class="hljs-number"><span class="hljs-number">8253</span></span>-<span class="hljs-number"><span class="hljs-number">5</span></span> (AT: <span class="hljs-number"><span class="hljs-number">8254.2</span></span>). mov al, ah <span class="hljs-keyword"><span class="hljs-keyword">out</span></span> <span class="hljs-number"><span class="hljs-number">42</span></span>h, al ; Timer <span class="hljs-number"><span class="hljs-number">8253</span></span>-<span class="hljs-number"><span class="hljs-number">5</span></span> (AT: <span class="hljs-number"><span class="hljs-number">8254.2</span></span>). mov bx, [si+<span class="hljs-number"><span class="hljs-number">0</span></span>Ah] <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> bl, <span class="hljs-number"><span class="hljs-number">3</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> al, <span class="hljs-number"><span class="hljs-number">61</span></span>h ; PC/XT PPI <span class="hljs-keyword"><span class="hljs-keyword">port</span></span> B bits: ; <span class="hljs-number"><span class="hljs-number">0</span></span>: Tmr <span class="hljs-number"><span class="hljs-number">2</span></span> gate ═╦═► <span class="hljs-keyword"><span class="hljs-keyword">OR</span></span> <span class="hljs-number"><span class="hljs-number">03</span></span>H=spkr <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> ; <span class="hljs-number"><span class="hljs-number">1</span></span>: Tmr <span class="hljs-number"><span class="hljs-number">2</span></span> data ═╝ <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>fcH=spkr OFF ; <span class="hljs-number"><span class="hljs-number">3</span></span>: <span class="hljs-number"><span class="hljs-number">1</span></span>=read high switches ; <span class="hljs-number"><span class="hljs-number">4</span></span>: <span class="hljs-number"><span class="hljs-number">0</span></span>=enable RAM parity checking ; <span class="hljs-number"><span class="hljs-number">5</span></span>: <span class="hljs-number"><span class="hljs-number">0</span></span>=enable I/O channel check ; <span class="hljs-number"><span class="hljs-number">6</span></span>: <span class="hljs-number"><span class="hljs-number">0</span></span>=hold keyboard clock low ; <span class="hljs-number"><span class="hljs-number">7</span></span>: <span class="hljs-number"><span class="hljs-number">0</span></span>=enable kbrd <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> al, <span class="hljs-number"><span class="hljs-number">0</span></span>FCh <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> al, bl <span class="hljs-keyword"><span class="hljs-keyword">out</span></span> <span class="hljs-number"><span class="hljs-number">61</span></span>h, al ; PC/XT PPI <span class="hljs-keyword"><span class="hljs-keyword">port</span></span> B bits: ; <span class="hljs-number"><span class="hljs-number">0</span></span>: Tmr <span class="hljs-number"><span class="hljs-number">2</span></span> gate ═╦═► <span class="hljs-keyword"><span class="hljs-keyword">OR</span></span> <span class="hljs-number"><span class="hljs-number">03</span></span>H=spkr <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> ; <span class="hljs-number"><span class="hljs-number">1</span></span>: Tmr <span class="hljs-number"><span class="hljs-number">2</span></span> data ═╝ <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>fcH=spkr OFF ; <span class="hljs-number"><span class="hljs-number">3</span></span>: <span class="hljs-number"><span class="hljs-number">1</span></span>=read high switches ; <span class="hljs-number"><span class="hljs-number">4</span></span>: <span class="hljs-number"><span class="hljs-number">0</span></span>=enable RAM parity checking ; <span class="hljs-number"><span class="hljs-number">5</span></span>: <span class="hljs-number"><span class="hljs-number">0</span></span>=enable I/O channel check ; <span class="hljs-number"><span class="hljs-number">6</span></span>: <span class="hljs-number"><span class="hljs-number">0</span></span>=hold keyboard clock low ; <span class="hljs-number"><span class="hljs-number">7</span></span>: <span class="hljs-number"><span class="hljs-number">0</span></span>=enable kbrd</code> </pre> <br><p>  Après avoir parcouru ce <em>Timer 8253-5,</em> je suis tombé sur <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">un article</a> qui est devenu la première clé pour comprendre ce qui se passait.  Ci-dessous, je vais essayer d'expliquer quoi. </p><br><p>  Ainsi, à l'ère d' <em>IBM-PC</em> , avant l'avènement des cartes son abordables, l'appareil de reproduction du son le plus courant était le soi-disant <em>PC Speaker</em> , également connu sous le nom de «beeper».  Cet appareil n'est rien de plus qu'un haut-parleur ordinaire connecté à la carte mère, dans la plupart des cas, via un connecteur à quatre broches.  Le beeper, selon l'idée, permettait de reproduire une impulsion rectangulaire à deux niveaux (correspondant à deux niveaux de tension, généralement 0V et + 5V) et était contrôlé via le 61ème port du contrôleur <em>PPI (Programmable Peripheral Interface)</em> .  Plus précisément, les deux premiers bits de la valeur envoyée au port sont chargés de contrôler le «haut-parleur» (voir commentaires sur les lignes <code>in al, 61h</code> et <code>out 61h, al</code> ). </p><br><p>  Comme je l'ai dit (dans des mots un peu différents), notre haut-parleur peut être dans deux états - <em>"in"</em> et <em>"out"</em> ( <em>"low" - "high"</em> , <em>"off" - "on"</em> , <em>"off" - "on"</em> , que ce soit).  Pour créer <em>une</em> impulsion, il est nécessaire de changer l'état actuel à l'opposé et, après un certain temps, de revenir.  Cela peut être fait directement en manipulant le premier bit (compter à partir de zéro) du port 61, par exemple, comme ceci: </p><br><pre> <code class="hljs vhdl">PULSE: <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> al, <span class="hljs-number"><span class="hljs-number">61</span></span>h ;    <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> al, <span class="hljs-number"><span class="hljs-number">11111100</span></span>b ;    ... <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> al, <span class="hljs-number"><span class="hljs-number">00000010</span></span>b ;     ... ; ,        <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">out</span></span> <span class="hljs-number"><span class="hljs-number">61</span></span>h, al ;    <span class="hljs-number"><span class="hljs-number">61</span></span>-  mov cx, <span class="hljs-number"><span class="hljs-number">100</span></span> ;   DELAY: <span class="hljs-keyword"><span class="hljs-keyword">loop</span></span> DELAY ;    <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> al, <span class="hljs-number"><span class="hljs-number">61</span></span>h ;    <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> al, <span class="hljs-number"><span class="hljs-number">11111100</span></span>b ;     <span class="hljs-keyword"><span class="hljs-keyword">out</span></span> <span class="hljs-number"><span class="hljs-number">61</span></span>h, al ;    <span class="hljs-number"><span class="hljs-number">61</span></span>- </code> </pre> <br><p>  Le résultat de l'exécution de ce code ressemblera à ceci: </p><br><pre> <code class="hljs delphi"> loop DELAY +<span class="hljs-number"><span class="hljs-number">5</span></span>V +----------------------+ ! ! <span class="hljs-number"><span class="hljs-number">0</span></span>V ---+ +-------------------------- <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> al, <span class="hljs-number"><span class="hljs-number">00000010</span></span>b <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> al, <span class="hljs-number"><span class="hljs-number">11111100</span></span>b <span class="hljs-keyword"><span class="hljs-keyword">out</span></span> <span class="hljs-number"><span class="hljs-number">61</span></span>h, al <span class="hljs-keyword"><span class="hljs-keyword">out</span></span> <span class="hljs-number"><span class="hljs-number">61</span></span>h, al</code> </pre> <br><p>  En répétant <em>PULSE</em> avec un retard, nous obtenons un signal rectangulaire: </p><br><pre> <code class="hljs erlang-repl"> mov dx, <span class="hljs-number"><span class="hljs-number">100</span></span> ;  <span class="hljs-number"><span class="hljs-number">100</span></span>  PULSE: ... mov cx, <span class="hljs-number"><span class="hljs-number">100</span></span> WAIT: loop WAIT dec dx jnz PULSE PULSE +<span class="hljs-number"><span class="hljs-number">5</span></span>V +---------+ +---------+ +---------+ ! ! ! ! ! ! <span class="hljs-number"><span class="hljs-number">0</span></span>V ---+ +---------+ +---------+ +--- loop WAIT</code> </pre><br><p>  Si dans le premier cas, nous n'aurions presque rien entendu, dans le second, nous obtiendrons une tonalité de fréquence, en fonction de la vitesse de la machine sur laquelle ce code est exécuté.  C'est formidable, mais associé à certaines difficultés.  Dans tous les cas, il existe un moyen plus pratique de contrôler le haut-parleur. </p><br><p>  Voici la minuterie à trois canaux programmable du jeu - <em>Intel 8253</em> , dont le deuxième canal (à partir de zéro) est connecté au signal sonore.  Ce temporisateur reçoit un signal de l'horloge <em>Intel 8254</em> , envoyant 1193180 impulsions par seconde (~ 1,193 MHz), et peut être programmé pour une réaction spécifique après un nombre spécifié d'impulsions.  L'une de ces réactions envoie une impulsion carrée au haut-parleur.  En d'autres termes, le <em>8253</em> peut fonctionner sous la forme d'un générateur d'un signal rectangulaire de fréquence réglable, ce qui permet de synthétiser relativement facilement divers effets sonores sur le haut-parleur.  Et voici ce dont vous avez besoin pour cela: </p><br><ol><li>  Réglez le deuxième canal de la minuterie sur le mode de génération de signal rectangulaire.  Pour ce faire, écrivez une valeur spéciale à un octet sur le port 43 ( <em>registre de mode / commande 8253</em> ).  Dans mon cas, c'est <code>10110110B</code> (plus de détails <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ici</a> ): </li></ol><br><pre> <code class="markdown hljs">Bits Usage 6 and 7 Select channel : 1 0 = Channel 2 4 and 5 Access mode : 1 1 = Access mode: lobyte/hibyte 1 to 3 Operating mode : 0 1 1 = Mode 3 (square wave generator) 0 BCD/Binary mode: 0 = 16-bit binary</code> </pre> <br><ol><li><p>  Réglez la fréquence souhaitée sur le deuxième canal.  Pour ce faire, octet par bit, du plus jeune au plus âgé, nous envoyons au 42e port ( <em>8253 canal de données du canal 2</em> ) une valeur égale à <code>1193180 / freq</code> , où <code>freq</code> est la valeur de fréquence requise en Hertz. </p><br></li><li><p>  Laissez le haut-parleur recevoir des impulsions de la minuterie.  Pour ce faire, définissez les deux premiers bits de la valeur du port 61 ( <em>PPI</em> ) sur l'unité.  Le fait est que si le bit zéro est mis à 1, alors le premier est interprété comme un «interrupteur»: </p><br></li></ol><br><pre> <code class="markdown hljs">Bit 0 Effect ----------------------------------------------------------------- 0 The state of the speaker will follow bit 1 of port 61h 1 The speaker will be connected to PIT channel 2, bit 1 is used as switch ie 0 = not connected, 1 = connected.</code> </pre> <br><p>  En conséquence, nous avons l'image suivante: </p><br><pre> <code class="hljs vhdl"> mov al, <span class="hljs-number"><span class="hljs-number">10110110</span></span>b <span class="hljs-keyword"><span class="hljs-keyword">out</span></span> <span class="hljs-number"><span class="hljs-number">43</span></span>h, al ;   mov ax, <span class="hljs-number"><span class="hljs-number">02E9</span></span>Bh ; <span class="hljs-number"><span class="hljs-number">1193180</span></span> / <span class="hljs-number"><span class="hljs-number">100</span></span> = ~<span class="hljs-number"><span class="hljs-number">0</span></span>x2E9B <span class="hljs-keyword"><span class="hljs-keyword">out</span></span> <span class="hljs-number"><span class="hljs-number">42</span></span>h, al ;      mov al, ah <span class="hljs-keyword"><span class="hljs-keyword">out</span></span> <span class="hljs-number"><span class="hljs-number">42</span></span>h, al ;      <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> al, <span class="hljs-number"><span class="hljs-number">61</span></span>h ;    <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> al, <span class="hljs-number"><span class="hljs-number">00000011</span></span>b ;      <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">out</span></span> <span class="hljs-number"><span class="hljs-number">61</span></span>h, al ;   ... ;       ~<span class="hljs-number"><span class="hljs-number">100</span></span>  <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> al, <span class="hljs-number"><span class="hljs-number">61</span></span>h <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> al, <span class="hljs-number"><span class="hljs-number">11111100</span></span>b <span class="hljs-keyword"><span class="hljs-keyword">out</span></span> <span class="hljs-number"><span class="hljs-number">61</span></span>h, al ;  </code> </pre> <br><p>  Et c'est exactement ce que fait le code que j'ai cité au tout début (sauf pour l'initialisation, mais je l'ai trouvé dans une autre fonction): à <code>si + 8</code> il y a un diviseur de fréquence envoyé au port 42, et à <code>si + 0Ah</code> - état du haut-parleur ( <em>«on» - «off»</em> ) enregistré dans le port 61. </p><br><p>  Le mécanisme de lecture est simple et direct, mais vous avez ensuite dû faire face à des synchronisations.  Après avoir examiné le code voisin, j'ai vu que dans la même fonction dans laquelle le temporisateur est initialisé ( <code>sub_2037A</code> , ci-après - <code>init_8253</code> ), le <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">huitième</a> gestionnaire d' <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">interruption</a> est remplacé par la fonction <code>sub_20416</code> (ci-après - <code>play_sample</code> ).  Il est rapidement devenu évident que cette interruption est générée environ 18,2 fois par seconde et sert à mettre à jour l'heure du système.  Le remplacement du gestionnaire de cette interruption est une pratique courante si vous devez effectuer une action 18 fois par seconde (en fait, le gestionnaire d'origine doit également être appelé à l'intérieur du hook, sinon l'heure du système s'arrêtera).  Sur cette base, il s'avère que la fréquence suivante est chargée au générateur tous les <code>(1 / 18.2) * 1000 ~ 55</code> . </p><br><p>  Le plan était le suivant: </p><br><ul><li>  mettre un point d'arrêt dans la fonction <code>play_sample</code> , sur la ligne où le prochain diviseur de fréquence est extrait; </li><li>  calculer la fréquence selon la formule <code>freq = 1193180 / divisor</code> ; </li><li>  générer 55 ms de signal de <code>freq</code> carrée dans une sorte d'éditeur audio (j'ai utilisé <em>Adobe Audition</em> ); </li><li>  répétez les trois premières étapes jusqu'à ce qu'au moins 3 secondes soient accumulées. </li></ul><br><p>  J'ai donc obtenu le début de la mélodie dans le menu principal, mais en jouant 10 fois plus lentement que nécessaire.  Ensuite, j'ai réduit la durée de l '«échantillon» de 55 ms à 5 ms - c'est devenu beaucoup mieux, mais toujours pas ça.  Le problème de synchronisation est resté ouvert jusqu'à ce que je trouve <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">cet article</a> .  Il s'est avéré que la huitième interruption est générée en alimentant le même <em>8253</em> , dont le canal zéro est connecté au contrôleur d'interruption ( <em>PIC</em> ).  Lorsque la machine démarre, le <em>BIOS</em> définit le canal zéro pour générer des impulsions avec une fréquence de ~ 18,2 Hz (c'est-à-dire qu'une interruption est générée toutes les ~ 54,9 ms).  Cependant, le canal zéro peut être reprogrammé afin qu'il génère des impulsions avec une fréquence plus élevée, pour cela, par analogie avec le deuxième canal, vous devez écrire une valeur égale à <code>1193180 / freq</code> sur le 40e port, où <code>freq</code> est la valeur de fréquence requise en Hertz.  Cela se produit dans la fonction <code>init_8253</code> , juste au début, je n'y ai pas prêté attention: </p><br><pre> <code class="hljs objectivec">init_8253: ... mov al, <span class="hljs-number"><span class="hljs-number">0</span></span>B6h ; <span class="hljs-number"><span class="hljs-number">10110110</span></span>b <span class="hljs-keyword"><span class="hljs-keyword">out</span></span> <span class="hljs-number"><span class="hljs-number">43</span></span>h, al ; Timer <span class="hljs-number"><span class="hljs-number">8253</span></span><span class="hljs-number"><span class="hljs-number">-5</span></span> (AT: <span class="hljs-number"><span class="hljs-number">8254.2</span></span>). mov ax, <span class="hljs-number"><span class="hljs-number">13</span></span>B1h <span class="hljs-keyword"><span class="hljs-keyword">out</span></span> <span class="hljs-number"><span class="hljs-number">40</span></span>h, al ; Timer <span class="hljs-number"><span class="hljs-number">8253</span></span><span class="hljs-number"><span class="hljs-number">-5</span></span> (AT: <span class="hljs-number"><span class="hljs-number">8254.2</span></span>). mov al, ah <span class="hljs-keyword"><span class="hljs-keyword">out</span></span> <span class="hljs-number"><span class="hljs-number">40</span></span>h, al ; Timer <span class="hljs-number"><span class="hljs-number">8253</span></span><span class="hljs-number"><span class="hljs-number">-5</span></span> (AT: <span class="hljs-number"><span class="hljs-number">8254.2</span></span>).</code> </pre> <br><p>  La valeur <code>13B1h</code> traduite en fréquence: <code>1193180 / 13B1h ~ 236.7</code> , puis nous obtenons environ <code>(1 / 236.7) * 1000 ~ 4.2</code> par "échantillon".  Le puzzle s'est développé. </p><br><p>  Ensuite, c'est une question de technologie - pour implémenter une fonction qui extrait les bandes sonores du jeu.  Mais voici le problème, les valeurs des diviseurs de fréquence enregistrées dans le 42e port ne sont pas stockées explicitement.  Ils sont calculés par un algorithme délicat, dont les données d'entrée et la zone de travail se trouvent directement dans le fichier exécutable du jeu (dans le septième segment, selon <em>Ida</em> ).  De plus, parmi les fonctionnalités, il n'y a aucun signe de fin de piste, quand il n'y a plus rien à jouer, l'algorithme produit infiniment un état zéro du haut-parleur.  Mais je n'ai pas pris la peine et, comme dans le cas de l'algorithme de décompression (la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">première partie</a> ), j'ai simplement porté à l'assembleur 64 bits la fonction de réglage de la piste pour la lecture et l'algorithme pour obtenir la fréquence suivante (et j'ai pris le septième segment entièrement). </p><br><p>  Et ça a marché.  Après cela, j'ai implémenté les fonctions de génération de bande sonore pour la piste sélectionnée ( <em>PCM, 44100 Hz, 8 bits, mono</em> ; <em>j'ai</em> fait quelque chose comme un générateur utilisé dans l'émulateur de haut-parleur de <em>DosBox</em> ).  J'ai résolu le problème du signe de la fin avec un simple compteur de silence: compté une seconde - nous complétons l'algorithme.  Enveloppant la piste résultante dans l'en-tête <em>WAV</em> et en enregistrant le résultat dans un fichier, j'ai obtenu exactement la piste dans le menu principal.  Et 13 autres pistes que vous pouvez écouter ci-dessous <em>[ou dans la visionneuse de ressources, qui a maintenant un lecteur intégré et la possibilité d'enregistrer n'importe quelle piste dans .WAV]</em> : </p><br><iframe width="560" height="315" src="https://www.youtube.com/embed/.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=https://w.soundcloud.com/player/" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><p>  <em>[En étudiant le problème, j'ai découvert des techniques plus avancées de «bip», comme l'utilisation de la modulation de largeur d'impulsion pour une reproduction sonore PCM de mauvaise qualité.</em>  <em>À la fin de cet article, je fournirai une liste de documents à partir desquels vous pourrez en savoir plus.]</em> </p><br><hr><br><p>  Dans la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">deuxième partie</a> , lorsque différents formats de ressources ont été pris en compte, j'ai suggéré que les fichiers <em>.ANH contiennent des</em> animations pour les arrière-plans d'emplacement (c'est-à-dire pour les images stockées dans <em>.PIC</em> ).  <em>[C'est vrai.]</em> Ayant fini avec le son, j'ai décidé de le vérifier.  En partant du principe que l'animation est appliquée directement à l'image de fond stockée en mémoire (pas dans la <em>mémoire vidéo</em> , mais dans la <em>chaîne de sprites</em> ), j'ai décidé de vider cette mémoire, respectivement, avant et après l'application de l'animation (regardez où le curseur pointe vers le haut chaîne de lettres «S»): </p><br><p><img src="https://habrastorage.org/webt/zp/9a/qn/zp9aqnvcvi-gn3pp0t1puzvhpti.gif" width="32%" height="32%"><img src="https://habrastorage.org/webt/jz/9l/ig/jz9ligummo9j_xwwatid-s0vcri.png" width="32%" height="32%"><img src="https://habrastorage.org/webt/sz/pd/uy/szpduyzc7lgsqum_np9sbvrq4qo.png" width="32%" height="32%"></p><br><pre> <code class="markdown hljs">3DE6:0E26 03 B4 44 B3 ... ;   3DE6:0E26 03 BC CC B3 ... ;  </code> </pre> <br><p>  Exactement ce à quoi je m'attendais - la couleur rouge foncé (0x4) est devenue rouge vif (0xC).  Vous pouvez maintenant essayer de définir le point d'arrêt pour modifier la valeur à l'adresse, par exemple, <code>3DE6:0E28</code> et, si vous êtes chanceux, effectuer une trace inverse.  <em>[J'ai eu de la chance.]</em> Le point d'arrêt m'a conduit à une ligne qui modifie directement la valeur à l'adresse donnée: <code>xor es:[bx], al</code> .  Après avoir examiné les environs, j'ai facilement construit une chaîne d'appels de la boucle du niveau principal jusqu'à ce point: <code>sub_1231E (xor es:[bx], al) &lt;- sub_12222 &lt;- sub_105F6 &lt;- sub_1038F ( )</code> . </p><br><p>  Je n'entrerai pas dans les détails sur la façon exacte dont j'ai inversé le processus d'animation.  C'est un travail assez routinier et méthodique, mais pas très difficile si les frontières sont clairement délimitées (le retour reçu est ces frontières).  Mais je ne peux m'empêcher de parler de ce qui s'est finalement passé. </p><br><p>  Tout d'abord sur le format <em>.ANH</em> .  En fait, il s'agit d'un ensemble de conteneurs, et le premier mot du fichier <em>.ANH</em> est le nombre de conteneurs à l'intérieur: </p><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">typedef</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">anh_hdr_t</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">uint16_t</span></span> anh_entries; <span class="hljs-comment"><span class="hljs-comment">/* first entry hdr */</span></span> } <span class="hljs-keyword"><span class="hljs-keyword">anh_hdr_t</span></span>;</code> </pre> <br><p>  Le conteneur lui-même est une animation prise séparément de l'élément d'arrière-plan.  Vous pouvez sélectionner un en-tête pour le conteneur contenant sa taille en octets et le nombre d'images dans l'animation qu'il représente.  À côté de l'en-tête se trouvent les valeurs de la durée (délai) de la trame suivante et du décalage des octets de la trame elle-même, par rapport aux octets de la première trame.  Le nombre de ces paires est évidemment égal au nombre de trames: </p><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">typedef</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">anh_entry_hdr_t</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">uint16_t</span></span> entry_size; <span class="hljs-keyword"><span class="hljs-keyword">uint16_t</span></span> total_frames; <span class="hljs-comment"><span class="hljs-comment">/* anh_frame_data_t first_frame_data */</span></span> <span class="hljs-comment"><span class="hljs-comment">/* another frames data */</span></span> <span class="hljs-comment"><span class="hljs-comment">/* anh_frame_hdr first_frame_hdr */</span></span> <span class="hljs-comment"><span class="hljs-comment">/* another frames */</span></span> } <span class="hljs-keyword"><span class="hljs-keyword">anh_entry_hdr_t</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">typedef</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">anh_frame_data_t</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">uint16_t</span></span> frame_sleep; <span class="hljs-keyword"><span class="hljs-keyword">uint16_t</span></span> frame_offset; } <span class="hljs-keyword"><span class="hljs-keyword">anh_frame_data_t</span></span>; ... <span class="hljs-keyword"><span class="hljs-keyword">extern</span></span> <span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> *anh; <span class="hljs-keyword"><span class="hljs-keyword">anh_hdr_t</span></span> *hdr = (<span class="hljs-keyword"><span class="hljs-keyword">anh_hdr_t</span></span>*)anh; <span class="hljs-keyword"><span class="hljs-keyword">anh_entry_hdr_t</span></span> *entry = (<span class="hljs-keyword"><span class="hljs-keyword">anh_entry_hdr_t</span></span>*)(anh + <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">anh_hdr_t</span></span>)); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">uint16_t</span></span> u = <span class="hljs-number"><span class="hljs-number">0</span></span>; u &lt; anh-&gt;anh_entries; u++) { <span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> *p = (<span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span>*)entry; <span class="hljs-keyword"><span class="hljs-keyword">anh_frame_data_t</span></span> *first_frame_data = (<span class="hljs-keyword"><span class="hljs-keyword">anh_frame_data_t</span></span>*)(p + <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">anh_entry_hdr_t</span></span>)); <span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> *first_frame_bytes = p + (entry-&gt;total_frames * <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">anh_frame_data_t</span></span>)); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">uint16_t</span></span> k = <span class="hljs-number"><span class="hljs-number">0</span></span>; k &lt; entry-&gt;total_frames; k++) { <span class="hljs-keyword"><span class="hljs-keyword">anh_frame_data_t</span></span> *frame_data = first_frame_data + k; <span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> *frame_bytes = first_frame_bytes + frame_data-&gt;frame_offset; ... } <span class="hljs-comment"><span class="hljs-comment">/* plus 2 bytes of padding */</span></span> p += (entry-&gt;entry_size + <span class="hljs-number"><span class="hljs-number">2</span></span>); entry = (<span class="hljs-keyword"><span class="hljs-keyword">anh_entry_hdr_t</span></span>*)p; }</code> </pre><br><p>  Un cadre séparé est constitué d'un en-tête de quatre octets contenant ses dimensions linéaires et ses déplacements par rapport à l'image d'arrière-plan, et les pixels du cadre codés par l'algorithme que je connais déjà par <em>Run Length</em> : </p><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">typedef</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">anh_frame_hdr</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> bg_x_offt; <span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> bg_y_offt; <span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> frame_width; <span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> frame_height; <span class="hljs-comment"><span class="hljs-comment">/* rle encoded frame bytes */</span></span> };</code> </pre> <br><p>  La «superposition» du cadre sur le fond peut ressembler à ceci: </p><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">extern</span></span> <span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> *level_bg; <span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> frame_pix[<span class="hljs-number"><span class="hljs-number">8192</span></span>]; anh_frame_hdr *hdr = (anh_frame_hdr*)frame_bytes; <span class="hljs-keyword"><span class="hljs-keyword">uint16_t</span></span> frame_len = hdr-&gt;frame_width * hdr-&gt;frame_height; decode_rle(frame + <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(anh_frame_hdr), frame_len, frame_pix); <span class="hljs-comment"><span class="hljs-comment">/* 0xFB4E - some magic value, have no idea what is it */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">uint16_t</span></span> bg_offt = (hdr-&gt;bg_y_offt * <span class="hljs-number"><span class="hljs-number">152</span></span>) + hdr-&gt;bg_x_offt + <span class="hljs-number"><span class="hljs-number">0xFB4E</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">uint16_t</span></span> bg_skip = <span class="hljs-number"><span class="hljs-number">152</span></span> - hdr-&gt;frame_width; <span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> *p1 = frame_pix, *p2 = level_bg; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">uint16_t</span></span> i = hdr-&gt;frame_height; i != <span class="hljs-number"><span class="hljs-number">0</span></span>; i--) { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">uint16_t</span></span> j = hdr-&gt;frame_width; j != <span class="hljs-number"><span class="hljs-number">0</span></span>; j--) { *p2++ ^= *p1++; } p2 += bg_skip; }</code> </pre> <br><p>  Il s'agit du <em>format .ANH</em> , mais il existe une autre structure qui fait que tout fonctionne: </p><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">typedef</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bg_animation_control_table_t</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">uint16_t</span></span> total_frames; <span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> *first_frame_data; <span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> *first_frame_bytes; <span class="hljs-keyword"><span class="hljs-keyword">uint16_t</span></span> sleep; <span class="hljs-keyword"><span class="hljs-keyword">uint16_t</span></span> curr_frame; } <span class="hljs-keyword"><span class="hljs-keyword">bg_animation_control_table_t</span></span>;</code> </pre> <br><p>  Dans le jeu lui-même, un tableau d'au moins quatre structures de ce type est globalement déclaré.  Après le chargement du fichier <em>.ANH</em> suivant, le nombre d'animations à l'intérieur est également stocké dans une variable globale et les éléments du tableau sont initialisés comme suit: </p><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">extern</span></span> <span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> *anh; <span class="hljs-keyword"><span class="hljs-keyword">uint16_t</span></span> g_anim_amount = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">bg_animation_control_table_t</span></span> g_anim_ctl[<span class="hljs-number"><span class="hljs-number">4</span></span>]; ... <span class="hljs-keyword"><span class="hljs-keyword">anh_hdr_t</span></span> *hdr = (<span class="hljs-keyword"><span class="hljs-keyword">anh_hdr_t</span></span>*)anh; <span class="hljs-keyword"><span class="hljs-keyword">anh_entry_hdr_t</span></span> *entry = (<span class="hljs-keyword"><span class="hljs-keyword">anh_entry_hdr_t</span></span>*)(anh + <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">anh_hdr_t</span></span>)); g_anim_amount = hdr-&gt;anh_entries; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">uint16_t</span></span> u = <span class="hljs-number"><span class="hljs-number">0</span></span>; u &lt; g_anim_amount; u++) { <span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> *p = (<span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span>*)entry; g_anim_ctl[u].total_frames = entry-&gt;total_frames; g_anim_ctl[u].first_frame_data = p + <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">anh_entry_hdr_t</span></span>); g_anim_ctl[u].first_frame_bytes = g_anim_ctl[u].first_frame_data + (entry-&gt;total_frames * <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">anh_frame_data_t</span></span>)); g_anim_ctl[u].sleep = *(<span class="hljs-keyword"><span class="hljs-keyword">uint16_t</span></span>*)(g_animation_control[u].first_frame_data); g_anim_ctl[u].curr_frame = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-comment"><span class="hljs-comment">/* plus 2 bytes of padding */</span></span> p += (entry-&gt;entry_size + <span class="hljs-number"><span class="hljs-number">2</span></span>); entry = (<span class="hljs-keyword"><span class="hljs-keyword">anh_entry_hdr_t</span></span>*)p; }</code> </pre><br><p>  Enfin, appliquez les animations: </p><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">uint16_t</span></span> u = <span class="hljs-number"><span class="hljs-number">0</span></span>; u &lt; g_anim_amount; u++) { <span class="hljs-keyword"><span class="hljs-keyword">bg_animation_control_table_t</span></span> *anim = &amp;g_anim_ctl[u]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (anim-&gt;sleep-- == <span class="hljs-number"><span class="hljs-number">0</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">anh_frame_data_t</span></span> *data = (<span class="hljs-keyword"><span class="hljs-keyword">anh_frame_data_t</span></span>*)anim-&gt;first_frame_data + anim-&gt;curr_frame; <span class="hljs-comment"><span class="hljs-comment">/*    */</span></span> ... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (++anim-&gt;curr_frame == anim-&gt;total_frames) { anim-&gt;curr_frame = <span class="hljs-number"><span class="hljs-number">0</span></span>; data = (<span class="hljs-keyword"><span class="hljs-keyword">anh_frame_data_t</span></span>*)anim-&gt;first_frame_data; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { data++; } anim-&gt;sleep = data-&gt;frame_sleep; } }</code> </pre> <br><p>  Et nous obtenons ce qui suit <em>[vous pouvez voir beaucoup plus dans la visionneuse de ressources]</em> : </p><br><div class="spoiler">  <b class="spoiler_title">R2.ANH.GIF</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/p7/lv/fn/p7lvfn5ytpjm5nsoctsumdncuaa.gif"></div></div><br><div class="spoiler">  <b class="spoiler_title">R6.ANH.GIF</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/j6/nb/xp/j6nbxpj29jlrikbmjl8f62s4xmc.gif"></div></div><br><p>  Il y a quelques problèmes avec l'animation en ce moment.  Le premier est que dans mon code, je joue toutes les animations disponibles, mais l'original vérifie certains drapeaux globaux indiquant s'il faut faire défiler la suivante.  Et le second, du fait que certaines animations ajoutent à l'écran des objets qui ne s'y trouvent pas à l'origine.  Et comme les cadres se «querellent» en arrière-plan, puis avec un défilement cyclique, à chaque deuxième cercle, l'objet disparaît tout simplement.  Voici, par exemple, à quoi cela pourrait ressembler: </p><br><div class="spoiler">  <b class="spoiler_title">R53.ANH.GIF</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/d3/5l/iu/d35liujvu6ash9gcdrecvoq9kuc.gif"></div></div><br><p>  Mais pour l'instant, laissons les choses telles quelles. </p><br><hr><br><p>  Rappelez-vous l'algorithme de décompression inconnu de la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">première partie</a> ?  A peine connecté au développement, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" class="user_link">viiri a</a> non seulement déterminé de quel type d'algorithme il s'agissait, mais a également écrit sa propre version du décodeur, remplaçant le terrible morceau de trois lignes d'Assembler dans la base de code.  À cet égard, j'ai demandé à <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" class="user_link">viiri</a> d'écrire un court essai sur le travail accompli.  Ce qui a été fait, mais avant de le donner, il faut dire quelques mots sur la théorie. </p><br><p>  Pour compresser les ressources, les développeurs <em>de Neuromancer ont</em> utilisé <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><em>le code Huffman</em></a> .  Il s'agit de l'une des premières méthodes efficaces de codage des informations à l'aide de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><em>codes préfixes</em></a> .  Dans la théorie du codage, les codes avec un mot de longueur variable et ceux où aucun mot de code n'est le préfixe d'un autre sont appelés codes de <em>préfixe</em> .  Autrement dit, si le mot <em>«a»</em> est inclus dans le code de préfixe, alors le mot <em>«ab»</em> n'existe pas dans le code.  Cette propriété vous permet de décomposer de manière unique en mots le message codé par un tel code. </p><br><p>  L'idée de l'algorithme de Huffman est que, connaissant la probabilité d'apparition de caractères d'un certain alphabet dans le message, nous pouvons décrire la procédure de construction de codes de longueur variable, consistant en un nombre entier de bits.  Les symboles avec une probabilité d'occurrence plus élevée se voient attribuer des codes plus courts, et les symboles avec une probabilité plus faible, au contraire, plus longs.  En général, la procédure de codage est réduite à la construction de l'arbre de code optimal et, sur sa base, à la mise en correspondance du symbole de message avec le code correspondant.  La propriété de préfixe du code reçu vous permet de décoder de manière unique le message compressé. </p><br><div class="spoiler">  <b class="spoiler_title">Huffman.GIF</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/fa/is/hb/faishbcvf0flxiao-mfmnx3llvu.gif"></div></div><br><p>  L'algorithme a un inconvénient important (en fait, pas un, mais maintenant seul celui-ci est important).  Le fait est que pour récupérer le contenu d'un message compressé, le décodeur doit connaître la table des fréquences d'occurrence des caractères utilisée par le codeur.  À cet égard, avec le message codé, une table de probabilité ou l'arbre de code lui-même (une option utilisée dans le jeu) doit être transmis.  La taille des données supplémentaires peut être relativement importante, ce qui affecte considérablement l'efficacité de la compression. </p><br><p>  Quelque chose sur la façon dont vous pouvez gérer cela, ainsi que sur votre décodeur et celui qui est implémenté dans le jeu, dit à <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" class="user_link">viiri</a> : </p><br><blockquote>  Il convient de mentionner que tout le jeu a été entièrement écrit à la main dans Assembler, de sorte que le code contient des solutions, des astuces et des optimisations intéressantes. <br><br>  Selon les procédures.  La fonction <code>sub_1ff94</code> ( <code>build_code_table</code> ) est nécessaire pour charger une arborescence Huffman compressée à partir d'un fichier.  Pour décoder un Huffman statique (parfois <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">dynamique</a> , et cette exigence ne s'applique pas à lui), avec le message, un arbre de code doit être transmis, qui est un mappage des codes Huffman en codes de caractères réels.  Cet arbre est assez grand et il serait donc intéressant de le stocker efficacement.  La manière la plus correcte consiste à utiliser des <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">codes canoniques</a> ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">MOAR</a> ).  En raison de leurs propriétés, il existe un moyen très intéressant et efficace de stocker l'arborescence (utilisé dans la mise en œuvre de la méthode de compression <em>Deflate</em> de l'archiveur <em>PKZip</em> ).  Mais les codes canoniques ne sont pas utilisés dans le jeu, à la place, une <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">traversée d'arbre directe est</a> effectuée et pour chaque sommet, le bit 0 est écrit dans le flux de sortie si le nœud n'est pas une feuille, ou le bit 1 si le nœud est une feuille, puis les 8 bits suivants sont le code de caractère dans ce nœud.  Lors du décodage, une traversée d'arbre similaire est effectuée, ce que nous voyons dans le jeu.  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Il</a> y a un exemple et une explication. </blockquote><br><div class="spoiler">  <b class="spoiler_title">build_code_table</b> <div class="spoiler_text"><pre> <code class="hljs sql">build_code_table proc near <span class="hljs-keyword"><span class="hljs-keyword">call</span></span> getbit ;     jb short loc_1FFA9 ;   ... shl dx, 1 inc bx <span class="hljs-keyword"><span class="hljs-keyword">call</span></span> build_code_table ;  build_code_table    or dl, 1 <span class="hljs-keyword"><span class="hljs-keyword">call</span></span> build_code_table ;  build_code_table    shr dx, 1 dec bx ret loc_1FFA9: <span class="hljs-keyword"><span class="hljs-keyword">call</span></span> sub_1FFC2 ;      (8 ) ... ;     ret sub_1FF94 endp sub_1FFC2 proc near sub di, di mov ch, 8 loc_1FFC6: <span class="hljs-keyword"><span class="hljs-keyword">call</span></span> getbit rcl di, <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-built_in"><span class="hljs-built_in">dec</span></span> ch jnz <span class="hljs-keyword"><span class="hljs-keyword">short</span></span> loc_1FFC6 retn sub_1FFC2 endp</code> </pre> </div></div><br><blockquote>  <code>getbit</code> ( <code>sub_1ffd0</code> ) lit un peu du flux d'entrée.  Son analyse nous permet de conclure que des bits individuels sont extraits du registre <code>ax</code> 16 bits, dont la valeur est chargée de la mémoire par l'instruction <code>lodsw</code> , qui charge deux octets du flux, mais comme le <em>processeur Intel</em> a un ordre d'octets peu fin, <code>xchg</code> réorganise la moitié du registre.  De plus, l'ordre des bits dans le flux est quelque peu illogique - le premier n'est pas le moins, mais le bit le plus significatif.   ,   <code>shl</code>      ,        <code>jb</code> . </blockquote><br><div class="spoiler"> <b class="spoiler_title">getbit</b> <div class="spoiler_text"><pre> <code class="hljs delphi">getbit proc <span class="hljs-keyword"><span class="hljs-keyword">near</span></span> <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> cl, cl jz short loc_1FFD9 dec cl <span class="hljs-keyword"><span class="hljs-keyword">shl</span></span> ax, <span class="hljs-number"><span class="hljs-number">1</span></span> retn loc_1FFD9: cmp si, <span class="hljs-number"><span class="hljs-number">27</span></span>B6h jz short loc_1FFE7 ;   lodsw xchg al, ah mov cl, <span class="hljs-number"><span class="hljs-number">0</span></span>Fh <span class="hljs-keyword"><span class="hljs-keyword">shl</span></span> ax, <span class="hljs-number"><span class="hljs-number">1</span></span> retn loc_1FFE7: call sub_202FC ;      lodsw xchg al, ah mov cl, <span class="hljs-number"><span class="hljs-number">0</span></span>Fh <span class="hljs-keyword"><span class="hljs-keyword">shl</span></span> ax, <span class="hljs-number"><span class="hljs-number">1</span></span> retn getbit endp</code> </pre> </div></div><br><p>    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" class="user_link">viiri</a>  ,    : </p><br><div class="spoiler"> <b class="spoiler_title">huffman_decompress</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">typedef</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">node_t</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> value; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">node_t</span></span></span><span class="hljs-class"> *</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">left</span></span></span><span class="hljs-class">, *</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">right</span></span></span><span class="hljs-class">;</span></span> } <span class="hljs-keyword"><span class="hljs-keyword">node_t</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> *g_src = <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getbits</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> numbits)</span></span></span><span class="hljs-function"> </span></span>{ ... } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> uint32_t </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getl_le</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">/*       4-    */</span></span> } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> node_t* </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">build_tree</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">node_t</span></span> *node = (<span class="hljs-keyword"><span class="hljs-keyword">node_t</span></span>*)<span class="hljs-built_in"><span class="hljs-built_in">calloc</span></span>(<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">node_t</span></span>)); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (getbits(<span class="hljs-number"><span class="hljs-number">1</span></span>)) { node-&gt;right = <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>; node-&gt;left = <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>; node-&gt;value = getbits(<span class="hljs-number"><span class="hljs-number">8</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { node-&gt;right = build_tree(); node-&gt;left = build_tree(); node-&gt;value = <span class="hljs-number"><span class="hljs-number">0</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> node; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">huffman_decompress</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint8_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *src, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint8_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *dst)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> length, i = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">node_t</span></span> *root, *node; g_src = src; length = getl_le(); node = root = build_tree(); <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (i &lt; length) { node = getbits(<span class="hljs-number"><span class="hljs-number">1</span></span>) ? node-&gt;left : node-&gt;right; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!node-&gt;left) { dst[i++] = node-&gt;value; node = root; } } ... }</code> </pre></div></div><br><p>       : </p><br><blockquote>    <code>build_code_table</code>    .     ,         ,                .     ,                 .     ,           ,    ,       —   (    <code>huffman_decompress</code> ). <br><br>     ? !       !  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="></a> ,   .       ( <em> </em> ):          . ,         3- ,         <em>N</em>  ,  <em>(3 — N)</em>     . </blockquote><p>       <code>ABCD</code> : <code>A - 0b, B - 10b, C - 110b, D - 111b</code> .       (  ),      ,     : </p><br><table><thead><tr><th>  Code </th><th>  </th><th>  </th></tr></thead><tbody><tr><td> <strong>0</strong> 00b </td><td>  1 </td><td>  Un </td></tr><tr><td> <strong>10</strong> 0b </td><td>  2 </td><td>  B </td></tr><tr><td> <strong>110</strong> b </td><td>  3 </td><td>  C </td></tr><tr><td> <strong>111</strong> b </td><td>  3 </td><td>  D </td></tr></tbody></table><br><p>       ,               .  , , ,      <code>010b</code> —     .       .  ,   'A'   <code>0b</code> ,     <em> </em>  ,    .     : </p><br><table><thead><tr><th>  Index </th><th>  Code </th><th>  </th><th>  </th></tr></thead><tbody><tr><td>  0 </td><td> <strong>0</strong> 00b </td><td>  1 </td><td>  Un </td></tr><tr><td>  1 </td><td> <strong>0</strong> 01b </td><td>  1 </td><td>  Un </td></tr><tr><td>  2 </td><td> <strong>0</strong> 10b </td><td>  1 </td><td>  Un </td></tr><tr><td>  3 </td><td> <strong>0</strong> 11b </td><td>  1 </td><td>  Un </td></tr><tr><td>  4 </td><td> <strong>10</strong> 0b </td><td>  2 </td><td>  B </td></tr><tr><td>  5 </td><td> <strong>10</strong> 1b </td><td>  2 </td><td>  B </td></tr><tr><td>  6 </td><td> <strong>110</strong> b </td><td>  3 </td><td>  C </td></tr><tr><td>  7 </td><td> <strong>111</strong> b </td><td>  3 </td><td>  D </td></tr></tbody></table><br><p> ,    <code>011010111b</code> : </p><br><ul><li>     : <code>011b</code> ; </li><li>  ,   <code>011b (3)</code> ,   <code>A</code> ,     ; </li><li>   <code>011b</code>    1, ,                 : <code>110b</code> ; </li><li>  ,   <code>110b (6)</code> ,   <code></code> ,     ; </li><li>   ,     . </li></ul><br><p>  «»     8- .      256 .          8 .   ,    ,  : </p><br><blockquote>           :      —  ,          .   ,    .   4 —   32- . </blockquote><p>     ,   .  . </p><br><hr><br><p>       ,      <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><em>github</em></a> .     ,       ,     ,   -   <em>[ ,    README.md]</em> . </p><br><p>  ,    ,     2015- : </p><br><ul><li> <em>LibNeuroRoutines (, MASM)</em> — ,       ,    .    ( <code>neuro_routines.h</code> )           ,   .     , : <br><ul><li>   ( <code>huffman_decompression.c</code> , <code>decompression.c</code> ); </li><li>    ( <code>cp437.c</code> ); </li><li>     ( <code>dialog.c</code> ); </li><li>    ( <code>audio.c</code> ). </li></ul></li><li> <em>NeuromancerWin64 ()</em> —     .                .     ,       <em>«»</em> ,    ,       .       <em>CSFML</em> ( <em>SFML</em>   <em>C</em> ). </li><li> <em>ResourceBrowser (C++)</em> —  .    <em>MFC</em> -,         <em>.DAT</em> -.    : <br><ul><li>     <em>BMP (8bpp)</em>  ( <em>IMH</em> , <em>PIC</em> ); </li><li>   ( <em>ANH</em> ); </li><li>     <em>WAV (PCM, 44100Hz, 8bps, mono)</em>  ( <em>SOUND</em> ). </li></ul></li></ul><br><p>    <em>LibNeuroRoutines</em>   .    <em>LibNeuroRoutines</em>  <em>CSFML</em> ( <em>ResourceBrowser</em>   <em>SFML</em>   ). </p><br><p>       64- <em>Windows</em>     .   ,   <em>LibNeuroRoutines</em>  64- <em>MASM (Microsoft Macro Assembler)</em> .   —    ,      64- . ,      <em>NASM</em>  <em>FASM</em> ,    ,             .      <em>VS 2015</em> — <em>MASM</em>   . </p><br><p>      ,   .         <em>C</em> .     ,           (  ,   <em>MFC</em> ). </p><br><p>   ,       .   - ,      . </p><br><hr><br><p>           .  ? ,  .            ,   .    - ,      . ,    ,     ,     .  (). </p><br><ol><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Make sound from the speaker using assembly</a> </li><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Programming the PC Speaker</a> </li><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">PC Speaker</a> </li><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Programmable Interval Timer</a> </li><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Making C Sing</a> </li><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Beyond Beep-Boop: Mastering the PC Speaker</a> </li></ol></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr417639/">https://habr.com/ru/post/fr417639/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr417619/index.html">Win32 / Glupteba n'est plus associé à l'opération Windigo</a></li>
<li><a href="../fr417621/index.html">Que s'est-il passé lorsque nous avons craqué l'exposition?</a></li>
<li><a href="../fr417627/index.html">Hyper CRM ou Mini ERP? Les affaires ont gâché</a></li>
<li><a href="../fr417629/index.html">Delphi et C ++ Builder Community Edition</a></li>
<li><a href="../fr417631/index.html">Tutoriel vidéo CSS Grid</a></li>
<li><a href="../fr417641/index.html">10 cours d'été d'apprentissage automatique</a></li>
<li><a href="../fr417643/index.html">Chevaliers du manteau et rootkits: que voir des hackers. Émissions de télévision</a></li>
<li><a href="../fr417645/index.html">Concours de programmation: négociation (résultats intermédiaires et annonces)</a></li>
<li><a href="../fr417647/index.html">Un projet de loi sur la protection des données personnelles présenté au Bélarus - ce qu'il y a "à l'intérieur"</a></li>
<li><a href="../fr417649/index.html">OpenAI surmonte les limitations importantes de l'IA pour Dota 2</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>