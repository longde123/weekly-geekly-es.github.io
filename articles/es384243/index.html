<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üïö üë©üèæ‚Äçüé§ üëª Controlador inal√°mbrico de aire acondicionado para el hogar de OpenHAB a trav√©s de Modbus a trav√©s de RF24Network üë®üèΩ‚Äç‚öñÔ∏è üöû üèîÔ∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Despu√©s de mi primer art√≠culo sobre el control del aire acondicionado con un controlador, pasaron poco m√°s de 2 a√±os. Durante este tiempo, la idea de ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Controlador inal√°mbrico de aire acondicionado para el hogar de OpenHAB a trav√©s de Modbus a trav√©s de RF24Network</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/384243/"><img align="left" src="https://habrastorage.org/files/1d4/8ed/b4b/1d48edb4b2b24079a0e2a7e7d5d7e584.png"><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Despu√©s de </font><font style="vertical-align: inherit;">mi </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">primer</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> art√≠culo sobre el control del aire acondicionado con un controlador, pasaron poco m√°s de 2 a√±os. </font><font style="vertical-align: inherit;">Durante este tiempo, la idea de controlar el aire acondicionado de forma remota no me abandon√≥ y tuvo varios renacimientos. </font><font style="vertical-align: inherit;">La condici√≥n principal era la ausencia de cables al aire acondicionado. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Es decir, el control del controlador debe ser inal√°mbrico.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Antecedentes</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El primer prototipo fue el Arduino UNO. Ella acept√≥ equipos en UART y sab√≠a c√≥mo encender y apagar el aire acondicionado. Porque El arduinka conectado a la computadora en funcionamiento ten√≠a poco sentido pr√°ctico, el jefe buscaba constantemente la oportunidad de conectar esta √∫ltima al servidor dom√©stico. No hubo visibilidad directa del servidor al culpable de todos los rompecabezas. El m√°ximo es un z√≥calo con una LAN en la misma computadora que funciona, ya que se encuentra casi enfrente del aire acondicionado. Un escudo de Ethernet no estaba disponible. Pero recordando que en alg√∫n lugar del zashashnik se encuentra un m√≥dem dsl DSL-2500U d-link que no se ha utilizado durante mucho tiempo, con solo un puerto a bordo. El deseo de darle una segunda vida a la pieza de hierro condujo a googlear, lo que, a su vez, condujo milagrosamente al art√≠culo </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Convertir un m√≥dem ADSL en un escudo Ethernet para Arduino / CraftDuino</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Saltando hacia adelante y omitiendo el interesante proceso de crear firmware personalizado, todav√≠a logr√© que el m√≥dem escuchara en el puerto deseado y "reenviara" el UART a trav√©s de √©l. </font><font style="vertical-align: inherit;">Por lo tanto, en el servidor dom√©stico, podr√≠a enviar un comando para encender / apagar el puerto a la direcci√≥n local del m√≥dem, que ir√° al arduino conectado a √©l. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pero este art√≠culo no se trata de eso. </font><font style="vertical-align: inherit;">La soluci√≥n </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">definitiva</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> utiliza el protocolo Modbus y la red inal√°mbrica </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;">RF24Network</font></a><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Y todo est√° controlado en OpenHAB.</font></font><br>
<a name="habracut"></a><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Durante estos dos a√±os, logr√© ordenar una gran cantidad de nishtyaks de China y la mayor√≠a de ellos me estaban esperando. </font><font style="vertical-align: inherit;">Esta lista inclu√≠a el m√≥dulo NRF24L01 +, comprado por un pu√±ado para experimentaci√≥n. </font><font style="vertical-align: inherit;">Y √©l habr√≠a ido m√°s lejos en alg√∫n lugar del armario inactivo, si un d√≠a no me hubiera topado con una serie de art√≠culos:</font></font><br>
<ul>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">C√≥mo hacer amigos OpenHAB y Arduino</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Arduino y Modbus</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Arduino y OpenHAB</font></font></a></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
desde  </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" class="user_link"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Borich</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">¬°Gracias por eso! </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Gracias a ellos, me familiaric√© con el protocolo Modbus. </font><font style="vertical-align: inherit;">Pero lo m√°s importante, descubr√≠ OpenHAB por m√≠ mismo, lo que he estado buscando durante mucho tiempo. </font><font style="vertical-align: inherit;">Esto me llev√≥ a comenzar a implementar ideas de larga data. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Despu√©s de jugar con ejemplos de los art√≠culos, decid√≠ tratar de separar el controlador y el servidor usando el escudo de ethernet del m√≥dem descrito anteriormente. </font><font style="vertical-align: inherit;">Esta soluci√≥n nos permiti√≥ lograr la tarea planteada: el escudo y el controlador estaban ubicados en el escritorio, sin usar una computadora que funcionara, al mismo tiempo, el escudo siempre est√° conectado a la red local y es accesible desde el servidor dom√©stico.</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pero esta decisi√≥n estaba condenada al fracaso.</font></font></b><div class="spoiler_text">     ModbusRtu over TCP   .    modpoll,   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Arduino &amp; Modbus</a>  .     ‚Äî          192.168.1.110   3000  !<br>
<br>
    OpenHAB. ,  , Modbus Binding   ¬´RTU over TCP¬ª.        ‚Äî     ModbusRtu   c      TCP.            OpenHAB-(ethernet)--(UART)-.<br>
<br>
 ,   ?      Item  .      1 Item     .      ‚Äî      . ,   ,    TCP    Modbus Binding. ..              .<br>
<br>
   Modbus Binding     Item'   host-port-slaveID     .<br>
<br>
        ,     .                .       ,    .<br>
</div></div><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Idea</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Y luego finalmente me establec√≠ que necesitaba hacer un controlador que sea accesible por aire. </font><font style="vertical-align: inherit;">¬°Los m√≥dulos NRF24L01 + no deber√≠an desaparecer! ... Es cierto, esto requer√≠a al menos dos controladores: uno desempe√±a un papel directo, el segundo desempe√±a el papel de un enrutador. </font><font style="vertical-align: inherit;">El segundo debe estar conectado al servidor y es a trav√©s de √©l que se lleva a cabo la comunicaci√≥n inal√°mbrica con los dem√°s. </font><font style="vertical-align: inherit;">Al conectarse a √©l, especificamos la ID del subordinado a quien est√° destinado el paquete. </font><font style="vertical-align: inherit;">Resulta que muchos esclavos est√°n disponibles en un puerto serie. </font><font style="vertical-align: inherit;">S√≠, esta es una red inal√°mbrica basada en Modbus. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Modbus, por cierto, hizo posible construir una red con un maestro, muchos subordinados. </font><font style="vertical-align: inherit;">Y la biblioteca </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">RF24Network</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , para hacer que todo sea inal√°mbrico, e incluso con enrutamiento autom√°tico entre nodos de red.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Desarrollo de bibliotecas para Arduino</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para implementar tal soluci√≥n, tom√≥ un poco modificar la biblioteca </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Modbus-Master-Slave-for-Arduino</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> para poder heredarla y sobrecargar un par de m√©todos. </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mi implementaci√≥n</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> tambi√©n se actualiza (se agrega library.properties, el archivo de biblioteca se divide en encabezado y cuerpo) para el √∫ltimo Arduino IDE 1.6.5. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La biblioteca </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Modbus-over-RF24Network-for-Arduino le</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> permite implementar dos comportamientos posibles: Proxy y Slave. </font><font style="vertical-align: inherit;">Ejemplo ModbusRF24Proxy es en realidad una implementaci√≥n de un "enrutador" y no requiere ninguna modificaci√≥n que no sea establecer los pines necesarios.</font></font><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ejemplo Modbus RF24Proxy</font></font></b><div class="spoiler_text"><pre><code class="cpp hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;RF24Network.h&gt;</span></span><font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;RF24.h&gt;</span></span><font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;SPI.h&gt;</span></span><font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;ModbusRtu.h&gt;</span></span><font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;ModbusRtuRF24.h&gt;</span></span><font></font>
<font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> stlPin  13  <span class="hljs-comment">//     (   Arduino)</span></span><font></font>
<font></font>
<span class="hljs-comment">// nRF24L01(+) radio attached using Getting Started board </span><font></font>
<span class="hljs-function">RF24 <span class="hljs-title">radio</span><span class="hljs-params">(<span class="hljs-number">9</span>, <span class="hljs-number">10</span>)</span></span>;<font></font>
<font></font>
<span class="hljs-comment">// Network uses that radio</span><font></font>
<span class="hljs-function">RF24Network <span class="hljs-title">network</span><span class="hljs-params">(radio)</span></span>;<font></font>
<font></font>
<span class="hljs-comment">// Address of our node</span><font></font>
<span class="hljs-keyword">const</span> <span class="hljs-keyword">uint16_t</span> this_node = <span class="hljs-number">0</span>;<font></font>
<font></font>
<span class="hljs-comment">//  ,   TX</span><font></font>
<span class="hljs-function">ModbusRF24 <span class="hljs-title">proxy</span><span class="hljs-params">(network, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>)</span></span>;<font></font>
<span class="hljs-keyword">int8_t</span> state = <span class="hljs-number">0</span>;<font></font>
<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span> tempus;<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">setup</span><span class="hljs-params">()</span> </span>{<font></font>
    <span class="hljs-comment">//    </span><font></font>
    io_setup();<font></font>
    <span class="hljs-comment">//    </span><font></font>
<font></font>
    proxy.begin(<span class="hljs-number">57600</span>);<font></font>
<font></font>
    SPI.begin();<font></font>
    radio.begin();<font></font>
    network.begin(<span class="hljs-comment">/*channel*/</span> <span class="hljs-number">90</span>, <span class="hljs-comment">/*node address*/</span> this_node);<font></font>
<font></font>
    <span class="hljs-comment">//    100 </span><font></font>
    tempus = millis() + <span class="hljs-number">100</span>;<font></font>
    digitalWrite(stlPin, HIGH);<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">io_setup</span><span class="hljs-params">()</span> </span>{<font></font>
    digitalWrite(stlPin, HIGH);<font></font>
    pinMode(stlPin, OUTPUT);<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">loop</span><span class="hljs-params">()</span> </span>{<font></font>
<font></font>
    <span class="hljs-comment">// Pump the network regularly</span><font></font>
    network.update();<font></font>
<font></font>
    <span class="hljs-comment">//  </span><font></font>
    state = proxy.proxy();<font></font>
<font></font>
    <span class="hljs-comment">//      -    50  </span><font></font>
    <span class="hljs-keyword">if</span> (state &gt; <span class="hljs-number">4</span>) {<font></font>
        tempus = millis() + <span class="hljs-number">50</span>;<font></font>
        digitalWrite(stlPin, HIGH);<font></font>
    }<font></font>
    <span class="hljs-keyword">if</span> (millis() &gt; tempus) digitalWrite(stlPin, LOW);<font></font>
}<font></font>
</code></pre><br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Un enrutador o proxy utiliza un formato de constructor especial:</font></font><br>
<pre><code class="cpp hljs"><span class="hljs-comment">//  ,   TX</span><font></font>
<span class="hljs-function">ModbusRF24 <span class="hljs-title">proxy</span><span class="hljs-params">(network, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>)</span></span>;<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
y funci√≥n </font></font><br>
<pre><code class="cpp hljs">proxy.proxy();
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
para procesar paquetes entrantes en el puerto serie, enviarlos a la red RF24, recibir una respuesta de la red y enviar el resultado nuevamente al puerto serie. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En esta implementaci√≥n, el proxy tiene una direcci√≥n RF24Network de cero:</font></font><br>
<pre><code class="cpp hljs"><span class="hljs-comment">// Address of our node</span><font></font>
<span class="hljs-keyword">const</span> <span class="hljs-keyword">uint16_t</span> this_node = <span class="hljs-number">0</span>;<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 - es decir </font><font style="vertical-align: inherit;">Este es el dispositivo ra√≠z de la red. </font><font style="vertical-align: inherit;">Si es necesario, la posici√≥n en la topolog√≠a del controlador proxy se puede cambiar.</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ejemplo de Modbus RF24Slave</font></font></b><div class="spoiler_text">    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Arduino &amp; Modbus</a>:<br>
<pre><code class="cpp hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;RF24Network.h&gt;</span></span><font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;RF24.h&gt;</span></span><font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;SPI.h&gt;</span></span><font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;ModbusRtu.h&gt;</span></span><font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;ModbusRtuRF24.h&gt;</span></span><font></font>
<font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> ID   1      <span class="hljs-comment">//  </span></span><font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> btnPin  2   <span class="hljs-comment">//  ,   </span></span><font></font>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> ledPin  7  <span class="hljs-comment">//   </span></span><font></font>
<font></font>
<span class="hljs-comment">// nRF24L01(+) radio attached using Getting Started board </span><font></font>
<span class="hljs-function">RF24 <span class="hljs-title">radio</span><span class="hljs-params">(<span class="hljs-number">9</span>, <span class="hljs-number">10</span>)</span></span>;<font></font>
<font></font>
<span class="hljs-comment">// Network uses that radio</span><font></font>
<span class="hljs-function">RF24Network <span class="hljs-title">network</span><span class="hljs-params">(radio)</span></span>;<font></font>
<font></font>
<span class="hljs-comment">// Address of our node</span><font></font>
<span class="hljs-keyword">const</span> <span class="hljs-keyword">uint16_t</span> this_node = ID;<font></font>
<font></font>
<span class="hljs-comment">//  </span><font></font>
<span class="hljs-function">ModbusRF24 <span class="hljs-title">slave</span><span class="hljs-params">(network, ID)</span></span>;<font></font>
<font></font>
<span class="hljs-comment">//   modbus</span><font></font>
<span class="hljs-keyword">uint16_t</span> au16data[<span class="hljs-number">11</span>];<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">io_setup</span><span class="hljs-params">()</span> </span>{<font></font>
    digitalWrite(ledPin, LOW);<font></font>
    pinMode(ledPin, OUTPUT);<font></font>
    pinMode(btnPin, INPUT);<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">io_poll</span><span class="hljs-params">()</span> </span>{<font></font>
    <span class="hljs-comment">// Coil[1]  Discrete[0]</span><font></font>
    au16data[<span class="hljs-number">0</span>] = au16data[<span class="hljs-number">1</span>];<font></font>
    <span class="hljs-comment">//   1.3   </span><font></font>
    digitalWrite(ledPin, bitRead(au16data[<span class="hljs-number">1</span>], <span class="hljs-number">3</span>));<font></font>
    <span class="hljs-comment">//     0.3</span><font></font>
    bitWrite(au16data[<span class="hljs-number">0</span>], <span class="hljs-number">3</span>, digitalRead(btnPin));<font></font>
    <span class="hljs-comment">// Holding[5,6,7]  Input[2,3,4]</span><font></font>
    au16data[<span class="hljs-number">2</span>] = au16data[<span class="hljs-number">5</span>];<font></font>
    au16data[<span class="hljs-number">3</span>] = au16data[<span class="hljs-number">6</span>];<font></font>
    au16data[<span class="hljs-number">4</span>] = au16data[<span class="hljs-number">7</span>];<font></font>
    <span class="hljs-comment">//    </span><font></font>
    au16data[<span class="hljs-number">8</span>] = slave.getInCnt();<font></font>
    au16data[<span class="hljs-number">9</span>] = slave.getOutCnt();<font></font>
    au16data[<span class="hljs-number">10</span>] = slave.getErrCnt();<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">setup</span><span class="hljs-params">()</span> </span>{<font></font>
    <span class="hljs-comment">//    </span><font></font>
    io_setup();<font></font>
<font></font>
    Serial.begin(<span class="hljs-number">57600</span>);<font></font>
    Serial.println(<span class="hljs-string">"RF24Network/examples/modbus_slave/"</span>);<font></font>
<font></font>
    SPI.begin();<font></font>
    radio.begin();<font></font>
    network.begin(<span class="hljs-comment">/*channel*/</span> <span class="hljs-number">90</span>, <span class="hljs-comment">/*node address*/</span> this_node);<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">loop</span><span class="hljs-params">()</span> </span>{<font></font>
<font></font>
    <span class="hljs-comment">// Pump the network regularly</span><font></font>
    network.update();<font></font>
<font></font>
    <span class="hljs-keyword">if</span> (network.available()) {<font></font>
        slave.poll(au16data, <span class="hljs-number">11</span>);<font></font>
    }<font></font>
    <span class="hljs-comment">//    Modbus    </span><font></font>
    io_poll();<font></font>
}<font></font>
</code></pre><br>
<br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El constructor en este caso ya es diferente:</font></font><br>
<pre><code class="cpp hljs"><span class="hljs-comment">//  </span><font></font>
<span class="hljs-function">ModbusRF24 <span class="hljs-title">slave</span><span class="hljs-params">(network, ID)</span></span>;<font></font>
</code></pre><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Estructura de registro Modbus</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Despu√©s de los primeros intentos exitosos de controlar el aire acondicionado con la capacidad de encender y apagar solo mi apetito solo aument√≥. </font><font style="vertical-align: inherit;">Ahora, esto no era suficiente, y dado que tengo la funcionalidad OpenHAB en mi aplicaci√≥n m√≥vil, deber√≠a hacer como m√≠nimo toda la funcionalidad del panel de control nativo. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Esto significa que aqu√≠ hay una lista de caracter√≠sticas al menos:</font></font><br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">indicaci√≥n del estado actual</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">encendido y apagado del aire acondicionado, modos individuales (O </font></font><sub><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2</font></font></sub><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , ionizaci√≥n, modo silencioso);</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">selecci√≥n del modo actual (autom√°tico, calefacci√≥n, refrigeraci√≥n, drenaje, ventilador);</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">indicaci√≥n de temperatura y velocidad del ventilador para cada modo. </font><font style="vertical-align: inherit;">Para el modo de ventilador, solo velocidad;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ajuste de cortina vertical (autom√°tico, 0 ¬∞, 15 ¬∞, 30 ¬∞, 45 ¬∞, 60 ¬∞);</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ajuste de cortina horizontal (autom√°tico, "| |", "/ /", "/ |", "| \", "\ \");</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ajuste de hora (hora, minuto);</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">en la configuraci√≥n del temporizador;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ajuste del temporizador de apagado;</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ajuste a tiempo (hora, minuto);</font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ajuste del tiempo de apagado (hora, minuto);</font></font></li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Durante el proceso de desarrollo, la estructura de los registros ha cambiado muchas veces conmigo. </font><font style="vertical-align: inherit;">La versi√≥n actual est√° debajo del spoiler.</font></font><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Registros Modbus</font></font></b><div class="spoiler_text"><table>
<tbody><tr>
<th>Type</th>
<th>Byte</th>
<th>Bit</th>
<th>Name</th>
<th></th>
</tr>
<tr>
<td>Bit RO</td>
<td>0</td>
<td>0</td>
<td>CFG_OXYGEN</td>
<td>1 ‚Äî   </td>
</tr>
<tr>
<td>Bit RO</td>
<td></td>
<td>1</td>
<td>CFG_ION</td>
<td>1 ‚Äî   </td>
</tr>
<tr>
<td>Bit RO</td>
<td></td>
<td>2</td>
<td>CFG_QUIET</td>
<td>1 ‚Äî   </td>
</tr>
<tr>
<td>Bit RO</td>
<td></td>
<td>3</td>
<td>CFG_TIMER</td>
<td>1 ‚Äî  /   </td>
</tr>
<tr>
<td>Bit RO</td>
<td></td>
<td>4</td>
<td>CFG_DELAY</td>
<td>1 ‚Äî   /</td>
</tr>
<tr>
<td>Bit RO</td>
<td></td>
<td>5</td>
<td>CFG_SWING</td>
<td>1 ‚Äî   </td>
</tr>
<tr>
<td>Bit RO</td>
<td></td>
<td>6</td>
<td>CFG_SWINGH</td>
<td>1 ‚Äî    </td>
</tr>
<tr>
<td>Bit RO</td>
<td></td>
<td>7</td>
<td>CFG_SWINGV</td>
<td>1 ‚Äî    </td>
</tr>
<tr>
<td>Bit RO</td>
<td></td>
<td>8</td>
<td>CFG_CLOCK</td>
<td>1 ‚Äî  </td>
</tr>
<tr>
<td>Bit RO</td>
<td></td>
<td>9</td>
<td></td>
<td></td>
</tr>
<tr>
<td>Bit RO</td>
<td></td>
<td>10</td>
<td></td>
<td></td>
</tr>
<tr>
<td>Bit RO</td>
<td></td>
<td>11</td>
<td>CFG_AUTO</td>
<td>1 ‚Äî   AUTO</td>
</tr>
<tr>
<td>Bit RO</td>
<td></td>
<td>12</td>
<td>CFG_COOL</td>
<td>1 ‚Äî   COOL</td>
</tr>
<tr>
<td>Bit RO</td>
<td></td>
<td>13</td>
<td>CFG_HEAT</td>
<td>1 ‚Äî   HEAT</td>
</tr>
<tr>
<td>Bit RO</td>
<td></td>
<td>14</td>
<td>CFG_DRY</td>
<td>1 ‚Äî   DRY</td>
</tr>
<tr>
<td>Bit RO</td>
<td></td>
<td>15</td>
<td>CFG_FAN</td>
<td>1 ‚Äî   FAN</td>
</tr>
<tr>
<td>Integer RO</td>
<td>1</td>
<td></td>
<td>CFG_TEMP</td>
<td>.  . : Min + Max*256</td>
</tr>
<tr>
<td>Integer RO</td>
<td>2</td>
<td></td>
<td>CFG_FAN_SPEED</td>
<td>  FAN</td>
</tr>
<tr>
<td>Bit RO</td>
<td>3</td>
<td>0</td>
<td>STATE_POWER</td>
<td>:0 ‚Äî , 1 ‚Äî </td>
</tr>
<tr>
<td>Bit RO</td>
<td></td>
<td>1</td>
<td>STATE_OXYGEN</td>
<td>:0 ‚Äî , 1 ‚Äî </td>
</tr>
<tr>
<td>Bit RO</td>
<td></td>
<td>2</td>
<td>STATE_ION</td>
<td>:0 ‚Äî , 1 ‚Äî </td>
</tr>
<tr>
<td>Bit RO</td>
<td></td>
<td>3</td>
<td>STATE_QUIET</td>
<td>:0 ‚Äî , 1 ‚Äî </td>
</tr>
<tr>
<td>Bit RO</td>
<td></td>
<td>4</td>
<td>STATE_TIMER</td>
<td>:0 ‚Äî , 1 ‚Äî </td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>Bit RW</td>
<td></td>
<td>8</td>
<td>CONTROL_POWER</td>
<td></td>
</tr>
<tr>
<td>Bit RW</td>
<td></td>
<td>9</td>
<td>CONTROL_OXYGEN</td>
<td></td>
</tr>
<tr>
<td>Bit RW</td>
<td></td>
<td>10</td>
<td>CONTROL_ION</td>
<td></td>
</tr>
<tr>
<td>Bit RW</td>
<td></td>
<td>11</td>
<td>CONTROL_QUIET</td>
<td></td>
</tr>
<tr>
<td>Integer RO</td>
<td>4</td>
<td></td>
<td>RTC_HR_MI</td>
<td>0x1308</td>
</tr>
<tr>
<td>Integer RW</td>
<td>5</td>
<td></td>
<td>RTCW_HR_MI</td>
<td>0x1308</td>
</tr>
<tr>
<td>Integer RO</td>
<td>6</td>
<td></td>
<td>TEMPERATURE1</td>
<td> . INT16,   </td>
</tr>
<tr>
<td>Integer RO</td>
<td>7</td>
<td></td>
<td>TEMPERATURE2</td>
<td> . INT16,   </td>
</tr>
<tr>
<td>Bit RW</td>
<td>8</td>
<td>0</td>
<td>MODE_AUTO</td>
<td></td>
</tr>
<tr>
<td>Bit RW</td>
<td></td>
<td>1</td>
<td>MODE_COOL</td>
<td></td>
</tr>
<tr>
<td>Bit RW</td>
<td></td>
<td>2</td>
<td>MODE_HEAT</td>
<td></td>
</tr>
<tr>
<td>Bit RW</td>
<td></td>
<td>3</td>
<td>MODE_DRY</td>
<td></td>
</tr>
<tr>
<td>Bit RW</td>
<td></td>
<td>4</td>
<td>MODE_FAN</td>
<td></td>
</tr>
<tr>
<td>Integer RW</td>
<td>9</td>
<td></td>
<td>TEMP_AUTO</td>
<td> AUTO</td>
</tr>
<tr>
<td>Integer RW</td>
<td>10</td>
<td></td>
<td>TEMP_COOL</td>
<td> COOL</td>
</tr>
<tr>
<td>Integer RW</td>
<td>11</td>
<td></td>
<td>TEMP_HEAT</td>
<td> HEAT</td>
</tr>
<tr>
<td>Integer RW</td>
<td>12</td>
<td></td>
<td>TEMP_DRY</td>
<td> DRY</td>
</tr>
<tr>
<td>Integer RW</td>
<td>13</td>
<td></td>
<td>FAN_AUTO</td>
<td> AUTO. 0: Auto</td>
</tr>
<tr>
<td>Integer RW</td>
<td>14</td>
<td></td>
<td>FAN_COOL</td>
<td> COOL. 0: Auto</td>
</tr>
<tr>
<td>Integer RW</td>
<td>15</td>
<td></td>
<td>FAN_HEAT</td>
<td> HEAT. 0: Auto</td>
</tr>
<tr>
<td>Integer RW</td>
<td>16</td>
<td></td>
<td>FAN_DRY</td>
<td> DRY. 0: Auto</td>
</tr>
<tr>
<td>Integer RW</td>
<td>17</td>
<td></td>
<td>FAN_SPEED</td>
<td> FAN. 0: Auto</td>
</tr>
<tr>
<td>Bit RW</td>
<td>18</td>
<td>0</td>
<td>SWING_AUTO</td>
<td> </td>
</tr>
<tr>
<td>Bit RW</td>
<td></td>
<td>1</td>
<td>SWINGV_0</td>
<td>   0¬∞</td>
</tr>
<tr>
<td>Bit RW</td>
<td></td>
<td>2</td>
<td>SWINGV_15</td>
<td>   15¬∞</td>
</tr>
<tr>
<td>Bit RW</td>
<td></td>
<td>3</td>
<td>SWINGV_30</td>
<td>   30¬∞</td>
</tr>
<tr>
<td>Bit RW</td>
<td></td>
<td>4</td>
<td>SWINGV_45</td>
<td>   45¬∞</td>
</tr>
<tr>
<td>Bit RW</td>
<td></td>
<td>5</td>
<td>SWINGV_60</td>
<td>   60¬∞</td>
</tr>
<tr>
<td>Bit RW</td>
<td>19</td>
<td>0</td>
<td>SWINGH_AUTO</td>
<td> </td>
</tr>
<tr>
<td>Bit RW</td>
<td></td>
<td>1</td>
<td>SWINGH_VV</td>
<td>  | &nbsp;|</td>
</tr>
<tr>
<td>Bit RW</td>
<td></td>
<td>2</td>
<td>SWINGH_LL</td>
<td>  / &nbsp;/</td>
</tr>
<tr>
<td>Bit RW</td>
<td></td>
<td>3</td>
<td>SWINGH_LV</td>
<td>  / &nbsp;|</td>
</tr>
<tr>
<td>Bit RW</td>
<td></td>
<td>4</td>
<td>SWINGH_VR</td>
<td>  | &nbsp;\</td>
</tr>
<tr>
<td>Bit RW</td>
<td></td>
<td>5</td>
<td>SWINGH_RR</td>
<td>  \ &nbsp;\</td>
</tr>
<tr>
<td>Bit RW</td>
<td>20</td>
<td>0</td>
<td>TIMER_ON</td>
<td></td>
</tr>
<tr>
<td>Bit RW</td>
<td></td>
<td>1</td>
<td>TIMER_OFF</td>
<td></td>
</tr>
<tr>
<td>Integer RW</td>
<td>21</td>
<td></td>
<td>TIME_ON_HOUR</td>
<td> </td>
</tr>
<tr>
<td>Integer RW</td>
<td>22</td>
<td></td>
<td>TIME_ON_MINUTE</td>
<td> </td>
</tr>
<tr>
<td>Integer RW</td>
<td>23</td>
<td></td>
<td>TIME_OFF_HOUR</td>
<td> </td>
</tr>
<tr>
<td>Integer RW</td>
<td>24</td>
<td></td>
<td>TIME_OFF_MINUTE</td>
<td> </td>
</tr>
<tr>
<td>Integer RW</td>
<td>25</td>
<td></td>
<td>DS18B20_ENV</td>
<td>. </td>
</tr>
<tr>
<td>Integer RW</td>
<td>26</td>
<td></td>
<td>DS18B20_NOZ</td>
<td>. </td>
</tr>
</tbody></table><br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Los registros est√°n organizados de tal manera que toda la matriz de datos se inicializa desde la EEPROM cuando se inicia el controlador. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Los primeros 3 registros (CFG_ *) contienen la configuraci√≥n de caracter√≠sticas, nunca cambian y son inicializados por el firmware EEPROM. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Los registros 3-7 siempre muestran el estado actual del controlador. Los bits altos del registro 3 se usan para cambiar el estado. Sus cambios inician el encendido / apagado del aire acondicionado y los modos especiales. Despu√©s de ejecutar el comando, los bits de orden inferior de este registro se copian en los de orden superior. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El registro 4 contiene el tiempo actual del controlador, que se lee del RTC. El valor se guarda en formato BCD, de modo que cuando el registro se muestra en notaci√≥n hexadecimal, el tiempo se lee como es: 12:34 es 0x1234. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El registro 5 se usa para cambiar el tiempo RTC.</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Los registros 6-7 contienen la temperatura de los sensores DS18B20. </font><font style="vertical-align: inherit;">El valor contiene un entero con signo y es igual a T * 100, es decir </font><font style="vertical-align: inherit;">25,67 ¬∞ C = 2567. </font><font style="vertical-align: inherit;">Se proporciona un m√°ximo de 2 sensores, pero el n√∫mero se puede cambiar f√°cilmente expandiendo la tabla de registro para almacenar las direcciones de los sensores y sus temperaturas. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Los √∫ltimos 2 bytes de la direcci√≥n del sensor se almacenan en los registros 25-26. </font><font style="vertical-align: inherit;">Al cambiar los sensores, restablezca el registro de direcci√≥n correspondiente. </font><font style="vertical-align: inherit;">Cuando se detecta un nuevo sensor, se verifica su presencia en los registros 25-26. </font><font style="vertical-align: inherit;">Si la direcci√≥n est√° en la tabla, el valor de temperatura del sensor se ingresa en el registro correspondiente 6-7. </font><font style="vertical-align: inherit;">Si la direcci√≥n no est√° en la tabla y la tabla tiene cero celdas, la direcci√≥n del sensor actual se escribe en una celda libre. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Los registros 8-26, cuando los modifica el usuario, se guardan en la EEPROM.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Gl√°ndulas</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El hardware consta de los siguientes componentes:</font></font><br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Arduino Pro Mini. </font></font><div class="spoiler"><b class="spoiler_title"> </b><div class="spoiler_text"><img src="https://habrastorage.org/files/e8a/460/33b/e8a46033b9cf45609d87e9a08f9f4ba9.png" alt="Arduino Pro Mini NEW"></div></div></li>
<li>NRF24L01+ ‚Äî   2.4</li>
<li>LM1117-3.3 ‚Äî  3.3  NRF24L01+</li>
<li>DS1302 ‚Äî RTC</li>
<li> 32768  RTC</li>
<li>DS18B20 ‚Äî  . 2</li>
<li> ‚Äî , , </li>
</ol><br>
<br>
<img src="https://habrastorage.org/files/b4f/6f2/357/b4f6f2357e044c78a3472d4d6b25ad07.jpg"><br>
<img src="https://habrastorage.org/files/025/6de/902/0256de902fed444682fc2e16f3e9be88.jpg"><br>
<img src="https://habrastorage.org/files/e45/604/4aa/e456044aabe0499c9b8016d908411434.jpg"><br>
<img src="https://habrastorage.org/files/3f2/818/d9a/3f2818d9af814ffba67ed9e271c1450d.jpg"><br>
<img src="https://habrastorage.org/files/f76/385/124/f76385124e4e4c2ca573b268365f5e40.jpg"><br>
<img src="https://habrastorage.org/files/be6/ded/b3c/be6dedb3c93a40fe9841a17dead1b723.jpg"><br>
<img src="https://habrastorage.org/files/80a/50c/1b7/80a50c1b7e154c87ae07296e704d6674.jpg"><br>
<img src="https://habrastorage.org/files/a5b/f61/96e/a5bf6196ee764f90bf535df517477363.jpg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La retroalimentaci√≥n con el aire acondicionado se realiza conectando optoacopladores a los LED correspondientes. Por lo tanto, se garantiza el aislamiento galv√°nico con el circuito el√©ctrico del aire acondicionado. La corriente de las entradas para los optoacopladores se seleccion√≥ experimentalmente usando resistencias para que la salida del optoacoplador tambi√©n se abriera y el brillo del LED principal en el aire acondicionado no se redujera. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Se instal√≥ un LED IR al lado del receptor IR del aire acondicionado. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El controlador funciona con carga mini-USB de alg√∫n tipo de milagro chino. Los contactos de tensi√≥n de red chinos fueron retirados de la caja de carga, los cables fueron retirados. La carga se instal√≥ en las entra√±as de la caja del aire acondicionado, conectada a la entrada 220 en paralelo con ella. El controlador se conecta a la carga con un cable USB AB normal.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El controlador "enrutador" se basa en el Arduino Mega2560 y NRF24L01 + con un LM1117-3.3 separado. </font><font style="vertical-align: inherit;">Adem√°s de una fuente de alimentaci√≥n 3.3 separada, se conecta un electrolito al m√≥dulo inal√°mbrico (lo encontr√© a 470 uf * 16 v) en las patas de alimentaci√≥n. </font><font style="vertical-align: inherit;">Como saben, el bus de alimentaci√≥n interno Mega2560 3.3V es muy ruidoso y el m√≥dulo se neg√≥ a transmitir datos, aunque respondi√≥ correctamente. </font><font style="vertical-align: inherit;">Pero incluso con una fuente de alimentaci√≥n separada sin condensador, la conexi√≥n era muy inestable. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para que el mega2560 no se reinicie al abrir el puerto a trav√©s de USB, se conecta un electrolito de 10 Œºf al pin de reinicio.</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Openhab</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">art√≠culo de Arduino y OpenHAB</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> describe una caracter√≠stica del complemento Modbus Binding, que con cada sondeo del controlador, el complemento env√≠a un evento al bus, incluso si nada ha cambiado. </font><font style="vertical-align: inherit;">Segu√≠ su ejemplo y finalic√© el complemento.</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Configuraci√≥n del complemento de enlace Modbus</font></font></b><div class="spoiler_text">#<br>
modbus:serial.ac_hall_state.connection=/dev/ttyACM0:57600:8:none:1:rtu<br>
modbus:serial.ac_hall_state.id=1<br>
modbus:serial.ac_hall_state.start=48<br>
modbus:serial.ac_hall_state.length=5<br>
modbus:serial.ac_hall_state.type=discrete<br>
<br>
#<br>
modbus:serial.ac_hall_power.connection=/dev/ttyACM0:57600:8:none:1:rtu<br>
modbus:serial.ac_hall_power.id=1<br>
modbus:serial.ac_hall_power.start=56<br>
modbus:serial.ac_hall_power.length=4<br>
modbus:serial.ac_hall_power.type=coil<br>
<br>
#<br>
modbus:serial.ac_hall_rtc.connection=/dev/ttyACM0:57600:8:none:1:rtu<br>
modbus:serial.ac_hall_rtc.id=1<br>
modbus:serial.ac_hall_rtc.start=4<br>
modbus:serial.ac_hall_rtc.length=1<br>
modbus:serial.ac_hall_rtc.type=holding<br>
<br>
# <br>
modbus:serial.ac_hall_temperature.connection=/dev/ttyACM0:57600:8:none:1:rtu<br>
modbus:serial.ac_hall_temperature.id=1<br>
modbus:serial.ac_hall_temperature.start=6<br>
modbus:serial.ac_hall_temperature.length=2<br>
modbus:serial.ac_hall_temperature.type=holding<br>
modbus:serial.ac_hall_temperature.valuetype=int16<br>
<br>
#<br>
modbus:serial.ac_hall_mode.connection=/dev/ttyACM0:57600:8:none:1:rtu<br>
modbus:serial.ac_hall_mode.id=1<br>
modbus:serial.ac_hall_mode.start=8<br>
modbus:serial.ac_hall_mode.length=1<br>
modbus:serial.ac_hall_mode.type=holding<br>
<br>
# <br>
modbus:serial.ac_hall_temp.connection=/dev/ttyACM0:57600:8:none:1:rtu<br>
modbus:serial.ac_hall_temp.id=1<br>
modbus:serial.ac_hall_temp.start=9<br>
modbus:serial.ac_hall_temp.length=4<br>
modbus:serial.ac_hall_temp.type=holding<br>
<br>
# <br>
modbus:serial.ac_hall_fan.connection=/dev/ttyACM0:57600:8:none:1:rtu<br>
modbus:serial.ac_hall_fan.id=1<br>
modbus:serial.ac_hall_fan.start=13<br>
modbus:serial.ac_hall_fan.length=5<br>
modbus:serial.ac_hall_fan.type=holding<br>
<br>
#<br>
modbus:serial.ac_hall_swing.connection=/dev/ttyACM0:57600:8:none:1:rtu<br>
modbus:serial.ac_hall_swing.id=1<br>
modbus:serial.ac_hall_swing.start=18<br>
modbus:serial.ac_hall_swing.length=2<br>
modbus:serial.ac_hall_swing.type=holding<br>
<br>
#<br>
modbus:serial.ac_hall_timer.connection=/dev/ttyACM0:57600:8:none:1:rtu<br>
modbus:serial.ac_hall_timer.id=1<br>
modbus:serial.ac_hall_timer.start=320<br>
modbus:serial.ac_hall_timer.length=2<br>
modbus:serial.ac_hall_timer.type=coil<br>
<br>
# <br>
modbus:serial.ac_hall_timer_time.connection=/dev/ttyACM0:57600:8:none:1:rtu<br>
modbus:serial.ac_hall_timer_time.id=1<br>
modbus:serial.ac_hall_timer_time.start=21<br>
modbus:serial.ac_hall_timer_time.length=4<br>
modbus:serial.ac_hall_timer_time.type=holding<br>
<br>
#  DS18B20<br>
modbus:serial.ac_hall_ds18b20.connection=/dev/ttyACM0:57600:8:none:1:rtu<br>
modbus:serial.ac_hall_ds18b20.id=1<br>
modbus:serial.ac_hall_ds18b20.start=25<br>
modbus:serial.ac_hall_ds18b20.length=2<br>
modbus:serial.ac_hall_ds18b20.type=holding<br>
</div></div><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Configuraciones de art√≠culos</font></font></b><div class="spoiler_text"><pre>Contact AC_HALL_STATE_POWER             "AC_HALL_STATE_POWER [MAP(air_cond.map):%s]"    (){modbus="ac_hall_state:0"}<font></font>
Contact AC_HALL_STATE_OXYGEN            "AC_HALL_STATE_OXYGEN [MAP(air_cond.map):%s]"   (){modbus="ac_hall_state:1"}<font></font>
Contact AC_HALL_STATE_ION               "AC_HALL_STATE_ION [MAP(air_cond.map):%s]"      (){modbus="ac_hall_state:2"}<font></font>
Contact AC_HALL_STATE_QUIET             "AC_HALL_STATE_QUIET [MAP(air_cond.map):%s]"    (){modbus="ac_hall_state:3"}<font></font>
Contact AC_HALL_STATE_TIMER             "[MAP(air_cond.map):%s]"                  (){modbus="ac_hall_state:4"}<font></font>
<font></font>
Switch  AC_HALL_CONTROL_POWER           ""                   &lt;climate&gt;       (){modbus="ac_hall_power:0"}<font></font>
Switch  AC_HALL_CONTROL_OXYGEN          " O2"                                  (){modbus="ac_hall_power:1"}<font></font>
Switch  AC_HALL_CONTROL_ION             ""                                     (){modbus="ac_hall_power:2"}<font></font>
Switch  AC_HALL_CONTROL_QUIET           " "                                   (){modbus="ac_hall_power:3"}<font></font>
<font></font>
Number  AC_HALL_RTC                     "RTC[%x]"                                       (){modbus="ac_hall_rtc:0"}<font></font>
String  AC_HALL_RTC_S                   " [%s]"         &lt;clock&gt;         ()<font></font>
<font></font>
Group   gAC_HALL_TEMPERATURE            "Living Room temp"<font></font>
<font></font>
Number  AC_HALL_TEMPERATURE_ENV         "[%d]"                                   (){modbus="ac_hall_temperature:0"}<font></font>
Number  AC_HALL_TEMPERATURE_NOZ         "[%d]"                                     (){modbus="ac_hall_temperature:1"}<font></font>
Number  AC_HALL_TEMPERATURE_ENVF        " [%.2f ¬∞C]"     &lt;temperature&gt;           (gAC_HALL_TEMPERATURE)<font></font>
Number  AC_HALL_TEMPERATURE_NOZF        " [%.2f ¬∞C]"       &lt;temperature&gt;           (gAC_HALL_TEMPERATURE)<font></font>
<font></font>
Number  AC_HALL_DS18B20_ENV             "ENV[%x]"                                       (){modbus="ac_hall_ds18b20:0"}<font></font>
Number  AC_HALL_DS18B20_NOZ             "NOZZLES[%x]"                                   (){modbus="ac_hall_ds18b20:1"}<font></font>
<font></font>
Number  AC_HALL_MODE                    ""                                              (){modbus="ac_hall_mode:0"}<font></font>
<font></font>
Number  AC_HALL_TEMP_AUTO               "[%d ¬∞C]"    &lt;temperature&gt;           (){modbus="ac_hall_temp:0"}<font></font>
Number  AC_HALL_TEMP_COOL               "[%d ¬∞C]"    &lt;temperature&gt;           (){modbus="ac_hall_temp:1"}<font></font>
Number  AC_HALL_TEMP_HEAT               "[%d ¬∞C]"    &lt;temperature&gt;           (){modbus="ac_hall_temp:2"}<font></font>
Number  AC_HALL_TEMP_DRY                "[%d ¬∞C]"    &lt;temperature&gt;           (){modbus="ac_hall_temp:3"}<font></font>
<font></font>
Number  AC_HALL_FAN_AUTO                "[%d]"                                  (){modbus="ac_hall_fan:0"}<font></font>
Number  AC_HALL_FAN_COOL                "[%d]"                                  (){modbus="ac_hall_fan:1"}<font></font>
Number  AC_HALL_FAN_HEAT                "[%d]"                                  (){modbus="ac_hall_fan:2"}<font></font>
Number  AC_HALL_FAN_DRY                 "[%d]"                                  (){modbus="ac_hall_fan:3"}<font></font>
Number  AC_HALL_FAN_SPEED               "[%d]"                                  (){modbus="ac_hall_fan:4"}<font></font>
<font></font>
Number  AC_HALL_SWINGV                  ""                                              (){modbus="ac_hall_swing:0"}<font></font>
Number  AC_HALL_SWINGH                  ""                                              (){modbus="ac_hall_swing:1"}<font></font>
<font></font>
Switch  AC_HALL_TIMER_ON                " "              &lt;clock&gt;         (){modbus="ac_hall_timer:0"}<font></font>
Switch  AC_HALL_TIMER_OFF               " "             &lt;clock&gt;         (){modbus="ac_hall_timer:1"}<font></font>
<font></font>
Number  AC_HALL_TIME_ON_HR              "[%02d]"                                     (){modbus="ac_hall_timer_time:0"}<font></font>
Number  AC_HALL_TIME_ON_MI              "[%02d]"                                  (){modbus="ac_hall_timer_time:1"}<font></font>
Number  AC_HALL_TIME_OFF_HR             "[%02d]"                                     (){modbus="ac_hall_timer_time:2"}<font></font>
Number  AC_HALL_TIME_OFF_MI             "[%02d]"                                  (){modbus="ac_hall_timer_time:3"}<font></font>
</pre><br>
</div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Las reglas se utilizan para convertir temperaturas enteras en temperaturas reales, as√≠ como para formatear el tiempo del controlador en la forma HH: MM.</font></font><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Configuraciones de reglas</font></font></b><div class="spoiler_text"><pre>import org.openhab.core.library.types.*<font></font>
import org.openhab.core.persistence.*<font></font>
import org.openhab.model.script.actions.*<font></font>
import java.io.File<font></font>
<font></font>
rule "Update AC_HALL ENV temp"<font></font>
        when<font></font>
                Item AC_HALL_TEMPERATURE_ENV received update<font></font>
        then<font></font>
                var Number T = AC_HALL_TEMPERATURE_ENV.state as DecimalType<font></font>
                var Number H = T/100<font></font>
                postUpdate(AC_HALL_TEMPERATURE_ENVF, H)<font></font>
end<font></font>
rule "Update AC_HALL NOZZLES temp"<font></font>
        when<font></font>
                Item AC_HALL_TEMPERATURE_NOZ received update<font></font>
        then<font></font>
                var Number T = AC_HALL_TEMPERATURE_NOZ.state as DecimalType<font></font>
                var Number H = T/100<font></font>
                postUpdate(AC_HALL_TEMPERATURE_NOZF, H)<font></font>
end<font></font>
rule "Update AC_HALL_RTC clock"<font></font>
        when<font></font>
                Item AC_HALL_RTC received update<font></font>
        then<font></font>
                var Number T = AC_HALL_RTC.state as DecimalType<font></font>
                var H = T.intValue / 256<font></font>
                var M = T.intValue % 256<font></font>
                var S = String::format("%02x:%02x",H,M)<font></font>
                postUpdate(AC_HALL_RTC_S, S)<font></font>
end<font></font>
</pre><br>
</div></div><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Configuraci√≥n de sitemaps</font></font></b><div class="spoiler_text"><pre>sitemap demo label="Demo House"{<font></font>
        Frame label="HOME"{<font></font>
                Text label=" " icon="ac_cond"{<font></font>
                        Frame label="" {<font></font>
                                Switch item= AC_HALL_CONTROL_POWER labelcolor=[AC_HALL_STATE_POWER==OPEN="blue"]<font></font>
                                Switch item= AC_HALL_CONTROL_OXYGEN labelcolor=[AC_HALL_STATE_OXYGEN==OPEN="blue"]<font></font>
                                Switch item= AC_HALL_CONTROL_ION labelcolor=[AC_HALL_STATE_ION==OPEN="blue"]<font></font>
                                Switch item= AC_HALL_CONTROL_QUIET labelcolor=[AC_HALL_STATE_QUIET==OPEN="blue"]<font></font>
                                Text item=AC_HALL_STATE_TIMER labelcolor=[AC_HALL_STATE_TIMER==OPEN="blue"] icon="clock-on"<font></font>
                                Text item=AC_HALL_RTC_S<font></font>
                                Text item=AC_HALL_TEMPERATURE_ENVF<font></font>
                                Text item=AC_HALL_TEMPERATURE_NOZF<font></font>
                        }<font></font>
<font></font>
                        Frame label=""{<font></font>
                                Selection item=AC_HALL_MODE label="" mappings=[1=AUTO, 2=COOL, 4=HEAT, 8=DRY, 16=FAN]<font></font>
                                Text item=AC_HALL_TEMP_AUTO visibility=[AC_HALL_MODE==1]<font></font>
                                Text item=AC_HALL_TEMP_COOL visibility=[AC_HALL_MODE==2]<font></font>
                                Text item=AC_HALL_TEMP_HEAT visibility=[AC_HALL_MODE==4]<font></font>
                                Text item=AC_HALL_TEMP_DRY visibility=[AC_HALL_MODE==8]<font></font>
<font></font>
                                Text item=AC_HALL_FAN_AUTO visibility=[AC_HALL_MODE==1]<font></font>
                                Text item=AC_HALL_FAN_COOL visibility=[AC_HALL_MODE==2]<font></font>
                                Text item=AC_HALL_FAN_HEAT visibility=[AC_HALL_MODE==4]<font></font>
                                Text item=AC_HALL_FAN_DRY visibility=[AC_HALL_MODE==8]<font></font>
                                Text item=AC_HALL_FAN_SPEED visibility=[AC_HALL_MODE==16]<font></font>
<font></font>
                                Selection item=AC_HALL_SWINGV label="" mappings=[1=AUTO, 2="0¬∞", 4="15¬∞", 8="30¬∞", 16="45¬∞", 32="60¬∞"]<font></font>
                                Selection item=AC_HALL_SWINGH label="" mappings=[1=AUTO, 4="/   /", 8="/   |", 2="|   |", 16="|   \\", 32="\\   \\"]<font></font>
<font></font>
                                Text label="" icon="settings"{<font></font>
                                        Frame label="AUTO"{<font></font>
                                                Setpoint item=AC_HALL_TEMP_AUTO minValue=16 maxValue=30 step=1<font></font>
                                                Switch   item=AC_HALL_FAN_AUTO mappings=[0=AUTO, 1="1", 2="2", 3="3", 4="4", 5="5"]<font></font>
                                        }<font></font>
                                        Frame label="COOL"{<font></font>
                                                Setpoint item=AC_HALL_TEMP_COOL minValue=16 maxValue=30 step=1<font></font>
                                                Switch   item=AC_HALL_FAN_COOL mappings=[0=AUTO, 1="1", 2="2", 3="3", 4="4", 5="5"]<font></font>
                                        }<font></font>
                                        Frame label="HEAT"{<font></font>
                                                Setpoint item=AC_HALL_TEMP_HEAT minValue=16 maxValue=30 step=1<font></font>
                                                Switch   item=AC_HALL_FAN_HEAT mappings=[0=AUTO, 1="1", 2="2", 3="3", 4="4", 5="5"]<font></font>
                                        }<font></font>
                                        Frame label="DRY"{<font></font>
                                                Setpoint item=AC_HALL_TEMP_DRY minValue=16 maxValue=30 step=1<font></font>
                                                Switch   item=AC_HALL_FAN_DRY mappings=[0=AUTO, 1="1", 2="2", 3="3", 4="4", 5="5"]<font></font>
                                        }<font></font>
                                        Frame label="FAN"{<font></font>
                                                Switch item=AC_HALL_FAN_SPEED mappings=[0=AUTO, 1="1", 2="2", 3="3", 4="4", 5="5"]<font></font>
                                        }<font></font>
                                        Frame label=""{<font></font>
                                                Text item=AC_HALL_DS18B20_ENV<font></font>
                                                Text item=AC_HALL_DS18B20_NOZ<font></font>
                                        }<font></font>
                                }<font></font>
                        }<font></font>
                        Frame label="" {<font></font>
                                Switch item= AC_HALL_TIMER_ON labelcolor=[AC_HALL_STATE_TIMER==OPEN="blue"]<font></font>
                                Setpoint item=AC_HALL_TIME_ON_HR minValue=0 maxValue=23 step=1<font></font>
                                Setpoint item=AC_HALL_TIME_ON_MI minValue=0 maxValue=50 step=5<font></font>
<font></font>
                                Switch item= AC_HALL_TIMER_OFF labelcolor=[AC_HALL_STATE_TIMER==OPEN="blue"]<font></font>
                                Setpoint item=AC_HALL_TIME_OFF_HR minValue=0 maxValue=23 step=1<font></font>
                                Setpoint item=AC_HALL_TIME_OFF_MI minValue=0 maxValue=50 step=5<font></font>
                        }<font></font>
                }<font></font>
                Text item=AC_HALL_RTC_S<font></font>
                Text item=AC_HALL_TEMPERATURE_ENVF{<font></font>
                        Frame label=" "{<font></font>
                                Chart item=gAC_HALL_TEMPERATURE period=h refresh=60000<font></font>
                        }<font></font>
                        Frame label=" 4 " {<font></font>
                                Chart item=gAC_HALL_TEMPERATURE period=4h refresh=600000<font></font>
                        }<font></font>
                }<font></font>
        }<font></font>
}<font></font>
</pre><br>
</div></div><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El resultado se ve as√≠ a trav√©s de un navegador:</font></font><br>
<img align="left" src="https://habrastorage.org/files/5c0/129/0f3/5c01290f365b47399e9b16123c21f6fa.png"><img align="left" src="https://habrastorage.org/files/634/45b/94b/63445b94b4ab47349482b85667313e10.png"><img align="left" src="https://habrastorage.org/files/09c/8cb/8ff/09c8cb8ffb8240349ce57e8c7ccc6629.png"><br clear="all">
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Conclusi√≥n</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Estoy satisfecho con el resultado como un elefante. El control de aire acondicionado ahora est√° disponible para m√≠ donde haya Internet m√≥vil o WiFI. Utilizando un cliente VPN en un tel√©fono inteligente, OpenHAB en mi servidor dom√©stico se vuelve accesible para m√≠ tanto a trav√©s de un navegador como a trav√©s de una aplicaci√≥n m√≥vil. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La soluci√≥n inal√°mbrica permiti√≥ integrar estrechamente el controlador con el aire acondicionado. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La presencia de retroalimentaci√≥n da confianza en que el comando enviado fue recibido por el aire acondicionado, y los sensores de temperatura lo demuestran claramente: despu√©s de unos segundos, puede observar un cambio en la lectura de temperatura en la salida del aire acondicionado. Bueno, despu√©s de unos minutos, y la temperatura ambiente. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Fue interesante observar el perfil del aire acondicionado al acercarse a las condiciones dadas.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Sin lugar a dudas, este no ser√° el √∫nico controlador inal√°mbrico que planeo usar. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Hay planes para usar el receptor IR del acondicionador de aire para leer los comandos del control remoto nativo para actualizar la configuraci√≥n en el controlador. </font><font style="vertical-align: inherit;">Adem√°s, el receptor IR ya est√° conectado a trav√©s de un optoacoplador al controlador. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Lea hasta el final un agradecimiento especial!</font></font><br>
<br>
<h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Referencias</font></font></h4><br>
<ol>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Biblioteca Arduino ModbusRtu </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Modbus-Master-Slave-for-Arduino</font></font></a></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Biblioteca Arduino ModbusRtuRF24 </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Modbus-over-RF24 Network-for-Arduino</font></font></a></li>
</ol></div>
      
    </div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/es384243/">https://habr.com/ru/post/es384243/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../es384229/index.html">Despu√©s de leer aplicar. 25 libros para el desarrollador del juego</a></li>
<li><a href="../es384231/index.html">Si nadie necesita uranio natural, ¬øc√≥mo enriquecerse?</a></li>
<li><a href="../es384235/index.html">Los UAV abrir√°n el cielo ruso para 2020</a></li>
<li><a href="../es384239/index.html">Revisi√≥n de Sphero BB-8, un robot de Star Wars</a></li>
<li><a href="../es384241/index.html">Emercoin: criptomoneda y una clave digital en una</a></li>
<li><a href="../es384247/index.html">Opiniones: Twitter comparte software para probar</a></li>
<li><a href="../es384249/index.html">Una selecci√≥n de dispositivos √∫tiles: 5 gadgets que son √∫tiles en la oficina</a></li>
<li><a href="../es384251/index.html">Robot y hombre. Del contenido a la forma</a></li>
<li><a href="../es384253/index.html">Giraffe Neural Network aprendi√≥ a jugar ajedrez al nivel de un maestro internacional de la FIDE en 72 horas</a></li>
<li><a href="../es384257/index.html">C√≥mo los restaurantes crean sitios: 4 soluciones de dise√±o</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>