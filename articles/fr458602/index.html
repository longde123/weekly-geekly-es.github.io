<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üôçüèø üë®üèæ‚Äçü§ù‚Äçüë®üèΩ üîû Comment nous avons perc√© le grand pare-feu chinois (partie 1) üï• üåù ‚Ü©Ô∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Bonjour √† tous! 


 En contact Nikita est un ing√©nieur syst√®me de SEMrush . Aujourd'hui, je vais vous expliquer comment nous avons fait face √† la t√¢ch...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Comment nous avons perc√© le grand pare-feu chinois (partie 1)</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/semrush/blog/458602/"><p>  Bonjour √† tous! </p><br><p>  En contact Nikita est un ing√©nieur syst√®me de <strong>SEMrush</strong> .  Aujourd'hui, je vais vous expliquer comment nous avons fait face √† la t√¢che d'assurer la stabilit√© de notre service semrush.com en Chine et quels probl√®mes nous avons rencontr√©s lors de sa mise en ≈ìuvre (compte tenu de l'emplacement de notre centre de donn√©es sur la c√¥te est des √âtats-Unis). </p><br><p>  Ce sera une grande histoire, divis√©e en plusieurs articles.  Je vais vous raconter comment tout cela s‚Äôest pass√© avec nous: d‚Äôun service totalement inutilis√© de la Chine √† la performance du service au niveau de sa version am√©ricaine pour les Am√©ricains.  Je promets que ce sera int√©ressant et utile.  Alors allons-y. </p><br><img src="https://habrastorage.org/webt/cv/6s/sv/cv6ssvuv-od31op6cjnadtw6xsy.png"><br><h2 id="problemy-kitayskogo-interneta">  Probl√®mes d'Internet chinois </h2><br><p>  M√™me la personne la plus √©loign√©e des sp√©cificit√©s de l'administration r√©seau a au moins une fois entendu parler du <strong>grand pare-feu chinois</strong> .  Euh, √ßa a l'air cool, hein?  Mais ce que c'est, comment cela fonctionne r√©ellement est une question assez compliqu√©e.  Sur Internet, vous pouvez trouver de nombreux articles √† ce sujet, mais d'un point de vue technique, l'appareil de ce pare-feu n'est d√©crit nulle part.  Ce qui n'est cependant pas surprenant.  J'avoue tout de suite que, sur la base des r√©sultats de l'ann√©e de travail, je ne peux pas dire exactement comment cela fonctionne, mais je peux parler de mes commentaires et de mes conclusions pratiques.  Et nous commencerons par des rumeurs sur ce pare-feu. </p><a name="habracut"></a><br><p>  Il y a beaucoup de rumeurs sur ce pare-feu.  Rassemblons les principaux et les plus int√©ressants d'entre eux dans une seule liste: </p><br><ul><li>  Google, Facebook, Twitter et d'autres services similaires sont bloqu√©s et ne fonctionnent pas en Chine. </li><li>  Tout trafic allant au-del√† de la Chine et vers la Chine est analys√© et limit√© par l'apprentissage automatique (en cas de trafic suspect), ce qui le ralentit consid√©rablement (trafic) passant par la fronti√®re. </li><li>  Les agences de renseignement chinois piratent tout trafic crypt√© qui passe par leur pare-feu. </li><li>  Les tunnels VPN, les tunnels IPSEC sont instables, tombent et sont constamment bloqu√©s. </li><li>  Plus le cryptage est simple, plus la phrase de passe utilis√©e pour l'authentification / chiffrement du trafic est simple, plus il passe rapidement le pare-feu chinois. </li></ul><br><p>  Voici ce que nous avons r√©ussi √† d√©couvrir sur ces rumeurs: </p><br><ul><li>  Google, Facebook, Twitter et d'autres services similaires sont vraiment bloqu√©s (votre KO), mais de nombreux domaines techniques de Google, par exemple, ne sont pas interdits et fonctionnent (le m√™me gstatic.com).  Cela conduit √† la conclusion: ne supprimez pas imprudemment toutes les ressources Google et autres qui semblent √™tre bloqu√©es, apparemment bloqu√©es. </li><li>  Tout trafic passant par la fronti√®re ajoute vraiment un s√©rieux retard √† son temps.  Regardez les deux r√©sultats.  Un site, une page, simple get <em>curl</em> .  La premi√®re mesure de la Chine elle-m√™me (la belle ville de Shenzhen).  Le second s'est fig√© √† l'ext√©rieur de Hong Kong (il a la souverainet√©, et il n'y a pas de pare-feu entre lui et le monde).  La distance entre les villes en ligne droite est d'environ 30 √† 40 km. </li></ul><br><pre><code class="bash hljs">nikita@china-shenzhen:~<span class="hljs-comment"><span class="hljs-comment"># curl -o /dev/null -w@curl_time "https://www.semrush.com/info/ebay.com" % Total % Received % Xferd Average Speed Time Time Time Current Dload Upload Total Spent Left Speed 100 381k 0 381k 0 0 71824 0 --:--:-- 0:00:05 --:--:-- 82832 time_namelookup: 0.004500 time_connect: 0.169342 time_appconnect: 0.723189 time_pretransfer: 0.723499 time_redirect: 0.000000 time_starttransfer: 1.532912 ---------- time_total: 5.443407 ---------- size_download: 390968 Bytes speed_download: 71824.000B/s nikita@china-hongkong:~# curl -o /dev/null -w@curl_time "https://www.semrush.com/info/ebay.com" % Total % Received % Xferd Average Speed Time Time Time Current Dload Upload Total Spent Left Speed 100 319k 0 319k 0 0 2555k 0 --:--:-- --:--:-- --:--:-- 2573k time_namelookup: 0.029366 time_connect: 0.030742 time_appconnect: 0.047310 time_pretransfer: 0.047388 time_redirect: 0.000000 time_starttransfer: 0.120793 ---------- time_total: 0.124871 ---------- size_download: 326755 Bytes speed_download: 2616740.000B/s</span></span></code> </pre> <br><p>  Faites attention √† <strong>time_connect</strong> .  Et en g√©n√©ral, vous voyez le r√©sultat: le pare-feu ajoute 4 secondes suppl√©mentaires, ce qui est monstrueusement long. </p><br><ul><li>  Les VPN et les tunnels IPSEC tombent souvent.  J'en parlerai un peu plus tard et plus en d√©tail.  Les serveurs VPN utilis√©s par les utilisateurs sont bloqu√©s au fil du temps (g√©n√©ralement dans la journ√©e suivant le d√©but de l'utilisation). </li><li>  Des personnes vivant en Chine pensent que plus le cryptage du trafic est facile, plus il passe rapidement √† la fronti√®re, car il est facile de comprendre qu'il n'y a rien d'ill√©gal.  Et tout comme le trafic ¬´propre¬ª obtient plus de bande passante et de vitesse, et le trafic ¬´sale¬ª, qui ne fait rien, obtient un passage plus lent au contraire.  Pour un exemple, j'apporterai curl √† <em>ifconfig.co en</em> utilisant les protocoles HTTPS et HTTP. </li></ul><br><pre> <code class="bash hljs">curl -o /dev/null -w@curl_time <span class="hljs-string"><span class="hljs-string">"https://ifconfig.co/"</span></span> % Total % Received % Xferd Average Speed Time Time Time Current Dload Upload Total Spent Left Speed 100 13 100 13 0 0 2 0 0:00:06 0:00:05 0:00:01 3 time_namelookup: 0.004305 time_connect: 0.397465 time_appconnect: 5.149305 time_pretransfer: 5.149393 time_redirect: 0.000000 time_starttransfer: 5.568847 ---------- time_total: 5.568893 ---------- size_download: 13 Bytes speed_download: 2.000B/s curl -o /dev/null -w@curl_time <span class="hljs-string"><span class="hljs-string">"http://ifconfig.co/"</span></span> % Total % Received % Xferd Average Speed Time Time Time Current Dload Upload Total Spent Left Speed 100 13 100 13 0 0 28 0 --:--:-- --:--:-- --:--:-- 28 time_namelookup: 0.004282 time_connect: 0.212457 time_appconnect: 0.000000 time_pretransfer: 0.212484 time_redirect: 0.000000 time_starttransfer: 0.450565 ---------- time_total: 0.450620 ---------- size_download: 13 Bytes speed_download: 28.000B/s</code> </pre> <br><p>  La diff√©rence est de 5 secondes pour un temps de chargement total de 13 octets.  En effectuant ce test plusieurs fois, vous pouvez voir que GET sur HTTP se termine en g√©n√©ral en m√™me temps √† chaque fois, alors qu'en utilisant HTTPS le site r√©pond parfois en 3, 5, 10 et m√™me 17 secondes.  Des erreurs SSL se produisent parfois: </p><br><p> <code>Unknown SSL protocol error in connection to ifconfig.co:443.</code> </p> <br><p>  Donc ce que nous avons: </p><br><ul><li>  Les probl√®mes cr√©√©s par le pare-feu chinois d√©crit ci-dessus. </li><li>  Les pings vers les ressources externes et les tunnels int√©rieurs disparaissent p√©riodiquement. </li><li>  La latence entre deux points est en constante √©volution, et souvent elle est tout simplement impr√©visible.  En connectant diff√©rentes villes / r√©gions, vous vous attendez √† ce qu'en fonction de la situation g√©ographique des r√©gions, le retard soit moindre et vous obtenez exactement la situation inverse. </li><li>  Les canaux Internet et de communication sont rapides ou lents.  Il y a une l√©g√®re d√©pendance √† l'heure et au jour de la semaine, mais pas toujours. </li><li>  Les requ√™tes DNS vers le monde ext√©rieur depuis la Chine d√©passent parfois le d√©lai d'attente autoris√©. </li></ul><br><p>  L'image se profile simplement ¬´excellente¬ª. </p><br><p>  Le centre de donn√©es, comme je l'ai d√©j√† dit, se trouve √† l'est des √âtats-Unis, et l'ensemble du SEMrush se compose de dizaines de produits, backends, frontends, bases de donn√©es interconnect√©s, et tout cela dans le centre de donn√©es et dans les nuages.  En tant qu'√©quipe d'administrateurs syst√®me, nous avons √©t√© charg√©s d'un petit effort pour commencer rapidement √† travailler en Chine. </p><br><p>  Nous avons d√ª r√©pondre √† une question importante: pouvons-nous nous d√©brouiller avec un peu de sang et r√©soudre tous les probl√®mes li√©s √† Internet chinois et au pare-feu au niveau du r√©seau / cloud / serveur? </p><br><p>  Nous avons commenc√© par obtenir une <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">licence <strong>ICP</strong></a> . </p><br><h2 id="icp-licenziya">  Licence ICP </h2><br><p>  Afin de pouvoir placer votre service en Chine (Chine continentale) et effectuer des tests, vous devez d'abord obtenir une licence de domaine ICP. </p><br><p>  Si le trafic utilisateur de votre site est interrompu en Chine continentale, et si votre domaine n'a pas de licence ICP, votre trafic sera bloqu√© c√¥t√© fournisseur / h√©bergement.  Fait int√©ressant, un fournisseur sp√©cifique s'int√®gre dans la licence ICP, que ce soit Cloudflare ou Alibaba Cloud.  Par cons√©quent, si vous avez re√ßu une licence ICP pour Cloudflare et h√©berg√© votre site avec eux, vous ne pourrez pas passer ¬´en toute transparence¬ª √† Alibaba Cloud.  Il sera n√©cessaire d'ajouter un h√©bergement suppl√©mentaire √† cette licence. </p><br><p>  Ayant re√ßu une licence de domaine ICP, nous avons pu trouver et mettre en ≈ìuvre des id√©es et des solutions techniques sp√©cifiques. </p><br><h2 id="testirovanie-resheniy">  Solutions de test </h2><br><p>  Mais avant de cr√©er directement les options de mise en sc√®ne, de tourner les boutons, d'optimiser le site et sa vitesse, vous devez choisir un outil pour le tester pour voir ce que nos actions am√©liorent ou aggravent le travail du site. </p><br><p>  Notre outil de test devait r√©pondre √† deux exigences principales: </p><br><ul><li>  il devrait pouvoir effectuer des tests en Chine, </li><li>  Il doit avoir des tests de navigateur. </li></ul><br><p>  Nous avons donc trouv√© le point d' <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">arr√™t</a> !  Ils ont une excellente couverture avec des points de test dans le monde entier.  En Chine, gr√¢ce √† cet outil, vous pouvez √©galement ex√©cuter des tests dans 100 500 provinces.  Dans chacun, plusieurs fournisseurs diff√©rents + la possibilit√© de faire des tests <strong>Backbone</strong> (quelque chose comme une machine <strong>virtuelle</strong> dans un centre de donn√©es) et des tests <strong>Lastmile</strong> (aussi pr√®s que possible des conditions de l'utilisateur, alias poste de travail).  Ce dernier type de test est plus cher. </p><br><p>  Apr√®s avoir conclu un contrat d'un an (vous ne pouvez pas faire moins), nous avons commenc√© √† √©tudier l'outil.  Franchement, nous avons √©t√© agr√©ablement surpris par sa fonctionnalit√©.  Vous pouvez ex√©cuter: </p><br><ul><li>  Tests DNS </li><li>  Tests Web (navigateur, simple GET / POST, √©mulation d'un client mobile, etc.), </li><li>  Contr√¥les transactionnels (par exemple, connexion), </li><li>  Tests API </li><li>  Ping, traceroute, NTP, etc. </li></ul><br><p>  Vous ne pouvez pas tout r√©pertorier.  Et surtout, chaque test peut √™tre assez bien personnalis√© en ajoutant un tas d'en-t√™tes et d'autres param√®tres.  Le r√©sultat est une √©norme quantit√© d'informations qui d√©crit pleinement votre test.  Si nous parlons des plus int√©ressants pour nous (tests de navigateur), le r√©sultat comprend: </p><br><ul><li>  Se connecter, attendre, charger, SSL, heure DNS, </li><li>  TTFB, TTLB, Document termin√©, Temps de rendu, Charge DOM, </li><li>  R√©ponse (quelque chose proche de Time To First Byte), R√©ponse de page Web (quelque chose proche de Time To Last Byte), </li><li>  N'importe quel centile, moyenne, temps m√©dian </li><li>  Etc. </li></ul><br><p>  En cons√©quence, toutes ces m√©triques vous aident √† voir les changements et √† comprendre s'ils se sont am√©lior√©s.  Nous avons principalement examin√© <strong>Response, Webpage Response, Median, 75 et 95 Percentiles</strong> . </p><br><p>  Une question importante qui se pose depuis le tout d√©but: est- <strong>il possible de croire Catchpoint</strong> ?  Cet outil refl√®te-t-il la vitesse r√©elle de chargement du site en Chine √† partir de diff√©rentes villes ou s'agit-il simplement d'une sorte de test dans le vide qui n'a rien √† voir avec une v√©ritable exp√©rience utilisateur? <br>  C'est un gros probl√®me, car √™tre en Russie est presque impossible de savoir de mani√®re fiable comment fonctionne le site chinois.  En faisant socks-proxy via une machine virtuelle, vous obtenez un chargement de site Web en quelques minutes √† la fin, ce qui est tout simplement inacceptable pour les tests, donc les boucles et les GET simples √† partir de la console avec mesure du temps restent la seule option pour les tests manuels.  Cela aide, car ce test refl√®te la vitesse de la solution r√©seau et s'il y a des tests de navigateur, c'est tr√®s bien. </p><br><p>  Plus tard, nous sommes all√©s en Chine nous-m√™mes et nous sommes assur√©s que <strong>Catchpoint peut √™tre digne de confiance, il refl√®te assez pr√©cis√©ment les vrais indicateurs de vitesse.</strong> </p><br><h2 id="cloudflare-china-network">  R√©seau Cloudflare Chine </h2><br><p>  Comme nous utilisons avec succ√®s Cloudflare pour le domaine principal semrush.com, nous avons d√©cid√© d'essayer imm√©diatement leur fonctionnalit√© appel√©e <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">China Network</a> .  Cette option est activ√©e uniquement pour les sites Enterprise sur demande et moyennant des frais.  Il est √©galement disponible uniquement pour les sites qui ont la licence ICP appropri√©e, dans laquelle Cloudflare est sp√©cifi√© comme fournisseur.  Apr√®s son inclusion, le ¬´CDN chinois¬ª de Cloudflare devient disponible pour le site - le trafic en provenance des r√©gions chinoises arrive dans le prochain PoP (Points of Presence) CF, puis il est livr√© √† l'origine via ses r√©seaux ou r√©seaux de fournisseurs / partenaires. </p><br><p>  Le sch√©ma de ce banc d'essai est pr√©sent√© ci-dessous. </p><br><img src="https://habrastorage.org/webt/zk/hw/um/zkhwumkneyyxkij6gdffhzcl6qw.png"><br><p>  C'est une excellente option pour nous.  Il s'av√®re que le deuxi√®me domaine sera √©galement pour CF, ce qui n'ajoute pas le nombre de solutions utilis√©es dans l'entreprise et ne complique pratiquement pas l'infrastructure. </p><br><p>  Nous avons ex√©cut√© les tests du navigateur, et c'est ce qui s'est produit: </p><br><img src="https://habrastorage.org/webt/cs/wo/hp/cswohpvoexjj3nanyzxloxk2poo.png"><br><p>  Les diamants rouges sont des fichiers de test.  Les fichiers ci-dessous sont des erreurs DNS (r√©soudre le d√©lai).  Les √©checs ci-dessus sont des d√©lais d'attente. </p><br><p>  <em>Disponibilit√©: 86,6</em> <em><br></em>  <em>M√©diane: 18 s</em> <em><br></em>  <em>75 centile: 29,3 s</em> <em><br></em>  <em>95 centile: 60s</em> </p><br><p>  La m√©diane, apr√®s avoir <em>supprim√© le</em> t√©l√©chargement de <em>reCaptcha</em> (un service <em>Google</em> bloqu√© en Chine), est pass√©e de 28 √† 18 secondes.  Mais quand m√™me, ce sont de terribles indicateurs, √©tant donn√© que le m√™me test pour semrush.com (aux USA) a donn√© moins de 10 secondes pour 95% des utilisateurs (aux USA) √† la m√™me page (statique + dynamique). </p><br><p>  Dans chaque test, vous pouvez aller voir <em>Waterfall</em> et d'autres param√®tres plus d√©taill√©s.  Nous avons commenc√© √† enqu√™ter sur les causes des erreurs, et si pour les d√©lais d'attente tout est moins ou moins clair: Internet en Chine "se d√©place vers le bas, puis s'√©loigne", √† cause de cela la vitesse de connexion et de chargement des ressources de l'√©tranger est instable et in√©gale, alors les erreurs DNS nous ont beaucoup surpris .  Nous avons constat√© que les PoPs de Cloudflare sont en effet situ√©s en Chine, l'adresse du site se r√©sout en une seule IP anycast, mais les serveurs DNS sont utilis√©s par les √âtats-Unis, c'est pourquoi les requ√™tes DNS sont oblig√©es de passer par la fronti√®re, donc parfois elles √©chouent. </p><br><p>  Apr√®s avoir clarifi√© cette question avec CF, il s'est av√©r√© <strong>qu'ils n'ont pas leurs propres serveurs DNS en Chine</strong> , et on ne sait toujours pas quand ce sera le cas. </p><br><p>  Par cons√©quent, nous avons d√©cid√© de tester uniquement DNS Cloudflare et chang√© le m√©canisme Cloudflare pour notre site en mode ¬´ <strong>DNS uniquement</strong> ¬ª.  C'est un tel mode lorsque Cloudflare ne proc√®de pas √† un trafic proxy via lui-m√™me, ce qui signifie qu'il ne fournit pas de protection DDoS, CDN et d'autres fonctionnalit√©s, et fonctionne en mode de serveur DNS normal. </p><br><p>  Ce support est repr√©sent√© sch√©matiquement dans la figure suivante.  La figure prend en compte la nouvelle connaissance que le serveur DNS Cloudflare se trouve derri√®re le pare-feu. </p><br><img src="https://habrastorage.org/webt/ac/w0/r7/acw0r7fgqahq9w2kckq6-myxjky.png"><br><p>  Chez Catchpoint, nous avons ex√©cut√© de simples tests GET (sans navigateur) qui ont montr√© de nombreux √©checs.  La raison en √©tait toutes les m√™mes erreurs DNS. </p><br><img src="https://habrastorage.org/webt/_w/3c/wu/_w3cwuxv8j9tdeuvp20jblktqoi.png"><br><p>  Nous avons commenc√© √† d√©boguer ces erreurs √† l'aide de <em>dig</em> et avons constat√© que l'adresse est d√©termin√©e correctement lors de la premi√®re demande, et sur demande r√©p√©t√©e nous obtenons <em>SERVFAIL</em> et <em>non trouv√© √†</em> chaque fois.  Qu'est-ce que c'est tout d'un coup? </p><br><pre> <code class="bash hljs">root@iZwz97n2wgbp61qucbfrjsZ:~<span class="hljs-comment"><span class="hljs-comment"># host semrushchina.cn semrushchina.cn has address 220.170.186.192 Host semrushchina.cn not found: 2(SERVFAIL) root@iZwz97n2wgbp61qucbfrjsZ:~# host semrushchina.cn semrushchina.cn has address 220.170.186.192 Host semrushchina.cn not found: 2(SERVFAIL) root@iZwz97n2wgbp61qucbfrjsZ:~# host semrushchina.cn semrushchina.cn has address 220.170.186.192 Host semrushchina.cn not found: 2(SERVFAIL) root@iZwz97n2wgbp61qucbfrjsZ:~# host semrushchina.cn semrushchina.cn has address 220.170.186.192 Host semrushchina.cn not found: 2(SERVFAIL)</span></span></code> </pre> <br><p>  Lorsque vous demandez directement des serveurs Cloudflare NS, il n'y a pas de telles erreurs: </p><br><pre> <code class="bash hljs">root@iZwz97n2wgbp61qucbfrjsZ:~<span class="hljs-comment"><span class="hljs-comment"># for i in `seq 1 2`; do host semrushchina.cn ray.ns.cloudflare.com.; done Using domain server: Name: ray.ns.cloudflare.com. Address: 173.245.59.138#53 Aliases: semrushchina.cn has address 220.170.186.192 semrushchina.cn has address 220.170.186.192 Using domain server: Name: ray.ns.cloudflare.com. Address: 173.245.59.138#53 Aliases: semrushchina.cn has address 220.170.186.192 semrushchina.cn has address 220.170.186.192</span></span></code> </pre> <br><p>  Cela signifie que le probl√®me est du c√¥t√© du serveur DNS ¬´local¬ª ou du serveur fournisseur. <br>  Une enqu√™te plus approfondie a montr√© que nous obtenons <em>SERVFAIL</em> sur la r√©solution du dossier <em>AAAA</em> . </p><br><p>  Il s'est av√©r√© que lorsque Cloudflare a demand√© un enregistrement <em>AAAA</em> qui n'√©tait pas dans le domaine, Cloudflare a r√©pondu avec un enregistrement <em>A</em> , qui est une erreur et une incompatibilit√© RFC.  √Ä cause de cela, le r√©solveur local ( <em>xxxx</em> ) n'aimait pas cela, et il a r√©pondu √† <em>SERVFAIL</em> .  Dans le journal ci-dessous, ce comportement est clairement visible: </p><br><pre> <code class="bash hljs">root@iZwz97n2wgbp61qucbfrjsZ:~<span class="hljs-comment"><span class="hljs-comment"># dig -t AAAA semrushchina.cn @xxxx ; &lt;&lt;&gt;&gt; DiG 9.10.3-P4-Ubuntu &lt;&lt;&gt;&gt; -t AAAA semrushchina.cn @xxxx ;; global options: +cmd ;; Got answer: ;; -&gt;&gt;HEADER&lt;&lt;- opcode: QUERY, status: SERVFAIL, id: 55467 ;; flags: qr rd ra; QUERY: 1, ANSWER: 0, AUTHORITY: 0, ADDITIONAL: 1 ;; OPT PSEUDOSECTION: ; EDNS: version: 0, flags:; udp: 4096 ;; QUESTION SECTION: ;semrushchina.cn. IN AAAA ;; Query time: 334 msec ;; SERVER: xxxx#53(xxxx) ;; WHEN: Tue Aug 14 23:38:50 CST 2018 ;; MSG SIZE rcvd: 44 root@iZwz97n2wgbp61qucbfrjsZ:~# dig -t AAAA semrushchina.cn @dana.ns.cloudflare.com. ; &lt;&lt;&gt;&gt; DiG 9.10.3-P4-Ubuntu &lt;&lt;&gt;&gt; -t AAAA semrushchina.cn @dana.ns.cloudflare.com. ;; global options: +cmd ;; Got answer: ;; -&gt;&gt;HEADER&lt;&lt;- opcode: QUERY, status: NOERROR, id: 63944 ;; flags: qr aa rd; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 1 ;; WARNING: recursion requested but not available ;; OPT PSEUDOSECTION: ; EDNS: version: 0, flags:; udp: 512 ;; QUESTION SECTION: ;semrushchina.cn. IN AAAA ;; ANSWER SECTION: semrushchina.cn. 300 IN A 220.170.186.192 ;; Query time: 185 msec ;; SERVER: 173.245.58.105#53(173.245.58.105) ;; WHEN: Tue Aug 14 23:43:03 CST 2018 ;; MSG SIZE rcvd: 60</span></span></code> </pre><br><p>  Nous avons envoy√© un rapport de bogue Cloudflare, et ils l'ont corrig√© apr√®s un certain temps.  Cela s'est av√©r√© int√©ressant: √† l'heure actuelle, il n'y a toujours pas de support IPv6 en Chine, donc Cloudflare n'a pas pu donner son adresse IPv6 en r√©ponse √† une demande d'enregistrement <em>AAAA</em> .  Au final, tout a √©t√© d√©cid√© pour que China Cloudflare commence √† r√©pondre √† <em>NODATA</em> √† de telles demandes. </p><br><p>  Ainsi, les erreurs DNS dans les tests Catchpoint ont fortement diminu√©, mais pas jusqu'√† la fin.  Les d√©lais d'attente n'ont pas non plus disparu: </p><br><img src="https://habrastorage.org/webt/u5/i7/fj/u5i7fjgo6pb9fl4mddq27uhk9lo.png"><br><p>  Et nous avons commenc√© √† chercher une autre solution. </p><br><p>  Dans la partie suivante, je dirai comment nous avons test√© le <strong>cloud</strong> chinois d' <strong>Alibaba</strong> , comment, avec l'aide d'un peu "magique" Nginx, nous avons pu cr√©er rapidement des solutions PoC (Proof of Concept), comment nous avons cr√©√© des solutions multi-cloud, dont l'une a finalement beaucoup aid√© acc√©l√©rer le service depuis la Chine. </p><br><p>  <strong>Restez √† l'√©coute!</strong> </p><br><h3 id="vse-chasti">  Toutes les pi√®ces </h3><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">2e partie</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">3e partie</a> </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr458602/">https://habr.com/ru/post/fr458602/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr458592/index.html">De la latence Ceph √©lev√©e au patch du noyau avec eBPF / BCC</a></li>
<li><a href="../fr458594/index.html">N'oubliez pas d'augmenter les chances de r√©ponse au client en utilisant une demande r√©p√©t√©e dans l'√©quilibrage L7</a></li>
<li><a href="../fr458596/index.html">Petty Little Joy # 6: OpenAI Gym - Jouez √† des jeux et contr√¥lez des robots</a></li>
<li><a href="../fr458598/index.html">Reconnaissance des sources lumineuses sur les cartes de l'environnement</a></li>
<li><a href="../fr458600/index.html">Que sont les v√©los √©lectriques (examen de groupe en deux parties de cinq mod√®les de deux fabricants), partie 1</a></li>
<li><a href="../fr458604/index.html">Pourquoi les deux plus grands fabricants d'√©lectronique ont uni leurs forces dans un nouveau projet de GPU</a></li>
<li><a href="../fr458606/index.html">Ex√©cutez OpenVPN dans Docker en 2 secondes</a></li>
<li><a href="../fr458608/index.html">Outils de d√©veloppement Node.js File d'attente des travaux</a></li>
<li><a href="../fr458612/index.html">Cosmos. 7 ans</a></li>
<li><a href="../fr458614/index.html">Cr√©ation d'un hook Reactive UsePosition () pour obtenir et suivre les coordonn√©es du navigateur</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>