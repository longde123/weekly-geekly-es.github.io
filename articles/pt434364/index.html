<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üî† üëéüèº üêª Suporte da fila do Hangfire üï° ü§Ωüèº üÜô</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="O Hangfire √© uma biblioteca para .net (core), que permite a execu√ß√£o ass√≠ncrona de algum c√≥digo no princ√≠pio de "acionar e esquecer". Um exemplo desse...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Suporte da fila do Hangfire</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/434364/"><p>  O Hangfire √© uma biblioteca para .net (core), que permite a execu√ß√£o ass√≠ncrona de algum c√≥digo no princ√≠pio de "acionar e esquecer".  Um exemplo desse c√≥digo pode ser enviar email, processamento de v√≠deo, sincroniza√ß√£o com outro sistema etc.  Al√©m de "disparar e esquecer", h√° suporte para tarefas adiadas, bem como tarefas agendadas no formato Cron. </p><br><p>  Atualmente, existem muitas dessas bibliotecas.  Alguns dos benef√≠cios do Hangfire s√£o: </p><br><ul><li>  Configura√ß√£o simples, API conveniente </li><li>  Confiabilidade  O Hangfire garante que a tarefa criada ser√° executada pelo menos uma vez </li><li>  Capacidade de executar tarefas em paralelo e excelente desempenho </li><li>  Extensibilidade (aqui usaremos abaixo) </li><li>  Documenta√ß√£o razoavelmente completa e compreens√≠vel </li><li>  Painel no qual voc√™ pode ver todas as estat√≠sticas sobre as tarefas </li></ul><br><p>  N√£o vou entrar em muitos detalhes, pois existem muitos artigos bons sobre o Hangfire e como us√°-lo.  Neste artigo, discutirei como usar o suporte de v√°rias filas (ou conjuntos de tarefas), como corrigir a funcionalidade de repeti√ß√£o padr√£o e fazer com que cada fila tenha uma configura√ß√£o individual. </p><a name="habracut"></a><br><h3 id="suschestvuyuschaya-podderzhka-psevdo-ocheredey">  Suporte existente para filas (pseudo) </h3><br><p>  Nota importante: no t√≠tulo, usei o termo pseudo-fila porque o Hangfire n√£o garante que as tarefas sejam executadas em uma ordem espec√≠fica.  I.e.  o princ√≠pio de "primeiro a entrar, primeiro a sair" n√£o se aplica e n√£o confiaremos nele.  Al√©m disso, o autor da biblioteca recomenda tornar as tarefas idempotentes, ou seja,  constante contra a execu√ß√£o m√∫ltipla imprevista.  Al√©m disso, usarei apenas a palavra "fila", porque  O Hangfire usa o termo "Fila". </p><br><p>  O Hangfire possui suporte a filas simples.  Embora n√£o ofere√ßa a flexibilidade de sistemas de fila de mensagens, como rabbitMQ ou Barramento de Servi√ßo do Azure, geralmente √© suficiente resolver uma ampla variedade de tarefas. </p><br><p>  Cada tarefa possui a propriedade "Fila", ou seja, o nome da fila na qual deve ser executada.  Por padr√£o, a tarefa √© enviada para a fila com o nome "padr√£o", a menos que especificado de outra forma.  √â necess√°rio suporte para v√°rias filas para gerenciar separadamente a execu√ß√£o de tarefas de diferentes tipos.  Por exemplo, podemos querer que as tarefas de processamento de v√≠deo caiam na fila "fila de v√≠deo" e enviem E-mails para a fila "fila de email".  Assim, somos capazes de executar independentemente esses dois tipos de tarefas.  Se queremos mover o processamento de v√≠deo para um servidor dedicado, podemos fazer isso facilmente executando um servidor Hangfire separado como um aplicativo de console que processar√° a fila "video_queue". </p><br><h3 id="pereydem-k-praktike">  Vamos seguir praticando </h3><br><p>  A configura√ß√£o do servidor Hangfire no n√∫cleo do asp.net √© a seguinte: </p><br><pre><code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Configure</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">IApplicationBuilder app</span></span></span><span class="hljs-function">)</span></span> { app.UseHangfireServer(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> BackgroundJobServerOptions { WorkerCount = <span class="hljs-number"><span class="hljs-number">2</span></span>, Queues = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span>[] { <span class="hljs-string"><span class="hljs-string">"email_queue"</span></span>, <span class="hljs-string"><span class="hljs-string">"video_queue"</span></span> } }); }</code> </pre> <br><h3 id="problema-1---zadachi-pri-povtore-popadayut-v-ochered-default">  Problema 1 - As tarefas de reprodu√ß√£o caem na fila padr√£o </h3><br><p>  Como mencionei acima, h√° uma fila padr√£o no Hangfire chamada "padr√£o".  Se uma tarefa colocada na fila, por exemplo, "video_queue", falhar e precisar ser tentada novamente, ser√° enviada para a fila "padr√£o" novamente e n√£o para "video_queue" e, como resultado, nossa tarefa n√£o ser√° executada. a inst√¢ncia do servidor Hangfire que gostar√≠amos, se houver.  Esse comportamento foi estabelecido por mim experimentalmente e provavelmente √© um bug no pr√≥prio Hangfire. </p><br><h4 id="job-filters">  Filtros de trabalho </h4><br><p>  O Hangfire nos oferece a possibilidade de expandir a funcionalidade com a ajuda dos chamados filtros (filtros de tarefas), que s√£o similares em princ√≠pio aos filtros de a√ß√µes no ASP.NET MVC.  O fato √© que a l√≥gica interna do Hangfire √© implementada como uma m√°quina de estado.  Este √© um mecanismo que transfere sequencialmente as tarefas no pool de um estado para outro (por exemplo, criado -&gt; enfileirado -&gt; processamento -&gt; bem-sucedido) e os filtros permitem "interceptar" a tarefa que √© executada cada vez que seu estado √© alterado e manipul√°-la.  Um filtro √© implementado como um atributo que pode ser aplicado a um √∫nico m√©todo, classe ou globalmente. </p><br><h4 id="job-parameters">  Par√¢metros do trabalho </h4><br><p>  O objeto ElectStateContext √© passado como um argumento para o m√©todo de filtro.  Este objeto cont√©m informa√ß√µes completas sobre a tarefa atual.  Entre outras coisas, ele possui os m√©todos GetJobParameter &lt;&gt; (...) e SettJobParameter &lt;&gt; (...).  Os Par√¢metros do trabalho permitem salvar informa√ß√µes relacionadas a uma tarefa em um banco de dados.  √â nos Par√¢metros da tarefa que o nome da fila para a qual a tarefa foi originalmente enviada √© armazenado, apenas por algum motivo essas informa√ß√µes s√£o ignoradas durante a pr√≥xima nova tentativa. </p><br><h3 id="reshenie">  Solu√ß√£o </h3><br><p>  Portanto, temos uma tarefa que terminou com erro e deve ser enviada para reexecu√ß√£o na fila certa (na mesma que foi atribu√≠da a ela no momento da cria√ß√£o inicial).  A repeti√ß√£o de uma tarefa que foi conclu√≠da com um erro √© uma transi√ß√£o do estado "falhou" para o estado "enfileirado".  Para resolver o problema, crie um filtro que, quando a tarefa entrar no estado "enfileirado", verifique em qual fila a tarefa foi enviada inicialmente e coloque o par√¢metro "QueueName" no valor desejado: </p><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">HangfireUseCorrectQueueFilter</span></span> : <span class="hljs-title"><span class="hljs-title">JobFilterAttribute</span></span>, <span class="hljs-title"><span class="hljs-title">IElectStateFilter</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OnStateElection</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">ElectStateContext context</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (context.CandidateState <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> EnqueuedState enqueuedState) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> queueName = context.GetJobParameter&lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>&gt;(<span class="hljs-string"><span class="hljs-string">"QueueName"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.IsNullOrWhiteSpace(queueName)) { context.SetJobParameter(<span class="hljs-string"><span class="hljs-string">"QueueName"</span></span>, enqueuedState.Queue); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { enqueuedState.Queue = queueName; } } } }</code> </pre> <br><p>  Para aplicar o filtro padr√£o a todas as tarefas (ou seja, globalmente), adicione o seguinte c√≥digo √† nossa configura√ß√£o: </p><br><pre> <code class="cs hljs">GlobalJobFilters.Filters.Add(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> HangfireUseCorrectQueueFilter { Order = <span class="hljs-number"><span class="hljs-number">1</span></span> });</code> </pre> <br><p>  Outro pequeno problema √© que a cole√ß√£o GlobalJobFilters, por padr√£o, cont√©m uma inst√¢ncia da classe AutomaticRetryAttribute.  Este √© um filtro padr√£o respons√°vel pela reexecu√ß√£o de tarefas com falha.  Ele tamb√©m envia a tarefa para a fila "padr√£o", ignorando a fila original.  Para que nossa bicicleta ande, √© necess√°rio remover esse filtro da cole√ß√£o e deixar que o filtro assuma a responsabilidade pelas tarefas repetidas.  Como resultado, o c√≥digo de configura√ß√£o ficar√° assim: </p><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> defaultRetryFilter = GlobalJobFilters.Filters .FirstOrDefault(f =&gt; f.Instance <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> AutomaticRetryAttribute); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (defaultRetryFilter != <span class="hljs-literal"><span class="hljs-literal">null</span></span> &amp;&amp; defaultRetryFilter.Instance != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { GlobalJobFilters.Filters.Remove(defaultRetryFilter.Instance); } GlobalJobFilters.Filters.Add(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> HangfireUseCorrectQueueFilter { Order = <span class="hljs-number"><span class="hljs-number">1</span></span> });</code> </pre> <br><p>  Deve-se observar que o AutomaticRetryAttribute implementa a l√≥gica de aumentar automaticamente o intervalo entre as tentativas (o intervalo aumenta a cada tentativa subseq√ºente) e, removendo o AutomaticRetryAttribute da cole√ß√£o GlobalJobFilters, abandonamos essa funcionalidade (consulte a implementa√ß√£o do m√©todo <a href="">ScheduleAgainLater</a> ) </p><br><p>  Portanto, conclu√≠mos que nossas tarefas podem ser executadas em filas diferentes, e isso nos permite gerenciar independentemente sua execu√ß√£o, incluindo o processamento de filas diferentes em m√°quinas diferentes.  Somente agora n√£o sabemos quantas vezes e em que intervalo nossas tarefas ser√£o repetidas em caso de erro, pois removemos o AutomaticRetryAttribute da cole√ß√£o de filtros. </p><br><h3 id="problema-2---individualnye-nastroyki-dlya-kazhdoy-ocheredi">  Problema 2 - Configura√ß√µes individuais para cada fila </h3><br><p>  Queremos poder configurar o intervalo e o n√∫mero de repeti√ß√µes separadamente para cada fila e, tamb√©m, se para alguma fila n√£o especificamos valores explicitamente, queremos que os valores padr√£o sejam aplicados.  Para fazer isso, implementamos outro filtro e o chamamos de <code>HangfireRetryJobFilter</code> . </p><br><p>  Idealmente, o c√≥digo de configura√ß√£o deve se parecer com isso: </p><br><pre> <code class="cs hljs">GlobalJobFilters.Filters.Add(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> HangfireRetryJobFilter { Order = <span class="hljs-number"><span class="hljs-number">2</span></span>, [<span class="hljs-string"><span class="hljs-string">"email_queue"</span></span>] = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> HangfireQueueSettings { DelayInSeconds = <span class="hljs-number"><span class="hljs-number">120</span></span>, RetryAttempts = <span class="hljs-number"><span class="hljs-number">3</span></span> }, [<span class="hljs-string"><span class="hljs-string">"video_queue"</span></span>] = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> HangfireQueueSettings { DelayInSeconds = <span class="hljs-number"><span class="hljs-number">60</span></span>, RetryAttempts = <span class="hljs-number"><span class="hljs-number">5</span></span> } });</code> </pre> <br><h3 id="reshenie-1">  Solu√ß√£o </h3><br><p>  Para fazer isso, primeiro adicione a classe <code>HangfireQueueSettings</code> , que servir√° como um cont√™iner para nossas configura√ß√µes. </p><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">sealed</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">HangfireQueueSettings</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> RetryAttempts { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> DelayInSeconds { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } }</code> </pre> <br><p>  Em seguida, adicionamos a implementa√ß√£o do pr√≥prio filtro, que, quando as tarefas s√£o repetidas ap√≥s um erro, aplicar√° as configura√ß√µes dependendo da configura√ß√£o da fila e monitorar√° o n√∫mero de tentativas: </p><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">HangfireRetryJobFilter</span></span> : <span class="hljs-title"><span class="hljs-title">JobFilterAttribute</span></span>, <span class="hljs-title"><span class="hljs-title">IElectStateFilter</span></span>, <span class="hljs-title"><span class="hljs-title">IApplyStateFilter</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> HangfireQueueSettings _defaultQueueSettings = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> HangfireQueueSettings { RetryAttempts = <span class="hljs-number"><span class="hljs-number">3</span></span>, DelayInSeconds = <span class="hljs-number"><span class="hljs-number">10</span></span> }; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> IDictionary&lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>, HangfireQueueSettings&gt; _settings = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Dictionary&lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>, HangfireQueueSettings&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> HangfireQueueSettings <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>[<span class="hljs-keyword"><span class="hljs-keyword">string</span></span> queueName] { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> _settings.TryGetValue(queueName, <span class="hljs-keyword"><span class="hljs-keyword">out</span></span> HangfireQueueSettings queueSettings) ? queueSettings : _defaultQueueSettings; } <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> { _settings[queueName] = <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>; } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OnStateElection</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">ElectStateContext context</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!(context.CandidateState <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> FailedState failedState)) { <span class="hljs-comment"><span class="hljs-comment">// This filter accepts only failed job state. return; } var retryAttempt = context.GetJobParameter&lt;int&gt;("RetryCount") + 1; var queueName = context.GetJobParameter&lt;string&gt;("QueueName"); if (retryAttempt &lt;= this[queueName].RetryAttempts) { ScheduleAgainLater(context, retryAttempt, failedState, queueName); } else { TransitionToDeleted(context, failedState, queueName); } } public void OnStateApplied( ApplyStateContext context, IWriteOnlyTransaction transaction) { if (context.NewState is ScheduledState &amp;&amp; context.NewState.Reason != null &amp;&amp; context.NewState.Reason.StartsWith("Retry attempt")) { transaction.AddToSet("retries", context.BackgroundJob.Id); } } public void OnStateUnapplied( ApplyStateContext context, IWriteOnlyTransaction transaction) { if (context.OldStateName == ScheduledState.StateName) { transaction.RemoveFromSet("retries", context.BackgroundJob.Id); } } private void ScheduleAgainLater( ElectStateContext context, int retryAttempt, FailedState failedState, string queueName) { context.SetJobParameter("RetryCount", retryAttempt); var delay = TimeSpan.FromSeconds(this[queueName].DelayInSeconds); const int maxMessageLength = 50; var exceptionMessage = failedState.Exception.Message.Length &gt; maxMessageLength ? failedState.Exception.Message.Substring(0, maxMessageLength - 1) + "‚Ä¶" : failedState.Exception.Message; // If attempt number is less than max attempts, we should // schedule the job to run again later. var reason = $"Retry attempt {retryAttempt} of {this[queueName].RetryAttempts}: {exceptionMessage}"; context.CandidateState = delay == TimeSpan.Zero ? (IState)new EnqueuedState { Reason = reason } : new ScheduledState(delay) { Reason = reason }; } private void TransitionToDeleted( ElectStateContext context, FailedState failedState, string queueName) { context.CandidateState = new DeletedState { Reason = this[queueName].RetryAttempts &gt; 0 ? "Exceeded the maximum number of retry attempts." : "Retries were disabled for this job." }; } }</span></span></code> </pre> <br><blockquote>  Nota para o c√≥digo: ao implementar a classe <code>HangfireRetryJobFilter</code> , a classe <code>AutomaticRetryAttribute</code> do <code>HangfireRetryJobFilter</code> foi tomada como base; portanto, a implementa√ß√£o de alguns m√©todos coincide parcialmente com os m√©todos correspondentes dessa classe. </blockquote><br><h3 id="problema-3---kak-otpravit-zadachu-na-vypolnenie-v-konkretnuyu-ochered">  Problema 3 - Como enviar uma tarefa para uma fila espec√≠fica? </h3><br><p>  Consegui encontrar duas maneiras de atribuir a tarefa √† fila: documentado e - n√£o. </p><br><p>  <strong>1¬∫ m√©todo</strong> - pendure o atributo correspondente no m√©todo </p><br><pre> <code class="cs hljs">[<span class="hljs-meta"><span class="hljs-meta">Queue(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"video_queue"</span></span></span><span class="hljs-meta">)</span></span>] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">SomeMethod</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { } BackgroundJob.Enqueue(() =&gt; SomeMethod());</code> </pre> <br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">http://docs.hangfire.io/en/latest/background-processing/configuring-queues.html</a> </p><br><p>  <strong>Segundo m√©todo</strong> (n√£o documentado) - use a classe <code>BackgroundJobClient</code> </p><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> client = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> BackgroundJobClient(); client.Create(() =&gt; MyMethod(), <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> EnqueuedState(<span class="hljs-string"><span class="hljs-string">"video_queue"</span></span>));</code> </pre> <br><p>  A vantagem do segundo m√©todo √© que ele n√£o cria depend√™ncias desnecess√°rias no Hangfire e permite que voc√™ decida durante qual processo a tarefa deve ser executada.  Infelizmente, na documenta√ß√£o oficial, n√£o encontrei men√ß√£o da classe <code>BackgroundJobClient</code> e como aplic√°-la.  Eu usei o segundo m√©todo na minha solu√ß√£o, portanto ele √© testado na pr√°tica. </p><br><h3 id="zaklyuchenie">  Conclus√£o </h3><br><p>  Neste artigo, usamos o suporte de v√°rias filas no Hangfire para separar o processamento de diferentes tipos de tarefas.  Implementamos nosso mecanismo para repetir tarefas conclu√≠das sem √™xito com a possibilidade de configura√ß√£o individual para cada fila, expandindo a funcionalidade do Hangfire usando filtros de tarefas e tamb√©m aprendemos como enviar tarefas para a fila desejada para execu√ß√£o. </p><br><p>  Espero que este artigo seja √∫til para algu√©m.  Ficarei feliz em comentar. </p><br><h3 id="poleznye-ssylki">  Links √∫teis </h3><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Documenta√ß√£o do Hangfire</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">C√≥digo-fonte do Hangfire</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Scott Hanselman - Como executar tarefas em segundo plano no ASP.NET</a> </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt434364/">https://habr.com/ru/post/pt434364/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt434354/index.html">Criando um modelo de reconhecimento de face usando aprendizado profundo em Python</a></li>
<li><a href="../pt434356/index.html">Still de Python com e-mail</a></li>
<li><a href="../pt434358/index.html">Substitui√ß√£o de importa√ß√£o de sistemas operacionais. Como vejo o SO dom√©stico</a></li>
<li><a href="../pt434360/index.html">Palestra explicada sobre programa√ß√£o ass√≠ncrona em Javascript</a></li>
<li><a href="../pt434362/index.html">N√ÉO previsto para 2019</a></li>
<li><a href="../pt434368/index.html">Machine Learning para encontrar erros no c√≥digo: como eu estagiei na JetBrains Research</a></li>
<li><a href="../pt434370/index.html">Outro conquistador de sombras em Phaser, ou o uso de bicicletas</a></li>
<li><a href="../pt434374/index.html">Verificando o RBAC no Kubernetes</a></li>
<li><a href="../pt434380/index.html">No√ß√µes b√°sicas de inje√ß√£o de depend√™ncia</a></li>
<li><a href="../pt434382/index.html">Portando o Alpine Linux para o RISC-V</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>