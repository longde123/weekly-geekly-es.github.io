<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë®‚Äçüé§ üë∞üèº üé¨ Le√ßons tir√©es des tests Plus de 200 000 lignes de code d'infrastructure üëçüèª üë©‚Äç‚öïÔ∏è üóæ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="L'IaC (Infrastructure as Code) est une approche moderne et je crois que l'infrastructure est du code. Cela signifie que nous devrions utiliser la m√™me...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Le√ßons tir√©es des tests Plus de 200 000 lignes de code d'infrastructure</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/467169/"><p><img src="https://habrastorage.org/webt/j2/pp/6q/j2pp6qs2f6qjrz5pn35wuzd0luk.png"></p><br><p>  <strong>L'IaC</strong> (Infrastructure as Code) est une approche moderne et je crois que l'infrastructure est du code.  Cela signifie que nous devrions utiliser la m√™me philosophie pour l'infrastructure que pour le d√©veloppement de logiciels.  Si nous parlons que l'infrastructure est du code, nous devons r√©utiliser les pratiques de d√©veloppement pour l'infrastructure, c'est-√†-dire les tests unitaires, la programmation de paires, la r√©vision de code.  Veuillez garder √† l'esprit cette id√©e lors de la lecture de l'article. </p><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Version russe</a> </p><a name="habracut"></a><br><p>  Il s'agit de la traduction de mon discours ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">vid√©o RU</a> ) √† <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">DevopsConf 2019-05-28</a> . </p><br><div class="spoiler">  <b class="spoiler_title">Diapositives et vid√©os</b> <div class="spoiler_text"><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Version russe</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Version russe</a> </li><li>  Essai √† sec 2019-04-24 <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">SpbLUG</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Vid√©o (RU) de DevopsConf 2019-05-28</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Vid√©o (RU) de DINS DevOps EVENING 2019-06-20</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Diapositives</a> </li></ul></div></div><br><h1 id="infrastructure-as-bash-history">  L'infrastructure comme histoire bash </h1><br><p><img src="https://habrastorage.org/webt/i_/yl/fm/i_ylfms8w-9pgisnujlu-iv1u3y.png"></p><br><p>  Imaginons que vous embarquiez sur un projet et que vous entendiez quelque chose comme: "Nous utilisons l' <em>infrastructure comme</em> approche de <em>code</em> ".  Malheureusement, ce qu'ils signifient vraiment, c'est <em>Infrastructure en tant qu'historique bash</em> ou <em>Documentation en tant qu'historique bash</em> .  C'est presque une situation r√©elle.  Par exemple, Denis Lysenko a d√©crit cette situation dans son discours <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Comment remplacer les infrastructures et arr√™ter de s'inqui√©ter (RU)</a> .  Denis a partag√© l'histoire sur la fa√ßon de convertir l'histoire de bash en une infrastructure haut de gamme. </p><br><p> V√©rifions la d√©finition du code source: <code>a text listing of commands to be compiled or assembled into an executable computer program</code> .  Si nous voulons, nous pouvons pr√©senter <em>Infrastructure comme un historique bash</em> comme du code.  Ceci est un texte et une liste de commandes.  Il d√©crit comment un serveur a √©t√© configur√©.  De plus, c'est: </p><br><ol><li>  <em>Reproductible</em> : vous pouvez obtenir l'historique de bash, ex√©cuter des commandes et probablement obtenir une infrastructure fonctionnelle. </li><li>  <em>Versioning</em> : vous savez qui s'est connect√©, quand et ce qui a √©t√© fait. <br>  Malheureusement, si vous perdez le serveur, vous ne pourrez rien faire car il n'y a pas d'historique bash, vous l'avez perdu avec le serveur. </li></ol><br><p>  Que faut-il faire? </p><br><h1 id="infrastructure-as-code">  L'infrastructure comme code </h1><br><p><img src="https://habrastorage.org/webt/gm/3e/wf/gm3ewf7g3w72takvuffsxhcbgoy.png"></p><br><p>  D'une part, ce cas anormal, <em>Infrastructure en tant qu'historique bash</em> , peut √™tre pr√©sent√© comme <em>Infrastructure en tant que code</em> , mais d'autre part, si vous voulez faire quelque chose de plus complexe que le serveur LAMP, vous devez g√©rer, maintenir et modifier le code .  Parlons des parall√®les entre <em>Infrastructure en tant que</em> d√©veloppement de <em>code</em> et d√©veloppement de logiciels. </p><br><h2 id="dry">  SEC </h2><br><p><img src="https://habrastorage.org/webt/rx/qa/vf/rxqavfjxrtmtwkjzzq4prr72oao.png"></p><br><p>  Nous d√©veloppions SDS (stockage d√©fini par logiciel).  La SDS se composait de serveurs OS distributifs personnalis√©s et haut de gamme, beaucoup de logique m√©tier, par cons√©quent, elle devait utiliser du mat√©riel r√©el.  P√©riodiquement, il y avait une sous-t√¢che d' <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">installation SDS</a> .  Avant de publier une nouvelle version, nous devions l'installer et v√©rifier.  Au d√©but, cela semblait √™tre une t√¢che tr√®s simple: </p><br><ul><li>  SSH pour h√©berger et ex√©cuter la commande. </li><li>  SCP un fichier. </li><li>  Modifiez une configuration. </li><li>  Ex√©cutez un service. </li><li>  ... </li><li>  PROFIT! </li></ul><br><p>  Je crois que <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Make CM, not bash</a> est une bonne approche.  Cependant, bash n'est utilis√© que dans des cas extr√™mes et limit√©s, comme au tout d√©but d'un projet.  Donc, bash √©tait un choix assez bon et raisonnable au tout d√©but du projet.  Le temps tournait.  Nous √©tions confront√©s √† diff√©rentes demandes de cr√©ation de nouvelles installations dans une configuration l√©g√®rement diff√©rente.  Nous √©tions SSHing dans les installations, et ex√©cutions les commandes pour installer tous les logiciels n√©cessaires, √©ditant les fichiers de configuration par des scripts et, enfin, configurant SDS via Web HTTP rest API.  Apr√®s tout, l'installation a √©t√© configur√©e et fonctionne.  C'√©tait une pratique assez courante, mais il y avait beaucoup de scripts bash et la logique d'installation devenait chaque jour plus complexe. </p><br><p>  Malheureusement, chaque script √©tait comme un petit flocon de neige selon qui le copiait.  C'√©tait aussi une vraie douleur lorsque nous cr√©ions ou recr√©ions l'installation. </p><br><p>  J'esp√®re que vous avez eu l'id√©e principale, qu'√† ce stade, nous devions constamment modifier la logique des scripts jusqu'√† ce que le service soit OK.  Mais il y avait une solution √† cela.  C'√©tait SEC </p><br><p><img src="https://habrastorage.org/webt/-u/ep/cv/-uepcvi1kjsnruflehy0noydk1k.png"></p><br><p>  Il existe une approche S√àCHE (ne vous r√©p√©tez pas).  L'id√©e principale est de r√©utiliser du code d√©j√† existant.  Cela semble extr√™mement simple.  Dans notre cas, DRY signifiait: configurations et scripts s√©par√©s. </p><br><h2 id="solid-for-cfm">  SOLIDE pour CFM </h2><br><p><img src="https://habrastorage.org/webt/kt/7f/ba/kt7fbazyy0arjwrnlwgoynqbvqg.png"></p><br><p>  Le projet grandissait, nous avons donc d√©cid√© d'utiliser Ansible.  Il y avait des raisons √† cela: </p><br><ol><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Bash ne doit pas contenir de logique complexe</a> . </li><li>  Nous avions une certaine expertise dans Ansible. </li></ol><br><p>  Il y avait une quantit√© de logique m√©tier dans le code Ansible.  Il existe une approche pour mettre les choses dans le code source pendant le processus de d√©veloppement logiciel.  Il s'appelle <em>SOLID</em> .  De mon point de vue, nous pouvons r√©utiliser <em>SOLID</em> for <em>Infrastructure comme code</em> .  Laissez-moi vous expliquer √©tape par √©tape. </p><br><h3 id="the-single-responsibility-principle">  Le principe de responsabilit√© unique </h3><br><p><img src="https://habrastorage.org/webt/yh/h7/kg/yhh7kgr1jal27ddvpeydqxcmzog.png"></p><br><p>  <em>Une classe ne devrait avoir qu'une seule responsabilit√©, c'est-√†-dire que seules les modifications apport√©es √† une partie de la sp√©cification du logiciel devraient pouvoir affecter la sp√©cification de la classe.</em> </p><br><p>  Vous ne devez pas cr√©er de code spaghetti dans votre code d'infrastructure.  Votre infrastructure doit √™tre constitu√©e de simples briques pr√©visibles.  En d'autres termes, ce pourrait √™tre une bonne id√©e de diviser l'immense livre de jeu Ansible en r√¥les Ansible ind√©pendants.  Il sera plus facile √† entretenir. </p><br><h3 id="the-open-closed-principle">  Les principes ouvert-ferm√© </h3><br><p><img src="https://habrastorage.org/webt/g6/ym/qn/g6ymqn8vohwbewqx7hgixuiuuf8.png"></p><br><p>  <em>Les entit√©s logicielles ... devraient √™tre ouvertes pour extension, mais ferm√©es pour modification.</em> </p><br><p>  Au d√©but, nous d√©ployions le SDS sur des machines virtuelles, un peu plus tard, nous avons ajout√© le <em>d√©ploiement sur des serveurs bare metal</em> .  Nous l'avions fait.  Cela a √©t√© aussi simple que facile pour nous car nous venons d'ajouter une impl√©mentation pour des pi√®ces sp√©cifiques au m√©tal nu sans modifier la logique d'installation de SDS. </p><br><h3 id="the-liskov-substitution-principle">  Le principe de substitution de Liskov </h3><br><p><img src="https://habrastorage.org/webt/1x/-4/am/1x-4am1tjecrhxx3jm7bfur00oy.png"></p><br><p>  <em>Les objets d'un programme doivent √™tre rempla√ßables par des instances de leurs sous-types sans alt√©rer l'exactitude de ce programme.</em> </p><br><p>  Soyons ouverts d'esprit.  <em>SOLID</em> est possible d'utiliser dans CFM en g√©n√©ral, ce n'√©tait pas un projet chanceux.  Je voudrais d√©crire un autre projet.  Il s'agit d'une solution d'entreprise pr√™te √† l'emploi.  Il prend en charge diff√©rentes bases de donn√©es, serveurs d'applications et interfaces d'int√©gration avec des syst√®mes tiers.  Je vais utiliser cet exemple pour d√©crire le reste de <em>SOLID</em> </p><br><p>  Par exemple dans notre cas, il y a un accord au sein de l'√©quipe d'infrastructure: si vous d√©ployez le r√¥le java ibm ou l'oracle java ou openjdk, vous aurez un ex√©cutable java binaire.  Nous en avons besoin car les r√¥les Ansible de niveau sup√©rieur * en d√©pendent.  En outre, cela nous permet d'√©changer l'impl√©mentation java sans modifier la logique d'installation des applications. </p><br><p>  Malheureusement, il n'y a pas de sucre de syntaxe pour cela dans les playbooks Ansible.  Cela signifie que vous devez en tenir compte lors du d√©veloppement des r√¥les Ansible. </p><br><h3 id="the-interface-segregation-principle">  Le principe de s√©gr√©gation des interfaces </h3><br><p><img src="https://habrastorage.org/webt/v2/9r/wa/v29rwalnqryarhrwe-_r8jvx0go.png"></p><br><p>  <em>De nombreuses interfaces sp√©cifiques au client valent mieux qu'une interface √† usage g√©n√©ral.</em> </p><br><p>  Au d√©but, nous mettions la logique d'installation des applications dans le playbook unique, nous essayions de couvrir tous les cas et les tranchants.  Nous avions fait face au probl√®me qu'il est difficile de maintenir, alors nous avons chang√© notre approche.  Nous avons compris qu'un client avait besoin d'une interface de notre part (c'est-√†-dire https au port 443) et nous avons pu combiner nos r√¥les Ansible pour chaque environnement sp√©cifique. </p><br><h3 id="the-dependency-inversion-principle">  Le principe d'inversion de d√©pendance </h3><br><p><img src="https://habrastorage.org/webt/ee/ip/e8/eeipe8nr7hbjx18yxtoxsekwlfy.png"></p><br><p>  <em>Il faut "d√©pendre d'abstractions, pas de concr√©tions".</em> </p><br><ul><li>  <em>Les modules de haut niveau ne doivent pas d√©pendre de modules de bas niveau.</em>  <em>Les deux devraient d√©pendre d'abstractions (par exemple des interfaces).</em> </li><li>  <em>Les abstractions ne devraient pas d√©pendre des d√©tails.</em>  <em>Les d√©tails (impl√©mentations concr√®tes) doivent d√©pendre des abstractions.</em> </li></ul><br><p>  Je voudrais d√©crire ce principe via anti-pattern. </p><br><ol><li>  Il y avait un client avec un cloud priv√©. </li><li>  Nous demandions des machines virtuelles dans le cloud. </li><li>  Notre logique de d√©ploiement d√©pendait de l'hyperviseur sur lequel une machine virtuelle √©tait situ√©e. </li></ol><br><p>  En d'autres termes, nous n'avons pas pu r√©utiliser notre IaC dans un autre cloud car la logique de d√©ploiement de niveau sup√©rieur d√©pendait de l'impl√©mentation de niveau inf√©rieur.  <strong>S'il te plait ne le fais pas</strong> </p><br><h1 id="interaction">  L'interaction </h1><br><p><img src="https://habrastorage.org/webt/rd/7_/8r/rd7_8rtprcz4xjkuhctjppbkcuu.png"></p><br><p>  L'infrastructure n'est pas seulement du code, il s'agit aussi du code d'interaction &lt;-&gt; DevOps, DevOps &lt;-&gt; DevOps, IaC &lt;-&gt; personnes. </p><br><h2 id="bus-factor">  Facteur de bus </h2><br><p><img src="https://habrastorage.org/webt/p5/4-/wh/p54-whkhcglorvk_dlt0b1jpajy.png"></p><br><p>  Imaginons, il y a l'ing√©nieur DevOps John.  John sait tout sur votre infrastructure.  Si John se fait heurter par un bus, qu'arrivera-t-il √† votre infrastructure?  Malheureusement, c'est presque un cas r√©el.  Parfois, des choses se produisent.  Si cela s'est produit et que vous ne partagez pas les connaissances sur l'IaC, l'infrastructure entre les membres de votre √©quipe, vous serez confront√© √† de nombreuses cons√©quences impr√©visibles et d√©licates.  Il existe certaines approches pour y faire face.  Laissez-nous en parler. </p><br><h2 id="pair-devopsing">  Pair DevOpsing </h2><br><p><img src="https://habrastorage.org/webt/6q/0l/t0/6q0lt0afzbkpivxxp4uvryxgake.png"></p><br><p>  C'est comme la programmation par paires.  En d'autres termes, il y a deux ing√©nieurs DevOps et ils utilisent un seul ordinateur portable \ clavier pour configurer l'infrastructure: configurer un serveur, cr√©er un r√¥le Ansible, etc.  Cela semble g√©nial, cependant, cela n'a pas fonctionn√© pour nous.  Il y avait des cas personnalis√©s quand cela fonctionnait partiellement. </p><br><ul><li>  <em>Int√©gration</em> : le mentor et la nouvelle personne obtiennent une t√¢che r√©elle √† partir d'un carnet de commandes et travaillent ensemble - transf√®rent les connaissances du mentor √† la personne. </li><li>  <em>Appel incident</em> : Lors du d√©pannage, il y a un groupe d'ing√©nieurs, ils recherchent une solution.  Le point cl√© est qu'il y a une personne qui dirige cet incident.  La personne partage l'√©cran et les id√©es.  D'autres personnes le suivent attentivement et remarquent les astuces bash, les erreurs, l'analyse des journaux, etc. </li></ul><br><h2 id="code-review">  Examen du code </h2><br><p><img src="https://habrastorage.org/webt/wk/u6/vn/wku6vntzzsquckgu58n1_r3tg-i.png"></p><br><p>  De mon point de vue, la <em>r√©vision de code</em> est l'un des moyens les plus efficaces de partager des connaissances au sein d'une √©quipe sur votre infrastructure.  Comment √ßa marche? </p><br><ul><li>  Il existe un r√©f√©rentiel qui contient la description de votre infrastructure. </li><li>  Tout le monde fait ses changements dans une branche d√©di√©e. </li><li>  Au cours de la demande de fusion, vous √™tes en mesure d'examiner les changements de delta dans votre infrastructure. </li></ul><br><p>  La chose la plus int√©ressante est que nous faisions tourner un relecteur.  Cela signifie que tous les deux jours, nous avons √©lu un nouvel examinateur et l'examinateur examinait toutes les demandes de fusion.  Par cons√©quent, th√©oriquement, chaque personne devait toucher une nouvelle partie de l'infrastructure et avait une connaissance moyenne de notre infrastructure en g√©n√©ral. </p><br><h3 id="code-style">  Style de code </h3><br><p><img src="https://habrastorage.org/webt/qa/fz/ju/qafzju1vc86llmvcc1m4urpfa7c.png"></p><br><p>  Le temps avan√ßait, nous nous disputions parfois lors de la r√©vision car le r√©viseur et le committer pouvaient utiliser un style de code diff√©rent: 2 espaces ou 4, <em>camelCase</em> ou <em>snake_case</em> .  Nous l'avons mis en ≈ìuvre, cependant, ce n'√©tait pas un pique-nique. </p><br><ul><li>  La premi√®re id√©e a √©t√© de recommander l'utilisation de linters.  Chacun avait son propre environnement de d√©veloppement: IDE, OS ... c'√©tait difficile de tout synchroniser &amp; unifier. </li><li>  L'id√©e a √©volu√© en un robot l√¢che.  Apr√®s chaque commit, le bot v√©rifiait le code source et poussait dans les messages l√¢ches avec une liste de probl√®mes.  Malheureusement, dans la grande majorit√© des cas, il n'y a eu aucun changement de code source apr√®s les messages. </li></ul><br><h3 id="green-build-master">  Ma√Ætre de la construction √©cologique </h3><br><p><img src="https://habrastorage.org/webt/lw/ow/xi/lwowxis0izoohgthm9db7nheih4.png"></p><br><p>  Ensuite, l'√©tape la plus douloureuse a √©t√© de restreindre la pouss√©e √† la branche principale pour tout le monde.  Seulement via les demandes de fusion et les tests verts doivent √™tre corrects.  Cela s'appelle <em>Green Build Master</em> .  En d'autres termes, vous √™tes s√ªr √† 100% que vous pouvez d√©ployer votre infrastructure √† partir de la branche principale.  C'est une pratique assez courante dans le d√©veloppement de logiciels: </p><br><ul><li>  Il existe un r√©f√©rentiel qui contient la description de votre infrastructure. </li><li>  Tout le monde fait ses changements dans une branche d√©di√©e. </li><li>  Pour chaque branche, nous effectuons des tests. </li><li>  Vous ne pouvez pas fusionner dans la branche principale si les tests √©chouent. </li></ul><br><p>  Ce fut une d√©cision difficile.  Esp√©rons que, lors du processus de r√©vision, il n'y ait eu aucune discussion sur le style de code et la quantit√© d'odeur de code diminuait. </p><br><h1 id="iac-testing">  Test IaC </h1><br><p><img src="https://habrastorage.org/webt/ah/dg/sa/ahdgsaecxtevlwnv9ozcoiypkq8.png"></p><br><p>  Outre la v√©rification du style de code, vous pouvez v√©rifier que vous pouvez d√©ployer ou recr√©er votre infrastructure dans un sandbox.  √Ä quoi √ßa sert?  C'est une question sophistiqu√©e et je voudrais partager une histoire au lieu d'une r√©ponse.  √âtait un scaler automatique personnalis√© pour AWS √©crit en Powershell.  Le d√©tartreur automatique n'a pas v√©rifi√© les param√®tres de coupe pour les param√®tres d'entr√©e, par cons√©quent, il a cr√©√© des tonnes de machines virtuelles et le client n'√©tait pas satisfait.  C'est une situation d√©licate, esp√©rons-le, il est possible de l'attraper d√®s les premi√®res √©tapes. </p><br><p>  D'une part, il est possible de tester le script et l'infrastructure, mais d'autre part, vous augmentez la quantit√© de code et complexifiez l'infrastructure.  Cependant, la vraie raison sous le capot est que vous mettez vos connaissances sur l'infrastructure √† l'√©preuve.  Vous d√©crivez comment les choses devraient fonctionner ensemble. </p><br><h2 id="iac-testing-pyramid">  Pyramide de test IaC </h2><br><p><img src="https://habrastorage.org/webt/pn/98/jt/pn98jtnydc1wupw_jvifjjc9mpc.png"></p><br><h3 id="iac-testing-static-analysis">  Tests IaC: analyse statique </h3><br><p>  Vous pouvez cr√©er l'int√©gralit√© de l'infrastructure √† partir de z√©ro pour chaque validation, mais, g√©n√©ralement, il existe certains obstacles: </p><br><ul><li>  Le prix est stratosph√©rique. </li><li>  Cela demande beaucoup de temps. </li></ul><br><p>  Esp√©rons qu'il y ait quelques astuces.  Vous devriez avoir beaucoup de tests simples, rapides et primitifs dans votre fondation. </p><br><h4 id="bash-is-tricky">  Bash est d√©licat </h4><br><p>  Prenons un exemple extr√™mement simple.  Je voudrais cr√©er un script de sauvegarde: </p><br><ul><li>  R√©cup√®re tous les fichiers du r√©pertoire courant. </li><li>  Copiez les fichiers dans un autre r√©pertoire avec un nom modifi√©. </li></ul><br><p>  La premi√®re id√©e est: </p><br><pre> <code class="plaintext hljs">for i in * ; do cp $i /some/path/$i.bak done</code> </pre> <br><p>  Assez bien.  Cependant, que se passe-t-il si le nom de fichier contient de l' <em>espace</em> ?  Nous sommes des gars intelligents, nous utilisons des citations: </p><br><pre> <code class="plaintext hljs">for i in * ; do cp "$i" "/some/path/$i.bak" done</code> </pre> <br><p>  Avons-nous fini?  Non!  Et si le r√©pertoire est vide?  Globing √©choue dans ce cas. </p><br><pre> <code class="plaintext hljs">find . -type f -exec mv -v {} dst/{}.bak \;</code> </pre> <br><p>  Avons-nous fini?  Pas encore ... Nous avons oubli√© que le nom de fichier peut contenir <code>\n</code> caract√®re. </p><br><pre> <code class="plaintext hljs">touch x mv x "$(printf "foo\nbar")" find . -type f -print0 | xargs -0 mv -t /path/to/target-dir</code> </pre> <br><h4 id="static-analysis-tools">  Outils d'analyse statique </h4><br><p>  Vous pouvez intercepter certains probl√®mes de l'exemple pr√©c√©dent via <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Shellcheck</a> .  Il existe de nombreux outils de ce type, appel√©s linters, et vous pouvez trouver celui qui convient le mieux √† votre IDE, √† votre pile et √† votre environnement. </p><br><div class="scrollable-table"><table><thead><tr><th>  La langue </th><th>  Outil </th></tr></thead><tbody><tr><td>  bash </td><td>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Shellcheck</a> </td></tr><tr><td>  Rubis </td><td>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Rubocop</a> </td></tr><tr><td>  python </td><td>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Pylint</a> </td></tr><tr><td>  Ansible </td><td>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Peluche ansible</a> </td></tr></tbody></table></div><br><h3 id="iac-testing-unit-tests">  Tests IaC: tests unitaires </h3><br><p><img src="https://habrastorage.org/webt/pn/wx/av/pnwxavylqxfmvcc-oynjhjmsq-a.png"></p><br><p>  Comme vous pouvez le voir, les linters ne peuvent pas tout attraper, ils ne peuvent que pr√©dire.  Si nous continuons de penser aux parall√®les entre le d√©veloppement de logiciels et l'infrastructure en tant que code, nous devrions mentionner les tests unitaires.  Il existe de nombreux syst√®mes de tests unitaires comme <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">shunit</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">JUnit</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">RSpec</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">pytest</a> .  Mais avez-vous d√©j√† entendu parler des tests unitaires pour Ansible, Chef, Saltstack, CFengine? </p><br><p>  Lorsque nous parlions de <em>SOLID</em> for CFM, j'ai mentionn√© que notre infrastructure devait √™tre faite de briques / modules simples.  Le moment est maintenant venu: </p><br><ol><li>  Divisez l'infrastructure en modules / coupures simples, c'est-√†-dire des r√¥les Ansible. </li><li>  Cr√©ez un environnement, c'est-√†-dire Docker ou VM. </li><li>  Appliquez votre unique rupture / module √† l'environnement. </li><li>  V√©rifiez que tout va bien ou non. <br>  ... </li><li>  PROFIT! </li></ol><br><h4 id="iac-testing-unit-testing-tools">  Tests IaC: outils de tests unitaires </h4><br><p>  Quel est le test pour CFM et votre infrastructure?  c'est-√†-dire que vous pouvez simplement ex√©cuter un script ou utiliser une solution pr√™te pour la production comme: </p><br><div class="scrollable-table"><table><thead><tr><th>  CFM </th><th>  Outil </th></tr></thead><tbody><tr><td>  Ansible </td><td>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Testinfra</a> </td></tr><tr><td>  Chef cuisinier </td><td>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Inspec</a> </td></tr><tr><td>  Chef cuisinier </td><td>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Serverspec</a> </td></tr><tr><td>  sali√®re </td><td>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Goss</a> </td></tr></tbody></table></div><br><p>  Jetons un ≈ìil √† testinfra, je voudrais v√©rifier que les utilisateurs <code>test1</code> , <code>test2</code> existent et font partie du groupe <code>sshusers</code> : </p><br><pre> <code class="plaintext hljs">def test_default_users(host): users = ['test1', 'test2' ] for login in users: assert host.user(login).exists assert 'sshusers' in host.user(login).groups</code> </pre> <br><p>  Quelle est la meilleure solution?  Il n'y a pas de r√©ponse unique √† cette question, cependant, j'ai cr√©√© la carte de chaleur et compar√© les changements dans ces projets au cours de 2018-2019: </p><br><p><img src="https://habrastorage.org/webt/aj/vm/0w/ajvm0wr0cno5a0kchi0z-jwyyxy.png"></p><br><h4 id="iac-testing-frameworks">  Cadres de test IaC </h4><br><p>  Apr√®s cela, vous pouvez vous poser une question sur la fa√ßon de g√©rer tout cela ensemble?  D'une part, vous pouvez <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">tout faire par vous-m√™me</a> si vous avez suffisamment de grands ing√©nieurs, mais d'autre part, vous pouvez utiliser des solutions open source pr√™tes pour la production: </p><br><div class="scrollable-table"><table><thead><tr><th>  CFM </th><th>  Outil </th></tr></thead><tbody><tr><td>  Ansible </td><td>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Mol√©cule</a> </td></tr><tr><td>  Chef cuisinier </td><td>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Cuisine d'essai</a> </td></tr><tr><td>  Terraform </td><td>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Terratest</a> </td></tr></tbody></table></div><br><p>  J'ai cr√©√© la carte de chaleur et compar√© les changements de ces projets au cours de 2018-2019: </p><br><p><img src="https://habrastorage.org/webt/bj/lb/02/bjlb02mi6tympyzdjjxef3_8bhq.png"></p><br><h4 id="molecule-vs-testkitchen">  Mol√©cule vs.  Testkitchen </h4><br><p><img src="https://habrastorage.org/webt/vx/2e/dt/vx2edtvvuquxyw-4yf81zmk6s9c.png"></p><br><p>  Au d√©but, nous avons essay√© de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">tester les r√¥les ansibles via testkitchen dans hyper-v</a> : </p><br><ol><li>  Cr√©ez des VM. </li><li>  Appliquer des r√¥les Ansible. </li><li>  Ex√©cutez Inspec. </li></ol><br><p>  Il a fallu 40 √† 70 minutes pour 25 √† 35 r√¥les Ansible.  C'√©tait trop long pour nous. </p><br><p><img src="https://habrastorage.org/webt/i-/9j/cl/i-9jclmr4x36ag1e8ppzk_d-_b0.png"></p><br><p>  L'√©tape suivante consistait √† utiliser Jenkins / docker / Ansible / mol√©cule.  C'est √† peu pr√®s la m√™me id√©e: </p><br><ol><li>  Playbooks Lint Ansible. </li><li>  R√¥les de Lint Ansible. </li><li>  Ex√©cutez un conteneur Docker. </li><li>  Appliquer des r√¥les Ansible. </li><li>  Ex√©cutez testinfra. </li><li>  V√©rifiez l'idempotence. </li></ol><br><p><img src="https://habrastorage.org/webt/zz/je/kf/zzjekf-i8wckzdeslzlrbkmmxhg.png"></p><br><p>  Linting pour 40 r√¥les et les tests pour dix d'entre eux ont pris environ 15 minutes. </p><br><p><img src="https://habrastorage.org/webt/pn/6p/qe/pn6pqelxwb7dbaapkefv80ccxra.png"></p><br><p>  Quelle est la meilleure solution?  D'une part, je ne veux pas √™tre l'autorit√© finale, mais d'autre part, je voudrais partager mon point de vue.  Il n'y a pas de solution miracle, cependant, dans le cas o√π la mol√©cule Ansible est une solution plus appropri√©e que la cuisine de test. </p><br><h3 id="iac-testing-integration-tests">  Tests IaC: tests d'int√©gration </h3><br><p><img src="https://habrastorage.org/webt/yt/jf/br/ytjfbruwxfanxl15sxcfyg_gz1g.png"></p><br><p>  Au niveau suivant de la <em>pyramide de tests IaC</em> , il y a <em>les tests d'int√©gration</em> .  Les tests d'int√©gration pour l'infrastructure ressemblent √† des tests unitaires: </p><br><ol><li>  Divisez l'infrastructure en modules / coupures simples, c'est-√†-dire des r√¥les Ansible. </li><li>  Cr√©ez un environnement, c'est-√†-dire Docker ou VM. </li><li>  Appliquer <em>une combinaison</em> de rupture / module simple √† l'environnement. </li><li>  V√©rifiez que tout va bien ou non. <br>  ... </li><li>  PROFIT! </li></ol><br><p>  En d'autres termes, lors des tests unitaires, nous v√©rifions un module simple (ie r√¥le Ansible, script python, module Ansible, etc.) d'une infrastructure, mais dans le cas des tests d'int√©gration, nous v√©rifions la configuration compl√®te du serveur. </p><br><h3 id="iac-testing-end-to-end-tests">  Tests IaC: tests de bout en bout </h3><br><p><img src="https://habrastorage.org/webt/pn/98/jt/pn98jtnydc1wupw_jvifjjc9mpc.png"></p><br><p>  En plus de la <em>pyramide des tests IaC</em> , il existe des <em>tests de bout en bout</em> .  Dans ce cas, nous ne v√©rifions pas le serveur d√©di√©, le script, le module de notre infrastructure;  Nous v√©rifions que l'ensemble de l'infrastructure fonctionne correctement.  Malheureusement, il n'y a pas de solution pr√™te √† l'emploi pour cela ou je n'en ai pas entendu parler (veuillez me signaler si vous les connaissez).  Habituellement, les gens r√©inventent la roue, car il y a une demande de tests de bout en bout pour les infrastructures.  Donc, je voudrais partager mon exp√©rience, j'esp√®re qu'elle sera utile √† quelqu'un. </p><br><p><img src="https://habrastorage.org/webt/us/xz/rl/usxzrlzt8unudguhf9b89d83dfm.png"></p><br><p>  Tout d'abord, je voudrais d√©crire le contexte.  Il s'agit d'une solution d'entreprise pr√™te √† l'emploi, elle prend en charge diff√©rentes bases de donn√©es, serveurs d'applications et interfaces d'int√©gration avec des syst√®mes tiers.  Habituellement, nos clients sont une immense entreprise avec un environnement compl√®tement diff√©rent.  Nous avons des connaissances sur les diff√©rentes combinaisons d'environnements et nous les stockons dans diff√©rents fichiers de composition de docker.  En outre, il existe une correspondance entre les fichiers de composition docker et les tests, nous les stockons en tant que travaux Jenkins. </p><br><p><img src="https://habrastorage.org/webt/an/l2/ev/anl2ev_lxlsnegrxpulghdw9jxw.png"></p><br><p>  Ce sch√©ma fonctionnait pendant une p√©riode de temps calme et <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">logicielle</a> lorsque, au cours de la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">recherche OpenShift,</a> nous avons essay√© de le migrer vers OpenShift.  Nous avons utilis√© √† peu pr√®s les m√™mes conteneurs (encore une fois DRY) et nous avons uniquement chang√© l'environnement. </p><br><p><img src="https://habrastorage.org/webt/sh/sg/ud/shsgudbrhuqpazrpikcacxskzrm.png"></p><br><p>  Nous continuons √† rechercher et √† trouver <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">APB</a> (Ansible Playbook Bundle).  L'id√©e principale est que vous emballiez toutes les choses n√©cessaires dans un conteneur et que vous ex√©cutiez le conteneur dans Openshift.  Cela signifie que vous disposez d'une solution reproductible et testable. </p><br><p><img src="https://habrastorage.org/webt/l_/cw/ho/l_cwho8ftxhtnmuekhjlsfllctg.png"></p><br><p>  Tout allait bien jusqu'√† ce que nous rencontrions un autre probl√®me: nous devions maintenir une infrastructure h√©t√©rog√®ne pour les environnements de test.  En cons√©quence, nous stockons nos connaissances sur la fa√ßon de cr√©er une infrastructure et d'ex√©cuter des tests dans les travaux Jenkins. </p><br><h1 id="conclusion">  Conclusion </h1><br><p><img src="https://habrastorage.org/webt/j2/pp/6q/j2pp6qs2f6qjrz5pn35wuzd0luk.png"><br>  L'infrastructure en tant que code est une combinaison de: </p><br><ul><li>  Code </li><li>  Interaction avec les gens. </li><li>  Test d'infrastructure. </li></ul><br><div class="spoiler">  <b class="spoiler_title">liens</b> <div class="spoiler_text"><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">C'est une publication crois√©e d'un blog personnel</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Version russe</a> </li><li>  Essai √† sec 2019-04-24 <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">SpbLUG</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Vid√©o (RU) de DevopsConf 2019-05-28</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Vid√©o (RU) de DINS DevOps EVENING 2019-06-20</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Le√ßons tir√©es de la r√©daction de plus de 300 000 lignes d'infrastructure Code</a> et <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">version texte</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Int√©gration de l'infrastructure en tant que code dans un pipeline de livraison continue</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Tester l'infrastructure en tant que code</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">D√©veloppement et maintenance efficaces des r√¥les Ansible</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Ansible n'est pas pour vous!</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Ansible idempotent</a> </li></ul></div></div></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr467169/">https://habr.com/ru/post/fr467169/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr467153/index.html">Travailler avec des objections: l'analyse statique fera partie du temps de travail</a></li>
<li><a href="../fr467155/index.html">Meilleures pratiques pour les conteneurs Kubernetes: bilans de sant√©</a></li>
<li><a href="../fr467161/index.html">Application Web sur Kotlin + Spring Boot + Vue.js</a></li>
<li><a href="../fr467163/index.html">Comment migrer vers le cloud en deux heures gr√¢ce √† Kubernetes et √† l'automatisation</a></li>
<li><a href="../fr467165/index.html">Sur les traces du mouvement russe Scala. 2e partie</a></li>
<li><a href="../fr467171/index.html">Ce que j'ai appris en testant 200 000 lignes de code d'infrastructure</a></li>
<li><a href="../fr467173/index.html">Architecte de mise en ≈ìuvre s√©curis√©e d'ERP</a></li>
<li><a href="../fr467175/index.html">R√©fl√©chissez bien avant d'utiliser les moteurs de jeu</a></li>
<li><a href="../fr467177/index.html">Conseils marketing Tarantino: quel r√¥le jouent les pieds et pourquoi faire du savon Uma Thurman</a></li>
<li><a href="../fr467179/index.html">Samsung Compiler Bootcamp: apprenez √† cr√©er des "programmes de programmation"</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>