<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üòä üôçüèΩ üòá Inmersi√≥n en AD: analizamos ataques avanzados en Microsoft Active Directory y c√≥mo detectarlos üÉè ‚ùì üõÉ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Imagen: Pexels 

 En los √∫ltimos cuatro a√±os, ning√∫n Black Hat o DEF CON ha estado sin informes sobre ataques en Microsoft Active Directory. Los parti...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Inmersi√≥n en AD: analizamos ataques avanzados en Microsoft Active Directory y c√≥mo detectarlos</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/pt/blog/423903/"> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><img src="https://habrastorage.org/webt/a7/-h/dd/a7-hddi1lio7lql-ftmp3xryg1e.jpeg"></a> <br><br>  <i>Imagen: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Pexels</a></i> <br><br>  En los √∫ltimos cuatro a√±os, ning√∫n Black Hat o DEF CON ha estado sin informes sobre ataques en Microsoft Active Directory.  Los participantes hablan sobre nuevos vectores y sus inventos, pero no se olviden de los consejos sobre c√≥mo detectarlos y prevenirlos.  En este art√≠culo, veremos formas populares de atacar AD y proporcionaremos recomendaciones que ayudar√°n a proteger contra ellos. <a name="habracut"></a><br><br><h2>  Seis ataques AD que no puedes pasar por alto </h2><br>  Muchos fabricantes de software de monitoreo de seguridad ya admiten una variedad de t√©cnicas de ataque en sus productos.  Consideremos algunos de ellos. <br><br><h3>  Pase el hash </h3><br>  Esta t√©cnica es posible debido a las caracter√≠sticas arquitect√≥nicas del protocolo de autenticaci√≥n NTLM, desarrollado por Microsoft en los a√±os noventa del siglo pasado.  Para iniciar sesi√≥n en un host remoto, se utiliza un hash de contrase√±a, que se almacena en la memoria de la computadora desde la que se lleva a cabo la autenticaci√≥n.  En consecuencia, se puede extraer de all√≠. <br><br><h3>  Mimikatz </h3><br>  Para una operaci√≥n conveniente de Pass-the-Hash, el investigador franc√©s Benjamin Delpy (Benjamin Delpy) en 2014 desarroll√≥ la utilidad mimikatz.  Permite descargar contrase√±as de texto sin cifrar y hash NTLM de la memoria. <br><br><h3>  Fuerza bruta </h3><br>  Si el atacante no tiene suficientes credenciales que extrajo de un host, puede recurrir a una t√©cnica cruda pero efectiva de adivinar contrase√±as. <br><br><h3>  usuario / dominio neto </h3><br>  ¬øD√≥nde obtener un diccionario de nombres de usuario para realizar Brute Force?  Cualquier miembro del dominio puede usar el comando net user / domain, que devuelve una lista completa de nombres de usuario de AD. <br><br><h3>  Kerberoasting </h3><br>  Si el dominio usa Kerberos como protocolo de autenticaci√≥n, el atacante podr√≠a recurrir a un ataque de Kerberoasting.  Cualquier usuario autenticado en el dominio puede solicitar un ticket Kerberos para acceder al Servicio de otorgamiento de tickets.  TGS se cifra con el hash de contrase√±a de la cuenta desde la que se ejecuta el servicio de destino.  Un atacante que obtuvo TGS ahora puede descifrarlo, tomar una contrase√±a y no tener miedo de bloquear, ya que lo hace sin conexi√≥n.  Tras un resultado exitoso, recibe una contrase√±a de la cuenta asociada con el servicio, que a menudo es privilegiada. <br><br><h3>  Psexec </h3><br>  Despu√©s de que el atacante recibi√≥ las credenciales necesarias, se enfrenta a la tarea de ejecutar comandos de forma remota.  La utilidad PsExec de la suite Sysinternals es muy adecuada para esto.  Se ha demostrado tanto entre los administradores de TI como entre los atacantes. <br><br><h2>  Siete hechizos de ataque para capturar Active Directory </h2><br>  Ahora estamos pasando a siete hechizos, gracias a los cuales los atacantes pueden tomar el control completo de Active Directory.  Los dividiremos en cuatro etapas: <br><br><ol><li>  Inteligencia </li><li>  Promoci√≥n en AD. </li><li>  Operaci√≥n </li><li>  Captura de dominio. </li></ol><br>  En el diagrama puede ver los cuatro, as√≠ como las t√©cnicas que se utilizan en ellos.  Consideremos cada uno en detalle. <br><br><img src="https://habrastorage.org/webt/bq/lw/uf/bqlwufggd4wwixlwo6dsb5w66by.png"><br><br><h2>  Etapa 1. Exploraci√≥n </h2><br>  Comencemos con la etapa de inteligencia. <br><br><h3>  Powerview </h3><br>  Esta herramienta es parte del popular marco de pruebas de penetraci√≥n de PowerShell: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">PowerSploit</a> .  Tambi√©n se basa en la herramienta <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">BloodHound</a> , que construye un gr√°fico de relaciones de objetos dentro de AD. <br><br><img src="https://habrastorage.org/webt/vb/45/xl/vb45xlilemlfooxopnrxytorpq0.png"><br><br>  <i>Representaci√≥n gr√°fica de las relaciones de objeto de Active Directory.</i> <br><br>  Bloodhound proporciona inmediatamente estas caracter√≠sticas: <br><br><ul><li>  Encuentra cuentas de todos los administradores de dominio; </li><li>  buscar hosts en los que los administradores de dominio hayan iniciado sesi√≥n; </li><li>  construya la ruta m√°s corta desde el host del atacante al host con la sesi√≥n de administrador de dominio. </li></ul><br>  El √∫ltimo p√°rrafo da una respuesta a la pregunta de qu√© hosts deben ser pirateados a un atacante para acceder a la cuenta de administrador de dominio.  Este enfoque reduce en gran medida el tiempo para obtener el control total sobre el dominio. <br><br>  PowerView difiere de las utilidades integradas para recuperar datos sobre objetos AD (por ejemplo, net.exe) en que se ejecuta en el protocolo LDAP, no en SAMR.  El evento 1644 de un controlador de dominio es adecuado para detectar esta actividad.  El registro de este evento se habilita agregando el valor apropiado en el registro: <br><br> <code>HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\NTDS\Diagnostic\\15 Field Engineering = 5</code> <br> <br><img src="https://habrastorage.org/webt/7q/i2/ny/7qi2nyhavykzj4rqdyohz3ou0pi.png"><br><br>  <i>Habilitaci√≥n del registro de eventos LDAP 1644</i> <br><br><img src="https://habrastorage.org/webt/aj/6m/1b/aj6m1bzfn0tgimroq6gnxva_7_e.png"><br><br>  <i>Evento 1644 con par√°metros de solicitud LDAP</i> <br><br>  Vale la pena prestar atenci√≥n al hecho de que puede haber muchos de estos eventos, y una buena alternativa a la detecci√≥n de eventos es la detecci√≥n de tr√°fico, ya que LDAP es un protocolo de texto claro, por lo tanto, todas las solicitudes en el tr√°fico son perfectamente visibles. <br><br> <a href=""><img src="https://habrastorage.org/webt/_w/cd/s3/_wcds3rfyfneg4f6fukn2ojjx4q.png"></a> <br><br>  <i>LDAP SearchRequest (haga clic para abrir la imagen a tama√±o completo)</i> <br><br>  Otra caracter√≠stica importante de este marco es que est√° escrito en PowerShell puro y no tiene dependencias.  Y aqu√≠, para la detecci√≥n, la funci√≥n de auditor√≠a avanzada introducida en PowerShell versi√≥n 5 nos ayudar√°.  El evento 4104 muestra el cuerpo de un script en el que podemos buscar nombres de funciones espec√≠ficas de PowerView. <br><br><img src="https://habrastorage.org/webt/4g/3q/ri/4g3qri26i-n9yd52ca5s95o-fg0.png"><br><br><h3>  Escaneo SPN </h3><br>  Puede reemplazar el nmap de lanzamiento del atacante.  Despu√©s de que el atacante haya descubierto qu√© usuarios y grupos est√°n dentro de AD, para completar la imagen necesitar√° informaci√≥n sobre qu√© servicios est√°n disponibles. <br><br><img src="https://habrastorage.org/webt/yt/gp/ro/ytgprok6xzem1x1ihixxn1awb1q.png"><br><br>  Esto generalmente se resuelve escaneando los puertos con nmap.  Pero ahora esta informaci√≥n tambi√©n se puede obtener de AD: ya est√° almacenada all√≠.  Puede ver el resultado de dicha solicitud: devuelva los llamados SPN (Service Principal Names).  El SPN consiste en una clase de servicio, es √∫nico para cada tipo de servicio, luego viene el nombre de host en forma de FQDN y para algunos servicios - puerto. <br><br><img src="https://habrastorage.org/webt/5b/z8/ot/5bz8otu_w7hroldiqy0wscyut-g.png"><br><br>  <i>Ejemplos de spn</i>  <i><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Lista completa de nombres principales de servicio</a></i> <br><br>  Para detectar SPN Scan, la auditor√≠a de eventos LDAP tambi√©n viene al rescate. <br>  Es importante tener en cuenta que el escaneo SPN tiene una clara ventaja sobre el escaneo nmap: es menos ruidoso.  Cuando use nmap, debe conectarse a cada nodo y enviar paquetes al rango de puertos que especific√≥.  Y para obtener la lista de SPN, solo debe enviar una solicitud. <br><br><h3>  Enumeraci√≥n de sesiones remotas </h3><br>  Una tarea importante para un atacante en la etapa de movimiento lateral es determinar qu√© usuario ha iniciado sesi√≥n en qu√© m√°quina.  O ya tiene credenciales de usuario (hash o ticket Kerberos), y est√° buscando hosts donde pueda iniciar sesi√≥n sin obst√°culos.  O est√° buscando un host donde hay una sesi√≥n de administrador de dominio en vivo. <br><br>  Entonces el escenario funciona: caza -&gt; comprometer a cualquier host -&gt; Golfo de Mimikatz -&gt; beneficio. <br><br>  Puede usar 2 eventos para detectar esta t√©cnica.  4624 es un inicio de sesi√≥n exitoso en un sistema remoto con un inicio de sesi√≥n de tipo 3, as√≠ como eventos de acceso de red IPC $, y el matiz es el nombre de la tuber√≠a: srvsvc.  Por qu√© se llama una tuber√≠a se puede entender por el tr√°fico. <br><br> <a href=""><img src="https://habrastorage.org/webt/gl/5k/kf/gl5kkf1bkclyx3b5dgkvwhxpeyo.png"></a> <br><br>  <i>Haga clic para abrir la imagen a tama√±o completo.</i> <br><br>  En el lado izquierdo, en los marcos rojos, acceda a SMB, luego acceda a la tuber√≠a - srvsvc.  Esta canalizaci√≥n le permite interactuar utilizando el Protocolo remoto de servicio de servidor especial.  Permite que los hosts finales reciban diversa informaci√≥n administrativa, incluyendo  Entre las consultas hay una llamada NetSessEnum.  Como resultado de esta solicitud, se devuelve una lista completa de usuarios que han iniciado sesi√≥n en el sistema remoto con IP y nombres de usuario. <br><br> <a href=""><img src="https://habrastorage.org/webt/6z/3-/oa/6z3-oas3amujm5b6kohgowgops0.png"></a> <br><br>  <i>En MaxPatrol SIEM, realizamos una detecci√≥n basada en una combinaci√≥n de estos dos eventos teniendo en cuenta srvsvc.</i>  <i>Y una detecci√≥n de tr√°fico similar en PT Network Attack Discovery.</i> <br><br><h2>  Etapa 2. Promoci√≥n AD </h2><br><h3>  Sobrepasar el hash </h3><br>  La reencarnaci√≥n de Pass-the-Hash.  Continuando con el tema del movimiento lateral.  ¬øQu√© puede hacer un atacante si tiene un hash NTLM?  √âl puede llevar a cabo un ataque Pass-the-Hash, pero ya hay detecciones en ella.  Por lo tanto, se encontr√≥ un nuevo vector: el ataque Overpass-the-Hash. <br><br>  El protocolo Kerberos fue dise√±ado espec√≠ficamente para que las contrase√±as de usuario de una forma u otra no se transmitan a trav√©s de la red.  Para hacer esto, en su m√°quina, el usuario utiliza su contrase√±a para cifrar la solicitud de autenticaci√≥n.  En respuesta, el Centro de distribuci√≥n de claves (un servicio especial que est√° alojado en el controlador de dominio) le emite un ticket para recibir otros tickets.  El llamado Ticket-Granting Ticket (TGT).  Ahora el cliente se considera autenticado, y en 10 horas puede solicitar boletos para acceder a otros servicios.  En consecuencia, si un atacante rechaz√≥ el hash de un usuario que es miembro de un grupo confiable de un servicio que le interesa, por ejemplo, un sistema ERP o una base de datos, el atacante puede emitir un pase para s√≠ mismo e iniciar sesi√≥n con √©xito en el servicio que le interesa. <br><br><img src="https://habrastorage.org/webt/6s/iy/qv/6siyqv90fxjresvbwwzhw2ioynw.png"><br><br><h4>  C√≥mo detectar </h4><br>  Si el atacante usa la versi√≥n PowerShell de mimikatz para este ataque, entonces el registro del cuerpo del script viene al rescate.  Porque Invoke-Mimikatz es una l√≠nea muy caracter√≠stica. <br><br><img src="https://habrastorage.org/webt/hh/3v/cu/hh3vcum-h8mlcker6wdmdsjiwfu.png"><br><br><img src="https://habrastorage.org/webt/hh/3v/cu/hh3vcum-h8mlcker6wdmdsjiwfu.png"><br><br>  O 4688 es un evento de inicio de proceso con auditor√≠a avanzada de l√≠nea de comandos.  Incluso si se cambia el nombre del binar, en la l√≠nea de comandos encontraremos un comando muy caracter√≠stico de mimikatz. <br><br><img src="https://habrastorage.org/webt/ur/li/cq/urlicqqkfzjpcphbagcrhvzdoxw.png"><br><br>  El tr√°fico de Overpass-the-Hash se puede detectar en funci√≥n de una anomal√≠a que resulta del hecho de que Microsoft recomienda usar la solicitud de autenticaci√≥n AES256 para el cifrado de los dominios actuales.  Y mimikatz, cuando env√≠a datos de solicitud de autenticaci√≥n, cifra los datos utilizando el ARCFOUR obsoleto. <br><br> <a href=""><img src="https://habrastorage.org/webt/1n/yh/tr/1nyhtr7fvxksqjh6snv_dwyhtco.png"></a> <br><br>  En el tr√°fico, se observa otra diferencia debido a las caracter√≠sticas de mimikatz.  Se basa en la diferencia en el conjunto de cifrado en el dominio leg√≠timo y lo que env√≠a mimikatz. <br><br><h3>  Boleto de oro </h3><br>  ¬øQu√© puede hacer un atacante si tiene un hash de contrase√±a de una cuenta especial llamada krbtgt?  Anteriormente, consideramos el caso en que el usuario podr√≠a no tener privilegios.  Ahora estamos considerando un usuario con un hash de contrase√±a del cual absolutamente todos los tickets para otros tickets (TGT) est√°n firmados.  En consecuencia, el atacante ya no se dirige al Centro de distribuci√≥n de claves, genera este boleto por su cuenta, ya que el Boleto dorado, en esencia, es TGT.  Luego puede enviar solicitudes de autenticaci√≥n a cualquier servicio dentro de AD, y por tiempo ilimitado.  Como resultado, recurre libremente a este recurso: el Golden Ticket no es sin raz√≥n llamado dorado. <br><br><img src="https://habrastorage.org/webt/58/z6/vh/58z6vh3afwjzkebygy_jmxu6ee0.png"><br><br><h4>  C√≥mo detectar por eventos </h4><br>  Existe el evento 4768, que dice que se emiti√≥ TGT, y el evento 4769, que dice que se emiti√≥ un ticket de servicio, que es necesario para la autenticaci√≥n en alg√∫n servicio dentro de AD. <br><br><img src="https://habrastorage.org/webt/wx/l5/gx/wxl5gx-fncwjf1oukr1ldumzzv8.png"><br><br>  Aqu√≠ podemos jugar con la diferencia:  durante un ataque, Golden Ticket no solicita un TGT de un controlador de dominio (lo genera por s√≠ solo), y necesita solicitar un TGS, si encontramos una diferencia en el TGT y TGS recibidos, podemos suponer que se est√° produciendo un ataque Golden Ticket. <br><br>  En MaxPatrol SIEM utilizando listas de tablas en las que registramos todos los TGT y TGS emitidos, logramos implementar dicha detecci√≥n. <br><br><h3>  Ejecuci√≥n remota de WMI </h3><br>  Una vez resuelta la tarea de autenticaci√≥n y autorizaci√≥n en los hosts deseados, el atacante puede comenzar a realizar tareas de forma remota.  WMI, como mecanismo incorporado y dise√±ado para esto, se adapta perfectamente.  En los √∫ltimos a√±os, "vivir de la tierra" significa utilizar los mecanismos integrados de Windows en una tendencia.  En primer lugar, porque le permite disfrazarse de actividad leg√≠tima. <br><br> <a href=""><img src="https://habrastorage.org/webt/m-/96/ez/m-96ez5gjcxuckslwxweegfopcu.png"></a> <br><br>  En la captura de pantalla, el uso de la utilidad wmic incorporada.  Especifica la direcci√≥n del host al que desea conectarse, las credenciales, la instrucci√≥n de creaci√≥n de la llamada al proceso y el comando que debe ejecutarse en el host remoto. <br><br><h4>  C√≥mo detectar </h4><br>  En un mont√≥n de eventos de inicio de sesi√≥n remoto 4624 (preste atenci√≥n a <br>  mania en Logon ID) y evento 4688, que habla sobre comenzar un proceso con l√≠nea de comando.  4688: puede ver que el padre del proceso iniciado es WmiPrvSE.exe, un proceso especial de servicio WMI que se utiliza para la administraci√≥n remota.  El comando que enviamos net user / add es visible, y el ID de inicio de sesi√≥n coincide con el evento 4624. En consecuencia, podemos decir exactamente desde qu√© host se est√° ejecutando este comando. <br><br><img src="https://habrastorage.org/webt/7u/eb/ei/7uebeito5oikpqj5c_uth187-3m.png"><br><br><h4>  Detecci√≥n de tr√°fico </h4><br>  Aqu√≠ vemos claramente las palabras caracter√≠sticas del proceso de creaci√≥n de Win32, as√≠ como la l√≠nea de comando, que se env√≠a para comenzar.  En la captura de pantalla, recientemente conocimos un malware, que se distribuy√≥ en redes virtuales de acuerdo con un principio similar a WannaCry, pero en lugar de cifrado, instal√≥ un minero.  Malvar llev√≥ a mimikatz y EthernalBlue con ella, dej√≥ las cuentas y, con su ayuda, inici√≥ sesi√≥n en todos los hosts a los que pod√≠a acceder en la red.  Usando WMI, lanz√≥ PowerShell en ellos, descarg√≥ la carga √∫til de PowerShell, que nuevamente conten√≠a mimikatz, EthernalBlue y el minero.  Por lo tanto, se obtuvo una reacci√≥n en cadena. <br><br><img src="https://habrastorage.org/webt/xm/jy/yb/xmjyybw60n3mxmjjrnm8wwvsrq8.png"><br><br><h2>  Recomendaciones para las etapas 1-3 </h2><br><blockquote>  1. <b>Contrase√±as largas y complejas (&gt; 25 caracteres) para cuentas de servicio.</b>  Esto no le dar√° al atacante la oportunidad de llevar a cabo un ataque de Kerberoasting, ya que  tomar√° mucho tiempo en bruto. <br><br>  2. <b>Registro de PowerShell</b> .  Ayudar√° a detectar el uso de muchas herramientas modernas para ataques contra AD <br><br>  3. <b>Pasando a Windows 10, Windows Server 2016.</b> Microsoft cre√≥ Credential Guard: ya no ser√° posible volcar hashes NTLM y tickets Kerberos de la memoria <br><br>  4. <b>Demarcaci√≥n estricta de roles</b> .  Es peligroso combinar en una funci√≥n el administrador de AD, DC, todos los servidores y m√°quinas en funcionamiento. <br><br>  5. <b>Cambio de contrase√±a doble krbtgt (esta es la misma cuenta con la que se registran los tickets de TGT)</b> .  Todos los a√±os  Y despu√©s de que el administrador de AD deja AD: <br><ul><li>  necesita ser cambiado dos veces, porque  la contrase√±a actual y la anterior se almacenan, </li><li>  cambiar cada a√±o, incl.  despu√©s de dejar el administrador de dominio.  Incluso si la red ya est√° comprometida y los atacantes emitieron el Golden Ticket, cambiar la contrase√±a hace que este Ticket sea in√∫til.  Y nuevamente necesitan comenzar de nuevo. </li></ul><br>  6. <b>Remedios con una base de conocimiento experto continuamente actualizada</b> .  Es necesario detectar ataques reales reales. </blockquote><br><h2>  Etapa 4. Captura de dominio </h2><br><h3>  DCShadow </h3><br>  El 24 de enero de 2018, en la conferencia Microsoft BlueHat en Israel, Benjamin Delpy y Vincent Le Toux presentaron el nuevo m√≥dulo mimikatz, que implementa el ataque DCShadow.  La esencia del ataque es que se crea un controlador de dominio falso para modificar y crear nuevos objetos en AD a trav√©s de la replicaci√≥n.  Los investigadores lograron aislar el conjunto m√≠nimo de SPN de Kerberos necesarios para realizar el proceso de replicaci√≥n; solo necesitan 2. Adem√°s, presentaron una funci√≥n especial que puede forzar la replicaci√≥n de los controladores.  Los autores del ataque lo posicionan como un ataque que har√° que su SIEM sea ciego.  Porque  un controlador de dominio falso no env√≠a eventos a SIEM, lo que significa que los atacantes pueden hacer varias cosas oscuras con AD y SIEM no lo sabr√°. <br><br><img src="https://habrastorage.org/webt/op/t5/nv/opt5nvhaixi6i8da_2ixv5kivmk.png"><br><br><h4>  Patr√≥n de ataque </h4><br>  En el sistema con el que se lleva a cabo el ataque, es necesario agregar 2 SPN, que son necesarios para que otros controladores de dominio puedan autenticarse usando Kerberos para la replicaci√≥n.  Porque  de acuerdo con la especificaci√≥n, el controlador de dominio est√° representado en la base de datos de AD por un objeto de la clase nTDSDSA, debe crear dicho objeto.  Finalmente, invoque la replicaci√≥n usando la funci√≥n DRSReplicaAdd. <br><br><h4>  C√≥mo detectar </h4><br>  C√≥mo se ve DCShadow en el tr√°fico.  Por tr√°fico, vemos claramente la adici√≥n de un nuevo objeto al esquema de configuraci√≥n del tipo de controlador de dominio, y luego el inicio forzado de la replicaci√≥n <br><br><img src="https://habrastorage.org/webt/fl/fa/xf/flfaxfzh1dwlccjntfdgcs44aui.png"><br><br>  Debido a que nuestra correlaci√≥n conoce la lista de controladores de dominio leg√≠timos, se activar√° cuando se produzca la replicaci√≥n desde un controlador de dominio que no est√° incluido en esta lista blanca.  En consecuencia, la divisi√≥n de seguridad de la informaci√≥n puede llevar a cabo una investigaci√≥n y comprender que se trata de un controlador de dominio leg√≠timo agregado por el servicio de TI o el ataque DCShadow. <br><br><h2>  Conclusi√≥n </h2><br>  El ejemplo DCShadow muestra que hay nuevos vectores de ataque para la empresa.  En este oc√©ano de eventos de seguridad de la informaci√≥n, es muy importante permanecer en la cresta de la ola: mirar m√°s all√° y moverse r√°pido.  Todos los d√≠as, en PT Expert Security Center investigamos nuevas amenazas y desarrollamos m√©todos y herramientas de detecci√≥n para ellas.  Y estamos listos para compartir m√°s esta informaci√≥n. <br><br>  <b>Publicado por</b> Anton Tyurin, jefe del equipo de detecci√≥n de ataques, Tecnolog√≠as positivas </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/es423903/">https://habr.com/ru/post/es423903/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../es423891/index.html">√Årboles de expresi√≥n de desarrollo empresarial</a></li>
<li><a href="../es423893/index.html">Hello World para recibir datos de un dispositivo Bluetooth (BLE) a trav√©s de C #</a></li>
<li><a href="../es423895/index.html">No necesitas un abogado. Pero eso no es seguro</a></li>
<li><a href="../es423897/index.html">Consejos √∫tiles para usar el asistente HyperLynx DDR para el an√°lisis QDR4</a></li>
<li><a href="../es423901/index.html">Cuando se necesita velocidad y escala: servidor de dispositivos iOS distribuidos</a></li>
<li><a href="../es423905/index.html">Los desarrolladores permanecieron desconocidos. Conferencia de Yandex</a></li>
<li><a href="../es423911/index.html">La fot√≥nica de silicio tropieza en el √∫ltimo medidor</a></li>
<li><a href="../es423919/index.html">C√≥mo automatizar la recopilaci√≥n de KPI por mes y dejar a los usuarios casi satisfechos</a></li>
<li><a href="../es423921/index.html">10 a√±os de Android: recuerda todo</a></li>
<li><a href="../es423923/index.html">SAP Leonardo Hackathon de velcom y SAP para desarrolladores de Bielorrusia</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>