<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🗂️ 🏂🏿 👨🏿‍🤝‍👨🏼 Zabbix-使用SNMPv3 TRAP，痛苦和绝望来监视OSPF邻居 👩🏾‍🤝‍👨🏼 🙌 ✌🏾</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="职权范围 
 有一个分布在不同地理位置的数据中心网络，其中有一个VRF汽车和一个不断变化的OSPF邻居列表。 您需要跟踪它们： 



1. 状态，如果邻居状态不是FULL，则发出警报 
2. 数量，即如果邻居不见了，您还必须发出警报 
 一个监控系统已经存在-Zabbix 3.4，最好使用它，Li...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Zabbix-使用SNMPv3 TRAP，痛苦和绝望来监视OSPF邻居</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/417813/"><h2> 职权范围 </h2><br> 有一个分布在不同地理位置的数据中心网络，其中有一个VRF汽车和一个不断变化的OSPF邻居列表。 您需要跟踪它们： <br><br><ol><li> 状态，如果邻居状态不是FULL，则发出警报 </li><li> 数量，即如果邻居不见了，您还必须发出警报 </li></ol><br> 一个监控系统已经存在-Zabbix 3.4，最好使用它，Linux OS Debian 9.x <br><a name="habracut"></a><br><h2> 我们尝试一下 </h2><br> 该协议非常普遍，监控系统众所周知，我可能不是第一个想要解决此问题的人，而且很有可能已经解决了。 <br><br> 我们进入“ zabbix ospf”搜索，第一个链接指向<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">模板</a> 。 幸福就是什么-现在我将其导入，并将其组合到我的需求中，一切都会顺利进行。 <br> 我们检查它是如何工作的-一切似乎都很好，监视了状态，但是当邻居进入DOWN状态时，我们从Zabbix收到了“非常”有用的消息 <br><br><pre><code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">No</span></span> Such Instance currently <span class="hljs-keyword"><span class="hljs-keyword">exists</span></span> at this <span class="hljs-type"><span class="hljs-type">OID</span></span></code> </pre> <br> 和信息 <br><br><pre> <code class="hljs pgsql">The item <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> discovered anymore <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> will be deleted <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-number"><span class="hljs-number">29</span></span>d <span class="hljs-number"><span class="hljs-number">23</span></span>h <span class="hljs-number"><span class="hljs-number">57</span></span>m (<span class="hljs-keyword"><span class="hljs-keyword">on</span></span> <span class="hljs-number"><span class="hljs-number">2018</span></span><span class="hljs-number"><span class="hljs-number">-08</span></span><span class="hljs-number"><span class="hljs-number">-19</span></span> at <span class="hljs-number"><span class="hljs-number">08</span></span>:<span class="hljs-number"><span class="hljs-number">52</span></span>)</code> </pre> <br> 发生的事情-问题很老而且在<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=https://www.opennet.ru/openforum/vsluhforumID3/109102.html)%2520%255B%25D0%25B4%25D0%25B2%25D0%25B0%255D(">论坛中都</a>知道-OSPF邻居消失时，与之关联的所有OID都会在网络硬件上被删除。 <br><br> 是的，有一个解决方案-创建一个无数据触发器，确定： <br><br><pre> <code class="hljs objectivec">{Template - SNMPv3 - OSPF Discovery:ospfNbrState[{<span class="hljs-meta"><span class="hljs-meta">#SNMPVALUE}].nodata(120)}=0</span></span></code> </pre> <br> 我们在仪表板中看到： <br><br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">OSPF</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">neighbor</span></span> 192<span class="hljs-selector-class"><span class="hljs-selector-class">.168</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.192</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.168</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">missing</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">data</span></span></code> </pre> <br> 基本上...可用 <br><br> 但是开箱即用，LLD仅检测默认VRF中的邻居。 当然，可以使用<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">SNMP上下文</a>解决此问题，但是我完全不希望采用这种方式-我们需要遍历所有腺体，将OSPF进程或VRF注入到上下文中，然后为模板中的每个上下文创建Discovery副本，总的来说要花点时间大惊小怪，当添加新的OSPF进程时，您需要在几个地方进行更改。 您当然可以被脚本包围，并且可以通过Zabbix API进行所有更改，但是我不希望有特殊的自定义，但是我只想最大程度地使用Zabbix内置的功能。 这里提到了某种CISCO-CONTEXT-MAPPING-MIB，您可以从中提取上下文和OSPF / VRF的所有对应关系，但是我没有弄清楚如何将这种设计固定到LLD。 如果有人知道如何将Zabbix煮得如此凉爽，那么欢迎您发表评论，最好是撰写完整的独立文章。 <br><br><h2> 我们从第二次攻击开始尝试 </h2><br> 在互联网上搜索了几个小时后，找到了论坛中的提示以及内存不足时，出现了一个有关SNMP TRAP的话题-这是我们不采访铁杆，但铁杆发送有关某些变化的信息的时候。 是的，针对这些问题的竞选支持已在我们的监控系统<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">中提供</a> ，该设备也可以<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">立即</a>就我的情况使用。 <br><br> 从第一行开始，监视文档就被一长串列表弄糊涂了： <br><br><pre> <code class="hljs pgsql">The workflow <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> receiving a trap: <span class="hljs-number"><span class="hljs-number">1.</span></span> snmptrapd receives a trap <span class="hljs-number"><span class="hljs-number">2.</span></span> snmptrapd passes the trap <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> SNMPTT <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> calls Perl trap receiver <span class="hljs-number"><span class="hljs-number">3.</span></span> SNMPTT <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> Perl trap receiver parses, formats <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> writes the trap <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> a file <span class="hljs-number"><span class="hljs-number">4.</span></span> Zabbix SNMP trapper reads <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> parses the trap file <span class="hljs-number"><span class="hljs-number">5.</span></span> <span class="hljs-keyword"><span class="hljs-keyword">For</span></span> <span class="hljs-keyword"><span class="hljs-keyword">each</span></span> trap Zabbix finds <span class="hljs-keyword"><span class="hljs-keyword">all</span></span> “SNMP trapper” items <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> host interfaces matching the received trap address. Note that <span class="hljs-keyword"><span class="hljs-keyword">only</span></span> the selected “IP” <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> “DNS” <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> host interface <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> used during the matching. <span class="hljs-number"><span class="hljs-number">6.</span></span> <span class="hljs-keyword"><span class="hljs-keyword">For</span></span> <span class="hljs-keyword"><span class="hljs-keyword">each</span></span> <span class="hljs-built_in"><span class="hljs-built_in">found</span></span> item, the trap <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> compared <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> regexp <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> “snmptrap[regexp]”. The trap <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> the <span class="hljs-keyword"><span class="hljs-keyword">value</span></span> <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> <span class="hljs-keyword"><span class="hljs-keyword">all</span></span> matched items. <span class="hljs-keyword"><span class="hljs-keyword">If</span></span> <span class="hljs-keyword"><span class="hljs-keyword">no</span></span> matching item <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> <span class="hljs-built_in"><span class="hljs-built_in">found</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> there <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> an “snmptrap.fallback” item, the trap <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> the <span class="hljs-keyword"><span class="hljs-keyword">value</span></span> <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> that. <span class="hljs-number"><span class="hljs-number">7.</span></span> <span class="hljs-keyword"><span class="hljs-keyword">If</span></span> the trap was <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> the <span class="hljs-keyword"><span class="hljs-keyword">value</span></span> <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> <span class="hljs-keyword"><span class="hljs-keyword">any</span></span> item, Zabbix <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> logs the unmatched trap. (This <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> configured <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> “<span class="hljs-keyword"><span class="hljs-keyword">Log</span></span> unmatched SNMP traps” <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> Administration → General → Other.)</code> </pre> <br> 也就是说，一个守护程序接受TRAP，将其传递给另一个守护程序，然后对其进行解析，并以所需的格式将其放入日志中，并且zabix已经读取该日志并决定下一步要做什么。 某种程度上，它看起来比用手走路并在任何地方绘制SNMP上下文都容易得多，但是，让我们尝试一下。 我们仔细阅读了监视文档，并了解到只有借助其帮助，才能进行任何配置，通常Zabbix会开玩笑-该文档仅描述了系统的功能和细微差别，以致于比讲授的更加混乱。 尽管可以理解-该软件是免费的，但是您需要以某种方式赚钱，但是他们会在支持方面赚钱。 互联网上有几篇文章介绍了<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">一次或</a> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">两次设置的方法</a> ，但是我无法从一篇文章改写到下一篇文章，我不得不从各种来源收集信息。 这是所有的歌词，他们开车去做硬核。 <br><br><h2> 我们配置铁网 </h2><br> 在使用监控程序扭曲主机上的内容之前，我强烈建议您首先配置网络硬件，并确保TRAP确实从硬件到达服务器-最初，我没有检查它是否消耗了很多神经，精力和时间。 我手上有一辆Cisco Nexus汽车，因此我将举例说明该系列。 拥有Catalyst，ASR，ASA等产品的人-抱歉，我不是太阳，我不会加热所有人，请阅读有关如何自行配置的扩展坞，语法将相似，但有其细微差别。 <br><br><pre> <code class="hljs pgsql">snmp-<span class="hljs-keyword"><span class="hljs-keyword">server</span></span> contact noc@example.com snmp-<span class="hljs-keyword"><span class="hljs-keyword">server</span></span> <span class="hljs-keyword"><span class="hljs-keyword">location</span></span> Room1 snmp-<span class="hljs-keyword"><span class="hljs-keyword">server</span></span> source-interface traps loopback1</code> </pre> <br> 将来很重要，在Zabbix中配置TRAP时，发送TRAP的地址必须等于Zabbix主机设置中接口的SNMP地址。 <br><br><pre> <code class="hljs cs">snmp-server user Zabbix network-<span class="hljs-keyword"><span class="hljs-keyword">operator</span></span> auth sha <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> priv aes<span class="hljs-number"><span class="hljs-number">-128</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span></code> </pre> <br> 在authPriv模式（加密和身份验证）下，尽可能使用协议的版本3，配置起来似乎并不困难。 忘记协议的版本1和版本2 –当由于这些协议版本中缺乏加密和本质上的身份验证而导致意外的人到达时，这只是时间问题（社区字符串以清晰的形式传输，而且，我经常看到它配置为public / private）。 使用network-operator参数可以授予用户只读权限。 <br><br><pre> <code class="hljs sql">snmp-server host 192.168.192.168 traps version 3 priv Zabbix snmp-server host 192.168.192.168 <span class="hljs-keyword"><span class="hljs-keyword">use</span></span>-vrf <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> snmp-<span class="hljs-keyword"><span class="hljs-keyword">server</span></span> host <span class="hljs-number"><span class="hljs-number">192.168</span></span><span class="hljs-number"><span class="hljs-number">.192</span></span><span class="hljs-number"><span class="hljs-number">.168</span></span> <span class="hljs-keyword"><span class="hljs-keyword">source</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">interface</span></span> loopback1 <span class="hljs-keyword"><span class="hljs-keyword">no</span></span> snmp-<span class="hljs-keyword"><span class="hljs-keyword">server</span></span> <span class="hljs-keyword"><span class="hljs-keyword">enable</span></span> traps ospf lsa snmp-<span class="hljs-keyword"><span class="hljs-keyword">server</span></span> <span class="hljs-keyword"><span class="hljs-keyword">enable</span></span> traps ospf <span class="hljs-keyword"><span class="hljs-keyword">no</span></span> snmp-<span class="hljs-keyword"><span class="hljs-keyword">server</span></span> <span class="hljs-keyword"><span class="hljs-keyword">enable</span></span> traps entity entity_mib_change <span class="hljs-keyword"><span class="hljs-keyword">no</span></span> snmp-<span class="hljs-keyword"><span class="hljs-keyword">server</span></span> <span class="hljs-keyword"><span class="hljs-keyword">enable</span></span> traps entity entity_module_status_change <span class="hljs-keyword"><span class="hljs-keyword">no</span></span> snmp-<span class="hljs-keyword"><span class="hljs-keyword">server</span></span> <span class="hljs-keyword"><span class="hljs-keyword">enable</span></span> traps entity entity_power_status_change <span class="hljs-keyword"><span class="hljs-keyword">no</span></span> snmp-<span class="hljs-keyword"><span class="hljs-keyword">server</span></span> <span class="hljs-keyword"><span class="hljs-keyword">enable</span></span> traps entity entity_module_inserted <span class="hljs-keyword"><span class="hljs-keyword">no</span></span> snmp-<span class="hljs-keyword"><span class="hljs-keyword">server</span></span> <span class="hljs-keyword"><span class="hljs-keyword">enable</span></span> traps entity entity_module_removed <span class="hljs-keyword"><span class="hljs-keyword">no</span></span> snmp-<span class="hljs-keyword"><span class="hljs-keyword">server</span></span> <span class="hljs-keyword"><span class="hljs-keyword">enable</span></span> traps entity entity_unrecognised_module <span class="hljs-keyword"><span class="hljs-keyword">no</span></span> snmp-<span class="hljs-keyword"><span class="hljs-keyword">server</span></span> <span class="hljs-keyword"><span class="hljs-keyword">enable</span></span> traps entity entity_fan_status_change <span class="hljs-keyword"><span class="hljs-keyword">no</span></span> snmp-<span class="hljs-keyword"><span class="hljs-keyword">server</span></span> <span class="hljs-keyword"><span class="hljs-keyword">enable</span></span> traps entity entity_power_out_change <span class="hljs-keyword"><span class="hljs-keyword">no</span></span> snmp-<span class="hljs-keyword"><span class="hljs-keyword">server</span></span> <span class="hljs-keyword"><span class="hljs-keyword">enable</span></span> traps <span class="hljs-keyword"><span class="hljs-keyword">link</span></span> linkDown <span class="hljs-keyword"><span class="hljs-keyword">no</span></span> snmp-<span class="hljs-keyword"><span class="hljs-keyword">server</span></span> <span class="hljs-keyword"><span class="hljs-keyword">enable</span></span> traps <span class="hljs-keyword"><span class="hljs-keyword">link</span></span> linkUp <span class="hljs-keyword"><span class="hljs-keyword">no</span></span> snmp-<span class="hljs-keyword"><span class="hljs-keyword">server</span></span> <span class="hljs-keyword"><span class="hljs-keyword">enable</span></span> traps <span class="hljs-keyword"><span class="hljs-keyword">link</span></span> <span class="hljs-keyword"><span class="hljs-keyword">extended</span></span>-linkDown <span class="hljs-keyword"><span class="hljs-keyword">no</span></span> snmp-<span class="hljs-keyword"><span class="hljs-keyword">server</span></span> <span class="hljs-keyword"><span class="hljs-keyword">enable</span></span> traps <span class="hljs-keyword"><span class="hljs-keyword">link</span></span> <span class="hljs-keyword"><span class="hljs-keyword">extended</span></span>-linkUp <span class="hljs-keyword"><span class="hljs-keyword">no</span></span> snmp-<span class="hljs-keyword"><span class="hljs-keyword">server</span></span> <span class="hljs-keyword"><span class="hljs-keyword">enable</span></span> traps <span class="hljs-keyword"><span class="hljs-keyword">link</span></span> cieLinkDown <span class="hljs-keyword"><span class="hljs-keyword">no</span></span> snmp-<span class="hljs-keyword"><span class="hljs-keyword">server</span></span> <span class="hljs-keyword"><span class="hljs-keyword">enable</span></span> traps <span class="hljs-keyword"><span class="hljs-keyword">link</span></span> cieLinkUp <span class="hljs-keyword"><span class="hljs-keyword">no</span></span> snmp-<span class="hljs-keyword"><span class="hljs-keyword">server</span></span> <span class="hljs-keyword"><span class="hljs-keyword">enable</span></span> traps <span class="hljs-keyword"><span class="hljs-keyword">link</span></span> connUnitPortStatusChange <span class="hljs-keyword"><span class="hljs-keyword">no</span></span> snmp-<span class="hljs-keyword"><span class="hljs-keyword">server</span></span> <span class="hljs-keyword"><span class="hljs-keyword">enable</span></span> traps bfd <span class="hljs-keyword"><span class="hljs-keyword">session</span></span>-up <span class="hljs-keyword"><span class="hljs-keyword">no</span></span> snmp-<span class="hljs-keyword"><span class="hljs-keyword">server</span></span> <span class="hljs-keyword"><span class="hljs-keyword">enable</span></span> traps <span class="hljs-keyword"><span class="hljs-keyword">link</span></span> <span class="hljs-keyword"><span class="hljs-keyword">delayed</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">link</span></span>-state-<span class="hljs-keyword"><span class="hljs-keyword">change</span></span> <span class="hljs-keyword"><span class="hljs-keyword">no</span></span> snmp-<span class="hljs-keyword"><span class="hljs-keyword">server</span></span> <span class="hljs-keyword"><span class="hljs-keyword">enable</span></span> traps bfd <span class="hljs-keyword"><span class="hljs-keyword">session</span></span>-down <span class="hljs-keyword"><span class="hljs-keyword">no</span></span> snmp-<span class="hljs-keyword"><span class="hljs-keyword">server</span></span> <span class="hljs-keyword"><span class="hljs-keyword">enable</span></span> traps rf redundancy_framework <span class="hljs-keyword"><span class="hljs-keyword">no</span></span> snmp-<span class="hljs-keyword"><span class="hljs-keyword">server</span></span> <span class="hljs-keyword"><span class="hljs-keyword">enable</span></span> traps license notify-license-expiry <span class="hljs-keyword"><span class="hljs-keyword">no</span></span> snmp-<span class="hljs-keyword"><span class="hljs-keyword">server</span></span> <span class="hljs-keyword"><span class="hljs-keyword">enable</span></span> traps license notify-<span class="hljs-keyword"><span class="hljs-keyword">no</span></span>-license-<span class="hljs-keyword"><span class="hljs-keyword">for</span></span>-feature <span class="hljs-keyword"><span class="hljs-keyword">no</span></span> snmp-<span class="hljs-keyword"><span class="hljs-keyword">server</span></span> <span class="hljs-keyword"><span class="hljs-keyword">enable</span></span> traps license notify-licensefile-<span class="hljs-keyword"><span class="hljs-keyword">missing</span></span> <span class="hljs-keyword"><span class="hljs-keyword">no</span></span> snmp-<span class="hljs-keyword"><span class="hljs-keyword">server</span></span> <span class="hljs-keyword"><span class="hljs-keyword">enable</span></span> traps license notify-license-expiry-<span class="hljs-keyword"><span class="hljs-keyword">warning</span></span> <span class="hljs-keyword"><span class="hljs-keyword">no</span></span> snmp-<span class="hljs-keyword"><span class="hljs-keyword">server</span></span> <span class="hljs-keyword"><span class="hljs-keyword">enable</span></span> traps <span class="hljs-keyword"><span class="hljs-keyword">upgrade</span></span> UpgradeOpNotifyOnCompletion <span class="hljs-keyword"><span class="hljs-keyword">no</span></span> snmp-<span class="hljs-keyword"><span class="hljs-keyword">server</span></span> <span class="hljs-keyword"><span class="hljs-keyword">enable</span></span> traps <span class="hljs-keyword"><span class="hljs-keyword">upgrade</span></span> UpgradeJobStatusNotify <span class="hljs-keyword"><span class="hljs-keyword">no</span></span> snmp-<span class="hljs-keyword"><span class="hljs-keyword">server</span></span> <span class="hljs-keyword"><span class="hljs-keyword">enable</span></span> traps rmon risingAlarm <span class="hljs-keyword"><span class="hljs-keyword">no</span></span> snmp-<span class="hljs-keyword"><span class="hljs-keyword">server</span></span> <span class="hljs-keyword"><span class="hljs-keyword">enable</span></span> traps rmon fallingAlarm <span class="hljs-keyword"><span class="hljs-keyword">no</span></span> snmp-<span class="hljs-keyword"><span class="hljs-keyword">server</span></span> <span class="hljs-keyword"><span class="hljs-keyword">enable</span></span> traps rmon hcRisingAlarm <span class="hljs-keyword"><span class="hljs-keyword">no</span></span> snmp-<span class="hljs-keyword"><span class="hljs-keyword">server</span></span> <span class="hljs-keyword"><span class="hljs-keyword">enable</span></span> traps rmon hcFallingAlarm <span class="hljs-keyword"><span class="hljs-keyword">no</span></span> snmp-<span class="hljs-keyword"><span class="hljs-keyword">server</span></span> <span class="hljs-keyword"><span class="hljs-keyword">enable</span></span> traps entity entity_sensor <span class="hljs-keyword"><span class="hljs-keyword">no</span></span> snmp-<span class="hljs-keyword"><span class="hljs-keyword">server</span></span> <span class="hljs-keyword"><span class="hljs-keyword">enable</span></span> traps generic coldStart <span class="hljs-keyword"><span class="hljs-keyword">no</span></span> snmp-<span class="hljs-keyword"><span class="hljs-keyword">server</span></span> <span class="hljs-keyword"><span class="hljs-keyword">enable</span></span> traps generic warmStart</code> </pre> <br> 我专门禁用了除OSPF以外的所有TRAP，因此，在诊断为什么某些功能不起作用时，我不必从调试中读取很多不必要的信息。 <br><br> 如何检查TRAP是否有效很简单-您需要破坏一些东西。 我们通过监视在主机上启动嗅探器： <br><br><pre> <code class="hljs pgsql">root@dc-zbx:~# tcpdump -i bond0 udp port <span class="hljs-number"><span class="hljs-number">162</span></span> tcpdump: <span class="hljs-keyword"><span class="hljs-keyword">verbose</span></span> output suppressed, use -v <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> -vv <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> <span class="hljs-keyword"><span class="hljs-keyword">full</span></span> protocol decode listening <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> bond0, link-<span class="hljs-keyword"><span class="hljs-keyword">type</span></span> EN10MB (Ethernet), capture size <span class="hljs-number"><span class="hljs-number">262144</span></span> bytes</code> </pre> <br> 我们发现一个铁生的邻居： <br><br><pre> <code class="hljs pgsql">SW# <span class="hljs-keyword"><span class="hljs-keyword">show</span></span> ip ospf neighbors vrf <span class="hljs-keyword"><span class="hljs-keyword">all</span></span> OSPF Process ID <span class="hljs-number"><span class="hljs-number">10</span></span> VRF <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> Total number <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> neighbors: <span class="hljs-number"><span class="hljs-number">4</span></span> Neighbor ID Pri State Up <span class="hljs-type"><span class="hljs-type">Time</span></span> Address Interface <span class="hljs-number"><span class="hljs-number">192.168</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.242</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FULL</span></span>/ - <span class="hljs-number"><span class="hljs-number">01</span></span>:<span class="hljs-number"><span class="hljs-number">47</span></span>:<span class="hljs-number"><span class="hljs-number">17</span></span> <span class="hljs-number"><span class="hljs-number">172.17</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.10</span></span> Vlan1427 <span class="hljs-number"><span class="hljs-number">192.168</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.222</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FULL</span></span>/ - <span class="hljs-number"><span class="hljs-number">18</span></span>w1d <span class="hljs-number"><span class="hljs-number">172.17</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.6</span></span> Vlan1426 <span class="hljs-number"><span class="hljs-number">192.168</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.149</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FULL</span></span>/ - <span class="hljs-number"><span class="hljs-number">5</span></span>w0d <span class="hljs-number"><span class="hljs-number">172.17</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.30</span></span> Vlan1473 <span class="hljs-number"><span class="hljs-number">192.168</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.146</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FULL</span></span>/ - <span class="hljs-number"><span class="hljs-number">3</span></span>d00h <span class="hljs-number"><span class="hljs-number">172.17</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.58</span></span> Vlan1404 OSPF Process ID <span class="hljs-number"><span class="hljs-number">100</span></span> VRF OSPF100 Total number <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> neighbors: <span class="hljs-number"><span class="hljs-number">4</span></span> Neighbor ID Pri State Up <span class="hljs-type"><span class="hljs-type">Time</span></span> Address Interface <span class="hljs-number"><span class="hljs-number">192.168</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.149</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FULL</span></span>/ - <span class="hljs-number"><span class="hljs-number">5</span></span>w0d <span class="hljs-number"><span class="hljs-number">172.17</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.34</span></span> Vlan1474 <span class="hljs-number"><span class="hljs-number">192.168</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.220</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FULL</span></span>/ - <span class="hljs-number"><span class="hljs-number">13</span></span>w3d <span class="hljs-number"><span class="hljs-number">172.17</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.54</span></span> Vlan1479 <span class="hljs-number"><span class="hljs-number">192.168</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.240</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FULL</span></span>/ - <span class="hljs-number"><span class="hljs-number">13</span></span>w3d <span class="hljs-number"><span class="hljs-number">172.17</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.46</span></span> Vlan1477 <span class="hljs-number"><span class="hljs-number">192.168</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.146</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FULL</span></span>/ - <span class="hljs-number"><span class="hljs-number">3</span></span>d00h <span class="hljs-number"><span class="hljs-number">172.17</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.62</span></span> Vlan1405 OSPF Process ID <span class="hljs-number"><span class="hljs-number">200</span></span> VRF Dia Total number <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> neighbors: <span class="hljs-number"><span class="hljs-number">2</span></span> Neighbor ID Pri State Up <span class="hljs-type"><span class="hljs-type">Time</span></span> Address Interface <span class="hljs-number"><span class="hljs-number">10.65</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.252</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FULL</span></span>/ - <span class="hljs-number"><span class="hljs-number">17</span></span>w2d <span class="hljs-number"><span class="hljs-number">172.17</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.18</span></span> Vlan1450 <span class="hljs-number"><span class="hljs-number">172.17</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.26</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FULL</span></span>/ - <span class="hljs-number"><span class="hljs-number">17</span></span>w0d <span class="hljs-number"><span class="hljs-number">172.17</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.26</span></span> Vlan1452 OSPF Process ID <span class="hljs-number"><span class="hljs-number">216</span></span> VRF Dev Total number <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> neighbors: <span class="hljs-number"><span class="hljs-number">2</span></span> Neighbor ID Pri State Up <span class="hljs-type"><span class="hljs-type">Time</span></span> Address Interface <span class="hljs-number"><span class="hljs-number">10.255</span></span><span class="hljs-number"><span class="hljs-number">.255</span></span><span class="hljs-number"><span class="hljs-number">.94</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FULL</span></span>/ - <span class="hljs-number"><span class="hljs-number">18</span></span>:<span class="hljs-number"><span class="hljs-number">59</span></span>:<span class="hljs-number"><span class="hljs-number">59</span></span> <span class="hljs-number"><span class="hljs-number">10.216</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.73</span></span> Vlan1641 <span class="hljs-number"><span class="hljs-number">10.216</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.82</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FULL</span></span>/ - <span class="hljs-number"><span class="hljs-number">18</span></span>:<span class="hljs-number"><span class="hljs-number">59</span></span>:<span class="hljs-number"><span class="hljs-number">54</span></span> <span class="hljs-number"><span class="hljs-number">10.216</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.82</span></span> Vlan1643</code> </pre><br> 放下一个人 <br><br><pre> <code class="hljs kotlin"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">vlan</span></span></span><span class="hljs-class"> 1643 </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">shutdown</span></span></span></span></code> </pre> <br> 我们在嗅探器中看到： <br><br><pre> <code class="hljs powershell"><span class="hljs-number"><span class="hljs-number">11</span></span>:<span class="hljs-number"><span class="hljs-number">08</span></span>:<span class="hljs-number"><span class="hljs-number">20.001942</span></span> IP <span class="hljs-number"><span class="hljs-number">192.168</span></span>.<span class="hljs-number"><span class="hljs-number">192.169</span></span>.<span class="hljs-number"><span class="hljs-number">22095</span></span> &gt; dc<span class="hljs-literal"><span class="hljs-literal">-zbx</span></span>.example.com.snmp<span class="hljs-literal"><span class="hljs-literal">-trap</span></span>: F=ap U=<span class="hljs-string"><span class="hljs-string">"Zabbix"</span></span> [!<span class="hljs-type"><span class="hljs-type">scoped</span></span> <span class="hljs-type"><span class="hljs-type">PDU</span></span>]<span class="hljs-number"><span class="hljs-number">39</span></span>_d1_7c_19_b3_d9_f8_31_32_8e_c9_39_c2_3a_db_d8_28_26_c6_0b_01_55_b6_fa_5e_f5_38_66_f9_6f_3f_c0_98_cb_57_93_5a_50_8e_50_90_79_f3_9b_ec_ec_d7_9f_e8_ac_f6_fd_79_ac_95_ff_71_73_32_70_52_66_a5_7d_b3_c4_39_d0_1c_7f_a6_38_ea_d7_61_c0_2f_12_ee_db_d9_07_40_8c_a8_48_57_e9_e5_56_12_3f_ec_f9_34_65_09_96_86_f6_d2_93_06_45_fa_95_ea_36_5a_82_2f_30_8f_02_03_59_07_5f_d8_a6_1c_f2_5a_be_7d_09_15_ef_05_00_83_fd_ea_ac_2a_3b_86_0f_86_e5_3b_93_3a_68_6d_33_99_e2_46_2b_9d_6a_1e_5d_9e_d9_93_56_51_5e_ff_9e_77_4c_cb</code> </pre> <br> 如果您没有在嗅探器中看到任何东西，请对其进行诊断，因为否则没有理由继续进行进一步的搜索，您将根本不了解在哪个阶段不适用于您。 <br> 如果手头没有铁片或无法触摸生产，则可以从任何其他汽车产生TRAP，例如，如下所示： <br><br><pre> <code class="hljs powershell">snmptrap <span class="hljs-literal"><span class="hljs-literal">-v</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-literal"><span class="hljs-literal">-c</span></span> neveruseme <span class="hljs-number"><span class="hljs-number">127.0</span></span>.<span class="hljs-number"><span class="hljs-number">0.1</span></span> <span class="hljs-string"><span class="hljs-string">'.1.3.6.1.6.3.1.1.5.3'</span></span> <span class="hljs-string"><span class="hljs-string">'0.0.0.0'</span></span> <span class="hljs-number"><span class="hljs-number">6</span></span> <span class="hljs-number"><span class="hljs-number">33</span></span> <span class="hljs-string"><span class="hljs-string">'55'</span></span> .<span class="hljs-number"><span class="hljs-number">1.3</span></span>.<span class="hljs-number"><span class="hljs-number">6.1</span></span>.<span class="hljs-number"><span class="hljs-number">6.3</span></span>.<span class="hljs-number"><span class="hljs-number">1.1</span></span>.<span class="hljs-number"><span class="hljs-number">5.3</span></span> s <span class="hljs-string"><span class="hljs-string">"teststring000"</span></span> snmptrap <span class="hljs-literal"><span class="hljs-literal">-v3</span></span> <span class="hljs-literal"><span class="hljs-literal">-l</span></span> authPriv <span class="hljs-literal"><span class="hljs-literal">-u</span></span> Zabbix <span class="hljs-literal"><span class="hljs-literal">-a</span></span> SHA <span class="hljs-literal"><span class="hljs-literal">-A</span></span> abyrvalg <span class="hljs-literal"><span class="hljs-literal">-x</span></span> AES <span class="hljs-literal"><span class="hljs-literal">-X</span></span> pechka <span class="hljs-literal"><span class="hljs-literal">-e</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>x8000000001020305 <span class="hljs-number"><span class="hljs-number">192.168</span></span>.<span class="hljs-number"><span class="hljs-number">192.168</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> linkUp.<span class="hljs-number"><span class="hljs-number">0</span></span></code> </pre> <br><h2> 配置SNMPd，SNMPTRAPd，SNMPTT </h2><br> 我们将在系统中需要软件包： <br><br><pre> <code class="hljs powershell">apt install snmp snmp<span class="hljs-literal"><span class="hljs-literal">-mibs</span></span><span class="hljs-literal"><span class="hljs-literal">-downloader</span></span> snmpd snmptrapd snmptt</code> </pre> <br> 我没有关注Perl陷阱接收器，而是出于个人和主观原因选择了SNMPTT。 因此，码头说： <br><br><pre> <code class="hljs markdown"><span class="hljs-bullet"><span class="hljs-bullet">1. </span></span>snmptrapd receives a trap</code> </pre> <br> 必须从其配置开始，而不是立即爬升以在Zabbix面上创建Item。 为什么这样做-您需要遵循TRAP的相同步骤。 在上一节中，我们确保TRAP基本上来自一块铁，现在我们将确保至少它被第一个守护程序snmptrapd接受。  &lt;lyric&gt;我记得很久以前就设置了postfix + dovecot +其他功能。 我闷闷了两周-在那儿，一个恶魔也接受了连接，另一个恶魔解析了这封信，第三个恶魔把它放在了队列中，第四个把它放到了用户的文件夹中，依此类推。 所有这些都是因为我从中间开始，从头开始，从头开始进行调优，但是我必须从telnet到端口25并查看foxer的调试器&lt;/ lyric&gt; <br><br> 我们进入/etc/snmp/snmptrapd.conf并将其删除，但我们会对所有我们不了解和不感兴趣的内容发表评论，只留下一行 <br><br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">disableAuthorization</span></span> <span class="hljs-literal"><span class="hljs-literal">yes</span></span></code> </pre> <br> 停止服务 <br><br><pre> <code class="hljs sql">systemctl <span class="hljs-keyword"><span class="hljs-keyword">stop</span></span> snmptrapd.service</code> </pre> <br> 以手动模式运行 <br><br><pre> <code class="hljs pgsql">root@dc-zbx:~# snmptrapd -f -Lo NET-SNMP <span class="hljs-keyword"><span class="hljs-keyword">version</span></span> <span class="hljs-number"><span class="hljs-number">5.7</span></span><span class="hljs-number"><span class="hljs-number">.3</span></span> AgentX subagent connected NET-SNMP <span class="hljs-keyword"><span class="hljs-keyword">version</span></span> <span class="hljs-number"><span class="hljs-number">5.7</span></span><span class="hljs-number"><span class="hljs-number">.3</span></span></code> </pre> <br> 再次尝试像上面的示例一样中断OSPF，请参阅： <br><br><pre> <code class="hljs powershell"><span class="hljs-number"><span class="hljs-number">2018</span></span><span class="hljs-literal"><span class="hljs-literal">-07</span></span><span class="hljs-literal"><span class="hljs-literal">-20</span></span> <span class="hljs-number"><span class="hljs-number">11</span></span>:<span class="hljs-number"><span class="hljs-number">38</span></span>:<span class="hljs-number"><span class="hljs-number">38</span></span> UNKNOWN [<span class="hljs-type"><span class="hljs-type">UDP</span></span>: [<span class="hljs-number"><span class="hljs-number">192.168</span></span><span class="hljs-type"><span class="hljs-type">.192.169</span></span>]:<span class="hljs-number"><span class="hljs-number">22095</span></span>-&gt;[<span class="hljs-number"><span class="hljs-number">192.168</span></span><span class="hljs-type"><span class="hljs-type">.192.168</span></span>]:<span class="hljs-number"><span class="hljs-number">162</span></span>]: DISMAN<span class="hljs-literal"><span class="hljs-literal">-EVENT</span></span><span class="hljs-literal"><span class="hljs-literal">-MIB</span></span>::sysUpTimeInstance = Timeticks: (<span class="hljs-number"><span class="hljs-number">1355817272</span></span>) <span class="hljs-number"><span class="hljs-number">156</span></span> days, <span class="hljs-number"><span class="hljs-number">22</span></span>:<span class="hljs-number"><span class="hljs-number">09</span></span>:<span class="hljs-number"><span class="hljs-number">32.72</span></span> SNMPv2<span class="hljs-literal"><span class="hljs-literal">-MIB</span></span>::snmpTrapOID.<span class="hljs-number"><span class="hljs-number">0</span></span> = OID: OSPF<span class="hljs-literal"><span class="hljs-literal">-TRAP</span></span><span class="hljs-literal"><span class="hljs-literal">-MIB</span></span>::ospfNbrStateChange OSPF<span class="hljs-literal"><span class="hljs-literal">-MIB</span></span>::ospfRouterId = IpAddress: <span class="hljs-number"><span class="hljs-number">10.216</span></span>.<span class="hljs-number"><span class="hljs-number">0.74</span></span> OSPF<span class="hljs-literal"><span class="hljs-literal">-MIB</span></span>::ospfNbrIpAddr = IpAddress: <span class="hljs-number"><span class="hljs-number">10.216</span></span>.<span class="hljs-number"><span class="hljs-number">0.82</span></span> OSPF<span class="hljs-literal"><span class="hljs-literal">-MIB</span></span>::ospfNbrAddressLessIndex = INTEGER: <span class="hljs-number"><span class="hljs-number">0</span></span> OSPF<span class="hljs-literal"><span class="hljs-literal">-MIB</span></span>::ospfNbrRtrId = IpAddress: <span class="hljs-number"><span class="hljs-number">10.216</span></span>.<span class="hljs-number"><span class="hljs-number">0.82</span></span> OSPF<span class="hljs-literal"><span class="hljs-literal">-MIB</span></span>::ospfNbrState = INTEGER: down(<span class="hljs-number"><span class="hljs-number">1</span></span>)</code> </pre> <br> 如果看不到，那么我们正在寻找原因。 如果要具有相同的优美记录，而不是格式为1.3.6.1.2.1.14.10.1.6的一组OID，请在/etc/snmp/snmp.conf中添加以下内容： <br><br><pre> <code class="hljs powershell">mibs +OSPF<span class="hljs-literal"><span class="hljs-literal">-MIB</span></span> mibs +OSPF<span class="hljs-literal"><span class="hljs-literal">-TRAP</span></span><span class="hljs-literal"><span class="hljs-literal">-MIB</span></span> mibs +OSPFV3<span class="hljs-literal"><span class="hljs-literal">-MIB</span></span> mibdirs +/usr/share/snmp/mibs/ietf/</code> </pre><br> 并扭曲SNMPd <br><br><pre> <code class="hljs pgsql">systemctl <span class="hljs-keyword"><span class="hljs-keyword">restart</span></span> snmpd.service</code> </pre> <br> 有关更详细的信息，请阅读[here]（https://wiki.debian.org/SNMP），以最轻松的方式下载MIB文件并将其提供给SNMPd。 <br><br> 现在，我们加强身份验证，我们再次进入/etc/snmp/snmptrapd.conf <br><br><pre> <code class="hljs vbscript">traphandle <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> snmptthandler #disableAuthorization yes # <span class="hljs-number"><span class="hljs-number">192.168</span></span><span class="hljs-number"><span class="hljs-number">.192</span></span><span class="hljs-number"><span class="hljs-number">.169</span></span> createUser -e <span class="hljs-number"><span class="hljs-number">0x80000009038d604a6a82a3</span></span> Zabbix SHA <span class="hljs-built_in"><span class="hljs-built_in">string</span></span> AES authuser <span class="hljs-built_in"><span class="hljs-built_in">log</span></span>,<span class="hljs-keyword"><span class="hljs-keyword">execute</span></span>,net Zabbix</code> </pre> <br>  -e 0x80000009038d604a6a82a3是engineID，可以在网络硬件上查看： <br><br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">SW</span></span># <span class="hljs-selector-tag"><span class="hljs-selector-tag">sh</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">snmp</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">engineID</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">Local</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">SNMP</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">engineID</span></span>: <span class="hljs-selector-attr"><span class="hljs-selector-attr">[Hex]</span></span> 80000009038<span class="hljs-selector-tag"><span class="hljs-selector-tag">F604D6A82A1</span></span> <span class="hljs-selector-attr"><span class="hljs-selector-attr">[Dec]</span></span> 128<span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:040</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:000</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:109</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:003</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:140</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:096</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:079</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:106</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:131</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:160</span></span></code> </pre> <br> 我们将再次重复该实验，但现在我们仍在进行有关USM的调试： <br><br><pre> <code class="hljs rust">root@dc-zbx:~# snmptrapd -f -Lo -Dusm registered debug token usm, <span class="hljs-number"><span class="hljs-number">1</span></span> usmUser: created a new user Zabbix at <span class="hljs-number"><span class="hljs-number">80</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">09</span></span> <span class="hljs-number"><span class="hljs-number">03</span></span> <span class="hljs-number"><span class="hljs-number">8</span></span>F <span class="hljs-number"><span class="hljs-number">60</span></span> <span class="hljs-number"><span class="hljs-number">4</span></span>F <span class="hljs-number"><span class="hljs-number">6</span></span>B <span class="hljs-number"><span class="hljs-number">82</span></span> A5 NET-SNMP version <span class="hljs-number"><span class="hljs-number">5.7</span></span>.<span class="hljs-number"><span class="hljs-number">3</span></span> AgentX subagent connected NET-SNMP version <span class="hljs-number"><span class="hljs-number">5.7</span></span>.<span class="hljs-number"><span class="hljs-number">3</span></span> usm: USM processing begun... usm: <span class="hljs-keyword"><span class="hljs-keyword">match</span></span> on user Zabbix usm: no <span class="hljs-keyword"><span class="hljs-keyword">match</span></span> on engineID (<span class="hljs-number"><span class="hljs-number">80</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">09</span></span> <span class="hljs-number"><span class="hljs-number">03</span></span> <span class="hljs-number"><span class="hljs-number">8</span></span>F <span class="hljs-number"><span class="hljs-number">60</span></span> <span class="hljs-number"><span class="hljs-number">4</span></span>F <span class="hljs-number"><span class="hljs-number">6</span></span>B <span class="hljs-number"><span class="hljs-number">82</span></span> A5 ) usm: <span class="hljs-keyword"><span class="hljs-keyword">match</span></span> on user Zabbix usm: Verification succeeded. usm: USM processing completed. <span class="hljs-number"><span class="hljs-number">2018</span></span>-<span class="hljs-number"><span class="hljs-number">07</span></span>-<span class="hljs-number"><span class="hljs-number">20</span></span> <span class="hljs-number"><span class="hljs-number">11</span></span>:<span class="hljs-number"><span class="hljs-number">50</span></span>:<span class="hljs-number"><span class="hljs-number">07</span></span> UNKNOWN [UDP: [<span class="hljs-number"><span class="hljs-number">192.168</span></span>.<span class="hljs-number"><span class="hljs-number">192.169</span></span>]:<span class="hljs-number"><span class="hljs-number">22095</span></span>-&gt;[<span class="hljs-number"><span class="hljs-number">192.168</span></span>.<span class="hljs-number"><span class="hljs-number">192.168</span></span>]:<span class="hljs-number"><span class="hljs-number">162</span></span>]: DISMAN-EVENT-MIB::sysUpTimeInstance = Timeticks: (<span class="hljs-number"><span class="hljs-number">1355886163</span></span>) <span class="hljs-number"><span class="hljs-number">156</span></span> days, <span class="hljs-number"><span class="hljs-number">22</span></span>:<span class="hljs-number"><span class="hljs-number">21</span></span>:<span class="hljs-number"><span class="hljs-number">01.63</span></span> SNMPv2-MIB::snmpTrapOID.<span class="hljs-number"><span class="hljs-number">0</span></span> = OID: OSPF-TRAP-MIB::ospfNbrStateChange OSPF-MIB::ospfRouterId = IpAddress: <span class="hljs-number"><span class="hljs-number">10.216</span></span>.<span class="hljs-number"><span class="hljs-number">0.74</span></span> OSPF-MIB::ospfNbrIpAddr = IpAddress: <span class="hljs-number"><span class="hljs-number">10.216</span></span>.<span class="hljs-number"><span class="hljs-number">0.82</span></span> OSPF-MIB::ospfNbrAddressLessIndex = INTEGER: <span class="hljs-number"><span class="hljs-number">0</span></span> OSPF-MIB::ospfNbrRtrId = IpAddress: <span class="hljs-number"><span class="hljs-number">10.216</span></span>.<span class="hljs-number"><span class="hljs-number">0.82</span></span> OSPF-MIB::ospfNbrState = INTEGER: down(<span class="hljs-number"><span class="hljs-number">1</span></span>)</code> </pre> <br> 如果在此阶段在调试中看到授权错误，请仔细检查engineID并确保在硬件上创建的用户与我们在/etc/snmp/snmptrapd.conf配置中绘制的用户匹配。 顺便说一句，是的，对于每块铁片，您都必须使用自己的engineID创建自己的用户，或者，如果铁片允许这样做，则用手在所有铁片上使其相同。 <br><br> 我可以在调试中看到这一行： <br><br><pre> <code class="hljs pgsql">usm: <span class="hljs-keyword"><span class="hljs-keyword">no</span></span> match <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> engineID (<span class="hljs-number"><span class="hljs-number">80</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">09</span></span> <span class="hljs-number"><span class="hljs-number">03</span></span> <span class="hljs-number"><span class="hljs-number">8</span></span>F <span class="hljs-number"><span class="hljs-number">60</span></span> <span class="hljs-number"><span class="hljs-number">4</span></span>F <span class="hljs-number"><span class="hljs-number">6</span></span>B <span class="hljs-number"><span class="hljs-number">82</span></span> A5 )</code> </pre> <br> 我为什么不明白，尽管TRAP已被接受并需要进一步处理。 如果您知道我做错了，请发表评论。 <br><br> 现在，我们使用SNMPTT-它具有两个ini和conf配置。 在第一个中，我们确定守护程序本身的参数，在第二个中，我们确定用于接收和处理每个特定阶梯的参数。 <br><br> 我们进入/etc/snmp/snmptt.ini文件并绘制以下内容： <br><br><pre> <code class="hljs perl">mode = daemon net_snmp_perl_enable = <span class="hljs-number"><span class="hljs-number">1</span></span> date_time_format = %Y %m %d %H:%M:%S</code> </pre> <br> 日期和时间的格式与业务有关；最重要的是，到处都使用相同的格式。 <br><br><pre> <code class="hljs pgsql">log_file = /var/<span class="hljs-keyword"><span class="hljs-keyword">log</span></span>/snmptt/snmptt.<span class="hljs-keyword"><span class="hljs-keyword">log</span></span> log_system_file = /var/<span class="hljs-keyword"><span class="hljs-keyword">log</span></span>/snmptt/snmpttsystem.<span class="hljs-keyword"><span class="hljs-keyword">log</span></span> unknown_trap_log_enable = <span class="hljs-number"><span class="hljs-number">1</span></span> unknown_trap_log_file = /var/<span class="hljs-keyword"><span class="hljs-keyword">log</span></span>/snmptt/snmpttunknown.<span class="hljs-keyword"><span class="hljs-keyword">log</span></span></code> </pre> <br> 为什么日志与Internet上许多文章中的日志不同？ 因为<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">扩展坞</a>说：“如果使用systemd参数PrivateTmp，则该文件不太可能在/ tmp中工作。”，如果事先警告，我不想再次进入rake，因此，我将立即更改为该文件的常规路径。 <br><br> 接下来，转到/etc/snmp/snmptt.conf，删除我们不需要和/或不理解的所有内容，仅保留以下内容： <br><br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">EVENT</span></span> ospfNbrStateChange .<span class="hljs-number"><span class="hljs-number">1.3.6.1</span></span>.<span class="hljs-number"><span class="hljs-number">2.1.14.16</span></span>.<span class="hljs-number"><span class="hljs-number">2</span></span>.<span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-string"><span class="hljs-string">"OSPF"</span></span> Normal FORMAT ZBXTRAP <span class="hljs-variable"><span class="hljs-variable">$aA</span></span> OSPF neighbor with IP addr <span class="hljs-variable"><span class="hljs-variable">$2</span></span> changed state to <span class="hljs-variable"><span class="hljs-variable">$5</span></span></code> </pre> <br> 采用这种形式，因为Zabbix期望日志中具有这种格式。  $ 2和$ 5的来源，您可以了解一下<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">TRAP消息格式</a> ，请看： <br><br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">Object</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">ospfNbrStateChange</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">OID</span></span> 1<span class="hljs-selector-class"><span class="hljs-selector-class">.3</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.6</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.2</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.14</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.16</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.2</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.2</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">MIB</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">OSPF-TRAP-MIB</span></span> ; <span class="hljs-selector-tag"><span class="hljs-selector-tag">Trap</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">Components</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">ospfRouterId</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">ospfNbrIpAddr</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">ospfNbrAddressLessIndex</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">ospfNbrRtrId</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">ospfNbrState</span></span></code> </pre> <br> 这些陷阱组件是可以按$ 1，$ 2 ...的顺序推入日志格式的参数。 <br><br> 在所有这些内容的摊牌过程中，我注意到更改SNMPTT设置后，好像没有应用更改。 事实证明，在进行更改之后，有必要不重新启动snmptt.serivce，而是重新启动snmpd.service-这种细微差别在调试过程中像样地吸了我的血，喝了我的神经。 <br><br> 检查您是否正在运行所有守护程序： <br><br><pre> <code class="hljs lua">systemctl <span class="hljs-built_in"><span class="hljs-built_in">status</span></span> snmpd snmptrapd snmptt</code> </pre> <br> 如果一切正常，请再次尝试破坏OSPF并转到日志/var/log/snmptt/snmptt.log，它将看起来像这样： <br><br><pre> <code class="hljs css">2018 07 19 15<span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:10</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:52</span></span> <span class="hljs-selector-class"><span class="hljs-selector-class">.1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.3</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.6</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.2</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.14</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.16</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.2</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.2</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">Normal</span></span> "<span class="hljs-selector-tag"><span class="hljs-selector-tag">OSPF</span></span>" 192<span class="hljs-selector-class"><span class="hljs-selector-class">.168</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.192</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.169</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">ZBXTRAP</span></span> 192<span class="hljs-selector-class"><span class="hljs-selector-class">.168</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.192</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.169</span></span> 192<span class="hljs-selector-class"><span class="hljs-selector-class">.168</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.192</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.169</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">OSPF</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">neighbor</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">with</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">IP</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">addr</span></span> 10<span class="hljs-selector-class"><span class="hljs-selector-class">.216</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.82</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">changed</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">state</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">to</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">down</span></span> 2018 07 19 15<span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:12</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:28</span></span> <span class="hljs-selector-class"><span class="hljs-selector-class">.1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.3</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.6</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.2</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.14</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.16</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.2</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.2</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">Normal</span></span> "<span class="hljs-selector-tag"><span class="hljs-selector-tag">OSPF</span></span>" 192<span class="hljs-selector-class"><span class="hljs-selector-class">.168</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.192</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.169</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">ZBXTRAP</span></span> 192<span class="hljs-selector-class"><span class="hljs-selector-class">.168</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.192</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.169</span></span> 192<span class="hljs-selector-class"><span class="hljs-selector-class">.168</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.192</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.169</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">OSPF</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">neighbor</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">with</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">IP</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">addr</span></span> 10<span class="hljs-selector-class"><span class="hljs-selector-class">.216</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.82</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">changed</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">state</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">to</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">exchangeStart</span></span> 2018 07 19 15<span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:12</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:34</span></span> <span class="hljs-selector-class"><span class="hljs-selector-class">.1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.3</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.6</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.2</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.14</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.16</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.2</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.2</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">Normal</span></span> "<span class="hljs-selector-tag"><span class="hljs-selector-tag">OSPF</span></span>" 192<span class="hljs-selector-class"><span class="hljs-selector-class">.168</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.192</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.169</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">ZBXTRAP</span></span> 192<span class="hljs-selector-class"><span class="hljs-selector-class">.168</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.192</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.169</span></span> 192<span class="hljs-selector-class"><span class="hljs-selector-class">.168</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.192</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.169</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">OSPF</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">neighbor</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">with</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">IP</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">addr</span></span> 10<span class="hljs-selector-class"><span class="hljs-selector-class">.216</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.82</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">changed</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">state</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">to</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">full</span></span> 2018 07 19 15<span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:22</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:41</span></span> <span class="hljs-selector-class"><span class="hljs-selector-class">.1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.3</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.6</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.2</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.14</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.16</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.2</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.2</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">Normal</span></span> "<span class="hljs-selector-tag"><span class="hljs-selector-tag">OSPF</span></span>" 192<span class="hljs-selector-class"><span class="hljs-selector-class">.168</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.192</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.169</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">ZBXTRAP</span></span> 192<span class="hljs-selector-class"><span class="hljs-selector-class">.168</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.192</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.169</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">OSPF</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">neighbor</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">with</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">IP</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">addr</span></span> 10<span class="hljs-selector-class"><span class="hljs-selector-class">.216</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.82</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">changed</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">state</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">to</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">down</span></span> 2018 07 19 15<span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:25</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:38</span></span> <span class="hljs-selector-class"><span class="hljs-selector-class">.1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.3</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.6</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.2</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.14</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.16</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.2</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.2</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">Normal</span></span> "<span class="hljs-selector-tag"><span class="hljs-selector-tag">OSPF</span></span>" 192<span class="hljs-selector-class"><span class="hljs-selector-class">.168</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.192</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.169</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">ZBXTRAP</span></span> 192<span class="hljs-selector-class"><span class="hljs-selector-class">.168</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.192</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.169</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">OSPF</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">neighbor</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">with</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">IP</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">addr</span></span> 10<span class="hljs-selector-class"><span class="hljs-selector-class">.216</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.82</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">changed</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">state</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">to</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">exchangeStart</span></span></code> </pre> <br> 我们未在/etc/snmp/snmptt.conf配置中配置的那些TRAP将转到/var/log/snmptt/snmpttunknown.log日志，但只会从在同一配置中为其配置了正确用户和engineID的硬件进入。 也就是说，TRAP将从左腺体默默地掉落，如果您想进行口头汇报和汇报，那么您在net-snmp上有一个异常健壮的基座，TRAP和INFORM之间的区别在那里仍然很好地描述了，展望未来，最好使用INFORM等。 k。那里有某种传递控制，但是它通过UDP而不是UDP起作用。 <br><br> 而且只有现在，我们才开始配置显示器。 <br><br><h2>  Zabbix设定 </h2><br><br> 首先，确保在/etc/zabbix/zabbix_server.conf配置中，将监视设置为正确的SNMPTT日志，并且Zabbix本身启动至少一个SNMP陷阱程序： <br><br> <code>SNMPTrapperFile=/var/log/snmptt/snmptt.log <br> StartSNMPTrapper=1</code> <br> <br> 首先，我直接在主机上创建了Item，以便更快，更轻松地捕捉特效。在这里，我将立即编写如何创建模板的方法，因为只要有可能，就应该使用模板。 我将为您展示图片，复制粘贴免费赠品已经结束，但我会绘制您需要注意的地方。 <br><br> 创建一个模板： <br><br><img src="https://habrastorage.org/webt/h_/ne/mw/h_nemwwcsrjzr1dvlqimgrmsq5e.png" alt="图片"><br><br> 在这里，我们给一个理智的名字 <br><br> 创建项目 <br><br><img src="https://habrastorage.org/webt/-c/hz/8k/-chz8klwqft17k391xp7epqusfs.png" alt="图片"><br><br> 重要-关键应该是这样，方括号中显示的是Zabbix将在日志中查找的内容，我们在/etc/snmp/snmptt.conf中配置了日志格式，并在其中写道： <br><br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">EVENT</span></span> ospfNbrStateChange .<span class="hljs-number"><span class="hljs-number">1.3.6.1</span></span>.<span class="hljs-number"><span class="hljs-number">2.1.14.16</span></span>.<span class="hljs-number"><span class="hljs-number">2</span></span>.<span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-string"><span class="hljs-string">"OSPF"</span></span> Normal FORMAT ZBXTRAP <span class="hljs-variable"><span class="hljs-variable">$aA</span></span> OSPF neighbor with IP addr <span class="hljs-variable"><span class="hljs-variable">$2</span></span> changed state to <span class="hljs-variable"><span class="hljs-variable">$5</span></span></code> </pre> <br> 实际上，在日志中，这是一个神奇的词“ OSPF”，并显示： <br><br><pre> <code class="hljs css">2018 07 19 15<span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:25</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:38</span></span> <span class="hljs-selector-class"><span class="hljs-selector-class">.1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.3</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.6</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.2</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.14</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.16</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.2</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.2</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">Normal</span></span> "<span class="hljs-selector-tag"><span class="hljs-selector-tag">OSPF</span></span>" 192<span class="hljs-selector-class"><span class="hljs-selector-class">.168</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.192</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.169</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">ZBXTRAP</span></span> 192<span class="hljs-selector-class"><span class="hljs-selector-class">.168</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.192</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.169</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">OSPF</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">neighbor</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">with</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">IP</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">addr</span></span> 10<span class="hljs-selector-class"><span class="hljs-selector-class">.216</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.82</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">changed</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">state</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">to</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">exchangeStart</span></span></code> </pre> <br> 我们在/etc/snmp/snmptt.ini配置中定义的日期格式： <br><br><pre> <code class="hljs perl">date_time_format = %Y %m %d %H:%M:%S</code> </pre> <br> 我在上面写的内容-使用对您方便的任何格式，主要是要在正确的位置进行匹配。 <br><br> 创建触发器 <br><br><img src="https://habrastorage.org/webt/7q/ci/b4/7qcib4j6sxnym61nykigci8gyac.png" alt="图片"><br><br> 邻居可能有几种<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">状态</a> ： <br><br><pre> <code class="hljs swift"><span class="hljs-number"><span class="hljs-number">1</span></span> : down <span class="hljs-number"><span class="hljs-number">2</span></span> : attempt <span class="hljs-number"><span class="hljs-number">3</span></span> : <span class="hljs-keyword"><span class="hljs-keyword">init</span></span> <span class="hljs-number"><span class="hljs-number">4</span></span> : twoWay <span class="hljs-number"><span class="hljs-number">5</span></span> : exchangeStart <span class="hljs-number"><span class="hljs-number">6</span></span> : exchange <span class="hljs-number"><span class="hljs-number">7</span></span> : loading <span class="hljs-number"><span class="hljs-number">8</span></span> : full</code> </pre> <br> 邻居所处的状态完全不重要，如果此状态不是FULL，因为要进行诊断，您仍然必须动手，阅读日志，输入一些命令。 因此，触发器将是一个触发器，并且仅当在TRAP中邻居的状态不是FULL时才会被激发。 <br><br> 在将模板挂在特定主机上之前，请确保为主机配置了具有正确IP地址的正确SNMP接口，否则梯形图将位于/var/log/snmptt/snmptt.log日志中，但是Zabbix不会将它们“绑定”到主机上。 在这种情况下，在服务器/var/log/zabbix/zabbix_server.log的Zabbix日志中，将出现以下形式的消息： <br><br><pre> <code class="hljs css">19972<span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:20180720</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:091722.896</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">unmatched</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">trap</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">received</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">from</span></span> "192<span class="hljs-selector-class"><span class="hljs-selector-class">.168</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.192</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.169</span></span>": 2018 07 20 09<span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:17</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:21</span></span> <span class="hljs-selector-class"><span class="hljs-selector-class">.1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.3</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.6</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.2</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.14</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.16</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.2</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.2</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">Normal</span></span> "<span class="hljs-selector-tag"><span class="hljs-selector-tag">OSPF</span></span>" 192<span class="hljs-selector-class"><span class="hljs-selector-class">.168</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.192</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.169</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">OSPF</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">neighbor</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">with</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">IP</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">addr</span></span> 10<span class="hljs-selector-class"><span class="hljs-selector-class">.64</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.10</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">changed</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">state</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">to</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">exchangeStart</span></span></code> </pre> <br><br> 转到最新数据，请参见 <br><br><img src="https://habrastorage.org/webt/pu/gj/w9/pugjw9j9ccjdnkj6x50trsfqeoc.png" alt="图片"><br><br> 扳机也起作用 <br><br><img src="https://habrastorage.org/webt/fm/wc/gp/fmwcgp5pjammodrcqjsrj3zpebe.png" alt="图片"><br><br> 现在放两个邻居 <br><br><img src="https://habrastorage.org/webt/7e/uh/d5/7euhd5pegn-7b_6ofpxmbctzt8c.png" alt="图片"><br><br> 在仪表板中，我们看到发生了两个问题，这很好，甚至在配置了通知的情况下，即使有两个字母也会到达此主题。 <br><br> 一切都很棒，一切正常，这是最后的蛋糕。 <br><br><div class="spoiler">  <b class="spoiler_title">绝望</b> <div class="spoiler_text"> 现在，我们要抚养一个邻居。 同时，这两个问题将立即在仪表板上消失。 这不是错误，而是功能。 测试模板时，我不小心注意到了这种细微差别。 结果，如果几个邻居掉下来，然后其中一个邻居升起，或者即使一个邻居升起了（以前根本不存在），则监视将变为绿色。 <br> 当然，您可以用手配置Item来跟踪特定的邻居，仍然可以编写一些脚本，还可以从本文的开头返回SNMP上下文。 还有一种想法是绘制一个脚本，该脚本将通过SSH / API传递到网络腺体，收集有关所有邻居的信息，进行“有效”转换，分析检查之间的差异，并在日志中写错什么，然后将日志馈送到监视器……这很困难。 我想要最少的拐杖和习俗。 如果您知道解决此问题的明智方法，或者认为我做错了所有事情，请再次在评论中询问，而在响应文章中询问。 <br></div></div><br><br>  UPD：我们的同事建议我们进行排序，并尝试使用<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">SNMP上下文</a>实施我们的计划。 有需求，就会有供应。 展望未来，我可以说-魔鬼并不那么可怕，我们走吧。 <br> 在一块铁网上，我们绘制了一条神奇的命令： <br><br> <code>snmp-server context {snmp context name} instance {protocol instance} vrf {vrf name}</code> <br> <br> 参数名称需要澄清 <br>  {snmp上下文名称}-将在请求中使用的SNMP上下文的名称。 <br> 我们从已配置的OSPF进程的配置中获取{protocol instance}和{vrf name}： <br><br> <code>router ospf {protocol instance} <br> .. <br> vrf {vrf name} <br> ..</code> <br> <br> 有人担心在进行了这样的设置后，我们将使用空上下文通过SNMP破坏已经配置的项，但是我检查了该设置仅影响通过OSPF-MIB的数据输出，而例如从IF-MIB部分中，所有内容都像以前一样使用空上下文继续返回。 如果您没有Nexus，建议您再次检查这一点-行为可能会有所不同。 <br><br> 现在在Zabbix中扭曲模板。 <br> 您必须使用上下文创建新的发现规则： <br><br><img src="https://habrastorage.org/webt/by/xd/ph/byxdpha64kwdstjxoipfjr3avl0.png" alt="图片"><br><br> 新项目原型也具有上下文 <br><br><img src="https://habrastorage.org/webt/oy/e1/2x/oye12xxe-ec-ohifymjb-zizpom.png" alt="图片"><br><br> 还有两个触发器（第一个触发器），用于在邻居处于除FULL之外的任何状态时发出的警报： <br><br><img src="https://habrastorage.org/webt/rj/gs/os/rjgsosmcwivhwhxjtnjheyymhza.png" alt="图片"><br><br> 第二个-如果邻居不见了： <br><br><img src="https://habrastorage.org/webt/sb/cx/i3/sbcxi3qrz-d-c82vyk_khmaw6im.png" alt="图片"></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN417813/">https://habr.com/ru/post/zh-CN417813/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN417795/index.html">我十几岁对电子游戏的痴迷不是“游戏障碍”</a></li>
<li><a href="../zh-CN417797/index.html">NASA项目违反截止日期并夸大预算的4个原因</a></li>
<li><a href="../zh-CN417801/index.html">封锁电报后我如何搬到以色列</a></li>
<li><a href="../zh-CN417803/index.html">Blender中的批量照片处理</a></li>
<li><a href="../zh-CN417809/index.html">AI，实践课程。 用于图像分类的现代深度神经网络架构</a></li>
<li><a href="../zh-CN417821/index.html">网络摘要：20种有关协议，标准和信息安全的专家材料</a></li>
<li><a href="../zh-CN417823/index.html">新一代：全球首个商用5G网络启动</a></li>
<li><a href="../zh-CN417825/index.html">“扩展边界”：6 GHz范围将满足Wi-Fi的需求</a></li>
<li><a href="../zh-CN417827/index.html">免费Wi-Fi：德国法院废除了咖啡馆侵犯顾客版权的惩罚措施</a></li>
<li><a href="../zh-CN417829/index.html">将架构的层数从5减少到2</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>