<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üöî üëÉüèø üö£ Millionen Videoanrufe pro Tag oder "Call Mom!" üåû ‚òùüèø üßïüèº</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Aus Sicht des Benutzers sehen die Anrufdienste ziemlich einfach aus: Sie gehen zu einem anderen Benutzer auf die Seite, Sie rufen an, er nimmt den H√∂r...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Millionen Videoanrufe pro Tag oder "Call Mom!"</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/odnoklassniki/blog/428217/">  Aus Sicht des Benutzers sehen die Anrufdienste ziemlich einfach aus: Sie gehen zu einem anderen Benutzer auf die Seite, Sie rufen an, er nimmt den H√∂rer ab, Sie sprechen mit ihm.  Drau√üen scheint alles einfach zu sein, aber nur wenige wissen, wie man einen solchen Service macht.  Aber Alexander Tobol ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" class="user_link">alatobol</a> ) wei√ü nicht nur Bescheid, sondern teilt auch <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" class="user_link">gerne</a> seine Erfahrungen. <br><br><img src="https://habrastorage.org/webt/rq/un/cx/rquncxhtqvyydpdbneoatkwfvke.jpeg"><br><br>  Weiter die Textversion des Berichts √ºber HighLoad ++ Sibirien, aus der Sie lernen werden: <br><br><ul><li>  wie Videoanrufdienste unter der Haube funktionieren; </li><li>  Wie sch√∂n es ist, NAT zu durchbrechen - dies wird f√ºr Spielspezialisten interessant sein, die eine Peer-to-Peer-Verbindung ben√∂tigen. </li><li>  wie WebRTC funktioniert, welche Protokolle es enth√§lt; </li><li>  Wie kann ich WebRTC √ºber BigData optimieren? </li></ul><br><iframe width="560" height="315" src="https://www.youtube.com/embed/MnEXuKHjIOU" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br>  <strong>√úber den Sprecher:</strong> Alexander Tobol leitet die Entwicklung der Video- und Tape-Plattformen bei ok.ru. <br><a name="habracut"></a><br><h2>  Videoanrufverlauf <br></h2><br>  Das erste Videoanrufger√§t erschien 1960, es wurde als Picherphone bezeichnet, verwendete dedizierte Netzwerke und war extrem teuer.  Im Jahr 2006 f√ºgte Skype seiner Anwendung Videoanrufe hinzu.  Im Jahr 2010 unterst√ºtzte Flash das RTMFP-Protokoll, und wir von Odnoklassniki starteten Flash-Videoanrufe.  Im Jahr 2016 hat Chrome die Unterst√ºtzung von Flash eingestellt, und im August 2017 haben wir Anrufe mit der neuen Technologie neu gestartet, √ºber die ich heute sprechen werde.  Nach Abschluss des Dienstes erhielten wir f√ºr weitere sechs Monate einen deutlichen Anstieg der erfolgreich abgeschlossenen Anrufe.  In letzter Zeit haben wir auch Masken in Anrufen. <br><img src="https://habrastorage.org/webt/kn/9u/uy/kn9uuyg18yggcfabvmzgs-cfygg.jpeg"><br><br><h2>  Architektur und TK <br></h2><br>  Da wir in einem sozialen Netzwerk arbeiten, haben wir keine technischen Aufgaben und wissen nicht, was TK ist.  Normalerweise passt die ganze Idee auf eine Seite und sieht ungef√§hr so ‚Äã‚Äãaus. <br><img src="https://habrastorage.org/webt/qf/9x/ju/qf9xjum4vvjczd3-momvzhht9cw.jpeg"><br><br>  Der Benutzer m√∂chte andere Benutzer √ºber eine Web- oder iOS / Android-Anwendung anrufen.  Ein anderer Benutzer kann mehrere Ger√§te haben.  Der Anruf kommt an alle Ger√§te, der Benutzer nimmt das Telefon auf einem von ihnen ab, sie sprechen.  Alles ist einfach. <br><br><h2>  Technische Eigenschaften <br></h2><br>  Um einen qualitativ hochwertigen Anrufservice durchf√ºhren zu k√∂nnen, m√ºssen wir verstehen, welche Merkmale wir verfolgen m√∂chten.  Wir haben uns entschlossen, zun√§chst zu suchen, was den Benutzer am meisten st√∂rt. <br><br>  Der Benutzer ist definitiv ver√§rgert, wenn er den H√∂rer abhebt und warten muss, bis die Verbindung hergestellt ist. <br><img src="https://habrastorage.org/webt/8g/kk/qb/8gkkqbq6ioqxnn0ro6dcq9kwhno.jpeg"><br><br>  Der Benutzer ist ver√§rgert, wenn die Anrufqualit√§t schlecht ist - etwas wird unterbrochen, das Video wird gestreut, der Ton sprudelt. <br><img src="https://habrastorage.org/webt/2l/rt/ud/2lrtudpp-tw5cjsknhzamgj--pi.jpeg"><br><br>  Vor allem aber √§rgert sich der Benutzer √ºber die Verz√∂gerung bei Anrufen.  Die Latenz ist eines der wichtigen Merkmale von Anrufen.  Bei einer Latenz in einem Gespr√§ch in der Gr√∂√üenordnung von 5 Sekunden ist es absolut unm√∂glich, einen Dialog zu f√ºhren. <br><img src="https://habrastorage.org/webt/z-/tn/lf/z-tnlfghw6laz3j25e3kbwob9mi.jpeg"><br><br>  Wir haben f√ºr uns akzeptable Eigenschaften festgestellt: <br><br><ul><li>  <strong>Start</strong> - wir haben beschlossen, dass es gut ist, den Anruf in einer Sekunde zu starten.  Das hei√üt,  Das Verbinden, nachdem der Benutzer geantwortet hat, sollte nicht l√§nger als 1 Sekunde dauern. </li><li>  <strong>Qualit√§t</strong> ist ein sehr subjektiver Indikator.  Sie k√∂nnen beispielsweise das Signal-Rausch-Verh√§ltnis (SNR) messen, es fehlen jedoch noch Frames und andere Artefakte.  Wir haben die Qualit√§t eher subjektiv gemessen und dann die Zufriedenheit der Benutzer bewertet. </li><li>  <strong>Die Latenz</strong> sollte weniger als 0,5 Sekunden <strong>betragen</strong> .  Wenn die Latenz l√§nger als 0,5 Sekunden ist, h√∂ren Sie bereits Verz√∂gerungen und beginnen sich gegenseitig zu unterbrechen. </li></ul><br><img src="https://habrastorage.org/webt/cl/yx/j0/clyxj0ajsqq5coamt5orttz-kxc.jpeg"><br><br>  Polycom ist ein Konferenzsystem, das in unseren B√ºros installiert wird.  Wir haben durchschnittliche Polycom-Latenzen in der Gr√∂√üenordnung von 1,3 Sekunden.  Mit einer solchen Verz√∂gerung verstehen Sie sich nicht immer.  Wenn sich die Verz√∂gerung auf 2 Sekunden erh√∂ht, ist kein Dialog m√∂glich. <br><img src="https://habrastorage.org/webt/3_/yy/qq/3_yyqqbvvq5zoavfa5q9tzvqhiq.jpeg"><br><br>  Da wir die Plattform bereits gestartet hatten, erwarteten wir ungef√§hr eine Million Anrufe pro Tag.  Dies sind tausend Anrufe parallel.  Wenn alle Anrufe √ºber den Server gestartet werden, werden pro Anruf tausend Megabit-Anrufe get√§tigt.  Dies ist nur 1 Gigabit / Sek. Ein Eisenserver wird ausreichen. <br><br><h2>  Internet gegen TTX <br></h2><br>  Was kann Sie daran hindern, solch coole Funktionen zu erreichen?  Das Internet! <br><img src="https://habrastorage.org/webt/qb/aq/sy/qbaqsyfaf6vln4e882armfugx1g.jpeg"><br><br>  Im Internet gibt es solche Dinge wie Roundtrip Time (RTT), die nicht √ºberwunden werden k√∂nnen, es gibt eine variable Bandbreite, es gibt NAT. <br><br>  Zuvor haben wir die √úbertragungsgeschwindigkeit in den Netzen unserer Benutzer gemessen. <br><img src="https://habrastorage.org/webt/bm/ge/z6/bmgez6efih7z_lqwidcknso8edw.jpeg"><br><br>  Wir haben es nach Art der Verbindung aufgeschl√ºsselt, die durchschnittliche RTT, den Paketverlust und die Geschwindigkeit untersucht und beschlossen, die Anrufe anhand der Durchschnittswerte jedes dieser Netzwerke zu testen. <br><img src="https://habrastorage.org/webt/ui/o4/k8/uio4k8pmxmyxyclfwwawehqijes.jpeg"><br><br>  Es gibt andere Probleme im Internet: <br><br><ul><li>  <strong>Paketverlust</strong> - Wir haben einen zuf√§lligen Paketverlust von 0,6% gemessen (wir ber√ºcksichtigen den Paketverlust bei √úberlastung bei einer √ºberm√§√üigen Anzahl von Paketen nicht). </li><li>  <strong>Neuordnung</strong> - Sie senden Pakete in derselben Reihenfolge und das Netzwerk sortiert sie neu. </li><li>  <strong>Jitter</strong> - Senden Sie in einem bestimmten Intervall einen Video- oder Audiostream, und Pakete werden auf der Clientseite zu B√ºndeln zusammengefasst, z. B. aufgrund der Pufferung auf Netzwerkger√§ten. </li><li>  <strong>NAT</strong> - Es stellte sich heraus, dass mehr als 97% der Benutzer hinter NAT stehen.  Wir werden dar√ºber sprechen, warum, was und wie. </li></ul><br><img src="https://habrastorage.org/webt/z_/uo/mc/z_uomck64smc12_beaupdnutgp4.jpeg"><br><br>  Betrachten Sie die oben aufgef√ºhrten Netzwerkeinstellungen anhand eines einfachen Beispiels. <br><br>  Ich habe die Website der Staatlichen Universit√§t Nowosibirsk von meinem B√ºro aus durchgesehen und so einen seltsamen Ping bekommen. <br><img src="https://habrastorage.org/webt/wi/am/at/wiamatloo1eviw58g3zgzbrsc2e.jpeg"><br><br>  Der durchschnittliche Jitter in diesem Beispiel betr√§gt 30 ms, dh das durchschnittliche Intervall zwischen benachbarten Ping-Zeiten betr√§gt etwa 30 ms und der durchschnittliche Ping betr√§gt 105 ms. <br><br>  Was ist bei Anrufen wichtig, warum werden wir f√ºr p2p k√§mpfen? <br><img src="https://habrastorage.org/webt/gb/ny/yx/gbnyyxij20hrfo96scwubxdzovu.jpeg"><br><br>  Wenn es uns gelingt, eine P2P-Verbindung zwischen unseren Benutzern herzustellen, die versuchen, in St. Petersburg miteinander zu kommunizieren, anstatt √ºber einen Server in Nowosibirsk, sparen wir nat√ºrlich etwa 100 ms Hin- und R√ºckfahrt und Datenverkehr zu diesem Dienst. <br><br>  Daher widmet sich der gr√∂√üte Teil des Artikels der Herstellung von gutem P2P. <br><br><h2>  Geschichte oder Erbe <br></h2><br>  Wie gesagt, wir haben seit 2010 einen Anrufdienst und jetzt haben wir ihn neu gestartet. <br><img src="https://habrastorage.org/webt/si/ru/lu/sirulur_jaalnldpkmvbjx7ct-q.jpeg"><br><br>  Im Jahr 2006, als Skype startete, kaufte Flash Amicima, das RTMFP herstellte.  Flash hatte bereits RTMP, das im Prinzip f√ºr Anrufe verwendet werden kann, und es wird h√§ufig f√ºr das Streaming verwendet.  Flash √∂ffnete sp√§ter die RTMP-Spezifikation.  Ich frage mich, warum sie RTMFP brauchten?  Im Jahr 2010 haben wir RTMFP verwendet. <br><br>  Vergleichen Sie die Anforderungen f√ºr Anrufprotokolle und echte Streaming-Protokolle und sehen Sie, wo sich diese Grenze befindet. <br><img src="https://habrastorage.org/webt/ih/j9/xi/ihj9xiris6praclbyxpxelwc1i4.jpeg"><br><br>  <strong>RTMP</strong> ist eher ein Video-Streaming-Protokoll.  Es verwendet TCP, es hat kumulative Verz√∂gerung.  Wenn Sie eine gute Internetverbindung haben, funktionieren Anrufe bei RTMP. <br><br>  <strong>Das RTMFP-Protokoll</strong> ist trotz des Unterschieds in nur einem Buchstaben das UDP-Protokoll.  Es ist frei von Pufferproblemen - solchen, die auf TCP sind;  Es wird die Head-of-Line-Blockierung vorenthalten. In diesem Fall haben Sie ein Paket verloren, und TCP gibt die folgenden Pakete erst zur√ºck, wenn es Zeit ist, das verlorene Paket erneut zu senden.  RTMFP war in der Lage, NAT zu verarbeiten, und die IP-Adresse der Clients wurde ge√§ndert.  Aus diesem Grund haben wir 2010 das Web auf RTMFP gestartet. <br><img src="https://habrastorage.org/webt/pv/rx/16/pvrx163tvieetirsg8nkfrov7qm.jpeg"><br><br>  Erst 2011 erschien dann der erste Entwurf des WebRTC, der noch nicht voll funktionsf√§hig war.  Im Jahr 2012 haben wir begonnen, Anrufe unter iOS / Android zu unterst√ºtzen, dann ist etwas anderes passiert, und im Jahr 2016 hat Chrome die Unterst√ºtzung von Flash eingestellt.  Wir mussten etwas tun. <br><img src="https://habrastorage.org/webt/uu/ub/cs/uuubcssxa_w9-ost03_y6dqq6ic.jpeg"><br><br>  Wir haben uns alle VoIP-Protokolle angesehen: Wie immer, um etwas zu tun, schauen wir uns zun√§chst die Wettbewerber an. <br><br><h2>  Konkurrenten oder wo ich anfangen soll <br></h2><br>  Wir haben die beliebtesten Konkurrenten ausgew√§hlt: Skype, WhatsApp, Google Duo (√§hnlich wie Hangouts) und ICQ. <br><br>  Zun√§chst haben wir die Verz√∂gerung gemessen. <br><img src="https://habrastorage.org/webt/yv/br/d2/yvbrd2tluf9yzf-xqqibngdooh8.jpeg"><br><br>  Es ist einfach zu tun.  Oben ist ein Foto, auf dem: <br><br><ul><li>  Stoppuhr (siehe Telefon oben links), die die Uhrzeit anzeigt (03:08). </li><li>  Das nahe gelegene Telefon t√§tigt einen Anruf und nimmt das erste Telefon als Video.  Von dem Moment an, als das Bild in die Kamera des Telefons gelangt ist und Sie es gesehen haben, dauerte es ungef√§hr 100 ms. </li><li>  Ein Anruf an ein anderes Telefon (wei√ü) und noch einmal.  Hier betr√§gt die Verz√∂gerung bei Google Duo ca. 310 ms. </li></ul><br>  Ich werde noch nicht alle Karten aufdecken, aber wir haben sichergestellt, dass diese Ger√§te keine P2P-Verbindungen herstellen k√∂nnen.  Nat√ºrlich wurden die Messungen in verschiedenen Netzwerken durchgef√ºhrt, und dies ist nur ein Beispiel. <br><img src="https://habrastorage.org/webt/rn/xz/ee/rnxzee4grukafmg0gu3cunpemsi.jpeg"><br><br>  Skype unterbricht immer noch ein wenig.  Es stellte sich heraus, dass bei Skype die Verz√∂gerung 1,1 s betr√§gt, falls p2p nicht verbunden werden kann. <br><br>  Unsere Testumgebung war kompliziert.  Wir haben unter verschiedenen Bedingungen (EDGE, 3G, LTE, WiFi) getestet, ber√ºcksichtigt, dass die Kan√§le asymmetrisch sind, und ich gebe die Durchschnittswerte aller Messungen an. <br><img src="https://habrastorage.org/webt/gb/pp/6s/gbpp6sc5jugssoov8nmzvajlifo.jpeg"><br><br>  Um den Akkuverbrauch, die Prozessorlast und alles andere abzusch√§tzen, haben wir beschlossen, dass Sie die Telefontemperatur einfach mit einem Pyrometer messen und davon ausgehen k√∂nnen, dass dies eine durchschnittliche Belastung der GPU des Telefons pro Prozessor und Akku ist.  Im Prinzip ist es sehr unangenehm, ein hei√ües Telefon an Ihr Ohr zu bringen und es sogar in Ihren H√§nden zu halten.  Es scheint dem Benutzer, dass die Anwendung jetzt ihren gesamten Akku verbraucht. <br><img src="https://habrastorage.org/webt/dl/ck/vd/dlckvdbr8we75haadv9qkgk1jxk.jpeg"><br><br>  Das Ergebnis ist: <br><br><ul><li>  Die langsamsten <strong>Verz√∂gerungen</strong> waren ICQ und Skype und die schnellsten - Telegramm.  Dies ist kein vollst√§ndig korrekter Vergleich, da Telegramm keine Videoanrufe hat, aber eine minimale Audio-Latenz aufweist.  WhatsApp (ca. 200 ms) und Hangouts - 390 ms funktionieren hervorragend. </li><li>  <strong>Nach Temperatur</strong> isst Telegramm am wenigsten ohne Video und Skype am meisten. </li><li>  In Bezug auf die <strong>Antwortzeit</strong> stellt Telegram die Verbindung <strong>f√ºr die</strong> l√§ngste Zeit und die schnellste WhatsApp und Google Duo her. </li></ul><br>  Gro√üartig, wir haben einige Metriken! <br><img src="https://habrastorage.org/webt/t8/mb/n0/t8mbn0vv_g1utslspeeevk8g5ie.jpeg"><br><br>  Wir haben die Qualit√§t von Video und Sprache in verschiedenen Netzwerken getestet, mit verschiedenen Tropfen und allem anderen.  Infolgedessen kamen wir zu dem Schluss, dass das <strong>Video mit</strong> der <strong>h√∂chsten Qualit√§t bei Google Duo und die Stimme bei Skype verf√ºgbar</strong> ist. Dies ist jedoch in ‚Äûschlechten‚Äú Netzwerken der Fall, wenn bereits Verzerrungen vorliegen.  Im Allgemeinen arbeitet jeder ungef√§hr mittelm√§√üig.  WhatsApp hat das unscharfeste Bild. <br><br>  Mal sehen, worauf es ankommt. <br><img src="https://habrastorage.org/webt/ih/ap/1i/ihap1infndlvdjllso8eszhjnla.jpeg"><br><br>  Skype verf√ºgt √ºber ein eigenes propriet√§res Protokoll, und alle anderen verwenden entweder eine Modifikation von WebRTC oder im Allgemeinen direkt WebRTC.  Hangouts, Google Duo, WhatsApp und Facebook Messenger k√∂nnen mit dem Web arbeiten, und alle haben WebRTC unter der Haube.  Sie sind alle so unterschiedlich, mit unterschiedlichen Eigenschaften und sie haben alle ein WebRTC!  Sie m√ºssen es also richtig kochen k√∂nnen.  Au√üerdem gibt es Telegramm, f√ºr das einige Teile von WebRTC f√ºr den Audioteil verantwortlich sind, und ICQ, das WebRTC lange Zeit gabelte und seinen eigenen Weg weiterentwickelte. <br><br><h2>  WebRTC  Architektur <br></h2><br><img src="https://habrastorage.org/webt/3q/0x/-c/3q0x-cy-45bblq5lgoayq2awd5u.jpeg"><br><br>  WebRTC impliziert das Vorhandensein eines Signalisierungsservers, eines Vermittlers zwischen Clients, der zum Austausch von Nachrichten w√§hrend des Aufbaus einer P2P-Verbindung zwischen ihnen verwendet wird.  Nach dem Herstellen einer direkten Verbindung beginnen Clients, Mediendaten miteinander auszutauschen. <br><br><h2>  WebRTC  Demo <br></h2><br>  Beginnen wir mit einer einfachen Demo.  Es gibt 5 einfache Schritte, um eine WebRTC-Verbindung herzustellen. <br><br><div class="spoiler">  <b class="spoiler_title">Detaillierter Beispielcode</b> <div class="spoiler_text"><pre><code class="javascript hljs"><span class="hljs-number"><span class="hljs-number">1.</span></span> <span class="hljs-comment"><span class="hljs-comment">// Step #1: Getting local video stream and initializing a peer connection with it (both caller and callee) 2. 3. var localStream = null; 4. var localVideo = document.getElementById('localVideo'); 5. 6. navigator 7. .mediaDevices 8. .getUserMedia({ audio: true, video: true }) 9. .then(stream =&gt; { 10. localVideo.srcObject = stream; 11. localStream = stream; 12. }); 13. 14. var pc = new RTCPeerConnection({ iceServers: [...] }); 15. 16. localStream 17. .getTracks() 18. .forEach(track =&gt; pc.addTrack(track, localStream)); 19. 20. // Step #2: Creating SDP offer (caller) 21. 22. pc.createOffer({ offerToReceiveAudio: true, offerToReceiveVideo: true }) 23. .then(offer =&gt; signaling.send('offer', offer)); 24. 25. // Step #3: Handling SDP offer and sending SDP answer (callee) 26. 27. signaling.on('offer', offer =&gt; { 28. pc.setRemoteDescription(offer) 29. .then(() =&gt; pc.createAnswer()) 30. .then(answer =&gt; signaling.send('answer', answer)) 31. }); 32. 33. // Step #4: Handling SDP answer (calleer) 34. 35. signaling.on('answer', answer =&gt; pc.setRemoteDescription(answer)); 36. 37. // Step #5: Exchanging ICE candidates 38. 39. pc.onicecandidate = event =&gt; signaling.send('candidate', event.candidate); 40. 41. signaling.on('candidate', candidate =&gt; pc.addIceCandidate(candidate)); 42. 43. // Step #6: Getting remote video stream (both caller and callee) 44. 45. var remoteVideo = document.getElementById('remoteVideo'); 46. 47. pc.onaddstream = event =&gt; remoteVideo.srcObject = event.streams[0];</span></span></code> </pre> <br></div></div><br>  Es hei√üt folgendes: <br><br><ol><li>  Nehmen Sie ein Video auf und stellen Sie eine Peer-Verbindung her. √úbertragen Sie eine Art IceServer (es ist nicht sofort klar, um was es sich handelt). <br></li><li>  Erstellen Sie ein SDP-Angebot und senden Sie es an die Signalisierung. Die Signalisierung von WebRTC wird in keiner Weise f√ºr Sie implementiert. <br></li><li>  Dann m√ºssen Sie einen Wrapper f√ºr denjenigen erstellen, der von der Signalisierung stammt, und dies ist auch nicht Teil von WebRTC. <br></li><li>  Tauschen Sie einige Kandidaten weiter aus. <br></li><li>  Holen Sie sich endlich den Remote-Videostream. <br></li></ol><br>  Lassen Sie uns herausfinden, was dort passiert und was wir selbst umsetzen m√ºssen. <br><img src="https://habrastorage.org/webt/wx/fz/fn/wxfzfnkuw7smjite-bdpmadb_ro.jpeg"><br><br>  Wir betrachten das Bild von unten nach oben.  Es gibt eine WebRTC-Bibliothek, die bereits in den Browser integriert ist und von Chrome, Firefox usw. unterst√ºtzt wird. Sie k√∂nnen sie unter Android / iOS erstellen und √ºber die API und SDP (Session Description Protocol) mit ihr kommunizieren, die die Sitzung selbst beschreibt.  Im Folgenden werde ich Ihnen sagen, was darin enthalten ist.  Um diese Bibliothek in Ihrer Anwendung zu verwenden, m√ºssen Sie durch Signalisierung eine Verbindung zwischen Teilnehmern herstellen.  Die Signalisierung ist auch Ihr Dienst, den Sie selbst schreiben m√ºssen. WebRTC bietet sie nicht an. <br><br>  Weiter im Artikel werden wir das Netzwerk in der richtigen Reihenfolge diskutieren, dann Video / Audio, und am Ende werden wir unsere Signalisierung schreiben. <br><br><h2>  WebRTC-Netzwerk oder p2p (eigentlich c2s2c) <br></h2><br>  Das Einrichten einer P2P-Verbindung scheint ziemlich einfach zu sein. <br><img src="https://habrastorage.org/webt/he/7h/so/he7hsoyzqklbzj715slypgychgc.jpeg"><br><br>  Wir haben Alice und Bob, die eine P2P-Verbindung herstellen m√∂chten.  Sie nehmen ihre IP-Adressen, haben einen Signalisierungsserver, mit dem sie beide verbunden sind, und √ºber den sie diese Adressen austauschen k√∂nnen.  Sie tauschen Adressen aus und oh!  Sie haben die gleichen Adressen, etwas ist schief gelaufen! <br><img src="https://habrastorage.org/webt/rn/hc/uj/rnhcujxoa5k0tni2oquj-tx3hfi.jpeg"><br><br>  Tats√§chlich sitzen beide Benutzer h√∂chstwahrscheinlich hinter WLAN-Routern, und dies sind ihre lokalen grauen IP-Adressen.  Der Router bietet ihnen eine Funktion wie Network Address Translation (NAT).  Wie arbeitet sie? <br><img src="https://habrastorage.org/webt/yr/xu/r0/yrxur0s_xhoye3i36zod4ropbec.jpeg"><br><br>  Sie haben ein graues Subnetz und eine externe IP-Adresse.  Sie senden ein Paket von Ihrer grauen Adresse ins Internet, NAT ersetzt Ihre graue Adresse durch Wei√ü und merkt sich die Zuordnung: von welchem ‚Äã‚ÄãPort es gesendet wurde, an welchen Benutzer und mit welchem ‚Äã‚ÄãPort es √ºbereinstimmt.  Wenn das R√ºckpaket ankommt, wird es durch diese Zuordnung aufgel√∂st und an den Absender gesendet.  Alles ist einfach. <br><br>  Unten ist eine Illustration, wie es bei mir aussieht. <br><img src="https://habrastorage.org/webt/ud/ar/da/udardacyxvmzt5mq0modbosd-mc.jpeg"><br><br>  Dies ist meine interne IP-Adresse und die Adresse des Routers (√ºbrigens auch grau).  Wenn Sie die Route verfolgen und sehen, sehen wir meinen WLAN-Router: ein Paket grauer Anbieteradressen und eine externe wei√üe IP.  Tats√§chlich werde ich also zwei NATs haben: einen, auf dem ich √ºber WLAN bin, und einen anderen vom Anbieter, es sei denn, ich habe mir nat√ºrlich eine dedizierte externe IP-Adresse gekauft. <br><br>  <strong>NAT ist so beliebt, weil:</strong> <br><br><ul><li>  Viele IPv4s fehlen noch und es gibt nicht gen√ºgend Adressen. </li><li>  NAT scheint das Netzwerk zu sch√ºtzen; </li><li>  Dies ist eine Standardfunktion des Routers: Stellen Sie eine Verbindung zu Wi-Fi her, es gibt NAT genau dort, es funktioniert. </li></ul><br>  Daher sitzen nur 3% der Benutzer mit einer externen IP, w√§hrend der Rest √ºber NAT l√§uft. <br><br>  Mit NAT k√∂nnen Sie sicher zu beliebigen wei√üen Adressen wechseln.  Aber wenn Sie nirgendwo hingegangen sind, kann niemand zu Ihnen kommen. <br><img src="https://habrastorage.org/webt/j7/cl/j2/j7clj2pypnpwv_p-odndgflgzpk.jpeg"><br><br>  Das Herstellen einer P2P-Verbindung ist ein Problem.  Tats√§chlich k√∂nnen Alice und Bob keine Pakete aneinander senden, wenn sie beide hinter NAT stehen. <br><br>  WebRTC verf√ºgt √ºber <strong>ein STUN-Protokoll</strong> , um dieses Problem zu l√∂sen.  Es wird vorgeschlagen, einen STUN-Server bereitzustellen.  Dann stellt Alice eine Verbindung zum STUN-Server her, erh√§lt ihre IP-Adresse und sendet sie per Signal an Bob.  Bob erh√§lt auch seine IP-Adresse und sendet sie an Alice.  Sie senden Pakete aufeinander zu und durchbrechen so NAT. <br><img src="https://habrastorage.org/webt/1m/mq/iz/1mmqiz57zbyzzahdgng_y_3hywo.jpeg"><br><br>  <strong>Frage</strong> : Alice hat einen bestimmten Port ge√∂ffnet, NAT / Firewall wurde bereits auf diesen Port durchbrochen, und Bob ist offen.  Sie kennen die Adressen der anderen.  Alice versucht das Paket an Bob zu senden, er sendet das Paket an Alice.  Glaubst du, sie k√∂nnen reden oder nicht? <br><br>  In der Tat haben Sie in jedem Fall Recht, das Ergebnis h√§ngt von der Art des NAT-Paares ab, √ºber das Benutzer verf√ºgen. <br><img src="https://habrastorage.org/webt/te/hd/hj/tehdhjdvyvfv9dcrxng950n98h8.jpeg"><br><br><h3>  √úbersetzung der Netzwerkadresse <br></h3><br>  Es gibt 4 Arten von NAT: <br><br><ol><li>  Vollkegel NAT; <br></li><li>  Eingeschr√§nkter Kegel NAT; <br></li><li>  Port eingeschr√§nkter Kegel NAT; <br></li><li>  Symmetrisches NAT <br></li></ol><br>  In der Basisversion sendet Alice ein Paket an den STUN-Server, sie √∂ffnet einen Port.  Bob erf√§hrt irgendwie von ihrem Port und sendet ein R√ºckpaket.  Wenn dies <strong>Full Cone NAT ist</strong> - das einfachste, das nur den externen Port dem internen Port zuordnet, kann Bob Alice sofort ein Paket senden, eine Verbindung herstellen und sie werden sprechen. <br><img src="https://habrastorage.org/webt/ph/kp/zr/phkpzrkuy3k2uzqsl4sub-sla7o.jpeg"><br><br>  Unten ist das Interaktionsschema: Alice von einem Port sendet ein Paket an den STUN-Port, STUN antwortet ihr mit ihrer externen Adresse.  STUN kann von jeder Adresse aus antworten. Wenn es sich um Vollkegel-NAT handelt, wird NAT weiterhin durchgestrichen, und Bob kann auf dieselbe Adresse antworten. <br><img src="https://habrastorage.org/webt/dl/pp/3a/dlpp3anl2az479kengmx5easix4.jpeg"><br><br>  Im Fall von <strong>Restricted Cone NAT sind die</strong> Dinge etwas komplizierter.  Es merkt sich nicht nur den Port, von dem aus Sie die interne Adresse zuordnen m√ºssen, sondern auch die externe Adresse, zu der Sie gegangen sind.  Das hei√üt, wenn Sie nur eine Verbindung zum IP STUN-Server hergestellt haben, kann Ihnen niemand im Netzwerk antworten, und dann erreicht Bobs Paket nicht. <br><img src="https://habrastorage.org/webt/yt/-g/sg/yt-gsg5yyrf99ywt77j2ydntyzy.jpeg"><br><br>  Wie wird dieses Problem gel√∂st?  In einem einfachen Schema (siehe Abbildung unten) wie folgt: Alice sendet ein Paket an STUN, er antwortet ihr mit ihrer IP.  STUN kann von jedem Port aus darauf reagieren, solange es sich um Restricted Cone NAT handelt.  Bob kann Alice nicht antworten, weil er eine andere Adresse hat.  Alice antwortet mit einem Paket und kennt Bobs IP-Adresse.  Sie √∂ffnet NAT f√ºr Bob, Bob antwortet ihr.  Hurra, sie haben geredet. <br><img src="https://habrastorage.org/webt/iz/ji/ar/izjiare3mege16iftxwal3haqye.jpeg"><br><br>  Eine etwas kompliziertere Option ist <strong>Port Restricted Cone NAT</strong> .  Trotzdem sollte nur STUN genau von dem Port aus reagieren, auf den zugegriffen wurde.  Alles wird auch funktionieren. <br><br>  Das sch√§dlichste ist <strong>Symmetric NAT</strong> . <br><img src="https://habrastorage.org/webt/p-/se/fu/p-sefuxnvpapxpuf8-wqavqkd0u.jpeg"><br><br>  Zun√§chst funktioniert alles genauso - Alice sendet das Paket an den STUN-Server, es antwortet √ºber denselben Port.  Bob kann Alice nicht antworten, aber sie sendet das Paket an Bob.  Und hier, obwohl Alice ein Paket an Port 4444 sendet, weist ihr das Mapping einen neuen Port zu.  Symmetrisches NAT unterscheidet sich darin, dass beim Herstellen jeder neuen Verbindung jedes Mal, wenn ein neuer Port am Router ausgegeben wird.  Dementsprechend schl√§gt Bob in dem Port, von dem Alice zu STUN gegangen ist, und sie k√∂nnen keine Verbindung herstellen. <br><br>  In der entgegengesetzten Richtung, wenn Bob eine offene IP-Adresse hat, kann Alice einfach zu ihm kommen und sie werden eine Verbindung herstellen. <br><br>  Alle Optionen sind in einer Tabelle unten zusammengefasst. <br><img src="https://habrastorage.org/webt/-c/jf/o9/-cjfo9dclflwku9qz-2p4wl_hre.jpeg"><br><br>  Es zeigt, dass fast alles m√∂glich ist, au√üer wenn wir versuchen, Verbindungen √ºber Symmetric NAT mit Port Restricted Cone NAT oder Symmetric NAT am anderen Ende herzustellen. <br><img src="https://habrastorage.org/webt/gp/lk/_d/gplk_darehdjbaxktic84liuwto.jpeg"><br><br>  Wie wir herausgefunden haben, ist p2p f√ºr uns in Bezug auf die Latenz von unsch√§tzbarem Wert. Wenn es jedoch nicht m√∂glich war, es zu installieren, bietet uns WebRTC einen TURN-Server an.  Als wir feststellten, dass p2p nicht installiert werden kann, k√∂nnen wir einfach eine Verbindung zu TURN herstellen, wodurch der gesamte Datenverkehr √ºbertragen wird.  Gleichzeitig zahlen Sie jedoch f√ºr den Datenverkehr, und Benutzer k√∂nnen einige zus√§tzliche Verz√∂gerungen haben. <br><br><h2>  √úbe <br></h2><br>  Google hat kostenlose STUN-Server.  Sie k√∂nnen sie in die Bibliothek stellen, es wird funktionieren. <br><br>  TURN-Server verf√ºgen √ºber Anmeldeinformationen (Login und Passwort).  H√∂chstwahrscheinlich m√ºssen Sie Ihre eigenen erh√∂hen, es ist ziemlich schwierig, frei zu finden. <br><br>  Beispiele f√ºr kostenlose STUN-Server von Google: <br><br><ul><li>  stun: stun.l.google.com: 19302 </li><li>  stun: stun1.l.google.com: 19302 </li><li>  stun: stun2.l.google.com: 19302 </li><li>  stun: stun3.l.google.com: 19302 </li></ul><br>  Und ein kostenloser TURN-Server mit Passw√∂rtern: URL: 'Turn: 192.158.29.39: 3478? Transport = udp', Berechtigungsnachweis: 'JZEOEt2V3Qb0y27GRntt2u2PAYA =', Benutzername: '28224511: 1379330808'. <br><br>  Wir benutzen <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Coturn</a> . <br><img src="https://habrastorage.org/webt/yj/_d/zv/yj_dzvkvpkhmol2a8ryscucgoli.jpeg"><br><br>  Infolgedessen werden 34% des Datenverkehrs √ºber die P2P-Verbindung √ºbertragen, alles andere wird √ºber den TURN-Server √ºbertragen. <br><br><h4>  Was ist sonst noch im STUN-Protokoll interessant? <br></h4><br>  Mit STUN k√∂nnen Sie den NAT-Typ bestimmen. <br><img src="https://habrastorage.org/webt/nj/lo/7h/njlo7h_sounawjxlwk-pxsiejy0.jpeg"><br><br>  <em>Schiebelink</em> <br><br>  Wenn Sie ein Paket senden, k√∂nnen Sie angeben, dass Sie eine Antwort von demselben Port erhalten m√∂chten, oder STUN bitten, von einem anderen Port, von einer anderen IP oder sogar von einer anderen IP und einem anderen Port zu antworten.  Somit k√∂nnen Sie <strong>f√ºr 4 Abfragen an den STUN-Server den NAT-Typ bestimmen</strong> . <br><img src="https://habrastorage.org/webt/og/0m/2h/og0m2hawerjjdabsr43zwygz_cy.jpeg"><br><br>  Wir haben die NAT-Typen gez√§hlt und festgestellt, dass fast alle Benutzer entweder symmetrisches NAT oder portbeschr√§nktes Kegel-NAT haben.  Daher stellt sich heraus, dass nur ein Drittel der Benutzer eine P2P-Verbindung herstellen kann. <br><br>  Sie fragen sich vielleicht, warum ich Ihnen das alles erz√§hle, wenn Sie den STUN einfach von Google nehmen und in WebRTC einf√ºgen k√∂nnten, und es scheint, als w√ºrde alles funktionieren. <br><br>  Weil Sie den NAT-Typ tats√§chlich selbst bestimmen k√∂nnen. <br><img src="https://habrastorage.org/webt/ih/qn/8j/ihqn8j2nm2dumsstvyopem7ljxk.jpeg"><br><br>  Dies ist ein <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Link</a> zu einer Java-Anwendung, die nichts Schwieriges tut: Sie pingt nur verschiedene Ports und verschiedene STUN-Server an und √ºberpr√ºft, welchen Port sie am Ende sieht.  Wenn Sie Open Full Cone NAT haben, hat der STUN-Server denselben Port.  Mit Restricted Cone NAT haben Sie unterschiedliche Ports f√ºr jede STUN-Anforderung. <br><img src="https://habrastorage.org/webt/ve/qf/t1/veqft1dee6wstziwrkrbemxj5da.jpeg"><br><br>  Mit Symmetric NAT sieht es in meinem B√ºro so aus.  Es gibt v√∂llig unterschiedliche Ports. <br><br>  Manchmal gibt es jedoch ein interessantes Muster, bei dem die Portnummer f√ºr jede Verbindung um eins erh√∂ht wird. <br><img src="https://habrastorage.org/webt/2n/7e/ro/2n7ero_besx7rzunsjuzfjplfpy.jpeg"><br><br>  Das hei√üt, viele NATs sind so konfiguriert, dass sie den Port um eine Konstante erh√∂hen oder verringern.  Diese Konstante kann gefunden werden und somit Symmetric NAT durchbrechen. <br><img src="https://habrastorage.org/webt/te/6n/bf/te6nbfknmebcz7zmrtk35jqwfpk.jpeg"><br><br>  So durchbrechen wir NAT - wir gehen zu einem STUN-Server, zu einem anderen, schauen uns den Unterschied an, vergleichen und versuchen erneut, unseren Port bereits mit diesem Inkrement oder Dekrement zu versehen.  Das hei√üt, Alice versucht, Bob ihren Port zu geben, der bereits auf eine Konstante eingestellt ist, und wei√ü, dass es beim n√§chsten Mal genau das sein wird. <br><img src="https://habrastorage.org/webt/l1/re/-m/l1re-mp1om6zkjqm0j1n5rfh004.jpeg"><br><br>  So konnten wir <strong>weitere 12% Peer-to-Peer</strong> schwei√üen. <br><br>  Tats√§chlich verhalten sich externe Router mit derselben IP manchmal gleich.  Wenn Sie also Statistiken erfassen und Symmetric NAT eine Funktion des Anbieters und keine Funktion des WLAN-Routers des Benutzers ist, kann das Delta vorhergesagt werden. Senden Sie es sofort an den Benutzer, damit er es verwendet und nicht zu viel Zeit damit verbringt, es zu bestimmen. <br><br><h2>  CDN-Relay oder was zu tun ist, wenn Sie keine P2P-Verbindung herstellen konnten <br></h2><br>  Wenn wir weiterhin den TURN-Server verwenden und nicht in p2p, sondern im Real-Modus arbeiten und den gesamten Datenverkehr √ºber den Server leiten, k√∂nnen wir weiterhin ein CDN hinzuf√ºgen.  Es sei denn nat√ºrlich, Sie haben einen Spielplatz.  Wir haben unsere eigenen CDN-Sites, daher war es f√ºr uns ganz einfach.  Es musste jedoch festgestellt werden, wo es besser ist, eine Person zu senden: zu einer CDN-Site oder beispielsweise zu einem Kanal nach Moskau.  Dies ist keine sehr triviale Aufgabe, also haben wir Folgendes getan: <br><br><ol><li>  Versehentlich an einige Benutzer der Moskauer Website ausgegeben, einige - entfernt. <br></li><li>  Wir haben Statistiken √ºber die IP des Benutzers, auf den Servern und √ºber die Eigenschaften des Netzwerks gesammelt. <br></li><li>  Mit maxMind haben wir die Subnetze gruppiert, die Statistiken √ºberpr√ºft und anhand der IP ermittelt, welcher Benutzer den n√§chstgelegenen TURN-Server f√ºr die Verbindung hatte. <br></li></ol><br><img src="https://habrastorage.org/webt/ql/dg/sy/qldgsyqtvaeqqdvyctilcipatau.jpeg"><br><br>  In Nowosibirsk gibt es ein CDN.  Wenn in Moskau alles f√ºr Sie funktioniert, betr√§gt das 99. Perzentil von RTT 1,3 Sekunden.  Durch CDN funktioniert alles viel schneller (0,4 Sekunden). <br><br>  Ist es immer besser, eine P2P-Verbindung zu verwenden und keinen Server zu verwenden?  Ein interessantes Beispiel sind die beiden Krasnojarsker Anbieter Optibyte und Mobra (Namen haben sich m√∂glicherweise ge√§ndert).  Aus irgendeinem Grund ist die Verbindung zwischen ihnen auf p2p viel schlechter als √ºber MSK.  Wahrscheinlich sind sie nicht miteinander befreundet. <br><img src="https://habrastorage.org/webt/yq/en/dm/yqendmksjs7vila8zpra1xu_2uc.jpeg"><br><br>  Wir haben alle diese F√§lle analysiert, zuf√§llig Benutzer an p2p oder √ºber MSK gesendet, Statistiken gesammelt und Vorhersagen erstellt.  Wir wissen, dass Statistiken aktualisiert werden m√ºssen. Daher stellen wir f√ºr einige Benutzer spezielle Verbindungen her, um zu √ºberpr√ºfen, ob sich in den Netzwerken etwas ge√§ndert hat. <br><br>  Wir haben so einfache Eigenschaften wie Rundzeit, Paketverlust und Bandbreite gemessen - es bleibt zu lernen, wie man sie richtig vergleicht. <br><img src="https://habrastorage.org/webt/yu/l-/nb/yul-nbvpnw5za6ixc80wlgumrse.jpeg"><br><br>  Wie kann man verstehen, was besser ist: 2 Mbit / s Internet, 400 ms RTT und 5% Paketverlust oder 100 Kbit / s, 100 ms Verz√∂gerung und geringer Paketverlust? <br><br>  Es gibt keine genaue Antwort, die Bewertung der Videoanrufqualit√§t ist sehr subjektiv.  Daher haben wir die Benutzer nach dem Ende des Aufrufs gebeten, die Qualit√§t der Sternchen zu bewerten und die Konstanten entsprechend den Ergebnissen festzulegen.  Es stellte sich heraus, dass beispielsweise die RTT weniger als 300 ms betr√§gt - es spielt keine Rolle mehr, die Bitrate ist wichtiger. <br><br>  H√∂here Benutzerbewertungen f√ºr Android und iOS.  Es ist zu sehen, dass iOS-Benutzer eher eine Einheit und h√§ufiger f√ºnf einsetzen.  Ich wei√ü nicht, warum wahrscheinlich die Besonderheiten der Plattform.  Aber wir haben die Konstanten entlang gezogen, so dass wir, wie es uns scheint, gut waren. <br><br>  Zur√ºck zu unserem Entwurf f√ºr den Artikel, diskutieren wir immer noch das Netzwerk. <br><br>  <strong>Wie sieht der Verbindungsaufbau aus?</strong> <br><img src="https://habrastorage.org/webt/-o/0b/zz/-o0bzzfolvd5rhfysec57ebndda.jpeg"><br><br>  Wir senden STUN- und TURN-Server an PeerConnection (), eine Verbindung wird hergestellt.  Alice findet ihre IP heraus und sendet sie an die Signalisierung.  Bob erf√§hrt von Alices IP.  Alice bekommt Bobs IP.  Sie tauschen Pakete aus, durchbrechen m√∂glicherweise NAT, stellen m√∂glicherweise TURN ein und kommunizieren. <br><img src="https://habrastorage.org/webt/yz/oa/rv/yzoarv064wp3s6zwwjpy0ec68hk.jpeg"><br><br>  In den 5 Schritten zum Herstellen der Verbindung, die wir zuvor besprochen haben, haben wir die Server herausgefunden, herausgefunden, wo sie erh√§ltlich sind, und dass ICE-Kandidaten externe IP-Adressen sind, die wir durch Signalisierung austauschen.  Es kann auch versucht werden, interne IP-Adressen von Clients zu durchbrechen, wenn sie sich in Reichweite eines Wi-Fi befinden. <br><br>  Fahren wir mit dem Teil des Videos fort. <br><br><h2>  Video und Audio <br></h2><br>  WebRTC unterst√ºtzt eine Reihe von Video- und Audio-Codecs, Sie k√∂nnen dort jedoch Ihren eigenen Codec hinzuf√ºgen.  Grunds√§tzlich unterst√ºtzt von <strong>H.264 und VP8 f√ºr Video</strong> .  VP8 ist ein Software-Codec und verbraucht daher viel Batterie.  H.264 ist nicht auf allen Ger√§ten verf√ºgbar (normalerweise nativ), daher ist die Standardpriorit√§t VP8. <br><br>  Innerhalb von SDP (Session Description Protocol) gibt es eine Codec-Aushandlung: Wenn ein Client eine Liste seiner Codecs sendet, sendet der andere eine eigene mit Priorit√§t und sie vereinbaren, welche Codecs f√ºr die Kommunikation verwendet werden.  Falls gew√ºnscht, k√∂nnen Sie die Priorit√§t der VP8- und H.264-Codecs √§ndern. Aus diesem Grund k√∂nnen Sie auf einigen Ger√§ten, auf denen 264 nativ ist, Batterie sparen.  Hier ist <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">ein Beispiel,</a> wie dies getan werden kann.  Wir haben dies getan, es schien uns, dass sich die Benutzer nicht √ºber die Qualit√§t beschwerten, aber gleichzeitig wurde die Batterieladung viel weniger verbraucht. <br><br>  F√ºr Audio hat WebRTC <strong>OPUS oder G711</strong> , normalerweise <strong>funktionieren</strong> alle OPUS immer, es muss nichts damit gemacht werden. <br><br>  Nachfolgend finden Sie Temperaturmessungen nach 10 Minuten Gebrauch. <br><img src="https://habrastorage.org/webt/pf/-q/pj/pf-qpjvwi8myzm7_q1zlmpe2zbs.jpeg"><br><br>  Es ist klar, dass wir verschiedene Ger√§te getestet haben.  Dies ist ein Beispiel f√ºr ein iPhone, und auf diesem verwendet die OK-Anwendung den Akku am wenigsten, da die Temperatur des Ger√§ts am geringsten ist. <br><br>  Das zweite, was Sie aktivieren k√∂nnen, wenn Sie WebRTC verwenden, ist das <strong>automatische Ausschalten des Videos, wenn die Verbindung sehr schlecht ist</strong> . <br><img src="https://habrastorage.org/webt/xg/kx/ab/xgkxab9ccijdbomfmja0rtrhfpg.jpeg"><br><br>  Wenn Sie weniger als 40 Kbit / s haben, wird das Video ausgeschaltet.  Sie m√ºssen nur das Kontrollk√§stchen aktivieren, wenn Sie die Verbindung herstellen. Der Schwellenwert kann √ºber die Schnittstelle konfiguriert werden.  Sie k√∂nnen auch die minimale und maximale Startstrom-Bitrate einstellen. <br><img src="https://habrastorage.org/webt/xw/7d/ts/xw7dtsmnuz7pe0ujabtjapnnkxg.jpeg"><br><br>  Dies ist eine sehr n√ºtzliche Sache.  Wenn Sie beim Herstellen einer Verbindung im Voraus wissen, welche Bitrate Sie erwarten, k√∂nnen Sie diese weiterleiten, der Anruf beginnt von dort und Sie m√ºssen die Bitrate nicht anpassen.  Wenn Sie wissen, dass Ihr Kanal h√§ufig Paketverluste oder Bandbreitenverluste aufweist, kann der Maximalwert ebenfalls begrenzt werden. <br><br>  WhatsApp funktioniert mit sehr seifigen Videos, jedoch mit kleinen Verz√∂gerungen, da die Bitrate von oben aggressiv komprimiert wird. <br><br>  Wir haben Statistiken mit MaxMind gesammelt und zugeordnet. <br><img src="https://habrastorage.org/webt/la/1b/kq/la1bkqswv6zqpbqdd7zrjarq0xu.jpeg"><br><br>  Dies ist eine ungef√§hre Startqualit√§t, die wir f√ºr Anrufe in verschiedenen Regionen Russlands verwenden. <br><br><h2>  Signalisierung <br></h2><br>  Sie m√ºssen diesen Teil h√∂chstwahrscheinlich schreiben, wenn Sie Anrufe t√§tigen m√∂chten.  Es gibt alle m√∂glichen Fallstricke.  Erinnern Sie sich, wie es aussieht. <br><img src="https://habrastorage.org/webt/ip/iv/er/ipiverlo5evjhsixis-obij86vs.jpeg"><br><br>  Es gibt eine Anwendung mit Signalisierung, die eine Verbindung zu SDP herstellt und mit SDP austauscht. Das folgende SDP ist die Schnittstelle zu WebRTC. <br><br>  So sieht eine einfache Signalisierung aus: <br><img src="https://habrastorage.org/webt/y3/zl/ih/y3zlihhnt8w32ukv-ms7sbelbgm.jpeg"><br><br>  Alice ruft Bob an.  Die Verbindung erfolgt beispielsweise √ºber eine Web-Socket-Verbindung.  Bob erh√§lt einen Push auf seinem Handy oder Browser oder stellt in einer offenen Verbindung eine Verbindung √ºber eine Web-Buchse her und danach klingelt das Telefon in seiner Tasche.  Bob nimmt den H√∂rer ab, Alice sendet ihm seine Codecs und andere von ihr unterst√ºtzte WebRTC-Funktionen.  Bob antwortet ihr genauso und danach tauschen sie die Kandidaten aus, die sie gesehen haben.  Hurra, ruf an! <br><br>  Es sieht alles ziemlich lang aus.  Erstens klingelt Bobs Telefon nicht in seiner Tasche, bis Sie eine Web-Socket-Verbindung hergestellt haben, bis der Push erfolgt und alles andere.  Alice wird die ganze Zeit warten und √ºberlegen, wo Bob ist, warum er nicht zum Telefon greift.  Nach der Best√§tigung dauert alles Sekunden, und selbst bei guten Verbindungen k√∂nnen es 3-5 Sekunden sein, bei schlechten Verbindungen alle 10. <br><br>  Wir m√ºssen etwas dagegen tun!  Sie werden mir sagen, dass alles sehr einfach gemacht werden kann. <br><br><img src="https://habrastorage.org/webt/kz/q0/ym/kzq0ymgejzqqpmlyso5ri8mvz-k.jpeg"><br><br>  Wenn Sie bereits eine offene Verbindung f√ºr Ihre Anwendung haben, k√∂nnen Sie sofort einen Push senden, um eine Verbindung herzustellen, eine Verbindung zum gew√ºnschten Signalisierungsserver herstellen und sofort Anrufe t√§tigen. <br><br>  Dann noch eine Optimierung.  Selbst wenn das Telefon immer noch in Ihrer Tasche klingelt und Sie das Telefon noch nicht abgenommen haben, k√∂nnen Sie Informationen √ºber die unterst√ºtzten Codecs und externen IP-Adressen austauschen, leere Videopakete senden und im Allgemeinen wird alles aufgew√§rmt.  Sobald Sie den H√∂rer abheben, wird alles gro√üartig. <br><br>  Wir haben es getan und es schien, dass alles cool war.  Aber nein. <br><img src="https://habrastorage.org/webt/hh/m5/t6/hhm5t6dtihar96isxhtsm92pums.jpeg"><br><br>  Das erste Problem ist, dass Benutzer den Anruf h√§ufig abbrechen.  Sie klicken auf "Anrufen" und brechen sofort ab.  Dementsprechend geht der Push zum Anruf und der Benutzer verschwindet (er hat das Internet oder etwas anderes verloren).  W√§hrenddessen klingelt jemandes Telefon, er nimmt den H√∂rer ab und wird dort nicht erwartet.  Daher funktioniert unsere primitive Optimierung, um so schnell wie m√∂glich mit dem Aufrufen zu beginnen, nicht wirklich. <br><img src="https://habrastorage.org/webt/xy/we/gy/xywegygpnsrlns4osq7nn4i71f0.jpeg"><br><br>  Mit einer schnellen Anrufannullierung gibt es eine zweite sch√§dliche Sache.  Wenn Sie die ID Ihrer Konversation auf dem Server generieren, m√ºssen Sie auf eine Antwort warten.  Das hei√üt, Sie erstellen einen Anruf, erhalten eine ID und k√∂nnen erst danach tun, was Sie wollen: Pakete senden, austauschen, einschlie√ülich des Anrufs abbrechen.  Dies ist eine sehr schlechte Geschichte, da sich herausstellt, dass Sie bis zum Eintreffen der Antwort nichts vom Kunden stornieren k√∂nnen.  Daher ist es am besten, auf dem Client eine ID wie eine GUID zu generieren und zu sagen, dass Sie den Anruf gestartet haben.  Die Leute machen das oft: Sie haben angerufen, abgesagt und sofort wieder angerufen.  Um dies zu verhindern, erstellen Sie eine GUID und senden Sie sie ab. <br><img src="https://habrastorage.org/webt/1e/he/ob/1eheobd8oyf6z-je6j0puuj7psy.jpeg"><br><br>  Es scheint nichts zu sein, aber es gibt ein anderes Problem.  Wenn Bob zwei Telefone hat oder woanders der Browser ge√∂ffnet bleibt, funktioniert unser gesamtes magisches Schema, um Pakete auszutauschen und eine Verbindung herzustellen, nicht, wenn er pl√∂tzlich von einem anderen Ger√§t aus antwortet. <br><br>  Was tun?  Kehren wir zu unserem einfachen einfachen langsamen Signalisierungsschema zur√ºck und optimieren es. Senden Sie den Push etwas fr√ºher.  Der Benutzer wird schneller eine Verbindung herstellen, dies spart jedoch einige Cent. <br><img src="https://habrastorage.org/webt/ap/k3/kx/apk3kx9qq3nsrzmrervqa548e-g.jpeg"><br><br>  Was tun mit dem l√§ngsten Teil, nachdem er den H√∂rer abgenommen und den Austausch gestartet hat? <br><img src="https://habrastorage.org/webt/ff/bj/qv/ffbjqvge9liirsi6spjc7ttlyby.jpeg"><br><br>  Sie k√∂nnen Folgendes tun.  Es ist klar, dass Alice bereits alle ihre Codecs kennt und sie an beide Telefone von Bob senden kann.  Sie kann alle ihre IP-Adressen aufl√∂sen und sie auch an die Signalisierung senden, wodurch sie in ihrer Warteschlange bleiben, aber nicht an einen der Clients gesendet werden, damit diese vorzeitig eine Verbindung mit ihr herstellen. <br><br>  Was kann Bob tun?  offer,   ,    ,   , ,    ,   .     ,    codec negotiation,  signaling             ,   ,     . Candidates         signaling. <br><br>   ,   signaling               .    ,          ,       . <br><br>    .           Google Duo  WhatsApp. <br><img src="https://habrastorage.org/webt/qr/gs/ry/qrgsry_mx3ahy48v6gvw1l49uau.jpeg"><br><br> ,   -  . ,      signaling,     ,   ,  , ,  ,    .     . <br><br> <strong>    ?</strong> <br><img src="https://habrastorage.org/webt/tp/fn/p3/tpfnp3a3cqrv_pdv31x7m4tirxi.jpeg"><br><br>      :   ,    .   ,      , ‚Äî   signaling  ,  ,   -  ,     ,     ,     . <br><img src="https://habrastorage.org/webt/so/mv/go/somvgopdt0c3zi5kksffvtpogz4.jpeg"><br><br>  ,   ,  ,      .          . ,     ,       ,   ,    .       ,    . <br><br>          ,     24/7,      -,      . <br><img src="https://habrastorage.org/webt/3a/uh/au/3auhaued9dsrfuwyhffcubvuqpy.jpeg"><br><br> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><em></em></a> <em>       <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="> </a></em> <br><br>    web-socket  - load balancer,    signaling-   -,       .  Zookeeper   Leader Election,     signaling,     conversation.       conversation,      . <br><br>      ,    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">NewSQL  Cassandra</a> .     ,  .       ,    signaling,   ,    signaling,     - ,  Leader Election  Zookeeper,   ,   ,         . <br><br>   : <br><br><ul><li>   - , ,   IP  signaling </li><li> Signaling ,   . </li><li>  ,  ,   , ,     . </li><li>       . </li></ul><br>     ,   . <br><br>           Cassandra,       ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="></a>    ). <br><br> <strong>,  :</strong> <br><br><ul><li>   iceServers    ; </li><li>   Session Description Protocol; </li><li>         ; </li><li>      signaling    WebRTC   ,   IP ; </li><li>    ! </li></ul><br><img src="https://habrastorage.org/webt/6j/hp/6k/6jhp6kn6luheqat6jepleauq1me.jpeg"><br><br> <strong> :</strong> <br><br><ul><li>   delay    ; </li><li>     ; </li><li>        . </li></ul><br>  Wow! <br><img src="https://habrastorage.org/webt/97/ru/zy/97ruzyu7gams8pyk2ktcoqb9yim.jpeg"><br><br><h2> Security. Man in the middle attack for WebRTC <br></h2><br>   man in the middle attack for WebRTC.   , WebRTC      ,     RTP,   1996 ,  SDP   1998  SIP. <br><img src="https://habrastorage.org/webt/yi/zm/7k/yizm7kvtjfnpnphvmuwiduk6yua.jpeg"><br><br>    ‚Äî   RFC     RTP,    RTP WebRTC. <br><br>      RFC ‚Äî       audio level,   ,     audio level  ,   . ,    SDP,   ,     .      congestion,       -. <br><br>  WebRTC  .  2011     ,  2013    Firefox,      iOS/Android,  2014 Opera.  , -   ,         . <br><img src="https://habrastorage.org/webt/53/s2/31/53s231p3esxh8vt9ls8dn8szgqi.jpeg"><br><br>       signaling,      ,  DTLS Handshake   .  ,       signaling,         ¬´¬ª   ,   ,      ,   . <br><img src="https://habrastorage.org/webt/i-/lq/uh/i-lquhbrd0eltgcqorvk1bu2gjs.jpeg"><br><br>       , , ,    HTTPS, WSS  ..     ‚Äî ZRTP,  , , Telegram. <br><br>    Telegram ,   ,     .       ,    ,  ,     ,       p2p . <br><br>  Wie funktioniert es <br><img src="https://habrastorage.org/webt/rx/0-/ws/rx0-wsjwmt6y8fboqtzsgyzpqos.jpeg"><br><br>          ‚Äî .    ,    ,  .          .              K,    ,     ,        . <br><br>       ,       ,     K <sub>1</sub>  K <sub>2</sub> .       .    .   K <sub>1</sub>  K <sub>2</sub>     ,         .       K <sub>1</sub>  K <sub>2</sub>     :  ,   ‚Äî  ,   ‚Äî       ,  .        ,     ,  -    , ,   . <br><br><h2>  <strong>Ergebnisse</strong> <br></h2><br><ul><li>  ¬´¬ª NAT type   symmetric NAT. </li><li>  ,  : 2  relay, , CDN;         . </li><li>   ,   . </li><li>    signaling. </li></ul><br><img src="https://habrastorage.org/webt/xr/h6/2i/xrh62iyyd4cb5ynwfa66atogljm.jpeg"><br><br>   ,       RTMFP, ,     WebRTC,   ,    .    !           4 . <br><br><h2> <strong> </strong> <br></h2><br>      ,    : <br><br><ul><li>   WebRTC  ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">https://webrtc.org/native-code/development/</a> ),    iOS/Android,      ; </li><li>    coturn ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">https://github.com/coturn/coturn</a> ); </li><li>  signaling. </li></ul><br>   ,    . <br><br><div class="spoiler"> <b class="spoiler_title">     </b> <div class="spoiler_text"><iframe width="560" height="315" src="https://www.youtube.com/embed/MnEXuKHjIOU" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br></div></div><br><blockquote>        HighLoad++  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="></a>      4-. <br><br>     ,   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="></a> .    ,  19  (10    9    -)  ,   -    .  ,       ,   . <br></blockquote></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de428217/">https://habr.com/ru/post/de428217/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de428203/index.html">Wir sehen uns die Diagramme an: Sch√§tzungen und Prognosen f√ºr den Cloud-Computing-Markt, Daten f√ºr 2018</a></li>
<li><a href="../de428205/index.html">Lifehacks NaviHaka</a></li>
<li><a href="../de428209/index.html">Entwicklerkochbuch: Domain Driven Design Rezepte (Teil 2, Struktur und Interaktion)</a></li>
<li><a href="../de428211/index.html">Das Buch ‚ÄûEvolution√§re Architektur. Unterst√ºtzung f√ºr st√§ndigen Wandel "</a></li>
<li><a href="../de428213/index.html">Interpretieren von Modellvorhersagen in SHAP</a></li>
<li><a href="../de428219/index.html">Woher kommt die Praxis der Massenverlagerung von qualifiziertem Personal?</a></li>
<li><a href="../de428221/index.html">KI-Erzeugung realistischer Gesichter</a></li>
<li><a href="../de428223/index.html">St√§dte und ihre Big Data</a></li>
<li><a href="../de428225/index.html">So f√ºhren Sie Webanalysen f√ºr SaaS √ºber Google Analytics durch: Einf√ºhrung und Verfolgung eines Trichters</a></li>
<li><a href="../de428227/index.html">Maschinelles Lernen: Vorhersage der Aktienkurse an der B√∂rse</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>