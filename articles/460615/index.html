<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üññüèª üë©üèø‚Äçüè≠ ‚èπÔ∏è A ra√≠z de Industrial Ninja: c√≥mo se pirate√≥ PLC en Positive Hack Days 9 üêè üö• üë®üèº‚Äçüé§</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="En PHDays 9, realizamos un concurso para piratear una planta de bombeo de gas: el concurso Industrial Ninja . Hab√≠a tres stands en el sitio con varios...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>A ra√≠z de Industrial Ninja: c√≥mo se pirate√≥ PLC en Positive Hack Days 9</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/pt/blog/460615/"> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><img src="https://habrastorage.org/webt/qt/2p/3g/qt2p3gfe43jhcxqqpuer8lzvgvc.png"></a> <br><br>  En PHDays 9, realizamos un concurso para piratear una planta de bombeo de gas: el concurso <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Industrial Ninja</a> .  Hab√≠a tres stands en el sitio con varios par√°metros de seguridad (Sin seguridad, Baja seguridad, Alta seguridad) que emulaban el mismo proceso industrial: se bombeaba aire al globo (y luego descend√≠a) bajo presi√≥n. <br><br>  A pesar de varios par√°metros de seguridad, el hardware de los stands era el mismo: Siemens Simatic S7-300 PLC;  bot√≥n de purga de emergencia y dispositivo de medici√≥n de presi√≥n (conectado a entradas digitales de PLC (DI));  v√°lvulas para bombeo y purga (conectadas a las salidas digitales del PLC (DO)) - vea la figura a continuaci√≥n. <br><br><img src="https://habrastorage.org/webt/2u/fq/om/2ufqommgoloxmjwohpy2sphrbha.png"><br><br>  El PLC, seg√∫n las lecturas de presi√≥n y de acuerdo con su programa, tom√≥ la decisi√≥n de soplar o soplar la bola (abri√≥ y cerr√≥ las v√°lvulas correspondientes).  Sin embargo, se proporcion√≥ un modo de control manual en todos los stands, lo que permiti√≥ controlar los estados de las v√°lvulas sin ninguna restricci√≥n. <br><br>  Los stands se distinguieron por la complejidad de habilitar este modo: en un stand sin protecci√≥n fue lo m√°s f√°cil de hacer, pero en el stand de Alta Seguridad, en consecuencia, fue m√°s dif√≠cil. <br><br>  En dos d√≠as, cinco de los seis problemas fueron resueltos;  El ganador del primer lugar obtuvo 233 puntos (pas√≥ una semana prepar√°ndose para la competencia).  Tres ganadores: coloco - a1exdandy, II - Rubikoid, III - Ze. <br><br>  Sin embargo, durante los PHDays, ninguno de los participantes pudo superar las tres posiciones, por lo que decidimos hacer una competencia en l√≠nea y publicamos la tarea m√°s dif√≠cil a principios de junio.  Los participantes tuvieron que completar la tarea en un mes, encontrar la bandera, describir la soluci√≥n en detalle e interesante. <br><br>  Bajo el corte, publicamos un an√°lisis de la mejor soluci√≥n para la tarea enviada durante el mes, fue encontrada por Alexey Kovrizhnykh (a1exdandy) de la compa√±√≠a de Seguridad Digital, quien ocup√≥ el primer lugar en la competencia durante PHDays.  A continuaci√≥n proporcionamos su texto con nuestros comentarios. <a name="habracut"></a><br><br><h2>  An√°lisis inicial </h2><br>  Entonces, en la tarea hab√≠a un archivo con archivos: <br><br><ul><li>  block_upload_traffic.pcapng </li><li>  DB100.bin </li><li>  hints.txt </li></ul><br>  El archivo hints.txt contiene la informaci√≥n necesaria y consejos para resolver la tarea.  Aqu√≠ est√°n sus contenidos: <br><br><blockquote><ol><li>  Petrovich me dijo ayer que desde PlcSim puedes descargar bloques en Step7. </li><li>  En el stand, se utilizaron PLC de la serie Siemens Simatic S7-300. </li><li>  PlcSim es un emulador de PLC que le permite ejecutar y depurar programas para PLC Siemens S7. </li></ol></blockquote><br><pre> El archivo DB100.bin, aparentemente, contiene un bloque de datos del PLC DB100: 00000000: 0100 0102 6e02 0401 0206 0100 0101 0102 .... n ........... 00000010: 1002 0501 0202 2002 0501 0206 0100 0102 ...... ......... 00000020: 0102 7702 0401 0206 0100 0103 0102 0a02 ..w ............. 00000030: 0501 0202 1602 0501 0206 0100 0104 0102 ................ 00000040: 7502 0401 0206 0100 0105 0102 0a02 0501 u ............... 00000050: 0202 1602 0501 0206 0100 0106 0102 3402 .............. 4.  00000060: 0401 0206 0100 0107 0102 2602 0501 0202 .......... &amp; ..... 00000070: 4c02 0501 0206 0100 0108 0102 3302 0401 L ........... 3. .. 00000080: 0206 0100 0109 0102 0a02 0501 0202 1602 ................ 00000090: 0501 0206 0100 010a 0102 3702 0401 0206 .......... 7. .... 000000a0: 0100 010b 0102 2202 0501 0202 4602 0501 ...... "..... F ... 000000b0: 0206 0100 010c 0102 3302 0401 0206 0100 ........ 3. ...... 000000c0: 010d 0102 0a02 0501 0202 1602 0501 0206 ................ 000000d0: 0100 010e 0102 6d02 0401 0206 0100 010f ...... m. ........ 000000e0: 0102 1102 0501 0202 2302 0501 0206 0100 ........ # ....... 000000f0: 0110 0102 3502 0401 0206 0100 0111 0102 .... 5. .......... 00000100: 1202 0501 0202 2502 0501 0206 0100 0112 ......% ......... 00000110: 0102 3302 0401 0206 0100 0113 0102 2602 ..3. .......... &amp;. 00000120: 0501 0202 4c02 0501 0206 0100 .... L ....... </pre><br>  A juzgar por el nombre, el archivo block_upload_traffic.pcapng contiene un volcado de tr√°fico de carga de bloques al PLC. <br><br>  Vale la pena se√±alar que este volcado de tr√°fico en el sitio de la competencia durante la conferencia fue un poco m√°s dif√≠cil de conseguir.  Para hacer esto, era necesario comprender el script del archivo del proyecto para TeslaSCADA2.  A partir de √©l, fue posible comprender d√≥nde se encuentra el volcado cifrado con RC4 y qu√© clave se debe utilizar para descifrarlo.  Se pueden obtener volcados de bloques de datos en el sitio utilizando el cliente de protocolo S7.  Utilic√© el cliente de demostraci√≥n del paquete Snap7 para esto. <br><br><h2>  Extraer unidades de procesamiento de se√±ales de un volcado de tr√°fico </h2><br>  Al observar el contenido del volcado, puede comprender que los bloques de procesamiento de se√±al OB1, FC1, FC2 y FC3 se transmiten en √©l: <br><br><img src="https://habrastorage.org/webt/sz/43/yd/sz43ydme-e17zhg3yuudd1xxmva.png"><br><br>  Es necesario extraer estos bloques.  Esto se puede hacer, por ejemplo, con el siguiente script, despu√©s de convertir el tr√°fico del formato pcapng a pcap: <br><br><pre><code class="python hljs"><span class="hljs-comment"><span class="hljs-comment">#!/usr/bin/env python2 import struct from scapy.all import * packets = rdpcap('block_upload_traffic.pcap') s7_hdr_struct = '&gt;BBHHHHBB' s7_hdr_sz = struct.calcsize(s7_hdr_struct) tpkt_cotp_sz = 7 names = iter(['OB1.bin', 'FC1.bin', 'FC2.bin', 'FC3.bin']) buf = '' for packet in packets: if packet.getlayer(IP).src == '10.0.102.11': tpkt_cotp_s7 = str(packet.getlayer(TCP).payload) if len(tpkt_cotp_s7) &lt; tpkt_cotp_sz + s7_hdr_sz: continue s7 = tpkt_cotp_s7[tpkt_cotp_sz:] s7_hdr = s7[:s7_hdr_sz] param_sz = struct.unpack(s7_hdr_struct, s7_hdr)[4] s7_param = s7[12:12+param_sz] s7_data = s7[12+param_sz:] if s7_param in ('\x1e\x00', '\x1e\x01'): # upload buf += s7_data[4:] elif s7_param == '\x1f': with open(next(names), 'wb') as f: f.write(buf) buf = ''</span></span></code> </pre> <br>  Despu√©s de estudiar los bloques recibidos, puede observar que siempre comienzan con los bytes 70 70 (pp).  Ahora necesita aprender a analizarlos.  Una sugerencia para la tarea sugiere que necesita usar PlcSim para esto. <br><br><h2>  Obteniendo instrucciones legibles por humanos de bloques </h2><br>  Primero, intentemos programar S7-PlcSim cargando varios bloques con instrucciones repetitivas (= Q 0.0) usando el software Simatic Manager, y guarde el resultado en el emulador PLC en el archivo example.plc.  Al observar el contenido del archivo, puede determinar f√°cilmente el comienzo de los bloques cargados mediante la firma 70 70, que descubrimos anteriormente.  Antes de los bloques, aparentemente, el tama√±o del bloque se escribe en forma de un valor little-endian de 4 bytes. <br><br><img src="https://habrastorage.org/webt/01/vp/ra/01vpra5veml-vbfozvhainxy-ig.png"><br><br>  Despu√©s de recibir informaci√≥n sobre la estructura de los archivos plc, apareci√≥ el siguiente plan de acci√≥n para leer programas PLC S7: <br><br><ol><li>  Usando el Administrador Simatic, creamos una estructura de bloques en S7-PlcSim similar a la que obtuvimos del volcado.  Los tama√±os de bloque deben coincidir (logrado al llenar los bloques con el n√∫mero correcto de instrucciones) y sus identificadores (OB1, FC1, FC2, FC3). </li><li>  Guarde el PLC en un archivo. </li><li>  Reemplazamos el contenido de los bloques en el archivo recibido con los bloques del volcado de tr√°fico.  El comienzo de los bloques est√° determinado por la firma. </li><li>  El archivo resultante se carga en S7-PlcSim y observamos el contenido de los bloques en Simatic Manager. </li></ol><br>  Los bloques se pueden reemplazar, por ejemplo, con el siguiente c√≥digo: <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">with</span></span> open(<span class="hljs-string"><span class="hljs-string">'original.plc'</span></span>, <span class="hljs-string"><span class="hljs-string">'rb'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> f: plc = f.read() blocks = [] <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> fname <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> [<span class="hljs-string"><span class="hljs-string">'OB1.bin'</span></span>, <span class="hljs-string"><span class="hljs-string">'FC1.bin'</span></span>, <span class="hljs-string"><span class="hljs-string">'FC2.bin'</span></span>, <span class="hljs-string"><span class="hljs-string">'FC3.bin'</span></span>]: <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> open(fname, <span class="hljs-string"><span class="hljs-string">'rb'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> f: blocks.append(f.read()) i = plc.find(<span class="hljs-string"><span class="hljs-string">b'pp'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> block <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> blocks: plc = plc[:i] + block + plc[i+len(block):] i = plc.find(<span class="hljs-string"><span class="hljs-string">b'pp'</span></span>, i + <span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> open(<span class="hljs-string"><span class="hljs-string">'target.plc'</span></span>, <span class="hljs-string"><span class="hljs-string">'wb'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> f: f.write(plc)</code> </pre> <br><blockquote>  Aleksey sigui√≥ un camino posiblemente m√°s complicado, pero a√∫n as√≠.  Asumimos que los participantes usar√≠an el programa NetToPlcSim para que PlcSim pudiera comunicarse a trav√©s de la red, cargar bloques en PlcSim a trav√©s de Snap7 y luego descargar estos bloques como un proyecto desde PlcSim usando el entorno de desarrollo. </blockquote><br>  Al abrir el archivo resultante en S7-PlcSim, puede leer bloques sobrescritos utilizando Simatic Manager.  Las principales funciones de gesti√≥n de dispositivos se registran en el bloque FC1.  La variable # TEMP0 atrae especial atenci√≥n, cuando se enciende, parece que el control del PLC se cambia al modo manual en funci√≥n de los valores de la memoria de bits M2.2 y M2.3.  # TEMP0 es configurado por FC3. <br><br><img src="https://habrastorage.org/webt/02/tq/pt/02tqptegvjst2hzny9d8sc4rmva.png"><br><br>  Para resolver el problema, es necesario analizar la funci√≥n FC3 y comprender lo que hay que hacer para que devuelva una unidad l√≥gica. <br><br>  Los bloques de procesamiento de se√±al PLC en el stand de baja seguridad en el sitio de la competencia se organizaron de la misma manera, pero para establecer el valor de la variable # TEMP0, fue suficiente para escribir la l√≠nea de mi camino ninja al bloque DB1.  La comprobaci√≥n del valor en el bloque se organiz√≥ claramente y no requiri√≥ un conocimiento profundo del lenguaje de programaci√≥n del bloque.  Obviamente, en el nivel de Alta Seguridad, ser√° mucho m√°s dif√≠cil lograr el control manual y es necesario comprender las complejidades del lenguaje STL (una de las formas de programar el PLC S7). <br><br><h2>  Reverse Block FC3 </h2><br><div class="spoiler">  <b class="spoiler_title">El contenido del bloque FC3 en la representaci√≥n STL:</b> <div class="spoiler_text"><pre> <code class="python hljs"> LB<span class="hljs-comment"><span class="hljs-comment">#16#0 T #TEMP13 T #TEMP15 LP#DBX 0.0 T #TEMP4 CLR = #TEMP14 M015: L #TEMP4 LAR1 OPN DB 100 L DBLG TAR1 &lt;=D JC M016 L DW#16#0 T #TEMP0 L #TEMP6 LW#16#0 &lt;&gt;I JC M00d LP#DBX 0.0 LAR1 M00d: LB [AR1,P#0.0] T #TEMP5 LW#16#1 ==I JC M007 L #TEMP5 LW#16#2 ==I JC M008 L #TEMP5 LW#16#3 ==I JC M00f L #TEMP5 LW#16#4 ==I JC M00e L #TEMP5 LW#16#5 ==I JC M011 L #TEMP5 LW#16#6 ==I JC M012 JU M010 M007: +AR1 P#1.0 LP#DBX 0.0 LAR2 LB [AR1,P#0.0] LC#8 *I +AR2 +AR1 P#1.0 LB [AR1,P#0.0] JL M003 JU M001 JU M002 JU M004 M003: JU M005 M001: OPN DB 101 LB [AR2,P#0.0] T #TEMP0 JU M006 M002: OPN DB 101 LB [AR2,P#0.0] T #TEMP1 JU M006 M004: OPN DB 101 LB [AR2,P#0.0] T #TEMP2 JU M006 M00f: +AR1 P#1.0 LB [AR1,P#0.0] LC#8 *IT #TEMP11 +AR1 P#1.0 LB [AR1,P#0.0] T #TEMP7 LP#M 100.0 LAR2 L #TEMP7 LC#8 *I +AR2 TAR2 #TEMP9 TAR1 #TEMP4 OPN DB 101 LP#DBX 0.0 LAR1 L #TEMP11 +AR1 LAR2 #TEMP9 LB [AR2,P#0.0] TB [AR1,P#0.0] L #TEMP4 LAR1 JU M006 M008: +AR1 P#1.0 LB [AR1,P#0.0] T #TEMP3 +AR1 P#1.0 LB [AR1,P#0.0] JL M009 JU M00b JU M00a JU M00c M009: JU M005 M00b: L #TEMP3 T #TEMP0 JU M006 M00a: L #TEMP3 T #TEMP1 JU M006 M00c: L #TEMP3 T #TEMP2 JU M006 M00e: +AR1 P#1.0 LB [AR1,P#0.0] T #TEMP7 LP#M 100.0 LAR2 L #TEMP7 LC#8 *I +AR2 TAR2 #TEMP9 +AR1 P#1.0 LB [AR1,P#0.0] T #TEMP8 LP#M 100.0 LAR2 L #TEMP8 LC#8 *I +AR2 TAR2 #TEMP10 TAR1 #TEMP4 LAR1 #TEMP9 LAR2 #TEMP10 LB [AR1,P#0.0] LB [AR2,P#0.0] AW INVI T #TEMP12 LB [AR1,P#0.0] LB [AR2,P#0.0] OW L #TEMP12 AW TB [AR1,P#0.0] L DW#16#0 T #TEMP0 L MB 101 T #TEMP1 L MB 102 T #TEMP2 L #TEMP4 LAR1 JU M006 M011: +AR1 P#1.0 LB [AR1,P#0.0] T #TEMP7 LP#M 100.0 LAR2 L #TEMP7 LC#8 *I +AR2 TAR2 #TEMP9 +AR1 P#1.0 LB [AR1,P#0.0] T #TEMP8 LP#M 100.0 LAR2 L #TEMP8 LC#8 *I +AR2 TAR2 #TEMP10 TAR1 #TEMP4 LAR1 #TEMP9 LAR2 #TEMP10 LB [AR1,P#0.0] LB [AR2,P#0.0] -ITB [AR1,P#0.0] L DW#16#0 T #TEMP0 L MB 101 T #TEMP1 L MB 102 T #TEMP2 L #TEMP4 LAR1 JU M006 M012: L #TEMP15 INC 1 T #TEMP15 +AR1 P#1.0 LB [AR1,P#0.0] T #TEMP7 LP#M 100.0 LAR2 L #TEMP7 LC#8 *I +AR2 TAR2 #TEMP9 +AR1 P#1.0 LB [AR1,P#0.0] T #TEMP8 LP#M 100.0 LAR2 L #TEMP8 LC#8 *I +AR2 TAR2 #TEMP10 TAR1 #TEMP4 LAR1 #TEMP9 LAR2 #TEMP10 LB [AR1,P#0.0] LB [AR2,P#0.0] ==I JCN M013 JU M014 M013: LP#DBX 0.0 LAR1 T #TEMP4 LB#16#0 T #TEMP6 JU M006 M014: L #TEMP4 LAR1 L #TEMP13 LL#1 +IT #TEMP13 JU M006 M006: L #TEMP0 T MB 100 L #TEMP1 T MB 101 L #TEMP2 T MB 102 +AR1 P#1.0 L #TEMP6 + 1 T #TEMP6 JU M005 M010: LP#DBX 0.0 LAR1 L 0 T #TEMP6 TAR1 #TEMP4 M005: TAR1 #TEMP4 CLR = #TEMP16 L #TEMP13 LL#20 ==IS #TEMP16 L #TEMP15 ==IA #TEMP16 JC M017 L #TEMP13 LL#20 &lt;IS #TEMP16 L #TEMP15 ==IA #TEMP16 JC M018 JU M019 M017: SET = #TEMP14 JU M016 M018: CLR = #TEMP14 JU M016 M019: CLR O #TEMP14 = #RET_VAL JU M015 M016: CLR O #TEMP14 = #RET_VAL</span></span></code> </pre> </div></div><br>  El c√≥digo es bastante voluminoso y para una persona que no est√° familiarizada con STL, puede parecer complicado.  No tiene sentido desarmar cada instrucci√≥n en el marco de este art√≠culo, para obtener instrucciones detalladas y las caracter√≠sticas del lenguaje STL, consulte el manual correspondiente: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Lista de</a> instrucciones <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">(STL) para la programaci√≥n S7-300 y S7-400</a> .  Aqu√≠ dar√© el mismo c√≥digo despu√©s del procesamiento: renombrar etiquetas y variables y agregar comentarios que describan el algoritmo de trabajo y algunas construcciones del lenguaje STL.  Noto de inmediato que en el bloque en consideraci√≥n se implementa una m√°quina virtual que ejecuta alg√∫n c√≥digo de bytes ubicado en el bloque DB100, cuyo contenido conocemos.  Las instrucciones de la m√°quina virtual son 1 byte de c√≥digo operativo y bytes de argumentos, un byte para cada argumento.  Todas las instrucciones revisadas tienen dos argumentos, design√© sus valores en los comentarios como X e Y. <br><br><div class="spoiler">  <b class="spoiler_title">C√≥digo de procesamiento posterior</b> <div class="spoiler_text">  ] <br><pre> <code class="perl hljs"><span class="hljs-comment"><span class="hljs-comment">#    LB#16#0 T #CHECK_N #     T #COUNTER_N #     LP#DBX 0.0 T #POINTER #     CLR = #PRE_RET_VAL #     - LOOP: L #POINTER LAR1 OPN DB 100 L DBLG TAR1 &lt;=D #       JC FINISH L DW#16#0 T #REG0 L #TEMP6 LW#16#0 &lt;&gt;I JC M00d LP#DBX 0.0 LAR1 #  switch - case     M00d: LB [AR1,P#0.0] T #OPCODE LW#16#1 ==I JC OPCODE_1 L #OPCODE LW#16#2 ==I JC OPCODE_2 L #OPCODE LW#16#3 ==I JC OPCODE_3 L #OPCODE LW#16#4 ==I JC OPCODE_4 L #OPCODE LW#16#5 ==I JC OPCODE_5 L #OPCODE LW#16#6 ==I JC OPCODE_6 JU OPCODE_OTHER #   01:    DB101[X]   Y # OP01(X, Y): REG[Y] = DB101[X] OPCODE_1: +AR1 P#1.0 LP#DBX 0.0 LAR2 LB [AR1,P#0.0] #   X (  DB101) LC#8 *I +AR2 +AR1 P#1.0 LB [AR1,P#0.0] #   Y ( ) JL M003 #  switch - case    Y JU M001 #      . JU M002 #       JU M004 #      M003: JU LOOPEND M001: OPN DB 101 LB [AR2,P#0.0] T #REG0 #   DB101[X]  REG[0] JU PRE_LOOPEND M002: OPN DB 101 LB [AR2,P#0.0] T #REG1 #   DB101[X]  REG[1] JU PRE_LOOPEND M004: OPN DB 101 LB [AR2,P#0.0] T #REG2 #   DB101[X]  REG[2] JU PRE_LOOPEND #   02:   X   Y # OP02(X, Y): REG[Y] = X OPCODE_2: +AR1 P#1.0 LB [AR1,P#0.0] T #TEMP3 +AR1 P#1.0 LB [AR1,P#0.0] JL M009 JU M00b JU M00a JU M00c M009: JU LOOPEND M00b: L #TEMP3 T #REG0 JU PRE_LOOPEND M00a: L #TEMP3 T #REG1 JU PRE_LOOPEND M00c: L #TEMP3 T #REG2 JU PRE_LOOPEND #  03    ,    ... #   04:   X  Y # OP04(X, Y): REG[0] = 0; REG[X] = (REG[X] == REG[Y]) OPCODE_4: +AR1 P#1.0 LB [AR1,P#0.0] T #TEMP7 #   - X LP#M 100.0 LAR2 L #TEMP7 LC#8 *I +AR2 TAR2 #TEMP9 # REG[X] +AR1 P#1.0 LB [AR1,P#0.0] T #TEMP8 LP#M 100.0 LAR2 L #TEMP8 LC#8 *I +AR2 TAR2 #TEMP10 # REG[Y] TAR1 #POINTER LAR1 #TEMP9 # REG[X] LAR2 #TEMP10 # REG[Y] LB [AR1,P#0.0] LB [AR2,P#0.0] AW INVI T #TEMP12 # ~(REG[Y] &amp; REG[X]) LB [AR1,P#0.0] LB [AR2,P#0.0] OW L #TEMP12 AW # (~(REG[Y] &amp; REG[X])) &amp; (REG[Y] | REG[X]) -     TB [AR1,P#0.0] L DW#16#0 T #REG0 L MB 101 T #REG1 L MB 102 T #REG2 L #POINTER LAR1 JU PRE_LOOPEND #   05:   Y  X # OP05(X, Y): REG[0] = 0; REG[X] = REG[X] - REG[Y] OPCODE_5: +AR1 P#1.0 LB [AR1,P#0.0] T #TEMP7 LP#M 100.0 LAR2 L #TEMP7 LC#8 *I +AR2 TAR2 #TEMP9 # REG[X] +AR1 P#1.0 LB [AR1,P#0.0] T #TEMP8 LP#M 100.0 LAR2 L #TEMP8 LC#8 *I +AR2 TAR2 #TEMP10 # REG[Y] TAR1 #POINTER LAR1 #TEMP9 LAR2 #TEMP10 LB [AR1,P#0.0] LB [AR2,P#0.0] -I # ACCU1 = ACCU2 - ACCU1, REG[X] - REG[Y] TB [AR1,P#0.0] L DW#16#0 T #REG0 L MB 101 T #REG1 L MB 102 T #REG2 L #POINTER LAR1 JU PRE_LOOPEND #   06:  #CHECK_N    X  Y # OP06(X, Y): #CHECK_N += (1 if REG[X] == REG[Y] else 0) OPCODE_6: L #COUNTER_N INC 1 T #COUNTER_N +AR1 P#1.0 LB [AR1,P#0.0] T #TEMP7 # REG[X] LP#M 100.0 LAR2 L #TEMP7 LC#8 *I +AR2 TAR2 #TEMP9 # REG[X] +AR1 P#1.0 LB [AR1,P#0.0] T #TEMP8 LP#M 100.0 LAR2 L #TEMP8 LC#8 *I +AR2 TAR2 #TEMP10 # REG[Y] TAR1 #POINTER LAR1 #TEMP9 # REG[Y] LAR2 #TEMP10 # REG[X] LB [AR1,P#0.0] LB [AR2,P#0.0] ==I JCN M013 JU M014 M013: LP#DBX 0.0 LAR1 T #POINTER LB#16#0 T #TEMP6 JU PRE_LOOPEND M014: L #POINTER LAR1 #   #CHECK_N L #CHECK_N LL#1 +IT #CHECK_N JU PRE_LOOPEND PRE_LOOPEND: L #REG0 T MB 100 L #REG1 T MB 101 L #REG2 T MB 102 +AR1 P#1.0 L #TEMP6 + 1 T #TEMP6 JU LOOPEND OPCODE_OTHER: LP#DBX 0.0 LAR1 L 0 T #TEMP6 TAR1 #POINTER LOOPEND: TAR1 #POINTER CLR = #TEMP16 L #CHECK_N LL#20 ==IS #TEMP16 L #COUNTER_N ==IA #TEMP16 #   ,  #CHECK_N == #COUNTER_N == 20 JC GOOD L #CHECK_N LL#20 &lt;IS #TEMP16 L #COUNTER_N ==IA #TEMP16 JC FAIL JU M019 GOOD: SET = #PRE_RET_VAL JU FINISH FAIL: CLR = #PRE_RET_VAL JU FINISH M019: CLR O #PRE_RET_VAL = #RET_VAL JU LOOP FINISH: CLR O #PRE_RET_VAL = #RET_VAL</span></span></code> </pre> </div></div><br>  Despu√©s de tener una idea de las instrucciones de la m√°quina virtual, escribiremos un peque√±o desensamblador para analizar el c√≥digo de bytes en el bloque DB100: <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> string alph = string.ascii_letters + string.digits <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> open(<span class="hljs-string"><span class="hljs-string">'DB100.bin'</span></span>, <span class="hljs-string"><span class="hljs-string">'rb'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> f: m = f.read() pc = <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> pc &lt; len(m): op = m[pc] <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> op == <span class="hljs-number"><span class="hljs-number">1</span></span>: print(<span class="hljs-string"><span class="hljs-string">'R{} = DB101[{}]'</span></span>.format(m[pc + <span class="hljs-number"><span class="hljs-number">2</span></span>], m[pc + <span class="hljs-number"><span class="hljs-number">1</span></span>])) pc += <span class="hljs-number"><span class="hljs-number">3</span></span> <span class="hljs-keyword"><span class="hljs-keyword">elif</span></span> op == <span class="hljs-number"><span class="hljs-number">2</span></span>: c = chr(m[pc + <span class="hljs-number"><span class="hljs-number">1</span></span>]) c = c <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> c <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> alph <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-string"><span class="hljs-string">'?'</span></span> print(<span class="hljs-string"><span class="hljs-string">'R{} = {:02x} ({})'</span></span>.format(m[pc + <span class="hljs-number"><span class="hljs-number">2</span></span>], m[pc + <span class="hljs-number"><span class="hljs-number">1</span></span>], c)) pc += <span class="hljs-number"><span class="hljs-number">3</span></span> <span class="hljs-keyword"><span class="hljs-keyword">elif</span></span> op == <span class="hljs-number"><span class="hljs-number">4</span></span>: print(<span class="hljs-string"><span class="hljs-string">'R0 = 0; R{} = (R{} == R{})'</span></span>.format( m[pc + <span class="hljs-number"><span class="hljs-number">1</span></span>], m[pc + <span class="hljs-number"><span class="hljs-number">1</span></span>], m[pc + <span class="hljs-number"><span class="hljs-number">2</span></span>])) pc += <span class="hljs-number"><span class="hljs-number">3</span></span> <span class="hljs-keyword"><span class="hljs-keyword">elif</span></span> op == <span class="hljs-number"><span class="hljs-number">5</span></span>: print(<span class="hljs-string"><span class="hljs-string">'R0 = 0; R{} = R{} - R{}'</span></span>.format( m[pc + <span class="hljs-number"><span class="hljs-number">1</span></span>], m[pc + <span class="hljs-number"><span class="hljs-number">1</span></span>], m[pc + <span class="hljs-number"><span class="hljs-number">2</span></span>])) pc += <span class="hljs-number"><span class="hljs-number">3</span></span> <span class="hljs-keyword"><span class="hljs-keyword">elif</span></span> op == <span class="hljs-number"><span class="hljs-number">6</span></span>: print(<span class="hljs-string"><span class="hljs-string">'CHECK (R{} == R{})\n'</span></span>.format( m[pc + <span class="hljs-number"><span class="hljs-number">1</span></span>], m[pc + <span class="hljs-number"><span class="hljs-number">2</span></span>])) pc += <span class="hljs-number"><span class="hljs-number">3</span></span> <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>: print(<span class="hljs-string"><span class="hljs-string">'unk opcode {}'</span></span>.format(op)) <span class="hljs-keyword"><span class="hljs-keyword">break</span></span></code> </pre> <br>  Como resultado, obtenemos el siguiente c√≥digo de m√°quina virtual: <br><br><div class="spoiler">  <b class="spoiler_title">C√≥digo de m√°quina virtual</b> <div class="spoiler_text"><pre> <code class="python hljs">R1 = DB101[<span class="hljs-number"><span class="hljs-number">0</span></span>] R2 = <span class="hljs-number"><span class="hljs-number">6</span></span>e (n) R0 = <span class="hljs-number"><span class="hljs-number">0</span></span>; R1 = (R1 == R2) CHECK (R1 == R0) R1 = DB101[<span class="hljs-number"><span class="hljs-number">1</span></span>] R2 = <span class="hljs-number"><span class="hljs-number">10</span></span> (?) R0 = <span class="hljs-number"><span class="hljs-number">0</span></span>; R1 = R1 - R2 R2 = <span class="hljs-number"><span class="hljs-number">20</span></span> (?) R0 = <span class="hljs-number"><span class="hljs-number">0</span></span>; R1 = R1 - R2 CHECK (R1 == R0) R1 = DB101[<span class="hljs-number"><span class="hljs-number">2</span></span>] R2 = <span class="hljs-number"><span class="hljs-number">77</span></span> (w) R0 = <span class="hljs-number"><span class="hljs-number">0</span></span>; R1 = (R1 == R2) CHECK (R1 == R0) R1 = DB101[<span class="hljs-number"><span class="hljs-number">3</span></span>] R2 = <span class="hljs-number"><span class="hljs-number">0</span></span>a (?) R0 = <span class="hljs-number"><span class="hljs-number">0</span></span>; R1 = R1 - R2 R2 = <span class="hljs-number"><span class="hljs-number">16</span></span> (?) R0 = <span class="hljs-number"><span class="hljs-number">0</span></span>; R1 = R1 - R2 CHECK (R1 == R0) R1 = DB101[<span class="hljs-number"><span class="hljs-number">4</span></span>] R2 = <span class="hljs-number"><span class="hljs-number">75</span></span> (u) R0 = <span class="hljs-number"><span class="hljs-number">0</span></span>; R1 = (R1 == R2) CHECK (R1 == R0) R1 = DB101[<span class="hljs-number"><span class="hljs-number">5</span></span>] R2 = <span class="hljs-number"><span class="hljs-number">0</span></span>a (?) R0 = <span class="hljs-number"><span class="hljs-number">0</span></span>; R1 = R1 - R2 R2 = <span class="hljs-number"><span class="hljs-number">16</span></span> (?) R0 = <span class="hljs-number"><span class="hljs-number">0</span></span>; R1 = R1 - R2 CHECK (R1 == R0) R1 = DB101[<span class="hljs-number"><span class="hljs-number">6</span></span>] R2 = <span class="hljs-number"><span class="hljs-number">34</span></span> (<span class="hljs-number"><span class="hljs-number">4</span></span>) R0 = <span class="hljs-number"><span class="hljs-number">0</span></span>; R1 = (R1 == R2) CHECK (R1 == R0) R1 = DB101[<span class="hljs-number"><span class="hljs-number">7</span></span>] R2 = <span class="hljs-number"><span class="hljs-number">26</span></span> (?) R0 = <span class="hljs-number"><span class="hljs-number">0</span></span>; R1 = R1 - R2 R2 = <span class="hljs-number"><span class="hljs-number">4</span></span>c (L) R0 = <span class="hljs-number"><span class="hljs-number">0</span></span>; R1 = R1 - R2 CHECK (R1 == R0) R1 = DB101[<span class="hljs-number"><span class="hljs-number">8</span></span>] R2 = <span class="hljs-number"><span class="hljs-number">33</span></span> (<span class="hljs-number"><span class="hljs-number">3</span></span>) R0 = <span class="hljs-number"><span class="hljs-number">0</span></span>; R1 = (R1 == R2) CHECK (R1 == R0) R1 = DB101[<span class="hljs-number"><span class="hljs-number">9</span></span>] R2 = <span class="hljs-number"><span class="hljs-number">0</span></span>a (?) R0 = <span class="hljs-number"><span class="hljs-number">0</span></span>; R1 = R1 - R2 R2 = <span class="hljs-number"><span class="hljs-number">16</span></span> (?) R0 = <span class="hljs-number"><span class="hljs-number">0</span></span>; R1 = R1 - R2 CHECK (R1 == R0) R1 = DB101[<span class="hljs-number"><span class="hljs-number">10</span></span>] R2 = <span class="hljs-number"><span class="hljs-number">37</span></span> (<span class="hljs-number"><span class="hljs-number">7</span></span>) R0 = <span class="hljs-number"><span class="hljs-number">0</span></span>; R1 = (R1 == R2) CHECK (R1 == R0) R1 = DB101[<span class="hljs-number"><span class="hljs-number">11</span></span>] R2 = <span class="hljs-number"><span class="hljs-number">22</span></span> (?) R0 = <span class="hljs-number"><span class="hljs-number">0</span></span>; R1 = R1 - R2 R2 = <span class="hljs-number"><span class="hljs-number">46</span></span> (F) R0 = <span class="hljs-number"><span class="hljs-number">0</span></span>; R1 = R1 - R2 CHECK (R1 == R0) R1 = DB101[<span class="hljs-number"><span class="hljs-number">12</span></span>] R2 = <span class="hljs-number"><span class="hljs-number">33</span></span> (<span class="hljs-number"><span class="hljs-number">3</span></span>) R0 = <span class="hljs-number"><span class="hljs-number">0</span></span>; R1 = (R1 == R2) CHECK (R1 == R0) R1 = DB101[<span class="hljs-number"><span class="hljs-number">13</span></span>] R2 = <span class="hljs-number"><span class="hljs-number">0</span></span>a (?) R0 = <span class="hljs-number"><span class="hljs-number">0</span></span>; R1 = R1 - R2 R2 = <span class="hljs-number"><span class="hljs-number">16</span></span> (?) R0 = <span class="hljs-number"><span class="hljs-number">0</span></span>; R1 = R1 - R2 CHECK (R1 == R0) R1 = DB101[<span class="hljs-number"><span class="hljs-number">14</span></span>] R2 = <span class="hljs-number"><span class="hljs-number">6</span></span>d (m) R0 = <span class="hljs-number"><span class="hljs-number">0</span></span>; R1 = (R1 == R2) CHECK (R1 == R0) R1 = DB101[<span class="hljs-number"><span class="hljs-number">15</span></span>] R2 = <span class="hljs-number"><span class="hljs-number">11</span></span> (?) R0 = <span class="hljs-number"><span class="hljs-number">0</span></span>; R1 = R1 - R2 R2 = <span class="hljs-number"><span class="hljs-number">23</span></span> (?) R0 = <span class="hljs-number"><span class="hljs-number">0</span></span>; R1 = R1 - R2 CHECK (R1 == R0) R1 = DB101[<span class="hljs-number"><span class="hljs-number">16</span></span>] R2 = <span class="hljs-number"><span class="hljs-number">35</span></span> (<span class="hljs-number"><span class="hljs-number">5</span></span>) R0 = <span class="hljs-number"><span class="hljs-number">0</span></span>; R1 = (R1 == R2) CHECK (R1 == R0) R1 = DB101[<span class="hljs-number"><span class="hljs-number">17</span></span>] R2 = <span class="hljs-number"><span class="hljs-number">12</span></span> (?) R0 = <span class="hljs-number"><span class="hljs-number">0</span></span>; R1 = R1 - R2 R2 = <span class="hljs-number"><span class="hljs-number">25</span></span> (?) R0 = <span class="hljs-number"><span class="hljs-number">0</span></span>; R1 = R1 - R2 CHECK (R1 == R0) R1 = DB101[<span class="hljs-number"><span class="hljs-number">18</span></span>] R2 = <span class="hljs-number"><span class="hljs-number">33</span></span> (<span class="hljs-number"><span class="hljs-number">3</span></span>) R0 = <span class="hljs-number"><span class="hljs-number">0</span></span>; R1 = (R1 == R2) CHECK (R1 == R0) R1 = DB101[<span class="hljs-number"><span class="hljs-number">19</span></span>] R2 = <span class="hljs-number"><span class="hljs-number">26</span></span> (?) R0 = <span class="hljs-number"><span class="hljs-number">0</span></span>; R1 = R1 - R2 R2 = <span class="hljs-number"><span class="hljs-number">4</span></span>c (L) R0 = <span class="hljs-number"><span class="hljs-number">0</span></span>; R1 = R1 - R2 CHECK (R1 == R0)</code> </pre> </div></div><br>  Como puede ver, este programa simplemente verifica la igualdad de cada s√≠mbolo de DB101 a un cierto valor.  La l√≠nea final para pasar todos los controles: n0w u 4r3 7h3 m4573r.  Si esta l√≠nea se coloca en el bloque DB101, se activa el control manual del PLC y ser√° posible inflar o desinflar el globo. <br><br>  Eso es todo!  Alexey demostr√≥ un alto nivel de conocimiento digno de un ninja industrial :) Enviamos premios memorables al ganador.  Muchas gracias a todos los participantes! </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/460615/">https://habr.com/ru/post/460615/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../460599/index.html">Noticias del mundo de OpenStreetMap No. 468 (07/02/2019 - 08/07/2019)</a></li>
<li><a href="../460603/index.html">V2G. Los autos el√©ctricos ayudar√°n a equilibrar la producci√≥n y el consumo de electricidad.</a></li>
<li><a href="../460605/index.html">Estudio fotogr√°fico autom√°tico, parte 1</a></li>
<li><a href="../460607/index.html">Tienda de aplicaciones de seguridad ofensiva con herramientas de hackeo de Android</a></li>
<li><a href="../460611/index.html">Conmutaci√≥n por error: el perfeccionismo nos arruina y ... la pereza</a></li>
<li><a href="../460617/index.html">Toda la verdad sobre RTOS. Art√≠culo # 30. Inicializaci√≥n de Nucleus SE y procedimientos de inicio</a></li>
<li><a href="../460621/index.html">Tic Tac Toe Parte 4: Interactuar con el backend de Flask usando HTTP</a></li>
<li><a href="../460623/index.html">Sobre la tortura de Julian Assange</a></li>
<li><a href="../460625/index.html">Como no ocup√© el primer lugar en la competencia para desarrolladores de JavaScript de Telegram</a></li>
<li><a href="../460627/index.html">vGPU: el uso no se puede ignorar</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>