<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üßíüèø üõåüèæ üßìüèª Set-Top-Box y experimentos con Android en el contenedor LXC üë©‚Äçüë¶‚Äçüë¶ ‚ôüÔ∏è üß•</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="C√≥mo surgi√≥ una extra√±a necesidad de ejecutar Android en un contenedor de Linux y qu√© surgi√≥ 

 Antecedentes 
 Ejecutar Android en el contenedor LXC, ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Set-Top-Box y experimentos con Android en el contenedor LXC</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/413809/">  C√≥mo surgi√≥ una extra√±a necesidad de ejecutar Android en un contenedor de Linux y qu√© surgi√≥ <br><br><h3>  Antecedentes </h3><br>  Ejecutar Android en el contenedor LXC, en mi opini√≥n, es una decisi√≥n l√≥gica si desea tener transparencia y confiabilidad de Bare Linux y utilizar el enorme potencial de buenas (y no tan buenas) aplicaciones de Android de terceros.  Adem√°s, esta configuraci√≥n es de inter√©s como plataforma para depurar su propia imagen AOSP en condiciones lo m√°s cercanas posible al combate. <a name="habracut"></a><br>  Para los experimentos, se seleccion√≥ un decodificador chino progresivo y econ√≥mico basado en ARMv8 de 64 bits de Amlogic S905x (CPU - 4 n√∫cleos, RAM - 2GB, MMC - 8GB).  Adem√°s, un buen argumento (en comparaci√≥n con otros proveedores) fue la base del c√≥digo en OpenSource y la presencia del controlador del n√∫cleo del n√∫cleo fuente para Mali-450.  Una biblioteca de espacio de usuario Mali hoy en el dominio p√∫blico en el sitio web oficial de ARM Limited.  Bibliotecas de acceso binario para Linux-FB, Linux-Wayland y Android. <br><br>  El objetivo principal de los experimentos fue la aplicaci√≥n de cines en l√≠nea y aplicaciones para trabajar con alojamiento de medios de red.  Por ejemplo, con Youtube en Linux, los problemas comenzaron de inmediato.  En primer lugar: el m√©todo hacker de obtener enlaces al contenido al analizar un script JS y generar una firma (previamente implementado en minitubo de Tordini y en youtube-dl) comenz√≥ a romperse regularmente debido a la lucha despiadada de Google con los m√©todos de rastreo de anuncios.  En segundo lugar: la resoluci√≥n m√°xima del contenido era 720p, no se emiti√≥ m√°s API de Google.  En tercer lugar: WebKit ha perdido el soporte normal y recientemente ha sido respaldado solo por un peque√±o grupo de entusiastas.  El mismo destino le sucedi√≥ a su puerto Qt.  Como resultado, en un momento, la p√°gina de youtube / tv se neg√≥ a funcionar, citando la vejez del motor web.  Bueno, al final, trajo una sorpresa WebEngine (Qt-Chromium).  Resulta que esta belleza no es compatible con la aceleraci√≥n de hardware.  Solo se hace una excepci√≥n para su puerto Android y la rama marginal VAAPI en Linux.  Callej√≥n sin salida.  En general, no encontr√© una manera simple de habilitar la decodificaci√≥n de video acelerada por hardware para Chromium en Linux.  Implementar VAAPI para Amlogic me pareci√≥ un trabajo duro e in√∫til.  Tambi√©n sent√≠ el complemento de pimienta, desafortunadamente PPAPI no permite reproducir videos fuera de pantalla. <br><br><h3>  Android </h3><br>  ¬øPor qu√© no ejecutar Android en un contenedor?  El proyecto Anbox inspir√≥ la haza√±a.  Un estudio exhaustivo de Anbox ha demostrado que no nos conviene.  Pero la idea era clara.  Los art√≠culos de otros autores afirman que ejecutar Android en un contenedor es una tarea tonta.  Pero, de hecho, todo result√≥ ser mucho m√°s complicado.  Simplemente configurando los archivos de configuraci√≥n, no pudimos salir. <br><br>  Entonces, recopilo LXC y lo instalo en el sistema.  La prueba de configuraci√≥n del n√∫cleo revela problemas: debe habilitar el soporte de espacio de nombres.  Como la plataforma est√° integrada, se deshabilitaron todo tipo de cosas innecesarias.  Tuve que identificar estos necesarios innecesarios. <br><br>  La primera prueba fue verificar Busybox en el contenedor.  Despu√©s de asegurarme de que todo funciona, comenc√© a experimentar. <br><br>  <i>La vista inicial es /var/lib/lxc/abox.conf:</i> <br><br><pre><code class="hljs ruby">lxc.rootfs = <span class="hljs-regexp"><span class="hljs-regexp">/var/lib</span></span><span class="hljs-regexp"><span class="hljs-regexp">/lxc/abox</span></span><span class="hljs-regexp"><span class="hljs-regexp">/rootfs lxc.rootfs.backend = dir lxc.utsname = abox lxc.pts = 1024 lxc.cap.drop = mac_admin mac_override</span></span></code> </pre> <br>  Descargar el bot√≠n chino manos AOSP 6.0.19.  Se diferencia de la versi√≥n vainilla por la presencia de un lanzador normal, agudizado por distash y revestimiento superficial r√≠gido con soporte para algunas caracter√≠sticas de la plataforma de hardware Amlogic.  El AOSP de vainilla tambi√©n fue probado posteriormente. <br><br>  <i>Una peque√±a desviaci√≥n del tema: los chinos, al adaptar el software, escupen todas las reglas establecidas por la comunidad.</i>  <i>Por ejemplo, el n√∫cleo 3.14.29.</i>  <i>Este n√∫mero de versi√≥n de kernel silencioso se usa en casi todo el hardware en los procesadores Amlogic S8xx y S9xx.</i>  <i>Pero, casi siempre, son muy diferentes entre s√≠, hasta la incompatibilidad completa de los m√≥dulos antiguos con nuevas im√°genes y viceversa.</i>  <i>Parece que el n√∫cleo se corrigi√≥ de acuerdo con el principio: "lo m√°s r√°pido posible la entrada del producto al mercado".</i>  <i>El c√≥digo no solo es sucio, es de una calidad desagradable.</i>  <i>Cambiar la configuraci√≥n generalmente conduce a errores al compilar o vincular la imagen o los m√≥dulos.</i>  <i>Android parcheado es de la misma calidad, y los principios de adaptaci√≥n son similares.</i>  <i>Casi todas las recomendaciones del equipo de AOSP son ignoradas.</i> <br><br>  Pues a donde ir!  Nosotros recogemos <br><br>  <b>Intento No. 1</b> Instale la imagen en el contenedor, ejecute.  No funciona  El an√°lisis muestra que no hay objetos del n√∫cleo: aglutinante y ashmem.  Agregamos m√≥dulos de kernel. <br><br>  <b>Intento No. 2</b> Comenzamos de nuevo.  Installd se bloquea.  Resulta que el archivador original no conoce los espacios de nombres.  Saca la carpeta de Anbox. <br><br>  <b>El intento n√∫mero 3</b> comienza e inmediatamente se reinicia.  Resulta que init quiere SELinux y se niega a trabajar sin √©l. <br><br>  <b>Intento No. 4</b> Encienda SELinux.  Tenemos un mont√≥n de problemas para el sistema host.  Tuve que apagarlo, al menos por ahora, hasta que se aclarara la esencia y la teor√≠a del proceso.  SELinux tambi√©n se puede deshabilitar en la l√≠nea de comando al cargar el kernel, pero a√∫n no entiendo c√≥mo pasar par√°metros al contenedor.  Tuve que entrar en la fuente init y corregir aproximadamente su comportamiento.  Esta fue la primera y √∫ltima intervenci√≥n quir√∫rgica que me lleg√≥ m√°s tarde. <br><br>  <b>Intento No. 5</b> El proceso de arranque lleg√≥ al cigoto.  En los registros, jurando desde el n√∫cleo en el UID init.  En la carpeta (y la carpeta de Anbox), el UID del proceso del propietario se compara f√°cilmente con la unidad.  La √∫nica forma es deshabilitar la verificaci√≥n, especialmente porque esta verificaci√≥n no tiene sentido en el contenedor. <br><br>  <b>Intento No. 6</b> Surgieron conflictos relacionados con el acceso compartido a la gesti√≥n de equipos.  Comento sobre los controles USB y Bluetooth en los guiones de inicio.  Elimino todas las entradas de fstab y proh√≠bo el montaje y la verificaci√≥n de todos los medios en scripts.  Ahora agregue la tarjeta de montaje a la configuraci√≥n del contenedor.  Contiene solo una l√≠nea.  El directorio /mnt/lxc.data est√° montado en el host en una partici√≥n MMC real. <br><br><pre> <code class="hljs haskell"><span class="hljs-title"><span class="hljs-title">lxc</span></span>.mount.entry = /mnt/lxc.<span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">data</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">data</span></span></span><span class="hljs-class"> auto rw,bind 0 0</span></span></code> </pre> <br>  <b>Intento No. 7</b> Bouncing balls apareci√≥ en la pantalla, la descarga lleva mucho tiempo, porque la imagen de Android est√° montada en NFS, y dexx tambi√©n se est√° generando en el directorio / data.  La recarga es muchas veces m√°s r√°pida.  Y finalmente, apareci√≥ el lanzador. <br>  Consideraremos que este es el √∫ltimo intento, porque, en general, todo funciona y debes terminar los detalles. <br><br>  La red no funciona, funciona con mayor precisi√≥n, pero algunas aplicaciones eval√∫an su rendimiento por el estado de las interfaces de red.  Manos torcidas, en una palabra.  Para eliminar este inconveniente en el host, elevamos el puente de red (bridge) y la interfaz virtual (veth). <br><br><pre> <code class="hljs ruby">lxc.network.type = veth lxc.network.flags = up lxc.network.name = eth1 lxc.network.link = br<span class="hljs-number"><span class="hljs-number">0</span></span> lxc.network.veth.pair = veth-<span class="hljs-number"><span class="hljs-number">01</span></span> lxc.network.ipv4 = <span class="hljs-number"><span class="hljs-number">10.0</span></span>.<span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-number"><span class="hljs-number">10</span></span>/<span class="hljs-number"><span class="hljs-number">24</span></span> lxc.network.ipv4.gateway = <span class="hljs-number"><span class="hljs-number">10.0</span></span>.<span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-number"><span class="hljs-number">1</span></span> lxc.network.hwaddr = <span class="hljs-number"><span class="hljs-number">00</span></span><span class="hljs-symbol"><span class="hljs-symbol">:FE</span></span><span class="hljs-symbol"><span class="hljs-symbol">:CD</span></span><span class="hljs-symbol"><span class="hljs-symbol">:BA</span></span><span class="hljs-symbol"><span class="hljs-symbol">:</span></span>09<span class="hljs-symbol"><span class="hljs-symbol">:</span></span><span class="hljs-number"><span class="hljs-number">87</span></span></code> </pre> <br>  Tambi√©n necesita elevar el servidor DHCP, de lo contrario habr√° problemas con el DNS.  Desafortunadamente, Android no analiza resolv.conf y su ubicaci√≥n en el sistema de archivos no juega ning√∫n papel.  Puede configurar la conexi√≥n de red manualmente, pero si elimina datos de la secci√≥n de datos, se restablecer√°n todas las configuraciones. <br><br><h3>  Resumen </h3><br>  Todas las aplicaciones de stock funcionan.  Con instalado desde el mercado hay problemas.  Por ejemplo: Youtube.tv versi√≥n 3 exigi√≥ actualizar el marco de servicio de Google, despu√©s de lo cual el sistema se bloque√≥.  Surgi√≥ un problema con el almac√©n de claves (a√∫n no resuelto).  TEE tambi√©n est√° temporalmente desactivado, por lo que widevine no funciona.  Los juguetes y las aplicaciones funcionan bien sin requisitos especiales de hardware.  Chrome tuerce el video HTML5 con un decodificador de software, se niega a conectar un decodificador de hardware.  En esta ocasi√≥n, hay una opini√≥n sobre el AOSP torcidamente arrastrado por los chinos.  Pero Vanilla AOSP lanza un lanzador con una pantalla t√°ctil: es imposible controlar la distancia. <br><br><h3>  Ep√≠logo </h3><br>  En un futuro cercano: hacer un lanzador para lanzar aplicaciones de Android directamente desde Linux.  Un ejemplo de esto est√° disponible en la fuente wpa-supplicant.  Tambi√©n puede echar un vistazo a c√≥mo se hace esto en Anbox. <br><br>  Gracias por su atencion! <br><br><h3>  Adici√≥n 1 </h3><br>  El otro d√≠a verifiqu√© la escalabilidad de las aplicaciones Qt.  Inicialmente, la aplicaci√≥n cliente de IPTV est√° escrita en QML para Linux.  El reproductor funciona a trav√©s del complemento QtMultimedia.  Durante la compilaci√≥n, surgieron dependencias problem√°ticas.  Afortunadamente, todo estaba limitado a QtDbus, que no est√° en Android.  Todav√≠a no entiendo por qu√© Android necesitaba reinventar la carpeta.  ¬øQu√© no les gust√≥ a los desarrolladores de DBus?  ¬øQue funciona en el espacio de usuario?  O consideraciones de licencia? <br>  DBus desconectado.  Esto fue sencillo, ya que el canal era necesario para un poco de funcionalidad relacionada con el sistema operativo.  APK reunido  No hay dificultad con el ensamblaje, ya que uso QtCreator (y se lo recomiendo). <br>  En AOSP, tuve que dibujar un puente Mediaplayer, un heredero de android :: MediaPlayerInterface.  Los m√©todos setDataSource () y stop () se implementaron en √©l.  Los enchufes est√°n hechos para el resto.  setDataSource tiene tres interfaces.  Se requer√≠a implementar solo: <br><pre> <code class="hljs objectivec">setDataSource(<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> sp&lt;IMediaHTTPService&gt; &amp;httpService, <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> *uri, <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> KeyedVector&lt;String8, String8&gt; *headers)</code> </pre><br><br>  <i>Si desea torcer archivos de medios, debe jugar con</i> <i><br></i> <pre> <i><code class="hljs cpp">setDataSource(<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> fd, <span class="hljs-keyword"><span class="hljs-keyword">int64_t</span></span> offset, <span class="hljs-keyword"><span class="hljs-keyword">int64_t</span></span> length)</code></i> </pre> <i><br></i>  <i>El nombre del archivo deber√° obtenerse a trav√©s de "/ proc / self / fd /" + fd;</i> <br><br>  Despu√©s de la instalaci√≥n, la aplicaci√≥n gan√≥ y la transmisi√≥n se fue.  Genial  Esperaba muchos problemas, pero casi no hay ninguno.  ¬°Gracias a los desarrolladores de Qt y QtCreator por el excelente y √∫til trabajo! <br>  Como resultado, obtuve un mont√≥n: el jugador del demonio anfitri√≥n.  En el contenedor, hay un programa de cliente y una tira que transmite llamadas de android :: Mediaplayer al host.  El paquete funciona a trav√©s de un socket UDP. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/es413809/">https://habr.com/ru/post/es413809/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../es413799/index.html">Raspberry Pi Neural Network Conteo de abejas</a></li>
<li><a href="../es413801/index.html">"Roskosmos" ofrece rehacer un ca√±√≥n l√°ser ... un telescopio √≥ptico</a></li>
<li><a href="../es413803/index.html">Pit√≥n y esteganograf√≠a</a></li>
<li><a href="../es413805/index.html">C√≥mo un servidor olvidado durante 12 a√±os puede costar 120,000 libras</a></li>
<li><a href="../es413807/index.html">Determinaci√≥n de las caracter√≠sticas bal√≠stico-temporales del movimiento del centro de masa de un paracaidista que aterriza desde un avi√≥n.</a></li>
<li><a href="../es413811/index.html">El resumen de materiales frescos del mundo del front-end para la √∫ltima semana No. 318 (4 al 10 de junio de 2018)</a></li>
<li><a href="../es413813/index.html">PHP Digest No. 132 (27 de mayo - 10 de junio de 2018)</a></li>
<li><a href="../es413815/index.html">Ir taller de contribuci√≥n en Rusia</a></li>
<li><a href="../es413817/index.html">Procesamiento de datos competitivos heterog√©neos en tiempo real estrictamente una vez</a></li>
<li><a href="../es413819/index.html">Sinceramente sobre el mercado de TI en Rusia</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>