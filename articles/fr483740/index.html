<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üé≠ üö∂üèª üéπ Configuration du routage dynamique (en particulier BGP) sur le tunnel OpenVPN sous Linux (et probablement * BSD) üé§ üåÄ ‚õ∫Ô∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Pourquoi et de quoi parle cet article? 


 Si vous google sur le sujet "openvpn bgp", vous pouvez trouver plusieurs articles int√©ressants et utiles d'...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Configuration du routage dynamique (en particulier BGP) sur le tunnel OpenVPN sous Linux (et probablement * BSD)</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/483740/"><h4>  Pourquoi et de quoi parle cet article? </h4><br><p>  Si vous google sur le sujet "openvpn bgp", vous pouvez trouver plusieurs articles int√©ressants et utiles d'un point de vue pratique (par exemple, <a href="https://habr.com/ru/post/348360/">une</a> ou <a href="https://habr.com/ru/post/354282/">deux fois</a> ).  Mais en commen√ßant √† r√©soudre le probl√®me dans le titre, pour de nombreuses raisons, je n'ai m√™me pas pris la peine de le rechercher sur Google.  L'id√©e est n√©e d'une mani√®re ou d'une autre au cours d'un long travail avec OpenVPN en g√©n√©ral (dans le cadre de t√¢ches assez typiques, avec un ensemble fixe de r√©seaux des deux c√¥t√©s), en travaillant avec la mise en ≈ìuvre d'OpenVPN sur le syst√®me RouterOS de MikroTik et en connectant les syst√®mes Linux et RouterOS entre eux.  En fait, dans le processus de r√©alisation des raisons pour √©crire notre propre impl√©mentation d'OpenVPN dans RouterOS, la ¬´perspicacit√©¬ª est venue sur la fa√ßon dont ce probl√®me peut √™tre r√©solu dans le cadre de l'√©dition OpenVPN √† personnel complet.  Ensuite, un court contr√¥le exp√©rimental a montr√© la pleine capacit√© de travail de l'id√©e et le lancement de cette solution en fonctionnement ¬´industriel¬ª. </p><br><p> Gardant √† l'esprit que cette situation est assez typique pour diff√©rentes applications et que la solution d√©crite ci-dessous n'a pas encore √©t√© pr√©sent√©e, j'ai d√©cid√© de partager l'id√©e avec la communaut√©. </p><br><a name="habracut"></a><br><h4>  L'essence du probl√®me ("qui est √† bl√¢mer?") </h4><br><p>  Quelle est la diff√©rence entre la version r√©guli√®re d'OpenVPN et celle qui est impl√©ment√©e dans RouterOS?  Il y a probablement quelques diff√©rences, mais dans cet article, nous ne consid√©rerons qu'une seule chose: l'OpenVPN normal dans les syst√®mes autres que RouterOS (et peut-√™tre certains autres) est une moissonneuse-batteuse qui contient la partie transport (c'est-√†-dire la transmission de paquets elle-m√™me, elle est √©galement en train de transmettre, c'est aussi un plan de donn√©es ) et le routage (c'est-√†-dire l'√©change d'informations sur les itin√©raires, c'est le routage, c'est aussi un plan de contr√¥le), et dans RouterOS, le service OpenVPN n'est responsable que <b>de la</b> partie <b>transport</b> , et le routage est g√©r√© par un processus syst√®me diff√©rent, ce qui permet, d'une part, de ne pas dupliquer la fonctionnalit√© du routage sous  (et de plus, ne conservez pas plusieurs tables de routage identiques dans diff√©rents services et synchronisez-les constamment les unes avec les autres), et d'autre part, permet un transfert transparent des tables de route sur ces v√©hicules et changez les tables de route des deux c√¥t√©s √† la vol√©e. </p><br><p>  De plus, l'impl√©mentation r√©guli√®re d'OpenVPN pr√©sente un autre inconv√©nient: le transfert de routes ne se produit que dans une seule direction (du serveur au client) et uniquement au moment de l'√©tablissement d'une session (c'est-√†-dire l'√©l√©vation du tunnel).  Il n'y a aucun moyen r√©gulier d'ajouter un itin√©raire √† la table de routage OpenVPN interne lors de vos d√©placements pendant le fonctionnement du tunnel, ainsi que de transf√©rer des itin√©raires d'un c√¥t√© √† l'autre.  De plus, il n'est m√™me pas possible d'obtenir la table de routage elle-m√™me. </p><br><h4>  Solution au probl√®me (¬´Que faire¬ª) </h4><br><p>  En analysant mes scripts qui automatisent l'attribution des routes √† diff√©rents clients, j'ai remarqu√© qu'OpenVPN a deux options diff√©rentes qui sp√©cifient les routes: </p><br><ul><li> <code><b>i</b> route</code> - d√©finit les routes <b>√†</b> l' <b>int√©rieur de</b> la table de routage du processus OpenVPN. </li><li>  <code>route</code> - d√©finit les routes que le processus OpenVPN transmet √† la table de routage syst√®me (c'est-√†-dire qu'il ajoute des routes √† la table via son interface de tunnel lors de la connexion et les supprime lorsqu'il est d√©connect√©). </li></ul><br><p>  La question √©vidente s'est pos√©e: que se passera-t-il si la <code><b>i</b> route</code> ajout√©e avec la route 0.0.0.0/0 des deux c√¥t√©s, puis les routes n√©cessaires (y compris celles qui apparaissent ou disparaissent dynamiquement) sont ajout√©es ou supprim√©es sur l'interface du tunnel elle-m√™me √† l'aide d'un service de routage ( en d√©route, z√®bre / quagga, oiseau, etc.)? </p><br><p>  L'exp√©rience a montr√© qu'un tel sch√©ma fonctionne vraiment avec un l√©ger inconv√©nient de restriction: un seul client peut √™tre connect√© √† un tunnel de serveur.  Le reste du circuit s'est av√©r√© √™tre pleinement op√©rationnel. </p><br><p>  Le sch√©ma fonctionne en mode TLS sur TCP, c'est-√†-dire que pour la configuration, vous devez d'abord g√©n√©rer des cl√©s et des certificats SSL. </p><br><p>  Ci-dessous, je donne un exemple de configuration OpenVPN pour le c√¥t√© serveur et client. </p><br><p>  Configuration c√¥t√© serveur (une pour chaque client). </p><br><p>  Fichier <code>server_dyn_rt.conf</code> (c√¥t√© serveur) </p><br><pre> <code class="plaintext hljs">daemon compress ping-timer-rem persist-tun persist-key tls-server proto tcp-server topology net30 mode server script-security 3 keepalive 15 45 tun-mtu 1500 remote-cert-tls client verify-x509-name &lt;CLIENT_DISTINGUISHED_NAME&gt; name auth &lt;TLS_AUTH_ALGORITHM&gt; cipher &lt;CIPHER_ALGORITHM&gt; local &lt;SERVER_PUBLIC_IP&gt; lport &lt;SERVER_PUBLIC_PORT&gt; dev-type tun dev &lt;TUNNEL_INTERFACE_NAME&gt; ifconfig &lt;TUNNEL_SERVER_SIDE_IP&gt; &lt;TUNNEL_CLIENT_SIDE_IP&gt; client-connect client_connect.sh push "route-gateway &lt;TUNNEL_SERVER_SIDE_IP&gt;" push "topology net30" push&amp;nbsp"persist-tun" push&amp;nbsp"persist-key" &lt;dh&gt; ... Diffie-Hellman data &lt;&lt;/dh&gt; &lt;ca&gt; ... Certificate Authority certificate data &lt;/ca&gt; &lt;cert&gt; ... Server certificate data &lt;/cert&gt; &lt;key&gt; ... Server Private Key data &lt;/key&gt;</code> </pre><br><p>  Fichier <code>client_connect.sh</code> (c√¥t√© serveur) </p><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/sh echo 'ifconfig-push TUNNEL_CLIENT_SIDE_IP TUNNEL_SERVER_SIDE_IP' &gt;&gt; ${1} echo 'push "iroute 0.0.0.0 0.0.0.0"' &gt;&gt; ${1} echo 'iroute 0.0.0.0 0.0.0.0' &gt;&gt; ${1} exit 0</span></span></code> </pre><br><p>  Fichier <code>client_dyn_rt.conf</code> (c√¥t√© client) </p><br><pre> <code class="plaintext hljs">daemon compress tls-client auth &lt;TLS_AUTH_ALGORITHM&gt; cipher &lt;CIPHER_ALGORITHM&gt; client dev-type tun dev &lt;TUNNEL_INTERFACE_NAME&gt; script-security 3 remote-cert-tls server verify-x509-name &lt;SERVER_DISTINGUISHED_NAME&gt; name remote &lt;SERVER_PUBLIC_IP&gt; &lt;SERVER_PUBLIC_PORT&gt; tcp &lt;ca&gt; ... Certificate Authority certificate data &lt;/ca&gt; &lt;cert&gt; ... Client certificate data &lt;/cert&gt; &lt;key&gt; ... Client Private Key data &lt;/key&gt;</code> </pre><br><p>  Je ne cite pas les param√®tres des paquets et des protocoles de routage soit √† cause de la vari√©t√© des paquets, soit √† cause de la vari√©t√© des param√®tres eux-m√™mes (en fait, comme source d'exemples de configuration, vous pouvez utiliser le deuxi√®me des articles, dont les liens sont donn√©s au d√©but de l'article).  Je veux juste noter que le param√®tre ci-dessus vous permet d'utiliser en particulier BGP (que j'aime personnellement √† la fois en raison de sa "contr√¥labilit√©" et de la possibilit√© de transmettre des routes de divers protocoles au cours d'une m√™me session).  Dans le cas de BGP, l'adresse &lt;TUNNEL_CLIENT_SIDE_IP&gt; doit √™tre utilis√©e comme adresse du voisin c√¥t√© "serveur", et l'adresse &lt;TUNNEL_SERVER_SIDE_IP&gt; ou les adresses "internes" des parties respectives doivent √™tre utilis√©es c√¥t√© client, mais vous devez ensuite ajouter les routes correspondantes √† la configuration. serveur et / ou client. </p><br><br><h4>  Avantages et inconv√©nients de la solution ci-dessus </h4><br><p>  <b>Inconv√©nients:</b> <br><br></p><ol><li>  Il doit y avoir exactement un client par serveur, donc pour plusieurs clients, vous devrez garder plusieurs processus OpenVPN actifs.  En cons√©quence - un certain d√©passement de m√©moire et tout cela. </li><li>  Vous ne pouvez pas utiliser le mode de cl√© pr√©-partag√©e dans OpenVPN, car dans ce mode, le transfert dynamique des param√®tres du serveur vers le client (push / pull) est interdit.  Pour cette raison, une configuration plus complexe est requise, y compris la g√©n√©ration d'un ensemble de cl√©s et de certificats, ainsi qu'un script pour g√©n√©rer une pi√®ce de configuration c√¥t√© client d'un serveur (qui, cependant, peut √™tre remplac√© par un r√©pertoire de fichiers statiques en rempla√ßant l'option <code>client-connect /path/to/script</code> par l'option <code>client-connect-dir /path/to/config/dir</code> , ce qui augmente le niveau de s√©curit√© c√¥t√© serveur. </li></ol><br><p>  <b>Avantages:</b> <br><br></p><ol><li>  Contrairement aux protocoles tels que GRE / IPIP, les tunnels OpenVPN peuvent avoir une MTU de 1500 octets (car le processus OpenVPN masque toute la fragmentation / d√©fragmentation sous le capot, envoyant des paquets complets √† l'interface du tunnel).  Cela facilite la configuration de toutes sortes de tunnels secondaires sur le tunnel OpenVPN. </li><li>  Le tunnel OpenVPN prend en charge simultan√©ment la transmission d'IPv4 et d'IPv6, ce qui r√©duit le nombre de tunnels entre des paires de n≈ìuds, le co√ªt de leur configuration et de leur administration, ainsi que la transmission de routes IPv6 dans la m√™me session BGP que les routes IPv4. </li><li>  Tous les avantages du protocole OpenVPN, tels que la facilit√© de mise en place d'un √©quipement r√©seau interm√©diaire (ou son absence totale), la possibilit√© de masquer le trafic sous HTTPS, la pr√©sence d'une impl√©mentation pour la plupart des plateformes et cetera, et cetera. </li></ol><br><p>  J'esp√®re que quelqu'un trouvera le guide ci-dessus utile. </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr483740/">https://habr.com/ru/post/fr483740/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr483726/index.html">JavaScript et HTML vanille. Aucun cadre. Pas de biblioth√®ques. Pas de probl√®me</a></li>
<li><a href="../fr483730/index.html">Programmers Union 2: les pantoufles ont cess√© de rire et sont devenues r√©fl√©chies</a></li>
<li><a href="../fr483732/index.html">Lire le firmware s√©curis√© du flash STM32F1xx √† l'aide de ChipWhisperer</a></li>
<li><a href="../fr483734/index.html">Quel prix payons-nous pour utiliser async / attendre dans JS / C # / Rust</a></li>
<li><a href="../fr483736/index.html">Recherche d'image invers√©e: un guide de l'agence de d√©tective Bellingcat</a></li>
<li><a href="../fr483742/index.html">Rechercher des bugs comme mode de vie</a></li>
<li><a href="../fr483744/index.html">Vente du Nouvel An</a></li>
<li><a href="../fr483746/index.html">Station Gateway: passage √† la ligne lunaire, acc√®s √† la station martienne</a></li>
<li><a href="../fr483748/index.html">La n√©gligence des utilisateurs de PayPal leur permettant de voler leur compte et leur argent [Corrig√©]</a></li>
<li><a href="../fr483750/index.html">Traduction du livre d'Andrew Un, Passion for Machine Learning, Chapitres 30 - 32</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>