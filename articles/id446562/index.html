<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ğŸ—„ï¸ ğŸ‘“ ğŸ‘ğŸ» Asynchrony dalam pemrograman ğŸŒ” ğŸ‘¸ğŸ» ğŸ‘</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Di bidang pengembangan aplikasi multithreaded atau terdistribusi sangat tinggi, diskusi tentang pemrograman asinkron sering muncul. Hari ini kita akan...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Asynchrony dalam pemrograman</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/jugru/blog/446562/"><p>  Di bidang pengembangan aplikasi multithreaded atau terdistribusi sangat tinggi, diskusi tentang pemrograman asinkron sering muncul.  Hari ini kita akan menyelami asynchrony secara terperinci dan mempelajari apa itu ketika itu terjadi, bagaimana hal itu mempengaruhi kode dan bahasa pemrograman yang kita gunakan.  Kami akan mencari tahu mengapa Berjangka dan Janji diperlukan, dan menyentuh coroutine dan sistem operasi.  Ini akan membuat pertukaran yang muncul selama pengembangan perangkat lunak lebih eksplisit. </p><br><p>  Materi tersebut didasarkan pada transkrip laporan oleh Ivan Puzyrevsky, seorang guru di Yandex Data Analysis School. </p><br><p><img src="https://habrastorage.org/webt/zl/f-/6v/zlf-6v_wphtcesgmq7cvpvfctbk.png"></p><a name="habracut"></a><br><h1 id="videozapis">  Rekaman video </h1><br><iframe width="560" height="315" src="https://www.youtube.com/embed/g7dno0SupKY" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><a name="section1"></a><br><h1 id="1-soderzhanie">  1. Konten </h1><br><div class="spoiler">  <b class="spoiler_title">Teks tersembunyi</b> <div class="spoiler_text"><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">1. Konten</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">2. Pendahuluan</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">3. Konsep dasar</a> <br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">3.1.</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Utas eksekusi</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">3.2.</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Multitasking dan konkurensi</a> </li></ul></li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">4. Memblokir dan menunggu</a> <br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">4.1.</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Menunggu tanpa pemblokiran</a> </li></ul></li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">5. Berjangka / Janji</a> <br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">5.1.</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Antarmuka Masa Depan &amp; Janji</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">5.2.</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Komposisi Komputasi</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">5.3.</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Contohnya</a> </li><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">5.4.</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Combinator apa saja</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">5.5.</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">All-combinator</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">5.6.</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Adaptasi Callback</a> </li></ul></li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">6. Cara membuat kode dapat dibaca dengan coroutine</a> <br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">6.1.</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Coroutine</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">6.2.</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Draft WaitFor Implementasi</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">6.3.</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Bagaimana siklus perencanaannya</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">6.4.</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Coroutine TS</a> </li></ul></li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">7. Apa yang kamu terima?</a> </li></ul></div></div><br><a name="section2"></a><br><h1 id="2-vvedenie">  2. Pendahuluan </h1><br><p> Halo semuanya, nama saya Ivan Puzyrevsky, saya bekerja untuk Yandex.  Selama enam tahun terakhir saya telah terlibat dalam infrastruktur penyimpanan dan pemrosesan data, sekarang saya beralih ke produk - untuk mencari perjalanan, hotel, dan tiket.  Karena saya sudah lama bekerja di infrastruktur, saya telah memperoleh cukup banyak pengalaman tentang cara menulis berbagai aplikasi yang dimuat.  Infrastruktur kami beroperasi <code>24*7*365</code> setiap hari tanpa henti, terus menerus di ribuan mesin.  Secara alami, Anda perlu menulis kode agar dapat bekerja dengan andal dan efisien dan menyelesaikan tugas yang dipikul perusahaan. </p><br><p>  Hari ini kita akan berbicara tentang asinkron.  Apa itu asinkron?  Ini adalah ketidakcocokan sesuatu dengan sesuatu pada waktunya.  Dari uraian ini, umumnya tidak jelas apa yang akan saya bicarakan hari ini.  Untuk memperjelas masalah ini, saya perlu contoh a la "Halo, dunia!".  Asynchrony biasanya terjadi dalam konteks penulisan aplikasi jaringan, jadi saya akan memiliki analog jaringan "Halo, dunia!".  Ini adalah aplikasi ping-pong.  Kode ini terlihat seperti ini: </p><br><pre> <code class="cpp hljs">socket s; <span class="hljs-built_in"><span class="hljs-built_in">string</span></span> x; x = read_from_socket(s, <span class="hljs-number"><span class="hljs-number">4</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (x == <span class="hljs-string"><span class="hljs-string">"ping"</span></span>) { write_to_socket(s, <span class="hljs-string"><span class="hljs-string">"pong"</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>;</code> </pre> <br><p>  Saya membuat soket, membaca garis dari sana, dan memeriksa apakah itu ping, maka saya menulis pong sebagai tanggapan.  Sangat sederhana dan jelas.  Apa yang terjadi ketika Anda melihat kode seperti itu di layar komputer Anda?  Kami menganggap kode ini sebagai urutan langkah-langkah ini: </p><br><p><img src="https://habrastorage.org/webt/va/3e/dk/va3edk8_ja838w9qo7apppwyy50.png"></p><br><p>  Dari sudut pandang waktu fisik nyata, semuanya agak bias. </p><br><p><img src="https://habrastorage.org/webt/od/wo/4g/odwo4gzguqz7nr_odgsksityvda.png"></p><br><p>  Mereka yang benar-benar menulis dan menjalankan kode seperti itu tahu bahwa setelah langkah membaca dan setelah langkah <br>  tulis adalah interval waktu yang cukup mencolok ketika program kita tampaknya tidak melakukan apa-apa dari sudut pandang kode kita, tetapi di bawah kap mesin beroperasi, yang kita sebut "input-output". </p><br><p><img src="https://habrastorage.org/webt/ye/jl/67/yejl67r3goweaiupb1wjieg5i2a.png"><br>  Selama I / O, paket dipertukarkan melalui jaringan dan semua petugas berat, pekerjaan tingkat rendah.  Mari kita lakukan eksperimen pemikiran: ambil satu program seperti itu, jalankan pada satu prosesor fisik dan berpura-pura bahwa kita tidak memiliki sistem operasi, apa yang akan terjadi?  Prosesor tidak dapat berhenti, ia terus melakukan langkah-langkah tanpa mengikuti instruksi apa pun, hanya membuang-buang energi dengan sia-sia. </p><br><p><img src="https://habrastorage.org/webt/pg/lu/xp/pgluxpmbkl8ho9w-2docuab2iqg.png"></p><br><p>  Muncul pertanyaan apakah kita dapat melakukan sesuatu yang bermanfaat selama periode waktu ini.  Ini adalah pertanyaan yang sangat alami, jawaban yang memungkinkan kita menghemat daya prosesor dan menggunakannya untuk sesuatu yang bermanfaat, sementara aplikasi kita tampaknya tidak melakukan apa-apa. </p><br><a name="section3"></a><br><h1 id="3-osnovnye-ponyatiya">  3. Konsep dasar </h1><br><a name="section3-1"></a><br><h2 id="31-potok-vypolneniya">  3.1.  Utas eksekusi </h2><br><p>  Bagaimana kita bisa mendekati tugas ini?  Mari kita rujuk konsep-konsepnya.  Saya akan mengatakan "aliran eksekusi", mengacu pada beberapa urutan yang berarti dari operasi atau langkah-langkah dasar.  Makna akan ditentukan oleh konteks di mana saya berbicara tentang aliran eksekusi.  Artinya, jika kita berbicara tentang algoritma single-threaded (Aho-Korasik, pencarian grafik), maka algoritma ini sendiri sudah menjadi utas eksekusi.  Dia mengambil beberapa langkah untuk menyelesaikan masalah. </p><br><p>  Jika saya berbicara tentang database, maka satu utas eksekusi dapat menjadi bagian dari tindakan yang dilakukan oleh database untuk melayani satu permintaan masuk.  Hal yang sama berlaku untuk server web.  Jika saya menulis beberapa jenis aplikasi seluler atau web, maka untuk melayani operasi satu pengguna, misalnya, mengklik tombol, interaksi jaringan, interaksi dengan penyimpanan lokal, dan sebagainya.  Urutan tindakan ini dari sudut pandang aplikasi seluler saya juga akan menjadi alur eksekusi yang bermakna dan terpisah.  Dari sudut pandang sistem operasi, proses atau utas proses juga merupakan untaian eksekusi yang bermakna. </p><br><a name="section3-2"></a><br><h2 id="32-mnogozadachnost-i-parallelizm">  3.2.  Multitasking dan konkurensi </h2><br><p>  Landasan produktivitas adalah kemampuan untuk melakukan trik seperti itu: ketika saya memiliki satu utas eksekusi yang berisi rongga dalam pemindaian waktu fisiknya, lalu isi rongga ini dengan sesuatu yang bermanfaat - ikuti langkah-langkah dari rangkaian eksekusi lainnya. </p><br><p><img src="https://habrastorage.org/webt/vw/x1/si/vwx1sijti5ahggnjozkymza2hna.png"></p><br><p>  Database biasanya melayani banyak klien secara bersamaan.  Jika kita dapat menggabungkan kerja pada beberapa utas eksekusi dalam kerangka satu utas eksekusi tingkat yang lebih tinggi, maka ini disebut multitasking.  Yaitu, multitasking adalah ketika saya melakukan tindakan dalam kerangka satu alur eksekusi yang lebih besar yang lebih rendah dari solusi tugas-tugas kecil. </p><br><p>  Penting untuk tidak membingungkan konsep multitasking dengan paralelisme.  Concurrency - <br>  ini adalah properti dari lingkungan runtime, yang memungkinkan dalam satu langkah waktu, dalam satu langkah, untuk membuat kemajuan dalam utas eksekusi yang berbeda.  Jika saya memiliki dua prosesor fisik, maka dalam satu siklus clock mereka dapat menjalankan dua instruksi.  Jika program berjalan pada satu prosesor, maka akan dibutuhkan dua siklus clock untuk menjalankan dua instruksi yang sama. </p><br><p><img src="https://habrastorage.org/webt/nq/n5/yf/nqn5yf1pee8kwgi3rw1lxmnyomi.png"></p><br><p>  Penting untuk tidak membingungkan konsep-konsep ini, karena mereka masuk dalam kategori yang berbeda.  Multitasking adalah fitur program Anda yang terstruktur secara internal sebagai variabel yang bekerja pada tugas yang berbeda.  Concurrency adalah properti dari lingkungan runtime yang memungkinkan Anda untuk mengerjakan beberapa tugas dalam satu siklus clock. </p><br><p>  Dalam banyak hal, kode asinkron dan penulisan kode asinkron adalah menulis kode multitasking.  Kesulitan utama adalah bagaimana saya menyandikan tugas dan cara mengelolanya.  Karena itu, hari ini kita akan membicarakan ini - menulis kode multitasking. </p><br><a name="section4"></a><br><h1 id="4-blokirovanie-i-ozhidanie">  4. Memblokir dan menunggu </h1><br><p><img src="https://habrastorage.org/getpro/habr/post_images/da7/042/897/da7042897d750697821baf6381db92ea.png"></p><br><p>  Mari kita mulai dengan beberapa contoh sederhana.  Kembali ke ping-pong: </p><br><pre> <code class="cpp hljs">socket s; <span class="hljs-built_in"><span class="hljs-built_in">string</span></span> x; x = read_from_socket(s, <span class="hljs-number"><span class="hljs-number">4</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (x == <span class="hljs-string"><span class="hljs-string">"ping"</span></span>) { write_to_socket(s, <span class="hljs-string"><span class="hljs-string">"pong"</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>;</code> </pre> <br><p>  Seperti yang telah kita bahas, setelah membaca dan garis putih utas eksekusi tertidur, itu diblokir.  Biasanya kita berkata, "aliran diblokir." </p><br><pre> <code class="cpp hljs">socket s; <span class="hljs-built_in"><span class="hljs-built_in">string</span></span> x; x = read_from_socket(s, <span class="hljs-number"><span class="hljs-number">4</span></span>); <span class="hljs-comment"><span class="hljs-comment">/* thread is blocked here */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (x == <span class="hljs-string"><span class="hljs-string">"ping"</span></span>) { write_to_socket(s, <span class="hljs-string"><span class="hljs-string">"pong"</span></span>); <span class="hljs-comment"><span class="hljs-comment">/* thread is blocked here */</span></span> } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>;</code> </pre> <br><p>  Ini berarti bahwa alur eksekusi telah mencapai titik di mana setiap peristiwa diperlukan untuk melanjutkannya.  Khususnya, dalam hal aplikasi jaringan kami, perlu bahwa data tiba melalui jaringan atau, sebaliknya, kami memiliki buffer gratis untuk menulis data ke jaringan.  Peristiwa mungkin berbeda.  Jika kita berbicara tentang aspek waktu, kita bisa menunggu timer untuk memicu atau menyelesaikan proses lain.  Peristiwa di sini adalah semacam hal yang abstrak, tentang hal itu penting untuk dipahami bahwa mereka dapat diharapkan. </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/c91/02f/7ca/c9102f7ca66291666b9df9c05ce7f46e.png"></p><br><p>  Ketika kami menulis kode sederhana, kami secara implisit memberikan kendali atas ekspektasi acara ke tingkat yang lebih tinggi.  Dalam kasus kami, sistem operasi.  Dia, sebagai entitas tingkat yang lebih tinggi, bertanggung jawab untuk memilih tugas mana yang akan dilakukan selanjutnya, dan dia juga bertanggung jawab untuk melacak terjadinya peristiwa. </p><br><p>  Kode kami, yang kami tulis sebagai pengembang, disusun pada saat yang sama mengenai pekerjaan pada satu tugas.  Cuplikan kode dari contoh menangani satu koneksi: ia membaca ping dari satu koneksi dan menulis pong ke satu koneksi. </p><br><p>  Kode ini jelas.  Anda dapat membacanya dan memahami apa fungsinya, cara kerjanya, masalah apa yang dipecahkan, invarian apa yang dimilikinya, dan sebagainya.  Pada saat yang sama, kami mengelola perencanaan tugas dengan sangat buruk dalam model seperti itu.  Secara umum, sistem operasi memiliki konsep prioritas, tetapi jika Anda menulis sistem waktu nyata yang lunak, maka Anda tahu bahwa alat yang tersedia di Linux tidak cukup untuk membuat sistem waktu nyata yang cukup waras. </p><br><p>  Lebih jauh, sistem operasi adalah hal yang rumit, dan mengalihkan konteks dari aplikasi kita ke kernel menghabiskan beberapa mikrodetik, yang, dengan beberapa perhitungan sederhana, memberi kita perkiraan sekitar 20-100 ribu konteks switch per detik.  Ini berarti bahwa jika kita menulis server web, maka dalam satu detik kita dapat memproses sekitar 20 ribu permintaan, dengan asumsi bahwa memproses permintaan sepuluh kali lebih mahal daripada sistem. </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/c12/68f/503/c1268f5037154f9f0f5ac5bc82dfc531.png"></p><br><a name="section4-1"></a><br><h2 id="41-neblokiruyuschee-ozhidanie">  4.1.  Menunggu tanpa pemblokiran </h2><br><p><img src="https://habrastorage.org/getpro/habr/post_images/ffe/97f/c42/ffe97fc42eca8beb2dae841358b31b8e.png"></p><br><p>  Jika Anda datang ke situasi yang Anda butuhkan untuk bekerja dengan jaringan lebih efisien, maka Anda mulai mencari bantuan di Internet dan datang untuk menggunakan select / epoll.  Di Internet tertulis bahwa jika Anda ingin melayani ribuan koneksi pada saat yang sama, Anda perlu epoll, karena ini adalah mekanisme yang baik dan seterusnya.  Anda membuka dokumentasi dan melihat sesuatu seperti ini: </p><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">select</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> nfds, fd_set* readfds, fd_set* writefds, fd_set* exceptfds, struct timeval* timeout)</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">FD_CLR</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> fd, fd_set* </span></span><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-params"><span class="hljs-built_in">set</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function">  </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">FD_ISSET</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> fd, fd_set* </span></span><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-params"><span class="hljs-built_in">set</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">FD_SET</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> fd, fd_set* </span></span><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-params"><span class="hljs-built_in">set</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">FD_ZERO</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(fd_set* </span></span><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-params"><span class="hljs-built_in">set</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">epoll_ctl</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> epfd, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> op, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> fd, struct epoll_event* event)</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">epoll_wait</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> epfd, struct epoll_event* events, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> maxevents, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> timeout)</span></span></span></span>;</code> </pre> <br><p>  Fungsi di mana antarmuka berisi banyak deskriptor yang bekerja dengan Anda (dalam kasus pilih), atau banyak peristiwa yang berlalu <br>  melintasi batas aplikasi Anda, kernel dari sistem operasi yang perlu Anda proses (dalam kasus epoll). </p><br><p>  Perlu juga ditambahkan bahwa Anda bisa datang bukan untuk memilih / epoll, tetapi ke perpustakaan seperti libuv, yang tidak akan memiliki acara di API, tetapi akan memiliki banyak panggilan balik.  Antarmuka perpustakaan akan mengatakan: "Dear friend, sediakan panggilan balik untuk membaca soket, yang akan saya panggil saat datanya muncul." </p><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">uv_timer_start</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uv_timer_t</span></span></span></span><span class="hljs-function"><span class="hljs-params">* handle, uv_timer_cb cb, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint64_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> timeout, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint64_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> repeat)</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">typedef</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">void</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(*uv_timer_cb)</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uv_timer_t</span></span></span></span><span class="hljs-function"><span class="hljs-params">* handle)</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">uv_read_start</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uv_stream_t</span></span></span></span><span class="hljs-function"><span class="hljs-params">* stream, uv_alloc_cb alloc_cb, uv_read_cb read_cb)</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">uv_read_stop</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uv_stream_t</span></span></span></span><span class="hljs-function"><span class="hljs-params">*)</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">typedef</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">void</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(*uv_read_cb)</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uv_stream_t</span></span></span></span><span class="hljs-function"><span class="hljs-params">* stream, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">ssize_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> nread, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uv_buf_t</span></span></span></span><span class="hljs-function"><span class="hljs-params">* buf)</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">uv_write</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uv_write_t</span></span></span></span><span class="hljs-function"><span class="hljs-params">* req, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uv_stream_t</span></span></span></span><span class="hljs-function"><span class="hljs-params">* handle, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uv_buf_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> bufs[], </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">unsigned</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> nbufs, uv_write_cb cb)</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">typedef</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">void</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(*uv_write_cb)</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uv_write_t</span></span></span></span><span class="hljs-function"><span class="hljs-params">* req, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> status)</span></span></span></span>;</code> </pre> <br><p>  Apa yang telah berubah dibandingkan dengan kode sinkron kami di bab sebelumnya?  Kode telah menjadi tidak sinkron.  Ini berarti bahwa kami mengambil logika ke dalam aplikasi untuk menentukan titik waktu ketika peristiwa dipantau.  Panggilan pilih / epoll eksplisit adalah titik di mana kami meminta sistem operasi untuk informasi tentang peristiwa yang telah terjadi.  Kami juga mengambil ke dalam kode aplikasi kami pilihan tugas mana yang harus dikerjakan selanjutnya. </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/458/28b/5f2/45828b5f2463ec94abf292e8a5db86bf.png"></p><br><p>  Dari contoh antarmuka, Anda dapat melihat bahwa pada dasarnya ada dua mekanisme untuk memperkenalkan multitasking.  Satu jenis "tarik" ketika kita <br>  kita menarik banyak peristiwa yang kita tunggu, dan kemudian kita entah bagaimana bereaksi terhadapnya.  Dalam pendekatan ini, mudah untuk mengamortisasi overhead oleh satu <br>  suatu peristiwa dan karenanya mencapai throughput tinggi dalam komunikasi tentang serangkaian peristiwa yang telah terjadi.  Biasanya, semua elemen jaringan seperti interaksi kernel dengan kartu jaringan atau interaksi Anda dan sistem operasi dibangun berdasarkan mekanisme polling. </p><br><p>  Cara kedua adalah mekanisme "push", ketika entitas eksternal tertentu dengan jelas masuk, mengganggu aliran eksekusi dan mengatakan: "Sekarang, tolong tangani kejadian yang baru saja tiba."  Ini adalah pendekatan dengan callback, dengan sinyal unix, dengan gangguan di tingkat prosesor, ketika entitas eksternal dengan jelas menginvasi utas eksekusi Anda dan berkata: "Sekarang, tolong, kami sedang mengerjakan acara ini."  Pendekatan ini telah muncul untuk mengurangi penundaan antara terjadinya suatu peristiwa dan reaksi terhadapnya. </p><br><p>  Mengapa kami pengembang C ++ yang menulis dan memecahkan masalah aplikasi tertentu mungkin ingin menyeret model acara ke dalam kode kami?  Jika kita seret dan lepas pekerjaan pada banyak tugas ke dalam kode kita dan mengelolanya, maka karena kurangnya transisi ke kernel dan sebaliknya, kita dapat bekerja sedikit lebih cepat dan melakukan tindakan yang lebih bermanfaat per unit waktu. </p><br><p>  Apa yang menyebabkan hal ini dalam hal kode yang kita tulis?  Ambil nginx, misalnya, server HTTP berkinerja tinggi, sangat umum.  Jika Anda membaca kodenya, kode ini dibuat berdasarkan model asinkron.  Kode ini cukup sulit dibaca.  Ketika Anda bertanya pada diri sendiri apa sebenarnya yang terjadi ketika memproses satu permintaan HTTP, ternyata kode tersebut memiliki banyak fragmen yang ditempatkan dalam file yang berbeda, pada sudut yang berbeda dari basis kode.  Setiap fragmen melakukan sejumlah kecil pekerjaan sebagai bagian dari melayani seluruh permintaan HTTP.  Sebagai contoh: </p><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ngx_http_request_handler</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">ngx_event_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *ev)</span></span></span><span class="hljs-function"> </span></span>{ â€¦ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (c-&gt;close) { ngx_http_terminate_request(r, <span class="hljs-number"><span class="hljs-number">0</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ev-&gt;write) { r-&gt;write_event_handler(r); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { r-&gt;read_event_handler(r); } ... } <span class="hljs-comment"><span class="hljs-comment">/* where the handler... */</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">typedef</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">void</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(*ngx_http_event_handler_pt)</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">ngx_http_request_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *r)</span></span></span></span>; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ngx_http_request_s</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-comment"><span class="hljs-comment">/*... */</span></span> ngx_http_event_handler_pt read_event_handler; <span class="hljs-comment"><span class="hljs-comment">/* ... */</span></span> }; <span class="hljs-comment"><span class="hljs-comment">/* ...is set when switching to the next processing stage */</span></span> r-&gt;read_event_handler = ngx_http_request_empty_handler; r-&gt;read_event_handler = ngx_http_block_reading; r-&gt;read_event_handler = ngx_http_test_reading; r-&gt;read_event_handler = ngx_http_discarded_request_body_handler; r-&gt;read_event_handler = ngx_http_read_client_request_body_handler; r-&gt;read_event_handler = ngx_http_upstream_rd_check_broken_connection; r-&gt;read_event_handler = ngx_http_upstream_read_request_handler;</code> </pre> <br><p>  Ada struktur permintaan, yang diteruskan ke pengendali acara ketika sinyal soket akses baca atau tulis.  Selanjutnya, pawang ini terus-menerus beralih dalam program tergantung pada kondisi pemrosesan permintaan.  Entah kita membaca tajuk, atau membaca badan permintaan, atau meminta data hulu - secara umum, ada banyak kondisi berbeda. </p><br><p>  Kode semacam itu sulit dibaca karena pada dasarnya dijelaskan dalam bentuk reaksi terhadap peristiwa.  Kita berada dalam keadaan ini dan itu dan bereaksi dengan cara tertentu terhadap peristiwa yang telah terjadi.  Tidak ada gambaran lengkap tentang seluruh proses pemrosesan permintaan HTTP. </p><br><p>  Pilihan lain, yang sering digunakan dalam JavaScript, adalah untuk membangun kode berbasis panggilan balik ketika kita meneruskan panggilan balik kita ke panggilan antarmuka, di mana biasanya ada beberapa panggilan balik bersarang untuk suatu acara, dan sebagainya. </p><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">int</span></span> LibuvStreamWrap::ReadStart() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> uv_read_start(stream(), [](<span class="hljs-keyword"><span class="hljs-keyword">uv_handle_t</span></span>* handle, <span class="hljs-keyword"><span class="hljs-keyword">size_t</span></span> suggested_size, <span class="hljs-keyword"><span class="hljs-keyword">uv_buf_t</span></span>* buf) { <span class="hljs-keyword"><span class="hljs-keyword">static_cast</span></span>&lt;LibuvStreamWrap*&gt;(handle-&gt;data)-&gt;OnUvAlloc(suggested_size, buf); }, [](<span class="hljs-keyword"><span class="hljs-keyword">uv_stream_t</span></span>* stream, <span class="hljs-keyword"><span class="hljs-keyword">ssize_t</span></span> nread, <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">uv_buf_t</span></span>* buf) { <span class="hljs-keyword"><span class="hljs-keyword">static_cast</span></span>&lt;LibuvStreamWrap*&gt;(stream-&gt;data)-&gt;OnUvRead(nread, buf); }); } <span class="hljs-comment"><span class="hljs-comment">/* ...for example, parsing http... */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (p=data; p != data + len; p++) { ch = *p; reexecute: <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> (CURRENT_STATE()) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> s_start_req_or_res: <span class="hljs-comment"><span class="hljs-comment">/*... */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> s_res_or_resp_H: <span class="hljs-comment"><span class="hljs-comment">/*... */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> s_res_HT: <span class="hljs-comment"><span class="hljs-comment">/*... */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> s_res_HTT: <span class="hljs-comment"><span class="hljs-comment">/* ... */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> s_res_HTTP: <span class="hljs-comment"><span class="hljs-comment">/* ... */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> s_res_http_major: <span class="hljs-comment"><span class="hljs-comment">/*... */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> s_res_http_dot: <span class="hljs-comment"><span class="hljs-comment">/*... */</span></span> <span class="hljs-comment"><span class="hljs-comment">/* ... */</span></span></code> </pre> <br><p>  Sekali lagi kode ini sangat terfragmentasi, tidak ada pemahaman tentang kondisi saat ini tentang bagaimana kami bekerja berdasarkan permintaan.  Banyak informasi yang dikirimkan melalui penutupan, dan Anda perlu melakukan upaya mental untuk merekonstruksi logika memproses satu permintaan. </p><br><p>  Dengan demikian, memperkenalkan multitasking ke dalam kode kami (logika memilih tugas kerja dan multiplexing), kami mendapatkan kode yang efektif dan kontrol atas prioritas tugas, tetapi kami kehilangan banyak tugas karena mudah dibaca.  Kode ini sulit dibaca dan sulit dipertahankan. </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/da5/a8a/151/da5a8a1517fb18945a330ae4c2b6d722.png"></p><br><p>  Mengapa  Misalkan saya punya kasus sederhana, misalnya, saya membaca file dan mentransfernya melalui jaringan.  Dalam versi non-pemblokiran, kasing ini akan sesuai dengan mesin keadaan linier tersebut: </p><br><ul><li>  Keadaan awal </li><li>  Mulai membaca file, </li><li>  Menunggu respons dari sistem file, </li><li>  Menulis file ke soket, </li><li>  Keadaan akhir. </li></ul><br><p>  Sekarang, katakanlah saya ingin menambahkan informasi dari database ke file ini.  Opsi sederhana: </p><br><ul><li>  keadaan awal </li><li>  membaca file </li><li>  baca file </li><li>  membaca dari database </li><li>  baca dari database, </li><li>  Saya bekerja dengan soket </li><li>  menulis ke soket. </li></ul><br><p>  Sepertinya kode linier, tetapi jumlah negara telah meningkat. </p><br><p>  Kemudian Anda mulai berpikir bahwa akan lebih baik untuk memparalelkan dua langkah - membaca dari file dan dari database.  Keajaiban kombinatorik dimulai: Anda berada dalam keadaan awal, meminta untuk membaca file dan data dari database.  Kemudian Anda bisa datang ke keadaan di mana ada data dari database, tetapi tidak ada file, atau sebaliknya - ada data dari file, tetapi tidak dari database.  Selanjutnya, Anda harus pergi ke keadaan di mana Anda memiliki satu dari dua hal.  Sekali lagi, ini adalah dua kondisi.  Maka Anda harus pergi ke keadaan di mana Anda memiliki kedua bahan tersebut.  Kemudian tuliskan ke soket dan sebagainya. </p><br><p>  Semakin kompleks aplikasi, semakin banyak status, semakin banyak fragmen kode yang perlu digabungkan di kepala Anda.  Nyaman  Atau Anda menulis mie panggilan balik, yang tidak nyaman untuk dibaca.  Jika sistem percabangan ditulis, maka suatu hari akan tiba saatnya Anda tidak bisa lagi menerimanya. </p><br><a name="section5"></a><br><h1 id="5-futurespromises">  5. Berjangka / Janji </h1><br><p><img src="https://habrastorage.org/getpro/habr/post_images/f93/0ea/b0a/f930eab0a9a5556b0db5d21f23d98190.png"></p><br><p>  Untuk mengatasi masalah, Anda perlu melihat situasi dengan lebih mudah. </p><br><p><img src="https://habrastorage.org/webt/-v/6e/gb/-v6egbslm8_jjhwcsevjffbe35s.png"></p><br><p>  Ada sebuah program, ia memiliki lingkaran hitam dan merah.  Alur eksekusi kami adalah lingkaran hitam;  terkadang mereka diselingi dengan warna merah ketika aliran tidak dapat melanjutkan pekerjaannya.  Masalahnya adalah bahwa untuk eksekusi thread hitam kami Anda harus masuk ke lingkaran hitam berikutnya, yang tidak akan diketahui kapan. </p><br><p>  Masalahnya adalah ketika kita menulis kode dalam bahasa pemrograman, kita menjelaskan kepada komputer apa yang harus dilakukan sekarang.  Komputer adalah hal yang relatif sederhana yang mengharapkan instruksi yang kita tulis dalam bahasa pemrograman.  Dia sedang menunggu instruksi untuk lingkaran berikutnya, dan dalam bahasa pemrograman kami tidak ada cukup uang untuk mengatakan: "Di masa depan, tolong, ketika sesuatu terjadi, lakukan sesuatu." </p><br><p><img src="https://habrastorage.org/webt/vp/8f/mx/vp8fmxhtnkukhqym-baw3g4mzyg.png"></p><br><p>  Dalam bahasa pemrograman, kami beroperasi dengan tindakan sesaat yang dapat dimengerti: memanggil fungsi, operasi aritmatika, dll.  Mereka menggambarkan langkah selanjutnya yang spesifik berikutnya.  Pada saat yang sama, untuk memproses logika aplikasi, perlu untuk menggambarkan bukan langkah fisik berikutnya, tetapi langkah logis berikutnya: apa yang harus kita lakukan ketika data dari database muncul, misalnya. </p><br><p><img src="https://habrastorage.org/webt/6m/by/ma/6mbyma_pagz74dx-j2ch1ixpxpg.png"></p><br><p>  Oleh karena itu, kita memerlukan mekanisme bagaimana menggabungkan fragmen-fragmen ini.  Dalam kasus ketika kami menulis kode sinkron, kami menyembunyikan pertanyaan sepenuhnya di bawah tenda dan mengatakan bahwa sistem operasi akan menanganinya, membiarkannya mengganggu dan menjadwal ulang utas kami. </p><br><p>  Di level 1, kami membuka kotak Pandora ini, dan membawa banyak sakelar, kasing, kondisi, cabang, status ke kode.  Saya ingin beberapa kompromi sehingga kodenya relatif mudah dibaca, tetapi tetap mempertahankan semua kelebihan level 1. </p><br><p>  Untungnya bagi kami, pada tahun 1988 orang yang terlibat dalam sistem terdistribusi, Barbara Liskov dan Luba Shirir, menyadari masalahnya, dan sampai pada kebutuhan akan perubahan linguistik.  Penting untuk menambahkan konstruksi ke bahasa pemrograman yang memungkinkan mengekspresikan hubungan temporal antara peristiwa - pada saat saat ini dalam waktu dan pada saat yang tidak pasti di masa depan. </p><br><p>  Ini disebut Janji.  Konsepnya keren, tapi sudah terkumpul di rak selama dua puluh tahun.       â€”  ,   Twitter,      Ruby on Rails  Scala,     ,  ,      ,      future  .     Your Server as a Function.   ,        . </p><br><p>   Scala,    , ++ ? </p><br><p>    ,   Future.      T c  :       ,  -    . </p><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">template</span></span> &lt;<span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">T</span></span></span><span class="hljs-class">&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Future</span></span></span><span class="hljs-class"> &lt;T&gt;</span></span></code> </pre> <br><p>         ,    ,  ,     .   ,   Â«Â»,  ,      .     Future     Â«Â»,  Promise â€”  Â«Â».        ;  ,  JavaScript, Promise â€”      ,   Java â€“   Future. </p><br><p>   ,     .     ,       ,     boost::future ( std::future) â€”      ,     . </p><br><a name="section5-1"></a><br><h2 id="51-interfeys-future--promise">  5.1.  Future &amp; Promise </h2><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">template</span></span> &lt;<span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">T</span></span></span><span class="hljs-class">&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Future</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">IsSet</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">const</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">const</span></span></span><span class="hljs-function"> T&amp; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Get</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">const</span></span></span></span>; <span class="hljs-function"><span class="hljs-function">T* </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">TryGet</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">const</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Subscribe</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-params"><span class="hljs-built_in">std</span></span></span></span><span class="hljs-function"><span class="hljs-params">::function&lt;</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> T&amp;)&gt; cb)</span></span></span></span>; <span class="hljs-keyword"><span class="hljs-keyword">template</span></span> &lt;<span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">R</span></span></span><span class="hljs-class">&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Future</span></span></span><span class="hljs-class">&lt;R&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Then</span></span></span><span class="hljs-class">( </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">std</span></span></span><span class="hljs-class">:</span></span>:function&lt;R(<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> T&amp;)&gt; f); <span class="hljs-keyword"><span class="hljs-keyword">template</span></span> &lt;<span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">R</span></span></span><span class="hljs-class">&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Future</span></span></span><span class="hljs-class">&lt;R&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Then</span></span></span><span class="hljs-class">( </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">std</span></span></span><span class="hljs-class">:</span></span>:function&lt;Future&lt;R&gt;(<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> T&amp;)&gt; f); }; <span class="hljs-keyword"><span class="hljs-keyword">template</span></span> &lt;<span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">T</span></span></span><span class="hljs-class">&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Future</span></span></span><span class="hljs-class">&lt;T&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MakeFuture</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">const</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">T</span></span></span><span class="hljs-class">&amp; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">value</span></span></span><span class="hljs-class">);</span></span></code> </pre> <br><p>  , ,  - ,      .  , ,      ,   . ,      ,       â€”   ,   ,   .       Then,      . </p><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">template</span></span> &lt;<span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">T</span></span></span><span class="hljs-class">&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Promise</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">IsSet</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">const</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Set</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> T&amp; value)</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">TrySet</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> T&amp; value)</span></span></span></span>; Future&lt;T&gt; ToFuture() <span class="hljs-keyword"><span class="hljs-keyword">const</span></span>; }; <span class="hljs-keyword"><span class="hljs-keyword">template</span></span> &lt;<span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">T</span></span></span><span class="hljs-class">&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Promise</span></span></span><span class="hljs-class">&lt;T&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">NewPromise</span></span></span><span class="hljs-class">();</span></span></code> </pre> <br><p>   .      ,       .    Â«, , ,      Â». </p><br><a name="section5-2"></a><br><h2 id="52-kompoziciya-vychisleniy">  5.2.   </h2><br><p><img src="https://habrastorage.org/getpro/habr/post_images/676/e68/6b7/676e686b75c6875ba0a914567bc46839.png"></p><br><p>    ?  ,         .  Then â€”  ,      . </p><br><p> ,      â€” future --,     -  t â€”       .    , ,   ,        f,  -     r. </p><br><p>          t     f.        ,  ,      r. </p><br><p>   :    t,      ,   r      .       : </p><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">template</span></span> &lt;<span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">T</span></span></span><span class="hljs-class">&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">template</span></span></span><span class="hljs-class"> &lt;class R&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Future</span></span></span><span class="hljs-class">&lt;R&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Future</span></span></span><span class="hljs-class">&lt;T&gt;:</span></span>:Then(<span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::function&lt;R(<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> T&amp;)&gt; f) { <span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> promise = NewPromise&lt;R&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>-&gt;Subscribe([promise] (<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> T&amp; t) { <span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> r = f(t); promise.Set(r); }); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> promise.ToFuture(); }</code> </pre> <br><p>  : </p><br><ul><li>  <code>Promise</code>  <code>R</code> , </li><li>    <code>Future&lt;T&gt;</code>    <code>t</code> , </li><li>   ,    <code>r = f(t)</code> , </li><li>  <code>r</code>   <code>Promise</code> , </li><li>      <code>Promise</code> . </li></ul><br><p>      <code>f</code> ,     <code>R</code> ,  <code>Future&lt;R&gt;</code> ,         <code>R</code> .  : </p><br><ul><li>          <code>T</code> , </li><li>  ,     <code>T</code> ,  ,      <code>R</code> , </li><li>     ,      <code>R</code> ,    ,        . </li></ul><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">template</span></span> &lt;<span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">T</span></span></span><span class="hljs-class">&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">template</span></span></span><span class="hljs-class"> &lt;class R&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Future</span></span></span><span class="hljs-class">&lt;R&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Future</span></span></span><span class="hljs-class">&lt;T&gt;:</span></span>:Then(<span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::function&lt;Future&lt;R&gt;(<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> T&amp;)&gt; f) { <span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> promise = NewPromise&lt;R&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>-&gt;Subscribe([promise] (<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> T&amp; t) { <span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> that = f(t); that.Subscribe([promise] (R r) { promise.Set(r); }); }); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> promise.ToFuture(); }</code> </pre> <br><p>        ,   -    t.        f,        r,    .    ,       ,   . </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/3c6/92f/064/3c692f06489d41c745a0d1b51085b278.png"></p><br><p>    ,    Then   : </p><br><ul><li>   <code>Promise</code> , </li><li>  <code>Subscribe</code>   -, </li><li>  <code>Promise</code> ,   <code>Future</code> . </li></ul><br><p>      ,       .    ,       ,    ,            . </p><br><p>     ,   ,          ,     -.   ,  ,   -,   Subscribe.       ,    ,   ,  -  .   ,    . </p><br><a name="section5-3"></a><br><h2 id="53-primery">  5.3.  Contohnya </h2><br><p>       AsyncComputeValue,      GPU,        .   Then,    ,        (2v+1) <sup>2</sup> . </p><br><pre> <code class="cpp hljs">Future&lt;<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>&gt; value = AsyncComputeValue(); <span class="hljs-comment"><span class="hljs-comment">//    value.Subscribe([] (int v) { std::cerr &lt;&lt; "Value is: " &lt;&lt; v &lt;&lt; std::endl; });</span></span></code> </pre> <br><p>      .  ,    :   (2v+1) <sup>2</sup>       .       ,            . </p><br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">//  (2v+1)^2 Future&lt;int&gt; anotherValue = value .Then([] (int v) { return 2 * v; }) .Then([] (int u) { return u + 1; }) .Then([] (int w) { return w * w; });</span></span></code> </pre> <br><p>     ,     ,       .       . </p><br><p>  .   :   ,       ;       ;       . </p><br><pre> <code class="cpp hljs">Future&lt;<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>&gt; GetDbKey(); Future&lt;<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>&gt; LoadDbValue(<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> key); Future&lt;<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>&gt; SendToMars(<span class="hljs-built_in"><span class="hljs-built_in">string</span></span> message); Future&lt;<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>&gt; ExploreOuterSpace() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> GetDbKey() <span class="hljs-comment"><span class="hljs-comment">// Future&lt;int&gt; .Then(&amp;LoadDbValue) // Future&lt;string&gt; .Then(&amp;SendToMars); // Future&lt;void&gt; } ExploreOuterSpace().Subscribe( [] () { std::cout &lt;&lt; "Mission Complete!" &lt;&lt; std::endl; });</span></span></code> </pre> <br><p>         â€” ExploreOuterSpace.           Then;    â€”    â€”    ,     .         ( ) .      . </p><br><a name="section5-4"></a><br><h2 id="54-any-kombinator">  5.4. Any- </h2><br><p>  :     <code>Future</code>    ,       ,      . ,  ,          : </p><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">template</span></span> &lt;<span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">T</span></span></span><span class="hljs-class">&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Future</span></span></span><span class="hljs-class">&lt;T&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Any</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Future</span></span></span><span class="hljs-class">&lt;T&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">f1</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Future</span></span></span><span class="hljs-class">&lt;T&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">f2</span></span></span><span class="hljs-class">) {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> promise = NewPromise&lt;T&gt;(); f1.Subscribe([promise] (<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> T&amp; t) { promise.TrySet(t); }); f2.Subscribe([promise] (<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> T&amp; t) { promise.TrySet(t); }); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> promise.ToFuture(); } <span class="hljs-comment"><span class="hljs-comment">//    </span></span></code> </pre> <br><p>   ,      Any-,      Future  :   ,   .      ,    ,  . </p><br><p>   ,  ,       ,     ,  ,    .      Â«   DB1,    DB2,        â€”  - Â». </p><br><a name="section5-5"></a><br><h2 id="55-all-kombinator">  5.5. All- </h2><br><p>    .                  ,       ,  ,     ( T1  T2),    T1  T2   ,        ,   . </p><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">template</span></span> &lt;<span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">T1</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">T2</span></span></span><span class="hljs-class">&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Future</span></span></span><span class="hljs-class">&lt;std::tuple&lt;T1, T2&gt;&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">All</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Future</span></span></span><span class="hljs-class">&lt;T1&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">f1</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Future</span></span></span><span class="hljs-class">&lt;T2&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">f2</span></span></span><span class="hljs-class">) {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> promise = NewPromise&lt;<span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::tuple&lt;T1, T2&gt;&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> result = <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::make_shared&lt; <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::tuple&lt;T1, T2&gt; &gt;(); <span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> counter = <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::make_shared&lt; <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::atomic&lt;<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>&gt; &gt;(<span class="hljs-number"><span class="hljs-number">2</span></span>); f1.Subscribe([promise, result, counter] (<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> T1&amp; t1) { <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::get&lt;<span class="hljs-number"><span class="hljs-number">0</span></span>&gt;(*result) = t1; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (--(*counter) == <span class="hljs-number"><span class="hljs-number">0</span></span>) { promise.Set(*result)); } }); f2.Subscribe([promise, result, counter] (<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> T2&amp; t2) { <span class="hljs-comment"><span class="hljs-comment">/*  */</span></span> } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> promise.ToFuture(); } <span class="hljs-comment"><span class="hljs-comment">//    </span></span></code> </pre> <br><p>    nginx.   ,      ,        .     nginx    Â« Â», Â«  Â», Â«    Â»   .  All-         ,     .      . </p><br><a name="section5-6"></a><br><h2 id="56-adaptaciya-obratnogo-vyzova"> 5.6.    </h2><br><p>   Future  Promises â€”     legacy-,   .     callback-    ,     ,   :   Future,     ,   callback-  Future. </p><br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">//   cb     void LegacyAsyncComputeStuff(std::function&lt;void(int)&gt; cb); //      Future Future&lt;int&gt; ModernAsyncComputeStuff() { auto promise = NewPromise&lt;int&gt;(); LegacyAsyncComputeStuff( [promise] (int value) { promise.Set(value); }); return promise.ToFuture(); }</span></span></code> </pre> <br><p> :      ,              Future  . </p><br><a name="section6"></a><br><h1 id="6-kak-sdelat-kod-chitaemee-s-pomoschyu-korutin"> 6.        </h1><br><p><img src="https://habrastorage.org/getpro/habr/post_images/19a/093/212/19a093212125673ff89cc4196c59583a.png"></p><br><p>   ,     ,     .  . </p><br><pre> <code class="cpp hljs">Future&lt;Request&gt; GetRequest(); Future&lt;Payload&gt; QueryBackend(Request req); Future&lt;Response&gt; HandlePayload(Payload pld); Future&lt;<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>&gt; Reply(Request req, Response rsp); <span class="hljs-comment"><span class="hljs-comment">// req  2 :  QueryBackend   Reply GetRequest().Subscribe( [] (Request req) { auto rsp = QueryBackend(req) .Then(&amp;HandlePayload) .Then(Bind(&amp;Reply, req)); });</span></span></code> </pre> <br><p>      .    Request,   -   .  ,     .  ,   ,        ,    .  ,   -      . </p><br><p>  ,  ,     .  ?   â€”  ,    request  payload,     â€”  ,      . </p><br><p> ,   Java   Netty. ,      ,        .  ,        ,    . </p><br><p>      ,    GetRequest, QueryBackend, HandlePayload   Reply   ,     Future. </p><br><p>     ,   ,   Future   T â€”   WaitFor. <br></p><pre> <code class="cpp hljs">Future&lt;Request&gt; GetRequest(); Future&lt;Payload&gt; QueryBackend(Request req); Future&lt;Response&gt; HandlePayload(Payload pld); Future&lt;<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>&gt; Reply(Request req, Response rsp); <span class="hljs-keyword"><span class="hljs-keyword">template</span></span> &lt;<span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">T</span></span></span><span class="hljs-class">&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">T</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WaitFor</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Future</span></span></span><span class="hljs-class">&lt;T&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">future</span></span></span><span class="hljs-class">);</span></span> <span class="hljs-comment"><span class="hljs-comment">// req  2 :  QueryBackend   Reply GetRequest().Subscribe( [] (Request req) { auto rsp = QueryBackend(req) .Then(&amp;HandlePayload) .Then(Bind(&amp;Reply, req)); });</span></span></code> </pre> <br><p>      : </p><br><pre> <code class="cpp hljs">Future&lt;Request&gt; GetRequest(); Future&lt;Payload&gt; QueryBackend(Request req); Future&lt;Response&gt; HandlePayload(Payload pld); Future&lt;<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>&gt; Reply(Request req, Response rsp); <span class="hljs-keyword"><span class="hljs-keyword">template</span></span> &lt;<span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">T</span></span></span><span class="hljs-class">&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">T</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WaitFor</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Future</span></span></span><span class="hljs-class">&lt;T&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">future</span></span></span><span class="hljs-class">);</span></span> <span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> req = WaitFor(GetRequest()); <span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> pld = WaitFor(QueryBackend(req)); <span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> rsp = WaitFor(HandlePayload(pld)); WaitFor(Reply(req, rsp));</code> </pre> <br><p>   :    Future,    .    .         ,    .      . </p><br><p>     .                    .     -  0,     ,  , mutex+cvar  future.        .          ,     . </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/99d/f77/3e4/99df773e4d1922427ab7dc98fde28b8f.png"></p><br><a name="section6-1"></a><br><h2 id="61-korutiny">  6.1.  </h2><br><p>  ,        .        ,  ,     ,   ,    - ,   .     ,    <i>-</i> . </p><br><p>       â€” Â«Â»      ,  ,    .       .     .  : boost::asio  boost::fiber. </p><br><p>         ,                .  Bagaimana cara melakukannya? </p><br><a name="section6-2"></a><br><h2 id="62-chernovik-realizacii-waitfor">  6.2.   WaitFor </h2><br><p>   , , boost::context,        :  ,   ;  ,              .    x86/64       ,       ,         . </p><br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">//      class MachineContext; //     from,    to void SwitchContext(MachineContext* from, MachineContext* to); //      â€“ boost::context //    // * x86_64-ASM (push...-movq(rsp,eip)-pop...-jmpq) // * makecontext/swapcontext // * setjmp/longjmp</span></span></code> </pre> <br><p>      ,       goto:    ,     ,        ,   . </p><br><p>      ,  -   .     Fiber â€”   .       +Future.  ,      ,         Future,    . </p><br><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Fiber</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-comment"><span class="hljs-comment">/*    */</span></span> MachineContext context_; Future&lt;<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>&gt; future_; };</code> </pre> <br><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Scheduler</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-comment"><span class="hljs-comment">/*    */</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">WaitFor</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Future&lt;</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params">&gt; future)</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Loop</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; MachineContext loop_context_; Fiber* current_fiber_; <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">deque</span></span>&lt;Fiber*&gt; run_queue_; };</code> </pre> <br><p>  Future   ,     ,    ,     .    :   Loop,      ,    ,   ,        ,    . </p><br><p>     WaitFor? </p><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">thread_local</span></span> Scheduler* ThisScheduler; <span class="hljs-keyword"><span class="hljs-keyword">template</span></span> &lt;<span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">T</span></span></span><span class="hljs-class">&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">T</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WaitFor</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Future</span></span></span><span class="hljs-class">&lt;T&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">future</span></span></span><span class="hljs-class">) {</span></span> ThisScheduler-&gt;WaitFor(future.As&lt;<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>&gt;()); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> future.Get(); } <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> Scheduler::WaitFor(Future&lt;<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>&gt; future) { current_fiber_-&gt;future_ = future; SwitchContext(Â¤t_fiber_-&gt;context_, &amp;loop_context_); }</code> </pre> <br><p>   :  ,   -   ,      ,      Future  void,        .           . </p><br><p>  <code>Future&lt;void&gt;</code>   ,     ,    -  . </p><br><p>   WaitFor    :   : Â«     Fiber   FutureÂ»,        ( )       . </p><br><p>  ,        : <br> <code>ThisScheduler-&gt;WaitFor</code>  <code>return future.Get()</code> ,         . </p><br><p>      ?  ,       Future,      . </p><br><a name="section6-3"></a><br><h2 id="63-kak-ustroen-cikl-planirovaniya">  6.3.     </h2><br><p>   -  , ,    ,     -     ,    .    SwitchContext   ,    2 â€”       . </p><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> Scheduler::Loop() { <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (<span class="hljs-literal"><span class="hljs-literal">true</span></span>) { <span class="hljs-comment"><span class="hljs-comment">// (1)     (= !) current_fiber_ = run_queue_.front(); run_queue_.pop_front(); SwitchContext(&amp;loop_context_, Â¤t_fiber_-&gt;context_); // (2) ,      //â€¦</span></span></code> </pre> <br><p>   ?   ,   ,    ,     Future,       Future, ,     ,           . </p><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> Scheduler::Loop() { <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (<span class="hljs-literal"><span class="hljs-literal">true</span></span>) { <span class="hljs-comment"><span class="hljs-comment">// (1)     â€¦ // (2) ,      if (current_fiber_-&gt;future_) { current_fiber_-&gt;future_.Subscribe( [this, fiber = current_fiber_] { fiber-&gt;future_ = nullptr; run_queue_.push_back(fiber); }); } //â€¦</span></span></code> </pre> <br><p>   ,      .       : </p><br><p>     WaitFor â€”   . </p><br><p><img src="https://habrastorage.org/webt/_4/m8/ao/_4m8aoag2egfc2mzczah2xf6a9i.png"></p><br><p>    Switch-    . </p><br><p><img src="https://habrastorage.org/webt/sa/hg/kz/sahgkzqleux5-htiqo-58lb0gua.png"></p><br><p>     Future    (  ),   ,         .   -               Fiber. </p><br><p><img src="https://habrastorage.org/webt/hg/cm/gc/hgcmgclv5raicu_tlfywmw0yrpi.png"></p><br><p>   WaitFor     Future ,     - , Future  .     : </p><br><pre> <code class="cpp hljs">Future&lt;Request&gt; GetRequest(); Future&lt;Payload&gt; QueryBackend(Request req); Future&lt;Response&gt; HandlePayload(Payload pld); Future&lt;<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>&gt; Reply(Request req, Response rsp); <span class="hljs-keyword"><span class="hljs-keyword">template</span></span> &lt;<span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">T</span></span></span><span class="hljs-class">&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">T</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WaitFor</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Future</span></span></span><span class="hljs-class">&lt;T&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">future</span></span></span><span class="hljs-class">);</span></span> <span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> req = WaitFor( GetRequest()); <span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> pld = WaitFor( QueryBackend(req)); <span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> rsp = WaitFor( HandlePayload(pld)); WaitFor( Reply(req, rsp));</code> </pre> <br><p>    ,    ,      ,   .         ,    ,    . </p><br><a name="section6-4"></a><br><h2 id="64-coroutine-ts">  6.4. Coroutine TS </h2><br><p>    ?   â€” .   Coroutine TS,        ,  WaitFor  CoroutineWait,    CoroutineTS â€”  -  .     ,         - . ,    Waiter  Co,     ,    . </p><br><a name="section7"></a><br><h1 id="7-chto-poluchili"> 7.  ? </h1><br><p>   .           ,   ,    ,    .     ,       ,     ,    . </p><br><p>     â€”  .    ,                  .       .     ,     . ,         ,        ,         ,      . </p><br><p>       -    ,        ,               .    ,  .      ,                ,          . </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/e02/3b7/924/e023b79240490a7b561152aa0972b3ac.png"></p><br><p>         ,   ?    ,     . </p><br><p>   .       ,     ,   ,  ,      .       .       ,     ,     ,    ,    . </p><br><p>    nginx,  ,  ,  ,       ,    .        ,     ,  ,    future  promises. </p><br><p>     ,       ,    ,     ,       ,      ,      ,      . </p><br><p>       futures, promises  actors.    .             ,    . </p><br><p> :      , ,   ,     .               ,    , ,      ,   .     ? ,   . </p><br><blockquote>  Menit periklanan. 19-20      C++ Russia 2019.      , , Grimm Rainer    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Â«Concurrency and parallelism in C++17 and C++20/23Â»</a> ,      <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">   C++</a> .      <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="> </a> ,    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="> </a> .  ,         ,    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">-</a> . </blockquote></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/id446562/">https://habr.com/ru/post/id446562/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../id446550/index.html">Masalah pola koordinator dan apa yang harus dilakukan RouteComposer dengannya</a></li>
<li><a href="../id446552/index.html">Bekerja dengan Perintah APDU Menggunakan Contoh EToken</a></li>
<li><a href="../id446554/index.html">Program residen Yandex, atau How to back-end yang berpengalaman menjadi insinyur-ML</a></li>
<li><a href="../id446558/index.html">Struktur Data Eksotis: Modifikasi Merkle Patricia Trie</a></li>
<li><a href="../id446560/index.html">"Courtesy Exchange": inti dari konflik antara dua perusahaan streaming paling terkenal</a></li>
<li><a href="../id446566/index.html">Project Zero. Bagaimana Amazon ingin berurusan dengan pemalsuan</a></li>
<li><a href="../id446568/index.html">Umbraco 8 pembaruan CMS skala besar: apa yang baru</a></li>
<li><a href="../id446570/index.html">Kisah GPU pertama: Rendition VÃ©ritÃ© 1000</a></li>
<li><a href="../id446572/index.html">Editor.js adalah editor yang sangat baik yang menyimpan kode sumber dalam format JSON</a></li>
<li><a href="../id446576/index.html">Mengganti impor, atau bagaimana Helikopter Rusia melakukan kesalahan</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>