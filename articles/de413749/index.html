<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🧓🏿 📧 😢 B + Baum in einem realen Projekt 👡 🤽🏽 👨🏿‍🏭</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In diesem Artikel werden wir uns detailliert ansehen, wie der B + -Baum in einer verteilten Apache Ignite- Datenbank erstellt wird. 




 Es gibt bere...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>B + Baum in einem realen Projekt</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/sberbank/blog/413749/"><p>  In diesem Artikel werden wir uns detailliert ansehen, wie der B + -Baum in einer verteilten <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Apache Ignite-</a> Datenbank erstellt wird. <br></p><br><img src="https://habrastorage.org/webt/mv/_t/zg/mv_tzg1o-c96a2ib19cf9umv67u.jpeg"><a name="habracut"></a><br><p>  Es gibt bereits einige Artikel über H-Bäume auf B-Bäumen ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">eins</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">zwei</a> ), aber sie sind eher theoretisch und selbst wenn sie eine Implementierung enthalten, sind sie nicht <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">produktionsbereit</a> .  Daraus ergibt sich ein Interesse an der Implementierung, die im Leben verwendet wird. </p><br><p>  Bevor Sie den Artikel weiter lesen, empfehle ich Ihnen, sich einen <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Vortrag von Maxim Babenko</a> anzuschauen, wenn Sie immer noch nicht wissen, was der B-Baum theoretisch ist.  Aber ich muss Java oder das Apache Ignite-Projekt nicht genau kennen - ich werde entweder die Details explizit schreiben oder sie unter Spoilern verstecken. </p><br><p>  Beim Lesen von Ignite-Quellen empfehle ich Ihnen, die Argumente von Methoden in Ihrem Kopf zu überspringen, deren Bedeutung nicht sehr klar ist, und die Namen von Funktionen zu lesen. Es ist viel einfacher, den Funktionskörper zu lesen, wenn Sie im Voraus wissen, was er tut. </p><br><p>  Bitte beachten Sie, dass ich nicht der Hauptentwickler von Apache Ignite bin und möglicherweise etwas aus dem Code missverstanden habe.  Also habe ich den Satz "soweit ich verstehe" ausgesprochen, der vor jedem positiven Satz mental hinzugefügt werden sollte. </p><br><h1 id="zachem-b-derevo-v-apache-ignite">  Warum B + Baum in Apache Ignite </h1><br><p> Apache Ignite ist eine speicherinterne Datenbank, verfügt jedoch seit Version 2.1 über einen <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">persistenten Datenspeicher</a> - eine Funktion zum Speichern von Daten auf der Festplatte <em>(hat nichts mit der <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">persistenten Datenstruktur</a> zu tun)</em> .  Daher ist klar, warum eine Struktur für den externen Speicher benötigt wird. Es bleibt zu verstehen, warum sie keine andere gewählt haben. </p><br><p>  Der B + -Baum ist zunächst eine Optimierung des B-Baums, bei dem Werte nur in Blättern gespeichert werden.  Bei dieser Optimierung passen mehr Schlüssel in einen Knoten, wodurch der Verzweigungsgrad erhöht wird.  Daher gibt es nicht viel Grund, den klassischen B-Baum zu verwenden. </p><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">B *</a> und B + * - sind auf der Festplatte dichter, haben aber eine schlechtere Leistung, weil  Wir speichern Daten aus dem RAM, Leistung ist uns wichtiger. </p><br><p>  Nach <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Benchmarks zu</a> urteilen <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">, ist ein</a> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">LSM-Baum</a> beim Schreiben schneller, beim Lesen jedoch langsamer.  Darüber hinaus ist der Leseverlust größer als der Schreibverlust, sodass ich für einen hypothetischen allgemeinen Fall auch den B + -Baum nehmen würde. </p><br><p>  Es gibt auch seltsame <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">fraktale Bäume</a> , die jedoch anscheinend nur in <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">TokuDB</a> patentiert und implementiert <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">sind</a> . </p><br><p>  Persönlich interessiert mich mehr, warum es unmöglich war, ein fertiges Festplatten-Backend wie <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">LevelDB zu verwenden</a> ?  Eine teilweise Antwort ist, dass PDS Speicher von Drittanbietern unterstützt. </p><br><h1 id="realizaciya-v-krupnuyu-kletku">  Implementierung großer Zellen </h1><br><p> Ursprünglich entwickelte GridGain Apache Ignite, aber bevor es zu Open Source ging, trug es den Namen des Unternehmens, sodass einige Komponentennamen mit <code>Grid</code> und andere mit <code>Ignite</code> .  Daher <code>GridCursor</code> , aber <code>IgniteTree</code> .  Hier gibt es keine andere Logik. </p><br><p>  Apache Ignite-Code wird in den Java-Best-Practice-Mustern geschrieben, und jede Klasse erbt eine Schnittstelle, wenn nicht eine.  Über die <code>IgniteTree</code> Oberfläche starten Sie den Tanz.  Ich gebe den Code ohne Javadoc, kurz. </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">IgniteTree</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">L</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">T</span></span></span><span class="hljs-class">&gt; </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> T </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">put</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(T val)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> IgniteCheckedException</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">invoke</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(L key, Object x, InvokeClosure&lt;T&gt; c)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> IgniteCheckedException</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> T </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">findOne</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(L key)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> IgniteCheckedException</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> GridCursor&lt;T&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">find</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(L lower, L upper)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> IgniteCheckedException</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> GridCursor&lt;T&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">find</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(L lower, L upper, Object x)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> IgniteCheckedException</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> T </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">findFirst</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> IgniteCheckedException</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> T </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">findLast</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> IgniteCheckedException</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> T </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">remove</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(L key)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> IgniteCheckedException</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">long</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">size</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> IgniteCheckedException</span></span>; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">InvokeClosure</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">T</span></span></span><span class="hljs-class">&gt; </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">call</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(@Nullable T row)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> IgniteCheckedException</span></span>; <span class="hljs-function"><span class="hljs-function">T </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">newRow</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; <span class="hljs-function"><span class="hljs-function">OperationType </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">operationType</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">enum</span></span> OperationType { NOOP, REMOVE, PUT } }</code> </pre> <br><p>  Die <code>IgniteTree</code> Schnittstelle beschreibt einen Standardsatz von Operationen.  Bitte beachten Sie, dass Sie für eine Bereichssuche Blätter in einer Liste stricken müssen.  Der Bonus unterstützt eine beliebige Aufzeichnungsoperation - <code>invoke</code> . </p><br><p>  Die <code>put</code> Operation akzeptiert nur ein Argument vom Typ <code>T</code> ohne Schlüssel.  In <code>IgniteTree</code> finden Sie keine Erklärung dafür. Die Antwort ist jedoch im <code>BPlusTree</code> Header versteckt. </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">abstract</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BPlusTree</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">L</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">T</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">L</span></span></span><span class="hljs-class">&gt; </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">DataStructure</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">IgniteTree</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">L</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">T</span></span></span><span class="hljs-class">&gt;</span></span></code> </pre> <br><p>  Wie Sie sehen können, erbt der Wert den Schlüssel. Daher wird bei der Put-Operation der Schlüssel aus dem Wert berechnet.  Dies schränkt die Funktionalität des Baums nicht ein.  Ich gehe davon aus, dass das Speichern von Sets kompakter ist. </p><br><p>  Normalerweise setzen sie die Karte außer Kraft, indem sie dem Wert eine Garbage-Konstante hinzufügen.  Im B + -Baum werden jedoch <em>nur Schlüssel</em> in Knoten gespeichert. Wenn der Wert auch den Schlüssel speichert, reicht es in den Blättern aus, <em>nur die Werte</em> zu speichern.  Und wenn der Baum eine Menge ist, stellt sich automatisch heraus, dass es in den Blättern nur Schlüssel ohne Müllwerte gibt. </p><br><p><img src="https://habrastorage.org/webt/gk/5a/mj/gk5amjeohtkej5assnsgyy791p4.png"></p><br><p>  Schauen wir uns nun den Elementsuchcode an. </p><br><pre> <code class="java hljs"><span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> g Get. * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@throws</span></span></span><span class="hljs-comment"> IgniteCheckedException If failed. */</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">doFind</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Get g)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> IgniteCheckedException </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (;;) { <span class="hljs-comment"><span class="hljs-comment">// Go down with retries. g.init(); switch (findDown(g, g.rootId, 0L, g.rootLvl)) { case RETRY: case RETRY_ROOT: checkInterrupted(); continue; default: return; } } } /** * @param g Get. * @param pageId Page ID. * @param fwdId Expected forward page ID. * @param lvl Level. * @return Result code. * @throws IgniteCheckedException If failed. */ private Result findDown(final Get g, final long pageId, final long fwdId, final int lvl) throws IgniteCheckedException { long page = acquirePage(pageId); try { for (;;) { // Init args. g.pageId = pageId; g.fwdId = fwdId; Result res = read(pageId, page, search, g, lvl, RETRY); switch (res) { case GO_DOWN: case GO_DOWN_X: assert g.pageId != pageId; assert g.fwdId != fwdId || fwdId == 0; // Go down recursively. res = findDown(g, g.pageId, g.fwdId, lvl - 1); switch (res) { case RETRY: checkInterrupted(); continue; // The child page got split, need to reread our page. default: return res; } case NOT_FOUND: assert lvl == 0 : lvl; g.row = null; // Mark not found result. return res; default: return res; } } } finally { if (g.canRelease(pageId, lvl)) releasePage(pageId, page); } }</span></span></code> </pre> <br><p>  Die Basis des B-Tree-Traversal-Algorithmus ist unverändert geblieben: Sie senken den Baum rekursiv zum gewünschten Blatt ab. Wenn der Wert vorhanden ist, geben sie das Ergebnis zurück, und wenn nicht, dann <code>null</code> .  Die Rekursion wurde anscheinend der Einfachheit halber verlassen, die B-Bäume sind nicht tief. </p><br><p><img src="https://habrastorage.org/webt/tc/g3/0t/tcg30to_z-6fcrfegjfulubh0gq.jpeg"></p><br><p>  Ich war überrascht, weil ich eine klare Installation in meinem Kopf hatte: Die Rekursion wird in einem realen Projekt immer entfernt ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">in Java gibt es keine Optimierung der Schwanzrekursion</a> , die Rekursion ist in Projekten in anderen Sprachen akzeptabel).  Aber tatsächlich wird die Höhe des B-Baums in Einheiten gemessen, weil die Größe des Ordnungsblocks <math></math><span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax_SVG" id="MathJax-Element-1-Frame" tabindex="0" style="font-size: 100%; display: inline-block; position: relative;" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msup><mn>2</mn><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mn>10</mn></mrow></msup></math>" role="presentation"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="3.039ex" height="2.419ex" viewBox="0 -935.7 1308.3 1041.5" role="img" focusable="false" style="vertical-align: -0.246ex;" aria-hidden="true"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=https://habr.com/ru/company/sberbank/blog/413749/&amp;usg=ALkJrhiL5uSZFYOdwHEgZPdnRlBnNVr4iQ#MJMAIN-32" x="0" y="0"></use><g transform="translate(500,393)"><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=https://habr.com/ru/company/sberbank/blog/413749/&amp;usg=ALkJrhiL5uSZFYOdwHEgZPdnRlBnNVr4iQ#MJMAIN-31"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=https://habr.com/ru/company/sberbank/blog/413749/&amp;usg=ALkJrhiL5uSZFYOdwHEgZPdnRlBnNVr4iQ#MJMAIN-30" x="500" y="0"></use></g></g></svg><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><msup><mn>2</mn><mrow class="MJX-TeXAtom-ORD"><mn>10</mn></mrow></msup></math></span></span><script type="math/tex" id="MathJax-Element-1"> 2 ^ {10} </script>  und die Anzahl der Bestelldaten <math></math><span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax_SVG" id="MathJax-Element-2-Frame" tabindex="0" style="font-size: 100%; display: inline-block; position: relative;" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msup><mn>2</mn><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mn>40</mn></mrow></msup></math>" role="presentation"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="3.039ex" height="2.419ex" viewBox="0 -935.7 1308.3 1041.5" role="img" focusable="false" style="vertical-align: -0.246ex;" aria-hidden="true"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=https://habr.com/ru/company/sberbank/blog/413749/&amp;usg=ALkJrhiL5uSZFYOdwHEgZPdnRlBnNVr4iQ#MJMAIN-32" x="0" y="0"></use><g transform="translate(500,393)"><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=https://habr.com/ru/company/sberbank/blog/413749/&amp;usg=ALkJrhiL5uSZFYOdwHEgZPdnRlBnNVr4iQ#MJMAIN-34"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=https://habr.com/ru/company/sberbank/blog/413749/&amp;usg=ALkJrhiL5uSZFYOdwHEgZPdnRlBnNVr4iQ#MJMAIN-30" x="500" y="0"></use></g></g></svg><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><msup><mn>2</mn><mrow class="MJX-TeXAtom-ORD"><mn>40</mn></mrow></msup></math></span></span><script type="math/tex" id="MathJax-Element-2"> 2 ^ {40} </script>  und die Höhe wird sein <math></math><span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax_SVG" id="MathJax-Element-3-Frame" tabindex="0" style="font-size: 100%; display: inline-block; position: relative;" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mtext>&amp;#xA0;</mtext><mi>f</mi><mi>r</mi><mi>a</mi><mi>c</mi><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi>l</mi><mi>o</mi><mi>g</mi><mo stretchy=&quot;false&quot;>(</mo><msup><mn>2</mn><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mn>40</mn></mrow></msup><mo stretchy=&quot;false&quot;>)</mo></mrow><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mi>l</mi><mi>o</mi><mi>g</mi><mo stretchy=&quot;false&quot;>(</mo><msup><mn>2</mn><mrow class=&quot;MJX-TeXAtom-ORD&quot;><mn>10</mn></mrow></msup><mo stretchy=&quot;false&quot;>)</mo></mrow><mo>=</mo><mn>4</mn></math>" role="presentation"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="24.975ex" height="2.901ex" viewBox="0 -935.7 10753.2 1249" role="img" focusable="false" style="vertical-align: -0.728ex;" aria-hidden="true"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=https://habr.com/ru/company/sberbank/blog/413749/&amp;usg=ALkJrhiL5uSZFYOdwHEgZPdnRlBnNVr4iQ#MJMATHI-66" x="250" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=https://habr.com/ru/company/sberbank/blog/413749/&amp;usg=ALkJrhiL5uSZFYOdwHEgZPdnRlBnNVr4iQ#MJMATHI-72" x="800" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=https://habr.com/ru/company/sberbank/blog/413749/&amp;usg=ALkJrhiL5uSZFYOdwHEgZPdnRlBnNVr4iQ#MJMATHI-61" x="1252" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=https://habr.com/ru/company/sberbank/blog/413749/&amp;usg=ALkJrhiL5uSZFYOdwHEgZPdnRlBnNVr4iQ#MJMATHI-63" x="1781" y="0"></use><g transform="translate(2215,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=https://habr.com/ru/company/sberbank/blog/413749/&amp;usg=ALkJrhiL5uSZFYOdwHEgZPdnRlBnNVr4iQ#MJMATHI-6C" x="0" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=https://habr.com/ru/company/sberbank/blog/413749/&amp;usg=ALkJrhiL5uSZFYOdwHEgZPdnRlBnNVr4iQ#MJMATHI-6F" x="298" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=https://habr.com/ru/company/sberbank/blog/413749/&amp;usg=ALkJrhiL5uSZFYOdwHEgZPdnRlBnNVr4iQ#MJMATHI-67" x="784" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=https://habr.com/ru/company/sberbank/blog/413749/&amp;usg=ALkJrhiL5uSZFYOdwHEgZPdnRlBnNVr4iQ#MJMAIN-28" x="1264" y="0"></use><g transform="translate(1654,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=https://habr.com/ru/company/sberbank/blog/413749/&amp;usg=ALkJrhiL5uSZFYOdwHEgZPdnRlBnNVr4iQ#MJMAIN-32" x="0" y="0"></use><g transform="translate(500,393)"><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=https://habr.com/ru/company/sberbank/blog/413749/&amp;usg=ALkJrhiL5uSZFYOdwHEgZPdnRlBnNVr4iQ#MJMAIN-34"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=https://habr.com/ru/company/sberbank/blog/413749/&amp;usg=ALkJrhiL5uSZFYOdwHEgZPdnRlBnNVr4iQ#MJMAIN-30" x="500" y="0"></use></g></g><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=https://habr.com/ru/company/sberbank/blog/413749/&amp;usg=ALkJrhiL5uSZFYOdwHEgZPdnRlBnNVr4iQ#MJMAIN-29" x="2962" y="0"></use></g><g transform="translate(5566,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=https://habr.com/ru/company/sberbank/blog/413749/&amp;usg=ALkJrhiL5uSZFYOdwHEgZPdnRlBnNVr4iQ#MJMATHI-6C" x="0" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=https://habr.com/ru/company/sberbank/blog/413749/&amp;usg=ALkJrhiL5uSZFYOdwHEgZPdnRlBnNVr4iQ#MJMATHI-6F" x="298" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=https://habr.com/ru/company/sberbank/blog/413749/&amp;usg=ALkJrhiL5uSZFYOdwHEgZPdnRlBnNVr4iQ#MJMATHI-67" x="784" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=https://habr.com/ru/company/sberbank/blog/413749/&amp;usg=ALkJrhiL5uSZFYOdwHEgZPdnRlBnNVr4iQ#MJMAIN-28" x="1264" y="0"></use><g transform="translate(1654,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=https://habr.com/ru/company/sberbank/blog/413749/&amp;usg=ALkJrhiL5uSZFYOdwHEgZPdnRlBnNVr4iQ#MJMAIN-32" x="0" y="0"></use><g transform="translate(500,393)"><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=https://habr.com/ru/company/sberbank/blog/413749/&amp;usg=ALkJrhiL5uSZFYOdwHEgZPdnRlBnNVr4iQ#MJMAIN-31"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=https://habr.com/ru/company/sberbank/blog/413749/&amp;usg=ALkJrhiL5uSZFYOdwHEgZPdnRlBnNVr4iQ#MJMAIN-30" x="500" y="0"></use></g></g><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=https://habr.com/ru/company/sberbank/blog/413749/&amp;usg=ALkJrhiL5uSZFYOdwHEgZPdnRlBnNVr4iQ#MJMAIN-29" x="2962" y="0"></use></g><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=https://habr.com/ru/company/sberbank/blog/413749/&amp;usg=ALkJrhiL5uSZFYOdwHEgZPdnRlBnNVr4iQ#MJMAIN-3D" x="9196" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=https://habr.com/ru/company/sberbank/blog/413749/&amp;usg=ALkJrhiL5uSZFYOdwHEgZPdnRlBnNVr4iQ#MJMAIN-34" x="10252" y="0"></use></g></svg><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mtext>&nbsp;</mtext><mi>f</mi><mi>r</mi><mi>a</mi><mi>c</mi><mrow class="MJX-TeXAtom-ORD"><mi>l</mi><mi>o</mi><mi>g</mi><mo stretchy="false">(</mo><msup><mn>2</mn><mrow class="MJX-TeXAtom-ORD"><mn>40</mn></mrow></msup><mo stretchy="false">)</mo></mrow><mrow class="MJX-TeXAtom-ORD"><mi>l</mi><mi>o</mi><mi>g</mi><mo stretchy="false">(</mo><msup><mn>2</mn><mrow class="MJX-TeXAtom-ORD"><mn>10</mn></mrow></msup><mo stretchy="false">)</mo></mrow><mo>=</mo><mn>4</mn></math></span></span><script type="math/tex" id="MathJax-Element-3"> \ frac {log (2 ^ {40})} {log (2 ^ {10})} = 4 </script>  . </p><br><p>  Apache Ignite <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">liebt Parallelität</a> .  Daher unterstützt der Baum wettbewerbsfähige Änderungen.  Zum Zeitpunkt des Vorgangs ist eine Seite blockiert, aber ein anderer Thread kann den Rest des Baums so ändern, dass ein zweiter Lesevorgang erforderlich ist.  Und so kann die Prozedur die Wurzel erreichen. </p><br><p>  Zuerst habe ich die Bedeutung solcher Funktionen nicht verstanden, da die Festplatte langsam ist und ein Thread alle E / A-Vorgänge ruhig verarbeitet.  Es ist klar, dass die Suche in dem von der Festplatte geladenen Knoten ein wenig kostet und Sie während dieser Zeit die Festplatte mit einer anderen Operation laden können, aber wiederholte Versuche verschlingen den Gewinn.  Dann wurde mir jedoch klar, dass in dieser Implementierung die Knoten nach der Änderung nicht sofort auf die Festplatte geleert wurden, sondern eine Weile im Speicher hingen, um dann viele Änderungen gleichzeitig anzuwenden.  Dank Write Ahead Log gehen keine Daten verloren.  Mehr dazu am Ende des Artikels. </p><br><p>  Sehen wir uns nun den Code zum Hinzufügen eines Elements an. </p><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> T </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">doPut</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(T row, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">boolean</span></span></span></span><span class="hljs-function"><span class="hljs-params"> needOld)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> IgniteCheckedException </span></span>{ checkDestroyed(); Put p = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Put(row, needOld); <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (;;) { <span class="hljs-comment"><span class="hljs-comment">// Go down with retries. p.init(); Result res = putDown(p, p.rootId, 0L, p.rootLvl); switch (res) { case RETRY: case RETRY_ROOT: checkInterrupted(); continue; case FOUND: // We may need to insert split key into upper level here. if (!p.isFinished()) { // It must be impossible to have an insert higher than the current root, // because we are making decision about creating new root while keeping // write lock on current root, so it can't concurrently change. assert p.btmLvl &lt;= getRootLevel(); checkInterrupted(); continue; } return p.oldRow; default: throw new IllegalStateException("Result: " + res); } } } catch (IgniteCheckedException e) { throw new IgniteCheckedException("Runtime failure on row: " + row, e); } catch (RuntimeException e) { throw new IgniteException("Runtime failure on row: " + row, e); } catch (AssertionError e) { throw new AssertionError("Assertion error on row: " + row, e); } finally { checkDestroyed(); } } /** * @param p Put. * @param pageId Page ID. * @param fwdId Expected forward page ID. * @param lvl Level. * @return Result code. * @throws IgniteCheckedException If failed. */ private Result putDown(final Put p, final long pageId, final long fwdId, final int lvl) throws IgniteCheckedException { assert lvl &gt;= 0 : lvl; final long page = acquirePage(pageId); try { for (;;) { // Init args. p.pageId = pageId; p.fwdId = fwdId; Result res = read(pageId, page, search, p, lvl, RETRY); switch (res) { case GO_DOWN: case GO_DOWN_X: assert lvl &gt; 0 : lvl; assert p.pageId != pageId; assert p.fwdId != fwdId || fwdId == 0; res = p.tryReplaceInner(pageId, page, fwdId, lvl); if (res != RETRY) // Go down recursively. res = putDown(p, p.pageId, p.fwdId, lvl - 1); if (res == RETRY_ROOT || p.isFinished()) return res; if (res == RETRY) checkInterrupted(); continue; // We have to insert split row to this level or it is a retry. case FOUND: // Do replace. assert lvl == 0 : "This replace can happen only at the bottom level."; return p.tryReplace(pageId, page, fwdId, lvl); case NOT_FOUND: // Do insert. assert lvl == p.btmLvl : "must insert at the bottom level"; assert p.needReplaceInner == FALSE : p.needReplaceInner + " " + lvl; return p.tryInsert(pageId, page, fwdId, lvl); default: return res; } } } finally { if (p.canRelease(pageId, lvl)) releasePage(pageId, page); } }</span></span></code> </pre> <br><p>  Der einzige Unterschied besteht darin, dass der Code nach dem Erkennen der Position <code>replace</code> und <code>insert</code> .  Der <code>remove</code> kann nicht mehr überwacht werden.  Der grundlegende Mechanismus besteht darin, dass bei wiederholten Versuchen, je nach Vorgang rekursiv durch den Baum zu gehen, zusammen mit einem speziellen Objekt: <code>Get</code> , <code>Put</code> oder <code>Remove</code> . </p><br><p>  <code>Invoke</code> funktioniert auf die gleiche Weise, nur der Vorgang findet mit einer Kopie des Datensatzes statt, dann wird sein Typ bestimmt: <code>NOOP</code> zum Lesen, <code>REMOVE</code> zum Löschen und <code>PUT</code> zum Aktualisieren oder Hinzufügen, und dann wird das entsprechende <code>Put</code> oder <code>Remove</code> Objekt generiert, das auf den Datensatz im Baum angewendet wird. </p><br><h1 id="ispolzovanie">  Verwenden Sie </h1><br><p>  Im Folgenden werde ich zwei <code>BPlusTree</code> näher betrachten: <code>CacheDataTree</code> und <code>PendingEntriesTree</code> .  Über Bord ist die Implementierung von Indizes - dies ist ein Thema für eine separate Diskussion, für die ich noch nicht bereit bin. </p><br><p>  Bevor ich <code>IgniteCache</code> , werde ich klarstellen, dass die lokal verteilte Karte <code>IgniteCache</code> Funktionen hat und <code>IgniteCache</code> heißt - im Folgenden einfach ein Cache. </p><br><h2 id="cachedatatree"> <code>CacheDataTree</code> </h2> <br><p>  <code>CacheDataTree</code> ist eine Zuordnung mehrerer <code>IgniteCache</code> zur Festplatte.  Die Sortierung erfolgt auf mehreren Ebenen: Zuerst nach Cache-ID sortieren, um Schlüssel in einem Cache zu gruppieren, und dann nach Hashes. </p><br><p>  <code>CacheDataTree</code> iteriert nicht über den Bereich, da Indizes in den Nachfolgern von <code>H2Tree extends BPlusTree</code> und <code>H2Tree extends BPlusTree</code> . Daher ist die spezifische Art der Sortierung nicht wichtig: Für <code>put</code> und <code>get</code> Operationen ist keine ausreichend.  Das Vergleichen von Hashes ist schneller als bei Objekten.  Noch wichtiger ist jedoch, dass ein einheitlicher Hash den Baum dichter füllt. </p><br><p>  Bäume balancieren so, dass sie nicht zu einer Liste ausarten.  Wenn Sie dem Suchbaum jedoch gleichmäßig verteilte Schlüssel hinzufügen, wird dieser automatisch ausgeglichen.  Da B-Bäume bei auftretenden Problemen mit dem Balancieren beginnen und Hashes die Schlüssel gleichmäßig mischen, verringert das Sortieren nach Hashes die Häufigkeit des Balancierens. </p><br><p>  Die Verwendung von Hashes im Suchbaum ist keine so seltsame Idee, wie es scheint. Ihre logische Entwicklung wird zu einem <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Hash-Array-Mapping-Versuch führen</a> . </p><br><h2 id="pendingentriestree"> <code>PendingEntriesTree</code> </h2> <br><p>  <code>PendingEntriesTree</code> speichert Schlüssel für Daten im Laufe der Zeit und wird wie festgelegt verwendet.  Die Sortierung erfolgt auf mehreren Ebenen: Zuerst nach Cache-ID sortiert, um Schlüssel in einem Cache zu gruppieren, und dann nach Lebensdauer.  Als nächstes folgt eine weitere Vergleichsrunde - anscheinend rein technisch, um zwischen Elementen zu unterscheiden.  Aus der Sortierung lässt sich leicht ableiten, dass diese Klasse zur Suche nach Bereichen verwendet wird.  Dieser Baum dupliziert die Cache-Eintragsschlüssel für die Vorauszahlung. </p><br><p>  Verstehe, wie dieses separate Abenteuer funktioniert. </p><br><div class="spoiler">  <b class="spoiler_title">Abenteuer</b> <div class="spoiler_text"><p>  <code>IgniteCacheOffheapManagerImpl.expire()</code> in <code>IgniteCacheOffheapManagerImpl.expire()</code> den Cursor und löschen Sie Einträge aus dem <code>PendingEntriesTree</code> .  Die Einträge im <code>CacheDataTree</code> werden im Closure <code>c</code> gelöscht, der in den Parametern übergeben wird. </p><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">expire</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( GridCacheContext cctx, IgniteInClosure2X&lt;GridCacheEntryEx, GridCacheVersion&gt; c, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> amount )</span></span></span></span></code> </pre> <br><p>  Apache Ignite unterstützt Java 7 erst seit kurzem nicht mehr, sodass der Abschluss über eine anonyme Klasse erstellt wird. </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> IgniteInClosure2X&lt;GridCacheEntryEx, GridCacheVersion&gt; expireC = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> IgniteInClosure2X&lt;GridCacheEntryEx, GridCacheVersion&gt;() { <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">applyx</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(GridCacheEntryEx entry, GridCacheVersion obsoleteVer)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">boolean</span></span> touch = !entry.isNear(); <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (log.isTraceEnabled()) log.trace(<span class="hljs-string"><span class="hljs-string">"Trying to remove expired entry from cache: "</span></span> + entry); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (entry.onTtlExpired(obsoleteVer)) touch = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (GridCacheEntryRemovedException ignore) { entry = entry.context().cache().entryEx(entry.key()); touch = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; } } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (touch) entry.context().evicts().touch(entry, <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>); } };</code> </pre><br><p>  Was wir suchen, ist in der <code>GridCacheMapEntry.onTtlExpired()</code> -Methode, wo sich die geschätzte Zeile im <code>finally</code> Block befindet. </p><br><pre> <code class="java hljs">cctx.cache().removeEntry(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>);</code> </pre> </div></div><br><h1 id="detali-realizacii">  Implementierungsdetails </h1><br><h2 id="rabota-so-stranicami-v-offheap">  Arbeiten Sie mit Seiten in Offheap </h2><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Offheap</a> ist eine Technik zur Optimierung der manuellen Speicherverwaltung in einer Sprache mit einem Garbage Collector. </p><br><p>  Es ist ein Mythos, dass aufgrund des Müllsammlers alles langsamer wird und Sammler normalerweise einen <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">miserablen Prozentsatz der Leistung</a> kosten.  Auch große Haufen an sich sind kein Problem, denn  Sammler arbeiten wettbewerbsfähig (z. B. <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">CMS und G1</a> in Java), und Server verfügen über <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Dutzende von Kernen</a> .  Natürlich fügt der Collector der Anwendung unvorhersehbare Pausen hinzu, was für Spiele wichtig, für die Datenbank jedoch tolerierbar ist. </p><br><p>  Aber was wirklich das Problem sein wird, ist eine Verletzung der Generationshypothese auf einem großen Haufen. </p><br><div class="spoiler">  <b class="spoiler_title">Generierungshypothesen</b> <div class="spoiler_text"><p>  GC-Optimierungen verwenden die Generationshypothese.  Diese Hypothese existiert in zwei Versionen: stark und schwach. </p><br><p>  <strong>Schwache Generationshypothese: Die</strong> meisten Objekte sterben jung. </p><br><p>  <strong>Eine starke Hypothese über Generationen:</strong> Je älter das Objekt ist, desto länger wird es leben. </p><br><p>  Eine starke Hypothese impliziert eine schwache, aber nicht umgekehrt.  Idealerweise sollte sich der GC damit zufrieden geben, die schwache Hypothese zu erfüllen, aber in der Praxis ist dies nicht der Fall. </p><br><p>  Schauen Sie sich Alexey Shipilevs Vortrag über den neuen GC in Java an, wenn Sie das Thema besser verstehen möchten: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">eins</a> und <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">zwei</a> . </p></div></div><br><p>  Und hier ist es so, dass Apache Ignite vor dem Aufkommen von PDS hauptsächlich als Cache zwischen Diensten und einer Festplattendatenbank (zum Beispiel <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Hadoop</a> ) positioniert wurde.  Daher heißen die Maps in Ignite <code>IgniteCache</code> und verfügen über die entsprechende Extrusionsfunktionalität.  Und Caches verletzen nur die Generationshypothese - in ihnen steigt die Wahrscheinlichkeit, dass ein Objekt gelöscht wird, mit der Zeit.  In diesem Fall verbessert Offheap zum Speichern von Benutzerdaten daher die Leistung. </p><br><p>  Weitere Boni: </p><br><ul><li>  Offheap erleichtert die Implementierung von Strukturen, die mehr als <code>Integer.MAX_VALUE</code> Elemente enthalten. </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Wenn Sie weniger als 32 GB behalten, wiegen die Links 4 Byte</a> , was einige Gigabyte spart. </li><li>  Da der Kollektor ein Diagramm von Objekten erstellt, verbraucht er proportional zu ihrer Anzahl Speicher.  Und die Anzahl der Objekte ist proportional zum Heap.  Der Kollektor verbraucht auch eine CPU, die beispielsweise besser für die Datenkomprimierung verwendet wird. </li><li>  Selbst wenn die Generationshypothese nicht als Ganzes verletzt wird, gibt es auf sehr großen Haufen immer noch ziemlich viele alte Objekte im absoluten Wert, die sie verletzen. </li></ul><br><p>  Da die Daten dann auf die Festplatte gesendet werden, werden die Objekte direkt durch <code>unsafe</code> Daten in den Speicher serialisiert, und dieser Speicherbereich wird dann für den E / A-Puffer verwendet. </p><br><h2 id="write-ahead-log">  Schreiben Sie ein Protokoll voraus </h2><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Write Ahead Log</a> ist ein Protokoll von Operationen mit einer linearen Struktur, dessen Hinzufügen im Gegensatz zu einem Baum eine Konstante kostet.  Der Baum wird seltener aktualisiert. Wenn Daten aufgrund eines Sturzes verloren gehen, werden sie aus dem Protokoll wiederhergestellt, indem Vorgänge angewendet werden, die mit dem zuletzt gespeicherten Status beginnen.  Das Ergebnis ist eine verbesserte Leistung, ohne die Zuverlässigkeit zu beeinträchtigen.  Ich empfehle Ihnen, einen Blick auf die <code>IgniteWriteAheadLogManager</code> Oberfläche zu <code>IgniteWriteAheadLogManager</code> - es gibt eine detaillierte Dokumentation. </p><br><h2 id="obhod-uzla">  Knotenumgehung </h2><br><p>  Da die Knoten in den B-Bäumen nicht klein sind, werden sie durch binäre Suche umgangen.  Hierzu werden Nachkommen der <code>BPlusTree.GetPageHandler</code> Klasse <code>BPlusTree.GetPageHandler</code> , und für verschiedene Operationen sind sie unterschiedlich. </p><br><div class="spoiler">  <b class="spoiler_title">Implementierung der binären Suche</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">findInsertionPoint</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> lvl, BPlusIO&lt;L&gt; io, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">long</span></span></span></span><span class="hljs-function"><span class="hljs-params"> buf, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> low, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> cnt, L row, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> shift)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> IgniteCheckedException </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">assert</span></span> row != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> high = cnt - <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (low &lt;= high) { <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> mid = (low + high) &gt;&gt;&gt; <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> cmp = compare(lvl, io, buf, mid, row); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (cmp == <span class="hljs-number"><span class="hljs-number">0</span></span>) cmp = -shift; <span class="hljs-comment"><span class="hljs-comment">// We need to fix the case when search row matches multiple data rows. //noinspection Duplicates if (cmp &lt; 0) low = mid + 1; else if (cmp &gt; 0) high = mid - 1; else return mid; // Found. } return -(low + 1); // Not found. }</span></span></code> </pre> <br><p>  Die <code>compare</code> ist für verschiedene Nachkommen von <code>BPlusTree</code> .  Ein negativer Index codiert das Fehlen eines Elements an der Position, an der es sich befinden könnte.  <code>Collections.binarySearch</code> aus der Standardbibliothek macht dasselbe. </p><br><p>  Beachten Sie die folgenden Zeilen. </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (cmp == <span class="hljs-number"><span class="hljs-number">0</span></span>) cmp = -shift;</code> </pre> <br><p>  Für die <code>findOne</code> Operation führt dieser Code nichts aus, weil  <code>shift</code> wird auf Null gesetzt, d.h.  Wenn sich dieselben Schlüssel im Baum befinden, finden sie einen beliebigen von ihnen. </p><br><p>  Wenn Sie jedoch auf diese Weise nach dem Bereich suchen, gehen die Elemente verloren, sodass die <code>shift</code> auf <code>1</code> .  Infolgedessen findet die Suche <em>das Element nicht, selbst wenn es vorhanden ist</em> , aber es ist nicht wichtig, nach dem Bereich zu suchen. </p></div></div><br><h2 id="spisok-listov">  Liste der Blätter </h2><br><p>  Um den Bereich effizient zu umgehen, werden Blätter an eine Liste gebunden.  <code>BPlusTree.ForwardCursor</code> , der von Blatt zu Blatt wechselt, wird als Suchergebnis zurückgegeben.  Anscheinend ist die Cursorpassage nicht von anderen Operationen im Baum isoliert, weil  Beim Übergeben wird die Sperre nur auf einer Seite aufgehoben.  Ich habe keinen Synchronisationsmechanismus gefunden, der den Zugriff auf Cursormethoden schützt. </p><br><h1 id="zaklyuchenie">  Fazit </h1><br><p>  Da der B + -Baum in Apache Ignite im Vergleich zu anderen relationalen Datenbanken noch jung ist, erhalten wir den erforderlichen Satz für den produktionsbereiten B + -Baum: </p><br><ul><li>  <strong>WAL</strong> bietet billige Sicherheit, daher wird der Baum selten auf der Festplatte aktualisiert. </li><li>  <strong>Offheap</strong> mit Daten in serialisierter Form. </li><li>  <strong>Parallelität</strong> - für Teile des Baums, die in den Speicher geladen werden. </li></ul></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de413749/">https://habr.com/ru/post/de413749/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de413739/index.html">Wie wir das gesamte Internet gescannt haben und was wir gelernt haben</a></li>
<li><a href="../de413741/index.html">Was es war und wie: Eindrücke des WWDC Redmadrobot-Teams</a></li>
<li><a href="../de413743/index.html">Starten Sie LAMP und Hunderte anderer Webanwendungen mit wenigen Klicks</a></li>
<li><a href="../de413745/index.html">Für alle elektronischen Geräte im menschlichen Körper wurde gleichzeitig ein drahtloses Stromversorgungssystem entwickelt</a></li>
<li><a href="../de413747/index.html">NULL durchlaufen</a></li>
<li><a href="../de413751/index.html">Ruslan Cheremin und Maxim Gramin - arbeiten mit der Umwelt auf jug.msk.ru</a></li>
<li><a href="../de413753/index.html">Auge in den Himmel: Patrouillendrohne mit Anerkennung von Gewalt in Menschenmengen und an öffentlichen Orten</a></li>
<li><a href="../de413757/index.html">Datenbank in einem kommerziellen Projekt: Was tun?</a></li>
<li><a href="../de413759/index.html">Neugierde entdeckte organische Stoffe auf dem Milliarden Jahre alten Mars</a></li>
<li><a href="../de413761/index.html">So verhindern Sie, dass Windows 10 nach Updates neu gestartet wird</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>