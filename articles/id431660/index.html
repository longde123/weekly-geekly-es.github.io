<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üßë ü§∏üèº üì® Fitur game menggunakan ECS: tambahkan kit P3K ke penembak üßùüèΩ üàöÔ∏è üê≥</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Mari kita beralih dari karpet ke hal-hal serius. Kami sudah bicara tentang ECS, kerangka apa yang ada untuk Unity dan mengapa mereka menulis sendiri (...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Fitur game menggunakan ECS: tambahkan kit P3K ke penembak</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/pixonic/blog/431660/"><img src="https://habrastorage.org/webt/qi/7x/ws/qi7xwsjwk196kqfg3ulcss6d3eo.jpeg"><br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Mari kita</a> beralih dari <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">karpet</a> ke hal-hal serius.  Kami sudah bicara tentang ECS, kerangka apa yang ada untuk Unity dan mengapa mereka menulis sendiri (Anda dapat menemukan daftar di akhir artikel).  Sekarang mari kita membahas contoh-contoh spesifik tentang bagaimana kita menggunakan ECS dalam penembak PvP seluler baru kita dan bagaimana kita menerapkan fitur-fitur game.  Saya perhatikan bahwa kami menggunakan arsitektur ini hanya untuk mensimulasikan dunia pada server dan sistem prediksi pada klien.  Visualisasi dan rendering objek diimplementasikan menggunakan pola MVP - tetapi tidak tentang itu hari ini. <a name="habracut"></a><br><br>  Arsitektur ECS berorientasi data, semua data dunia permainan disimpan dalam apa yang disebut GameState dan merupakan daftar entitas (entitas) dengan beberapa komponen pada masing-masingnya.  Seperangkat komponen menentukan perilaku suatu objek.  Dan logika perilaku komponen terkonsentrasi dalam sistem. <br><br>  Gamestate di ECS kami terdiri dari dua bagian: RuleBook dan WorldState.  RuleBook adalah seperangkat komponen yang tidak berubah selama pertandingan.  Semua data statis disimpan di sana (karakteristik senjata / karakter, komposisi tim) dan dikirim ke klien hanya sekali - selama otorisasi di server permainan. <br><br>  Pertimbangkan contoh sederhana: menelurkan karakter dan pindahkan dalam ruang 2D menggunakan dua joystick.  Pertama, deklarasikan komponen. <br><br>  Ini menentukan pemain dan diperlukan untuk visualisasi karakter: <br><br><pre><code class="cs hljs">[<span class="hljs-meta"><span class="hljs-meta">Component</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Player</span></span> { }</code> </pre> <br>  Komponen selanjutnya adalah permintaan untuk membuat karakter baru.  Ini berisi dua bidang: waktu karakter spawn (dalam kutu) dan ID-nya: <br><br><pre> <code class="cs hljs">[<span class="hljs-meta"><span class="hljs-meta">Component</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">PlayerSpawnRequest</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> SpawnTime; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> unit PlayerId; }</code> </pre> <br>  Komponen orientasi objek dalam ruang: <br><br><pre> <code class="cs hljs">[<span class="hljs-meta"><span class="hljs-meta">Component</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Transform</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Vector2 Position; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> Rotation; }</code> </pre> <br>  Komponen yang menyimpan kecepatan objek saat ini: <br><br><pre> <code class="cs hljs">[<span class="hljs-meta"><span class="hljs-meta">Component</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Movement</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Vector2 Velocity; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> RotateToAngle; }</code> </pre> <br>  Komponen yang menyimpan input pemain (vektor joystick gerak dan vektor joystick rotasi karakter): <br><br><pre> <code class="cs hljs">[<span class="hljs-meta"><span class="hljs-meta">Component</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Input</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Vector2 MoveVector; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Vector2 RotateVector; }</code> </pre> <br>  Komponen dengan karakteristik statis karakter (itu akan disimpan di RuleBook, karena ini adalah karakteristik dasar dan tidak berubah selama sesi permainan): <br><br><pre> <code class="cs hljs">[<span class="hljs-meta"><span class="hljs-meta">Component</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">PlayerStats</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> MoveSpeed; }</code> </pre> <br>  Ketika mendekomposisi fitur ke dalam sistem, kita sering dipandu oleh prinsip tanggung jawab tunggal: setiap sistem harus memenuhi satu dan hanya satu fungsi. <br><br>  Fitur dapat terdiri dari beberapa sistem.  Mari kita mulai dengan mendefinisikan sistem karakter spawn.  Sistem melewati semua permintaan untuk membuat karakter dalam gamestate dan jika waktu dunia saat ini cocok dengan yang diperlukan, itu menciptakan entitas baru dan menempel padanya komponen yang menentukan pemain: <i>Pemain</i> , <i>Transformasi</i> , <i>Gerakan</i> . <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">SpawnPlayerSystem</span></span> : <span class="hljs-title"><span class="hljs-title">ExecutableSystem</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Execute</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">GameState gs</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> deleter = gs.Pools.Deferred.GetDeleter(gs.WorldState.SpawnAvatarRequest); <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> avatarRequest <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> gs.WorldState.SpawnAvatarRequest) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (avatarRequest.Value.SpawnTime == gs.Time) { <span class="hljs-comment"><span class="hljs-comment">// create new entity with player ID var playerEntity = gs.WorldState.CreateEntity(avatarRequest.Value.PlayerId); // add components to determinate player behaviour playerEntity.AddPlayer(); playerEntity.AddTransform(Vector2.zero, 0); playerEntity.AddMovement(Vector2.zero, 0); // delete player spawn request deleter.Delete(avatarRequest.Key); } } } }</span></span></code> </pre><br>  Sekarang perhatikan pergerakan pemain di joystick.  Kami membutuhkan sistem yang akan menangani input.  Ini melewati semua komponen input, menghitung kecepatan pemain (dia berdiri atau bergerak) dan mengubah vektor joystick rotasi menjadi sudut rotasi: <br><br><pre> <code class="cs hljs">MovementControlSystem <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">MovementControlSystem</span></span> : <span class="hljs-title"><span class="hljs-title">ExecutableSystem</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Execute</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">GameState gs</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> playerStats = gs.RuleBook.PlayerStats[<span class="hljs-number"><span class="hljs-number">1</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> pair <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> gs.Input) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> movement = gs.WorldState.Movement[pair.Key]; movement.Velocity = pair.Value.MoveVector.normalized * playerStats.MoveSpeed; movement.RotateToAngle = Math.Atan2(pair.Value.RotateVector.y, pair.Value.RotateVector.x); } } }</code> </pre> <br>  Berikutnya adalah sistem pergerakan: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">MovementSystem</span></span> : <span class="hljs-title"><span class="hljs-title">ExecutableSystem</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Execute</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">GameState gs</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> pair <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> gs.WorldState.Movement) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> transform = gs.WorldState.Transform[pair.Key]; transform.Position += pair.Value.Velocity * GameState.TickDurationSec; } } }</code> </pre> <br>  Sistem yang bertanggung jawab untuk rotasi objek: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">RotationSystem</span></span> : <span class="hljs-title"><span class="hljs-title">ExecutableSystem</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Execute</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">GameState gs</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> pair <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> gs.WorldState.Movement) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> transform = gs.WorldState.Transform[pair.Key]; transform.Angle = pair.Value.RotateToAngle; } } }</code> </pre> <br>  <i>MovementSystem</i> dan <i>RotationSystem</i> hanya berfungsi dengan komponen <i>Transform</i> dan <i>Movement</i> .  Mereka terlepas dari esensi pemain.  Jika entitas lain dengan komponen <i>Gerakan</i> dan <i>Transform</i> muncul di permainan kami, logika gerakan juga akan bekerja dengannya. <br><br>  Misalnya, tambahkan kit pertolongan pertama yang akan bergerak dalam garis lurus di sepanjang bibit dan, saat memilih, mengisi kembali kesehatan karakter.  Deklarasikan komponen: <br><br><pre> <code class="cs hljs">[<span class="hljs-meta"><span class="hljs-meta">Component</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Health</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">uint</span></span> CurrentHealth; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">uint</span></span> MaxHealth; } [Component] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">HealthPowerUp</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">uint</span></span> NextChangeDirection; } [Component] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">HealthPowerUpSpawnRequest</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">uint</span></span> SpawnRequest; } [Component] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">HealthPowerUpStats</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> HealthRestorePercent; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> MoveSpeed; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> SecondsToChangeDirection; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> PickupRadius; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> TimeToSpawn; }</code> </pre> <br>  Kami memodifikasi komponen statistik karakter dengan menambahkan jumlah maksimum kehidupan di sana: <br><br><pre> <code class="cs hljs">[<span class="hljs-meta"><span class="hljs-meta">Component</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">PlayerStats</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> MoveSpeed; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">uint</span></span> MaxHealth; }</code> </pre> <br>  Sekarang kita memodifikasi sistem karakter spawn sehingga karakter muncul dengan kesehatan maksimum: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">SpawnPlayerSystem</span></span> : <span class="hljs-title"><span class="hljs-title">ExecutableSystem</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Execute</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">GameState gs</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> deleter = gs.Pools.Deferred.GetDeleter(gs.WorldState.SpawnAvatarRequest); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> playerStats = gs.RuleBook.PlayerStats[<span class="hljs-number"><span class="hljs-number">1</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> avatarRequest <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> gs.WorldState.SpawnAvatarRequest) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (avatarRequest.Value.SpawnTime &lt;= gs.Time) { <span class="hljs-comment"><span class="hljs-comment">// create new entity with player ID var playerEntity = gs.WorldState.CreateEntity(avatarRequest.Value.PlayerId); // add components to determinate player behaviour playerEntity.AddPlayer(); playerEntity.AddTransform(Vector2.zero, 0); playerEntity.AddMovement(Vector2.zero, 0); playerEntity.AddHealth(playerStats.MaxHealth, playerStats.MaxHealth); // delete player spawn request deleter.Delete(avatarRequest.Key); } } } }</span></span></code> </pre> <br>  Lalu kami mendeklarasikan sistem spawn kit P3K kami: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">SpawnHealthPowerUpSystem</span></span> : <span class="hljs-title"><span class="hljs-title">ExecutableSystem</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Execute</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">GameState gs</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> deleter = gs.Pools.Deferred.GetDeleter(gs.WorldState.HealthPowerUpSpawnRequest); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> healthPowerUpStats = gs.RoolBook.healthPowerUpStats[<span class="hljs-number"><span class="hljs-number">1</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> spawnRequest <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> gs.WorldState.HealthPowerUpSpawnRequest) { <span class="hljs-comment"><span class="hljs-comment">// create new entity var powerUpEntity = gs.WorldState.CreateEntity(); // add components to determine healthPowerUp behaviour powerUpEntity.AddHealthPowerUp((uint)(healthPowerUpStats.SecondsToChangeDirection * GameState.Hz)); playerEntity.AddTransform(Vector2.zero, 0); playerEntity.AddMovement(healthPowerUpStats.MoveSpeed, 0); // delete player spawn request deleter.Delete(spawnRequest.Key); } } }</span></span></code> </pre> <br>  Dan sistem untuk mengubah kecepatan kotak P3K.  Untuk menyederhanakan, kotak P3K akan mengubah arah setiap beberapa detik: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">HealthPowerUpMovementSystem</span></span> : <span class="hljs-title"><span class="hljs-title">ExecutableSystem</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Execute</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">GameState gs</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> healthPowerUpStats = gs.RoolBook.healthPowerUpStats[<span class="hljs-number"><span class="hljs-number">1</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> pair <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> gs.WorldState.HealthPowerUp) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> movement = gs.WorldState.Movement[pair.Key]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(pair.Value.NextChangeDirection &lt;= gs.Time) { pair.Value.NextChangeDirection = (<span class="hljs-keyword"><span class="hljs-keyword">uint</span></span>) (healthPowerUpStats.SecondsToChangeDirection * GameState.Hz); movement.Velocity *= <span class="hljs-number"><span class="hljs-number">-1</span></span>; } } } }</code> </pre> <br>  Karena kami sudah mengumumkan <i>MovementSystem</i> untuk memindahkan objek dalam permainan, kami hanya perlu <i>HealthPowerUpMovementSystem</i> untuk mengubah vektor kecepatan, setiap N detik. <br><br>  Sekarang kita menyelesaikan pemilihan kit P3K dan perhitungan karakter HP.  Kita akan memerlukan komponen tambahan lain untuk menyimpan jumlah nyawa yang akan diterima karakter setelah memilih kotak P3K. <br><br><pre> <code class="cs hljs">[<span class="hljs-meta"><span class="hljs-meta">Component</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">HealthToAdd</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> Health; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Entity Target; }</code> </pre><br>  Dan komponen untuk menghilangkan kekuatan kita: <br><br><pre> <code class="cs hljs">[<span class="hljs-meta"><span class="hljs-meta">Component</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">DeleteHealthPowerUpRequest</span></span> { }</code> </pre> <br>  Kami menulis sistem yang memproses pemilihan kit P3K: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">HealthPowerUpPickUpSystem</span></span> : <span class="hljs-title"><span class="hljs-title">ExecutableSystem</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Execute</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">GameState gs</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> healthPowerUpStats = gs.RoolBook.healthPowerUpStats[<span class="hljs-number"><span class="hljs-number">1</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> powerUpPair <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> gs.WorldState.HealthPowerUp) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> powerUpTransform = gs.WorldState.Transform[powerUpPair.Key]; <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> playerPair <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> gs.WorldState.Player) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> playerTransform = gs.WorldState.Transform[playerPair.Key]; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> distance = Vector2.Distance(powerUpTransform.Position, playerTransform.Position) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(distance &lt; healthPowerUpStats.PickupRadius) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> healthToAdd = gs.WorldState.Health[playerPair.Key].MaxHealth * healthPowerUpStats.HealthRestorePercent; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> entity = gs.WorldState.CreateEntity(); entity.AddHealthToAdd(healthToAdd, gs.WorldState.Player[playerPair.Key]); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> powerUpEnity = gs.WorldState[powerUpPair.Key]; powerUpEnity.AddDeleteHealthPowerUpRequest(); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } } } } }</code> </pre> <br>  Sistem melewati semua power-up aktif dan menghitung jarak ke pemain.  Jika ada pemain dalam radius seleksi, sistem membuat dua komponen permintaan: <br><br>  <i>HealthToAdd</i> - "permintaan" untuk menambahkan kehidupan ke karakter; <br>  <i>DeleteHealthPowerUpRequest</i> - "request" untuk menghapus kit pertolongan pertama. <br><br>  Mengapa tidak menambahkan jumlah nyawa yang tepat dalam sistem yang sama?  Kami melanjutkan dari fakta bahwa pemain menerima HP tidak hanya dari kit P3K, tetapi juga dari sumber lain.  Dalam hal ini, lebih baik untuk memisahkan sistem pemilihan kit pertolongan pertama dan sistem akrual kehidupan karakter.  Selain itu, ini lebih konsisten dengan Prinsip Tanggung Jawab Tunggal. <br><br>  Kami menerapkan sistem accruing lives dengan karakter: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">HealingSystem</span></span> : <span class="hljs-title"><span class="hljs-title">ExecutableSystem</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Execute</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">GameState gs</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> deleter = gs.Pools.Deferred.GetDeleter(gs.WorldState.HealthToAdd); <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> healtToAddPair <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> gs.WorldState.HealthToAdd) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> healthToAdd = healtToAddPair.Value.Health; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> health = healtToAddPair.Value.Target.Health; health.CurrentHealth += healthToAdd; health.CurrentHealth = Mathf.Clamp(health.CurrentHealth, <span class="hljs-number"><span class="hljs-number">0</span></span>, health.MaxHealth); deleter.Delete(healtToAddPair.Key); } } }</code> </pre> <br>  Sistem melewati semua komponen <i>HealthToAdd</i> , menghitung jumlah nyawa yang diperlukan dalam komponen <i>Kesehatan</i> dari entitas <i>Target</i> target.  Entitas ini tidak tahu apa-apa tentang sumber dan target dan cukup universal.  Sistem ini dapat digunakan tidak hanya untuk menghitung kehidupan karakter, tetapi untuk objek apa pun yang melibatkan keberadaan kehidupan dan regenerasi mereka. <br><br>  Untuk mengimplementasikan fitur dengan kotak P3K, ia tetap menambahkan sistem terakhir: sistem P3K setelah setelah pemilihannya. <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">DeleteHealthPowerUpSystem</span></span> : <span class="hljs-title"><span class="hljs-title">ExecutableSystem</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Execute</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">GameState gs</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> deleter = gs.Pools.Deferred.GetDeleter(gs.WorldState.DeleteHealthPowerUpReques); <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> healthRequest <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> gs.WorldState.DeleteHealthPowerUpReques) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> id = healthRequest.Key; gs.WorldState.DelHealthPowerUp(id); gs.WorldState.DelTransform(id); gs.WorldState.DelMovement(id); deleter.Delete(id); } } }</code> </pre> <br>  <i>HealthPowerUpPickUpSystem</i> membuat permintaan untuk menghapus kit pertolongan pertama.  Sistem <i>DeleteHealthPowerUpSystem</i> melewati semua permintaan seperti itu dan menghapus semua komponen yang merupakan inti dari kit pertolongan pertama. <br><br>  Selesai  Semua sistem dari contoh kami diimplementasikan.  Ada satu titik bekerja dengan ECS - semua sistem dijalankan secara berurutan dan urutan ini penting. <br><br>  Dalam contoh kami, urutan sistem adalah sebagai berikut: <br><br><pre> <code class="cs hljs">_systems = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> List&lt;ExecutableSystem&gt; { <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SpawnPlayerSystem(), <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SpawnHealthPowerUpSystem(), <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> MovementControlSystem(), <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> HealthPowerUpMovementSystem(), <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> MovementSystem(), <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> RotationSystem(), <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> HealthPowerUpPickUpSystem(), <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> HealingSystem(), <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> DeleteHealthPowerUpSystem() };</code> </pre> <br>  Dalam kasus umum, sistem yang bertanggung jawab untuk membuat entitas dan komponen baru didahulukan.  Kemudian sistem perawatan, dan akhirnya sistem pembuangan dan pembersihan. <br><br>  Dengan dekomposisi yang tepat, ECS memiliki fleksibilitas besar.  Ya, implementasi kami tidak sempurna, tetapi memungkinkan Anda untuk mengimplementasikan fitur dalam waktu singkat, dan juga memiliki kinerja yang baik pada perangkat seluler modern.  Anda dapat membaca lebih lanjut tentang ECS ‚Äã‚Äãdi sini: <br><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Bagaimana dan mengapa kami menulis ECS kami</a> . </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Cara kami men-debug ECS ‚Äã‚Äãyang ditulis sendiri di peramban di server gim</a> . </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Seperti ECS, Sistem Pekerjaan C # dan SRP mengubah arsitektur</a> . </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Unity ECS</a> . </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Persatuan, ECS, dan semuanya.</a>  Artikel bagus tentang ECS ‚Äã‚Äãdalam contoh. </li></ul></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/id431660/">https://habr.com/ru/post/id431660/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../id431648/index.html">NB-IoT: bagaimana cara kerjanya? Bagian 2</a></li>
<li><a href="../id431650/index.html">Latensi Belajar: Teori Antrian</a></li>
<li><a href="../id431652/index.html">Algoritma pengambilan sampel reservoir</a></li>
<li><a href="../id431654/index.html">Tren dalam bahasa pemrograman 2019</a></li>
<li><a href="../id431656/index.html">CraSSh: memecah semua browser modern dengan perhitungan CSS</a></li>
<li><a href="../id431664/index.html">Pusat fase antena (FCA) dan pencariannya di Ansys HFSS</a></li>
<li><a href="../id431666/index.html">Kecerdasan buatan. Kekayaan intelektual. Bahaya</a></li>
<li><a href="../id431668/index.html">Apa yang Baru di GoLand 2018.3</a></li>
<li><a href="../id431670/index.html">Zen dan Dukungan Seni Kode Murni</a></li>
<li><a href="../id431674/index.html">Kanvas Nanoleaf: Soon On All Walls</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>