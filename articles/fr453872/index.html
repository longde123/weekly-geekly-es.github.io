<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üçº üë©üèø‚Äçüåæ üéôÔ∏è Restauration de photos √† l'aide de r√©seaux de neurones üë®üèª‚Äçüîß ü§≤üèª üë©üèΩ‚Äçüîß</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Salut tout le monde, je travaille en tant que programmeur de recherche dans l'√©quipe de vision par ordinateur du groupe Mail.ru. Pour le Jour de la Vi...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Restauration de photos √† l'aide de r√©seaux de neurones</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/mailru/blog/453872/"><img src="https://habrastorage.org/getpro/habr/post_images/333/44a/c78/33344ac788b63200841180799417f934.jpg"><br><br>  Salut tout le monde, je travaille en tant que programmeur de recherche dans l'√©quipe de vision par ordinateur du groupe Mail.ru.  Pour le Jour de la Victoire de cette ann√©e, nous avons d√©cid√© de r√©aliser un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">projet de restauration de photographies militaires</a> .  Qu'est-ce que la restauration photo?  Il se compose de trois √©tapes: <br><br><ul><li>  on retrouve tous les d√©fauts d'image: cassures, √©raflures, trous; <br></li><li>  peindre les d√©fauts trouv√©s en fonction des valeurs de pixels qui les entourent; <br></li><li>  colorise l'image. <br></li></ul><br>  Dans cet article, je passerai en revue chacune des √©tapes de la restauration en d√©tail et vous dirai comment et o√π nous avons pris les donn√©es, quels r√©seaux nous avons appris, ce que nous avons fait, quels r√¢teaux nous avons emprunt√©s. <br><a name="habracut"></a><br><h1>  Recherche de d√©fauts </h1><br>  Nous voulons trouver tous les pixels li√©s aux d√©fauts dans la photo t√©l√©charg√©e.  Tout d'abord, nous devons comprendre quel type de photographies des ann√©es de guerre les gens vont t√©l√©charger.  Nous nous sommes tourn√©s vers les organisateurs du projet Immortal Regiment, qui ont partag√© des donn√©es avec nous.  Apr√®s les avoir analys√©s, nous avons remarqu√© que les gens t√©l√©chargent souvent des portraits, seuls ou en groupe, qui pr√©sentent un nombre mod√©r√© ou important de d√©fauts. <br><br>  Il a ensuite fallu pr√©lever un √©chantillon de formation.  L'√©chantillon d'apprentissage pour la t√¢che de segmentation est une image et un masque sur lesquels tous les d√©fauts sont marqu√©s.  Le moyen le plus simple est de donner des photos aux marqueurs aux marqueurs.  Bien s√ªr, les gens sont capables de trouver des d√©fauts, mais le probl√®me est que le balisage est un processus tr√®s long. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/d5d/a19/892/d5da1989220f10bcaac3944d27d64276.png"><br><br>  Cela peut prendre entre une heure et une journ√©e enti√®re de travail pour marquer des pixels li√©s √† des d√©fauts sur une photo, il est donc difficile de collecter un √©chantillon de plus de 100 photos en quelques semaines.  Par cons√©quent, nous avons essay√© de compl√©ter nos donn√©es en quelque sorte et avons √©crit nous-m√™mes les d√©fauts: nous avons pris une photo propre, y avons appliqu√© des d√©fauts artificiels et obtenu un masque nous indiquant quelles parties particuli√®res de l'image √©taient endommag√©es.  La partie principale de notre √©chantillon de formation √©tait de 79 photos marqu√©es manuellement, dont 11 ont √©t√© transf√©r√©es √† l'√©chantillon de test. <br><br>  L'approche la plus populaire pour le probl√®me de segmentation: prenez Unet avec un encodeur pr√©-form√© et minimisez la quantit√© <math></math><span class="MathJax_Preview" style="color: inherit;"><span class="MJXp-math" id="MJXp-Span-1"><span class="MJXp-mi MJXp-italic" id="MJXp-Span-2">B</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-3">c</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-4">e</span></span></span><span class="MathJax_SVG MathJax_SVG_Processed" id="MathJax-Element-1-Frame" tabindex="0" style="font-size: 100%; display: inline-block;"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="3.854ex" height="2.057ex" viewBox="0 -780.1 1659.5 885.9" role="img" focusable="false" style="vertical-align: -0.246ex;"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=https://habr.com/ru/company/mailru/blog/453872/&amp;usg=ALkJrhgoAD8aof8sFu4Rzf_zJ1nlQ-f7vg#MJMATHI-42" x="0" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=https://habr.com/ru/company/mailru/blog/453872/&amp;usg=ALkJrhgoAD8aof8sFu4Rzf_zJ1nlQ-f7vg#MJMATHI-63" x="759" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=https://habr.com/ru/company/mailru/blog/453872/&amp;usg=ALkJrhgoAD8aof8sFu4Rzf_zJ1nlQ-f7vg#MJMATHI-65" x="1193" y="0"></use></g></svg></span><script type="math/tex" id="MathJax-Element-1"> Bce </script>  ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">entropie crois√©e binaire</a> ) et <math></math><span class="MathJax_Preview" style="color: inherit;"><span class="MJXp-math" id="MJXp-Span-5"><span class="MJXp-mi MJXp-italic" id="MJXp-Span-6">D</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-7">I</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-8">C</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-9">E</span></span></span><span class="MathJax_SVG MathJax_SVG_Processed" id="MathJax-Element-2-Frame" tabindex="0" style="font-size: 100%; display: inline-block;"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="6.638ex" height="2.057ex" viewBox="0 -780.1 2858 885.9" role="img" focusable="false" style="vertical-align: -0.246ex;"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=https://habr.com/ru/company/mailru/blog/453872/&amp;usg=ALkJrhgoAD8aof8sFu4Rzf_zJ1nlQ-f7vg#MJMATHI-44" x="0" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=https://habr.com/ru/company/mailru/blog/453872/&amp;usg=ALkJrhgoAD8aof8sFu4Rzf_zJ1nlQ-f7vg#MJMATHI-49" x="828" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=https://habr.com/ru/company/mailru/blog/453872/&amp;usg=ALkJrhgoAD8aof8sFu4Rzf_zJ1nlQ-f7vg#MJMATHI-43" x="1333" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=https://habr.com/ru/company/mailru/blog/453872/&amp;usg=ALkJrhgoAD8aof8sFu4Rzf_zJ1nlQ-f7vg#MJMATHI-45" x="2093" y="0"></use></g></svg></span><script type="math/tex" id="MathJax-Element-2"> DICE </script>  ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">S√∏rensen - Coefficient de d√©s</a> ). <br><br>  Quels probl√®mes se posent avec cette approche dans le probl√®me de la segmentation des d√©fauts? <br><br><ul><li>  M√™me s'il nous semble qu'il y a beaucoup de d√©fauts sur la photo, qu'elle est tr√®s sale et tr√®s d√©chir√©e par le temps, la zone occup√©e par les d√©fauts est encore beaucoup plus petite que la partie intacte de l'image.  Pour r√©soudre ce probl√®me, vous pouvez augmenter le poids de la classe positive dans <math></math><span class="MathJax_Preview" style="color: inherit;"><span class="MJXp-math" id="MJXp-Span-10"><span class="MJXp-mi MJXp-italic" id="MJXp-Span-11">B</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-12">c</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-13">e</span></span></span><span class="MathJax_SVG MathJax_SVG_Processed" id="MathJax-Element-3-Frame" tabindex="0" style="font-size: 100%; display: inline-block;"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="3.854ex" height="2.057ex" viewBox="0 -780.1 1659.5 885.9" role="img" focusable="false" style="vertical-align: -0.246ex;"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=https://habr.com/ru/company/mailru/blog/453872/&amp;usg=ALkJrhgoAD8aof8sFu4Rzf_zJ1nlQ-f7vg#MJMATHI-42" x="0" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=https://habr.com/ru/company/mailru/blog/453872/&amp;usg=ALkJrhgoAD8aof8sFu4Rzf_zJ1nlQ-f7vg#MJMATHI-63" x="759" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=https://habr.com/ru/company/mailru/blog/453872/&amp;usg=ALkJrhgoAD8aof8sFu4Rzf_zJ1nlQ-f7vg#MJMATHI-65" x="1193" y="0"></use></g></svg></span><script type="math/tex" id="MathJax-Element-3"> Bce </script>  , et le poids optimal sera le rapport du nombre de pixels purs au nombre de pixels appartenant aux d√©fauts. <br></li><li>  Le deuxi√®me probl√®me est que si nous utilisons Unet avec un encodeur pr√©-form√©, par exemple Albunet-18, alors nous perdons beaucoup d'informations de position.  La premi√®re couche d'Albunet-18 consiste en une convolution avec un noyau de 5 et une foul√©e √©gale √† deux.  Cela permet au r√©seau de fonctionner rapidement.  Nous avons sacrifi√© le temps r√©seau pour une meilleure localisation des d√©fauts: nous avons supprim√© le pool max apr√®s la premi√®re couche, r√©duit la foul√©e √† 1 et r√©duit le noyau de convolution √† 3. <br></li><li>  Si nous travaillons avec de petites images, par exemple, en compressant une image en 256 x 256 ou 512 x 512, les petits d√©fauts dispara√Ætront simplement en raison de l'interpolation.  Par cons√©quent, vous devez travailler avec une grande image.  Maintenant en production, nous segmentons les d√©fauts dans les photographies de 1024 x 1024. Par cons√©quent, il √©tait n√©cessaire de former le r√©seau neuronal en grande r√©colte d'images de grande taille.  Et √† cause de cela, il y a des probl√®mes avec la petite taille du lot sur une carte vid√©o. <br></li><li>  Pendant la formation, nous avons environ 20 photos plac√©es sur une carte.  Pour cette raison, l'estimation de la moyenne et de la variance dans les couches BatchNorm est inexacte.  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">BatchNorm sur place</a> nous aide √† r√©soudre ce probl√®me, qui, d'une part, √©conomise de la m√©moire, et d'autre part, il a une version de BatchNorm synchronis√©, qui synchronise les statistiques entre toutes les cartes.  Maintenant, nous consid√©rons la moyenne et la variance non pas par 20 images sur une carte, mais par 80 images de 4 cartes.  Cela am√©liore la convergence du r√©seau. <br></li></ul><br>  En fin de compte, l'augmentation du poids <math></math><span class="MathJax_Preview" style="color: inherit;"><span class="MJXp-math" id="MJXp-Span-14"><span class="MJXp-mi MJXp-italic" id="MJXp-Span-15">B</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-16">c</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-17">e</span></span></span><span class="MathJax_SVG MathJax_SVG_Processed" id="MathJax-Element-4-Frame" tabindex="0" style="font-size: 100%; display: inline-block;"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="3.854ex" height="2.057ex" viewBox="0 -780.1 1659.5 885.9" role="img" focusable="false" style="vertical-align: -0.246ex;"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=https://habr.com/ru/company/mailru/blog/453872/&amp;usg=ALkJrhgoAD8aof8sFu4Rzf_zJ1nlQ-f7vg#MJMATHI-42" x="0" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=https://habr.com/ru/company/mailru/blog/453872/&amp;usg=ALkJrhgoAD8aof8sFu4Rzf_zJ1nlQ-f7vg#MJMATHI-63" x="759" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=https://habr.com/ru/company/mailru/blog/453872/&amp;usg=ALkJrhgoAD8aof8sFu4Rzf_zJ1nlQ-f7vg#MJMATHI-65" x="1193" y="0"></use></g></svg></span><script type="math/tex" id="MathJax-Element-4"> Bce </script>  En modifiant l'architecture et en utilisant BatchNorm sur place, nous avons commenc√© √† rechercher des d√©fauts sur la photo.  Mais √† moindre co√ªt, vous pourriez faire encore un peu mieux en ajoutant une augmentation de la dur√©e du test.  Nous pouvons ex√©cuter le r√©seau une fois dans l'image d'entr√©e, puis le mettre en miroir et ex√©cuter √† nouveau le r√©seau, cela peut nous aider √† trouver de petits d√©fauts. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/c75/95b/702/c7595b702dcb921dac612b0218ce13e4.png"><br><br>  En cons√©quence, notre r√©seau a converg√© sur quatre GeForce 1080Ti en 18 heures.  L'inf√©rence prend 290 ms.  Cela s'av√®re assez long, mais c'est le prix pour le fait que nous recherchons bien de petits d√©fauts.  Validation <math></math><span class="MathJax_Preview" style="color: inherit;"><span class="MJXp-math" id="MJXp-Span-18"><span class="MJXp-mi MJXp-italic" id="MJXp-Span-19">D</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-20">I</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-21">C</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-22">E</span></span></span><span class="MathJax_SVG MathJax_SVG_Processed" id="MathJax-Element-5-Frame" tabindex="0" style="font-size: 100%; display: inline-block;"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="6.638ex" height="2.057ex" viewBox="0 -780.1 2858 885.9" role="img" focusable="false" style="vertical-align: -0.246ex;"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=https://habr.com/ru/company/mailru/blog/453872/&amp;usg=ALkJrhgoAD8aof8sFu4Rzf_zJ1nlQ-f7vg#MJMATHI-44" x="0" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=https://habr.com/ru/company/mailru/blog/453872/&amp;usg=ALkJrhgoAD8aof8sFu4Rzf_zJ1nlQ-f7vg#MJMATHI-49" x="828" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=https://habr.com/ru/company/mailru/blog/453872/&amp;usg=ALkJrhgoAD8aof8sFu4Rzf_zJ1nlQ-f7vg#MJMATHI-43" x="1333" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=https://habr.com/ru/company/mailru/blog/453872/&amp;usg=ALkJrhgoAD8aof8sFu4Rzf_zJ1nlQ-f7vg#MJMATHI-45" x="2093" y="0"></use></g></svg></span><script type="math/tex" id="MathJax-Element-5"> DICE </script>  √©gal √† 0,35, et <math></math><span class="MathJax_Preview" style="color: inherit;"><span class="MJXp-math" id="MJXp-Span-23"><span class="MJXp-mi MJXp-italic" id="MJXp-Span-24">R</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-25">O</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-26">C</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-27">A</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-28">U</span><span class="MJXp-mi MJXp-italic" id="MJXp-Span-29">C</span></span></span><span class="MathJax_SVG MathJax_SVG_Processed" id="MathJax-Element-6-Frame" tabindex="0" style="font-size: 100%; display: inline-block;"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="10.596ex" height="2.057ex" viewBox="0 -780.1 4562 885.9" role="img" focusable="false" style="vertical-align: -0.246ex;"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=https://habr.com/ru/company/mailru/blog/453872/&amp;usg=ALkJrhgoAD8aof8sFu4Rzf_zJ1nlQ-f7vg#MJMATHI-52" x="0" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=https://habr.com/ru/company/mailru/blog/453872/&amp;usg=ALkJrhgoAD8aof8sFu4Rzf_zJ1nlQ-f7vg#MJMATHI-4F" x="759" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=https://habr.com/ru/company/mailru/blog/453872/&amp;usg=ALkJrhgoAD8aof8sFu4Rzf_zJ1nlQ-f7vg#MJMATHI-43" x="1523" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=https://habr.com/ru/company/mailru/blog/453872/&amp;usg=ALkJrhgoAD8aof8sFu4Rzf_zJ1nlQ-f7vg#MJMATHI-41" x="2283" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=https://habr.com/ru/company/mailru/blog/453872/&amp;usg=ALkJrhgoAD8aof8sFu4Rzf_zJ1nlQ-f7vg#MJMATHI-55" x="3034" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=https://habr.com/ru/company/mailru/blog/453872/&amp;usg=ALkJrhgoAD8aof8sFu4Rzf_zJ1nlQ-f7vg#MJMATHI-43" x="3801" y="0"></use></g></svg></span><script type="math/tex" id="MathJax-Element-6"> ROCAUC </script>  - 0,93. <br><br><h1>  Restauration de fragments </h1><br>  Unet nous a aid√© √† r√©soudre ce probl√®me √† nouveau.  Nous lui avons donn√© l'image d'origine et un masque √† l'entr√©e, sur lesquels nous marquons les espaces propres avec des unit√©s, et les pixels que nous voulons peindre avec des z√©ros.  Nous avons collect√© les donn√©es comme suit: nous avons pris d'Internet un grand ensemble de donn√©es avec des images, par exemple, OpenImagesV4, et ajout√© artificiellement des d√©fauts de forme similaire √† ceux trouv√©s dans la vie r√©elle.  Et apr√®s cela, ils ont form√© le r√©seau pour r√©parer les pi√®ces manquantes. <br><br>  Comment pouvons-nous modifier Unet pour cette t√¢che? <br><br>  Vous pouvez utiliser la convolution partielle au lieu de la convolution habituelle.  Son id√©e est que lorsque nous r√©duisons une r√©gion d'une image avec un noyau, nous ne prenons pas en compte les valeurs de pixels li√©es aux d√©fauts.  Cela permet de rendre la peinture plus pr√©cise.  Un exemple d'un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">article NVIDIA</a> .  Dans l'image centrale, ils ont utilis√© Unet avec la convolution habituelle, et √† droite - avec Convolution partielle: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/5a5/280/a4b/5a5280a4be71695d16ab08af876c5d23.png"><br><br>  Nous avons form√© le r√©seau pendant 5 jours.  Le dernier jour, nous avons gel√© BatchNorm, ce qui a contribu√© √† rendre les bords de la partie peinte de l'image moins visibles. <br><br>  Le r√©seau traite une image de 512 x 512 en 50 ms.  Le PSNR de validation est de 26,4.  Cependant, les mesures ne peuvent pas √™tre approuv√©es sans condition dans cette t√¢che.  Par cons√©quent, nous avons d'abord ex√©cut√© plusieurs bons mod√®les sur nos donn√©es, anonymis√© les r√©sultats, puis vot√© pour ceux que nous aimions le plus.  Nous avons donc choisi le mod√®le final. <br><br>  J'ai mentionn√© que nous avions artificiellement ajout√© des d√©fauts pour nettoyer les images.  Lors de la formation, vous devez surveiller attentivement la taille maximale des d√©fauts superpos√©s, car avec de tr√®s gros d√©fauts que le r√©seau n'a jamais vus dans le processus d'apprentissage, il fantasmera √©norm√©ment et donnera un r√©sultat absolument inapplicable.  Donc, si vous devez peindre de gros d√©fauts, appliquez √©galement de gros d√©fauts pendant la formation. <br><br>  Voici un exemple d'algorithme: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/abd/6cb/c8c/abd6cbc8c05396042bf83c00516b630e.png"><br><br><h1>  Coloration </h1><br>  Nous avons segment√© les d√©fauts et les avons peints, la troisi√®me √©tape est la reconstruction de la couleur.  Permettez-moi de vous rappeler que parmi les photographies de l '"Immortal Regiment" il y a beaucoup de portraits simples ou de groupe.  Et nous voulions que notre r√©seau fonctionne bien avec eux.  Nous avons d√©cid√© de faire notre propre colorisation, car aucun des services que nous connaissons ne peint les portraits rapidement et bien. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/015/bce/bf1/015bcebf15ef1ee069fdf08f16e00542.png"><br><br>  GitHub a un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">r√©f√©rentiel</a> populaire pour colorier des photos.  En moyenne, il fait bien ce travail, mais il a plusieurs probl√®mes.  Par exemple, il aime peindre des v√™tements en bleu.  Par cons√©quent, nous l'avons √©galement rejet√©. <br><br>  Nous avons donc d√©cid√© de cr√©er un r√©seau neuronal pour la colorisation.  L'id√©e la plus √©vidente: prendre une image en noir et blanc et pr√©voir trois canaux, rouge, vert et bleu.  Mais, d'une mani√®re g√©n√©rale, nous pouvons simplifier notre travail.  Nous pouvons travailler non pas avec la repr√©sentation RVB de la couleur, mais avec la repr√©sentation YCbCr.  Le composant Y est la luminosit√© (luma).  L'image en noir et blanc t√©l√©charg√©e est la cha√Æne Y, nous la r√©utiliserons.  Il restait √† pr√©dire Cb et Cr: Cb est la diff√©rence de couleur bleue et de luminosit√©, et Cr est la diff√©rence de couleur rouge et de luminosit√©. <br><br><img src="https://habrastorage.org/webt/k8/ke/l_/k8kel_xrjco6euolh8ypkchjm8g.jpeg"><br><br>  Pourquoi avons-nous choisi la vue YCbCr?  L'≈ìil humain est plus sensible aux changements de luminosit√© qu'aux changements de couleur.  Par cons√©quent, nous r√©utilisons la composante Y (luminosit√©), √† laquelle l'≈ìil est initialement bien sensible, et pr√©disons le Cb et le Cr, dans lesquels nous pouvons faire un peu plus d'erreurs, car les gens remarquent moins de ¬´fausses¬ª couleurs.  Cette fonctionnalit√© a commenc√© √† √™tre activement utilis√©e √† l'aube de la t√©l√©vision couleur, lorsque la bande passante du canal n'√©tait pas suffisante pour transmettre toutes les couleurs en totalit√©.  L'image a √©t√© transf√©r√©e sur YCbCr, transf√©r√©e sur le composant Y inchang√©e, et Cb et Cr ont √©t√© compress√©s deux fois. <br><br><h1>  Comment assembler la ligne de base </h1><br>  Vous pouvez √† nouveau prendre Unet avec un encodeur pr√©-form√© et minimiser la perte L1 entre le CbCr r√©el et le pr√©dictif.  Nous voulons colorer des portraits, donc en plus des photos d'OpenImages, nous devons ajouter des photos sp√©cifiques √† notre t√¢che. <br><br>  O√π puis-je obtenir des photographies en couleur de personnes en uniforme militaire?  Il y a des gens sur Internet qui peignent de vieilles photographies comme passe-temps ou pour commander.  Ils le font tr√®s soigneusement, essayant de se conformer pleinement √† toutes les nuances.  Colorant l'uniforme, les √©paulettes, les m√©dailles, ils se tournent vers des documents d'archives, de sorte que le r√©sultat de leur travail peut √™tre fait confiance.  Au total, nous avons utilis√© 200 photographies peintes √† la main.  La deuxi√®me source de donn√©es utiles est le site de l' <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Arm√©e rouge ouvri√®re et paysanne</a> .  L'un de ses cr√©ateurs a √©t√© photographi√© dans presque toutes les variantes possibles d'uniforme militaire pendant la Grande Guerre patriotique. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/f72/999/7d9/f729997d9fd02755fd95967ff09d27ca.png"><br><br>  Dans certaines photographies, il a r√©p√©t√© les poses de personnes √† partir de photographies d'archives c√©l√®bres.  C‚Äôest particuli√®rement bien qu‚Äôil ait tir√© sur un fond blanc, cela nous a permis d‚Äôaugmenter tr√®s bien les donn√©es, en ajoutant divers objets naturels √† l‚Äôarri√®re-plan.  Nous avons √©galement utilis√© des portraits modernes ordinaires de personnes, en les compl√©tant d'insignes et d'autres attributs des v√™tements de guerre. <br><br>  Nous avons form√© AlbuNet-50 - c'est Unet, dans lequel AlbuNet-50 est utilis√© comme encodeur.  Le r√©seau a commenc√© √† donner des r√©sultats ad√©quats: la peau est rose, les yeux sont gris-bleu, les bretelles sont jaun√¢tres.  Mais le probl√®me est qu'elle a peint les tableaux avec des taches.  Cela est d√ª au fait que du point de vue de l'erreur L1, il est parfois plus rentable de ne rien faire que d'essayer de pr√©dire une certaine couleur. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/435/4a9/63c/4354a963c4cd2789c434002e44fdda26.png"><br>  <i>Nous comparons notre r√©sultat avec une photo de Ground Truth - colorisation manuelle de l'artiste sous le pseudo <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Klimbim</a></i> <br><br>  Comment r√©soudre ce probl√®me?  Nous avons besoin d'un discriminateur: un r√©seau de neurones, auquel nous fournirons des images √† l'entr√©e, et il dira √† quel point cette image est r√©aliste.  Ci-dessous, une photographie est peinte √† la main, et la seconde par un r√©seau de neurones.  Lequel pensez-vous? <br><br><img src="https://habrastorage.org/getpro/habr/post_images/253/86a/abd/25386aabd9080c14daf71b60d9968453.png"><br><br><div class="spoiler">  <b class="spoiler_title">La r√©ponse</b> <div class="spoiler_text">  La photo de gauche est peinte manuellement. <br></div></div><br>  En tant que discriminateur, nous utilisons le discriminateur de l'article <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Self-Attention GAN</a> .  Il s'agit d'un petit r√©seau convolutionnel, dans les derni√®res couches dont la soi-disant auto-attention est int√©gr√©e.  Il vous permet de "faire plus attention" aux d√©tails de l'image.  Nous utilisons √©galement la normalisation spectrale.  L'explication et la motivation exactes se trouvent dans l'article.  Nous avons form√© un r√©seau avec une combinaison de perte L1 et de l'erreur renvoy√©e par le discriminateur.  Maintenant, le r√©seau peint mieux les d√©tails de l'image et l'arri√®re-plan est plus coh√©rent.  Un autre exemple: √† gauche est le r√©sultat du r√©seau form√© uniquement avec une perte L1, √† droite - avec une perte L1 et une erreur de discrimination. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/aa4/724/ada/aa4724ada4e0bbdc52dbcaadd5bb3fdc.png"><br><br>  Sur quatre Geforce 1080Ti, la formation a dur√© deux jours.  Le r√©seau a fonctionn√© en 30 ms dans l'image 512 x 512. Le MSE de validation √©tait de 34,4.  Comme dans le cas du probl√®me de peinture, les mesures ne peuvent pas √™tre enti√®rement approuv√©es.  Par cons√©quent, nous avons s√©lectionn√© 6 mod√®les qui avaient les meilleures mesures pour la validation et avons vot√© aveugl√©ment pour le meilleur mod√®le. <br><br>  Apr√®s avoir d√©ploy√© le mod√®le en production, nous avons poursuivi les exp√©riences et sommes arriv√©s √† la conclusion qu'il √©tait pr√©f√©rable de minimiser non pas la perte L1 par pixel, mais la perte perceptuelle.  Pour le calculer, vous devez ex√©cuter la pr√©diction du r√©seau et la photo source via le r√©seau VGG-16, prendre les cartes d'attributs sur les couches inf√©rieures et les comparer selon MSE.  Cette approche peint plus de zones et aide √† obtenir une image plus color√©e. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/db9/303/509/db93035094c4906cf82c246151432cbc.jpg"><br><br><h1>  Conclusions et conclusion </h1><br>  Unet est un mod√®le sympa.  Dans le premier probl√®me de segmentation, nous avons rencontr√© un probl√®me de formation et de travail avec des images haute r√©solution, nous utilisons donc In-Place BatchNorm.  Dans la deuxi√®me t√¢che (Inpainting), au lieu de la convolution habituelle, nous avons utilis√© la convolution partielle, cela a aid√© √† obtenir de meilleurs r√©sultats.  Dans le probl√®me de colorisation pour Unet, nous avons ajout√© un petit r√©seau de discriminateur qui a inflig√© une amende au g√©n√©rateur pour une image d'apparence irr√©aliste et utilis√© une perte de perception. <br><br>  La deuxi√®me conclusion est que les accesseurs sont importants.  Et pas seulement au stade du marquage des photos avant l'entra√Ænement, mais aussi pour valider le r√©sultat final, car en cas de probl√®mes de d√©fauts de peinture ou de colorisation, il faut quand m√™me valider le r√©sultat avec l'aide d'une personne.  Nous donnons √† l'utilisateur trois photos: l'original avec les d√©fauts supprim√©s, coloris√© avec les d√©fauts supprim√©s, et juste la photo coloris√©e au cas o√π l'algorithme de recherche et de peinture des d√©fauts serait erron√©. <br><br>  Nous avons pris quelques photos du projet <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Album militaire</a> et les avons trait√©es avec nos r√©seaux de neurones.  Voici les r√©sultats obtenus: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/a51/ade/15e/a51ade15e9cee54ec8269dc1e22df0af.jpg"><br><br>  Et <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ici,</a> vous pouvez les voir dans la r√©solution d'origine et √† chaque √©tape du traitement. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr453872/">https://habr.com/ru/post/fr453872/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr453862/index.html">Pourquoi vous devriez utiliser pathlib</a></li>
<li><a href="../fr453864/index.html">Utiliser une souris et un clavier sur des consoles, c'est tricher?</a></li>
<li><a href="../fr453866/index.html">Demande d'API avec React Hooks, HOC ou Render Prop</a></li>
<li><a href="../fr453868/index.html">Mini interrupteur tactile avec panneau en verre sur nRF52832</a></li>
<li><a href="../fr453870/index.html">Nous √©crivons le proxy Reverse socks5 sur PowerShell. Partie 1</a></li>
<li><a href="../fr453874/index.html">De la roulette russe au LOTO s√©curis√©: comment prot√©ger le personnel du centre de donn√©es</a></li>
<li><a href="../fr453876/index.html">Comme dans Yandex.Practicum, le front desync a gagn√©: un num√©ro acrobatique avec Redux-Saga, postMessage et Jupyter</a></li>
<li><a href="../fr453882/index.html">Un excellent guide sur le m√©tier d'architecte de solutions (+ liste de liens utiles)</a></li>
<li><a href="../fr453884/index.html">Remplacement de la cam√©ra HYIP ou du reflex num√©rique?</a></li>
<li><a href="../fr453886/index.html">Le programme fonctionne</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>