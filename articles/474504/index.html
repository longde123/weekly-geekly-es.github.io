<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üöπ ü•õ üòá Backend ortodoxo üç¶ üëâüèª üì¨</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="El backend moderno es diverso, pero sigue obedeciendo algunas reglas t√°citas. Muchos de nosotros que desarrollamos aplicaciones de servidor nos enfren...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Backend ortodoxo</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/474504/"><img src="https://habrastorage.org/webt/dj/q5/y-/djq5y-xjov_bqvrrnb08bfyqn4i.jpeg"><br><br>  El backend moderno es diverso, pero sigue obedeciendo algunas reglas t√°citas.  Muchos de nosotros que desarrollamos aplicaciones de servidor nos enfrentamos a enfoques generalmente aceptados, como Clean Architecture, SOLID, Persistence Ignorance, Dependency Injection y otros.  Muchos de los atributos del desarrollo del servidor est√°n tan tristes que no plantean ninguna pregunta y se usan sin pensar.  Hablan mucho sobre algunos, pero nunca lo usan.  El significado del resto se interpreta incorrectamente o se distorsiona.  El art√≠culo habla sobre c√≥mo construir una arquitectura de back-end simple, completamente t√≠pica, que no solo pueda seguir los preceptos de los famosos te√≥ricos de la programaci√≥n sin ning√∫n da√±o, sino que tambi√©n pueda mejorarlos en cierta medida. <br><a name="habracut"></a><br>  <i>Dedicado a todos aquellos que no piensan programar sin belleza y no aceptan la belleza en medio de lo absurdo.</i> <br><br><h2>  Modelo de dominio </h2><br>  El modelado es donde debe comenzar el desarrollo de software en un mundo ideal.  Pero no todos somos perfectos, hablamos mucho al respecto, pero hacemos todo como de costumbre.  A menudo, la raz√≥n es la imperfecci√≥n de las herramientas existentes.  Y para ser sincero, nuestra pereza y miedo a asumir la responsabilidad de alejarnos de las "mejores pr√°cticas".  En un mundo imperfecto, el desarrollo de software comienza, en el mejor de los casos, con andamios, y en el peor, con la optimizaci√≥n del rendimiento, nada.  Sin embargo, me gustar√≠a descartar los ejemplos duros de arquitectos "sobresalientes" y especular sobre cosas m√°s comunes. <br><br>  Entonces, tenemos una tarea t√©cnica, e incluso tenemos un dise√±o de interfaz de usuario (o no, si no se proporciona la interfaz de usuario).  El siguiente paso es reflejar los requisitos en el modelo de dominio.  Para comenzar, puede dibujar un diagrama de objetos modelo para mayor claridad: <br><br><img src="https://habrastorage.org/webt/4n/hp/m5/4nhpm5kbhwvomryj9xhyww1eep0.png"><br><br>  Luego, como regla, comenzamos a proyectar el modelo en los medios de su implementaci√≥n: un lenguaje de programaci√≥n, un mapeador relacional de objetos (ORM), o en alg√∫n tipo de marco complejo como ASP.NET MVC o Ruby on Rails, en otras palabras: Comience a escribir el c√≥digo.  En este caso, seguimos el camino del marco, que creo que no es correcto en el marco del desarrollo basado en el modelo, por muy conveniente que parezca inicialmente.  Aqu√≠ hace una suposici√≥n enorme, que posteriormente niega los beneficios del desarrollo basado en el dominio.  Como una opci√≥n m√°s libre, no limitada por el alcance de ninguna herramienta, sugerir√≠a detenerse en el uso de solo herramientas sint√°cticas de un lenguaje de programaci√≥n para construir un modelo de objeto de un dominio.  En mi trabajo utilizo varios lenguajes de programaci√≥n: C #, JavaScript, Ruby.  Fate ha decretado que los ecosistemas Java y C # son mi inspiraci√≥n, JS es mi principal ingreso y Ruby es el lenguaje que me gusta.  Por lo tanto, continuar√© mostrando ejemplos simples en Ruby: estoy convencido de que esto no causar√° problemas para que los desarrolladores en otros idiomas lo entiendan.  Por lo tanto, transfiera el modelo a la clase Factura en Ruby: <br><br><pre><code class="ruby hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Invoice</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">attr_reader</span></span></span><span class="hljs-class"> :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">amount</span></span></span><span class="hljs-class">, :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">date</span></span></span><span class="hljs-class">, :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">created_at</span></span></span><span class="hljs-class">, :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">paid_at</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">def</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">initialize</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">attrs</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">payment_service</span></span></span><span class="hljs-class">) @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">created_at</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">DateTime</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">now</span></span></span><span class="hljs-class"> @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">paid_at</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">nil</span></span></span><span class="hljs-class"> @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">amount</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">attrs</span></span></span><span class="hljs-class">[:</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">amount</span></span></span><span class="hljs-class">] @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">date</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">attrs</span></span></span><span class="hljs-class">[:</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">date</span></span></span><span class="hljs-class">] @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">subscription</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">attrs</span></span></span><span class="hljs-class">[:</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">subscription</span></span></span><span class="hljs-class">] @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">payment_service</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">payment_service</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">def</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">pay</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">credit_card</span></span></span><span class="hljs-class"> = @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">subscription</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">customer</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">credit_card</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">amount</span></span></span><span class="hljs-class"> = @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">subscription</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">plan</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">price</span></span></span><span class="hljs-class"> @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">payment_service</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">charge</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">credit_card</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">amount</span></span></span><span class="hljs-class">) @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">paid_at</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">DateTime</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">now</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span></span></code> </pre> <br>  Es decir  tenemos una clase cuyo constructor acepta un hash de atributos, dependencias de objetos e inicializa sus campos, y un m√©todo de pago que puede cambiar el estado del objeto.  Todo es muy sencillo.  Ahora no pensamos en c√≥mo y d√≥nde mostraremos y almacenaremos este objeto.  Simplemente existe, podemos crearlo, cambiar su estado, interactuar con otros objetos.  Tenga en cuenta que el c√≥digo no contiene artefactos extra√±os como BaseEntity y otros elementos no relacionados con el modelo.  Esto es muy importante  Por cierto, en esta etapa ya podemos comenzar el desarrollo a trav√©s de pruebas (TDD), utilizando objetos de c√≥digo auxiliar en lugar de dependencias como payment_service: <br><br><pre> <code class="ruby hljs">RSpec.describe Invoice <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> before <span class="hljs-symbol"><span class="hljs-symbol">:each</span></span> <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> @payment_service = double(<span class="hljs-symbol"><span class="hljs-symbol">:payment_service</span></span>) allow(@payment_service).to receive(<span class="hljs-symbol"><span class="hljs-symbol">:charge</span></span>) @amount = <span class="hljs-number"><span class="hljs-number">100</span></span> @credit_card = CreditCard.new({...}) @customer = Customer.new({<span class="hljs-symbol"><span class="hljs-symbol">credit_card:</span></span> @credit_card, ...}) @subscription = Subscription.new({<span class="hljs-symbol"><span class="hljs-symbol">customer:</span></span> customer, ...}) @invoice = Invoice.new({<span class="hljs-symbol"><span class="hljs-symbol">amount:</span></span> @amount, <span class="hljs-symbol"><span class="hljs-symbol">date:</span></span> DateTime.now, @subscription: subscription}, payment_service) <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> describe <span class="hljs-string"><span class="hljs-string">'pay'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> it <span class="hljs-string"><span class="hljs-string">"charges customer's credit card"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> expect(@payment_service).to receive(<span class="hljs-symbol"><span class="hljs-symbol">:charge</span></span>).with(@credit_card, @amount) @invoice.pay <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> it <span class="hljs-string"><span class="hljs-string">'makes the invoice paid'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> expect(@invoice.paid_at).not_to be_nil @invoice.pay <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> </pre><br>  o incluso jugar con el modelo en el int√©rprete (irb para Ruby), que bien puede ser, aunque no muy amigable, la interfaz de usuario: <br><br><pre> <code class="bash hljs">irb &gt; invoice = Invoice.new({amount: @amount, date: DateTime.now, @subscription: subscription}, payment_service) irb &gt; invoice.pay</code> </pre><br>  ¬øPor qu√© es tan importante evitar los "artefactos extra√±os" en esta etapa?  El hecho es que el modelo no debe tener idea de c√≥mo se guardar√° o si se guardar√°.  Al final, para algunos sistemas, el almacenamiento de objetos directamente en la memoria puede ser bastante adecuado.  En el momento del modelado, debemos abstraernos completamente de este detalle.  Este enfoque se llama ignorancia de persistencia.  Debe enfatizarse que no ignoramos los problemas de trabajar con el repositorio, ya sea relacional o cualquier otra base de datos, solo descuidamos los detalles de interacci√≥n con √©l en la etapa de modelado.  La ignorancia de persistencia significa la eliminaci√≥n intencional de mecanismos para trabajar con el estado del modelo, as√≠ como todo tipo de metadatos relacionados con este proceso, del modelo mismo.  Ejemplos: <br><br><pre> <code class="ruby hljs"><span class="hljs-comment"><span class="hljs-comment">#  class User &lt; Entity #     table :users #     # mapping  field :name, type: 'String' #   def save ... end end user = User.load(id) #     user.save #    </span></span></code> </pre><br><pre> <code class="ruby hljs"><span class="hljs-comment"><span class="hljs-comment">#  class User #   ,      attr_accessor :name, :lastname end user = repo.load(id) #     repo.save(user) #    </span></span></code> </pre><br>  Este enfoque tambi√©n se debe a razones fundamentales: el cumplimiento del principio de responsabilidad exclusiva (Principio de responsabilidad √∫nica, S en S√ìLIDO).  Si el modelo, adem√°s de su componente funcional, describe los par√°metros de preservaci√≥n del estado y tambi√©n se ocupa de su preservaci√≥n y carga, entonces obviamente tiene demasiadas responsabilidades.  La ventaja resultante y no la √∫ltima de la ignorancia de persistencia es la capacidad de reemplazar la herramienta de almacenamiento e incluso el tipo de almacenamiento en s√≠ durante el proceso de desarrollo. <br><br><h2>  Modelo-Vista-Controlador </h2><br>  El concepto MVC es tan popular en el entorno de desarrollo de varias aplicaciones, no solo de servidores, en diferentes idiomas y plataformas que ya no pensamos en qu√© es y por qu√© es necesario.  Tengo la mayor√≠a de las preguntas de esta abreviatura se llama "Controlador".  Desde el punto de vista de organizar la estructura del c√≥digo, es bueno agrupar acciones en el modelo.  Pero el controlador no deber√≠a ser una clase en absoluto, deber√≠a ser m√°s bien un m√≥dulo que incluye m√©todos para acceder al modelo.  No solo eso, ¬ødeber√≠a tener un lugar para estar?  Como desarrollador que sigui√≥ el camino de .NET -&gt; Ruby -&gt; Node.js, simplemente me conmovieron los controladores JS (ES5) que se implementan en el marco de express.js.  Teniendo la capacidad de resolver la tarea asignada a los controladores en un estilo m√°s funcional, los desarrolladores, como hechizados, escriben el "Controlador" m√°gico una y otra vez.  ¬øPor qu√© un controlador t√≠pico es malo? <br><br>  Un controlador t√≠pico es un conjunto de m√©todos que no est√°n estrechamente relacionados entre s√≠, unidos por uno solo: una cierta esencia del modelo;  y a veces no solo uno, peor.  Cada m√©todo individual puede requerir diferentes dependencias.  Mirando hacia el futuro un poco, noto que soy partidario de la pr√°ctica de la inversi√≥n de dependencia (Inversi√≥n de dependencia, D en S√ìLIDO).  Por lo tanto, necesito inicializar estas dependencias en alg√∫n lugar externo y pasarlas al constructor del controlador.  Por ejemplo, al crear una nueva cuenta, tengo que enviar notificaciones al contador, para lo cual necesito un servicio de notificaci√≥n, y en otros m√©todos no lo necesito: <br><br><pre> <code class="ruby hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">InvoiceController</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">def</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">initialize</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">invoice_repository</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">notification_service</span></span></span><span class="hljs-class">) @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">repository</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">invoice_repository</span></span></span><span class="hljs-class"> @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">notification_service</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">notification_service</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">def</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">index</span></span></span><span class="hljs-class"> @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">repository</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">get_all</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">def</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">show</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">id</span></span></span><span class="hljs-class">) @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">repository</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">get_by_id</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">id</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">def</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">create</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">data</span></span></span><span class="hljs-class">) @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">repository</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">create</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">data</span></span></span><span class="hljs-class">) @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">notification_service</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">notify_accountant</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span></span></code> </pre><br>  Aqu√≠ la idea pide ser dividida en m√©todos para trabajar con el modelo en clases separadas, y ¬øpor qu√© no? <br><br><pre> <code class="ruby hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ListInvoices</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">def</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">initialize</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">invoice_repository</span></span></span><span class="hljs-class">) @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">repository</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">invoice_repository</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">def</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">call</span></span></span><span class="hljs-class"> @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">repository</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">get_all</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CreateInvoice</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">def</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">initialize</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">invoice_repository</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">notification_service</span></span></span><span class="hljs-class">) @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">repository</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">invoice_repository</span></span></span><span class="hljs-class"> @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">notification_service</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">notification_service</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">def</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">call</span></span></span><span class="hljs-class"> @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">repository</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">create</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">data</span></span></span><span class="hljs-class">) @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">notification_service</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">notify_accountant</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span></span></code> </pre><br>  Bueno, en lugar del controlador, ahora hay un conjunto de "funciones" para acceder al modelo, que, por cierto, tambi√©n se puede estructurar utilizando directorios del sistema de archivos, por ejemplo.  Ahora necesita "abrir" estos m√©todos al exterior, es decir  organizar algo como un enrutador.  Como persona tentada con todo tipo de DSL (lenguaje espec√≠fico de dominio), preferir√≠a tener una descripci√≥n m√°s visual de las instrucciones para una aplicaci√≥n web que trucos en Ruby u otro lenguaje de prop√≥sito general para especificar rutas: <br><br><pre> <code class="plaintext hljs">`HTTP GET /invoices -&gt; return all invoices` `HTTP POST /invoices -&gt; create new invoice`</code> </pre><br>  o al menos <br><br><pre> <code class="plaintext hljs">`HTTP GET /invoices -&gt; ./invoices/list_invoices` `HTTP POST /invoices -&gt; ./invoices/create`</code> </pre><br>  Esto es muy similar a un enrutador t√≠pico, con la √∫nica diferencia de que no interact√∫a con los controladores, sino directamente con las acciones en el modelo.  Est√° claro que si queremos enviar y recibir JSON, debemos ocuparnos de la serializaci√≥n y deserializaci√≥n de objetos y mucho m√°s.  De una forma u otra, podemos deshacernos de los controladores, transferir parte de su responsabilidad a la estructura del directorio y al enrutador m√°s avanzado. <br><br><h2>  Inyecci√≥n de dependencia </h2><br>  Deliberadamente escrib√≠ un "enrutador m√°s avanzado".  Para que el enrutador realmente pueda permitir el flujo de acciones en el modelo utilizando el mecanismo de inyecci√≥n de dependencia a nivel declarativo, probablemente deber√≠a ser bastante complejo por dentro.  El esquema general de su trabajo deber√≠a verse m√°s o menos as√≠: <br><br><img src="https://habrastorage.org/webt/62/v1/ts/62v1tsjynvq067lnqxmpqefw0lg.png"><br><br>  Como puede ver, todo mi enrutador est√° plagado de inyecci√≥n de dependencia utilizando un contenedor IoC.  ¬øPor qu√© es esto necesario?  El concepto de "inyecci√≥n de dependencia" se remonta a la t√©cnica de Inversi√≥n de dependencia, que est√° dise√±ada para reducir la conectividad de los objetos al mover la inicializaci√≥n de dependencia fuera del alcance de su uso.  Un ejemplo: <br><br><pre> <code class="ruby hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Repository</span></span></span><span class="hljs-class">;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-comment"><span class="hljs-comment">#  (   ) class A def initialize </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@repo</span></span></span><span class="hljs-comment"> = Repository.new end end #  (   ) class A def initialize(repo) </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@repo</span></span></span><span class="hljs-comment"> = repo end end</span></span></code> </pre><br>  Este enfoque es de gran ayuda para quienes usan Test-Driven Development.  En el ejemplo anterior, podemos poner f√°cilmente un trozo en el constructor en lugar del objeto de repositorio real correspondiente a su interfaz, sin "piratear" el modelo de objetos.  Este no es el √∫nico bono DI: cuando se aplica correctamente, este enfoque traer√° mucha magia agradable a su aplicaci√≥n, pero lo primero es lo primero.  La inyecci√≥n de dependencia es un enfoque que le permite integrar la t√©cnica de inversi√≥n de dependencia en una soluci√≥n arquitect√≥nica completa.  La herramienta de implementaci√≥n suele ser un contenedor IoC- (Inversi√≥n de control).  Hay toneladas de contenedores IoC realmente geniales en el mundo de Java y .NET, hay docenas de ellos.  En JS y Ruby, desafortunadamente, no hay opciones adecuadas para m√≠.  En particular, mir√© el contenedor <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="nofollow">seco</a> (contenedor <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="nofollow">seco</a> ).  As√≠ ser√≠a mi clase al usarlo: <br><br><pre> <code class="ruby hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Invoice</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">include</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Import</span></span></span><span class="hljs-class">['</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">payment_service</span></span></span><span class="hljs-class">'] </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">def</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">pay</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">credit_card</span></span></span><span class="hljs-class"> = @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">subscription</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">customer</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">credit_card</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">amount</span></span></span><span class="hljs-class"> = @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">subscription</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">plan</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">price</span></span></span><span class="hljs-class"> @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">payment_service</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">charge</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">credit_card</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">amount</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span></span></code> </pre><br>  En lugar del uso delgado del constructor, cargamos a la clase introduciendo nuestras propias dependencias, lo que en la etapa inicial nos aleja de un modelo limpio e independiente.  Bueno, algo, ¬°y el modelo no deber√≠a saber nada sobre IoC!  Esto es cierto para acciones como CreateInvoice.  Para el caso dado, en mis pruebas ya estoy obligado a usar IoC como algo inalienable.  Esto est√° totalmente mal.  Los objetos de aplicaci√≥n en su mayor parte no deber√≠an saber sobre la existencia de IoC.  Despu√©s de buscar y pensar mucho, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="nofollow">dibuj√© mi IoC</a> , lo que no ser√≠a tan intrusivo. <br><br><h2>  Guardar y cargar un modelo </h2><br>  La ignorancia de persistencia requiere un transformador de objetos discreto.  En este art√≠culo, me referir√© a trabajar con una base de datos relacional, los puntos principales ser√°n ciertos para otros tipos de almacenamientos.  Un convertidor relacional de objetos - ORM (Object Relational Mapper) se utiliza como un convertidor similar para bases de datos relacionales.  En el mundo de .NET y Java, hay una gran cantidad de herramientas ORM verdaderamente poderosas.  Todos ellos tienen algunos u otros defectos menores a los que puedes cerrar los ojos.  No hay buenas soluciones en JS y Ruby.  Todos ellos, de una forma u otra, vinculan r√≠gidamente el modelo al marco y fuerzan la declaraci√≥n de elementos extra√±os, sin mencionar la inaplicabilidad de la ignorancia de persistencia.  Como en el caso de IoC, pens√© en implementar ORM por mi cuenta, esta es la situaci√≥n en Ruby.  No hice todo desde cero, pero tom√© como base una simple Secuela de ORM, que proporciona herramientas discretas para trabajar con diferentes DBMS relacionales.  En primer lugar, estaba interesado en la capacidad de ejecutar consultas en forma de SQL normal, recibiendo una serie de cadenas (objetos hash) en la salida.  Solo quedaba implementar su Mapper y proporcionar la ignorancia de persistencia.  Como ya mencion√©, no me gustar√≠a mezclar campos de mapeo en el modelo de dominio, por lo que implemento Mapper para que use un archivo de configuraci√≥n separado en el formato de tipo: <br><br><pre> <code class="ruby hljs">entity Invoice <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> field <span class="hljs-symbol"><span class="hljs-symbol">:amount</span></span> field <span class="hljs-symbol"><span class="hljs-symbol">:date</span></span> field <span class="hljs-symbol"><span class="hljs-symbol">:start_date</span></span> field <span class="hljs-symbol"><span class="hljs-symbol">:end_date</span></span> field <span class="hljs-symbol"><span class="hljs-symbol">:created_at</span></span> field <span class="hljs-symbol"><span class="hljs-symbol">:updated_at</span></span> reference <span class="hljs-symbol"><span class="hljs-symbol">:user</span></span>, <span class="hljs-symbol"><span class="hljs-symbol">type:</span></span> User reference <span class="hljs-symbol"><span class="hljs-symbol">:subscription</span></span>, <span class="hljs-symbol"><span class="hljs-symbol">type:</span></span> Subscription <span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> </pre><br>  La ignorancia de persistencia es bastante simple de implementar usando un objeto externo del tipo Repositorio: <br><br><pre> <code class="ruby hljs">repository.save(user)</code> </pre> <br>  Pero iremos m√°s all√° e implementaremos el patr√≥n de la Unidad de Trabajo.  Para hacer esto, debe resaltar el concepto de sesi√≥n.  Una sesi√≥n es un objeto que existe con el tiempo, durante el cual se realiza un conjunto de acciones en el modelo, que son una sola operaci√≥n l√≥gica.  En el transcurso de una sesi√≥n, se pueden cargar y cambiar objetos del modelo.  Al final de la sesi√≥n, se guarda el estado transaccional del modelo. <br>  Ejemplo de unidad de trabajo: <br><br><pre> <code class="ruby hljs">user = session.load(User, <span class="hljs-symbol"><span class="hljs-symbol">id:</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>) plan = session.load(Plan, <span class="hljs-symbol"><span class="hljs-symbol">id:</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>) subscription = Subscription.new(user, plan) session.attach(subscription) invoice = Invoice.new(subscription) session.attach(invoice) <span class="hljs-comment"><span class="hljs-comment"># ... # -       if Date.today.yday == 1 subscription.comment = 'New year offer' invoice.amount /= 2 end session.flush</span></span></code> </pre><br>  Como resultado, se ejecutar√°n 2 instrucciones en la base de datos en lugar de 4, y ambas se ejecutar√°n dentro de la misma transacci√≥n. <br><br>  ¬°Y de repente recuerda los repositorios!  Aqu√≠ hay una sensaci√≥n de deja vu, como con los controladores: ¬øno es el repositorio la misma entidad rudimentaria?  Mirando hacia el futuro, responder√©, s√≠, lo es.  El objetivo principal del repositorio es evitar que la capa de l√≥gica empresarial interact√∫e con el almacenamiento real.  Por ejemplo, en el contexto de bases de datos relacionales, significa escribir consultas SQL directamente en el c√≥digo de l√≥gica de negocios.  Sin lugar a dudas, esta es una decisi√≥n muy razonable.  Pero volviendo al momento en que nos deshicimos del controlador.  Desde el punto de vista de OOP, el repositorio es esencialmente el mismo controlador: el mismo conjunto de m√©todos, no solo para procesar solicitudes, sino tambi√©n para trabajar con el repositorio.  El repositorio tambi√©n se puede dividir en acciones.  Seg√∫n todas las indicaciones, estas acciones no diferir√°n de ninguna manera de lo que propusimos en lugar del controlador.  Es decir, podemos rechazar el Repositorio y el Controlador a favor de una √∫nica Acci√≥n unificada. <br><br><pre> <code class="ruby hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">LoadPlan</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">def</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">initialize</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">session</span></span></span><span class="hljs-class">) @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">session</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">session</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">def</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">call</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">sql</span></span></span><span class="hljs-class"> = &lt;&lt;~</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SQL</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SELECT</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">p</span></span></span><span class="hljs-class">.* </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AS</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ENTITY</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">plan</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">FROM</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">plans</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">p</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WHERE</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">p</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">id</span></span></span><span class="hljs-class"> = 1 </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SQL</span></span></span><span class="hljs-class"> @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">session</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">fetch</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Plan</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">sql</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span></span></code> </pre><br>  Probablemente not√≥ que uso SQL en lugar de alg√∫n tipo de sintaxis de objeto.  Esto es cuesti√≥n de gustos.  Prefiero SQL porque es un lenguaje de consulta, un tipo de DSL para trabajar con datos.  Est√° claro que siempre es m√°s f√°cil escribir Plan.load (id) que el SQL correspondiente, pero esto es para casos triviales.  Cuando se trata de cosas un poco m√°s complejas, SQL se convierte en una herramienta muy bienvenida.  A veces maldeces a otro ORM al intentar que funcione como SQL puro, que "escribir√≠a en un par de minutos".  Para aquellos que tengan dudas, les sugiero que busquen en la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="nofollow">documentaci√≥n de MongoDB</a> , donde las explicaciones se dan en forma de SQL, ¬°lo cual se ve muy divertido!  Por lo tanto, la interfaz para consultas en <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="nofollow">ORM JetSet</a> , que escrib√≠ para mis prop√≥sitos, es SQL con impregnaciones m√≠nimas como "ENTIDAD".  Por cierto, en la mayor√≠a de los casos no utilizo objetos modelo, varios DTO, etc. para mostrar datos tabulares: solo escribo una consulta SQL, obtengo una matriz de objetos hash y los visualizo a la vista.  De una forma u otra, pocas personas logran "desplazar" grandes datos proyectando tablas relacionadas en un modelo.  En la pr√°ctica, es m√°s probable que se use la proyecci√≥n plana (vista), y los productos muy maduros llegan a la etapa de optimizaci√≥n cuando comienzan a usarse soluciones m√°s complejas como CQRS (segregaci√≥n de responsabilidad de comandos y consultas). <br><br><h2>  Poniendo todo junto </h2><br>  Entonces lo que tenemos: <br><br><ul><li>  descubrimos c√≥mo cargar y guardar el modelo, tambi√©n dise√±amos una arquitectura aproximada de la herramienta de entrega web del modelo, un cierto enrutador; </li><li>  llegamos a la conclusi√≥n de que toda la l√≥gica que no es parte del √°rea tem√°tica puede llevarse a cabo en Acciones (Acciones) en lugar de controladores y repositorios; </li><li>  Las acciones deben admitir la inyecci√≥n de dependencia </li><li>  herramienta decente Inyecci√≥n de dependencia implementada; </li><li>  Se implementa el ORM necesario. </li></ul><br>  Lo √∫nico que queda es implementar el mismo "enrutador".  Como nos hemos deshecho de los repositorios y controladores a favor de las acciones, es obvio que para una solicitud tendremos que realizar varias acciones.  Las acciones son aut√≥nomas y no podemos invertir el uno en el otro.  Por lo tanto, como parte del <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="nofollow">marco Dandy,</a> implement√© un enrutador que le permite crear cadenas de acciones.  Ejemplo de configuraci√≥n (preste atenci√≥n a / planes): <br><br><pre> <code class="plaintext hljs">:receive .-&gt; :before -&gt; common/open_db_session GET -&gt; welcome -&gt; :respond &lt;- show_welcome /auth -&gt; :before -&gt; current_user@users/load_current_user /profile -&gt; GET -&gt; plan@plans/load_plan \ -&gt; :respond &lt;- users/show_user_profile PATCH -&gt; users/update_profile /plans -&gt; GET -&gt; current_plan@plans/load_current_plan \ -&gt; plans@plans/load_plans \ -&gt; :respond &lt;- plans/list :catch -&gt; common/handle_errors</code> </pre><br>  "GET / auth / planes" muestra todos los planes de suscripci√≥n disponibles y "resalta" el actual.  Sucede lo siguiente: <br><br><ol><li>  ": before -&gt; common / open_db_session" - abriendo una sesi√≥n JetSet </li><li>  / auth ": before -&gt; current_user @ users / load_current_user" - carga el usuario actual (por tokens).  El resultado se registra en el contenedor de IoC como current_user (current_user @ instrucci√≥n). </li><li>  / auth / planes "current_plan @ planes / load_current_plan": carga el plan actual.  Para esto, el valor @current_user se toma del contenedor.  El resultado se registra en el contenedor de IoC como current_plan (current_plan @ instrucci√≥n): <br><br><pre> <code class="ruby hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">LoadCurrentPlan</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">def</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">initialize</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">current_user</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">session</span></span></span><span class="hljs-class">) @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">current_user</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">current_user</span></span></span><span class="hljs-class"> @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">session</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">session</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">def</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">call</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">sql</span></span></span><span class="hljs-class"> = &lt;&lt;~</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SQL</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SELECT</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">p</span></span></span><span class="hljs-class">.* </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AS</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ENTITY</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">plan</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">FROM</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">plans</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">p</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">INNER</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">JOIN</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">subscriptions</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">s</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ON</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">s</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">user_id</span></span></span><span class="hljs-class"> = :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">user_id</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AND</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">s</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">current</span></span></span><span class="hljs-class"> = '</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">t</span></span></span><span class="hljs-class">' </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WHERE</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">p</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">id</span></span></span><span class="hljs-class"> = :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">user_id</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">LIMIT</span></span></span><span class="hljs-class"> 1 </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SQL</span></span></span><span class="hljs-class"> @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">session</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">execute</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">sql</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">user_id</span></span></span><span class="hljs-class">: @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">current_user</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">id</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">do</span></span></span><span class="hljs-class"> |</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">row</span></span></span><span class="hljs-class">| </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">map</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Plan</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">row</span></span></span><span class="hljs-class">, '</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">plan</span></span></span><span class="hljs-class">') </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span></span></code> </pre><br></li><li>  "Plans @ planes / load_plans": carga una lista de todos los planes disponibles.  El resultado se registra en el contenedor de IoC como planes (los planes @ instrucci√≥n). </li><li>  ": responder &lt;- planes / lista" - ViewBuilder registrado, por ejemplo JBuilder, dibuja Ver 'planes / lista' de tipo: <br><br><pre> <code class="ruby hljs">json.plans @plans <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-params"><span class="hljs-params">|plan|</span></span> json.id plan.id json.name plan.name json.price plan.price json.active plan.id == @current_plan.id <span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> </pre><br></li></ol><br>  Como @plans y @current_plan, los valores registrados en los pasos anteriores se recuperan del contenedor.  En el constructor de acciones, en general, puede "ordenar" todo lo que necesita, o m√°s bien, todo lo que est√° registrado en el contenedor.  Un lector atento probablemente tendr√° una pregunta, pero ¬øhay aislamiento de tales variables en el modo "multiusuario"?  Si lo hace  El hecho es que el contenedor Hypo IoC tiene la capacidad de establecer la vida √∫til de los objetos y, adem√°s, vincularlo a la vida √∫til de otros objetos.  Dentro de Dandy, variables como @plans, @current_plan, @current_user est√°n vinculadas al objeto de solicitud y se destruir√°n en el momento en que se complete la solicitud.  Por cierto, la sesi√≥n de JetSet tambi√©n est√° vinculada a la solicitud: tambi√©n se realizar√° un restablecimiento de su estado cuando se complete la solicitud de Dandy.  Es decir  Cada solicitud tiene su propio contexto aislado.  Hypo rige todo el ciclo de vida de Dandy, no importa cu√°n divertido sea este juego de palabras en la traducci√≥n literal de los nombres. <br><br><h2>  Conclusiones </h2><br>  Dentro del marco de la arquitectura dada, uso el modelo de objetos para describir el √°rea tem√°tica;  Utilizo pr√°cticas apropiadas como la inyecci√≥n de dependencia;  Incluso puedo usar la herencia.  Pero, al mismo tiempo, todas estas acciones son funciones esencialmente ordinarias que se pueden encadenar en un nivel declarativo.  Obtuvimos el backend deseado en un estilo funcional, pero con todas las ventajas del enfoque de objetos, cuando no experimenta problemas con abstracciones y prueba de su c√≥digo.  Usando el enrutador DSL Dandy como ejemplo, somos libres de crear los idiomas necesarios para describir rutas y m√°s. <br><br><h2>  Conclusi√≥n </h2><br>  Como parte de este art√≠culo, realic√© una especie de excursi√≥n sobre los aspectos fundamentales de la creaci√≥n de un backend tal como lo veo.  Repito, el art√≠culo es superficial, no toc√≥ muchos temas importantes, como, por ejemplo, la optimizaci√≥n del rendimiento.  Trat√© de concentrarme solo en aquellas cosas que realmente pueden ser √∫tiles para la comunidad como alimento para el pensamiento, y no volver a verter de vac√≠o en vac√≠o, qu√© es SOLID, TDD, c√≥mo se ve el esquema MVC, etc.  Las definiciones estrictas de estos y otros t√©rminos utilizados por un lector curioso se pueden encontrar f√°cilmente en la vasta red, sin mencionar a los colegas en la tienda, para quienes estas abreviaturas son parte del discurso cotidiano.  Y finalmente, enfatizo, trate de no concentrarse en las herramientas que necesitaba implementar para resolver los problemas planteados.<font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Esto es solo una demostraci√≥n de la validez de los pensamientos, no su esencia. </font><font style="vertical-align: inherit;">Si este art√≠culo es de alg√∫n inter√©s, escribir√© un material separado sobre estas bibliotecas.</font></font></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/474504/">https://habr.com/ru/post/474504/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../474494/index.html">¬øC√≥mo fue la Cumbre Zabbix 2019?</a></li>
<li><a href="../474496/index.html">Bases de datos en HighLoad ++ 2019</a></li>
<li><a href="../474498/index.html">Tutorial JavaFX: Hola Mundo</a></li>
<li><a href="../474500/index.html">Desarrollo de plugins para Grafana: la historia de los conos completos</a></li>
<li><a href="../474502/index.html">An√°lisis de Odnoklassniki en Joker 2019</a></li>
<li><a href="../474508/index.html">Logros de la bioimpresi√≥n 3D de injertos de piel</a></li>
<li><a href="../474514/index.html">¬øC√≥mo sobreviven los magnates mineros chinos de Bitcoin?</a></li>
<li><a href="../474516/index.html">Aplicaciones de voz: el mercado n√∫mero mil millones que Rusia no nota</a></li>
<li><a href="../474518/index.html">FP vs OOP</a></li>
<li><a href="../474522/index.html">Historia de Mutt</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>