<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🔺 👎🏼 🕵️ Springe in die Wolke. Erstellen einer kostengünstigen IoT-Lösung auf NodeMCU + Azure IoT Hub 📫 🤘🏿 🤞🏽</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Das beliebteste Ziel für IoT-Geräte ist die Telemetriesammlung. Bisher sind die Preise für Cloud-IoT-Dienste so stark gesunken, dass es sich selbst ei...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Springe in die Wolke. Erstellen einer kostengünstigen IoT-Lösung auf NodeMCU + Azure IoT Hub</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/microsoft/blog/421847/"><p>  Das beliebteste Ziel für IoT-Geräte ist die Telemetriesammlung.  Bisher sind die Preise für Cloud-IoT-Dienste so stark gesunken, dass es sich selbst ein gewöhnlicher Benutzer leisten kann, sie zu nutzen.  Heute werden wir darüber sprechen, wie Daten vom NodeMCU-Board in der Lua-Sprache in die Cloud gesendet werden. </p><br><p><img src="https://habrastorage.org/webt/k3/f5/nx/k3f5nxom4hfjshqqwpgl43ppjwo.jpeg"><a name="habracut"></a></p><br><p>  <em>Hinweis: Wir setzen die Reihe der Veröffentlichungen von Vollversionen von Artikeln aus dem Hacker-Magazin fort.</em>  <em>Rechtschreibung und Zeichensetzung des Autors gespeichert.</em> </p><br><p>  Ich gebe dem Autor das Wort. </p><br><p>  Da ich im Microsoft-Technologie-Stack arbeite, verwende ich Azure-Funktionen und Tabellenspeicher, um den Cloud-Teil der IoT-Lösung zu erstellen. Mein PoC für NodeMCU und Lua kann jedoch auch mit anderen Cloud-Anbietern von IoT-Lösungen verwendet werden. </p><br><h1>  INFO </h1><br><p>  Expressif NodeMCU ist eines der günstigsten Motherboards mit Wi-Fi, Micro-USB und integriertem Programmierer.  Es basiert auf dem ESP8266-Modul.  Das Board der zweiten Generation kann für etwa 6 bis 7 US-Dollar erworben werden.  Sie können mit dem Board von der Arduino IDE aus arbeiten.  Darüber hinaus unterstützt das Board eine Skriptsprache namens Lua (übersetzt aus dem Portugiesischen als „Mond“). </p><br><h2>  Schließen Sie das Gerät an und konfigurieren Sie es </h2><br><p>  Damit das Gerät unter Windows erkannt wird, müssen Sie den Treiber über den folgenden Link herunterladen: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">CP210x USB to UART Bridge VCP-Treiber</a> </p><br><p> Die Standardgeschwindigkeit der seriellen NodeMCU-Schnittstelle beträgt 115'200 bps.  Sie können eine andere Geschwindigkeit einstellen. Beim ersten Zurücksetzen des Geräts kehrt es zu 115200 zurück. <br>  Es ist wichtig, dass der Fahrer auf genau die gleiche Geschwindigkeit eingestellt ist: </p><br><p><img src="https://habrastorage.org/webt/ce/sq/y5/cesqy5kslu5pos-rrdqsxvch-vo.png"></p><br><h2>  Firmware </h2><br><p>  Höchstwahrscheinlich wird in der anfänglichen Firmware etwas übersehen, daher sollten Sie das Gerät idealerweise selbst flashen.  Es gibt verschiedene Möglichkeiten, ein Firmware-Image zu erstellen.  Verwenden eines <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Cloud-Dienstes</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">eines Docker-Images</a> oder Verwenden von <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Anweisungen für Linux</a> .  Ich habe über einen Cloud-Dienst gesammelt.  Ich rate Ihnen auch diese Option. </p><br><p>  Wenn Sie Daten an die Cloud senden müssen, sind die erforderlichen Funktionen für die Auswahl SNTP, MQTT, HTTP (WLAN, Timer, Datei, GPIO, Netz, Knoten, UART sind standardmäßig bereits ausgewählt).  Es ist auch erforderlich, die TLS / SSL-Unterstützung in den verschiedenen Optionen als erforderlich zu markieren <br>  Der Link zur bin-Datei kommt zur Mail.  Genauer gesagt, sogar 2 Links kommen sofort.  Eines mit einem Bild, das Gleitkommaoperationen unterstützt, und das zweite mit einem nicht unterstützenden Bild. </p><br><p>  Bevor Sie den ESP8266 flashen, müssen Sie ihn in den Spezialmodus versetzen.  Auf der Platine befindet sich eine separate FLASH-Taste.  Durch Drücken während des Einschaltens oder Drücken von Reset wird das Gerät in den Bootloader-Modus versetzt.  Wenn Ihre Board-Modifikation keine solche Taste hat, müssen Sie vor dem Blinken GPIO0 an GND anschließen und Reset drücken (diese Methode ist für ESP-12 geeignet). </p><br><p>  Die Firmware kann mit <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">dem</a> Dienstprogramm <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">PyFlasher geflasht werden</a> .  Py im Namen bedeutet, dass die Anwendung in Python geschrieben ist.  Es gibt auch <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Nodemcu-Flasher</a> , aber es wurde für eine lange Zeit nicht aktualisiert.  Ich habe es nicht versucht. </p><br><p>  Das PyFlasher-Fenster sieht folgendermaßen aus: </p><br><p><img src="https://habrastorage.org/webt/1a/ns/rh/1ansrh_oc-zpqvaif8eujfvetvg.png"></p><br><p>  Der Flash-Modus wird je nach Board ausgewählt.  Die meisten modernen Motherboards, die auf den ESP8266 ESP-12- und ESP32-Modulen basieren, verwenden den DIO-Modus.  ESP8266 01 bis 07 passt in den schnelleren QIO-Modus.  DOUT wird von ESP8285 verwendet. </p><br><h2>  IDE-Setup </h2><br><p>  Laden Sie die kostenlose IDE über den <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">ESPlorer-</a> Link <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">herunter</a> .  Alternativ gibt es <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">ZeroBrane Studio</a> .  ESPlorer hat mir am besten gefallen, daher werde ich ein Beispiel für die Arbeit damit geben.  ESPlorer ist in JAVA geschrieben.  Die Anwendungsschnittstelle ist </p><br><p><img src="https://habrastorage.org/webt/gi/lj/vs/giljvs_zxesytj7k52d_nlka_u8.png"></p><br><p>  Auf der linken Seite finden Sie den Code, die Einstellungen und einige andere ähnliche Funktionen.  Auf der rechten Seite befinden sich das Überwachungsfenster und die Geräteverwaltungsbefehle.  Öffnen Sie die Anwendung und wählen Sie den Port aus.  Stellen Sie die Geschwindigkeit ein, mit der der Austausch stattfinden soll (höchstwahrscheinlich 115200), und klicken Sie auf Öffnen. </p><br><p><img src="https://habrastorage.org/webt/1p/iq/xr/1piqxr933-f-nwkk6wagwtw42ea.png"></p><br><p>  Zum Aufwärmen können Sie ein einfaches Skript ausführen, das mit einer integrierten LED blinkt: </p><br><pre><code class="hljs powershell">LED = <span class="hljs-number"><span class="hljs-number">0</span></span> gpio.mode(LED, gpio.OUTPUT) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">flash_led</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">gpio</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">write</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(LED, gpio.LOW)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">tmr</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">delay</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(500000)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">gpio</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">write</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(LED, gpio.HIGH)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">end</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">tmr</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">alarm</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(1, 1000, tmr.ALARM_AUTO, flash_led)</span></span></span></span></code> </pre> <br><p>  Wenn Ihr Board keine eingebaute LED hat (oder Sie die Beispiele für blinkende LED = satt haben), können Sie versuchen, ein noch einfacheres Skript auszuführen, das die Zeile anzeigt: </p><br><pre> <code class="hljs swift"><span class="hljs-built_in"><span class="hljs-built_in">print</span></span>(<span class="hljs-string"><span class="hljs-string">"Hello from Lua!"</span></span>)</code> </pre> <br><p>  Nachdem Sie eine .lua-Datei erstellt haben (z. B. test.lua), fügen Sie den Code hinzu und speichern Sie ihn auf der Festplatte. Sie können ihn auf Ihr Gerät herunterladen.  Öffnen Sie dazu den Port, wenn er nicht geöffnet ist (Schaltfläche Öffnen), und klicken Sie auf die Schaltfläche Hochladen.  Sie finden es unter den Schaltflächen, die sich unter dem Code befinden (links). </p><br><p>  Nach dem Herunterladen der Datei können Sie sie ausführen, indem Sie den folgenden Befehl senden: </p><br><pre> <code class="hljs lisp">dofile(<span class="hljs-string"><span class="hljs-string">"test.lua"</span></span>)</code> </pre> <br><p>  Der Befehl kann manuell in das untere Feld rechts unter dem Monitor eingegeben werden.  Wenn Sie keinen Text eingeben möchten, können Sie auf die Schaltfläche "Neu laden" (die äußerste Reihe von Schaltflächen rechts) klicken.  Nachdem Sie auf diese Schaltfläche geklickt haben, erhalten Sie eine Liste der Schaltflächen mit den auf der Karte geladenen .lua-Dateien.  Durch Klicken auf die Schaltfläche mit dem Dateinamen wird die Datei zur Ausführung gestartet. </p><br><p>  Wenn Sie möchten, dass die Datei sofort nach dem Einschalten der Karte gestartet wird, erstellen Sie eine Datei mit dem Namen init.lua. </p><br><h2>  Konfigurieren des Cloud-Teils für die Arbeit mit dem Gerät </h2><br><p>  Lassen Sie unser Gerät für einige Zeit stehen und erstellen Sie das Double in der Cloud.  Kürzlich konnte mit der neuen Funktionalität ein Gerätedoppel direkt im Azure-Portal erstellt werden.  In der Gruppe mit den IoT-Hub-Einstellungen mit dem Namen Explorers müssen Sie IoT-Geräte auswählen und auf "+ Hinzufügen" klicken. </p><br><p>  Um das Gerät mit dem IoT-Hub zu verbinden, müssen wir SAS (Shared Access Signature) generieren.  Zum Generieren von SAS wird ein Gerätedoppelschlüssel verwendet, der mit einem zusätzlichen Dienstprogramm (Geräte-Explorer, iothub-explorer, IoT-Erweiterung für Azure CLI 2.0) abgerufen werden kann.  Am einfachsten ist es jedoch, den Schlüssel an derselben Stelle im Azure-Portal abzurufen, indem Sie zum IoT-Hub -&gt; IoT-Geräte wechseln. </p><br><p><img src="https://habrastorage.org/webt/gu/fn/jz/gufnjz89qukktzouxgsoauw01ww.png"></p><br><p>  SAS kann auf dem Gerät oder über einen seiner Onlinedienste generiert werden.  Wenn Sie das SDK verwenden, kann es automatisch SAS für Sie generieren (es reicht aus, den Doppelschlüssel des Geräts im Code anzugeben). </p><br><p><img src="https://habrastorage.org/webt/ob/gs/v1/obgsv1ag1bhj7rrcjejvonpvs3u.png"></p><br><p>  Die Art und Weise, wie ein SAS-Token von einem Webdienst für eine bestimmte begrenzte Zeit generiert wird, ist etwas sicherer.  Obwohl es eine gewisse Nuance gibt.  Wenn Sie nur den Gerätenamen an den Dienst senden, kann jemand die Namen durchsuchen, um das Token eines anderen Geräts zu erhalten.  Um den Prozess ein wenig sicherer zu machen, schlage ich folgende Lösung vor: Speichern Sie den Azure-Hash des Doppelschlüssels des Geräts auf dem Gerät.  Und im Service-Code prüfen wir vor dem Generieren der SAS, ob der Hash mit dem Hash des Geräteschlüssels übereinstimmt.  Somit ist es möglich, SAS nur zu erhalten, wenn der Gerätename und der Hash seines Schlüssels bekannt sind. </p><br><p>  Die erste Art und Weise, wie SAS auf dem Gerät generiert wird, ist einfacher und bequemer, jedoch etwas weniger sicher.  Da ein Angreifer nach dem Zugriff auf das Gerät einen Schlüssel erhalten und SAS-Geräte selbst generieren kann.  Im zweiten Fall kann der Cracker nach dem Zugriff auf das Gerät nur SAS-Token empfangen, deren Lebensdauer begrenzt ist. </p><br><p>  Es stellt sich heraus, dass beide Methoden im Großen und Ganzen nicht ideal sind, wenn der Hacker Zugriff auf das Gerät hat.  Auch das Sichern einer Verbindung über ein VPN hilft hier nicht weiter.  In diesem Fall wird der Übertragungskanal geschützt, aber diejenigen, die das Gerät in die Hand nehmen, können auf den Kanal zugreifen.  Leider auf NodeMCU-, Arduino- usw. Geräten  Es gibt keine Möglichkeit, Schlüssel / Passwörter in einem sicheren Speicher zu speichern.  Möglicherweise erfordert der Markt für kostengünstige IoT-Geräte neue Hardwarefunktionen. </p><br><h2>  Erstellen einer Azure-Funktion für die SAS-Generierung </h2><br><p>  Als Onlinedienst ist es am einfachsten, Azure-Funktionen zu verwenden.  Hierbei handelt es sich um eindeutige Snippets, die sofort im Browser im Azure-Portal geschrieben werden können.  Scherz als Scherz, aber auf diese Weise können Sie sogar von einem Smartphone aus programmieren.  Natürlich verbietet niemand, sie in Visual Studio zu erstellen und zu debuggen und sie erst dann in kompilierter Form in Azure zu veröffentlichen. </p><br><p>  Die Aufgabe der Funktion besteht darin, eine normalerweise nicht sehr komplizierte Operation durchzuführen.  Nach der Microservice-Idee kann jede Funktion eines tun, aber es ist sehr gut (Prinzip der Einzelverantwortung). </p><br><p>  Sie können eine Azure Function App im Portal erstellen, indem Sie ein kurzes Formular ausfüllen </p><br><p><img src="https://habrastorage.org/webt/hd/ec/cu/hdeccuzb_kfv3cz7ggi1x5cnwe4.png"></p><br><p>  Mit dem Verbrauchsplan können Sie nur für die festgeschriebenen Funktionsaufrufe bezahlen.  Dies ist die billigste Option.  Derzeit sind eine Million Feature-Aufrufe kostenlos. </p><br><p>  Beachten Sie, dass neben der Erstellung der Funktion auch ein zusätzlicher Datenspeicher (Storage) erstellt wird. </p><br><p>  Nach dem Erstellen der Funktions-App können Sie die Funktion selbst erstellen.  In diesem Fall benötigen wir eine Funktion wie Webhook + API.  Die Funktion steht möglicherweise jedem offen (anonymer Zugriff) und steht möglicherweise nur Besitzern eines speziellen Codes zur Verfügung.  Der Code kann aus dem Fenster mit der Funktion abgerufen werden, indem Sie auf den Link &lt;/&gt; Funktions-URL abrufen klicken: </p><br><p><img src="https://habrastorage.org/webt/fl/mi/4w/flmi4wk8td66jpkudkozeqaec_o.png"></p><br><p>  Funktionen können in verschiedenen Sprachen geschrieben werden.  Ich bevorzuge C #. </p><br><pre> <code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">using</span></span> <span class="hljs-keyword"><span class="hljs-keyword">System</span></span>.Net; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> Microsoft.Azure.Devices; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> Microsoft.Azure.Devices.Common.<span class="hljs-keyword"><span class="hljs-keyword">Security</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> <span class="hljs-keyword"><span class="hljs-keyword">System</span></span>.Globalization; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> <span class="hljs-keyword"><span class="hljs-keyword">System</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">Security</span></span>.Cryptography; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> <span class="hljs-keyword"><span class="hljs-keyword">System</span></span>.Text; <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> static async Task&lt;HttpResponseMessage&gt; Run(HttpRequestMessage req, TraceWriter <span class="hljs-keyword"><span class="hljs-keyword">log</span></span>) { string deviceid = req.GetQueryNameValuePairs() .FirstOrDefault(q =&gt; string.Compare(q.Key, "deviceid", <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>, CultureInfo.InvariantCulture) == <span class="hljs-number"><span class="hljs-number">0</span></span>).<span class="hljs-keyword"><span class="hljs-keyword">Value</span></span>; string hash = req.GetQueryNameValuePairs() .FirstOrDefault(q =&gt; string.Compare(q.Key, "hash", <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>, CultureInfo.InvariantCulture) == <span class="hljs-number"><span class="hljs-number">0</span></span>).<span class="hljs-keyword"><span class="hljs-keyword">Value</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (String.IsNullOrEmpty(deviceid)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> req.CreateResponse(HttpStatusCode.BadRequest, "device id missing"); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (String.IsNullOrEmpty(hash)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> req.CreateResponse(HttpStatusCode.BadRequest, "hash missing"); var resourceUri ="ArduinoDemoHub.azure-devices.net/devices/"+deviceid; // taken <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> IoT Hub <span class="hljs-keyword"><span class="hljs-keyword">user</span></span> <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Connect</span></span> devices rights (<span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> Device Explorer) var connectionString = "HostName=ArduinoDemoHub.azure-devices.net;SharedAccessKeyName=iothubowner;SharedAccessKey=cuYBKc42lfJr4oSRGQGQ8IiKWxGQkLre7rprZDZ/ths="; var registryManager = RegistryManager.CreateFromConnectionString(connectionString); var device = await registryManager.GetDeviceAsync(deviceid); var key = device.Authentication.SymmetricKey.PrimaryKey; HMACSHA256 hmac = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> HMACSHA256(<span class="hljs-keyword"><span class="hljs-keyword">Encoding</span></span>.UTF8.GetBytes("somerandomkeyKJBWyfy4gski")); var hashedkey = Convert.ToBase64String(hmac.ComputeHash(<span class="hljs-keyword"><span class="hljs-keyword">Encoding</span></span>.UTF8.GetBytes(key))); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (hashedkey!=hash) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> req.CreateResponse(HttpStatusCode.BadRequest, "wrong hash"); SharedAccessSignatureBuilder sasBuilder = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> SharedAccessSignatureBuilder() { Key = key, Target = resourceUri, TimeToLive = TimeSpan.FromDays(Convert.ToDouble(<span class="hljs-number"><span class="hljs-number">7</span></span>)) }; var SAS = sasBuilder.ToSignature(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> req.CreateResponse(HttpStatusCode.OK, SAS); }</code> </pre> <br><p>  Wir erstellen die Datei project.json und fügen den folgenden Inhalt hinzu: </p><br><pre> <code class="hljs json">{ <span class="hljs-attr"><span class="hljs-attr">"frameworks"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"net46"</span></span>:{ <span class="hljs-attr"><span class="hljs-attr">"dependencies"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"Microsoft.Azure.Devices"</span></span>: <span class="hljs-string"><span class="hljs-string">"1.4.1"</span></span> } } } }</code> </pre> <br><p>  Der Code verwendet die Verbindungszeichenfolge zum IoT-Hub.  Es kann mit der Verbindungszeichenfolge zum Gerät verwechselt werden.  Damit Sie nicht verwirrt werden, möchte ich Sie daran erinnern, wo Sie es bekommen können: </p><br><p><img src="https://habrastorage.org/webt/7v/i9/jd/7vi9jdnq12-lsf2gwv82pbbhge0.png"></p><br><p>  Es ist erforderlich, die Verbindungszeichenfolge aus einer Richtlinie mit den Rechten der Geräteverbindung zu übernehmen. <br>  Es ist am besten, die Verbindungszeichenfolge selbst nicht wie ich im Code anzugeben.  Ich habe dies nur zum Beispiel getan.  Rufen Sie am besten die Funktion "Anwendungseinstellungen" auf. </p><br><p><img src="https://habrastorage.org/webt/u2/e_/uc/u2e_uchy0i1np_d6ikqjpbtpflw.png"></p><br><p>  Und geben Sie dort die Verbindungszeichenfolge an.  Danach können Sie es mit aus dem sicheren Speicher "holen" </p><br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">ConfigurationManager</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.ConnectionStrings</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">["___"]</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.ConnectionString</span></span></code> </pre> <br><p>  Auf dem Gerät müssen wir den Hash-Schlüssel speichern.  Aber zuerst müssen Sie die Zeichen codieren.  HttpUtility.UrlEncode aus dem System.Web-Bereich hilft uns dabei. </p><br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">hashedkey</span></span> = HttpUtility.UrlEncode(hashedkey);</code> </pre> <br><p>  Wir senden die Anfrage mit Get, aber nicht alle Zeichen können als Parameterwert übergeben werden. </p><br><h2>  Schreiben von Code zum Senden von Daten an die Cloud </h2><br><p>  Ich habe einen kleinen Code über Lua geschrieben, der Daten in die Cloud sendet.  Das Ergebnis war eine Art PoC.  Sie können es verwenden und an Ihre Bedürfnisse anpassen. <br>  Erstellen Sie 2 init.lua- und SendDataToCloud.lua-Dateien <br>  Der Inhalt des ersten: </p><br><pre> <code class="hljs php">--    <span class="hljs-keyword"><span class="hljs-keyword">print</span></span>(<span class="hljs-string"><span class="hljs-string">'init.lua ver 1.2'</span></span>) wifi.setmode(wifi.STATION) <span class="hljs-keyword"><span class="hljs-keyword">print</span></span>(<span class="hljs-string"><span class="hljs-string">'set mode=STATION (mode='</span></span>..wifi.getmode()..<span class="hljs-string"><span class="hljs-string">')'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">print</span></span>(<span class="hljs-string"><span class="hljs-string">'MAC: '</span></span>..wifi.sta.getmac()) <span class="hljs-keyword"><span class="hljs-keyword">print</span></span>(<span class="hljs-string"><span class="hljs-string">'chip: '</span></span>..node.chipid()) <span class="hljs-keyword"><span class="hljs-keyword">print</span></span>(<span class="hljs-string"><span class="hljs-string">'heap: '</span></span>..node.heap()) --  Wifi station_cfg={} station_cfg.ssid=<span class="hljs-string"><span class="hljs-string">"_SSID"</span></span> station_cfg.pwd=<span class="hljs-string"><span class="hljs-string">"___"</span></span> station_cfg.save=<span class="hljs-keyword"><span class="hljs-keyword">false</span></span> wifi.sta.config(station_cfg) wifi_status_codes = { [<span class="hljs-number"><span class="hljs-number">0</span></span>] = <span class="hljs-string"><span class="hljs-string">"Idle"</span></span>, [<span class="hljs-number"><span class="hljs-number">1</span></span>] = <span class="hljs-string"><span class="hljs-string">"Connecting"</span></span>, [<span class="hljs-number"><span class="hljs-number">2</span></span>] = <span class="hljs-string"><span class="hljs-string">"Wrong Password"</span></span>, [<span class="hljs-number"><span class="hljs-number">3</span></span>] = <span class="hljs-string"><span class="hljs-string">"No AP Found"</span></span>, [<span class="hljs-number"><span class="hljs-number">4</span></span>] = <span class="hljs-string"><span class="hljs-string">"Connection Failed"</span></span>, [<span class="hljs-number"><span class="hljs-number">5</span></span>] = <span class="hljs-string"><span class="hljs-string">"Got IP"</span></span> } sntp_connect_status_codes = { [<span class="hljs-number"><span class="hljs-number">1</span></span>] = <span class="hljs-string"><span class="hljs-string">"DNS lookup failed"</span></span>, [<span class="hljs-number"><span class="hljs-number">2</span></span>] = <span class="hljs-string"><span class="hljs-string">"Memory allocation failure"</span></span>, [<span class="hljs-number"><span class="hljs-number">3</span></span>] = <span class="hljs-string"><span class="hljs-string">"UDP send failed"</span></span>, [<span class="hljs-number"><span class="hljs-number">4</span></span>] = <span class="hljs-string"><span class="hljs-string">"Timeout, no NTP response received"</span></span> } --    Wi-fi (   ) tmr.alarm(<span class="hljs-number"><span class="hljs-number">6</span></span>,<span class="hljs-number"><span class="hljs-number">1000</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">if</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">wifi</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sta</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getip</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">==</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">nil</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">then</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">print</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"Waiting for IP address! (Status: "</span></span></span></span><span class="hljs-function"><span class="hljs-params">..wifi_status_codes[wifi.sta.status</span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"><span class="hljs-params">()</span></span></span></span><span class="hljs-function"><span class="hljs-params">]..</span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">")"</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">else</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">print</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"New IP address is "</span></span></span></span><span class="hljs-function"><span class="hljs-params">..wifi.sta.getip</span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"><span class="hljs-params">()</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">tmr</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">stop</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">6</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> --    </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">NTP</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sntp</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sync</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">({</span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">'pool.ntp.org'</span></span></span></span><span class="hljs-function"><span class="hljs-params">}, function</span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"><span class="hljs-params">(sec, usec, server)</span></span></span></span><span class="hljs-function"><span class="hljs-params"> print</span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"><span class="hljs-params">(</span></span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-params"><span class="hljs-string">"Clock Synced: "</span></span></span></span></span><span class="hljs-function"><span class="hljs-params"><span class="hljs-params">..sec..</span></span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-params"><span class="hljs-string">", "</span></span></span></span></span><span class="hljs-function"><span class="hljs-params"><span class="hljs-params">..usec..</span></span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-params"><span class="hljs-string">", "</span></span></span></span></span><span class="hljs-function"><span class="hljs-params"><span class="hljs-params">..server)</span></span></span></span><span class="hljs-function"><span class="hljs-params"> tls.cert.verify</span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"><span class="hljs-params">(false)</span></span></span></span><span class="hljs-function"><span class="hljs-params"> --    dofile</span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"><span class="hljs-params">(</span></span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-params"><span class="hljs-string">'SendDataToCloud.lua'</span></span></span></span></span><span class="hljs-function"><span class="hljs-params"><span class="hljs-params">)</span></span></span></span><span class="hljs-function"><span class="hljs-params"> end, function</span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"><span class="hljs-params">(error_code)</span></span></span></span><span class="hljs-function"><span class="hljs-params"> print</span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"><span class="hljs-params">(</span></span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-params"><span class="hljs-string">"Clock Sync Failed: "</span></span></span></span></span><span class="hljs-function"><span class="hljs-params"><span class="hljs-params">..sntp_connect_status_codes[error_code])</span></span></span></span><span class="hljs-function"><span class="hljs-params"> end, </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">1</span></span></span></span><span class="hljs-function"><span class="hljs-params"> --      )</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">end</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">end</span></span></span><span class="hljs-function"> )</span></span></code> </pre> <br><p>  Diese Datei stellt eine Verbindung zum Netzwerk her und führt den Code aus der Datei SendDataToCloud.lua aus, wenn die Verbindung erfolgreich hergestellt wurde. </p><br><p>  Sie müssen die Daten Ihres Wi-Fi-Zugangspunkts als Werte für station_cfg.ssid und station_cfg.pwd angeben. </p><br><p>  In der folgenden Datei müssen Sie den Gerätenamen und das IoT des Hubs (Variablen DEVICE und IOTHUB) ändern.  Die Variable funcurl enthält die Adresse der SAS-generierenden Funktion und den Hash des Geräteschlüssels (den wir zuvor mit HttpUtility.UrlEncode codiert haben) als Wert des Hash-Parameters </p><br><pre> <code class="hljs powershell">--  DEVICE = <span class="hljs-string"><span class="hljs-string">"LuaDevice"</span></span> IOTHUB = <span class="hljs-string"><span class="hljs-string">"ArduinoDemoHub.azure-devices.net"</span></span> PORT = <span class="hljs-number"><span class="hljs-number">8883</span></span> USER = <span class="hljs-string"><span class="hljs-string">"ArduinoDemoHub.azure-devices.net/"</span></span>..DEVICE..<span class="hljs-string"><span class="hljs-string">"/api-version=2016-11-14"</span></span> telemetry_topic=<span class="hljs-string"><span class="hljs-string">"devices/"</span></span>..DEVICE..<span class="hljs-string"><span class="hljs-string">"/messages/events/"</span></span> connected = false local headers = <span class="hljs-string"><span class="hljs-string">'Content-Type: application/x-www-form-urlencoded\r\n'</span></span>.. <span class="hljs-string"><span class="hljs-string">'Accept: */*\r\n'</span></span>.. <span class="hljs-string"><span class="hljs-string">'User-Agent: Mozilla/5.0 (Windows NT 6.1; Win64; x64; rv:47.0) Gecko/20100101 Firefox/47.0'</span></span> funcurl = <span class="hljs-string"><span class="hljs-string">"https://arduinofunction.azurewebsites.net/api/GenerateSASFunction?code=Jn7j54PbR31BSRa0UZrDwp4ZEltjmWHmblG9zLo0Ne0tyGM7w/wQ7w=="</span></span> funcurl = funcurl..<span class="hljs-string"><span class="hljs-string">"&amp;hash=oJzykimyQsTPtzgJxYq90Xfqmw1rZTPTCH%2bJ5sSurKI%3d"</span></span> funcurl = funcurl..<span class="hljs-string"><span class="hljs-string">"&amp;deviceid="</span></span>..DEVICE tmr.alarm(<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-number"><span class="hljs-number">5000</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, function() http.get(funcurl, headers, function(code, <span class="hljs-keyword"><span class="hljs-keyword">data</span></span>, header) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (code &lt; <span class="hljs-number"><span class="hljs-number">0</span></span>) then print(<span class="hljs-string"><span class="hljs-string">"HTTP request failed"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> sas = true print(code, <span class="hljs-keyword"><span class="hljs-keyword">data</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> string.match(<span class="hljs-keyword"><span class="hljs-keyword">data</span></span>, <span class="hljs-string"><span class="hljs-string">"Shared"</span></span>) then tmr.stop(<span class="hljs-number"><span class="hljs-number">1</span></span>) SAS = string.sub(<span class="hljs-keyword"><span class="hljs-keyword">data</span></span>,<span class="hljs-number"><span class="hljs-number">2</span></span>,string.len(<span class="hljs-keyword"><span class="hljs-keyword">data</span></span>)<span class="hljs-literal"><span class="hljs-literal">-1</span></span>) print(SAS) connect(SAS) <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">connect</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(SAS)</span></span></span><span class="hljs-function"> --   </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">MQTT</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">client</span></span></span><span class="hljs-function"> = </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">mqtt</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Client</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(DEVICE, 240, USER, SAS)</span></span></span><span class="hljs-function"> --   </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">IoTHub</span></span></span><span class="hljs-function">    </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">MQTT</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">print</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">("Connecting to MQTT broker. Please wait...")</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">tmr</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">alarm</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(2,1000, 1, function()</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">client</span></span></span><span class="hljs-function">:</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">connect</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(IOTHUB, PORT, 1, -- Callback     function(client)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">tmr</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">stop</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(2)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">print</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">("Connected to MQTT: "..IOTHUB..":"..PORT.." as "..DEVICE)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">connected</span></span></span><span class="hljs-function"> = </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">true</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">senddata</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">end</span></span></span><span class="hljs-function">, -- </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Callback</span></span></span><span class="hljs-function">    </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(client, reason)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">print</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">("Error Connecting: "..reason)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">end</span></span></span><span class="hljs-function"> ) </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">end</span></span></span><span class="hljs-function">) </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">end</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">senddata</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">math</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">randomseed</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(1)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">tmr</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">alarm</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(3, 1000, tmr.ALARM_AUTO, publish_data)</span></span></span><span class="hljs-function"> --   ,     </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">callback</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">client</span></span></span><span class="hljs-function">:</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">on</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">("offline", function(client)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">print</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">("MQTT Disconnected.")</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">connected</span></span></span><span class="hljs-function"> = </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">false</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">end</span></span></span><span class="hljs-function">) </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">end</span></span></span><span class="hljs-function"> --      </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">publish_data</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">if</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">connected</span></span></span><span class="hljs-function"> == </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">true</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">then</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">somedata</span></span></span><span class="hljs-function"> = </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">math</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">random</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(1,100)</span></span></span><span class="hljs-function"> --     </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">payload</span></span></span><span class="hljs-function"> = "</span></span>{ \<span class="hljs-string"><span class="hljs-string">"deviceId\"</span></span> : \<span class="hljs-string"><span class="hljs-string">""</span></span>..DEVICE..<span class="hljs-string"><span class="hljs-string">"\"</span></span>,<span class="hljs-string"><span class="hljs-string">".. "</span></span>\<span class="hljs-string"><span class="hljs-string">"iotdata\"</span></span> :<span class="hljs-string"><span class="hljs-string">"..somedata.."</span></span>}<span class="hljs-string"><span class="hljs-string">" --   client:publish(telemetry_topic, payload, 1, 0, function(client) print("</span></span><span class="hljs-keyword"><span class="hljs-keyword">Data</span></span> published successfully.<span class="hljs-string"><span class="hljs-string">") end) end end</span></span></code> </pre> <br><p>  Daten werden ohne Verwendung des Azure SDK gesendet, sodass Sie diesen Code nicht nur zum Senden von Daten an Azure verwenden können.  Es gibt viele Alternativen: AWS, Google Cloud IoT, IBM Watson IoT Platform. </p><br><p>  In diesem Beispiel wird das MQTT-Protokoll (Message Queuing Telemetry Transport) verwendet.  Dies ist ein offenes Protokoll, das speziell für IoT-Geräte entwickelt wurde.  Daten werden im JSON-Format gesendet.  Wenn in realen Projekten Daten von Sensoren stammen, wird im Beispiel eine Zufallszahl generiert. </p><br><p>  Während des Handshake-Prozesses zwischen dem Gerät und dem IoT-Hub kann der Server sein Zertifikat senden oder ein Gerätezertifikat anfordern.  Wenn Sie sich erinnern, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">haben wir</a> das <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">letzte Mal, als wir</a> mit dem Arduino-Gerät gearbeitet haben, es mit einem Zertifikat geflasht.  Jetzt reicht eine Code-Senke: </p><br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">tls</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.cert</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.verify</span></span>(<span class="hljs-selector-tag"><span class="hljs-selector-tag">false</span></span>)</code> </pre> <br><p>  Wir sind auf das Zertifikat beschränkt, das der Server an uns sendet. </p><br><h2>  INFO </h2><br><p>  Möglicherweise interessieren Sie sich für den Inhalt der Zertifikate für Ihren Hub mit dem folgenden OpenSSL-Befehl. </p><br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">openssl</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">s_client</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-showcerts</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-connect</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">ArduinoDemoHub</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.azure-devices</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.net</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:8883</span></span></code> </pre> <br><p>  Zur Vorbereitung des Materials wurden die Labore verwendet, die unter folgendem Link verfügbar sind: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Senden von D2C-Nachrichten (Device-to-Cloud)</a> <br>  Der Code ist nicht ganz auf dem neuesten Stand und ich musste ihn ein wenig aktualisieren, aber im Allgemeinen kann der Link nützlich sein. </p><br><h2>  Arbeiten mit NodeMCU von Arduino IDE </h2><br><p>  Ich kann das Thema der Verwendung des SDK nicht ignorieren.  Ihre Lösung ist gut, aber das SDK ist derselbe Code, der bereits debuggt, vereinfacht und einsatzbereit ist.  Ein paar Worte zur Konfiguration und Verwendung der Arduino IDE für die Arbeit mit NodeMCU. </p><br><p>  Nach der Installation der Arduino IDE müssen Sie zum Menü Datei - Einstellungen wechseln </p><br><p><img src="https://habrastorage.org/webt/ea/u_/fq/eau_fqwxsvtujmn50otjftkgwvi.png"></p><br><p>  Fügen Sie einen Link zum zusätzlichen Board Manager hinzu. Geben Sie im Feld URLs für den zusätzlichen Board Manager die Adresse ein: <a href="">http://arduino.esp8266.com/versions/2.4.0/package_esp8266com_index.json</a> </p><br><p>  Gehen Sie dann zum Menü Tools - Board xxx - Boardx Manager und installieren Sie ESP8266 <br>  Installieren Sie die Bibliotheken AzureIoTHub, AzureIoTUtility, AzureIoTProtocol_MQTT.  Nach der Installation der letzten Bibliothek in den Beispielen (Menü Datei - Beispiele - AzureIoTProtocol_MQTT) finden Sie ein Beispiel simplesample_mqtt für ESP8266. </p><br><p>  Das Beispiel ist fertig.  Geben Sie einfach die Variablenwerte in die Datei iot_configs.h ein <br>  Ich erwähne ein kleines Minus.  Das Kompilieren des Projekts und das Herunterladen auf das Board dauert im Vergleich zu Lua ziemlich lange. </p><br><h2>  Speichern von Daten in der Azure-Cloud </h2><br><p>  Beim Senden von Daten ist alles klar, aber wie kostengünstig es ist, Daten in der Cloud zu speichern. <br>  Die kostengünstigste Möglichkeit, Daten vom IoT-Hub an die Datenbank zu senden, sind Azure-Funktionen.  Der kostengünstigste Datenspeicher ist Azure Table Storage. </p><br><p>  Interessanterweise wird beim Erstellen einer Funktions-App auch automatisch Speicher erstellt, den die Funktion selbst benötigt, um zu funktionieren.  Wenn Sie ein separates Repository erstellen, ist es ratsam, die Grundeinstellungen wie folgt vorzunehmen: </p><br><p><img src="https://habrastorage.org/webt/zg/va/sz/zgvaszlilbyzjh6srxdmrq3cjyi.png"></p><br><p>  Die LSR-Replikation ist derzeit die kostengünstigste Option.  Sie wird ausgewählt, wenn automatisch ein an eine Funktion gebundenes Repository erstellt wird. <br>  Was wir jetzt brauchen, ist, Daten vom IoT-Hub zu empfangen und in den Speicher zu schreiben.  In diesem Fall kann uns das Schnellstartfenster beim Erstellen einer Funktion nicht die gewünschte Option anbieten. </p><br><p><img src="https://habrastorage.org/webt/x5/vw/6i/x5vw6ia4ubsfidgvpqmlrretqru.png"></p><br><p>  Klicken Sie daher unten auf den Link Benutzerdefinierte Funktion und wählen Sie die Option IoT Hub (Event Hub). <br>  Dieses Fenster öffnet sich für uns: </p><br><p><img src="https://habrastorage.org/webt/gu/t6/ry/gut6ryx8peg_aq2mqfv0dr62agk.jpeg"></p><br><p>  In dem wir das Event Hub-Verbindungsfeld mit einer einfachen Auswahl ausfüllen können (indem wir auf Neu klicken).  Um jedoch den Namen des Event Hub anzugeben, müssen Sie zum IoT Hub wechseln.  Im Hub müssen Sie zu Endpunkten (Endpunkten) gehen und von dort den Event Hub-kompatiblen Namen abrufen </p><br><p><img src="https://habrastorage.org/webt/dl/tk/lb/dltklbv7hubhxdhe07nioe7ckgu.png"></p><br><p>  Fahren wir mit dem Funktionscode fort.  Das folgende Snippet empfängt Daten vom IoT-Hub und speichert sie im Tabellenspeicher: </p><br><pre> <code class="hljs lua">#r <span class="hljs-string"><span class="hljs-string">"Microsoft.WindowsAzure.Storage"</span></span> #r <span class="hljs-string"><span class="hljs-string">"Newtonsoft.Json"</span></span> using Microsoft.Azure; // Namespace <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> CloudConfigurationManager using Microsoft.WindowsAzure.Storage; // Namespace <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> CloudStorageAccount using Microsoft.WindowsAzure.Storage.Table; // Namespace <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> Table storage types using Newtonsoft.Json; public static void Run(<span class="hljs-built_in"><span class="hljs-built_in">string</span></span> myIoTHubMessage, TraceWriter <span class="hljs-built_in"><span class="hljs-built_in">log</span></span>) { var e = JsonConvert.DeserializeObject&lt;EventDataEntity&gt;(myIoTHubMessage); <span class="hljs-built_in"><span class="hljs-built_in">log</span></span>.Info($<span class="hljs-string"><span class="hljs-string">"C# IoT Hub trigger function processed a message: {myIoTHubMessage}"</span></span>); CloudStorageAccount storageAccount = CloudStorageAccount.Parse (<span class="hljs-string"><span class="hljs-string">"DefaultEndpointsProtocol=https;AccountName=iotdatademostorage;AccountKey=JgStNcJvlQYeNsVCmpkHQUkWlZiQ7tJwAm6OCL34+lGx3XrR+0CPiY9RoxIDA6VSvMKlOEUrVWL+KWP0qLMLrw==;EndpointSuffix=core.windows.net"</span></span>); CloudTableClient tableClient = storageAccount.CreateCloudTableClient(); CloudTable <span class="hljs-built_in"><span class="hljs-built_in">table</span></span> = tableClient.GetTableReference(<span class="hljs-string"><span class="hljs-string">"iottable"</span></span>); <span class="hljs-built_in"><span class="hljs-built_in">table</span></span>.CreateIfNotExists(); EventDataEntity edata = new EventDataEntity(<span class="hljs-string"><span class="hljs-string">"IOTpartition"</span></span>, Guid.NewGuid().ToString()); edata.DeviceId = e.DeviceId; edata.IotData = e.IotData; TableOperation insertOperation = TableOperation.Insert(edata); <span class="hljs-built_in"><span class="hljs-built_in">table</span></span>.Execute(insertOperation); } public class EventDataEntity : TableEntity { public EventDataEntity(<span class="hljs-built_in"><span class="hljs-built_in">string</span></span> pkey, <span class="hljs-built_in"><span class="hljs-built_in">string</span></span> rkey) { this.PartitionKey = pkey; this.RowKey = rkey; } public EventDataEntity() { } public <span class="hljs-built_in"><span class="hljs-built_in">string</span></span> DeviceId { get; set; } public int IotData { get; set; } }</code> </pre> <br><p>  Wenn Sie diesen Code in einem realen Projekt verwenden, vergessen Sie nicht, die Verbindungszeichenfolge an einem sichereren Ort zu platzieren - in den App-Einstellungen (genau wie die Verbindungszeichenfolge der ersten Funktion). </p><br><p>  Die Verbindungszeichenfolge selbst kann im Einstellungselement namens Zugriffsschlüssel verwendet werden: </p><br><p><img src="https://habrastorage.org/webt/ot/z9/pb/otz9pbjqyflhjivwztvvsmkjms4.png"></p><br><p>  Zeigen Sie Tabelleninhalte mit dem kostenlosen Dienstprogramm <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Azure Storage Explorer an</a> </p><br><p>  Da die Kosten für Azure Table Storage recht niedrig sind und der Azure Functions- und IoT-Hub bestimmte Ressourcen monatlich kostenlos anbietet, können die Kosten für die gesamte Lösung pro Monat weniger als 1 US-Dollar betragen.  Das hängt natürlich von der Datenmenge ab.  Zählen Sie selbst.  Heute kostet 1 GB Daten 7 Cent pro Monat und für jede Million Transaktionen werden Ihnen nur 4 Cent berechnet. </p><br><h2>  INFO </h2><br><p>  Wenn Sie Cloud-Dienste von einem Anbieter nutzen, empfehle ich Ihnen immer, eine Kreditkarte mit dem Mindestbetrag mit Ihrem Konto zu verknüpfen.  Es ist ein Zufall, dass Sie durch die Wahl einer fehlerhaften Einstellung viel mehr bezahlen, als Sie erwarten. </p><br><p>  Wir erinnern Sie daran, dass dies die Vollversion eines <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Artikels aus dem Hacker-Magazin ist</a> .  Sein Autor ist <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Alexey Sommer</a> . </p><br><h2>  Nützliche Materialien </h2><br><h4>  Handbuch zur Cloud-Anwendungsarchitektur </h4><br><p> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><img width="200" align="left" src="https://habrastorage.org/webt/zk/ns/pq/zknspqark8ose3vto4iom_kbdaq.jpeg"></a>  Verfolgen Sie einen strukturierten Ansatz für die Entwicklung von Cloud-Anwendungen.  In diesem 300-seitigen E-Book zur Cloud-Computing-Architektur werden Richtlinien für Architektur, Entwicklung und Implementierung erläutert, die unabhängig von der gewählten Cloud-Plattform gelten.  Diese Anleitung enthält Schritte zu: </p><br><ul><li>  Auswahl des richtigen Cloud-Anwendungsarchitekturstils für Ihre Anwendung oder Lösung; </li><li>  Auswahl geeigneter Computer- und Datenspeichertechnologien; </li><li>  Implementierung von 10 Entwicklungsprinzipien zur Erstellung einer skalierbaren, ausfallsicheren und verwaltbaren Anwendung; </li><li>  Befolgen Sie die fünf Prinzipien zur Erstellung hochwertiger Software, die den Erfolg Ihrer Cloud-Anwendung garantiert. </li><li>  Verwenden von Entwurfsmustern, die für das Problem entwickelt wurden, das Sie lösen möchten. </li></ul><br><p>  → <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><b>Herunterladen</b></a> </p><br><h4>  Azure-Entwicklerhandbuch </h4><br><p> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><img width="200" align="right" src="https://habrastorage.org/webt/ik/2g/ot/ik2gotwyadnbqcjeusitbjdk550.png"></a> </p><br><p>  In diesem Update des Azure-Entwicklerhandbuchs erfahren Sie, wie der gesamte Satz von Diensten für die Azure-Softwareplattform Ihren Anforderungen entspricht.  Hier finden Sie Informationen zu Architekturansätzen und den häufigsten Situationen, die beim Erstellen von Cloud-Anwendungen auftreten. </p><br><p>  → <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><b>Herunterladen</b></a> </p><br><h4>  Microsoft Azure-Grundlagen </h4><br><p> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><img width="200" align="left" src="https://habrastorage.org/webt/w1/pe/sj/w1pesji9lrslkdggsjzwdkya2la.png"></a>  Dieses Buch bietet Entwicklern und IT-Fachleuten, die noch keine Erfahrung mit Cloud Computing haben, wichtige Einblicke in wichtige Azure-Dienste.  Schritt-für-Schritt-Demos helfen dem Leser zu verstehen, wie er mit den einzelnen Schlüsseldiensten beginnen kann.  Jedes Kapitel ist unabhängig. Es ist nicht erforderlich, praktische Demonstrationen aus früheren Kapiteln durchzuführen, um ein bestimmtes Kapitel zu verstehen. </p><br><p>  Die folgenden Themen werden in diesem Buch behandelt: </p><br><ul><li>  Erste Schritte mit Azure; </li><li>  Azure-Anwendungsdienst und Webanwendungen; </li><li>  Virtuelle Maschinen; </li><li>  Lagerservice; </li><li>  Datenbanken </li><li>  Zusätzliche Azure-Dienste. </li></ul><br><p>  → <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><b>Herunterladen</b></a> </p><br><h2>  Nützliche Links </h2><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Russischsprachige Dokumentation für IoT Hub</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Azure IoT-Beispiele für Csharp (.NET)</a> </li></ul></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de421847/">https://habr.com/ru/post/de421847/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de421835/index.html">Die Interagency Commission entwickelt neue Technologien zur Blockierung von Telegrammen</a></li>
<li><a href="../de421837/index.html">Erstellen von 1k Intro Chaos für ZX-Spectrum</a></li>
<li><a href="../de421839/index.html">Funktionale Java-Programmierung mit Vavr</a></li>
<li><a href="../de421841/index.html">Robotaxi Waymo ist nicht ganz bereit für den Zugang zu öffentlichen Straßen</a></li>
<li><a href="../de421845/index.html">Was machen Datenanalysten eigentlich? Ergebnisse aus 35 Interviews</a></li>
<li><a href="../de421849/index.html">Veranstaltungen für HR in der IT im September 2018: My Circle Digest</a></li>
<li><a href="../de421851/index.html">Probleme mit Eulen und Globus: Verbinden von zwei Assemblys mit identischen Namespaces und Klassennamen</a></li>
<li><a href="../de421855/index.html">Heimprojektoren: die besten "je nach Version", ultrakurzer Fokus, Meister in Helligkeit und Geschwindigkeit</a></li>
<li><a href="../de421857/index.html">ToFoIn v 1. Reservierung von Gateways und Umschalten zwischen externen Kanälen in FreeBSD</a></li>
<li><a href="../de421859/index.html">Hinweise des IoT-Anbieters. Geräte und überbieten</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>