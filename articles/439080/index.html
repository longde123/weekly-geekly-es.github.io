<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>‚ùå üôÇ üêù El RabbitMQ no obvio en Yii2 o por qu√© RabbitMQ escribe en todas las colas a la vez üöä üôçüèº üë©üèø‚Äçü§ù‚Äçüë®üèΩ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Quiero compartir el problema pr√°ctico de configurar el intermediario de colas RabbitMQ en Yii2. Le advierto al lector que no tengo una opini√≥n experta...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>El RabbitMQ no obvio en Yii2 o por qu√© RabbitMQ escribe en todas las colas a la vez</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/439080/"><div style="text-align:center;"><img src="https://habrastorage.org/webt/7e/1v/k7/7e1vk7xprusmt0uhpyxpr3ll-j8.jpeg"></div><br>  Quiero compartir el problema pr√°ctico de configurar el intermediario de colas RabbitMQ en Yii2.  Le advierto al lector que no tengo una opini√≥n experta sobre c√≥mo trabajar con este agente de colas, sin embargo, realmente quiero llenar los vac√≠os en la documentaci√≥n de Yii2 y corregir el resultado de mi propio tormento.  Entonces, si alguna vez ha encontrado un problema de que se est√°n enviando mensajes a todas las colas que est√°n en el servidor de colas, acepta que esto es un problema y no entiende por qu√© sucede esto, entonces le pido un gato. <br><a name="habracut"></a><br>  ¬øPor qu√© podr√≠as encontrar este comportamiento?  Por ejemplo, si usted, como yo, no ha trabajado con RabbitMQ antes, pero trabaj√≥ por ejemplo con Gearman.  Gearman en s√≠, tan simple como un ferrocarril ( <s>tomado de un conocido y respetado personaje de Internet</s> ).  Crea una cola con un nombre determinado, coloca los datos all√≠.  El trabajador lee de la cola con el mismo nombre.  Todo es simple  Ahora es el momento de usar la tecnolog√≠a de la moda, sin entender por qu√© eliges RabbitMQ.  Entonces te alegra que Yii2 <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">tenga una</a> abstracci√≥n preparada para muchos corredores de colas populares.  La escasa documentaci√≥n indica la configuraci√≥n predeterminada para que todo comience: <br><br><pre><code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">return</span></span> [ <span class="hljs-string"><span class="hljs-string">'bootstrap'</span></span> =&gt; [ <span class="hljs-string"><span class="hljs-string">'queue'</span></span>, <span class="hljs-comment"><span class="hljs-comment">// The component registers its own console commands ], 'components' =&gt; [ 'queue' =&gt; [ 'class' =&gt; \yii\queue\amqp_interop\Queue::class, 'port' =&gt; 5672, 'user' =&gt; 'guest', 'password' =&gt; 'guest', 'queueName' =&gt; 'queue', 'driver' =&gt; yii\queue\amqp_interop\Queue::ENQUEUE_AMQP_LIB, // or 'dsn' =&gt; 'amqp://guest:guest@localhost:5672/%2F', // or, same as above 'dsn' =&gt; 'amqp:', ], ], ];</span></span></code> </pre> <br>  Parece que todo es incre√≠blemente simple, aqu√≠ est√° la l√≠nea familiar con <i>queueName</i> , copiar y pegar, arreglarlo, ejecutarlo, ¬°funciona!  Hacemos colas para otros componentes del sistema.  Paralelamente con lo que nuestro php puede.  Comprometerse, empujar satisfecho, ponemos la tarea en el control de calidad y vamos a leer un habr ( <s>en el almuerzo</s> ). <br><br>  Aqu√≠, lo m√°s interesante, el control de calidad en el chat nos interrumpe y dice que algo extra√±o est√° sucediendo.  Por alguna raz√≥n, los datos que escriben los trabajadores (consumidores) est√°n duplicados.  Que que  No puede ser as√≠.  Vamos a revisar los registros.  Vemos que el mensaje se est√° escribiendo en la cola, con la cual la cola se selecciona correctamente, se recibe hash jobId.  No, no, no tenemos errores.  Estamos escribiendo QA satisfechos, verifique nuevamente, esto no puede ser, lo estamos haciendo bien. <br><br>  Literalmente, despu√©s de media hora, nos distrajimos nuevamente, el error se repiti√≥ y luego cay√≥ una notificaci√≥n: la tarea fue transferida de regreso al trabajo.  Bueno, soy programador, ahora lo resolveremos.  RabbitMQ, a diferencia de Gearman, tiene una interfaz web en la que hay mucha informaci√≥n sobre el servidor.  Este milagro se ve as√≠: <br><br><img src="https://habrastorage.org/webt/hb/gj/mh/hbgjmh691g7hqj9zesqnl0j9dso.png"><br><br>  Lanzamos un par de mensajes m√°s a la cola, vemos en el webmord que nuestros mensajes llegan y son procesados ‚Äã‚Äãpor el trabajador.  Una mirada informal advierte que cuando lanzamos un mensaje a la cola, el cuadro de "Tasas de mensajes" salta en todas las colas. <br><br><img src="https://habrastorage.org/webt/ww/kl/6u/wwkl6u3aaqymtxvgvfjkqzmnnea.png"><br><br>  Verificamos la configuraci√≥n cien veces, volvemos a leer la escasa documentaci√≥n de Yii.  Hicimos todo bien.  Vamos a leer la documentaci√≥n en el sitio del conejo.  Despu√©s de un par de decenas de minutos deambulando en la oscuridad, nos topamos con un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">tutorial</a> .  Inmediatamente despu√©s del primer p√°rrafo, nos familiarizamos con la raz√≥n de nuestros malentendidos: intercambios.  No repetir√© la documentaci√≥n, muy brevemente. <br><br>  En RabbitMQ no escribimos un mensaje en la cola, lo escribimos para intercambiar, una especie de proxy que recibe nuestros mensajes en un extremo y se comunica con las colas en el servidor en el otro extremo.  Est√° en su poder decidir en qu√© cola colocar nuestros datos.  Curiosamente, no hay una sola l√≠nea sobre esto en la documentaci√≥n de Yii.  A primera vista, no est√° claro c√≥mo configurar el intercambio, nos sumergimos en las entra√±as y en el archivo <i>vendor / yiisoft / yii2-queue / src / drivers / amqp_interop / Queue.php: 176</i> encontramos una propiedad apreciada que se puede poblar.  Aqu√≠ debo decir que hay muchos controladores para RabbitMQ, en mi caso <i>se usa enqueue / amqp-lib</i> .  Establecemos <i>exchangeName</i> , prueba, nada cambia.  Bueno, somos como un verdadero ingeniero ruso, primero lo intentamos y luego volvemos a leer detenidamente la documentaci√≥n.  Lo leemos cuidadosamente otra vez, luego vamos a la cara web de conejo y vemos lo siguiente: <br><br><img src="https://habrastorage.org/webt/zp/_y/o5/zp_yo5nzamanqo-lptarpv_nswu.png"><br><br>  Varias de nuestras colas est√°n asociadas con el mismo intercambio.  Bingo!  Aqu√≠ est√° la raz√≥n, un "pero", no los at√©.  Volvemos al intestino del controlador, encontramos la l√≠nea 392 del m√©todo <i>setupBroker.</i> <br><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;context-&gt;bind(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> AmqpBind($queue, $topic));</code> </pre><br>  Este es un enlace no administrado. <br><br>  Y as√≠, sin pensarlo por mucho tiempo, llegamos a la conclusi√≥n de que para cada cola se debe declarar un intercambio, entonces la conexi√≥n ser√° correcta y un intercambio tendr√° solo una cola conectada.  de esta manera obtenemos un comportamiento similar de Gearman.  Por cierto, la documentaci√≥n describe en detalle por qu√© se realiz√≥ el intercambio, y seg√∫n tengo entendido, una de las razones es la capacidad de vincular varias colas con el intercambio.  Pero no se me ocurri√≥ un caso como este cuando podr√≠a ser necesario, chicos escriben en los comentarios.  Y escriba, ¬øha encontrado la situaci√≥n descrita anteriormente o estoy haciendo todo mal? </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/439080/">https://habr.com/ru/post/439080/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../439068/index.html">La campa√±a de spam "Te amo" redirigida a Jap√≥n</a></li>
<li><a href="../439070/index.html">China abandonar√° el sistema de IA anticorrupci√≥n Zero Trust debido a su alta eficiencia</a></li>
<li><a href="../439072/index.html">Manifiesto del desarrollador de casas inteligentes: 15 principios</a></li>
<li><a href="../439076/index.html">¬øEn qu√© aplicaciones esperar un c√≥digo malicioso desconocido?</a></li>
<li><a href="../439078/index.html">Programador permanente arrestado por crear una aplicaci√≥n m√≥vil a trav√©s de la cual actu√≥ el ped√≥filo</a></li>
<li><a href="../439082/index.html">Wish Factory Walk</a></li>
<li><a href="../439086/index.html">Causas de ANR y c√≥mo evitarlo</a></li>
<li><a href="../439090/index.html">El IBM 5150. Donde comenz√≥ el monopolio</a></li>
<li><a href="../439094/index.html">Los cient√≠ficos han encontrado el vertebrado vivo m√°s antiguo de la Tierra</a></li>
<li><a href="../439096/index.html">Buildbot: una historia con ejemplos de otro sistema de integraci√≥n continua</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>