<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üéÄ üë©üèø‚Äçü§ù‚Äçüë©üèª ‚òÆÔ∏è Desempenho do PHP: planejamento, cria√ß√£o de perfil, otimiza√ß√£o üßùüèΩ üë®üèæ‚Äç‚öïÔ∏è üçÖ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Ol√° Habr! Dois anos atr√°s, escrevemos sobre como mudamos para o PHP 7.0 e economizamos um milh√£o de d√≥lares. Em nosso perfil de carregamento, a nova v...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Desempenho do PHP: planejamento, cria√ß√£o de perfil, otimiza√ß√£o</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/badoo/blog/430722/"><img src="https://habrastorage.org/webt/k_/fe/vv/k_fevvrhhn2aruuz19gpne_jypy.jpeg"><br><br>  Ol√° Habr!  Dois anos atr√°s, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">escrevemos</a> sobre como mudamos para o PHP 7.0 e economizamos um milh√£o de d√≥lares.  Em nosso perfil de carregamento, a nova vers√£o mostrou ser duas vezes mais eficiente no uso da CPU: o carregamento que costum√°vamos atender a ~ 600 servidores, depois que a transi√ß√£o come√ßou a servir ~ 300.  Como resultado, por dois anos tivemos uma reserva de capacidades. <br><br>  Mas o Badoo est√° crescendo.  O n√∫mero de usu√°rios ativos est√° aumentando constantemente.  Estamos melhorando e desenvolvendo nossa funcionalidade, gra√ßas √† qual os usu√°rios passam cada vez mais tempo no aplicativo.  E isso, por sua vez, se reflete no n√∫mero de solicita√ß√µes, que nos √∫ltimos dois anos aumentaram de 2 a 2,5 vezes. <br><br>  Nos encontramos em uma situa√ß√£o em que um ganho duplo de desempenho foi nivelado por mais de um aumento duplo de solicita√ß√µes e novamente come√ßamos a abordar os limites do cluster.  No n√∫cleo do PHP, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">otimiza√ß√µes</a> √∫teis (JIT, pr√©-carregamento) s√£o novamente esperadas, mas s√£o planejadas apenas para o PHP 7.4, e esta vers√£o ser√° lan√ßada n√£o antes de um ano.  Portanto, o truque de transi√ß√£o n√£o pode ser repetido agora - voc√™ precisa otimizar o pr√≥prio c√≥digo do aplicativo. <br><br>  Abaixo, mostrarei como abordamos essas tarefas, quais ferramentas usamos e mostrarei exemplos de otimiza√ß√µes, id√©ias e abordagens que aplicamos e que nos ajudaram em nosso tempo. <br><a name="habracut"></a><br><h1>  Por que otimizar </h1><br>  A maneira mais f√°cil e √≥bvia de resolver o problema de desempenho √© adicionar ferro.  Se o seu c√≥digo for executado no mesmo servidor, a adi√ß√£o de mais um duplicar√° o desempenho do seu cluster.  Transferindo esses custos para o tempo de trabalho do desenvolvedor, nos perguntamos: ele conseguir√° um aumento duplo de produtividade durante esse per√≠odo devido a otimiza√ß√µes?  Talvez sim, mas talvez n√£o: depende de qu√£o otimamente o sistema j√° est√° funcionando e de qu√£o bom √© o desenvolvedor.  Por outro lado, o servidor adquirido permanecer√° propriedade da empresa e o tempo gasto n√£o ser√° devolvido. <br><br>  Acontece que em pequenos volumes a solu√ß√£o correta ser√° frequentemente a adi√ß√£o de ferro. <br><br>  Mas leve a nossa situa√ß√£o.  Agora, depois que o ganho da mudan√ßa para o PHP 7.0 foi compensado pelo crescimento da atividade e pelo n√∫mero de usu√°rios, novamente temos 600 servidores atendendo solicita√ß√µes ao aplicativo PHP.  Para aumentar a capacidade uma vez e meia, precisamos adicionar 300 servidores. <br><br>  Tome como c√°lculo o custo m√©dio de um servidor - US $ 4.000.  300 * 4000 = US $ 1.200.000 - o custo de aumentar a capacidade uma vez e meia. <br><br>  Ou seja, em nossas condi√ß√µes, podemos investir uma quantidade significativa de tempo de trabalho na otimiza√ß√£o do sistema, e ainda ser√° mais lucrativo do que comprar ferro. <br><br><h1>  Planejamento de capacidade </h1><br>  Antes de empreender qualquer coisa, √© importante entender se h√° algum problema.  Se ela n√£o estiver l√°, vale a pena tentar prever quando ela poder√° aparecer.  Esse processo √© chamado de planejamento de capacidade. <br><br>  Um indicador concreto da presen√ßa de problemas de desempenho √© o tempo de resposta.  Na verdade, n√£o importa se a CPU (ou outros recursos) √© carregada em 6% ou 146%: se um cliente recebe um servi√ßo da qualidade necess√°ria em um tempo satisfat√≥rio, tudo funciona bem. <br><br>  A desvantagem de se concentrar no tempo de resposta √© que ele geralmente come√ßa a aumentar apenas quando o problema j√° apareceu.  Se ainda n√£o √©, √© dif√≠cil prever sua apar√™ncia.  Al√©m disso, o tempo de resposta reflete os resultados da influ√™ncia de todos os fatores (servi√ßos de frenagem, rede, unidades, etc.) e n√£o fornece uma compreens√£o das causas dos problemas. <br><br>  No nosso caso, a CPU geralmente √© o gargalo; portanto, ao planejar o tamanho e o desempenho dos clusters, prestamos aten√ß√£o principalmente √†s m√©tricas associadas ao seu uso.  Coletamos o uso da CPU de todas as nossas m√°quinas e constru√≠mos gr√°ficos com o valor m√©dio, mediana, percentil 75 e 95: <br><br><img src="https://habrastorage.org/webt/pt/xs/dr/ptxsdr6jybv45cznqjykeqd11_g.png"><br>  <i>Utiliza√ß√£o da CPU de m√°quinas de cluster em porcentagem: m√©dia, mediana, percentis</i> <br><br>  Existem centenas de m√°quinas em nossos clusters que foram adicionadas l√° por muitos anos.  Eles s√£o diferentes em configura√ß√£o e desempenho (o cluster n√£o √© homog√™neo).  Nosso balanceador leva isso em considera√ß√£o ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">artigo</a> e <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">v√≠deo</a> ) e carrega as m√°quinas de acordo com suas capacidades.  Para controlar esse processo, tamb√©m temos um cronograma de m√°quinas com carga m√°xima e m√≠nima. <br><br><img src="https://habrastorage.org/webt/nf/we/f7/nfwef7cixau-uxenwsglrnvfzho.png"><br>  <i>As m√°quinas de cluster mais e menos carregadas</i> <br><br>  Se voc√™ olhar esses gr√°ficos (ou apenas a sa√≠da do comando top) e ver a carga da CPU de 50%, voc√™ pensaria que ainda temos uma margem para um aumento duplo na carga.  Mas, na verdade, esse geralmente n√£o √© o caso.  E aqui est√° o porqu√™. <br><br><h1>  Hyper threading </h1><br>  Imagine um √∫nico n√∫cleo sem hiper-pisar.  N√≥s o carregamos com um thread vinculado √† CPU.  Veremos 100% de carregamento na parte superior. <br><br>  Agora ative a hiper-leitura neste kernel e carregue-o exatamente da mesma maneira.  No topo, j√° veremos dois n√∫cleos l√≥gicos e a carga total ser√° de 50% (geralmente em um 0% e no outro 100%). <br><br><img src="https://habrastorage.org/webt/gr/zi/hw/grzihwfkj986zatrfrsrgg4-ykk.png"><br>  <i>Utiliza√ß√£o da CPU: principais dados e o que realmente acontece</i> <br><br>  Como se o processador tivesse apenas 50% de carga.  Mas fisicamente nenhum n√∫cleo livre adicional apareceu.  O Hypertreading permite, <i>em alguns casos,</i> executar em um n√∫cleo f√≠sico mais de um processo por vez.  Mas isso est√° longe de dobrar o desempenho em situa√ß√µes t√≠picas, embora no gr√°fico de uso da CPU pare√ßa metade dos recursos: de 50% a 100%. <br><br>  Isso significa que, ap√≥s 50% do uso da CPU quando o hipertreading estiver ativado, ele n√£o crescer√° da mesma forma que antes. <br><br>  Eu escrevi este c√≥digo para demonstrar (este √© algum tipo de caso sint√©tico, na realidade os resultados ser√£o diferentes): <br><br><div class="spoiler">  <b class="spoiler_title">C√≥digo de script</b> <div class="spoiler_text"><pre><code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> $concurrency = $_SERVER[<span class="hljs-string"><span class="hljs-string">'argv'</span></span>][<span class="hljs-number"><span class="hljs-number">1</span></span>] ?? <span class="hljs-number"><span class="hljs-number">1</span></span>; $hashes = <span class="hljs-number"><span class="hljs-number">100000000</span></span>; $chunkSize = intval($hashes / $concurrency); $t1 = microtime(<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); $children = <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>(); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> ($i = <span class="hljs-number"><span class="hljs-number">0</span></span>; $i &lt; $concurrency; $i++) {    $pid = pcntl_fork();    <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-number"><span class="hljs-number">0</span></span> === $pid) {        $first = $i * $chunkSize;        $last = ($i + <span class="hljs-number"><span class="hljs-number">1</span></span>) * $chunkSize - <span class="hljs-number"><span class="hljs-number">1</span></span>;        <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> ($j = $first; $j &lt; $last; $j++) {            $dummy = md5($j);        }        printf(<span class="hljs-string"><span class="hljs-string">"[%d]: %d hashes in %0.4f sec\n"</span></span>, $i, $last - $first, microtime(<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>) - $t1);        <span class="hljs-keyword"><span class="hljs-keyword">exit</span></span>;    } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> {        $children[$pid] = <span class="hljs-number"><span class="hljs-number">1</span></span>;    } } <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (count($children) &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) {    $pid = pcntl_waitpid(<span class="hljs-number"><span class="hljs-number">-1</span></span>, $status);    <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($pid &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) {        <span class="hljs-keyword"><span class="hljs-keyword">unset</span></span>($children[$pid]);    } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> {        <span class="hljs-keyword"><span class="hljs-keyword">exit</span></span>(<span class="hljs-string"><span class="hljs-string">"Got a error pid=$pid"</span></span>);    } }</code> </pre> <br><br></div></div><br>  Eu tenho dois n√∫cleos f√≠sicos no meu laptop.  Execute esse c√≥digo com diferentes dados de entrada para medir seu desempenho com um n√∫mero diferente de processos C paralelos. <br><br><div class="spoiler">  <b class="spoiler_title">Resultados da medi√ß√£o</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/n5/3z/ev/n53zevyyvda4w4u-2xkjryqlj9m.png"><br></div></div><br>  Tra√ßamos os resultados dos lan√ßamentos: <br><img src="https://habrastorage.org/webt/xg/iv/rn/xgivrnyyynb418fnr5muqfn0qba.png"><br>  <i>Desempenho do script, dependendo do n√∫mero de processos paralelos</i> <br><br>  No que voc√™ pode prestar aten√ß√£o: <br><br><ul><li>  C = 1 e C = 2 s√£o previsivelmente os mesmos para HT = ativado e HT = desativado, o desempenho duplica quando um n√∫cleo f√≠sico √© adicionado; <br></li></ul><br><ul><li>  em C = 3, as vantagens do HT tornam-se vis√≠veis: para HT = ativado, conseguimos obter desempenho adicional, enquanto para HT = desativado com C = 3 em diante, ele come√ßa a diminuir previsivelmente lentamente; <br></li></ul><br><ul><li>  em C = 4, vemos todos os benef√≠cios da TH;  conseguimos extrair 30% de produtividade adicional, mas em compara√ß√£o com C = 2 no momento, o uso da CPU aumentou de 50% para 100%. <br></li></ul><br>  Total, vendo nos 50% superiores da carga da CPU, ao executar esse script, obtemos 8.065 Mhash / s e 100% - 10.511 Mhash / s.  Isso significa que em cerca de 50% do topo, obtemos 8,065 / 10,511 ~ 77% do desempenho m√°ximo do sistema e, de fato, temos cerca de 100% restantes na reserva - 77% = 23% e n√£o 50%, como pode parecer. <br><br>  Esse fato deve ser considerado no planejamento. <br><br><img src="https://habrastorage.org/webt/ru/6g/00/ru6g002t0ziv1pkppgqfjber80o.png"><br>  <i>Utiliza√ß√£o da CPU para demoscript: principais dados e o que realmente acontece</i> <br><br><h1>  Inconsist√™ncia no tr√°fego </h1><br>  Al√©m da hipertrofia, o planejamento tamb√©m complica a irregularidade do tr√°fego, dependendo da hora do dia, dia da semana, esta√ß√£o do ano e outras frequ√™ncias.  Para n√≥s, por exemplo, o pico √© domingo √† noite. <br><br><img src="https://habrastorage.org/webt/eh/ks/58/ehks58pfn7sjva3c869i7cwj7fy.png"><br>  <i>N√∫mero de pedidos por segundo, pico no domingo √† noite</i> <br><br>  Nem sempre o n√∫mero de solicita√ß√µes muda de maneira √≥bvia.  Por exemplo, os usu√°rios podem de alguma forma interagir com outros usu√°rios: a atividade de alguns pode gerar push / email para outros e, portanto, envolv√™-los no processo.  Para isso, s√£o adicionadas campanhas promocionais que aumentam o tr√°fego e para as quais voc√™ tamb√©m precisa estar preparado. <br><br>  Tamb√©m √© importante considerar tudo isso ao planejar: por exemplo, criar uma tend√™ncia nos dias de pico e ter em mente a poss√≠vel n√£o linearidade do pico de crescimento. <br><br><h1>  Ferramentas de perfil e medi√ß√£o </h1><br>  Suponha que descobrimos que h√° problemas de desempenho, entenda que esse n√£o √© o banco de dados / servi√ßos / outras coisas e, no entanto, decidimos otimizar o c√≥digo.  Para fazer isso, primeiro de tudo, precisamos de um criador de perfil ou de algumas ferramentas para encontrar gargalos e, posteriormente, ver os resultados de nossas otimiza√ß√µes. <br><br>  Infelizmente, para o PHP hoje, n√£o existe uma boa ferramenta universal. <br><br><h2>  perf </h2><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">perf</a> √© uma ferramenta de cria√ß√£o de perfil incorporada ao kernel do Linux.  √â um criador de perfil de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">amostra</a> que √© iniciado por um processo separado, portanto, n√£o adiciona diretamente uma sobrecarga ao programa que est√° sendo criado.  As sobrecargas indiretamente adicionadas s√£o uniformemente "borradas", de modo que n√£o distorcem as medi√ß√µes. <br><br>  Por todas as suas vantagens, o perf √© capaz de trabalhar apenas com c√≥digo compilado e com JIT e n√£o √© capaz de trabalhar com c√≥digo em execu√ß√£o "em uma m√°quina virtual".  Portanto, o pr√≥prio c√≥digo PHP n√£o pode ser perfilado nele, mas voc√™ pode ver claramente como o PHP funciona por dentro, incluindo v√°rias extens√µes PHP e quanto recursos s√£o gastos nele. <br><br>  Por exemplo, com perf, encontramos v√°rios gargalos, incluindo um local de compress√£o, que discutirei abaixo. <br><br>  Um exemplo: <br><br> <code>perf record --call-graph dwarf,65528 -F 99 -p $(pgrep php-cgi | paste -sd "," -) -- sleep 20 <br> perf report</code> <br> <br>  (se o processo e o perf forem executados sob diferentes usu√°rios, o perf precisar√° ser executado no sudo). <br><br><img src="https://habrastorage.org/webt/k9/vu/k6/k9vuk6sf37xhshipgvx2byw3xps.png"><br>  <i>Exemplo de sa√≠da de relat√≥rio Perf para PHP-FPM</i> <br><br><h2>  Agregador XHProf e XHProf </h2><br>  XHProf √© uma extens√£o para PHP que coloca temporizadores em torno de todas as chamadas para fun√ß√µes / m√©todos e tamb√©m cont√©m ferramentas para visualizar os resultados assim obtidos.  Diferentemente do perf, ele permite que voc√™ opere com termos de c√≥digo PHP (ao mesmo tempo, o que est√° acontecendo nas extens√µes n√£o √© vis√≠vel). <br><br>  As desvantagens incluem duas coisas: <br><br><ul><li>  todas as medi√ß√µes s√£o coletadas no √¢mbito de uma √∫nica solicita√ß√£o, portanto, n√£o fornecem informa√ß√µes sobre a imagem como um todo; <br></li><li>  a sobrecarga, embora <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">n√£o seja t√£o grande</a> quanto, por exemplo, ao usar o Xdebug, mas √©, e em alguns casos, os resultados s√£o bastante distorcidos (quanto mais vezes uma fun√ß√£o √© chamada e quanto mais simples √©, maior a distor√ß√£o). <br></li></ul><br>  Aqui est√° um exemplo que ilustra o √∫ltimo ponto: <br><br><pre> <code class="php hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">child1</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">child2</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">parent1</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ child1(); child2(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> ($i = <span class="hljs-number"><span class="hljs-number">0</span></span>; $i &lt; <span class="hljs-number"><span class="hljs-number">1000000</span></span>; $i++) { parent1(); }</code> </pre> <br><img src="https://habrastorage.org/webt/iw/7m/y6/iw7my6irzq5xg7_soy7sfkqpj7m.png"><br>  <i>Sa√≠da XHProf para demos: parent1 √© ordens de magnitude maiores que a soma de child1 e child2</i> <br><br>  Pode-se observar que parent1 () foi executado ~ 500 vezes mais que child1 () + child2 (), embora, na realidade, esses n√∫meros devam ser aproximadamente iguais, assim como main () e parent1 (). <br><br>  Se a √∫ltima desvantagem √© dif√≠cil de combater, para combater a primeira, criamos um complemento para o XHProf, que agrega os perfis de diferentes solicita√ß√µes e visualiza os dados agregados. <br><br>  Al√©m do XHProf, existem muitos outros criadores de perfil menos conhecidos trabalhando com um princ√≠pio semelhante.  Eles t√™m vantagens e desvantagens semelhantes. <br><br><h2>  Pinba </h2><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">O Pinba</a> permite <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">monitorar o desempenho por</a> scripts (a√ß√µes) e por temporizadores predefinidos.  Todas as medidas no contexto dos scripts s√£o feitas prontamente, para isso, nenhuma etapa adicional √© necess√°ria.  Para cada script e cron√¥metro, a <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">getrusage</a> √© <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">executada</a> , para que saibamos exatamente quanto tempo do processador foi gasto em uma parte espec√≠fica do c√≥digo (diferente dos criadores de perfil de amostragem, onde esse tempo pode se transformar em rede, disco etc.).  O Pinba √© √≥timo para salvar dados hist√≥ricos e obter uma imagem em geral e dentro de tipos espec√≠ficos de consultas. <br><br><img src="https://habrastorage.org/webt/od/x5/qr/odx5qryl0ufhceiuyjkytjhtm0c.png"><br>  <i>A confus√£o geral de todos os scripts obtidos de Pinba</i> <br><br>  As desvantagens incluem o fato de que os cron√¥metros que perfilam se√ß√µes espec√≠ficas do c√≥digo, e n√£o os scripts inteiros, devem ser organizados com anteced√™ncia no c√≥digo, bem como a presen√ßa de uma sobrecarga que (como no XHProf) pode distorcer os dados. <br><br><h2>  phpspy </h2><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">O phpspy</a> √© um projeto relativamente novo (o primeiro commit no GitHub foi h√° meio ano), que parece promissor, por isso estamos monitorando de perto. <br><br>  Do ponto de vista do usu√°rio, o phpspy √© semelhante ao perf: um processo paralelo √© iniciado, que copia periodicamente as partes da mem√≥ria do processo PHP, analisa-as e recebe rastreamentos de pilha e outros dados a partir da√≠.  Isso √© feito de uma maneira bastante espec√≠fica.  Para minimizar a sobrecarga, o phpspy n√£o interrompe o processo PHP e copia a mem√≥ria diretamente enquanto est√° em execu√ß√£o.  Isso leva ao fato de que o criador de perfil pode obter um estado inconsistente, rastreamentos de pilha podem ser quebrados.  Mas o phpspy pode detectar isso e descartar esses dados. <br><br>  No futuro, usando esta ferramenta, ser√° poss√≠vel coletar dados da imagem como um todo e perfis de tipos espec√≠ficos de consultas. <br><br><h2>  Tabela de compara√ß√£o </h2><br>  Para estruturar as diferen√ßas entre as ferramentas, vamos criar uma tabela din√¢mica: <br><br><img src="https://habrastorage.org/webt/bg/1a/bt/bg1abtxk-f8i5q83qm5teok3lbs.png"><br>  <i>Compara√ß√£o dos principais recursos dos criadores de perfil</i> <br>  <i><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Gr√°ficos de chama</a></i> <br><br><h1>  Otimiza√ß√£o e abordagens </h1><br>  Com essas ferramentas, monitoramos constantemente o desempenho e o uso de nossos recursos.  Quando eles s√£o usados ‚Äã‚Äãinjustificadamente ou estamos nos aproximando do limite (para a CPU, escolhemos empiricamente um valor de 55% para ter uma margem de tempo em caso de crescimento), como escrevi acima, uma das solu√ß√µes para o problema √© a otimiza√ß√£o. <br><br>  Bem, se a otimiza√ß√£o j√° foi feita por outra pessoa, como foi o caso do PHP 7.0, quando esta vers√£o se mostrou muito mais produtiva do que as anteriores.  Geralmente tentamos usar tecnologias e ferramentas modernas, incluindo atualiza√ß√µes oportunas para as vers√µes mais recentes do PHP.  De acordo com <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">benchmarks</a> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">p√∫blicos</a> , o PHP 7.2 √© 5-12% mais r√°pido que o PHP 7.1.  Mas essa transi√ß√£o, infelizmente, nos deu muito menos. <br><br>  Durante todo o tempo, implementamos um grande n√∫mero de otimiza√ß√µes.  Infelizmente, a maioria deles est√° fortemente relacionada √† nossa l√≥gica de neg√≥cios.  Vou falar sobre aqueles que podem ser relevantes n√£o apenas para n√≥s, ou sobre id√©ias e abordagens que podem ser usadas fora do nosso c√≥digo. <br><br><h2>  Compacta√ß√£o Zlib =&gt; zstd </h2><br>  Usamos compacta√ß√£o para grandes chaves de memkey.  Isso nos permite gastar tr√™s a quatro vezes menos mem√≥ria para armazenamento devido aos custos adicionais da CPU para compacta√ß√£o / descompacta√ß√£o.  Usamos o zlib para isso (nossa extens√£o para trabalhar com memekes √© diferente daquela que vem com o PHP, mas os oficiais <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">tamb√©m</a> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">usam o</a> zlib). <br><br>  Em perf, a produ√ß√£o era algo assim: <br><br> <code>+    4.03%     0.22% php-cgi  libz.so.1.2.11      [.] inflate <br> +    3.38%     0.00% php-cgi  libz.so.1.2.11      [.] deflate</code> <br> <br>  7-8% do tempo foi gasto em compress√£o / descompress√£o. <br><br>  Decidimos testar diferentes n√≠veis e algoritmos de compacta√ß√£o.  Verificou-se que o zstd roda nossos dados quase dez vezes mais r√°pido, perdendo 1,1 vezes.  Uma mudan√ßa bastante simples no algoritmo nos salvou ~ 7,5% da CPU (isso, lembro-me, em nossos volumes √© equivalente a ~ 45 servidores). <br><br>  √â importante entender que a propor√ß√£o do desempenho de diferentes algoritmos de compacta√ß√£o pode variar bastante, dependendo dos dados de entrada.  Existem v√°rias <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">compara√ß√µes</a> , mas com mais precis√£o isso s√≥ pode ser estimado usando exemplos do mundo real. <br><br><h2>  IS_ARRAY_IMMUTABLE como reposit√≥rio de dados raramente modificados </h2><br>  Ao trabalhar com tarefas reais, √© necess√°rio lidar com esses dados que voc√™ precisa frequentemente e ao mesmo tempo raramente mudam e t√™m um tamanho limitado.  Temos muitos dados semelhantes, um bom exemplo √© a configura√ß√£o de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">testes divididos</a> .  Verificamos se o usu√°rio se enquadra nas condi√ß√µes de um teste espec√≠fico e, dependendo disso, mostramos a ele a funcionalidade experimental ou normal (isso acontece quase durante cada solicita√ß√£o).  Em outros projetos, configura√ß√µes e v√°rios diret√≥rios podem ser um exemplo: pa√≠ses, cidades, idiomas, categorias, marcas, etc. <br><br>  Como esses dados costumam ser solicitados, o recebimento deles pode criar uma carga adicional percept√≠vel tanto no pr√≥prio aplicativo quanto no servi√ßo no qual esses dados s√£o armazenados.  O √∫ltimo problema pode ser resolvido, por exemplo, usando o APCu, que usa a mem√≥ria da mesma m√°quina executando o PHP-FPM como armazenamento.  Mas mesmo assim: <br><br><ul><li>  haver√° custos de serializa√ß√£o / desserializa√ß√£o; <br></li><li>  voc√™ precisa de alguma forma invalidar os dados ao alterar; <br></li><li>  H√° alguma sobrecarga em compara√ß√£o ao acesso a apenas uma vari√°vel no PHP. <br></li></ul><br>  O PHP 7.0 apresenta a otimiza√ß√£o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">IS_ARRAY_IMMUTABLE</a> .  Se voc√™ declarar uma matriz, cujos elementos s√£o conhecidos no momento da compila√ß√£o, ela ser√° processada e colocada na mem√≥ria OPCache uma vez, os funcion√°rios do PHP-FPM se referir√£o a essa mem√≥ria compartilhada sem gastar seu tempo antes de tentar mudar.  Da mesma forma, a inclus√£o de uma matriz levar√° tempo constante, independentemente do tamanho (geralmente ~ 1 microssegundo). <br><br>  Para compara√ß√£o: um exemplo do tempo para obter uma matriz de 10.000 elementos atrav√©s de include e apcu_fetch: <br><br><pre> <code class="php hljs">$t0 = microtime(<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); $a = <span class="hljs-keyword"><span class="hljs-keyword">include</span></span> <span class="hljs-string"><span class="hljs-string">'test-incl-1.php'</span></span>; $t1 = microtime(<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); printf(<span class="hljs-string"><span class="hljs-string">"include (%d): %d microsec\n"</span></span>, count($a), ($t1-$t0) * <span class="hljs-number"><span class="hljs-number">1e6</span></span>); $t0 = microtime(<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); $a = apcu_fetch(<span class="hljs-string"><span class="hljs-string">'a'</span></span>); $t1 = microtime(<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); printf(<span class="hljs-string"><span class="hljs-string">"apcu_fetch (%d): %d microsec\n"</span></span>, count($a), ($t1-$t0) * <span class="hljs-number"><span class="hljs-number">1e6</span></span>); <span class="hljs-comment"><span class="hljs-comment">//include (10000): 1 microsec //apcu_fetch (10000): 792 microsec</span></span></code> </pre><br>  Verificar se essa otimiza√ß√£o foi aplicada pode ser muito simples se voc√™ observar os c√≥digos de opera√ß√£o gerados: <br><br><pre> <code class="php hljs">$ cat immutable.php <span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> [ <span class="hljs-string"><span class="hljs-string">'key1'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'val1'</span></span>, <span class="hljs-string"><span class="hljs-string">'key2'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'val2'</span></span>, <span class="hljs-string"><span class="hljs-string">'key3'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'val3'</span></span>, ]; $ cat mutable.php <span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> [ <span class="hljs-string"><span class="hljs-string">'key1'</span></span> =&gt; \SomeClass::CONST_1, <span class="hljs-string"><span class="hljs-string">'key2'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'val2'</span></span>, <span class="hljs-string"><span class="hljs-string">'key3'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'val3'</span></span>, ]; $ php -d opcache.enable=<span class="hljs-number"><span class="hljs-number">1</span></span> -d opcache.enable_cli=<span class="hljs-number"><span class="hljs-number">1</span></span> -d opcache.opt_debug_level=<span class="hljs-number"><span class="hljs-number">0x20000</span></span> immutable.php $_main: ; (lines=<span class="hljs-number"><span class="hljs-number">1</span></span>, args=<span class="hljs-number"><span class="hljs-number">0</span></span>, vars=<span class="hljs-number"><span class="hljs-number">0</span></span>, tmps=<span class="hljs-number"><span class="hljs-number">0</span></span>) ; (after optimizer) ; /home/ubuntu/immutable.php:<span class="hljs-number"><span class="hljs-number">1</span></span><span class="hljs-number"><span class="hljs-number">-8</span></span> L0 (<span class="hljs-number"><span class="hljs-number">4</span></span>): <span class="hljs-keyword"><span class="hljs-keyword">RETURN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>(...) $ php -d opcache.enable_cli=<span class="hljs-number"><span class="hljs-number">1</span></span> -d opcache.opt_debug_level=<span class="hljs-number"><span class="hljs-number">0x20000</span></span> mutable.php $_main: ; (lines=<span class="hljs-number"><span class="hljs-number">5</span></span>, args=<span class="hljs-number"><span class="hljs-number">0</span></span>, vars=<span class="hljs-number"><span class="hljs-number">0</span></span>, tmps=<span class="hljs-number"><span class="hljs-number">2</span></span>) ; (after optimizer) ; /home/ubuntu/mutable.php:<span class="hljs-number"><span class="hljs-number">1</span></span><span class="hljs-number"><span class="hljs-number">-8</span></span> L0 (<span class="hljs-number"><span class="hljs-number">4</span></span>): T1 = FETCH_CLASS_CONSTANT string(<span class="hljs-string"><span class="hljs-string">"SomeClass"</span></span>) string(<span class="hljs-string"><span class="hljs-string">"CONST_1"</span></span>) L1 (<span class="hljs-number"><span class="hljs-number">4</span></span>): T0 = INIT_ARRAY <span class="hljs-number"><span class="hljs-number">3</span></span> T1 string(<span class="hljs-string"><span class="hljs-string">"key1"</span></span>) L2 (<span class="hljs-number"><span class="hljs-number">5</span></span>): T0 = ADD_ARRAY_ELEMENT string(<span class="hljs-string"><span class="hljs-string">"val2"</span></span>) string(<span class="hljs-string"><span class="hljs-string">"key2"</span></span>) L3 (<span class="hljs-number"><span class="hljs-number">6</span></span>): T0 = ADD_ARRAY_ELEMENT string(<span class="hljs-string"><span class="hljs-string">"val3"</span></span>) string(<span class="hljs-string"><span class="hljs-string">"key3"</span></span>) L4 (<span class="hljs-number"><span class="hljs-number">6</span></span>): <span class="hljs-keyword"><span class="hljs-keyword">RETURN</span></span> T0</code> </pre><br>  No primeiro caso, pode-se ver que h√° apenas um c√≥digo de opera√ß√£o no arquivo - o retorno da matriz finalizada.  No segundo caso, sua forma√ß√£o elemento a elemento ocorre sempre que esse arquivo √© executado. <br><br>  Assim, √© poss√≠vel gerar estruturas de uma forma que n√£o exija mais transforma√ß√£o no tempo de execu√ß√£o.  Por exemplo, em vez de desmontar os nomes das classes pelos sinais ‚Äú_‚Äù e ‚Äú\‚Äù a cada vez para o carregamento autom√°tico, voc√™ pode pr√©-gerar o mapa de correspond√™ncia ‚ÄúClass =&gt; Path‚Äù.  Nesse caso, a fun√ß√£o de convers√£o ser√° reduzida para uma √∫nica chamada de tabela de hash.  O Composer faz esse tipo de otimiza√ß√£o se voc√™ ativar a <a href="">op√ß√£o optimize-autoloader</a> . <br><br>  Para invalidar esses dados, voc√™ n√£o precisa fazer nada espec√≠fico - o pr√≥prio PHP recompilar√° o arquivo ao alterar, da mesma forma que faria com uma implanta√ß√£o normal de c√≥digo.  A √∫nica desvantagem que voc√™ n√£o deve esquecer: se o arquivo for muito grande, a primeira solicita√ß√£o ap√≥s a altera√ß√£o causar√° uma recompila√ß√£o, o que pode levar um tempo tang√≠vel. <br><br><h2>  O desempenho inclui / requer </h2><br>  Ao contr√°rio do exemplo de matriz est√°tica, anexar arquivos com declara√ß√µes de classe e fun√ß√£o n√£o √© t√£o r√°pido.  Apesar da presen√ßa do OPCache, o mecanismo PHP deve copi√°-los na mem√≥ria do processo, conectando depend√™ncias recursivamente, o que pode levar centenas de microssegundos ou mesmo milissegundos por arquivo. <br><br>  Se voc√™ criar um novo projeto vazio no <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Symfony 4.1</a> e colocar <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">get_included_files () como a</a> primeira linha da a√ß√£o, poder√° ver que 310 arquivos j√° est√£o conectados.  Em um projeto real, esse n√∫mero pode atingir milhares por solicita√ß√£o.  Vale a pena prestar aten√ß√£o nas seguintes coisas. <br><br>  <b>Falta de recursos de carregamento autom√°tico</b> <br><br>  Existe a <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">fun√ß√£o Autoloading RFC</a> , mas nenhum desenvolvimento foi visto por v√°rios anos.  Portanto, se uma depend√™ncia no Composer define fun√ß√µes fora da classe e essas fun√ß√µes devem estar acess√≠veis ao usu√°rio, isso √© feito <a href="">obrigatoriamente conectando um</a> arquivo com essas fun√ß√µes a cada inicializa√ß√£o do carregador autom√°tico. <br><br>  Por exemplo, removendo uma das depend√™ncias do composer.json, que declara muitas fun√ß√µes e √© facilmente substitu√≠da por cem linhas de c√≥digo, conquistamos alguns por cento da CPU. <br><br>  <b>O carregador autom√°tico √© chamado com mais frequ√™ncia do que parece.</b> <br><br>  Para demonstrar a ideia, crie um arquivo com uma classe: <br><br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">A</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">B</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">C</span></span></span><span class="hljs-class"> </span></span>{   <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">D</span></span>;   <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> AC1 = \E::E1;   <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> AC2 = \F::F1;   <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> $as3 = \G::G1;   <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> $as4 = \H::H1;   <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> $a5 = \I::I1;   <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> $a6 = \J::J1;   <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__construct</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(\K $k = null)</span></span></span><span class="hljs-function"> </span></span>{}   <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">asf1</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(\L $l = null)</span></span></span><span class="hljs-function"> :? </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">LR</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; }   <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">asf2</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(\M $m = null)</span></span></span><span class="hljs-function"> :? </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">MR</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; }   <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">af3</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(\N $n = null)</span></span></span><span class="hljs-function"> :? </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">NR</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; }   <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">af4</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(\P $p = null)</span></span></span><span class="hljs-function"> :? </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">PR</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; } }</code> </pre> <br>  <b>Registre o carregador autom√°tico:</b> <br><br><pre> <code class="php hljs">spl_autoload_register(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($name)</span></span></span><span class="hljs-function"> </span></span>{   <span class="hljs-keyword"><span class="hljs-keyword">echo</span></span> <span class="hljs-string"><span class="hljs-string">"Including $name...\n"</span></span>;   <span class="hljs-keyword"><span class="hljs-keyword">include</span></span> <span class="hljs-string"><span class="hljs-string">"$name.php"</span></span>; });</code> </pre> <br>  <b>E faremos v√°rios casos de uso para esta classe:</b> <br><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">include</span></span> <span class="hljs-string"><span class="hljs-string">'A.php'</span></span> Including B... Including D... Including C... \A::AC1 Including A... Including B... Including D... Including C... Including E... <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> A() Including A... Including B... Including D... Including C... Including E... Including F... Including G... Including H... Including I... Including J...</code> </pre><br>  Voc√™ pode perceber que, quando de alguma forma conectamos a classe, mas n√£o criamos sua inst√¢ncia, o pai, as interfaces e os tra√ßos ser√£o conectados.  Isso √© feito recursivamente para todos os arquivos conectados conforme resolvidos. <br><br>  Ao criar uma inst√¢ncia, a resolu√ß√£o de todas as constantes e campos √© adicionada a isso, o que leva √† conex√£o de todos os arquivos necess√°rios para isso, o que, por sua vez, tamb√©m causar√° a conex√£o recursiva de caracter√≠sticas, pais e interfaces das classes rec√©m-conectadas. <br><br><img src="https://habrastorage.org/webt/8a/qq/2t/8aqq2tf_8j-mixi8p_ydoypo-yo.png"><br>  <i>Conectando Classes Relacionadas para o Processo de Cria√ß√£o da Inst√¢ncia e Outros Casos</i> <br><br>  N√£o existe uma solu√ß√£o universal para esse problema, basta manter isso em mente e monitorar as conex√µes entre as classes: uma linha pode gerar a conex√£o de centenas de arquivos. <br><br>  <b>Configura√ß√µes do OPCache</b> <br><br>  Se voc√™ usar o m√©todo <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">atomic deploy alterando o link simb√≥lico</a> proposto por Rasmus Lerdorf, o criador do PHP, para <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">resolver o</a> problema de "colar" o link simb√≥lico na vers√£o antiga, inclua opcache.revalidate_path, como recomendado, por exemplo, neste <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">artigo</a> sobre OPCache traduzido por Mail .Ru Group. <br><br>  O problema √© que esta op√ß√£o significativamente (em m√©dia, uma vez e meia a duas vezes) aumenta o tempo de inclus√£o de cada arquivo.  No total, isso pode consumir uma quantidade significativa de recursos (no nosso caso, desabilitar essa op√ß√£o deu um ganho de 7 a 9%). <br><br>  Para desativ√°-lo, voc√™ precisa fazer duas coisas: <br><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">fa√ßa o</a> servidor <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">da</a> web resolver links simb√≥licos; <br></li><li>  pare de conectar arquivos dentro do script PHP ao longo dos caminhos que cont√™m links simb√≥licos ou force-os atrav√©s de readlink () ou realpath (). <br></li></ul><br>  Se todos os arquivos estiverem conectados ao carregador autom√°tico do Composer, o segundo item ser√° executado automaticamente ap√≥s a conclus√£o do primeiro: O compositor usa a constante __DIR__, que ser√° resolvida corretamente. <br><br>  O OPCache tem mais algumas op√ß√µes que podem aumentar o desempenho em troca de flexibilidade.  Voc√™ pode ler mais sobre isso no <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">artigo</a> que mencionei acima. <br><br>  Apesar de todas essas otimiza√ß√µes, a inclus√£o ainda n√£o ser√° gratuita.  Para combater isso, o PHP 7.4 planeja adicionar <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">pr√©-carregamento</a> . <br><br><h2>  APCu Lock </h2><br>  Embora n√£o falemos de bancos de dados e servi√ßos aqui, v√°rios tipos de bloqueios tamb√©m podem ocorrer no c√≥digo, o que aumenta o tempo de execu√ß√£o do script. <br><br>  √Ä medida que as solicita√ß√µes aumentavam, notamos uma desacelera√ß√£o acentuada da resposta nos hor√°rios de pico.  Depois de descobrir os motivos, descobriu-se que, embora o APCu seja a maneira mais r√°pida de obter dados (em compara√ß√£o com Memcache, Redis e outro armazenamento externo), ele tamb√©m pode trabalhar lentamente com a substitui√ß√£o freq√ºente das mesmas chaves. <br><br><img src="https://habrastorage.org/webt/hs/05/gc/hs05gcwvqozrqews1ewwtsskdyo.png"><br>  <i>N√∫mero de solicita√ß√µes por segundo e tempo de execu√ß√£o: picos em 16 e 17 de outubro</i> <br><br>  Ao usar o APCu como cache, esse problema n√£o √© t√£o relevante, porque o cache geralmente envolve grava√ß√£o rara e leitura frequente.  Mas algumas tarefas e algoritmos (por exemplo, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Disjuntor</a> ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">implementa√ß√£o em PHP</a> )) tamb√©m envolvem grava√ß√£o frequente, o que causa bloqueios. <br><br>  N√£o existe uma solu√ß√£o universal para esse problema, mas no caso do disjuntor, ele pode ser resolvido, por exemplo, colocando-o em um <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">servi√ßo separado</a> instalado em m√°quinas com PHP. <br><br><h2>  Processamento em lote </h2><br>  Mesmo que voc√™ n√£o leve em considera√ß√£o a inclus√£o, normalmente, uma parte significativa do tempo de execu√ß√£o da consulta √© gasta na inicializa√ß√£o: uma estrutura (por exemplo, construindo um cont√™iner de DI e inicializando todas as suas depend√™ncias, roteamento, execu√ß√£o de todos os ouvintes), aumentando a sess√£o, Usu√°rio e assim por diante. mais adiante. <br><br>  Se o seu back-end √© uma API interna para alguma coisa, algumas solicita√ß√µes de clientes podem ser agrupadas e enviadas como uma √∫nica solicita√ß√£o.  Nesse caso, a inicializa√ß√£o ser√° realizada uma vez para v√°rias solicita√ß√µes. <br><br>      ,   ,    .    -  ,          .       . <br><br><h2>    </h2><br>    Badoo   ,     .    PHP-FPM,      CPU,   ,            ,    :        IO, CPU  . <br><br>      PHP-FPM    ‚Äî  ,          PHP. <br><br>         (CPU, IO),    . , ,       ,  ,    -     ,        .        ,     .   ,  ,      . <br><br><h1>  Conclus√£o </h1><br>        .                    PHP     . <br><br>  : <br><br><ul><li>       ; <br></li><li>     ; <br></li><li>  -  ,  :  ,    ; <br></li><li>   :       (, ,  ); <br></li><li>    :     ; <br></li><li>   , OPCache    PHP,  , ,   ; <br></li><li>    :       (, ,   PHP 7.2   ,   ); <br></li><li>    : ,        . <br></li></ul><br>       ? <br><br>  Obrigado pela aten√ß√£o! </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt430722/">https://habr.com/ru/post/pt430722/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt430710/index.html">O que fazer se a Black Friday for amanh√£ e seus servidores n√£o estiverem prontos</a></li>
<li><a href="../pt430712/index.html">NeurIPS: Como conquistar a melhor confer√™ncia de ML</a></li>
<li><a href="../pt430714/index.html">VMware compra Heptio - o que isso significa para o Kubernetes</a></li>
<li><a href="../pt430718/index.html">Para quais objetos vale a pena usar a vigil√¢ncia por v√≠deo na nuvem?</a></li>
<li><a href="../pt430720/index.html">Intel RealSense D435i: pequena atualiza√ß√£o e breve digress√£o hist√≥rica</a></li>
<li><a href="../pt430724/index.html">DEFCON 21. A confer√™ncia DNS pode ser perigosa para sua sa√∫de. Parte 1</a></li>
<li><a href="../pt430728/index.html">Ensine-me a dar feedback</a></li>
<li><a href="../pt430730/index.html">O que a P&D ABBYY faz: Grupo de Pesquisa Avan√ßada em PNL</a></li>
<li><a href="../pt430732/index.html">Para a quest√£o da divis√£o e TI</a></li>
<li><a href="../pt430734/index.html">Atualiza√ß√µes inteligentes x contratos inteligentes</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>