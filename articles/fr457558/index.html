<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üõ¥ üàÅ üì∑ Analyse de vuln√©rabilit√© EvilParcel üéπ üéø ü§¶üèø</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Pr√©sentation 
 √Ä la mi-avril, nous avons publi√© des informations sur le cheval de Troie Android.InfectionAds.1 , qui exploitait plusieurs vuln√©rabilit...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Analyse de vuln√©rabilit√© EvilParcel</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/drweb/blog/457558/"><h3>  Pr√©sentation </h3><br>  √Ä la mi-avril, nous avons <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">publi√© des informations</a> sur le cheval de Troie <b>Android.InfectionAds.1</b> , qui exploitait plusieurs vuln√©rabilit√©s critiques dans le syst√®me d'exploitation Android.  L'un d'eux - CVE-2017-13156 (√©galement connu sous le nom de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Janus</a> ) - permet √† un programme malveillant d'infecter les fichiers APK sans endommager leur signature num√©rique. <br><br>  L'autre est CVE-2017-13315.  Il conf√®re au cheval de Troie des privil√®ges avanc√©s et peut installer et d√©sinstaller ind√©pendamment des applications.  Une analyse d√©taill√©e d' <b>Android.InfectionAds.1 est</b> disponible dans notre biblioth√®que de virus, vous pouvez la trouver <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ici</a> .  Nous allons nous attarder sur la vuln√©rabilit√© CVE-2017-13315 plus en d√©tail et voir √† quoi elle ressemble. <br><a name="habracut"></a><br>  CVE-2017-13315 appartient au groupe de vuln√©rabilit√©s qui a re√ßu le nom g√©n√©ral EvilParcel.  Ils se trouvent dans diff√©rentes classes de syst√®me du syst√®me d'exploitation Android.  En raison d'erreurs dans ce dernier lors de l'√©change de donn√©es entre les applications et le syst√®me, il devient possible de remplacer ces donn√©es.  Les programmes malveillants qui exploitent les vuln√©rabilit√©s EvilParcel re√ßoivent des privil√®ges plus √©lev√©s et peuvent effectuer les op√©rations suivantes avec leur aide: <br><br><ul><li>  installer et d√©sinstaller des applications avec toutes les autorisations sans confirmation de l'utilisateur; </li><li>  lorsqu'il est utilis√© conjointement avec d'autres vuln√©rabilit√©s, infecter les programmes install√©s sur l'appareil et remplacer les originaux ¬´propres¬ª par des copies infect√©es; </li><li>  R√©initialiser le code de verrouillage d'√©cran pour l'appareil Android </li><li>  R√©initialisez le code PIN de l'√©cran de verrouillage de l'appareil Android. </li></ul><br>  Il existe actuellement 7 vuln√©rabilit√©s connues de ce type: <br><br><ul><li>  CVE-2017-0806 (erreur dans la classe GateKeeperResponse), publi√©e en octobre 2017; </li><li>  CVE-2017-13286 (erreur dans la classe OutputConfiguration, publi√©e en avril 2018; </li><li>  CVE-2017-13287 (erreur dans la classe VerifyCredentialResponse), publi√©e en avril 2018; </li><li>  CVE-2017-13288 (erreur dans la classe PeriodicAdvertizingReport), publi√©e en avril 2018; </li><li>  CVE-2017-13289 (bogue dans la classe ParcelableRttResults), publi√© en avril 2018; </li><li>  CVE-2017-13311 (bogue dans la classe SparseMappingTable), publi√© en mai 2018; </li><li>  CVE-2017-13315 (erreur dans la classe DcParamObject), publi√© en mai 2018. </li></ul><br>  Tous menacent les appareils ex√©cutant Android OS versions 5.0 - 8.1 sur lesquels les mises √† jour de s√©curit√© de mai 2018 et ult√©rieures ne sont pas install√©es. <br><br><h3>  Conditions pr√©alables aux vuln√©rabilit√©s EvilParcel </h3><br>  Voyons comment les vuln√©rabilit√©s EvilParcel surviennent.  Tout d'abord, nous allons examiner certaines des fonctionnalit√©s des applications Android.  Dans Android OS, tous les programmes interagissent entre eux, ainsi qu'avec le syst√®me d'exploitation lui-m√™me, en envoyant et en recevant des objets de type Intent.  Ces objets peuvent contenir un nombre arbitraire de paires cl√©-valeur √† l'int√©rieur d'un objet de type Bundle. <br><br>  Lors de la transmission de l'intention, l'objet Bundle est converti (s√©rialis√©) en un tableau d'octets envelopp√© dans Parcel, et lors de la lecture des cl√©s et des valeurs d'un bundle s√©rialis√©, il est automatiquement d√©s√©rialis√©. <br><br>  Dans le Bundle, la cha√Æne est la cl√© et la valeur peut √™tre presque n'importe quoi.  Par exemple, un type primitif, une cha√Æne ou un conteneur contenant des types ou des cha√Ænes primitifs.  De plus, il peut s'agir d'un objet de type Parcelable. <br><br>  Ainsi, dans le Bundle, vous pouvez placer un objet de tout type qui impl√©mente l'interface Parcelable.  Pour ce faire, vous devrez impl√©menter les m√©thodes writeToParcel () et createFromParcel () pour s√©rialiser et d√©s√©rialiser l'objet. <br><br>  Comme bon exemple, cr√©ons un bundle s√©rialis√© simple.  √âcrivons un code qui place trois paires cl√©-valeur dans le bundle et le s√©rialise: <br><br>  D√©mo de bundle = nouveau bundle (); <br>  demo.putString ("String", "Bonjour tout le monde!"); <br>  demo.putInt ("Integer", 42); <br>  demo.putByteArray ("ByteArray", nouvel octet [] {1, 2, 3, 4, 5, 6, 7, 8}); <br>  Parcel parcel = Parcel.obtain (); <br>  parcel.writeBundle (d√©mo); <br><br>  Apr√®s avoir ex√©cut√© ce code, nous obtenons un ensemble du formulaire suivant: <br><br><img src="https://habrastorage.org/webt/53/gn/x5/53gnx5bjhjfdaqjr5isxgva6fzg.png"><br><br>  <b>Figure 1.</b> Structure d'un objet Bundle s√©rialis√©. <br><br>  Prenons attention aux fonctionnalit√©s suivantes de la s√©rialisation Bundle: <br><br><ul><li>  toutes les paires cl√©-valeur sont √©crites l'une apr√®s l'autre; </li><li>  avant chaque valeur, son type est indiqu√© (13 pour un tableau d'octets, 1 pour un entier, 0 pour une cha√Æne, etc.); </li><li>  avant les donn√©es de longueur variable, leur taille est indiqu√©e (longueur pour la cha√Æne, nombre d'octets pour le tableau); </li><li>  toutes les valeurs sont √©crites avec un alignement de 4 octets. </li></ul><br>  Du fait que toutes les cl√©s et valeurs du Bundle sont √©crites s√©quentiellement, lors de l'acc√®s √† une cl√© ou √† la valeur d'un objet Bundle s√©rialis√©, ce dernier est compl√®tement d√©s√©rialis√©, y compris l'initialisation de tous les objets Parcelable qui y sont contenus. <br><br>  Il semblerait, quel pourrait √™tre le probl√®me?  Et c'est que dans certaines classes syst√®me qui impl√©mentent Parcelable, les m√©thodes createFromParcel () et writeToParcel () peuvent rencontrer des erreurs.  Dans ces classes, le nombre d'octets lus dans la m√©thode createFromParcel () sera diff√©rent du nombre d'octets √©crits dans la m√©thode writeToParcel ().  Si vous placez un objet d'une telle classe √† l'int√©rieur du Bundle, les limites de l'objet √† l'int√©rieur du Bundle changeront apr√®s la re-s√©rialisation.  Et c'est l√† que les conditions d'exploitation de la vuln√©rabilit√© EvilParcel sont cr√©√©es. <br><br>  Voici un exemple d'une classe avec une erreur similaire: <br><br><pre><code class="java hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Demo</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Parcelable</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[] data; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Demo</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.data = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[<span class="hljs-number"><span class="hljs-number">0</span></span>]; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Demo</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Parcel in)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> length = in.readInt(); data = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[length]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (length &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) { in.readByteArray(data); } } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Creator&lt;Demo&gt; CREATOR = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Creator&lt;Demo&gt;() { <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Demo </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">createFromParcel</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Parcel in)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Demo(in); } }; <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">writeToParcel</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Parcel parcel, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> i)</span></span></span><span class="hljs-function"> </span></span>{ parcel.writeInt(data.length); parcel.writeByteArray(data); } }</code> </pre> <br>  Si la taille du tableau de donn√©es est 0, lors de la cr√©ation d'un objet dans createFromParcel (), un int (4 octets) sera lu et deux int (8 octets) seront √©crits dans writeToParcel ().  Le premier entier sera √©crit dans un appel explicite √† writeInt.  Le deuxi√®me entier sera √©crit lorsque writeByteArray () est appel√©, car la longueur du tableau est toujours √©crite dans Parcel avant lui (voir la figure 1). <br><br>  Les situations o√π la taille du tableau de donn√©es est 0 sont rares.  Mais m√™me lorsque cela se produit, le programme continue de fonctionner si un seul objet est transmis sous forme s√©rialis√©e √† la fois (dans notre exemple, l'objet Demo).  Par cons√©quent, de telles erreurs, en r√®gle g√©n√©rale, passent inaper√ßues. <br><br>  Essayons maintenant de placer un objet Demo avec une longueur de tableau nulle dans le Bundle: <br><br><img src="https://habrastorage.org/webt/2y/2v/i0/2y2vi0ftdkartg9i01cc-b858g0.png"><br>  <b>Figure 2.</b> R√©sultat de l'ajout d'un objet de d√©monstration avec une longueur de tableau nulle au bundle. <br><br>  Nous s√©rialisons l'objet: <br><br><img src="https://habrastorage.org/webt/hv/tw/if/hvtwifj9curkc7ip6jplbdlk-yc.png"><br>  <b>Figure 3.</b> Bundle objet apr√®s la s√©rialisation. <br><br>  Essayons de le d√©s√©rialiser: <br><br><img src="https://habrastorage.org/webt/_u/a1/k4/_ua1k4hp34wknsvnppv8zla0jei.png"><br>  <b>Figure 4.</b> Apr√®s d√©s√©rialisation de l'objet Bundle. <br><br>  Quel est le r√©sultat?  Consid√©rez un extrait de colis: <br><br><img src="https://habrastorage.org/webt/g0/qs/y4/g0qsy4cigykwv2gxgpizo2qsu7u.png"><br>  <b>Figure 5.</b> Structure du colis apr√®s d√©s√©rialisation du faisceau. <br><br>  D'apr√®s les figures 4 et 5, nous voyons que pendant la d√©s√©rialisation, un entier a √©t√© lu dans la m√©thode createFromParcel au lieu de deux pr√©c√©demment √©crits.  Par cons√©quent, toutes les valeurs suivantes de l'ensemble n'ont pas √©t√© lues correctement.  La valeur 0x0 √† l'adresse 0x60 a √©t√© lue comme la longueur de la cl√© suivante.  Et la valeur 0x1 √† l'adresse 0x64 a √©t√© lue comme une cl√©.  Dans ce cas, la valeur 0x31 √† l'adresse 0x68 a √©t√© lue comme type de valeur.  Il n'y a aucune valeur dans Parcel dont le type est 0x31, donc readFromParcel () a fid√®lement signal√© une erreur (exception). <br><br>  Comment cela peut-il √™tre utilis√© dans la pratique et devenir une vuln√©rabilit√©?  Voyons voir!  L'erreur d√©crite ci-dessus dans les classes syst√®me Parcelable vous permet de construire Bundle, qui peut diff√©rer lors de la premi√®re et des d√©s√©rialisations r√©p√©t√©es.  Pour illustrer cela, modifiez l'exemple pr√©c√©dent: <br><br><pre> <code class="java hljs">Parcel data = Parcel.obtain(); data.writeInt(<span class="hljs-number"><span class="hljs-number">3</span></span>); <span class="hljs-comment"><span class="hljs-comment">// 3 entries data.writeString("vuln_class"); data.writeInt(4); // value is Parcelable data.writeString("com.drweb.testbundlemismatch.Demo"); data.writeInt(0); // data.length data.writeInt(1); // key length -&gt; key value data.writeInt(6); // key value -&gt; value is long data.writeInt(0xD); // value is bytearray -&gt; low(long) data.writeInt(-1); // bytearray length dummy -&gt; high(long) int startPos = data.dataPosition(); data.writeString("hidden"); // bytearray data -&gt; hidden key data.writeInt(0); // value is string data.writeString("Hi there"); // hidden value int endPos = data.dataPosition(); int triggerLen = endPos - startPos; data.setDataPosition(startPos - 4); data.writeInt(triggerLen); // overwrite dummy value with the real value data.setDataPosition(endPos); data.writeString("A padding"); data.writeInt(0); // value is string data.writeString("to match pair count"); int length = data.dataSize(); Parcel bndl = Parcel.obtain(); bndl.writeInt(length); bndl.writeInt(0x4C444E42); // bundle magic bndl.appendFrom(data, 0, length); bndl.setDataPosition(0);</span></span></code> </pre> <br>  Ce code cr√©e un bundle s√©rialis√© qui contient une classe vuln√©rable.  Regardons le r√©sultat de l'ex√©cution de ce code: <br><br><img src="https://habrastorage.org/webt/tc/ke/wf/tckewffnaop28wllxnrt7pagdvs.png"><br>  <b>Figure 6.</b> Cr√©ation d'un bundle avec une classe vuln√©rable. <br><br>  Apr√®s la premi√®re d√©s√©rialisation, ce bundle contiendra les cl√©s suivantes: <br><br><img src="https://habrastorage.org/webt/cj/si/l0/cjsil0--g_jsoew8ht-oxely1u4.png"><br>  <b>Figure 7.</b> R√©sultat de la d√©s√©rialisation d'un bundle avec une classe vuln√©rable. <br><br>  Maintenant, s√©rialisez √† nouveau le bundle r√©sultant, puis d√©s√©rialisez-le √† nouveau et consultez la liste des cl√©s: <br><br><img src="https://habrastorage.org/webt/uw/e1/mj/uwe1mjdtywr59oyshaah2q1gkus.png"><br>  <b>Figure 8.</b> R√©sultat de la re-s√©rialisation et de la d√©s√©rialisation d'un bundle avec une classe vuln√©rable. <br><br>  Que voyons-nous?  La cl√© cach√©e (avec la valeur de cha√Æne ¬´Hi there!¬ª) Est apparue dans le bundle, qui n'√©tait pas l√† auparavant.  Consid√©rez l'extrait de colis de cet ensemble pour comprendre pourquoi cela s'est produit: <br><br><img src="https://habrastorage.org/webt/cx/za/dz/cxzadza4tugyeemlefk1lmlkdbu.png"><br>  <b>Figure 9.</b> Structure de parcelle de l'objet Bundle avec la classe vuln√©rable apr√®s deux cycles de s√©rialisation-d√©s√©rialisation. <br><br>  Ici, l'essence des vuln√©rabilit√©s EvilParcel devient plus claire.  Il est possible de cr√©er un Bundle sp√©cialement form√© qui contiendra une classe vuln√©rable.  Changer les limites de cette classe vous permettra de placer n'importe quel objet dans ce Bundle - par exemple, Intent, qui n'appara√Ætra dans le Bundle qu'apr√®s la deuxi√®me d√©s√©rialisation.  Cela permettra de masquer Intent aux m√©canismes de protection du syst√®me d'exploitation. <br><br><h3>  Op√©ration EvilParcel </h3><br>  Android.InfectionAds.1 utilisant CVE-2017-13315 a install√© et d√©sinstall√© seul des programmes sans l'intervention du propri√©taire de l'appareil infect√©.  Mais comment √ßa se passe? <br><br>  En 2013, l'erreur <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">7699048</a> a √©galement √©t√© d√©couverte, √©galement connue sous le nom de Launch AnyWhere.  Il a permis √† une application tierce d'ex√©cuter des activit√©s arbitraires au nom du syst√®me utilisateur le plus privil√©gi√©.  Le sch√©ma ci-dessous montre son m√©canisme d'action: <br><br><img src="https://habrastorage.org/webt/dg/no/n9/dgnon92txtobknvvgr5eo2cmi54.png"><br>  <b>Figure 10.</b> Sch√©ma d'erreur 7699048. <br><br>  Avec cette vuln√©rabilit√©, une application d'exploitation pourrait impl√©menter le service AccountAuthenticator, qui est con√ßu pour ajouter de nouveaux comptes au syst√®me d'exploitation.  Gr√¢ce au bogue 7699048, l'exploit est capable d'ex√©cuter une activit√© pour installer, d√©sinstaller, remplacer des applications, r√©initialiser le code PIN ou le verrouillage de mod√®le et faire d'autres choses d√©sagr√©ables. <br><br>  Google a corrig√© cet √©cart en interdisant le lancement d'activit√©s arbitraires depuis AccountManager.  D√©sormais, le AccountManager ne permet que le lancement d'activit√©s provenant de la m√™me application.  Pour ce faire, il v√©rifie et compare la signature num√©rique du programme qui a initi√© le d√©marrage de l'activit√© avec la signature de l'application dans laquelle se situe l'activit√© lanc√©e.  Cela ressemble √† ceci: <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (result != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span> &amp;&amp; (intent = result.getParcelable(AccountManager.KEY_INTENT)) != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { <span class="hljs-comment"><span class="hljs-comment">/* * The Authenticator API allows third party authenticators to * supply arbitrary intents to other apps that they can run, * this can be very bad when those apps are in the system like * the System Settings. */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> authenticatorUid = Binder.getCallingUid(); <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> bid = Binder.clearCallingIdentity(); <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { PackageManager pm = mContext.getPackageManager(); ResolveInfo resolveInfo = pm.resolveActivityAsUser(intent, <span class="hljs-number"><span class="hljs-number">0</span></span>, mAccounts.userId); <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> targetUid = resolveInfo.activityInfo.applicationInfo.uid; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (PackageManager.SIGNATURE_MATCH != pm.checkSignatures(authenticatorUid, targetUid)) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SecurityException( <span class="hljs-string"><span class="hljs-string">"Activity to be started with KEY_INTENT must "</span></span> + <span class="hljs-string"><span class="hljs-string">"share Authenticator's signatures"</span></span>); } } <span class="hljs-keyword"><span class="hljs-keyword">finally</span></span> { Binder.restoreCallingIdentity(bid); } }</code> </pre><br>  Il semblerait que le probl√®me ait √©t√© r√©solu, mais tout n'est pas si fluide ici.  Il s'est av√©r√© que ce correctif peut √™tre contourn√© en utilisant la vuln√©rabilit√© bien connue EvilParcel CVE-2017-13315!  Comme nous le savons d√©j√†, apr√®s avoir corrig√© Launch AnyWhere, le syst√®me v√©rifie la signature num√©rique de l'application.  Si cette v√©rification r√©ussit, le bundle est transmis √† IAccountManagerResponse.onResult ().  Dans le m√™me temps, onResult () est appel√© via le m√©canisme IPC, de sorte que le bundle est √† nouveau s√©rialis√©.  Dans l'impl√©mentation onResult (), les √©v√©nements suivants se produisent: <br><br><pre> <code class="java hljs"><span class="hljs-comment"><span class="hljs-comment">/** Handles the responses from the AccountManager */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Response</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">IAccountManagerResponse</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Stub</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onResult</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Bundle bundle)</span></span></span><span class="hljs-function"> </span></span>{ Intent intent = bundle.getParcelable(KEY_INTENT); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (intent != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span> &amp;&amp; mActivity != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { <span class="hljs-comment"><span class="hljs-comment">// since the user provided an Activity we will silently start intents // that we see mActivity.startActivity(intent); // leave the Future running to wait for the real response to this request } //&lt;.....&gt; } //&lt;.....&gt; }</span></span></code> </pre><br>  Ensuite, le Bundle est extrait de la cl√© d'intention et l'activit√© est lanc√©e sans v√©rifications.  Par cons√©quent, pour d√©marrer une activit√© arbitraire avec des droits syst√®me, il suffit de construire le Bundle de telle sorte que le champ d'intention soit masqu√© lors de la premi√®re d√©s√©rialisation et apparaisse lors de la seconde d√©s√©rialisation.  Et, comme nous l'avons d√©j√† vu, c'est pr√©cis√©ment cette t√¢che que remplissent les vuln√©rabilit√©s EvilParcel. <br><br>  √Ä l'heure actuelle, toutes les vuln√©rabilit√©s connues de ce type sont corrig√©es par des correctifs dans les classes Parcelable vuln√©rables elles-m√™mes.  Cependant, la r√©apparition de classes vuln√©rables √† l'avenir ne peut √™tre exclue.  La mise en ≈ìuvre du Bundle et le m√©canisme d'ajout de nouveaux comptes sont toujours les m√™mes qu'auparavant.  Ils vous permettent toujours de cr√©er exactement le m√™me exploit lorsque vous d√©couvrez (ou de nouvelles) classes Parcelable vuln√©rables.  De plus, l'impl√©mentation de ces classes se fait toujours manuellement et le programmeur doit garder un ≈ìil sur la longueur constante de l'objet Parcelable s√©rialis√©.  Et c'est un facteur humain avec toutes les cons√©quences.  Cependant, nous esp√©rons que ces erreurs seront aussi peu nombreuses que possible et que les vuln√©rabilit√©s d'EvilParcel ne d√©rangeront pas les utilisateurs d'appareils Android. <br><br>  Vous pouvez v√©rifier votre appareil mobile pour les vuln√©rabilit√©s EvilParcel en utilisant notre antivirus <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Dr.Web Security Space</a> .  Le ¬´v√©rificateur de s√©curit√©¬ª int√©gr√© rendra compte des probl√®mes identifi√©s et formulera des recommandations pour les r√©soudre. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr457558/">https://habr.com/ru/post/fr457558/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr457542/index.html">Piratage et protection des lecteurs de chiffrement LUKS</a></li>
<li><a href="../fr457546/index.html">Demo Day: pourquoi tout cela et comment le faire UPD + Broadcast</a></li>
<li><a href="../fr457548/index.html">G√©n√©ration de signal PWM multiphas√© sur TMS320F28027</a></li>
<li><a href="../fr457550/index.html">De quoi l'industrie num√©rique doit-elle √™tre prot√©g√©e</a></li>
<li><a href="../fr457552/index.html">Grimpeurs √† Zafasadia. Comment fonctionnent les promalps de la tour du centre de Lakhta</a></li>
<li><a href="../fr457560/index.html">Actions Tokenized: Comment devenir un investisseur Gett avant de passer en bourse</a></li>
<li><a href="../fr457562/index.html">Ivideon Counter 3D: qui, comment et pourquoi compter les visiteurs</a></li>
<li><a href="../fr457564/index.html">Estimer le co√ªt des syst√®mes informatiques d'une entreprise</a></li>
<li><a href="../fr457566/index.html">La pression est OK: Pourquoi le centre de donn√©es a-t-il besoin d'un contr√¥le de la pression atmosph√©rique?</a></li>
<li><a href="../fr457568/index.html">Congr√®s Futurologique: une s√©lection de t√©moignages des √©vang√©listes du futur</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>