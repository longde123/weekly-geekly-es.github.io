<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üßìüèΩ üë©üèΩ‚Äçüî¨ üëéüèæ Comment nous avons construit un cluster PostgreSQL fiable sur Patroni üí´ üë©üèø‚Äçü§ù‚Äçüë®üèº ‚öïÔ∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Aujourd'hui, une haute disponibilit√© des services est requise partout et toujours, pas seulement dans les grands projets co√ªteux. Les sites temporaire...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Comment nous avons construit un cluster PostgreSQL fiable sur Patroni</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/mailru/blog/452846/"><img src="https://habrastorage.org/getpro/habr/post_images/17a/6e9/29d/17a6e929d3e8e24203871d573b17ef0d.jpg"><br><br>  Aujourd'hui, une haute disponibilit√© des services est requise partout et toujours, pas seulement dans les grands projets co√ªteux.  Les sites temporairement indisponibles avec le message "D√©sol√©, la maintenance est en cours" se produisent toujours, mais provoquent g√©n√©ralement un sourire condescendant.  Ajoutez √† cela la vie dans les nuages, quand pour d√©marrer un serveur suppl√©mentaire, vous n'avez besoin que d'un seul appel √† l'API, et vous n'avez pas besoin de penser √† une op√©ration de ¬´repassage¬ª.  Et il n'y a plus d'excuse pour laquelle le syst√®me critique n'a pas √©t√© fabriqu√© de mani√®re fiable √† l'aide des technologies de cluster et de la redondance. <br><br>  Nous vous indiquerons les solutions que nous avons envisag√©es pour garantir la fiabilit√© des bases de donn√©es de nos services et ce √† quoi nous sommes parvenus.  Plus une d√©mo avec des conclusions de grande envergure. <br><a name="habracut"></a><br><h2>  H√©ritage dans l'architecture √† haute disponibilit√© </h2><br>  Ceci est encore mieux vu dans le contexte du d√©veloppement de divers syst√®mes open source.  Les anciennes solutions ont √©t√© forc√©es d'ajouter des technologies √† haute disponibilit√© √† mesure que la demande augmentait.  Et leur qualit√© √©tait diff√©rente.  Les solutions de nouvelle g√©n√©ration placent la haute disponibilit√© au c≈ìur de leur architecture.  Par exemple, MongoDB positionne le cluster comme cas d'utilisation principal.  Le cluster √©volue horizontalement, ce qui constitue un fort avantage concurrentiel de ce SGBD. <br><br>  Revenons √† PostgreSQL.  Il s'agit de l'un des plus anciens projets open source populaires, dont la premi√®re version a eu lieu au cours de la 95e ann√©e du si√®cle dernier.  Pendant longtemps, l'√©quipe du projet n'a pas consid√©r√© la haute disponibilit√© comme une t√¢che qui devait √™tre trait√©e par le syst√®me.  Par cons√©quent, la technologie de r√©plication pour cr√©er des copies de donn√©es n'a √©t√© int√©gr√©e qu'√† la version 8.2 en 2006, mais elle a √©t√© archiv√©e (envoi de journaux).  En 2010, la r√©plication en streaming est apparue dans la version 9.0 et constitue la base de la cr√©ation d'une grande vari√©t√© de clusters.  En fait, cela est tr√®s surprenant pour les personnes qui d√©couvrent PostgreSQL apr√®s Enterprise SQL ou NoSQL moderne - la solution standard de la communaut√© n'est qu'un couple de r√©pliques ma√Ætres avec r√©plication synchrone ou asynchrone.  Dans le m√™me temps, l'assistant est commut√© manuellement dans le drain, et le probl√®me du changement de client est √©galement propos√© pour √™tre r√©solu ind√©pendamment. <br><br><h2>  Comment nous avons d√©cid√© de rendre PostgreSQL fiable et ce que nous avons choisi pour cela </h2><br>  Cependant, PostgreSQL ne serait pas devenu si populaire s'il n'y avait pas un grand nombre de projets et d'outils qui aident √† cr√©er une solution tol√©rante aux pannes qui ne n√©cessite pas une attention constante.  Depuis le lancement de DBaaS, des serveurs PostgreSQL uniques et des paires de r√©pliques ma√Ætres avec r√©plication asynchrone sont disponibles dans <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Mail.ru Cloud Solutions</a> (MCS). <br><br>  Naturellement, nous voulions simplifier la vie de chacun et rendre disponible l'installation de PostgreSQL, qui pourrait servir de base √† des services hautement accessibles que vous n'auriez pas √† surveiller en permanence et √† vous r√©veiller la nuit pour effectuer le changement.  Dans ce segment, il existe √† la fois d'anciennes solutions √©prouv√©es et une g√©n√©ration de nouveaux utilitaires qui utilisent les derniers d√©veloppements. <br><br>  Aujourd'hui, le probl√®me de la haute disponibilit√© ne repose pas sur la redondance (il va sans dire), mais sur le consensus - un algorithme pour choisir un leader (√©lection du leader).  Le plus souvent, des accidents majeurs ne surviennent pas √† cause d'un manque de serveurs, mais √† cause de probl√®mes de consensus: un nouveau leader n'est pas sorti, deux leaders sont apparus dans diff√©rents centres de donn√©es, etc.  Un exemple est un crash sur le cluster Github MySQL - ils ont √©crit un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">post mortem d√©taill√©</a> . <br><br>  La base math√©matique en la mati√®re est tr√®s s√©rieuse.  D'une part, il existe un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">th√©or√®me CAP</a> , qui impose des restrictions th√©oriques sur la possibilit√© de construire des solutions HA, et d'autre part, des algorithmes de d√©termination de consensus math√©matiquement √©prouv√©s tels que <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Paxos</a> et <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Raft</a> .  Sur cette base, il existe des DCS (syst√®mes de consensus d√©centralis√©s) assez populaires - Zookeeper, etcd, Consul.  Par cons√©quent, si le syst√®me de prise de d√©cision fonctionne sur certains de ses propres algorithmes, √©crits ind√©pendamment, vous devez √™tre extr√™mement prudent √† ce sujet.  Apr√®s avoir analys√© un grand nombre de syst√®mes, nous nous sommes install√©s sur Patroni - un syst√®me open source, principalement d√©velopp√© par Zalando. <br><br>  En tant que digression lyrique, je dirai que nous avons √©galement envisag√© des solutions multi-ma√Ætres, c'est-√†-dire des clusters qui peuvent √™tre mis √† l'√©chelle horizontalement pour l'enregistrement.  Cependant, pour deux raisons principales, ils ont d√©cid√© de ne pas constituer un tel cluster.  Premi√®rement, ces solutions pr√©sentent une complexit√© √©lev√©e et, par cons√©quent, davantage de vuln√©rabilit√©s.  Il sera difficile de prendre une d√©cision stable pour tous les cas.  Deuxi√®mement, dans ce cas, PostgreSQL cesse d'√™tre pur (natif), certaines fonctions ne seront pas disponibles, certaines applications peuvent rencontrer des bogues cach√©s lorsqu'elles fonctionnent. <br><br><h2>  Patroni </h2><br>  Alors, comment fonctionne Patroni?  Les d√©veloppeurs n'ont pas r√©invent√© la roue et ont sugg√©r√© d'utiliser une des solutions DCS √©prouv√©es comme base.  Tous les probl√®mes de synchronisation des configurations, de choix d'un leader et de quorum lui sont donn√©s.  Nous avons choisi etcd pour cela. <br><br>  Ensuite, Patroni s'occupe de l'application correcte de tous les param√®tres de PostgreSQL et des param√®tres de r√©plication, ainsi que de l'ex√©cution des commandes de basculement et de basculement (c'est-√†-dire des assistants de commutation standard et non standard).  Plus pr√©cis√©ment, dans le cloud MCS, vous pouvez cr√©er un cluster √† partir d'un assistant, d'une r√©plique synchrone et d'une ou plusieurs r√©pliques asynchrones.  La pr√©sence d'une r√©plique synchrone garantit la s√©curit√© des donn√©es sur au moins 2 serveurs, et cette r√©plique sera le principal ¬´candidat pour le ma√Ætre¬ª. <br><br>  √âtant donn√© que etcd est d√©ploy√© sur les m√™mes serveurs, il est recommand√© que le nombre de serveurs soit de 3 ou 5, pour la valeur de quorum optimale.  Un tel cluster est mis √† l'√©chelle horizontalement pour la lecture (j'ai √©crit sur la mise √† l'√©chelle pour √©crire ci-dessus).  N√©anmoins, il convient de garder √† l'esprit que les r√©pliques asynchrones sont √† la tra√Æne, en particulier √† des charges √©lev√©es. <br><br>  L'utilisation de ces r√©plicas en attente de lecture est justifi√©e pour les t√¢ches de g√©n√©ration de rapports ou d'analyse et d√©charge le serveur ma√Ætre. <br><br>  Si vous souhaitez cr√©er un tel cluster vous-m√™me, vous aurez besoin de: <br><br><ul><li>  pr√©parer 3 serveurs ou plus, configurer l'adressage IP et les r√®gles de pare-feu entre eux; <br></li><li>  installer des packages pour les services etcd, Patroni, PostgreSQL; <br></li><li>  configurer le cluster etcd; <br></li><li>  configurer le service patroni pour fonctionner avec PostgreSQL. <br></li></ul><br>  C'est-√†-dire qu'au total, vous devez composer correctement une douzaine de fichiers de configuration et ne faire aucune erreur nulle part.  Pour ce faire, il vaut vraiment la peine d'utiliser un outil de gestion de configuration tel qu'Ansible, par exemple.  Cependant, il n'existe toujours pas d'√©quilibreur TCP hautement disponible.  Pour ce faire, c'est un travail distinct. <br><br>  Pour ceux qui ont besoin d'un cluster pr√™t √† l'emploi, mais ne veulent pas fouiner avec tout cela, nous avons essay√© de simplifier notre vie et avons cr√©√© un cluster pr√™t √† l'emploi sur Patroni dans notre cloud, il peut √™tre test√© gratuitement.  En plus du cluster lui-m√™me, nous avons fait: <br><br><ul><li>  √âquilibreur TCP  sur diff√©rents ports, il pointe toujours vers le ma√Ætre actuel, la r√©plique synchrone ou asynchrone, respectivement; <br></li><li>  API pour changer l'assistant Patroni actif. <br></li></ul><br>  Ils peuvent √™tre connect√©s √† la fois via l'API cloud MCS et la console Web. <br><br><h2>  D√©mo </h2><br>  Pour tester les capacit√©s du cluster PostgreSQL dans le cloud MCS, voyons comment une application en direct se comporte en cas de probl√®mes avec le SGBD. <br><br>  Voici le code d'une application qui enregistrera les √©v√©nements artificiels et les signalera √† l'√©cran.  En cas d'erreurs, il le signalera et continuera son travail dans un cycle jusqu'√† ce que nous l'arr√™tions avec la combinaison Ctrl + C. <br><br><pre><code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> __future__ <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> print_function <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> datetime <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> datetime <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> random <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> randint <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> time <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> sleep <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> psycopg2 <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">try</span></span>: connection = psycopg2.connect(user = <span class="hljs-string"><span class="hljs-string">"admin"</span></span>, password = <span class="hljs-string"><span class="hljs-string">"P@ssw0rd"</span></span>, host = <span class="hljs-string"><span class="hljs-string">"89.208.87.38"</span></span>, port = <span class="hljs-string"><span class="hljs-string">"5432"</span></span>, database = <span class="hljs-string"><span class="hljs-string">"myproddb"</span></span>) cursor = connection.cursor() cursor.execute(<span class="hljs-string"><span class="hljs-string">"SELECT version();"</span></span>) record = cursor.fetchone() print(<span class="hljs-string"><span class="hljs-string">"Connection opened to"</span></span>, record[<span class="hljs-number"><span class="hljs-number">0</span></span>]) cursor.execute( <span class="hljs-string"><span class="hljs-string">"INSERT INTO log VALUES ({});"</span></span>.format(randint(<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">10000</span></span>))) connection.commit() cursor.execute(<span class="hljs-string"><span class="hljs-string">"SELECT COUNT(event_id) from log;"</span></span>) record = cursor.fetchone() print(<span class="hljs-string"><span class="hljs-string">"Logged a value, overall count: {}"</span></span>.format(record[<span class="hljs-number"><span class="hljs-number">0</span></span>])) <span class="hljs-keyword"><span class="hljs-keyword">except</span></span> Exception <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> error: <span class="hljs-keyword"><span class="hljs-keyword">print</span></span> (<span class="hljs-string"><span class="hljs-string">"Error while connecting to PostgreSQL"</span></span>, error) <span class="hljs-keyword"><span class="hljs-keyword">finally</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> connection: cursor.close() connection.close() print(<span class="hljs-string"><span class="hljs-string">"Connection closed"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> __name__ == <span class="hljs-string"><span class="hljs-string">'__main__'</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">try</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> <span class="hljs-keyword"><span class="hljs-keyword">True</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">try</span></span>: print(datetime.now()) main() sleep(<span class="hljs-number"><span class="hljs-number">3</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">except</span></span> Exception <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> e: print(<span class="hljs-string"><span class="hljs-string">"Caught error:\n"</span></span>, e) sleep(<span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">except</span></span> KeyboardInterrupt: print(<span class="hljs-string"><span class="hljs-string">"exit"</span></span>)</code> </pre> <br>  Une application a besoin de PostgreSQL pour fonctionner.  Cr√©ez un cluster dans le cloud MCS √† l'aide de l'API.  Dans un terminal normal, o√π la variable OS_TOKEN contient un jeton pour acc√©der √† l'API (vous pouvez l'obtenir avec la commande d'√©mission de jeton openstack), nous tapons les commandes: <br><br>  Cr√©ez un cluster: <br><br><pre> <code class="bash hljs">cat &lt;&lt;EF &gt; pgc10.json {<span class="hljs-string"><span class="hljs-string">"cluster"</span></span>:{<span class="hljs-string"><span class="hljs-string">"name"</span></span>:<span class="hljs-string"><span class="hljs-string">"postgres10"</span></span>,<span class="hljs-string"><span class="hljs-string">"allow_remote_access"</span></span>:<span class="hljs-literal"><span class="hljs-literal">true</span></span>,<span class="hljs-string"><span class="hljs-string">"datastore"</span></span>:{<span class="hljs-string"><span class="hljs-string">"type"</span></span>:<span class="hljs-string"><span class="hljs-string">"postgresql"</span></span>,<span class="hljs-string"><span class="hljs-string">"version"</span></span>:<span class="hljs-string"><span class="hljs-string">"10"</span></span>},<span class="hljs-string"><span class="hljs-string">"databases"</span></span>:[{<span class="hljs-string"><span class="hljs-string">"name"</span></span>:<span class="hljs-string"><span class="hljs-string">"myproddb"</span></span>}],<span class="hljs-string"><span class="hljs-string">"users"</span></span>:[{<span class="hljs-string"><span class="hljs-string">"databases"</span></span>:[{<span class="hljs-string"><span class="hljs-string">"name"</span></span>:<span class="hljs-string"><span class="hljs-string">"myproddb"</span></span>}],<span class="hljs-string"><span class="hljs-string">"name"</span></span>:<span class="hljs-string"><span class="hljs-string">"admin"</span></span>,<span class="hljs-string"><span class="hljs-string">"password"</span></span>:<span class="hljs-string"><span class="hljs-string">"P@ssw0rd"</span></span>}],<span class="hljs-string"><span class="hljs-string">"instances"</span></span>:[{<span class="hljs-string"><span class="hljs-string">"key_name"</span></span>:<span class="hljs-string"><span class="hljs-string">"shared"</span></span>,<span class="hljs-string"><span class="hljs-string">"availability_zone"</span></span>:<span class="hljs-string"><span class="hljs-string">"DP1"</span></span>,<span class="hljs-string"><span class="hljs-string">"flavorRef"</span></span>:<span class="hljs-string"><span class="hljs-string">"d659fa16-c7fb-42cf-8a5e-9bcbe80a7538"</span></span>,<span class="hljs-string"><span class="hljs-string">"nics"</span></span>:[{<span class="hljs-string"><span class="hljs-string">"net-id"</span></span>:<span class="hljs-string"><span class="hljs-string">"b91eafed-12b1-4a46-b000-3984c7e01599"</span></span>}],<span class="hljs-string"><span class="hljs-string">"volume"</span></span>:{<span class="hljs-string"><span class="hljs-string">"size"</span></span>:50,<span class="hljs-string"><span class="hljs-string">"type"</span></span>:<span class="hljs-string"><span class="hljs-string">"DP1"</span></span>}},{<span class="hljs-string"><span class="hljs-string">"key_name"</span></span>:<span class="hljs-string"><span class="hljs-string">"shared"</span></span>,<span class="hljs-string"><span class="hljs-string">"availability_zone"</span></span>:<span class="hljs-string"><span class="hljs-string">"DP1"</span></span>,<span class="hljs-string"><span class="hljs-string">"flavorRef"</span></span>:<span class="hljs-string"><span class="hljs-string">"d659fa16-c7fb-42cf-8a5e-9bcbe80a7538"</span></span>,<span class="hljs-string"><span class="hljs-string">"nics"</span></span>:[{<span class="hljs-string"><span class="hljs-string">"net-id"</span></span>:<span class="hljs-string"><span class="hljs-string">"b91eafed-12b1-4a46-b000-3984c7e01599"</span></span>}],<span class="hljs-string"><span class="hljs-string">"volume"</span></span>:{<span class="hljs-string"><span class="hljs-string">"size"</span></span>:50,<span class="hljs-string"><span class="hljs-string">"type"</span></span>:<span class="hljs-string"><span class="hljs-string">"DP1"</span></span>}},{<span class="hljs-string"><span class="hljs-string">"key_name"</span></span>:<span class="hljs-string"><span class="hljs-string">"shared"</span></span>,<span class="hljs-string"><span class="hljs-string">"availability_zone"</span></span>:<span class="hljs-string"><span class="hljs-string">"DP1"</span></span>,<span class="hljs-string"><span class="hljs-string">"flavorRef"</span></span>:<span class="hljs-string"><span class="hljs-string">"d659fa16-c7fb-42cf-8a5e-9bcbe80a7538"</span></span>,<span class="hljs-string"><span class="hljs-string">"nics"</span></span>:[{<span class="hljs-string"><span class="hljs-string">"net-id"</span></span>:<span class="hljs-string"><span class="hljs-string">"b91eafed-12b1-4a46-b000-3984c7e01599"</span></span>}],<span class="hljs-string"><span class="hljs-string">"volume"</span></span>:{<span class="hljs-string"><span class="hljs-string">"size"</span></span>:50,<span class="hljs-string"><span class="hljs-string">"type"</span></span>:<span class="hljs-string"><span class="hljs-string">"DP1"</span></span>}}]}} EOF curl -s -H <span class="hljs-string"><span class="hljs-string">"X-Auth-Token: </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$OS_TOKEN</span></span></span><span class="hljs-string">"</span></span> \ -H <span class="hljs-string"><span class="hljs-string">'Accept: application/json'</span></span> \ -H <span class="hljs-string"><span class="hljs-string">'Content-Type: application/json'</span></span> \ -d @pgc10.json https://infra.mail.ru:8779/v1.0/ce2a41bbd1434013b85bdf0ba07c770f/clusters</code> </pre><br><img src="https://habrastorage.org/getpro/habr/post_images/f2c/aee/463/f2caee46351a0f304dac92483739a3c5.png"><br><br>  Lorsque le cluster entre dans l'√©tat ACTIF, tous les champs recevront les valeurs actuelles - le cluster est pr√™t. <br><br>  Dans l'interface graphique: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/8b2/0de/606/8b20de6065c6c703282c27f96a67724f.png"><br><br>  Essayons de nous connecter et de cr√©er une table: <br><br><pre> <code class="bash hljs">psql -h 89.208.87.38 -U admin -d myproddb Password <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> user admin: psql (11.1, server 10.7) Type <span class="hljs-string"><span class="hljs-string">"help"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> <span class="hljs-built_in"><span class="hljs-built_in">help</span></span>. myproddb=&gt; CREATE TABLE <span class="hljs-built_in"><span class="hljs-built_in">log</span></span> (event_id <span class="hljs-built_in"><span class="hljs-built_in">integer</span></span> NOT NULL); CREATE TABLE myproddb=&gt; INSERT INTO <span class="hljs-built_in"><span class="hljs-built_in">log</span></span> VALUES (1),(2),(3); INSERT 0 3 myproddb=&gt; SELECT * FROM <span class="hljs-built_in"><span class="hljs-built_in">log</span></span>; event_id ---------- 1 2 3 (3 rows) myproddb=&gt;</code> </pre><br><img src="https://habrastorage.org/getpro/habr/post_images/e04/c3f/7df/e04c3f7dfae02ca66e1f4163eb5b52d0.png"><br><br>  Dans l'application, nous indiquons les param√®tres actuels de connexion √† PostgreSQL.  Nous allons sp√©cifier l'adresse du TCP-balancer, √©liminant ainsi le besoin de basculer manuellement vers l'adresse de l'assistant.  Lancez-le.  Comme vous pouvez le voir, les √©v√©nements sont correctement enregistr√©s dans la base de donn√©es. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/e37/fd2/33c/e37fd233cc670185c6da974e8ef54f9f.png"><br><br><h2>  Interrupteur principal programm√© </h2><br>  Nous allons maintenant tester le fonctionnement de notre application lors du basculement pr√©vu de l'assistant: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/0d4/7de/e5d/0d47dee5d56f84efe7ade9790a219c8f.png"><br><br>  Nous regardons l'application.  On voit que l'application est vraiment interrompue, mais cela ne prend que quelques secondes, dans ce cas particulier, un maximum de 9. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/a52/d80/a34/a52d80a34309b6a0e771ca01a722a448.png"><br><br><h2>  Chute de voiture </h2><br>  Essayons maintenant de simuler la chute d'une machine virtuelle, le ma√Ætre actuel.  Il serait possible de simplement √©teindre la machine virtuelle via l'interface Horizon, seulement ce sera un arr√™t r√©gulier.  Un tel changement sera trait√© par tous les services, y compris Patroni. <br><br>  Nous avons besoin d'un arr√™t impr√©visible.  Par cons√©quent, j'ai demand√© √† nos administrateurs √† des fins de test de d√©sactiver la machine virtuelle - le ma√Ætre actuel - de mani√®re anormale. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/101/231/8c8/1012318c85c30c4717e6db5df430afc3.png"><br><br>  Dans le m√™me temps, notre application a continu√© de fonctionner.  Naturellement, un tel interrupteur d'urgence du ma√Ætre ne peut passer inaper√ßu. <br><br><pre> <code class="bash hljs">2019-03-29 10:45:56.071234 Connection opened to PostgreSQL 10.7 on x86_64-pc-linux-gnu, compiled by gcc (GCC) 4.8.5 20150623 (Red Hat 4.8.5-36), 64-bit Logged a value, overall count: 453 Connection closed 2019-03-29 10:45:59.205463 Connection opened to PostgreSQL 10.7 on x86_64-pc-linux-gnu, compiled by gcc (GCC) 4.8.5 20150623 (Red Hat 4.8.5-36), 64-bit Logged a value, overall count: 454 Connection closed 2019-03-29 10:46:02.661440 Error <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> connecting to PostgreSQL server closed the connection unexpectedly This probably means the server terminated abnormally before or <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> processing the request. Caught error: <span class="hljs-built_in"><span class="hljs-built_in">local</span></span> variable <span class="hljs-string"><span class="hljs-string">'connection'</span></span> referenced before assignment ‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶‚Ä¶.. -  -   2019-03-29 10:46:30.930445 Error <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> connecting to PostgreSQL server closed the connection unexpectedly This probably means the server terminated abnormally before or <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> processing the request. Caught error: <span class="hljs-built_in"><span class="hljs-built_in">local</span></span> variable <span class="hljs-string"><span class="hljs-string">'connection'</span></span> referenced before assignment 2019-03-29 10:46:31.954399 Connection opened to PostgreSQL 10.7 on x86_64-pc-linux-gnu, compiled by gcc (GCC) 4.8.5 20150623 (Red Hat 4.8.5-36), 64-bit Logged a value, overall count: 455 Connection closed 2019-03-29 10:46:35.409800 Connection opened to PostgreSQL 10.7 on x86_64-pc-linux-gnu, compiled by gcc (GCC) 4.8.5 20150623 (Red Hat 4.8.5-36), 64-bit Logged a value, overall count: 456 Connection closed ^Cexit</code> </pre><br>  Comme vous pouvez le voir, l'application a pu continuer son travail en moins de 30 secondes.  Oui, un certain nombre d'utilisateurs du service auront le temps de remarquer des probl√®mes.  Cependant, il s'agit d'une grave d√©faillance du serveur, cela ne se produit pas si souvent.  Dans le m√™me temps, la personne (administrateur) n'aurait gu√®re r√©ussi √† r√©agir aussi rapidement, √† moins d'√™tre assise dans la console pr√™te avec un script de commutation. <br><br><h2>  Conclusion </h2><br>  Il me semble qu'un tel cluster offre un √©norme avantage aux administrateurs.  En effet, de graves pannes et dysfonctionnements des serveurs de base de donn√©es ne seront pas perceptibles pour l'application et, par cons√©quent, pour l'utilisateur.  Vous n'aurez pas √† r√©parer quelque chose √† la h√¢te et √† passer √† des configurations temporaires, des serveurs, etc.  Et si vous utilisez cette solution sous la forme d'un service pr√™t √† l'emploi dans le cloud, vous n'aurez pas √† perdre de temps √† la pr√©parer.  Il sera possible de faire quelque chose de plus int√©ressant. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr452846/">https://habr.com/ru/post/fr452846/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr452836/index.html">Outils Web, ou par o√π commencer un pentester?</a></li>
<li><a href="../fr452838/index.html">Int√©gration de 3CX avec Office 365 via l'API Azure</a></li>
<li><a href="../fr452840/index.html">Conf√©rence VMware EMPOWER 2019: comment s'est pass√© le premier jour</a></li>
<li><a href="../fr452842/index.html">SMPP - Protocole de message court d'√©gal √† √©gal</a></li>
<li><a href="../fr452844/index.html">Transformation ou blasph√®me: comment ¬´num√©riser¬ª les op√©rateurs t√©l√©coms</a></li>
<li><a href="../fr452848/index.html">Que va-t-il se passer le 1er f√©vrier 2020?</a></li>
<li><a href="../fr452850/index.html">Syst√®mes √† l'int√©rieur des cartouches: comment les ing√©nieurs ont √©tendu les capacit√©s des consoles de jeux</a></li>
<li><a href="../fr452852/index.html">Travail √† distance: mythes la nuit</a></li>
<li><a href="../fr452854/index.html">D'un utilisateur r√©gulier √† un administrateur de serveur √† part enti√®re (XSS, LFI, Web-Shell)</a></li>
<li><a href="../fr452856/index.html">Pourquoi les projets ind√©pendants ne vivent pas pour sortir</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>