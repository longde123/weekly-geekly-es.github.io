<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🖖🏽 👩‍🚀 👩‍👩‍👦 Speicherung einer großen Anzahl von Dateien ☕️ 🖌️ 🚟</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Gute Gesundheit, Hawkers! Während der Arbeit an einem Dating-Site-Projekt wurde es notwendig, die Speicherung von Benutzerfotos zu organisieren. Gemäß...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Speicherung einer großen Anzahl von Dateien</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/423875/"><img src="https://habrastorage.org/webt/ti/up/px/tiuppxliueu75a1ycliw537yw-k.jpeg" alt="Bild"><br><br>  Gute Gesundheit, Hawkers!  Während der Arbeit an einem Dating-Site-Projekt wurde es notwendig, die Speicherung von Benutzerfotos zu organisieren.  Gemäß der Leistungsbeschreibung ist die Anzahl der Fotos pro Benutzer auf 10 Dateien begrenzt.  Aber es kann Zehntausende von Benutzern geben.  Besonders wenn man bedenkt, dass das Projekt in seiner jetzigen Form bereits ab dem Beginn der "Null" existiert.  Das heißt, die Datenbank enthält bereits Tausende von Benutzern.  Soweit ich weiß, reagiert fast jedes Dateisystem sehr negativ auf eine große Anzahl von untergeordneten Knoten in einem Ordner.  Aus Erfahrung kann ich sagen, dass Probleme nach 1000-1500 Dateien / Ordnern im übergeordneten Ordner beginnen. <br><a name="habracut"></a><br>  <i>Haftungsausschluss.</i>  <i>Ich habe vor dem Schreiben des Artikels gegoogelt und verschiedene Lösungen für das zur Diskussion stehende Problem gefunden (zum Beispiel <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">hier</a> oder <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">hier</a> ).</i>  <i>Aber ich habe keine einzige Lösung gefunden, die genau zu meiner passt.</i>  <i>Außerdem teile ich in diesem Artikel nur meine eigenen Erfahrungen bei der Lösung des Problems.</i> <br><br><h3>  Theorie </h3><br>  Neben der Speicheraufgabe als solche gab es in der Arbeitserklärung auch eine Bedingung, wonach Bildunterschriften und Bildunterschriften für Fotos hinterlassen werden mussten.  Natürlich können Sie nicht auf eine Datenbank verzichten.  Das heißt, wir erstellen zunächst eine Tabelle, in die wir die Metadatenzuordnung (Signaturen, Titel usw.) mit den Dateien auf der Festplatte schreiben.  Jede Datei entspricht einer Zeile in der Datenbank.  Dementsprechend hat jede Datei eine Kennung. <br><br>  Ein kleiner Exkurs.  Lassen Sie uns über das automatische Inkrementieren sprechen.  Eine Dating-Site kann ein Dutzend oder zweitausend Benutzer haben.  Die Frage ist, wie viele Benutzer das Projekt im Allgemeinen während der gesamten Dauer seines Bestehens durchlaufen.  Zum Beispiel ist das aktive Publikum von dating-ru mehrere hunderttausend.  Stellen Sie sich jedoch vor, wie viele Benutzer während der Laufzeit dieses Projekts noch übrig waren.  Wie viele Benutzer sind bisher nicht aktiviert?  Und jetzt fügen Sie unsere Gesetzgebung hinzu, die uns verpflichtet, Informationen über Benutzer mindestens sechs Monate lang zu speichern ... Früher oder später endet 4 mit einem Cent <b>UNSIGNED INT</b> .  Daher ist es am besten, <b>BIGINT</b> als Primärschlüssel zu verwenden. <br><br>  Versuchen wir nun, uns eine Reihe vom Typ <b>BIGINT vorzustellen</b> .  Das sind 8 Bytes.  Jedes Byte reicht von 0 bis 255. 255 untergeordnete Knoten sind für jedes Dateisystem ganz normal.  Das heißt, wir nehmen die Dateikennung in hexadezimaler Darstellung und teilen sie in Teile von zwei Zeichen auf.  Wir verwenden diese Chunks als Ordnernamen, letzterer als Namen der physischen Datei.  GEWINN! <br><br> <code>0f/65/84/10/67/68/19/ff.file</code> <br> <br>  Elegant und einfach.  Die Dateierweiterung ist hier nicht wichtig.  Auf jeden Fall wird die Datei von einem Skript bereitgestellt, das dem Browser einen bestimmten MIME-Typ gibt, den wir auch in der Datenbank speichern.  Durch Speichern von Informationen über die Datei in der Datenbank können Sie außerdem den Pfad für den Browser neu definieren.  Angenommen, die Datei, die wir haben, befindet sich tatsächlich relativ zum Projektverzeichnis entlang des Pfads <code>/content/files/0f/65/84/10/67/68/19/ff.file</code> .  In die Datenbank können Sie eine URL schreiben, z. B. <code>/content/users/678/files/somefile</code> .  SEOs sind im Moment wahrscheinlich ziemlich gelächelt.  All dies ermöglicht es uns, uns keine Gedanken mehr darüber zu machen, wo die Datei physisch abgelegt werden soll. <br><br><h3>  Tabelle in der Datenbank </h3><br>  Zusätzlich zu der Kennung, dem MIME-Typ, der URL und dem physischen Speicherort speichern wir md5- und sha1-Dateien in der Tabelle, um bei Bedarf dieselben Dateien herauszufiltern.  Natürlich müssen wir auch Entitätsbeziehungen in dieser Tabelle speichern.  Angenommen, die Benutzer-ID, zu der die Dateien gehören.  Und wenn das Projekt nicht sehr groß ist, können wir im selben System beispielsweise Fotos von Waren speichern.  Daher speichern wir auch den Namen der Entitätsklasse, zu der der Datensatz gehört. <br><br>  Apropos Vögel.  Wenn Sie den Ordner mit .htaccess für den externen Zugriff schließen, kann die Datei nur über das Skript abgerufen werden.  Und im Skript wird es möglich sein, den Zugriff auf die Datei zu bestimmen.  Mit Blick auf die Zukunft werde ich sagen, dass in meinem CMS (in dem das oben genannte Projekt gerade abgesägt wird) der Zugriff durch grundlegende Benutzergruppen bestimmt wird, von denen ich 8 habe - Gäste, Benutzer, Manager, Administratoren, inaktive, blockierte, gelöschte und Superadministratoren.  Super-Admin kann absolut alles, so dass es nicht an der Bestimmung des Zugriffs beteiligt ist.  Wenn der Benutzer ein Superadministrator-Flag hat, ist er ein Superadministrator.  Alles ist einfach.  Das heißt, wir werden den Zugriff auf die verbleibenden sieben Gruppen bestimmen.  Der Zugriff ist einfach - entweder geben Sie die Datei oder nicht geben.  Insgesamt können Sie ein Feld vom Typ <b>TINYINT nehmen</b> . <br><br>  Und noch etwas.  Gemäß unserem Gesetz müssen wir benutzerdefinierte Bilder physisch speichern.  Das heißt, wir müssen die Bilder irgendwie als gelöscht markieren, anstatt sie physisch zu löschen.  Es ist am bequemsten, für diese Zwecke ein Bitfeld zu verwenden.  In solchen Fällen verwende ich normalerweise ein Feld vom Typ <b>INT</b> .  Sozusagen reservieren.  Darüber hinaus habe ich bereits eine Tradition darin, die <b>DELETED-</b> Flagge im 5. Bit vom Ende an zu platzieren.  Aber es spielt wieder keine Rolle. <br><br>  Was haben wir als Ergebnis: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">table</span></span> <span class="hljs-string"><span class="hljs-string">`files`</span></span> ( <span class="hljs-string"><span class="hljs-string">`id`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">bigint</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> auto_increment, <span class="hljs-comment"><span class="hljs-comment">--   `entity_type` char(32) not null default '', --   `entity` bigint null, -- ID  `mime` char(32) not null default '', -- MIME- `md5` char(32) not null default '', -- MD5 `sha1` char(40) not null default '', -- SHA1 `file` char(64) not null default '', --   `url` varchar(250) not null default '', -- URL `meta` text null, -- -   JSON    `size` bigint not null default '0', --  `created` datetime not null, --   `updated` datetime null, --   `access` tinyint not null default '0', --   `flags` int not null default '0', --  primary key (`id`), index (`entity_type`), index (`entity`), index (`mime`), index (`md5`), index (`sha1`), index (`url`) ) engine = InnoDB;</span></span></code> </pre> <br><h3>  Dispatcher-Klasse </h3><br>  Jetzt müssen wir eine Klasse erstellen, mit der wir Dateien hochladen.  Die Klasse sollte die Möglichkeit bieten, Dateien zu erstellen, Dateien zu ersetzen / zu ändern und Dateien zu löschen.  Darüber hinaus sollten zwei Punkte berücksichtigt werden.  Erstens kann das Projekt von Server zu Server übertragen werden.  In der Klasse müssen Sie also eine Eigenschaft definieren, die das Stammverzeichnis der Dateien enthält.  Zweitens ist es sehr unangenehm, wenn jemand eine Tabelle in der Datenbank knallt.  Sie müssen also die Möglichkeit der Datenwiederherstellung bereitstellen.  Mit dem ersten ist im Allgemeinen alles klar.  Für die Datensicherung behalten wir uns nur das vor, was nicht wiederhergestellt werden kann. <br><br>  <b>ID</b> - vom physischen Speicherort der Datei wiederhergestellt <br>  <b>entity_type</b> - nicht wiederhergestellt <br>  <b>Entität</b> - nicht wiederhergestellt <br>  <b>mime</b> - restauriert mit finfo extension <br>  <b>md5</b> - wird aus der Datei selbst wiederhergestellt <br>  <b>sha1</b> - aus der Datei selbst wiederhergestellt <br>  <b>Datei</b> - vom physischen Speicherort der Datei wiederhergestellt <br>  <b>URL</b> - nicht wiederhergestellt <br>  <b>Meta</b> - nicht wiederhergestellt <br>  <b>Größe</b> - aus der Datei selbst wiederhergestellt <br>  <b>Erstellt</b> - Sie können Informationen aus einer Datei entnehmen <br>  <b>aktualisiert</b> - Sie können Informationen aus einer Datei entnehmen <br>  <b>Zugang</b> - nicht wiederhergestellt <br>  <b>Flags</b> - nicht wiederhergestellt <br><br>  Sie können Metainformationen sofort verwerfen.  Es ist nicht kritisch für die Funktionsweise des Systems.  Für eine schnellere Wiederherstellung müssen Sie den MIME-Typ noch speichern.  Gesamt: Entitätstyp, Entitäts-ID, MIME, URL, Zugriff und Flags.  Um die Zuverlässigkeit des Systems zu erhöhen, speichern wir Sicherungsinformationen für jeden Zielordner separat im Ordner selbst. <br><br><div class="spoiler">  <b class="spoiler_title">Klassencode</b> <div class="spoiler_text"><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BigFiles</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> FLAG_DELETED = <span class="hljs-number"><span class="hljs-number">0x08000000</span></span>; <span class="hljs-comment"><span class="hljs-comment">//    "" /** @var mysqli $_db */ protected $_db = null; protected $_webRoot = ''; protected $_realRoot = ''; function __construct(mysqli $db = null) { $this-&gt;_db = $db; } /** * /   URL- * @param string $v  * @return string */ public function webRoot($v = null) { if (!is_null($v)) { $this-&gt;_webRoot = $v; } return $this-&gt;_webRoot; } /** * /    * @param string $v  * @return string */ public function realRoot($v = null) { if (!is_null($v)) { $this-&gt;_realRoot = $v; } return $this-&gt;_realRoot; } /** *   * @param array $data   * @param string $url URL   * @param string $eType   * @param int $eID ID  * @param mixed $meta - * @param int $access  * @param int $flags  * @param int $fileID ID   * @return bool * @throws Exception */ public function upload(array $data, $url, $eType = '', $eID = null, $meta = null, $access = 127, $flags = 0, $fileID = 0) { $meta = is_array($meta) ? serialize($meta) : $meta; if (empty($data['tmp_name']) || empty($data['name'])) { $fid = intval($fileID); if (empty($fid)) { return false; } $meta = empty($meta) ? 'null' : "'" . $this-&gt;_db-&gt;real_escape_string($meta) . "'"; $q = "`meta`={$meta},`updated`=now()"; $this-&gt;_db-&gt;query("UPDATE `files` SET {$q} WHERE (`id` = {$fid}) AND (`entity_type` = '{$eType}')"); return $fid; } // File data $meta = empty($meta) ? 'null' : "'" . $this-&gt;_db-&gt;real_escape_string($meta) . "'"; $finfo = finfo_open(FILEINFO_MIME_TYPE); $mime = finfo_file($finfo , $data['tmp_name']); finfo_close($finfo); // FID, file name if (empty($fileID)) { $eID = empty($eID) ? 'null' : intval($eID); $q = &lt;&lt;&lt;sql insert into `files` set `mime` = '{$mime}', `entity` = {$eID}, `entityType` = '{$eType}', `created` = now(), `access` = {$access}, `flags` = {$flags} sql; $this-&gt;_db-&gt;query($q); $fid = $this-&gt;_db-&gt;insert_id; list($ffs, $fhn) = self::fid($fid); $url = $this-&gt;_webRoot . $url . '/' . $fid; $fdir = $this-&gt;_realRoot . $ffs; self::validateDir($fdir); $index = self::getIndex($fdir); $index[$fhn] = array($fhn, $mime, $url, ($eID == 'null' ? 0 : $eID), $access, $flags); self::setIndex($fdir, $index); $fname = $ffs . '/' . $fhn . '.file'; } else { $fid = intval($fileID); $fname = $this-&gt;fileName($fid); } // Move file $fdir = $this-&gt;_realRoot . $fname; if (!move_uploaded_file($data['tmp_name'], $fdir)) { throw new Exception('Upload error'); } $q = '`md5`=\'' . md5_file($fdir) . '\',`sha1`=\'' . sha1_file($fdir) . '\',' . '`size`=' . filesize($fdir) . ',`meta`=' . $meta . ',' . (empty($fileID) ? "`url`='{$url}',`file`='{$fname}'" : '`updated`=now()'); $this-&gt;_db-&gt;query("UPDATE `files` SET {$q} WHERE (`id` = {$fid}) AND (`entity_type` = '{$eType}')"); return $fid; } /** *   * @param string $url URL * @param string $basicGroup    * @throws Exception */ public function read($url, $basicGroup = 'anonimous') { if (!ctype_alnum(str_replace(array('/', '.', '-', '_'), '', $url))) { header('HTTP/1.1 400 Bad Request'); exit; } $url = $this-&gt;_db-&gt;real_escape_string($url); $q = "SELECT * FROM `files` WHERE `url` = '{$url}' ORDER BY `created` ASC"; if ($result = $this-&gt;_db-&gt;query($q)) { $vars = array(); $ints = array('id', 'entity', 'size', 'access', 'flags'); while ($row = $result-&gt;fetch_assoc()) { foreach ($ints as $i) { $row[$i] = intval($row[$i]); } $fid = $row['id']; $vars[$fid] = $row; } if (empty($vars)) { header('HTTP/1.1 404 Not Found'); exit; } $deleted = false; $access = true; $found = ''; $mime = ''; foreach ($vars as $fdata) { $flags = intval($fdata['flags']); $deleted = ($flags &amp; self::FLAG_DELETED) != 0; $access = self::granted($basicGroup, $fdata['access']); if (!$access || $deleted) { continue; } $found = $fdata['file']; $mime = $fdata['mime']; } if (empty($found)) { if ($deleted) { header('HTTP/1.1 410 Gone'); exit; } elseif (!$access) { header('HTTP/1.1 403 Forbidden'); exit; } } else { header('Content-type: ' . $mime . '; charset=utf-8'); readfile($this-&gt;_realRoot . $found); exit; } } header('HTTP/1.1 404 Not Found'); exit; } /** *   ()   * @param mixed $fid () * @return bool * @throws Exception */ public function delete($fid) { $fid = is_array($fid) ? implode(',', $fid) : $fid; $q = "delete from `table` where `id` in ({$fid})"; $this-&gt;_db-&gt;query($q); $result = true; foreach ($fid as $fid_i) { list($ffs, $fhn) = self::fid($fid_i); $fdir = $this-&gt;_realRoot . $ffs; $index = self::getIndex($fdir); unset($index[$fhn]); self::setIndex($fdir, $index); $result &amp;= unlink($fdir . '/'. $fhn . '.file'); } return $result; } /** *  ()  "" * @param int $fid () * @param bool $value   * @return bool */ public function setDeleted($fid, $value=true) { $fid = is_array($fid) ? implode(',', $fid) : $fid; $o = $value ? ' | ' . self::FLAG_DELETED : ' &amp; ' . (~self::FLAG_DELETED); $this-&gt;_db-&gt;query("update `files` set `flags` = `flags` {$o} where `id` in ({$fid})"); return true; } /** *   * @param int $fid  * @return string * @throws Exception */ public function fileName($fid) { list($ffs, $fhn) = self::fid($fid); self::validateDir($this-&gt;_realRoot . $ffs); return $ffs . '/' . $fhn . '.file'; } /** *   . *           . * @param int $fid   * @return array */ public static function fid($fid) { $ffs = str_split(str_pad(dechex($fid), 16, '0', STR_PAD_LEFT), 2); $fhn = array_pop($ffs); $ffs = implode('/', $ffs); return array($ffs, $fhn); } /** *    * @param string $f     * @return bool * @throws Exception */ public static function validateDir($f) { if (!is_dir($f)) { if (!mkdir($f, 0700, true)) { throw new Exception('cannot make dir: ' . $f); } } return true; } /** *    * @param string $f       * @return array */ public static function getIndex($f) { $index = array(); if (file_exists($f . '/.index')) { $_ = file($f . '/.index'); foreach ($_ as $_i) { $row = trim($_i); $row = explode('|', $row); array_walk($row, 'trim'); $rid = $row[0]; $index[$rid] = $row; } } return $index; } /** *    * @param string $f       * @param array $index    * @return bool */ public static function setIndex($f, array $index) { $_ = array(); foreach ($index as $row) { $_[] = implode('|', $row); } return file_put_contents($f . '/.index', implode("\r\n", $_)); } /** *   * @param string $group   (. ) * @param int $value   * @return bool */ public static function granted($group, $value=0) { $groups = array('anonimous', 'user', 'manager', 'admin', 'inactive', 'blocked', 'deleted'); if ($group == 'root') { return true; } foreach ($groups as $groupID =&gt; $groupName) { if ($groupName == $group) { return (((1 &lt;&lt; $groupID) &amp; $value) != 0); } } return false; } }</span></span></code> </pre> <br></div></div><br>  Betrachten Sie einige Punkte: <br><br>  - <b>realRoot</b> - Der vollständige Pfad zum Ordner, wobei das Dateisystem mit einem Schrägstrich endet. <br>  - <b>webRoot</b> - Der Pfad vom Stammverzeichnis der Site ohne führenden Schrägstrich (siehe unten, warum). <br>  - Als DBMS verwende ich die <b>MySQLi-</b> Erweiterung. <br>  - Tatsächlich werden die Informationen aus dem Array <b>$ _FILES</b> als erstes Argument an die <b>Upload-</b> Methode übergeben. <br>  - Wenn Sie die <b>Aktualisierungsmethode</b> aufrufen, um die ID einer vorhandenen Datei zu übergeben, wird diese ersetzt, wenn das Eingabearray in <b>tmp_name</b> nicht leer ist. <br>  - Sie können die Flags von Dateien gleichzeitig löschen und ändern.  Anstatt die Dateikennung zu übergeben, müssen Sie dazu entweder ein Array mit Bezeichnern oder eine durch Kommas getrennte Zeichenfolge übergeben. <br><br><h3>  Routing </h3><br>  Tatsächlich handelt es sich um einige Zeilen in htaccess im Stammverzeichnis der Site (es wird davon ausgegangen, dass mod_rewrite aktiviert ist): <br><br><pre> <code class="apache hljs"><span class="hljs-attribute"><span class="hljs-nomarkup"><span class="hljs-attribute"><span class="hljs-nomarkup">RewriteCond</span></span></span></span> <span class="hljs-variable"><span class="hljs-variable">%{REQUEST_URI}</span></span> ^/content/(.*)$ RewriteCond <span class="hljs-variable"><span class="hljs-variable">%{REQUEST_FILENAME}</span></span> !-f RewriteRule ^(.+)$ content/index.php?file=<span class="hljs-number"><span class="hljs-number">$1</span></span><span class="hljs-meta"><span class="hljs-meta"> [L,QSA]</span></span></code> </pre> <br>  "Inhalt" ist in meinem Fall der Ordner im Stammverzeichnis der Site.  Natürlich können Sie den Ordner auch anders benennen.  Und natürlich index.php selbst, in meinem Fall im Inhaltsordner gespeichert: <br><br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> $dbHost = <span class="hljs-string"><span class="hljs-string">'127.0.0.1'</span></span>; $dbUser = <span class="hljs-string"><span class="hljs-string">'user'</span></span>; $dbPass = <span class="hljs-string"><span class="hljs-string">'****'</span></span>; $dbName = <span class="hljs-string"><span class="hljs-string">'database'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">empty</span></span>($_REQUEST[<span class="hljs-string"><span class="hljs-string">'file'</span></span>])) { header(<span class="hljs-string"><span class="hljs-string">'HTTP/1.1 400 Bad Request'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">exit</span></span>; } $userG = <span class="hljs-string"><span class="hljs-string">'anonimous'</span></span>; <span class="hljs-comment"><span class="hljs-comment">//      ;      $files = new BigFiles(new mysqli($dbHost,$dbUser,$dbPass,$dbName)); $files-&gt;realRoot(dirname(__FILE__).'/files/'); $files-&gt;read($_REQUEST['file'],$userG); } catch (Exception $e) { header('HTTP/1.1 500 Internal Error'); header('Content-Type: text/plain; charset=utf-8'); echo $e-&gt;getMessage(); exit; }</span></span></code> </pre><br>  Nun, wir selbst schließen das Dateisystem selbst vor externem Zugriff.  Legen Sie die <code>.htaccess</code> Datei mit nur einer Zeile im Stammverzeichnis des Ordners <code>content/files</code> ab: <br><br><pre> <code class="apache hljs"><span class="hljs-attribute"><span class="hljs-nomarkup"><span class="hljs-attribute"><span class="hljs-nomarkup">Deny</span></span></span></span> from <span class="hljs-literal"><span class="hljs-literal">all</span></span></code> </pre> <br><h3>  Zusammenfassung </h3><br>  Mit dieser Lösung können Sie Leistungseinbußen beim Dateisystem aufgrund einer Erhöhung der Anzahl der Dateien vermeiden.  Zumindest die Probleme in Form von Tausenden von Dateien in einem Ordner können definitiv vermieden werden.  Gleichzeitig können wir den Zugriff auf Dateien an lesbaren Adressen organisieren und steuern.  Plus Einhaltung unserer düsteren Gesetzgebung.  Machen Sie sofort eine Reservierung, diese Lösung ist KEINE vollständige Möglichkeit, Inhalte zu schützen.  Denken Sie daran: Wenn etwas im Browser abgespielt wird, kann es kostenlos heruntergeladen werden. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de423875/">https://habr.com/ru/post/de423875/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de423865/index.html">Roskomnadzor berichtete öffentlich</a></li>
<li><a href="../de423867/index.html">Gründer des 3D-Druckstudios - über seine Arbeit</a></li>
<li><a href="../de423869/index.html">Die Zukunft der Arbeitsplätze. Die Hauptsache aus dem Bericht des Weltwirtschaftsforums</a></li>
<li><a href="../de423871/index.html">Wir lösen ein logisches Problem für Studenten in SQL</a></li>
<li><a href="../de423873/index.html">PICASO 3D Designer X 3D-Druckerübersicht</a></li>
<li><a href="../de423877/index.html">29. bis 31. Oktober: Erstellen eines produktionsbereiten Kubernetes-Clusters</a></li>
<li><a href="../de423879/index.html">Ist es einfach, dem alten Framework neue Funktionen hinzuzufügen? Mehl der Wahl am Beispiel der Entwicklung von SObjectizer</a></li>
<li><a href="../de423881/index.html">Was waren die Schweißer für Optik (Teil zwei)</a></li>
<li><a href="../de423885/index.html">Eine Einladung zu einer Lichtshow und ein kleiner Insider von der zukünftigen Circle of Light-Plattform in Moskau</a></li>
<li><a href="../de423889/index.html">Meine Enttäuschung über Software</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>