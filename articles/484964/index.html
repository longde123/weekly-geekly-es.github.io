<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üéµ ‚ô¶Ô∏è üôèüèø Configurar el equilibrio de carga en InfoWatch Traffic Monitor ‚òÑÔ∏è ü§ó üö£üèæ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="¬øQu√© debo hacer si la potencia de un servidor no es suficiente para procesar todas las solicitudes y el fabricante del software no proporciona el equi...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Configurar el equilibrio de carga en InfoWatch Traffic Monitor</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/ntc-vulkan/blog/484964/"><div style="text-align:center;"><img src="https://habrastorage.org/webt/4w/ol/wf/4wolwfpah48j6egm8hqmcn4we5o.png"></div><br><p>  ¬øQu√© debo hacer si la potencia de un servidor no es suficiente para procesar todas las solicitudes y el fabricante del software no proporciona el equilibrio de carga?  Hay muchas opciones, desde comprar un equilibrador de carga hasta limitar la cantidad de solicitudes.  Cu√°l es correcto, debe mirar la situaci√≥n, teniendo en cuenta las condiciones existentes.  En este art√≠culo le diremos qu√© se puede hacer si el presupuesto es limitado y hay un servidor gratuito disponible. </p><a name="habracut"></a><br><p>  Como un sistema para el que era necesario reducir la carga en uno de los servidores, elegimos InfoWatch DLP (Sistema de prevenci√≥n de fugas de informaci√≥n).  Una caracter√≠stica de la implementaci√≥n fue la colocaci√≥n de la funci√≥n equilibradora en uno de los servidores de "combate". </p><br><p>  Uno de los problemas que encontramos es la incapacidad de usar Source NAT (SNAT).  Para lo que se necesitaba y c√≥mo se resolvi√≥ el problema, lo describiremos m√°s adelante. </p><br><p>  Entonces, el diagrama l√≥gico inicial del sistema existente era el siguiente: </p><br><img src="https://habrastorage.org/webt/jn/p_/w1/jnp_w1x4tilvkrdpsk98z0ikwxo.jpeg"><br><p>  El tr√°fico ICAP, SMTP, los eventos de las computadoras de los usuarios se procesaron en el servidor Traffic Monitor (TM).  Al mismo tiempo, el servidor de la base de datos hizo frente f√°cilmente a la carga despu√©s de procesar eventos en la TM, pero la carga en la TM en s√≠ era grande.  Esto fue evidente por la aparici√≥n de la cola de mensajes en el servidor Device Monitor (DM), as√≠ como por la carga del procesador y la memoria en el TM. </p><br><p>  A primera vista, si agregamos otro servidor TM a este esquema, ICAP o DM podr√≠an cambiarse a √©l, pero decidimos no usar este m√©todo, ya que se redujo la tolerancia a fallas. </p><br><h1>  Descripci√≥n de la soluci√≥n </h1><br><p>  En el proceso de encontrar la soluci√≥n correcta, nos decidimos por el software freeware <a href="http://www.keepalived.org/">keepalived</a> junto con <a href="http://www.linuxvirtualserver.org/">LVS</a> .  Dado que keepalived resuelve el problema de crear un cl√∫ster de conmutaci√≥n por error, tambi√©n puede administrar el equilibrador LVS. </p><br><p>  A lo que quer√≠amos llegar (reducir la carga en TM y mantener el nivel actual de tolerancia a fallas) deber√≠a funcionar de acuerdo con el siguiente esquema: </p><br><img src="https://habrastorage.org/webt/kr/yh/lz/kryhlzufx39kmzvq9ndepj_gpxi.jpeg"><br><p>  Al verificar el rendimiento, result√≥ que el ensamblaje RedHat personalizado instalado en los servidores no es compatible con SNAT.  En nuestro caso, planeamos usar SNAT para que los paquetes entrantes y las respuestas a ellos se env√≠en desde la misma direcci√≥n IP, de lo contrario obtendr√≠amos la siguiente imagen: </p><br><img src="https://habrastorage.org/webt/hl/zt/oa/hlztoaeuk5itpyjn_iv5kncmumw.jpeg"><br><p>  Esto es inaceptable.  Por ejemplo, un servidor proxy, que env√≠a paquetes a una direcci√≥n IP virtual (VIP), esperar√° una respuesta de VIP, pero en este caso vendr√° de IP2 para las sesiones enviadas a la copia de seguridad.  Se encontr√≥ la soluci√≥n: era necesario crear otra tabla de enrutamiento en la copia de seguridad y conectar los dos servidores TM con una red separada, como se muestra a continuaci√≥n: </p><br><img src="https://habrastorage.org/webt/24/bf/vp/24bfvpitjgkba5nxbqaftdeglhu.jpeg"><br><h1>  Configuraciones </h1><br><p>  Implementamos un esquema de dos servidores con servicios ICAP, SMTP, TCP 9100 y un equilibrador de carga instalado en uno de ellos. </p><br><p> Tenemos dos servidores RHEL6, de los cuales se han eliminado los repositorios est√°ndar y parte de los paquetes. </p><br><p>  Servicios que necesitamos para equilibrar: </p><br><p>  ‚Ä¢ ICAP - tcp 1344; </p><br><p>  ‚Ä¢ SMTP - tcp 25. </p><br><p>  Servicio de tr√°fico DM - tcp 9100. </p><br><p>  Primero tenemos que planificar la red. </p><br><p>  Direcci√≥n IP virtual (VIP): </p><br><p>  ‚Ä¢ IP: 10.20.20.105. </p><br><p>  Servidor TM6_1: </p><br><p>  ‚Ä¢ IP externa: 10.20.20.101; </p><br><p>  ‚Ä¢ IP interna: 192.168.1.101. </p><br><p>  Servidor TM6_2: </p><br><p>  ‚Ä¢ IP externa: 10.20.20.102; </p><br><p>  ‚Ä¢ IP interna: 192.168.1.102. </p><br><p>  Luego habilite el reenv√≠o de IP en los dos servidores TM.  <a href="https://rhel7tutorial.wordpress.com/how-to-enable-ip-forwarding/">Aqu√≠</a> se describe c√≥mo hacerlo en RedHat. </p><br><p>  Decidimos cu√°l de los servidores tendremos el principal y cu√°l, la copia de seguridad.  Deje que el maestro sea TM6_1, el respaldo sea TM6_2. </p><br><p>  En la copia de seguridad, cree una nueva tabla de enrutamiento equilibrador y reglas de enrutamiento: </p><br><pre><code class="plaintext hljs">[root@tm6_2 ~]echo 101 balancer &gt;&gt; /etc/iproute2/rt_tables [root@tm6_2 ~]ip rule add from 192.168.1.102 table balancer [root@tm6_2 ~]ip route add default via 192.168.1.101 table balancer</code> </pre> <br><p>  Los comandos anteriores funcionan hasta que el sistema se reinicia.  Para mantener las rutas despu√©s de reiniciar, puede ingresarlas en <em>/etc/rc.d/rc.local</em> , pero mejor a trav√©s del archivo de configuraci√≥n <em>/ etc / sysconfig / network-scripts / route-eth1</em> (nota: esto usa una sintaxis diferente). </p><br><p>  Instale keepalived en ambos servidores TM.  Como fuente de distribuci√≥n, utilizamos rpmfind.net: </p><br><pre> <code class="plaintext hljs">[root@tm6_1 ~]#yum install https://rpmfind.net/linux/centos/6.10/os/x86_64/Packages/keepalived-1.2.13-5.el6_6.x86_64.rpm</code> </pre> <br><p>  En la configuraci√≥n de keepalived, asignamos uno de los servidores maestros, el otro, backup.  Luego configuramos VIP y servicios para el equilibrio de carga.  El archivo de configuraci√≥n generalmente se encuentra aqu√≠: <em>/etc/keepalived/keepalived.conf</em> . </p><br><div class="spoiler">  <b class="spoiler_title">Configuraciones para el servidor TM1</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">vrrp_sync_group VG1 { group { VI_1 } } vrrp_instance VI_1 { state MASTER interface eth0 lvs_sync_daemon_inteface eth0 virtual_router_id 51 priority 151 advert_int 1 authentication { auth_type PASS auth_pass example } virtual_ipaddress { 10.20.20.105 } } virtual_server 10.20.20.105 1344 { delay_loop 6 lb_algo wrr lb_kind NAT protocol TCP real_server 192.168.1.101 1344 { weight 1 TCP_CHECK { connect_timeout 3 connect_port 1344 nb_get_retry 3 delay_before_retry 3 } } real_server 192.168.1.102 1344 { weight 1 TCP_CHECK { connect_timeout 3 connect_port 1344 nb_get_retry 3 delay_before_retry 3 } } } virtual_server 10.20.20.105 25 { delay_loop 6 lb_algo wrr lb_kind NAT protocol TCP real_server 192.168.1.101 25 { weight 1 TCP_CHECK { connect_timeout 3 connect_port 25 nb_get_retry 3 delay_before_retry 3 } } real_server 192.168.1.102 25 { weight 1 TCP_CHECK { connect_timeout 3 connect_port 25 nb_get_retry 3 delay_before_retry 3 } } } virtual_server 10.20.20.105 9100 { delay_loop 6 lb_algo wrr lb_kind NAT protocol TCP real_server 192.168.1.101 9100 { weight 1 TCP_CHECK { connect_timeout 3 connect_port 9100 nb_get_retry 3 delay_before_retry 3 } } real_server 192.168.1.102 9100 { weight 1 TCP_CHECK { connect_timeout 3 connect_port 9100 nb_get_retry 3 delay_before_retry 3 } } }</code> </pre> </div></div><br><div class="spoiler">  <b class="spoiler_title">Configuraciones para el servidor TM2</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">vrrp_sync_group VG1 { group { VI_1 } } vrrp_instance VI_1 { state BACKUP interface eth0 lvs_sync_daemon_inteface eth0 virtual_router_id 51 priority 100 advert_int 1 authentication { auth_type PASS auth_pass example } virtual_ipaddress { 10.20.20.105 } }</code> </pre> </div></div><br><p>  Instalar en LVS maestro, que equilibrar√° el tr√°fico.  Para el segundo servidor, no tiene sentido instalar un equilibrador, porque en la configuraci√≥n solo tenemos dos servidores. </p><br><pre> <code class="plaintext hljs">[root@tm6_1 ~]##yum install https://rpmfind.net/linux/centos/6.10/os/x86_64/Packages/ipvsadm-1.26-4.el6.x86_64.rpm</code> </pre> <br><p>  El balanceador ser√° administrado por el keepalived que ya hemos configurado. </p><br><p>  Para completar la imagen, agregue keepalived para la ejecuci√≥n autom√°tica en ambos servidores: </p><br><pre> <code class="plaintext hljs">[root@tm6_1 ~]#chkconfig keepalived on</code> </pre> <br><h1>  Conclusi√≥n </h1><br><p>  <em>Comprobaci√≥n de resultados</em> </p><br><p>  Ejecute keepalived en ambos servidores: </p><br><pre> <code class="plaintext hljs">service keepalived start</code> </pre> <br><p>  <em>Verifique la disponibilidad de la direcci√≥n virtual VRRP</em> </p><br><p>  Aseg√∫rese de que el VIP est√© en master: </p><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/gi/ki/w_/gikiw_8kvn4oasjpykqljrpnjha.jpeg"></div><br><p>  Y no hay VIP en la copia de seguridad: </p><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/p7/8x/6o/p78x6o9prduqmsyknrjazt9lcoe.jpeg"></div><br><p>  Usando el comando ping, verifique la disponibilidad de VIP: </p><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/1n/ev/b2/1nevb23tpstycsrbokowdm34-lk.jpeg"></div><br><p>  Ahora puede apagar el maestro y ejecutar el comando <code>ping</code> nuevamente. </p><br><p>  El resultado debe seguir siendo el mismo, y en la copia de seguridad veremos VIP: </p><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/ny/ga/mg/nygamghufaycljxfyxamf6ixspk.jpeg"></div><br><p>  <em>Verificar el equilibrio del servicio</em> </p><br><p>  Tome SMTP, por ejemplo.  Ejecute dos conexiones a 10.20.20.105 al mismo tiempo: </p><br><pre> <code class="plaintext hljs">telnet 10.20.20.105 25</code> </pre> <br><p>  En master, deber√≠amos ver que ambas conexiones est√°n activas y conectadas a diferentes servidores: </p><br><pre> <code class="plaintext hljs">[root@tm6_1 ~]#watch ipvsadm ‚ÄìLn</code> </pre> <br><div style="text-align:center;"><img src="https://habrastorage.org/webt/54/uw/og/54uwogp1mozyhstfkkxfx1pc5ck.jpeg"></div><br><p>  Por lo tanto, implementamos una configuraci√≥n a prueba de fallas de los servicios TM con la instalaci√≥n de un equilibrador en uno de los servidores TM.  Para nuestro sistema, esto redujo la carga en TM a la mitad, lo que nos permiti√≥ resolver el problema de la falta de escala horizontal por medio del sistema. </p><br><p>  En la mayor√≠a de los casos, esta soluci√≥n se implementa r√°pidamente y sin costos adicionales, pero a veces hay una serie de limitaciones y dificultades en la configuraci√≥n, por ejemplo, al equilibrar el tr√°fico UDP. </p></div></div><p>Source: <a href="https://habr.com/ru/post/484964/">https://habr.com/ru/post/484964/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../484944/index.html">¬øQu√© estoy en ACID o no nos conviene?</a></li>
<li><a href="../484946/index.html">Modelado GPR</a></li>
<li><a href="../484948/index.html">NEC lanz√≥ un cable submarino con un r√©cord de 20 pares de fibras √≥pticas</a></li>
<li><a href="../484952/index.html">Sustituci√≥n de Redux con observables y ganchos de reacci√≥n</a></li>
<li><a href="../484954/index.html">Gu√≠a visual de soluci√≥n de problemas para Kubernetes</a></li>
<li><a href="../484966/index.html">Plantilla lista para usar con Spring</a></li>
<li><a href="../484968/index.html">WPF DataGrid. Lucha por la plantilla</a></li>
<li><a href="../484972/index.html">Wine 5.0 lanzado</a></li>
<li><a href="../484974/index.html">Wang Tiles para la simulaci√≥n de m√°quinas de Turing</a></li>
<li><a href="../484978/index.html">PubSub es casi gratis: NOTIFICAR caracter√≠sticas en PostgreSQL</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>