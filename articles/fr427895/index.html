<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë©üèæ‚Äçüåæ üóëÔ∏è ü§¢ Suppression de donn√©es d'une base de donn√©es partageable üë®üèª‚ÄçüöÄ üè¶ ‚õàÔ∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Un article sur la fa√ßon de r√©soudre le probl√®me de l'optimisation du processus de suppression de fichiers d'un syst√®me fragment√©. Il s'agit d'un proje...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Suppression de donn√©es d'une base de donn√©es partageable</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/427895/"> Un article sur la fa√ßon de r√©soudre le probl√®me de l'optimisation du processus de suppression de fichiers d'un syst√®me fragment√©.  Il s'agit d'un projet de partage et de travail avec des fichiers.  Le syst√®me √©tait une startup il y a environ 8 ans, puis il a tourn√© avec succ√®s et a √©t√© vendu plusieurs fois.  Le projet a 4 d√©veloppeurs qui sont avec le projet d√®s le d√©but, ce qui est tr√®s pr√©cieux.  Traditionnellement, la documentation n'a pas eu le temps d'√©crire ou elle n'est pas tr√®s pertinente. <br><br>  Pourquoi voudriez-vous lire ceci et pourquoi ai-je √©crit tout cela?  Je voudrais parler d'un r√¢teau qui se trouve soigneusement √† l'int√©rieur du syst√®me et qui bat pour que les √©toiles d√©bordent des yeux. <br><br>  Je tiens √† dire un grand merci √† <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" class="user_link">Hanna_Hlushakova</a> pour avoir travaill√© ensemble, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" class="user_link">men√©</a> le projet √† son terme et aid√© √† pr√©parer l'article.  Fondamentalement, vous trouverez des descriptions du probl√®me et de l'algorithme pour le r√©soudre, que nous avons utilis√©s, il n'y a pas d'exemples de code, de structures de donn√©es ou d'autres choses n√©cessaires.  Je ne sais pas si mon exp√©rience vous aidera √† √©viter un r√¢teau √† la maison, mais j'esp√®re que vous obtiendrez quelque chose d'utile.  Cet article sera peut-√™tre une perte absolument irr√©vocable de temps pr√©cieux. <br><br><img src="https://habrastorage.org/webt/lb/p2/s5/lbp2s5dnlsusssfxqfd3zf9aoyk.png"><br><a name="habracut"></a><br><h3>  √Ä propos du projet </h3><br>  Le projet est l'un des leaders de la place Gartner, a des entreprises clientes avec plus de 300 000 employ√©s aux √âtats-Unis et en Europe, et plusieurs milliards de fichiers pour la maintenance. <br><br>  Les technologies suivantes sont utilis√©es dans le projet: Microsoft, serveurs C # .net, base de donn√©es MS SQL, 14 serveurs actifs + 14 en mode miroir de donn√©es. <br><br>  Le volume des bases de donn√©es peut atteindre 4 To, la charge constante en heures ouvrables est d'environ 400 000 requ√™tes par minute. <br><br>  Il y a beaucoup de logique m√©tier dans la base de donn√©es: <br>  450 tables <br>  1000 proc√©dures stock√©es <br>  80 000 lignes de code SQL <br>  Traditionnellement, soit ils n'avaient pas le temps de r√©diger la documentation, soit elle n'est pas pertinente. <br><br><h3>  √Ä propos de la t√¢che </h3><br>  La t√¢che consiste √† refaire la suppression des fichiers du stockage qui ont d√©j√† √©t√© supprim√©s par les clients, et la p√©riode de stockage des fichiers supprim√©s a expir√©, au cas o√π ils souhaiteraient √™tre restaur√©s.  Dans la version actuelle, selon les calculs de l'entreprise elle-m√™me, les fichiers supprim√©s il y a 1 an √©taient stock√©s sur les serveurs, bien que selon les conditions g√©n√©rales de vente, ils n'auraient d√ª √™tre stock√©s que 1 mois.  √âtant donn√© que certains fichiers sont stock√©s sur S3, la soci√©t√© a pay√© les donn√©es suppl√©mentaires et les clients qui ont utilis√© le stockage sur site se demandaient pourquoi les fichiers prenaient plus d'espace qu'ils ne le devraient. <br><br>  Bases de donn√©es shardovany pour le client de l'entreprise. <br><br><h3>  Comment le retrait a-t-il fonctionn√© plus t√¥t? </h3><br><br><img src="https://habrastorage.org/webt/wy/zx/dq/wyzxdqqakclb2u1kjmtbzl3v39y.png"><br><br>  Sur un serveur global contenant des informations sur tous les fichiers du syst√®me, des plages de 15 000 identifiants de fichiers ont √©t√© form√©es. <br><br>  Ensuite, selon le calendrier, une enqu√™te sur le serveur a √©t√© lanc√©e pour une gamme d'identifiants de fichiers. <br>  Les limites de l'aire de r√©partition ont √©t√© transmises √† chaque fragment. <br><br>  Shard en r√©ponse a envoy√© des fichiers trouv√©s de la plage. <br><br>  Le serveur principal a ajout√© les fichiers manquants √† la table de file d'attente pour suppression dans sa base de donn√©es. <br>  Ensuite, √† partir de la table de file d'attente, le service de suppression de fichiers physiques du stockage a re√ßu un tas d'identifiants √† supprimer, apr√®s quoi il a envoy√© une confirmation qu'il allait supprimer les fichiers et une v√©rification a √©t√© lanc√©e pour tous les fragments si ces fichiers y √©taient utilis√©s. <br>  Avec une augmentation du nombre de fichiers, cette approche a commenc√© √† fonctionner tr√®s lentement, car il y avait plusieurs milliards de fichiers et le nombre de plages a consid√©rablement augment√©.  Les fichiers supprim√©s sont toujours rest√©s inf√©rieurs √† 5% par rapport au nombre total, respectivement, il est tr√®s inefficace de trier des milliards de fichiers pour trouver plusieurs millions de fichiers supprim√©s. <br><br>  Par exemple, g√©n√©ralement apr√®s qu'un utilisateur a supprim√© un fichier, il doit √™tre stock√© pendant 1 mois, au cas o√π il devrait √™tre restaur√©.  Apr√®s cette p√©riode, le fichier doit √™tre supprim√© par le programme du r√©f√©rentiel.  Avec le nombre actuel de fichiers, le nombre de plages et la vitesse de contournement des plages, il faudrait 1 an au serveur pour contourner compl√®tement toutes les plages. <br>  Il est clair que l'endroit n'a pas √©t√© lib√©r√©, ce qui a provoqu√© l'insatisfaction des utilisateurs, car leurs serveurs stockaient beaucoup plus de fichiers que ce qui aurait d√ª √™tre signal√©.  La soci√©t√© de services a elle-m√™me pay√© une place suppl√©mentaire sur S3, ce qui a √©t√© une perte directe pour elle. <br><br>  Seulement sur S3 au moment o√π le travail a commenc√©, 2 p√©taoctets de fichiers supprim√©s ont √©t√© stock√©s, et ce n'est que sur le cloud.  De plus, il y avait des clients dont les fichiers √©taient stock√©s sur leurs serveurs d√©di√©s, qui avaient le m√™me probl√®me: l'espace du serveur √©tait occup√© par des fichiers supprim√©s par les utilisateurs mais pas supprim√©s du serveur. <br><br><h3>  Qu'avez-vous d√©cid√© de faire? </h3><br>  Nous avons d√©cid√© de suivre les √©v√©nements de suppression: <br><br><ul><li>  le client a supprim√© le fichier, puis a expir√©. </li><li>  l'utilisateur a supprim√© le fichier imm√©diatement sans possibilit√© de r√©cup√©ration. </li></ul><br>  Lors de la suppression d'un fichier d'une base de donn√©es fragment√©e, nous avons d√©cid√© d'utiliser une approche optimiste et de supprimer l'un des contr√¥les √† utiliser.  Nous savions que 99% des fichiers ne sont utilis√©s que dans un seul fragment.  Nous avons d√©cid√© d'ajouter imm√©diatement le fichier √† la file d'attente de suppression et de ne pas v√©rifier le reste des fragments pour l'utilisation de ce fichier, car la v√©rification sera √† nouveau effectu√©e lorsque la suppression du magasin confirmera le service. <br><br>  De plus, ils ont laiss√© le JOB actuel qui v√©rifiait les fichiers supprim√©s par plages afin d'ajouter des fichiers qui ont √©t√© supprim√©s avant la sortie de la nouvelle version. <br><br>  Tout ce qui a √©t√© supprim√© sur le fragment est collect√© dans une table puis transf√©r√© sur un seul serveur, avec des informations sur tous les fichiers. <br><br>  Sur ce serveur, il est envoy√© √† la table de suppression de file d'attente. <br><br>  Dans le tableau de suppression avant suppression, il est v√©rifi√© que le fichier n'est pas utilis√© sur tous les fragments.  Cette partie du ch√®que √©tait l√† avant le changement de code, et ils ont d√©cid√© de ne pas y toucher. <br><br><h4>  De quoi aviez-vous besoin de changer dans le code? </h4><br>  Sur chacun des fragments, une table a √©t√© ajout√©e dans laquelle l'identifiant du fichier supprim√© doit √™tre √©crit. <br><br>  Nous avons trouv√© toutes les proc√©dures pour supprimer des fichiers de la base de donn√©es, il n'y en avait que 2. Apr√®s que l'utilisateur a supprim√© le fichier, le fichier se trouve toujours dans la base de donn√©es pendant un certain temps. <br><br>  Dans la proc√©dure de suppression d'un fichier de la base de donn√©es, nous avons ajout√© une entr√©e √† cette table locale avec les fichiers supprim√©s. <br><br>  Sur le serveur global avec des fichiers, ils ont fait un JOB qui t√©l√©charge une liste de fichiers √† partir de bases de donn√©es de fragments.  Il suffit d'appeler une proc√©dure √† partir d'une base de donn√©es partageable, cela fait un DELETE √† l'int√©rieur et affiche une liste de fichiers dans OUTPUT.  Dans MS SQL Server pull - tirer √† partir d'un serveur distant est beaucoup plus rapide que l'ins√©rer sur un serveur distant.  Tout cela se fait en blocs. <br>  Ces fichiers sont ensuite ajout√©s √† la table de suppression de files d'attente sur le serveur global. <br>  Une table avec un identificateur de fragment a √©t√© ajout√©e √† la table de file d'attente pour savoir d'o√π venait l'√©v√©nement de suppression. <br><br><h3>  Comment tout le monde l'a-t-il test√©? </h3><br>  Il existe 3 environnements: <br><br>  Le d√©veloppement est un environnement de d√©veloppement.  Le code est tir√© de la branche develop du gith.  Il est possible de d√©ployer une version diff√©rente du code sur IIS et de cr√©er plusieurs versions d'orchestration.  Il se connectera √† l'environnement de d√©veloppement √† partir du client dans vpn.  Jusqu'√† r√©cemment, l'inconv√©nient ne concernait que les bases de donn√©es, car toutes les modifications apport√©es √† la base de donn√©es peuvent interrompre le travail d'autres parties du syst√®me.  Ensuite, les bases ont √©t√© rendues locales.  Le code d√©j√† en cours d'ex√©cution peut √™tre vers√© sur des serveurs de d√©veloppement avec des bases de donn√©es afin de ne pas ruiner le travail de tout le monde.  Dans un environnement de d√©veloppement, il y a 3 fragments, au lieu de 12, qui sont sur la prod, mais cela suffit g√©n√©ralement pour tester l'interaction. <br><br>  Staging - l'environnement est le m√™me avec le prod selon la version du code (presque le m√™me, car c'est rare, mais il y a des changements directement sur le prod par les administrateurs).  Une copie du code de la branche ma√Ætre.  Parfois, certaines diff√©rences avec le code du prod ont √©t√© d√©tect√©es dans la base de donn√©es, mais en g√©n√©ral, elles sont identiques.  Il y a aussi 3 fragments sur Staging ainsi que sur la jeune fille.  Il n'y a pas de charge sur la mise en sc√®ne ainsi que sur le d√©veloppement.  Ici, vous pouvez ex√©cuter des tests d'int√©gration d√©j√† compl√®tement, car le code correspond au prod.  Tous les tests doivent r√©ussir, c'est une condition pr√©alable avant de passer au d√©ploiement. <br><br>  Perf lab, o√π les tests sont effectu√©s sous charge.  La charge est cr√©√©e √† l'aide de jmeter, 10 fois moins que sur la prod, et il n'y a qu'un seul fragment, ce qui cr√©e parfois des inconv√©nients.  Les donn√©es de vente sont prises, puis anonymis√©es et utilis√©es sur perf lab.  Tous les serveurs de la m√™me configuration que sur prod. <br><br>  La charge est 10 fois inf√©rieure, car on suppose qu'il s'agit d'une charge approximative qui vient √† la prod pour 1 fragment.  L'inconv√©nient est que la base mondiale est tr√®s sous-utilis√©e, contrairement aux ventes.  Et, si les modifications concernent principalement la base de donn√©es globale avec des fichiers, vous ne pouvez compter sur les r√©sultats des tests qu'environ - sur le prod cela peut ne pas fonctionner comme √ßa.  Bien que perf lab ne corresponde pas id√©alement √† la charge avec la prod, la possibilit√© de tester sous la charge aide d√©j√† √† d√©tecter de nombreuses erreurs avant de d√©ployer sur la prod. <br><br>  Il existe √©galement un serveur de sauvegarde o√π vous pouvez voir les donn√©es de la vente afin de d√©tecter certains cas.  En g√©n√©ral, la soci√©t√© fonctionne sous une licence qui interdit aux d√©veloppeurs de donner acc√®s aux donn√©es de vente et √† l'√©quipe d'administration et de support (Op√©rations) d'acc√©der au d√©veloppement, vous devez donc demander l'aide des administrateurs de base de donn√©es.  Les donn√©es de vente rendent les tests tr√®s faciles, car certains cas se produisent uniquement sur les donn√©es de production et il est tr√®s utile d'√©tudier les donn√©es dans un syst√®me r√©el afin de comprendre comment le syst√®me fonctionne pour l'utilisateur. <br><br>  Lors des tests sur perf lab, il s'est av√©r√© que la charge de suppression des fichiers du stockage n'√©tait pas du tout r√©alis√©e √† partir du mot.  Lors de la mise en ≈ìuvre du test de charge, nous avons choisi des demandes plus populaires du logiciel client, dont certaines n'√©taient pas incluses dans le nettoyage du stockage.  Puisqu'il s'agit d'une base de donn√©es, il s'est av√©r√© effectuer un test simplifi√© pour tous les objets modifi√©s avec l'appel des proc√©dures modifi√©es sur diff√©rentes donn√©es manuellement.  (sur les options que je connaissais). <br>  De plus, dans les tests d'int√©gration et de performance, l'accent a √©t√© mis sur le type de stockage de fichiers le plus populaire. <br><br>  Une caract√©ristique suppl√©mentaire du laboratoire de perf, qui n'a pas √©t√© imm√©diatement d√©couverte, est l'inad√©quation de la quantit√© de donn√©es dans certains tableaux sur le prod et le perf.  En ce sens que tous les emplois de vente travaillent sur la performance, qui g√©n√®rent des donn√©es, mais il n'y a pas toujours quelque chose qui traite les donn√©es g√©n√©r√©es dans la table.  Et, par exemple, la file d'attente de table susmentionn√©e pour la suppression sur la perf est beaucoup plus grande que sur la prod - 20 millions d'enregistrements sur la perf et 200 000 enregistrements sur la prod. <br><br><h4>  Processus de d√©ploiement </h4><br>  Le processus de d√©ploiement est assez standard.  Aucune modification n'a √©t√© apport√©e au code d'application pour cette t√¢che, toutes les modifications se trouvent uniquement dans la base de donn√©es.  Un DBA est toujours int√©gr√© √† la base de donn√©es; ce processus n'est pas automatis√©.  2 versions de scripts sont pr√©par√©es - pour appliquer les modifications et pour annuler les modifications, et une instruction pour DBA est √©crite.  2 versions de scripts sont toujours faites, et elles sont n√©cessairement test√©es pour la restauration et la restauration des modifications.  Et ces m√™mes scripts sont utilis√©s pour appliquer des modifications √† la pr√©paration et √† la perf perf avant de lancer l'int√©gration et les tests de charge. <br><br><h3>  Que s'est-il pass√© apr√®s le d√©ploiement? </h3><br>  Dans les 5 premi√®res heures apr√®s le d√©ploiement, 1 million d'√©v√©nements sont survenus lorsque le logiciel client a re√ßu une erreur lors de la tentative de t√©l√©chargement du fichier.  L'√©v√©nement ¬´fichier corrompu¬ª.  Cela signifie que le client essaie de t√©l√©charger le fichier, mais le fichier est introuvable sur le r√©f√©rentiel.  Habituellement, ces √©v√©nements ne sont pas du tout ou sont mesur√©s entre 1 et 2 000 par jour. <br><br>  Je dois dire tout de suite qu'il a fallu au moins 1 semaine pour trouver la cause de l'√©chec sur une √©quipe de 3 et parfois 5 personnes (dont moi). <br><br>  Nous avons collect√© la liste compl√®te des fichiers pour lesquels l'√©v√©nement ¬´File Corrupted¬ª est survenu. <br><br>  Malgr√© le fait qu'il y avait plus d'un million d'√©v√©nements et qu'ils provenaient tous d'utilisateurs diff√©rents, de soci√©t√©s diff√©rentes, il n'y avait que 250 fichiers uniques dans cette liste. <br><br>  DBA sur le serveur de sauvegarde a √©t√© d√©clench√© pour enqu√™ter sur les sauvegardes de base de donn√©es au moment o√π les √©v√©nements sont arriv√©s.  Il y a pas mal de tableaux dans les bases du projet avec toutes sortes de journaux qui ont aid√© √† l'analyse.  M√™me lors de la suppression d'informations de la base de donn√©es, un journal est ajout√© √† ce qui a √©t√© supprim√© et par quel √©v√©nement.  Sur le prod, ces enregistrements sont stock√©s pendant 1 semaine, puis fusionn√©s sur le serveur d'archives. <br><br>  Et les tableaux avec journaux ont √©galement beaucoup aid√© √† analyser ce qui s'est pass√©: <br>  Un journal complet avec les √©v√©nements client est maintenu sur chaque fragment <br><br>  Sur le serveur global: <br><br><ul><li>  Journal des demandes de t√©l√©chargement de tous les fichiers par les utilisateurs </li><li>  Enregistrer les fichiers t√©l√©charg√©s sur le syst√®me par les utilisateurs </li><li>  Journal des √©v√©nements FileCorrupt </li><li>  Fichier journal pour annuler la suppression du stockage </li><li>  Journal des fichiers supprim√©s de la base de donn√©es </li></ul><br>  De plus, un ELK avec les journaux d'application √©tait disponible. <br><br>  Nous avons r√©ussi √† r√©p√©ter l'erreur sur l'environnement de d√©veloppement, ce qui a confirm√© l'exactitude de l'hypoth√®se.  Au d√©but, personne ne prenait cette hypoth√®se au s√©rieux, car il √©tait tr√®s difficile de croire que tant de facteurs co√Øncidaient en m√™me temps et que de nombreux utilisateurs venaient √† ce moment pr√©cis. <br><br><h3>  Qu'est-ce qui a mal tourn√©? </h3><br>  Il s'est av√©r√© que le syst√®me avait environ 250 (√† titre de comparaison, des milliards de fichiers dans le syst√®me) de m√©ga fichiers super duper populaires.  250 oui! <br><br>  Ces fichiers √©taient encore tr√®s anciens.  Au moment o√π ces fichiers ont √©t√© t√©l√©charg√©s sur le syst√®me, un autre syst√®me pour g√©n√©rer la cl√© de fichier sur le stockage a √©t√© utilis√©. <br><br>  Il s'est av√©r√© que pour ce type de cl√©, la m√©thode de suppression physique du stockage physique se comportait diff√©remment des autres fichiers. <br><br>  Dans la classe avec suppression, il y a un bloc de code avec une condition sp√©cifique pour les fichiers avec l'ancienne cl√©.  Le syst√®me, au moment de la suppression, avant de v√©rifier que le fichier ne se trouve pas sur des fragments, d√©place cet ancien fichier vers un autre emplacement.  Eh bien, cela n'a pas fonctionn√©. <br><br>  Et il s'est av√©r√© qu'au moment o√π le fichier a √©t√© d√©plac√© (et je rappellerai qu'il est tr√®s populaire), si l'un des utilisateurs essaie de lui donner un nouveau droit d'utilisateur, le logiciel client va dans le stockage de ce fichier, mais le fichier n'est pas au bon endroit.  Comme il est d√©plac√©, cela ne fonctionne pas.  Et le logiciel client envoie un message indiquant que le fichier est cass√©.  Dans la base de donn√©es, il est marqu√© comme cass√©.  Et toutes les informations sont supprim√©es de la base de donn√©es (enfin, presque toutes). <br><br>  En attendant, notre routine de v√©rification des fragments d√©couvre que le fichier est utilis√©.  Et envoie une r√©ponse dont vous avez besoin pour le renvoyer.  Mais toutes les informations ont d√©j√† √©t√© supprim√©es de la base de donn√©es et il est impossible de les renvoyer. <br><br>  Dr√¥le hein? <br><br>  Autrement dit, lorsque le fichier a √©t√© supprim√©, l'utilisateur √©tait dans cette p√©riode de temps lorsque le fichier a √©t√© d√©plac√©, les fragments v√©rifi√©s et c'est √† ce moment-l√† que l'utilisateur a envoy√© une demande de t√©l√©chargement. <br><br>  Le voici: une charge √©lev√©e en action, lorsque les matchs les plus incroyables vous correspondent. <br><br><img src="https://habrastorage.org/webt/_y/m6/me/_ym6meu2s43ds32d1ngjzspn67k.png"><br><br>  Apr√®s avoir r√©cup√©r√© de la surprise et avoir tout restaur√©, nous nous sommes assur√©s que les fichiers des utilisateurs sont vivants, car ils ont √©t√© restaur√©s √† partir des disques d'autres clients. <br><br>  Naturellement, tout s'est bien pass√© dans les tests, car pendant le test, les nouveaux fichiers ont √©t√© supprim√©s avec un nouveau type de cl√© utilis√© au cours des 5 derni√®res ann√©es. Ces fichiers ne sont pas transf√©r√©s vers un autre emplacement de stockage au moment de la suppression. <br><br>  Notre optimisme a diminu√© et nous avons d√©cid√© de ne pas emprunter la voie la plus optimiste. <br><br><h3>  R√©trospective </h3><br>  Nous avons d√©cid√© que nous devions ajouter des tests pour diff√©rents types de stockages <br>  Ajouter une charge √† perf lab qui utilise les appels lors de sa suppression du stockage <br>  Fermer les conditions de course c√©l√®bres <br>  Ajouter une surveillance (bien que ce soit dans les plans, mais ne cadrait pas avec la port√©e d'origine) <br><br><h3>  √Ä propos de la surveillance </h3><br>  Ils ont d√©cid√© de faire une surveillance tout de suite, mais il s'est estomp√© en arri√®re-plan, car il √©tait n√©cessaire de se d√©ployer plus rapidement. <br><br>  Pour la surveillance, le projet a utilis√© Zabbix, ELK, Grafana, NewRelic, SQL Sentry et une version de test d'AppDynamics. <br><br>  De cela, sur pef lab √©tait NewRelic et SQL Sentry. <br><br>  Nous avons d√©j√† mesur√© toutes les m√©triques du syst√®me et donc, nous voulions mesurer les m√©triques de l'entreprise.  J'avais de l'exp√©rience dans l'organisation d'une telle surveillance via Zabbix - nous avons d√©cid√© de faire de m√™me. <br><br>  Le sch√©ma est tr√®s simple dans la base de donn√©es pour cr√©er un tableau dans lequel collecter les m√©triques n√©cessaires par JOB et une proc√©dure qui t√©l√©chargera les m√©triques collect√©es vers Zabbix. <br><br>  Mesures: <br><br><ul><li>  Le nombre de fichiers dans la file d'attente √† supprimer sur une base globale </li><li>  Nombre de fichiers mis en file d'attente par le serveur </li><li>  Le nombre de fichiers envoy√©s au programme de d√©sinstallation √† partir du r√©f√©rentiel </li><li>  Nombre de fichiers supprim√©s </li><li>  Nombre d'√©v√©nements FileCorrupt </li><li>  Le nombre de fichiers √† supprimer sur chaque fragment </li></ul><br>  La surveillance a √©t√© impl√©ment√©e et d√©ploy√©e sur le prod s√©par√©ment, avant qu'ils ne commencent √† d√©ployer une nouvelle impl√©mentation de suppression. <br><br><h3>  Nouvelle solution </h3><br>  En g√©n√©ral, nous avons d√©cid√© qu'il valait mieux manger avec exc√®s que de ne pas dormir, et avons fait un nouveau plan. <br><br><ol><li>  v√©rifiez le m√™me fragment que personne n'utilise le fichier √† coup s√ªr et transf√©rez uniquement les fichiers inutilis√©s vers le serveur; </li><li>  lors du transfert vers le serveur, collectez tous les fichiers de la table et v√©rifiez que les fichiers ne sont pas utilis√©s sur les fragments avant d'√™tre plac√©s dans la table de file d'attente de file d'attente; </li><li>  lorsque vous utilisez un fichier et que vous le recherchez dans le syst√®me, marquez la file d'attente de retrait dans le tableau comme un fichier n√©cessitant une v√©rification; </li><li>  renvoyer uniquement les fichiers pour lesquels aucune recherche n'a √©t√© effectu√©e; </li><li>  les fichiers qui ont √©t√© recherch√©s, v√©rifiez √† nouveau les fragments; </li><li>  en g√©n√©ral, supprimez la coche dans la proc√©dure qui supprime le fichier, car elle devrait fonctionner rapidement - et le fichier utilis√© ne devrait pas y parvenir en principe; </li><li>  prendre en compte dans la proc√©dure que tout supprime par le fichier battu qu'il est en cours de suppression, et ne pas supprimer les informations le concernant. </li></ol><br>  Le point 6 lors du d√©ploiement comprenait la suppression du ch√®que en plusieurs √©tapes.  Tout d'abord, ils ont quitt√© le ch√®que, puis une semaine plus tard, le contr√¥le des dossiers des employ√©s de l'entreprise a √©t√© d√©sactiv√©, apr√®s 2 semaines, ils ont compl√®tement d√©sactiv√© le ch√®que. <br><br><h3>  De quoi aviez-vous besoin de changer dans le code? </h3><br>  Encore une fois, toutes les modifications s'appliquent uniquement √† la base de donn√©es. <br><br>  L'ampleur des changements √©tait la plus importante sur le serveur mondial: <br>  Ajoutez une table interm√©diaire dans laquelle ajouter tous les fichiers t√©l√©charg√©s √† partir de fragments. <br>  Faites un JOB qui v√©rifie les fichiers sur la table interm√©diaire qu'ils ne sont pas utilis√©s sur les fragments. <br><br>  Dans la file d'attente des fichiers supprim√©s, ajoutez un champ avec la date du dernier acc√®s au fichier et ajoutez un index. <br><br>  Trouvez toutes les proc√©dures avec acc√®s au fichier - il s'est av√©r√© 5 proc√©dures.  Ajoutez-leur un bloc modifiant la date de la derni√®re utilisation dans la table de file d'attente.  La date change √† chaque fois, qu'elle soit remplie ou non. <br><br>  Ajoutez le programme de suppression aux proc√©dures d'√©mission de fichiers afin qu'il n'affiche que les fichiers dont la date d'utilisation est vide. <br><br>  JOB,          (  10 ,  ,        ,    2 ,   )     .      ,    ,       .       ,      ,          ,            . <br><br>  : <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dans la proc√©dure qui supprime des fichiers du tableau avec des fichiers supprim√©s, vous avez d√ª ajouter une v√©rification que le fichier n'√©tait pas utilis√©. </font><font style="vertical-align: inherit;">La proc√©dure a perdu beaucoup de sa simplicit√© et de sa beaut√© - dans DELETE avec la sortie, ils ont simplement ajout√© NOT EXISTS. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nous avons ajout√© un JOB, qui en arri√®re-plan a frapp√© √† partir des fichiers de table utilis√©s sur le serveur.</font></font><br><br><h4>  Les tests </h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Des sc√©narios d'utilisation de toutes les options de stockage ont √©t√© ajout√©s aux tests d'int√©gration. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ils ont √©galement √©crit de nouveaux cas pour tester de nouvelles fonctionnalit√©s de suppression de fichiers. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Perf Lab a ajout√© une charge au serveur global. </font><font style="vertical-align: inherit;">De plus, nous avons ajout√© une charge correspondant √† la suppression de fichiers du stockage.</font></font><br><br><h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> D√©ployer </font></font></h4><br>          . DBA    ,           -   .     ,     . <br><br> -    JOB           ,  ,         . <br><br><h3>  </h3><br>              . <br> ,     ,          . <br><br>      S3   2   .         ,     ,          . <br><br>    -      ,      ,    -   . </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr427895/">https://habr.com/ru/post/fr427895/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr427879/index.html">Comment je suis pass√© de Python √† Julia (et pourquoi)</a></li>
<li><a href="../fr427883/index.html">Pr√©sentation de la virtualisation, des conteneurs et de Kubernetes: 18 ressources cloud</a></li>
<li><a href="../fr427889/index.html">Faux, faux, FAUX! m√©thodes d'att√©nuation des DDoS</a></li>
<li><a href="../fr427891/index.html">Des millions de personnes peuvent √™tre attaqu√©es par une vuln√©rabilit√© dans la plate-forme de conf√©rence Cisco WebEx</a></li>
<li><a href="../fr427893/index.html">Bloody Lola sur Omega 2 ou Python √©touffant √† l'Halloween</a></li>
<li><a href="../fr427897/index.html">Analyser un imageur √† r√©sonance magn√©tique II: les m√©tamat√©riaux en IRM</a></li>
<li><a href="../fr427899/index.html">JsonWriterSax - une biblioth√®que pour cr√©er JSON</a></li>
<li><a href="../fr427901/index.html">Comment ne pas utiliser l'API de flux Node.js</a></li>
<li><a href="../fr427905/index.html">Extraction de nourriture ou Carrefour √† travers les yeux d'un pirate</a></li>
<li><a href="../fr427907/index.html">Tir de drone, r√¢teau, hacks de vie, d√©veloppement personnel et carri√®re de photographe / vid√©aste: nouveau podcast GLPH</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>