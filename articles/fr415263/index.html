<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🥈 🐨 ⏺️ Comment nous avons ajouté des entrées à la carte et réduit la taille des bases de 10% 🤚🏻 👨‍🏫 👨‍❤️‍👨</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="À la fin du mois dernier, 2GIS a commencé à afficher des porches. Nous montrons les entrées aux organisations depuis 2013, et les entrées semblent êtr...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Comment nous avons ajouté des entrées à la carte et réduit la taille des bases de 10%</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/2gis/blog/415263/"><img src="https://habrastorage.org/webt/en/6k/fp/en6kfpoagwhj42loeubjzo0rzo0.jpeg"><br><br>  À la fin du mois dernier, 2GIS a commencé à afficher des porches.  Nous montrons les entrées aux organisations depuis 2013, et les entrées semblent être les mêmes entrées.  Alors pourquoi maintenant?  Tous les produits et processus internes sont prêts, il vous suffit d'ajouter un peu plus et de corriger l'affichage dans l'interface utilisateur. <br><br>  En plus de la réponse standard «Il y avait d'autres priorités», il y en a aussi une qui n'est pas tout à fait standard: «Ce n'est pas si simple.»  Cet article explique quelles étaient les difficultés et comment nous les avons résolues. <br><a name="habracut"></a><br>  Premièrement, l'entrée n'est pas l'entrée.  Ainsi, une seule entrée peut conduire à plusieurs entrées, généralement de différents côtés du bâtiment.  La définition de «bloc d'appartements (à plusieurs niveaux) avec une entrée commune» est également incorrecte.  Il arrive qu'une entrée mène au premier étage de l'entrée, et l'autre - au deuxième étage et aux suivants. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/zz/w7/pr/zzw7prchtb-1ictjkzvrfd6c_-8.png" alt="Entrée avec deux entrées"></div><br>  Deuxièmement, je veux chercher des entrées. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/yb/ty/ut/ybtyutk7jllplorjkmqiywob1ha.png" alt="Entrées dans les résultats de recherche"></div><br>  C'est une opportunité assez recherchée, car les entrées sont loin d'être toujours situées de manière évidente. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/fm/j7/41/fmj741efgjyhdj29y3udi2lsjym.png" alt="Maison avec la numérotation d'entrée pas la plus évidente"></div><br>  En plus des numéros d'entrée, il existe également des noms (généralement à partir d'une seule lettre). <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/ef/wk/2d/efwk2d9a_gsaw5vokxqoyiqzuzm.png" alt="Les lettres dans les noms des porches"></div><br>  Ou même comme <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">à Kaliningrad</a> - une adresse distincte est affectée exactement à l'escalier. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/rw/iz/4w/rwiz4wywzkk_nnjll6xzrpy5k1o.png" alt="Numérotation indépendante des entrées à Kaliningrad"></div><br>  Troisièmement, nous avons décidé que si nous cherchions des entrées, pourquoi ne pas soutenir immédiatement la recherche par numéro d'appartement.  Ils ont décidé - et collecté les gammes d'appartements, cependant, jusqu'à présent sans reliure au sol.  Comme pour les entrées, les appartements peuvent avoir non seulement des noms numériques (le plus souvent, il existe des variantes avec la lettre «a»), et les plages sont loin d'être toujours continues.  Dans les vieilles maisons de Saint-Pétersbourg, la numérotation est assez étrange: les appartements 1 et 3 peuvent être dans la même entrée, et l'appartement 2 peut être dans la partie opposée du bâtiment. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/m2/se/uh/m2seuh3ovc_5ob8b1ulcdlru8x8.jpeg" alt="Entrée typique du vieux Pétersbourg"></div><br><div class="spoiler">  <b class="spoiler_title">Digression lyrique sur la validation des données</b> <div class="spoiler_text">  N'essayez pas de rendre la validation des données collectées très intelligente - dans la capitale du nord, il y a des cas où vous pouvez entrer dans un appartement à partir de plusieurs entrées, et dans certaines colonies européennes, l'adresse contient en plus de la maison le nom de l'entrée et le numéro de l'appartement dans cette entrée.  Peter plaît également avec un bâtiment avec deux huitièmes entrées. <br></div></div><br>  Quatrièmement, je veux toujours montrer les entrées sur la carte, et pas seulement lorsque nous étudions les informations d'une maison ou d'une entrée particulière. <br><br>  Et enfin, il y a de nombreuses entrées - selon les estimations actuelles, il y en a environ cent mille à Moscou seulement.  La première évaluation «sur les doigts» a donné quelques chiffres astronomiques - nous avons fait une erreur une fois toutes les six fois sur le plus grand côté. <br><br>  <b>Conclusions:</b> <br><br><ul><li>  Nous avons besoin d'une entité supplémentaire, qui a son propre nom, contient une liste de gammes d'appartements et auxquelles les entrées du bâtiment peuvent être attachées. </li><li>  Nous rechercherons cette entité et lui montrerons une fiche d'information distincte. </li><li>  Nous sommes obligés soit d'augmenter à nouveau la taille des données téléchargées par l'application mobile, soit d'afficher ces données uniquement s'il y a une connexion réseau, soit de proposer quelque chose avec le format. </li></ul><br><h3>  Accéder à la solution </h3><br>  Les deux premiers points nécessitent des changements dans les produits internes et externes, mais c'est une routine.  Ce dernier est une question complètement différente.  Comme nous n'aimons pas déranger les utilisateurs, nous fixons une restriction: les données doivent être disponibles hors ligne et leur ajout ne doit pas augmenter la taille des bases de données. <br><br>  Comment?  D'une part, vous devez réduire la taille actuelle des données, d'autre part, vous pouvez penser à un tel format de stockage des informations sur les entrées que la quantité de données supplémentaires est minimale. <br><br><h3>  Réduisez le volume de données </h3><br>  Il existe deux façons de le réduire: <br><br><ul><li>  Examinez attentivement les données stockées et essayez de trouver quelque chose dont nous pouvons nous passer. </li><li>  Réfléchissez à la possibilité de stocker les données de manière plus efficace que nous ne le faisons actuellement. </li></ul><br><div class="spoiler">  <b class="spoiler_title">Evolution du format de stockage des données avant l'ère des porches</b> <div class="spoiler_text"><h4>  La toute première option et la plus simple </h4><br>  La méthode traditionnelle pour enregistrer des données complexes consiste à les <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">normaliser</a> , à les placer dans une base de données de table et à créer des <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">index</a> auxiliaires.  Une fois, 2GIS a fait exactement cela, sauf pour réduire la taille, le contenu de chaque tableau a été trié de sorte que le plus souvent possible, les valeurs des cellules coïncident avec les valeurs de la ligne précédente.  Nous avons stocké les colonnes indépendamment et réduit les séquences de valeurs identiques. <br><br>  Un exemple très simplifié d'optimisation du stockage d'une table avec des bâtiments: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/bh/jw/gy/bhjwgyi3kccb_sx2l4zho_pqlsy.png" alt="Un exemple de stockage de table optimisé"></div><br>  La normalisation vous permet de réduire la redondance, mais il y a aussi un côté négatif - pour former un élément d'interface utilisateur pour un objet, vous devez effectuer plusieurs requêtes qui accèdent à un grand nombre de tables.  Cependant, à cette époque, ces tableaux étaient utilisés non seulement pour obtenir des données à afficher, mais pour presque toutes les tâches, y compris la recherche de texte et divers types de recherche de voyage.  Pour toutes ces tâches, les données normalisées nous ont juste permis de réduire la quantité d'informations traitées. <br><br>  Les données pour le rendu de la carte avaient déjà leur propre format binaire et étaient stockées dans un bloc séparé.  Progressivement, nous avons créé des formats binaires distincts pour accélérer la recherche d'itinéraires et les recherches de texte.  Seules les informations sont restées dans la base de données, qui a été utilisée pour afficher les fiches d'objets, ainsi que pour les liens de certains objets avec d'autres. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/yd/4k/jh/yd4kjhjwh0pjpbj8bqmvksnqngk.png" alt="Cartes et communications"></div><br><h4>  Simplifiez le travail </h4><br>  Comment pouvez-vous simplifier le travail avec les données?  Recevez toutes les données nécessaires pour dessiner une carte à la fois par l'identifiant de l'objet.  Étant donné que la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">version en ligne</a> reçoit déjà toutes les données de l' <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">API</a> pour une demande au <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">format JSON</a> , vous pouvez en même temps combiner les formats utilisés par tous nos produits. <br><br>  Les deux json pour l'affichage des cartes et les communications doivent être reçues pour un nombre limité d'objets, de la puissance de plusieurs dizaines à la fois.  Mais il existe des scénarios où des attributs individuels doivent être obtenus à la fois pour des échantillons de grande taille, jusqu'à des centaines de milliers.  Il est plus logique de séparer ces attributs dans une entité distincte avec un format de stockage distinct - propriétés.  Les propriétés peuvent être de type et stockées plus efficacement au format binaire. <br><br>  Une approche naïve pour stocker json consiste à utiliser une base de données de valeurs-clés.  Prenons Moscou comme exemple, comme le plus grand de nos projets.  Même sous la forme la plus simple possible - pour chaque objet json lui-même est stocké, 8 octets d'identifiant et un caractère délimiteur - le répertoire prendra 1,9 Gio.  La taille résultante est presque six fois plus grande que l'option décrite précédemment, et cela est toujours sans liens ni propriétés. <br><br>  Nous avons délibérément gonflé les objets en les remplissant d'informations sur tout ce qui pourrait être nécessaire pour afficher leurs cartes, mais vous devez toujours stocker les noms de champ, les guillemets, les virgules et les crochets. <br><br><h4>  Compresser les données </h4><br>  La normalisation n'est pas le seul moyen d'éliminer la redondance.  La deuxième méthode populaire est la compression.  L'archive lzma de notre fichier incroyablement épais ne prend que 55 Mo. <br><br>  Bien sûr, nous ne pouvons pas utiliser ce format directement, car pour accéder à un objet arbitraire, nous devons décompresser toutes les données stockées précédemment et les archives lzma ne sont pas décompressées très rapidement. <br><br>  Comment obtenir un accès aléatoire rapide d'une part, et d'autre part, en compressant les données, réduire la taille de l'espace requis?  La réponse est d'utiliser la pagination. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/ag/lk/jr/aglkjrbolu5w7cclmf-_cuqsjly.png" alt="Format de stockage binaire"></div><br>  Maintenant que les données sont paginées, nous pouvons compresser chacune individuellement.  Pour accéder à un endroit arbitraire, nous devons décompresser et numériser la page, mais c'est beaucoup plus rapide que de décompresser et de numériser l'archive entière. <br><br>  Dans ce format, toutes les données sont stockées - json'y, relations et propriétés.  Reste à associer ces données aux identifiants des objets.  Pour chaque identifiant, nous devons stocker une ou plusieurs paires <i>&lt;numéro de stockage, numéro de données dans le stockage&gt;</i> . <br><br><img src="https://habrastorage.org/webt/7b/db/tz/7bdbtzgxk03-5c189bv4sesw7b8.png" alt="Format simplifié des relations entre l'identifiant d'objet et les données dans les stockages"><br>  Tous les numéros de série, décalages et tailles sont stockés dans un format compressé similaire à <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">UTF-8</a> , où les petites valeurs ne prennent qu'un octet.  Cela nous permet de réduire la taille des liens en triant simplement le contenu des référentiels binaires pour réduire la fréquence d'occurrence. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/od/9w/zv/od9wzvyv9ql8ps8g2gmmyq8njmo.png" alt="Trier et réduire la taille"></div><br>  Certaines propriétés ont de nombreuses valeurs de fréquence, et donc le tri donne un gros gain de taille.  En revanche, à cause de cela, le numéro de série des données ne peut pas coïncider pour tous les stockages. <br><br>  De plus, loin de tous les objets, des données sont présentes dans tous les stockages, et donc stocker des numéros de stockage est plus efficace que de référencer des objets vides. <br><br><h4>  Accélérez la récupération des données </h4><br>  Le format décrit présente un problème.  Pour trouver le numéro de l'objet qui stocke les indices pour l'identifiant spécifié, nous devons exécuter une recherche binaire à l'intérieur des données du premier objet.  Pour ce faire, vous devez soit charger 10,9 Mio en mémoire, soit effectuer 21 lectures supplémentaires.  Les deux solutions ne nous conviennent pas et nous réduisons donc le nombre de lectures en stockant les données dans un arbre. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/8b/cx/to/8bcxto_pgnqn7drgqi5hkiae_su.png" alt="Format de l'arborescence pour une recherche rapide des données par identifiant"></div><br>  Nous regroupons les données sur 32 objets, et aux niveaux intermédiaires, nous stockons 128 des premiers identifiants des nœuds imbriqués.  Nous avons ajouté trois niveaux de l'arborescence et réduit le nombre de lectures supplémentaires à quatre (mais en fait, en tenant compte de la mise en cache des nœuds d'arbre précédemment lus, même à 1-3).  Prix ​​- un peu moins de 400 Ko. <br><br>  À ce stade, nous sommes assez efficaces pour stocker les relations et les propriétés, mais les json occupent beaucoup d'espace.  C'est compréhensible.  Plus la taille de la page est grande, plus il y a d'objets et plus l'algorithme de compression est en mesure de déterminer quelles informations sont redondantes.  Mais, d'un autre côté, plus nous devons travailler pour lire un seul objet.  Les Json sont des objets assez gros, et donc il y en a très peu sur une seule page.  Par conséquent, vous devez aider l'algorithme à mieux faire son travail. <br><br><h4>  Diviser JSON en plusieurs parties </h4><br>  Premièrement, de nombreux objets ont des schémas de données correspondants; seules les valeurs d'attribut diffèrent.  Deuxièmement, de nombreuses valeurs d'attribut sont les mêmes, même pour des objets avec des schémas différents.  Nous séparerons les schémas et les valeurs d'attribut dans des stockages séparés, et nous stockerons les json sous la forme: un lien vers un schéma + des liens vers des valeurs d'attribut. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/pq/n8/ef/pqn8ef7v2wv7bkkvbgguql2vggq.png" alt="Division de Json en schéma et données"></div><br>  Dans notre schéma de données, le nombre de noms d'attribut est limité.  Nous pouvons donc les mettre dans un fichier séparé et stocker le numéro à la place.  Nous apporterons également quelques modifications supplémentaires, en tenant compte du fait que les json sont toujours des objets. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/gq/i_/ak/gqi_akxdvngmmjmgjrg60y-5luu.png" alt="Format réel pour le stockage des schémas d'objet json"></div><br>  Oui, nous avons essentiellement compressé nos données nous-mêmes, réduisant la portée du fonctionnement de l'algorithme.  Mais d'un autre côté, nous avons considérablement ralenti l'accès aux données, et l'algorithme aide toujours, en compressant des valeurs similaires stockées à proximité. <br><br>  Nous avons fixé la taille de la page à 1 Ko et il se trouve que si nous avons optimisé le format afin que, d'une part, la lecture ne soit pas très lente, et d'autre part, les données aient été emballées le mieux possible, nous ... avons déjà contourné les «tables optimisées» à la fois en taille et pour une facilité d'utilisation.  Mais ce n'est pas pour rien que tout cela était!  Le gain maximal doit provenir de la compression des valeurs des attributs, des propriétés et des schémas.  Nous incitons zlib et vérifions que, dans le contexte du reste du travail, la lecture des données de la base de données prend peu de temps.  Satisfait du résultat, nous passons à d'autres tâches. <br></div></div><br><h3>  Débarrassez-vous de l'inutile </h3><br>  Nous commençons à réduire en recherchant des données dont vous pouvez vous débarrasser.  Il s'avère que pendant l'existence du format, nous avons appris à nous passer de la plus grande connexion.  C'est 10% de la taille! <br><br>  Le code de ces données était toujours lié, mais les modifications nécessaires sont assez triviales.  Mais les applications déjà publiées ne peuvent pas être facilement modifiées.  Nous nous efforçons de maintenir aussi longtemps que possible non seulement la rétrocompatibilité, mais aussi la compatibilité directe.  Et si le premier est familier à tout le monde, alors beaucoup peuvent ne pas penser au second avec bonheur.  Nous sommes obligés de le supporter en raison de la queue assez longue d'utilisateurs qui, pour diverses raisons, ont désactivé les mises à jour automatiques et ne sont pas pressés de passer à une nouvelle version de l'application. <br><br><div class="spoiler">  <b class="spoiler_title">Répartition des utilisateurs par version</b> <div class="spoiler_text"><div style="text-align:center;"><img src="https://habrastorage.org/webt/ms/ld/kq/msldkqhkepk1gsouayqmglu36zo.png" alt="Repartition des utilisateurs par version"></div><br>  Tout en haut se trouve la répartition des utilisateurs par les dernières versions de l'application Android.  Le fond est iOS. <br><br>  Il est facile de remarquer que les utilisateurs d'appareils iOS sont mis à jour beaucoup plus facilement, mais même parmi eux, il y a beaucoup d'utilisateurs d'anciennes versions. <br></div></div><br>  Nous publions également de nouvelles données pour la version figée pour Windows Phone.  Et bien que les utilisateurs de WP8 ne représentent qu'une petite fraction de notre audience, en chiffres absolus, c'est presque 200 000 par mois. <br><br>  Nous avons depuis longtemps un mécanisme qui nous permet de produire plusieurs formats de données et détermine automatiquement quelles versions doivent obtenir quoi.  L'opportunité est bonne, mais vous devez toujours apprendre à décharger ces formats.  La première grande tâche a été d'implémenter un service qui recevra toutes les données et filtrera le nouveau pour l'ancien format de base de données et l'ancien pour le nouveau. <br><br>  Un bon bonus du travail effectué est de réduire la taille des mises à jour mensuelles, car la connexion à distance a considérablement changé d'un mois à l'autre, gonflant la taille des différences. <br><br>  Si vous regardez les données restantes, au total, vous pouvez obtenir les mêmes 10%, cependant, le prix sera incomparablement plus élevé.  Jusqu'à présent, nous avons décidé de ne pas toucher. <br><br><h3>  Optimiser le format de stockage actuel </h3><br>  Comme il a été écrit ci-dessus, nous avons créé des pages de 1 Ko et emballé pas tous les référentiels binaires. <br><br>  La première chose que nous faisons est d'essayer de compresser également les pages avec des liens et de vérifier que la différence de vitesse de réception des données se situe dans la région de l'erreur. <br><br>  L'élément suivant consiste à choisir la taille de page optimale.  Plus la taille de la page est grande, plus les données sont compressées efficacement, mais plus les données sont lues lentement.  Et si, avec l'augmentation de la taille des pages, les coûts de temps et de mémoire augmentent linéairement, le gain devient de moins en moins perceptible.  Après les tests, nous décidons d'augmenter la taille à 8 Ko. <br><br><div class="spoiler">  <b class="spoiler_title">L'effet de la taille de la page sur les grandes sélections</b> <div class="spoiler_text">  Si l'agrandissement de la page devrait ralentir les petites sélections, les grandes - à partir de centaines d'éléments - sont même accélérées.  Cela signifie que dans le bon sens, vous devez choisir différentes tailles pour les stockages en fonction des cas d'utilisation des données qui y sont stockées. <br></div></div><br>  Au total, seuls ces deux points peuvent réduire la base de 18%! <br><br><h3>  Changer le format de compression </h3><br>  zlib, bien sûr, est un classique, mais <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">zstd</a> fournit une vitesse de décompression plus élevée avec un taux de compression plus élevé.  De plus, zstd vous permet de créer d'abord un dictionnaire unique pour toutes les données disponibles, puis de l'enregistrer une fois et de le compresser avec toutes les pages.  Ainsi, nous ralentissons décemment le processus de création d'un fichier avec une base de données, mais nous pressons 8% supplémentaires. <br><br><h3>  Ajouter des porches </h3><br><h4>  Moyen facile </h4><br>  Le moyen le plus simple est de faire de chaque entrée un objet distinct, de les indexer séparément (selon des estimations approximatives + 10% de la taille de l'indice) et de stocker séparément leur géométrie dans les données pour dessiner la carte. <br><br>  Cette méthode gonflera la base de 3% au total.  Lors des étapes précédentes, nous avons gagné plus qu'assez pour nous calmer et travailler avec les entrées selon le schéma habituel, mais ... au moment du début des travaux, nous n'étions pas sûrs de cela, et travailler sur un format alternatif était en parallèle. <br><br><div class="spoiler">  <b class="spoiler_title">Évaluation détaillée, pour les personnes intéressées</b> <div class="spoiler_text">  Essayons d'évaluer l'augmentation de la taille du package avec la base de données pour chaque objet: <br><br>  8 octets - identifiant, <br>  6 octets - nombre de stockages utilisés (données + cinq propriétés; les propriétés sont extraites des données principales et stockées sous forme binaire, car elles sont souvent nécessaires pour un grand nombre d'objets à la fois), <br>  3 octets - index dans l'entrepôt de données, <br>  2 octets - décalage des données de l'objet, <br>  5 octets - valeurs de données - 2 octets par circuit, 3 octets en moyenne pour les informations d'appartement (nous pensons qu'il y aura de nombreux doublons et que les données elles-mêmes sont stockées une fois), <br>  6 octets - coordonnées de données décalées (d'autres propriétés ont de nombreuses valeurs en double et s'effondreront), <br>  8 octets - valeurs de coordonnées. <br><br>  Total 38 octets par objet.  Dans le cas de Moscou, cela représente 4,5 Mio pour plus de 124 000 intrants collectés. <br><br>  Ensuite, nous devons stocker également la connexion entre la maison et les entrées, c'est 2,5 octets pour chaque immeuble et 8 octets pour chaque entrée.  1 MiB de plus. <br><br>  Maintenant, nous considérons combien tout cela prendra sur la carte. <br><br>  Tout d'abord, nous devons stocker la géométrie.  Pour les polylignes, le premier point prend toujours 8 octets et tous les suivants sont stockés sous forme de différences de la précision requise.  Ici, nous sommes satisfaits de la précision en décimètres.  La plupart des entrées se composent de deux points qui ne sont pas très éloignés l'un de l'autre, et donc on peut supposer que la géométrie elle-même occupera 10 octets.  Total 1,2 Mio. <br><br>  Nous devons également associer l'identifiant d'entrée et l'objet à sa géométrie.  Un index est le même stockage binaire que tout le reste, seules la destination de communication (1 octet), le numéro de couche (1 octet) et le numéro d'objet (3 octets) sont stockés.  Plus 8 octets par identifiant, ainsi qu'un arbre de recherche rapide.  Total de 1,5 Mio. <br><br>  Comme cela a été dit au tout début de l'article, nous voulons afficher en permanence les entrées sur la carte, et la façon la plus simple de le faire est de décharger une autre couche avec des points, mais ... vous pouvez également réutiliser la couche avec des géométries, créant un nouveau <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">symbole</a> qui affichera l'image dont nous avons besoin au dernier point de la polyligne. <br><br>  10% de l'index de recherche est de 5,9 MiB.  Pour résumer tout, nous obtenons 14,2 MiB, ce qui est juste un peu plus de 3%. <br></div></div><br><h4>  Option actuelle </h4><br>  Au lieu d'indexer les entrées et de gonfler l'index de recherche, nous recherchons des maisons, mais balisons en outre les mots de la requête et en extrayons des adresses (pertinentes pour la recherche d'entrées à Kaliningrad), des entrées et / ou des appartements.  Ainsi, à la sortie, nous avons l'identifiant de la maison et les champs de texte tapés, par lesquels nous devons trouver l'escalier dont nous avons besoin. <br><br><div class="spoiler">  <b class="spoiler_title">Remarque</b> <div class="spoiler_text">  C'est un point controversé.  D'une part, cela nous permet de réduire la taille de la base de données, et d'autre part, il impose des restrictions sur le format d'entrée - les entrées ne seront pas sur de nombreuses demandes qui seraient correctement traitées en utilisant une recherche honnête. <br></div></div><br>  De plus, au lieu de décharger des objets individuels, nous incluons toutes les informations sur les entrées directement dans les données du bâtiment. <br>  Et enfin, nous transférons une partie des géométries dans le répertoire. <br><br>  Ce dernier mérite d'être divulgué plus en détail. <br><br>  Tout d'abord, nous remarquons que la plupart des entrées sont deux points et ont la même longueur.  Ces entrées peuvent être stockées sous la forme d'un point + direction, c'est-à-dire  économisez 1 octet par entrée. <br><br>  Deuxièmement, nous supposons que la plupart des maisons dans les villes modernes sont typiques, par conséquent, les déplacements des points de leurs entrées par rapport au point central de la maison coïncideront jusqu'à un tour. <br><br>  Nous avons déjà les points centraux des bâtiments.<font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Que se passe-t-il si nous ajoutons une nouvelle propriété pour le bâtiment - sa "direction" entière, et pour chaque entrée deux autres - décalages entiers en décimètres le long et perpendiculaire à la ligne de direction? Compte tenu de la façon dont nous stockons les json avec des informations, la géométrie d'entrée occupera en moyenne un peu plus de deux octets. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Un bonus supplémentaire est que puisque la géométrie est dans le répertoire, nous n'avons plus besoin de stocker la correspondance entre l'identifiant d'entrée et le numéro d'objet dans la couche de carte.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Moins - le code est devenu plus compliqué. Auparavant, nous venions de dire à la carte de "montrer tel ou tel objet", et maintenant lors de l'affichage des entrées, nous extrayons ces données de json et ajoutons des objets dynamiques à la carte. Tout n'est pas très effrayant ici. Au moment d'afficher les touches fléchées des entrées json, nous avons déjà les objets correspondants, c'est-à-dire qu'il n'est pas nécessaire d'aller en plus dans la base de données. Avec les points d'entrée affichés, tout est légèrement pire - maintenant, nous devons déterminer en arrière-plan quelles maisons sont visibles, extraire les données de ces maisons de la base de données, analyser json et, s'il y a des entrées, créer des objets dynamiques pour elles.</font></font><br><br><div class="spoiler">  <b class="spoiler_title">Remarque</b> <div class="spoiler_text">  .              ,     ,     0,2% (972   ). <br></div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Comme nous avons déjà écrit du code supplémentaire pour afficher les entrées aux entrées, rien ne nous empêche de commencer à stocker des entrées à deux points dans l'organisation dans l'annuaire. </font><font style="vertical-align: inherit;">Le gain dans ce cas sera faible, mais gratuit. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Combien cela nous a-t-il donné? </font><font style="vertical-align: inherit;">3% sont devenus 0,5%. </font><font style="vertical-align: inherit;">Nous aurions pu faire encore moins, mais nous avons laissé des identifiants dans les données (qui sont assez mal compressés) pour simplifier le traitement des messages utilisateur sur les entrées inexactes.</font></font><br><br><h3>  Résultat </h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nous avons ajouté un grand nombre d'entrées, tout en réduisant la taille du fichier avec les données cartographiques de 0,5% et en réduisant de 26,6% la taille du fichier avec les données du répertoire. </font><font style="vertical-align: inherit;">Ce dernier est toujours le plus gros de nos fichiers, mais il ne s'agit que d'un des quatre fichiers «lourds», de sorte que le changement global s'est avéré plus modeste - 10,1%.</font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/s8/p-/_v/s8p-_vjsi9mgzymzwusfn4vsz6g.png" alt="Redimensionner la base de Moscou au fil du temps"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Les entrées ne sont pas encore collectées. </font><font style="vertical-align: inherit;">La taille des bases augmentera légèrement au fil du temps (selon les estimations actuelles, le même Moscou augmentera de 0,4%), mais en tout cas, l'objectif est de libérer les entrées sans augmenter la taille, plus qu'atteint.</font></font><br><br><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Et ensuite? </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Si nous parlons d'améliorations d'épicerie, nous allons soutenir les entrées et les appartements dans les conseils de recherche, ainsi que dans la recherche des points de début et de fin de la recherche d'itinéraires. </font><font style="vertical-align: inherit;">Nous pensons également à afficher les entrées importantes des bâtiments (principalement dans les centres commerciaux) de la même manière que les porches. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dans les plans techniques, il existe une vérification de plusieurs idées qui peuvent conduire à une réduction supplémentaire de la taille du fichier avec des données de référence, et vous devez examiner attentivement les autres fichiers. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Et, bien sûr, nous corrigerons les erreurs que nous avons jusqu'à présent.</font></font><br><br><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Une dernière pensée: utilisez JSON judicieusement </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> D'après ce qui précède, la conclusion suggère que vous ne pouvez pas trop penser aux formats binaires et simplement utiliser JSON. </font></font> Ce n'est pas tout à fait vrai.<font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cela fonctionne pour nous, car en même temps, nous devons recevoir plusieurs dizaines d'objets de la force. </font><font style="vertical-align: inherit;">De plus, nous utilisons rapidjson, et il est </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">très intelligent</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> et consomme peu de mémoire. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Il convient également de restreindre le transfert de données JSON de C ++ vers l'interface utilisateur, écrites dans un autre langage. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tout d'abord, vous devez le transformer en chaîne. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Deuxièmement, les analyseurs disponibles à partir de la partie interface utilisateur remonteront cette ligne, et le feront beaucoup plus lentement. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Il est préférable d'obtenir toutes les données de JSON par vous-même et de lancer des interfaces simples adaptées pour afficher des éléments spécifiques du côté de l'interface utilisateur.</font></font></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr415263/">https://habr.com/ru/post/fr415263/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr415253/index.html">Les photographies du XIXe siècle ont été restaurées à l'aide de la technologie du XXIe siècle</a></li>
<li><a href="../fr415255/index.html">Roskosmos a annoncé la fin des vols de missiles Proton</a></li>
<li><a href="../fr415257/index.html">8 façons d'améliorer la visualisation des données</a></li>
<li><a href="../fr415259/index.html">select / poll / epoll: différence pratique</a></li>
<li><a href="../fr415261/index.html">Artiste VFX dans le développement de jeux: fonctionnalités, carrière, développement</a></li>
<li><a href="../fr415265/index.html">À la recherche d'un successeur au KL-7: RACE et AROFLEX</a></li>
<li><a href="../fr415269/index.html">Fonctionnement de JS: arborescences de syntaxe abstraite, analyse et optimisation</a></li>
<li><a href="../fr415271/index.html">Comment les diagrammes de Gantt simplifient la gestion de projet</a></li>
<li><a href="../fr415273/index.html">Apprendre les bases de la programmation</a></li>
<li><a href="../fr415275/index.html">Le livre "C # 7 et .NET Core. Développement multiplateforme pour les professionnels. 3e édition</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>