<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ü•à üê® ‚è∫Ô∏è Comment nous avons ajout√© des entr√©es √† la carte et r√©duit la taille des bases de 10% ü§öüèª üë®‚Äçüè´ üë®‚Äç‚ù§Ô∏è‚Äçüë®</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="√Ä la fin du mois dernier, 2GIS a commenc√© √† afficher des porches. Nous montrons les entr√©es aux organisations depuis 2013, et les entr√©es semblent √™tr...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Comment nous avons ajout√© des entr√©es √† la carte et r√©duit la taille des bases de 10%</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/2gis/blog/415263/"><img src="https://habrastorage.org/webt/en/6k/fp/en6kfpoagwhj42loeubjzo0rzo0.jpeg"><br><br>  √Ä la fin du mois dernier, 2GIS a commenc√© √† afficher des porches.  Nous montrons les entr√©es aux organisations depuis 2013, et les entr√©es semblent √™tre les m√™mes entr√©es.  Alors pourquoi maintenant?  Tous les produits et processus internes sont pr√™ts, il vous suffit d'ajouter un peu plus et de corriger l'affichage dans l'interface utilisateur. <br><br>  En plus de la r√©ponse standard ¬´Il y avait d'autres priorit√©s¬ª, il y en a aussi une qui n'est pas tout √† fait standard: ¬´Ce n'est pas si simple.¬ª  Cet article explique quelles √©taient les difficult√©s et comment nous les avons r√©solues. <br><a name="habracut"></a><br>  Premi√®rement, l'entr√©e n'est pas l'entr√©e.  Ainsi, une seule entr√©e peut conduire √† plusieurs entr√©es, g√©n√©ralement de diff√©rents c√¥t√©s du b√¢timent.  La d√©finition de ¬´bloc d'appartements (√† plusieurs niveaux) avec une entr√©e commune¬ª est √©galement incorrecte.  Il arrive qu'une entr√©e m√®ne au premier √©tage de l'entr√©e, et l'autre - au deuxi√®me √©tage et aux suivants. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/zz/w7/pr/zzw7prchtb-1ictjkzvrfd6c_-8.png" alt="Entr√©e avec deux entr√©es"></div><br>  Deuxi√®mement, je veux chercher des entr√©es. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/yb/ty/ut/ybtyutk7jllplorjkmqiywob1ha.png" alt="Entr√©es dans les r√©sultats de recherche"></div><br>  C'est une opportunit√© assez recherch√©e, car les entr√©es sont loin d'√™tre toujours situ√©es de mani√®re √©vidente. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/fm/j7/41/fmj741efgjyhdj29y3udi2lsjym.png" alt="Maison avec la num√©rotation d'entr√©e pas la plus √©vidente"></div><br>  En plus des num√©ros d'entr√©e, il existe √©galement des noms (g√©n√©ralement √† partir d'une seule lettre). <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/ef/wk/2d/efwk2d9a_gsaw5vokxqoyiqzuzm.png" alt="Les lettres dans les noms des porches"></div><br>  Ou m√™me comme <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">√† Kaliningrad</a> - une adresse distincte est affect√©e exactement √† l'escalier. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/rw/iz/4w/rwiz4wywzkk_nnjll6xzrpy5k1o.png" alt="Num√©rotation ind√©pendante des entr√©es √† Kaliningrad"></div><br>  Troisi√®mement, nous avons d√©cid√© que si nous cherchions des entr√©es, pourquoi ne pas soutenir imm√©diatement la recherche par num√©ro d'appartement.  Ils ont d√©cid√© - et collect√© les gammes d'appartements, cependant, jusqu'√† pr√©sent sans reliure au sol.  Comme pour les entr√©es, les appartements peuvent avoir non seulement des noms num√©riques (le plus souvent, il existe des variantes avec la lettre ¬´a¬ª), et les plages sont loin d'√™tre toujours continues.  Dans les vieilles maisons de Saint-P√©tersbourg, la num√©rotation est assez √©trange: les appartements 1 et 3 peuvent √™tre dans la m√™me entr√©e, et l'appartement 2 peut √™tre dans la partie oppos√©e du b√¢timent. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/m2/se/uh/m2seuh3ovc_5ob8b1ulcdlru8x8.jpeg" alt="Entr√©e typique du vieux P√©tersbourg"></div><br><div class="spoiler">  <b class="spoiler_title">Digression lyrique sur la validation des donn√©es</b> <div class="spoiler_text">  N'essayez pas de rendre la validation des donn√©es collect√©es tr√®s intelligente - dans la capitale du nord, il y a des cas o√π vous pouvez entrer dans un appartement √† partir de plusieurs entr√©es, et dans certaines colonies europ√©ennes, l'adresse contient en plus de la maison le nom de l'entr√©e et le num√©ro de l'appartement dans cette entr√©e.  Peter pla√Æt √©galement avec un b√¢timent avec deux huiti√®mes entr√©es. <br></div></div><br>  Quatri√®mement, je veux toujours montrer les entr√©es sur la carte, et pas seulement lorsque nous √©tudions les informations d'une maison ou d'une entr√©e particuli√®re. <br><br>  Et enfin, il y a de nombreuses entr√©es - selon les estimations actuelles, il y en a environ cent mille √† Moscou seulement.  La premi√®re √©valuation ¬´sur les doigts¬ª a donn√© quelques chiffres astronomiques - nous avons fait une erreur une fois toutes les six fois sur le plus grand c√¥t√©. <br><br>  <b>Conclusions:</b> <br><br><ul><li>  Nous avons besoin d'une entit√© suppl√©mentaire, qui a son propre nom, contient une liste de gammes d'appartements et auxquelles les entr√©es du b√¢timent peuvent √™tre attach√©es. </li><li>  Nous rechercherons cette entit√© et lui montrerons une fiche d'information distincte. </li><li>  Nous sommes oblig√©s soit d'augmenter √† nouveau la taille des donn√©es t√©l√©charg√©es par l'application mobile, soit d'afficher ces donn√©es uniquement s'il y a une connexion r√©seau, soit de proposer quelque chose avec le format. </li></ul><br><h3>  Acc√©der √† la solution </h3><br>  Les deux premiers points n√©cessitent des changements dans les produits internes et externes, mais c'est une routine.  Ce dernier est une question compl√®tement diff√©rente.  Comme nous n'aimons pas d√©ranger les utilisateurs, nous fixons une restriction: les donn√©es doivent √™tre disponibles hors ligne et leur ajout ne doit pas augmenter la taille des bases de donn√©es. <br><br>  Comment?  D'une part, vous devez r√©duire la taille actuelle des donn√©es, d'autre part, vous pouvez penser √† un tel format de stockage des informations sur les entr√©es que la quantit√© de donn√©es suppl√©mentaires est minimale. <br><br><h3>  R√©duisez le volume de donn√©es </h3><br>  Il existe deux fa√ßons de le r√©duire: <br><br><ul><li>  Examinez attentivement les donn√©es stock√©es et essayez de trouver quelque chose dont nous pouvons nous passer. </li><li>  R√©fl√©chissez √† la possibilit√© de stocker les donn√©es de mani√®re plus efficace que nous ne le faisons actuellement. </li></ul><br><div class="spoiler">  <b class="spoiler_title">Evolution du format de stockage des donn√©es avant l'√®re des porches</b> <div class="spoiler_text"><h4>  La toute premi√®re option et la plus simple </h4><br>  La m√©thode traditionnelle pour enregistrer des donn√©es complexes consiste √† les <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">normaliser</a> , √† les placer dans une base de donn√©es de table et √† cr√©er des <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">index</a> auxiliaires.  Une fois, 2GIS a fait exactement cela, sauf pour r√©duire la taille, le contenu de chaque tableau a √©t√© tri√© de sorte que le plus souvent possible, les valeurs des cellules co√Øncident avec les valeurs de la ligne pr√©c√©dente.  Nous avons stock√© les colonnes ind√©pendamment et r√©duit les s√©quences de valeurs identiques. <br><br>  Un exemple tr√®s simplifi√© d'optimisation du stockage d'une table avec des b√¢timents: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/bh/jw/gy/bhjwgyi3kccb_sx2l4zho_pqlsy.png" alt="Un exemple de stockage de table optimis√©"></div><br>  La normalisation vous permet de r√©duire la redondance, mais il y a aussi un c√¥t√© n√©gatif - pour former un √©l√©ment d'interface utilisateur pour un objet, vous devez effectuer plusieurs requ√™tes qui acc√®dent √† un grand nombre de tables.  Cependant, √† cette √©poque, ces tableaux √©taient utilis√©s non seulement pour obtenir des donn√©es √† afficher, mais pour presque toutes les t√¢ches, y compris la recherche de texte et divers types de recherche de voyage.  Pour toutes ces t√¢ches, les donn√©es normalis√©es nous ont juste permis de r√©duire la quantit√© d'informations trait√©es. <br><br>  Les donn√©es pour le rendu de la carte avaient d√©j√† leur propre format binaire et √©taient stock√©es dans un bloc s√©par√©.  Progressivement, nous avons cr√©√© des formats binaires distincts pour acc√©l√©rer la recherche d'itin√©raires et les recherches de texte.  Seules les informations sont rest√©es dans la base de donn√©es, qui a √©t√© utilis√©e pour afficher les fiches d'objets, ainsi que pour les liens de certains objets avec d'autres. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/yd/4k/jh/yd4kjhjwh0pjpbj8bqmvksnqngk.png" alt="Cartes et communications"></div><br><h4>  Simplifiez le travail </h4><br>  Comment pouvez-vous simplifier le travail avec les donn√©es?  Recevez toutes les donn√©es n√©cessaires pour dessiner une carte √† la fois par l'identifiant de l'objet.  √âtant donn√© que la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">version en ligne</a> re√ßoit d√©j√† toutes les donn√©es de l' <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">API</a> pour une demande au <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">format JSON</a> , vous pouvez en m√™me temps combiner les formats utilis√©s par tous nos produits. <br><br>  Les deux json pour l'affichage des cartes et les communications doivent √™tre re√ßues pour un nombre limit√© d'objets, de la puissance de plusieurs dizaines √† la fois.  Mais il existe des sc√©narios o√π des attributs individuels doivent √™tre obtenus √† la fois pour des √©chantillons de grande taille, jusqu'√† des centaines de milliers.  Il est plus logique de s√©parer ces attributs dans une entit√© distincte avec un format de stockage distinct - propri√©t√©s.  Les propri√©t√©s peuvent √™tre de type et stock√©es plus efficacement au format binaire. <br><br>  Une approche na√Øve pour stocker json consiste √† utiliser une base de donn√©es de valeurs-cl√©s.  Prenons Moscou comme exemple, comme le plus grand de nos projets.  M√™me sous la forme la plus simple possible - pour chaque objet json lui-m√™me est stock√©, 8 octets d'identifiant et un caract√®re d√©limiteur - le r√©pertoire prendra 1,9 Gio.  La taille r√©sultante est presque six fois plus grande que l'option d√©crite pr√©c√©demment, et cela est toujours sans liens ni propri√©t√©s. <br><br>  Nous avons d√©lib√©r√©ment gonfl√© les objets en les remplissant d'informations sur tout ce qui pourrait √™tre n√©cessaire pour afficher leurs cartes, mais vous devez toujours stocker les noms de champ, les guillemets, les virgules et les crochets. <br><br><h4>  Compresser les donn√©es </h4><br>  La normalisation n'est pas le seul moyen d'√©liminer la redondance.  La deuxi√®me m√©thode populaire est la compression.  L'archive lzma de notre fichier incroyablement √©pais ne prend que 55 Mo. <br><br>  Bien s√ªr, nous ne pouvons pas utiliser ce format directement, car pour acc√©der √† un objet arbitraire, nous devons d√©compresser toutes les donn√©es stock√©es pr√©c√©demment et les archives lzma ne sont pas d√©compress√©es tr√®s rapidement. <br><br>  Comment obtenir un acc√®s al√©atoire rapide d'une part, et d'autre part, en compressant les donn√©es, r√©duire la taille de l'espace requis?  La r√©ponse est d'utiliser la pagination. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/ag/lk/jr/aglkjrbolu5w7cclmf-_cuqsjly.png" alt="Format de stockage binaire"></div><br>  Maintenant que les donn√©es sont pagin√©es, nous pouvons compresser chacune individuellement.  Pour acc√©der √† un endroit arbitraire, nous devons d√©compresser et num√©riser la page, mais c'est beaucoup plus rapide que de d√©compresser et de num√©riser l'archive enti√®re. <br><br>  Dans ce format, toutes les donn√©es sont stock√©es - json'y, relations et propri√©t√©s.  Reste √† associer ces donn√©es aux identifiants des objets.  Pour chaque identifiant, nous devons stocker une ou plusieurs paires <i>&lt;num√©ro de stockage, num√©ro de donn√©es dans le stockage&gt;</i> . <br><br><img src="https://habrastorage.org/webt/7b/db/tz/7bdbtzgxk03-5c189bv4sesw7b8.png" alt="Format simplifi√© des relations entre l'identifiant d'objet et les donn√©es dans les stockages"><br>  Tous les num√©ros de s√©rie, d√©calages et tailles sont stock√©s dans un format compress√© similaire √† <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">UTF-8</a> , o√π les petites valeurs ne prennent qu'un octet.  Cela nous permet de r√©duire la taille des liens en triant simplement le contenu des r√©f√©rentiels binaires pour r√©duire la fr√©quence d'occurrence. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/od/9w/zv/od9wzvyv9ql8ps8g2gmmyq8njmo.png" alt="Trier et r√©duire la taille"></div><br>  Certaines propri√©t√©s ont de nombreuses valeurs de fr√©quence, et donc le tri donne un gros gain de taille.  En revanche, √† cause de cela, le num√©ro de s√©rie des donn√©es ne peut pas co√Øncider pour tous les stockages. <br><br>  De plus, loin de tous les objets, des donn√©es sont pr√©sentes dans tous les stockages, et donc stocker des num√©ros de stockage est plus efficace que de r√©f√©rencer des objets vides. <br><br><h4>  Acc√©l√©rez la r√©cup√©ration des donn√©es </h4><br>  Le format d√©crit pr√©sente un probl√®me.  Pour trouver le num√©ro de l'objet qui stocke les indices pour l'identifiant sp√©cifi√©, nous devons ex√©cuter une recherche binaire √† l'int√©rieur des donn√©es du premier objet.  Pour ce faire, vous devez soit charger 10,9 Mio en m√©moire, soit effectuer 21 lectures suppl√©mentaires.  Les deux solutions ne nous conviennent pas et nous r√©duisons donc le nombre de lectures en stockant les donn√©es dans un arbre. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/8b/cx/to/8bcxto_pgnqn7drgqi5hkiae_su.png" alt="Format de l'arborescence pour une recherche rapide des donn√©es par identifiant"></div><br>  Nous regroupons les donn√©es sur 32 objets, et aux niveaux interm√©diaires, nous stockons 128 des premiers identifiants des n≈ìuds imbriqu√©s.  Nous avons ajout√© trois niveaux de l'arborescence et r√©duit le nombre de lectures suppl√©mentaires √† quatre (mais en fait, en tenant compte de la mise en cache des n≈ìuds d'arbre pr√©c√©demment lus, m√™me √† 1-3).  Prix ‚Äã‚Äã- un peu moins de 400 Ko. <br><br>  √Ä ce stade, nous sommes assez efficaces pour stocker les relations et les propri√©t√©s, mais les json occupent beaucoup d'espace.  C'est compr√©hensible.  Plus la taille de la page est grande, plus il y a d'objets et plus l'algorithme de compression est en mesure de d√©terminer quelles informations sont redondantes.  Mais, d'un autre c√¥t√©, plus nous devons travailler pour lire un seul objet.  Les Json sont des objets assez gros, et donc il y en a tr√®s peu sur une seule page.  Par cons√©quent, vous devez aider l'algorithme √† mieux faire son travail. <br><br><h4>  Diviser JSON en plusieurs parties </h4><br>  Premi√®rement, de nombreux objets ont des sch√©mas de donn√©es correspondants; seules les valeurs d'attribut diff√®rent.  Deuxi√®mement, de nombreuses valeurs d'attribut sont les m√™mes, m√™me pour des objets avec des sch√©mas diff√©rents.  Nous s√©parerons les sch√©mas et les valeurs d'attribut dans des stockages s√©par√©s, et nous stockerons les json sous la forme: un lien vers un sch√©ma + des liens vers des valeurs d'attribut. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/pq/n8/ef/pqn8ef7v2wv7bkkvbgguql2vggq.png" alt="Division de Json en sch√©ma et donn√©es"></div><br>  Dans notre sch√©ma de donn√©es, le nombre de noms d'attribut est limit√©.  Nous pouvons donc les mettre dans un fichier s√©par√© et stocker le num√©ro √† la place.  Nous apporterons √©galement quelques modifications suppl√©mentaires, en tenant compte du fait que les json sont toujours des objets. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/gq/i_/ak/gqi_akxdvngmmjmgjrg60y-5luu.png" alt="Format r√©el pour le stockage des sch√©mas d'objet json"></div><br>  Oui, nous avons essentiellement compress√© nos donn√©es nous-m√™mes, r√©duisant la port√©e du fonctionnement de l'algorithme.  Mais d'un autre c√¥t√©, nous avons consid√©rablement ralenti l'acc√®s aux donn√©es, et l'algorithme aide toujours, en compressant des valeurs similaires stock√©es √† proximit√©. <br><br>  Nous avons fix√© la taille de la page √† 1 Ko et il se trouve que si nous avons optimis√© le format afin que, d'une part, la lecture ne soit pas tr√®s lente, et d'autre part, les donn√©es aient √©t√© emball√©es le mieux possible, nous ... avons d√©j√† contourn√© les ¬´tables optimis√©es¬ª √† la fois en taille et pour une facilit√© d'utilisation.  Mais ce n'est pas pour rien que tout cela √©tait!  Le gain maximal doit provenir de la compression des valeurs des attributs, des propri√©t√©s et des sch√©mas.  Nous incitons zlib et v√©rifions que, dans le contexte du reste du travail, la lecture des donn√©es de la base de donn√©es prend peu de temps.  Satisfait du r√©sultat, nous passons √† d'autres t√¢ches. <br></div></div><br><h3>  D√©barrassez-vous de l'inutile </h3><br>  Nous commen√ßons √† r√©duire en recherchant des donn√©es dont vous pouvez vous d√©barrasser.  Il s'av√®re que pendant l'existence du format, nous avons appris √† nous passer de la plus grande connexion.  C'est 10% de la taille! <br><br>  Le code de ces donn√©es √©tait toujours li√©, mais les modifications n√©cessaires sont assez triviales.  Mais les applications d√©j√† publi√©es ne peuvent pas √™tre facilement modifi√©es.  Nous nous effor√ßons de maintenir aussi longtemps que possible non seulement la r√©trocompatibilit√©, mais aussi la compatibilit√© directe.  Et si le premier est familier √† tout le monde, alors beaucoup peuvent ne pas penser au second avec bonheur.  Nous sommes oblig√©s de le supporter en raison de la queue assez longue d'utilisateurs qui, pour diverses raisons, ont d√©sactiv√© les mises √† jour automatiques et ne sont pas press√©s de passer √† une nouvelle version de l'application. <br><br><div class="spoiler">  <b class="spoiler_title">R√©partition des utilisateurs par version</b> <div class="spoiler_text"><div style="text-align:center;"><img src="https://habrastorage.org/webt/ms/ld/kq/msldkqhkepk1gsouayqmglu36zo.png" alt="Repartition des utilisateurs par version"></div><br>  Tout en haut se trouve la r√©partition des utilisateurs par les derni√®res versions de l'application Android.  Le fond est iOS. <br><br>  Il est facile de remarquer que les utilisateurs d'appareils iOS sont mis √† jour beaucoup plus facilement, mais m√™me parmi eux, il y a beaucoup d'utilisateurs d'anciennes versions. <br></div></div><br>  Nous publions √©galement de nouvelles donn√©es pour la version fig√©e pour Windows Phone.  Et bien que les utilisateurs de WP8 ne repr√©sentent qu'une petite fraction de notre audience, en chiffres absolus, c'est presque 200 000 par mois. <br><br>  Nous avons depuis longtemps un m√©canisme qui nous permet de produire plusieurs formats de donn√©es et d√©termine automatiquement quelles versions doivent obtenir quoi.  L'opportunit√© est bonne, mais vous devez toujours apprendre √† d√©charger ces formats.  La premi√®re grande t√¢che a √©t√© d'impl√©menter un service qui recevra toutes les donn√©es et filtrera le nouveau pour l'ancien format de base de donn√©es et l'ancien pour le nouveau. <br><br>  Un bon bonus du travail effectu√© est de r√©duire la taille des mises √† jour mensuelles, car la connexion √† distance a consid√©rablement chang√© d'un mois √† l'autre, gonflant la taille des diff√©rences. <br><br>  Si vous regardez les donn√©es restantes, au total, vous pouvez obtenir les m√™mes 10%, cependant, le prix sera incomparablement plus √©lev√©.  Jusqu'√† pr√©sent, nous avons d√©cid√© de ne pas toucher. <br><br><h3>  Optimiser le format de stockage actuel </h3><br>  Comme il a √©t√© √©crit ci-dessus, nous avons cr√©√© des pages de 1 Ko et emball√© pas tous les r√©f√©rentiels binaires. <br><br>  La premi√®re chose que nous faisons est d'essayer de compresser √©galement les pages avec des liens et de v√©rifier que la diff√©rence de vitesse de r√©ception des donn√©es se situe dans la r√©gion de l'erreur. <br><br>  L'√©l√©ment suivant consiste √† choisir la taille de page optimale.  Plus la taille de la page est grande, plus les donn√©es sont compress√©es efficacement, mais plus les donn√©es sont lues lentement.  Et si, avec l'augmentation de la taille des pages, les co√ªts de temps et de m√©moire augmentent lin√©airement, le gain devient de moins en moins perceptible.  Apr√®s les tests, nous d√©cidons d'augmenter la taille √† 8 Ko. <br><br><div class="spoiler">  <b class="spoiler_title">L'effet de la taille de la page sur les grandes s√©lections</b> <div class="spoiler_text">  Si l'agrandissement de la page devrait ralentir les petites s√©lections, les grandes - √† partir de centaines d'√©l√©ments - sont m√™me acc√©l√©r√©es.  Cela signifie que dans le bon sens, vous devez choisir diff√©rentes tailles pour les stockages en fonction des cas d'utilisation des donn√©es qui y sont stock√©es. <br></div></div><br>  Au total, seuls ces deux points peuvent r√©duire la base de 18%! <br><br><h3>  Changer le format de compression </h3><br>  zlib, bien s√ªr, est un classique, mais <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">zstd</a> fournit une vitesse de d√©compression plus √©lev√©e avec un taux de compression plus √©lev√©.  De plus, zstd vous permet de cr√©er d'abord un dictionnaire unique pour toutes les donn√©es disponibles, puis de l'enregistrer une fois et de le compresser avec toutes les pages.  Ainsi, nous ralentissons d√©cemment le processus de cr√©ation d'un fichier avec une base de donn√©es, mais nous pressons 8% suppl√©mentaires. <br><br><h3>  Ajouter des porches </h3><br><h4>  Moyen facile </h4><br>  Le moyen le plus simple est de faire de chaque entr√©e un objet distinct, de les indexer s√©par√©ment (selon des estimations approximatives + 10% de la taille de l'indice) et de stocker s√©par√©ment leur g√©om√©trie dans les donn√©es pour dessiner la carte. <br><br>  Cette m√©thode gonflera la base de 3% au total.  Lors des √©tapes pr√©c√©dentes, nous avons gagn√© plus qu'assez pour nous calmer et travailler avec les entr√©es selon le sch√©ma habituel, mais ... au moment du d√©but des travaux, nous n'√©tions pas s√ªrs de cela, et travailler sur un format alternatif √©tait en parall√®le. <br><br><div class="spoiler">  <b class="spoiler_title">√âvaluation d√©taill√©e, pour les personnes int√©ress√©es</b> <div class="spoiler_text">  Essayons d'√©valuer l'augmentation de la taille du package avec la base de donn√©es pour chaque objet: <br><br>  8 octets - identifiant, <br>  6 octets - nombre de stockages utilis√©s (donn√©es + cinq propri√©t√©s; les propri√©t√©s sont extraites des donn√©es principales et stock√©es sous forme binaire, car elles sont souvent n√©cessaires pour un grand nombre d'objets √† la fois), <br>  3 octets - index dans l'entrep√¥t de donn√©es, <br>  2 octets - d√©calage des donn√©es de l'objet, <br>  5 octets - valeurs de donn√©es - 2 octets par circuit, 3 octets en moyenne pour les informations d'appartement (nous pensons qu'il y aura de nombreux doublons et que les donn√©es elles-m√™mes sont stock√©es une fois), <br>  6 octets - coordonn√©es de donn√©es d√©cal√©es (d'autres propri√©t√©s ont de nombreuses valeurs en double et s'effondreront), <br>  8 octets - valeurs de coordonn√©es. <br><br>  Total 38 octets par objet.  Dans le cas de Moscou, cela repr√©sente 4,5 Mio pour plus de 124 000 intrants collect√©s. <br><br>  Ensuite, nous devons stocker √©galement la connexion entre la maison et les entr√©es, c'est 2,5 octets pour chaque immeuble et 8 octets pour chaque entr√©e.  1 MiB de plus. <br><br>  Maintenant, nous consid√©rons combien tout cela prendra sur la carte. <br><br>  Tout d'abord, nous devons stocker la g√©om√©trie.  Pour les polylignes, le premier point prend toujours 8 octets et tous les suivants sont stock√©s sous forme de diff√©rences de la pr√©cision requise.  Ici, nous sommes satisfaits de la pr√©cision en d√©cim√®tres.  La plupart des entr√©es se composent de deux points qui ne sont pas tr√®s √©loign√©s l'un de l'autre, et donc on peut supposer que la g√©om√©trie elle-m√™me occupera 10 octets.  Total 1,2 Mio. <br><br>  Nous devons √©galement associer l'identifiant d'entr√©e et l'objet √† sa g√©om√©trie.  Un index est le m√™me stockage binaire que tout le reste, seules la destination de communication (1 octet), le num√©ro de couche (1 octet) et le num√©ro d'objet (3 octets) sont stock√©s.  Plus 8 octets par identifiant, ainsi qu'un arbre de recherche rapide.  Total de 1,5 Mio. <br><br>  Comme cela a √©t√© dit au tout d√©but de l'article, nous voulons afficher en permanence les entr√©es sur la carte, et la fa√ßon la plus simple de le faire est de d√©charger une autre couche avec des points, mais ... vous pouvez √©galement r√©utiliser la couche avec des g√©om√©tries, cr√©ant un nouveau <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">symbole</a> qui affichera l'image dont nous avons besoin au dernier point de la polyligne. <br><br>  10% de l'index de recherche est de 5,9 MiB.  Pour r√©sumer tout, nous obtenons 14,2 MiB, ce qui est juste un peu plus de 3%. <br></div></div><br><h4>  Option actuelle </h4><br>  Au lieu d'indexer les entr√©es et de gonfler l'index de recherche, nous recherchons des maisons, mais balisons en outre les mots de la requ√™te et en extrayons des adresses (pertinentes pour la recherche d'entr√©es √† Kaliningrad), des entr√©es et / ou des appartements.  Ainsi, √† la sortie, nous avons l'identifiant de la maison et les champs de texte tap√©s, par lesquels nous devons trouver l'escalier dont nous avons besoin. <br><br><div class="spoiler">  <b class="spoiler_title">Remarque</b> <div class="spoiler_text">  C'est un point controvers√©.  D'une part, cela nous permet de r√©duire la taille de la base de donn√©es, et d'autre part, il impose des restrictions sur le format d'entr√©e - les entr√©es ne seront pas sur de nombreuses demandes qui seraient correctement trait√©es en utilisant une recherche honn√™te. <br></div></div><br>  De plus, au lieu de d√©charger des objets individuels, nous incluons toutes les informations sur les entr√©es directement dans les donn√©es du b√¢timent. <br>  Et enfin, nous transf√©rons une partie des g√©om√©tries dans le r√©pertoire. <br><br>  Ce dernier m√©rite d'√™tre divulgu√© plus en d√©tail. <br><br>  Tout d'abord, nous remarquons que la plupart des entr√©es sont deux points et ont la m√™me longueur.  Ces entr√©es peuvent √™tre stock√©es sous la forme d'un point + direction, c'est-√†-dire  √©conomisez 1 octet par entr√©e. <br><br>  Deuxi√®mement, nous supposons que la plupart des maisons dans les villes modernes sont typiques, par cons√©quent, les d√©placements des points de leurs entr√©es par rapport au point central de la maison co√Øncideront jusqu'√† un tour. <br><br>  Nous avons d√©j√† les points centraux des b√¢timents.<font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Que se passe-t-il si nous ajoutons une nouvelle propri√©t√© pour le b√¢timent - sa "direction" enti√®re, et pour chaque entr√©e deux autres - d√©calages entiers en d√©cim√®tres le long et perpendiculaire √† la ligne de direction? Compte tenu de la fa√ßon dont nous stockons les json avec des informations, la g√©om√©trie d'entr√©e occupera en moyenne un peu plus de deux octets. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Un bonus suppl√©mentaire est que puisque la g√©om√©trie est dans le r√©pertoire, nous n'avons plus besoin de stocker la correspondance entre l'identifiant d'entr√©e et le num√©ro d'objet dans la couche de carte.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Moins - le code est devenu plus compliqu√©. Auparavant, nous venions de dire √† la carte de "montrer tel ou tel objet", et maintenant lors de l'affichage des entr√©es, nous extrayons ces donn√©es de json et ajoutons des objets dynamiques √† la carte. Tout n'est pas tr√®s effrayant ici. Au moment d'afficher les touches fl√©ch√©es des entr√©es json, nous avons d√©j√† les objets correspondants, c'est-√†-dire qu'il n'est pas n√©cessaire d'aller en plus dans la base de donn√©es. Avec les points d'entr√©e affich√©s, tout est l√©g√®rement pire - maintenant, nous devons d√©terminer en arri√®re-plan quelles maisons sont visibles, extraire les donn√©es de ces maisons de la base de donn√©es, analyser json et, s'il y a des entr√©es, cr√©er des objets dynamiques pour elles.</font></font><br><br><div class="spoiler">  <b class="spoiler_title">Remarque</b> <div class="spoiler_text">  .              ,     ,     0,2% (972   ). <br></div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Comme nous avons d√©j√† √©crit du code suppl√©mentaire pour afficher les entr√©es aux entr√©es, rien ne nous emp√™che de commencer √† stocker des entr√©es √† deux points dans l'organisation dans l'annuaire. </font><font style="vertical-align: inherit;">Le gain dans ce cas sera faible, mais gratuit. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Combien cela nous a-t-il donn√©? </font><font style="vertical-align: inherit;">3% sont devenus 0,5%. </font><font style="vertical-align: inherit;">Nous aurions pu faire encore moins, mais nous avons laiss√© des identifiants dans les donn√©es (qui sont assez mal compress√©s) pour simplifier le traitement des messages utilisateur sur les entr√©es inexactes.</font></font><br><br><h3>  R√©sultat </h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nous avons ajout√© un grand nombre d'entr√©es, tout en r√©duisant la taille du fichier avec les donn√©es cartographiques de 0,5% et en r√©duisant de 26,6% la taille du fichier avec les donn√©es du r√©pertoire. </font><font style="vertical-align: inherit;">Ce dernier est toujours le plus gros de nos fichiers, mais il ne s'agit que d'un des quatre fichiers ¬´lourds¬ª, de sorte que le changement global s'est av√©r√© plus modeste - 10,1%.</font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/s8/p-/_v/s8p-_vjsi9mgzymzwusfn4vsz6g.png" alt="Redimensionner la base de Moscou au fil du temps"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Les entr√©es ne sont pas encore collect√©es. </font><font style="vertical-align: inherit;">La taille des bases augmentera l√©g√®rement au fil du temps (selon les estimations actuelles, le m√™me Moscou augmentera de 0,4%), mais en tout cas, l'objectif est de lib√©rer les entr√©es sans augmenter la taille, plus qu'atteint.</font></font><br><br><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Et ensuite? </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Si nous parlons d'am√©liorations d'√©picerie, nous allons soutenir les entr√©es et les appartements dans les conseils de recherche, ainsi que dans la recherche des points de d√©but et de fin de la recherche d'itin√©raires. </font><font style="vertical-align: inherit;">Nous pensons √©galement √† afficher les entr√©es importantes des b√¢timents (principalement dans les centres commerciaux) de la m√™me mani√®re que les porches. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dans les plans techniques, il existe une v√©rification de plusieurs id√©es qui peuvent conduire √† une r√©duction suppl√©mentaire de la taille du fichier avec des donn√©es de r√©f√©rence, et vous devez examiner attentivement les autres fichiers. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Et, bien s√ªr, nous corrigerons les erreurs que nous avons jusqu'√† pr√©sent.</font></font><br><br><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Une derni√®re pens√©e: utilisez JSON judicieusement </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> D'apr√®s ce qui pr√©c√®de, la conclusion sugg√®re que vous ne pouvez pas trop penser aux formats binaires et simplement utiliser JSON. </font></font> Ce n'est pas tout √† fait vrai.<font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cela fonctionne pour nous, car en m√™me temps, nous devons recevoir plusieurs dizaines d'objets de la force. </font><font style="vertical-align: inherit;">De plus, nous utilisons rapidjson, et il est </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tr√®s intelligent</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> et consomme peu de m√©moire. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Il convient √©galement de restreindre le transfert de donn√©es JSON de C ++ vers l'interface utilisateur, √©crites dans un autre langage. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tout d'abord, vous devez le transformer en cha√Æne. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Deuxi√®mement, les analyseurs disponibles √† partir de la partie interface utilisateur remonteront cette ligne, et le feront beaucoup plus lentement. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Il est pr√©f√©rable d'obtenir toutes les donn√©es de JSON par vous-m√™me et de lancer des interfaces simples adapt√©es pour afficher des √©l√©ments sp√©cifiques du c√¥t√© de l'interface utilisateur.</font></font></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr415263/">https://habr.com/ru/post/fr415263/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr415253/index.html">Les photographies du XIXe si√®cle ont √©t√© restaur√©es √† l'aide de la technologie du XXIe si√®cle</a></li>
<li><a href="../fr415255/index.html">Roskosmos a annonc√© la fin des vols de missiles Proton</a></li>
<li><a href="../fr415257/index.html">8 fa√ßons d'am√©liorer la visualisation des donn√©es</a></li>
<li><a href="../fr415259/index.html">select / poll / epoll: diff√©rence pratique</a></li>
<li><a href="../fr415261/index.html">Artiste VFX dans le d√©veloppement de jeux: fonctionnalit√©s, carri√®re, d√©veloppement</a></li>
<li><a href="../fr415265/index.html">√Ä la recherche d'un successeur au KL-7: RACE et AROFLEX</a></li>
<li><a href="../fr415269/index.html">Fonctionnement de JS: arborescences de syntaxe abstraite, analyse et optimisation</a></li>
<li><a href="../fr415271/index.html">Comment les diagrammes de Gantt simplifient la gestion de projet</a></li>
<li><a href="../fr415273/index.html">Apprendre les bases de la programmation</a></li>
<li><a href="../fr415275/index.html">Le livre "C # 7 et .NET Core. D√©veloppement multiplateforme pour les professionnels. 3e √©dition</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>