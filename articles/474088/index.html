<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>游녫游낕 游땤 游둟游낕 Protegemos el servidor remoto en Windows como podemos 游 游游 游</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="El tema de la seguridad del servidor de Windows se ha planteado m치s de una vez, incluso en este blog. Sin embargo, me gustar칤a refrescar una vez m치s l...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Protegemos el servidor remoto en Windows como podemos</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/pc-administrator/blog/474088/"><p><img src="https://habrastorage.org/getpro/habr/post_images/ee6/d54/289/ee6d54289f854ab18b4c86c99ce5243e.jpg"></p><br><p>  El tema de la seguridad del servidor de Windows se ha planteado m치s de una vez, incluso en este blog.  Sin embargo, me gustar칤a refrescar una vez m치s la memoria de los viejos m칠todos de defensa y hablar sobre los nuevos poco conocidos.  Por supuesto, utilizaremos las herramientas integradas al m치ximo. </p><br><p>  Entonces, supongamos que tenemos una peque침a empresa que alquila un servidor de terminal en un centro de datos remoto. </p><a name="habracut"></a><br><p>  Al dise침ar cualquier protecci칩n, debe comenzar con un modelo de amenaza: de qui칠n o qu칠, de hecho, defenderemos.  En nuestra configuraci칩n t칤pica, construir칠 una defensa contra hackers malvados externos, de usuarios incompetentes (y quiz치s un poco maliciosos).  Comencemos con el per칤metro exterior de la defensa: el firewall. </p><br><h1 id="za-toboy-kak-za-ognennoy-stenoy">  Detr치s de ti como un muro de fuego </h1><br><p>  En los d칤as de Windows 2003, el cortafuegos incorporado era un espect치culo miserable, y si era imposible usar herramientas de terceros, ten칤a que usar IPSec.  Un ejemplo de dicha configuraci칩n se discute, por ejemplo, en el material <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Servidores seguros de Windows que usan IPSec Firewall</a> . </p><br><p> Ahora, con el advenimiento de WFP ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Windows Filtering Platform</a> ), las cosas han mejorado.  En principio, probablemente todos los administradores de sistemas de Windows se encontraron con este firewall de todos modos, por lo que configurar el acceso remoto al servidor solo desde ciertas IP no deber칤a ser dif칤cil.  Prestar칠 atenci칩n a algunos "chips", que rara vez se usan. </p><br><p>  De manera predeterminada, el firewall bloquea todas las conexiones entrantes, excepto las expl칤citamente permitidas, pero las salientes permiten todas las conexiones excepto las expl칤citamente prohibidas.  Esta pol칤tica se puede cambiar abriendo la administraci칩n del firewall a trav칠s de wf.msc y seleccionando "Propiedades". </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/843/247/278/84324727844f52b04c72436b3b0190ae.jpg"></p><br><p>  <em>Configuraci칩n de cortafuegos.</em> </p><br><p>  Ahora, si queremos evitar que los usuarios del servidor terminal accedan a Internet desde este servidor, lo lograremos. </p><br><blockquote>  Vale la pena se침alar que al configurar reglas de acceso al servidor (conexiones entrantes), no es necesario crear reglas expl칤citamente para el tr치fico saliente.  En t칠rminos de iptables, siempre se permiten los establecidos y los relacionados. </blockquote><p>  Para los conocedores de la l칤nea de comandos, puede configurar el firewall en el contexto de netsh advfirewall.  Puede leer acerca de los comandos en el art칤culo " <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Firewall de Windows 7 con seguridad avanzada</a> ". Agregar칠 que el comando habilita el bloqueo de conexiones entrantes y salientes: </p><br><pre><code class="bash hljs">netsh advfirewall <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> currentprofile firewallpolicy blockinbound,blockoutbound</code> </pre> <br><p>  Otra caracter칤stica del firewall de Windows es que cualquier programa o configuraci칩n cambia sus reglas sin notificaci칩n.  Por ejemplo, desactiv칩 todas las reglas de nuestro abuelo, apareci칩 una segunda cerca, cre칩 una red local entre ellas, configur칩 el acceso compartido y ... de repente, se activ칩 para todos y para todo con las consecuencias resultantes. </p><br><p>  B치sicamente, hay dos salidas y media (perm칤tanme recordarles que solo estamos hablando de herramientas integradas): verifique regularmente para ver si las reglas han cambiado y use el viejo IPSec o, para m칤, la opci칩n m치s razonable es configurar el firewall con la Pol칤tica de grupo.  La configuraci칩n se realiza en Configuraci칩n del equipo - Configuraci칩n de Windows - Configuraci칩n de seguridad - Monitor de firewall de Windows Defender en Seguridad avanzada. </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/c09/9b2/f7c/c099b2f7c2be0024c3c5783d865308d4.jpg"></p><br><p>  <em>Configurar una pol칤tica de grupo de firewall.</em> </p><br><p>  Adem치s, utilizando el firewall de Windows, puede implementar un simple fail2ban.  Es suficiente para habilitar la auditor칤a de intentos fallidos de inicio de sesi칩n y, si hay varias fallas seguidas, bloquear la IP de origen.  Puede usar secuencias de comandos autoescritas, o puede usar herramientas listas para usar, sobre las que escrib칤 en el art칤culo " <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">C칩mo dar cifradores para hundir una empresa</a> ". </p><br><p>  Si el firewall incorporado no es suficiente y desea utilizar algo m치s serio, puede instalar software de terceros.  Es una pena que se paguen la mayor칤a de las soluciones conocidas para Windows Server.  Otra opci칩n ser칤a colocar un enrutador frente al servidor.  Est치 claro que dicha instalaci칩n es adecuada si utilizamos la colocaci칩n y no alquilamos un servidor en alg칰n lugar muy, muy lejano.  Si el centro de datos extranjero es nuestra elecci칩n, puede usar la virtualizaci칩n, por ejemplo, Hyper-V incorporado, e instalar el conocido GNU \ Linux o FreeBSD en la m치quina virtual. </p><br><p>  Surge la pregunta: 쯖칩mo hacer que la m치quina virtual tenga acceso directo a Internet, pero el servidor no?  Adem치s, la direcci칩n MAC del servidor no brilla en el host y, por lo tanto, no requiere la compra de otra direcci칩n IP. </p><br><blockquote>  Precauci칩n  춰M치s acciones se realizan mejor a trav칠s de IP-KVM! </blockquote><p>  Para esto, la m치quina virtual debe estar equipada con dos adaptadores de red.  Una es para la conexi칩n directa a Internet, para ello haremos un conmutador virtual del tipo "externo" y desmarcaremos la casilla que permite que el sistema operativo interact칰e con este conmutador.  Con esta marca de verificaci칩n, privamos al servidor del acceso directo a Internet (es mejor configurar el firewall virtual de antemano), y su MAC no se iluminar치 al host. </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/183/150/bd1/183150bd155c8e704802546314738394.jpg"></p><br><p>  <em>Configure un conmutador virtual externo.</em> </p><br><p>  Debe hacerse otro conmutador virtual del tipo "interno" para la interacci칩n entre la m치quina virtual y el servidor.  Ya necesita configurar el direccionamiento local.  Esto crear치 un enrutador virtual que se coloca frente al servidor y lo protege. </p><br><p>  Al mismo tiempo, puede configurar su VPN favorita para la oficina o los empleados remotos en esta m치quina virtual sin molestarse con la funci칩n de "Enrutamiento y acceso remoto" o con IPSec incorporado, como describ칤 en el art칤culo " <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">C칩mo escond칤 la base 1C en Alemania</a> ".  Lo principal es no olvidar comprobar el inicio de esta m치quina virtual al iniciar el sistema. </p><br><p>  Puede conectarse a dicho servidor usando RDP regular o usar <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">clientes HTML5</a> con autenticaci칩n de dos factores.  En caso de fuerza bruta, vale la pena ocuparse de las soluciones de fail2ban y bloquear la cuenta durante alg칰n tiempo con varios intentos fallidos de autorizar en una fila. </p><br><p>  Afuera, hemos protegido m치s o menos el servidor, pasemos a la protecci칩n interna. </p><br><h1 id="zaschita-vnutrennyaya-ostanovit-i-ne-puschat">  Protecci칩n interna: det칠ngase y no lo suelte </h1><br><p>  Por supuesto, para proteger el servidor desde adentro, realmente quiero instalar alg칰n tipo de antivirus: nunca se sabe lo que los usuarios del servidor est치n acumulando o bombeando desde Internet.  Pero en la pr치ctica, el antivirus en el servidor puede hacer m치s da침o que bien.  Por lo tanto, generalmente utilizo mecanismos de bloqueo de inicio de software no incluidos en la lista blanca, en particular, el mecanismo SRP (pol칤ticas de restricci칩n de software), que tambi칠n mencion칠 en el art칤culo " <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">C칩mo permitir que los cifradores inunden una empresa</a> ". </p><br><p>  Me detendr칠 con m치s detalle en una trampa, que a menudo olvidamos cuando activa SRP con la configuraci칩n est치ndar, cuando todo est치 bloqueado, excepto las carpetas Windows y Archivos de programa.  De hecho, esto filtra casi todo el malware.  Pero en realidad no funciona con la malicia de los empleados, porque en las carpetas del sistema hay subcarpetas con el derecho de crear objetos por parte de los usuarios.  Por ejemplo, puede mirar la carpeta C: \ Windows \ Temp. </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/792/8a3/a92/7928a3a92823ab9ee919cdb456ed94da.jpg"></p><br><p>  <em>Permisos para la carpeta que est치 en la lista blanca.</em> </p><br><p>  Y esa carpeta no est치 sola.  Por supuesto, puede auditar las carpetas del sistema usted mismo, o puede confiar en las personas que ya lo han hecho.  Por ejemplo, un especialista de <em>Stefan Kanthak</em> en su <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">blog</a> (hay un virus de prueba EICAR por referencia, el antivirus puede funcionar) camina de manera bastante agresiva sobre los antivirus y los m칠todos de protecci칩n de Windows y al mismo tiempo ofrece un paquete de configuraci칩n SRP ya ensamblado que tambi칠n bloquear치 esas carpetas sospechosas.  Previa solicitud, el autor proporciona un programa para convertir estas configuraciones de registro en archivos de pol칤ticas locales. </p><br><p>  Si prefiere utilizar el mecanismo AppLocker con configuraciones m치s flexibles, la soluci칩n <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">AaronLocker</a> puede ayudarlo. </p><br><blockquote>  Los editores no recomiendan usar e instalar scripts y otros programas de Internet sin antes estudiarlos. </blockquote><p>  Si AppLocker apareci칩 durante mucho tiempo y la edad de SRP excedi칩 los 15 a침os, entonces una alternativa relativamente nueva es WDAC (Control de aplicaciones de Windows Defender).  De hecho, desde Security Essentials, el "antivirus" incorporado ha adquirido muchas caracter칤sticas interesantes.  Por ejemplo, WDAC es el m칩dulo responsable de las pol칤ticas de acceso para aplicaciones y bibliotecas.  Anteriormente, formaba parte de Device Guard (proteger una computadora, incluido el uso de tecnolog칤as de virtualizaci칩n), y un poco sobre su configuraci칩n se describi칩 en el art칤culo " <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">El principio del Modo S en Windows 10 y la configuraci칩n de Device Guard con sus propias manos</a> ".  Se pueden encontrar m치s detalles sobre todas las sutilezas en la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">documentaci칩n</a> oficial, pero puedo agregar algunos inconvenientes que lo distinguen de las soluciones cl치sicas como SRP y AppLocker: </p><br><ul><li>  No hay configuraci칩n gr치fica, a trav칠s de los cmdlets de PowerShell. </li><li>  No hay configuraciones en el segmento de usuario, solo para la computadora. </li><li>  La configuraci칩n se hace bastante inusual: se prepara un archivo xml, que luego se convierte en binario y se distribuye a las computadoras. </li></ul><br><p>  Pero es posible configurar la aplicaci칩n en un segmento: por ejemplo, si desea dar acceso a cmd.exe a su secuencia de comandos, y no a un virus de terceros, esto puede implementarse.  Adem치s, la pol칤tica se puede aplicar antes de iniciar el sistema utilizando UEFI. </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/eef/b63/bfe/eefb63bfe3fd2313517544106174af73.jpg"></p><br><p>  <em>Cerradura de cromo a trav칠s de WDAC.</em> </p><br><p>  En general, debido a la configuraci칩n dolorosa, la impresi칩n fue que WDAC ya no estaba posicionado por s칤 solo para administrar computadoras, sino como una herramienta que le permite integrarse con sistemas MDM centralizados como <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Microsoft Intune</a> .  Pero al mismo tiempo, el desarrollo del buen SRP viejo se <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">suspendi칩</a> en Windows 10 1803. </p><br><p>  Si hablamos de Windows Defender, no puede evitar mencionar el Credential Guard y el Remote Credential Guard. </p><br><p>  La primera herramienta utiliza nuevamente la virtualizaci칩n, iniciando el componente LSA (Autoridad de Seguridad Local) en un proceso aislado del sistema operativo, lo que complica enormemente el proceso de robo de hash de contrase침as y tickets de Kerberos.  Lea m치s sobre la tecnolog칤a en la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">documentaci칩n</a> oficial.  Para que el procesador funcione, debe admitir la virtualizaci칩n y el sistema debe tener habilitado el Arranque seguro y el m칩dulo TPM para vincular las credenciales al equipo.  Puede habilitar Credential Guard a trav칠s de la pol칤tica de grupo Configuraci칩n del equipo - Plantillas administrativas - Sistema - Device Guard - Habilitar una herramienta de seguridad basada en virtualizaci칩n. </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/e4d/88e/ade/e4d88eade072b25149d4a9a00c5d7e32.jpg"></p><br><p>  <em>Habilitaci칩n de credenciales de guardia.</em> </p><br><p>  La segunda herramienta sirve para proteger las credenciales transmitidas (춰especialmente el administrador!) Para la conexi칩n remota, por ejemplo, a trav칠s del mismo RDP.  Anteriormente, el mecanismo del <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">modo de administrador restringido se</a> hab칤a propuesto para estos fines, pero limitaba la conexi칩n a un solo servidor.  Una vez conectado al servidor, era imposible usar los recursos de la red, los derechos de administrador se aplicaron a un solo servidor a la cuenta del sistema local. </p><br><p>  Remote Credential Guard le permite transferir credenciales desde la m치quina local a un servidor remoto sin ingresar una contrase침a expl칤cita, lo que, adem치s de la seguridad avanzada, tambi칠n proporcionar치 la conveniencia de conectarse a los servidores (SSO).  Puede leer m치s en la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">documentaci칩n</a> , pero agregar칠 que para que el mecanismo funcione es suficiente para habilitar su soporte en el servidor, por ejemplo, a trav칠s del registro con el comando: </p><br><pre> <code class="bash hljs">reg add HKLM\SYSTEM\CurrentControlSet\Control\Lsa /v DisableRestrictedAdmin /d 0</code> </pre><br><p>  Y luego con칠ctese al servidor con el comando: </p><br><pre> <code class="bash hljs">mstsc.exe /remoteGuard</code> </pre><br><p>  Ahora las credenciales son seguras y el servidor es bastante seguro.  Es cierto que en el material no toqu칠 conscientemente cuestiones de protecci칩n contra un host malicioso, pero aqu칤 se trata de una cosa en general: el cifrado de disco. </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/474088/">https://habr.com/ru/post/474088/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../474070/index.html">Dispositivos de sala de reuniones BYOD</a></li>
<li><a href="../474076/index.html">C칩mo convertirse en el mejor del mundo en un nicho</a></li>
<li><a href="../474080/index.html">Telegram bot que muestra las portadas de las 10 publicaciones peri칩dicas m치s populares del mundo</a></li>
<li><a href="../474082/index.html">Phonocut: una grabadora de vinilo dom칠stica: reflexiones sobre la probabilidad de despegue</a></li>
<li><a href="../474084/index.html">Julia y redes neuronales: flujo</a></li>
<li><a href="../474090/index.html">Salarios de desarrolladores en Armenia</a></li>
<li><a href="../474092/index.html">Secci칩n de backend en DUMP Kazan: arquitectura de aplicaciones en la nube, microservicios salientes, DDD y m치s</a></li>
<li><a href="../474094/index.html">Editor de diagrama de bloques: sobre la amistad entre Vue.js y MxGraph</a></li>
<li><a href="../474096/index.html">Lenguajes de programaci칩n populares 2019 de los usuarios de hh.ru</a></li>
<li><a href="../474104/index.html">Una forma universal de personalizar la apariencia de una aplicaci칩n WinForms (usando el ejemplo de FAQ.Net)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>