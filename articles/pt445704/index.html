<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üôèüèº üîπ üôåüèª Citymobil - um guia para startups para aumentar a estabilidade em meio ao crescimento. Parte 2. Quais s√£o os tipos de acidentes? üç£ üï∑Ô∏è üë©‚Äçüë©‚Äçüë¶</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Este √© o segundo artigo de uma s√©rie sobre como n√≥s da Citymobil aumentamos a estabilidade do servi√ßo (voc√™ pode ler o primeiro aqui ). Neste artigo, ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Citymobil - um guia para startups para aumentar a estabilidade em meio ao crescimento. Parte 2. Quais s√£o os tipos de acidentes?</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/mailru/blog/445704/"><img src="https://habrastorage.org/getpro/habr/post_images/61f/db5/50d/61fdb550d3b183fa7f134339397e276f.png"><br><br>  Este √© o segundo artigo de uma s√©rie sobre como n√≥s da Citymobil aumentamos a estabilidade do servi√ßo (voc√™ pode ler o primeiro <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">aqui</a> ).  Neste artigo, vou me aprofundar nas especificidades da an√°lise de acidentes.  Mas, antes disso, abordarei um ponto em que tive que pensar com anteced√™ncia e abordar no primeiro artigo, mas n√£o pensei nisso.  E sobre o qual aprendi com o feedback dos leitores.  O segundo artigo me d√° a chance de eliminar esse defeito irritante. <br><a name="habracut"></a><br><h2>  0. Pr√≥logo </h2><br>  Um dos leitores fez uma pergunta muito justa: "O que √© dif√≠cil no backend de um servi√ßo de t√°xi?"  A pergunta √© boa.  Eu me perguntei no ver√£o passado antes de come√ßar a trabalhar na Citymobil.  Ent√£o pensei "pense em um t√°xi, em um aplicativo com tr√™s bot√µes".  O que poderia ser complicado sobre isso?  Mas aconteceu que este √© um servi√ßo de alta tecnologia e um produto complexo.  Para pelo menos esclarecer o que √© e o que realmente √© um grande colosso tecnol√≥gico, falarei sobre v√°rias √°reas das atividades de produtos da Citymobil: <br><br><ul><li>  Pre√ßos.  A equipe de pre√ßos lida com problemas de pre√ßos em todos os pontos e a qualquer momento.  O pre√ßo √© determinado pela previs√£o do balan√ßo de oferta e demanda com base em estat√≠sticas e outros dados.  Tudo isso cria um servi√ßo grande, complexo e em constante evolu√ß√£o, baseado no aprendizado de m√°quina. </li><li>  Pre√ßos.  A implementa√ß√£o de v√°rios m√©todos de pagamento, a l√≥gica das sobretaxas ap√≥s a viagem, reter fundos em cart√µes banc√°rios, cobran√ßa, intera√ß√£o com parceiros e motoristas. </li><li>  Distribui√ß√£o de pedidos.  Em qual m√°quina distribuir o pedido de vendas?  Por exemplo, a op√ß√£o de distribui√ß√£o para a mais pr√≥xima n√£o √© a melhor em termos de aumento do n√∫mero de viagens.  Uma op√ß√£o mais correta √© comparar clientes e carros de forma a maximizar o n√∫mero de viagens, dada a probabilidade de cancelamento por esse cliente em particular nessas condi√ß√µes (porque leva muito tempo) e o cancelamento ou sabotagem do pedido por esse motorista (porque leva muito tempo ou muito pouco cheque). </li><li>  Geo.  Tudo relacionado √† busca e localiza√ß√£o de endere√ßos, pontos de aterrissagem, ajuste do tempo de entrega (nossos parceiros, fornecedores de cart√µes e engarrafamentos nem sempre fornecem informa√ß√µes precisas sobre o ETA, levando em conta os engarrafamentos), melhorando a precis√£o do geocodifica√ß√£o direta e reversa, melhorando a precis√£o da m√°quina.  H√° muito trabalho com dados, muitas an√°lises, muitos servi√ßos baseados no aprendizado de m√°quina. </li><li>  Antifraude.  A diferen√ßa no pre√ßo de uma viagem para um passageiro e um motorista (por exemplo, em viagens curtas) cria um incentivo econ√¥mico para os fraudadores que est√£o tentando roubar nosso dinheiro.  O combate √† fraude √© um pouco semelhante ao combate ao spam no servi√ßo de email - a integridade e a precis√£o s√£o importantes.  √â necess√°rio bloquear o n√∫mero m√°ximo de fraudadores (perfei√ß√£o), mas bons usu√°rios n√£o devem ser confundidos com fraudadores (precis√£o). </li><li> Motiva√ß√£o dos motoristas.  A equipe de motiva√ß√£o do motorista est√° envolvida no desenvolvimento de tudo relacionado ao aumento do uso da nossa plataforma pelos motoristas e pela lealdade do motorista devido a v√°rios tipos de motiva√ß√£o.  Por exemplo, fa√ßa viagens X e obtenha rublos Y adicionais para isso.  Ou compre um turno por rublos Z e viaje sem comiss√£o. </li><li>  Aplicativo de driver de back-end.  Uma lista de pedidos, um mapa de demanda (uma dica para onde ir ao motorista para maximizar sua receita), altera√ß√µes de status prokidyvaniya, um sistema de comunica√ß√£o com drivers e muito mais. </li><li>  O back-end do aplicativo cliente (esta √© provavelmente a parte mais √≥bvia e o que geralmente √© entendido pelo back-end de um t√°xi): fazer pedidos, rolar status sobre a altera√ß√£o do status do pedido, garantir a circula√ß√£o de carros no mapa no pedido e na entrega, dicas de back-end e etc. </li></ul><br>  Esta √© toda a ponta do iceberg.  Funcionalidade √© muito mais.  A interface amig√°vel esconde uma enorme parte subaqu√°tica do iceberg. <br><br>  E agora de volta aos acidentes.  Nos seis meses de hist√≥rico de acidentes, compilamos a seguinte categoriza√ß√£o: <br><br><ul><li>  vers√£o ruim, 500 erros; </li><li>  libera√ß√£o ruim, c√≥digo abaixo do ideal, carga na base; </li><li>  interven√ß√£o manual malsucedida no sistema; </li><li>  ovo de p√°scoa; </li><li>  causas externas; </li><li>  vers√£o ruim, funcionalidade corrompida. </li></ul><br>  Abaixo, anotarei as conclus√µes que tiramos sobre os tipos mais comuns de acidentes. <br><br><h2>  1. Vers√£o ruim, 500¬∫ erros </h2><br>  Quase todo o nosso back-end √© escrito em PHP, uma linguagem interpretada com digita√ß√£o fraca.  Acontece que voc√™ lan√ßa o c√≥digo e ele falha devido a um erro no nome da classe ou fun√ß√£o.  E este √© apenas um exemplo quando o 500¬∫ erro aparece.  Tamb√©m pode aparecer no caso de um erro l√≥gico no c√≥digo;  lambeu o ramo errado;  acidentalmente excluiu a pasta com o c√≥digo;  deixado no c√≥digo artefatos tempor√°rios necess√°rios para teste;  n√£o alterou a estrutura das tabelas de acordo com o novo c√≥digo;  n√£o reiniciou ou parou os scripts cron necess√°rios. <br><br>  Lutamos com esse problema sequencialmente em v√°rias etapas.  As viagens perdidas devido a baixa libera√ß√£o s√£o obviamente proporcionais ao tempo em que foram usadas.  Ou seja, devemos fazer o poss√≠vel para garantir que uma vers√£o ruim esteja em opera√ß√£o o m√≠nimo poss√≠vel.  Qualquer altera√ß√£o no processo de desenvolvimento que reduz o tempo m√©dio necess√°rio para obter uma vers√£o ruim em uso por pelo menos 1 segundo √© positiva para os neg√≥cios e precisa ser implementada. <br><br>  Uma vers√£o ruim ou qualquer acidente de produ√ß√£o geralmente passa por dois estados, que chamamos de "est√°gio passivo" e "est√°gio ativo".  O est√°gio passivo √© quando ainda n√£o estamos cientes do acidente.  O est√°gio ativo √© quando j√° estamos sabendo.  O acidente come√ßa na fase passiva e, com o tempo, quando descobrimos, o acidente entra na fase ativa - come√ßamos a combat√™-lo: primeiro diagnosticamos e depois reparamos. <br><br>  Para reduzir a dura√ß√£o de qualquer acidente na produ√ß√£o, √© necess√°rio reduzir a dura√ß√£o m√©dia dos est√°gios passivo e ativo.  O mesmo vale para uma vers√£o ruim, porque √© em si um tipo de acidente. <br><br>  Come√ßamos a analisar nosso processo atual de repara√ß√£o de acidentes.  As vers√µes ruins que encontramos no momento do in√≠cio da an√°lise resultaram em uma m√©dia ociosa (total ou parcial) de 20 a 25 minutos.  O est√°gio passivo geralmente levava 15 minutos, o ativo 10 minutos.  Durante a fase passiva, as reclama√ß√µes dos usu√°rios come√ßaram a ser processadas pelo contact center e, ap√≥s algum limiar, o contact center se queixou de chats gerais no Slack.  √Äs vezes, um dos funcion√°rios reclamava quando ele n√£o podia pedir um t√°xi.  Uma reclama√ß√£o de funcion√°rio foi um sinal para n√≥s sobre um problema s√©rio.  Ap√≥s a transi√ß√£o de uma vers√£o ruim para o est√°gio ativo, come√ßamos a diagnosticar o problema, analisamos as vers√µes mais recentes, v√°rios gr√°ficos e logs para determinar a causa do acidente.  Ap√≥s descobrir o motivo, revertemos o c√≥digo se a vers√£o ruim foi lan√ßada por √∫ltimo ou fizemos uma nova revers√£o com o reverso da confirma√ß√£o da vers√£o ruim. <br><br>  Aqui est√° um processo para lidar com lan√ßamentos ruins, tivemos que melhorar. <br><br><h3>  1.1  Redu√ß√£o passiva do est√°gio </h3><br>  Antes de tudo, percebemos que, se uma vers√£o ruim √© acompanhada por 500 erros, podemos entender sem queixa que ocorreu um problema.  Felizmente, todos os 500 erros foram registrados na New Relic (este √© um dos sistemas de monitoramento que usamos), e restava apenas enviar notifica√ß√µes por SMS e URA sobre o excesso de uma certa frequ√™ncia de "quinhentos" (com o tempo, o limite era constantemente reduzido). <br><br>  Isso levou ao fato de que a fase ativa do acidente, como "Vers√£o ruim, 500¬∫ erro" come√ßou quase imediatamente ap√≥s a vers√£o.  O processo em caso de acidente come√ßou a ter a seguinte apar√™ncia: <br><br><ol><li>  O programador implementa o c√≥digo. </li><li>  O lan√ßamento leva a um acidente (enormes 500s). </li><li>  O SMS chega. </li><li>  Programadores e administradores come√ßam a entender (√†s vezes n√£o imediatamente, mas ap√≥s 2-3 minutos: o SMS pode atrasar, o som do telefone pode ser desligado e a cultura de a√ß√µes imediatas ap√≥s o SMS n√£o pode aparecer em um dia). </li><li>  A fase ativa do acidente come√ßa, que dura os mesmos 10 minutos de antes. </li></ol><br>  Assim, o est√°gio passivo foi reduzido de 15 minutos para 3. <br><br><h3>  1.2  Redu√ß√£o adicional do est√°gio passivo </h3><br>  Apesar da redu√ß√£o do est√°gio passivo para 3 minutos, mesmo um est√°gio passivo t√£o curto nos incomodou mais do que o ativo, porque durante o est√°gio ativo j√° fazemos algo para resolver o problema e, durante o est√°gio passivo, o servi√ßo n√£o funciona no todo ou em parte, mas ‚Äú os homens n√£o sabem. " <br><br>  Para reduzir ainda mais o est√°gio passivo, decidimos sacrificar tr√™s minutos de tempo do desenvolvedor ap√≥s cada vers√£o.  A id√©ia era muito simples: voc√™ lan√ßa o c√≥digo e olha para New Relic, Sentry, Kibana por tr√™s minutos para ver se h√° 500 erros.  Assim que voc√™ encontrar um problema, a priori, voc√™ assume que est√° relacionado ao seu c√≥digo e come√ßa a entender. <br><br>  Escolhemos tr√™s minutos com base nas estat√≠sticas: √†s vezes os problemas apareciam nas paradas com um atraso de 1-2 minutos, mas nunca havia mais de tr√™s minutos. <br><br>  Esta regra foi registrada em fazer e n√£o fazer.  No come√ßo, nem sempre era executado, mas gradualmente os desenvolvedores se acostumavam √† regra como higiene b√°sica: escovar os dentes pela manh√£ tamb√©m √© uma perda de tempo, mas √© preciso fazer isso. <br><br>  Como resultado, o est√°gio passivo foi reduzido para 1 minuto (os hor√°rios ainda estavam atrasados ‚Äã‚Äã√†s vezes).  Como uma surpresa agrad√°vel, isso reduziu simultaneamente o est√°gio ativo.  Afinal, o desenvolvedor encontra um problema em boa forma e est√° pronto para reverter imediatamente seu c√≥digo.  Embora isso nem sempre ajude, porque  o problema poderia ter surgido devido ao c√≥digo de outra pessoa que estava sendo implementado em paralelo.  Mas, no entanto, o est√°gio ativo foi reduzido em m√©dia para 5 minutos. <br><br><h3>  1.3  Redu√ß√£o adicional no est√°gio ativo </h3><br>  Mais ou menos satisfeitos com um minuto do est√°gio passivo, come√ßamos a pensar em uma redu√ß√£o adicional no est√°gio ativo.  Antes de tudo, prestamos aten√ß√£o ao hist√≥rico de problemas (√© a pedra angular na constru√ß√£o de nossa estabilidade!) E descobrimos que, em muitos casos, n√£o retrocedemos imediatamente porque n√£o entendemos para qual vers√£o retroceder, porque existem muitas vers√µes paralelas.  Para resolver esse problema, introduzimos a seguinte regra (e a registramos em fa√ßa e n√£o fa√ßa): antes do lan√ßamento, voc√™ escreve para o bate-papo no Slack, para o que est√° rolando e para qu√™ e, no caso de um acidente, escreve para o bate-papo "acidente, n√£o role!".  Al√©m disso, come√ßamos a relatar automaticamente via SMS sobre os fatos da vers√£o para notificar quem n√£o entra no bate-papo. <br><br>  Essa regra simples reduziu drasticamente o n√∫mero de lan√ßamentos j√° ocorridos durante acidentes e reduziu o est√°gio ativo - de 5 minutos para 3. <br><br><h3>  1.4  Uma redu√ß√£o ainda maior no est√°gio ativo </h3><br>  Apesar de termos alertado no bate-papo sobre todos os lan√ßamentos e falhas, algumas vezes as condi√ß√µes da corrida apareceram - uma escreveu sobre a libera√ß√£o e a outra j√° foi lan√ßada naquele momento;  ou o acidente come√ßou, eles escreveram sobre isso no bate-papo e algu√©m acabou de lan√ßar um novo c√≥digo.  Essas circunst√¢ncias prolongaram o diagn√≥stico.  Para resolver esse problema, implementamos uma proibi√ß√£o autom√°tica de vers√µes paralelas.  A ideia √© muito simples: ap√≥s cada vers√£o, o sistema de CI / CD pro√≠be que todos os lan√ßamentos sejam lan√ßados pelos pr√≥ximos 5 minutos, exceto o autor do √∫ltimo lan√ßamento (para que ele possa lan√ßar ou lan√ßar hotfix, se necess√°rio) e v√°rios desenvolvedores especialmente experientes (em caso de emerg√™ncia).  Al√©m disso, o sistema de CI / CD pro√≠be a implanta√ß√£o durante um acidente (ou seja, desde o momento em que a notifica√ß√£o foi recebida no in√≠cio do acidente at√© o momento em que a notifica√ß√£o foi conclu√≠da). <br><br>  Assim, o processo ficou assim: o desenvolvedor lan√ßa, monitora os gr√°ficos por tr√™s minutos e, depois disso, por mais dois minutos, ningu√©m pode lan√ßar nada.  Se houver algum problema, o desenvolvedor reverte o release.  Essa regra simplificou radicalmente o diagn√≥stico e a dura√ß√£o total dos est√°gios ativo e passivo diminuiu de 3 + 1 = 4 minutos para 1 + 1 = 2 minutos. <br><br>  Mas dois minutos do acidente s√£o muitos.  Portanto, continuamos a otimizar o processo. <br><br><h3>  1.5  Detec√ß√£o e revers√£o autom√°ticas de falhas </h3><br>  Temos pensado h√° muito tempo em como reduzir a dura√ß√£o do acidente devido a lan√ßamentos ruins.  Eles at√© tentaram se for√ßar a olhar na <code>tail -f error_log | grep 500</code>  <code>tail -f error_log | grep 500</code> .  Mas no final, todos eles decidiram por uma solu√ß√£o cardinal autom√°tica. <br><br>  Em resumo, isso √© uma revers√£o autom√°tica.  Configuramos um servidor da web separado, no qual carregamos 10 vezes menos carga do balanceador do que em outros servidores da web.  Cada vers√£o foi implantada automaticamente pelo sistema CI / CD neste servidor separado (chamamos de pr√©-produ√ß√£o, embora, apesar do nome, a carga real de usu√°rios reais tenha ido para l√°).  E ent√£o a automa√ß√£o seguiu <code>tail -f error_log | grep 500</code>  <code>tail -f error_log | grep 500</code> .  Se nenhum erro 500 ocorrer dentro de um minuto, o CI / CD implantou o novo c√≥digo em produ√ß√£o.  Se erros aparecessem, o sistema imediatamente revertia tudo.  Ao mesmo tempo, no n√≠vel do balanceador, todas as solicita√ß√µes conclu√≠das com 500 erros no pr√©-produto foram duplicadas em um dos servidores de produ√ß√£o. <br><br>  Essa medida reduziu o efeito das quinhentas libera√ß√µes para zero.  Ao mesmo tempo, no caso de erros na automa√ß√£o, n√£o cancelamos a regra por tr√™s minutos para monitorar os gr√°ficos.  Isso √© tudo sobre lan√ßamentos ruins e 500¬∫ bugs.  Prosseguimos para o pr√≥ximo tipo de acidente. <br><br><h2>  2. Vers√£o ruim, c√≥digo abaixo do ideal, carga b√°sica </h2><br>  Come√ßarei imediatamente com um exemplo concreto de um acidente desse tipo.  Implementamos a otimiza√ß√£o: adicionamos <code>USE INDEX</code> √† consulta SQL, durante o teste dessas consultas curtas aceleradas, como na produ√ß√£o, mas as consultas longas diminu√≠ram.  A desacelera√ß√£o de consultas longas foi notada apenas na produ√ß√£o.  Como resultado, o fluxo de solicita√ß√µes longas coloca toda a base principal por uma hora.  Compreendemos perfeitamente como o <code>USE INDEX</code> funciona, o descrevemos no arquivo do's &amp; dont e alertamos os desenvolvedores contra o uso indevido.  Tamb√©m analisamos a consulta e percebemos que ela retorna principalmente dados hist√≥ricos, o que significa que ela pode ser executada em uma r√©plica separada para consultas hist√≥ricas.  Mesmo se essa r√©plica estiver sob carga, os neg√≥cios n√£o ser√£o interrompidos. <br><br>  Ap√≥s esse incidente, ainda enfrentamos problemas semelhantes e, em algum momento, decidimos abordar o problema sistematicamente.  Analisamos todo o c√≥digo com um pente frequente e realizamos at√© a r√©plica todos os pedidos que podem ser feitos l√°, sem comprometer a qualidade do servi√ßo.  Ao mesmo tempo, dividimos as pr√≥prias r√©plicas de acordo com os n√≠veis de criticidade, para que a queda de qualquer uma delas n√£o parasse o servi√ßo.  Como resultado, chegamos a uma arquitetura que possui as seguintes bases: <br><br><ul><li>  base mestre (para opera√ß√µes de grava√ß√£o e para consultas que s√£o supercr√≠ticas √† atualiza√ß√£o de dados); </li><li>  r√©plica de produ√ß√£o (para consultas curtas que s√£o um pouco menos cr√≠ticas para a atualiza√ß√£o dos dados); </li><li>  r√©plica para o c√°lculo de √≠ndices de pre√ßos, os chamados pre√ßos de aumento.  Essa r√©plica pode demorar entre 30 a 60 segundos - isso n√£o √© cr√≠tico, os coeficientes mudam com tanta frequ√™ncia e, se essa r√©plica cair, o servi√ßo n√£o ser√° interrompido, apenas os pre√ßos n√£o corresponder√£o exatamente ao equil√≠brio de oferta e demanda; </li><li>  r√©plica para o painel de administra√ß√£o de usu√°rios de neg√≥cios e o contact center (se cair, o neg√≥cio principal n√£o aumentar√°, mas o suporte n√£o funcionar√° e n√£o poderemos exibir e alterar temporariamente as configura√ß√µes); </li><li>  muitas r√©plicas para an√°lises; </li><li>  Banco de dados MPP para an√°lises pesadas com fatias completas de acordo com dados hist√≥ricos. </li></ul><br>  Essa arquitetura nos deu mais espa√ßo para crescimento e reduziu o n√∫mero de falhas em uma ordem de magnitude devido a consultas SQL abaixo do ideal.  Mas ela ainda est√° longe do ideal.  Planeja fazer sharding para que voc√™ possa dimensionar atualiza√ß√µes e exclus√µes, bem como consultas curtas, supercr√≠ticas √† atualiza√ß√£o desses dados.  A margem de seguran√ßa do MySQL n√£o √© infinita.  Em breve, precisaremos de artilharia pesada na forma de um Tarantool.  Sobre isso ser√° necess√°rio nos seguintes artigos! <br><br>  No processo do teste com c√≥digos e solicita√ß√µes n√£o ideais, percebemos o seguinte: √© melhor eliminar qualquer n√£o otimiza√ß√£o antes do lan√ßamento e n√£o depois.  Isso reduz o risco de um acidente e reduz o tempo gasto pelos desenvolvedores na otimiza√ß√£o.  Porque, se o c√≥digo j√° foi baixado e h√° novas vers√µes, √© muito mais dif√≠cil otimizar.  Como resultado, introduzimos uma verifica√ß√£o de c√≥digo obrigat√≥ria para otimizar.  √â conduzido pelos desenvolvedores mais experientes, de fato, nossas for√ßas especiais. <br><br>  Al√©m disso, come√ßamos a coletar no melhor e no n√£o os melhores m√©todos de otimiza√ß√£o de c√≥digo que funcionam em nossas realidades, eles est√£o listados abaixo.  Por favor, n√£o percebam essas pr√°ticas como verdade absoluta e n√£o tente repeti-las cegamente em si mesmos.  Cada m√©todo faz sentido apenas para uma situa√ß√£o espec√≠fica e um neg√≥cio espec√≠fico.  Eles s√£o fornecidos aqui apenas por exemplo, para que os detalhes sejam claros: <br><br><ul><li>  Se a consulta SQL n√£o depender do usu√°rio atual (por exemplo, um mapa de demanda por drivers indicando as taxas de viagens m√≠nimas e coeficientes para pol√≠gonos), essa consulta dever√° ser feita pelo cron com uma certa frequ√™ncia (no nosso caso, uma vez a cada minuto).  Escreva o resultado no cache (Memcached ou Redis), que j√° √© usado no c√≥digo de produ√ß√£o. </li><li>  Se a consulta SQL operar com dados cuja lista n√£o processada n√£o seja cr√≠tica para os neg√≥cios, seu resultado dever√° ser armazenado em cache com algum TTL (por exemplo, 30 segundos).  E, em solicita√ß√µes subseq√ºentes, leia do cache. </li><li>  Se, no contexto do processamento de uma solicita√ß√£o na Web (no nosso caso, no contexto da implementa√ß√£o de um m√©todo de servidor espec√≠fico em PHP), voc√™ desejar fazer uma consulta SQL, precisar√° garantir que esses dados n√£o "cheguem" a nenhuma outra consulta SQL (e se eles chegar√£o mais longe por c√≥digo).  O mesmo se aplica ao acesso ao cache: ele tamb√©m pode ser inundado com solicita√ß√µes, se voc√™ desejar, portanto, se os dados j√° "chegaram" do cache, voc√™ n√£o precisa ir ao cache como em sua casa e retir√°-lo, o que j√° foi retirado. </li><li>  Se, no contexto do processamento de consultas na Web, voc√™ desejar chamar alguma fun√ß√£o, precisar√° garantir que nenhuma consulta SQL ou acesso a cache extra seja feito em seus giblets.  Se a chamada de uma fun√ß√£o for inevit√°vel, voc√™ precisar√° garantir que ela n√£o possa ser modificada ou que sua l√≥gica seja desfeita para n√£o fazer consultas desnecess√°rias aos bancos de dados / caches. </li><li>  Se voc√™ ainda precisar acessar o SQL, verifique se n√£o √© poss√≠vel adicionar os campos necess√°rios mais alto ou mais baixo no c√≥digo √†s consultas que j√° existem no c√≥digo. </li></ul><br><h2>  3. Interven√ß√£o manual malsucedida no sistema </h2><br>  Exemplos desses acidentes: um ALTER malsucedido (que sobrecarregou o banco de dados ou provocou um atraso na r√©plica) ou DROP malsucedido (encontrou um bug no MySQL, bloqueou o banco de dados quando uma nova tabela foi descartada);  pedido pesado de mestre feito por engano √† m√£o;  Realizamos um trabalho no servidor sob carga, embora pens√°ssemos que estava sem trabalho. <br><br>  Para minimizar quedas por esses motivos, √© necess√°rio, infelizmente, entender a natureza do acidente a cada vez.  Ainda n√£o encontramos a regra geral.  Mais uma vez, tente os exemplos.  Digamos que, em algum momento, os coeficientes de pico pararam de funcionar (eles multiplicam o pre√ßo da viagem no local e no hor√°rio de maior demanda).  O motivo foi que, na r√©plica do banco de dados, de onde vieram os dados para calcular os coeficientes, o script Python funcionou, que consumiu toda a mem√≥ria, e a r√©plica caiu.  O script est√° em execu√ß√£o h√° muito tempo, funcionou em uma r√©plica apenas por conveni√™ncia.  O problema foi resolvido reiniciando o script.  As conclus√µes foram as seguintes: n√£o execute scripts de terceiros em uma m√°quina com um banco de dados (gravado em do's &amp; dont's; caso contr√°rio, isso √© um tiro em branco!), Monitore o fim da mem√≥ria em uma m√°quina com uma r√©plica e alerta por SMS se a mem√≥ria acabar rapidamente. <br><br>  √â muito importante sempre tirar conclus√µes e n√£o cair em uma situa√ß√£o confort√°vel "eles viram um problema, consertaram e esqueceram".  Um servi√ßo de qualidade s√≥ pode ser constru√≠do se forem tiradas conclus√µes.  Al√©m disso, os alertas por SMS s√£o muito importantes - eles definem a qualidade do servi√ßo em um n√≠vel mais alto do que o fizeram, impedem que caiam e melhoram ainda mais a confiabilidade.  Como escalador de cada estado est√°vel, ele se levanta e √© fixado em outro estado est√°vel, mas a uma altitude mais alta. <br><br>  Monitorar e alertar com ganchos de ferro invis√≠veis, por√©m r√≠gidos, cortam a rocha da incerteza e nunca nos deixam abaixo do n√≠vel de estabilidade que estabelecemos, que constantemente aumentamos apenas. <br><br><h2>  4. ovo de pascoa </h2><br>  O que chamamos de "Ovo de P√°scoa" √© uma bomba-rel√≥gio que existe h√° muito tempo, mas que n√£o encontramos.  Fora deste artigo, este termo refere-se a um recurso n√£o documentado feito de prop√≥sito.  No nosso caso, isso n√£o √© um recurso, mas um bug, mas que funciona como uma bomba-rel√≥gio e que √© um efeito colateral de boas inten√ß√µes. <br><br>  Por exemplo: estouro <code>auto_increment</code> 32 bits;  n√£o otimiza√ß√£o no c√≥digo / configura√ß√£o, "tiro" devido √† carga;  r√©plica atrasada (geralmente devido a uma solicita√ß√£o sub√≥tima de uma r√©plica que foi acionada por um novo padr√£o de uso ou uma carga mais alta ou por uma UPDATE sub√≥tima no mestre que foi chamada por um novo padr√£o de carga e carregou a r√©plica). <br><br>  Outro tipo popular de ovo de P√°scoa √© o c√≥digo n√£o ideal e, mais especificamente, a consulta SQL n√£o ideal.  Anteriormente, a tabela era menor e a carga era menor - a consulta funcionava bem.  E com o aumento da tabela, linear no tempo e no crescimento da carga, linear no tempo, o consumo de recursos do DBMS cresceu quadraticamente.  Normalmente, isso leva a um forte efeito negativo: tudo estava "ok" e bang. <br><br>  Cen√°rios mais raros s√£o uma combina√ß√£o de insetos e ovos de p√°scoa.  Uma vers√£o com um bug levou a um aumento no tamanho da tabela ou no n√∫mero de registros em uma tabela de um determinado tipo, e um ovo de P√°scoa j√° existente causou uma carga excessiva no banco de dados devido a consultas mais lentas nessa tabela de crescimento excessivo. <br><br>  Embora tamb√©m tiv√©ssemos ovos de P√°scoa, n√£o relacionados √† carga.  Por exemplo, <code>auto increment</code> 32 bits: ap√≥s dois e alguns bilh√µes de registros na tabela, as inser√ß√µes deixam de ser executadas.  Portanto, o campo do <code>auto increment</code> no mundo moderno deve ser feito de 64 bits.  Aprendemos bem esta li√ß√£o. <br><br>  Como lidar com ovos de P√°scoa?  A resposta √© simples: a) procure por "ovos" velhos eb) evite que novos ovos apare√ßam.  Tentamos cumprir os dois pontos.  A busca por "ovos" antigos em nosso pa√≠s est√° associada √† otimiza√ß√£o constante do c√≥digo.  Identificamos dois dos desenvolvedores mais experientes para otimiza√ß√£o em tempo integral.  Eles encontram em consultas slow.log que consomem mais recursos do banco de dados, otimizam essas consultas e o c√≥digo ao seu redor.  Reduzimos a probabilidade de novos ovos, verificando o c√≥digo de otimiza√ß√£o de cada confirma√ß√£o pelo sensei rezrabotchiki mencionado acima.  A tarefa deles √© apontar erros que afetam o desempenho;  dizer como fazer melhor e transferir conhecimento para outros desenvolvedores. <br><br>  Em algum momento ap√≥s o pr√≥ximo ovo de p√°scoa que encontramos, percebemos que pesquisar consultas lentas √© bom, mas vale a pena pesquisar adicionalmente consultas que parecem lentas, mas funcionam rapidamente.  Esses s√£o apenas os pr√≥ximos candidatos a colocar tudo no caso de um crescimento explosivo da pr√≥xima tabela. <br><br><h2>  5. Causas externas </h2><br>  Essas s√£o as raz√µes que consideramos pouco controladas por n√≥s.  Por exemplo: <br><br><ul><li>  Trote pelo Google Maps.  Voc√™ pode contornar isso monitorando o uso desse servi√ßo, observando um certo n√≠vel de carga, planejando o crescimento da carga com anteced√™ncia e comprando a expans√£o do servi√ßo. </li><li>  A queda da rede no data center.  Voc√™ pode se locomover colocando uma c√≥pia do servi√ßo no centro de dados de backup. </li><li>  Acidente de servi√ßo de pagamento.  Voc√™ pode ignorar a reserva de servi√ßos de pagamento. </li><li>  Bloqueio de tr√°fego incorreto pelo servi√ßo de prote√ß√£o DDoS.  Voc√™ pode se deslocar desativando o servi√ßo de prote√ß√£o DDoS padr√£o e ativando-o apenas no caso de um ataque DDoS. </li></ul><br>  Como a elimina√ß√£o de uma causa externa √© uma tarefa longa e cara (por defini√ß√£o), come√ßamos a coletar estat√≠sticas sobre acidentes devido a causas externas e aguardamos o ac√∫mulo de massa cr√≠tica.  N√£o h√° receita para determinar a massa cr√≠tica.  Simplesmente funciona intui√ß√£o.  Por exemplo, se estiv√©ssemos cinco vezes em tempo de inatividade total devido a problemas, digamos, do servi√ßo de controle DDoS, a cada queda seguinte, ele se tornar√° cada vez mais n√≠tido para levantar a quest√£o de uma alternativa. <br><br>  Por outro lado, se voc√™ pode, de alguma forma, faz√™-lo funcionar com um servi√ßo externo inacess√≠vel, n√≥s definitivamente o fazemos.  E isso nos ajuda a analisar post-mortem de cada queda.  Sempre deve haver uma conclus√£o.  Isso significa que voc√™ sempre n√£o quer, mas pode criar uma solu√ß√£o alternativa. <br><br><h2>  6. Vers√£o ruim, funcionalidade corrompida </h2><br>  Este √© o tipo mais desagrad√°vel de acidente.  O √∫nico tipo de acidente que n√£o √© vis√≠vel para sintomas que n√£o sejam reclama√ß√µes de usu√°rios / neg√≥cios.  Portanto, esse acidente, especialmente se n√£o for grande, pode existir despercebido na produ√ß√£o por um longo tempo. <br><br>  Todos os outros tipos de acidentes s√£o mais ou menos parecidos com ‚Äúm√° libera√ß√£o, 500¬∫ erro‚Äù.  S√≥ que o gatilho n√£o √© uma libera√ß√£o, mas uma carga, uma opera√ß√£o manual ou um problema ao lado de um servi√ßo externo. <br><br>  Para descrever o m√©todo de lidar com esse tipo de acidente, basta recordar uma anedota barbada: <br><br><blockquote>  A matem√°tica e a f√≠sica receberam a mesma tarefa: ferver uma chaleira.  Ferramentas auxiliares s√£o dadas: fog√£o, chaleira, torneira de √°gua com √°gua, f√≥sforos.  Os dois alternadamente despejam √°gua na chaleira, ligam o g√°s, acendem e acendem a chaleira.  Em seguida, a tarefa foi simplificada: uma chaleira cheia de √°gua e um fog√£o com g√°s ardente foram propostos.  O objetivo √© o mesmo - ferver √°gua.  O f√≠sico p√µe fogo na chaleira.  O matem√°tico derrama √°gua da chaleira, desliga o g√°s e diz: "A tarefa foi reduzida √† anterior".  anekdotov.net </blockquote><br>  Este tipo de acidente deve ser reduzido por todos os meios para "baixa libera√ß√£o, 500 erros".  Idealmente, se os erros no c√≥digo foram salvos no log como um erro.  Bem, ou pelo menos deixou vest√≠gios no banco de dados.  A partir desses rastreamentos, voc√™ pode entender que ocorreu um erro e alertar imediatamente.  Como contribuir para isso?  Come√ßamos a analisar cada bug principal e oferecer solu√ß√µes, que tipo de alerta de monitoramento / SMS pode ser feito para que esse bug se manifeste imediatamente da mesma maneira que o 500¬∫ erro. <br><br><h3>  6.1  Exemplo </h3><br>  Houve queixas maci√ßas: os pedidos pagos atrav√©s do Apple Pay n√£o fecham.  Eles come√ßaram a entender, o problema foi repetido.  Descobrimos o motivo: aprimoramos o formato da <code>expire date</code> dos cart√µes banc√°rios ao interagir com a aquisi√ß√£o, e eles come√ßaram a transferi-lo especificamente para pagamentos via Apple Pay no formato esperado no servi√ßo de processamento de pagamentos (na verdade, um √© trat√°vel, mutilando outra coisa), ent√£o todos os pagamentos atrav√©s do Apple Pay come√ßaram a declinar.  Rapidamente corrigido, lan√ßado, o problema desapareceu.  Mas eles "viveram" com o problema por 45 minutos. <br><br>  Seguindo os rastreios desse problema, monitoramos o n√∫mero de falhas nos pagamentos via Apple Pay e tamb√©m emitimos um alerta SMS / IVR com um limite diferente de zero (porque falhas nos pagamentos s√£o a norma do ponto de vista do servi√ßo, por exemplo, o cliente n√£o tem dinheiro no cart√£o ou o cart√£o est√° bloqueado) .  A partir deste momento, quando o limite √© excedido, aprendemos instantaneamente sobre o problema.  Se a nova vers√£o introduzir QUALQUER problema no processamento do Apple Pay, o que levar√° √† inoperabilidade do servi√ßo, mesmo parcial, aprenderemos imediatamente sobre isso a partir do monitoramento e reverteremos a vers√£o em tr√™s minutos (a descri√ß√£o acima descreve como o processo de rolagem manual funciona).  Foram 45 minutos de inatividade parcial e 3 minutos.  Lucro <br><br><h3>  6.2  Outros exemplos </h3><br>  Implementamos a otimiza√ß√£o da lista de pedidos oferecidos aos motoristas.  Um bug entrou no c√≥digo.  Como resultado, em alguns casos, os motoristas n√£o viram a lista de pedidos (estava vazia).  Eles descobriram o bug por acidente - um dos funcion√°rios examinou o aplicativo do motorista.  Revertido rapidamente.  Como conclus√£o do acidente, fizemos um gr√°fico do n√∫mero m√©dio de pedidos na lista de drivers de acordo com o banco de dados, analisamos o gr√°fico retroativamente por um m√™s, observamos uma falha l√° e fizemos um alerta por SMS para a consulta SQL, que forma esse gr√°fico quando o n√∫mero m√©dio de pedidos em a lista abaixo do limite selecionado com base no m√≠nimo hist√≥rico do m√™s. <br><br>  Mudou a l√≥gica de devolver os usu√°rios para viagens.  Incluindo distribu√≠do para o grupo errado de usu√°rios.  Corrigimos o problema, constru√≠mos um cronograma de reembolso, vimos um aumento acentuado l√°, tamb√©m vimos que nunca houve esse crescimento, fizemos um alerta por SMS. <br><br>  Com o lan√ßamento, a funcionalidade de fechamento de pedidos foi interrompida (o pedido foi encerrado para sempre, o pagamento com cart√µes n√£o funcionou, os motoristas exigiram pagamento em dinheiro dos clientes).  O problema foi de 1,5 horas (est√°gios totais passivos e ativos).  Aprendemos sobre o problema no contact center de reclama√ß√µes.  Eles fizeram uma corre√ß√£o, fizeram monitoramento e alertas sobre o hor√°rio de fechamento de pedidos com limiares encontrados no estudo de gr√°ficos hist√≥ricos. <br><br>  Como voc√™ pode ver, a abordagem para esse tipo de acidente √© sempre a mesma: <br><br><ol><li>  Abra a vers√£o. </li><li>  Aprenda sobre o problema. </li><li>  Corrija. </li><li>  Determinamos por quais rastreamentos (no banco de dados, logs, Kiban) voc√™ pode descobrir os sinais do problema. </li><li>  Tra√ßamos esses sinais. </li><li>  Retrocedemos no passado e olhamos para as explos√µes / quedas. </li><li>  Selecionamos o limite correto para o alerta. </li><li>  Quando um problema surge novamente, aprendemos imediatamente por meio de um alerta. </li></ol><br>  O que √© legal nesse m√©todo: uma enorme classe de problemas √© fechada imediatamente com um gr√°fico e um alerta (exemplos de classes de problemas: n√£o fechamento de pedidos, b√¥nus extras, n√£o pagamento via Apple Pay, etc.). <br><br>  Com o tempo, tornamos a cria√ß√£o de alertas e o monitoramento de todos os principais erros uma parte da cultura de desenvolvimento.  Para evitar que essa cultura se perca, formalizamos um pouco.  Para cada acidente, eles come√ßaram a exigir um relat√≥rio de si mesmos.  Um relat√≥rio √© um formul√°rio preenchido com respostas para as seguintes perguntas: causa raiz, m√©todo de elimina√ß√£o, impacto nos neg√≥cios, conclus√µes.  Todos os itens s√£o obrigat√≥rios.  Portanto, se voc√™ quiser ou n√£o, voc√™ escrever√° as conclus√µes.  Essa mudan√ßa de processo, √© claro, foi escrita por do's &amp; dont's. <br><br><h2>  7. Kotan </h2><br>    ,     ,    -,        .  - (  ,  )   ¬´¬ª.   ¬´¬ª.  :-) <br><br>  ¬´¬ª   : <br><br>  .          ‚Äî ,      .       ,   (  ),    (     )     ,        .      ( ,      ). <br><br>  .  ,    .   ,     :  ‚Äî   ,   ‚Äî   . , ¬´ 500-  1 %¬ª ‚Äî  .  ¬´ 500-  1 %,   - , - ,  - ¬ª ‚Äî  .         ,      .          (     ).         ,     :  ,   ¬´¬ª,   ,   ,    ,  .     ‚Äî     .      (  ,      ).      . <br><br> .      .        ,     (   ,     ,       ),   ,       :  ,  ,   , . <br><br>  .    ,   ,       ( ,   ). <br><br><h2> 8.      ? </h2><br>       ‚Äî  .    .  :   ,    .          ,    ,   .      ,  ,      , ..    ‚Äî  ,      ‚Äî !      ,     .           ,    ,  ?    ,       , .. ,    ,  . <br><br>           .      .     (    ,   ),    ,           :  ,  ,     ,   .     ,    ,        .          .           .       -,      ,    .    ,   ,      ,     ‚Äî   :          . <br><br><h2> 9.   </h2><br>      ,           . <br><br><table><tbody><tr><th>  ? </th><th>  ? </th></tr><tr><td>    . <br></td><td>        . <br></td></tr><tr><td>    (    )   post-mortem. <br></td><td>       . <br></td></tr><tr><td>    do's &amp; dont's. <br></td><td>     ,       ,   . <br></td></tr><tr><td>   ,    5 . <br></td><td>      . <br></td></tr><tr><td>        ,    . <br></td><td>      . <br></td></tr><tr><td>    . <br></td><td>      . <br></td></tr><tr><td>      <br></td><td>   . <br></td></tr><tr><td>       . <br></td><td>   . <br></td></tr><tr><td>        . <br></td><td>    . <br></td></tr><tr><td> SMS/IVR-  . <br></td><td>    . <br></td></tr><tr><td>   ( )    . <br></td><td>    . <br></td></tr><tr><td>    . <br></td><td>     -   . <br></td></tr><tr><td>    (   ‚Äî slow.log). <br></td><td>     - ¬´ ¬ª. <br></td></tr><tr><td>     . <br></td><td>       . <br></td></tr><tr><td>     . <br></td><td>        . <br></td></tr><tr><td>          . <br></td><td>   ,      ,         . <br></td></tr><tr><td> ¬´¬ª ‚Äî     . <br></td><td>   ,   . <br></td></tr><tr><td>  . <br></td><td>    . <br></td></tr></tbody></table><br>  ,    !       , , ,   ,    ! </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt445704/">https://habr.com/ru/post/pt445704/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt445692/index.html">Vis√£o geral dos recursos do PlayCanvas para criar aplicativos Web VR</a></li>
<li><a href="../pt445696/index.html">Como s√£o criados os rob√¥s que podem ir aonde estamos</a></li>
<li><a href="../pt445698/index.html">Licenciamento do NanoCAD</a></li>
<li><a href="../pt445700/index.html">‚Äú33 palavras sobre design‚Äù: quem e por que faz um filme sobre design na R√∫ssia</a></li>
<li><a href="../pt445702/index.html">SlowPochta - mensageiro de entrega injustificada de mensagens com tempo de encaminhamento indefinido</a></li>
<li><a href="../pt445706/index.html">Intel GPU SGX - Armazene seus dados na placa gr√°fica. Com uma garantia</a></li>
<li><a href="../pt445708/index.html">UICollectionView ao redor da cabe√ßa: alterando vistas em tempo real</a></li>
<li><a href="../pt445710/index.html">Gerenciamento de clima de equipe</a></li>
<li><a href="../pt445712/index.html">Seis regras para ajud√°-lo a alcan√ßar seus objetivos.</a></li>
<li><a href="../pt445714/index.html">O programa final do DUMP-2019 est√° pronto. Nos encontramos em 19 de abril em Ecaterimburgo</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>