<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üíÇüèº üë©üèº ü§∞üèæ 12,3 millions de WebSockets simultan√©s ü§µ üßöüèª ü§¢</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Une chose √† propos des WebSockets est que vous avez besoin de beaucoup de ressources c√¥t√© client pour g√©n√©rer une charge suffisamment √©lev√©e pour que ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>12,3 millions de WebSockets simultan√©s</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/460847/"><p>  Une chose √† propos des WebSockets est que vous avez besoin de beaucoup de ressources c√¥t√© client pour g√©n√©rer une charge suffisamment √©lev√©e pour que le serveur consomme r√©ellement toutes les ressources CPU. </p><br><p>  Il y a plusieurs d√©fis √† relever car le protocole WebSockets demande plus de CPU du c√¥t√© client que du c√¥t√© serveur.  En m√™me temps, vous avez besoin de beaucoup de RAM pour stocker des informations sur les connexions ouvertes si vous en avez des millions. </p><br><p>  J'ai eu la chance d'avoir quelques nouveaux serveurs pour une p√©riode de temps limit√©e √† ma disposition pour les tests de "burnout" mat√©riel.  J'ai donc d√©cid√© d'utiliser mon Lua Application Server - <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">LAppS</a> pour faire les deux t√¢ches: tester le mat√©riel et effectuer les tests LAppS √† haute charge. </p><br><p><a name="habracut"></a>  Voyons les d√©tails </p><br><h1 id="challenges">  D√©fis </h1><br><p>  Tout d'abord, les WebSockets c√¥t√© client n√©cessitent un RNG assez rapide pour le masquage du trafic, sauf si vous voulez le truquer.  Je voulais que les tests soient r√©alistes, j'ai donc abandonn√© l'id√©e de truquer le RNG en le rempla√ßant par une constante.  Cela laisse la seule option - beaucoup de puissance CPU.  Comme je l'ai dit, j'ai deux serveurs: un avec deux processeurs Intel Gold 6148 (40 c≈ìurs au total) 256 Go de RAM (DDR4-2666) et un avec quatre processeurs Intel Platinum 8180 (112 c≈ìurs au total) 384 Go de RAM (DDR4-2666) .  Je ferai r√©f√©rence √† eux en tant que serveur A et serveur B ci-apr√®s. </p><br><p>  Le deuxi√®me d√©fi - il n'y a pas de biblioth√®ques ou de suites de tests pour WebSockets qui sont assez rapides.  C'est pourquoi j'ai √©t√© contraint de d√©velopper un module client WebSockets pour LAppS ( <strong>cws</strong> ). </p><br><h1 id="the-tests-setup">  La configuration des tests </h1><br><p>  Les deux serveurs ont des cartes 10 GbE √† double port.  Le port 1 de chaque carte est agr√©g√© √† une interface de liaison et ces ports des deux cartes sont connect√©s les uns aux autres en mode RR.  Le port 2 de chaque carte est agr√©g√© √† une interface de liaison en mode Active-Backup, connect√© via un commutateur Ethernet.  Chaque serveur mat√©riel ex√©cutait RHEL 7.6.  J'ai d√ª installer gcc-8.3 √† partir des sources pour avoir un compilateur moderne au lieu du gcc-4.8.5 par d√©faut.  Ce n'est pas la meilleure configuration pour les tests de performance, mais les mendiants ne peuvent pas √™tre des s√©lecteurs. </p><br><p>  Les processeurs sur le serveur A (2xGold 6148) ont une fr√©quence plus √©lev√©e que sur le serveur B (4xPlatinum 8180).  En m√™me temps, le serveur B a plus de c≈ìurs, j'ai donc d√©cid√© d'ex√©cuter un serveur d'√©cho sur le serveur A et les clients d'√©cho sur le serveur B. </p><br><p>  Je voulais voir comment LAppS se comportait sous une charge √©lev√©e avec des millions de connexions et quelle quantit√© maximale de demandes d'√©cho par seconde il pouvait servir.  Il s'agit en fait de deux ensembles de tests diff√©rents, car avec la croissance du nombre de connexions, le serveur et les clients font un travail de plus en plus complexe. </p><br><p>  Avant cela, j'ai fait tous les tests sur mon PC personnel que j'utilise pour le d√©veloppement.  Les r√©sultats de ces tests seront utilis√©s √† des fins de comparaison.  Mon ordinateur personnel dispose d'un processeur Intel Core i7-7700 √† 3,6 GHz (4,0 GHz Turbo) avec 4 c≈ìurs et 32 ‚Äã‚ÄãGo de RAM DDR4-2400.  Ce PC ex√©cute Gentoo avec le noyau 4.14.72. </p><br><div class="spoiler">  <b class="spoiler_title">Niveaux des correctifs Spectre et Meltdown</b> <div class="spoiler_text"><ul><li>  PC √† la maison <br><pre><code class="plaintext hljs">/sys/devices/system/cpu/vulnerabilities/l1tf:Mitigation: PTE Inversion; VMX: conditional cache flushes, SMT vulnerable /sys/devices/system/cpu/vulnerabilities/meltdown:Mitigation: PTI /sys/devices/system/cpu/vulnerabilities/spec_store_bypass:Mitigation: Speculative Store Bypass disabled via prctl and seccomp /sys/devices/system/cpu/vulnerabilities/spectre_v1:Mitigation: __user pointer sanitization /sys/devices/system/cpu/vulnerabilities/spectre_v2:Vulnerable: Minimal generic ASM retpoline, IBPB, IBRS_FW</code> </pre> </li><li>  Serveurs A et B <br><pre> <code class="plaintext hljs">/sys/kernel/debug/x86/ibpb_enabled : 1 /sys/kernel/debug/x86/pti_enabled : 1 /sys/kernel/debug/x86/ssbd_enabled : 1 /sys/kernel/debug/x86/ibrs_enabled : 1 /sys/kernel/debug/x86/retp_enabled : 3</code> </pre> </li></ul><br><p>  Je ferai une note suppl√©mentaire avec les r√©sultats des tests des serveurs A et B, que ces correctifs soient activ√©s ou non. </p><br><p>  Sur mon Home PC, le niveau des correctifs n'est jamais modifi√©. </p></div></div><br><h2 id="installing-lapps-081">  Installation de LAppS 0.8.1 </h2><br><div class="spoiler">  <b class="spoiler_title">Installation des pr√©requis et des LAppS</b> <div class="spoiler_text"><p>  LAppS d√©pend du luajit-2.0.5 ou sup√©rieur, des biblioth√®ques libcrypto ++ 8.2 et wolfSSL-3.15.7 et ils doivent √™tre install√©s √† partir de sources dans RHEL 7.6 et probablement dans toute autre distribution Linux. </p><br><p>  Le pr√©fixe d'installation est / usr / local.  Voici la partie Dockerfile assez explicite pour l'installation de wolfSSL </p><br><pre> <code class="plaintext hljs">ADD https://github.com/wolfSSL/wolfssl/archive/v3.15.7-stable.tar.gz ${WORKSPACE} RUN tar xzvf v3.15.7-stable.tar.gz WORKDIR ${WORKSPACE}/wolfssl-3.15.7-stable RUN ./autogen.sh RUN ./configure CFLAGS="-pipe -O2 -march=native -mtune=native -fomit-frame-pointer -fstack-check -fstack-protector-strong -mfpmath=sse -msse2avx -mavx2 -ftree-vectorize -funroll-loops -DTFM_TIMING_RESISTANT -DECC_TIMING_RESISTANT -DWC_RSA_BLINDING" --prefix=/usr/local --enable-tls13 --enable-openssh --enable-aesni --enable-intelasm --enable-keygen --enable-certgen --enable-certreq --enable-curve25519 --enable-ed25519 --enable-intelasm --enable-harden RUN make -j40 all RUN make install</code> </pre><br><p>  Et voici la partie pour l'installation de libcrypto ++ </p><br><pre> <code class="plaintext hljs">ADD https://github.com/weidai11/cryptopp/archive/CRYPTOPP_8_2_0.tar.gz ${WORKSPACE} RUN rm -rf ${WORKSPACE}/cryptopp-CRYPTOPP_8_2_0 RUN tar xzvf ${WORKSPACE}/CRYPTOPP_8_2_0.tar.gz WORKDIR ${WORKSPACE}/cryptopp-CRYPTOPP_8_2_0 RUN make CFLAGS="-pipe -O2 -march=native -mtune=native -fPIC -fomit-frame-pointer -fstack-check -fstack-protector-strong -mfpmath=sse -msse2avx -mavx2 -ftree-vectorize -funroll-loops" CXXFLAGS="-pipe -O2 -march=native -mtune=native -fPIC -fomit-frame-pointer -fstack-check -fstack-protector-strong -mfpmath=sse -msse2avx -mavx2 -ftree-vectorize -funroll-loops" -j40 libcryptopp.a libcryptopp.so RUN make install</code> </pre><br><p>  Et le luajit </p><br><pre> <code class="plaintext hljs">ADD http://luajit.org/download/LuaJIT-2.0.5.tar.gz ${WORKSPACE} WORKDIR ${WORKSPACE} RUN tar xzvf LuaJIT-2.0.5.tar.gz WORKDIR ${WORKSPACE}/LuaJIT-2.0.5 RUN env CFLAGS="-pipe -Wall -pthread -O2 -fPIC -march=native -mtune=native -mfpmath=sse -msse2avx -mavx2 -ftree-vectorize -funroll-loops -fstack-check -fstack-protector-strong -fno-omit-frame-pointer" make -j40 all RUN make install</code> </pre> <br><p>  Une d√©pendance facultative de LAppS, qui peut √™tre ignor√©e, est la nouvelle biblioth√®que de Microsoft <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">mimalloc</a> .  Cette biblioth√®que am√©liore consid√©rablement les performances (environ 1%) mais n√©cessite cmake-3.4 ou sup√©rieur.  √âtant donn√© le temps limit√© pour les tests, j'ai d√©cid√© de sacrifier l'am√©lioration des performances mentionn√©e. </p><br><p>  Sur mon PC personnel, je ne d√©sactiverai pas <em>mimalloc</em> pendant les tests. </p><br><p>  Permet d'extraire des LAppS du r√©f√©rentiel: </p><br><pre> <code class="plaintext hljs">WORKDIR ${WORKSPACE} RUN rm -rf ITCLib ITCFramework lar utils LAppS RUN git clone https://github.com/ITpC/ITCLib.git RUN git clone https://github.com/ITpC/utils.git RUN git clone https://github.com/ITpC/ITCFramework.git RUN git clone https://github.com/ITpC/LAppS.git RUN git clone https://github.com/ITpC/lar.git WORKDIR ${WORKSPACE}/LAppS</code> </pre> <br><p>  Maintenant, nous devons supprimer "-lmimalloc" de tous les Makefiles du sous-r√©pertoire <strong>nbproject</strong> , afin que nous puissions construire LAppS (en supposant que notre r√©pertoire actuel est $ {WORKSPACE} / LAppS) </p><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># find ./nbproject -type f -name "*.mk" -exec sed -i.bak -e 's/-lmimalloc//g' {} \; # find ./nbproject -type f -name "*.bak" -exec rm {} \;</span></span></code> </pre> <br><p>  Et maintenant, nous pouvons construire LAppS.  LAppS fournit plusieurs configurations de build, qui peuvent ou non exclure certaines fonctionnalit√©s c√¥t√© serveur: </p><br><ul><li>  avec support SSL et avec support de collecte de statistiques </li><li>  avec SSL et sans collecte de statistiques (bien que la collecte de statistiques minimale se poursuivra car elle est utilis√©e pour l'optimisation dynamique de LAppS lors de l'ex√©cution) </li><li>  sans SSL et sans collecte de statistiques. </li></ul><br><p>  Avant l'√©tape suivante, assurez-vous que vous √™tes le propri√©taire du r√©pertoire / opt / lapps (ou ex√©cutez make installs avec sudo) </p><br><p>  Faisons deux types de binaires avec prise en charge SSL et collecte de statistiques et sans (en supposant que nous soyons dans le r√©pertoire $ {WORKSPACE} / LAppS): </p><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># make clean # make CONF=Release.AVX2 install # make CONF=Release.AVX2.NO_STATS.NO_TLS install</span></span></code> </pre> <br><p>  Les binaires r√©sultants sont: </p><br><ul><li>  dist / Release.AVX2 / GNU-Linux / lapps.avx2 </li><li>  dist / Release.AVX2.NO_STATS.NO_TLS / GNU-Linux / lapps.avx2.nostats.notls </li></ul><br><p>  Ils seront install√©s dans / opt / lapps / bin. </p><br><p>  Veuillez noter que le module client WebSockets pour Lua est toujours construit avec le support SSL.  Qu'il soit activ√© ou non d√©pend de l'URI que vous utilisez pour la connexion (ws: // ou wss: //) lors de l'ex√©cution. </p></div></div><br><h2 id="test-1-top-performance-on-home-pc-configuration-for-baseline">  Test 1. Performances optimales sur PC domestique.  Configuration pour la ligne de base. </h2><br><p>  J'ai d√©j√† √©tabli que j'obtiens les meilleures performances lorsque je configure quatre instances de service de r√©f√©rence avec 100 connexions chacune.  En m√™me temps, je n'ai besoin que de trois IOWorkers et de quatre instances de service d'√©cho pour obtenir les meilleures performances.  Tu te souviens?  Je n'ai que 4 c≈ìurs ici. </p><br><p>  Le but de ce test est simplement d'√©tablir une base de r√©f√©rence pour une comparaison ult√©rieure.  Rien d'excitant ici vraiment. </p><br><p>  Ci-dessous sont les √©tapes requises pour configurer LAppS pour les tests. </p><br><h3 id="self-signed-certificates">  Certificats auto-sign√©s </h3><br><div class="spoiler">  <b class="spoiler_title">script certgen.sh</b> <div class="spoiler_text"><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/bash openssl genrsa -out example.org.key 2048 openssl req -new -key example.org.key -out example.org.csr openssl genrsa -out ca.key 2048 openssl req -new -x509 -key ca.key -out ca.crt openssl x509 -req -in example.org.csr -CA ca.crt -CAkey ca.key -CAcreateserial -out example.org.crt cat example.org.crt ca.crt &gt; example.org.bundle.crt</span></span></code> </pre> </div></div><br><p>  L'ex√©cution de ce script √† partir du r√©pertoire / opt / lapps / conf / ssl cr√©era tous les fichiers requis.  Voici la sortie du script et ce que j'ai tap√©: </p><br><div class="spoiler">  <b class="spoiler_title">sortie certgen.sh</b> <div class="spoiler_text"><pre> <code class="plaintext hljs"># certgen.sh Generating RSA private key, 2048 bit long modulus .................................................................................................................................................................+++++ .....................................+++++ e is 65537 (0x010001) You are about to be asked to enter information that will be incorporated into your certificate request. What you are about to enter is what is called a Distinguished Name or a DN. There are quite a few fields but you can leave some blank For some fields there will be a default value, If you enter '.', the field will be left blank. ----- Country Name (2 letter code) [AU]:KZ State or Province Name (full name) [Some-State]:none Locality Name (eg, city) []:Almaty Organization Name (eg, company) [Internet Widgits Pty Ltd]:NOORG.DO.NOT.FORGET.TO.REMOVE.FROM.BROWSER Organizational Unit Name (eg, section) []: Common Name (eg server FQDN or YOUR name) []: Email Address []: Please enter the following 'extra' attributes to be sent with your certificate request A challenge password []: An optional company name []: Generating RSA private key, 2048 bit long modulus ...+++++ ............................................................................+++++ e is 65537 (0x010001) You are about to be asked to enter information that will be incorporated into your certificate request. What you are about to enter is what is called a Distinguished Name or a DN. There are quite a few fields but you can leave some blank For some fields there will be a default value, If you enter '.', the field will be left blank. ----- Country Name (2 letter code) [AU]:KZ State or Province Name (full name) [Some-State]:none Locality Name (eg, city) []:Almaty Organization Name (eg, company) [Internet Widgits Pty Ltd]:none Organizational Unit Name (eg, section) []: Common Name (eg server FQDN or YOUR name) []:*.example.org Email Address []: Signature ok subject=C = KZ, ST = none, L = Almaty, O = NOORG.DO.NOT.FORGET.TO.REMOVE.FROM.BROWSER Getting CA Private Key</code> </pre> </div></div><br><h3 id="lapps-configuration">  Configuration de LAppS </h3><br><p>  Voici le fichier de configuration WebSockets qui est d√©fini pour TLS 1.3, inclut les certificats g√©n√©r√©s ci-dessus et configur√© avec 3 IOWorkers (voir la description d√©taill√©e des variables dans le wiki LAppS). </p><br><div class="spoiler">  <b class="spoiler_title">/opt/lapps/etc/conf/ws.json</b> <div class="spoiler_text"><pre> <code class="json hljs">{ <span class="hljs-attr"><span class="hljs-attr">"listeners"</span></span> : <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-attr"><span class="hljs-attr">"connection_weight"</span></span>: <span class="hljs-number"><span class="hljs-number">1.0</span></span>, <span class="hljs-attr"><span class="hljs-attr">"ip"</span></span> : <span class="hljs-string"><span class="hljs-string">"0.0.0.0"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"port"</span></span> : <span class="hljs-number"><span class="hljs-number">5083</span></span>, <span class="hljs-attr"><span class="hljs-attr">"lapps_config_auto_save"</span></span> : <span class="hljs-literal"><span class="hljs-literal">true</span></span> , <span class="hljs-attr"><span class="hljs-attr">"workers"</span></span> : { <span class="hljs-attr"><span class="hljs-attr">"workers"</span></span>: <span class="hljs-number"><span class="hljs-number">3</span></span>, <span class="hljs-attr"><span class="hljs-attr">"max_connections"</span></span> : <span class="hljs-number"><span class="hljs-number">40000</span></span>, <span class="hljs-attr"><span class="hljs-attr">"auto_fragment"</span></span> : <span class="hljs-literal"><span class="hljs-literal">false</span></span>, <span class="hljs-attr"><span class="hljs-attr">"max_poll_events"</span></span> : <span class="hljs-number"><span class="hljs-number">256</span></span>, <span class="hljs-attr"><span class="hljs-attr">"max_poll_wait_ms"</span></span> : <span class="hljs-number"><span class="hljs-number">10</span></span>, <span class="hljs-attr"><span class="hljs-attr">"max_inbounds_skip"</span></span> : <span class="hljs-number"><span class="hljs-number">50</span></span>, <span class="hljs-attr"><span class="hljs-attr">"input_buffer_size"</span></span> : <span class="hljs-number"><span class="hljs-number">2048</span></span> }, <span class="hljs-attr"><span class="hljs-attr">"acl"</span></span> : { <span class="hljs-attr"><span class="hljs-attr">"policy"</span></span> : <span class="hljs-string"><span class="hljs-string">"allow"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"exclude"</span></span> : [] }, <span class="hljs-attr"><span class="hljs-attr">"tls"</span></span>:<span class="hljs-literal"><span class="hljs-literal">true</span></span>, <span class="hljs-attr"><span class="hljs-attr">"tls_server_version"</span></span> : <span class="hljs-number"><span class="hljs-number">4</span></span>, <span class="hljs-attr"><span class="hljs-attr">"tls_client_version"</span></span> : <span class="hljs-number"><span class="hljs-number">4</span></span>, <span class="hljs-attr"><span class="hljs-attr">"tls_certificates"</span></span>:{ <span class="hljs-attr"><span class="hljs-attr">"ca"</span></span>:<span class="hljs-string"><span class="hljs-string">"/opt/lapps/conf/ssl/ca.crt"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"cert"</span></span>: <span class="hljs-string"><span class="hljs-string">"/opt/lapps/conf/ssl/example.org.bundle.crt"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"key"</span></span>: <span class="hljs-string"><span class="hljs-string">"/opt/lapps/conf/ssl/example.org.key"</span></span> } }</code> </pre> </div></div><br><p>  Configuration des services: le serveur d'√©cho et le client d'√©cho (benchmark), chacun avec quatre instances. </p><br><div class="spoiler">  <b class="spoiler_title">/opt/lapps/etc/conf/lapps.json</b> <div class="spoiler_text"><pre> <code class="json hljs">{ <span class="hljs-attr"><span class="hljs-attr">"directories"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"app_conf_dir"</span></span>: <span class="hljs-string"><span class="hljs-string">"etc"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"applications"</span></span>: <span class="hljs-string"><span class="hljs-string">"apps"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"deploy"</span></span>: <span class="hljs-string"><span class="hljs-string">"deploy"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"tmp"</span></span>: <span class="hljs-string"><span class="hljs-string">"tmp"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"workdir"</span></span>: <span class="hljs-string"><span class="hljs-string">"workdir"</span></span> }, <span class="hljs-attr"><span class="hljs-attr">"services"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"echo"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"auto_start"</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>, <span class="hljs-attr"><span class="hljs-attr">"instances"</span></span>: <span class="hljs-number"><span class="hljs-number">4</span></span>, <span class="hljs-attr"><span class="hljs-attr">"internal"</span></span>: <span class="hljs-literal"><span class="hljs-literal">false</span></span>, <span class="hljs-attr"><span class="hljs-attr">"max_inbound_message_size"</span></span>: <span class="hljs-number"><span class="hljs-number">16777216</span></span>, <span class="hljs-attr"><span class="hljs-attr">"protocol"</span></span>: <span class="hljs-string"><span class="hljs-string">"raw"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"request_target"</span></span>: <span class="hljs-string"><span class="hljs-string">"/echo"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"acl"</span></span> : { <span class="hljs-attr"><span class="hljs-attr">"policy"</span></span> : <span class="hljs-string"><span class="hljs-string">"allow"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"exclude"</span></span> : [] } }, <span class="hljs-attr"><span class="hljs-attr">"benchmark"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"auto_start"</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>, <span class="hljs-attr"><span class="hljs-attr">"instances"</span></span> : <span class="hljs-number"><span class="hljs-number">4</span></span>, <span class="hljs-attr"><span class="hljs-attr">"internal"</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>, <span class="hljs-attr"><span class="hljs-attr">"preload"</span></span>: [ <span class="hljs-string"><span class="hljs-string">"nap"</span></span>, <span class="hljs-string"><span class="hljs-string">"cws"</span></span>, <span class="hljs-string"><span class="hljs-string">"time"</span></span> ], <span class="hljs-attr"><span class="hljs-attr">"depends"</span></span> : [ <span class="hljs-string"><span class="hljs-string">"echo"</span></span> ] } } }</code> </pre> </div></div><br><p>  Le service d'√©cho est assez banal: </p><br><div class="spoiler">  <b class="spoiler_title">code source du service d'√©cho</b> <div class="spoiler_text"><pre> <code class="lua hljs">echo = {} echo.<span class="hljs-built_in"><span class="hljs-built_in">__index</span></span> = echo; echo.onStart=<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> <span class="hljs-built_in"><span class="hljs-built_in">print</span></span>(<span class="hljs-string"><span class="hljs-string">"echo::onStart"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> echo.onDisconnect=<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> echo.onShutdown=<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> <span class="hljs-built_in"><span class="hljs-built_in">print</span></span>(<span class="hljs-string"><span class="hljs-string">"echo::onShutdown()"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> echo.onMessage=<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(handler,opcode, message)</span></span></span></span> <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> result, errmsg=ws:send(handler,opcode,message); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">not</span></span> result) <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-built_in"><span class="hljs-built_in">print</span></span>(<span class="hljs-string"><span class="hljs-string">"echo::OnMessage(): "</span></span>..errmsg); <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> result; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> echo</code> </pre> </div></div><br><p>  Le service de benchmark cr√©e autant de <strong>benchmark.max_connections</strong> vers <strong>benchmark.target</strong> , puis s'ex√©cute jusqu'√† ce que vous arr√™tiez le LAppS.  Il n'y a pas de pause dans l'√©tablissement des connexions ou d'√©cho de bombardements.  L'API du module <strong>cws</strong> ressemble √† l'API Web pour WebSockets.  Une fois que tous les <strong>benchmark.max_connections</strong> sont √©tablis, le benchmark imprime la quantit√© de Sockets connect√©s.  Une fois la connexion √©tablie, le benchmark envoie un <strong>benchmark.message</strong> au serveur.  Une fois que le serveur a r√©pondu, la m√©thode <strong>onmessage</strong> anonyme de l'objet <strong>cws</strong> est invoqu√©e, qui renvoie simplement le m√™me message au serveur. </p><br><div class="spoiler">  <b class="spoiler_title">code source du service de r√©f√©rence</b> <div class="spoiler_text"><pre> <code class="lua hljs">benchmark={} benchmark.<span class="hljs-built_in"><span class="hljs-built_in">__index</span></span>=benchmark benchmark.init=<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> benchmark.messages_counter=<span class="hljs-number"><span class="hljs-number">0</span></span>; benchmark.start_time=<span class="hljs-built_in"><span class="hljs-built_in">time</span></span>.now(); benchmark.max_connections=<span class="hljs-number"><span class="hljs-number">100</span></span>; benchmark.target=<span class="hljs-string"><span class="hljs-string">"wss://127.0.0.1:5083/echo"</span></span>; benchmark.message=<span class="hljs-string"><span class="hljs-string">"XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX"</span></span>; benchmark.meter=<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> benchmark.messages_counter=benchmark.messages_counter+<span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> slice=<span class="hljs-built_in"><span class="hljs-built_in">time</span></span>.now() - benchmark.start_time; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>( slice &gt;= <span class="hljs-number"><span class="hljs-number">1000</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-built_in"><span class="hljs-built_in">print</span></span>(benchmark.messages_counter..<span class="hljs-string"><span class="hljs-string">" messages received per "</span></span>..slice..<span class="hljs-string"><span class="hljs-string">"ms"</span></span>) benchmark.messages_counter=<span class="hljs-number"><span class="hljs-number">0</span></span>; benchmark.start_time=<span class="hljs-built_in"><span class="hljs-built_in">time</span></span>.now(); <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> benchmark.run=<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> n=nap:new(); <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> counter=<span class="hljs-number"><span class="hljs-number">1</span></span>; n:sleep(<span class="hljs-number"><span class="hljs-number">1</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> array={}; <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> start=<span class="hljs-built_in"><span class="hljs-built_in">time</span></span>.now(); <span class="hljs-keyword"><span class="hljs-keyword">while</span></span>(#array &lt; benchmark.max_connections) <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">not</span></span> must_stop()) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> sock, err_msg=cws:new(benchmark.target, { onopen=<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(handler)</span></span></span></span> <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> result, errstr=cws:send(handler,benchmark.message,<span class="hljs-number"><span class="hljs-number">2</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">not</span></span> result) <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-built_in"><span class="hljs-built_in">print</span></span>(<span class="hljs-string"><span class="hljs-string">"Error on websocket send at handler "</span></span>..handler..<span class="hljs-string"><span class="hljs-string">": "</span></span>..errstr); <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>, onmessage=<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(handler,message,opcode)</span></span></span></span> benchmark.meter(); cws:send(handler,message,opcode); <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>, onerror=<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(handler, message)</span></span></span></span> <span class="hljs-built_in"><span class="hljs-built_in">print</span></span>(<span class="hljs-string"><span class="hljs-string">"Client WebSocket connection is failed for socketfd "</span></span>..handler..<span class="hljs-string"><span class="hljs-string">". Error: "</span></span>..message); <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>, onclose=<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(handler)</span></span></span></span> <span class="hljs-built_in"><span class="hljs-built_in">print</span></span>(<span class="hljs-string"><span class="hljs-string">"Connection is closed for socketfd "</span></span>..handler); <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> }); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(sock ~= <span class="hljs-literal"><span class="hljs-literal">nil</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-built_in"><span class="hljs-built_in">table</span></span>.<span class="hljs-built_in"><span class="hljs-built_in">insert</span></span>(array,sock); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-built_in"><span class="hljs-built_in">print</span></span>(err_msg); err_msg=<span class="hljs-literal"><span class="hljs-literal">nil</span></span>; <span class="hljs-built_in"><span class="hljs-built_in">collectgarbage</span></span>(<span class="hljs-string"><span class="hljs-string">"collect"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-comment"><span class="hljs-comment">-- poll events once per 10 outgoing connections -- this will improve the connection establishment speed if counter == 10 then cws:eventLoop(); counter=1 else counter = counter + 1; end end print("Sockets connected: "..#array); benchmark.start_time=time.now(); while not must_stop() do cws:eventLoop(); end for i=1,#array do array[i]:close(); cws:eventLoop(); end end return benchmark;</span></span></code> </pre> </div></div><br><h3 id="services-installation">  Installation des services </h3><br><p>  Maintenant, nous devons placer les scripts de service dans /opt/lapps/apps//.lua: <br></p><ul><li>  /opt/lapps/apps/benchmark/benchmark.lua </li><li>  /opt/lapps/apps/echo/echo.lua </li></ul><br><p>  Nous sommes pr√™ts √† ex√©cuter notre r√©f√©rence maintenant.  Ex√©cutez simplement: <code>rm -f lapps.log; /opt/lapps/bin/lapps.avx2 &gt; log</code>  <code>rm -f lapps.log; /opt/lapps/bin/lapps.avx2 &gt; log</code> partir du r√©pertoire LAppS et attendez 5 minutes, puis appuyez une fois sur Ctrl-C, pour arr√™ter le LAppS (il ne s'arr√™tera pas imm√©diatement, il fermera d'abord les connexions), ou deux fois (cela interrompra la s√©quence d'arr√™t). </p><br><p>  Ok, nous avons un fichier texte avec quelque chose comme √ßa √† l'int√©rieur: </p><br><div class="spoiler">  <b class="spoiler_title">sortie de r√©f√©rence</b> <div class="spoiler_text"><p>  echo :: onStart <br>  echo :: onStart <br>  echo :: onStart <br>  echo :: onStart <br>  courir <br>  1 messages re√ßus par 3196ms <br>  1 messages re√ßus par 3299ms <br>  1 messages re√ßus par 3299ms <br>  1 messages re√ßus par 3305ms <br>  Prises connect√©es: 100 <br>  Prises connect√©es: 100 <br>  Prises connect√©es: 100 <br>  Prises connect√©es: 100 <br>  134597 messages re√ßus par 1000 ms <br>  139774 messages re√ßus par 1000 ms <br>  138521 messages re√ßus par 1000 ms <br>  139404 messages re√ßus par 1000 ms <br>  140162 messages re√ßus par 1000 ms <br>  139337 messages re√ßus par 1000 ms <br>  140088 messages re√ßus par 1000 ms <br>  139946 messages re√ßus par 1000 ms <br>  141204 messages re√ßus par 1000 ms <br>  137988 messages re√ßus par 1000 ms <br>  141805 messages re√ßus par 1000 ms <br>  134733 messages re√ßus par 1000 ms <br>  ... </p></div></div><br><p>  Nettoyons ce fichier journal comme ceci: </p><br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> -e <span class="hljs-string"><span class="hljs-string">':%s/ms/^V^M/g\n:%g/^$/d\nGdd1G4/Sockets\n4\ndggZZ'</span></span> | vi <span class="hljs-variable"><span class="hljs-variable">$i</span></span></code> </pre> <br><p>  '^ V ^ M' est une repr√©sentation visible des touches cl√©s suivantes: Ctrl-V Ctrl-V Ctrl-V Ctrl-M, il sera donc assez inutile de copier-coller simplement cette ligne bash.  Br√®ve explication: </p><br><ul><li>  nous devons remplacer les symboles 'ms' par une fin de ligne, car nous n'en avons pas besoin, ils g√¢cheront les calculs plus tard et 4 benchmarks travaillant en parall√®le peuvent imprimer leurs r√©sultats sur une seule ligne. </li><li>  nous devons ensuite supprimer toutes les lignes vides </li><li>  nous supprimons √©galement la derni√®re ligne, car nous arr√™tons le serveur </li><li>  dans le fichier <strong>journal</strong> , il n'y aura que des lignes avant constitu√©es de <em>Sockets connect√©s: 100</em> (c'est parce que nous n'ex√©cutons que quatre services de r√©f√©rence).  Nous sautons donc 4 lignes au-del√† de la derni√®re, et nous supprimons tout en haut du fichier. </li><li>  enregistrer le fichier. </li></ul><br><p>  Le fichier est enregistr√© et vous √™tes de retour dans le shell maintenant, et le fichier journal est pr√™t pour l'√©tape suivante: </p><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># awk -v avg=0 '{rps=($1/$5);avg+=rps;}END{print ((avg*1000)/NR)*4}' log</span></span></code> </pre> <br><p>  Ce awk single-liner calcule la quantit√© de r√©ponses d'√©cho par ms et accumule le r√©sultat en variable <em>moyenne</em> .  Une fois toutes les lignes du fichier journal trait√©es, il multiplie la <em>moyenne</em> √† 1000 pour obtenir le nombre total de r√©ponses d'√©cho par seconde, en divisant le nombre de lignes et en multipliant le nombre de services de r√©f√©rence.  Cela nous donne le nombre moyen de r√©ponses d'√©cho par seconde pour ce test. </p><br><p>  Sur mon PC, ce nombre (ERps) est: <strong>563854</strong> </p><br><p>  Faisons de m√™me sans support SSL et voyons la diff√©rence: </p><br><ul><li>  changer la valeur de la variable <strong>tls</strong> dans ws.json en false </li><li>  changez <strong>benchmark.target</strong> dans benchmark.lua de wss: // en ws: // </li><li>  ex√©cutez <code>rm -f lapps.log; /opt/lapps/bin/lapps.avx2.nostats.notls &gt; log</code>  <code>rm -f lapps.log; /opt/lapps/bin/lapps.avx2.nostats.notls &gt; log</code> partir du r√©pertoire LAppS et r√©p√©tez les √©tapes ci-dessus. </li></ul><br><p>  J'ai: <strong>721236</strong> r√©ponses par seconde </p><br><p>  La diff√©rence de performances avec SSL et sans SSL est d'environ 22%.  Gardons ces chiffres √† l'esprit pour r√©f√©rence future. </p><br><p>  Avec la m√™me configuration sur le serveur A, j'ai: <strong>421905</strong> ERpS avec SSL et <strong>443145</strong> ERpS sans SSL.  Les correctifs pour Spectre et Meltdown ont √©t√© d√©sactiv√©s. <br>  Sur le serveur B, j'ai <strong>270996</strong> ERpS avec SSL et <strong>318522</strong> ERpS sans SSL avec les correctifs activ√©s.  <strong>385726</strong> et <strong>372126</strong> sans et avec SSL.  Les correctifs pour Spectre et Meltdown ont √©galement √©t√© d√©sactiv√©s. </p><br><p>  Les r√©sultats sont pires avec la m√™me configuration car les processeurs de ces serveurs ont une fr√©quence moindre. </p><br><p>  Veuillez noter que les clients d√©pendent beaucoup de la disponibilit√© des donn√©es dans / dev / urandom.  Cela peut prendre un certain temps avant que les clients ne d√©marrent r√©ellement, si vous l'avez d√©j√† ex√©cut√© une fois.  Attendez donc qu'ils commencent √† travailler, puis ils sont assez rapides dans ce qu'ils font.  Surveillez simplement avec <em>top</em> si les instances de LAppS font vraiment du travail.  Si / dev / urandom est √©puis√©, le LAppS ne d√©vorera pas vos CPU tant qu'il n'y aura pas de donn√©es disponibles. </p><br><h1 id="preparing-for-big-tests">  Se pr√©parer √† de gros tests </h1><br><p>  Tout d'abord, nous devons apporter des modifications aux param√®tres du noyau et ne pas oublier l'ulimit pour le nombre de fichiers ouverts.  J'ai utilis√© presque la m√™me configuration que dans cet <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">article</a> . </p><br><p>  Cr√©ez un fichier avec le contenu suivant </p><br><pre> <code class="bash hljs">: sysctl -w fs.file-max=14000000 sysctl -w fs.nr_open=14000000 <span class="hljs-built_in"><span class="hljs-built_in">ulimit</span></span> -n 14000000 sysctl -w net.ipv4.tcp_mem=<span class="hljs-string"><span class="hljs-string">"100000000 100000000 100000000"</span></span> sysctl -w net.core.somaxconn=20000 sysctl -w net.ipv4.tcp_max_syn_backlog=20000 sysctl -w net.ipv4.ip_local_port_range=<span class="hljs-string"><span class="hljs-string">"1025 65535"</span></span></code> </pre> <br><p>  Ensuite, utilisez <em>source ./filename</em> sur les deux serveurs pour modifier les param√®tres du noyau et ulimit. </p><br><p>  Cette fois, mon but est de cr√©er plusieurs millions de clients sur un serveur et de les connecter au second. </p><br><p>  Le serveur A servira de serveur de service d'√©cho WebSockets c√¥t√© serveur. <br>  Le serveur B servira de c√¥t√© client du service d'√©cho WebSockets. </p><br><p>  Il y a une limitation dans LAppS impos√©e par LuaJIT.  Vous ne pouvez utiliser que 2 Go de RAM par machine virtuelle LuaJIT.  C'est la limite de RAM que vous pouvez utiliser dans une seule instance LAppS pour tous les services, car les services sont les threads li√©s √† une instance libluajit.  Si l'un de vos services qui s'ex√©cute sous la seule instance LAppS d√©passe cette limite, alors tous les services seront √† court de m√©moire. </p><br><p>  J'ai d√©couvert que par instance LAppS unique, vous ne pouvez pas √©tablir plus de 2 464 000 WebSockets client avec une taille de message de 64 octets.  La taille du message peut l√©g√®rement modifier cette limite, car LAppS transmet le message au service <em>cws</em> en allouant l'espace pour ce message dans le LuaJIT. </p><br><p>  Cela implique que je dois d√©marrer plusieurs instances LAppS avec la m√™me configuration sur le serveur B pour √©tablir plus de 2,4 millions de WebSockets.  Le serveur A (le serveur d'√©cho) n'utilise pas autant de m√©moire c√¥t√© LuaJIT, donc la seule instance du LAppS prendra en charge 12,3 millions de WebSockets sans aucun probl√®me. </p><br><p>  Pr√©parons deux configurations diff√©rentes pour les serveurs A et B. </p><br><div class="spoiler">  <b class="spoiler_title">Serveur A ws.json</b> <div class="spoiler_text"><pre> <code class="json hljs">{ <span class="hljs-attr"><span class="hljs-attr">"listeners"</span></span> : <span class="hljs-number"><span class="hljs-number">224</span></span>, <span class="hljs-attr"><span class="hljs-attr">"connection_weight"</span></span>: <span class="hljs-number"><span class="hljs-number">1.0</span></span>, <span class="hljs-attr"><span class="hljs-attr">"ip"</span></span> : <span class="hljs-string"><span class="hljs-string">"0.0.0.0"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"port"</span></span> : <span class="hljs-number"><span class="hljs-number">5084</span></span>, <span class="hljs-attr"><span class="hljs-attr">"lapps_config_auto_save"</span></span> : <span class="hljs-literal"><span class="hljs-literal">true</span></span> , <span class="hljs-attr"><span class="hljs-attr">"workers"</span></span> : { <span class="hljs-attr"><span class="hljs-attr">"workers"</span></span>: <span class="hljs-number"><span class="hljs-number">40</span></span>, <span class="hljs-attr"><span class="hljs-attr">"max_connections"</span></span> : <span class="hljs-number"><span class="hljs-number">2000000</span></span>, <span class="hljs-attr"><span class="hljs-attr">"auto_fragment"</span></span> : <span class="hljs-literal"><span class="hljs-literal">false</span></span>, <span class="hljs-attr"><span class="hljs-attr">"max_poll_events"</span></span> : <span class="hljs-number"><span class="hljs-number">256</span></span>, <span class="hljs-attr"><span class="hljs-attr">"max_poll_wait_ms"</span></span> : <span class="hljs-number"><span class="hljs-number">10</span></span>, <span class="hljs-attr"><span class="hljs-attr">"max_inbounds_skip"</span></span> : <span class="hljs-number"><span class="hljs-number">50</span></span>, <span class="hljs-attr"><span class="hljs-attr">"input_buffer_size"</span></span> : <span class="hljs-number"><span class="hljs-number">2048</span></span> }, <span class="hljs-attr"><span class="hljs-attr">"acl"</span></span> : { <span class="hljs-attr"><span class="hljs-attr">"policy"</span></span> : <span class="hljs-string"><span class="hljs-string">"allow"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"exclude"</span></span> : [] }, <span class="hljs-attr"><span class="hljs-attr">"tls"</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>, <span class="hljs-attr"><span class="hljs-attr">"tls_server_version"</span></span> : <span class="hljs-number"><span class="hljs-number">4</span></span>, <span class="hljs-attr"><span class="hljs-attr">"tls_client_version"</span></span> : <span class="hljs-number"><span class="hljs-number">4</span></span>, <span class="hljs-attr"><span class="hljs-attr">"tls_certificates"</span></span>:{ <span class="hljs-attr"><span class="hljs-attr">"ca"</span></span>:<span class="hljs-string"><span class="hljs-string">"/opt/lapps/conf/ssl/ca.crt"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"cert"</span></span>: <span class="hljs-string"><span class="hljs-string">"/opt/lapps/conf/ssl/example.org.bundle.crt"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"key"</span></span>: <span class="hljs-string"><span class="hljs-string">"/opt/lapps/conf/ssl/example.org.key"</span></span> } }</code> </pre> </div></div><br><div class="spoiler">  <b class="spoiler_title">Serveur A lapps.json</b> <div class="spoiler_text"><pre> <code class="json hljs">{ <span class="hljs-attr"><span class="hljs-attr">"directories"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"app_conf_dir"</span></span>: <span class="hljs-string"><span class="hljs-string">"etc"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"applications"</span></span>: <span class="hljs-string"><span class="hljs-string">"apps"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"deploy"</span></span>: <span class="hljs-string"><span class="hljs-string">"deploy"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"tmp"</span></span>: <span class="hljs-string"><span class="hljs-string">"tmp"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"workdir"</span></span>: <span class="hljs-string"><span class="hljs-string">"workdir"</span></span> }, <span class="hljs-attr"><span class="hljs-attr">"services"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"echo"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"auto_start"</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>, <span class="hljs-attr"><span class="hljs-attr">"instances"</span></span>: <span class="hljs-number"><span class="hljs-number">40</span></span>, <span class="hljs-attr"><span class="hljs-attr">"internal"</span></span>: <span class="hljs-literal"><span class="hljs-literal">false</span></span>, <span class="hljs-attr"><span class="hljs-attr">"max_inbound_message_size"</span></span>: <span class="hljs-number"><span class="hljs-number">16777216</span></span>, <span class="hljs-attr"><span class="hljs-attr">"protocol"</span></span>: <span class="hljs-string"><span class="hljs-string">"raw"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"request_target"</span></span>: <span class="hljs-string"><span class="hljs-string">"/echo"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"acl"</span></span> : { <span class="hljs-attr"><span class="hljs-attr">"policy"</span></span> : <span class="hljs-string"><span class="hljs-string">"allow"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"exclude"</span></span> : [] } } } }</code> </pre> </div></div><br><div class="spoiler">  <b class="spoiler_title">Serveur B ws.json</b> <div class="spoiler_text"><pre> <code class="json hljs">{ <span class="hljs-attr"><span class="hljs-attr">"listeners"</span></span> : <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-attr"><span class="hljs-attr">"connection_weight"</span></span>: <span class="hljs-number"><span class="hljs-number">1.0</span></span>, <span class="hljs-attr"><span class="hljs-attr">"ip"</span></span> : <span class="hljs-string"><span class="hljs-string">"0.0.0.0"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"port"</span></span> : <span class="hljs-number"><span class="hljs-number">5083</span></span>, <span class="hljs-attr"><span class="hljs-attr">"lapps_config_auto_save"</span></span> : <span class="hljs-literal"><span class="hljs-literal">true</span></span> , <span class="hljs-attr"><span class="hljs-attr">"workers"</span></span> : { <span class="hljs-attr"><span class="hljs-attr">"workers"</span></span>: <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-attr"><span class="hljs-attr">"max_connections"</span></span> : <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-attr"><span class="hljs-attr">"auto_fragment"</span></span> : <span class="hljs-literal"><span class="hljs-literal">false</span></span>, <span class="hljs-attr"><span class="hljs-attr">"max_poll_events"</span></span> : <span class="hljs-number"><span class="hljs-number">2048</span></span>, <span class="hljs-attr"><span class="hljs-attr">"max_poll_wait_ms"</span></span> : <span class="hljs-number"><span class="hljs-number">10</span></span>, <span class="hljs-attr"><span class="hljs-attr">"max_inbounds_skip"</span></span> : <span class="hljs-number"><span class="hljs-number">50</span></span>, <span class="hljs-attr"><span class="hljs-attr">"input_buffer_size"</span></span> : <span class="hljs-number"><span class="hljs-number">2048</span></span> }, <span class="hljs-attr"><span class="hljs-attr">"acl"</span></span> : { <span class="hljs-attr"><span class="hljs-attr">"policy"</span></span> : <span class="hljs-string"><span class="hljs-string">"deny"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"exclude"</span></span> : [] }, <span class="hljs-attr"><span class="hljs-attr">"tls"</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>, <span class="hljs-attr"><span class="hljs-attr">"tls_server_version"</span></span> : <span class="hljs-number"><span class="hljs-number">4</span></span>, <span class="hljs-attr"><span class="hljs-attr">"tls_client_version"</span></span> : <span class="hljs-number"><span class="hljs-number">4</span></span>, <span class="hljs-attr"><span class="hljs-attr">"tls_certificates"</span></span>:{ <span class="hljs-attr"><span class="hljs-attr">"ca"</span></span>:<span class="hljs-string"><span class="hljs-string">"/opt/lapps/conf/ssl/ca.crt"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"cert"</span></span>: <span class="hljs-string"><span class="hljs-string">"/opt/lapps/conf/ssl/example.org.bundle.crt"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"key"</span></span>: <span class="hljs-string"><span class="hljs-string">"/opt/lapps/conf/ssl/example.org.key"</span></span> } }</code> </pre> </div></div><br><p>  Le serveur A a deux interfaces: </p><br><ul><li>  bond0 - xx203.37 </li><li>  bond1 - xx23.10 </li></ul><br><p>  L'un est plus rapide, l'autre est plus lent, mais cela n'a pas vraiment d'importance.  Le serveur sera de toute fa√ßon sous forte charge. </p><br><p>  Permet de pr√©parer un mod√®le √† partir de notre /opt/lapps/benchmark/benchmark.lua </p><br><div class="spoiler">  <b class="spoiler_title">benchmark.lua</b> <div class="spoiler_text"><pre> <code class="lua hljs">benchmark={} benchmark.<span class="hljs-built_in"><span class="hljs-built_in">__index</span></span>=benchmark benchmark.init=<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> benchmark.messages_counter=<span class="hljs-number"><span class="hljs-number">0</span></span>; benchmark.start_time=<span class="hljs-built_in"><span class="hljs-built_in">time</span></span>.now(); benchmark.max_connections=<span class="hljs-number"><span class="hljs-number">10000</span></span>; benchmark.target_port=<span class="hljs-number"><span class="hljs-number">0</span></span>; benchmark.target_prefix=<span class="hljs-string"><span class="hljs-string">"wss://IPADDR:"</span></span>; benchmark.target_postfix=<span class="hljs-string"><span class="hljs-string">"/echo"</span></span>; benchmark.message=<span class="hljs-string"><span class="hljs-string">"XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX"</span></span>; benchmark.meter=<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> benchmark.messages_counter=benchmark.messages_counter+<span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> slice=<span class="hljs-built_in"><span class="hljs-built_in">time</span></span>.now() - benchmark.start_time; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>( slice &gt;= <span class="hljs-number"><span class="hljs-number">1000</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-built_in"><span class="hljs-built_in">print</span></span>(benchmark.messages_counter..<span class="hljs-string"><span class="hljs-string">" messages received per "</span></span>..slice..<span class="hljs-string"><span class="hljs-string">"ms"</span></span>) benchmark.messages_counter=<span class="hljs-number"><span class="hljs-number">0</span></span>; benchmark.start_time=<span class="hljs-built_in"><span class="hljs-built_in">time</span></span>.now(); <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> benchmark.run=<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> n=nap:new(); <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> counter=<span class="hljs-number"><span class="hljs-number">1</span></span>; n:sleep(<span class="hljs-number"><span class="hljs-number">1</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> array={}; <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> start=<span class="hljs-built_in"><span class="hljs-built_in">time</span></span>.now(); <span class="hljs-keyword"><span class="hljs-keyword">while</span></span>(#array &lt; benchmark.max_connections) <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">not</span></span> must_stop()) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> benchmark.target_port=<span class="hljs-built_in"><span class="hljs-built_in">math</span></span>.<span class="hljs-built_in"><span class="hljs-built_in">random</span></span>(<span class="hljs-number"><span class="hljs-number">5084</span></span>,<span class="hljs-number"><span class="hljs-number">5307</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> sock, err_msg=cws:new(benchmark.target_prefix..benchmark.target_port..benchmark.target_postfix, { onopen=<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(handler)</span></span></span></span> <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> result, errstr=cws:send(handler,benchmark.message,<span class="hljs-number"><span class="hljs-number">2</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">not</span></span> result) <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-built_in"><span class="hljs-built_in">print</span></span>(<span class="hljs-string"><span class="hljs-string">"Error on websocket send at handler "</span></span>..handler..<span class="hljs-string"><span class="hljs-string">": "</span></span>..errstr); <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>, onmessage=<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(handler,message,opcode)</span></span></span></span> benchmark.meter(); cws:send(handler,message,opcode); <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>, onerror=<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(handler, message)</span></span></span></span> <span class="hljs-built_in"><span class="hljs-built_in">print</span></span>(<span class="hljs-string"><span class="hljs-string">"Client WebSocket connection is failed for socketfd "</span></span>..handler..<span class="hljs-string"><span class="hljs-string">". Error: "</span></span>..message); <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>, onclose=<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(handler)</span></span></span></span> <span class="hljs-built_in"><span class="hljs-built_in">print</span></span>(<span class="hljs-string"><span class="hljs-string">"Connection is closed for socketfd "</span></span>..handler); <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> }); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(sock ~= <span class="hljs-literal"><span class="hljs-literal">nil</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-built_in"><span class="hljs-built_in">table</span></span>.<span class="hljs-built_in"><span class="hljs-built_in">insert</span></span>(array,sock); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-built_in"><span class="hljs-built_in">print</span></span>(err_msg); err_msg=<span class="hljs-literal"><span class="hljs-literal">nil</span></span>; <span class="hljs-built_in"><span class="hljs-built_in">collectgarbage</span></span>(<span class="hljs-string"><span class="hljs-string">"collect"</span></span>); <span class="hljs-comment"><span class="hljs-comment">-- force garbage collection on connection failure. end -- poll events once per 10 outgoing connections -- this will improve the connection establishment speed if counter == 10 then cws:eventLoop(); counter=1 else counter = counter + 1; end end print("Sockets connected: "..#array); benchmark.start_time=time.now(); while not must_stop() do cws:eventLoop(); end for i=1,#array do array[i]:close(); cws:eventLoop(); end end return benchmark;</span></span></code> </pre> </div></div><br><p>  Stockons les adresses IP du serveur A dans les fichiers IP1 et IP2 respectivement, puis: </p><br><pre> <code class="bash hljs"><span class="hljs-keyword"><span class="hljs-keyword">for</span></span> i <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> 1 2 <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> mkdir -p /opt/lapps/apps/benchmark<span class="hljs-variable"><span class="hljs-variable">${i}</span></span> sed -e <span class="hljs-string"><span class="hljs-string">"s/IPADDR/</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$(cat IP1)</span></span></span><span class="hljs-string">/g"</span></span> /opt/lapps/apps/benchmark/benchmark.lua &gt; /opt/lapps/apps/benchmark<span class="hljs-variable"><span class="hljs-variable">${i}</span></span>/benchmark<span class="hljs-variable"><span class="hljs-variable">${i}</span></span>.lua <span class="hljs-keyword"><span class="hljs-keyword">done</span></span></code> </pre> <br><p>  Maintenant, nous modifions /opt/lapps/etc/conf/lapps.json sur le serveur B pour utiliser ces deux services de r√©f√©rence: </p><br><div class="spoiler">  <b class="spoiler_title">Serveur B lapps.json</b> <div class="spoiler_text"><pre> <code class="json hljs">{ <span class="hljs-attr"><span class="hljs-attr">"directories"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"app_conf_dir"</span></span>: <span class="hljs-string"><span class="hljs-string">"etc"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"applications"</span></span>: <span class="hljs-string"><span class="hljs-string">"apps"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"deploy"</span></span>: <span class="hljs-string"><span class="hljs-string">"deploy"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"tmp"</span></span>: <span class="hljs-string"><span class="hljs-string">"tmp"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"workdir"</span></span>: <span class="hljs-string"><span class="hljs-string">"workdir"</span></span> }, <span class="hljs-attr"><span class="hljs-attr">"services"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"benchmark1"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"auto_start"</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>, <span class="hljs-attr"><span class="hljs-attr">"instances"</span></span> : <span class="hljs-number"><span class="hljs-number">112</span></span>, <span class="hljs-attr"><span class="hljs-attr">"internal"</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>, <span class="hljs-attr"><span class="hljs-attr">"preload"</span></span>: [ <span class="hljs-string"><span class="hljs-string">"nap"</span></span>, <span class="hljs-string"><span class="hljs-string">"cws"</span></span>, <span class="hljs-string"><span class="hljs-string">"time"</span></span> ] }, <span class="hljs-attr"><span class="hljs-attr">"benchmark2"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"auto_start"</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>, <span class="hljs-attr"><span class="hljs-attr">"instances"</span></span> : <span class="hljs-number"><span class="hljs-number">112</span></span>, <span class="hljs-attr"><span class="hljs-attr">"internal"</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>, <span class="hljs-attr"><span class="hljs-attr">"preload"</span></span>: [ <span class="hljs-string"><span class="hljs-string">"nap"</span></span>, <span class="hljs-string"><span class="hljs-string">"cws"</span></span>, <span class="hljs-string"><span class="hljs-string">"time"</span></span> ] } } }</code> </pre> </div></div><br><p>  Sommes-nous pr√™ts?  Non, nous ne le sommes pas.  Parce que nous avons l'intention de g√©n√©rer 2 240 000 sockets sortants vers seulement deux adresses et nous avons besoin de plus de ports c√¥t√© serveur.  Il est impossible de cr√©er plus de 64k connexions vers la m√™me paire ip: port (en fait un peu moins que 64k). </p><br><p>  Sur le serveur A dans le fichier LAppS / include / wsServer.h, il y a une fonction void startListeners ().  Dans cette fonction, nous remplacerons la ligne 126 </p><br><pre> <code class="plaintext hljs">LAppSConfig::getInstance()-&gt;getWSConfig()["port"],</code> </pre> <br><p>  avec ceci: </p><br><pre> <code class="plaintext hljs">static_cast&lt;int&gt;(LAppSConfig::getInstance()-&gt;getWSConfig()["port"])+i,</code> </pre> <br><p>  Reconstruire des Laps: </p><br><pre> <code class="bash hljs">make CONF=Release.AVX2 install</code> </pre> <br><h1 id="running-the-tests-for-2-240-000-client-websockets">  Ex√©cution des tests pour 2 240 000 WebSockets client. </h1><br><p>  D√©marrez le LAppS sur le serveur B, puis d√©marrez le LAppS sur le serveur B et redirigez la sortie vers un fichier comme celui-ci: </p><br><pre> <code class="bash hljs">/opt/lapps/bin/lapps.avx2 &gt; <span class="hljs-built_in"><span class="hljs-built_in">log</span></span></code> </pre> <br><p>  Edit, NB: </p><br><pre> <code class="plaintext hljs">if you want to run several LAppS instances, then create separate directory for each instnace (like run1,run2, etc) and run each instance from within these directories. This is required for lapps.log file and of course for resulting standard output, for not to be overlapped/overwritten by concurrent LAppS instances.</code> </pre> <br><p>  Cela peut prendre un certain temps jusqu'√† ce que toutes les connexions soient √©tablies.  Suivons les progr√®s. </p><br><p>  N'utilisez pas netstat pour surveiller les connexions √©tablies, cela ne sert √† rien alors qu'il s'ex√©cute ind√©finiment apr√®s, comme 150 000 connexions qui s'√©tablissent en quelques secondes.  Regardez le lapps.log sur le serveur A, dans le r√©pertoire o√π vous vous trouviez au d√©marrage de LAppS.  Vous pouvez utiliser le one-liner suivant pour voir comment les connexions sont √©tablies et comment sont-elles r√©parties entre les IOWorkers: </p><br><pre> <code class="bash hljs">date;awk <span class="hljs-string"><span class="hljs-string">'/ will be added to connection pool of worker/{a[$22]++}END{for(i in a){ print i, a[i]; sum+=a[i]} print sum}'</span></span> lapps.log | sort -n;date</code> </pre> <br><p>  Voici une id√©e de la rapidit√© avec laquelle ces connexions sont √©tablies: </p><br><pre> <code class="plaintext hljs">375874 Sun Jul 21 20:33:07 +06 2019 650874 Sun Jul 21 20:34:42 +06 2019 2894 connections per second 1001874 Sun Jul 21 20:36:45 +06 2019 2974 connections per second 1182874 Sun Jul 21 20:37:50 +06 2019 2784 connections per second 1843874 Sun Jul 21 20:41:44 +06 2019 2824 connections per second 2207874 Sun Jul 21 20:45:43 +06 2019 3058 connections per second</code> </pre><br><p>  Sur le serveur B, nous pouvons v√©rifier le nombre de benchmarks finis d'√©tablir leurs connexions: </p><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># grep Sockets log | wc -l 224</span></span></code> </pre> <br><p>  Apr√®s avoir vu que le nombre est 224, laissez les serveurs fonctionner pendant un certain temps, surveillez l'utilisation du processeur et de la m√©moire avec top.  Vous pourriez voir quelque chose comme √ßa (serveur B √† gauche et serveur A √† droite): </p><br><p><img src="https://habrastorage.org/webt/e0/vy/sv/e0vysvislttrfhwpn_vexnwseli.png" alt="image"></p><br><p>  Ou comme ceci (serveur B √† gauche et serveur A √† droite): </p><br><p><img src="https://habrastorage.org/webt/p1/cj/qk/p1cjqk6fxmthbnnexc2ikco9d6a.png"></p><br><p>  Il est clair que le serveur B, o√π les services clients de r√©f√©rence sont en cours d'ex√©cution, est sous une lourde charge.  Le serveur A est √©galement sous forte charge mais pas toujours.  Parfois, il se refroidit tandis que le serveur B a du mal avec la quantit√© de t√¢ches √† travailler.  Le chiffrement du trafic sur TLS est tr√®s gourmand en ressources CPU. </p><br><p>  Arr√™tons les serveurs (appuyez plusieurs fois sur Ctrl-C) et modifions le journal comme auparavant, mais par rapport √† la quantit√© modifi√©e de services de r√©f√©rence (224): </p><br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> -e <span class="hljs-string"><span class="hljs-string">':%s/ms/^V^M/g\n:%g/^$/d\nGdd1G224/Sockets\n224\ndggZZ'</span></span> | vi <span class="hljs-variable"><span class="hljs-variable">$i</span></span> awk -v avg=0 <span class="hljs-string"><span class="hljs-string">'{rps=($1/$5);avg+=rps;}END{print ((avg*1000)/NR)*224}'</span></span> <span class="hljs-built_in"><span class="hljs-built_in">log</span></span></code> </pre> <br><p>  Vous souhaiterez peut-√™tre √©galement supprimer plusieurs derni√®res lignes pour tenir compte des impressions de l'arr√™t des services de r√©f√©rence.  Vous avez d√©j√† une id√©e sur la fa√ßon de proc√©der.  Je vais donc publier les r√©sultats pour diff√©rents sc√©narios de test et poursuivre les probl√®mes que j'ai rencontr√©s. </p><br><h1 id="results-for-all-the-other-tests-49-million-and-beyond">  R√©sultats pour tous les autres tests (4,9 millions et au-del√†) </h1><br><p><img src="https://habrastorage.org/webt/az/4a/at/az4aatexickfttbrom2gg3yrymu.png"></p><br><div class="spoiler">  <b class="spoiler_title">test # 4 charge</b> <div class="spoiler_text"><p><img src="https://habrastorage.org/webt/ra/ka/_f/raka_fia7i2vnqhwh2p-5lnulc8.png"></p></div></div><br><div class="spoiler">  <b class="spoiler_title">test # 5 charge</b> <div class="spoiler_text"><p><img src="https://habrastorage.org/webt/ln/z5/ml/lnz5mlaoz7aclxuyvjwjpwj25jm.png"></p></div></div><br><div class="spoiler">  <b class="spoiler_title">test # 5 √©quilibr√© pour un partage CPU √©gal</b> <div class="spoiler_text"><p><img src="https://habrastorage.org/webt/vi/cy/fe/vicyfenhzk7uvcjsiohq950c9fa.png"></p></div></div><br><div class="spoiler">  <b class="spoiler_title">test n ¬∞ 6</b> <div class="spoiler_text"><p><img src="https://habrastorage.org/webt/7h/bg/ez/7hbgezb4zxuv3ijuemjmkilf110.png"></p></div></div><br><div class="spoiler">  <b class="spoiler_title">test n ¬∞ 8</b> <div class="spoiler_text"><p><img src="https://habrastorage.org/webt/gq/5_/uj/gq5_uje-nnkfhlqmilb7xnbu5tc.png"></p></div></div><br><div class="spoiler">  <b class="spoiler_title">test # 12</b> <div class="spoiler_text"><p><img src="https://habrastorage.org/webt/xa/tr/m9/xatrm9dbbaha13w9wjxzmecvxjm.png"></p></div></div><br><div class="spoiler">  <b class="spoiler_title">test # 13</b> <div class="spoiler_text"><p><img src="https://habrastorage.org/webt/-w/9t/i8/-w9ti8atzczna-9dvepihihlyqu.png"></p></div></div><br><h1 id="problems">  Probl√®mes. </h1><br><p>  Marqu√© dans le tableau ci-dessus avec du rouge. </p><br><p>  L'ex√©cution de plus de 224 instances de r√©f√©rence sur le serveur B s'est av√©r√©e √™tre la mauvaise id√©e, car le serveur c√¥t√© client √©tait incapable de r√©partir uniform√©ment le temps CPU entre les processus / threads.  Les 224 premi√®res instances de r√©f√©rence qui ont √©tabli toutes leurs connexions ont consomm√© la plupart des ressources CPU et les autres instances de r√©f√©rence accusent un retard.  M√™me l'utilisation de renice -20 n'aide pas beaucoup (448 instances de r√©f√©rence, 2 instances LAppS): </p><br><div class="spoiler">  <b class="spoiler_title">448 instances de r√©f√©rence</b> <div class="spoiler_text"><p><img src="https://habrastorage.org/webt/a2/ms/bg/a2msbgjgzuwvzzdl332linmmq98.png"><br>  Le serveur B (c√¥t√© gauche) est soumis √† une charge tr√®s lourde et le serveur A dispose toujours de ressources CPU gratuites. </p></div></div><br><p>  J'ai donc doubl√© <strong>benchmark.max_connections</strong> au lieu de d√©marrer davantage d'instances LAppS distinctes. </p><br><p>  Toujours pour 12,3 millions de WebSockets √† ex√©cuter, j'ai d√©marr√© la 5√®me instance de LAppS (tests 5 et 6) sans en arr√™ter quatre d√©j√† en cours d'ex√©cution.  Et a jou√© le r√¥le de CFQ en suspendant et en red√©marrant manuellement les processus prioritaires avec <em>kill -STOP / -CONT</em> ou / et <em>renice</em> leurs priorit√©s.  Vous pouvez utiliser le script de mod√®le suivant pour cela: </p><br><pre> <code class="bash hljs"><span class="hljs-keyword"><span class="hljs-keyword">while</span></span> [ 1 ]; <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-built_in"><span class="hljs-built_in">kill</span></span> -STOP &lt;4 fast-processes pids&gt; sleep 10 <span class="hljs-built_in"><span class="hljs-built_in">kill</span></span> -CONT &lt;4 fast-processes pids&gt; sleep 5 <span class="hljs-keyword"><span class="hljs-keyword">done</span></span></code> </pre> <br><p>  Bienvenue dans RHEL 7.6 2019!  Honn√™tement, j'ai utilis√© la commande renice pour la premi√®re fois depuis 2009. Ce qui est pire, - je l'ai utilis√©e presque sans succ√®s cette fois. </p><br><p>  J'ai eu un probl√®me avec le moteur de diffusion-collecte des cartes r√©seau.  Je l'ai donc d√©sactiv√© pour certains tests, sans marquer cet √©v√©nement dans le tableau. </p><br><p>  J'ai eu des interruptions de liaison partielles sous une charge √©lev√©e et le bug du pilote NIC, j'ai donc d√ª ignorer les r√©sultats des tests associ√©s. </p><br><h1 id="end-of-story">  Fin de l'histoire </h1><br><p>  Honn√™tement, les tests se sont d√©roul√©s beaucoup plus facilement que je ne l'avais pr√©vu. </p><br><p>  Je suis convaincu que je n'ai pas r√©ussi √† charger LAppS sur le serveur A √† son plein potentiel (sans SSL), car je n'avais pas assez de ressources CPU pour le c√¥t√© client.  Bien que TLS 1.3 soit activ√©, le LAppS sur le serveur A utilisait presque toutes les ressources CPU disponibles. </p><br><p>  Je suis toujours convaincu que LAppS est le serveur open source WebSockets le plus √©volutif et le plus rapide du <strong>march√©</strong> et que le module client <strong>cws</strong> WebSockets est le seul du genre, fournissant le cadre pour les tests √† haute charge. </p><br><p>  Veuillez v√©rifier les r√©sultats sur votre propre mat√©riel. </p><br><p>  Remarque: n'utilisez jamais nginx ou apache comme √©quilibreur de charge ou comme passe proxy pour WebSockets, sinon vous finirez par r√©duire les performances par ordre de grandeur.  Ils ne sont pas con√ßus pour WebSockets. </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr460847/">https://habr.com/ru/post/fr460847/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr460837/index.html">Manuel du podcast pour d√©butants</a></li>
<li><a href="../fr460839/index.html">Lancer Predator - R√©f√©rentiels de donn√©es pr√©compil√©s</a></li>
<li><a href="../fr460841/index.html">TOP-23 applications d'apprentissage des langues</a></li>
<li><a href="../fr460843/index.html">Pr√©sentation du nouveau concepteur de flux d'appels 3CX et du g√©n√©rateur de mod√®les CRM 3CX</a></li>
<li><a href="../fr460845/index.html">Fernando Corbato, le p√®re de votre ordinateur (et mot de passe), est d√©c√©d√© √† 93 ans</a></li>
<li><a href="../fr460849/index.html">Partie 4. Un mod√®le de graphe pour calculer les fonctions logiques pour les processus parall√®les asynchrones</a></li>
<li><a href="../fr460851/index.html">SamsPcbGuide, Partie 10: Technologie - Soudage de composants sans plomb</a></li>
<li><a href="../fr460855/index.html">Comment utiliser PHP pour impl√©menter des microservices?</a></li>
<li><a href="../fr460857/index.html">Comment Namecoin Blockchain Research a pr√©dit les cyber-attaques RTM</a></li>
<li><a href="../fr460859/index.html">Conf√©rence IThink # 3 √† Kharkov - bas√©e sur la WWDC 2019</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>