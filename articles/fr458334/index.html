<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üè¥ ‚ô¶Ô∏è üç¢ R√©plication continue de l'ancien vers le nouveau PostgreSQL avec Slony üèåÔ∏è ‚Ñ¢Ô∏è üßõüèº</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="La r√©plication de streaming native dans PostgreSQL ne fonctionne qu'entre serveurs avec la m√™me version principale. Nous avons parl√© de r√©plication lo...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>R√©plication continue de l'ancien vers le nouveau PostgreSQL avec Slony</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/southbridge/blog/458334/"><p><img src="https://habrastorage.org/webt/c-/eo/j8/c-eoj8fosll1jnolz9jlnmi1wrg.jpeg"></p><br><p>  La r√©plication de streaming native dans PostgreSQL ne fonctionne qu'entre serveurs avec la m√™me version principale.  Nous avons parl√© de r√©plication logique dans un article <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">pr√©c√©dent</a> .  Nous avons vu comment la r√©plication logique aide √† d√©placer les donn√©es d'une version de PostgreSQL vers une autre.  Mais la r√©plication logique ne convient qu'aux versions prises en charge de PostgreSQL, par exemple, PostgreSQL 9.4 et PostgreSQL 11. Que faire avec les versions ant√©rieures √† 9.4?  Utilisez <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Slony-I</a> . </p><br><p>  Utilisez la r√©plication avec Slony-I pour transf√©rer des donn√©es d'anciennes bases de donn√©es vers la derni√®re version de PostgreSQL.  Qu'est-ce que Slony et comment √ßa marche? </p><a name="habracut"></a><br><p>  Ceci est le quatri√®me article de notre s√©rie <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Mise √† niveau ou migration d'anciennes versions de PostgreSQL vers de nouvelles</a> , o√π nous apprenons diff√©rentes m√©thodes de mise √† jour des bases de donn√©es PostgreSQL. </p><br><h3 id="slony">  Slony </h3><br><p>  Slony est une impl√©mentation de r√©plication logique au niveau de l'application pour PostgreSQL.  Ou plut√¥t, il s'agit d'un outil de r√©plication tiers qui n√©cessite une installation et une configuration distinctes.  Slony existe depuis longtemps.  La derni√®re version prend en charge PostgreSQL de 8.4 √† 11. </p><br><p>  Le principal objectif de la r√©plication est de transf√©rer les modifications d'un serveur de base de donn√©es √† un autre.  Pour mieux comprendre l'architecture, regardons les termes: Slon, events et slonik. </p><br><p>  Soit dit en passant, Slony, si vous n‚Äôavez pas devin√©, ce sont des ¬´√©l√©phants¬ª.  Et ils ont vraiment une excellente m√©moire.  Ce n'est pas un hasard si un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">√©l√©phant</a> strict mais mignon s'affiche sur le logo PostgreSQL. </p><br><h3 id="slon">  Slon </h3><br><p>  Slon est un d√©mon qui s'ex√©cute sur chaque n≈ìud PostgreSQL dans la r√©plication Slony-I.  Ces d√©mons sont utilis√©s pour g√©rer les √©v√©nements de configuration et de r√©plication pour chaque serveur PostgreSQL.  Chaque serveur PostgreSQL est appel√© h√¥te.  Tous les n≈ìuds forment ensemble un cluster Slony. </p><br><p>  Le n≈ìud √©diteur est la source des modifications, et le n≈ìud abonn√© re√ßoit et applique les modifications de l'√©diteur. </p><br><p> Pour configurer la r√©plication, vous devez sp√©cifier toutes les tables r√©pliqu√©es ou un ensemble de r√©plication.  L'abonnement fonctionne pour un ensemble sp√©cifique.  Les modifications apport√©es aux tables r√©pliqu√©es sont combin√©es dans SYNC, un groupe de transactions qui sont appliqu√©es ensemble sur les abonn√©s. </p><br><h3 id="sobytiya">  Les √©v√©nements </h3><br><p>  Les modifications sont signal√©es par l'√©diteur en tant qu'√©v√©nements.  Lorsqu'un √©v√©nement est trait√© par le d√©mon Slon sur l'h√¥te distant, un accus√© de r√©ception est g√©n√©r√©.  Et les √©v√©nements notifient les n≈ìuds des modifications de configuration, comme l'ajout ou la suppression de nouveaux n≈ìuds, de nouveaux abonnements ou des modifications DDL. </p><br><p>  Chaque √©v√©nement a son propre identifiant de source unique, son num√©ro de s√©rie, son identifiant de transaction pour l'instantan√© sur le n≈ìud d'√©v√©nement, plusieurs arguments et un horodatage avec un fuseau horaire. <br>  Les d√©clencheurs √©crits dans PL / pgSQL enregistrent toutes les modifications apport√©es aux tables r√©pliqu√©es.  Malheureusement, il n'existe aucun moyen fiable de g√©rer les modifications apport√©es aux objets blob, DDL ou aux utilisateurs et aux r√¥les. </p><br><h3 id="slonik">  slonik </h3><br><p>  Il s'agit d'un utilitaire de ligne de commande avec un analyseur et un interpr√©teur qui accepte les scripts slonik - un langage d√©claratif simple.  Il est con√ßu pour surmonter les limites d'un langage proc√©dural.  √Ä l'aide des commandes slonik, vous pouvez configurer ou modifier la r√©plication dans Slony, et elles peuvent √™tre int√©gr√©es dans des scripts shell.  Il accepte les commandes d'entr√©e standard ou de fichiers.  L'exemple ci-dessous montre comment le script slonik est pass√© √† slonik et incorpor√© dans des scripts shell. </p><br><p>  Le script qui cr√©e la configuration initiale pour un sch√©ma ma√Ætre-esclave simple dans notre base de donn√©es pgbench ressemble √† ceci: </p><br><pre><code class="plaintext hljs">#!/bin/sh slonik &lt;&lt;_EOF_ cluster name = percona_pg; node 1 admin conninfo = 'dbname=pg93 host=pg93_host user=percona_pg93_user'; node 2 admin conninfo = 'dbname=pg11 host=pg11_host user=percona_pg11_user'; #-- # Creates a _$(clustername), this example, _percona_pg schema #-- init cluster ( id=1, comment = 'Legacy PG Node'); #-- # Add a list of tables being replicated to a set. #-- create set (id=1, origin=1, comment='pgbench'); set add table (set id=1, origin=1, id=1, fully qualified name = 'public.pgbench_accounts', comment='accounts'); set add table (set id=1, origin=1, id=2, fully qualified name = 'public.pgbench_branches', comment='branches'); set add table (set id=1, origin=1, id=3, fully qualified name = 'public.pgbench_tellers', comment='tellers'); set add table (set id=1, origin=1, id=4, fully qualified name = 'public.pgbench_history', comment='history'); #-- # Create the second node (the slave) tell the 2 nodes how to connect to # each other and how they should listen for events. #-- store node (id=2, comment = 'Target node', event node=1); store path (server = 1, client = 2, conninfo='dbname=pg93 host=pg93_host user=percona_pg93_user'); store path (server = 2, client = 1, conninfo='dbname=pg11 host=pg11_host user=percona_pg11_user'); _EOF_</code> </pre> <br><h3 id="pochemu-slony-udobno-ispolzovat-dlya-migraciy">  Pourquoi Slony est-il pratique pour les migrations? </h3><br><p>  Malgr√© les avantages de la r√©plication logique interne, pour les versions ant√©rieures √† PostgreSQL 9.4, vous devez utiliser cette solution tierce.  L'approche bas√©e sur les d√©clencheurs d√©pend de l'API de base de donn√©es - les deux versions doivent √™tre compatibles pour utiliser la syntaxe PL / pgSQL et SQL. </p><br><h3 id="kak-adaptirovat-bazu-dannyh-dlya-ispolzovaniya-so-slony">  Comment adapter la base de donn√©es pour une utilisation avec Slony? </h3><br><ul><li>  Les tables doivent avoir des cl√©s primaires.  Ajoutez un champ s√©rie √† toutes les tables sans cl√© primaire. </li><li>  Les modifications apport√©es au blob OID ne sont pas r√©pliqu√©es.  Si vous avez des colonnes avec des valeurs courtes, convertissez-les en BYTEA.  Si les objets sont tr√®s volumineux - par exemple, des images -, il est pr√©f√©rable de stocker les donn√©es dans un stockage externe (par exemple, S3 dans le cloud Amazon).  Si la modification de l'application est trop compliqu√©e, appliquez les modifications d'objet blob √† la derni√®re √©tape de la migration. </li><li>  ALTER TABLE et autres op√©rations DDL.  Slony ne d√©tecte pas les changements de structure de table.  Utilisez la commande slonik EXECUTE SCRIPT pour appliquer un fichier SQL avec des cha√Ænes SQL ou DDL √† l'ensemble du cluster de r√©plication. </li></ul><br><h3 id="onlayn-migraciya-iz-predyduschih-versiy-postgresql">  Migration en ligne des versions pr√©c√©dentes de PostgreSQL </h3><br><ol><li>  Cr√©ez un utilisateur de r√©plication avec des privil√®ges de superutilisateur.  Vous pouvez configurer les droits en d√©tail, mais c'est beaucoup plus compliqu√©. </li><li>  Cr√©ez une base de donn√©es √† destination avec un acc√®s TCP / IP. </li><li>  Copiez les d√©finitions de table du ma√Ætre vers les esclaves. </li><li>  Installez Slony-I.  Sur les serveurs avec une ancienne version du syst√®me d'exploitation, il sera plus facile d'installer Slony-I √† partir du code source. </li><li>  D√©finissez le cluster, l'ensemble de tables et les informations de connexion de noeud comme une liste de commandes slonik. </li><li>  Ex√©cutez le d√©mon slon sur chaque serveur PostgreSQL.  V√©rifiez la sortie standard ou les fichiers journaux pour les erreurs de connexion. </li><li>  Ex√©cutez les commandes d'abonnement slonik pour d√©marrer la synchronisation. </li><li>  Testez les requ√™tes en lecture seule dans la nouvelle version de Postgres. </li><li>  Lorsque toutes les donn√©es sont r√©pliqu√©es et synchronis√©es, arr√™tez les applications et dirigez-les vers le nouveau serveur Postgres. </li><li>  Utilisez le n≈ìud de d√©sinstallation dans la nouvelle version de PostgreSQL pour supprimer toutes les traces de r√©plication Slony. </li></ol><br><h3 id="perehod-na-predyduschie-versii">  Transition vers les versions pr√©c√©dentes </h3><br><p>  Utilisez la m√™me proc√©dure pour mettre √† niveau vers les versions pr√©c√©dentes.  Avec Slony, vous pouvez r√©pliquer √† partir de n'importe quelle version et vers n'importe quelle version de PosgreSQL prise en charge par la version Slony.  La version minimale prise en charge est 8.4. </p><br><h3 id="itogi">  R√©sum√© </h3><br><p>  Nous avons vu en termes g√©n√©raux comment vous pouvez passer √† la nouvelle version avec un temps d'arr√™t minimal en utilisant Slony.  En savoir plus sur notre <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">webinaire</a> . </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr458334/">https://habr.com/ru/post/fr458334/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr458324/index.html">Tout ce dont vous avez besoin pour commencer avec Vue.js</a></li>
<li><a href="../fr458326/index.html">Yandex ouvre des ensembles de donn√©es Toloka pour les chercheurs</a></li>
<li><a href="../fr458328/index.html">Comment dupliquer les objectifs de Yandex.Metrica dans Google Analytics</a></li>
<li><a href="../fr458330/index.html">Il n'y a pas de limite √† la perfection: comment les interfaces neuronales aident l'humanit√©</a></li>
<li><a href="../fr458332/index.html">Programmation asynchrone - performances asynchrones: comprendre les co√ªts de l'async et attendre</a></li>
<li><a href="../fr458336/index.html">Le cycle complet de d√©veloppement de produits informatiques en utilisant l'exemple de projet: r√¥les d'√©quipe, t√¢ches client, √©tapes</a></li>
<li><a href="../fr458338/index.html">Gestionnaire de s√©curit√© des applications. D√©veloppeur ou s√©curit√©?</a></li>
<li><a href="../fr458342/index.html">Texturation, ou ce que vous devez savoir pour devenir un artiste de surface. Partie 1. Pixel</a></li>
<li><a href="../fr458344/index.html">Utilisation de la messagerie asynchrone pour am√©liorer la disponibilit√©</a></li>
<li><a href="../fr458346/index.html">R√©solution de probl√®mes avec pwnable.kr 01 - fd. Descripteurs et processus de fichiers</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>