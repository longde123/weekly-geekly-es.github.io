<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>♐️ 🎥 🎏 Asynchronie dans la programmation 🤷🏼 👞 🚵🏾</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Dans le domaine du développement d'applications multithreads ou distribuées très chargées, des discussions sur la programmation asynchrone se posent s...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Asynchronie dans la programmation</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/jugru/blog/446562/"><p>  Dans le domaine du développement d'applications multithreads ou distribuées très chargées, des discussions sur la programmation asynchrone se posent souvent.  Aujourd'hui, nous allons plonger dans l'asynchronie en détail et étudier ce que c'est quand cela se produit, comment cela affecte le code et le langage de programmation que nous utilisons.  Nous découvrirons pourquoi les Futures et les Promesses sont nécessaires, et aborderons les coroutines et les systèmes d'exploitation.  Cela rendra les compromis qui surviennent pendant le développement de logiciels plus explicites. </p><br><p>  Le matériel est basé sur une transcription d'un rapport d'Ivan Puzyrevsky, enseignant à la Yandex Data Analysis School. </p><br><p><img src="https://habrastorage.org/webt/zl/f-/6v/zlf-6v_wphtcesgmq7cvpvfctbk.png"></p><a name="habracut"></a><br><h1 id="videozapis">  Enregistrement vidéo </h1><br><iframe width="560" height="315" src="https://www.youtube.com/embed/g7dno0SupKY" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><a name="section1"></a><br><h1 id="1-soderzhanie">  1. Contenu </h1><br><div class="spoiler">  <b class="spoiler_title">Texte masqué</b> <div class="spoiler_text"><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">1. Contenu</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">2. Introduction</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">3. Concepts de base</a> <br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">3.1.</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Fil d'exécution</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">3.2.</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Multitâche et simultanéité</a> </li></ul></li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">4. Blocage et attente</a> <br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">4.1.</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Attente non bloquante</a> </li></ul></li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">5. Futures / promesses</a> <br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">5.1.</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Interface Future &amp; Promise</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">5.2.</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Informatique de composition</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">5.3.</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Des exemples</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">5.4.</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Tout-combinateur</a> </li><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">5.5.</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Tout-combinateur</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">5.6.</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Adaptation de rappel</a> </li></ul></li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">6. Comment rendre le code lisible avec coroutine</a> <br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">6.1.</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Coroutines</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">6.2.</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Projet de mise en œuvre WaitFor</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">6.3.</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Comment est le cycle de planification</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">6.4.</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Coroutine TS</a> </li></ul></li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">7. Qu'avez-vous reçu?</a> </li></ul></div></div><br><a name="section2"></a><br><h1 id="2-vvedenie">  2. Introduction </h1><br><p> Bonjour à tous, je m'appelle Ivan Puzyrevsky, je travaille pour Yandex.  Au cours des six dernières années, je me suis engagé dans l'infrastructure de stockage et de traitement des données, maintenant je suis passé au produit - à la recherche de voyages, d'hôtels et de billets.  Depuis que je travaille depuis longtemps dans l'infrastructure, j'ai acquis pas mal d'expérience sur la façon d'écrire différentes applications chargées.  Notre infrastructure fonctionne <code>24*7*365</code> heures sur <code>24*7*365</code> jours sur 7, sans interruption, en continu sur des milliers de machines.  Naturellement, vous devez écrire du code pour qu'il fonctionne de manière fiable et efficace et résout les tâches que l'entreprise pose. </p><br><p>  Aujourd'hui, nous allons parler d'asynchronie.  Qu'est-ce que l'asynchronie?  C'est un décalage entre quelque chose et quelque chose dans le temps.  D'après cette description, il n'est généralement pas clair de quoi je vais parler aujourd'hui.  Pour clarifier quelque peu le problème, j'ai besoin d'un exemple à la «Bonjour, monde!».  L'asynchronie se produit généralement dans le contexte de l'écriture d'applications réseau, donc j'aurai un réseau analogique "Bonjour, monde!".  Ceci est une application de ping-pong.  Le code ressemble à ceci: </p><br><pre> <code class="cpp hljs">socket s; <span class="hljs-built_in"><span class="hljs-built_in">string</span></span> x; x = read_from_socket(s, <span class="hljs-number"><span class="hljs-number">4</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (x == <span class="hljs-string"><span class="hljs-string">"ping"</span></span>) { write_to_socket(s, <span class="hljs-string"><span class="hljs-string">"pong"</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>;</code> </pre> <br><p>  Je crée un socket, je lis une ligne à partir de là et vérifie s'il s'agit de ping, puis j'écris pong en réponse.  Très simple et clair.  Que se passe-t-il lorsque vous voyez ce code sur l'écran de votre ordinateur?  Nous considérons ce code comme une séquence de ces étapes: </p><br><p><img src="https://habrastorage.org/webt/va/3e/dk/va3edk8_ja838w9qo7apppwyy50.png"></p><br><p>  Du point de vue du temps physique réel, tout est un peu biaisé. </p><br><p><img src="https://habrastorage.org/webt/od/wo/4g/odwo4gzguqz7nr_odgsksityvda.png"></p><br><p>  Ceux qui ont écrit et exécuté un tel code savent qu'après l'étape de lecture et après l'étape <br>  l'écriture est un intervalle de temps assez perceptible lorsque notre programme semble ne rien faire du point de vue de notre code, mais sous le capot la machine fonctionne, que nous appelons «entrée-sortie». </p><br><p><img src="https://habrastorage.org/webt/ye/jl/67/yejl67r3goweaiupb1wjieg5i2a.png"><br>  Pendant les E / S, les paquets sont échangés sur le réseau et tous les travaux lourds et de bas niveau qui en découlent.  Faisons une expérience de réflexion: prenons un tel programme, exécutez-le sur un processeur physique et prétendez que nous n'avons pas de système d'exploitation, que se passera-t-il?  Le processeur ne peut pas s'arrêter, il continue de prendre des mesures sans suivre aucune instruction, gaspillant simplement de l'énergie en vain. </p><br><p><img src="https://habrastorage.org/webt/pg/lu/xp/pgluxpmbkl8ho9w-2docuab2iqg.png"></p><br><p>  La question se pose de savoir si nous pouvons faire quelque chose d’utile pendant cette période.  C'est une question très naturelle, dont la réponse nous permettrait d'économiser la puissance du processeur et de l'utiliser pour quelque chose d'utile, alors que notre application semble ne rien faire. </p><br><a name="section3"></a><br><h1 id="3-osnovnye-ponyatiya">  3. Concepts de base </h1><br><a name="section3-1"></a><br><h2 id="31-potok-vypolneniya">  3.1.  Fil d'exécution </h2><br><p>  Comment pouvons-nous aborder cette tâche?  Réconcilions les concepts.  Je dirai "flux d'exécution", en référence à une séquence significative d'opérations ou d'étapes élémentaires.  La signification sera déterminée par le contexte dans lequel je parle du flux d'exécution.  Autrement dit, si nous parlons d'un algorithme à un seul thread (Aho-Korasik, recherche de graphes), alors cet algorithme lui-même est déjà un thread d'exécution.  Il prend quelques mesures pour résoudre le problème. </p><br><p>  Si je parle d'une base de données, alors un thread d'exécution peut faire partie des actions effectuées par la base de données pour servir une demande entrante.  Il en va de même pour les serveurs Web.  Si j'écris une sorte d'application mobile ou Web, pour servir les opérations d'un utilisateur, par exemple, en cliquant sur un bouton, les interactions réseau, l'interaction avec le stockage local, etc.  La séquence de ces actions du point de vue de mon application mobile sera également un flux d'exécution significatif distinct.  Du point de vue du système d'exploitation, un processus ou un thread de processus est également un thread d'exécution significatif. </p><br><a name="section3-2"></a><br><h2 id="32-mnogozadachnost-i-parallelizm">  3.2.  Multitâche et simultanéité </h2><br><p>  La pierre angulaire de la productivité est la capacité de faire une telle astuce: lorsque j'ai un thread d'exécution qui contient des vides dans son analyse du temps physique, puis remplissez ces vides avec quelque chose d'utile - suivez les étapes des autres threads d'exécution. </p><br><p><img src="https://habrastorage.org/webt/vw/x1/si/vwx1sijti5ahggnjozkymza2hna.png"></p><br><p>  Les bases de données desservent généralement de nombreux clients en même temps.  Si nous pouvons combiner le travail sur plusieurs threads d'exécution dans le cadre d'un thread d'exécution d'un niveau supérieur, alors cela s'appelle le multitâche.  C'est-à-dire que le multitâche est lorsque j'exécute des actions dans le cadre d'un plus grand flux d'exécution qui sont subordonnées à la solution de tâches plus petites. </p><br><p>  Il est important de ne pas confondre le concept de multitâche avec le parallélisme.  Accès simultané - <br>  ce sont des propriétés de l'environnement d'exécution, ce qui permet en une seule étape, en une seule étape, de progresser dans différents threads d'exécution.  Si j'ai deux processeurs physiques, alors dans un cycle d'horloge, ils peuvent exécuter deux instructions.  Si le programme s'exécute sur un processeur, il faudra deux cycles d'horloge pour exécuter les deux mêmes instructions. </p><br><p><img src="https://habrastorage.org/webt/nq/n5/yf/nqn5yf1pee8kwgi3rw1lxmnyomi.png"></p><br><p>  Il est important de ne pas confondre ces concepts, car ils entrent dans différentes catégories.  Le multitâche est une caractéristique de votre programme car il est structuré en interne comme un travail variable sur différentes tâches.  La concurrence est une propriété de l'environnement d'exécution qui vous permet de travailler sur plusieurs tâches en un seul cycle d'horloge. </p><br><p>  À bien des égards, le code asynchrone et l'écriture de code asynchrone consiste à écrire du code multitâche.  La principale difficulté est de savoir comment j'encode les tâches et comment les gérer.  Par conséquent, nous en parlerons aujourd'hui - écrire du code multitâche. </p><br><a name="section4"></a><br><h1 id="4-blokirovanie-i-ozhidanie">  4. Blocage et attente </h1><br><p><img src="https://habrastorage.org/getpro/habr/post_images/da7/042/897/da7042897d750697821baf6381db92ea.png"></p><br><p>  Commençons par un exemple simple.  Retour au ping-pong: </p><br><pre> <code class="cpp hljs">socket s; <span class="hljs-built_in"><span class="hljs-built_in">string</span></span> x; x = read_from_socket(s, <span class="hljs-number"><span class="hljs-number">4</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (x == <span class="hljs-string"><span class="hljs-string">"ping"</span></span>) { write_to_socket(s, <span class="hljs-string"><span class="hljs-string">"pong"</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>;</code> </pre> <br><p>  Comme nous l'avons déjà évoqué, après les lignes lues et blanches le fil d'exécution s'endort, il est bloqué.  Habituellement, nous disons «le flux est bloqué». </p><br><pre> <code class="cpp hljs">socket s; <span class="hljs-built_in"><span class="hljs-built_in">string</span></span> x; x = read_from_socket(s, <span class="hljs-number"><span class="hljs-number">4</span></span>); <span class="hljs-comment"><span class="hljs-comment">/* thread is blocked here */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (x == <span class="hljs-string"><span class="hljs-string">"ping"</span></span>) { write_to_socket(s, <span class="hljs-string"><span class="hljs-string">"pong"</span></span>); <span class="hljs-comment"><span class="hljs-comment">/* thread is blocked here */</span></span> } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>;</code> </pre> <br><p>  Cela signifie que le flux d'exécution a atteint un point où tout événement est nécessaire pour le poursuivre.  En particulier, dans le cas de notre application réseau, il est nécessaire que les données arrivent sur le réseau ou, inversement, nous avons un tampon gratuit pour écrire des données sur le réseau.  Les événements peuvent être différents.  Si nous parlons d'aspects temporels, nous pouvons attendre le déclenchement de la minuterie ou la fin d'un autre processus.  Les événements ici sont une sorte de chose abstraite, à propos d'eux, il est important de comprendre qu'ils peuvent être attendus. </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/c91/02f/7ca/c9102f7ca66291666b9df9c05ce7f46e.png"></p><br><p>  Lorsque nous écrivons du code simple, nous donnons implicitement le contrôle de l'attente des événements à un niveau supérieur.  Dans notre cas, le système d'exploitation.  Elle, en tant qu'entité d'un niveau supérieur, est responsable du choix de la tâche qui sera exécutée ensuite, et elle est également responsable du suivi de l'occurrence des événements. </p><br><p>  Notre code, que nous écrivons en tant que développeur, est structuré en même temps en ce qui concerne le travail sur une tâche.  L'extrait de code de l'exemple gère une connexion: il lit le ping d'une connexion et écrit le pong dans une connexion. </p><br><p>  Le code est clair.  Vous pouvez le lire et comprendre ce qu'il fait, comment cela fonctionne, quel problème il résout, quels invariants il a, etc.  Dans le même temps, nous gérons très mal la planification des tâches dans un tel modèle.  En général, les systèmes d'exploitation ont des concepts de priorités, mais si vous avez écrit des systèmes en temps réel doux, vous savez que les outils disponibles sous Linux ne sont pas suffisants pour créer suffisamment de systèmes en temps réel sains. </p><br><p>  De plus, le système d'exploitation est une chose compliquée, et le changement de contexte de notre application vers le noyau coûte quelques microsecondes, ce qui, avec quelques calculs simples, nous donne une estimation d'environ 20 à 100 000 changements de contexte par seconde.  Cela signifie que si nous écrivons un serveur Web, en une seconde, nous pouvons traiter environ 20 000 demandes, en supposant que le traitement des demandes est dix fois plus cher que le système. </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/c12/68f/503/c1268f5037154f9f0f5ac5bc82dfc531.png"></p><br><a name="section4-1"></a><br><h2 id="41-neblokiruyuschee-ozhidanie">  4.1.  Attente non bloquante </h2><br><p><img src="https://habrastorage.org/getpro/habr/post_images/ffe/97f/c42/ffe97fc42eca8beb2dae841358b31b8e.png"></p><br><p>  Si vous arrivez à la situation dont vous avez besoin pour travailler plus efficacement avec le réseau, alors vous commencez à chercher de l'aide sur Internet et à utiliser select / epoll.  Sur Internet, il est écrit que si vous voulez servir des milliers de connexions en même temps, vous avez besoin d'epoll, car c'est un bon mécanisme, etc.  Vous ouvrez la documentation et voyez quelque chose comme ceci: </p><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">select</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> nfds, fd_set* readfds, fd_set* writefds, fd_set* exceptfds, struct timeval* timeout)</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">FD_CLR</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> fd, fd_set* </span></span><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-params"><span class="hljs-built_in">set</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function">  </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">FD_ISSET</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> fd, fd_set* </span></span><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-params"><span class="hljs-built_in">set</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">FD_SET</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> fd, fd_set* </span></span><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-params"><span class="hljs-built_in">set</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">FD_ZERO</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(fd_set* </span></span><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-params"><span class="hljs-built_in">set</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">epoll_ctl</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> epfd, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> op, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> fd, struct epoll_event* event)</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">epoll_wait</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> epfd, struct epoll_event* events, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> maxevents, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> timeout)</span></span></span></span>;</code> </pre> <br><p>  Fonctions dans lesquelles l'interface contient soit de nombreux descripteurs avec lesquels vous travaillez (dans le cas de select), soit de nombreux événements qui passent <br>  à travers les frontières de votre application, le noyau du système d'exploitation que vous devez traiter (dans le cas d'epoll). </p><br><p>  Il convient également d'ajouter que vous ne pouvez pas sélectionner / epoll, mais dans une bibliothèque telle que libuv, qui n'aura aucun événement dans l'API, mais aura de nombreux rappels.  L'interface de la bibliothèque dira: "Cher ami, fournissez un rappel pour lire le socket, que j'appellerai lorsque les données apparaîtront." </p><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">uv_timer_start</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uv_timer_t</span></span></span></span><span class="hljs-function"><span class="hljs-params">* handle, uv_timer_cb cb, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint64_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> timeout, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint64_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> repeat)</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">typedef</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">void</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(*uv_timer_cb)</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uv_timer_t</span></span></span></span><span class="hljs-function"><span class="hljs-params">* handle)</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">uv_read_start</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uv_stream_t</span></span></span></span><span class="hljs-function"><span class="hljs-params">* stream, uv_alloc_cb alloc_cb, uv_read_cb read_cb)</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">uv_read_stop</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uv_stream_t</span></span></span></span><span class="hljs-function"><span class="hljs-params">*)</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">typedef</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">void</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(*uv_read_cb)</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uv_stream_t</span></span></span></span><span class="hljs-function"><span class="hljs-params">* stream, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">ssize_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> nread, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uv_buf_t</span></span></span></span><span class="hljs-function"><span class="hljs-params">* buf)</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">uv_write</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uv_write_t</span></span></span></span><span class="hljs-function"><span class="hljs-params">* req, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uv_stream_t</span></span></span></span><span class="hljs-function"><span class="hljs-params">* handle, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uv_buf_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> bufs[], </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">unsigned</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> nbufs, uv_write_cb cb)</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">typedef</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">void</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(*uv_write_cb)</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uv_write_t</span></span></span></span><span class="hljs-function"><span class="hljs-params">* req, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> status)</span></span></span></span>;</code> </pre> <br><p>  Qu'est-ce qui a changé par rapport à notre code synchrone dans le chapitre précédent?  Le code est devenu asynchrone.  Cela signifie que nous avons intégré la logique dans l'application pour déterminer le moment où les événements sont surveillés.  Les appels select / epoll explicites sont les points où nous demandons au système d'exploitation des informations sur les événements qui se sont produits.  Nous avons également pris en compte dans notre code d'application le choix de la tâche à effectuer ensuite. </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/458/28b/5f2/45828b5f2463ec94abf292e8a5db86bf.png"></p><br><p>  À partir des exemples d'interfaces, vous pouvez voir qu'il existe essentiellement deux mécanismes pour introduire le multitâche.  Une sorte de «pull» quand nous <br>  nous faisons ressortir bon nombre des événements que nous attendons, puis nous réagissons d'une manière ou d'une autre à eux.  Dans cette approche, il est facile d'amortir les frais généraux d'une unité <br>  un événement et donc atteindre un débit élevé de communication sur l'ensemble des événements qui se sont produits.  Habituellement, tous les éléments du réseau tels que l'interaction du noyau avec la carte réseau ou l'interaction entre vous et le système d'exploitation reposent sur des mécanismes d'interrogation. </p><br><p>  La deuxième façon est un mécanisme de «poussée», lorsqu'une certaine entité externe entre clairement, interrompt le flux d'exécution et dit: «Maintenant, veuillez gérer l'événement qui vient d'arriver.»  Il s'agit d'une approche avec des rappels, avec des signaux Unix, avec des interruptions au niveau du processeur, lorsqu'une entité externe envahit clairement votre thread d'exécution et dit: "Maintenant, s'il vous plaît, nous travaillons sur cet événement."  Cette approche est apparue afin de réduire le délai entre la survenance d'un événement et sa réaction. </p><br><p>  Pourquoi les développeurs C ++ qui écrivent et résolvent des problèmes d'application spécifiques peuvent-ils vouloir faire glisser un modèle d'événement dans notre code?  Si nous glissons et déposons le travail sur de nombreuses tâches dans notre code et les gérons, alors en raison du manque de transition vers le noyau et vice versa, nous pouvons travailler un peu plus rapidement et effectuer des actions plus utiles par unité de temps. </p><br><p>  À quoi cela mène-t-il en termes de code que nous écrivons?  Prenez nginx, par exemple, un serveur HTTP hautes performances, très courant.  Si vous lisez son code, il est construit sur un modèle asynchrone.  Le code est assez difficile à lire.  Lorsque vous vous demandez ce qui se passe exactement lors du traitement d'une seule requête HTTP, il s'avère qu'il y a beaucoup de fragments dans le code, espacés dans différents fichiers, à différents angles de la base de code.  Chaque fragment effectue une petite quantité de travail dans le cadre du traitement de la requête HTTP entière.  Par exemple: </p><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ngx_http_request_handler</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">ngx_event_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *ev)</span></span></span><span class="hljs-function"> </span></span>{ … <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (c-&gt;close) { ngx_http_terminate_request(r, <span class="hljs-number"><span class="hljs-number">0</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ev-&gt;write) { r-&gt;write_event_handler(r); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { r-&gt;read_event_handler(r); } ... } <span class="hljs-comment"><span class="hljs-comment">/* where the handler... */</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">typedef</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">void</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(*ngx_http_event_handler_pt)</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">ngx_http_request_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *r)</span></span></span></span>; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ngx_http_request_s</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-comment"><span class="hljs-comment">/*... */</span></span> ngx_http_event_handler_pt read_event_handler; <span class="hljs-comment"><span class="hljs-comment">/* ... */</span></span> }; <span class="hljs-comment"><span class="hljs-comment">/* ...is set when switching to the next processing stage */</span></span> r-&gt;read_event_handler = ngx_http_request_empty_handler; r-&gt;read_event_handler = ngx_http_block_reading; r-&gt;read_event_handler = ngx_http_test_reading; r-&gt;read_event_handler = ngx_http_discarded_request_body_handler; r-&gt;read_event_handler = ngx_http_read_client_request_body_handler; r-&gt;read_event_handler = ngx_http_upstream_rd_check_broken_connection; r-&gt;read_event_handler = ngx_http_upstream_read_request_handler;</code> </pre> <br><p>  Il existe une structure de demande, qui est transmise au gestionnaire d'événements lorsque le socket signale un accès en lecture ou en écriture.  De plus, ce gestionnaire bascule constamment au cours du programme en fonction de l'état du traitement de la demande.  Soit nous lisons les en-têtes, soit nous lisons le corps de la demande, soit nous demandons des données en amont - en général, il existe de nombreux états différents. </p><br><p>  Un tel code est difficile à lire car il est, en substance, décrit en termes de réaction aux événements.  Nous sommes dans tel ou tel état et réagissons d'une certaine manière aux événements qui se sont produits.  Il n'y a pas une image complète de l'ensemble du processus de traitement d'une demande HTTP. </p><br><p>  Une autre option, qui est souvent utilisée en JavaScript, consiste à créer du code basé sur le rappel lorsque nous transférons notre rappel à l'appel d'interface, dans lequel il existe généralement un autre rappel imbriqué pour un événement, etc. </p><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">int</span></span> LibuvStreamWrap::ReadStart() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> uv_read_start(stream(), [](<span class="hljs-keyword"><span class="hljs-keyword">uv_handle_t</span></span>* handle, <span class="hljs-keyword"><span class="hljs-keyword">size_t</span></span> suggested_size, <span class="hljs-keyword"><span class="hljs-keyword">uv_buf_t</span></span>* buf) { <span class="hljs-keyword"><span class="hljs-keyword">static_cast</span></span>&lt;LibuvStreamWrap*&gt;(handle-&gt;data)-&gt;OnUvAlloc(suggested_size, buf); }, [](<span class="hljs-keyword"><span class="hljs-keyword">uv_stream_t</span></span>* stream, <span class="hljs-keyword"><span class="hljs-keyword">ssize_t</span></span> nread, <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">uv_buf_t</span></span>* buf) { <span class="hljs-keyword"><span class="hljs-keyword">static_cast</span></span>&lt;LibuvStreamWrap*&gt;(stream-&gt;data)-&gt;OnUvRead(nread, buf); }); } <span class="hljs-comment"><span class="hljs-comment">/* ...for example, parsing http... */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (p=data; p != data + len; p++) { ch = *p; reexecute: <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> (CURRENT_STATE()) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> s_start_req_or_res: <span class="hljs-comment"><span class="hljs-comment">/*... */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> s_res_or_resp_H: <span class="hljs-comment"><span class="hljs-comment">/*... */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> s_res_HT: <span class="hljs-comment"><span class="hljs-comment">/*... */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> s_res_HTT: <span class="hljs-comment"><span class="hljs-comment">/* ... */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> s_res_HTTP: <span class="hljs-comment"><span class="hljs-comment">/* ... */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> s_res_http_major: <span class="hljs-comment"><span class="hljs-comment">/*... */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> s_res_http_dot: <span class="hljs-comment"><span class="hljs-comment">/*... */</span></span> <span class="hljs-comment"><span class="hljs-comment">/* ... */</span></span></code> </pre> <br><p>  Le code est à nouveau très fragmenté, il n'y a aucune compréhension de l'état actuel de la façon dont nous travaillons sur la demande.  De nombreuses informations sont transmises par le biais de fermetures, et vous devez faire des efforts mentaux pour reconstruire la logique de traitement d'une seule demande. </p><br><p>  Ainsi, en introduisant le multitâche dans notre code (la logique de choisir les tâches de travail et de les multiplexer), nous obtenons un code efficace et un contrôle sur la priorisation des tâches, mais nous en perdons beaucoup en lisibilité.  Ce code est difficile à lire et difficile à maintenir. </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/da5/a8a/151/da5a8a1517fb18945a330ae4c2b6d722.png"></p><br><p>  Pourquoi?  Supposons que j'ai un cas simple, par exemple, je lis un fichier et le transfère sur le réseau.  Dans une version non bloquante, ce cas correspondra à une telle machine à états linéaires: </p><br><ul><li>  État initial </li><li>  Commencez à lire un fichier, </li><li>  En attente d'une réponse du système de fichiers, </li><li>  Ecrire un fichier sur un socket, </li><li>  État final. </li></ul><br><p>  Supposons maintenant que je souhaite ajouter des informations de la base de données à ce fichier.  Une option simple: </p><br><ul><li>  état initial </li><li>  lire un fichier </li><li>  lire le dossier </li><li>  lecture de la base de données </li><li>  lire à partir de la base de données, </li><li>  Je travaille avec une prise </li><li>  écrit sur la prise. </li></ul><br><p>  Cela ressemble à un code linéaire, mais le nombre d'états a augmenté. </p><br><p>  Ensuite, vous commencez à penser qu'il serait bien de paralléliser les deux étapes - la lecture d'un fichier et d'une base de données.  Les miracles de la combinatoire commencent: vous êtes dans l'état initial, vous demandez à lire le fichier et les données de la base de données.  Ensuite, vous pouvez soit arriver à un état où il y a des données de la base de données, mais il n'y a pas de fichier, ou vice versa - il y a des données du fichier, mais pas de la base de données.  Ensuite, vous devez entrer dans un état où vous avez l'une des deux choses.  Encore une fois, ce sont deux États.  Ensuite, vous devez entrer dans un état où vous avez les deux ingrédients.  Ensuite, écrivez-les dans la prise et ainsi de suite. </p><br><p>  Plus l'application est complexe, plus il y a d'états, plus il y a de fragments de code à combiner dans votre tête.  Inopportunément.  Ou vous écrivez des nouilles de rappel, ce qui n'est pas pratique à lire.  Si un système de branchement est écrit, il arrive un jour où vous ne pouvez plus le tolérer. </p><br><a name="section5"></a><br><h1 id="5-futurespromises">  5. Futures / promesses </h1><br><p><img src="https://habrastorage.org/getpro/habr/post_images/f93/0ea/b0a/f930eab0a9a5556b0db5d21f23d98190.png"></p><br><p>  Pour résoudre le problème, vous devez regarder la situation plus facilement. </p><br><p><img src="https://habrastorage.org/webt/-v/6e/gb/-v6egbslm8_jjhwcsevjffbe35s.png"></p><br><p>  Il y a un programme, il a des cercles noirs et rouges.  Notre flux d'exécution est constitué de cercles noirs;  parfois ils sont alternés avec du rouge lorsque le flux ne peut pas continuer son travail.  Le problème est que pour notre fil d'exécution noir, vous devez entrer dans le prochain cercle noir, qui ne sera pas connu quand. </p><br><p>  Le problème est que lorsque nous écrivons du code dans un langage de programmation, nous expliquons à l'ordinateur ce qu'il faut faire maintenant.  Un ordinateur est une chose relativement simple qui attend des instructions que nous écrivons dans le langage de programmation.  Elle attend des instructions pour le prochain cercle, et dans notre langage de programmation, il n'y a pas assez d'argent pour dire: "À l'avenir, s'il se passe quelque chose, fais quelque chose." </p><br><p><img src="https://habrastorage.org/webt/vp/8f/mx/vp8fmxhtnkukhqym-baw3g4mzyg.png"></p><br><p>  Dans un langage de programmation, nous opérons avec des actions momentanées compréhensibles: appel d'une fonction, opérations arithmétiques, etc.  Ils décrivent la prochaine étape suivante spécifique.  Dans le même temps, pour traiter la logique d'application, il est nécessaire de décrire non pas la prochaine étape physique, mais la prochaine étape logique: que devons-nous faire lorsque des données de la base de données apparaissent, par exemple. </p><br><p><img src="https://habrastorage.org/webt/6m/by/ma/6mbyma_pagz74dx-j2ch1ixpxpg.png"></p><br><p>  Par conséquent, nous avons besoin d'un mécanisme pour combiner ces fragments.  Dans le cas où nous avons écrit du code synchrone, nous avons complètement caché la question sous le capot et déclaré que le système d'exploitation allait s'en occuper, lui permettre d'interrompre et de replanifier nos threads. </p><br><p>  Au niveau 1, nous avons ouvert cette boîte de Pandore, et cela a apporté beaucoup de commutateurs, de cas, de conditions, de branches, d'états au code.  Je voudrais un compromis pour que le code soit relativement lisible, mais conserve tous les avantages du niveau 1. </p><br><p>  Heureusement pour nous, en 1988, les personnes impliquées dans les systèmes distribués, Barbara Liskov et Lyub Shirir, ont réalisé le problème et sont venues au besoin de changements linguistiques.  Il est nécessaire d'ajouter au langage de programmation des constructions qui permettent d'exprimer des relations temporelles entre les événements - au moment présent dans le temps et à un moment incertain dans le futur. </p><br><p>  Ce sont des promesses.  Le concept est cool, mais il accumule de la poussière sur une étagère depuis vingt ans.<font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Récemment, il a gagné en intérêt - par exemple, des camarades sur Twitter, lorsqu'ils ont refactorisé leur code de Ruby on Rails à Scala, ont imprégné ce concept assez profondément et ont décidé que tous les services seraient une fonction qui prend une demande et renvoie une réponse future. </font><font style="vertical-align: inherit;">Vous pouvez lire l'article Votre serveur en tant que fonction. </font><font style="vertical-align: inherit;">Un concept très cohérent, qui leur a permis de restructurer très rapidement l'ensemble du code.</font></font></p><br><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Mais c'est Scala, mais que devons-nous faire, les développeurs C ++? </font></font></p><br><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nous avons besoin d'une certaine abstraction, appelons-la Future. </font><font style="vertical-align: inherit;">Il s'agit d'un conteneur pour une valeur de type T avec la sémantique suivante: en ce moment, la valeur dans le conteneur peut être absente, mais dans le futur elle apparaîtra.</font></font></p><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">template</span></span> &lt;<span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">T</span></span></span><span class="hljs-class">&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Future</span></span></span><span class="hljs-class"> &lt;T&gt;</span></span></code> </pre> <br><p>         ,    ,  ,     .   ,   «»,  ,      .     Future     «»,  Promise —  «».        ;  ,  JavaScript, Promise —      ,   Java –   Future. </p><br><p>   ,     .     ,       ,     boost::future ( std::future) —      ,     . </p><br><a name="section5-1"></a><br><h2 id="51-interfeys-future--promise">  5.1.  Future &amp; Promise </h2><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">template</span></span> &lt;<span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">T</span></span></span><span class="hljs-class">&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Future</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">IsSet</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">const</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">const</span></span></span><span class="hljs-function"> T&amp; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Get</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">const</span></span></span></span>; <span class="hljs-function"><span class="hljs-function">T* </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">TryGet</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">const</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Subscribe</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-params"><span class="hljs-built_in">std</span></span></span></span><span class="hljs-function"><span class="hljs-params">::function&lt;</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> T&amp;)&gt; cb)</span></span></span></span>; <span class="hljs-keyword"><span class="hljs-keyword">template</span></span> &lt;<span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">R</span></span></span><span class="hljs-class">&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Future</span></span></span><span class="hljs-class">&lt;R&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Then</span></span></span><span class="hljs-class">( </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">std</span></span></span><span class="hljs-class">:</span></span>:function&lt;R(<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> T&amp;)&gt; f); <span class="hljs-keyword"><span class="hljs-keyword">template</span></span> &lt;<span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">R</span></span></span><span class="hljs-class">&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Future</span></span></span><span class="hljs-class">&lt;R&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Then</span></span></span><span class="hljs-class">( </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">std</span></span></span><span class="hljs-class">:</span></span>:function&lt;Future&lt;R&gt;(<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> T&amp;)&gt; f); }; <span class="hljs-keyword"><span class="hljs-keyword">template</span></span> &lt;<span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">T</span></span></span><span class="hljs-class">&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Future</span></span></span><span class="hljs-class">&lt;T&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MakeFuture</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">const</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">T</span></span></span><span class="hljs-class">&amp; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">value</span></span></span><span class="hljs-class">);</span></span></code> </pre> <br><p>  , ,  - ,      .  , ,      ,   . ,      ,       —   ,   ,   .       Then,      . </p><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">template</span></span> &lt;<span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">T</span></span></span><span class="hljs-class">&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Promise</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">IsSet</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">const</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Set</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> T&amp; value)</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">TrySet</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> T&amp; value)</span></span></span></span>; Future&lt;T&gt; ToFuture() <span class="hljs-keyword"><span class="hljs-keyword">const</span></span>; }; <span class="hljs-keyword"><span class="hljs-keyword">template</span></span> &lt;<span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">T</span></span></span><span class="hljs-class">&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Promise</span></span></span><span class="hljs-class">&lt;T&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">NewPromise</span></span></span><span class="hljs-class">();</span></span></code> </pre> <br><p>   .      ,       .    «, , ,      ». </p><br><a name="section5-2"></a><br><h2 id="52-kompoziciya-vychisleniy">  5.2.   </h2><br><p><img src="https://habrastorage.org/getpro/habr/post_images/676/e68/6b7/676e686b75c6875ba0a914567bc46839.png"></p><br><p>    ?  ,         .  Then —  ,      . </p><br><p> ,      — future --,     -  t —       .    , ,   ,        f,  -     r. </p><br><p>          t     f.        ,  ,      r. </p><br><p>   :    t,      ,   r      .       : </p><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">template</span></span> &lt;<span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">T</span></span></span><span class="hljs-class">&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">template</span></span></span><span class="hljs-class"> &lt;class R&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Future</span></span></span><span class="hljs-class">&lt;R&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Future</span></span></span><span class="hljs-class">&lt;T&gt;:</span></span>:Then(<span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::function&lt;R(<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> T&amp;)&gt; f) { <span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> promise = NewPromise&lt;R&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>-&gt;Subscribe([promise] (<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> T&amp; t) { <span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> r = f(t); promise.Set(r); }); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> promise.ToFuture(); }</code> </pre> <br><p>  : </p><br><ul><li>  <code>Promise</code>  <code>R</code> , </li><li>    <code>Future&lt;T&gt;</code>    <code>t</code> , </li><li>   ,    <code>r = f(t)</code> , </li><li>  <code>r</code>   <code>Promise</code> , </li><li>      <code>Promise</code> . </li></ul><br><p>      <code>f</code> ,     <code>R</code> ,  <code>Future&lt;R&gt;</code> ,         <code>R</code> .  : </p><br><ul><li>          <code>T</code> , </li><li>  ,     <code>T</code> ,  ,      <code>R</code> , </li><li>     ,      <code>R</code> ,    ,        . </li></ul><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">template</span></span> &lt;<span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">T</span></span></span><span class="hljs-class">&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">template</span></span></span><span class="hljs-class"> &lt;class R&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Future</span></span></span><span class="hljs-class">&lt;R&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Future</span></span></span><span class="hljs-class">&lt;T&gt;:</span></span>:Then(<span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::function&lt;Future&lt;R&gt;(<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> T&amp;)&gt; f) { <span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> promise = NewPromise&lt;R&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>-&gt;Subscribe([promise] (<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> T&amp; t) { <span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> that = f(t); that.Subscribe([promise] (R r) { promise.Set(r); }); }); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> promise.ToFuture(); }</code> </pre> <br><p>        ,   -    t.        f,        r,    .    ,       ,   . </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/3c6/92f/064/3c692f06489d41c745a0d1b51085b278.png"></p><br><p>    ,    Then   : </p><br><ul><li>   <code>Promise</code> , </li><li>  <code>Subscribe</code>   -, </li><li>  <code>Promise</code> ,   <code>Future</code> . </li></ul><br><p>      ,       .    ,       ,    ,            . </p><br><p>     ,   ,          ,     -.   ,  ,   -,   Subscribe.       ,    ,   ,  -  .   ,    . </p><br><a name="section5-3"></a><br><h2 id="53-primery">  5.3.  Des exemples </h2><br><p>       AsyncComputeValue,      GPU,        .   Then,    ,        (2v+1) <sup>2</sup> . </p><br><pre> <code class="cpp hljs">Future&lt;<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>&gt; value = AsyncComputeValue(); <span class="hljs-comment"><span class="hljs-comment">//    value.Subscribe([] (int v) { std::cerr &lt;&lt; "Value is: " &lt;&lt; v &lt;&lt; std::endl; });</span></span></code> </pre> <br><p>      .  ,    :   (2v+1) <sup>2</sup>       .       ,            . </p><br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">//  (2v+1)^2 Future&lt;int&gt; anotherValue = value .Then([] (int v) { return 2 * v; }) .Then([] (int u) { return u + 1; }) .Then([] (int w) { return w * w; });</span></span></code> </pre> <br><p>     ,     ,       .       . </p><br><p>  .   :   ,       ;       ;       . </p><br><pre> <code class="cpp hljs">Future&lt;<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>&gt; GetDbKey(); Future&lt;<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>&gt; LoadDbValue(<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> key); Future&lt;<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>&gt; SendToMars(<span class="hljs-built_in"><span class="hljs-built_in">string</span></span> message); Future&lt;<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>&gt; ExploreOuterSpace() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> GetDbKey() <span class="hljs-comment"><span class="hljs-comment">// Future&lt;int&gt; .Then(&amp;LoadDbValue) // Future&lt;string&gt; .Then(&amp;SendToMars); // Future&lt;void&gt; } ExploreOuterSpace().Subscribe( [] () { std::cout &lt;&lt; "Mission Complete!" &lt;&lt; std::endl; });</span></span></code> </pre> <br><p>         — ExploreOuterSpace.           Then;    —    —    ,     .         ( ) .      . </p><br><a name="section5-4"></a><br><h2 id="54-any-kombinator">  5.4. Any- </h2><br><p>  :     <code>Future</code>    ,       ,      . ,  ,          : </p><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">template</span></span> &lt;<span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">T</span></span></span><span class="hljs-class">&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Future</span></span></span><span class="hljs-class">&lt;T&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Any</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Future</span></span></span><span class="hljs-class">&lt;T&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">f1</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Future</span></span></span><span class="hljs-class">&lt;T&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">f2</span></span></span><span class="hljs-class">) {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> promise = NewPromise&lt;T&gt;(); f1.Subscribe([promise] (<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> T&amp; t) { promise.TrySet(t); }); f2.Subscribe([promise] (<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> T&amp; t) { promise.TrySet(t); }); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> promise.ToFuture(); } <span class="hljs-comment"><span class="hljs-comment">//    </span></span></code> </pre> <br><p>   ,      Any-,      Future  :   ,   .      ,    ,  . </p><br><p>   ,  ,       ,     ,  ,    .      «   DB1,    DB2,        —  - ». </p><br><a name="section5-5"></a><br><h2 id="55-all-kombinator">  5.5. All- </h2><br><p>    .                  ,       ,  ,     ( T1  T2),    T1  T2   ,        ,   . </p><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">template</span></span> &lt;<span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">T1</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">T2</span></span></span><span class="hljs-class">&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Future</span></span></span><span class="hljs-class">&lt;std::tuple&lt;T1, T2&gt;&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">All</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Future</span></span></span><span class="hljs-class">&lt;T1&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">f1</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Future</span></span></span><span class="hljs-class">&lt;T2&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">f2</span></span></span><span class="hljs-class">) {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> promise = NewPromise&lt;<span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::tuple&lt;T1, T2&gt;&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> result = <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::make_shared&lt; <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::tuple&lt;T1, T2&gt; &gt;(); <span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> counter = <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::make_shared&lt; <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::atomic&lt;<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>&gt; &gt;(<span class="hljs-number"><span class="hljs-number">2</span></span>); f1.Subscribe([promise, result, counter] (<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> T1&amp; t1) { <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::get&lt;<span class="hljs-number"><span class="hljs-number">0</span></span>&gt;(*result) = t1; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (--(*counter) == <span class="hljs-number"><span class="hljs-number">0</span></span>) { promise.Set(*result)); } }); f2.Subscribe([promise, result, counter] (<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> T2&amp; t2) { <span class="hljs-comment"><span class="hljs-comment">/*  */</span></span> } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> promise.ToFuture(); } <span class="hljs-comment"><span class="hljs-comment">//    </span></span></code> </pre> <br><p>    nginx.   ,      ,        .     nginx    « », «  », «    »   .  All-         ,     .      . </p><br><a name="section5-6"></a><br><h2 id="56-adaptaciya-obratnogo-vyzova">  5.6.    </h2><br><p>   Future  Promises —     legacy-,   .     callback-    ,     ,   :   Future,     ,   callback-  Future. </p><br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">//   cb     void LegacyAsyncComputeStuff(std::function&lt;void(int)&gt; cb); //      Future Future&lt;int&gt; ModernAsyncComputeStuff() { auto promise = NewPromise&lt;int&gt;(); LegacyAsyncComputeStuff( [promise] (int value) { promise.Set(value); }); return promise.ToFuture(); }</span></span></code> </pre> <br><p> :      ,              Future  . </p><br><a name="section6"></a><br><h1 id="6-kak-sdelat-kod-chitaemee-s-pomoschyu-korutin"> 6.        </h1><br><p><img src="https://habrastorage.org/getpro/habr/post_images/19a/093/212/19a093212125673ff89cc4196c59583a.png"></p><br><p>   ,     ,     .  . </p><br><pre> <code class="cpp hljs">Future&lt;Request&gt; GetRequest(); Future&lt;Payload&gt; QueryBackend(Request req); Future&lt;Response&gt; HandlePayload(Payload pld); Future&lt;<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>&gt; Reply(Request req, Response rsp); <span class="hljs-comment"><span class="hljs-comment">// req  2 :  QueryBackend   Reply GetRequest().Subscribe( [] (Request req) { auto rsp = QueryBackend(req) .Then(&amp;HandlePayload) .Then(Bind(&amp;Reply, req)); });</span></span></code> </pre> <br><p>      .    Request,   -   .  ,     .  ,   ,        ,    .  ,   -      . </p><br><p>  ,  ,     .  ?   —  ,    request  payload,     —  ,      . </p><br><p> ,   Java   Netty. ,      ,        .  ,        ,    . </p><br><p>      ,    GetRequest, QueryBackend, HandlePayload   Reply   ,     Future. </p><br><p>     ,   ,   Future   T —   WaitFor. <br></p><pre> <code class="cpp hljs">Future&lt;Request&gt; GetRequest(); Future&lt;Payload&gt; QueryBackend(Request req); Future&lt;Response&gt; HandlePayload(Payload pld); Future&lt;<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>&gt; Reply(Request req, Response rsp); <span class="hljs-keyword"><span class="hljs-keyword">template</span></span> &lt;<span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">T</span></span></span><span class="hljs-class">&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">T</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WaitFor</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Future</span></span></span><span class="hljs-class">&lt;T&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">future</span></span></span><span class="hljs-class">);</span></span> <span class="hljs-comment"><span class="hljs-comment">// req  2 :  QueryBackend   Reply GetRequest().Subscribe( [] (Request req) { auto rsp = QueryBackend(req) .Then(&amp;HandlePayload) .Then(Bind(&amp;Reply, req)); });</span></span></code> </pre> <br><p>      : </p><br><pre> <code class="cpp hljs">Future&lt;Request&gt; GetRequest(); Future&lt;Payload&gt; QueryBackend(Request req); Future&lt;Response&gt; HandlePayload(Payload pld); Future&lt;<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>&gt; Reply(Request req, Response rsp); <span class="hljs-keyword"><span class="hljs-keyword">template</span></span> &lt;<span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">T</span></span></span><span class="hljs-class">&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">T</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WaitFor</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Future</span></span></span><span class="hljs-class">&lt;T&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">future</span></span></span><span class="hljs-class">);</span></span> <span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> req = WaitFor(GetRequest()); <span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> pld = WaitFor(QueryBackend(req)); <span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> rsp = WaitFor(HandlePayload(pld)); WaitFor(Reply(req, rsp));</code> </pre> <br><p>   :    Future,    .    .         ,    .      . </p><br><p>     .                    .     -  0,     ,  , mutex+cvar  future.        .          ,     . </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/99d/f77/3e4/99df773e4d1922427ab7dc98fde28b8f.png"></p><br><a name="section6-1"></a><br><h2 id="61-korutiny"> 6.1.  </h2><br><p>  ,        .        ,  ,     ,   ,    - ,   .     ,    <i>-</i> . </p><br><p>       — «»      ,  ,    .       .     .  : boost::asio  boost::fiber. </p><br><p>         ,                .  Comment faire </p><br><a name="section6-2"></a><br><h2 id="62-chernovik-realizacii-waitfor">  6.2.   WaitFor </h2><br><p>   , , boost::context,        :  ,   ;  ,              .    x86/64       ,       ,         . </p><br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">//      class MachineContext; //     from,    to void SwitchContext(MachineContext* from, MachineContext* to); //      – boost::context //    // * x86_64-ASM (push...-movq(rsp,eip)-pop...-jmpq) // * makecontext/swapcontext // * setjmp/longjmp</span></span></code> </pre> <br><p>      ,       goto:    ,     ,        ,   . </p><br><p>      ,  -   .     Fiber —   .       +Future.  ,      ,         Future,    . </p><br><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Fiber</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-comment"><span class="hljs-comment">/*    */</span></span> MachineContext context_; Future&lt;<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>&gt; future_; };</code> </pre> <br><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Scheduler</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-comment"><span class="hljs-comment">/*    */</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">WaitFor</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Future&lt;</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params">&gt; future)</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Loop</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; MachineContext loop_context_; Fiber* current_fiber_; <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">deque</span></span>&lt;Fiber*&gt; run_queue_; };</code> </pre> <br><p>  Future   ,     ,    ,     .    :   Loop,      ,    ,   ,        ,    . </p><br><p>     WaitFor? </p><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">thread_local</span></span> Scheduler* ThisScheduler; <span class="hljs-keyword"><span class="hljs-keyword">template</span></span> &lt;<span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">T</span></span></span><span class="hljs-class">&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">T</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WaitFor</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Future</span></span></span><span class="hljs-class">&lt;T&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">future</span></span></span><span class="hljs-class">) {</span></span> ThisScheduler-&gt;WaitFor(future.As&lt;<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>&gt;()); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> future.Get(); } <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> Scheduler::WaitFor(Future&lt;<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>&gt; future) { current_fiber_-&gt;future_ = future; SwitchContext(¤t_fiber_-&gt;context_, &amp;loop_context_); }</code> </pre> <br><p>   :  ,   -   ,      ,      Future  void,        .           . </p><br><p>  <code>Future&lt;void&gt;</code>   ,     ,    -  . </p><br><p>   WaitFor    :   : «     Fiber   Future»,        ( )       . </p><br><p>  ,        : <br> <code>ThisScheduler-&gt;WaitFor</code>  <code>return future.Get()</code> ,         . </p><br><p>      ?  ,       Future,      . </p><br><a name="section6-3"></a><br><h2 id="63-kak-ustroen-cikl-planirovaniya">  6.3.     </h2><br><p>   -  , ,    ,     -     ,    .    SwitchContext   ,    2 —       . </p><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> Scheduler::Loop() { <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (<span class="hljs-literal"><span class="hljs-literal">true</span></span>) { <span class="hljs-comment"><span class="hljs-comment">// (1)     (= !) current_fiber_ = run_queue_.front(); run_queue_.pop_front(); SwitchContext(&amp;loop_context_, ¤t_fiber_-&gt;context_); // (2) ,      //…</span></span></code> </pre> <br><p>   ?   ,   ,    ,     Future,       Future, ,     ,           . </p><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> Scheduler::Loop() { <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (<span class="hljs-literal"><span class="hljs-literal">true</span></span>) { <span class="hljs-comment"><span class="hljs-comment">// (1)     … // (2) ,      if (current_fiber_-&gt;future_) { current_fiber_-&gt;future_.Subscribe( [this, fiber = current_fiber_] { fiber-&gt;future_ = nullptr; run_queue_.push_back(fiber); }); } //…</span></span></code> </pre> <br><p>   ,      .       : </p><br><p>     WaitFor —   . </p><br><p><img src="https://habrastorage.org/webt/_4/m8/ao/_4m8aoag2egfc2mzczah2xf6a9i.png"></p><br><p>    Switch-    . </p><br><p><img src="https://habrastorage.org/webt/sa/hg/kz/sahgkzqleux5-htiqo-58lb0gua.png"></p><br><p>     Future    (  ),   ,         .   -               Fiber. </p><br><p><img src="https://habrastorage.org/webt/hg/cm/gc/hgcmgclv5raicu_tlfywmw0yrpi.png"></p><br><p>   WaitFor     Future ,     - , Future  .     : </p><br><pre> <code class="cpp hljs">Future&lt;Request&gt; GetRequest(); Future&lt;Payload&gt; QueryBackend(Request req); Future&lt;Response&gt; HandlePayload(Payload pld); Future&lt;<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>&gt; Reply(Request req, Response rsp); <span class="hljs-keyword"><span class="hljs-keyword">template</span></span> &lt;<span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">T</span></span></span><span class="hljs-class">&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">T</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WaitFor</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Future</span></span></span><span class="hljs-class">&lt;T&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">future</span></span></span><span class="hljs-class">);</span></span> <span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> req = WaitFor( GetRequest()); <span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> pld = WaitFor( QueryBackend(req)); <span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> rsp = WaitFor( HandlePayload(pld)); WaitFor( Reply(req, rsp));</code> </pre> <br><p>    ,    ,      ,   .         ,    ,    . </p><br><a name="section6-4"></a><br><h2 id="64-coroutine-ts">  6.4. Coroutine TS </h2><br><p>    ?   — .   Coroutine TS,        ,  WaitFor  CoroutineWait,    CoroutineTS —  -  .     ,         - . ,    Waiter  Co,     ,    . </p><br><a name="section7"></a><br><h1 id="7-chto-poluchili"> 7.  ? </h1><br><p>   .           ,   ,    ,    .     ,       ,     ,    . </p><br><p>     —  .    ,                  .       .     ,     . ,         ,        ,         ,      . </p><br><p>       -    ,        ,               .    ,  .      ,                ,          . </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/e02/3b7/924/e023b79240490a7b561152aa0972b3ac.png"></p><br><p>         ,   ?    ,     . </p><br><p>   .       ,     ,   ,  ,      .       .       ,     ,     ,    ,    . </p><br><p>    nginx,  ,  ,  ,       ,    .        ,     ,  ,    future  promises. </p><br><p>     ,       ,    ,     ,       ,      ,      ,      . </p><br><p>       futures, promises  actors.    .             ,    . </p><br><p> :      , ,   ,     .               ,    , ,      ,   .     ? ,   . </p><br><blockquote>  Minute de publicité. 19-20      C++ Russia 2019.      , , Grimm Rainer    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">«Concurrency and parallelism in C++17 and C++20/23»</a> ,      <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">   C++</a> .      <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="> </a> ,    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="> </a> .  ,         ,    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">-</a> . </blockquote></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr446562/">https://habr.com/ru/post/fr446562/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr446550/index.html">Problèmes de modèle de coordinateur et qu'est-ce que RouteComposer a à voir avec cela</a></li>
<li><a href="../fr446552/index.html">Utilisation des commandes APDU à l'aide de l'exemple EToken</a></li>
<li><a href="../fr446554/index.html">Programme résident Yandex, ou Comment un back-end expérimenté devient ingénieur ML</a></li>
<li><a href="../fr446558/index.html">Structures de données exotiques: Merkle modifiée Patricia Trie</a></li>
<li><a href="../fr446560/index.html">"Courtesy Exchange": l'essence du conflit entre les deux sociétés de streaming les plus célèbres</a></li>
<li><a href="../fr446566/index.html">Project Zero. Comment Amazon veut gérer les contrefaçons</a></li>
<li><a href="../fr446568/index.html">Mise à jour CMS à grande échelle d'Umbraco 8: Quoi de neuf</a></li>
<li><a href="../fr446570/index.html">L'histoire du premier GPU: Rendition Vérité 1000</a></li>
<li><a href="../fr446572/index.html">Editor.js est un excellent éditeur qui enregistre le code source au format JSON</a></li>
<li><a href="../fr446576/index.html">Substitution à l'importation ou comment les hélicoptères russes ont fait quelque chose de mal</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>