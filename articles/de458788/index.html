<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🧛 🕋 🙅🏿 Benutzerdefinierte Vorlagen in GTM: ein Beispiel 👩🏿‍🔬 👃🏿 🏭</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Ende Mai hat Google im Google Tag Manager (GTM) eine neue Funktion eingeführt: Benutzerdefinierte Vorlagen oder benutzerdefinierte Vorlagen. Mal sehen...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Benutzerdefinierte Vorlagen in GTM: ein Beispiel</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/458788/">  Ende Mai hat Google im Google Tag Manager (GTM) eine neue Funktion eingeführt: Benutzerdefinierte Vorlagen oder benutzerdefinierte Vorlagen.  Mal sehen, warum es benötigt wird, wie es verwendet wird, was die Unterschiede zu HTML-Tags und JavaScript-Variablen sind. <br><br>  Erwägen Sie beispielsweise, eine benutzerdefinierte Vorlage für ein dynamisches Retargeting-Pixel von VKontakte zu erstellen und GTM-Tags darüber weiter anzupassen. <br><br><img src="https://habrastorage.org/webt/c-/62/zr/c-62zrfxks1t6c2gfsv0kn2brjm.png"><br><a name="habracut"></a><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Einfache Worte zu benutzerdefinierten Vorlagen</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Erstellen einer benutzerdefinierten Vorlage</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">• Registerkarte Info</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">• Registerkarte Felder</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">• Registerkarte Code</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">• Registerkarte Berechtigungen</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Anpassen und Testen des Tags in der erstellten benutzerdefinierten Vorlage</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">• Seitenaufruf</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">• AddToCart</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">• Bergbautest</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Fazit</a> <br><br><a name="1"></a><h2>  Einfache Worte zu benutzerdefinierten Vorlagen </h2><br>  Benutzerdefinierte Vorlagen sind Vorlagen, mit denen Benutzer neue Tags oder Variablen erstellen können.  GTM verfügt über vorgefertigte Vorlagen (im Abschnitt "Empfohlen" oder "Empfohlen"), z. B. das Google Analytics-Tag, Google Optimize und andere.  Jetzt können wir sie mit unseren Vorlagen ergänzen.  Nach der Erstellung werden sie auf der Registerkarte Benutzerdefiniert angezeigt: <br><br><img src="https://habrastorage.org/webt/nx/q_/mu/nxq_mu_uxl6tyiumnl8xbzt6o2c.png"><br><br>  Der Hauptunterschied zu HTML-Tags und JS-Variablen besteht darin, dass ein Benutzer beim Erstellen eines Tags oder einer Variablen gemäß einer vorgefertigten Vorlage nicht mit JS-Code interagiert. <br><br>  Der Code für die Benutzervorlage wird vom Entwickler oder Webanalysten in der Phase ihrer Erstellung geschrieben.  Wenn Sie dann ein Tag oder eine Variable gemäß einer Benutzervorlage erstellen, wird die gesamte Interaktion über die Schnittstelle ausgeführt (die auch beim Erstellen einer Benutzervorlage konfiguriert wird): <br><br><img src="https://habrastorage.org/webt/pe/e2/te/pee2tevqbahm_nplbfgj0btis34.png"><br><br>  Dementsprechend wird das Anpassen eines Tags oder einer Variablen gemäß einer Benutzervorlage im Vergleich zum Schreiben eines HTML-Tags oder einer JS-Variablen um eine Größenordnung einfacher, da dies keine Kenntnisse und Fähigkeiten in der Arbeit mit JavaScript erfordert. <br><br>  Ein weiteres großes Plus an benutzerdefinierten Vorlagen besteht darin, dass die Wahrscheinlichkeit, eine Site zu "platzieren", aufgrund eines Fehlers im JS-Code des Tags um eine Größenordnung verringert wird. <br><br>  In unserem Beispiel müssen Sie zum Konfigurieren des dynamischen Retargeting-Tags "VKontakte" nicht mehr mit den Entwicklern Kontakt aufnehmen. Alles kann unabhängig eingerichtet werden, auch die Übertragung von Daten über Waren (mit dem auf der Website konfigurierten erweiterten Google E-Commerce), der nur Erfahrung mit GTM hat. <br><br><a name="2"></a><h2>  Erstellen einer benutzerdefinierten Vorlage </h2><br>  Da wir eine Tag-Vorlage erstellen, müssen wir zum Abschnitt Vorlagen gehen und im Abschnitt Tag-Vorlagen auf die Schaltfläche Neu klicken. <br><br><img src="https://habrastorage.org/webt/ca/bt/sa/cabtsaamxy-zoglccqgvt1v_tra.png"><br><br>  Danach öffnet sich der Vorlageneditor: <br><br><img src="https://habrastorage.org/webt/bf/c3/jf/bfc3jf2xgpkasmc3qvik2tp4wxy.png"><br><br>  Im linken Teil des Editors befindet sich ein Einstellungsfenster, im rechten Teil ein Vorschaufenster und eine Konsole.  Das Einstellungsfenster enthält vier Registerkarten, die zum Erstellen und Arbeiten mit der Vorlage erforderlich sind. <br><br><a name="3"></a><h3>  Registerkarte "Info" </h3><br>  Auf dieser Registerkarte werden Informationen zum Tag angezeigt: Name, Beschreibung, Symbol.  Dies sind die Informationen, die beim Erstellen eines neuen Tags in der Liste der Vorlagen angezeigt werden: <br><br><img src="https://habrastorage.org/webt/dd/nm/9f/ddnm9fvcygh2ob6jzkliccqgi1o.png"><br><br>  Für das Tag-Symbol gelten folgende Anforderungen: PNG-, JPEG- oder GIF-Format, eine Auflösung von mindestens 64 x 64 Pixel und eine Größe von nicht mehr als 50 KB. <br><br><a name="4"></a><h3>  Registerkarte "Felder" </h3><br>  Dieser Abschnitt erstellt die Schnittstelle unserer Vorlage.  Die Benutzeroberfläche besteht aus verschiedenen Feldern und Formularen, mit denen der Benutzer beim Erstellen eines neuen Tags oder einer neuen Variablen interagiert. <br><br>  In Zukunft werden die Informationen, die der Benutzer beim Erstellen des Tags über die Schnittstelle eingegeben hat, im Vorlagencode verwendet. <br><br>  Um ein neues Element hinzuzufügen, klicken Sie auf die Schaltfläche Feld hinzufügen.  Das Fenster zur Auswahl des Elementtyps wird angezeigt: <br><br><img src="https://habrastorage.org/webt/g5/ko/d7/g5kod7ox7dal761180kpdfhojto.png"><br><br>  Mit GTM können Sie die folgenden Arten von Schnittstellenelementen auswählen: <br><br><ul><li>  <b>Textfeld</b> </li><li>  <b>Dropdown-Menü</b> </li><li>  <b>Kontrollkästchen</b> ; </li><li>  <b>Schalter</b> </li><li>  <b>einfache Tabelle</b> , hier können Sie jede Zelle bearbeiten. </li><li>  <b>erweiterte Tabelle</b> , Sie können nur eine Zeile bearbeiten. Diese Art von Tabelle ist praktisch, um ein Wörterbuch aus Schlüssel-Wert-Paaren zu erstellen. </li><li>  <b>Gruppe von Elementen</b> , ermöglicht es Ihnen, mehrere Typen in einer Gruppe zu gruppieren; </li><li>  <b>Die Verknüpfung wird</b> verwendet, um der Benutzeroberfläche Text hinzuzufügen. Der Benutzer muss keine Daten eingeben. </li></ul><br>  Nachdem Sie ein Element hinzugefügt haben, müssen Sie ihm einen Anzeigenamen geben, der dann im Code verwendet wird.  Dies ist eine Art Variablenname - er sollte verständlich sein und die Essenz des erstellten Schnittstellenelements offenbaren.  Beispielsweise bedeutet der Name "ID" nichts Bestimmtes, aber der Name "pixelIDs" zeigt bereits an, dass die vom Benutzer eingegebenen Pixel-IDs in diesem Element gespeichert sind: <br><br><img src="https://habrastorage.org/webt/fv/1h/ht/fv1hht_iaatbuhi1ejovajkehhc.png"><br><br>  Gehen Sie als Nächstes zu den Einstellungen der einzelnen Elemente und aktivieren Sie die erforderlichen Eigenschaften. <br>  In verschiedenen Situationen sind unterschiedliche Eigenschaften des Schnittstellenelements erforderlich, daher sind sie standardmäßig alle ausgeblendet, und wir müssen diejenigen aktivieren, die jetzt benötigt werden: <br><br><img src="https://habrastorage.org/webt/ah/jx/o1/ahjxo1oz0w8fp6pntytshfs1y_o.png"><br><br>  Für verschiedene Arten von Elementen unterscheiden sich die verfügbaren Eigenschaften. Ich werde die am häufigsten verwendeten angeben, bei denen es sich fast ausschließlich um Elemente handelt: <br><br>  <b>1. Anzeigename</b> .  Dies ist der Name, den der Benutzer beim Erstellen des Tags in der Benutzeroberfläche sieht: <br><br><img src="https://habrastorage.org/webt/jf/lk/-g/jflk-glzt0dahft6vpdx9qrzy8q.png"><br><br>  <b>2. Beispielwert</b> .  Dies ist ein Hinweis für den Benutzer, welche Werte in das Feld eingegeben werden sollen: <br><br><img src="https://habrastorage.org/webt/b6/zz/sc/b6zzscielm1pjho74x22rk88c0c.png"><br><br>  <b>3. Hilfetext</b> .  Dies ist der Text, den der Benutzer sehen wird, wenn er mit der Maus über das Hilfesymbol des Elements fährt: <br><br><img src="https://habrastorage.org/webt/nv/wo/qr/nvwoqraide7hp-qrbdjaomwvg3e.png"><br><br>  <b>4. Regeln für die Datenüberprüfung</b> .  In dieser Eigenschaft können Sie bestimmte Regeln für die Überprüfung der vom Benutzer in das Feld eingegebenen Daten und gegebenenfalls den Fehlertext festlegen, der angezeigt wird, wenn Sie versuchen, ein Tag mit Daten zu speichern, die den Test nicht bestanden haben. <br><br>  Sie können beispielsweise festlegen, dass das Feld ausgefüllt werden muss.  Das zweite Beispiel: Sie müssen eine E-Mail-Adresse vom Benutzer erhalten, dann können Sie überprüfen, ob die vom Benutzer eingegebenen Daten mit dem regulären Ausdruck übereinstimmen müssen <b>. * @. * \ .. *</b> . <br><br><img src="https://habrastorage.org/webt/3s/ma/pb/3smapbl1aorsc4fsvhwpd-1oy4m.png"><br><br>  Um den Fehlertext anzugeben, der angezeigt wird, wenn die eingegebenen Daten nicht den Überprüfungsregeln entsprechen, müssen Sie die erweiterten Regeleinstellungen aktivieren: <br><br><img src="https://habrastorage.org/webt/kb/zw/qr/kbzwqr32irigkreu9bbht9fxf1m.png"><br><br><img src="https://habrastorage.org/webt/ek/xh/hg/ekxhhgobsta59wpr6uxsbaqzdwg.png"><br><br>  In den erweiterten Einstellungen können Sie auch die Bedingungen angeben, unter denen diese Regel aktiviert wird (Feld Enable Condition). <br><br>  <b>5. Einschlussbedingungen</b> .  Dies sind die Bedingungen, unter denen der Benutzer dieses Schnittstellenelement hat. <br><br>  Um die Vorlage beispielsweise nicht mit Schnittstellenelementen zu überladen, können Sie die erforderlichen Elemente anzeigen, wenn das Kontrollkästchen aktiviert ist.  Angenommen, ein Benutzer möchte die Übertragung von Produktdaten in einem Pixel konfigurieren (dies ist mit der auf der Website konfigurierten erweiterten Google E-Commerce-Website möglich), aktiviert das Kontrollkästchen "DataLayer zum Übertragen von Produktdaten verwenden" und nach dem Aktivieren des Kontrollkästchens werden Elemente in der Tag-Oberfläche angezeigt erforderlich, um eine solche Übertragung zu konfigurieren.  Wenn das Kontrollkästchen nicht aktiviert ist, befinden sich keine Elemente in der Benutzeroberfläche. <br><br><img src="https://habrastorage.org/webt/rp/ui/x_/rpuix__y-ya--_uat8taekcwpa0.png"><br><br>  Ich stelle fest, dass hier der Name des Elements angegeben werden muss, das ihm unmittelbar nach dem Hinzufügen zugewiesen werden musste. <br><br>  Wenn Sie Einstellungen hinzufügen und eine Benutzeroberfläche erstellen, können alle Änderungen sofort im Vorschaufenster angezeigt und getestet werden: <br><br><img src="https://habrastorage.org/webt/df/bl/l9/dfbll9mc0qvpwcxnbzzx-fbg71g.png"><br><br><a name="5"></a><h3>  Registerkarte "Code" </h3><br>  Diese Registerkarte ist ein Code-Editor. <br><br>  Der Code für benutzerdefinierte GTM-Vorlagen wird in abgespecktem JavaScript ES6 geschrieben und in einer isolierten Umgebung ausgeführt, in der die gesamte Kommunikation mit globalen Daten (dh direkt mit der Seite) über die API erfolgt.  Es gibt keine globalen Objekte wie Fenster oder Dokumente, auch nicht die üblichen Methoden.  Zum Beispiel Konstruktoren (neues Objekt und dergleichen), setTimeout, parseInt, delete usw.  - All dies funktioniert nicht in benutzerdefinierten Vorlagen. <br><br>  Dafür gibt es jedoch eine API.  Daher sollte das Schreiben von Code für benutzerdefinierte Vorlagen mit der Tatsache beginnen, dass wir die APIs definieren, die wir in unserem Code verwenden: <br><br><pre><code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">// API //     const copyFromWindow = require('copyFromWindow'); //     const setInWindow = require('setInWindow'); //      const injectScript = require('injectScript'); //    const callInWindow = require('callInWindow'); //  ,     ,    const makeTableMap = require('makeTableMap'); //   URL  const getUrl = require('getUrl'); //    const getQueryParameters = require('getQueryParameters'); //     const makeInteger = require('makeInteger'); //    const makeString = require('makeString'); //  setTimeout const callLater = require('callLater'); //  console.log const logToConsole = require('logToConsole');</span></span></code> </pre> <br>  In der <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Google Developer Help finden Sie eine</a> vollständige Liste der APIs mit detaillierter Dokumentation. <br><br>  Ich werde Ihnen Beispiele für die Arbeit mit der API zeigen: <br><div class="scrollable-table"><table><tbody><tr><th>  Aktionsbeschreibung </th><th>  Klassische js </th><th>  Benutzerdefinierte Vorlagen-API </th></tr><tr><td>  Konsolenausgabe </td><td>  console.log ('Hi'); </td><td>  logToConsole ('Hi'); </td></tr><tr><td>  Timer einstellen </td><td>  setTimeout (Funktion, 100); </td><td>  callLater (Funktion); </td></tr><tr><td>  In String konvertieren </td><td>  String (1234); </td><td>  makeString (1234); </td></tr><tr><td>  Konvertierung in eine Ganzzahl </td><td>  parseInt ('1234', 10); </td><td>  makeInteger ('1234'); </td></tr><tr><td>  Seitenhost </td><td>  window.location.hostname </td><td>  getUrl ('host'); </td></tr></tbody></table></div><br>  Wie Sie der Beispieltabelle entnehmen können, müssen Sie die API nach dem Definieren anstelle von Standard-JS-Konstrukten verwenden. <br><br>  Nachdem wir die API definiert haben, ist es wünschenswert, ein Objekt mit den vom Benutzer eingegebenen Einstellungen zu definieren.  Dies kann beispielsweise erfolgen, nachdem beispielsweise während des ausführbaren Codes die erforderlichen Daten aus den Einstellungen des Benutzers angefordert wurden.  Wenn wir das Einstellungsobjekt jedoch von Anfang an definieren, wird die Arbeit mit dem Code einfacher und verständlicher, da alle Benutzereinstellungen in einem separaten Objekt gespeichert werden. <br><br>  Um Daten von einem Schnittstellenelement abzurufen, müssen Sie das Datenkonstrukt verwenden. <br><br>  {{Elementname}}: <br><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">//    const settings = { //  event: data.event, //ID  () pixelIDs: data.pixelIDs, //ID - (  1 -) priceListId: data.priceListId, //   -? fewPriceLists: data.fewPriceLists, //ID - (    ) priceListIds: data.priceListIds === undefined ? data.priceListIds : makeTableMap(data.priceListIds,'hostname','priceListId'), //  ecommerce   ? ecommerceUse: data.ecommerceUse, // ecommerce   eventEcommerce: data.eventEcommerce, //     siteSearchQueryParam: data.siteSearchQueryParam };</span></span></code> </pre><br>  Hinweis: Wenn Sie undefined an die makeTableMap-Methode übergeben, führt dies zu einem Skriptfehler. Daher verwende ich ein Konstrukt mit einem ternären Operator (ein abgekürzter Datensatz des if-else-Konstrukts), um solche Skripte herauszufiltern. <br><br><div class="spoiler">  <b class="spoiler_title">Informationen zur Methode makeTableMap.</b> <div class="spoiler_text">  Wenn die Schnittstelle eine erweiterte Tabelle verwendet, werden die darin enthaltenen Daten in folgender Form gespeichert: <br><br><pre> <code class="javascript hljs">[ <span class="hljs-string"><span class="hljs-string">'key'</span></span>: <span class="hljs-string"><span class="hljs-string">'k1'</span></span>, <span class="hljs-string"><span class="hljs-string">'value'</span></span>: <span class="hljs-string"><span class="hljs-string">'v1'</span></span>}, <span class="hljs-string"><span class="hljs-string">'key'</span></span>: <span class="hljs-string"><span class="hljs-string">'k2'</span></span>, <span class="hljs-string"><span class="hljs-string">'value'</span></span>: <span class="hljs-string"><span class="hljs-string">'v2'</span></span>} ]</code> </pre><br>  Nach der Verarbeitung mit der Methode makeTableMap werden die Daten zu einem regulären Objekt mit Schlüssel-Wert-Paaren: <br><br><pre> <code class="javascript hljs">{ <span class="hljs-string"><span class="hljs-string">'k1'</span></span>: <span class="hljs-string"><span class="hljs-string">'v1'</span></span>, <span class="hljs-string"><span class="hljs-string">'k2'</span></span>: <span class="hljs-string"><span class="hljs-string">'v2'</span></span> }</code> </pre><br></div></div><br>  Eine weitere Anforderung für benutzerdefinierten Vorlagencode: Wenn das Tag erfolgreich ausgeführt wird, müssen Sie die Methode data.gtmOnSuccess () aufrufen und im Fehlerfall die Methode data.gtmOnFailure () aufrufen. <br><br>  In meinem Code wird beispielsweise die Methode data.gtmOnSuccess () aufgerufen, nachdem die Anforderung erfolgreich gesendet wurde, und die Methode data.gtmOnFailure () wird aufgerufen, wenn der Download auf der externen Skriptseite VK openapi.js fehlschlägt. <br><br>  Nachdem Sie die API definiert und das Objekt mit den Einstellungen definiert haben, können Sie einen Algorithmus zum Erarbeiten des Pixels schreiben. <br><br>  Die Hauptsache, an die Sie sich hier erinnern sollten, ist: <br><br>  • Wenn Sie eine globale Variable benötigen, verwenden Sie die API-Methode copyFromWindow. <br><br><pre> <code class="javascript hljs">copyFromWindow(<span class="hljs-string"><span class="hljs-string">'VK'</span></span>); <span class="hljs-comment"><span class="hljs-comment">//VK -   ,    </span></span></code> </pre><br>  • Wenn Sie eine globale Variable festlegen müssen, verwenden wir die API-Methode setInWindow. <br><br><pre> <code class="javascript hljs">setInWindow(<span class="hljs-string"><span class="hljs-string">'openapiInject'</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>); <span class="hljs-comment"><span class="hljs-comment">//openapiInject -   ,    //1 - ,    .</span></span></code> </pre><br>  • Wenn Sie eine globale Funktion ausführen müssen, verwenden wir die API-Methode callInWindow. <br><br><pre> <code class="javascript hljs">callInWindow(<span class="hljs-string"><span class="hljs-string">'VK.Retargeting.Init'</span></span>, p); <span class="hljs-comment"><span class="hljs-comment">//VK.Retargeting.Init -   ,    //p - ,     </span></span></code> </pre><br>  • Wenn Sie der Seite ein externes Skript hinzufügen müssen, verwenden Sie die InjectScript-API-Methode. <br><br><pre> <code class="javascript hljs">injectScript(<span class="hljs-string"><span class="hljs-string">'https://vk.com/js/api/openapi.js?159'</span></span>, pixel.setVkAsyncInit(), data.gtmOnFailure, <span class="hljs-string"><span class="hljs-string">'vkPixel'</span></span>); <span class="hljs-comment"><span class="hljs-comment">//https://vk.com/js/api/openapi.js?159 -  ,      //pixel.setVkAsyncInit() - ,        //data.gtmOnFailure - ,        //vkPixel -  ,  ,   URL  .    ,   JavaScript      </span></span></code> </pre><br>  • Wenn Sie die URL (oder einen Teil davon) abrufen müssen, verwenden Sie die getUrl-API-Methode. <br><br><pre> <code class="javascript hljs">getUrl(<span class="hljs-string"><span class="hljs-string">'host'</span></span>); <span class="hljs-comment"><span class="hljs-comment">//host -  URL,  .  ,  host: protocol, port, path, extension, fragment, query.</span></span></code> </pre><br>  Wie ich oben geschrieben habe, unterstützt Custom Template JS ES6.  Es ist ratsam, diese Syntax zu verwenden, da sie den Code verkürzt und lesbarer macht und die Arbeit von JS vorhersehbarer und anderen Programmiersprachen ähnlicher ist. <br><br><div class="spoiler">  <b class="spoiler_title">Weitere Informationen zur JS ES6-Syntax</b> <div class="spoiler_text">  Die Hauptsache, die verwendet werden soll, sind Pfeilfunktionen und Deklarationen von const und let-Variablen anstelle von var. <br><br>  Eine über const deklarierte Variable ist eine Konstante, deren Wert nicht geändert werden kann. <br><br>  Eine durch let deklarierte Variable unterscheidet sich von einer durch var deklarierten Variablen wie folgt: <br><br><ul><li>  let wird nicht zum globalen Fensterobjekt hinzugefügt; </li><li>  Die Sichtbarkeit ist auf den Deklarationsblock beschränkt. </li><li>  über let deklarierte Variablen können nicht erneut deklariert werden. </li></ul><br>  Pfeilfunktionen sind eine Abkürzung für die üblichen Funktionen: <br><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">//1.   const func1 = function() { return 'test'; } //    const func1 = () =&gt; 'test'; //2.   const func2 = function(arg) { if (arg &gt; 0) return 'plus'; else return 'minus'; } //    const func2 = arg =&gt; { if (arg &gt; 0) return 'plus'; else return 'minus'; } //3.   const func3 = function(arg1, arg2){ if (arg1 &gt; arg2) return arg1; else return arg2; } //    const func3 = (arg1, arg2) =&gt; { if (arg1 &gt; arg2) return arg1; else return arg2; }</span></span></code> </pre><br></div></div><br>  Nachdem wir uns mit der Verwendung der API für benutzerdefinierte Vorlagen vertraut gemacht haben, können wir den Tag-Operationscode mithilfe der JavaScript ES6-Syntax schreiben. <br><br>  Mein Code enthält Methoden zum Starten eines Pixels, zum Installieren von VK openapi.js, zum Abrufen von Produktdaten aus dataLayer (wobei die erweiterte E-Commerce-Website von Google konfiguriert ist) und zum Verarbeiten dieser Daten, um sie in die Form zu bringen, die für das Senden an das VKontakte-Retargeting-Pixel erforderlich ist und die Ereignisversandmethode. <br><br>  Die Pixel-Trigger-Methode unterstützt drei Szenarien: <br><br><ol><li>  Das Pixel wird auf einer Seite ausgeführt, auf der openapi.js fehlt. </li><li>  Das Pixel wird auf der Seite ausgeführt, auf der sich openapi.js befindet, es wurde jedoch noch nicht geladen. </li><li>  Das Pixel wird auf der Seite mit geladener openapi.js gestartet. </li></ol><br><div class="spoiler">  <b class="spoiler_title">Der vollständige Code meiner benutzerdefinierten GTM-Vorlage für das dynamische Retargeting-Pixel von VKontakte</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">//api const copyFromWindow = require('copyFromWindow'); const setInWindow = require('setInWindow'); const injectScript = require('injectScript'); const callInWindow = require('callInWindow'); const makeTableMap = require('makeTableMap'); const getUrl = require('getUrl'); const getQueryParameters = require('getQueryParameters'); const makeInteger = require('makeInteger'); const makeString = require('makeString'); const callLater = require('callLater'); //    const settings = { event: data.event, pixelIDs: data.pixelIDs, priceListId: data.priceListId, fewPriceLists: data.fewPriceLists, priceListIds: data.priceListIds === undefined ? data.priceListIds : makeTableMap(data.priceListIds,'hostname','priceListId'), ecommerceUse: data.ecommerceUse, eventEcommerce: data.eventEcommerce, siteSearchQueryParam: data.siteSearchQueryParam }; //       const pixel = { //    getPageHostname: () =&gt; getUrl('host'), //    VK getVK: () =&gt; copyFromWindow('VK'), //    VK setVkAsyncInit: () =&gt; { setInWindow('vkAsyncInit', pixel.sendEvent); }, //       getSiteSearchPhrase: () =&gt; { if (settings.event === 'view_search') return getQueryParameters(settings.siteSearchQueryParam); else return undefined; }, //      getEventParams: (products, currencyCode, revenue) =&gt; { let eventParamsClean= {}; let eventParams = { products: eventProducts.getProductParams(products), category_ids: eventProducts.getCategoryString(products), currency_code: currencyCode, total_price: eventProducts.getTotalPrice(products, revenue), search_string: pixel.getSiteSearchPhrase() }; if (eventParams.products !== undefined) eventParamsClean.products = eventParams.products; if (eventParams.category_ids !== undefined) eventParamsClean.category_ids = eventParams.category_ids; if (eventParams.currency_code !== undefined) eventParamsClean.currency_code = eventParams.currency_code; if (eventParams.total_price !== undefined) eventParamsClean.total_price = eventParams.total_price; if (eventParams.search_string !== undefined) eventParamsClean.search_string = eventParams.search_string; return eventParamsClean; }, //  - getPriceListId: hostname =&gt; { if (settings.fewPriceLists) return settings.priceListIds[hostname]; else return settings.priceListId; }, //  openapi.js openapiInit: () =&gt; { injectScript('https://vk.com/js/api/openapi.js?159', pixel.setVkAsyncInit(), data.gtmOnFailure, 'vkPixel'); setInWindow('openapiInject', 1); }, //   sendEvent: () =&gt; { if (settings.event === 'hit') { settings.pixelIDs.split(',').forEach(p =&gt; { callInWindow('VK.Retargeting.Init',p); callInWindow('VK.Retargeting.Hit'); }); } else { const pricelist = pixel.getPriceListId(pixel.getPageHostname()); const name = settings.event; let products = []; if(settings.ecommerceUse) products = name === 'view_home' || name === 'view_category' || name === 'view_search' || name === 'view_other' ? settings.eventEcommerce : settings.eventEcommerce.products; else products = undefined; const currencyCode = settings.ecommerceUse ? settings.eventEcommerce.currencyCode : undefined; const revenue = (settings.ecommerceUse &amp;&amp; name === 'purchase') ? settings.eventEcommerce.actionField.revenue : undefined; const eventParams = settings.ecommerceUse ? pixel.getEventParams(products, currencyCode, revenue) : undefined; settings.pixelIDs.split(',').forEach(p =&gt; { callInWindow('VK.Retargeting.Init',p); callInWindow('VK.Retargeting.ProductEvent', pricelist, name, eventParams); }); }, //   start: () =&gt; { if (pixel.getVK() === undefined &amp;&amp; copyFromWindow('openapiInject') !== 1) { pixel.openapiInit(); data.gtmOnSuccess(); } else if (pixel.getVK() === undefined &amp;&amp; copyFromWindow('openapiInject') === 1) { if (pixel.count &lt; 50) { callLater(pixel.start); pixel.count++; } else return; } else { pixel.sendEvent(); data.gtmOnSuccess(); }, //   count: 0 }; //       const eventProducts = { //    products   getProductParams: products =&gt; { let arr = []; products.forEach(i =&gt; { let productParamsClean = {}; let productParams = { id: makeString(i.id), group_id: makeString(i.brand), price: makeInteger(i.price * 100) / 100 }; if (productParams.id !== 'undefined') productParamsClean.id = productParams.id; if (productParams.group_id !== 'undefined') productParamsClean.group_id = productParams.group_id; if (productParams.price !== 0) productParamsClean.price = productParams.price; arr.push(productParamsClean); }); return arr; }, //       'a,b,c'       getCategoryString: products =&gt; { let categoryId = ''; let check = []; products.forEach(i =&gt; { if(check.indexOf(i.category) === -1) { check.push(i.category); categoryId += ',' + i.category; }); return categoryId.slice(1); }, //     getTotalPrice: (products, revenue) =&gt; { let sumPrice = 0; if (revenue !== undefined ) return makeInteger(revenue * 100) / 100; else { products.forEach(i =&gt; { if (i.hasOwnProperty('quantity')) sumPrice += (makeInteger(i.price * 100) / 100) * makeInteger(i.quantity); else sumPrice += makeInteger(i.price * 100) / 100; }); return sumPrice; }; //  pixel.start();</span></span></code> </pre> <br></div></div><br><a name="6"></a><h2>  Registerkarte "Berechtigungen" </h2><br>  Nach dem Schreiben des Tag-Codes bleibt die letzte Phase, um Berechtigungen für die Interaktion mit den globalen Daten der Seite zu erteilen.  Dies erfolgt nur auf der Registerkarte Berechtigungen. <br><br>  Da der Code in einer isolierten Umgebung ausgeführt wird und die Interaktion mit globalen Daten über die API erfolgt, müssen wir für jede API-Methode (falls erforderlich) manuell Berechtigungen für bestimmte Aktionen angeben. <br><br>  Dies geschieht, um die Arbeit mit globalen Seitendaten so sorgfältig wie möglich anzugehen und dadurch die Wahrscheinlichkeit zu minimieren, dass die Site in einen Fehler im Code unserer Vorlage gerät. <br><br>  Für die in meinem Code verwendeten API-Methoden müssen drei Arten von Berechtigungen erteilt werden: <br><br><img src="https://habrastorage.org/webt/29/og/lw/29oglwyra6zkhac7_2lr4jpqq5a.png"><br><br>  <b>1.</b> Zugriff auf globale <b>Variablen</b> - Lesen, Schreiben, Ausführen des Zugriffs auf globale Variablen, die in unserem Code verwendet werden.  Variablen müssen manuell hinzugefügt werden und geben für jede Variable an, was wir tun dürfen. <br><br><img src="https://habrastorage.org/webt/f3/qb/6b/f3qb6b9sj6rn1v4q55t_z9f362e.png"><br><br>  Beispielsweise kann die VK-Variable nur gelesen, vkAsyncInit gelesen und neu definiert werden und die VK.Retargeting.Hit-Methode kann nur ausgeführt werden. <br><br>  <b>2. Liest die URL</b> .  Hier müssen Sie angeben, welche Teile der URL empfangen dürfen.  Ich erlaube den Empfang von Teilen der URL: <br><br><img src="https://habrastorage.org/webt/do/um/li/doumlixqd-rw2cppm4ordw1svae.png"><br><br>  Wenn Sie möchten, können Sie jedoch Folgendes angeben: <br><br><img src="https://habrastorage.org/webt/sj/d3/ne/sjd3nefe52_foeat88kifeodi-w.png"><br><br>  <b>3. Injiziert Skripte</b> .  Hier müssen die Adressen registriert werden, von denen Sie externe Skripte herunterladen können.  In meinem Code wird nur ein Skript mit VK openapi.js geladen, ich gebe seine Adresse an: <br><br><img src="https://habrastorage.org/webt/xt/oy/hd/xtoyhd-yprd2sn_eu41mbquh2s0.png"><br><br>  Das ist alles, die Einrichtung der benutzerdefinierten Vorlage ist abgeschlossen. Sie können die Vorlage speichern und mit dem Testen fortfahren. <br><br><a name="7"></a><h2>  Anpassen und Testen des Tags in der erstellten benutzerdefinierten Vorlage </h2><br>  Als Beispiel erstellen wir zwei dynamische Retargeting-Tags für "VKontakte" mithilfe der erstellten benutzerdefinierten Vorlage: pageview und addToCart. <br><br><a name="8"></a><h3>  Seitenaufruf </h3><br>  Wir gehen in den erforderlichen GTM-Container, erstellen ein neues Tag und wählen den Tag-Typ VK Pixel im Abschnitt Benutzerdefiniert aus: <br><br><img src="https://habrastorage.org/webt/gd/s-/fi/gds-fi0tqxxcmfkkccsi8trowq4.png"><br><br>  Geben Sie den Namen des Tags ein, wählen Sie das zu verfolgende Ereignis aus, wählen Sie Treffer (dies ist ein Standard-Seitenaufruf), geben Sie im Feld "Pixel-ID" die ID der beiden Pixel an, an die die Daten gesendet werden, und setzen Sie den Auslöser Alle Seiten: <br><br><img src="https://habrastorage.org/webt/vr/op/-0/vrop-0cjfqndkh35qnbtdsoxpc4.png"><br><br>  Speichern Sie das erstellte Tag. <br><br><a name="9"></a><h3>  AddToCart </h3><br>  Das Erstellen eines Tags für ein Ereignis, bei dem ein Produkt zum Warenkorb hinzugefügt wird, ist etwas komplizierter als das Erstellen eines Hit-Tags. <br><br>  Zunächst müssen Sie die Waren übertragen, die dem Warenkorb hinzugefügt wurden.  Wie ich oben geschrieben habe, ist dies mit dem auf der Website konfigurierten erweiterten E-Commerce von Google möglich.  In diesem Fall werden Produktdaten aus dataLayer übernommen. <br><br>  Dazu müssen wir die Variable dataLayer in GTM erstellen, in der das E-Commerce-Objekt für das Ereignis addToCart gespeichert wird.  Variable Einstellungen sehen folgendermaßen aus: <br><br><img src="https://habrastorage.org/webt/ko/r5/gu/kor5gumudjjzs9groemuo7nepco.png"><br><br>  Zweitens müssen Sie einen Trigger erstellen, der das Tag aktiviert, wenn das E-Commerce-Ereignis addToCart auftritt (der Trigger aktiviert das Tag, wenn Sie den dataLayer drücken, wenn das Ereignis addToCart auftritt): <br><br><img src="https://habrastorage.org/webt/og/xl/lt/ogxlltp_4_spurvq8fesqg3uy0m.png"><br><br>  Nachdem Sie eine Variable mit einem E-Commerce-Objekt und einem Trigger erstellt haben, können Sie mit dem Erstellen des Tags beginnen: <br><br><img src="https://habrastorage.org/webt/dp/qg/zq/dpqgzqb27rcdydnjeen5fftp6ba.png"><br><br>  In der Reihenfolge: <br><br><ol><li>  Wählen Sie als verfolgtes Ereignis In den Warenkorb. </li><li>  Wir geben die durch Kommas getrennte ID von zwei Pixeln ein, in die Daten übertragen werden müssen. </li><li>  Aktivieren Sie das Kontrollkästchen "Mehrere Preislisten verwenden": In Moskau und St. Petersburg müssen in unserem Beispiel unterschiedliche Preislisten verwendet werden. </li><li>  Füllen Sie die Tabelle mit Preislisten aus. </li><li>  Aktivieren Sie das Kontrollkästchen "E-Commerce zum Übertragen von Produkten und Parametern verwenden". </li><li>  Geben Sie im E-Commerce-Objekt dieses Ereignisses die zuvor erstellte Variable an. </li><li>  Wir setzen den Auslöser für das überwachte Ereignis, in diesem Fall AddToCart. </li><li>  Speichern. </li></ol><br><a name="10"></a><h3>  Bergbautest </h3><br>  Um das Ausarbeiten der Pixel des dynamischen Retargeting in VKontakte zu überprüfen, müssen Sie den Vorschaumodus in GTM aktivieren, auf unsere Website gehen und den Abschnitt Netzwerk in der Browserkonsole öffnen und im Feld Filter 'rtrg' eingeben: <br><img src="https://habrastorage.org/webt/ci/m9/z8/cim9z824mbc9dfvdz-4425fe02w.png"><br><br>  Danach aktualisieren wir die Seite und sollten zwei Anfragen haben - das Hit-Ereignis, das in zwei Pixeln gesendet wird: <br><br><img src="https://habrastorage.org/webt/o0/5x/80/o05x80jeypiwcogusca_zgsnaju.png"><br><br>  Status 200 bedeutet, dass Anforderungen vom Server erfolgreich gesendet und empfangen werden. <br><br>  Auch im GTM-Vorschaufenster sehen wir, dass unser erstelltes Tag für das Ereignis "Seitenansicht" ordnungsgemäß funktioniert hat. <br><br>  Um das Ereignis "In den Warenkorb" zu überprüfen, fügen Sie das Produkt dem Warenkorb hinzu. In der Konsole werden zwei weitere Anforderungen angezeigt: <br><br><img src="https://habrastorage.org/webt/wt/jm/-k/wtjm-k50mmapqa1xtyva_yd3wcc.png"><br><br>  Im GTM-Vorschaufenster sehen wir, dass das zweite Tag erfolgreich funktioniert hat.  Produktdaten von dataLayer abgerufen und korrekt verarbeitet, die korrekte Preisliste wurde ebenfalls ersetzt. <br><br>  Für den zweiten Host wird die Preisliste ebenfalls korrekt ersetzt: <br><br><img src="https://habrastorage.org/webt/n3/de/h3/n3deh30jep61h2kv9zefwruu8cy.png"><br><br>  Tags für andere Ereignisse werden auf die gleiche Weise konfiguriert und überprüft. <br><br><a name="11"></a><h2>  Fazit </h2><br>  Benutzerdefinierte Vorlagen ändern das bekannte Paradigma der Verwendung von GTM.  Jeder ist an HTML-Tags und JS-Variablen gewöhnt, aber jetzt gibt es eine großartige Alternative. <br><br>  Es reicht aus, einmal eine hochwertige benutzerdefinierte Vorlage zu erstellen, und dann kann jeder, der mit GTM vertraut ist, diese verwenden. <br><br>  Angesichts der Möglichkeit, die erstellten Vorlagen freizugeben, sollten sie meiner Meinung nach bei den Benutzern an Beliebtheit gewinnen. <br><br>  Sie können <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">die benutzerdefinierte</a> dynamische Retargeting-Pixelvorlage von VKontakte <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">herunterladen</a> , die wir in diesem Artikel untersucht haben. <br><br>  Um eine Vorlage zu importieren, erstellen Sie eine neue benutzerdefinierte Vorlage und wählen Sie im Menü die Option Importieren: <br><br><img src="https://habrastorage.org/webt/mx/nn/jc/mxnnjc0419poxmshokabjcgeoye.png"><br><br>  <i>Von mir für ppc.world vorbereitetes Material</i> </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de458788/">https://habr.com/ru/post/de458788/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de458774/index.html">Funktionales DBMS</a></li>
<li><a href="../de458778/index.html">Satellite 6.5 Reporting Engine: Was und warum</a></li>
<li><a href="../de458782/index.html">Anpassung von Programmen für ZX Spectrum an TR-DOS mit modernen Mitteln. Teil 3</a></li>
<li><a href="../de458784/index.html">Übertragen Sie Projekte und Bibliotheken von Altium Designer an PADS Professional</a></li>
<li><a href="../de458786/index.html">Videospiel-Keeper halten die Spielkultur Schritt für Schritt aufrecht</a></li>
<li><a href="../de458790/index.html">Einführung in CatBoost. Yandex-Bericht</a></li>
<li><a href="../de458792/index.html">"Verbrannte" Mitarbeiter: Gibt es einen Ausweg?</a></li>
<li><a href="../de458794/index.html">Business Analysts Meeting bei Redmadrobot am 18. Juli</a></li>
<li><a href="../de458796/index.html">So bereiten Sie Ihre Site auf hohe Arbeitslasten vor: 5 praktische Tipps und nützliche Tools</a></li>
<li><a href="../de458798/index.html">Nährstoff-Bot oder wie ich Brot von Fitnesstrainern nehmen möchte</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>