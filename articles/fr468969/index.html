<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üîä üîâ üëéüèø Cr√©ez des utilisateurs Google √† partir de PowerShell via l'API üë©üèΩ‚Äçüé§ ‚ùóÔ∏è ü•ô</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Salut 

 Cet article d√©crit comment PowerShell interagit avec l'API Google pour manipuler les utilisateurs de G Suite. 

 Dans l'organisation, nous ut...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Cr√©ez des utilisateurs Google √† partir de PowerShell via l'API</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/468969/">  Salut <br><br>  Cet article d√©crit comment PowerShell interagit avec l'API Google pour manipuler les utilisateurs de G Suite. <br><br>  Dans l'organisation, nous utilisons plusieurs services internes et cloud.  Pour la plupart, l'autorisation y relative revient √† Google ou √† Active Directory, entre lesquels nous ne pouvons pas conserver de r√©plique, respectivement, lorsqu'un nouvel employ√© est lib√©r√©, vous devez cr√©er / activer un compte dans ces deux syst√®mes.  Pour automatiser le processus, nous avons d√©cid√© d'√©crire un script qui collecte des informations et les envoie aux deux services. <br><a name="habracut"></a><br><h3>  <font color="#5D8DDF">Se connecter</font> </h3><br>  Composant les exigences, nous avons d√©cid√© d'utiliser des personnes r√©elles comme administrateurs pour l'autorisation, ce qui simplifie l'analyse des actions en cas de changements massifs accidentels ou intentionnels. <br><br>  Les API Google utilisent le protocole OAuth 2.0 pour l'authentification et l'autorisation.  Des cas d'utilisation et une description plus d√©taill√©e peuvent √™tre trouv√©s ici: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Utilisation d'OAuth 2.0 pour acc√©der aux API Google</a> . <br><br>  J'ai choisi le script utilis√© pour l'autorisation dans les applications de bureau.  Il existe √©galement une option pour utiliser un compte de service qui ne n√©cessite pas de mouvements inutiles de la part de l'utilisateur. <br><br>  L'image ci-dessous est une description sch√©matique du sc√©nario s√©lectionn√© √† partir de la page Google. <br><br><img src="https://habrastorage.org/webt/wx/sp/rw/wxsprwm-uqyd1koa-2xx4sgjkku.png"><br><br><ol><li>  Tout d'abord, nous envoyons l'utilisateur √† la page d'authentification du compte Google, en indiquant les param√®tres GET: <br><ul><li>  identifiant d'application </li><li>  les zones auxquelles l'application doit acc√©der </li><li>  adresse vers laquelle l'utilisateur sera redirig√© une fois la proc√©dure termin√©e </li><li>  la fa√ßon dont nous mettrons √† jour le jeton </li><li>  code de v√©rification </li><li>  format de transmission du code de v√©rification </li></ul><br></li><li>  Une fois l'autorisation termin√©e, l'utilisateur sera redirig√© vers la page sp√©cifi√©e dans la premi√®re demande, avec un code d'erreur ou d'autorisation transmis par les param√®tres GET </li><li>  L'application (script) devra obtenir ces param√®tres et, si le code est re√ßu, ex√©cuter la demande de jetons suivante </li><li>  Si la demande est correcte, l'API Google renvoie: <br><br><ul><li>  Jeton d'acc√®s avec lequel nous pouvons faire des demandes </li><li>  Validit√© de ce jeton </li><li>  Actualiser le jeton n√©cessaire pour mettre √† jour le jeton d'acc√®s. </li></ul></li></ol><br>  Vous devez d'abord acc√©der √† la console Google API: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Credentials - Google API Console</a> , s√©lectionnez l'application souhait√©e et cr√©ez l'identifiant OAuth du client dans la section Credentials.  Au m√™me endroit (ou plus tard, dans les propri√©t√©s de l'identifiant cr√©√©), vous devez sp√©cifier les adresses vers lesquelles la redirection est autoris√©e.  Dans notre cas, il s'agira de plusieurs entr√©es d'h√¥te local avec diff√©rents ports (voir ci-dessous). <br><br>  Pour faciliter la lecture de l'algorithme de script, vous pouvez g√©n√©rer les premi√®res √©tapes dans une fonction distincte qui renverra des jetons d'acc√®s et d'actualisation pour l'application: <br><br><pre><code class="cs hljs">$client_secret = <span class="hljs-string"><span class="hljs-string">'Our Client Secret'</span></span> $client_id = <span class="hljs-string"><span class="hljs-string">'Our Client ID'</span></span> function Get-GoogleAuthToken { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (-not [System.Net.HttpListener]::IsSupported) { <span class="hljs-string"><span class="hljs-string">"HttpListener is not supported."</span></span> exit <span class="hljs-number"><span class="hljs-number">1</span></span> } $codeverifier = -<span class="hljs-keyword"><span class="hljs-keyword">join</span></span> ((<span class="hljs-number"><span class="hljs-number">65.</span></span><span class="hljs-number"><span class="hljs-number">.90</span></span>) + (<span class="hljs-number"><span class="hljs-number">97.</span></span><span class="hljs-number"><span class="hljs-number">.122</span></span>) + (<span class="hljs-number"><span class="hljs-number">48.</span></span><span class="hljs-number"><span class="hljs-number">.57</span></span>) + <span class="hljs-number"><span class="hljs-number">45</span></span> + <span class="hljs-number"><span class="hljs-number">46</span></span> + <span class="hljs-number"><span class="hljs-number">95</span></span> + <span class="hljs-number"><span class="hljs-number">126</span></span> |Get-Random -Count <span class="hljs-number"><span class="hljs-number">60</span></span>| % {[<span class="hljs-keyword"><span class="hljs-keyword">char</span></span>]$_}) $hasher = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">object</span></span> System.Security.Cryptography.SHA256Managed $hashByteArray = $hasher.ComputeHash([System.Text.Encoding]::UTF8.GetBytes($codeverifier)) $base64 = ((([System.Convert]::ToBase64String($hashByteArray)).replace(<span class="hljs-string"><span class="hljs-string">'='</span></span>,<span class="hljs-string"><span class="hljs-string">''</span></span>)).replace(<span class="hljs-string"><span class="hljs-string">'+'</span></span>,<span class="hljs-string"><span class="hljs-string">'-'</span></span>)).replace(<span class="hljs-string"><span class="hljs-string">'/'</span></span>,<span class="hljs-string"><span class="hljs-string">'_'</span></span>) $ports = @(<span class="hljs-number"><span class="hljs-number">10600</span></span>,<span class="hljs-number"><span class="hljs-number">15084</span></span>,<span class="hljs-number"><span class="hljs-number">39700</span></span>,<span class="hljs-number"><span class="hljs-number">42847</span></span>,<span class="hljs-number"><span class="hljs-number">65387</span></span>,<span class="hljs-number"><span class="hljs-number">32079</span></span>) $port = $ports[(<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>-random -Minimum <span class="hljs-number"><span class="hljs-number">0</span></span> -maximum <span class="hljs-number"><span class="hljs-number">5</span></span>)] Write-Host <span class="hljs-string"><span class="hljs-string">"Start browser..."</span></span> Start-Process <span class="hljs-string"><span class="hljs-string">"https://accounts.google.com/o/oauth2/v2/auth?code_challenge_method=S256&amp;code_challenge=$base64&amp;access_type=offline&amp;client_id=$client_id&amp;redirect_uri=http://localhost:$port&amp;response_type=code&amp;scope=https://www.googleapis.com/auth/admin.directory.user https://www.googleapis.com/auth/admin.directory.group"</span></span> $listener = New-Object System.Net.HttpListener $listener.Prefixes.Add(<span class="hljs-string"><span class="hljs-string">"http://localhost:"</span></span>+$port+<span class="hljs-string"><span class="hljs-string">'/'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> {$listener.Start()} <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> { <span class="hljs-string"><span class="hljs-string">"Unable to start listener."</span></span> exit <span class="hljs-number"><span class="hljs-number">1</span></span> } <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (($code -eq $<span class="hljs-literal"><span class="hljs-literal">null</span></span>)) { $context = $listener.GetContext() Write-Host <span class="hljs-string"><span class="hljs-string">"Connection accepted"</span></span> -f <span class="hljs-string"><span class="hljs-string">'mag'</span></span> $url = $context.Request.RawUrl $code = $url.split(<span class="hljs-string"><span class="hljs-string">'?'</span></span>)[<span class="hljs-number"><span class="hljs-number">1</span></span>].split(<span class="hljs-string"><span class="hljs-string">'='</span></span>)[<span class="hljs-number"><span class="hljs-number">1</span></span>].split(<span class="hljs-string"><span class="hljs-string">'&amp;'</span></span>)[<span class="hljs-number"><span class="hljs-number">0</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($url.split(<span class="hljs-string"><span class="hljs-string">'?'</span></span>)[<span class="hljs-number"><span class="hljs-number">1</span></span>].split(<span class="hljs-string"><span class="hljs-string">'='</span></span>)[<span class="hljs-number"><span class="hljs-number">0</span></span>] -eq <span class="hljs-string"><span class="hljs-string">'error'</span></span>) { Write-Host <span class="hljs-string"><span class="hljs-string">"Error!"</span></span>$code -f <span class="hljs-string"><span class="hljs-string">'red'</span></span> $buffer = [System.Text.Encoding]::UTF8.GetBytes(<span class="hljs-string"><span class="hljs-string">"Error!"</span></span>+$code) $context.Response.ContentLength64 = $buffer.Length $context.Response.OutputStream.Write($buffer, <span class="hljs-number"><span class="hljs-number">0</span></span>, $buffer.Length) $context.Response.OutputStream.Close() $listener.Stop() exit <span class="hljs-number"><span class="hljs-number">1</span></span> } $buffer = [System.Text.Encoding]::UTF8.GetBytes(<span class="hljs-string"><span class="hljs-string">"Now you can close this browser tab."</span></span>) $context.Response.ContentLength64 = $buffer.Length $context.Response.OutputStream.Write($buffer, <span class="hljs-number"><span class="hljs-number">0</span></span>, $buffer.Length) $context.Response.OutputStream.Close() $listener.Stop() } Return Invoke-RestMethod -Method Post -Uri <span class="hljs-string"><span class="hljs-string">"https://www.googleapis.com/oauth2/v4/token"</span></span> -Body @{ code = $code client_id = $client_id client_secret = $client_secret redirect_uri = <span class="hljs-string"><span class="hljs-string">'http://localhost:'</span></span>+$port grant_type = <span class="hljs-string"><span class="hljs-string">'authorization_code'</span></span> code_verifier = $codeverifier } $code = $<span class="hljs-literal"><span class="hljs-literal">null</span></span></code> </pre> <br>  Nous d√©finissons l'ID client et le secret client obtenus dans les propri√©t√©s de l'identifiant client OAuth, et le v√©rificateur de code est une cha√Æne de 43 √† 128 caract√®res, qui doit √™tre g√©n√©r√©e de mani√®re al√©atoire √† partir de caract√®res non r√©serv√©s: [AZ] / [az] / [0-9 ] / "-" / "."  / "_" / "~". <br><br>  De plus, ce code sera retransmis.  Il √©limine la vuln√©rabilit√© dans laquelle un attaquant pourrait intercepter la r√©ponse renvoy√©e sous forme de redirection apr√®s l'autorisation de l'utilisateur. <br>  Vous pouvez envoyer le v√©rificateur de code dans la demande actuelle sous une forme claire (ce qui le rend inutile - cela ne convient qu'aux syst√®mes qui ne prennent pas en charge SHA256), ou en cr√©ant un hachage SHA256 qui doit √™tre cod√© en BASE64Url (diff√®re de Base64 en deux caract√®res du tableau) et supprimez le caract√®re fin de ligne: =. <br><br>  Ensuite, nous devons commencer √† √©couter http sur la machine locale pour obtenir une r√©ponse apr√®s autorisation, qui sera renvoy√©e sous forme de redirection. <br><br>  Les t√¢ches administratives sont effectu√©es sur un serveur sp√©cial, nous ne pouvons pas exclure la possibilit√© que plusieurs administrateurs ex√©cutent le script en m√™me temps, donc il s√©lectionnera au hasard un port pour l'utilisateur actuel, mais j'ai sp√©cifi√© des ports pr√©d√©finis, car  ils doivent √©galement √™tre ajout√©s comme approuv√©s dans la console API. <br><br>  <i>access_type = offline</i> signifie que l'application peut mettre √† jour le jeton expir√© ind√©pendamment sans interaction de l'utilisateur avec le navigateur, <br>  <i>response_type = code</i> d√©finit le format de retour du code (se r√©f√©rant √† l'ancienne m√©thode d'autorisation lorsque l'utilisateur a copi√© le code du navigateur vers le script), <br>  <i>scope</i> indique la <i>port√©e</i> et le type d'acc√®s.  Ils doivent √™tre s√©par√©s par des espaces ou% 20 (selon l'encodage URL).  Une liste des zones d'acc√®s avec des types peut √™tre consult√©e ici: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">OAuth 2.0 Scopes for Google APIs</a> . <br><br>  Apr√®s avoir re√ßu le code d'autorisation, l'application renverra un message de fermeture au navigateur, cessera d'√©couter le port et enverra une demande POST pour recevoir le jeton.  Nous y indiquons l'identifiant et le secret pr√©c√©demment d√©finis dans l'API de la console, l'adresse vers laquelle l'utilisateur sera redirig√© et grant_type conform√©ment √† la sp√©cification du protocole. <br><br>  En r√©ponse, nous obtiendrons un jeton d'acc√®s, sa dur√©e en secondes et un jeton d'actualisation, avec lesquels nous pourrons mettre √† jour le jeton d'acc√®s. <br><br>  L'application doit stocker les jetons dans un endroit s√ªr avec une longue dur√©e de conservation, donc jusqu'√† ce que nous r√©voquions l'acc√®s re√ßu, le jeton d'actualisation ne sera pas retourn√© √† l'application.  √Ä la fin, j'ai ajout√© une demande de r√©vocation du jeton.Si l'application ne s'est pas termin√©e avec succ√®s et que le jeton d'actualisation n'est pas revenu, il recommencera la proc√©dure (nous avons consid√©r√© qu'il n'√©tait pas s√ªr de stocker les jetons localement sur le terminal, mais nous ne voulons pas compliquer la cryptographie ou souvent ouvrir le navigateur). <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">do</span></span> { $token_result = Get-GoogleAuthToken $token = $token_result.<span class="hljs-function"><span class="hljs-function">access_token </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">if</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">$token_result.refresh_token -eq $</span></span><span class="hljs-literal"><span class="hljs-function"><span class="hljs-params"><span class="hljs-literal">null</span></span></span></span></span><span class="hljs-function">)</span></span> { Write-Host (<span class="hljs-string"><span class="hljs-string">"Session is not destroyed. Revoking token..."</span></span>) Invoke-WebRequest -Uri (<span class="hljs-string"><span class="hljs-string">"https://accounts.google.com/o/oauth2/revoke?token="</span></span>+$token) } } <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> ($token_result.refresh_token -eq $<span class="hljs-literal"><span class="hljs-literal">null</span></span>) $refresh_token = $token_result.refresh_token $minute = ([<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>](<span class="hljs-string"><span class="hljs-string">"{0:mm}"</span></span> -f ([timespan]::fromseconds($token_result.expires_in))))+((Get-date).Minute)<span class="hljs-number"><span class="hljs-number">-2</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($minute -lt <span class="hljs-number"><span class="hljs-number">0</span></span>) {$minute += <span class="hljs-number"><span class="hljs-number">60</span></span>} elseif ($minute -gt <span class="hljs-number"><span class="hljs-number">59</span></span>) {$minute -=<span class="hljs-number"><span class="hljs-number">60</span></span>} $token_expire = @{ hour = ([<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>](<span class="hljs-string"><span class="hljs-string">"{0:hh}"</span></span> -f ([timespan]::fromseconds($token_result.expires_in))))+((Get-date).Hour) minute = $minute }</code> </pre><br>  Comme vous l'avez peut-√™tre remarqu√©, lors de l'appel d'un jeton, Invoke-WebRequest est utilis√©.  Contrairement √† Invoke-RestMethod, il ne renvoie pas les donn√©es re√ßues dans un format pratique √† utiliser et affiche l'√©tat de la demande. <br><br>  Ensuite, le script vous demandera d'entrer le pr√©nom et le nom de l'utilisateur, g√©n√©rant un nom d'utilisateur + e-mail. <br><br><h3>  <font color="#5D8DDF">Demandes</font> </h3><br>  Voici les demandes - tout d'abord, vous devez v√©rifier si l'utilisateur existe d√©j√† avec une telle connexion pour obtenir une d√©cision sur la cr√©ation d'une nouvelle connexion ou l'activation de la connexion actuelle. <br><br>  J'ai d√©cid√© d'impl√©menter toutes les requ√™tes au format d'une seule fonction avec une s√©lection via switch: <br><br><pre> <code class="cs hljs">function GoogleQuery { param ( $type, $query ) <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> ($type) { <span class="hljs-string"><span class="hljs-string">"SearchAccount"</span></span> { Return Invoke-RestMethod -Method Get -Uri <span class="hljs-string"><span class="hljs-string">"https://www.googleapis.com/admin/directory/v1/users"</span></span> -Headers @{Authorization = <span class="hljs-string"><span class="hljs-string">"Bearer "</span></span>+(Get-GoogleToken)} -Body @{ domain = <span class="hljs-string"><span class="hljs-string">'rocketguys.com'</span></span> query = <span class="hljs-string"><span class="hljs-string">"email:$query"</span></span> } } <span class="hljs-string"><span class="hljs-string">"UpdateAccount"</span></span> { $body = @{ name = @{ givenName = $query[<span class="hljs-string"><span class="hljs-string">'givenName'</span></span>] familyName = $query[<span class="hljs-string"><span class="hljs-string">'familyName'</span></span>] } suspended = <span class="hljs-string"><span class="hljs-string">'false'</span></span> password = $query[<span class="hljs-string"><span class="hljs-string">'password'</span></span>] changePasswordAtNextLogin = <span class="hljs-string"><span class="hljs-string">'true'</span></span> phones = @(@{ primary = <span class="hljs-string"><span class="hljs-string">'true'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">value</span></span> = $query[<span class="hljs-string"><span class="hljs-string">'phone'</span></span>] type = <span class="hljs-string"><span class="hljs-string">"mobile"</span></span> }) orgUnitPath = $query[<span class="hljs-string"><span class="hljs-string">'orgunit'</span></span>] } Return Invoke-RestMethod -Method Put -Uri (<span class="hljs-string"><span class="hljs-string">"https://www.googleapis.com/admin/directory/v1/users/"</span></span>+$query[<span class="hljs-string"><span class="hljs-string">'email'</span></span>]) -Headers @{Authorization = <span class="hljs-string"><span class="hljs-string">"Bearer "</span></span>+(Get-GoogleToken)} -Body (ConvertTo-Json $body) -ContentType <span class="hljs-string"><span class="hljs-string">'application/json; charset=utf-8'</span></span> } <span class="hljs-string"><span class="hljs-string">"CreateAccount"</span></span> { $body = @{ primaryEmail = $query[<span class="hljs-string"><span class="hljs-string">'email'</span></span>] name = @{ givenName = $query[<span class="hljs-string"><span class="hljs-string">'givenName'</span></span>] familyName = $query[<span class="hljs-string"><span class="hljs-string">'familyName'</span></span>] } suspended = <span class="hljs-string"><span class="hljs-string">'false'</span></span> password = $query[<span class="hljs-string"><span class="hljs-string">'password'</span></span>] changePasswordAtNextLogin = <span class="hljs-string"><span class="hljs-string">'true'</span></span> phones = @(@{ primary = <span class="hljs-string"><span class="hljs-string">'true'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">value</span></span> = $query[<span class="hljs-string"><span class="hljs-string">'phone'</span></span>] type = <span class="hljs-string"><span class="hljs-string">"mobile"</span></span> }) orgUnitPath = $query[<span class="hljs-string"><span class="hljs-string">'orgunit'</span></span>] } Return Invoke-RestMethod -Method Post -Uri <span class="hljs-string"><span class="hljs-string">"https://www.googleapis.com/admin/directory/v1/users"</span></span> -Headers @{Authorization = <span class="hljs-string"><span class="hljs-string">"Bearer "</span></span>+(Get-GoogleToken)} -Body (ConvertTo-Json $body) -ContentType <span class="hljs-string"><span class="hljs-string">'application/json; charset=utf-8'</span></span> } <span class="hljs-string"><span class="hljs-string">"AddMember"</span></span> { $body = @{ userKey = $query[<span class="hljs-string"><span class="hljs-string">'email'</span></span>] } $ifrequest = Invoke-RestMethod -Method Get -Uri <span class="hljs-string"><span class="hljs-string">"https://www.googleapis.com/admin/directory/v1/groups"</span></span> -Headers @{Authorization = <span class="hljs-string"><span class="hljs-string">"Bearer "</span></span>+(Get-GoogleToken)} -Body $body $array = @() <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> ($<span class="hljs-keyword"><span class="hljs-keyword">group</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> $ifrequest.groups) {$array += $<span class="hljs-keyword"><span class="hljs-keyword">group</span></span>.email} <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($array -notcontains $query[<span class="hljs-string"><span class="hljs-string">'groupkey'</span></span>]) { $body = @{ email = $query[<span class="hljs-string"><span class="hljs-string">'email'</span></span>] role = <span class="hljs-string"><span class="hljs-string">"MEMBER"</span></span> } Return Invoke-RestMethod -Method Post -Uri (<span class="hljs-string"><span class="hljs-string">"https://www.googleapis.com/admin/directory/v1/groups/"</span></span>+$query[<span class="hljs-string"><span class="hljs-string">'groupkey'</span></span>]+<span class="hljs-string"><span class="hljs-string">"/members"</span></span>) -Headers @{Authorization = <span class="hljs-string"><span class="hljs-string">"Bearer "</span></span>+(Get-GoogleToken)} -Body (ConvertTo-Json $body) -ContentType <span class="hljs-string"><span class="hljs-string">'application/json; charset=utf-8'</span></span> } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { Return ($query[<span class="hljs-string"><span class="hljs-string">'email'</span></span>]+<span class="hljs-string"><span class="hljs-string">" now is a member of "</span></span>+$query[<span class="hljs-string"><span class="hljs-string">'groupkey'</span></span>]) } } } }</code> </pre> <br>  Dans chaque demande, vous devez envoyer un en-t√™te d'autorisation contenant le type de jeton et le jeton d'acc√®s lui-m√™me.  Pour le moment, le type de jeton est toujours porteur.  Parce que  nous devons v√©rifier que le jeton n'est pas expir√© et le mettre √† jour une heure apr√®s son √©mission, j'ai indiqu√© une demande pour une autre fonction qui renvoie un jeton d'acc√®s.  Le m√™me morceau de code se trouve au d√©but du script lors de la r√©ception du premier jeton Access: <br><br><pre> <code class="cs hljs">function Get-GoogleToken { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (((Get-date).Hour -gt $token_expire.hour) -or (((Get-date).Hour -ge $token_expire.hour) -and ((Get-date).Minute -gt $token_expire.minute))) { Write-Host <span class="hljs-string"><span class="hljs-string">"Token Expired. Refreshing..."</span></span> $request = (Invoke-RestMethod -Method Post -Uri <span class="hljs-string"><span class="hljs-string">"https://www.googleapis.com/oauth2/v4/token"</span></span> -ContentType <span class="hljs-string"><span class="hljs-string">'application/x-www-form-urlencoded'</span></span> -Body @{ client_id = $client_id client_secret = $client_secret refresh_token = $refresh_token grant_type = <span class="hljs-string"><span class="hljs-string">'refresh_token'</span></span> }) $token = $request.access_token $minute = ([<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>](<span class="hljs-string"><span class="hljs-string">"{0:mm}"</span></span> -f ([timespan]::fromseconds($request.expires_in))))+((Get-date).Minute)<span class="hljs-number"><span class="hljs-number">-2</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($minute -lt <span class="hljs-number"><span class="hljs-number">0</span></span>) {$minute += <span class="hljs-number"><span class="hljs-number">60</span></span>} elseif ($minute -gt <span class="hljs-number"><span class="hljs-number">59</span></span>) {$minute -=<span class="hljs-number"><span class="hljs-number">60</span></span>} $script:token_expire = @{ hour = ([<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>](<span class="hljs-string"><span class="hljs-string">"{0:hh}"</span></span> -f ([timespan]::fromseconds($request.expires_in))))+((Get-date).Hour) minute = $minute } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $token }</code> </pre> <br>  V√©rification de la connexion pour l'existence: <br><br><pre> <code class="cs hljs">function Check_Google { $query = (GoogleQuery <span class="hljs-string"><span class="hljs-string">'SearchAccount'</span></span> $username) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($query.users -ne $<span class="hljs-literal"><span class="hljs-literal">null</span></span>) { $user = $query.users[<span class="hljs-number"><span class="hljs-number">0</span></span>] Write-Host $user.name.fullName<span class="hljs-string"><span class="hljs-string">' - '</span></span>$user.PrimaryEmail<span class="hljs-string"><span class="hljs-string">' - suspended: '</span></span>$user.Suspended $GAresult = $user } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($GAresult) { $<span class="hljs-keyword"><span class="hljs-keyword">return</span></span> = $GAresult } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> {$<span class="hljs-keyword"><span class="hljs-keyword">return</span></span> = <span class="hljs-string"><span class="hljs-string">'gg'</span></span>} <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $<span class="hljs-keyword"><span class="hljs-keyword">return</span></span> }</code> </pre> <br>  Demande par e-mail: $ query demandera √† l'API de rechercher un utilisateur avec exactement cet e-mail, y compris les alias.  Vous pouvez √©galement utiliser des caract√®res g√©n√©riques: <i>=,:,: {PREFIX} *</i> . <br><br>  Pour obtenir des donn√©es, la m√©thode de demande GET est utilis√©e, pour ins√©rer des donn√©es (cr√©er un compte ou ajouter un membre √† un groupe) - POST, pour mettre √† jour des donn√©es existantes - PUT, pour supprimer une entr√©e (par exemple, un participant d'un groupe) - SUPPRIMER. <br><br>  Le script demandera √©galement un num√©ro de t√©l√©phone (une cha√Æne non valide) et l'inclura dans un groupe de distribution r√©gional.  Il d√©cide de l'unit√© organisationnelle que l'utilisateur doit avoir en fonction de l'unit√© d'organisation Active Directory s√©lectionn√©e et propose un mot de passe: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">do</span></span> { $phone = Read-Host <span class="hljs-string"><span class="hljs-string">"   +7"</span></span> } <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (-not $phone) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> { $moscow = Read-Host <span class="hljs-string"><span class="hljs-string">"  ? (y/n) "</span></span> } <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (-not (($moscow -eq <span class="hljs-string"><span class="hljs-string">'y'</span></span>) -or ($moscow -eq <span class="hljs-string"><span class="hljs-string">'n'</span></span>))) $orgunit = <span class="hljs-string"><span class="hljs-string">'/'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($OU -like <span class="hljs-string"><span class="hljs-string">"*OU=Delivery,OU=Users,OU=ROOT,DC=rocket,DC=local"</span></span>) { Write-host <span class="hljs-string"><span class="hljs-string">"   /Team delivery"</span></span> $orgunit = <span class="hljs-string"><span class="hljs-string">"/Team delivery"</span></span> } $Password = -<span class="hljs-keyword"><span class="hljs-keyword">join</span></span> ( <span class="hljs-number"><span class="hljs-number">48.</span></span><span class="hljs-number"><span class="hljs-number">.57</span></span> + <span class="hljs-number"><span class="hljs-number">65.</span></span><span class="hljs-number"><span class="hljs-number">.90</span></span> + <span class="hljs-number"><span class="hljs-number">97.</span></span><span class="hljs-number"><span class="hljs-number">.122</span></span> | Get-Random -Count <span class="hljs-number"><span class="hljs-number">12</span></span> | % {[<span class="hljs-keyword"><span class="hljs-keyword">char</span></span>]$_})+<span class="hljs-string"><span class="hljs-string">"*Ba"</span></span></code> </pre><br>  Et puis commence √† manipuler le compte: <br><br><pre> <code class="cs hljs">$query = @{ email = $email givenName = $firstname familyName = $lastname password = $password phone = $phone orgunit = $orgunit } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($GMailExist) { Write-Host <span class="hljs-string"><span class="hljs-string">"  "</span></span> -<span class="hljs-function"><span class="hljs-function">f </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">mag</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">GoogleQuery </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">'UpdateAccount'</span></span></span></span><span class="hljs-function"><span class="hljs-params"> $query</span></span></span><span class="hljs-function">) | fl write-host "      $Username  Google." } else</span></span> { Write-Host <span class="hljs-string"><span class="hljs-string">"  "</span></span> -<span class="hljs-function"><span class="hljs-function">f </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">mag</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">GoogleQuery </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">'CreateAccount'</span></span></span></span><span class="hljs-function"><span class="hljs-params"> $query</span></span></span><span class="hljs-function">) | fl } </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">if</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">$moscow -eq </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"y"</span></span></span></span></span><span class="hljs-function">)</span></span>{ write-host <span class="hljs-string"><span class="hljs-string">"   moscowoffice"</span></span> $query = @{ groupkey = <span class="hljs-string"><span class="hljs-string">'moscowoffice@rocketguys.com'</span></span> email = $email } (GoogleQuery <span class="hljs-string"><span class="hljs-string">'AddMember'</span></span> $query) | fl }</code> </pre><br>  Les fonctions de mise √† jour et de cr√©ation d'un compte ont la m√™me syntaxe, tous les champs suppl√©mentaires ne sont pas requis, dans la section avec les num√©ros de t√©l√©phone, vous devez sp√©cifier un tableau qui peut contenir √† partir d'un enregistrement avec un num√©ro et son type. <br><br>  Afin de ne pas obtenir d'erreur lors de l'ajout d'un utilisateur √† un groupe, nous pouvons d'abord v√©rifier s'il est d√©j√† dans ce groupe en recevant une liste des membres du groupe ou de la composition de l'utilisateur lui-m√™me. <br><br>  <b>Une demande de composition de groupes d'un utilisateur sp√©cifique ne sera pas r√©cursive et ne montrera que l'adh√©sion directe.</b>  L'inclusion de l'utilisateur dans le groupe parent, dans lequel le groupe subsidiaire dont l'utilisateur est membre, est d√©j√† r√©ussie. <br><br><h3>  <font color="#5D8DDF">Conclusion</font> </h3><br>  Reste √† envoyer √† l'utilisateur le mot de passe du nouveau compte.  Nous le faisons par SMS et envoyons des informations g√©n√©rales avec des instructions et une connexion √† un courrier personnel qui, avec le num√©ro de t√©l√©phone, a √©t√© fourni par le service de s√©lection du personnel.  Comme alternative, vous pouvez √©conomiser de l'argent et envoyer un mot de passe √† un chat t√©l√©gramme secret, qui peut √©galement √™tre consid√©r√© comme le deuxi√®me facteur (les macbooks seront une exception). <br><br>  Merci d'avoir lu jusqu'au bout.  Je serai heureux de voir des suggestions pour am√©liorer le style d'√©criture des articles et je souhaite que vous rattrapiez moins d'erreurs lors de l'√©criture de scripts =) <br><br>  Liste de liens qui peuvent √™tre utiles par th√®me ou simplement r√©pondre √† vos questions: <br><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">OAuth 2.0 pour applications mobiles et de bureau</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Utilisation d'OAuth 2.0 pour les applications de serveur Web</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Cl√© de preuve pour l'√©change de code par les clients publics OAuth</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">G√©n√©rer des lettres al√©atoires avec PowerShell</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Tableau et description ASCII</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">PowerShell: obtention de la valeur de hachage pour une cha√Æne</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Encoder / D√©coder Base64Url</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Encodage Base64 vs encodage Base64url</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Invoke-RestMethod dans PowerShell 5.1</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Ne pas obtenir de jeton d'actualisation m√™me si access_type est hors ligne √† l'√©tape 1</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">√Ä propos des op√©rateurs de comparaison</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">API d'annuaire: comptes d'utilisateurs</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Recherche d'utilisateurs</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">API d'annuaire: Groupes</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Gestion des erreurs pour Invoke-RestMethod - Powershell</a> </li></ul></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr468969/">https://habr.com/ru/post/fr468969/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr468957/index.html">G√©n√©ration de donjons cycliques sur l'exemple d'Unxplored</a></li>
<li><a href="../fr468959/index.html">Gestion des d√©pendances dans un projet multi-modules sur la gr√™le</a></li>
<li><a href="../fr468961/index.html">Comment se d√©barrasser de la routine dans la vie pour 560 $? Ou comment vivre, pas vivre</a></li>
<li><a href="../fr468963/index.html">Sauvegarde, pi√®ce √† la demande des lecteurs: pr√©sentation d'UrBackup, BackupPC, AMANDA</a></li>
<li><a href="../fr468967/index.html">"Technologie" d'obtention d'√©quations de dynamique de TAU. Et pourquoi l‚Äôidentification du syst√®me est nul, et les r√®gles de la ¬´physique honn√™te¬ª</a></li>
<li><a href="../fr468971/index.html">√âcriture en Java pour Nintendo DS</a></li>
<li><a href="../fr468973/index.html">R√©seau de neurones pour classer les images satellites √† l'aide de Tensorflow en Python</a></li>
<li><a href="../fr468989/index.html">March√© de l'UEBA meurt - Longue vie √† l'UEBA</a></li>
<li><a href="../fr468991/index.html">Personnages de sprites modulaires et leur animation</a></li>
<li><a href="../fr468993/index.html">Oculus Quest se connecte √† un PC et voit les mains</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>