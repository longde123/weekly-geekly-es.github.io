<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ü•ú üêí üçß Principales erreurs de d√©veloppement lors de l'utilisation de PostgreSQL üè£ üëêüèΩ üë©üèø‚Äçüç≥</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="HighLoad ++ existe depuis longtemps et nous parlons de travailler r√©guli√®rement avec PostgreSQL. Mais les d√©veloppeurs ont toujours les m√™mes probl√®me...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Principales erreurs de d√©veloppement lors de l'utilisation de PostgreSQL</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/oleg-bunin/blog/455248/">  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">HighLoad ++</a> existe depuis longtemps et nous parlons de travailler r√©guli√®rement avec PostgreSQL.  Mais les d√©veloppeurs ont toujours les m√™mes probl√®mes de mois en mois, d'ann√©e en ann√©e.  Lorsque dans les petites entreprises sans DBA dans l'√âtat, il y a des erreurs dans le travail avec les bases de donn√©es, cela n'est pas surprenant.  Les grandes entreprises ont √©galement besoin de bases de donn√©es et m√™me avec des processus d√©bogu√©s, des erreurs se produisent toujours et les bases de donn√©es tombent.  Peu importe la taille de l'entreprise - des erreurs se produisent toujours, des bases de donn√©es se bloquent p√©riodiquement, se bloquent. <br><br><img src="https://habrastorage.org/webt/k7/dz/pb/k7dzpbs_rg2wat7ac4awvar2h-e.png"><br><br>  Bien s√ªr, cela ne vous arrivera jamais, mais v√©rifier la liste de contr√¥le n'est pas difficile, et il peut √™tre tr√®s d√©cent de sauver les nerfs futurs.  Sous le chat, nous allons r√©pertorier les principales erreurs typiques que les d√©veloppeurs commettent lorsqu'ils travaillent avec PostgreSQL, voir pourquoi nous n'avons pas besoin de le faire et d√©couvrir comment. <br><br><iframe width="560" height="315" src="https://www.youtube.com/embed/HjLnY0aPQZo" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br>  <b>√Ä propos de l'orateur: Alexey Lesovsky a</b> commenc√© en tant qu'administrateur syst√®me Linux.  Des t√¢ches de virtualisation et de surveillance des syst√®mes sont progressivement venues √† PostgreSQL.  Maintenant PostgreSQL DBA dans <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Data Egret</a> , une soci√©t√© de conseil qui travaille avec de nombreux projets diff√©rents et voit de nombreux exemples de probl√®mes r√©currents.  Ceci est un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">lien</a> vers la pr√©sentation du rapport √† HighLoad ++ 2018. <br><a name="habracut"></a><br><h2>  D'o√π viennent les probl√®mes </h2><br>  Pour vous √©chauffer, quelques histoires sur la fa√ßon dont les erreurs se produisent. <br><br><h3>  Historique 1. Caract√©ristiques </h3><br>  L'un des probl√®mes est de savoir quelles fonctionnalit√©s l'entreprise utilise lorsqu'elle travaille avec PostgreSQL.  Tout commence simplement: PostgreSQL, jeux de donn√©es, requ√™tes simples avec JOIN.  Nous prenons les donn√©es, faisons SELECT - tout est simple. <br><br>  Ensuite, nous commen√ßons √† utiliser les fonctionnalit√©s suppl√©mentaires de PostgreSQL, ajouter de nouvelles fonctions, extensions.  La fonctionnalit√© s'agrandit.  Nous connectons la r√©plication en streaming, le sharding.  Divers utilitaires et kits de carrosserie apparaissent autour - pgbouncer, pgpool, patroni.  Quelque chose comme √ßa. <br><br><img src="https://habrastorage.org/webt/_i/kr/an/_ikran7pf4ni9e4hyxiwptuhwy4.png"><br><br><blockquote>  Chaque mot-cl√© est la raison pour laquelle une erreur appara√Æt. </blockquote><br><h3>  Historique 2. Stockage de donn√©es </h3><br>  La fa√ßon dont nous stockons les donn√©es est √©galement une source d'erreurs. <br><br>  Lorsque le projet est apparu pour la premi√®re fois, il contenait pas mal de donn√©es et de tableaux.  De simples requ√™tes suffisent pour recevoir et enregistrer des donn√©es.  Mais il y a de plus en plus de tableaux.  Les donn√©es sont s√©lectionn√©es √† diff√©rents endroits, des JOIN apparaissent.  Les requ√™tes sont compliqu√©es et incluent des constructions CTE, SUBQUERY, IN, LATERAL.  Faire une erreur et √©crire une requ√™te courbe devient beaucoup plus facile. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/ff9/37e/620/ff937e6202947bba4393531475868c74.png"><br><br>  Et ce n'est que la pointe de l'iceberg - quelque part sur le c√¥t√©, il peut y avoir 400 autres tables, partitions, √† partir desquelles des donn√©es sont √©galement lues occasionnellement. <br><br><h3>  Histoire 3. Cycle de vie </h3><br>  L'histoire de la fa√ßon dont le produit est suivi.  Les donn√©es doivent toujours √™tre stock√©es quelque part, il y a donc toujours une base de donn√©es.  Comment se d√©veloppe une base de donn√©es lorsqu'un produit se d√©veloppe? <br><br>  D'une part, il y a des <b>d√©veloppeurs</b> qui sont occup√©s avec les langages de programmation.  Ils r√©digent leurs applications et d√©veloppent des comp√©tences dans le domaine du d√©veloppement logiciel, sans pr√™ter attention aux services.  Souvent, ils ne sont pas int√©ress√©s par le fonctionnement de Kafka ou PostgreSQL - ils d√©veloppent de nouvelles fonctionnalit√©s dans leur application, et ils ne se soucient pas du reste. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/056/1c3/00a/0561c300abe5623898768ad7d334a334.png"><br><br>  <b>Admins, d'</b> autre part.  Ils g√©n√®rent de nouvelles instances Amazon sur Bare-metal et sont occup√©s √† l'automatisation: ils configurent des d√©ploiements pour bien faire fonctionner la mise en page et configurent pour que les services interagissent bien entre eux. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/961/3f5/8fb/9613f58fb950f69b235d5b80cc29e1b4.png"><br><br>  Il y a une situation o√π il n'y a pas de temps ou de d√©sir pour un r√©glage fin des composants, ainsi que de la base de donn√©es.  Les bases de donn√©es fonctionnent avec des configurations par d√©faut, puis elles les oublient compl√®tement - "√ßa marche, ne le touchez pas". <br><br>  En cons√©quence, les r√¢teaux sont dispers√©s √† divers endroits, qui volent de temps en temps dans le front des d√©veloppeurs.  Dans cet article, nous essaierons de rassembler tous ces r√¢teaux dans un hangar afin que vous les connaissiez et que lorsque vous travaillez avec PostgreSQL, ne les attaquez pas. <br><br><h2>  Planification et suivi </h2><br>  Tout d'abord, imaginez que nous avons un nouveau projet - c'est toujours un d√©veloppement actif, des tests d'hypoth√®ses et la mise en ≈ìuvre de nouvelles fonctionnalit√©s.  Au moment o√π l'application vient d'appara√Ætre et se d√©veloppe, elle a peu de trafic, d'utilisateurs et de clients, et elles g√©n√®rent toutes de petites quantit√©s de donn√©es.  La base de donn√©es contient des requ√™tes simples qui sont trait√©es rapidement.  Pas besoin de faire glisser de grandes quantit√©s de donn√©es, il n'y a aucun probl√®me. <br><br>  Mais il y a plus d'utilisateurs, le trafic arrive: de nouvelles donn√©es apparaissent, les bases de donn√©es se d√©veloppent et les anciennes requ√™tes cessent de fonctionner.  Il est n√©cessaire de compl√©ter les index, de r√©√©crire et d'optimiser les requ√™tes.  Il y a des probl√®mes de performances.  Tout cela conduit √† des alertes √† 4 heures du matin, au stress des administrateurs et au m√©contentement de la direction. <br><br><h3>  Qu'est-ce qui ne va pas? </h3><br><blockquote>  D'apr√®s mon exp√©rience, le plus souvent, il n'y a pas assez de disques. </blockquote><br>  <b>Le premier exemple</b> .  Nous ouvrons le calendrier de surveillance de l'utilisation du disque et nous constatons que l' <b>espace libre sur le disque est √©puis√©</b> . <br><br><img src="https://habrastorage.org/getpro/habr/post_images/65b/245/c83/65b245c834e20a94ed7e698b08cfabaf.png"><br><br>  Nous regardons combien d'espace et ce qui est consomm√© - il s'av√®re qu'il existe un r√©pertoire pg_xlog: <br><br><pre><code class="plaintext hljs">$ du -csh -t 100M /pgdb/9.6/main/* 15G /pgdb/9.6/main/base 58G /pgdb/9.6/main/pg_xlog 72G </code> </pre> <br>  Les administrateurs de base de donn√©es savent g√©n√©ralement ce qu'est ce r√©pertoire, et ils n'y touchent pas - il existe et existe.  Mais le d√©veloppeur, surtout s'il regarde la mise en sc√®ne, se gratte la t√™te et pense: <br><br>  <i>- Une sorte de journaux ... Supprimons pg_xlog!</i> <br><br>  <b>Supprime le r√©pertoire, la base de donn√©es cesse de fonctionner</b> .  Vous devez imm√©diatement rechercher sur Google comment augmenter la base de donn√©es apr√®s avoir supprim√© les journaux de transactions. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/2b8/1af/30c/2b81af30c865d529e6f7ff3fd66339ce.png"><br><br>  <b>Deuxi√®me exemple</b> .  Encore une fois, nous ouvrons la surveillance et constatons qu'il n'y a pas assez d'espace.  Cette fois, l'endroit est occup√© par une sorte de base. <br><br><pre> <code class="plaintext hljs">$ du -csh -t 100M /pgdb/9.6/main/* 70G /pgdb/9.6/main/base 2G /pgdb/9.6/main/pg_xlog 72G </code> </pre> <br>  Nous recherchons quelle base de donn√©es occupe le plus d'espace, quelles tables et quels index. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/d88/ffc/4e9/d88ffc4e98ca1fd4648ac7aea1c8d019.png"><br><br>  Il s'av√®re qu'il s'agit d'un tableau avec des journaux historiques.  Nous n'avons jamais eu besoin de journaux historiques.  Ils sont √©crits juste au cas o√π, et sans le probl√®me de l'endroit, personne ne les regarderait jusqu'√† la seconde venue: <br><br>  <i>- Nettoyons tout ce qui mm ... plus ancien qu'octobre!</i> <br><br>  Faites une demande de mise √† jour, ex√©cutez-la, cela fonctionnera et supprimera certaines des lignes. <br><br><pre> <code class="plaintext hljs">=# DELETE FROM history_log -# WHERE created_at &lt; ¬´2018-10-01¬ª; DELETE 165517399 Time: 585478.451 ms</code> </pre> <br>  La requ√™te s'ex√©cute pendant 10 minutes, mais la table occupe toujours la m√™me quantit√© d'espace. <br><br>  PostgreSQL supprime les lignes de la table - tout est correct, mais il ne renvoie pas la place au syst√®me d'exploitation.  Ce comportement de PostgreSQL est inconnu de la plupart des d√©veloppeurs et peut √™tre tr√®s surprenant. <br><br>  <b>Le troisi√®me exemple</b> .  Par exemple, ORM a fait une demande int√©ressante.  Habituellement, tout le monde accuse ORM de faire de ¬´mauvaises¬ª requ√™tes qui lisent quelques tableaux. <br><br>  Supposons qu'il existe plusieurs op√©rations JOIN qui lisent des tables en parall√®le dans plusieurs threads.  PostgreSQL peut parall√©liser les op√©rations de donn√©es et lire les tableaux dans plusieurs threads.  Mais, √©tant donn√© que nous avons plusieurs serveurs d'applications, cette requ√™te lit toutes les tables plusieurs milliers de fois par seconde.  Il s'av√®re que le serveur de base de donn√©es est surcharg√©, les disques ne peuvent pas faire face, et tout cela conduit √† une erreur <b>502 Bad Gateway</b> du backend - la base de donn√©es n'est pas disponible. <br><br>  Mais ce n'est pas tout.  Vous pouvez rappeler d'autres fonctionnalit√©s de PostgerSQL. <br><br><ul><li>  <b>Freins des processus d'arri√®re-plan du SGBD</b> - PostgreSQL a toutes sortes de points de contr√¥le, de vides et de r√©plication. <br></li><li>  <b>Frais g√©n√©raux de virtualisation</b> .  Lorsque la base de donn√©es s'ex√©cute sur une machine virtuelle, sur le m√™me morceau de fer, il y a √©galement des machines virtuelles sur le c√¥t√©, et elles peuvent entrer en conflit sur les ressources. <br></li><li>  <b>Le stockage est du fabricant chinois NoName</b> , dont les performances d√©pendent de la lune en Capricorne ou de la position de Saturne, et il n'y a aucun moyen de comprendre pourquoi cela fonctionne de cette fa√ßon.  La base souffre. <br></li><li>  <b>La configuration par d√©faut</b> .  C'est mon sujet pr√©f√©r√©: le client dit que sa base de donn√©es ralentit - vous regardez, et il a une configuration par d√©faut.  Le fait est que la configuration PostgreSQL par d√©faut est con√ßue pour <b>fonctionner sur la th√©i√®re la plus faible</b> .  La base est lanc√©e, √ßa marche, mais quand √ßa marche d√©j√† sur du mat√©riel de milieu de gamme, alors cette config ne suffit pas, il faut la r√©gler. <br></li></ul><br><blockquote>  Le plus souvent, PostgreSQL manque d'espace disque ou de performances disque.  Heureusement, avec des processeurs, de la m√©moire et un r√©seau, en r√®gle g√©n√©rale, tout est plus ou moins en ordre. </blockquote><br>  Comment √™tre  Besoin de surveillance et de planification!  Cela semble √©vident, mais pour une raison quelconque, dans la plupart des cas, personne ne planifie une base, et la surveillance ne couvre pas tout ce qui doit √™tre surveill√© pendant le fonctionnement de PostgreSQL.  Il existe un ensemble de r√®gles claires, avec lesquelles tout fonctionnera bien, et non "au hasard". <br><br><h3>  Planification </h3><br>  <b>H√©bergez la base de donn√©es sur un SSD sans h√©sitation</b> .  Les SSD sont depuis longtemps devenus fiables, stables et productifs.  Les mod√®les SSD d'entreprise existent depuis des ann√©es. <br><br>  <b>Planifiez toujours un sch√©ma de donn√©es</b> .  N'√©crivez pas dans la base de donn√©es que vous doutez de ce qui est n√©cessaire - garanti de ne pas √™tre n√©cessaire.  Un exemple simple est un tableau l√©g√®rement modifi√© d'un de nos clients. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/9e1/56f/9ec/9e156f9ec534a11c5e80180c1c72a987.png"><br><br>  Il s'agit d'une table de journal dans laquelle se trouve une colonne de donn√©es de type json.  Relativement parlant, vous pouvez √©crire n'importe quoi dans cette colonne.  Le dernier enregistrement de ce tableau montre que les journaux occupent 8 Mo.  PostgreSQL n'a aucun probl√®me √† stocker des enregistrements de cette longueur.  PostgreSQL a un tr√®s bon stockage qui m√¢che de tels enregistrements. <br><br>  Mais le probl√®me est que lorsque les serveurs d'applications lisent les donn√©es de cette table, ils obstrueront facilement la totalit√© de la bande passante du r√©seau, et d'autres demandes en souffriront.  C'est le probl√®me de la planification d'un sch√©ma de donn√©es. <br><br>  <b>Utilisez le partitionnement pour tout indice d'une histoire qui doit √™tre stock√©e pendant plus de deux ans</b> .  Le partitionnement semble parfois compliqu√© - vous devez vous soucier des d√©clencheurs, des fonctions qui cr√©eront des partitions.  Dans les nouvelles versions de PostgreSQL, la situation est meilleure et maintenant la configuration du partitionnement est beaucoup plus simple - une fois termin√©e, et fonctionne. <br><br>  Dans l'exemple consid√©r√© de suppression de donn√©es en 10 minutes, <code>DELETE</code> peut √™tre remplac√© par <code>DROP TABLE</code> - une telle op√©ration dans des circonstances similaires ne prendra que quelques millisecondes. <br><br>  Lorsque les donn√©es sont tri√©es par partition, la partition est supprim√©e litt√©ralement en quelques millisecondes et le syst√®me d'exploitation prend le relais imm√©diatement.  La gestion des donn√©es historiques est plus facile, plus facile et plus s√ªre. <br><br><h3>  Suivi </h3><br>  La surveillance est un grand sujet distinct, mais du point de vue de la base de donn√©es, il existe des recommandations qui peuvent s'inscrire dans une section de l'article. <br><br>  Par d√©faut, de nombreux syst√®mes de surveillance assurent la surveillance des processeurs, de la m√©moire, du r√©seau, de l'espace disque, mais, en r√®gle g√©n√©rale, <b>aucun p√©riph√©rique de disque n'est disponible</b> .  Des informations sur la charge des disques, la bande passante actuellement pr√©sente sur les disques et la valeur de latence doivent toujours √™tre ajout√©es √† la surveillance.  Cela vous aidera √† √©valuer rapidement la fa√ßon dont les disques sont charg√©s. <br><br>  Il existe de nombreuses options de surveillance PostgreSQL, il y en a pour tous les go√ªts.  Voici quelques points qui doivent √™tre pr√©sents. <br><br><ul><li>  <b>Clients connect√©s</b> .  Il est n√©cessaire de surveiller les statuts avec lesquels ils travaillent, de trouver rapidement les clients "nuisibles" qui endommagent la base de donn√©es et de les d√©sactiver. </li><li>  <b>Erreurs</b>  Il est n√©cessaire de surveiller les erreurs afin de contr√¥ler le bon fonctionnement de la base de donn√©es: aucune erreur - grande, des erreurs sont apparues - une raison de regarder les journaux et de commencer √† comprendre ce qui ne va pas. </li><li>  <b>Demandes (d√©clarations)</b> .  Nous surveillons les caract√©ristiques quantitatives et qualitatives des demandes afin d'√©valuer approximativement si nous avons des demandes lentes, longues ou gourmandes en ressources. </li></ul><br>  Pour plus d'informations, consultez le rapport <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">¬´PostgreSQL Monitoring Basics¬ª</a> avec HighLoad ++ Siberia et la page <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Monitoring</a> du PostgreSQL Wiki. <br><br>  Lorsque nous avons tout planifi√© et que nous nous ¬´sommes couverts¬ª avec le suivi, nous pouvons encore rencontrer des probl√®mes. <br><br><h3>  Mise √† l'√©chelle </h3><br>  En r√®gle g√©n√©rale, le d√©veloppeur voit la ligne de base de donn√©es dans la configuration.  Il n'est pas particuli√®rement int√©ress√© par la fa√ßon dont il est organis√© en interne - comment fonctionne le point de contr√¥le, la r√©plication, le planificateur.  Le d√©veloppeur a d√©j√† quelque chose √† faire - √† faire il y a beaucoup de choses int√©ressantes qu'il veut essayer. <br><br><blockquote>  "Donnez-moi l'adresse de la base, puis moi-m√™me."  ¬© D√©veloppeur anonyme. </blockquote><br>  L'ignorance du sujet entra√Æne des cons√©quences assez int√©ressantes lorsque le d√©veloppeur commence √† √©crire des requ√™tes qui fonctionnent dans cette base de donn√©es.  Les fantasmes lors de l'√©criture de requ√™tes donnent parfois des effets √©tonnants. <br><br>  Il existe deux types de transactions.  <b>Les transactions OLTP</b> sont rapides, courtes et l√©g√®res qui prennent des fractions de milliseconde.  Ils fonctionnent tr√®s rapidement, et ils sont nombreux.  <b>OLAP - requ√™tes analytiques</b> - lentes, longues, lourdes, lisent de grands tableaux de tableaux et lisent des statistiques. <br><br>  <b>Au</b> cours des 2-3 derni√®res ann√©es, l'abr√©viation <b>HTAP</b> sonne souvent - Transaction hybride / Traitement analytique ou traitement <b>transactionnel-analytique hybride</b> .  Si vous n'avez pas le temps de penser √† la mise √† l'√©chelle et √† la diversit√© des requ√™tes OLAP et OLTP, vous pouvez dire: ¬´Nous avons HTAP!¬ª  Mais l'exp√©rience et la douleur des erreurs montrent qu'apr√®s tout, diff√©rents types de requ√™tes doivent vivre s√©par√©ment les uns des autres, car les longues requ√™tes OLAP bloquent les requ√™tes OLTP l√©g√®res. <br><br>  Nous arrivons donc √† la question de savoir comment faire √©voluer PostgreSQL afin de r√©partir la charge, et tout le monde √©tait satisfait. <br><br>  <b>R√©plication en streaming</b> .  L'option la plus simple est <b>la r√©plication en streaming</b> .  Lorsque l'application fonctionne avec la base de donn√©es, nous connectons plusieurs r√©pliques √† cette base de donn√©es et distribuons la charge.  L'enregistrement va toujours √† la base principale et la lecture aux r√©pliques.  Cette m√©thode vous permet d'√©voluer tr√®s largement. <br><br>  De plus, vous pouvez connecter plus de r√©pliques √† des r√©pliques individuelles et obtenir une <b>r√©plication en cascade</b> .  Des groupes d'utilisateurs ou des applications distincts qui, par exemple, lisent des analyses, peuvent √™tre d√©plac√©s vers une r√©plique distincte. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/7f4/5b3/2d7/7f45b32d7eeb8dfcd7e19cfb38210134.png"><br><br>  <b>Publications logiques, abonnements</b> - le m√©canisme des publications logiques et des abonnements implique la pr√©sence de plusieurs serveurs PostgreSQL ind√©pendants avec des bases de donn√©es et des ensembles de tables distincts.  Ces ensembles de tables peuvent √™tre connect√©s aux bases de donn√©es voisines, ils seront visibles par les applications qui peuvent les utiliser normalement.  Autrement dit, toutes les modifications qui se produisent dans la source sont r√©pliqu√©es sur la base de destination et y sont visibles.  Fonctionne tr√®s bien avec PostgreSQL 10. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/13a/4aa/068/13a4aa06893b4ae9f1a1b7523c407b06.png"><br><br>  <b>Tables √©trang√®res, partitionnement d√©claratif - partitionnement d√©claratif et tables externes</b> .  Vous pouvez prendre plusieurs PostgreSQL et y cr√©er plusieurs ensembles de tables qui stockeront les plages de donn√©es souhait√©es.  Il peut s'agir de donn√©es pour une ann√©e sp√©cifique ou de donn√©es collect√©es sur n'importe quelle plage. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/109/929/cb9/109929cb936d0c040651ad30c130258b.png"><br><br>  En utilisant le m√©canisme des tables externes, vous pouvez combiner toutes ces bases de donn√©es sous la forme d'une table partitionn√©e dans un PostgreSQL s√©par√©.  Une application peut d√©j√† fonctionner avec cette table partitionn√©e, mais en fait, elle lira les donn√©es des partitions distantes.  Lorsque les volumes de donn√©es d√©passent les capacit√©s d'un seul serveur, il s'agit d'un partage. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/446/d13/a39/446d13a394143b988ec04f60e645ea21.png"><br><br>  Tout cela peut √™tre combin√© dans des configurations de diffusion, pour proposer diff√©rentes topologies de r√©plication PostgreSQL, mais comment tout cela fonctionne et comment le g√©rer fait l'objet d'un rapport s√©par√©. <br><br><h3>  Par o√π commencer? </h3><br>  L'option la plus simple est la <b>r√©plication</b> .  La premi√®re √©tape consiste √† r√©partir la charge de lecture et d'√©criture.  Autrement dit, √©crivez au ma√Ætre et lisez √† partir de r√©pliques.  Nous adaptons donc la charge et effectuons la lecture √† partir de l'assistant.  De plus, n'oubliez pas les analystes.  Les requ√™tes analytiques fonctionnent depuis longtemps, elles ont besoin d'une r√©plique distincte avec des param√®tres distincts afin que les longues requ√™tes analytiques ne puissent pas interf√©rer avec le reste. <br><br>  La prochaine √©tape consiste √† <b>√©quilibrer</b> .  Nous avons toujours la m√™me ligne dans la configuration sur laquelle le d√©veloppeur op√®re.  Il a besoin d'un endroit o√π il pourra √©crire et lire.  Il y a plusieurs options ici. <br><br>  L'id√©al est d'impl√©menter l'√©quilibrage <b>au niveau de l'application</b> , lorsque l'application elle-m√™me sait o√π lire les donn√©es et sait comment choisir une r√©plique.  Supposons qu'un solde de compte soit toujours n√©cessaire √† jour et qu'il doive √™tre lu par le ma√Ætre, et que l'image du produit ou les informations le concernant puissent √™tre lues avec un certain retard et effectu√©es √† partir d'une r√©plique. <br><br><ul><li>  <b>DNS Round Robin</b> , √† mon avis, n'est pas une impl√©mentation tr√®s pratique, car parfois cela fonctionne longtemps et ne donne pas le temps n√©cessaire lors du changement de r√¥le d'assistant entre les serveurs en cas de basculement. </li><li>  Une option plus int√©ressante consiste √† utiliser <b>Keepalived et HAProxy</b> .  Les adresses virtuelles pour le ma√Ætre et l'ensemble de r√©pliques sont lanc√©es entre les serveurs HAProxy et HAProxy √©quilibre d√©j√† le trafic. </li><li>  <b>Patroni, DCS</b> en conjonction avec quelque chose comme ZooKeeper, etcd, Consul - l'option la plus int√©ressante, √† mon avis.  Autrement dit, la d√©couverte de service est responsable de l'information qui est le ma√Ætre maintenant et qui est la r√©plique.  Patroni g√®re un cluster de PostgreSQL, effectue la commutation - si la topologie a chang√©, ces informations appara√Ætront dans la d√©couverte de service et les applications pourront rapidement d√©couvrir la topologie actuelle. </li></ul><br>  Et il existe des nuances avec la r√©plication, dont la plus courante est le <b>retard de r√©plication</b> .  Vous pouvez le faire comme GitLab, et lorsque le d√©calage s'accumule, laissez simplement tomber la base.  Mais nous avons un suivi complet - nous l'examinons et constatons de longues transactions. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/619/9a0/fae/6199a0fae7ed88fb1646e232cc1f2953.png"><br><br><h3>  Applications et transactions SGBD </h3><br>  En g√©n√©ral, les transactions lentes et inactives entra√Ænent: <br><br><ul><li>  <b>diminution de la productivit√©</b> - pas √† un spasmodique pointu, mais lisse; <br></li><li>  <b>verrous et blocages</b> , car les transactions longues maintiennent des verrous sur les lignes et emp√™chent les autres transactions de fonctionner; <br></li><li>  <b>50 * Erreurs HTTP sur le backend</b> , erreurs d'interface ou ailleurs. <br></li></ul><br><br>  Examinons un peu la th√©orie sur la fa√ßon dont ces probl√®mes se posent et pourquoi le m√©canisme des transactions longues et inactives est nuisible. <br><br>  PostgreSQL a MVCC - relativement parlant, un moteur de base de donn√©es.  Il permet aux clients de travailler de mani√®re comp√©titive avec les donn√©es sans interf√©rer les uns avec les autres: les lecteurs n'interf√®rent pas avec les lecteurs et les √©crivains n'interf√®rent pas avec les √©crivains.  Bien s√ªr, il y a quelques exceptions, mais dans ce cas, elles ne sont pas importantes. <br><br>  Il s'av√®re que dans la base de donn√©es pour une ligne, il peut y avoir plusieurs versions pour diff√©rentes transactions.  Les clients se connectent, la base de donn√©es leur donne des instantan√©s de donn√©es et au sein de ces instantan√©s, diff√©rentes versions de la m√™me ligne peuvent exister.  Par cons√©quent, dans le cycle de vie de la base de donn√©es, les transactions sont d√©cal√©es, se remplacent mutuellement et des versions de lignes apparaissent dont personne n'a besoin. <br><br>  Il y a donc un <b>besoin pour un collecteur d'ordures - l'aspirateur automatique</b> .  Les transactions longues existent et emp√™chent l'aspiration automatique de nettoyer les versions de ligne inutiles.  Ces donn√©es ind√©sirables commencent √† errer de la m√©moire au disque, du disque √† la m√©moire.  Pour stocker ces d√©chets, les ressources CPU et m√©moire sont gaspill√©es. <br><br><blockquote>  Plus la transaction est longue, plus les performances sont ind√©sirables et moindres. </blockquote><br>  Du point de vue de "Qui est √† bl√¢mer?", L'application est √† bl√¢mer pour l'apparition de longues transactions.  Si la base de donn√©es existe seule, les transactions longues et sans effet ne seront prises nulle part.  En pratique, il existe les options suivantes pour l'apparition de transactions inactives. <br><br>  <b>"Allons √† une source externe</b> . <b>"</b>  L'application ouvre une transaction, fait quelque chose dans la base de donn√©es, puis d√©cide de se tourner vers une source externe, par exemple Memcached ou Redis, dans l'espoir qu'elle reviendra ensuite dans la base de donn√©es, continuera √† travailler et fermera la transaction.  Mais si une erreur se produit dans la source externe, l'application se bloque et la transaction reste ferm√©e jusqu'√† ce que quelqu'un la remarque et la tue. <br><br>  <b>Aucune gestion d'erreur</b> .  D'un autre c√¥t√©, il peut y avoir un probl√®me de gestion des erreurs.  Lorsque, √† nouveau, l'application a ouvert une transaction, a r√©solu un probl√®me dans la base de donn√©es, est retourn√©e √† l'ex√©cution de code, a effectu√© certaines fonctions et calculs, afin de continuer √† travailler dans la transaction et de la fermer.  Lorsque sur ces calculs, l'application a √©t√© interrompue avec une erreur, le code est revenu au d√©but du cycle et la transaction est √† nouveau rest√©e confidentielle. <br><br>  <b>Le facteur humain</b> .  Par exemple, l'administrateur, le d√©veloppeur, l'analyste, travaille dans certains pgAdmin ou dans DBeaver - a ouvert une transaction, y fait quelque chose.  Puis la personne a √©t√© distraite, elle est pass√©e √† une autre t√¢che, puis √† la troisi√®me, a oubli√© la transaction, est partie pour le week-end, et la transaction continue de se bloquer.  Les performances de base en souffrent. <br><br>  Voyons quoi faire dans ces cas. <br><br><ul><li>  Nous avons une surveillance; en cons√©quence, nous avons besoin d' <b>alertes dans la surveillance</b> .  Toute transaction qui se bloque pendant plus d'une heure et ne fait rien est une occasion de voir d'o√π elle vient et de comprendre ce qui ne va pas. </li><li>  L'√©tape suivante consiste √† <b>tirer ces transactions via la t√¢che dans la couronne</b> (pg_terminate_backend (pid)) ou √† configurer dans la configuration PostgreSQL.  Des seuils de 10 √† 30 minutes sont n√©cessaires, apr√®s quoi les transactions sont automatiquement termin√©es. </li><li>  <b>Refactorisation d'application</b> .  Bien s√ªr, vous devez savoir d'o√π viennent les transactions inactives, pourquoi elles se produisent et √©liminer ces endroits. </li></ul><br><blockquote>  √âvitez les transactions longues √† tout prix, car elles affectent consid√©rablement les performances de la base de donn√©es. </blockquote><br>  Tout devient encore plus int√©ressant lorsque des t√¢ches en attente apparaissent, par exemple, vous devez calculer soigneusement les unit√©s.  Et nous arrivons √† la question de la construction de v√©los. <br><br><h3>  Construction de v√©los </h3><br>  Sujet douloureux.  Les entreprises du c√¥t√© des applications doivent effectuer un traitement en arri√®re-plan des √©v√©nements.  Par exemple, pour calculer des agr√©gats: minimum, maximum, valeur moyenne, envoyer des notifications aux utilisateurs, √©mettre des factures aux clients, configurer un compte d'utilisateur apr√®s l'enregistrement ou vous inscrire dans les services voisins - effectuez un traitement diff√©r√©. <br><br>  L'essence de ces t√¢ches est la m√™me - elles sont report√©es pour plus tard.  Des tables apparaissent dans la base de donn√©es qui ex√©cutent simplement les files d'attente. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/ef4/bfa/f20/ef4bfaf20634c6d43941c9c8325a09ff.png"><br><br>  Voici l'identifiant de la t√¢che, l'heure √† laquelle la t√¢che a √©t√© cr√©√©e, sa mise √† jour, le gestionnaire qui l'a prise, le nombre de tentatives √† effectuer.  Si vous avez une table qui ressemble m√™me √† distance √† celle-ci, vous disposez de <b>files d'attente auto-√©crites</b> . <br><br>  Tout cela fonctionne bien jusqu'√† ce que de longues transactions apparaissent.  Apr√®s cela, les <b>tables qui fonctionnent avec les files d'attente gonflent de taille</b> .  De nouveaux travaux sont ajout√©s tout le temps, les anciens sont supprim√©s, les mises √† jour se produisent - un tableau avec un enregistrement intensif est obtenu.  Il doit √™tre nettoy√© r√©guli√®rement des versions obsol√®tes des cha√Ænes afin que les performances ne souffrent pas. <br><br>  <b>Le temps de traitement s'allonge</b> - une longue transaction verrouille les versions obsol√®tes des rang√©es ou emp√™che l'aspirateur de les nettoyer.  Lorsque la taille du tableau augmente, le temps de traitement augmente √©galement, car vous devez lire de nombreuses pages avec des ordures.  Le temps augmente et la <b>file d'attente cesse √† un moment donn√© de fonctionner</b> . <br><br>  Voici un exemple du haut de l'un de nos clients, qui avait une file d'attente.  Toutes les demandes sont uniquement li√©es √† la file d'attente. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/344/203/7ac/3442037ac837daec02ee89a83bd53dd7.png"><br><br>  Faites attention au temps d'ex√©cution de ces requ√™tes - toutes sauf une fonctionnent pendant plus de vingt secondes. <br><br>  Pour r√©soudre ces probl√®mes, <b>Skytools PgQ</b> , un gestionnaire de files d'attente pour PostgreSQL, a √©t√© invent√© il y a longtemps.  Ne r√©inventez pas votre v√©lo - prenez PgQ, installez-le une fois et oubliez les lignes. <br><br>  Certes, il a √©galement des fonctionnalit√©s.  Skytools PgQ a <b>peu de documentation</b> .  Apr√®s avoir lu la page officielle, on a l'impression qu'il n'a rien compris.  Le sentiment grandit lorsque vous essayez de faire quelque chose.  Tout fonctionne, mais <b>son fonctionnement n'est pas clair</b> .  Une sorte de magie Jedi.  Mais beaucoup d'informations peuvent √™tre trouv√©es dans les <b>listes de diffusion</b> .  Ce n'est pas un format tr√®s pratique, mais il y a beaucoup de choses int√©ressantes, et vous devrez lire ces feuilles. <br><br>  Malgr√© les inconv√©nients, Skytools PgQ fonctionne sur le principe de ¬´configurer et oublier¬ª.   ,    ,     ,    .   PgQ ,        .  PgQ ,      . <br><br><blockquote>    ,   -     ‚Äî  ,   .     . </blockquote><br>              PgQ. ,    PostgreSQL, ,  ,   PgQ  .    ,   . <br><br><h3>  </h3><br>        ,          .   ,    , ,     - ,   , ,      . ,       ,       ,   alter. <br><br>     <b>auto-failover</b> ‚Äî       PostgreSQL  - ,       ,        .      ,    auto-failover. <br><br> <b>Split-brain</b> .    PostgreSQL     ,     ,  ‚Äî  .   ,   .   PostgreSQL     fencing,     Kubernets    .     -    ,         .   Split-brain. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/327/239/97e/32723997e13e8427e4cddc59ea7c964f.png"><br><br>           .  GitHub   Split-brain,       . <br><br> <b>Cascade failover</b> . ,     .  ,         . <br><br><img src="https://habrastorage.org/getpro/habr/post_images/ea9/864/d63/ea9864d63b7cebd46ff8b185ddb5d639.png"><br><br>        ,       .    ,       . <br><br><img src="https://habrastorage.org/getpro/habr/post_images/81d/243/fc1/81d243fc1500011f0f3c24576f81786a.png"><br><br>         ‚Äî   failover. <br><br>      auto-failover,    . <br><br> <b>Bash </b> ‚Äî  ,      .   ,     ,   .   - ,   ,   .     . <br><br> <b>Ansible playbooks</b> ‚Äî bash-  .    ,   ,    . <br><br> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><b>Patroni</b></a> ‚Äî   ,    ,      auto-failover,   ,       service discovery. <br><br> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><b>PAF</b></a> ‚Äî <b>  Pacemaker</b> .     auto-failover  PostgreSQL,        Pacemaker. <br><br> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><b>Stolon</b></a>     .  Kubernetes, . Stolon  Patroni,        . <br><br><h3>    </h3><br>    Docker  Kubernetes .    ,     . <br><br><img src="https://habrastorage.org/getpro/habr/post_images/b99/aba/8c4/b99aba8c4f9c959cd96840bfcd3359b2.png"><br><br>        ,       . <i> ¬´      Kubernetes...¬ª</i>    . <br><br> <b> ‚Äî   stateful</b> ,   - .  O??      .   Open Source: CEPH, GlusterFS, LinStor DRBD.    ,       , ,     . <br><br>       ‚Äî <b>    </b> . ,      Kubernetes,     CEPH.         ‚Äî    .           ,       . <br><br><ul><li> <b>  </b> ,           . </li><li> <b>     latency</b> .  latency        ‚Äî    . </li><li> <b>   </b> . Kubernetes ,    - . ,    shared storage  Kubernetes,       .  -         . </li></ul><br>     ,    Kubernetes  Docker    staging  dev-     .    ,   , Kubernetes      . <br><br><img src="https://habrastorage.org/getpro/habr/post_images/b04/8dd/fd0/b048ddfd0b6212ef2d1eb49eda02386b.png"><br><br>    ,     <b>local volumes ‚Äî  </b>     , <b>streaming replication ‚Äî   </b> ,       <b>PostgreSQL-</b> ,       ‚Äî ,   .       : <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Zalando</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Crunchy</a> . <br><br>    ,     .    issues  pull requests.   ,     ,     . <br><br><h2>  R√©sum√© </h2><br> <b>         SSD</b> ‚Äî          ,    . <br><br> <b>     </b> .   JSON  8  ‚Äî  ,   . <br><br> <b> </b> ,        .  PostgreSQL,   . <br><br> <b>  ‚Äî Postgres is ready</b> .          . PostgreSQL   ,        .    : <b>streaming replication; publications, subscriptions; foreign Tables; declarative partitioning</b> . <br><br> <b>    </b> .      ,    . <br><br>    -,      ,   ‚Äî <b>   </b> .    .    ,  Skytools PgQ! <br><br> <b>     Kubernetes,  local volumes, streaming replication  PostgreSQL </b> .     - ,   ,      . <br><br><blockquote>               .     ,   24  25   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">HighLoad++ Siberia</a>     <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="></a>  ,    ,           .   38    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="></a> ‚Äî     ! </blockquote></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr455248/">https://habr.com/ru/post/fr455248/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr455236/index.html">Comodo r√©voque les certificats sans raison</a></li>
<li><a href="../fr455240/index.html">Utilisation du taux de d√©fauts rejet√©s pour am√©liorer le rapport d'erreurs</a></li>
<li><a href="../fr455242/index.html">Moins d'oreilles ou comment ne pas g√¢cher le son du jeu d√®s le d√©but</a></li>
<li><a href="../fr455244/index.html">Bande dessin√©e "Soldering is Easy" dans la version mise √† jour (2019)</a></li>
<li><a href="../fr455246/index.html">L'inscription √† la Journ√©e de l'exp√©rience client √† Saint-P√©tersbourg est ouverte le 20 juin</a></li>
<li><a href="../fr455250/index.html">Celui qui a ressuscit√© Duke Nukem: entretien avec Randy Pitchford, magicien de Gearbox</a></li>
<li><a href="../fr455252/index.html">.NET: Outils pour travailler avec le multithread et l'asynchronie - Partie 1</a></li>
<li><a href="../fr455256/index.html">Habr Weekly # 4 / Computex, comment b√™ta-t-on Apple, Durov meurt de faim, BadComedian cat, pourquoi le r√©seau de neurones a-t-il cherch√© des acteurs porno</a></li>
<li><a href="../fr455258/index.html">Le vote pour les rapports de la section Backend √† l'anniversaire de DevConfX a commenc√©, qui se tiendra les 21 et 22 juin √† Moscou</a></li>
<li><a href="../fr455260/index.html">Merkle Tree: rouill√© et rapide</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>