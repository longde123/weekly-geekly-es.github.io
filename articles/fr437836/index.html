<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üîä ü•í üí© Under the hood Screeps - virtualisation dans le sandbox MMO pour les programmeurs üö¥üèΩ ü§ûüèø üë©‚Äçüë©‚Äçüëß‚Äçüëß</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Dans cet article, je parlerai d'une technologie peu connue qui a trouv√© une application cl√© dans notre jeu en ligne pour les programmeurs. Afin de ne ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Under the hood Screeps - virtualisation dans le sandbox MMO pour les programmeurs</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/437836/"><p> Dans cet article, je parlerai d'une technologie peu connue qui a trouv√© une application cl√© dans notre jeu en ligne pour les programmeurs.  Afin de ne pas tirer sur le caoutchouc pendant longtemps, il y a un spoiler tout de suite: il semble que personne n'ait fait un tel chamanisme dans le code Node.js natif auquel nous sommes arriv√©s apr√®s plusieurs ann√©es de d√©veloppement.  Le moteur de machine virtuelle isol√©e (open source), qui fonctionne sous le capot du projet, a √©t√© √©crit sp√©cifiquement pour ses besoins et est actuellement utilis√© en production par nous et une autre startup.  Et les capacit√©s d'isolement qu'il donne sont uniques et m√©ritent d'√™tre racont√©es √† leur sujet. </p><br><p>  Mais parlons de tout dans l'ordre. </p><br><h2>  Contexte </h2><br><p>  Aimez-vous la programmation?  Pas l'entreprise de codage de routine que beaucoup d'entre nous sont oblig√©s de faire 40 heures par semaine, aux prises avec la procrastination, verser des litres de caf√© et br√ªler professionnellement;  et la <i>programmation</i> est un processus magique incomparable de transformation des pens√©es en programme de travail, prenant plaisir √† ce que le code que vous venez d'√©crire s'incarne √† l'√©cran et commence √† vivre la vie que le cr√©ateur lui raconte.  √Ä de tels moments, je veux √©crire le mot "Cr√©ateur" avec une lettre majuscule - un tel sentiment qui surgit dans le processus est parfois proche de la r√©v√©rence. </p><br><p><img src="https://habrastorage.org/webt/mm/2a/5h/mm2a5hmu2k6s26hviyoykwd6tv8.jpeg"></p><br><p>  Il est dommage que tr√®s peu de projets r√©els li√©s aux revenus quotidiens puissent offrir de tels sentiments √† leurs d√©veloppeurs.  Le plus souvent, afin de ne pas perdre la passion de la programmation, les passionn√©s doivent commencer une affaire de c√¥t√©: un passe-temps de programmation, un projet pour animaux de compagnie, un open-source √† la mode, juste un script python pour automatiser leur maison intelligente ... ou le comportement d'un personnage dans certains sites populaires en ligne jeu. </p><a name="habracut"></a><br><p>  Oui, ce sont les jeux en ligne qui constituent souvent une source d'inspiration in√©puisable pour les programmeurs.  M√™me les tout premiers jeux de ce genre (Ultima Online, Everquest, sans parler de toutes sortes de MUDs) ont attir√© de nombreux artisans qui ne s'int√©ressent pas tant √† jouer le r√¥le et √† profiter de la fantaisie du monde, mais dans l'application de leurs talents pour automatiser tout et tout dans espace de jeu virtuel.  Et √† ce jour, cela reste une discipline sp√©ciale de l'Olympiade MMO Games en ligne: affiner votre esprit en √©crivant votre bot afin qu'il passe inaper√ßu par l'administration et obtienne le maximum de profit par rapport aux autres joueurs.  Ou d'autres robots - comme, par exemple, dans EVE Online, o√π le commerce sur des march√©s dens√©ment peupl√©s est l√©g√®rement moins que totalement contr√¥l√© par les scripts de trading, tout comme sur les √©changes r√©els. </p><br><p>  L'id√©e d'un jeu en ligne, <em>initialement et compl√®tement orient√© vers les programmeurs,</em> planait dans l'air.  Un tel jeu dans lequel l'√©criture d'un bot n'est pas un acte punissable, mais l'essence du gameplay.  O√π la t√¢che ne serait pas d'ex√©cuter les m√™mes actions ¬´Tuer X monstres et trouver des objets Y¬ª de temps en temps, mais d'√©crire un script qui peut effectuer correctement ces actions en votre nom.  Et comme cela implique un jeu en ligne dans le genre MMO, la rivalit√© se d√©roule avec les scripts des autres joueurs en temps r√©el dans un seul monde de jeu commun. </p><br><p>  Ainsi, en 2014, le jeu Screeps (√† partir des mots "Scripts" et "creeps") est apparu - un sandbox strat√©gique MMO en temps r√©el avec un seul grand <em>monde persistant</em> dans lequel les joueurs n'ont aucune influence sur ce qui se passe, sauf en √©crivant des scripts AI pour leurs unit√©s de jeu. .  Toutes les m√©caniques d'un jeu strat√©gique ordinaire - extraction de ressources, construction d'unit√©s, construction d'une base, saisie de territoires, fabrication et commerce - le joueur lui-m√™me doit √™tre programm√© via l'API JavaScript fournie par le monde du jeu.  La diff√©rence entre les diff√©rentes comp√©titions en mati√®re d'√©criture de l'IA est que le monde du jeu, comme il devrait l'√™tre dans le monde du jeu en ligne, fonctionne constamment et vit sa vie en temps r√©el 24/7 au cours des 4 derni√®res ann√©es, lan√ßant l'IA de chaque joueur √† chaque cycle de jeu. </p><br><p>  Donc, assez sur le jeu lui-m√™me - cela devrait √™tre suffisant pour mieux comprendre l'essence des probl√®mes techniques que nous avons rencontr√©s pendant le d√©veloppement.  Vous pouvez obtenir plus de vues de cette vid√©o, mais cela est facultatif: </p><br><div class="spoiler">  <b class="spoiler_title">Bande-annonce vid√©o</b> <div class="spoiler_text"><iframe width="560" height="315" src="https://www.youtube.com/embed/ZboTgOajnGg" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe></div></div><br><h2>  Probl√®mes techniques </h2><br><p>  L'essence de la m√©canique du monde du jeu est la suivante: le monde entier est divis√© en <strong>salles</strong> , qui sont reli√©es entre elles par des sorties sur quatre points cardinaux.  Une pi√®ce est une unit√© atomique du processus de traitement de l'√©tat du monde du jeu.  La salle peut avoir certains objets (par exemple, des unit√©s) qui ont leur propre √©tat, et √† chaque √©tape du jeu, ils re√ßoivent des commandes des joueurs.  Le gestionnaire de serveur prend une salle √† la fois, ex√©cute ces commandes, modifie l'√©tat des objets et valide le nouvel √©tat de la salle dans la base de donn√©es.  Ce syst√®me √©volue bien horizontalement: vous pouvez ajouter plus de gestionnaires au cluster, et comme les salles sont isol√©es architecturalement les unes des autres, autant de salles peuvent √™tre trait√©es en parall√®le qu'il y a de gestionnaires en cours d'ex√©cution. </p><br><p><img src="https://habrastorage.org/webt/mp/d0/ed/mpd0ed40jp8efrihjrxkfft49fc.png"></p><br><p>  En ce moment, nous avons <strong>42 060 chambres</strong> dans le jeu.  Un cluster de serveurs de 36 machines physiques quad-core contient 144 processeurs.  Nous utilisons Redis pour cr√©er des files d'attente, l'ensemble du backend est √©crit dans Node.js. </p><br><p>  Ce fut une √©tape du jeu tactique.  Mais d'o√π viennent les √©quipes de joueurs?  Les sp√©cificit√©s du jeu est qu'il n'y a pas d'interface o√π vous pouvez cliquer sur une unit√© et lui dire d'aller √† un certain point ou de construire une structure sp√©cifique.  Le maximum qui peut √™tre fait dans l'interface est de mettre un drapeau intangible au bon endroit dans la pi√®ce.  Pour que l'unit√© vienne √† cet endroit et prenne les mesures n√©cessaires, il est n√©cessaire que votre script fasse quelque chose comme ceci pour plusieurs ticks de jeu: </p><br><pre><code class="javascript hljs"><span class="hljs-built_in"><span class="hljs-built_in">module</span></span>.exports.loop = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> creep = Game.creeps[<span class="hljs-string"><span class="hljs-string">'Creep1'</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> flag = Game.flags[<span class="hljs-string"><span class="hljs-string">'Flag1'</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(!creep.pos.isEqualTo(flag.pos)) { creep.moveTo(flag.pos); } }</code> </pre> <br><p>  Il s'av√®re qu'√† chaque √©tape du jeu, vous devez prendre la fonction de <code>loop</code> du joueur, l'ex√©cuter dans un environnement JavaScript √† part enti√®re de ce joueur particulier (dans lequel l'objet de <code>Game</code> form√© pour lui existe), obtenir un ensemble d'ordres pour les unit√©s et les donner √† la prochaine √©tape de traitement.  Tout semble assez simple. </p><br><p><img src="https://habrastorage.org/webt/po/om/vh/poomvhcw4nhpjcsgk2df0a5hg_e.png"></p><br><p>  Les probl√®mes commencent quand il s'agit des nuances de mise en ≈ìuvre.  √Ä l'heure actuelle, nous avons <strong>1600 joueurs actifs</strong> dans le monde.  Les scripts de joueurs individuels ne peuvent d√©j√† pas √™tre appel√©s ¬´scripts¬ª - certains d'entre eux contiennent jusqu'√† 25 <strong>000 lignes de code</strong> , sont compil√©s √† partir de TypeScript ou m√™me de C / C ++ / Rust via WebAssembly (oui, nous prenons en charge le wasm!), Et impl√©mentent le concept de v√©ritables syst√®mes d'exploitation miniatures, dans lequel les joueurs ont d√©velopp√© leur propre pool de processus de t√¢ches de jeu et leur gestion √† travers le noyau, qui prend autant de t√¢ches qu'il s'av√®re effectuer sur un tact donn√© d'un jeu, les ex√©cute et les remet en file d'attente jusqu'√† la prochaine mesure.  √âtant donn√© que le processeur et la m√©moire du lecteur sont limit√©s √† chaque cycle d'horloge, ce mod√®le fonctionne bien.  Bien que ce ne soit pas obligatoire - pour d√©marrer le jeu, il suffit qu'un d√©butant prenne un script de 15 lignes, qui est √©galement d√©j√† √©crit dans le cadre du tutoriel. </p><br><p>  Mais rappelons-nous maintenant que le script du lecteur devrait fonctionner dans une vraie machine JavaScript.  Et que le jeu fonctionne en temps r√©el - c'est-√†-dire que la machine JavaScript de chaque joueur doit constamment exister, travailler √† un certain rythme, afin de ne pas ralentir le jeu dans son ensemble.  L'√©tape d'ex√©cution des scripts de jeu et de formation des ordres pour les unit√©s fonctionne approximativement sur le m√™me principe que les salles de traitement - le script de chaque joueur est une t√¢che assum√©e par un gestionnaire de la piscine, de nombreux gestionnaires parall√®les travaillent dans le cluster.  Mais contrairement au stade des salles de traitement, il y a d√©j√† beaucoup de difficult√©s. </p><br><p>  Premi√®rement, vous ne pouvez pas simplement r√©partir les t√¢ches par les gestionnaires au hasard √† chaque cycle d'horloge, comme c'est possible dans le cas des salles.  La machine JavaScript du lecteur devrait fonctionner sans interruption, chaque mesure suivante n'est qu'un nouvel appel de fonction de <code>loop</code> , mais le contexte global devrait continuer d'exister de la m√™me mani√®re.  En gros, le jeu vous permet de faire quelque chose comme ceci: </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">let</span></span> counter = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> song = [<span class="hljs-string"><span class="hljs-string">'EX-'</span></span>, <span class="hljs-string"><span class="hljs-string">'TER-'</span></span>, <span class="hljs-string"><span class="hljs-string">'MI-'</span></span>, <span class="hljs-string"><span class="hljs-string">'NATE!'</span></span>]; <span class="hljs-built_in"><span class="hljs-built_in">module</span></span>.exports.loop = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ Game.creeps[<span class="hljs-string"><span class="hljs-string">'DalekSinger'</span></span>].say(song[counter]); counter++; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(counter == song.length) { counter = <span class="hljs-number"><span class="hljs-number">0</span></span>; } }</code> </pre> <br><p><img src="https://habrastorage.org/webt/sz/sk/je/szskjecusiurkgvg1apq3sxzjdw.gif"></p><br><p>  Un tel fluage chantera sur une ligne de la chanson √† chaque battement de jeu.  Le num√©ro de ligne du <code>counter</code> morceaux est stock√© dans un contexte global qui est stock√© entre les mesures.  Si chaque fois que le script de ce joueur est ex√©cut√© dans un nouveau processus de gestionnaire, le contexte sera perdu.  Cela signifie que tous les joueurs doivent √™tre attribu√©s √† des gestionnaires sp√©cifiques et qu'ils doivent √™tre modifi√©s le moins possible.  Mais qu'en est-il de l'√©quilibrage de charge?  Un joueur peut passer 500 ms d'ex√©cution sur ce n≈ìud, et l'autre joueur peut passer 10 ms, et il est tr√®s difficile de le pr√©voir √† l'avance.  Si 20 joueurs de 500 ms tombent chacun sur un n≈ìud, le fonctionnement d'un tel n≈ìud prendra 10 secondes, pendant lesquelles tous les autres attendront son ach√®vement et resteront inactifs.  Et pour r√©√©quilibrer ces joueurs et les lancer vers d'autres n≈ìuds, vous devez perdre leur contexte. </p><br><p>  Deuxi√®mement, l'environnement du joueur doit √™tre bien isol√© des autres joueurs et de l'environnement du serveur.  Et cela concerne non seulement la s√©curit√©, mais aussi le confort des utilisateurs eux-m√™mes.  Si un joueur voisin fonctionnant sur le m√™me n≈ìud du cluster que moi le fait horriblement, g√©n√®re beaucoup de d√©chets et se comporte g√©n√©ralement de mani√®re incorrecte, alors je ne devrais pas le sentir.  √âtant donn√© que la ressource CPU dans le jeu est le temps d'ex√©cution du script (il est calcul√© du d√©but √† la fin de la m√©thode de <code>loop</code> ), le gaspillage de ressources sur les t√¢ches √©trang√®res lors de l'ex√©cution de mon script peut √™tre tr√®s sensible, car il est d√©pens√© √† partir de mon budget de ressources CPU. </p><br><p>  En essayant de r√©soudre ces probl√®mes, nous avons trouv√© plusieurs solutions. </p><br><h2 id="pervaya-versiya">  Premi√®re version </h2><br><p>  La premi√®re version du moteur de jeu √©tait bas√©e sur deux √©l√©ments de base: </p><br><ul><li>  module <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><code>vm</code></a> temps plein dans la livraison de Node.js, </li><li>  fork des processus d'ex√©cution. </li></ul><br><p>  Cela ressemblait √† √ßa.  Sur chaque machine du cluster, il y avait 4 (selon le nombre de c≈ìurs) processus de gestionnaires de script de jeu.  Lorsqu'une nouvelle t√¢che a √©t√© re√ßue de la file d'attente de scripts de jeu, le gestionnaire a demand√© les donn√©es n√©cessaires √† la base de donn√©es et les a transf√©r√©es au processus enfant, qui a √©t√© maintenu dans un √©tat en cours d'ex√©cution, red√©marr√© en cas d'√©chec et r√©utilis√© par diff√©rents joueurs.  Le processus enfant, isol√© du parent (qui contenait la logique m√©tier du cluster), ne pouvait que faire une chose: cr√©er un objet <code>Game</code> partir des donn√©es re√ßues et d√©marrer la machine virtuelle du joueur.  Pour commencer, nous avons utilis√© le module <code>vm</code> dans Node.js. </p><br><p>  Pourquoi cette d√©cision √©tait-elle imparfaite?  √Ä strictement parler, les deux probl√®mes ci-dessus n'ont pas √©t√© r√©solus ici. </p><br><p>  <code>vm</code> fonctionne dans le m√™me mode monothread que Node.js.  Par cons√©quent, pour disposer de quatre processeurs parall√®les sur chaque c≈ìur d'une machine √† 4 c≈ìurs, vous devez disposer de 4 processus.  D√©placer un acteur ¬´vivant¬ª dans un processus vers un autre processus conduit √† une recr√©ation compl√®te du contexte global, m√™me si cela se produit au sein de la m√™me machine. </p><br><p><img src="https://habrastorage.org/webt/mu/pk/xl/mupkxlqzbbgh4zjnnymqjdjapm0.png"></p><br><p>  De plus, <code>vm</code> ne cr√©e pas r√©ellement une machine virtuelle enti√®rement isol√©e.  Ce qu'il fait est simplement de cr√©er un <em>contexte</em> ou une port√©e isol√©, mais d'ex√©cuter le code dans la m√™me instance de la machine virtuelle JavaScript, d'o√π <code>vm.runInContext</code> appel <code>vm.runInContext</code> .  Et cela signifie - dans le m√™me cas o√π d'autres joueurs sont lanc√©s.  Bien que les joueurs soient s√©par√©s par des contextes globaux isol√©s, mais, faisant partie de la m√™me machine virtuelle, ils ont une m√©moire de tas commune, un garbage collector commun et g√©n√®rent des d√©chets ensemble.  Si le joueur ¬´A¬ª a g√©n√©r√© beaucoup d'ordures pendant l'ex√©cution de son script de jeu, le travail termin√© et le contr√¥le pass√© au joueur ¬´B¬ª, alors √† ce moment-l√† <em>toutes les</em> ordures du processus peuvent √™tre collect√©es, et le joueur ¬´B¬ª paiera du temps CPU pour la collecte la poubelle de quelqu'un d'autre.  Sans parler du fait que tous les contextes fonctionnent dans la m√™me boucle d'√©v√©nements, et th√©oriquement il est possible d'ex√©cuter la promesse de quelqu'un d'autre √† tout moment, bien que nous ayons essay√© d'emp√™cher cela.  De plus, <code>vm</code> ne vous permet pas de contr√¥ler la quantit√© de m√©moire de tas allou√©e pour l'ex√©cution de script, toute la m√©moire de processus est disponible. </p><br><h2 id="isolated-vm">  vm-isol√© </h2><br><p>  Il vit une personne si merveilleuse nomm√©e Marcel Laverde.  Pour certains, il est devenu remarquable pour avoir √©crit une biblioth√®que de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">fibres</a> nodales, pour d'autres, pour avoir <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">pirat√© Facebook et a √©t√© embauch√© pour y travailler</a> .  Et pour nous, il est merveilleux car il a g√©n√©reusement particip√© √† notre toute premi√®re campagne de crowdfunding et √† ce jour est un grand fan de Screeps. </p><br><p>  Notre projet est en open source depuis plusieurs ann√©es maintenant - le serveur de jeu est publi√© sur GitHub.  Bien que le client officiel soit vendu moyennant des frais via Steam, il existe des versions alternatives de celui-ci, et le serveur lui-m√™me est disponible pour √©tude et modification √† n'importe quelle √©chelle, ce que nous encourageons vivement. </p><br><p>  Et une fois que Marcel nous √©crit: "Les gars, j'ai une bonne exp√©rience en d√©veloppement natif C / C ++ pour Node.js, et j'aime votre jeu, mais je n'aime pas comment √ßa fonctionne dans tout - √©crivons-en un tout nouveau technologie de lancement de machine virtuelle pour Node.js sp√©cifiquement pour Screeps? " </p><br><p>  Comme Marcel n'a pas demand√© d'argent, nous n'avons pas pu refuser.  Apr√®s plusieurs mois de coop√©ration, la biblioth√®que <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><strong>isolated-vm</strong></a> est n√©e.  Et cela a absolument tout chang√©. </p><br><p>  <code>isolated-vm</code> diff√®re de <code>vm</code> en ce qu'il n'isole pas le <em>contexte</em> , mais <em>isole</em> en termes de <abbr title="Moteur JavaScript utilis√© dans Node.js">V8</abbr> .  Sans entrer dans les d√©tails, cela signifie qu'une instance distincte √† part enti√®re de la machine JavaScript est cr√©√©e, qui a non seulement son propre contexte global, mais aussi sa propre m√©moire de tas, le garbage collector et fonctionne dans le cadre d'une boucle d'√©v√©nements distincte.  Parmi les inconv√©nients: pour chaque machine en marche, une petite surcharge de RAM est requise (environ 20 Mo), et il est √©galement impossible de transf√©rer des objets ou d'appeler des fonctions directement dans la machine, l'ensemble du central doit √™tre s√©rialis√©.  Cela met fin aux inconv√©nients, le reste - c'est juste une panac√©e! </p><br><p><img src="https://habrastorage.org/webt/gh/cz/5v/ghcz5vxih2oaferse6kgv-zruvq.png"></p><br><p>  Maintenant, il est vraiment possible d'ex√©cuter le script de chaque joueur dans son propre espace compl√®tement isol√©.  Le joueur a ses propres 500 Mo de hanche, si cela se termine, cela signifie que c'est votre propre hanche qui a pris fin, et non la hanche du processus global.  Si vous avez g√©n√©r√© des d√©chets - alors ce sont vos propres d√©chets, vous devez les collecter.  Les promesses pendantes ne seront ex√©cut√©es que lorsque votre isolat prendra le relais la prochaine fois, et pas plus t√¥t.  Eh bien et la s√©curit√© - en aucun cas il n'est possible d'acc√©der quelque part en dehors de l'isolat, uniquement si vous trouvez quelque part une vuln√©rabilit√© au niveau V8. </p><br><p>  Mais qu'en est-il de l'√©quilibre?  Un autre avantage de isolated-vm est qu'il d√©marre les machines √† partir du m√™me processus, mais dans des threads s√©par√©s (l'exp√©rience de Marcel avec les fibres nodales est ici utile).  Si nous avons une machine √† 4 c≈ìurs, nous pouvons cr√©er un pool de 4 threads et d√©marrer 4 machines parall√®les en m√™me temps.  Dans le m√™me temps, √©tant dans le m√™me processus, ce qui signifie avoir une m√©moire commune, nous pouvons transf√©rer n'importe quel joueur d'un thread √† un autre √† l'int√©rieur de ce pool.  Bien que chaque joueur reste li√© √† un processus sp√©cifique sur une machine sp√©cifique (afin de ne pas perdre le contexte global), l'√©quilibre entre 4 threads est suffisant pour r√©soudre les probl√®mes de distribution des joueurs "lourds" et "l√©gers" entre les n≈ìuds afin que tous les processeurs finissent travailler en m√™me temps et √† l'heure. </p><br><p>  Apr√®s avoir ex√©cut√© cette fonction en mode exp√©rimental, nous avons re√ßu une √©norme quantit√© de commentaires positifs de joueurs dont les scripts ont commenc√© √† fonctionner beaucoup mieux, plus stables et plus pr√©visibles.  Et maintenant, c'est notre moteur par d√©faut, bien que les joueurs puissent toujours choisir le runtime h√©rit√© uniquement pour une compatibilit√© descendante avec les anciens scripts (certains joueurs se sont consciemment concentr√©s sur les sp√©cificit√©s de l'environnement partag√© dans le jeu). </p><br><p>  Bien s√ªr, il y a encore de la place pour l'optimisation, et il y a aussi d'autres domaines int√©ressants du projet dans lesquels nous avons r√©solu divers probl√®mes techniques.  Mais plus √† ce sujet une autre fois. </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr437836/">https://habr.com/ru/post/fr437836/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr437826/index.html">Comment nous avons migr√© la base de donn√©es de Redis et Riak KV vers PostgreSQL. Partie 1: le processus</a></li>
<li><a href="../fr437828/index.html">Webinaire ouvert "SELECT ordre d'ex√©cution des requ√™tes et plan de requ√™te dans MS SQL Server"</a></li>
<li><a href="../fr437830/index.html">Programmation fiable par langage - revue noob. Partie 1</a></li>
<li><a href="../fr437832/index.html">Open source: humour de code, astuces de code, PAS de code</a></li>
<li><a href="../fr437834/index.html">Deux histoires sur la fa√ßon dont les √©v√©nements de programmation ont eu lieu √† Iekaterinbourg</a></li>
<li><a href="../fr437838/index.html">Les technologies d'apprentissage automatique acc√©l√®rent parfois le processus d'adaptation des patients aux proth√®ses bioniques</a></li>
<li><a href="../fr437842/index.html">L'histoire secr√®te de Donkey Kong: des machines d'arcade √† NES</a></li>
<li><a href="../fr437844/index.html">Les conflits persistants entre le typage statique et le typage dynamique - TypeScript n'aidera pas</a></li>
<li><a href="../fr437846/index.html">bobaoskit - accessoires, dnssd et WebSocket</a></li>
<li><a href="../fr437848/index.html">Nous rendons le processus de d√©veloppement de logiciels lourds pour microcontr√¥leurs plus pratique (non)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>