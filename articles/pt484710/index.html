<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üñ®Ô∏è üèïÔ∏è üïô Quebrando as Regras da Coleta de Lixo da Unidade üèÇüèæ ü•ô üçö</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Era uma vez, um programador de jogos de unidade chamado Lancelot. Muito apaixonado, eu diria. Ele ainda n√£o sabia, mas acabaria enfrentando o lado mai...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Quebrando as Regras da Coleta de Lixo da Unidade</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/484710/"> Era uma vez, um programador de jogos de unidade chamado Lancelot.  Muito apaixonado, eu diria.  Ele ainda n√£o sabia, mas acabaria enfrentando o lado mais sombrio da coleta de lixo da Unity. <br><br><div style="text-align:center;"><img src="https://thegamedevguru.b-cdn.net/wp-content/uploads/2019/12/GC-GarbageCollection-Thumbnail.jpg" alt="imagem"></div><br>  Lancelot estava sempre procurando <b>t√≠tulos cada</b> vez <b>maiores</b> para trabalhar.  E assim ele trabalhou duro para obter sua grande chance na ind√∫stria de jogos. <br><br>  N√£o era f√°cil, ele sabia. <br><a name="habracut"></a><br>  Esses pontos na ind√∫stria de jogos eram e ainda s√£o reservados para uma pequena minoria de programadores de jogos.  E ele n√£o tinha certeza se estaria de acordo com os padr√µes. <br><br>  Mas ele persistiu e continuou a aprimorar suas habilidades de programa√ß√£o. <br><br>  Lancelot come√ßou a trabalhar em pequenos jogos.  Talvez em algum momento ele tivesse a grande chance que procurava, pensou. <br><br>  Anos se passaram at√© que ele teve a oportunidade que estava esperando.  Ele foi convidado a portar um grande jogo de VR para uma plataforma m√≥vel.  T√£o animado quanto Lancelot estava, ele n√£o conseguia parar de se perguntar se era <b>bom o suficiente</b> para a tarefa.  Foi assustador, mas ele aceitou o desafio.  Ele sabia que s√≥ poderia crescer com isso. <br><br>  A maior preocupa√ß√£o de Lancelot era a necessidade de melhorar enormemente o desempenho do jogo.  Na verdade, era um duplo desafio.  Ele teve que <b>melhorar o desempenho em 20%</b> para obter uma <b>plataforma</b> significativamente <b>menos poderosa</b> . <br><br>  Ap√≥s meses de trabalho sem parar, ele finalmente conseguiu otimizar o jogo o suficiente para ter uma linha de base de desempenho s√≥lida. <br><br>  No entanto, um problema inesperado estava ao virar da esquina ... <br><br>  O criador de perfil da unidade revelou a ele uma queda significativa na taxa de quadros a cada poucos segundos.  E isso o preocupou, porque isso n√£o permitiria que ele enviasse o jogo.  O lan√ßamento do jogo estava em risco.  Isso o deixou totalmente desconfort√°vel. <br><br>  Com base em sua experi√™ncia anterior, Lancelot rapidamente suspeitou do <b>coletor de lixo</b> .  Afinal, ele sabia que alocar mem√≥ria tempor√°ria no jogo com muita frequ√™ncia poderia causar esses picos de desempenho.  Assim como a lata de lixo na cozinha de todos, voc√™ sabe que √© hora de limp√°-la quando atingir 80% de sua capacidade. <br><br>  E assim ele passou dias lutando contra as aloca√ß√µes inc√¥modas de mem√≥ria.  Ele realizou todos os tipos de otimiza√ß√µes em que conseguia pensar.  Conjuntos de objetos, cache de dados, otimiza√ß√µes da estrutura de dados ... <br><br>  Passar esses dias otimizando o levou um pouco √† frente na jornada de desempenho.  Lancelot estava orgulhoso de seu trabalho, mas suas preocupa√ß√µes s√≥ aumentaram quando ele viu o coletor de lixo ainda em funcionamento a cada 15 segundos. <br><br>  Jogar o jogo em VR com essas quedas de desempenho de alguma forma faria as pessoas parecerem p√°lidas. <br><br>  "Como isso pode estar acontecendo?", Ele se perguntou. <br><br>  Com mais paci√™ncia e busca, Lancelot descobriu uma segunda fonte de aloca√ß√µes de mem√≥ria que ele n√£o via antes.  Isso aconteceu em uma <b>biblioteca de terceiros</b> . <br><br>  Ele deu uma olhada e logo percebeu que estava na pior posi√ß√£o de todos os tempos: aquela biblioteca era de c√≥digo fechado.  Al√©m disso, ele tamb√©m tentou usar o <b>coletor de lixo incremental</b> do Unity, mas n√£o teve condi√ß√µes de pagar seu pre√ßo de desempenho. <br><br>  Lancelot estava ficando sem op√ß√µes. <br><br>  Ele se sentiu desesperado, mas conseguiu manter a calma.  Ele esteve em situa√ß√µes piores, afinal. <br><br>  Ele poderia <b>fazer engenharia reversa</b> da biblioteca e fazer otimiza√ß√µes de aloca√ß√£o de mem√≥ria.  O problema era que a licen√ßa n√£o permitia essas coisas.  E ele era jovem demais para ir para a cadeia. <br><br>  A segunda op√ß√£o que ele considerou foi <b>pr√©-alocar</b> muita mem√≥ria no heap.  Ele sabia que a unidade desencadeou o processo de coleta de lixo quando o uso da pilha atingiu uma certa porcentagem.  Portanto, aumentar a pilha deve dar a ele mais tempo entre as coletas de lixo. <br><br>  Infelizmente, isso ainda n√£o foi suficiente. <br><br>  Lentamente, parecia que ele n√£o tinha controle sobre a situa√ß√£o.  Foi dif√≠cil, mas novamente, ele <b>persistiu</b> . <br><br>  Ent√£o Lancelot teve uma <b>ideia maluca</b> .  E se ele desativasse completamente a coleta de lixo?  Isso foi poss√≠vel?  Ele sentia em seus ossos o qu√£o arriscada era essa ideia.  Ele n√£o queria acrescentar a possibilidade de o jogo travar em pontos imprevis√≠veis.  A √∫ltima vez que ele checou, ‚Äã‚Äãisso n√£o foi divertido para os jogadores.  Talvez os tempos tenham mudado, mas √© melhor prevenir do que remediar. <br><br>  Al√©m disso, ele se preocupava em adiar o lan√ßamento do jogo.  Ele n√£o queria que seus jogadores perdessem esse t√≠tulo no Natal.  Ele se lembrou de como se divertia jogando EverQuest durante essas f√©rias.  Ele n√£o tiraria isso dos jogadores. <br><br>  Chegou a esse ponto, ele n√£o tinha outra escolha sen√£o desativar o coletor de lixo. <br><br>  Ele entrou no modo de pesquisa e descobriu que realmente podia <b>desativar manualmente a coleta de lixo</b> .  Ele realizou dezenas de experimentos para ver quanto tempo o jogo duraria sem ficar sem mem√≥ria.  Ele fez todos os tipos de testes para estressar o sistema.  Clicando em todos os lugares, andando e pulando, alternando entre diferentes aplicativos. <br><br>  <b>Os n√∫meros</b> come√ßaram a chegar em sua planilha: 25 minutos, 28 minutos, 30 minutos ... Ele tamb√©m observou como o uso da pilha aumentava ao longo do tempo para garantir que ele nunca excederia um or√ßamento seguro. <br><br>  Com esses n√∫meros, Lancelot estabeleceu uma <b>margem de seguran√ßa</b> generosa e preparou um <b>prot√≥tipo</b> .  Ele executava a coleta de lixo manualmente durante o carregamento das telas e a cada poucos minutos. <br><br>  Ele tinha esperan√ßa novamente. <br><br>  Ele pediu educadamente ao controle de qualidade que passasse pelo jogo dezenas de vezes. <br><br>  A mem√≥ria estava sempre dentro do or√ßamento.  Sem falhas.  Sem efeitos colaterais. <br><br>  Essa longa jornada o levou ao ponto em que ele foi capaz de <b>embarcar</b> o jogo. <br><br>  E adivinhe?  Agora, centenas de jogadores est√£o gostando do Natal. <br><br>  No come√ßo, ele n√£o estava confort√°vel com esta solu√ß√£o.  Foi uma jogada arriscada e ele sabia disso.  Mas ele conseguiu. <br><br>  Lancelot aprendeu a se sentir confort√°vel com o <b>desconfort√°vel</b> .  Ele aprendeu a ser mais <b>pragm√°tico</b> .  Porque h√° momentos em que um programador precisa ser. <br><br>  Alguma coisa da hist√≥ria toca uma campainha?  Nesse caso, sua intui√ß√£o provavelmente est√° certa. <br><br>  Esse programador era eu. <br><br>  Nos momentos em que voc√™ precisar, √© assim que voc√™ pode gerenciar o coletor de lixo: <br><br>  Esse trecho de c√≥digo mostra como desativar as coletas de lixo autom√°ticas.  Ele executa o processo do GC manualmente a cada minuto e, possivelmente, durante as transi√ß√µes da tela (desbotamento para preto). <br><br>  Esteja ciente de seus poss√≠veis efeitos colaterais: <br><br><ul><li>  <b>Falhas</b> : se voc√™ n√£o jogar com seguran√ßa o suficiente, ficar√° sem mem√≥ria.  Pior, o sistema operacional pode acabar com o seu jogo quando voc√™ alterna entre aplicativos </li><li>  <b>Tempos de coleta de lixo mais longos</b> : aumentar a pilha tornar√° as futuras cole√ß√µes de lixo mais lentas </li></ul><br>  Se voc√™ precisar produzir quantidades generosas de lixo, eis um m√©todo simples que funcionar√°: <br><br><pre><code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">GenerousGarbageCreator</span></span> : <span class="hljs-title"><span class="hljs-title">MonoBehaviour</span></span> { [SerializeField] <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> garbageCreationRate = <span class="hljs-number"><span class="hljs-number">1024</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span>[] _garbage; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Update</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { _garbage = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span>[garbageCreationRate]; } }</code> </pre> <br>  Isto √© o que voc√™ obter√° no criador de perfil: <br><br><img src="https://thegamedev.guru/wp-content/uploads/2019/12/GC-Garbage-Collection-Management-Highlight.gif" alt="imagem"><br>  <i>Coleta de lixo da Unity: acionador manual baseado em tempo</i> <br><br>  L√° voc√™ v√™ um uso crescente de mem√≥ria.  O crescente uso de heap √© destacado como "mono".  Felizmente para n√≥s, estamos executando o coletor de lixo manual a cada 3 segundos. <br><br>  Voc√™ pode ver claramente esse ciclo de remo√ß√£o de gera√ß√£o de lixo no gr√°fico do criador de perfil.  Para os desenvolvedores de jogos que estudaram f√≠sica, voc√™ pode reconhec√™-la como uma forma de onda dente de serra. <br><br>  Se voc√™ deseja o c√≥digo fonte deste projeto, sabe onde encontr√°-lo (spoiler: aqui). <br><br>  Para otimiza√ß√µes de mem√≥ria mais gerais, voc√™ pode estar interessado em Endere√ß√°veis ‚Äã‚Äãda Unidade.  Com os endere√ßos endere√ß√°veis, voc√™ reduz o uso total de mem√≥ria para ativar a coleta de lixo com menos frequ√™ncia.  Por sua vez, isso reduzir√° os picos de desempenho que seus jogadores experimentar√£o. <br><br>  Estou ansioso para trabalhar com todos voc√™s em 2020. <br>  Ruben </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt484710/">https://habr.com/ru/post/pt484710/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt484692/index.html">Vitamina C - Preciso tomar suplementos ou √© uma medida comercial?</a></li>
<li><a href="../pt484700/index.html">Java 14: visualiza√ß√£o de registros</a></li>
<li><a href="../pt484702/index.html">Alternativas do Prestashop em 2020: as principais plataformas de com√©rcio eletr√¥nico</a></li>
<li><a href="../pt484706/index.html">Pr√°tica no trabalho com pneus personalizados do complexo Redd</a></li>
<li><a href="../pt484708/index.html">Richard Hamming ‚ÄúCap√≠tulo inexistente‚Äù: como sabemos o que sabemos (vers√£o completa)</a></li>
<li><a href="../pt484712/index.html">Compatibilidade bin√°ria Reaktive: como a fornecemos</a></li>
<li><a href="../pt484716/index.html">Pare de chamar tudo de AI</a></li>
<li><a href="../pt484718/index.html">As modernas impressoras HP se recusam a trabalhar sem assinatura de tinta</a></li>
<li><a href="../pt484720/index.html">Concerto para uma cidade com uma orquestra: quem e por que grava os sons da vida cotidiana</a></li>
<li><a href="../pt484722/index.html">Quais ferramentas de desenvolvimento do Ruby on Rails se adequam ao seu projeto: Principais j√≥ias do Ruby on Rails para 2020</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>