<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ü§∂ üìì üë©üèª‚Äçü§ù‚Äçüë®üèæ bobaflu - accesorios de programaci√≥n en flutter üë®üèª‚Äçüéì üë∞ ‚ûó</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Este art√≠culo se centrar√° en la implementaci√≥n del cliente m√≥vil Flutter. 


 ¬øQu√© cliente m√≥vil? 


 La publicaci√≥n anterior describi√≥ el sistema de ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>bobaflu - accesorios de programaci√≥n en flutter</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/440088/"><p><img src="https://habrastorage.org/webt/-n/0y/sv/-n0ysvv41yt_uwk8hh-fa1ui79e.png"></p><br><p> Este art√≠culo se centrar√° en la implementaci√≥n del cliente m√≥vil Flutter. </p><br><p>  ¬øQu√© cliente m√≥vil? </p><br><p>  La publicaci√≥n anterior describi√≥ el sistema de accesorios de software: <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">bobaoskit: accesorios, dnssd y WebSocket</a> . </p><br><p> Un an√°logo de un accesorio de software es un objeto real.  Bombilla, interruptor, reproductor de cd / cassette, reproductor de radio, termostato, sensor de temperatura, sensor de movimiento, etc. ... Un conjunto de accesorios est√° determinado por la imaginaci√≥n y el c√≥digo del programa.  Puede implementar al menos un tablero de ajedrez.  Para tal tablero, debe tener un <code>move</code> campo de control ( <code>control</code> ), que toma un objeto <code>{ from: "e2", to: "e4" }</code> por ejemplo, y campos de servicio para restablecer figuras, etc. ... El script accesorio procesar√° la solicitud para controlar el campo de <code>move</code> , aceptar la decisi√≥n es si es posible mover la figura y devolver√° (o no) el estado con la posici√≥n de las figuras en todo el campo. </p><br><p>  Los tipos de accesorios admitidos actualmente con una funcionalidad m√≠nima son los siguientes: "interruptor", "sensor de temperatura", "termostato", "reproductor de radio". </p><br><p>  Sobre el ajedrez, no habr√° m√°s discusi√≥n.  Si es interesante y en ese caso, bienvenido a cat. </p><a name="habracut"></a><br><p>  Entonces <code>bobaoskit.worker</code> funcionamiento.  Existen objetos accesorios en la memoria de la computadora, puede leer informaci√≥n sobre ellos, puede enviar manualmente una solicitud <code>JSON</code> al puerto <code>WebSocket</code> y ver los eventos entrantes. </p><br><p>  Para la administraci√≥n, hice la aplicaci√≥n m√≥vil m√°s simple. </p><br><h2 id="pochemu-flutter">  ¬øPor qu√© revolotear? </h2><br><p>  Durante los √∫ltimos a√±os, una idea ha estado viviendo activamente en mi cabeza para estudiar programaci√≥n para dispositivos m√≥viles.  Como escribo en <code>JavaScript</code> , estudi√© soluciones que le permiten no aprender un nuevo lenguaje de programaci√≥n. </p><br><p>  <code>Appcelerator</code>  Comenz√≥ el estudio con √©l.  Si la memoria no cambia, el SDK est√° abierto, pero el IDE con varias tarifas. <br>  <code>NativeScript</code>  Aqu√≠ ya he creado una aplicaci√≥n simple que muestra una lista con im√°genes.  No fue m√°s lejos. <br>  <code>ReactNative</code>  El asalto m√°s largo de los marcos enumerados hasta ahora.  El mayor desaf√≠o es comenzar.  Mir√© el curso.  Al principio es claro, interesante, resulta.  Pero <code>redux</code> y despu√©s de la dominaci√≥n fallaron.  Luego intentaba comenzar a escribir regularmente, pero <code>redux</code> tercamente no se permit√≠a dominar. </p><br><p>  Como resultado, no estaba apegado a ninguna decisi√≥n en ese momento (finales de 2016).  Quiz√°s porque no hab√≠a una tarea espec√≠fica, quiz√°s por otras razones. </p><br><p>  M√°s cerca de la ca√≠da del pasado (2018), ya se estaba trabajando en el SDK para accesorios de software.  Naturalmente, necesitas una aplicaci√≥n m√≥vil.  Todo comenz√≥ con mdns.  Una vez en mi tiempo libre, actualic√© ReactNative, encontr√© el complemento react-native-zeroconf y cre√© la aplicaci√≥n.  De acuerdo con las instrucciones, instalado, hizo un <code>link</code> , lanzado.  Se lanz√≥ la aplicaci√≥n de depuraci√≥n de Expo, que no admite m√≥dulos nativos y, en consecuencia, el complemento mdns no funcion√≥.  En este punto, no hab√≠a suficiente tiempo libre para crear una aplicaci√≥n nativa de reacci√≥n limpia (sin expo) y probar con ella.  El trabajo fue pospuesto por un par de meses. </p><br><p>  Al mismo tiempo, aparecieron m√°s y m√°s materiales sobre el <code>flutter</code> en la red.  Me instal√© yo mismo.  La instalaci√≥n es simple: <code>git clone</code> y agregue a <code>PATH</code> .  El resto ya est√° configurando el SDK / Xcode de Android (en mi caso, el SDK de Android se ha configurado durante mucho tiempo. No puedo desarrollar para iOS, porque no soy un usuario de macOS) y el SDK de Dart (puede instalarlo por separado, pero no necesariamente, ya que es parte del flutter). </p><br><h2 id="principshema-raboty">  Principio / esquema de trabajo </h2><br><ul><li>  Cuando se inicia, la aplicaci√≥n busca los servicios <code>_bobaoskit._tcp</code> en la red local utilizando el complemento <a href="">flutter_mdns</a> .  Hay varias versiones de este complemento, todas tienen su origen en la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">publicada</a> , pero no es compatible con las nuevas versiones del Dart SDK, respectivamente, muchas bifurcaciones y compatibilidad a√±adida.  Eleg√≠ esta versi√≥n porque las otras no resolvieron los hosts de varios servicios descubiertos a la vez. <br>  Tras la detecci√≥n y determinaci√≥n (onResolve), el host se agrega a la lista. <br>  La p√°gina con la lista de servicios descubiertos es <code>StatefulWidget</code> , respectivamente, cuando detecta / pierde servicios, se <code>setState() {...}</code> </li><li>  Al elegir un host de la lista, se crea una nueva p√°gina (tambi√©n <code>StatefulWidget</code> ), a la que se transmiten el <code>host</code> y el <code>port</code> servicio seleccionado. <br>  Se <code>BobaosKit</code> objeto <code>BobaosKit</code> responsable de las comunicaciones.  Las respuestas se procesan mediante devoluciones de llamada, como  mientras que no estudi√© mucho dardo as√≠ncrono.  Pero a juzgar por la documentaci√≥n escaneada, <code>Futures</code> es un an√°logo de <code>Promise</code> en JS. <br>  Las funciones se registran para eventos entrantes (sin respuestas).  <code>EventEmitter</code> para Dart aqu√≠.  Escrib√≠ mi muy simple. </li></ul><br><pre> <code class="plaintext hljs"> void registerListener(String name, Function cb) { this._events.add(new BobaosKitCallback(name, cb)); } void removeAllListeners() { this._events = []; } void emitEvent(String name, dynamic params) { // call all listeners List&lt;BobaosKitCallback&gt; foundCallbacks = this._events.where((t) =&gt; t.name == name).toList(); foundCallbacks.forEach((f) =&gt; f.cb(params)); } ... ... void listen() { this.ws.listen((text) { var json = jsonDecode(text); if (json.containsKey('response_id')) { .... } else { //   response_id -  this.emitEvent(json['method'], json['payload']); } }); }</code> </pre> <br><p>  Eventos entrantes: si el accesorio se ha eliminado, agregado, estado actualizado.  O si se quitan todos los accesorios ( <code>clear accessories</code> ). </p><br><p>  Funciones registradas: para actualizar listas, widgets para estos eventos. </p><br><ul><li>  Se env√≠a una solicitud de informaci√≥n sobre todos los accesorios. </li></ul><br><p>  Se crea un objeto AccessoryInfo para cada accesorio: </p><br><pre> <code class="plaintext hljs">import 'package:scoped_model/scoped_model.dart'; // AccessoryInfo extends Model // so, when accessory value is updated it descends down to // all widgets inside ScopedModelDescendant class AccessoryInfo extends Model { dynamic id; dynamic type; String name; String job_channel; List control; List status; bool selected; Map&lt;dynamic, dynamic&gt; currentState; AccessoryInfo(Map&lt;dynamic, dynamic&gt; obj) { this.id = obj['id']; this.type = obj['type']; this.name = obj['name']; this.job_channel = obj['job_channel']; this.control = obj['control']; this.status = obj['status']; this.currentState = {}; } void updateCurrentState(key, value) { currentState[key] = value; notifyListeners(); } void notify() { notifyListeners(); } }</code> </pre> <br><p>  Este objeto ya es un modelo.  Inicialmente, escrib√≠ <code>setState() {}</code> y <code>setState() {}</code> todas partes, pero <code>setState() {}</code> solo funciona para un widget dentro del cual los oyentes est√°n registrados.  Pero para la gesti√≥n detallada de accesorios, inicialmente cre√© nuevas p√°ginas con <code>Stateful</code> y not√© que el estado no se actualiza.  Como soluci√≥n, utiliz√≥ <code>ScopedModel</code> . </p><br><p>  Despu√©s de recibir la lista de accesorios, para cada uno de ellos enviamos una solicitud de estado y la agregamos a la lista <code>List &lt;AccessoryInfo&gt;</code> .  Llame a <code>setState() {}</code> , agregando as√≠ un accesorio compatible a la interfaz.  Los tipos de accesorios compatibles se definen en <code>ListView.builder</code> y en <code>./lib/widgets/*.dart</code> .  <code>switch/temperature sensor/radio player/thermostat</code> admitidos actualmente.  El principal trabajo por delante es agregar nuevos y mejorar los widgets existentes. </p><br><ul><li>  Ahora sobre c√≥mo crear elementos separados para cada accesorio.  Por ejemplo, considere un cambio. </li></ul><br><pre> <code class="plaintext hljs"> @override Widget build(BuildContext context) { return new ScopedModel&lt;AccessoryInfo&gt;( model: info, child: ScopedModelDescendant&lt;AccessoryInfo&gt;( builder: (context, child, model) { var cardColor = Theme.of(context).cardColor; dynamic switchState = model.currentState['state']; if (switchState is bool) { if (switchState) { cardColor = Colors.deepPurple; } else { cardColor = Theme.of(context).cardColor; } } return Card( color: cardColor, child: ListTile( selected: false, leading: new Icon(Icons.lightbulb_outline), title: new Text("${model.name}"), onTap: () { // to control accessory value // get status value at first bobaos.getStatusValue( model.id, "state", (bool err, Object payload) { if (err) { return print('error ocurred $payload'); } if (payload is Map) { dynamic currentValue = payload['status']['value']; bool newValue; if (currentValue is bool) { // invert newValue = !currentValue; } else { newValue = false; } // then send new value bobaos.controlAccessoryValue( model.id, {"state": newValue}, (bool err, Object payload) { if (err) { return print('error ocurred $payload'); } }); } }); }, onLongPress: () { // TODO: dialog with additional funcs }, )); })); }</code> </pre> <br><p>  Para un accesorio de tipo <code>switch</code> , se crea un elemento en la lista general de accesorios, al interactuar con el cual (onTap) se env√≠a una solicitud para obtener el valor actual, y luego para cambiar este valor.  <code>ScopedModel</code> permite volver a dibujar el widget para las actualizaciones de estado entrantes. </p><br><p>  No se implementa un controlador de clic largo para este accesorio. </p><br><p>  Para un reproductor de radio, se ve as√≠: </p><br><pre> <code class="plaintext hljs"> onLongPress: () { Navigator.of(context).push(MaterialPageRoute( builder: (context) =&gt; AccRadioPlayerControl( info: info, bobaos: bobaos, ))); },</code> </pre> <br><p>  Se <code>AccRadioPlayerControl</code> p√°gina <code>AccRadioPlayerControl</code> , que tambi√©n usa <code>ScopedModel</code> para administrar el estado. </p><br><p>  En esto, se agota la descripci√≥n completa del algoritmo de operaci√≥n del programa.  No se implementan caracter√≠sticas adicionales, como recordar el √∫ltimo host, clasificar los accesorios en categor√≠as / habitaciones.  Por el momento, todo es simple. </p><br><h2 id="problemy">  Los problemas </h2><br><p>  Describir√© el problema principal que es ahora.  Todav√≠a no entiendo c√≥mo detectar una conexi√≥n <code>WebSocket</code> rota. </p><br><p>  Yo uso: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">clase WebSocket</a> . </p><br><p>  Cuando la aplicaci√≥n / dispositivo est√° en modo de suspensi√≥n durante mucho tiempo, la conexi√≥n se desconecta.  Debe volver a la primera p√°gina y volver a abrir el servicio descubierto. </p><br><h2 id="posleslovie">  Ep√≠logo </h2><br><p>  Por un lado, Flutter es bastante r√°pido en aprender y desarrollarse.  ScopedModel para m√≠ result√≥ ser redux m√°s comprensible. <br>  Dart result√≥ ser similar a JavaScript familiar.  Escribir + tipos din√°micos permitir√° que todos puedan escribir de la manera m√°s conveniente. </p><br><p>  Dificultades para escribir c√≥digo: gran anidamiento de widgets.  El conocido infierno de devoluci√≥n de llamada despu√©s del aleteo se ve de manera diferente.  Vim-mode y <code>%</code> ser√°n √∫tiles. </p><br><p>  Ahora algunas reflexiones sobre IoT.  Recientemente, cada vez m√°s dispositivos / servicios inteligentes que requieren registrarse en la nube.  Puntos de venta chinos, para los cuales necesita instalar la aplicaci√≥n, crear una cuenta, y solo despu√©s de eso puede usarla. </p><br><p>  Asistentes de voz.  Alice de Yandex requiere su nube a la que se env√≠a el texto reconocido.  Alexa de Amazon funciona de manera similar. </p><br><p>  El m√°s exitoso, en mi opini√≥n, es hecho por Apple HomeKit junto con Siri.  La nube se usa para el reconocimiento de texto.  Interacci√≥n con dispositivos: en la red local. </p><br><p>  Mi opini√≥n es que la nube debe existir para su prop√≥sito: control remoto, actualizaci√≥n, etc. ... Si el dispositivo se puede controlar en una red local, entonces debe hacerlo. </p><br><h2 id="ssylki">  Referencias </h2><br><ol><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Repositorio de aplicaciones</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Documentaci√≥n de Bobaoskit</a> : describe c√≥mo instalar bobaoskit.worker y ejecutar el accesorio del <code>radio player</code> . </li></ol></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/440088/">https://habr.com/ru/post/440088/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../440074/index.html">Roskomos considera incorrecto comparar los motores Raptor Ilona Mask y RD-180</a></li>
<li><a href="../440076/index.html">Traducci√≥n e interpretaci√≥n de publicidad del ingl√©s al ruso</a></li>
<li><a href="../440078/index.html">Dispositivo compilador r√°pido. Parte 4</a></li>
<li><a href="../440084/index.html">10 mil millones de exportaciones de software son insignificantes</a></li>
<li><a href="../440086/index.html">Mundo de virus MS-DOS</a></li>
<li><a href="../440090/index.html">¬øC√≥mo funcionan realmente los indicadores t√©cnicos en el mercado de valores?</a></li>
<li><a href="../440092/index.html">Una investigaci√≥n matem√°tica de c√≥mo fingi√≥ las elecciones de gobernador en Primorye el 16 de septiembre de 2018</a></li>
<li><a href="../440094/index.html">Los jardines en flor en Marte siguen siendo un sue√±o: el proyecto Mars One se declar√≥ en quiebra</a></li>
<li><a href="../440096/index.html">Vulnerabilidad de RunC que afecta a Kubernetes, Docker y containerd</a></li>
<li><a href="../440098/index.html">La luz de la luna todav√≠a es completamente autom√°tica. Parte 2. Separador. Nevera. Cubo Algoritmos</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>