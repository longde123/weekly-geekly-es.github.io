<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👲🏻 🐤 🎅🏻 APM elastis di aplikasi 👨🏾‍⚕️ ⚫️ 🏂🏿</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Saya belum menerbitkan artikel untuk waktu yang lama dan sekarang lagi ... Artikel ini tidak terlalu besar, tapi, semoga bermanfaat. Setelah kami memu...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>APM elastis di aplikasi</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/485996/"><p> Saya belum menerbitkan artikel untuk waktu yang lama dan sekarang lagi ... Artikel ini tidak terlalu besar, tapi, semoga bermanfaat.  Setelah kami memutuskan untuk menggunakan Prometheus untuk mengumpulkan metrik, tapi ... Setelah beberapa saat, kami memutuskan untuk beralih ke Elastic APM, karena kami sudah memiliki seluruh tumpukan Elastis dan kami memutuskan untuk mendukung metrik dalam tumpukan ini. </p><a name="habracut"></a><br><p>  Jadi, Elastic APM adalah alat untuk bekerja dengan metrik, untuk ini aplikasinya menggunakan Elastic APM Agent - agen untuk mengumpulkan metrik untuk berbagai bahasa.  Kami menggunakan Elastic APM .NET Agent.  Paket ini didukung oleh .NET Framework sejak versi 4.6.2. </p><br><p>  Agen mengirim metrik ke server (Elastic APM Server).  Semua pengaturan yang diperlukan ditulis dalam web.config dengan kunci spesifik yang diharapkan oleh Agen APM Elastis. <br>  Kita perlu mengkonfigurasi setidaknya url untuk Server APM Elastis.  Untuk memisahkan, saat menampilkan metrik dalam LC, berdasarkan aplikasi dan lingkungan, kita memerlukan parameter berikut: </p><br><ul><li>  ElasticApm: ServiceName - nama layanan, harus memenuhi aturan berikut: ^ [a-zA-Z0-9 _-] + $. </li><li>  ElasticApm: Lingkungan - nama lingkungan memungkinkan Anda untuk memfilter data di tingkat global dalam aplikasi.  Hanya didukung di Kibana dimulai dengan versi 7.2. </li></ul><br><p>  Untuk mengatur waktu setelah metrik mana yang akan dikirim, kami memerlukan parameter berikut: </p><br><ul><li>  ElasticApm: MetricsInterval - memungkinkan Anda untuk mengatur waktu setelah mana metrik akan dikirim ke server, secara default - 5 dtk.  Jika waktunya diatur ke 0, metrik tidak akan dikirim ke server.  Semua pengukuran untuk parameter ini dalam hitungan detik. </li></ul><br><p>  Anda juga dapat mengkonfigurasi level logging: ElasticApm: LogLevel. </p><br><p>  Contoh mengisi web.config: </p><br><pre><code class="xml hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?xml version="1.0" encoding="utf-8"?&gt;</span></span> <span class="hljs-comment"><span class="hljs-comment">&lt;!-- ... --&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">configuration</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-comment"><span class="hljs-comment">&lt;!-- ... --&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">appSettings</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-comment"><span class="hljs-comment">&lt;!-- ... --&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">add</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">key</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"ElasticApm:ServerUrls"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">value</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"https://my-apm-server:8200"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">add</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">key</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"ElasticApm:MetricsInterval"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">value</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"10"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">add</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">key</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"ElasticApm:Environment"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">value</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Stage"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">add</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">key</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"ElasticApm:ServiceName"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">value</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Web.Api"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-comment"><span class="hljs-comment">&lt;!-- ... --&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">appSettings</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-comment"><span class="hljs-comment">&lt;!-- ... --&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">configuration</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br><p>  Unit kerja dari paket Agen APM Elastis adalah transaksi - objek dari jenis transaksi IT.  Data transaksi dikumpulkan di dalam objek Reporter dan dikirim ke server satu kali pada waktu yang ditentukan.  Pengaturan waktu pengiriman diberikan di atas. </p><br><p>  Awal transaksi dimulai dengan panggilan ke metode StartTransaction, selesai dengan panggilan ke metode End ().  Selain metode StartTransaction, Anda juga dapat menggunakan metode CaptureTransaction, tetapi metode End () tidak dipanggil untuk itu, semua yang Anda butuhkan diteruskan sebagai parameter untuk metode tersebut.  Jika tidak perlu untuk menangkap pengecualian, maka ada metode CaptureException untuk ini. </p><br><p>  Metode ini akan menulis objek transaksi yang akan berisi pengecualian yang diteruskan ke sana.  Semua informasi tambahan - metadata - ditulis ke objek transaksi dengan mengisi properti Label dari objek transaksi. </p><br><p>  Jadi apa yang terjadi?  Pertama, tambahkan model yang akan berisi pengaturan yang diperlukan untuk objek transaksi IT bagi kami: </p><br><pre> <code class="plaintext hljs">public class MeasurementData { public static string ApmServerUrl =&gt; ConfigurationManager.AppSettings["ElasticApm:ServerUrls"] ?? "http://localhost:8200"; public static string MetricsInterval =&gt; ConfigurationManager.AppSettings["ElasticApm:MetricsInterval"] ?? "10"; public static string ApmEnvironment =&gt; ConfigurationManager.AppSettings["ElasticApm:Environment"] ?? "local"; public static string ServiceName =&gt; ConfigurationManager.AppSettings["ElasticApm:ServiceName"] ?? "Api"; public ITransaction MetricsObject { get; set; } //    public static ITransaction Create(string metricsName) { Environment.SetEnvironmentVariable(ConfigConsts.EnvVarNames.ServerUrls, ApmServerUrl); Environment.SetEnvironmentVariable(ConfigConsts.EnvVarNames.MetricsInterval, MetricsInterval); Environment.SetEnvironmentVariable(ConfigConsts.EnvVarNames.Environment, ApmEnvironment); Environment.SetEnvironmentVariable(ConfigConsts.EnvVarNames.ServiceName, ServiceName); return Agent.Tracer.StartTransaction(metricsName, ApiConstants.TypeRequest); } }</code> </pre> <br><p>  Selanjutnya, kita membuat pembangun di mana kita akan membuat objek transaksi, menulis metadata ke transaksi, membuat transaksi untuk menyimpan pengecualian, menyelesaikan transaksi: </p><br><pre> <code class="plaintext hljs">public class MetricsBuilder { private readonly MeasurementData _measurementData = new MeasurementData(); private string _metricName; public void BuildMetrics(string metricName) { //      ,   _metricName = string.IsNullOrEmpty(metricName) ? "api_payment_request_duration" : metricName; CheckAndCreateMetricsObjects(); } //      public void AddMetricsLabels(string key, string value) { CheckAndCreateMetricsObjects(); if (!_measurementData.MetricsObject.Labels.ContainsKey(key)) { _measurementData.MetricsObject.Labels.Add(key, value); return; } _measurementData.MetricsObject.Labels[key] = value; } //    public void CaptureMetricException(Exception exception) { CheckAndCreateMetricsObjects(); _measurementData.MetricsObject.CaptureException(exception); } public void Dispose() { CheckAndCreateMetricsObjects(); _measurementData.MetricsObject.End(); } // ,      , //   -  private void CheckAndCreateMetricsObjects() { if (_measurementData.MetricsObject == null) { _measurementData.MetricsObject = MeasurementData.Create(_metricName); Logger.Info($"{nameof(MetricsBuilder)}: CurrentTransaction: {JsonConvert.SerializeObject(Agent.Tracer.CurrentTransaction)} " + $"ServerUrls: {JsonConvert.SerializeObject(Agent.Config.ServerUrls)} " + $"MetricsIntervalInMilliseconds: {JsonConvert.SerializeObject(Agent.Config.MetricsIntervalInMilliseconds)}"); } } } public interface IMetricsService : IDisposable { void AddMetricsLabels(string key, string value); void CaptureMetricException(string message, Exception exception); } public class MetricsService : IMetricsService { private readonly MetricsBuilder _builder; public MetricsService(string metricName) { _builder = new MetricsBuilder(); Build(metricName); } public void AddMetricsLabels(string key, string value) { try { _builder.AddMetricsLabels(key, value); } catch (Exception exception) { CaptureMetricException("Can't write metrics labels", exception); } } public void CaptureMetricException(string message, Exception exception) { Logger.Error(message, exception); try { _builder.CaptureMetricException(exception); } catch (Exception exec) { Logger.Error("Can't write capture exception of metrics", exec); } } public void Dispose() { try { _builder.Dispose(); } catch (Exception exception) { CaptureMetricException($"Can't to do correct dispose of object: {typeof(MetricsService)}", exception); } } private void Build(string metricName) { try { _builder.BuildMetrics(metricName); } catch (Exception exception) { CaptureMetricException("Can't create metrics object", exception); } } }</code> </pre> <br><p>  Untuk kelas tempat metrik dikumpulkan, kami membuat dekorator tempat kami akan menggunakan kelas MetricsService kami.  Jangan lupa tentang mendaftarkan dekorator untuk implementasi dependensi yang benar. </p><br><pre> <code class="plaintext hljs">public class TestClientMetricsService : ITestObject { private readonly ITestObject _testObject; public GatewayClientMetricsService(ITestObject testObject) { _testObject = testObject; } public ProcessingResult TestMethod() { return WriteMetrics("Test_Method", () =&gt; _testObject.Test()); } private ProcessingResult WriteMetrics(string methodName, Func&lt;Result&gt; testMethod) { using (var metricsService = new MetricsService(methodName)) { try { metricsService.AddMetricsLabels("assemblyName", Assembly.GetCallingAssembly().FullName); var requestResult = testMethod(); metricsService.AddMetricsLabels("success", requestResult?.Success.ToString() ?? "false"); metricsService.AddMetricsLabels("resultCode", requestResult?.GetResultCode().ToString()); return requestResult; } catch (Exception exception) { metricsService.CaptureMetricException("Can't write metrics", exception); throw; } } } }</code> </pre> <br><p>  Saya harap artikel ini bermanfaat bagi mereka yang ingin menggunakan Elastic APM sebagai alat untuk mengumpulkan metrik. <cut></cut></p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/id485996/">https://habr.com/ru/post/id485996/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../id485972/index.html">Metode Analisis Regresi dalam Ilmu Data</a></li>
<li><a href="../id485974/index.html">Raspberry Pi dan SIM7600E 4G HAT Modem</a></li>
<li><a href="../id485986/index.html">5 Tren Pelokalan Teratas di 2020</a></li>
<li><a href="../id485988/index.html">[Case Locomizer] Cara mempercepat perhitungan peta panas sebanyak 20.000 kali dalam dua setengah tahun</a></li>
<li><a href="../id485990/index.html">Otomatisasi membunuh?</a></li>
<li><a href="../id485998/index.html">LyX: Komentar umum. Bagian 2</a></li>
<li><a href="../id486000/index.html">ADSM3. Sistem IPAM / DCIM</a></li>
<li><a href="../id486006/index.html">Simpan status obrolan di tumpukan</a></li>
<li><a href="../id486010/index.html">Membuat demo untuk ponsel lama - AONDEMO</a></li>
<li><a href="../id486014/index.html">Tur SLAC: Laboratorium Akselerator Nasional Departemen Energi AS di Stanford</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>