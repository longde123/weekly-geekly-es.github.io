<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üß¶ üë©üèæ‚Äçüé® ü§πüèª DIY-Bedienfeld f√ºr Heimwerker üíÖüèº üëä üêº</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hallo liebe Leser! 

 Eine Idee kam mir hier, aber kein Bedienfeld f√ºr ein Raumschiff zusammenzubauen. Zu USB. Mit nativer Treiberunterst√ºtzung. Benut...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>DIY-Bedienfeld f√ºr Heimwerker</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/434854/"><img src="https://habrastorage.org/webt/jq/jk/xz/jqjkxzwpn74xwt3quxzwbzwcxoa.jpeg"><br>  Hallo liebe Leser! <br><br>  Eine Idee kam mir hier, aber kein Bedienfeld f√ºr ein Raumschiff zusammenzubauen.  Zu USB.  Mit nativer Treiberunterst√ºtzung.  Benutzerdefinierte versteckt.  Zu kleben und alles funktioniert, ohne T√§nze und Tamburine.  Als Ergebnis haben wir eine Art monstr√∂ses ‚ÄûGamepad‚Äú f√ºr Weltraumsimulatoren erhalten.  Im Allgemeinen beurteilen Sie selbst. <br><a name="habracut"></a><br>  Anfangs hatte ich keine Ahnung, was am Ende passieren w√ºrde.  Ich wollte zwei Haupt-Joysticks, wie bei Sojus-MS, ein paar Schalter, Tasten und mehrere Displays. <br><br>  Nachdem ich die Arbeitsfl√§che meines Tisches gesch√§tzt hatte, w√§hlte ich die Abmessungen der Konsole in Breite und Tiefe 500 * 300 mm.  Und nachdem er auf der Suche nach Baumaterialien durch Baulager und Gesch√§fte gest√∂bert hatte, entschied er sich f√ºr eine H√∂he von 125 mm.  Als Ergebnis erwarb ich eine Platte aus 4 mm Sperrholz, Lamellen 20 * 12 mm und eine Platte 120 * 20 mm. <br><br>  Im Cad wurde schnell eine Skizze der Fernbedienung skizziert.  Und ich habe es sehr lange in einem Baum gemacht.  Drei Monate.  am Wochenende.  Und das nicht, weil er so imposant wie eine S√§ge arbeitete, sondern aus Zeitmangel.  Die Platte wurde kittiert, geschliffen und mit Emaille-Farbe bemalt, √§hnlich wie echte Platten von Raumschiffen oder Flugzeugen. <br><br><img src="https://habrastorage.org/webt/oa/oz/ck/oaozck0uudattfk5yl0mhztmx4o.jpeg"><br><br>  Aber lassen Sie die Malerarbeit vorerst beiseite und ich werde √ºber elektronisches F√ºllen sprechen. <br><br>  Radioteile wurden bei Ali gekauft.  Als Joysticks habe ich diese gefunden.  Im Allgemeinen ist die Situation mit solchen Joysticks eine vollst√§ndige Naht.  Industrielle L√∂sungen sind zu teuer, aber billig, kommen als Spielzeug und sind daher schlecht.  Diese sind von ziemlich hoher Qualit√§t, aber sie werden nicht wissen, wie lange sie dauern werden. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/n-/4c/96/n-4c96az3dh--wj0w8ir1cqz1qw.jpeg"></div><br>  Der Rest des kleinen Dings verursachte keine Probleme.  Die Steuerung hat STM32 ausgew√§hlt.  Als ADC f√ºr Joysticks 16-Bit-ADS1118.  Es wurde auch ein 12-V-Netzteil gekauft. Eigentlich erkl√§rt sich diese Spannung dadurch, dass ich vom ‚Äûshah‚Äú eine Tankanzeige bekommen habe, die ich auch hier anbringen wollte. <br><br><img src="https://habrastorage.org/webt/jz/0k/zq/jz0kzqxm-89ytb2bmexgkdqkm5i.jpeg"><br>  <i>Auf dem Foto das Netzteil, Stabilisatoren f√ºr 5 und 3,3 V, STM32, MCP23017, ADS1118</i> <br><br>  Controller 100-poliger STM32F407VET6, angeschlossen: <br><br>  2 Selektoren auf 4 Positionen <br>  1 variabler Widerstand <br>  2 Achsschalter <br>  4 Hauptachsen <br>  2 Hilfsachsen <br>  2 Steuerachsen <br>  4 Schl√ºsselschalter, je 2 Tasten <br>  20 Tasten mit LEDs <br>  4 Hauptschalter mit LEDs <br>  2 Pilztasten mit LEDs <br>  2 Timer-Tasten <br>  3 Schalter mit LEDs <br>  13 Schalter <br>  2 ADS1118 (ADC) <br>  4 MAX7219 (8-stellige LED-Anzeigen) <br>  2 TM1637 (Anzeigestunden) <br>  1 PCF8574 (E / A-Expander, an die Zeichensyntheseanzeige angeschlossen) <br><br><img src="https://habrastorage.org/webt/vl/6d/76/vl6d76rcv0daasbujiyeidj4fvc.png"><br>  <i>Die resultierende Struktur</i> <br><br>  Es wird ein bisschen zu viel f√ºr Hunderte von Beinen des MK sein, entschied ich und f√ºgte hier E / A-Expander hinzu: vier Teile des MCP23017 f√ºr jeweils 16 Ein- oder Ausg√§nge.  Mit Blick auf die Zukunft werde ich sagen, dass die Verz√∂gerung beim Abrufen der Eing√§nge des Expanders bei einer I2C-Busgeschwindigkeit von 400 kHz etwa 0,13 ms pro Chip betrug.  Das hei√üt, es deckt mit einem Rand die minimale USB-Abfragezeit von 1 ms ab. <br><br>  Um den I2C-Bus nicht mit unbrauchbaren Anforderungen anzusteuern, verf√ºgt der MCP23017 √ºber Interrupt-Ausg√§nge, die gesetzt werden, wenn sich der Status der Eing√§nge √§ndert.  Ich habe sie auch in meinem Projekt angewendet.  Wie sich weiter herausstellte, waren diese Unterbrechungen aufgrund des Rasselns der Kontakte nutzlos. <br><br>  Der ADS1118 ADC h√§lt nicht etwas mit der USB-Geschwindigkeit Schritt, seine deklarierte Leistung betr√§gt h√∂chstens 820 Samples pro Sekunde, was 1,2 ms entspricht, w√§hrend er mehrere Eing√§nge hat, die bereits √ºber den Multiplexer mit dem ADC verbunden sind.  Ich habe 2 Eing√§nge auf einem Chip verwendet, daher betr√§gt die Aktualisierungszeit der Werte 2,4 ms.  Schlecht, aber was kannst du tun?  Leider gibt es auf Ali keine anderen schnellen 16-Bit-ADCs. <br><br><img src="https://habrastorage.org/webt/sb/xt/jy/sbxtjyzbgnuutfbdhbh6iub1qpe.jpeg"><br>  <i>Im Inneren sieht es so aus, aber nach der Installation der Dr√§hte ist es viel schlimmer</i> <br><br>  Das CPU-Programm ist im Stil eines SPS-Programms geschrieben.  Keine Sperranforderungen.  Der Kern wartet nicht auf die Peripherie, hat keine Zeit gehabt und zur H√∂lle damit, beim n√§chsten Zyklus wird abgefragt.  Es gibt auch kein RTOS im Projekt, ich habe es versucht, ich hatte eine minimale Wartezeit von 1 ms - es stellt sich langsam heraus, wenn wir Daten √ºber USB mit einer Frequenz von 1 ms senden m√ºssen.  Als Ergebnis wurde mir klar, dass ich das Betriebssystem ohne osDelay () verwenden w√ºrde, und warum dann RTOS?  Genau wie in einer SPS reicht es aus, die Programmanweisungen einzeln in einer Endlosschleife zu platzieren. <br><br>  Verwendet nat√ºrlich CubeMX- und HAL-Bibliotheken.  √úbrigens bin ich k√ºrzlich zu HAL gewechselt und habe mich √ºber die Bequemlichkeit gewundert.  Ich wei√ü nicht, warum es immer noch nicht sehr beliebt ist. Die Hauptsache ist, es zuerst herauszufinden, und dann wird es sehr einfach gehen.  Es f√ºhlt sich an, als w√ºrdest du Arduino programmieren. <br><br>  Das Ger√§t haben wir USB benutzerdefinierte HID.  HID ist Maus, Tastatur, Gamepad, Joystick und vieles mehr.  Und es gibt Sitte.  All dies erfordert keine Treiber vom Betriebssystem.  Genauer gesagt, sie wurden bereits vom Entwickler geschrieben.  Ein benutzerdefiniertes Ger√§t ist insofern gut, als wir selbst die Funktionen aller oben genannten Ger√§te nach unserem Ermessen kombinieren. <br><br>  Im Allgemeinen ist das USB-Ding sehr kompliziert, es hat ein Handbuch von fast tausend Seiten und Sie k√∂nnen es nicht aus dem Handumdrehen nehmen.  Wer keine schweren Handb√ºcher lesen m√∂chte, gibt es einen tollen Artikel USB in a NutShell, google.  Sie hat auch eine √úbersetzung.  Ich werde versuchen, einige Punkte "an den Fingern" zu erkl√§ren. <br><br>  USB - paketierte Daten√ºbertragung mit einer Reihe von Ebenen und Abstraktionen.  Das Ger√§t ist bei uns - es kann keine Daten anfordern, der Host initiiert die gesamte √úbertragung.  Der Host schreibt und fordert Daten an die sogenannten Endpunkte an. Dies sind physisch einige Puffer im MK-Speicher.  Damit der Host versteht, an welchen Endpunkten er schreiben kann, welche Endpunkte er lesen soll und welche Daten er als Schaltfl√§chen und Achsen unseres Ger√§ts interpretieren kann und im Allgemeinen, welche Art von Ger√§t wir hier haben, fordert er zu Beginn der Verbindung Ger√§tedeskriptoren an.  Es gibt viele dieser Deskriptoren, und es ist schwierig, sie zu verfassen, und Sie k√∂nnen nach Belieben Fehler machen und √ºberall Fehler machen.  Physikalisch sind sie ein Array von Bytes. <br><br>  Tats√§chlich generiert CubeMX einen benutzerdefinierten HID-Initialisierungscode besser als wir. <br><br><img src="https://habrastorage.org/webt/dv/vh/vm/dvvhvm9hohydqeva77lahqhwer4.png"><br><br><img src="https://habrastorage.org/webt/b8/85/an/b885and1wp7m4r6yw9e21w-4hhs.png"><br><br>  Bitte achten Sie auf das letzte Bild unter der Nummer 3. Dies ist die Gr√∂√üe des Deskriptors in Bytes, die bestimmt, welche Achsen und Tasten sich auf unserem Ger√§t befinden.  Dieser Deskriptor wird im <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">HID-Deskriptor-Tool</a> generiert.  Es gibt mehrere Beispiele f√ºr das Selbststudium.  Im Allgemeinen ist hier mein Deskriptor.  Zum besseren Verst√§ndnis sind noch keine Daten f√ºr Anzeigen vorhanden, aber alle Schaltfl√§chen und Achsen der Joysticks sind vorhanden.  Es muss in der Datei usbd_custom_hid_if.c abgelegt werden.  Standardm√§√üig macht dieses Handle den Cube leer. <br><br><div class="spoiler">  <b class="spoiler_title">HID-Deskriptor (Gr√∂√üe 104 Byte)</b> <div class="spoiler_text"><pre><code class="cpp hljs">__ALIGN_BEGIN <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> CUSTOM_HID_ReportDesc_FS[USBD_CUSTOM_HID_REPORT_DESC_SIZE] __ALIGN_END = { <span class="hljs-comment"><span class="hljs-comment">/* USER CODE BEGIN 0 */</span></span> <span class="hljs-number"><span class="hljs-number">0x05</span></span>, <span class="hljs-number"><span class="hljs-number">0x01</span></span>, <span class="hljs-comment"><span class="hljs-comment">// USAGE_PAGE (Generic Desktop) 0x15, 0x00, // LOGICAL_MINIMUM (0) 0x09, 0x04, // USAGE (Joystick) 0xa1, 0x01, // COLLECTION (Application) 0x05, 0x02, // USAGE_PAGE (Simulation Controls) 0x09, 0xbb, // USAGE (Throttle) 0x15, 0x00, // LOGICAL_MINIMUM (0) 0x27, 0xff, 0xff, 0x00, 0x00, // LOGICAL_MAXIMUM (65535) 0x75, 0x10, // REPORT_SIZE (16) 0x95, 0x01, // REPORT_COUNT (1) 0x81, 0x02, // INPUT (Data,Var,Abs) 0x05, 0x01, // USAGE_PAGE (Generic Desktop) 0x09, 0x01, // USAGE (Pointer) 0xa1, 0x00, // COLLECTION (Physical) 0x09, 0x30, // USAGE (X) 0x09, 0x31, // USAGE (Y) 0x95, 0x02, // REPORT_COUNT (2) 0x81, 0x02, // INPUT (Data,Var,Abs) 0xc0, // END_COLLECTION 0x05, 0x01, // USAGE_PAGE (Generic Desktop) 0x09, 0x32, // USAGE (Z) 0x95, 0x01, // REPORT_COUNT (1) 0x81, 0x02, // INPUT (Data,Var,Abs) 0x09, 0x33, // USAGE (Rx) 0x81, 0x02, // INPUT (Data,Var,Abs) 0x09, 0x34, // USAGE (Ry) 0x81, 0x02, // INPUT (Data,Var,Abs) 0x09, 0x35, // USAGE (Rz) 0x81, 0x02, // INPUT (Data,Var,Abs) 0x09, 0x36, // USAGE (Slider) 0x81, 0x02, // INPUT (Data,Var,Abs) 0x09, 0x39, // USAGE (Hat switch) 0x15, 0x01, // LOGICAL_MINIMUM (1) 0x25, 0x08, // LOGICAL_MAXIMUM (8) 0x35, 0x00, // PHYSICAL_MINIMUM (0) 0x46, 0x0e, 0x01, // PHYSICAL_MAXIMUM (270) 0x65, 0x14, // UNIT (Eng Rot:Angular Pos) 0x75, 0x08, // REPORT_SIZE (8) 0x95, 0x01, // REPORT_COUNT (1) 0x81, 0x02, // INPUT (Data,Var,Abs) 0x05, 0x09, // USAGE_PAGE (Button) 0x19, 0x01, // USAGE_MINIMUM (Button 1) 0x29, 0x40, // USAGE_MAXIMUM (Button 64) 0x15, 0x00, // LOGICAL_MINIMUM (0) 0x25, 0x01, // LOGICAL_MAXIMUM (1) 0x75, 0x01, // REPORT_SIZE (1) 0x95, 0x40, // REPORT_COUNT (64) 0x55, 0x00, // UNIT_EXPONENT (0) 0x65, 0x00, // UNIT (None) 0x81, 0x02, // INPUT (Data,Var,Abs) /* USER CODE END 0 */ 0xC0 /* END_COLLECTION */ };</span></span></code> </pre> <br></div></div><br>  Tats√§chlich kann es beliebig zusammengestellt werden. Zuerst stellen Sie die USAGE PAGE-Parameter und die erforderliche USAGE ein, z. B. die USAGE-Achse (Gas), und nach dem Wort INPUT (Data, Var, Abs) geht das System davon aus, dass wir die Achse ‚ÄûGas‚Äú haben.  Die Abmessung der variablen Achse und ihre Anzahl werden durch die Parameter LOGICAL_MAXIMUM, MINIMUM, REPORT_SIZE, REPORT_COUNT festgelegt, die vor INPUT liegen m√ºssen. <br><br>  Weitere Details zu diesen Parametern sowie zu den Funktionen (Data, Var, Abs) finden Sie in der <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Ger√§teklassendefinition f√ºr Human Interface Devices (HID) v1.11</a> . <br><br>  Das Folgende ist ein Beispiel f√ºr die Initialisierung der Drosselklappenachse aus meinem Deskriptor.  In diesem Beispiel hat Throttle einen Wertebereich von 0-65535, der einer Variablen uint16_t entspricht. <br><br><pre> <code class="cpp hljs"> <span class="hljs-number"><span class="hljs-number">0x05</span></span>, <span class="hljs-number"><span class="hljs-number">0x02</span></span>, <span class="hljs-comment"><span class="hljs-comment">// USAGE_PAGE (Simulation Controls) 0x09, 0xbb, // USAGE (Throttle) 0x15, 0x00, // LOGICAL_MINIMUM (0) 0x27, 0xff, 0xff, 0x00, 0x00, // LOGICAL_MAXIMUM (65535) 0x75, 0x10, // REPORT_SIZE (16) 0x95, 0x01, // REPORT_COUNT (1) 0x81, 0x02, // INPUT (Data,Var,Abs)</span></span></code> </pre> <br>  Angenommen, Sie k√∂nnen nicht jedes Mal LOGICAL_MAXIMUM, MINIMUM, REPORT_SIZE, REPORT_COUNT schreiben. Der Host ermittelt diesen Wert anhand des vorherigen Parameters.  Dies wird durch die Achsen veranschaulicht, die nacheinander verlaufen, ohne die Gr√∂√üe und Anzahl anzugeben: <br><br><pre> <code class="cpp hljs"> <span class="hljs-number"><span class="hljs-number">0x09</span></span>, <span class="hljs-number"><span class="hljs-number">0x32</span></span>, <span class="hljs-comment"><span class="hljs-comment">// USAGE (Z) 0x95, 0x01, // REPORT_COUNT (1) 0x81, 0x02, // INPUT (Data,Var,Abs) 0x09, 0x33, // USAGE (Rx) 0x81, 0x02, // INPUT (Data,Var,Abs) 0x09, 0x34, // USAGE (Ry) 0x81, 0x02, // INPUT (Data,Var,Abs) 0x09, 0x35, // USAGE (Rz) 0x81, 0x02, // INPUT (Data,Var,Abs) 0x09, 0x36, // USAGE (Slider)</span></span></code> </pre> <br>  Die folgende Struktur entspricht all diesem Deskriptor, der unter dem Spoiler h√∂her ist.  Es ist in der Tat nicht mehr obligatorisch, es ist nur bequemer, basierend auf Zeigern aufzuzeichnen. <br><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">pragma</span></span></span><span class="hljs-meta"> pack(push, 1) typedef struct _myReportStruct { uint16_t Throttle; uint16_t X; uint16_t Y; uint16_t Z; uint16_t Rx; uint16_t Ry; uint16_t Rz; uint16_t Slider; uint8_t Hat; </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">// 0 - none, 1 - up, 2 - up-right, 3 - right, 4 - down-right... uint32_t Buttons1; // 32 buttons of 1 bit each uint32_t Buttons2; // 32 buttons of 1 bit each }myReportStruct; #pragma pack(pop) volatile myReportStruct Desk;</span></span></span></span></code> </pre> <br>  Diese Struktur kann von der Funktion an den Host gesendet werden <br><br><pre> <code class="cpp hljs">USBD_CUSTOM_HID_SendReport(&amp;hUsbDeviceFS, (<span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> *) &amp;Desk, <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(Desk));</code> </pre> <br>  Der erste Parameter ist ein USB-Handle, der bereits in unserem Cube erstellt wurde.  M√∂glicherweise m√ºssen Sie die erforderliche Datei in das <i>Include einf√ºgen,</i> in dem dieses Handle zum ersten Mal initialisiert wird, und <i>extern USBD_HandleTypeDef hUsbDeviceFS</i> schreiben <i>.</i>  damit du mit ihm arbeiten kannst.  Der zweite Parameter ist ein Zeiger auf unsere Struktur und der dritte ist die Gr√∂√üe der Struktur in Bytes. <br><br>  Nach dem Bef√ºllen und Flashen des Controllers werden Sie feststellen, dass sich etwas USB langsam bewegt.  Die Daten aus unserem Panel werden nicht schnell aktualisiert.  Um schnell zu sein, m√ºssen Sie in den Dateien usbd_customhid.h #define CUSTOM_HID_EPIN_SIZE auf den Maximalwert 0x40 √§ndern, #define CUSTOM_HID_EPOUT_SIZE auch 0x40.  Suchen Sie in der Datei usbd_customhid.c Kommentare im Endpunktdeskriptor "/ * bInterval: Abfrageintervall (20 ms) * /" und √§ndern Sie das Deskriptorbyte f√ºr jeden Endpunkt nur zweimal in 0x01.  Dies entspricht einem Datenaustausch von 1 ms. <br><br><img src="https://habrastorage.org/webt/yf/zm/cx/yfzmcxseu1la7jgqxyql9qzm4ji.png"><br>  <i>Es sollte so etwas sein.</i>  <i>Standardger√§t ohne Installation von Treibern</i> <br><br>  Im Allgemeinen ist die Verwaltungsfunktion ein wenig verstanden.  Es ist ganz einfach und alle Tasten und Achsen funktionieren bereits.  Es bleibt, damit die Anzeigen funktionieren.  Ich habe es getan, ungef√§hr sechs Monate, und seit einem halben Jahr sammelt sich das Panel in einer langen Schachtel.  Es gibt keine Zeit.  Aus diesem Grund habe ich mich entschlossen, den Artikel in dieser Form zu gestalten, da sonst die Gefahr besteht, dass er nicht einmal herauskommt. <br><br>  Bei Displays ist alles wie bei Achsen.  F√ºr sie m√ºssen wir unseren Ger√§te-HID-Deskriptor erg√§nzen, nur angeben, dass dies Anzeigen sind, und anstatt Eingabedaten zu akzeptieren, sendet der Host Ausgabedaten. <br><br>  Der Griff des HID-Ger√§ts ist erheblich gewachsen.  Hier habe ich bereits die Report ID-Parameter angewendet, um den Sende- / Empfangspuffer und die Endpunkte nicht mit vollst√§ndigen Daten zu verstopfen und um zu unterscheiden, welche Art von Telegramm wir empfangen haben.  Die Berichts-ID ist ein uint8_t-Byte mit dem Wert, der am Anfang des Telegramms steht.  Der Wert, den wir im Ger√§tedeskriptor HID festgelegt haben. <br><br><div class="spoiler">  <b class="spoiler_title">CUSTOM_HID_ReportDesc_FS</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">//AXIS 0x05, 0x01, // USAGE_PAGE (Generic Desktop) 0x09, 0x04, // USAGE (Joystick) 0xa1, 0x01, // COLLECTION (Application)28 0x05, 0x02, // USAGE_PAGE (Simulation Controls) 0x09, 0xbb, // USAGE (Throttle) 0x15, 0x00, // LOGICAL_MINIMUM (0) 0x27, 0xff, 0xff, 0x00, 0x00, // LOGICAL_MAXIMUM (65535) 0x75, 0x10, // REPORT_SIZE (16) 0x95, 0x01, // REPORT_COUNT (1) 0x85, 0x01, // REPORT_ID (1) 0x81, 0x02, // INPUT (Data,Var,Abs) 0x05, 0x01, // USAGE_PAGE (Generic Desktop) 0x09, 0x01, // USAGE (Pointer) 0xa1, 0x00, // COLLECTION (Physical) 0x09, 0x30, // USAGE (X) 0x09, 0x31, // USAGE (Y) 0x95, 0x02, // REPORT_COUNT (2) 0x81, 0x02, // INPUT (Data,Var,Abs) 0xc0, // END_COLLECTION 0x05, 0x01, // USAGE_PAGE (Generic Desktop) 0x09, 0x32, // USAGE (Z) 0x95, 0x01, // REPORT_COUNT (1) 0x81, 0x02, // INPUT (Data,Var,Abs) 0x09, 0x33, // USAGE (Rx) 0x81, 0x02, // INPUT (Data,Var,Abs) 0x09, 0x34, // USAGE (Ry) 0x81, 0x02, // INPUT (Data,Var,Abs) 0x09, 0x35, // USAGE (Rz) 0x81, 0x02, // INPUT (Data,Var,Abs) 0x09, 0x36, // USAGE (Slider) 0x81, 0x02, // INPUT (Data,Var,Abs) //HAT 0x09, 0x39, // USAGE (Hat switch) 0x15, 0x01, // LOGICAL_MINIMUM (1) 0x25, 0x08, // LOGICAL_MAXIMUM (8) 0x35, 0x00, // PHYSICAL_MINIMUM (0) 0x46, 0x0e, 0x01, // PHYSICAL_MAXIMUM (270) 0x65, 0x14, // UNIT (Eng Rot:Angular Pos) 0x75, 0x08, // REPORT_SIZE (8) 0x95, 0x01, // REPORT_COUNT (1) 0x81, 0x02, // INPUT (Data,Var,Abs) //Buttons 0x05, 0x09, // USAGE_PAGE (Button) 0x19, 0x01, // USAGE_MINIMUM (Button 1) 0x29, 0x40, // USAGE_MAXIMUM (Button 64) 0x15, 0x00, // LOGICAL_MINIMUM (0) 0x25, 0x01, // LOGICAL_MAXIMUM (1) 0x75, 0x01, // REPORT_SIZE (1) 0x95, 0x40, // REPORT_COUNT (64) 0x55, 0x00, // UNIT_EXPONENT (0) 0x65, 0x00, // UNIT (None) 0x81, 0x02, // INPUT (Data,Var,Abs) //LEDs 0x85, 0x02, // REPORT_ID (2) 0x05, 0x08, // USAGE_PAGE (LEDs) 0x09, 0x4B, // USAGE (Generic Indicator) 0x95, 0x40, // REPORT_COUNT (16) 0x91, 0x02, // OUTPUT (Data,Var,Abs) 0xc0, // END_COLLECTION //LCD Displays 0x05, 0x14, // USAGE_PAGE (Alphnumeric Display) 0x09, 0x01, // USAGE (Alphanumeric Display) 0x15, 0x00, // LOGICAL_MINIMUM (0) 0xa1, 0x02, // COLLECTION (Logical) 0x09, 0x32, // USAGE (Cursor Position Report) 0xa1, 0x02, // COLLECTION (Logical) 0x85, 0x04, // REPORT_ID (4) 0x75, 0x08, // REPORT_SIZE (8) 0x95, 0x01, // REPORT_COUNT (1) 0x25, 0x13, // LOGICAL_MAXIMUM (19) 0x09, 0x34, // USAGE (Column) 0xb1, 0x22, // FEATURE (Data,Var,Abs,NPrf) 0x25, 0x03, // LOGICAL_MAXIMUM (3) 0x09, 0x33, // USAGE (Row) 0x91, 0x22, // OUTPUT (Data,Var,Abs,NPrf) 0xc0, // END_COLLECTION 0x09, 0x2b, // USAGE (Character Report) 0xa1, 0x02, // COLLECTION (Logical) 0x85, 0x05, // REPORT_ID (5) 0x95, 0x14, // REPORT_COUNT (20) 0x26, 0xFF, 0x00, // LOGICAL_MAXIMUM (255) 0x09, 0x2c, // USAGE (Display Data) 0x92, 0x02, 0x01, // OUTPUT (Data,Var,Abs,Buf) 0xc0, // END_COLLECTION 0x09, 0x24, // USAGE (Display Control Report) 0x85, 0x06, // REPORT_ID (6) 0x95, 0x01, // REPORT_COUNT (1) 0x91, 0x22, // OUTPUT (Data,Var,Abs,NPrf) 0xc0, // END_COLLECTION //LED Displays 0x05, 0x14, // USAGE_PAGE (Alphnumeric Display) 0x09, 0x01, // USAGE (Alphanumeric Display) 0x15, 0x00, // LOGICAL_MINIMUM (0) 0xa1, 0x02, // COLLECTION (Logical) 0x09, 0x2b, // USAGE (Character Report) 0xa1, 0x02, // COLLECTION (Logical) 0x85, 0x07, // REPORT_ID (7) 0x75, 0x08, // REPORT_SIZE (8) 0x95, 0x28, // REPORT_COUNT (40) 0x26, 0xFF, 0x00, // LOGICAL_MAXIMUM (255) 0x09, 0x2c, // USAGE (Display Data) 0x92, 0x02, 0x01, // OUTPUT (Data,Var,Abs,Buf) 0xc0, // END_COLLECTION //Other DATA 0x06, 0x00, 0xff, // USAGE_PAGE (Generic Desktop) 0x09, 0x01, // USAGE (Vendor Usage 1) 0xa1, 0x01, // COLLECTION (Application) 0x85, 0x08, // REPORT_ID (8) 0x09, 0x01, // USAGE (Vendor Usage 1) 0x15, 0x00, // LOGICAL_MINIMUM (0) 0x27, 0xff, 0xff, 0x00, 0x00, // LOGICAL_MAXIMUM (65535) 0x75, 0x10, // REPORT_SIZE (16) 0x95, 0x0A, // REPORT_COUNT (10) 0x91, 0x82, // OUTPUT (Data,Var,Abs,Vol)</span></span></code> </pre> </div></div><br>  Die Ausgabe wird in der <i>statischen</i> Funktion <i>int8_t CUSTOM_HID_OutEvent_FS (Status uint8_t event_idx, Status uint8_t) verarbeitet</i> , die sich standardm√§√üig in usbd_custom_hid_if.c befindet. <br><br><div class="spoiler">  <b class="spoiler_title">statisch int8_t CUSTOM_HID_OutEvent_FS ()</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> int8_t </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CUSTOM_HID_OutEvent_FS</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint8_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> event_idx, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint8_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> state)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">/* USER CODE BEGIN 6 */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> dataReceiveArray[USBD_CUSTOMHID_OUTREPORT_BUF_SIZE]; USBD_CUSTOM_HID_HandleTypeDef *hhid = (USBD_CUSTOM_HID_HandleTypeDef*)hUsbDeviceFS.pClassData; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; USBD_CUSTOMHID_OUTREPORT_BUF_SIZE; i++) { dataReceiveArray[i] = hhid-&gt;Report_buf[i]; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (dataReceiveArray[<span class="hljs-number"><span class="hljs-number">0</span></span>] == <span class="hljs-number"><span class="hljs-number">2</span></span>) <span class="hljs-comment"><span class="hljs-comment">//report ID 2 leds { //  Report id == 2,   -     dataReceiveArray[1 + N], ,  LED } if (dataReceiveArray[0] == 4) //report ID 4 cursor position { //  Report id == 4,   -,     LCD } if (dataReceiveArray[0] == 5) //report ID 5 display data { //  Report id == 5,   -,     USB  LCD } //   ,   ID     return (USBD_OK); /* USER CODE END 6 */ }</span></span></code> </pre> <br></div></div><br>  Es bleibt nur ein Programm auf einem PC zu schreiben, das die erforderlichen Berichte zur Steuerung der Anzeigen sendet.  Um den MK-Code zu √ºberpr√ºfen, ist jedoch ein gro√üartiges Programm von ST: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">USB HID Demonstrator</a> geeignet.  Sie k√∂nnen Berichte von einem PC mit beliebigen Inhalten senden. <br><br><img src="https://habrastorage.org/webt/ft/bd/e3/ftbde3fwn14llpdhjmakp7pwx4a.jpeg"><br>  <i>LED-Anzeigetest</i> <br><br>  Zu diesem Zeitpunkt bin ich bisher fertig.  Und es ist nicht bekannt, ob ich wieder anfangen werde. <br><br>  Es wird in Simulatoren gespielt, die interessanter sind als mit einer Tastatur.  Aber nicht so sehr, dass es einen direkten Wow-Effekt gab.  Die Tastatur sieht auch aus wie ein Bedienfeld.  Die Steuerung von Joystickachsen ist jedoch zumindest ungew√∂hnlich.  F√ºhlen Sie sich wie ein Astronaut.  Zwar wird zum vollst√§ndigen Eintauchen ein Raumanzug ben√∂tigt. <br><br>  Ich hoffe du warst interessiert.  Tippfehler, Ungenauigkeiten und Wahnvorstellungen sind vorhanden.  Diejenigen, die tiefer in den Code eintauchen m√∂chten, k√∂nnen <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">hier sehen</a> . <br><br>  Mit freundlichen Gr√º√üen. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de434854/">https://habr.com/ru/post/de434854/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de434838/index.html">Erstellen eines Bots zur Teilnahme am CodeBall des russischen AI Cup 2018</a></li>
<li><a href="../de434840/index.html">Wie habe ich "Your Diary" gemacht - oder die Situation auf dem Markt f√ºr elektronische Tageb√ºcher</a></li>
<li><a href="../de434842/index.html">Stadtfarmen k√∂nnen extrem effektiv sein, aber momentan nicht</a></li>
<li><a href="../de434844/index.html">Wiederherstellung der kognitiven F√§higkeiten von 100 Patienten (√úbersetzung eines Artikels von Dale Bredesen)</a></li>
<li><a href="../de434848/index.html">Teslas Board of Directors besteht aus zwei unabh√§ngigen Direktoren - Larry Ellison und Caitlin Wilson-Thompson</a></li>
<li><a href="../de434856/index.html">Bearbeiten von Videos in MPC mithilfe von Shadern</a></li>
<li><a href="../de434858/index.html">Jetpack Racing 2019</a></li>
<li><a href="../de434862/index.html">Die intelligente Form chinesischer Schulkinder hilft, Fehlzeiten zu reduzieren</a></li>
<li><a href="../de434864/index.html">Senior Engineer auf der Suche nach Arbeit. Wie ich 15 technische Interviews durchlaufen habe und was ich dar√ºber denke</a></li>
<li><a href="../de434868/index.html">Die Blockchain ist tot. Es lebe die Blockchain</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>