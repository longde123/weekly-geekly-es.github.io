<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👩🏻‍🚀 🛫 👨🏼‍🔬 Introduction au pare-feu de couche 3 MikroTik 👈 🧑🏻 🌃</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Le pare-feu (ou filtre de paquets) est un sujet vaste et complexe à la fois théoriquement et concrètement. Un filtre de paquets dans divers systèmes d...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Introduction au pare-feu de couche 3 MikroTik</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/435070/"><p>  Le pare-feu (ou filtre de paquets) est un sujet vaste et complexe à la fois théoriquement et concrètement.  Un filtre de paquets dans divers systèmes d'exploitation peut avoir ses avantages et ses inconvénients par rapport à d'autres implémentations.  Dans cet article, je considérerai exclusivement le pare-feu dans RouterOS en gardant un œil sur son progiciel iptables. </p><a name="habracut"></a><br><h3 id="predislovie">  Préface </h3><br><h4 id="dlya-kogo-eta-statya">  À qui s'adresse cet article? </h4><br><p>  Si vous savez comment travailler avec iptables, alors allez-y et configurez le pare-feu, il n'y aura rien de nouveau pour vous dans cet article (enfin, sauf que des chaînes avec d'autres noms sont utilisées dans la table NAT).  Si c'est la première fois que vous voyez un pare-feu dans RouterOS et que vous souhaitez obtenir un script prêt à l'emploi pour la configuration, vous ne le trouverez pas ici.  Le matériel est destiné à ceux qui veulent avoir une idée de <strong>base</strong> du fonctionnement du pare-feu et de ce qui se passe avec le paquet ip à différentes étapes de son traitement.  Une compréhension plus approfondie viendra avec l'expérience et la résolution de problèmes quotidiens et inhabituels à l'aide d'un filtre de paquets. </p><br><h3 id="teoreticheskaya-chast">  Partie théorique </h3><br><h4 id="chto-takoe-layer3-firewall">  Qu'est-ce que le pare-feu Layer3? </h4><br><p><img src="https://habrastorage.org/webt/ai/xt/od/aixtod5yvn-bvirxxdvwmnm2m30.png"></p><br><p>  Supposons que vous ayez un routeur avec accès Internet et deux interfaces de pont: bridge-lan (ether2-ether5) et bridge-dmz (ether6-ether10). </p><br><p>  Dans l'interface Bridge, les périphériques trouvent indépendamment des voisins de leur sous-réseau et échangent des paquets, le routeur agit comme un commutateur et ne surveille pas ce trafic au niveau du réseau (bien sûr, vous pouvez le forcer à le faire, mais nous parlerons du pare-feu Layer2 une autre fois). </p><br><p>  Si nécessaire, contactez l'appareil connecté à une autre interface de pont ou situé sur le réseau mondial, les appareils transmettent des paquets au routeur, qui détermine l'itinéraire et les traite au niveau du réseau (couche 3). </p><br><h4 id="packet-flow-diagram">  Diagramme de flux de paquets </h4><br><p>  Le chemin complet du trafic est décrit dans le diagramme de flux de paquets, il existe plusieurs versions officielles (v5, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">v6</a> ), elles doivent être connues et utilisées dans le travail quotidien, mais pour comprendre le fonctionnement du filtre de paquets, elles sont surchargées, donc je vais vous expliquer dans une version légère. </p><br><p><img src="https://habrastorage.org/webt/cb/fr/uu/cbfruui7ydb8lqm19myzozfotbo.png"></p><br><p>  L'interface d'entrée / sortie est n'importe quelle interface de routeur de couche 3 (physique ou virtuelle).  Un paquet qui va du réseau local à Internet arrive à l'interface d'entrée et quitte l'interface de sortie.  Un paquet provenant d'Internet vers le réseau local parvient également à l'interface d'entrée et quitte l'interface de sortie.  Le flux de paquets est toujours lu dans une seule direction entrée -&gt; sortie. </p><br><h4 id="osobennosti-terminologii">  Caractéristiques terminologiques </h4><br><p>  En étudiant le flux de paquets pour iptables, vous pouvez trouver des descriptions à travers "des chaînes dans des tables" ou des "tables dans des chaînes".  Le diagramme montre les tables enchaînées, lors de l'ajout de règles au pare-feu, tout se fera inversement. </p><br><p>  Mais en fait, le paquet se déplace entre les blocs [chain + tables], par exemple, si vous faites accepter dans le bloc [prerouting + mangle], le paquet de transit sera toujours traité dans [forward + mangle].  Ceci est important à retenir dans les configurations complexes avec pbr et files d'attente. </p><br><p>  La documentation iptables a des définitions plus précises, mais en termes simples: <br>  <strong>Les chaînes</strong> sont responsables de l'endroit où le paquet est traité et de la séquence des règles. <br>  <strong>Les tableaux</strong> déterminent les actions pouvant être effectuées sur un package. </p><br><h4 id="bazovye-varianty-sledovaniya-paketa">  Options de suivi du package de base </h4><br><p><img src="https://habrastorage.org/webt/1d/tm/6j/1dtm6j1wiiolczrm215gcz_imss.png"></p><br><p>  <strong>Transit</strong> </p><br><p><img src="https://habrastorage.org/webt/rj/9z/_w/rj9z_w8s9pc4valiwixtkrwpdke.png"></p><br><ol><li>  Un paquet du réseau arrive sur l'une des interfaces du routeur </li><li>  Dans la chaîne PREROUTING, l'administrateur peut influencer la route des paquets: déterminer l'interface de sortie (routage de la base de règles) ou rediriger vers une autre adresse (dst-nat). </li><li>  Conformément à la table de routage pour le paquet, l'interface sortante est déterminée. </li><li>  La chaîne FORWARD est le principal lieu de filtrage pour le trafic de passage. </li><li>  Le dernier élément avant d'entrer dans le réseau est la chaîne POSTROUTING, dans laquelle vous pouvez modifier l'adresse de l'expéditeur (src-nat). </li><li>  Le paquet est allé en ligne. </li></ol><br><p>  <strong>Entrant</strong> </p><br><p><img src="https://habrastorage.org/webt/qn/l8/gd/qnl8gdad6vpxhgdjnhvhpzngcau.png"></p><br><ol><li>  Un paquet du réseau est arrivé à l'une des interfaces du routeur </li><li>  Frappez la chaîne PREROUTING. </li><li>  Selon la table de routage, le paquet a été envoyé pour traitement au processus local. </li><li>  La chaîne INPUT filtre le trafic entrant par l'administrateur. </li><li>  Le package a été traité par le processus local. </li></ol><br><p>  <strong>Sortant</strong> </p><br><p><img src="https://habrastorage.org/webt/jh/qr/sd/jhqrsd8rq3lt8x1s3jzjuup_m-8.png"></p><br><ol><li>  Un des processus du routeur a généré un paquet IP (nouveau ou réponse - peu importe). </li><li>  Conformément à la table de routage, une interface de sortie est définie pour le paquet. </li><li>  L'administrateur peut filtrer le trafic sortant ou modifier l'itinéraire dans la chaîne OUTPUT. </li><li>  Pour le package, la décision finale sur l'interface de sortie est prise. </li><li>  Le paquet tombe en POSTROUTING, tout comme le trafic qui <em>passe</em> . </li><li>  Le paquet est allé en ligne. </li></ol><br><h4 id="connection-tracker">  Suivi de connexion </h4><br><p>  Vous devez d'abord comprendre ce que sont les filtres de paquets avec état et sans état. </p><br><p><img src="https://habrastorage.org/webt/8c/lg/7z/8clg7zcfasexwuw3e3utjyhypl8.png"></p><br><p>  Un exemple.  L'ordinateur 192.168.100.10 ouvre une connexion TCP au serveur 192.0.2.10.  Côté client, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">le port dynamique</a> 49149 est utilisé, côté serveur 80. Avant la réception du contenu, le client et le serveur doivent échanger des paquets pour établir une session TCP. </p><br><p>  Dans les <em>apatrides, vous</em> devez ouvrir le trafic du réseau local à Internet et d'Internet au réseau local (au moins pour la plage de ports dynamiques).  Ce qui dans son ensemble est un trou. </p><br><p>  Dans un routeur avec <em>état</em> , il analyse les paquets et, après avoir reçu la synchronisation tcp de 192.168.100.10:49149 pour 192.0.2.10:80, considère cela comme le début d'une nouvelle connexion.  Tous les autres paquets (dans n'importe quelle direction) entre 192.168.100.10:49149 et 192.0.2.10:80 seront considérés comme faisant partie de la connexion établie jusqu'à la fermeture de la session TCP ou l'expiration des temporisations. </p><br><p>  Pour UDP / ICMP et d'autres types de trafic, où le début et la fin de la connexion ne peuvent pas être clairement distingués, le premier paquet est le premier, les autres sont considérés comme faisant partie de la connexion établie et mettent à jour les temporisateurs, le routeur oublie ces connexions après l'expiration des temporisateurs. </p><br><p>  Le traqueur de connexion divise les packages en plusieurs types: </p><br><p><img src="https://habrastorage.org/webt/j2/do/3f/j2do3fsdj1-t-hq7p2wnf0pnqte.png"></p><br><p>  <em>new</em> - un paquet qui ouvre une connexion, par exemple <em>syn</em> pour tcp ou le premier paquet dans un flux udp. <br>  <em>établi</em> - un paquet lié à une connexion connue. <br>  <em>related</em> - paquet lié à la connexion supplémentaire dans le multiprotocole (sip, pptp, ftp, ...). <br>  <em>invalide</em> - paquet d'une connexion inconnue. <br>  non suivi - traqueur de connexion de paquet non suivi. </p><br><p>  <strong>Configuration du traqueur de connexion</strong> <br>  activé = oui - activé. <br>  activé = non - désactivé. <br>  enabed = auto-désactivé jusqu'à ce qu'une règle utilisant les capacités de conntrack apparaisse dans le pare-feu.  Il est utilisé par défaut. </p><br><p><img src="https://habrastorage.org/webt/a9/2b/tl/a92btlt5yfxh9fhf7-wmpgrohbu.png"></p><br><p>  Les paramètres restants sont des minuteries différentes et ne nécessitent généralement pas de réglage. </p><br><p>  L'administrateur peut afficher et supprimer les connexions, par exemple, la connexion au NAT ressemble à ceci: </p><br><p><img src="https://habrastorage.org/webt/mb/i7/7x/mbi77x9oinpcys1ohb516glu4mc.png"></p><br><p>  L'utilisation de conntrack affecte les performances et la consommation de ressources (en particulier avec un grand nombre de connexions), mais cela ne fonctionnera pas dans la plupart des configurations, car  vous aurez un pare-feu sans état sans NAT. </p><br><div class="spoiler">  <b class="spoiler_title">Liste des fonctions dépendantes du traqueur de connexion</b> <div class="spoiler_text"><p><img src="https://habrastorage.org/webt/la/td/kz/latdkzskcwi9cx2o4lkdwtehps8.png"></p></div></div><br><h4 id="ttl">  TTL </h4><br><p>  Time To Live - un champ dans l'en-tête de paquet IP qui définit le nombre de routeurs par lesquels un paquet peut passer avant qu'il ne soit détruit, protège contre le transfert de paquets sans fin pendant les boucles de routage. </p><br><p><img src="https://habrastorage.org/webt/gp/qi/js/gpqijsw0wgsu2yqrkcamd3z0mhk.png"></p><br><p>  Lors du transfert, le routeur diminue la valeur TTL de 1, si TTL = 0.  Dans ce cas, un paquet avec TTL = 1 arrivera au processus local du routeur. </p><br><p>  Certains opérateurs utilisent des astuces TTL pour empêcher l'utilisation de routeurs.  Toutes ces limitations valent bien l'augmentation de la valeur ttl dans la table mangle. </p><br><h4 id="nat">  NAT </h4><br><p>  Traduction d'adresses réseau - technologie pour changer les adresses dans l'en-tête du paquet ip.  Comme Linux, NAT fait partie du filtre de paquets.  NAT fonctionne basé sur le traqueur de connexion. </p><br><p>  Initialement, le NAT a été conçu comme une solution rapide au problème d'épuisement des adresses IPv4, pour les réseaux locaux, il a été proposé d'utiliser un sous-réseau des plages: 10.0.0.0/8;  172.16.0.0/12;  192.168.0.0/16 et les traduire en une (ou plusieurs) adresses routables.  En fait, il existe quelques sous-réseaux de service supplémentaires qui peuvent être utilisés sur des réseaux privés et le routeur, en principe, est le même que pour NAT, mais il est recommandé de suivre les normes. </p><br><p>  Processus NAT uniquement: tcp, udp, icmp et certains multi-protocoles de [IP] -&gt; [Firewall] -&gt; [Service Port].  Seul le premier paquet (état de connexion = nouveau) de la connexion est traité, les paquets restants sont traités automatiquement sans la participation de la table NAT.  Cela peut être suivi par le changement de compteurs dans les règles. </p><br><p>  L'en-tête du paquet contient respectivement l'adresse source et destination et le NAT est divisé en NAT source et destination. </p><br><p>  <strong>Source NAT</strong> - usurpation d'adresse de l'expéditeur, présente sur la grande majorité des routeurs domestiques et d'entreprise dans le monde. </p><br><p><img src="https://habrastorage.org/webt/2s/ej/or/2sejor290wkc26agkonobacposa.png"></p><br><p>  Il permet à de nombreux appareils avec des adresses "grises" sur le réseau local de communiquer avec Internet en utilisant une (ou plusieurs) adresses réelles. </p><br><p><img src="https://habrastorage.org/webt/hh/hi/du/hhhidurhkrsiiuflmg6dakupph8.png"></p><br><p>  En retournant à Packet Flow, nous voyons que SRC-NAT est en Postrouting, après avoir décidé de router le paquet. </p><br><p>  Le paquet de réponse passe par <em>un</em> DST-NAT <em>implicite</em> dans lequel l'adresse du destinataire est changée en locale. </p><br><p>  <strong>Destination NAT</strong> - substitution de l'adresse du destinataire. </p><br><p><img src="https://habrastorage.org/webt/id/rb/l9/idrbl9jdlfgfvbftjkgwoorszae.png"></p><br><p>  Il est utilisé, si nécessaire, pour transférer le paquet vers une autre adresse, il est généralement utilisé pour "transférer des ports" du réseau externe au réseau local. </p><br><p><img src="https://habrastorage.org/webt/ju/uv/ly/juuvlyxr74gi8qykxx80vzhyvg4.png"></p><br><p>  Selon Packet Flow, l'opération DST-NAT se produit avant la décision de routage dans le préroutage; le SRC-NAT <em>implicite</em> est présent pour le trafic de réponse. </p><br><p>  NAT est un outil de gestion du trafic assez puissant, mais il doit être utilisé en dernier (lorsque d'autres outils ne peuvent pas aider). </p><br><h4 id="cepochkichains-bazovye-i-polzovatelskie">  Chaînes (chaînes) de base et utilisateur </h4><br><p>  Les chaînes sont constituées de règles et forcent la logique du traitement des paquets. <br>  Il existe plusieurs chaînes de base mappées au flux de paquets: <br>  <strong>Préroutage (dstnat)</strong> - traitement des paquets avant de décider du routage <br>  <strong>Entrée</strong> - traitement des paquets destinés aux processus locaux du routeur <br>  <strong>Sortie</strong> - traitement des paquets de paquets générés par les processus locaux du routeur <br>  <strong>Transférer</strong> - Traiter le trafic passant <br>  <strong>Postrouting (srcnat)</strong> - Traitement du trafic prêt à être transmis à l'interface </p><br><p>  <em>Tout est comme dans iptables, mais les chaînes en nat sont renommées.</em>  <em>Je ne sais pas à quoi cela est lié (très probablement avec le hotspot ou le déchargement matériel de nat), mais cela ne change rien du tout.</em> </p><br><p>  Le package transmet les règles de la chaîne de manière séquentielle, s'il convient à toutes les conditions, alors l'action est appliquée au package.  Si l'action se termine et ne supprime pas le paquet, elle est transmise au bloc de flux de paquets suivant. </p><br><p>  Toutes les chaînes de base ont une action par défaut (si le package ne correspondait à aucune des règles) - <em>acceptez</em> . </p><br><p>  Des chaînes personnalisées sont nécessaires pour réduire le nombre de règles transmises par chaque paquet et pour créer des règles complexes pour le traitement du trafic.  Toutes les chaînes d'utilisateurs ont une action par défaut - <em>return</em> . </p><br><p><img src="https://habrastorage.org/webt/bk/rg/sk/bkrgskh5wudzzf54mueqiy9oehk.png"></p><br><p>  Dans le tableau, vous pouvez transmettre les règles de plusieurs chaînes de base (et utilisateur) différentes à la chaîne utilisateur, mais le paquet retournera à la chaîne dont il est issu. </p><br><p><img src="https://habrastorage.org/webt/_8/kw/oi/_8kwoirut9mtd67elbejqkzdsek.png"></p><br><h4 id="usloviya-v-pravilah">  Termes et conditions </h4><br><p>  Les chaînes se composent de règles; chaque règle se compose de conditions et d'actions.  Il y a beaucoup de conditions, mais vous n'utiliserez pas tous dans des configurations réelles.  La plupart des conditions peuvent être précédées de "non" (signe "!").  Pour coïncider avec la règle, le forfait doit être adapté à toutes ces conditions. </p><br><p><img src="https://habrastorage.org/webt/la/dh/or/ladhorisauzv81cnmffmkjo6_hi.png"></p><br><div class="spoiler">  <b class="spoiler_title">Quelques conditions</b> <div class="spoiler_text"><table><thead><tr><th>  Condition </th><th>  La description </th></tr></thead><tbody><tr><td>  adresse src </td><td>  Adresse source </td></tr><tr><td>  adresse-dst </td><td>  Adresse du destinataire </td></tr><tr><td>  liste-d'adresses-src </td><td>  L'adresse source est répertoriée. </td></tr><tr><td>  dst-address-list </td><td>  L'adresse du destinataire est répertoriée </td></tr><tr><td>  protocole </td><td>  Protocole de couche transport </td></tr><tr><td>  port src </td><td>  Port source </td></tr><tr><td>  port-dst </td><td>  Port destinataire </td></tr><tr><td>  port </td><td>  Port source ou de destination </td></tr><tr><td>  dans l'interface </td><td>  L'interface sur laquelle le paquet est venu </td></tr><tr><td>  hors interface </td><td>  L'interface à partir de laquelle le paquet sera envoyé au réseau </td></tr><tr><td>  in-interface-list </td><td>  L'interface à laquelle le package est arrivé est répertoriée </td></tr><tr><td>  out-interface-list </td><td>  L'interface à partir de laquelle le paquet sera envoyé au réseau est répertoriée </td></tr><tr><td>  couche7-protocole </td><td>  Analyse du contenu des 10 premiers paquets d'une connexion </td></tr><tr><td>  contenu </td><td>  Rechercher une chaîne donnée dans un lot </td></tr><tr><td>  tls-host </td><td>  Rechercher l'hôte dans l'en-tête tls </td></tr><tr><td>  politique ipsec </td><td>  Vérifiez si le paquet correspond à la politique IPSec ou non </td></tr><tr><td>  taille de paquet </td><td>  taille de paquet en octets </td></tr><tr><td>  src-mac-address </td><td>  adresse source du package mac </td></tr><tr><td>  connexion-marque </td><td>  Étiquette de connexion </td></tr><tr><td>  marque de paquet </td><td>  Étiquette d'emballage </td></tr><tr><td>  marque de routage </td><td>  Packet Waypoint </td></tr><tr><td>  état de connexion </td><td>  État du package de connexion </td></tr><tr><td>  tcp-flags </td><td>  Drapeaux tcp package </td></tr><tr><td>  icmp-options </td><td>  Options du package ICMP </td></tr><tr><td>  aléatoire </td><td>  La règle est déclenchée (lorsque d'autres conditions coïncident) avec une probabilité donnée </td></tr><tr><td>  le temps </td><td>  Vous pouvez spécifier les heures de travail de la règle, malheureusement sans conversion de date </td></tr><tr><td>  ttl </td><td>  Valeur du champ ttl dans le package </td></tr><tr><td>  dscp </td><td>  Valeur du champ DSCP (ToS) dans le paquet </td></tr><tr><td>  - // - </td><td>  - // - </td></tr><tr><td>  lieu avant </td><td>  Option de console (sans condition), vous permet d'ajouter une règle avant la spécification </td></tr><tr><td>  désactivé </td><td>  Option de console (pas de condition), vous permet de désactiver la règle </td></tr></tbody></table><br><p>  <strong>Remarques</strong> <br>  En tant qu'adresse src. (Dst.), Vous pouvez spécifier: une seule adresse IP, une plage d'adresses via un trait d'union ou un sous-réseau. <br>  Des listes d'adresses sont nécessaires pour combiner plusieurs adresses IP non connectées sous le même nom.  Contrairement à l'ipset dans netfilter, les entrées dans les listes MikroTik peuvent être supprimées après une période de temps spécifiée.  Vous pouvez afficher les listes et apporter des modifications dans [IP] -&gt; [Pare-feu] -&gt; [Listes d'adresses]. <br>  En tant que numéro de port (port, src-port, dst-port), vous pouvez spécifier un seul port, plusieurs ports séparés par des virgules ou une plage de ports via un trait d'union. </p></div></div><br><p>  Lors du dernier MUM dans MSC, il y avait une bonne présentation sur l'effet de diverses conditions sur la vitesse de traitement des paquets (vous y apprendrez comment utiliser la table brute pour réduire la charge sur le routeur), qui s'intéressent à: l' <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">enregistrement</a> et la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">présentation</a> . </p><br><h4 id="deystviya-v-tablicah">  Actions sur les tableaux </h4><br><p>  L'ensemble des actions disponibles sur le package dépend de la table dans laquelle il est traité. <br><img src="https://habrastorage.org/webt/i3/ba/xj/i3baxjyyz-fnswxpanh_qek5kq8.png"><br>  <strong>Filtre</strong> - table de filtrage du trafic, l'un des deux endroits où vous pouvez déposer le paquet. </p><br><p>  <strong>NAT</strong> - table pour modifier les adresses IP et les ports (tpc, udp) dans l'en-tête du paquet ip. </p><br><p>  <strong>Mangle</strong> - un tableau pour modifier d'autres champs du paquet ip et définir diverses étiquettes. </p><br><p><img src="https://habrastorage.org/webt/w0/dc/n3/w0dcn3uinajpugbflfjha0pt5jy.png"></p><br><p>  Il existe trois types d'étiquettes de paquets internes: connexion, paquet, route.  Les étiquettes n'existent que dans le routeur et ne vont pas au réseau.  Un paquet peut avoir une étiquette de chaque type, tout en passant plusieurs règles mark- * dans l'ordre, les étiquettes sont écrasées. <br>  Les étiquettes de route ne peuvent être définies que dans les chaînes de pré-routage et de sortie, le reste dans toutes les chaînes. </p><br><p>  Il est recommandé de marquer d'abord la connexion, puis le paquet (paquet) ou l'itinéraire (route).  La vérification des étiquettes est plus rapide que les champs de paquets.  En pratique, ce n'est pas toujours le cas dans les files d'attente complexes ou un marquage supplémentaire pbr de la connexion n'est pas utile. </p><br><p>  <strong>RAW</strong> - une table qui permet aux paquets de contourner le traqueur de connexion.  Il est utilisé pour contrer DoS et réduire la charge sur le processeur (par exemple, en contournant le trafic de multidiffusion).  Vous permet de laisser tomber le paquet. </p><br><p>  Les actions de fin achèvent le traitement d'un paquet dans la chaîne et le transmettent au bloc suivant dans le flux de paquets, ou le jettent. </p><br><div class="spoiler">  <b class="spoiler_title">Actions</b> <div class="spoiler_text"><table><thead><tr><th>  Table </th><th>  Action </th><th>  La description </th><th>  Fin? </th></tr></thead><tbody><tr><td>  Tous </td><td>  accepter </td><td>  Arrêtez de traiter le paquet et transférez-le vers le bloc de flux Pakcet suivant </td><td>  Oui </td></tr><tr><td>  Tous </td><td>  journal </td><td>  Informations sur le package de journaux. Dans les versions modernes, vous pouvez ajouter un journal à toute autre action. </td><td>  Non </td></tr><tr><td>  Tous </td><td>  passtrough </td><td>  Comptez le nombre de paquets.  Utilisé pour le débogage </td><td>  Non </td></tr><tr><td>  Tous </td><td>  ajouter src à la liste d'adresses et ajouter dst à la liste d'adresses </td><td>  Ajouter l'adresse source (destination) du paquet à la liste donnée </td><td>  Non </td></tr><tr><td>  Tous </td><td>  sauter </td><td>  Accéder à la chaîne d'utilisateurs </td><td>  Oui </td></tr><tr><td>  Tous </td><td>  retour </td><td>  Retour à la chaîne parent.  Dans les chaînes de base, cela fonctionne comme accepter </td><td>  Oui </td></tr><tr><td>  Filtre et brut </td><td>  laisser tomber </td><td>  Arrêter le flux de paquets sur le flux de paquets et les supprimer </td><td>  Oui </td></tr><tr><td>  Filtre et pré-routage </td><td>  fasttrack </td><td>  Paquet de drapeau pour un flux de paquets rapide </td><td>  Oui </td></tr><tr><td>  Filtrer </td><td>  rejeter </td><td>  Comme drop, mais un expéditeur de paquet reçoit une notification (tcp ou icmp) concernant le paquet abandonné </td><td>  Oui </td></tr><tr><td>  Filtrer </td><td>  trapit </td><td>  Émulez la présence d'un port ouvert.  Utilisé pour la protection contre le DoS, les erreurs trompeuses et (parfois) le débogage </td><td>  Oui </td></tr><tr><td>  NAT </td><td>  src-nat </td><td>  Substitution de l'adresse de l'expéditeur à l'adresse indiquée </td><td>  Oui </td></tr><tr><td>  NAT </td><td>  mascarade </td><td>  Un cas particulier de src-nat, remplace l'adresse de l'expéditeur par l'une des adresses de l'interface, est utilisé sur les interfaces dynamiques (dhcp, vpn).  Il n'est pas recommandé d'utiliser s'il y a plusieurs ip sur l'interface </td><td>  Oui </td></tr><tr><td>  NAT </td><td>  pareil </td><td>  Un cas particulier de src-nat.  Remplace l'adresse de l'expéditeur par une adresse de la plage spécifiée </td><td>  Oui </td></tr><tr><td>  NAT </td><td>  dst-nat </td><td>  Remplace l'adresse du destinataire par l'adresse spécifiée </td><td>  Oui </td></tr><tr><td>  NAT </td><td>  rediriger </td><td>  Un cas particulier de dst-nat, remplace l'adresse du destinataire par l'adresse de l'interface du routeur à laquelle le paquet est arrivé </td><td>  Oui </td></tr><tr><td>  NAT </td><td>  netmap </td><td>  Pas un remplacement pour dst-nat.  Utilisé pour la traduction de réseau à réseau, voir des exemples </td><td>  Oui </td></tr><tr><td>  Mangle </td><td>  marquer la connexion </td><td>  Étiquette de connexion </td><td>  Non </td></tr><tr><td>  Mangle </td><td>  marquer le paquet </td><td>  Étiquette de paquet appliquée dans les files d'attente </td><td>  Non </td></tr><tr><td>  Mangle </td><td>  marquer le routage </td><td>  Étiquette de route appliquée dans le routage de base de stratégie </td><td>  Non </td></tr><tr><td>  Mangle </td><td>  changer ttl </td><td>  Modifier ttl </td><td>  Non </td></tr><tr><td>  Mangle </td><td>  changer dcsp (tos) </td><td>  Modifier la décimale dcsp </td><td>  Non </td></tr><tr><td>  Mangle </td><td>  changer mss </td><td>  Changer mss en tcp syn </td><td>  Non </td></tr><tr><td>  Mangle </td><td>  clair df </td><td>  Drapeau clair et non parfumé </td><td>  Non </td></tr><tr><td>  Mangle </td><td>  supprimer les options ipv4 </td><td>  Effacer les options avancées d'ipv4 </td><td>  Non </td></tr><tr><td>  Mangle </td><td>  définir la priorité </td><td>  Définir la priorité pour CoS </td><td>  Non </td></tr><tr><td>  Mangle </td><td>  route </td><td>  Définissez la passerelle pour le paquet.  Version simple de PBR </td><td>  Non </td></tr><tr><td>  Mangle </td><td>  sniff tzsp </td><td>  Encapsuler les paquets dans udp et envoyer à l'IP spécifié </td><td>  Non </td></tr><tr><td>  Mangle </td><td>  renifler pc </td><td>  Un analogue de tzsp, mais avec un type d'encapsulation différent.  Dans wiki si cas d'utilisation avec calea </td><td>  Non </td></tr><tr><td>  Mangle </td><td>  passtrough </td><td>  Par défaut, la plupart des règles de mangle n'empêchent pas le paquet de passer, vous pouvez changer ce comportement en définissant passtrough = no </td><td>  Non </td></tr><tr><td>  Brut </td><td>  notrack </td><td>  Ne pas suivre le package dans le suivi des connexions </td><td>  Oui </td></tr></tbody></table><br><p>  <em>S'il y en a qui le souhaitent, je peux en écrire plus sur FastTrack et FastPath, mais vous ne devriez pas vous attendre à des miracles de ces technologies.</em> </p></div></div><br><h4 id="para-slov-pro-dpi">  Quelques mots sur DPI </h4><br><p>  Il existe plusieurs possibilités pour examiner le package un peu plus profondément que l'en-tête de la couche transport: <br>  <em>content</em> - recherche une chaîne donnée dans un package. <br>  <em>layer7-protocol</em> - met en <em>mémoire</em> tampon les 10 premiers paquets (ou 2 Ko) de la connexion et recherche l'expression rationnelle dans les données tamponnées.  Un grand nombre de règles de layer7 affectent considérablement les performances. <br>  <em>tls-host</em> est l'adresse du nom d'hôte dans l'en-tête TLS / SNI d'une connexion HTTPS. </p><br><h3 id="primery">  Des exemples </h3><br><p>  Ne copiez pas les exemples sans réfléchir, il vaut mieux prendre l'appareil et essayer d'écrire la configuration vous-même (ou réécrire les exemples, mais pour comprendre ce que fait chacune des règles).  Si vous ne savez pas comment compléter les règles: dans les configurations d'accueil par défaut et minimum, il n'y a pas d'accès au routeur depuis l'interface WAN, ajoutez-le avec filtrage par la liste d'adresses. </p><br><h4 id="defoltnyy-firewall-routeros">  Pare-feu par défaut RouterOS </h4><br><p>  Une configuration assez sécurisée, mais par endroits très confuse: </p><br><pre><code class="plaintext hljs">/ip firewall filter #     (established, related)   (untracked)  add action=accept chain=input connection-state=established,related,untracked #    (invalid)  add action=drop chain=input connection-state=invalid #  icmp  add action=accept chain=input protocol=icmp #          add action=drop chain=input in-interface-list=!LAN #   ipsec    add action=accept chain=forward ipsec-policy=in,ipsec add action=accept chain=forward ipsec-policy=out,ipsec #          add action=fasttrack-connection chain=forward connection-state=established,related #       add action=accept chain=forward connection-state=established,related,untracked #    add action=drop chain=forward connection-state=invalid #     wan ,     dstnat (,      src-nat   dst-nat) add action=drop chain=forward connection-nat-state=!dstnat connection-state=new in-interface-list=WAN /ip firewall nat #Source NAT      ipsec,      WAN add action=masquerade chain=srcnat ipsec-policy=out,none out-interface-list=WAN</code> </pre> <br><p>  Je n'ai jamais utilisé la configuration par défaut, mais avant le pare-feu par défaut était bien pire. </p><br><h4 id="minimalnyy-domashniy-firewall">  Pare-feu domestique minimal </h4><br><p>  La chose la plus simple à trouver.  Oui, le trafic non suivi n'y est pas autorisé (mais au stade de l'étude de base du pare-feu, vous n'en avez toujours pas besoin) et il y aura des problèmes avec tunnel ipsec (encore une fois, si vous pouvez configurer ipsec, vous savez vous-même ce qui doit être fait). </p><br><pre> <code class="plaintext hljs">/ip firewall filter #     (established, related)  add chain=input connection-state=established,related action=accept #  icmp  add chain=input connection-state=new protocol=icmp action=accept #      add chain=input connection-state=new in-interface-list=LAN action=accept #     add chain=input action=drop #       add chain=forward connection-state=established,related action=accept #         add chain=forward connection-state=new in-interface-list=LAN action=accept #     add chain=forward action=drop /ip firewall nat #Source NAT        WAN add chain=srcnat out-interface-list=WAN action=masquerade</code> </pre> <br><h4 id="primer-s-dmz">  Exemple DMZ </h4><br><p>  Sur les routeurs "domestiques", l'acronyme DMZ aime appeler un ordinateur sur le sous-réseau local pour lequel tous les ports du réseau externe sont redirigés. </p><br><p>  En fait, ce n'est pas le cas et l'une des options DMZ consiste à séparer la ressource à laquelle vous devez fournir l'accès à partir d'Internet et une attaque réussie peut être effectuée (un serveur Web avec cms dans lequel des trous sont constamment trouvés est une bonne cible pour un attaquant).  En cas de piratage, un attaquant ne pourra pas affecter les participants du réseau local. </p><br><p><img src="https://habrastorage.org/webt/bb/pp/9g/bbpp9gbe7k4owuef7hxuzisrurg.png"></p><br><pre> <code class="plaintext hljs">#  /ip firewall nat add chain=dstnat dst-port=80,443 action=dst-nat to-address=192.168.200.2 /ip firewall filter #   icmp   add chain=input connection-state=established,related action=accept add chain=input protocol=icmp connection-state=new action=accept #      add chain=input in-interface=ether2-lan action=accept #    add chain=input action=drop #    add chain=forward connection-state=established,related action=accept #        add chain=forward in-interface=ether2-lan connection-state=new action=accept #    web  add chain=forward out-interface=ether3-dmz dst-address=192.168.200.2 dst-port=80,443 connection-state=new action=accept #   add chain=forward action=drop</code> </pre> <br><h4 id="hairpin-nat">  Épingle à cheveux NAT </h4><br><p><img src="https://habrastorage.org/webt/r5/ms/wv/r5mswv8kwtp0m3amzpl--bd5fn0.png"></p><br><pre> <code class="plaintext hljs">/ip firewall nat add chain=dstnat dst-port=80 action=dst-nat to-address=192.168.100.2</code> </pre> <br><p>  Une situation typique est lorsque vous transférez un port vers un serveur sur un réseau local et que tout fonctionne de l'extérieur, mais à l'intérieur du réseau local, le serveur n'est pas accessible à une adresse externe. </p><br><p>  Voyons ce qui se passe: </p><br><ol><li>  L'ordinateur 192.168.100.10 envoie une demande à 192.0.2.100 </li><li>  Il exécute DST-NAT sur le routeur et le paquet est transmis à 192.168.100.2 </li><li>  Le serveur voit qu'un paquet de 192.168.100.10 lui est arrivé à l'adresse 192.168.100.2 et répond à partir de l'adresse locale </li><li>  L'ordinateur reçoit un paquet inattendu de 192.168.100.2 et le supprime. </li></ol><br><p>  La solution consiste à ajouter une règle supplémentaire qui modifie l'adresse source en adresse du routeur, afin que le serveur renvoie le paquet au routeur, qui l'enverra à l'ordinateur initialiseur. </p><br><pre> <code class="plaintext hljs">/ip firewall nat #  add chain=dstnat dst-port=80 action=dst-nat to-address=192.168.100.2 # ,      add chain=srcnat src-address=192.168.100.0/24 dst-address=192.168.100.2 action=masquerade</code> </pre> <br><p>  En pratique, ce schéma n'est pas souvent utilisé, mais comme exemple de débogage d'un pare-feu, j'aime beaucoup. </p><br><h4 id="pravilnoe-ispolzovanie-netmap">  Utilisation appropriée de netmap </h4><br><p><img src="https://habrastorage.org/webt/l9/xa/ox/l9xaoxkyat1phpmy6tnnhau6nls.png"><br>  Netmap est une technologie permettant de traduire des adresses d'un sous-réseau en adresses d'un autre sous-réseau. <br>  L'adresse IP (dans l'entrée de masque) se compose de deux parties: le réseau (le nombre de bits spécifié dans le masque de sous-réseau) et l'hôte (bits restants).  Netmap modifie la partie réseau de l'adresse, mais ne touche pas la partie hôte. </p><br><p><img src="https://habrastorage.org/webt/jy/eh/xh/jyehxh3hok1l5-wfw6c8n4czdlu.png"></p><br><p>  Il y a deux routeurs connectés par un canal VPN.  Les routeurs desservent des sous-réseaux avec le même adressage.  Il est nécessaire de rendre l'accès entre les sous-réseaux. </p><br><p>  Vous ne pouvez pas vous passer d’adressage supplémentaire. </p><br><p>  Les utilisateurs du sous-réseau de gauche vont frapper vers la droite via le sous-réseau 192.168.102.0/24 <br>  Les utilisateurs du sous-réseau droit vont frapper vers la gauche via le sous-réseau 192.168.101.0/24 </p><br><p>  Configuration sur MikroTik 1. </p><br><pre> <code class="plaintext hljs">#     /ip route add distance=1 dst-address=192.168.102.0/24 gateway /ip firewall nat #       add action=netmap chain=srcnat dst-address=192.168.102.0/24 out-interface=ipip src-address=192.168.100.0/24 to-address=192.168.101.0/24 #       add action=netmap chain=dstnat dst-address=192.168.101.0/24 in-interface=ipip src-address=192.168.102.0/24 to-address=192.168.100.0/24</code> </pre> <br><p>  La configuration de MikroTik2 est presque la même: </p><br><pre> <code class="plaintext hljs">/ip route add distance=1 dst-address=192.168.101.0/24 gateway=10.10.10.1 /ip firewall nat add action=netmap chain=srcnat dst-address=192.168.101.0/24 out-interface=ipip src-address=192.168.100.0/24 to-address=192.168.102.0/24 add action=netmap chain=dstnat dst-address=192.168.102.0/24 in-interface=ipip src-address=192.168.101.0/24 to-address=192.168.100.0/24</code> </pre> <br><p>  Il existe des configurations plus complexes utilisant netmap, par exemple, si vous avez de nombreuses connexions à des points distants avec des sous-réseaux qui se croisent et qu'il n'y a aucun moyen de modifier les paramètres sur l'équipement distant, mais c'est déjà un routage avancé. </p><br><p>  Si vous ne comprenez rien (à propos de netmap), vous n'en avez pas besoin et n'utilisez simplement pas cette action lors du transfert de ports. </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr435070/">https://habr.com/ru/post/fr435070/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr435054/index.html">Université ITMO "en pratique": avec quelles entreprises technologiques coopérons-nous</a></li>
<li><a href="../fr435056/index.html">Samsung SSD 860 QVO 1 To et 4 To: le premier consommateur SATA QLC (en 3 parties)</a></li>
<li><a href="../fr435060/index.html">2018 a été l'année du scooter. Et ensuite?</a></li>
<li><a href="../fr435062/index.html">Guide: Thymeleaf + Spring. Partie 1</a></li>
<li><a href="../fr435064/index.html">Nous conduisons l'aspirateur Xiaomi</a></li>
<li><a href="../fr435072/index.html">Mémoire analogique 8 bits pour travailler avec des réseaux de neurones</a></li>
<li><a href="../fr435074/index.html">Vulnérabilités de Kyivstar: 1) analyse d'un article précédent sur les mots de passe + 2) informations sur les achats transitant par les services Kyivstar</a></li>
<li><a href="../fr435076/index.html">Comment les spécialistes du marketing travaillant avec Google monétisent notre inconfort</a></li>
<li><a href="../fr435078/index.html">Et si l'intelligence artificielle rend les acteurs immortels?</a></li>
<li><a href="../fr435080/index.html">Guide: Thymeleaf + Spring. 2e partie</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>