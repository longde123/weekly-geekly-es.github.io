<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🐘 🕯️ 🕣 Coroutines personnalisées dans Unity avec préférence et courtisanes 😼 🌰 👩🏿‍🤝‍👨🏽</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Vous êtes déjà tellement cool que vous faites pivoter les coroutines autour de tous les axes en même temps, d'un seul coup d'œil, elles effectuent yie...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Coroutines personnalisées dans Unity avec préférence et courtisanes</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/442820/"><p><img src="https://habrastorage.org/webt/ba/4v/xo/ba4vxoon1fdwi28pizrv99yg6cy.jpeg"></p><br><p> Vous êtes déjà tellement cool que vous faites pivoter les coroutines autour de tous les axes en même temps, d'un seul coup d'œil, elles effectuent <code>yield break</code> et se cachent derrière le canevas IDE.  Les <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">emballages</a> simples sont une étape révolue depuis longtemps. </p><br><p>  Vous savez si bien les cuisiner que vous pourriez obtenir une étoile <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Michelin</a> (voire deux) si vous aviez votre propre restaurant.  Bien sûr!  Personne ne sera indifférent en dégustant votre <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Bouillabaisse</a> à la sauce coroutine. </p><br><p>  Pendant toute une semaine, le code dans le prod ne tombe pas!  Wrappers, <code>callback</code> 'et les <code>Start/Stop Coroutine</code> sont le lot des esclaves.  Vous avez besoin de plus de contrôle et de liberté d'action.  Vous êtes prêt à monter la prochaine étape (mais pas à quitter les coroutines, bien sûr). </p><br><p>  Si vous vous reconnaissez dans ces lignes, bienvenue au chat. </p><br><p><a name="habracut"></a>  J'en profite pour dire bonjour à l'un de mes modèles préférés - <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Command</a> . </p><br><h2 id="vvedenie">  Présentation </h2><br><p>  Pour toutes les instructions de <code>yield</code> fournies par Unity ( <code>Coroutine</code> , <code>AsyncOperation</code> , <code>WaiForSeconds</code> et autres), la classe de base est la classe <code>YieldInstruction</code> ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">docs</a> ) sans <code>YieldInstruction</code> : </p><br><pre> <code class="cs hljs">[<span class="hljs-meta"><span class="hljs-meta">StructLayout (LayoutKind.Sequential)</span></span>] [UsedByNativeCode] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">YieldInstruction</span></span> { }</code> </pre> <br><p>  Sous le capot, les coroutines sont des énumérateurs ordinaires ( <code>IEnumerator</code> ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">docs</a> )).  Chaque image est appelée par la méthode <code>MoveNext()</code> .  Si la valeur de retour est <code>true</code> , l'exécution est retardée jusqu'à la prochaine instruction <code>yield</code> ; si elle est <code>false</code> , elle s'arrête. </p><br><p>  Pour les instructions de <code>yield</code> personnalisées, Unity fournit la <code>CustomYieldInstruction</code> ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">docs</a> ) du même nom. </p><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">abstract</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">CustomYieldInstruction</span></span> : <span class="hljs-title"><span class="hljs-title">IEnumerator</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">abstract</span></span> <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> keepWaiting { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> Current =&gt; <span class="hljs-literal"><span class="hljs-literal">null</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">MoveNext</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Reset</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span>; }</code> </pre><br><p>  Il suffit d'en hériter et d'implémenter la propriété keepWaiting.  Nous avons déjà discuté de sa logique ci-dessus.  Elle doit retourner <code>true</code> tant que la coroutine doit être exécutée. </p><br><p>  Exemple tiré de la documentation: </p><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">using</span></span> UnityEngine; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">WaitForMouseDown</span></span> : <span class="hljs-title"><span class="hljs-title">CustomYieldInstruction</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> keepWaiting { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> !Input.GetMouseButtonDown(<span class="hljs-number"><span class="hljs-number">1</span></span>); } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">WaitForMouseDown</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { Debug.Log(<span class="hljs-string"><span class="hljs-string">"Waiting for Mouse right button down"</span></span>); } }</code> </pre> <br><p>  Selon elle, le getter <code>keepWating</code> exécuté chaque image après <code>Update()</code> et avant <code>LateUpdate()</code> . </p><br><p>  <em>Si vous travaillez avec du code dans lequel certaines choses devraient fonctionner à un moment donné, et que vous n'avez toujours pas étudié <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">cette</a> page, je vous recommande fortement de décider de cet exploit.</em> </p><br><h2 id="kastomnye-yield-instrukcii">  Instructions de rendement personnalisées </h2><br><p><img src="https://habrastorage.org/webt/4p/wt/xf/4pwtxfv0kjogj_2zwcrm-sputhc.jpeg"></p><br><p>  Mais nous ne sommes pas venus ici avec des wrappers réguliers comme <code>CustomYieldInstruction</code> hériter.  Pour cela, vous pouvez rester sans Michelin. </p><br><p>  Par conséquent, nous fumons plus loin la documentation et presque au bas de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">la même</a> page, nous trouvons le paragraphe le plus important. </p><br><p>  <strong>Pour avoir plus de contrôle et implémenter des instructions de rendement plus complexes, vous pouvez hériter directement de la</strong> <strong>classe</strong> <code>System.Collections.IEnumerator</code> <strong>.</strong>  <strong>Dans ce cas, implémentez la</strong> <strong>méthode</strong> <code>MoveNext()</code> <strong>la même manière que vous implémenteriez la</strong> <strong>propriété</strong> <code>keepWaiting</code> <strong>.</strong>  <strong>En plus de cela, vous pouvez également retourner un objet dans la propriété <code>Current</code> , qui sera traité par le planificateur de coroutine d'Unity après avoir exécuté la</strong> <strong>méthode</strong> <strong>MoveNext</strong> <code>MoveNext()</code> <strong>.</strong>  <strong>Ainsi, par exemple, si</strong> <code>Current</code> <strong>retourne un autre objet héritant d'</strong> <code>IEnumerator</code> <strong>, l'énumérateur actuel est suspendu jusqu'à ce que celui renvoyé soit terminé.</strong> </p><br><div class="spoiler">  <b class="spoiler_title">En russe</b> <div class="spoiler_text"><p>  <strong>Pour obtenir plus de contrôle et implémenter des</strong> <strong>instructions de</strong> <code>yield</code> <strong>plus complexes</strong> <strong>, vous pouvez hériter directement de l'interface</strong> <code>System.Collections.IEnumerator</code> <strong>.</strong>  <strong>Dans ce cas, implémentez la méthode</strong> <code>MoveNext()</code> <strong>de la même manière que la propriété</strong> <code>keepWaiting</code> <strong>.</strong>  <strong>De plus, vous pouvez utiliser l'objet dans la propriété</strong> <code>Current</code> <strong>, qui sera traité par le planificateur de coroutine Unity après l'exécution de la méthode</strong> <code>MoveNext()</code> <strong>.</strong>  <strong>Par exemple, si la propriété</strong> <code>Current</code> <strong>renvoie un autre objet qui implémente l'interface</strong> <code>IEnumerator</code> <strong>, l'exécution de l'énumérateur actuel sera retardée jusqu'à la fin du nouveau.</strong> </p></div></div><br><p>  Saintes palourdes!  Ce sont les contrôles et la liberté d'action que je voulais tant.  Eh bien c'est ça, maintenant vous allez envelopper de corutines de telle sorte qu'aucun <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Gimbal Lock ne</a> fait peur.  L'essentiel, du bonheur, pousse le vertukha à ne pas cogner. </p><br><h3 id="interfeys">  Interface </h3><br><p>  Eh bien, ce serait bien de commencer par décider quelle interface d'interaction avec notre instruction nous voulons avoir.  Un ensemble minimal. </p><br><p>  Je suggère l'option suivante </p><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">interface</span></span> <span class="hljs-title"><span class="hljs-title">IInstruction</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> IsExecuting { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> IsPaused { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; } <span class="hljs-function"><span class="hljs-function">Instruction </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Execute</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Pause</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Resume</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Terminate</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">event</span></span> Action&lt;Instruction&gt; Started; <span class="hljs-keyword"><span class="hljs-keyword">event</span></span> Action&lt;Instruction&gt; Paused; <span class="hljs-keyword"><span class="hljs-keyword">event</span></span> Action&lt;Instruction&gt; Cancelled; <span class="hljs-keyword"><span class="hljs-keyword">event</span></span> Action&lt;Instruction&gt; Done; }</code> </pre> <br><p>  Je veux attirer votre attention sur le fait que <code>IsExecuting</code> et <code>IsPaused</code> ne <code>IsPaused</code> pas le contraire ici.  Si l'exécution de coroutine est suspendue, elle est toujours en cours d'exécution. </p><br><h3 id="pasyans-i-kurtizanki">  Solitaire et courtisane </h3><br><p>  Comme l'indique la documentation, vous devez implémenter l'interface <code>IEnumerator</code> .  Dans certains endroits, pour l'instant, laissons les talons, car son implémentation dépend directement de la fonctionnalité que nous voulons y mettre. </p><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">using</span></span> UnityEngine; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> IEnumerator = System.Collections.IEnumerator; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">abstract</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Instruction</span></span> : <span class="hljs-title"><span class="hljs-title">IEnumerator</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Instruction current; <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> IEnumerator.Current =&gt; current; <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> IEnumerator.Reset() { } <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> IEnumerator.MoveNext() { } }</code> </pre> <br><p>  Il convient de considérer qu'il existe au moins deux façons de lancer notre instruction: </p><br><ol><li><p>  Méthode <code>StartCoroutine(IEnumerator routine)</code> : </p><br><pre> <code class="plaintext hljs">StartCoroutine(new ConcreteInstruction());</code> </pre> <br></li><li><p>  Déclaration de rendement: </p><br><pre> <code class="plaintext hljs">private IEnumerator SomeRoutine() { yield return new ConcreteInstruction(); }</code> </pre> <br></li></ol><br><p>  La méthode <code>Execute</code> , que nous avons décrite ci-dessus dans l'interface <code>IInstruction</code> , utilisera la première méthode.  Par conséquent, nous ajoutons quelques champs qui aideront à gérer l'instruction dans ce cas. </p><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> routine; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> MonoBehaviour Parent { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; }</code> </pre> <br><p>  Maintenant propriétés et événements pour <code>IInstruction</code> . </p><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">using</span></span> UnityEngine; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> IEnumerator = System.Collections.IEnumerator; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">abstract</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Instruction</span></span> : <span class="hljs-title"><span class="hljs-title">IEnumerator</span></span>, <span class="hljs-title"><span class="hljs-title">IInstruction</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Instruction current; <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> IEnumerator.Current =&gt; current; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> routine; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> MonoBehaviour Parent { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> IsExecuting { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> IsPaused { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> IsStopped { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">event</span></span> Action&lt;Instruction&gt; Started; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">event</span></span> Action&lt;Instruction&gt; Paused; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">event</span></span> Action&lt;Instruction&gt; Terminated; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">event</span></span> Action&lt;Instruciton&gt; Done; <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> IEnumerator.Reset() { } <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> IEnumerator.MoveNext() { } Instruction(MonoBehaviour parent) =&gt; Parent = parent; }</code> </pre> <br><p>  En outre, les méthodes de gestion des événements dans les classes enfants: </p><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">virtual</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OnStarted</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">virtual</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OnPaused</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">virtual</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OnResumed</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">virtual</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OnTerminated</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">virtual</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OnDone</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { }</code> </pre> <br><p>  Ils seront appelés manuellement immédiatement avant les événements correspondants pour donner aux classes enfants la priorité de leur traitement. </p><br><p>  Maintenant, les méthodes restantes. </p><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Pause</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (IsExecuting &amp;&amp; !IsPaused) { IsPaused = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; OnPaused(); Paused?.Invoke(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>); } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Resume</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (IsExecuting) { IsPaused = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; OnResumed(); } }</code> </pre> <br><p>  Ici, tout est simple.  L'instruction ne peut être suspendue que si elle est en cours d'exécution et si elle n'a pas été suspendue, et poursuivre son exécution uniquement si elle est suspendue. </p><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Terminate</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Stop()) { OnTerminated(); Terminate?.Invoke(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>); } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Stop</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (IsExecuting) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (routine <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> Coroutine) Parent.StopCoroutine(routine <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> Coroutine); (<span class="hljs-keyword"><span class="hljs-keyword">this</span></span> <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> IEnumerator).Reset(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> IsStopped = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; }</code> </pre> <br><p>  La logique de base pour arrêter les instructions a été déplacée vers la méthode <code>Stop</code> .  Cela est nécessaire pour pouvoir effectuer un arrêt silencieux (sans déclencher d'événements). <br>  Vérifier <code>if (routine is Coroutine)</code> nécessaire car, comme je l'ai écrit ci-dessus, l'instruction peut être lancée par l' <code>yield</code> (c'est-à-dire sans appeler <code>StartCoroutine</code> ), ce qui signifie qu'il peut n'y avoir aucun lien vers une instance spécifique de <code>Coroutine</code> .  Dans ce cas, la <code>routine</code> n'aura qu'un objet stub. </p><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Instruction </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Execute</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">MonoBehaviour parent</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (current != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { Debug.LogWarning(<span class="hljs-string"><span class="hljs-string">$"Instruction </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{ GetType().Name}</span></span></span><span class="hljs-string"> is currently waiting for another one and can't be stared right now."</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!IsExecuting) { IsExecuting = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; routine = (Parent = parent).StartCoroutine(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>; } Debug.LogWarning(<span class="hljs-string"><span class="hljs-string">$"Instruction </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{ GetType().Name}</span></span></span><span class="hljs-string"> is already executing."</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>; }</code> </pre> <br><p>  La méthode de lancement principale est également extrêmement simple - le lancement ne sera effectué que si l'instruction n'a pas encore été lancée. </p><br><p>  Il reste à terminer l'implémentation de <code>IEnumerator</code> , car nous avons laissé des espaces vides dans certaines méthodes. </p><br><pre> <code class="cs hljs">IEnumerator.Reset() { IsExecuting = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; IsPaused = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; IsStopped = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; routine = <span class="hljs-literal"><span class="hljs-literal">null</span></span>; }</code> </pre> <br><p>  Et le plus intéressant, mais pas plus compliqué, est <code>MoveNext</code> : </p><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> IEnumerator.MoveNext() { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (IsStopped) { (<span class="hljs-keyword"><span class="hljs-keyword">this</span></span> <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> IEnumerator).Reset(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!IsExecuting) { IsExecuting = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; routine = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">object</span></span>(); OnStarted(); Started?.Invoke(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (current != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (IsPaused) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!Update()) { OnDone(); Done?.Invoke(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>); IsStopped = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>; }</code> </pre> <br><p>  <code>if (!IsExecuting)</code> - si l'instruction n'a pas été lancée via <code>StartCoroutine</code> et que cette ligne de code est exécutée, alors l' <code>yield</code> lancée.  Nous écrivons un talon dans les événements de <code>routine</code> et d'incendie. </p><br><p>  <code>if (current != null)</code> - <code>current</code> utilisé pour les instructions enfants.  Si tout à coup cela est apparu, nous attendons sa fin.  Veuillez noter que je vais manquer le processus d'ajout de la prise en charge des instructions enfant dans cet article afin de ne pas le gonfler encore plus.  Par conséquent, si vous n'êtes pas intéressé à ajouter davantage cette fonctionnalité, vous pouvez simplement supprimer ces lignes. </p><br><p>  <code>if (!Update())</code> - la méthode <code>Update</code> de nos instructions fonctionnera comme <code>keepWaiting</code> dans <code>CustomYieldInstruction</code> et devrait être implémentée dans une classe enfant.  <code>Instruction</code> n'est qu'une méthode abstraite. </p><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">abstract</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Update</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span>;</code> </pre> <br><div class="spoiler">  <b class="spoiler_title">Code d'instruction complet</b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">using</span></span> UnityEngine; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> IEnumerator = System.Collections.IEnumerator; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">abstract</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Instruction</span></span> : <span class="hljs-title"><span class="hljs-title">IEnumerator</span></span>, <span class="hljs-title"><span class="hljs-title">IInstruction</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Instruction current; <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> IEnumerator.Current =&gt; current; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> routine; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> MonoBehaviour Parent { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> IsExecuting { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> IsPaused { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> IsStopped { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">event</span></span> Action&lt;Instruction&gt; Started; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">event</span></span> Action&lt;Instruction&gt; Paused; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">event</span></span> Action&lt;Instruction&gt; Terminated; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">event</span></span> Action&lt;Instruction&gt; Done; <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> IEnumerator.Reset() { IsPaused = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; IsStopped = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; routine = <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> IEnumerator.MoveNext() { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (IsStopped) { (<span class="hljs-keyword"><span class="hljs-keyword">this</span></span> <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> IEnumerator).Reset(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!IsExecuting) { IsExecuting = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; routine = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">object</span></span>(); OnStarted(); Started?.Invoke(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (current != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (IsPaused) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!Update()) { OnDone(); Done?.Invoke(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>); IsStopped = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Instruction</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">MonoBehaviour parent</span></span></span><span class="hljs-function">)</span></span> =&gt; Parent = parent; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Pause</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (IsExecuting &amp;&amp; !IsPaused) { IsPaused = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; OnPaused(); Paused?.Invoke(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>); } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Resume</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { IsPaused = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; OnResumed(); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Terminate</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Stop()) { OnTerminated(); Terminated?.Invoke(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>); } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Stop</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (IsExecuting) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (routine <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> Coroutine) Parent.StopCoroutine(routine <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> Coroutine); (<span class="hljs-keyword"><span class="hljs-keyword">this</span></span> <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> IEnumerator).Reset(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> IsStopped = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Instruction </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Execute</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (current != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { Debug.LogWarning(<span class="hljs-string"><span class="hljs-string">$"Instruction </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{ GetType().Name}</span></span></span><span class="hljs-string"> is currently waiting for another one and can't be stared right now."</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!IsExecuting) { IsExecuting = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; routine = Parent.StartCoroutine(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>; } Debug.LogWarning(<span class="hljs-string"><span class="hljs-string">$"Instruction </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{ GetType().Name}</span></span></span><span class="hljs-string"> is already executing."</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Instruction </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Execute</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">MonoBehaviour parent</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (current != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { Debug.LogWarning(<span class="hljs-string"><span class="hljs-string">$"Instruction </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{ GetType().Name}</span></span></span><span class="hljs-string"> is currently waiting for another one and can't be stared right now."</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!IsExecuting) { IsExecuting = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; routine = (Parent = parent).StartCoroutine(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>; } Debug.LogWarning(<span class="hljs-string"><span class="hljs-string">$"Instruction </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{ GetType().Name}</span></span></span><span class="hljs-string"> is already executing."</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Reset</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { Terminate(); Started = <span class="hljs-literal"><span class="hljs-literal">null</span></span>; Paused = <span class="hljs-literal"><span class="hljs-literal">null</span></span>; Terminated = <span class="hljs-literal"><span class="hljs-literal">null</span></span>; Done = <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">virtual</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OnStarted</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">virtual</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OnPaused</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">virtual</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OnResumed</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">virtual</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OnTerminated</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">virtual</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OnDone</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">abstract</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Update</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span>; }</code> </pre> </div></div><br><h2 id="primery">  Des exemples </h2><br><p>  La classe de base est prête.  Pour créer des instructions, il suffit d'en hériter et d'implémenter les membres nécessaires.  Je suggère un regard sur quelques exemples. </p><br><h3 id="peredvizhenie-k-tochke">  Déplacer vers le point </h3><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">sealed</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">MoveToPoint</span></span> : <span class="hljs-title"><span class="hljs-title">Instruction</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Transform Transform { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Vector3 Target { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> Speed { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> Threshold { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">MoveToPoint</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">MonoBehaviour parent</span></span></span><span class="hljs-function">) : </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">base</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">parent</span></span></span><span class="hljs-function">)</span></span> { } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Update</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { Transform.position = Vector3.Lerp(Transform.position, Target, Time.deltaTime * Speed); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Vector3.Distance(Transform.position, Target) &gt;= Threshold; } }</code> </pre> <br><div class="spoiler">  <b class="spoiler_title">Options de lancement</b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Method</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> move = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> MoveToPoint(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>) { Actor = transform, Target = target, Speed = <span class="hljs-number"><span class="hljs-number">1.0F</span></span>, Threshold = <span class="hljs-number"><span class="hljs-number">0.05F</span></span> }; move.Execute(); }</code> </pre> <br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Method</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> move = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> MoveToPoint(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>); move.Execute(transform, target, <span class="hljs-number"><span class="hljs-number">1.0F</span></span>, <span class="hljs-number"><span class="hljs-number">0.05F</span></span>); }</code> </pre> <br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> IEnumerator </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Method</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">yield</span></span></span><span class="hljs-function"> return new </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">MoveToPoint</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">this</span></span></span></span></span><span class="hljs-function">)</span></span> { Actor = transform, Target = target, Speed = <span class="hljs-number"><span class="hljs-number">1.0F</span></span>, Threshold = <span class="hljs-number"><span class="hljs-number">0.05F</span></span> }; }</code> </pre> <br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> IEnumerator </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Method</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> move = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> MoveToPoint(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>) { Actor = transform, Target = target, Speed = <span class="hljs-number"><span class="hljs-number">1.0F</span></span>, Threshold = <span class="hljs-number"><span class="hljs-number">0.05F</span></span> }; <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> move; }</code> </pre> <br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> IEnumerator </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Method</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> move = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> MoveToPoint(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> move.Execute(transform, target, <span class="hljs-number"><span class="hljs-number">1.0F</span></span>, <span class="hljs-number"><span class="hljs-number">0.05F</span></span>); }</code> </pre> </div></div><br><h3 id="obrabotka-vvoda">  Traitement d'entrée </h3><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">sealed</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">WaitForKeyDown</span></span> : <span class="hljs-title"><span class="hljs-title">Instruction</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> KeyCode Key { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Update</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> !Input.GetKeyDown(Key); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">WaitForKeyDown</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">MonoBehaviour parent</span></span></span><span class="hljs-function">) : </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">base</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">parent</span></span></span><span class="hljs-function">)</span></span> { } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Instruction </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Execute</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">KeyCode key</span></span></span><span class="hljs-function">)</span></span> { Key = key; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">base</span></span>.Execute(); } }</code> </pre> <br><div class="spoiler">  <b class="spoiler_title">Exemples de lancement</b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Method</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { car wait = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> WaitForKeyDown(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>); wait.Execute(KeyCode.Space).Done += (i) =&gt; DoSomething(); }</code> </pre> <br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> IEnumerator </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Method</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">yield</span></span></span><span class="hljs-function"> return new </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">WaitForKeyDown</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">this</span></span></span></span></span><span class="hljs-function">)</span></span> { Key = KeyCode.Space }; <span class="hljs-comment"><span class="hljs-comment">// do something; }</span></span></code> </pre> </div></div><br><h3 id="ozhidanie-i-pauza">  Attendez et faites une pause </h3><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">sealed</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Wait</span></span> : <span class="hljs-title"><span class="hljs-title">Instruction</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> Delay { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> startTime; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Update</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Time.time - startTime &lt; Delay; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Wait</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">MonoBehaviour parent</span></span></span><span class="hljs-function">) : </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">base</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">parent</span></span></span><span class="hljs-function">)</span></span> { } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Wait</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params"> delay, MonoBehaviour parent</span></span></span><span class="hljs-function">) : </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">base</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">parent</span></span></span><span class="hljs-function">)</span></span> { Delay = delay; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OnStarted</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { startTime = Time.time; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Instruction </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Execute</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params"> delay</span></span></span><span class="hljs-function">)</span></span> { Delay = delay; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">base</span></span>.Execute(); } }</code> </pre> <br><p>  Ici, semble-t-il, tout est aussi simple que possible.  Tout d'abord, nous avons enregistré l'heure de début, puis vérifions la différence entre l'heure actuelle et <code>StartTime</code> .  Mais il y a une nuance que vous ne pouvez pas remarquer immédiatement.  Si pendant l'exécution d'une instruction vous la mettez en pause (en utilisant la méthode <code>Pause</code> ) et attendez, alors après la reprise ( <code>Resume</code> ), elle sera exécutée instantanément.  Et tout cela parce que maintenant cette instruction ne tient pas compte du fait que je peux la suspendre. </p><br><p>  Essayons de réparer cette injustice: </p><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OnPaused</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { Delay -= Time.time - startTime; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OnResumed</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { startTime = Time.time; }</code> </pre> <br><p>  C'est fait.  Maintenant, après la fin de la pause, l'instruction continuera d'être exécutée autant de temps qu'il en restait avant de commencer. </p><br><div class="spoiler">  <b class="spoiler_title">Exemples de lancement</b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Method</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> wait = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Wait(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>); wait.Execute(<span class="hljs-number"><span class="hljs-number">5.0F</span></span>).Done += (i) =&gt; DoSomething; }</code> </pre> <br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> IEnumerator </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Method</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">yield</span></span></span><span class="hljs-function"> return new </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Wait</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">this</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">5.0F</span></span></span></span></span><span class="hljs-function">)</span></span>; <span class="hljs-comment"><span class="hljs-comment">// do something; }</span></span></code> </pre> </div></div><br><h2 id="itog">  Résumé </h2><br><p>  Coroutines in Unity vous permet de faire des choses incroyables et fonctionnelles.  Mais combien ils seront complexes et si vous en avez besoin, c'est le choix personnel de chacun. </p><br><p>  L'extension des fonctionnalités de la corutine n'est pas la tâche la plus difficile.  Tout ce que vous avez à faire est de décider quelle interface vous souhaitez interagir avec eux et quel sera l'algorithme de leur travail. </p><br><p>  Merci pour votre temps.  Laissez vos questions / commentaires / ajouts dans les commentaires.  Je serai ravi de communiquer. </p><br><hr><br><p>  PS Si, soudainement, vous avez été brûlé d'utiliser la corutine, lisez <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ce</a> commentaire et buvez quelque chose de cool. <br></p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr442820/">https://habr.com/ru/post/fr442820/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr442810/index.html">Mythes de la physique populaire, suite: gravité</a></li>
<li><a href="../fr442812/index.html">"Je ne vois aucune raison d'utiliser Python pour travailler avec Spark, à part la paresse"</a></li>
<li><a href="../fr442814/index.html">10 ans se sont écoulés, et personne n'a compris comment utiliser la blockchain. Et là encore?</a></li>
<li><a href="../fr442816/index.html">Créez votre propre contrôleur de jeu</a></li>
<li><a href="../fr442818/index.html">10 erreurs courantes en anglais écrit et comment y faire face</a></li>
<li><a href="../fr442822/index.html">Centre de données en mer et en orbite: ont-ils une signification pratique?</a></li>
<li><a href="../fr442824/index.html">Bienvenue dans la Silicon Valley</a></li>
<li><a href="../fr442826/index.html">L'ingénierie sociale comme dramaturgie, ou ce que le domaine du phishing et le fusil Tchekhov ont en commun</a></li>
<li><a href="../fr442828/index.html">Gestion informatique sans nœuds et avec accroc</a></li>
<li><a href="../fr442830/index.html">Le créateur d'Anubis arrêté</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>