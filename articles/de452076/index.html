<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë®üèª‚Äçüöí üë∫ üö¥üèº UC-Browser brechen üòÇ üì§ üöÆ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Einf√ºhrung 
 Ende M√§rz berichteten wir √ºber das versteckte Potenzial, nicht verifizierten Code im UC-Browser herunterzuladen und auszuf√ºhren. Heute we...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>UC-Browser brechen</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/drweb/blog/452076/"><img src="https://habrastorage.org/webt/ke/e0/rd/kee0rdupth-kalljz9gfxpjndnk.jpeg"><br><br><h3>  Einf√ºhrung </h3><br>  Ende M√§rz <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">berichteten</a> wir <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">√ºber</a> das versteckte Potenzial, nicht verifizierten Code im UC-Browser herunterzuladen und auszuf√ºhren.  Heute werden wir im Detail untersuchen, wie es passiert und wie Hacker es verwenden k√∂nnen. <br><br>  Vor einiger Zeit wurde UC Browser ziemlich aggressiv beworben und verbreitet.  Es wurde von Malware auf Ger√§ten installiert und √ºber Websites unter dem Deckmantel von Videodateien verbreitet (d. H. Benutzer dachten, sie w√ºrden Pornografie oder √§hnliches herunterladen, aber stattdessen APK-Dateien mit diesem Browser abrufen), und mit besorgniserregenden Bannern beworben, dass der Browser eines Benutzers veraltet sei oder anf√§llig.  Die offizielle UC Browser VK-Gruppe hatte ein <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Thema,</a> bei dem sich Benutzer √ºber falsche Werbung beschweren konnten, und viele Benutzer lieferten Beispiele.  Im Jahr 2016 gab es sogar einen <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Werbespot</a> in russischer Sprache (ja, einen Werbespot eines Browsers, der Werbespots blockiert). <br><br>  W√§hrend wir diesen Artikel schreiben, wurde UC Browser 500.000.000 Mal von Google Play installiert.  Dies ist beeindruckend, da nur Google Chrome das geschafft hat.  In den Bewertungen finden Sie viele Beschwerden von Nutzern √ºber Werbung und die Weiterleitung zu anderen Anwendungen bei Google Play.  Dies war der Grund f√ºr unsere Studie: Wir wollten sehen, ob UC Browser etwas falsch macht.  Und das ist es!  Die Anwendung kann ausf√ºhrbaren Code herunterladen und ausf√ºhren, was <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">gegen die Richtlinien von Google Play f√ºr die Ver√∂ffentlichung von</a> Apps <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">verst√∂√üt</a> .  Und UC Browser l√§dt nicht nur ausf√ºhrbaren Code herunter.  Dies geschieht unsicher, was f√ºr einen MitM-Angriff verwendet werden kann.  Mal sehen, ob wir es so nutzen k√∂nnen. <br><a name="habracut"></a><br>  Alles, was folgt, gilt f√ºr die Version von UC Browser, die zum Zeitpunkt unserer Studie √ºber Google Play verbreitet wurde: <br><br><pre><code class="plaintext hljs">package: com.UCMobile.intl versionName: 12.10.8.1172 versionCode: 10598 sha1 APK-file: f5edb2243413c777172f6362876041eb0c3a928c</code> </pre> <br><h3>  Angriffsvektor </h3><br>  Das Manifest des UC-Browsers enth√§lt einen Dienst mit dem verr√§terischen Namen <i>com.uc.deployment.UpgradeDeployService</i> . <br><br><pre> <code class="plaintext hljs"> &lt;service android:exported="false" android:name="com.uc.deployment.UpgradeDeployService" android:process=":deploy" /&gt;</code> </pre><br>  Wenn dieser Dienst <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">gestartet wird</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">sendet</a> der Browser eine POST-Anforderung an <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">puds.ucweb.com/upgrade/index.xhtml</a> , die einige Zeit nach dem Start im Datenverkehr angezeigt wird.  Als Antwort erh√§lt der Browser m√∂glicherweise einen Befehl zum Herunterladen eines Updates oder eines neuen Moduls.  W√§hrend unserer Analyse haben wir solche Befehle nie vom Server erhalten, aber wir haben festgestellt, dass beim Versuch, eine PDF-Datei im Browser zu √∂ffnen, die Anforderung an die oben angegebene Adresse wiederholt und dann eine native Bibliothek heruntergeladen wird.  Um einen Angriff zu simulieren, haben wir uns f√ºr diese Funktion des UC-Browsers entschieden - die M√∂glichkeit, PDF-Dateien mithilfe einer nativen Bibliothek zu √∂ffnen -, die nicht in der APK-Datei vorhanden ist, aber aus dem Internet heruntergeladen werden kann.  Technisch gesehen kann UC Browser etwas ohne die Erlaubnis eines Benutzers herunterladen, wenn eine entsprechende Antwort auf eine beim Start gesendete Anfrage gegeben wird.  Daf√ºr m√ºssen wir jedoch das Interaktionsprotokoll mit dem Server genauer untersuchen. Daher dachten wir, es sei einfacher, die Antwort einfach zu verkn√ºpfen und zu bearbeiten und dann die zum √ñffnen von PDF-Dateien erforderliche Bibliothek durch etwas anderes zu ersetzen. <br><br>  Wenn ein Benutzer eine PDF-Datei direkt im Browser √∂ffnen m√∂chte, kann der Datenverkehr die folgenden Anforderungen enthalten: <br><br><img src="https://habrastorage.org/webt/j0/i1/c1/j0i1c1n_nwf_gnauzbudnqor5oi.png"><br><br>  Zuerst erfolgt eine POST-Anfrage an <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">puds.ucweb.com/upgrade/index.xhtml</a> , dann wird die komprimierte Bibliothek zum Anzeigen von PDF-Dateien und Office-Dokumenten heruntergeladen.  Logischerweise k√∂nnen wir davon ausgehen, dass die erste Anforderung Informationen √ºber das System sendet (zumindest die Architektur, da der Server eine geeignete Bibliothek ausw√§hlen muss), und der Server antwortet mit einigen Informationen √ºber die Bibliothek, die heruntergeladen werden muss, wie z. B. ihrer Adresse und vielleicht noch etwas anderes.  Das Problem ist, dass diese Anfrage verschl√ºsselt ist. <br><br><div class="scrollable-table"><table><tbody><tr><td>  Fragment anfordern <br><br></td><td>  Antwortfragment <br><br></td></tr><tr><td><img src="https://habrastorage.org/webt/go/tj/tz/gotjtzkpg2owfmk8jrnznox_vdg.jpeg"><br><br></td><td><img src="https://habrastorage.org/webt/g5/7k/iv/g57kivkwrysmcqvptmhclqzzipq.png"><br><br></td></tr></tbody></table></div><br>  Die Bibliothek wird in einer ZIP-Datei komprimiert und nicht verschl√ºsselt. <br><br><img src="https://habrastorage.org/webt/6r/lt/ns/6rltnsrtyd-_5ekwis68qn-vydc.png"><br><br><h3>  Suche nach Verkehrsentschl√ºsselungscode </h3><br>  Versuchen wir, die Antwort des Servers zu entschl√ºsseln.  Sehen Sie sich den Code der <i>Klasse com.uc.deployment.UpgradeDeployService an</i> : Von der <i>onStartCommand-Methode</i> navigieren wir zu <i>com.uc.deployment.bx</i> und dann zu <i>com.uc.browser.core.dcfe</i> : <br><br><pre> <code class="java hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">final</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">e</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(l arg9)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> v4_5; String v3_1; <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[] v3; <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[] v1 = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(arg9 == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { v3 = v1; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { v3_1 = arg9.iGX.ipR; StringBuilder v4 = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> StringBuilder(<span class="hljs-string"><span class="hljs-string">"["</span></span>); v4.append(v3_1); v4.append(<span class="hljs-string"><span class="hljs-string">"]product:"</span></span>); v4.append(arg9.iGX.ipR); v4 = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> StringBuilder(<span class="hljs-string"><span class="hljs-string">"["</span></span>); v4.append(v3_1); v4.append(<span class="hljs-string"><span class="hljs-string">"]version:"</span></span>); v4.append(arg9.iGX.iEn); v4 = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> StringBuilder(<span class="hljs-string"><span class="hljs-string">"["</span></span>); v4.append(v3_1); v4.append(<span class="hljs-string"><span class="hljs-string">"]upgrade_type:"</span></span>); v4.append(arg9.iGX.mMode); v4 = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> StringBuilder(<span class="hljs-string"><span class="hljs-string">"["</span></span>); v4.append(v3_1); v4.append(<span class="hljs-string"><span class="hljs-string">"]force_flag:"</span></span>); v4.append(arg9.iGX.iEo); v4 = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> StringBuilder(<span class="hljs-string"><span class="hljs-string">"["</span></span>); v4.append(v3_1); v4.append(<span class="hljs-string"><span class="hljs-string">"]silent_mode:"</span></span>); v4.append(arg9.iGX.iDQ); v4 = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> StringBuilder(<span class="hljs-string"><span class="hljs-string">"["</span></span>); v4.append(v3_1); v4.append(<span class="hljs-string"><span class="hljs-string">"]silent_type:"</span></span>); v4.append(arg9.iGX.iEr); v4 = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> StringBuilder(<span class="hljs-string"><span class="hljs-string">"["</span></span>); v4.append(v3_1); v4.append(<span class="hljs-string"><span class="hljs-string">"]silent_state:"</span></span>); v4.append(arg9.iGX.iEp); v4 = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> StringBuilder(<span class="hljs-string"><span class="hljs-string">"["</span></span>); v4.append(v3_1); v4.append(<span class="hljs-string"><span class="hljs-string">"]silent_file:"</span></span>); v4.append(arg9.iGX.iEq); v4 = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> StringBuilder(<span class="hljs-string"><span class="hljs-string">"["</span></span>); v4.append(v3_1); v4.append(<span class="hljs-string"><span class="hljs-string">"]apk_md5:"</span></span>); v4.append(arg9.iGX.iEl); v4 = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> StringBuilder(<span class="hljs-string"><span class="hljs-string">"["</span></span>); v4.append(v3_1); v4.append(<span class="hljs-string"><span class="hljs-string">"]download_type:"</span></span>); v4.append(arg9.mDownloadType); v4 = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> StringBuilder(<span class="hljs-string"><span class="hljs-string">"["</span></span>); v4.append(v3_1); v4.append(<span class="hljs-string"><span class="hljs-string">"]download_group:"</span></span>); v4.append(arg9.mDownloadGroup); v4 = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> StringBuilder(<span class="hljs-string"><span class="hljs-string">"["</span></span>); v4.append(v3_1); v4.append(<span class="hljs-string"><span class="hljs-string">"]download_path:"</span></span>); v4.append(arg9.iGH); v4 = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> StringBuilder(<span class="hljs-string"><span class="hljs-string">"["</span></span>); v4.append(v3_1); v4.append(<span class="hljs-string"><span class="hljs-string">"]apollo_child_version:"</span></span>); v4.append(arg9.iGX.iEx); v4 = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> StringBuilder(<span class="hljs-string"><span class="hljs-string">"["</span></span>); v4.append(v3_1); v4.append(<span class="hljs-string"><span class="hljs-string">"]apollo_series:"</span></span>); v4.append(arg9.iGX.iEw); v4 = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> StringBuilder(<span class="hljs-string"><span class="hljs-string">"["</span></span>); v4.append(v3_1); v4.append(<span class="hljs-string"><span class="hljs-string">"]apollo_cpu_arch:"</span></span>); v4.append(arg9.iGX.iEt); v4 = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> StringBuilder(<span class="hljs-string"><span class="hljs-string">"["</span></span>); v4.append(v3_1); v4.append(<span class="hljs-string"><span class="hljs-string">"]apollo_cpu_vfp3:"</span></span>); v4.append(arg9.iGX.iEv); v4 = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> StringBuilder(<span class="hljs-string"><span class="hljs-string">"["</span></span>); v4.append(v3_1); v4.append(<span class="hljs-string"><span class="hljs-string">"]apollo_cpu_vfp:"</span></span>); v4.append(arg9.iGX.iEu); ArrayList v3_2 = arg9.iGX.iEz; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(v3_2 != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span> &amp;&amp; v3_2.size() != <span class="hljs-number"><span class="hljs-number">0</span></span>) { Iterator v3_3 = v3_2.iterator(); <span class="hljs-keyword"><span class="hljs-keyword">while</span></span>(v3_3.hasNext()) { Object v4_1 = v3_3.next(); StringBuilder v5 = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> StringBuilder(<span class="hljs-string"><span class="hljs-string">"["</span></span>); v5.append(((au)v4_1).getName()); v5.append(<span class="hljs-string"><span class="hljs-string">"]component_name:"</span></span>); v5.append(((au)v4_1).getName()); v5 = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> StringBuilder(<span class="hljs-string"><span class="hljs-string">"["</span></span>); v5.append(((au)v4_1).getName()); v5.append(<span class="hljs-string"><span class="hljs-string">"]component_ver_name:"</span></span>); v5.append(((au)v4_1).aDA()); v5 = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> StringBuilder(<span class="hljs-string"><span class="hljs-string">"["</span></span>); v5.append(((au)v4_1).getName()); v5.append(<span class="hljs-string"><span class="hljs-string">"]component_ver_code:"</span></span>); v5.append(((au)v4_1).gBl); v5 = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> StringBuilder(<span class="hljs-string"><span class="hljs-string">"["</span></span>); v5.append(((au)v4_1).getName()); v5.append(<span class="hljs-string"><span class="hljs-string">"]component_req_type:"</span></span>); v5.append(((au)v4_1).gBq); } } j v3_4 = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> j(); mb(v3_4); h v4_2 = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> h(); mb(v4_2); ay v5_1 = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ay(); v3_4.hS(<span class="hljs-string"><span class="hljs-string">""</span></span>); v3_4.setImsi(<span class="hljs-string"><span class="hljs-string">""</span></span>); v3_4.hV(<span class="hljs-string"><span class="hljs-string">""</span></span>); v5_1.bPQ = v3_4; v5_1.bPP = v4_2; v5_1.yr(arg9.iGX.ipR); v5_1.gBF = arg9.iGX.mMode; v5_1.gBI = arg9.iGX.iEz; v3_2 = v5_1.gAr; c.aBh(); v3_2.add(g.fs(<span class="hljs-string"><span class="hljs-string">"os_ver"</span></span>, c.getRomInfo())); v3_2.add(g.fs(<span class="hljs-string"><span class="hljs-string">"processor_arch"</span></span>, com.uc.baacgetCpuArch())); v3_2.add(g.fs(<span class="hljs-string"><span class="hljs-string">"cpu_arch"</span></span>, com.uc.baacPb())); String v4_3 = com.uc.baacPd(); v3_2.add(g.fs(<span class="hljs-string"><span class="hljs-string">"cpu_vfp"</span></span>, v4_3)); v3_2.add(g.fs(<span class="hljs-string"><span class="hljs-string">"net_type"</span></span>, String.valueOf(com.uc.base.system.a.Jo()))); v3_2.add(g.fs(<span class="hljs-string"><span class="hljs-string">"fromhost"</span></span>, arg9.iGX.iEm)); v3_2.add(g.fs(<span class="hljs-string"><span class="hljs-string">"plugin_ver"</span></span>, arg9.iGX.iEn)); v3_2.add(g.fs(<span class="hljs-string"><span class="hljs-string">"target_lang"</span></span>, arg9.iGX.iEs)); v3_2.add(g.fs(<span class="hljs-string"><span class="hljs-string">"vitamio_cpu_arch"</span></span>, arg9.iGX.iEt)); v3_2.add(g.fs(<span class="hljs-string"><span class="hljs-string">"vitamio_vfp"</span></span>, arg9.iGX.iEu)); v3_2.add(g.fs(<span class="hljs-string"><span class="hljs-string">"vitamio_vfp3"</span></span>, arg9.iGX.iEv)); v3_2.add(g.fs(<span class="hljs-string"><span class="hljs-string">"plugin_child_ver"</span></span>, arg9.iGX.iEx)); v3_2.add(g.fs(<span class="hljs-string"><span class="hljs-string">"ver_series"</span></span>, arg9.iGX.iEw)); v3_2.add(g.fs(<span class="hljs-string"><span class="hljs-string">"child_ver"</span></span>, r.aVw())); v3_2.add(g.fs(<span class="hljs-string"><span class="hljs-string">"cur_ver_md5"</span></span>, arg9.iGX.iEl)); v3_2.add(g.fs(<span class="hljs-string"><span class="hljs-string">"cur_ver_signature"</span></span>, SystemHelper.getUCMSignature())); v3_2.add(g.fs(<span class="hljs-string"><span class="hljs-string">"upgrade_log"</span></span>, i.bjt())); v3_2.add(g.fs(<span class="hljs-string"><span class="hljs-string">"silent_install"</span></span>, String.valueOf(arg9.iGX.iDQ))); v3_2.add(g.fs(<span class="hljs-string"><span class="hljs-string">"silent_state"</span></span>, String.valueOf(arg9.iGX.iEp))); v3_2.add(g.fs(<span class="hljs-string"><span class="hljs-string">"silent_file"</span></span>, arg9.iGX.iEq)); v3_2.add(g.fs(<span class="hljs-string"><span class="hljs-string">"silent_type"</span></span>, String.valueOf(arg9.iGX.iEr))); v3_2.add(g.fs(<span class="hljs-string"><span class="hljs-string">"cpu_archit"</span></span>, com.uc.baacPc())); v3_2.add(g.fs(<span class="hljs-string"><span class="hljs-string">"cpu_set"</span></span>, SystemHelper.getCpuInstruction())); <span class="hljs-keyword"><span class="hljs-keyword">boolean</span></span> v4_4 = v4_3 == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span> || !v4_3.contains(<span class="hljs-string"><span class="hljs-string">"neon"</span></span>) ? <span class="hljs-keyword"><span class="hljs-keyword">false</span></span> : <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; v3_2.add(g.fs(<span class="hljs-string"><span class="hljs-string">"neon"</span></span>, String.valueOf(v4_4))); v3_2.add(g.fs(<span class="hljs-string"><span class="hljs-string">"cpu_cores"</span></span>, String.valueOf(com.uc.baacJl()))); v3_2.add(g.fs(<span class="hljs-string"><span class="hljs-string">"ram_1"</span></span>, String.valueOf(com.uc.baahPo()))); v3_2.add(g.fs(<span class="hljs-string"><span class="hljs-string">"totalram"</span></span>, String.valueOf(com.uc.baahOL()))); c.aBh(); v3_2.add(g.fs(<span class="hljs-string"><span class="hljs-string">"rom_1"</span></span>, c.getRomInfo())); v4_5 = e.getScreenWidth(); <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> v6 = e.getScreenHeight(); StringBuilder v7 = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> StringBuilder(); v7.append(v4_5); v7.append(<span class="hljs-string"><span class="hljs-string">"*"</span></span>); v7.append(v6); v3_2.add(g.fs(<span class="hljs-string"><span class="hljs-string">"ss"</span></span>, v7.toString())); v3_2.add(g.fs(<span class="hljs-string"><span class="hljs-string">"api_level"</span></span>, String.valueOf(Build$VERSION.SDK_INT))); v3_2.add(g.fs(<span class="hljs-string"><span class="hljs-string">"uc_apk_list"</span></span>, SystemHelper.getUCMobileApks())); Iterator v4_6 = arg9.iGX.iEA.entrySet().iterator(); <span class="hljs-keyword"><span class="hljs-keyword">while</span></span>(v4_6.hasNext()) { Object v6_1 = v4_6.next(); v3_2.add(g.fs(((Map$Entry)v6_1).getKey(), ((Map$Entry)v6_1).getValue())); } v3 = v5_1.toByteArray(); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(v3 == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.iGY.iGI.a(arg9, <span class="hljs-string"><span class="hljs-string">"up_encode"</span></span>, <span class="hljs-string"><span class="hljs-string">"yes"</span></span>, <span class="hljs-string"><span class="hljs-string">"fail"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; } v4_5 = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.iGY.iGw ? <span class="hljs-number"><span class="hljs-number">0x1F</span></span> : <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(v3 == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { v3 = gi(v4_5, v3); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(v3 == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { v1 = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[v3.length + <span class="hljs-number"><span class="hljs-number">16</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[] v6_2 = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[<span class="hljs-number"><span class="hljs-number">16</span></span>]; Arrays.fill(v6_2, <span class="hljs-number"><span class="hljs-number">0</span></span>); v6_2[<span class="hljs-number"><span class="hljs-number">0</span></span>] = <span class="hljs-number"><span class="hljs-number">0x5F</span></span>; v6_2[<span class="hljs-number"><span class="hljs-number">1</span></span>] = <span class="hljs-number"><span class="hljs-number">0</span></span>; v6_2[<span class="hljs-number"><span class="hljs-number">2</span></span>] = ((<span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>)v4_5); v6_2[<span class="hljs-number"><span class="hljs-number">3</span></span>] = -<span class="hljs-number"><span class="hljs-number">50</span></span>; System.arraycopy(v6_2, <span class="hljs-number"><span class="hljs-number">0</span></span>, v1, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">16</span></span>); System.arraycopy(v3, <span class="hljs-number"><span class="hljs-number">0</span></span>, v1, <span class="hljs-number"><span class="hljs-number">16</span></span>, v3.length); } } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(v1 == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.iGY.iGI.a(arg9, <span class="hljs-string"><span class="hljs-string">"up_encrypt"</span></span>, <span class="hljs-string"><span class="hljs-string">"yes"</span></span>, <span class="hljs-string"><span class="hljs-string">"fail"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(TextUtils.isEmpty(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.iGY.mUpgradeUrl)) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.iGY.iGI.a(arg9, <span class="hljs-string"><span class="hljs-string">"up_url"</span></span>, <span class="hljs-string"><span class="hljs-string">"yes"</span></span>, <span class="hljs-string"><span class="hljs-string">"fail"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; } StringBuilder v0 = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> StringBuilder(<span class="hljs-string"><span class="hljs-string">"["</span></span>); v0.append(arg9.iGX.ipR); v0.append(<span class="hljs-string"><span class="hljs-string">"]url:"</span></span>); v0.append(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.iGY.mUpgradeUrl); com.uc.browser.core.dci v0_1 = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.iGY.iGI; v3_1 = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.iGY.mUpgradeUrl; com.uc.base.net.e v0_2 = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> com.uc.base.net.e(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> com.uc.browser.core.dci$a(v0_1, arg9)); v3_1 = v3_1.contains(<span class="hljs-string"><span class="hljs-string">"?"</span></span>) ? v3_1 + <span class="hljs-string"><span class="hljs-string">"&amp;dataver=pb"</span></span> : v3_1 + <span class="hljs-string"><span class="hljs-string">"?dataver=pb"</span></span>; n v3_5 = v0_2.uc(v3_1); mb(v3_5, <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>); v3_5.setMethod(<span class="hljs-string"><span class="hljs-string">"POST"</span></span>); v3_5.setBodyProvider(v1); v0_2.b(v3_5); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.iGY.iGI.a(arg9, <span class="hljs-string"><span class="hljs-string">"up_null"</span></span>, <span class="hljs-string"><span class="hljs-string">"yes"</span></span>, <span class="hljs-string"><span class="hljs-string">"success"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.iGY.iGI.b(arg9); }</code> </pre> <br>  Wir k√∂nnen sehen, dass hier die POST-Anfrage gestellt wird.  Schauen Sie sich das 16-Byte-Array an, das Folgendes enth√§lt: 0x5F, 0, 0x1F, -50 (= 0xCE).  Die Werte sind die gleichen wie in der obigen Anfrage. <br><br>  Dieselbe Klasse enth√§lt eine verschachtelte Klasse mit einer anderen interessanten Methode: <br><br><pre> <code class="java hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">final</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">a</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(l arg10, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">byte</span></span></span></span><span class="hljs-function"><span class="hljs-params">[] arg11)</span></span></span><span class="hljs-function"> </span></span>{ f v0 = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.iGQ; StringBuilder v1 = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> StringBuilder(<span class="hljs-string"><span class="hljs-string">"["</span></span>); v1.append(arg10.iGX.ipR); v1.append(<span class="hljs-string"><span class="hljs-string">"]:UpgradeSuccess"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[] v1_1 = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(arg11 == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(arg11.length &lt; <span class="hljs-number"><span class="hljs-number">16</span></span>) { } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(arg11[<span class="hljs-number"><span class="hljs-number">0</span></span>] != <span class="hljs-number"><span class="hljs-number">0x60</span></span> &amp;&amp; arg11[<span class="hljs-number"><span class="hljs-number">3</span></span>] != <span class="hljs-number"><span class="hljs-number">0xFFFFFFD0</span></span>) { goto label_57; } <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> v3 = <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> v5 = arg11[<span class="hljs-number"><span class="hljs-number">1</span></span>] == <span class="hljs-number"><span class="hljs-number">1</span></span> ? <span class="hljs-number"><span class="hljs-number">1</span></span> : <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(arg11[<span class="hljs-number"><span class="hljs-number">2</span></span>] != <span class="hljs-number"><span class="hljs-number">1</span></span> &amp;&amp; arg11[<span class="hljs-number"><span class="hljs-number">2</span></span>] != <span class="hljs-number"><span class="hljs-number">11</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(arg11[<span class="hljs-number"><span class="hljs-number">2</span></span>] == <span class="hljs-number"><span class="hljs-number">0x1F</span></span>) { } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { v3 = <span class="hljs-number"><span class="hljs-number">0</span></span>; } } <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[] v7 = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[arg11.length - <span class="hljs-number"><span class="hljs-number">16</span></span>]; System.arraycopy(arg11, <span class="hljs-number"><span class="hljs-number">16</span></span>, v7, <span class="hljs-number"><span class="hljs-number">0</span></span>, v7.length); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(v3 != <span class="hljs-number"><span class="hljs-number">0</span></span>) { v7 = gj(arg11[<span class="hljs-number"><span class="hljs-number">2</span></span>], v7); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(v7 == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { goto label_57; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(v5 != <span class="hljs-number"><span class="hljs-number">0</span></span>) { v1_1 = gP(v7); goto label_57; } v1_1 = v7; } label_57: <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(v1_1 == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { v0.iGY.iGI.a(arg10, <span class="hljs-string"><span class="hljs-string">"up_decrypt"</span></span>, <span class="hljs-string"><span class="hljs-string">"yes"</span></span>, <span class="hljs-string"><span class="hljs-string">"fail"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; } q v11 = gb(arg10, v1_1); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(v11 == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { v0.iGY.iGI.a(arg10, <span class="hljs-string"><span class="hljs-string">"up_decode"</span></span>, <span class="hljs-string"><span class="hljs-string">"yes"</span></span>, <span class="hljs-string"><span class="hljs-string">"fail"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(v0.iGY.iGt) { v0.d(arg10); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(v0.iGY.iGo != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { v0.iGY.iGo.a(<span class="hljs-number"><span class="hljs-number">0</span></span>, ((o)v11)); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(v0.iGY.iGs) { v0.iGY.a(((o)v11)); v0.iGY.iGI.a(v11, <span class="hljs-string"><span class="hljs-string">"up_silent"</span></span>, <span class="hljs-string"><span class="hljs-string">"yes"</span></span>, <span class="hljs-string"><span class="hljs-string">"success"</span></span>); v0.iGY.iGI.a(v11); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; } v0.iGY.iGI.a(v11, <span class="hljs-string"><span class="hljs-string">"up_silent"</span></span>, <span class="hljs-string"><span class="hljs-string">"no"</span></span>, <span class="hljs-string"><span class="hljs-string">"success"</span></span>); } }</code> </pre> <br>  Diese Methode empf√§ngt eine Eingabe eines Bytearrays und pr√ºft, ob das Nullbyte 0x60 oder das dritte Byte 0xD0 ist und ob das zweite Byte 1, 11 oder 0x1F ist.  √úberpr√ºfen Sie die Serverantwort: Null-Byte ist 0x60, das zweite Byte ist 0x1F, das dritte Byte ist 0x60.  Es sieht so aus, wie wir es brauchen.  Gemessen an den Zeichenfolgen (z. B. "up_decrypt") soll hier eine Methode aufgerufen werden, um die Serverantwort zu entschl√ºsseln.  Schauen wir uns nun die gj-Methode an.  Beachten Sie, dass das erste Argument ein Byte bei Offset 2 ist (in unserem Fall 0x1F) und das zweite die Serverantwort ohne die ersten 16 Bytes. <br><br><pre> <code class="java hljs"> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[] j(<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> arg1, <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[] arg2) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(arg1 == <span class="hljs-number"><span class="hljs-number">1</span></span>) { arg2 = cc(arg2, c.adu); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(arg1 == <span class="hljs-number"><span class="hljs-number">11</span></span>) { arg2 = m.aF(arg2); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(arg1 != <span class="hljs-number"><span class="hljs-number">0x1F</span></span>) { } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { arg2 = EncryptHelper.decrypt(arg2); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> arg2; }</code> </pre> <br>  Offensichtlich wird der Entschl√ºsselungsalgorithmus ausgew√§hlt, und das Byte, das in unserem Fall gleich 0x1F ist, gibt eine von drei m√∂glichen Optionen an. <br><br>  Kehren wir zur Code-Analyse zur√ºck.  Nach ein paar Spr√ºngen gelangen wir zur Methode mit dem verr√§terischen Namen <i>decryptBytesByKey</i> .  Jetzt werden zwei weitere Bytes von unserer Antwort getrennt und bilden eine Zeichenfolge.  Es ist klar, dass auf diese Weise der Schl√ºssel zum Entschl√ºsseln der Nachricht ausgew√§hlt wird. <br><br><pre> <code class="java hljs"> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[] decryptBytesByKey(<span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[] bytes) { <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[] v0 = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(bytes != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(bytes.length &lt; EncryptHelper.PREFIX_BYTES_SIZE) { } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(bytes.length == EncryptHelper.PREFIX_BYTES_SIZE) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> v0; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[] prefix = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[EncryptHelper.PREFIX_BYTES_SIZE]; <span class="hljs-comment"><span class="hljs-comment">// 2  System.arraycopy(bytes, 0, prefix, 0, prefix.length); String keyId = c.ayR().d(ByteBuffer.wrap(prefix).getShort()); //   if(keyId == null) { return v0; } else { a v2 = EncryptHelper.ayL(); if(v2 == null) { return v0; } else { byte[] enrypted = new byte[bytes.length - EncryptHelper.PREFIX_BYTES_SIZE]; System.arraycopy(bytes, EncryptHelper.PREFIX_BYTES_SIZE, enrypted, 0, enrypted.length); return v2.l(keyId, enrypted); } } } } catch(SecException v7_1) { EncryptHelper.handleDecryptException(((Throwable)v7_1), v7_1.getErrorCode()); return v0; } catch(Throwable v7) { EncryptHelper.handleDecryptException(v7, 2); return v0; } } return v0; }</span></span></code> </pre> <br>  Beachten Sie, dass es sich in diesem Stadium nur um die Schl√ºsselkennung handelt, nicht um den Schl√ºssel selbst.  Die Schl√ºsselauswahl wird etwas komplizierter. <br><br>  Bei der n√§chsten Methode werden zwei weitere Parameter zu den vorhandenen hinzugef√ºgt, sodass insgesamt vier erhalten werden.  Die magische Zahl 16, die Schl√ºsselkennung, die verschl√ºsselten Daten und eine Zeichenfolge werden dort aus irgendeinem Grund hinzugef√ºgt (in unserem Fall leer). <br><br><pre> <code class="java hljs"> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[] l(String keyId, <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[] encrypted) <span class="hljs-keyword"><span class="hljs-keyword">throws</span></span> SecException { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.ayJ().staticBinarySafeDecryptNoB64(<span class="hljs-number"><span class="hljs-number">16</span></span>, keyId, encrypted, <span class="hljs-string"><span class="hljs-string">""</span></span>); }</code> </pre> <br>  Nach einer Reihe von Spr√ºngen sehen wir die <i>staticBinarySafeDecryptNoB64-</i> Methode der Schnittstelle <i>com.alibaba.wireless.security.open.staticdataencrypt.IStaticDataEncryptComponent</i> .  Der Hauptanwendungscode enth√§lt keine Klassen, die diese Schnittstelle implementieren.  Diese Klasse ist in der Datei <b><i>lib / armeabi-v7a / libsgmain.so enthalten</i></b> , die nicht wirklich .SO, sondern .JAR ist.  Die Methode, an der wir interessiert sind, wird wie folgt implementiert: <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">package</span></span> com.alibaba.wireless.security.ai; <span class="hljs-comment"><span class="hljs-comment">// ... public class a implements IStaticDataEncryptComponent { private ISecurityGuardPlugin a; // ... private byte[] a(int mode, int magicInt, int xzInt, String keyId, byte[] encrypted, String magicString) { return this.a.getRouter().doCommand(10601, new Object[]{Integer.valueOf(mode), Integer.valueOf(magicInt), Integer.valueOf(xzInt), keyId, encrypted, magicString}); } // ... private byte[] b(int magicInt, String keyId, byte[] encrypted, String magicString) { return this.a(2, magicInt, 0, keyId, encrypted, magicString); } // ... public byte[] staticBinarySafeDecryptNoB64(int magicInt, String keyId, byte[] encrypted, String magicString) throws SecException { if(keyId != null &amp;&amp; keyId.length() &gt; 0 &amp;&amp; magicInt &gt;= 0 &amp;&amp; magicInt &lt; 19 &amp;&amp; encrypted != null &amp;&amp; encrypted.length &gt; 0) { return this.b(magicInt, keyId, encrypted, magicString); } throw new SecException("", 301); } //... }</span></span></code> </pre> <br>  Hier wird unsere Parameterliste durch zwei weitere Ganzzahlen erg√§nzt: 2 und 0. Anscheinend bedeutet 2 Entschl√ºsselung, wie bei der <i>doFinal-Methode</i> der <i>Systemklasse javax.crypto.Cipher</i> .  Diese Informationen werden dann zusammen mit der Nummer 10601, die anscheinend die Befehlsnummer ist, an einen bestimmten Router √ºbertragen. <br><br>  Nach der n√§chsten <i>Sprungkette</i> finden wir eine Klasse, die die <i>RouterComponent-</i> Schnittstelle und die <i>doCommand-</i> Methode <i>implementiert</i> : <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">package</span></span> com.alibaba.wireless.security.mainplugin; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.alibaba.wireless.security.framework.IRouterComponent; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.taobao.wireless.security.adapter.JNICLibrary; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">a</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">IRouterComponent</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">a</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>(); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Object </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">doCommand</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> arg2, Object[] arg3)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> JNICLibrary.doCommandNative(arg2, arg3); } }</code> </pre> <br>  Es gibt auch die <i>JNIC Library-</i> Klasse, in der die native <i>doCommandNative-</i> Methode deklariert ist: <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">package</span></span> com.taobao.wireless.security.adapter; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">JNICLibrary</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">native</span></span></span><span class="hljs-function"> Object </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">doCommandNative</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> arg0, Object[] arg1)</span></span></span></span>; }</code> </pre> <br>  Wir m√ºssen also die <i>doCommandNative-</i> Methode im nativen Code finden.  Hier beginnt der Spa√ü. <br><br><h3>  Verschleierung des Maschinencodes </h3><br>  In der Datei <i>libsgmain.so</i> befindet sich eine native Bibliothek (die eigentlich eine .JAR-Datei ist und, wie oben erw√§hnt, einige verschl√ºsselungsbezogene Schnittstellen implementiert): <i><b>libsgmainso-6.4.36.so</b></i> .  Wir laden es in IDA und erhalten eine Reihe von Dialogen mit Fehlermeldungen.  Das Problem ist, dass die Abschnitts√ºberschriften-Tabelle ung√ºltig ist.  Dies geschieht absichtlich, um die Analyse zu erschweren. <br><br><img src="https://habrastorage.org/webt/_k/bz/5c/_kbz5cbedw6g1jnsj047rtqudli.jpeg"><br><br>  Aber wir brauchen es sowieso nicht wirklich.  Die Programm-Header-Tabelle reicht aus, um die ELF-Datei korrekt zu laden und zu analysieren.  Also l√∂schen wir einfach die Abschnitts√ºberschriften-Tabelle und setzen die entsprechenden Felder in der √úberschrift auf Null. <br><br><img src="https://habrastorage.org/webt/2y/xh/vk/2yxhvksp30f016gfyhrlfh0pklc.jpeg"><br><br>  Dann √∂ffnen wir die Datei in IDA erneut. <br><br>  Wir haben zwei M√∂glichkeiten, der virtuellen Java-Maschine genau mitzuteilen, wo die native Bibliothek die Implementierung der im Java-Code als native deklarierten Methode enth√§lt.  Der erste besteht darin, ihm einen Namen wie diesen zu geben: <i>Java_package_name_ClassName_methodName</i> .  Die zweite M√∂glichkeit besteht darin, sie beim Laden der Bibliothek (in der Funktion JNI_OnLoad) durch Aufrufen der Funktion RegisterNatives zu registrieren.  In unserem Fall sollte der Name bei Verwendung der ersten Methode folgenderma√üen <i>lauten</i> : <i>Java_com_taobao_wireless_security_adapter_JNICLibrary_doCommandNative</i> .  Die Liste der exportierten Funktionen enth√§lt diesen Namen nicht, was bedeutet, dass wir nach den RegisterNatives suchen m√ºssen.  Wir gehen also zur Funktion JNI_OnLoad und sehen Folgendes: <br><br><img src="https://habrastorage.org/webt/m6/dp/iw/m6dpiwaonfuyri-jg8thppcfgqe.jpeg"><br><br>  Was ist hier los?  Anfang und Ende der Funktion sind auf den ersten Blick typisch f√ºr die ARM-Architektur.  Der erste Befehl √ºbertr√§gt den Inhalt der Register, die die Funktion verwendet, an den Stapel (in diesem Fall R0, R1 und R2) sowie den Inhalt des LR-Registers mit der R√ºcksprungadresse der Funktion.  Der letzte Befehl stellt die gespeicherten Register wieder her und legt die R√ºcksprungadresse in das PC-Register, wodurch von der Funktion zur√ºckgekehrt wird.  Bei n√§herer Betrachtung stellen wir jedoch m√∂glicherweise fest, dass der vorletzte Befehl die auf dem Stapel gespeicherte R√ºcksprungadresse √§ndert.  Berechnen wir, wie es sein wird, wenn der Code ausgef√ºhrt wird.  Die Adresse 0xB130 wird in R1 geladen, von 5 subtrahiert, dann nach R0 verschoben und erh√§lt eine Addition von 0x10.  Am Ende ist es gleich 0xB13B.  Somit glaubt IDA, dass der endg√ºltige Befehl eine normale Funktionsr√ºckgabe ausf√ºhrt, w√§hrend er tats√§chlich eine √úbertragung an die berechnete Adresse 0xB13B durchf√ºhrt. <br><br>  Wir m√∂chten Sie nun daran erinnern, dass ARM-Prozessoren zwei Modi und zwei Befehlss√§tze haben - ARM und Thumb.  Das niederwertige Bit der Adresse bestimmt, welchen Befehlssatz der Prozessor verwendet. Das hei√üt, die Adresse ist tats√§chlich 0xB13A, w√§hrend der Wert im niederwertigen Bit den Daumenmodus anzeigt. <br>  Ein √§hnlicher ‚ÄûAdapter‚Äú und etwas semantischer M√ºll werden am Anfang jeder Funktion in dieser Bibliothek hinzugef√ºgt.  Aber wir werden nicht im Detail darauf eingehen.  Denken Sie daran, dass der eigentliche Beginn fast aller Funktionen etwas weiter entfernt ist. <br><br>  Da im Code kein expliziter √úbergang zu 0xB13A vorhanden ist, kann IDA nicht erkennen, dass dort Code vorhanden ist.  Aus dem gleichen Grund wird der gr√∂√üte Teil des Codes in der Bibliothek nicht als Code erkannt, was die Analyse etwas schwieriger macht.  Also sagen wir IDA, dass es Code gibt, und Folgendes passiert: <br><br><img src="https://habrastorage.org/webt/eq/wp/p3/eqwpp3exmqnybi7r_tdvvan4jls.png"><br><br>  Ab 0xB144 haben wir die Tabelle klar.  Aber was ist mit sub_494C? <br><br><img src="https://habrastorage.org/webt/bo/9b/rn/bo9brnkfvauy3ntm2dnucnsxqhs.png"><br><br>  Beim Aufruf dieser Funktion im LR-Register erhalten wir die Adresse der oben genannten Tabelle (0xB144).  R0 enth√§lt den Index in dieser Tabelle.  Das hei√üt, wir nehmen den Wert aus der Tabelle, f√ºgen ihn zu LR hinzu und erhalten die Adresse, zu der wir gehen m√ºssen.  Versuchen wir es zu berechnen: 0xB144 + [0xB144 + 8 * 4] = 0xB144 + 0x120 = 0xB264.  Wir navigieren zu dieser Adresse und sehen einige n√ºtzliche Anweisungen. Dann gehen wir zu 0xB140: <br><br><img src="https://habrastorage.org/webt/nz/95/4x/nz954xqtjmky6tnpaqeejhvecus.png"><br><br>  Jetzt gibt es einen √úbergang am Offset mit dem Index 0x20 von der Tabelle. <br>  Gemessen an der Gr√∂√üe der Tabelle gibt es viele solcher √úberg√§nge im Code.  Wir m√∂chten uns also automatisch darum k√ºmmern und vermeiden, Adressen manuell zu berechnen.  Daher helfen uns Skripte und die M√∂glichkeit, Code in IDA zu patchen: <br><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">put_unconditional_branch</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(source, destination)</span></span></span><span class="hljs-function">:</span></span> offset = (destination - source - <span class="hljs-number"><span class="hljs-number">4</span></span>) &gt;&gt; <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> offset &gt; <span class="hljs-number"><span class="hljs-number">2097151</span></span> <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> offset &lt; <span class="hljs-number"><span class="hljs-number">-2097152</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">raise</span></span> RuntimeError(<span class="hljs-string"><span class="hljs-string">"Invalid offset"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> offset &gt; <span class="hljs-number"><span class="hljs-number">1023</span></span> <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> offset &lt; <span class="hljs-number"><span class="hljs-number">-1024</span></span>: instruction1 = <span class="hljs-number"><span class="hljs-number">0xf000</span></span> | ((offset &gt;&gt; <span class="hljs-number"><span class="hljs-number">11</span></span>) &amp; <span class="hljs-number"><span class="hljs-number">0x7ff</span></span>) instruction2 = <span class="hljs-number"><span class="hljs-number">0xb800</span></span> | (offset &amp; <span class="hljs-number"><span class="hljs-number">0x7ff</span></span>) patch_word(source, instruction1) patch_word(source + <span class="hljs-number"><span class="hljs-number">2</span></span>, instruction2) <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>: instruction = <span class="hljs-number"><span class="hljs-number">0xe000</span></span> | (offset &amp; <span class="hljs-number"><span class="hljs-number">0x7ff</span></span>) patch_word(source, instruction) ea = here() <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> get_wide_word(ea) == <span class="hljs-number"><span class="hljs-number">0xb503</span></span>: <span class="hljs-comment"><span class="hljs-comment">#PUSH {R0,R1,LR} ea1 = ea + 2 if get_wide_word(ea1) == 0xbf00: #NOP ea1 += 2 if get_operand_type(ea1, 0) == 1 and get_operand_value(ea1, 0) == 0 and get_operand_type(ea1, 1) == 2: index = get_wide_dword(get_operand_value(ea1, 1)) print "index =", hex(index) ea1 += 2 if get_operand_type(ea1, 0) == 7: table = get_operand_value(ea1, 0) + 4 elif get_operand_type(ea1, 1) == 2: table = get_operand_value(ea1, 1) + 4 else: print "Wrong operand type on", hex(ea1), "-", get_operand_type(ea1, 0), get_operand_type(ea1, 1) table = None if table is None: print "Unable to find table" else: print "table =", hex(table) offset = get_wide_dword(table + (index &lt;&lt; 2)) put_unconditional_branch(ea, table + offset) else: print "Unknown code", get_operand_type(ea1, 0), get_operand_value(ea1, 0), get_operand_type(ea1, 1) == 2 else: print "Unable to detect first instruction"</span></span></code> </pre> <br>  Wir setzen den Cursor auf die Zeichenfolge 0xB26A, f√ºhren das Skript aus und sehen den √úbergang zu 0xB4B0: <br><br><img src="https://habrastorage.org/webt/52/rf/fx/52rffxhzmtrfdhfrznsr8dovfim.png"><br><br>  Auch hier erkennt IDA diesen Ort nicht als Code.  Wir helfen es und sehen dort eine andere Struktur: <br><br><img src="https://habrastorage.org/webt/ct/d9/kv/ctd9kvewm9l1blmw3pqipi8mnqm.png"><br><br>  Anweisungen, die nach BLX gehen, erscheinen nicht sehr aussagekr√§ftig.  Sie sind eher eine Art Versatz.  Wir schauen uns sub_4964 an: <br><br><img src="https://habrastorage.org/webt/o7/wi/4-/o7wi4-imrothkr6qpkbrklj40aw.png"><br><br>  Tats√§chlich nimmt es DWORD an der Adresse von LR, f√ºgt es dieser Adresse hinzu, nimmt dann den Wert an der resultierenden Adresse und speichert ihn im Stapel.  Zus√§tzlich werden 4 zu LR hinzugef√ºgt, um denselben Offset zu springen, nachdem von der Funktion zur√ºckgekehrt wurde.  Dann nimmt der Befehl POP {R1} den resultierenden Wert vom Stapel.  Wenn wir uns ansehen, was sich unter der Adresse 0xB4BA + 0xEA = 0xB5A4 befindet, sehen wir etwas √Ñhnliches wie in der Adresstabelle: <br><br><img src="https://habrastorage.org/webt/ev/hb/a8/evhba8ty8dtnv8niuxyfue0nkfk.png"><br><br>  Um diese Struktur zu patchen, m√ºssen wir zwei Parameter aus dem Code abrufen: den Offset und die Registernummer, an die wir das Ergebnis senden m√∂chten.  Wir m√ºssen f√ºr jedes m√∂gliche Register im Voraus einen Code vorbereiten. <br><br><pre> <code class="python hljs">patches = {} patches[<span class="hljs-number"><span class="hljs-number">0</span></span>] = (<span class="hljs-number"><span class="hljs-number">0x00</span></span>, <span class="hljs-number"><span class="hljs-number">0xbf</span></span>, <span class="hljs-number"><span class="hljs-number">0x01</span></span>, <span class="hljs-number"><span class="hljs-number">0x48</span></span>, <span class="hljs-number"><span class="hljs-number">0x00</span></span>, <span class="hljs-number"><span class="hljs-number">0x68</span></span>, <span class="hljs-number"><span class="hljs-number">0x02</span></span>, <span class="hljs-number"><span class="hljs-number">0xe0</span></span>) patches[<span class="hljs-number"><span class="hljs-number">1</span></span>] = (<span class="hljs-number"><span class="hljs-number">0x00</span></span>, <span class="hljs-number"><span class="hljs-number">0xbf</span></span>, <span class="hljs-number"><span class="hljs-number">0x01</span></span>, <span class="hljs-number"><span class="hljs-number">0x49</span></span>, <span class="hljs-number"><span class="hljs-number">0x09</span></span>, <span class="hljs-number"><span class="hljs-number">0x68</span></span>, <span class="hljs-number"><span class="hljs-number">0x02</span></span>, <span class="hljs-number"><span class="hljs-number">0xe0</span></span>) patches[<span class="hljs-number"><span class="hljs-number">2</span></span>] = (<span class="hljs-number"><span class="hljs-number">0x00</span></span>, <span class="hljs-number"><span class="hljs-number">0xbf</span></span>, <span class="hljs-number"><span class="hljs-number">0x01</span></span>, <span class="hljs-number"><span class="hljs-number">0x4a</span></span>, <span class="hljs-number"><span class="hljs-number">0x12</span></span>, <span class="hljs-number"><span class="hljs-number">0x68</span></span>, <span class="hljs-number"><span class="hljs-number">0x02</span></span>, <span class="hljs-number"><span class="hljs-number">0xe0</span></span>) patches[<span class="hljs-number"><span class="hljs-number">3</span></span>] = (<span class="hljs-number"><span class="hljs-number">0x00</span></span>, <span class="hljs-number"><span class="hljs-number">0xbf</span></span>, <span class="hljs-number"><span class="hljs-number">0x01</span></span>, <span class="hljs-number"><span class="hljs-number">0x4b</span></span>, <span class="hljs-number"><span class="hljs-number">0x1b</span></span>, <span class="hljs-number"><span class="hljs-number">0x68</span></span>, <span class="hljs-number"><span class="hljs-number">0x02</span></span>, <span class="hljs-number"><span class="hljs-number">0xe0</span></span>) patches[<span class="hljs-number"><span class="hljs-number">4</span></span>] = (<span class="hljs-number"><span class="hljs-number">0x00</span></span>, <span class="hljs-number"><span class="hljs-number">0xbf</span></span>, <span class="hljs-number"><span class="hljs-number">0x01</span></span>, <span class="hljs-number"><span class="hljs-number">0x4c</span></span>, <span class="hljs-number"><span class="hljs-number">0x24</span></span>, <span class="hljs-number"><span class="hljs-number">0x68</span></span>, <span class="hljs-number"><span class="hljs-number">0x02</span></span>, <span class="hljs-number"><span class="hljs-number">0xe0</span></span>) patches[<span class="hljs-number"><span class="hljs-number">5</span></span>] = (<span class="hljs-number"><span class="hljs-number">0x00</span></span>, <span class="hljs-number"><span class="hljs-number">0xbf</span></span>, <span class="hljs-number"><span class="hljs-number">0x01</span></span>, <span class="hljs-number"><span class="hljs-number">0x4d</span></span>, <span class="hljs-number"><span class="hljs-number">0x2d</span></span>, <span class="hljs-number"><span class="hljs-number">0x68</span></span>, <span class="hljs-number"><span class="hljs-number">0x02</span></span>, <span class="hljs-number"><span class="hljs-number">0xe0</span></span>) patches[<span class="hljs-number"><span class="hljs-number">8</span></span>] = (<span class="hljs-number"><span class="hljs-number">0x00</span></span>, <span class="hljs-number"><span class="hljs-number">0xbf</span></span>, <span class="hljs-number"><span class="hljs-number">0xdf</span></span>, <span class="hljs-number"><span class="hljs-number">0xf8</span></span>, <span class="hljs-number"><span class="hljs-number">0x06</span></span>, <span class="hljs-number"><span class="hljs-number">0x80</span></span>, <span class="hljs-number"><span class="hljs-number">0xd8</span></span>, <span class="hljs-number"><span class="hljs-number">0xf8</span></span>, <span class="hljs-number"><span class="hljs-number">0x00</span></span>, <span class="hljs-number"><span class="hljs-number">0x80</span></span>, <span class="hljs-number"><span class="hljs-number">0x01</span></span>, <span class="hljs-number"><span class="hljs-number">0xe0</span></span>) patches[<span class="hljs-number"><span class="hljs-number">9</span></span>] = (<span class="hljs-number"><span class="hljs-number">0x00</span></span>, <span class="hljs-number"><span class="hljs-number">0xbf</span></span>, <span class="hljs-number"><span class="hljs-number">0xdf</span></span>, <span class="hljs-number"><span class="hljs-number">0xf8</span></span>, <span class="hljs-number"><span class="hljs-number">0x06</span></span>, <span class="hljs-number"><span class="hljs-number">0x90</span></span>, <span class="hljs-number"><span class="hljs-number">0xd9</span></span>, <span class="hljs-number"><span class="hljs-number">0xf8</span></span>, <span class="hljs-number"><span class="hljs-number">0x00</span></span>, <span class="hljs-number"><span class="hljs-number">0x90</span></span>, <span class="hljs-number"><span class="hljs-number">0x01</span></span>, <span class="hljs-number"><span class="hljs-number">0xe0</span></span>) patches[<span class="hljs-number"><span class="hljs-number">10</span></span>] = (<span class="hljs-number"><span class="hljs-number">0x00</span></span>, <span class="hljs-number"><span class="hljs-number">0xbf</span></span>, <span class="hljs-number"><span class="hljs-number">0xdf</span></span>, <span class="hljs-number"><span class="hljs-number">0xf8</span></span>, <span class="hljs-number"><span class="hljs-number">0x06</span></span>, <span class="hljs-number"><span class="hljs-number">0xa0</span></span>, <span class="hljs-number"><span class="hljs-number">0xda</span></span>, <span class="hljs-number"><span class="hljs-number">0xf8</span></span>, <span class="hljs-number"><span class="hljs-number">0x00</span></span>, <span class="hljs-number"><span class="hljs-number">0xa0</span></span>, <span class="hljs-number"><span class="hljs-number">0x01</span></span>, <span class="hljs-number"><span class="hljs-number">0xe0</span></span>) patches[<span class="hljs-number"><span class="hljs-number">11</span></span>] = (<span class="hljs-number"><span class="hljs-number">0x00</span></span>, <span class="hljs-number"><span class="hljs-number">0xbf</span></span>, <span class="hljs-number"><span class="hljs-number">0xdf</span></span>, <span class="hljs-number"><span class="hljs-number">0xf8</span></span>, <span class="hljs-number"><span class="hljs-number">0x06</span></span>, <span class="hljs-number"><span class="hljs-number">0xb0</span></span>, <span class="hljs-number"><span class="hljs-number">0xdb</span></span>, <span class="hljs-number"><span class="hljs-number">0xf8</span></span>, <span class="hljs-number"><span class="hljs-number">0x00</span></span>, <span class="hljs-number"><span class="hljs-number">0xb0</span></span>, <span class="hljs-number"><span class="hljs-number">0x01</span></span>, <span class="hljs-number"><span class="hljs-number">0xe0</span></span>) ea = here() <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (get_wide_word(ea) == <span class="hljs-number"><span class="hljs-number">0xb082</span></span> <span class="hljs-comment"><span class="hljs-comment">#SUB SP, SP, #8 and get_wide_word(ea + 2) == 0xb503): #PUSH {R0,R1,LR} if get_operand_type(ea + 4, 0) == 7: pop = get_bytes(ea + 12, 4, 0) if pop[1] == '\xbc': register = -1 r = get_wide_byte(ea + 12) for i in range(8): if r == (1 &lt;&lt; i): register = i break if register == -1: print "Unable to detect register" else: address = get_wide_dword(ea + 8) + ea + 8 for b in patches[register]: patch_byte(ea, b) ea += 1 if ea % 4 != 0: ea += 2 patch_dword(ea, address) elif pop[:3] == '\x5d\xf8\x04': register = ord(pop[3]) &gt;&gt; 4 if register in patches: address = get_wide_dword(ea + 8) + ea + 8 for b in patches[register]: patch_byte(ea, b) ea += 1 patch_dword(ea, address) else: print "POP instruction not found" else: print "Wrong operand type on +4:", get_operand_type(ea + 4, 0) else: print "Unable to detect first instructions"</span></span></code> </pre> <br>  Wir setzen den Cursor an den Anfang der Struktur, die wir ersetzen m√∂chten (dh 0xB4B2) und f√ºhren das Skript aus: <br><br><img src="https://habrastorage.org/webt/lv/mp/oo/lvmpoow5agndjnbbl-t3imyaisq.jpeg"><br><br>  Zus√§tzlich zu den bereits erw√§hnten Strukturen enth√§lt der Code Folgendes: <br><br><img src="https://habrastorage.org/webt/dk/nn/rw/dknnrwaye18zzz0xipny0_gdqfq.png"><br><br>  Wie im vorherigen Fall gibt es nach dem BLX-Befehl einen Offset: <br><br><img src="https://habrastorage.org/webt/fn/bw/uz/fnbwuzpo3qw1hp3vd9rvr2xfq1k.jpeg"><br><br>  Wir nehmen den Offset an der Adresse von LR, f√ºgen ihn LR hinzu und navigieren dorthin.  0x72044 + 0xC = 0x72050.  Das Skript f√ºr diese Struktur ist recht einfach: <br><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">put_unconditional_branch</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(source, destination)</span></span></span><span class="hljs-function">:</span></span> offset = (destination - source - <span class="hljs-number"><span class="hljs-number">4</span></span>) &gt;&gt; <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> offset &gt; <span class="hljs-number"><span class="hljs-number">2097151</span></span> <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> offset &lt; <span class="hljs-number"><span class="hljs-number">-2097152</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">raise</span></span> RuntimeError(<span class="hljs-string"><span class="hljs-string">"Invalid offset"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> offset &gt; <span class="hljs-number"><span class="hljs-number">1023</span></span> <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> offset &lt; <span class="hljs-number"><span class="hljs-number">-1024</span></span>: instruction1 = <span class="hljs-number"><span class="hljs-number">0xf000</span></span> | ((offset &gt;&gt; <span class="hljs-number"><span class="hljs-number">11</span></span>) &amp; <span class="hljs-number"><span class="hljs-number">0x7ff</span></span>) instruction2 = <span class="hljs-number"><span class="hljs-number">0xb800</span></span> | (offset &amp; <span class="hljs-number"><span class="hljs-number">0x7ff</span></span>) patch_word(source, instruction1) patch_word(source + <span class="hljs-number"><span class="hljs-number">2</span></span>, instruction2) <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>: instruction = <span class="hljs-number"><span class="hljs-number">0xe000</span></span> | (offset &amp; <span class="hljs-number"><span class="hljs-number">0x7ff</span></span>) patch_word(source, instruction) ea = here() <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> get_wide_word(ea) == <span class="hljs-number"><span class="hljs-number">0xb503</span></span>: <span class="hljs-comment"><span class="hljs-comment">#PUSH {R0,R1,LR} ea1 = ea + 6 if get_wide_word(ea + 2) == 0xbf00: #NOP ea1 += 2 offset = get_wide_dword(ea1) put_unconditional_branch(ea, (ea1 + offset) &amp; 0xffffffff) else: print "Unable to detect first instruction"</span></span></code> </pre> <br>  Das Ergebnis der Ausf√ºhrung des Skripts: <br><br><img src="https://habrastorage.org/webt/tm/fq/yo/tmfqyogtdhbje0atjckosbrgide.jpeg"><br><br>  Nachdem wir alles in dieser Funktion gepatcht haben, k√∂nnen wir die IDA auf ihren tats√§chlichen Anfang verweisen.  Es wird den gesamten Funktionscode St√ºck f√ºr St√ºck sammeln und wir k√∂nnen ihn mit HexRays dekompilieren. <br><br><h3>  Die Zeichenfolgen entschl√ºsseln </h3><br>  Wir haben gelernt, wie man mit der Verschleierung von Maschinencode in der Bibliothek <b><i>libsgmainso-6.4.36.so</i></b> vom UC-Browser <b><i>umgeht,</i></b> und haben den Funktionscode <i>JNI_OnLoad erhalten</i> . <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">int</span></span> __<span class="hljs-function"><span class="hljs-function">fastcall </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">real_JNI_OnLoad</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(JavaVM *vm)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> result; <span class="hljs-comment"><span class="hljs-comment">// r0 jclass clazz; // r0 MAPDST int v4; // r0 JNIEnv *env; // r4 int v6; // [sp-40h] [bp-5Ch] int v7; // [sp+Ch] [bp-10h] v7 = *(_DWORD *)off_8AC00; if ( !vm ) goto LABEL_39; sub_7C4F4(); env = (JNIEnv *)sub_7C5B0(0); if ( !env ) goto LABEL_39; v4 = sub_72CCC(); sub_73634(v4); sub_73E24(&amp;unk_83EA6, &amp;v6, 49); clazz = (jclass)((int (__fastcall *)(JNIEnv *, int *))(*env)-&gt;FindClass)(env, &amp;v6); if ( clazz &amp;&amp; (sub_9EE4(), sub_71D68(env), sub_E7DC(env) &gt;= 0 &amp;&amp; sub_69D68(env) &gt;= 0 &amp;&amp; sub_197B4(env, clazz) &gt;= 0 &amp;&amp; sub_E240(env, clazz) &gt;= 0 &amp;&amp; sub_B8B0(env, clazz) &gt;= 0 &amp;&amp; sub_5F0F4(env, clazz) &gt;= 0 &amp;&amp; sub_70640(env, clazz) &gt;= 0 &amp;&amp; sub_11F3C(env) &gt;= 0 &amp;&amp; sub_21C3C(env, clazz) &gt;= 0 &amp;&amp; sub_2148C(env, clazz) &gt;= 0 &amp;&amp; sub_210E0(env, clazz) &gt;= 0 &amp;&amp; sub_41B58(env, clazz) &gt;= 0 &amp;&amp; sub_27920(env, clazz) &gt;= 0 &amp;&amp; sub_293E8(env, clazz) &gt;= 0 &amp;&amp; sub_208F4(env, clazz) &gt;= 0) ) { result = (sub_B7B0(env, clazz) &gt;&gt; 31) | 0x10004; } else { LABEL_39: result = -1; } return result; }</span></span></code> </pre> <br>  Schauen wir uns die folgenden Zeichenfolgen an: <br><br><pre> <code class="cpp hljs"> sub_73E24(&amp;unk_83EA6, &amp;v6, <span class="hljs-number"><span class="hljs-number">49</span></span>); clazz = (jclass)((<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> (__fastcall *)(JNIEnv *, <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> *))(*env)-&gt;FindClass)(env, &amp;v6);</code> </pre> <br>  Es ist ziemlich klar, dass die Funktion <i>sub_73E24</i> den <i>Klassennamen</i> entschl√ºsselt.  Die Parameter dieser Funktion enthalten einen Zeiger auf die Daten, die den verschl√ºsselten √§hnlich sind, eine Art Puffer und eine Zahl.  Offensichtlich befindet sich nach einem Aufruf der Funktion eine entschl√ºsselte Zeichenfolge im Puffer, da der Puffer an die <i>FindClass-</i> Funktion geht, die denselben Klassennamen wie der zweite Parameter erh√§lt.  Die Zahl ist also die Gr√∂√üe des Puffers oder die L√§nge der Zeichenfolge.  Versuchen wir, den Namen der Klasse zu entschl√ºsseln.  Es sollte anzeigen, ob wir in die richtige Richtung gehen.  Schauen wir uns genauer an, was in <i>sub_73E24</i> passiert. <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">int</span></span> __<span class="hljs-function"><span class="hljs-function">fastcall </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sub_73E56</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">unsigned</span></span></span></span><span class="hljs-function"><span class="hljs-params"> __int8 *in, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">unsigned</span></span></span></span><span class="hljs-function"><span class="hljs-params"> __int8 *out, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">size_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> size)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> v4; <span class="hljs-comment"><span class="hljs-comment">// r6 int v7; // r11 int v8; // r9 int v9; // r4 size_t v10; // r5 int v11; // r0 struc_1 v13; // [sp+0h] [bp-30h] int v14; // [sp+1Ch] [bp-14h] int v15; // [sp+20h] [bp-10h] v4 = 0; v15 = *(_DWORD *)off_8AC00; v14 = 0; v7 = sub_7AF78(17); v8 = sub_7AF78(size); if ( !v7 ) { v9 = 0; goto LABEL_12; } (*(void (__fastcall **)(int, const char *, int))(v7 + 12))(v7, "DcO/lcK+h?m3c*q@", 16); if ( !v8 ) { LABEL_9: v4 = 0; goto LABEL_10; } v4 = 0; if ( !in ) { LABEL_10: v9 = 0; goto LABEL_11; } v9 = 0; if ( out ) { memset(out, 0, size); v10 = size - 1; (*(void (__fastcall **)(int, unsigned __int8 *, size_t))(v8 + 12))(v8, in, v10); memset(&amp;v13, 0, 0x14u); v13.field_4 = 3; v13.field_10 = v7; v13.field_14 = v8; v11 = sub_6115C(&amp;v13, &amp;v14); v9 = v11; if ( v11 ) { if ( *(_DWORD *)(v11 + 4) == v10 ) { qmemcpy(out, *(const void **)v11, v10); v4 = *(_DWORD *)(v9 + 4); } else { v4 = 0; } goto LABEL_11; } goto LABEL_9; } LABEL_11: sub_7B148(v7); LABEL_12: if ( v8 ) sub_7B148(v8); if ( v9 ) sub_7B148(v9); return v4; }</span></span></code> </pre> <br>  Die Funktion sub_7AF78 erstellt eine Containerinstanz f√ºr Byte-Arrays der angegebenen Gr√∂√üe (wir werden uns nicht im Detail darauf konzentrieren).  Hier werden zwei solcher Container erstellt: Einer enth√§lt die Zeichenfolge " <b><i>DcO / lcK + h? M3c * q @</i></b> " (es ist leicht zu erraten, dass dies der Schl√ºssel ist), der andere enth√§lt die verschl√ºsselten Daten.  Beide Objekte werden dann in einer bestimmten Struktur platziert, die an die Funktion <i>sub_6115C √ºbertragen</i> wird.  Wir k√∂nnen auch feststellen, dass diese Struktur ein Feld mit dem Wert 3 enth√§lt. Mal sehen, was als n√§chstes passiert. <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">int</span></span> __<span class="hljs-function"><span class="hljs-function">fastcall </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sub_611B4</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(struc_1 *a1, _DWORD *a2)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> v3; <span class="hljs-comment"><span class="hljs-comment">// lr unsigned int v4; // r1 int v5; // r0 int v6; // r1 int result; // r0 int v8; // r0 *a2 = 820000; if ( a1 ) { v3 = a1-&gt;field_14; if ( v3 ) { v4 = a1-&gt;field_4; if ( v4 &lt; 0x19 ) { switch ( v4 ) { case 0u: v8 = sub_6419C(a1-&gt;field_0, a1-&gt;field_10, v3); goto LABEL_17; case 3u: v8 = sub_6364C(a1-&gt;field_0, a1-&gt;field_10, v3); goto LABEL_17; case 0x10u: case 0x11u: case 0x12u: v8 = sub_612F4( a1-&gt;field_0, v4, *(_QWORD *)&amp;a1-&gt;field_8, *(_QWORD *)&amp;a1-&gt;field_8 &gt;&gt; 32, a1-&gt;field_10, v3, a2); goto LABEL_17; case 0x14u: v8 = sub_63A28(a1-&gt;field_0, v3); goto LABEL_17; case 0x15u: sub_61A60(a1-&gt;field_0, v3, a2); return result; case 0x16u: v8 = sub_62440(a1-&gt;field_14); goto LABEL_17; case 0x17u: v8 = sub_6226C(a1-&gt;field_10, v3); goto LABEL_17; case 0x18u: v8 = sub_63530(a1-&gt;field_14); LABEL_17: v6 = 0; if ( v8 ) { *a2 = 0; v6 = v8; } return v6; default: LOWORD(v5) = 28032; goto LABEL_5; } } } } LOWORD(v5) = -27504; LABEL_5: HIWORD(v5) = 13; v6 = 0; *a2 = v5; return v6; }</span></span></code> </pre> <br>  Das Feld mit dem zuvor zugewiesenen Wert 3 wird als Schalterparameter √ºbergeben.  Schauen wir uns Fall 3 an - Parameter, die die der Struktur hinzugef√ºgte vorherige Funktion (dh der Schl√ºssel und die verschl√ºsselten Daten) in die Funktion sub_6364C √ºberf√ºhrt.  Wenn wir uns sub_6364C genau ansehen, k√∂nnen wir den RC4-Algorithmus erkennen. <br><br>  Wir haben also einen Algorithmus und einen Schl√ºssel.  Versuchen wir, den Namen der Klasse zu entschl√ºsseln.  Folgendes haben wir: com / taobao / wireless / security / adapter / JNICLibrary.  Genial!  Wir sind auf dem richtigen Weg. <br><br><h3>  Befehlsbaum </h3><br>  Jetzt m√ºssen wir den Aufruf von <i>RegisterNatives finden</i> , der uns auf die Funktion <i>doCommandNative verweist</i> .  Also schauen wir uns die von <i>JNI_OnLoad</i> aufgerufenen Funktionen an und finden sie in <i>sub_B7B0</i> : <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">int</span></span> __<span class="hljs-function"><span class="hljs-function">fastcall </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sub_B7F6</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(JNIEnv *env, jclass clazz)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> signature[<span class="hljs-number"><span class="hljs-number">41</span></span>]; <span class="hljs-comment"><span class="hljs-comment">// [sp+7h] [bp-55h] char name[16]; // [sp+30h] [bp-2Ch] JNINativeMethod method; // [sp+40h] [bp-1Ch] int v8; // [sp+4Ch] [bp-10h] v8 = *(_DWORD *)off_8AC00; decryptString((unsigned __int8 *)&amp;unk_83ED9, (unsigned __int8 *)name, 0x10u);// doCommandNative decryptString((unsigned __int8 *)&amp;unk_83EEA, (unsigned __int8 *)signature, 0x29u);// (I[Ljava/lang/Object;)Ljava/lang/Object; method.name = name; method.signature = signature; method.fnPtr = sub_B69C; return ((int (__fastcall *)(JNIEnv *, jclass, JNINativeMethod *, int))(*env)-&gt;RegisterNatives)(env, clazz, &amp;method, 1) &gt;&gt; 31; }</span></span></code> </pre> <br>  <i>Tats√§chlich</i> ist hier eine native Methode mit dem Namen <i>doCommandNative</i> registriert.  Jetzt kennen wir seine Adresse.  Schauen wir uns an, was es tut. <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">int</span></span> __<span class="hljs-function"><span class="hljs-function">fastcall </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">doCommandNative</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(JNIEnv *env, jobject obj, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> command, jarray args)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> v5; <span class="hljs-comment"><span class="hljs-comment">// r5 struc_2 *a5; // r6 int v9; // r1 int v11; // [sp+Ch] [bp-14h] int v12; // [sp+10h] [bp-10h] v5 = 0; v12 = *(_DWORD *)off_8AC00; v11 = 0; a5 = (struc_2 *)malloc(0x14u); if ( a5 ) { a5-&gt;field_0 = 0; a5-&gt;field_4 = 0; a5-&gt;field_8 = 0; a5-&gt;field_C = 0; v9 = command % 10000 / 100; a5-&gt;field_0 = command / 10000; a5-&gt;field_4 = v9; a5-&gt;field_8 = command % 100; a5-&gt;field_C = env; a5-&gt;field_10 = args; v5 = sub_9D60(command / 10000, v9, command % 100, 1, (int)a5, &amp;v11); } free(a5); if ( !v5 &amp;&amp; v11 ) sub_7CF34(env, v11, &amp;byte_83ED7); return v5; }</span></span></code> </pre> <br>  Der Name deutet darauf hin, dass dies der Einstiegspunkt f√ºr alle Funktionen ist, die die Entwickler in die native Bibliothek √ºbertragen haben.  Wir sind speziell an der Funktionsnummer 10601 interessiert. <br><br>  Aus dem Code k√∂nnen wir erkennen, dass die Befehlsnummer drei Zahlen enth√§lt: Befehl / 10000, Befehl% 10000/100 und Befehl% 10 (in unserem Fall 1, 6 und 1).  Diese drei Zahlen sowie der Zeiger auf JNIEnv und die an die Funktion √ºbertragenen Argumente bilden eine Struktur und werden weitergegeben.  Mit diesen drei Zahlen (wir bezeichnen sie als N1, N2 und N3) wird ein Befehlsbaum erstellt.  So etwas wie das: <br><br><img src="https://habrastorage.org/webt/xg/jk/l1/xgjkl1uhzmibo-nhmha3kpivf5a.png"><br><br>  Der Baum wird dynamisch in JNI_OnLoad erstellt.  Drei Zahlen kodieren den Pfad im Baum.  Jedes Blatt des Baums enth√§lt die xorred-Adresse der entsprechenden Funktion.  Der Schl√ºssel befindet sich im √ºbergeordneten Knoten.  Es ist ziemlich einfach, eine Stelle im Code zu finden, an der die ben√∂tigte Funktion zum Baum hinzugef√ºgt wird, wenn wir alle Strukturen dort verstehen (wir werden keine Zeit damit verbringen, sie in diesem Artikel zu beschreiben). <br><br><h3>  Mehr Verschleierung </h3><br>  Wir haben die Adresse der Funktion, die den Datenverkehr entschl√ºsseln soll: 0x5F1AC.  Aber es ist noch zu fr√ºh, um sich zu entspannen - die UC-Browser-Entwickler haben eine weitere √úberraschung f√ºr uns. <br><br>  Nachdem wir die Parameter von einem Array im Java-Code erhalten haben, gehen wir zur Funktion bei 0x4D070.  Eine andere Art der Codeverschleierung wartet bereits. <br><br>  Wir dr√ºcken dann zwei Indizes in R7 und R4: <br><br><img src="https://habrastorage.org/webt/7i/fx/86/7ifx86mr4yph41jsxukpjqvxmfa.png"><br><br>  Der erste Index bewegt sich zu R11: <br><br><img src="https://habrastorage.org/webt/fa/62/6j/fa626jaylcaaewtslff_-byaseo.jpeg"><br><br>  Wir verwenden diesen Index, um die Adresse aus der Tabelle zu erhalten: <br><br><img src="https://habrastorage.org/webt/co/rk/s1/corks1o2dp75elfvdsxjimrohuo.png"><br><br>  Nach der √úbertragung an die erste Adresse verwenden wir den zweiten Index von R4.  Die Tabelle enth√§lt 230 Elemente. <br><br>  Was machen wir damit?  Wir k√∂nnten der IDA sagen, dass es sich um eine Art Schalter handelt: Bearbeiten -&gt; Andere -&gt; Schalter-Idiom angeben. <br><br><img src="https://habrastorage.org/webt/36/uu/xn/36uuxnabf3xesptr8qisxzzfutk.jpeg"><br><br>  Der resultierende Code ist schrecklich.<font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Wir k√∂nnen jedoch den Aufruf der bekannten </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sub_6115C-</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Funktion in ihren </font><i><font style="vertical-align: inherit;">Verwicklungen sehen</font></i><font style="vertical-align: inherit;"> : </font></font><br><br><img src="https://habrastorage.org/webt/-d/pt/3a/-dpt3akb_yckinmdheczkktzlem.jpeg"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In Fall 3 gab es den switch-Parameter mit der RC4-Entschl√ºsselung. In diesem Fall wird die Struktur, die an die Funktion √ºbertragen wird, mit den an doCommandNative √ºbertragenen Parametern gef√ºllt. Wir erinnern uns, dass wir dort magicInt mit dem Wert 16 hatten. Wir betrachten den entsprechenden Fall und finden nach mehreren √úberg√§ngen den Code, mit dem wir den Algorithmus identifizieren k√∂nnen. </font></font><br><br><img src="https://habrastorage.org/webt/rn/_1/i4/rn_1i4avl8oki83hslk5u19ygoe.jpeg"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Es ist AES!</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Wir haben einen Algorithmus und m√ºssen nur seine Parameter wie Modus, Schl√ºssel und (m√∂glicherweise) den Initialisierungsvektor abrufen (sein Vorhandensein h√§ngt vom Betriebsmodus des AES-Algorithmus ab). </font><font style="vertical-align: inherit;">Die Struktur, die sie enth√§lt, sollte irgendwo erstellt werden, bevor die Funktion sub_6115C aufgerufen wird. </font><font style="vertical-align: inherit;">Da dieser Teil des Codes jedoch besonders gut verschleiert ist, haben wir beschlossen, den Code zu patchen, damit alle Parameter der Entschl√ºsselungsfunktion in eine Datei kopiert werden k√∂nnen.</font></font><br><br><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Patch </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Wenn Sie nicht den gesamten Patch-Code manuell in der Assemblersprache schreiben m√∂chten, k√∂nnen Sie Android Studio ausf√ºhren, eine Funktion codieren, die dieselben Parameter wie unsere Entschl√ºsselungsfunktion empf√§ngt und in die Datei schreibt, und dann den vom Compiler </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Unsere guten Freunde vom UC Browser-Team haben auch das bequeme Hinzuf√ºgen von Code ‚Äûsichergestellt‚Äú. Wir erinnern uns, dass wir am Anfang jeder Funktion M√ºllcode haben, der leicht durch jeden anderen Code ersetzt werden kann. Sehr praktisch :) Am Anfang der Zielfunktion ist jedoch nicht gen√ºgend Platz f√ºr den Code, der alle Parameter in einer Datei speichert. Wir mussten es in Teile teilen und die M√ºllbl√∂cke benachbarter Funktionen verwenden. Wir haben insgesamt vier Teile. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Teil eins:</font></font><br><br><img src="https://habrastorage.org/webt/hy/lk/qr/hylkqrhqgyei6qjdj6ayvgivpqu.jpeg"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Die ersten vier Funktionsparameter in der ARM-Architektur werden in den Registern R0-R3 angezeigt, w√§hrend der Rest, falls vorhanden, √ºber den Stapel geht. Das LR-Register zeigt die R√ºcksprungadresse an. Wir m√ºssen alle diese Daten speichern, damit die Funktion funktionieren kann, nachdem wir ihre Parameter ausgegeben haben. Wir m√ºssen auch alle Register speichern, die wir in diesem Prozess verwenden, also verwenden wir PUSH.W {R0-R10, LR}. In R7 erhalten wir die Adresse der Liste der Parameter, die √ºber den Stapel an die Funktion √ºbertragen werden.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mit der Funktion fopen √∂ffnen wir die Datei / data / local / tmp / aes im Modus "ab" (damit wir etwas hinzuf√ºgen k√∂nnen). Wir laden dann die Dateinamenadresse in R0 und die Zeichenfolgenadresse, die den Modus in R1 angibt. Hier endet der M√ºllcode, also navigieren wir zur n√§chsten Funktion. Da wir m√∂chten, dass es weiter funktioniert, setzen wir den √úbergang zum eigentlichen Funktionscode am Anfang vor den M√ºll und ersetzen den M√ºll durch den Rest des Patches. </font></font><br><br><img src="https://habrastorage.org/webt/68/ss/kf/68sskfcymjorl_flpf8mg9wwej4.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Wir rufen dann fopen an. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Die ersten drei Parameter der aes-Funktion sind vom Typ int. Da wir die Register zu Beginn auf den Stapel verschoben haben, k√∂nnen wir einfach ihre Adressen im Stapel an die Funktion fwrite √ºbertragen.</font></font><br><br><img src="https://habrastorage.org/webt/d1/yt/iz/d1ytiz_jx7byflntqxxec2nece0.jpeg"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Als n√§chstes haben wir drei Strukturen, die die Gr√∂√üe der Daten angeben und einen Zeiger auf die Daten f√ºr den Schl√ºssel, den Initialisierungsvektor und die verschl√ºsselten Daten enthalten. </font></font><br><br><img src="https://habrastorage.org/webt/me/vy/kz/mevykztpkcwdr6xkpnenauxqccs.jpeg"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Am Ende schlie√üen wir die Datei, stellen die Register wieder her und geben die Kontrolle √ºber die eigentliche aes-Funktion zur√ºck.</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Wir kompilieren die APK-Datei mit der gepatchten Bibliothek, signieren sie, laden sie auf ein Ger√§t oder einen Emulator herunter und f√ºhren sie aus. Jetzt sehen wir, dass der Speicherauszug mit vielen Daten erstellt wurde. Der Browser entschl√ºsselt nicht nur den Datenverkehr, sondern auch andere Daten, und die gesamte Entschl√ºsselung erfolgt √ºber diese Funktion. Aus irgendeinem Grund sehen wir die ben√∂tigten Daten nicht und die erwartete Anfrage ist im Datenverkehr nicht sichtbar. Lassen Sie uns das Warten √ºberspringen, bis UC Browser die M√∂glichkeit hat, diese Anforderung zu stellen, und die zuvor vom Server erhaltene verschl√ºsselte Antwort verwenden, um die Anwendung erneut zu patchen. Wir werden die Entschl√ºsselung zu onCreate der Hauptaktivit√§t hinzuf√ºgen.</font></font><br><br><pre> <code class="plaintext hljs"> const/16 v1, 0x62 new-array v1, v1, [B fill-array-data v1, :encrypted_data const/16 v0, 0x1f invoke-static {v0, v1}, Lcom/uc/browser/core/d/c/g;-&gt;j(I[B)[B move-result-object v1 array-length v2, v1 invoke-static {v2}, Ljava/lang/String;-&gt;valueOf(I)Ljava/lang/String; move-result-object v2 const-string v0, "ololo" invoke-static {v0, v2}, Landroid/util/Log;-&gt;d(Ljava/lang/String;Ljava/lang/String;)I</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Wir kompilieren es, signieren, installieren und f√ºhren es aus. </font><font style="vertical-align: inherit;">Daher erhalten wir eine NullPointerException, da die Methode einen Nullwert zur√ºckgibt. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nachdem wir den Code weiter analysiert hatten, fanden wir eine Funktion mit ziemlich interessanten Zeichenfolgen: "META-INF /" und ".RSA". </font><font style="vertical-align: inherit;">Es sieht so aus, als ob die App ihr Zertifikat √ºberpr√ºft oder sogar Schl√ºssel daraus generiert. </font><font style="vertical-align: inherit;">Wir wollen nicht wirklich untersuchen, was mit dem Zertifikat passiert, also geben wir ihm einfach das richtige Zertifikat. </font><font style="vertical-align: inherit;">Wir patchen die verschl√ºsselte Zeichenfolge, sodass wir anstelle von "META-INF /" "BLABLINF /" erhalten, einen Ordner mit diesem Namen in der APK-Datei erstellen und das Browserzertifikat darin speichern. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Wir kompilieren es, signieren, installieren und f√ºhren es aus. </font><font style="vertical-align: inherit;">Bingo! </font><font style="vertical-align: inherit;">Wir haben den Schl√ºssel!</font></font><br><br><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Mitm </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Jetzt haben wir den Schl√ºssel und einen gleichen Initialisierungsvektor. Versuchen wir, die Serverantwort im CBC-Modus zu entschl√ºsseln. </font></font><br><br><img src="https://habrastorage.org/webt/9k/m7/un/9km7unymy_ybx1lwnflfbqd36ke.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Wir sehen die Archiv-URL, so etwas wie MD5, "extract_unzipsize" und eine Nummer. Lassen Sie uns √ºberpr√ºfen. Das MD5 des Archivs ist dasselbe. Die Gr√∂√üe der entpackten Bibliothek ist gleich. Jetzt werden wir versuchen, diese Bibliothek zu patchen und an den Browser zu √ºbertragen. Um zu zeigen, dass unsere gepatchte Bibliothek geladen wurde, erstellen wir eine Absicht, um die Textnachricht "PWNED!" Zu erstellen. Wir werden zwei Antworten vom Server ersetzen: </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">puds.ucweb.com/upgrade/index.xhtml</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> und die, die zum Herunterladen des Archivs auffordert. Im ersten Fall ersetzen wir MD5 (die Gr√∂√üe bleibt nach dem Entpacken gleich). Im zweiten Schritt senden wir das Archiv mit der gepatchten Bibliothek.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Der Browser unternimmt mehrere Versuche, das Archiv herunterzuladen, was zu einem Fehler f√ºhrt. </font><font style="vertical-align: inherit;">Anscheinend passiert dort etwas faul. </font><font style="vertical-align: inherit;">Bei der Analyse dieses bizarren Formats haben wir festgestellt, dass der Server auch die Archivgr√∂√üe √ºbertr√§gt: </font></font><br><br><img src="https://habrastorage.org/webt/e2/-v/ua/e2-vuahng86h0bt0vm84f3xhqrg.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Es ist LEB128-codiert. </font><font style="vertical-align: inherit;">Der Patch √§ndert die Gr√∂√üe der komprimierten Bibliothek geringf√ºgig, sodass der Browser feststellte, dass das Archiv beim Herunterladen besch√§digt wurde und nach mehreren Versuchen ein Fehler angezeigt wurde. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Also korrigieren wir die Archivgr√∂√üe und ... voila! </font><font style="vertical-align: inherit;">:) Siehe das Ergebnis im Video.</font></font><br><br><iframe width="560" height="315" src="https://www.youtube.com/embed/Nfns7uH03J8" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Konsequenzen und Antwort des Entwicklers </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Auf die gleiche Weise k√∂nnen Hacker diese unsichere Funktion von UC Browser verwenden, um sch√§dliche Bibliotheken zu verteilen und zu starten. Diese Bibliotheken arbeiten im Kontext des Browsers, was zu vollst√§ndigen Systemberechtigungen des Browsers f√ºhrt. Dies gibt ihnen die M√∂glichkeit, Phishing-Fenster anzuzeigen und auf die Arbeitsdateien des Browsers zuzugreifen, einschlie√ülich Anmeldungen, Kennw√∂rtern und Cookies in der Datenbank.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Wir haben die Entwickler des UC-Browsers kontaktiert und sie √ºber das gefundene Problem informiert, versucht, auf die Sicherheitsanf√§lligkeit und ihre Gefahr hinzuweisen, aber sie haben sich geweigert, die Angelegenheit zu diskutieren. In der Zwischenzeit blieb der Browser mit der gef√§hrlichen Funktion in Sichtweite. Sobald wir die Details der Sicherheitsanf√§lligkeit enth√ºllten, war es unm√∂glich, sie wie zuvor zu ignorieren. Am 27. M√§rz wurde eine neue Version von UC Browser 10.10.9.1193 ver√∂ffentlicht, die √ºber HTTPS </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;">puds.ucweb.com/upgrade/index.xhtml auf</font></a><font style="vertical-align: inherit;"> den Server </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">zugegriffen hat</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Au√üerdem f√ºhrte der Versuch, eine PDF-Datei im Browser zu √∂ffnen, zwischen der Fehlerbehebung und dem Zeitpunkt, zu dem wir diesen Artikel geschrieben haben, zu einer Fehlermeldung mit dem Text "Ups, etwas stimmt nicht". </font><font style="vertical-align: inherit;">Beim Versuch, die PDF-Datei zu √∂ffnen, wurde keine Anforderung an den Server gesendet. </font><font style="vertical-align: inherit;">Dies wurde jedoch beim Start durchgef√ºhrt. Dies ist ein Zeichen daf√ºr, dass der ausf√ºhrbare Code unter Versto√ü gegen die Google Play-Richtlinien weiterhin heruntergeladen werden kann.</font></font></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de452076/">https://habr.com/ru/post/de452076/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de452064/index.html">Konfiguration und Dateien des gew√ºnschten PowerShell-Status: Teil 1. Konfigurieren des DSC Pull-Servers f√ºr die Arbeit mit der SQL-Datenbank</a></li>
<li><a href="../de452066/index.html">Excelsior JET stellt die Entwicklung seines AOT-Compilers nach 18 Jahren Arbeit ein</a></li>
<li><a href="../de452068/index.html">12. Check Point Erste Schritte R80.20. Protokolle und Berichte</a></li>
<li><a href="../de452072/index.html">Wir implementieren CircularRevealAnimation auf Flutter und ver√∂ffentlichen gleichzeitig die Bibliothek auf pub.dev</a></li>
<li><a href="../de452074/index.html">Das erste Spiel √ºber die Einheit oder was ich sechs Monate gebraucht habe</a></li>
<li><a href="../de452078/index.html">Kubernetes Reservierung: Es besteht</a></li>
<li><a href="../de452082/index.html">Flexibler Ablauf von In-App-Updates: Beschleunigen Sie den App-Update-Prozess unter Android</a></li>
<li><a href="../de452086/index.html">Was ist in meinem Pixel f√ºr Sie: Erstellen von Nanopixeln mit Plasmon-Metaoberfl√§chen</a></li>
<li><a href="../de452088/index.html">Stra√üenerkennung durch semantische Segmentierung</a></li>
<li><a href="../de452090/index.html">Erstellen eines prozeduralen Puzzle-Generators</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>