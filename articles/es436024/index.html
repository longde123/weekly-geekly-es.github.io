<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üî£ üë®üèª‚Äçüè≠ üë®‚Äçüç≥ C√≥mo no tirar basura en Java ü•© ü¶Ä üë©üèø</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Existe una idea err√≥nea popular de que si no le gusta la recolecci√≥n de basura, no necesita escribir en Java, sino en C / C ++. Durante los √∫ltimos tr...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>C√≥mo no tirar basura en Java</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/436024/"><p> Existe una idea err√≥nea popular de que si no le gusta la recolecci√≥n de basura, no necesita escribir en Java, sino en C / C ++.  Durante los √∫ltimos tres a√±os he estado escribiendo c√≥digo Java de baja latencia para el comercio de divisas, y tuve que evitar crear objetos innecesarios en todos los sentidos.  Como resultado, formul√© algunas reglas simples para m√≠, c√≥mo reducir las asignaciones en Java, si no a cero, luego a un m√≠nimo razonable, sin recurrir a la administraci√≥n manual de memoria.  Quiz√°s tambi√©n sea √∫til para alguien de la comunidad. </p><a name="habracut"></a><br><h2>  ¬øPor qu√© evitar la basura? </h2><br><p>  Sobre qu√© es GC y c√≥mo configurarlos, se dijo y escribi√≥ mucho.  Pero en √∫ltima instancia, no importa c√≥mo configure el GC, codifique que la basura funcionar√° de manera sub√≥ptima.  Siempre hay una compensaci√≥n entre el rendimiento y la latencia.  Se hace imposible mejorar uno sin empeorar al otro.  Como regla general, la sobrecarga del GC se mide mediante el estudio de los registros: puede comprender a partir de ellos en qu√© momentos hubo pausas y cu√°nto tiempo tomaron.  Sin embargo, los registros del GC no contienen toda la informaci√≥n sobre esta sobrecarga.  El objeto creado por el subproceso se coloca autom√°ticamente en la memoria cach√© L1 del n√∫cleo del procesador en el que se ejecuta el subproceso.  Esto lleva a la exclusi√≥n de otros datos potencialmente √∫tiles.  Con una gran cantidad de asignaciones, los datos √∫tiles tambi√©n se pueden extraer del cach√© L3.  La pr√≥xima vez que el subproceso acceda a estos datos, se producir√° la falta de cach√©, lo que provocar√° demoras en la ejecuci√≥n del programa.  Adem√°s, dado que el cach√© L3 es com√∫n para todos los n√∫cleos dentro del mismo procesador, un flujo de basura empujar√° datos y otros subprocesos / aplicaciones desde el cach√© L3, y ya encontrar√°n errores de cach√© costosos adicionales, incluso si est√°n escritos en C y no crees basura.  Sin configuraciones, sin recolectores de basura (ni C4 ni ZGC) ayudar√°n a hacer frente a este problema.  La √∫nica forma de mejorar la situaci√≥n en su conjunto es no crear objetos innecesarios innecesariamente.  Java, a diferencia de C ++, no tiene un rico arsenal de mecanismos para trabajar con memoria, pero, sin embargo, hay varias formas de minimizar las asignaciones.  Ser√°n discutidos. </p><br><div class="spoiler">  <b class="spoiler_title">Digresi√≥n l√≠rica</b> <div class="spoiler_text"><p>  Por supuesto, no necesita escribir todo el c√≥digo libre de basura.  Lo que pasa con el lenguaje Java es que puede simplificar enormemente su vida eliminando solo las principales fuentes de basura.  Tampoco puede lidiar con la recuperaci√≥n segura de la memoria al escribir algoritmos sin bloqueo.  Si un determinado c√≥digo se ejecuta solo una vez al inicio de la aplicaci√≥n, puede asignar tanto como desee, y no es gran cosa.  Bueno, por supuesto, la principal herramienta de trabajo para deshacerse del exceso de basura es el generador de perfiles de asignaci√≥n. </p></div></div><br><h2>  Usando tipos primitivos </h2><br><p> Lo m√°s simple que se puede hacer en muchos casos es usar tipos primitivos en lugar de tipos de objetos.  La JVM tiene una serie de optimizaciones para minimizar la sobrecarga de los tipos de objetos, como el almacenamiento en cach√© de peque√±os valores de tipos enteros y la inclusi√≥n de clases simples.  Pero no siempre vale la pena confiar en estas optimizaciones, ya que es posible que no funcionen: el valor entero puede no almacenarse en cach√© y puede que no se formen l√≠neas.  Adem√°s, cuando trabajamos con un n√∫mero entero condicional, nos vemos obligados a seguir el enlace, lo que potencialmente conduce a una p√©rdida de cach√©.  Adem√°s, todos los objetos tienen encabezados que ocupan espacio adicional en el cach√©, desplazando otros datos desde all√≠.  Vamos a tomarlo: un int primitivo toma 4 bytes.  Object <code>Integer</code> ocupa 16 bytes + el tama√±o del enlace a este entero es de 4 bytes como m√≠nimo (en el caso de Ups comprimido).  En total, resulta que <code>Integer</code> ocupa cinco (!) Veces m√°s espacio que <code>int</code> .  Por lo tanto, es mejor usar tipos primitivos usted mismo.  Dar√© algunos ejemplos. </p><br><h3>  Ejemplo 1. C√°lculos convencionales. </h3><br><p>  Digamos que tenemos una funci√≥n regular que solo cuenta algo. </p><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-function">Integer </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getValue</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Integer a, Integer b, Integer c)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (a + b) / c; }</code> </pre> <br><p>  Es probable que dicho c√≥digo se vuelva en l√≠nea (tanto el m√©todo como las clases) y no dar√° lugar a asignaciones innecesarias, pero no puede estar seguro de esto.  Incluso si esto sucede, habr√° un problema con el hecho de que una <code>NullPointerException</code> podr√≠a volar desde aqu√≠.  De una forma u otra, la JVM tendr√° que insertar cheques <code>null</code> debajo del cap√≥, o comprender de alguna manera por el contexto que <code>null</code> no puede ser un argumento.  De todos modos, es mejor simplemente escribir el mismo c√≥digo en primitivas. </p><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getValue</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> a, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> b, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> c)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (a + b) / c; }</code> </pre> <br><h3>  Ejemplo 2. Lambdas </h3><br><p>  A veces los objetos se crean sin nuestro conocimiento.  Por ejemplo, si pasamos tipos primitivos a donde se esperan tipos de objetos.  Esto sucede a menudo cuando se usan expresiones lambda. <br>  Imagina que tenemos este c√≥digo: </p><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">calculate</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Consumer&lt;Integer&gt; calculator)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> x = System.currentTimeMillis(); calculator.accept(x); }</code> </pre> <br><p>  A pesar de que la variable x es una primitiva, se crear√° un objeto de tipo Integer, que se pasar√° a la calculadora.  Para evitar esto, use <code>IntConsumer</code> lugar de <code>Consumer&lt;Integer&gt;</code> : </p><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">calculate</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(IntConsumer calculator)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> x = System.currentTimeMillis(); calculator.accept(x); }</code> </pre> <br><p>  Tal c√≥digo ya no conducir√° a la creaci√≥n de un objeto adicional.  Java.util.function tiene un conjunto completo de interfaces est√°ndar adaptadas para usar tipos primitivos: <code>DoubleSupplier</code> , <code>LongFunction</code> , etc.  Bueno, si falta algo, siempre puede agregar la interfaz deseada con primitivas.  Por ejemplo, en lugar de <code>BiConsumer&lt;Integer, Double&gt;</code> puede usar una interfaz casera. </p><br><pre> <code class="java hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">IntDoubleConsumer</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">accept</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> x, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">double</span></span></span></span><span class="hljs-function"><span class="hljs-params"> y)</span></span></span></span>; }</code> </pre> <br><h3>  Ejemplo 3. Colecciones </h3><br><p>  Usar un tipo primitivo puede ser dif√≠cil porque una variable de este tipo est√° en una colecci√≥n.  Supongamos que tenemos algo de <code>List&lt;Integer&gt;</code> y queremos saber qu√© n√∫meros hay en √©l y calcular cu√°ntas veces se repite cada uno de los n√∫meros.  Para esto, usamos <code>HashMap&lt;Integer, Integer&gt;</code> .  El c√≥digo se ve as√≠: </p><br><pre> <code class="java hljs">List&lt;Integer&gt; numbers = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ArrayList&lt;&gt;(); <span class="hljs-comment"><span class="hljs-comment">// fill numbers somehow Map&lt;Integer, Integer&gt; counters = new HashMap&lt;&gt;(); for (Integer x : numbers) { counters.compute(x, (k, v) -&gt; v == null ? 1 : v + 1); }</span></span></code> </pre> <br><p>  Este c√≥digo es malo de varias maneras a la vez.  En primer lugar, utiliza una estructura de datos intermedia, que probablemente podr√≠a hacerse sin ella.  Bueno, bueno, por simplicidad, asumimos que esta lista ser√° necesaria m√°s tarde, es decir.  no puedes eliminarlo por completo.  En segundo lugar, el objeto <code>Integer</code> usa en ambos lugares en lugar de <code>int</code> primitivo.  En tercer lugar, hay muchas asignaciones en el m√©todo de <code>compute</code> .  Cuarto, se asigna un iterador.  Es probable que esta asignaci√≥n se convierta en l√≠nea, pero no obstante.  ¬øC√≥mo convertir este c√≥digo en c√≥digo libre de basura?  Solo necesita usar la colecci√≥n en las primitivas de alguna biblioteca de terceros.  Hay varias bibliotecas que contienen tales colecciones.  El siguiente c√≥digo utiliza la biblioteca <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">agrona</a> . </p><br><pre> <code class="java hljs">IntArrayList numbers = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> IntArrayList(); <span class="hljs-comment"><span class="hljs-comment">// fill numbers somehow Int2IntCounterMap counters = new Int2IntCounterMap(0); for (int i = 0; i &lt; numbers.size(); i++) { counters.incrementAndGet(numbers.getInt(i)); }</span></span></code> </pre> <br><p>  Los objetos que se crean aqu√≠ son dos colecciones y dos <code>int[]</code> , que se encuentran dentro de estas colecciones.  Ambas colecciones se pueden reutilizar llamando al m√©todo <code>clear()</code> en ellas.  Al usar colecciones en primitivas, no complicamos nuestro c√≥digo (e incluso lo simplificamos al eliminar el m√©todo de c√°lculo con una lambda compleja dentro de √©l) y recibimos los siguientes bonos adicionales en comparaci√≥n con el uso de colecciones est√°ndar: </p><br><ol><li>  Ausencia casi completa de asignaciones.  Si las colecciones se reutilizan, entonces no habr√° asignaciones en absoluto. </li><li>  Ahorro significativo de memoria ( <code>IntArrayList</code> ocupa aproximadamente cinco veces menos espacio que <code>ArrayList&lt;Integer&gt;</code> . Como ya se mencion√≥, nos preocupa el uso econ√≥mico de las memorias cach√© del procesador, no de la RAM. </li><li>  Acceso en serie a la memoria.  Mucho se ha escrito sobre el tema de por qu√© esto es importante, por lo que no me detendr√© all√≠.  Aqu√≠ hay un par de art√≠culos: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Martin Thompson</a> y <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Ulrich Drepper</a> . </li></ol><br><p>  Otro peque√±o comentario sobre colecciones.  Puede resultar que la colecci√≥n contenga valores de diferentes tipos y, por lo tanto, no es posible reemplazarla con una colecci√≥n con primitivas.  En mi opini√≥n, esto es una se√±al de un mal dise√±o de la estructura de datos o del algoritmo en su conjunto.  Lo m√°s probable en este caso, la asignaci√≥n de objetos adicionales no es el problema principal. </p><br><h2>  Objetos mutables </h2><br><p>  Pero, ¬øqu√© pasa si no se puede prescindir de las primitivas?  Por ejemplo, en el caso de que el m√©todo que necesitamos deba devolver varios valores.  La respuesta es simple: use objetos mutables. </p><br><div class="spoiler">  <b class="spoiler_title">Peque√±a digresi√≥n</b> <div class="spoiler_text"><p>  Algunos idiomas enfatizan el uso de objetos inmutables, por ejemplo en Scala.  El argumento principal a su favor es que escribir c√≥digo multiproceso se simplifica enormemente.  Sin embargo, tambi√©n hay gastos generales asociados con la asignaci√≥n excesiva de basura.  Si queremos evitarlos, entonces no debemos crear objetos inmutables de corta duraci√≥n. </p></div></div><br><p>  ¬øC√≥mo se ve en la pr√°ctica?  Supongamos que necesitamos calcular el cociente y el resto de la divisi√≥n.  Y para esto usamos el siguiente c√≥digo. </p><br><pre> <code class="java hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">IntPair</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> x; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> y; } <span class="hljs-function"><span class="hljs-function">IntPair </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">divide</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> value, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> divisor)</span></span></span><span class="hljs-function"> </span></span>{ IntPair result = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> IntPair(); result.x = value / divisor; result.y = value % divisor; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> result; }</code> </pre> <br><p>  ¬øC√≥mo se puede deshacerse de la asignaci√≥n en este caso?  As√≠ es, pase <code>IntPair</code> como argumento y escriba el resultado all√≠.  En este caso, necesita escribir un javadoc detallado, y a√∫n mejor, usar alg√∫n tipo de convenci√≥n para nombres de variables, donde se escribe el resultado.  Por ejemplo, pueden comenzar con el prefijo.  El c√≥digo libre de basura en este caso se ver√° as√≠: </p><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">divide</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> value, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> divisor, IntPair outResult)</span></span></span><span class="hljs-function"> </span></span>{ outResult.x = value / divisor; outResult.y = value % divisor; }</code> </pre> <br><p>  Quiero se√±alar que el m√©todo de <code>divide</code> no deber√≠a guardar un enlace para emparejarlo en ninguna parte o pasarlo a m√©todos que puedan hacer esto, de lo contrario, podr√≠amos tener grandes problemas.  Como podemos ver, los objetos mutables son m√°s dif√≠ciles de usar que los tipos primitivos, por lo que si puede usar primitivos, entonces es mejor hacerlo.  De hecho, en nuestro ejemplo, transferimos el problema de asignaci√≥n desde dentro del m√©todo de divisi√≥n al exterior.  En todos los lugares donde llamamos a este m√©todo, necesitaremos un poco de <code>IntPair</code> , que pasaremos para <code>divide</code> .  A menudo es suficiente para almacenar este ficticio en el campo <code>final</code> del objeto, desde donde llamamos al m√©todo de <code>divide</code> .  Perm√≠teme darte un ejemplo descabellado: supongamos que nuestro programa solo trata de recibir una secuencia de n√∫meros a trav√©s de la red, los divide y env√≠a el resultado al mismo socket. </p><br><pre> <code class="java hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SocketListener</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> IntPair pair = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> IntPair(); <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> BufferedReader in; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> PrintWriter out; SocketListener(<span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Socket socket) <span class="hljs-keyword"><span class="hljs-keyword">throws</span></span> IOException { in = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> BufferedReader(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> InputStreamReader(socket.getInputStream())); out = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> PrintWriter(socket.getOutputStream(), <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">listenSocket</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> IOException </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> value = in.read(); <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> divisor = in.read(); divide(value, divisor, pair); out.print(pair.x); out.print(pair.y); } } }</code> </pre> <br><p>  Por brevedad, no escrib√≠ c√≥digo "extra" para el manejo de errores, la finalizaci√≥n correcta del programa, etc.  La idea principal de este fragmento de c√≥digo es que el objeto <code>IntPair</code> que <code>IntPair</code> se crea una vez y se almacena en el campo <code>final</code> . </p><br><h2>  Agrupaciones de objetos </h2><br><p>  Cuando usamos objetos mutables, primero debemos tomar un objeto vac√≠o de alg√∫n lugar, luego escribir los datos que necesitamos en √©l, usarlo en alg√∫n lugar y luego devolver el objeto "en su lugar".  En el ejemplo anterior, el objeto siempre estaba "en su lugar", es decir  en el campo <code>final</code>  Desafortunadamente, esto no siempre es posible hacerlo de una manera simple.  Por ejemplo, es posible que no sepamos de antemano exactamente cu√°ntos objetos necesitamos.  En este caso, los grupos de objetos vienen en nuestra ayuda.  Cuando necesitamos un objeto vac√≠o, lo obtenemos del grupo de objetos, y cuando deja de ser necesario, lo devolvemos all√≠.  Si no hay ning√∫n objeto libre en el grupo, el grupo crea un nuevo objeto.  De hecho, se trata de una gesti√≥n de memoria manual con todas las consecuencias resultantes.  Es aconsejable no recurrir a este m√©todo si es posible utilizar los m√©todos anteriores.  ¬øQu√© podr√≠a salir mal? </p><br><ul><li>  Podemos olvidar devolver el objeto al grupo y luego se crear√° basura ("p√©rdida de memoria").  Este es un problema peque√±o: el rendimiento disminuir√° ligeramente, pero el GC funcionar√° y el programa continuar√° funcionando. </li><li>  Podemos devolver el objeto al grupo, pero guarde el enlace en alguna parte.  Luego, alguien m√°s obtendr√° el objeto del grupo, y en este punto de nuestro programa ya habr√° dos enlaces al mismo objeto.  Este es un problema cl√°sico de uso libre despu√©s.  Es dif√≠cil debutar porque  A diferencia de C ++, el programa no se bloquear√° y continuar√° funcionando <em>incorrectamente</em> . </li></ul><br><p>  Para reducir la probabilidad de cometer los errores anteriores, puede usar la construcci√≥n est√°ndar de prueba con recursos.  Puede verse as√≠: </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Storage</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">T</span></span></span><span class="hljs-class">&gt; </span></span>{ <span class="hljs-function"><span class="hljs-function">T </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">get</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">dispose</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(T object)</span></span></span></span>; } <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">IntPair</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AutoCloseable</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Storage&lt;IntPair&gt; STORAGE = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> StorageImpl(IntPair::<span class="hljs-keyword"><span class="hljs-keyword">new</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> x; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> y; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">IntPair</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{} <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> IntPair </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">create</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> STORAGE.get(); } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">close</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ STORAGE.dispose(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>); } }</code> </pre> <br><p>  El m√©todo de divisi√≥n podr√≠a verse as√≠: </p><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-function">IntPair </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">divide</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> value, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> divisor)</span></span></span><span class="hljs-function"> </span></span>{ IntPair result = IntPair.create(); result.x = value / divisor; result.y = value % divisor; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> result; }</code> </pre> <br><p>  Y el m√©todo <code>listenSocket</code> as√≠: </p><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">listenSocket</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> IOException </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> value = in.read(); <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> divisor = in.read(); <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> (IntPair pair = divide(value, divisor)) { out.print(pair.x); out.print(pair.y); } } }</code> </pre> <br><p>  En el IDE, generalmente puede configurar el resaltado de todos los casos cuando los objetos <code>AutoCloseable</code> se usan fuera del bloque de prueba con recursos.  Pero esta no es una opci√≥n absoluta, porque  resaltar en el IDE solo se puede desactivar.  Por lo tanto, hay otra forma de garantizar el retorno del objeto al grupo: la inversi√≥n de control.  Dar√© un ejemplo: </p><br><pre> <code class="java hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">IntPair</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AutoCloseable</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Storage&lt;IntPair&gt; STORAGE = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> StorageImpl(IntPair::<span class="hljs-keyword"><span class="hljs-keyword">new</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> x; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> y; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">IntPair</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{} <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">apply</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Consumer&lt;IntPair&gt; consumer)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">try</span></span>(IntPair pair = STORAGE.get()) { consumer.accept(pair); } } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">close</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ STORAGE.dispose(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>); } }</code> </pre> <br><p>  En este caso, b√°sicamente no podemos acceder al objeto de la clase <code>IntPair</code> exterior.  Desafortunadamente, este m√©todo tampoco siempre funciona.  Por ejemplo, no funcionar√° si un hilo obtiene objetos del grupo y lo pone en una cola, y otro hilo los saca de la cola y regresa al grupo. </p><br><p>  Obviamente, si no almacenamos objetos gen√©ricos en el grupo, pero algunos objetos de la biblioteca que no implementan <code>AutoCloseable</code> , la opci√≥n de prueba con recursos tampoco funcionar√°. </p><br><p>  Un problema adicional aqu√≠ es multihilo.  La implementaci√≥n del conjunto de objetos debe ser muy r√°pida, lo cual es bastante dif√≠cil de lograr.  Un grupo lento puede hacer m√°s da√±o al rendimiento que bien.  A su vez, la asignaci√≥n de nuevos objetos en TLAB es muy r√°pida, mucho m√°s r√°pida que malloc en C. Escribir un grupo de objetos r√°pido es un tema separado que no quisiera desarrollar ahora.  Solo puedo decir que no he visto ninguna buena implementaci√≥n "lista para usar". </p><br><h2>  En lugar de una conclusi√≥n </h2><br><p>  En resumen, reutilizar objetos con piscinas de objetos son hemorroides graves.  Afortunadamente, casi siempre puedes prescindir de √©l.  Mi experiencia personal es que el uso excesivo de grupos de objetos se√±ala problemas con la arquitectura de la aplicaci√≥n.  Como regla, una instancia del objeto almacenado en cach√© en el campo <code>final</code> es suficiente para nosotros.  Pero incluso esto es excesivo si es posible usar tipos primitivos. </p><br><h2>  Actualizaci√≥n: </h2><br><p>  S√≠, record√© otra manera para aquellos que no tienen miedo a los cambios bit a bit: empaquetar varios tipos primitivos peque√±os en uno grande.  Supongamos que necesitamos devolver dos <code>int</code> .  En este caso particular, no puede usar el objeto <code>IntPair</code> , pero devuelve uno <code>long</code> , los primeros 4 bytes en los que corresponder√°n al primer <code>int</code> 'y, y los segundos 4 bytes al segundo.  El c√≥digo podr√≠a verse as√≠: </p><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">long</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">combine</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> left, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> right)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ((<span class="hljs-keyword"><span class="hljs-keyword">long</span></span>)left &lt;&lt; Integer.SIZE) | (<span class="hljs-keyword"><span class="hljs-keyword">long</span></span>)right &amp; <span class="hljs-number"><span class="hljs-number">0xFFFFFFFFL</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getLeft</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">long</span></span></span></span><span class="hljs-function"><span class="hljs-params"> value)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>)(value &gt;&gt;&gt; Integer.SIZE); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getRight</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">long</span></span></span></span><span class="hljs-function"><span class="hljs-params"> value)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>)value; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">long</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">divide</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> value, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> divisor)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> x = value / divisor; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> y = value % divisor; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> combine(left, right); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">listenSocket</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> IOException </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> value = in.read(); <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> divisor = in.read(); <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> xy = divide(value, divisor); out.print(getLeft(xy)); out.print(getRight(xy)); } }</code> </pre> <br><p>  Tales m√©todos, por supuesto, deben probarse a fondo, porque es bastante f√°cil escribirlos.  Pero entonces solo √∫salo. </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/es436024/">https://habr.com/ru/post/es436024/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../es436012/index.html">Soy un idiota in√∫til, as√≠ que quiero dejar mi trabajo: 10 preguntas para un desarrollador de software, un episodio piloto</a></li>
<li><a href="../es436014/index.html">Modelos matem√°ticos del caos</a></li>
<li><a href="../es436016/index.html">Asterisk Voice Recognition IVR - R√°pido, F√°cil, Gratis</a></li>
<li><a href="../es436020/index.html">Magento 2: importaci√≥n de productos de fuentes externas</a></li>
<li><a href="../es436022/index.html">C√≥mo desarrollamos LibreK 5 DevKit completamente en software libre</a></li>
<li><a href="../es436026/index.html">Mesa de informaci√≥n: "Archivo de Internet" - historia, misi√≥n y proyectos subsidiarios</a></li>
<li><a href="../es436028/index.html">Una introducci√≥n a Kubernetes para usuarios de VMware. Parte 1. Teor√≠a</a></li>
<li><a href="../es436032/index.html">Tutorial React Parte 9: Propiedades del componente</a></li>
<li><a href="../es436036/index.html">¬øPueden los investigadores de inteligencia artificial confiarle una prueba de su trabajo?</a></li>
<li><a href="../es436038/index.html">El sonido del silencio: ¬øcu√°ntos aparatos locos son necesarios para lograr un entorno √≥ptimo para dormir?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>