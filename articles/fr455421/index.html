<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ü§§ üîç üêª D√©composition d'une UICollectionViewCell üëàüèª üëø üçû</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Apr√®s avoir regard√© Keynote WWDC 2019 et appris √† conna√Ætre SwiftUI , qui est con√ßu pour d√©crire de mani√®re d√©clarative les interfaces utilisateur dan...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>D√©composition d'une UICollectionViewCell</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/455421/"><p>  Apr√®s avoir regard√© Keynote WWDC 2019 et <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">appris</a> √† <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">conna√Ætre SwiftUI</a> , qui est con√ßu pour d√©crire de mani√®re d√©clarative les interfaces utilisateur dans le code, je veux sp√©culer sur la fa√ßon de remplir de mani√®re d√©clarative des plaques et des collections.  Par exemple, comme ceci: </p><br><pre><code class="swift hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">enum</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Builder</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">widgets</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(objects: Objects)</span></span></span></span> -&gt; [<span class="hljs-type"><span class="hljs-type">Widget</span></span>] { <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> header = [ <span class="hljs-type"><span class="hljs-type">Spacing</span></span>(height: <span class="hljs-number"><span class="hljs-number">25</span></span>).widget, <span class="hljs-type"><span class="hljs-type">Header</span></span>(string: <span class="hljs-string"><span class="hljs-string">" "</span></span>).widget, <span class="hljs-type"><span class="hljs-type">Spacing</span></span>(height: <span class="hljs-number"><span class="hljs-number">10</span></span>, separator: .bottom).widget ] <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> body = objects .flatMap({ (object: <span class="hljs-type"><span class="hljs-type">Object</span></span>) -&gt; [<span class="hljs-type"><span class="hljs-type">Widgets</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> [ <span class="hljs-type"><span class="hljs-type">Title</span></span>(object: object).widget, <span class="hljs-type"><span class="hljs-type">Spacing</span></span>(height: <span class="hljs-number"><span class="hljs-number">1</span></span>, separator: .bottom).widget ] }) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> header + body } } <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> objects: [<span class="hljs-type"><span class="hljs-type">Object</span></span>] = ... <span class="hljs-type"><span class="hljs-type">Builder</span></span> .widgets(objects: objects) .bind(to: collectionView)</code> </pre> <br><p>  Dans la collection, ceci est rendu comme suit: <a name="habracut"></a></p><div style="text-align:center;"><img src="https://habrastorage.org/webt/el/r0/bp/elr0bpuqgbgcm5unfprets9_woc.png" alt="image"></div><p></p><br><h1 id="vvedenie">  Pr√©sentation </h1><br><p>  Comme vous le savez de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">sources faisant autorit√©</a> : la grande majorit√© de leur temps, un d√©veloppeur iOS typique passe √† travailler avec des tablettes.  Si nous supposons que les d√©veloppeurs du projet manquent cruellement et que les tablettes ne sont pas simples, alors il ne reste absolument plus de temps pour le reste de l'application.  Et quelque chose doit √™tre fait avec cela ... Une solution possible serait la d√©composition des cellules. </p><br><p>  La d√©composition cellulaire signifie remplacer une cellule par plusieurs cellules plus petites.  Avec ce remplacement, visuellement, rien ne devrait changer.  Par exemple, consid√©rons les publications du flux d'actualit√©s VK pour iOS.  Un message peut √™tre pr√©sent√© √† la fois comme une seule cellule ou comme un groupe de cellules - les <strong>primitives</strong> . </p><br><p>  Les cellules en d√©composition ne fonctionneront pas toujours.  Il sera difficile de diviser une cellule en primitives qui ont une ombre ou un arrondi de tous les c√¥t√©s.  Dans ce cas, la cellule d'origine sera une primitive. </p><br><h1 id="plyusy-i-minusy">  Avantages et inconv√©nients </h1><br><p>  En utilisant la d√©composition des cellules, les tableaux / collections commencent √† se composer de primitives qui seront souvent r√©utilis√©es: une primitive avec du texte, une primitive avec une image, une primitive avec un fond, etc.  Le calcul de la hauteur d'une primitive unique est beaucoup plus simple et plus efficace qu'une cellule complexe avec un grand nombre d'√©tats.  Si vous le souhaitez, la hauteur dynamique de la primitive peut √™tre calcul√©e ou m√™me dessin√©e en arri√®re-plan (par exemple, du texte via <code>CTFramesetter</code> ). </p><br><p>  D'un autre c√¥t√©, travailler avec des donn√©es devient plus compliqu√©.  Des donn√©es seront n√©cessaires pour chaque primitive, et selon l' <code>IndexPath</code> primitive, il sera difficile de d√©terminer √† quelle cellule r√©elle elle appartient.  Nous devrons introduire de nouvelles couches d'abstraction ou r√©soudre en quelque sorte ces probl√®mes. </p><br><p>  Vous pouvez parler longtemps des avantages et des inconv√©nients possibles de cette entreprise, mais il vaut mieux essayer de d√©crire l'approche de la d√©composition cellulaire. </p><br><h1 id="vybiraem-instrumenty">  Choisir des outils </h1><br><p>  √âtant donn√© que <code>UITableView</code> limit√© dans ses capacit√©s et, comme d√©j√† mentionn√©, nous avons des plaques plut√¥t complexes, une solution appropri√©e serait d'utiliser <code>UICollectionView</code> .  Il s'agit d' <code>UICollectionView</code> qui sera abord√© dans cette publication. </p><br><p>  En utilisant <code>UICollectionView</code> confront√© √† une situation o√π la base <code>UICollectionViewFlowLayout</code> ne peut pas former la disposition souhait√©e des √©l√©ments de la collection (nous ne prenons pas en compte la nouvelle <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><code>UICollectionViewCompositionalLayout</code></a> ).  √Ä de tels moments, la d√©cision est g√©n√©ralement prise de trouver un <code>UICollectionViewLayout</code> open source.  Mais m√™me parmi les solutions toutes faites, il peut ne pas y avoir de solution appropri√©e, comme, par exemple, dans le cas de la page principale dynamique d'une grande boutique en ligne ou d'un r√©seau social.  Nous supposons le pire, nous allons donc cr√©er notre propre <code>UICollectionViewLayout</code> universel. </p><br><p>  En plus de la difficult√© de choisir une mise en page, vous devez d√©cider comment la collection recevra les donn√©es.  En plus de l'approche habituelle, lorsqu'un objet (le plus souvent un <code>UIViewController</code> ) est conforme au protocole <code>UICollectionViewDataSource</code> et fournit des donn√©es pour une collection, l'utilisation de frameworks pilot√©s par les donn√©es gagne en popularit√©.  Les brillants repr√©sentants de cette approche sont <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">CollectionKit</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">IGListKit</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">RxDataSources</a> et autres.  L'utilisation de tels cadres simplifie le travail avec les collections et offre la possibilit√© d'animer les modifications de donn√©es, car  L'algorithme diff√©rent est d√©j√† pr√©sent dans le framework.  √Ä des fins de publication, le cadre <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">RxDataSources</a> sera s√©lectionn√©. </p><br><h1 id="vidzhet-i-ego-svoystva">  Widget et ses propri√©t√©s </h1><br><p>  Nous introduisons une structure de donn√©es interm√©diaire et appelons cela un <strong>widget</strong> .  Nous d√©crivons les principales propri√©t√©s qu'un widget devrait avoir: </p><br><ol><li>  Le widget doit respecter les protocoles n√©cessaires pour utiliser le framework pilot√© par les donn√©es.  Ces protocoles contiennent g√©n√©ralement une valeur associ√©e (par exemple, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><code>IdentifiableType</code></a> dans <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">RxDataSources</a> ) </li><li>  Il devrait √™tre possible d'assembler des widgets pour diff√©rentes primitives dans un tableau.  Pour ce faire, le widget ne doit pas avoir de valeurs associ√©es.  √Ä ces fins, vous pouvez utiliser le m√©canisme d'effacement de type ou quelque chose comme √ßa. </li><li>  Le widget doit pouvoir compter la taille de la primitive.  Ensuite, lors de la formation de l' <code>UICollectionViewLayout</code> , il ne reste plus qu'√† positionner correctement les primitives selon des r√®gles pr√©d√©finies. </li><li>  Le widget doit √™tre la fabrique de l' <code>UICollectionViewCell</code> .  Par cons√©quent, √† partir de l'impl√©mentation de <code>UICollectionViewDataSource</code> toute la logique de cr√©ation de cellules sera supprim√©e et il ne restera plus que: <br><pre> <code class="plaintext hljs">let cell = widget.widgetCell(collectionView: collectionView, indexPath: indexPath) return cell</code> </pre> </li></ol><br><h1 id="realizaciya-vidzheta">  Impl√©mentation du widget </h1><br><p>  Afin de pouvoir utiliser le widget avec le framework <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">RxDataSources</a> , il <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">doit respecter les protocoles</a> <code>Equatable</code> et <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><code>IdentifiableType</code></a> .  √âtant donn√© que le widget repr√©sente une primitive, il suffira √† des fins de publication si le widget s'identifie pour se conformer au protocole <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><code>IdentifiableType</code></a> .  En pratique, cela affectera le fait que lorsque le widget change, la primitive ne sera pas recharg√©e, mais supprim√©e et ins√©r√©e.  Pour ce faire, introduisez le nouveau protocole <code>WidgetIdentifiable</code> : </p><br><pre> <code class="swift hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">protocol</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WidgetIdentifiable</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">IdentifiableType</span></span></span><span class="hljs-class"> </span></span>{ } <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extension</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WidgetIdentifiable</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> identity: <span class="hljs-type"><span class="hljs-type">Self</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">self</span></span> } }</code> </pre> <br><p>  Pour se conformer au <code>WidgetIdentifiable</code> , le widget doit se conformer au protocole <code>Hashable</code> .  <code>Hashable</code> widget <code>Hashable</code> prendra les donn√©es pour la conformit√© au protocole de l'objet qui d√©crira une primitive particuli√®re.  Vous pouvez utiliser <code>AnyHashable</code> pour "effacer" le widget de type d'objet. </p><br><pre> <code class="swift hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Widget</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WidgetIdentifiable</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> underlying: <span class="hljs-type"><span class="hljs-type">AnyHashable</span></span> <span class="hljs-keyword"><span class="hljs-keyword">init</span></span>(<span class="hljs-number"><span class="hljs-number">_</span></span> underlying: <span class="hljs-type"><span class="hljs-type">AnyHashable</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.underlying = underlying } } <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extension</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Widget</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Hashable</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">hash</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(into hasher: </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">inout</span></span></span></span><span class="hljs-function"><span class="hljs-params"> Hasher)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.underlying.hash(into: &amp;hasher) } <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> ==</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(lhs: Widget, rhs: Widget)</span></span></span></span> -&gt; <span class="hljs-type"><span class="hljs-type">Bool</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> lhs.underlying == rhs.underlying } }</code> </pre> <br><p>  √Ä ce stade, les deux premi√®res propri√©t√©s du widget sont ex√©cut√©es.  Ce n'est pas difficile √† v√©rifier en collectant plusieurs widgets avec diff√©rents types d'objets dans un tableau. </p><br><pre> <code class="swift hljs"><span class="hljs-keyword"><span class="hljs-keyword">let</span></span> widgets = [<span class="hljs-type"><span class="hljs-type">Widget</span></span>(<span class="hljs-string"><span class="hljs-string">"Hello world"</span></span>), <span class="hljs-type"><span class="hljs-type">Widget</span></span>(<span class="hljs-number"><span class="hljs-number">100500</span></span>)]</code> </pre> <br><p>  Pour impl√©menter les propri√©t√©s restantes, nous introduisons un nouveau protocole <code>WidgetPresentable</code> </p><br><pre> <code class="swift hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">protocol</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WidgetPresentable</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">widgetCell</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(collectionView: UICollectionView, indexPath: IndexPath)</span></span></span></span> -&gt; <span class="hljs-type"><span class="hljs-type">UICollectionViewCell</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">widgetSize</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(containerWidth: CGFloat)</span></span></span></span> -&gt; <span class="hljs-type"><span class="hljs-type">CGSize</span></span> }</code> </pre> <br><p>  La fonction <code>widgetSize(containerWidth:)</code> sera utilis√©e dans <code>UICollectionViewLayout</code> lors de la g√©n√©ration des attributs des cellules, et <code>widgetCell(collectionView:indexPath:)</code> - pour obtenir les cellules. </p><br><p>  Si le widget <code>WidgetPresentable</code> protocole <code>WidgetPresentable</code> , le widget remplira toutes les propri√©t√©s indiqu√©es au d√©but de la publication.  Cependant, l'objet contenu dans le widget AnyHashable devra √™tre remplac√© par la composition <code>WidgetPresentable</code> et <code>WidgetHashable</code> , o√π <code>WidgetHashable</code> n'aura pas de valeur associ√©e (comme dans le cas de <code>Hashable</code> ) et le type de l'objet √† l'int√©rieur du widget restera "effac√©": </p><br><pre> <code class="swift hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">protocol</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WidgetHashable</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">widgetEqual</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">_</span></span></span></span><span class="hljs-function"><span class="hljs-params"> any: </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">Any</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span> -&gt; <span class="hljs-type"><span class="hljs-type">Bool</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">widgetHash</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(into hasher: </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">inout</span></span></span></span><span class="hljs-function"><span class="hljs-params"> Hasher)</span></span></span></span> }</code> </pre> <br><p>  Dans la version finale, le widget ressemblera √† ceci: </p><br><pre> <code class="swift hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Widget</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WidgetIdentifiable</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> underlying: <span class="hljs-type"><span class="hljs-type">WidgetHashable</span></span> &amp; <span class="hljs-type"><span class="hljs-type">WidgetPresentable</span></span> <span class="hljs-keyword"><span class="hljs-keyword">init</span></span>(<span class="hljs-number"><span class="hljs-number">_</span></span> underlying: <span class="hljs-type"><span class="hljs-type">WidgetHashable</span></span> &amp; <span class="hljs-type"><span class="hljs-type">WidgetPresentable</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.underlying = underlying } } <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extension</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Widget</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Hashable</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">hash</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(into hasher: </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">inout</span></span></span></span><span class="hljs-function"><span class="hljs-params"> Hasher)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.underlying.widgetHash(into: &amp;hasher) } <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> ==</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(lhs: Widget, rhs: Widget)</span></span></span></span> -&gt; <span class="hljs-type"><span class="hljs-type">Bool</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> lhs.underlying.widgetEqual(rhs.underlying) } } <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extension</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Widget</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WidgetPresentable</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">widgetCell</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(collectionView: UICollectionView, indexPath: IndexPath)</span></span></span></span> -&gt; <span class="hljs-type"><span class="hljs-type">UICollectionViewCell</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> underlying.widgetCell(collectionView: collectionView, indexPath: indexPath) } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">widgetSize</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(containerWidth: CGFloat)</span></span></span></span> -&gt; <span class="hljs-type"><span class="hljs-type">CGSize</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> underlying.widgetSize(containerWidth: containerWidth) } }</code> </pre> <br><h1 id="obekt-primitiva">  Objet primitif </h1><br><p>  Essayons d'assembler la primitive la plus simple, qui sera l'indentation d'une hauteur donn√©e. </p><br><pre> <code class="swift hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Spacing</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Hashable</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> height: <span class="hljs-type"><span class="hljs-type">CGFloat</span></span> } <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SpacingView</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">UIView</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-built_in"><span class="hljs-built_in">lazy</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> constraint = <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.heightAnchor.constraint(equalToConstant: <span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">init</span></span>() { <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">init</span></span>(frame: .zero) <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.constraint.isActive = <span class="hljs-literal"><span class="hljs-literal">true</span></span> } } <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extension</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Spacing</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WidgetHashable</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">widgetEqual</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">_</span></span></span></span><span class="hljs-function"><span class="hljs-params"> any: </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">Any</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span> -&gt; <span class="hljs-type"><span class="hljs-type">Bool</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> spacing = any <span class="hljs-keyword"><span class="hljs-keyword">as</span></span>? <span class="hljs-type"><span class="hljs-type">Spacing</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">self</span></span> == spacing } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span> } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">widgetHash</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(into hasher: </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">inout</span></span></span></span><span class="hljs-function"><span class="hljs-params"> Hasher)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.hash(into: &amp;hasher) } } <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extension</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Spacing</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WidgetPresentable</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">widgetCell</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(collectionView: UICollectionView, indexPath: IndexPath)</span></span></span></span> -&gt; <span class="hljs-type"><span class="hljs-type">UICollectionViewCell</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> cell: <span class="hljs-type"><span class="hljs-type">WidgetCell</span></span>&lt;<span class="hljs-type"><span class="hljs-type">SpacingView</span></span>&gt; = collectionView.cellDequeueSafely(indexPath: indexPath) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> cell.view == <span class="hljs-literal"><span class="hljs-literal">nil</span></span> { cell.view = <span class="hljs-type"><span class="hljs-type">SpacingView</span></span>() } cell.view?.constraint.constant = height <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> cell } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">widgetSize</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(containerWidth: CGFloat)</span></span></span></span> -&gt; <span class="hljs-type"><span class="hljs-type">CGSize</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-type"><span class="hljs-type">CGSize</span></span>(width: containerWidth, height: height) } }</code> </pre> <br><p>  <code>WidgetCell&lt;T&gt;</code> n'est qu'une sous-classe de <code>UICollectionViewCell</code> qui accepte une <code>UIView</code> et l'ajoute en tant que sous-vue.  <code>cellDequeueSafely(indexPath:)</code> est une fonction qui enregistre une cellule dans une collection avant r√©utilisation si une cellule de la collection n'a pas √©t√© pr√©c√©demment enregistr√©e.  <code>Spacing</code> sera utilis√© comme d√©crit au tout d√©but de la publication. </p><br><p>  Apr√®s avoir re√ßu le tableau de widgets, il ne reste plus qu'√† se lier √† <code>observerWidgets</code> : </p><br><pre> <code class="swift hljs"><span class="hljs-keyword"><span class="hljs-keyword">typealias</span></span> <span class="hljs-type"><span class="hljs-type">DataSource</span></span> = <span class="hljs-type"><span class="hljs-type">RxCollectionViewSectionedAnimatedDataSource</span></span>&lt;<span class="hljs-type"><span class="hljs-type">WidgetSection</span></span>&gt; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Controller</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">UIViewController</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-built_in"><span class="hljs-built_in">lazy</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> dataSource: <span class="hljs-type"><span class="hljs-type">DataSource</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.makeDataSource() <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> observerWidgets: (<span class="hljs-type"><span class="hljs-type">Observable</span></span>&lt;<span class="hljs-type"><span class="hljs-type">Widgets</span></span>&gt;) -&gt; <span class="hljs-type"><span class="hljs-type">Disposable</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> collectionView.rx.items(dataSource: dataSource) } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">makeDataSource</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> -&gt; <span class="hljs-type"><span class="hljs-type">DataSource</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-type"><span class="hljs-type">DataSource</span></span>(configureCell: { (<span class="hljs-number"><span class="hljs-number">_</span></span>, collectionView: <span class="hljs-type"><span class="hljs-type">UICollectionView</span></span>, indexPath: <span class="hljs-type"><span class="hljs-type">IndexPath</span></span>, widget: <span class="hljs-type"><span class="hljs-type">Widget</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> cell = widget.widgetCell(collectionView: collectionView, indexPath: indexPath) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> cell }) } }</code> </pre> <br><h1 id="rezultaty">  R√©sultats </h1><br><p>  En conclusion, je voudrais montrer le vrai travail de la collection, qui est enti√®rement construite sur des widgets. </p><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/_t/od/tz/_todtzto-dqfqf1nwto9pik694c.gif" alt="image"></div><br><p>  Comme vous pouvez le voir, la d√©composition de <code>UICollectionViewCell</code> possible et dans des situations appropri√©es peut simplifier la vie du d√©veloppeur. </p><br><h1 id="zamechaniya">  Remarques </h1><br><p>  Le code donn√© dans la publication est tr√®s simplifi√© et ne doit pas √™tre compil√©.  Le but √©tait de d√©crire l'approche, pas de fournir une solution cl√© en main. </p><br><p>  Le protocole <code>WidgetPresentable</code> peut √™tre √©tendu avec d'autres fonctions qui optimisent la disposition, par exemple, <code>widgetSizeEstimated(containerWidth:)</code> ou <code>widgetSizePredefined(containerWidth:)</code> , qui renvoient respectivement la taille estim√©e et fixe.  Il convient de noter que la fonction <code>widgetSize(containerWidth:)</code> doit renvoyer la taille de la primitive m√™me pour des calculs exigeants, par exemple, pour <code>systemLayoutSizeFitting(_:)</code> .  Ces calculs peuvent √™tre mis en cache via <code>Dictionary</code> , <code>NSCache</code> , etc. </p><br><p>  Comme vous le savez, tous les types de cellules utilis√©s par <code>UICollectionView</code> doivent √™tre pr√©-enregistr√©s dans la collection.  Cependant, afin de r√©utiliser des widgets entre diff√©rents √©crans / collections et de ne pas enregistrer tous les identifiants / types de cellules √† l'avance, vous devez acqu√©rir un m√©canisme qui enregistrera une cellule imm√©diatement avant sa premi√®re utilisation dans chaque collection.  Dans la publication, la fonction <code>cellDequeueSafely(indexPath:)</code> utilis√©e pour cela. </p><br><p>  Il ne peut y avoir aucun en-t√™te ou pied de page dans la collection.  √Ä leur place seront des primitifs.  La pr√©sence de suppl√©ment dans la collection ne donnera aucun bonus sp√©cial dans l'approche actuelle.  Ils sont g√©n√©ralement utilis√©s lorsque le tableau de donn√©es correspond strictement au nombre de cellules et qu'il est n√©cessaire d'afficher des vues suppl√©mentaires avant, apr√®s ou entre les cellules.  Dans notre cas, les donn√©es des vues auxiliaires peuvent √©galement √™tre ajout√©es au tableau de widgets et dessin√©es en tant que primitives. </p><br><p>  Dans la m√™me collection, des widgets avec les m√™mes objets peuvent √™tre localis√©s.  Par exemple, le m√™me <code>Spacing</code> au d√©but et √† la fin de la collection.  La pr√©sence de tels objets non uniques entra√Ænera la disparition de l'animation dans la collection.  Pour rendre ces objets uniques, vous pouvez utiliser des balises <code>AnyHashable</code> sp√©ciales, <code>#file</code> et <code>#line</code> o√π l'objet a √©t√© cr√©√©, etc. </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr455421/">https://habr.com/ru/post/fr455421/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr455407/index.html">Voitures √©lectriques et pointe des ventes de voitures √† essence</a></li>
<li><a href="../fr455409/index.html">Compatibilit√© descendante</a></li>
<li><a href="../fr455411/index.html">M√©gaphone a effectu√© une mise √† jour technique ... noms de r√©seau</a></li>
<li><a href="../fr455413/index.html">Transformez Pocket en un fil d'actualit√©s</a></li>
<li><a href="../fr455419/index.html">Apple Beta Alive: Anecdotes non r√©v√©l√©es lors de la pr√©sentation</a></li>
<li><a href="../fr455425/index.html">Cr√©ation d'un tunnel IPSec GRE entre Mikrotik hEX S et Juniper SRX via un modem USB</a></li>
<li><a href="../fr455427/index.html">Comment nous avons appris √† pr√©dire la demande d'un utilisateur et √† acc√©l√©rer le chargement des r√©sultats de recherche</a></li>
<li><a href="../fr455429/index.html">Comment Doom est arriv√© sur Super Nintendo</a></li>
<li><a href="../fr455439/index.html">Le nouvel algorithme cr√©√© par les scientifiques vous permet de cr√©er des "t√™tes parlantes" presque parfaites avec de vraies personnes</a></li>
<li><a href="../fr455441/index.html">21 juin, Moscou, Deworkacy - AnalyzeIT MeetUp # 2</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>