<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>📸 🤚🏿 👲 Moniteur d'air domestique compact (CO2, température, humidité, pression) avec Wi-Fi et une interface mobile 👂🏼 🚡 😽</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="CO2 Geektimes ( ). CO2, , Wi-Fi, . esp8266, CO2 MH-Z19 esp8266-arduino. , USB-:
 


 

C , . wifi , . http://192.168.4.1 , .
 


 

 Blynk.   Geektime...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Moniteur d'air domestique compact (CO2, température, humidité, pression) avec Wi-Fi et une interface mobile</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/400975/"><p><img src="https://habrastorage.org/files/8f2/11c/ce6/8f211cce6d61458182645930eacf3e07.jpg" alt="image"></p><br>
<p>  CO2     Geektimes     (   ).         CO2,   ,     Wi-Fi,         .      esp8266,  CO2 MH-Z19   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">esp8266-arduino</a>.  ,    USB-:</p><a name="habracut"></a><br>
<p><img src="https://habrastorage.org/files/7ca/47e/573/7ca47e573301423aafa5a88d72a264b5.gif" alt="image"></p><br>
<p>C           ,  .   wifi   ,           .        <code>http://192.168.4.1</code>     ,          .</p><br>
<p><img src="https://habrastorage.org/files/a35/2d3/48f/a352d348fbee4de0a8bf100d7e2f83b6.jpg" alt="image"></p><br>
<p>         <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Blynk</a>.    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="></a> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="></a>  Geektimes.  opensource ,                 .      ,   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">docker-</a>, a      .</p><br>
<p>  blynk          <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">iOS</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Android</a>. Web-,   .        ,    web hook    ( —   CO2),        .</p><br>
<p>Blynk       QR-,      .</p><br>
<div class="spoiler"><b class="spoiler_title">QR- ,   Blynk</b><div class="spoiler_text"><p><img src="https://habrastorage.org/files/0f4/019/00c/0f401900c0c8410fbf98a20afd98fe36.png" alt="image"></p></div></div><br>
<p><img src="https://habrastorage.org/files/dcf/2ff/775/dcf2ff7753c24ac3ba3da511d9776ac3.jpg" alt="image"></p><br>
<h2 id="kak-sobrat-podobnoe-ustroystvo">   ?</h2><br>
<p>      , ,  aliexpress.       ,       ,    ,  .</p><br>
<table>
<thead>
<tr>
<th></th>
<th> </th>
<th> </th>
</tr>
</thead>
<tbody>
<tr>
<td>Esp-12 NodeMCU *</td>
<td>esp8266 nodemcu cp2102</td>
<td>$3.50</td>
</tr>
<tr>
<td> CO2 mh-z19</td>
<td>mh-z19</td>
<td>$22</td>
</tr>
<tr>
<td> **,***</td>
<td>bmp280</td>
<td>$1</td>
</tr>
<tr>
<td>   **,***</td>
<td>gy-21 SI7021 i2c</td>
<td>$2.2</td>
</tr>
<tr>
<td></td>
<td>0.96" 128x64 i2c OLED blue</td>
<td>$2.7</td>
</tr>
<tr>
<td></td>
<td>dupont female-female 10cm</td>
<td>$1</td>
</tr>
<tr>
<td>3- </td>
<td>-</td>
<td>$8</td>
</tr>
<tr>
<td></td>
<td>:</td>
<td>$40.4</td>
</tr>
</tbody>
</table><br>
<p>* —        NodeMCU.      USB-UART  cp2102  ch340g,    —   ch340g   3        . ,   cp2102   ,            .<br>
** —     bmp-085,     .    bmp-280      ,   ,      <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">https://github.com/adafruit/Adafruit_BMP280_Library</a> —     .<br>
*** —    bmp280+si7021,    bme280,     : ,   .  aliexpress     $3.5</p><br>
<h3 id="korpus"></h3><br>
<p>        ,          .    Tinkercad  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="> </a>   3-.   tinkercad  ,         .     ,    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">openSCAD</a></p><br>
<p><img src="https://habrastorage.org/files/abb/90d/7a0/abb90d7a02ac4c4bb51954aee9d4b3b7.jpg" alt="image"></p><br>
<p>   ,               ,   .</p><br>
<p><img src="https://habrastorage.org/files/0ce/af6/674/0ceaf667471f4a4fa6f5522795e8b026.jpg" alt="image"></p><br>
<p>     ,      dc-dc      ~3    ,      .      ,      CO2 .</p><br>
<p>    ,    ,      .</p><br>
<h2 id="podklyuchenie"></h2><br>
<p>    —  ,         3.3      I2C.      : SDA     D1 (GPIO5),  SCL —   D2 (GPIO4)</p><br>
<p> CO2   5 (   Vin —   USB )    UART.     D7 (GPIO13) — RX (   TX )  D8 (GPIO15) — TX (   RX )</p><br>
<p><img src="https://habrastorage.org/files/2c1/09d/9e4/2c109d9e4cb846b4b64dc45a3e3d71b1.png" alt="image"></p><br>
<h2 id="programmnaya-chast"> </h2><br>
<p>        <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">PlatformIO</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">  Github-e</a>.</p><br>
<div class="spoiler"><b class="spoiler_title"> ,     Github</b><div class="spoiler_text"><pre><code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;FS.h&gt;</span></span></span></span>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;Arduino.h&gt;</span></span></span></span>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;ESP8266WiFi.h&gt;          //https://github.com/esp8266/Arduino</span></span></span></span><font></font>
<font></font>
<span class="hljs-comment"><span class="hljs-comment">// Wifi Manager</span></span>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;DNSServer.h&gt;</span></span></span></span>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;ESP8266WebServer.h&gt;</span></span></span></span>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;WiFiManager.h&gt;         //https://github.com/tzapu/WiFiManager</span></span></span></span><font></font>
<font></font>
<span class="hljs-comment"><span class="hljs-comment">// HTTP requests</span></span>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;ESP8266HTTPClient.h&gt;</span></span></span></span><font></font>
<font></font>
<span class="hljs-comment"><span class="hljs-comment">// OTA updates</span></span>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;ESP8266httpUpdate.h&gt;</span></span></span></span>
<span class="hljs-comment"><span class="hljs-comment">// Blynk</span></span>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;BlynkSimpleEsp8266.h&gt;</span></span></span></span><font></font>
<font></font>
<span class="hljs-comment"><span class="hljs-comment">// JSON</span></span>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;ArduinoJson.h&gt;          //https://github.com/bblanchon/ArduinoJson</span></span></span></span><font></font>
<font></font>
<span class="hljs-comment"><span class="hljs-comment">// GPIO Defines</span></span>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> I2C_SDA 5 </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">// D1 Orange</span></span></span></span>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> I2C_SCL 4 </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">// D2 Yellow</span></span></span></span><font></font>
<font></font>
<span class="hljs-comment"><span class="hljs-comment">// Humidity/Temperature SI7021</span></span>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;SI7021.h&gt;</span></span></span></span><font></font>
SI7021 si7021;<font></font>
<font></font>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;Wire.h&gt;</span></span></span></span><font></font>
<font></font>
<span class="hljs-comment"><span class="hljs-comment">// Pressure and Temperature</span></span>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;Adafruit_BMP085.h&gt;</span></span></span></span><font></font>
<font></font>
<span class="hljs-comment"><span class="hljs-comment">// Use U8g2 for i2c OLED Lib</span></span>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;SPI.h&gt;</span></span></span></span>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;U8g2lib.h&gt;</span></span></span></span>
<span class="hljs-function"><span class="hljs-function">U8G2_SSD1306_128X64_NONAME_F_SW_I2C </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">u8g2</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(U8G2_R0, I2C_SCL, I2C_SDA, U8X8_PIN_NONE)</span></span></span></span>;<font></font>
byte x {<span class="hljs-number"><span class="hljs-number">0</span></span>};<font></font>
byte y {<span class="hljs-number"><span class="hljs-number">0</span></span>};<font></font>
<font></font>
<span class="hljs-comment"><span class="hljs-comment">// Handy timers</span></span>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;SimpleTimer.h&gt;</span></span></span></span><font></font>
<font></font>
<span class="hljs-comment"><span class="hljs-comment">// CO2 SERIAL</span></span>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> DEBUG_SERIAL Serial1</span></span>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> SENSOR_SERIAL Serial</span></span><font></font>
<font></font>
byte cmd[<span class="hljs-number"><span class="hljs-number">9</span></span>] = {<span class="hljs-number"><span class="hljs-number">0xFF</span></span>,<span class="hljs-number"><span class="hljs-number">0x01</span></span>,<span class="hljs-number"><span class="hljs-number">0x86</span></span>,<span class="hljs-number"><span class="hljs-number">0x00</span></span>,<span class="hljs-number"><span class="hljs-number">0x00</span></span>,<span class="hljs-number"><span class="hljs-number">0x00</span></span>,<span class="hljs-number"><span class="hljs-number">0x00</span></span>,<span class="hljs-number"><span class="hljs-number">0x00</span></span>,<span class="hljs-number"><span class="hljs-number">0x79</span></span>};
<span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> response[<span class="hljs-number"><span class="hljs-number">7</span></span>];<font></font>
<font></font>
<span class="hljs-comment"><span class="hljs-comment">// Pressure and temperature</span></span><font></font>
Adafruit_BMP085 bme;<font></font>
<font></font>
<span class="hljs-comment"><span class="hljs-comment">// Blynk token</span></span>
<span class="hljs-keyword"><span class="hljs-keyword">char</span></span> blynk_token[<span class="hljs-number"><span class="hljs-number">33</span></span>] {<span class="hljs-string"><span class="hljs-string">"Blynk token"</span></span>};
<span class="hljs-keyword"><span class="hljs-keyword">char</span></span> blynk_server[<span class="hljs-number"><span class="hljs-number">64</span></span>] {<span class="hljs-string"><span class="hljs-string">"blynk-cloud.com"</span></span>};
<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">uint16_t</span></span> blynk_port {<span class="hljs-number"><span class="hljs-number">8442</span></span>};<font></font>
<font></font>
<span class="hljs-comment"><span class="hljs-comment">// Device Id</span></span>
<span class="hljs-keyword"><span class="hljs-keyword">char</span></span> device_id[<span class="hljs-number"><span class="hljs-number">17</span></span>] = <span class="hljs-string"><span class="hljs-string">"Device ID"</span></span>;
<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> fw_ver[<span class="hljs-number"><span class="hljs-number">17</span></span>] = <span class="hljs-string"><span class="hljs-string">"0.1.0"</span></span>;<font></font>
<font></font>
<span class="hljs-comment"><span class="hljs-comment">// Handy timer</span></span><font></font>
SimpleTimer timer;<font></font>
<font></font>
<span class="hljs-comment"><span class="hljs-comment">// Setup Wifi connection</span></span><font></font>
WiFiManager wifiManager;<font></font>
<font></font>
<span class="hljs-comment"><span class="hljs-comment">// Network credentials</span></span>
String ssid { <span class="hljs-string"><span class="hljs-string">"ku_"</span></span> +  String(ESP.getChipId())};<font></font>
String pass {<span class="hljs-string"><span class="hljs-string">"ku_"</span></span> + String(ESP.getFlashChipId()) };<font></font>
<font></font>
<span class="hljs-comment"><span class="hljs-comment">//flag for saving data</span></span>
<span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> shouldSaveConfig = <span class="hljs-literal"><span class="hljs-literal">false</span></span>;<font></font>
<font></font>
<span class="hljs-comment"><span class="hljs-comment">// Sensors data</span></span>
<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> t {<span class="hljs-number"><span class="hljs-number">-100</span></span>};
<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> p {<span class="hljs-number"><span class="hljs-number">-1</span></span>};
<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> h {<span class="hljs-number"><span class="hljs-number">-1</span></span>};
<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> co2 {<span class="hljs-number"><span class="hljs-number">-1</span></span>};<font></font>
<font></font>
<span class="hljs-keyword"><span class="hljs-keyword">char</span></span> loader[<span class="hljs-number"><span class="hljs-number">4</span></span>] {<span class="hljs-string"><span class="hljs-string">'.'</span></span>};<font></font>
<font></font>
<span class="hljs-comment"><span class="hljs-comment">//callback notifying the need to save config</span></span>
<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">saveConfigCallback</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{<font></font>
        DEBUG_SERIAL.println(<span class="hljs-string"><span class="hljs-string">"Should save config"</span></span>);<font></font>
        shouldSaveConfig = <span class="hljs-literal"><span class="hljs-literal">true</span></span>;<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">factoryReset</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{<font></font>
        wifiManager.resetSettings();<font></font>
        SPIFFS.format();<font></font>
        ESP.reset();<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">printString</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String str)</span></span></span><span class="hljs-function"> </span></span>{<font></font>
        DEBUG_SERIAL.println(str);<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">readCO2</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{
        <span class="hljs-comment"><span class="hljs-comment">// CO2</span></span>
        <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> header_found {<span class="hljs-literal"><span class="hljs-literal">false</span></span>};
        <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> tries {<span class="hljs-number"><span class="hljs-number">0</span></span>};<font></font>
<font></font>
        SENSOR_SERIAL.write(cmd, <span class="hljs-number"><span class="hljs-number">9</span></span>);
        <span class="hljs-built_in"><span class="hljs-built_in">memset</span></span>(response, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">7</span></span>);<font></font>
<font></font>
        <span class="hljs-comment"><span class="hljs-comment">// Looking for packet start</span></span>
        <span class="hljs-keyword"><span class="hljs-keyword">while</span></span>(SENSOR_SERIAL.available() &amp;&amp; (!header_found)) {
                <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(SENSOR_SERIAL.read() == <span class="hljs-number"><span class="hljs-number">0xff</span></span> ) {
                        <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(SENSOR_SERIAL.read() == <span class="hljs-number"><span class="hljs-number">0x86</span></span> ) header_found = <span class="hljs-literal"><span class="hljs-literal">true</span></span>;<font></font>
                }<font></font>
        }<font></font>
<font></font>
        <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (header_found) {<font></font>
                SENSOR_SERIAL.readBytes(response, <span class="hljs-number"><span class="hljs-number">7</span></span>);<font></font>
<font></font>
                byte crc = <span class="hljs-number"><span class="hljs-number">0x86</span></span>;
                <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">char</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; <span class="hljs-number"><span class="hljs-number">6</span></span>; i++) {<font></font>
                        crc+=response[i];<font></font>
                }<font></font>
                crc = <span class="hljs-number"><span class="hljs-number">0xff</span></span> - crc;<font></font>
                crc++;<font></font>
<font></font>
                <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( !(response[<span class="hljs-number"><span class="hljs-number">6</span></span>] == crc) ) {<font></font>
                        DEBUG_SERIAL.println(<span class="hljs-string"><span class="hljs-string">"CO2: CRC error: "</span></span> + String(crc) + <span class="hljs-string"><span class="hljs-string">" / "</span></span>+ String(response[<span class="hljs-number"><span class="hljs-number">6</span></span>]));<font></font>
                } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> {
                        <span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> responseHigh = (<span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span>) response[<span class="hljs-number"><span class="hljs-number">0</span></span>];
                        <span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> responseLow = (<span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span>) response[<span class="hljs-number"><span class="hljs-number">1</span></span>];
                        <span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> ppm = (<span class="hljs-number"><span class="hljs-number">256</span></span>*responseHigh) + responseLow;<font></font>
                        co2 = ppm;<font></font>
                        DEBUG_SERIAL.println(<span class="hljs-string"><span class="hljs-string">"CO2:"</span></span> + String(co2));<font></font>
                }<font></font>
        } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> {<font></font>
                DEBUG_SERIAL.println(<span class="hljs-string"><span class="hljs-string">"CO2: Header not found"</span></span>);<font></font>
        }<font></font>
<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sendMeasurements</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{
        <span class="hljs-comment"><span class="hljs-comment">// Read data</span></span>
        <span class="hljs-comment"><span class="hljs-comment">// Temperature</span></span>
        <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> tf = si7021.getCelsiusHundredths() / <span class="hljs-number"><span class="hljs-number">100.0</span></span>;
        <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> t2f =bme.readTemperature();<font></font>
        t = <span class="hljs-keyword"><span class="hljs-keyword">static_cast</span></span>&lt;<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>&gt;((tf + t2f) / <span class="hljs-number"><span class="hljs-number">2</span></span>);<font></font>
<font></font>
        <span class="hljs-comment"><span class="hljs-comment">// Humidity</span></span><font></font>
        h = si7021.getHumidityPercent();<font></font>
<font></font>
        <span class="hljs-comment"><span class="hljs-comment">// Pressure (in mmHg)</span></span>
        p = <span class="hljs-keyword"><span class="hljs-keyword">static_cast</span></span>&lt;<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>&gt;(bme.readPressure() * <span class="hljs-number"><span class="hljs-number">760.0</span></span> / <span class="hljs-number"><span class="hljs-number">101325</span></span>);<font></font>
<font></font>
        <span class="hljs-comment"><span class="hljs-comment">// CO2</span></span><font></font>
        readCO2();<font></font>
<font></font>
        <span class="hljs-comment"><span class="hljs-comment">// Send to server</span></span><font></font>
        Blynk.virtualWrite(V1, t);<font></font>
        Blynk.virtualWrite(V2, h);<font></font>
        Blynk.virtualWrite(V4, p);<font></font>
        Blynk.virtualWrite(V5, co2);<font></font>
<font></font>
        <span class="hljs-comment"><span class="hljs-comment">// Write to debug console</span></span>
        printString(<span class="hljs-string"><span class="hljs-string">"H: "</span></span> + String(h) + <span class="hljs-string"><span class="hljs-string">"%"</span></span>);<font></font>
        printString(<span class="hljs-string"><span class="hljs-string">"T: "</span></span> + String(t) + <span class="hljs-string"><span class="hljs-string">"C"</span></span>);<font></font>
        printString(<span class="hljs-string"><span class="hljs-string">"P: "</span></span> + String(p) + <span class="hljs-string"><span class="hljs-string">"mmHg"</span></span>);<font></font>
        printString(<span class="hljs-string"><span class="hljs-string">"CO2: "</span></span> + String(co2) + <span class="hljs-string"><span class="hljs-string">"ppm"</span></span>);<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">loading</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{
        <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> <span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> count {(millis() / <span class="hljs-number"><span class="hljs-number">500</span></span>) % <span class="hljs-number"><span class="hljs-number">4</span></span>};
        <span class="hljs-built_in"><span class="hljs-built_in">memset</span></span>(loader, <span class="hljs-string"><span class="hljs-string">'.'</span></span>, count);
        <span class="hljs-built_in"><span class="hljs-built_in">memset</span></span>(&amp;loader[count], <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>);<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">draw</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{<font></font>
        u8g2.clearBuffer();<font></font>
<font></font>
        <span class="hljs-comment"><span class="hljs-comment">// CO2</span></span>
        <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (co2 &gt; <span class="hljs-number"><span class="hljs-number">-1</span></span>) {
                <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> co2a [<span class="hljs-number"><span class="hljs-number">5</span></span>];
                <span class="hljs-built_in"><span class="hljs-built_in">sprintf</span></span> (co2a, <span class="hljs-string"><span class="hljs-string">"%i"</span></span>, co2);<font></font>
<font></font>
                u8g2.setFont(u8g2_font_inb19_mf);<font></font>
                x = (<span class="hljs-number"><span class="hljs-number">128</span></span> - u8g2.getStrWidth(co2a))/<span class="hljs-number"><span class="hljs-number">2</span></span>;<font></font>
                y = u8g2.getAscent() - u8g2.getDescent();<font></font>
                u8g2.drawStr(x, y, co2a);<font></font>
<font></font>
                <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> ppm[] {<span class="hljs-string"><span class="hljs-string">"ppm CO2"</span></span>};<font></font>
                u8g2.setFont(u8g2_font_6x12_mf);<font></font>
                x = (<span class="hljs-number"><span class="hljs-number">128</span></span> - u8g2.getStrWidth(ppm)) / <span class="hljs-number"><span class="hljs-number">2</span></span>;<font></font>
                y = y + <span class="hljs-number"><span class="hljs-number">2</span></span> + u8g2.getAscent() - u8g2.getDescent();<font></font>
                u8g2.drawStr(x, y, ppm);<font></font>
        } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> {<font></font>
                loading();<font></font>
                u8g2.setFont(u8g2_font_inb19_mf);<font></font>
                x = (<span class="hljs-number"><span class="hljs-number">128</span></span> - u8g2.getStrWidth(loader)) / <span class="hljs-number"><span class="hljs-number">2</span></span>;<font></font>
                y = u8g2.getAscent() - u8g2.getDescent();<font></font>
                u8g2.drawStr(x, y, loader);<font></font>
        }<font></font>
<font></font>
        <span class="hljs-comment"><span class="hljs-comment">// Cycle other meauserments</span></span>
        String measurement {<span class="hljs-string"><span class="hljs-string">"..."</span></span>};
        <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> degree {<span class="hljs-number"><span class="hljs-number">176</span></span>};<font></font>
<font></font>
        <span class="hljs-comment"><span class="hljs-comment">// Switch every 3 seconds</span></span>
        <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span>((millis() / <span class="hljs-number"><span class="hljs-number">3000</span></span>) % <span class="hljs-number"><span class="hljs-number">3</span></span>) {
        <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>:
                <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (t &gt; <span class="hljs-number"><span class="hljs-number">-100</span></span>) { measurement = <span class="hljs-string"><span class="hljs-string">"T: "</span></span> + String(t) + degree + <span class="hljs-string"><span class="hljs-string">"C"</span></span>; }
                <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>;
        <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>:
                <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (h &gt; <span class="hljs-number"><span class="hljs-number">-1</span></span>) { measurement = <span class="hljs-string"><span class="hljs-string">"H: "</span></span> + String(h) + <span class="hljs-string"><span class="hljs-string">"%"</span></span>; }
                <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>;
        <span class="hljs-keyword"><span class="hljs-keyword">default</span></span>:
                <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (p &gt; <span class="hljs-number"><span class="hljs-number">-1</span></span>) { measurement =  <span class="hljs-string"><span class="hljs-string">"P: "</span></span> + String(p) + <span class="hljs-string"><span class="hljs-string">" mmHg"</span></span>; }<font></font>
        }<font></font>
<font></font>
        <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> measurementa [<span class="hljs-number"><span class="hljs-number">12</span></span>];<font></font>
        measurement.toCharArray(measurementa, <span class="hljs-number"><span class="hljs-number">12</span></span>);<font></font>
<font></font>
        u8g2.setFont(u8g2_font_9x18_mf);<font></font>
        x = (<span class="hljs-number"><span class="hljs-number">128</span></span> - u8g2.getStrWidth(measurementa))/<span class="hljs-number"><span class="hljs-number">2</span></span>;<font></font>
        y = <span class="hljs-number"><span class="hljs-number">64</span></span> + u8g2.getDescent();<font></font>
        u8g2.drawStr(x, y, measurementa);<font></font>
<font></font>
        u8g2.sendBuffer();<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">drawBoot</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String msg = </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"Loading..."</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span></span>{<font></font>
        u8g2.clearBuffer();<font></font>
        u8g2.setFont(u8g2_font_9x18_mf);<font></font>
        x = (<span class="hljs-number"><span class="hljs-number">128</span></span> - u8g2.getStrWidth(msg.c_str())) / <span class="hljs-number"><span class="hljs-number">2</span></span>;<font></font>
        y = <span class="hljs-number"><span class="hljs-number">32</span></span> + u8g2.getAscent() / <span class="hljs-number"><span class="hljs-number">2</span></span>;<font></font>
        u8g2.drawStr(x, y, msg.c_str());<font></font>
        u8g2.sendBuffer();<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">drawConnectionDetails</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String ssid, String pass, String url)</span></span></span><span class="hljs-function"> </span></span>{<font></font>
        String msg {<span class="hljs-string"><span class="hljs-string">""</span></span>};<font></font>
        u8g2.clearBuffer();<font></font>
<font></font>
        msg = <span class="hljs-string"><span class="hljs-string">"Connect to WiFi:"</span></span>;<font></font>
        u8g2.setFont(u8g2_font_7x13_mf);<font></font>
        x = (<span class="hljs-number"><span class="hljs-number">128</span></span> - u8g2.getStrWidth(msg.c_str())) / <span class="hljs-number"><span class="hljs-number">2</span></span>;<font></font>
        y = u8g2.getAscent() - u8g2.getDescent();<font></font>
        u8g2.drawStr(x, y, msg.c_str());<font></font>
<font></font>
        msg = <span class="hljs-string"><span class="hljs-string">"net: "</span></span> + ssid;<font></font>
        x = (<span class="hljs-number"><span class="hljs-number">128</span></span> - u8g2.getStrWidth(msg.c_str())) / <span class="hljs-number"><span class="hljs-number">2</span></span>;<font></font>
        y = y + <span class="hljs-number"><span class="hljs-number">1</span></span> + u8g2.getAscent() - u8g2.getDescent();<font></font>
        u8g2.drawStr(x, y, msg.c_str());<font></font>
<font></font>
        msg = <span class="hljs-string"><span class="hljs-string">"pw: "</span></span>+ pass;<font></font>
        x = (<span class="hljs-number"><span class="hljs-number">128</span></span> - u8g2.getStrWidth(msg.c_str())) / <span class="hljs-number"><span class="hljs-number">2</span></span>;<font></font>
        y = y + <span class="hljs-number"><span class="hljs-number">1</span></span> + u8g2.getAscent() - u8g2.getDescent();<font></font>
        u8g2.drawStr(x, y, msg.c_str());<font></font>
<font></font>
        msg = <span class="hljs-string"><span class="hljs-string">"Open browser:"</span></span>;<font></font>
        x = (<span class="hljs-number"><span class="hljs-number">128</span></span> - u8g2.getStrWidth(msg.c_str())) / <span class="hljs-number"><span class="hljs-number">2</span></span>;<font></font>
        y = y + <span class="hljs-number"><span class="hljs-number">1</span></span> + u8g2.getAscent() - u8g2.getDescent();<font></font>
        u8g2.drawStr(x, y, msg.c_str());<font></font>
<font></font>
        <span class="hljs-comment"><span class="hljs-comment">// URL</span></span>
        <span class="hljs-comment"><span class="hljs-comment">// u8g2.setFont(u8g2_font_6x12_mf);</span></span>
        x = (<span class="hljs-number"><span class="hljs-number">128</span></span> - u8g2.getStrWidth(url.c_str())) / <span class="hljs-number"><span class="hljs-number">2</span></span>;<font></font>
        y = y + <span class="hljs-number"><span class="hljs-number">1</span></span> + u8g2.getAscent() - u8g2.getDescent();<font></font>
        u8g2.drawStr(x, y, url.c_str());<font></font>
<font></font>
        u8g2.sendBuffer();<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">loadConfig</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{<font></font>
        File configFile = SPIFFS.open(<span class="hljs-string"><span class="hljs-string">"/config.json"</span></span>, <span class="hljs-string"><span class="hljs-string">"r"</span></span>);
        <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!configFile) {<font></font>
                DEBUG_SERIAL.println(<span class="hljs-string"><span class="hljs-string">"Failed to open config file"</span></span>);
                <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>;<font></font>
        }<font></font>
<font></font>
        <span class="hljs-keyword"><span class="hljs-keyword">size_t</span></span> size = configFile.size();
        <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (size &gt; <span class="hljs-number"><span class="hljs-number">1024</span></span>) {<font></font>
                DEBUG_SERIAL.println(<span class="hljs-string"><span class="hljs-string">"Config file size is too large"</span></span>);
                <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>;<font></font>
        }<font></font>
<font></font>
        <span class="hljs-comment"><span class="hljs-comment">// Allocate a buffer to store contents of the file.</span></span>
        <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">unique_ptr</span></span>&lt;<span class="hljs-keyword"><span class="hljs-keyword">char</span></span>[]&gt; buf(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span>[size]);<font></font>
<font></font>
        <span class="hljs-comment"><span class="hljs-comment">// We don't use String here because ArduinoJson library requires the input</span></span>
        <span class="hljs-comment"><span class="hljs-comment">// buffer to be mutable. If you don't use ArduinoJson, you may as well</span></span>
        <span class="hljs-comment"><span class="hljs-comment">// use configFile.readString instead.</span></span><font></font>
        configFile.readBytes(buf.get(), size);<font></font>
<font></font>
        StaticJsonBuffer&lt;<span class="hljs-number"><span class="hljs-number">200</span></span>&gt; jsonBuffer;<font></font>
        JsonObject &amp;json = jsonBuffer.parseObject(buf.get());<font></font>
<font></font>
        <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!json.success()) {<font></font>
                DEBUG_SERIAL.println(<span class="hljs-string"><span class="hljs-string">"Failed to parse config file"</span></span>);
                <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>;<font></font>
        }<font></font>
<font></font>
        <span class="hljs-comment"><span class="hljs-comment">// Save parameters</span></span>
        <span class="hljs-built_in"><span class="hljs-built_in">strcpy</span></span>(device_id, json[<span class="hljs-string"><span class="hljs-string">"device_id"</span></span>]);
        <span class="hljs-built_in"><span class="hljs-built_in">strcpy</span></span>(blynk_token, json[<span class="hljs-string"><span class="hljs-string">"blynk_token"</span></span>]);<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">configModeCallback</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(WiFiManager *wifiManager)</span></span></span><span class="hljs-function"> </span></span>{<font></font>
        String url {<span class="hljs-string"><span class="hljs-string">"http://192.168.4.1"</span></span>};<font></font>
        printString(<span class="hljs-string"><span class="hljs-string">"Connect to WiFi:"</span></span>);<font></font>
        printString(<span class="hljs-string"><span class="hljs-string">"net: "</span></span> + ssid);<font></font>
        printString(<span class="hljs-string"><span class="hljs-string">"pw: "</span></span>+ pass);<font></font>
        printString(<span class="hljs-string"><span class="hljs-string">"Open browser:"</span></span>);<font></font>
        printString(url);<font></font>
        printString(<span class="hljs-string"><span class="hljs-string">"to setup device"</span></span>);<font></font>
<font></font>
        drawConnectionDetails(ssid, pass, url);<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setupWiFi</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{
        <span class="hljs-comment"><span class="hljs-comment">//set config save notify callback</span></span><font></font>
        wifiManager.setSaveConfigCallback(saveConfigCallback);<font></font>
<font></font>
        <span class="hljs-comment"><span class="hljs-comment">// Custom parameters</span></span>
        <span class="hljs-function"><span class="hljs-function">WiFiManagerParameter </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">custom_device_id</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"device_id"</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"Device name"</span></span></span></span><span class="hljs-function"><span class="hljs-params">, device_id, </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">16</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span>;
        <span class="hljs-function"><span class="hljs-function">WiFiManagerParameter </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">custom_blynk_server</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"blynk_server"</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"Blynk server"</span></span></span></span><span class="hljs-function"><span class="hljs-params">, blynk_server, </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">64</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span>;
        <span class="hljs-function"><span class="hljs-function">WiFiManagerParameter </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">custom_blynk_token</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"blynk_token"</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"Blynk token"</span></span></span></span><span class="hljs-function"><span class="hljs-params">, blynk_token, </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">34</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span>;<font></font>
        wifiManager.addParameter(&amp;custom_blynk_server);<font></font>
        wifiManager.addParameter(&amp;custom_blynk_token);<font></font>
        wifiManager.addParameter(&amp;custom_device_id);<font></font>
<font></font>
        <span class="hljs-comment"><span class="hljs-comment">// wifiManager.setTimeout(180);</span></span><font></font>
        wifiManager.setAPCallback(configModeCallback);<font></font>
<font></font>
        <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!wifiManager.autoConnect(ssid.c_str(), pass.c_str())) {<font></font>
                DEBUG_SERIAL.println(<span class="hljs-string"><span class="hljs-string">"failed to connect and hit timeout"</span></span>);<font></font>
        }<font></font>
<font></font>
        <span class="hljs-comment"><span class="hljs-comment">//save the custom parameters to FS</span></span>
        <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (shouldSaveConfig) {<font></font>
                DEBUG_SERIAL.println(<span class="hljs-string"><span class="hljs-string">"saving config"</span></span>);<font></font>
                DynamicJsonBuffer jsonBuffer;<font></font>
                JsonObject &amp;json = jsonBuffer.createObject();<font></font>
                json[<span class="hljs-string"><span class="hljs-string">"device_id"</span></span>] = custom_device_id.getValue();<font></font>
                json[<span class="hljs-string"><span class="hljs-string">"blynk_server"</span></span>] = custom_blynk_server.getValue();<font></font>
                json[<span class="hljs-string"><span class="hljs-string">"blynk_token"</span></span>] = custom_blynk_token.getValue();<font></font>
<font></font>
                File configFile = SPIFFS.open(<span class="hljs-string"><span class="hljs-string">"/config.json"</span></span>, <span class="hljs-string"><span class="hljs-string">"w"</span></span>);
                <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!configFile) {<font></font>
                        DEBUG_SERIAL.println(<span class="hljs-string"><span class="hljs-string">"failed to open config file for writing"</span></span>);<font></font>
                }<font></font>
<font></font>
                json.printTo(DEBUG_SERIAL);<font></font>
                json.printTo(configFile);<font></font>
                configFile.close();<font></font>
                <span class="hljs-comment"><span class="hljs-comment">//end save</span></span><font></font>
        }<font></font>
<font></font>
        <span class="hljs-comment"><span class="hljs-comment">//if you get here you have connected to the WiFi</span></span>
        DEBUG_SERIAL.println(<span class="hljs-string"><span class="hljs-string">"WiFi connected"</span></span>);<font></font>
<font></font>
        DEBUG_SERIAL.print(<span class="hljs-string"><span class="hljs-string">"IP address: "</span></span>);<font></font>
        DEBUG_SERIAL.println(WiFi.localIP());<font></font>
}<font></font>
<font></font>
<span class="hljs-comment"><span class="hljs-comment">// Virtual pin update FW</span></span><font></font>
BLYNK_WRITE(V22) {<font></font>
        <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (param.asInt() == <span class="hljs-number"><span class="hljs-number">1</span></span>) {<font></font>
                DEBUG_SERIAL.println(<span class="hljs-string"><span class="hljs-string">"Got a FW update request"</span></span>);<font></font>
<font></font>
                <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> full_version[<span class="hljs-number"><span class="hljs-number">34</span></span>] {<span class="hljs-string"><span class="hljs-string">""</span></span>};
                <span class="hljs-built_in"><span class="hljs-built_in">strcat</span></span>(full_version, device_id);
                <span class="hljs-built_in"><span class="hljs-built_in">strcat</span></span>(full_version, <span class="hljs-string"><span class="hljs-string">"::"</span></span>);
                <span class="hljs-built_in"><span class="hljs-built_in">strcat</span></span>(full_version, fw_ver);<font></font>
<font></font>
                t_httpUpdate_return ret = ESPhttpUpdate.update(<span class="hljs-string"><span class="hljs-string">"http://romfrom.space/get"</span></span>, full_version);
                <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> (ret) {
                <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> HTTP_UPDATE_FAILED:<font></font>
                        DEBUG_SERIAL.println(<span class="hljs-string"><span class="hljs-string">"[update] Update failed."</span></span>);
                        <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>;
                <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> HTTP_UPDATE_NO_UPDATES:<font></font>
                        DEBUG_SERIAL.println(<span class="hljs-string"><span class="hljs-string">"[update] Update no Update."</span></span>);
                        <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>;
                <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> HTTP_UPDATE_OK:<font></font>
                        DEBUG_SERIAL.println(<span class="hljs-string"><span class="hljs-string">"[update] Update ok."</span></span>);
                        <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>;<font></font>
                }<font></font>
<font></font>
        }<font></font>
}<font></font>
<font></font>
<span class="hljs-comment"><span class="hljs-comment">// Virtual pin reset settings</span></span><font></font>
BLYNK_WRITE(V23) {<font></font>
        factoryReset();<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setup</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{
        <span class="hljs-comment"><span class="hljs-comment">// Init serial ports</span></span>
        DEBUG_SERIAL.begin(<span class="hljs-number"><span class="hljs-number">115200</span></span>);<font></font>
<font></font>
        SENSOR_SERIAL.begin(<span class="hljs-number"><span class="hljs-number">9600</span></span>);<font></font>
        SENSOR_SERIAL.swap();  <span class="hljs-comment"><span class="hljs-comment">// GPIO15 (TX) and GPIO13 (RX)</span></span><font></font>
<font></font>
        <span class="hljs-comment"><span class="hljs-comment">// Init I2C interface</span></span><font></font>
        Wire.begin(I2C_SDA, I2C_SCL);<font></font>
<font></font>
        <span class="hljs-comment"><span class="hljs-comment">// Init display</span></span><font></font>
        u8g2.begin();<font></font>
        drawBoot();<font></font>
<font></font>
        <span class="hljs-comment"><span class="hljs-comment">// Init Humidity/Temperature sensor</span></span><font></font>
        si7021.begin(I2C_SDA, I2C_SCL);<font></font>
<font></font>
        <span class="hljs-comment"><span class="hljs-comment">// Init Pressure/Temperature sensor</span></span>
        <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!bme.begin()) {<font></font>
                DEBUG_SERIAL.println(<span class="hljs-string"><span class="hljs-string">"Could not find a valid BMP085 sensor, check wiring!"</span></span>);<font></font>
        }<font></font>
<font></font>
        <span class="hljs-comment"><span class="hljs-comment">// Init filesystem</span></span>
        <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!SPIFFS.begin()) {<font></font>
                DEBUG_SERIAL.println(<span class="hljs-string"><span class="hljs-string">"Failed to mount file system"</span></span>);<font></font>
                ESP.reset();<font></font>
        }<font></font>
<font></font>
        <span class="hljs-comment"><span class="hljs-comment">// Setup WiFi</span></span><font></font>
        setupWiFi();<font></font>
<font></font>
        <span class="hljs-comment"><span class="hljs-comment">// Load config</span></span><font></font>
        drawBoot();<font></font>
        <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!loadConfig()) {<font></font>
                DEBUG_SERIAL.println(<span class="hljs-string"><span class="hljs-string">"Failed to load config"</span></span>);<font></font>
                factoryReset();<font></font>
        } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> {<font></font>
                DEBUG_SERIAL.println(<span class="hljs-string"><span class="hljs-string">"Config loaded"</span></span>);<font></font>
        }<font></font>
<font></font>
        <span class="hljs-comment"><span class="hljs-comment">// Start blynk</span></span><font></font>
        Blynk.config(blynk_token, blynk_server, blynk_port);<font></font>
<font></font>
        <span class="hljs-comment"><span class="hljs-comment">// Setup a function to be called every 10 second</span></span>
        timer.setInterval(<span class="hljs-number"><span class="hljs-number">10000L</span></span>, sendMeasurements);<font></font>
<font></font>
        sendMeasurements();<font></font>
}<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">loop</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{<font></font>
        Blynk.run();<font></font>
        timer.run();<font></font>
        draw();<font></font>
}</code></pre></div></div><br>
<p>          :</p><br>
<ul>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">    WiFi   </a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">   </a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">    </a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">  </a></li>
</ul><br>
<p>   CO2        <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">datasheet</a>-.</p><br>
<h2 id="chto-mozhno-sdelat-luchshe">   ?</h2><br>
<p>     :<br>
1)      <br>
2)     —      <br>
3)    offline </p><br>
<p>   ?    ?  -   -        .</p><br>
<h2 id="suschestvuyuschie-stati-na-temu-na-geektimes">     Geektimes:</h2><br>
<ol>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">  CO2     MH-Z19</a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Présentation du capteur de CO2 infrarouge MH-Z19</font></font></a></li>
<li><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Compteur de CO2 Wi-Fi sur l'ESP8266 + K-30</font></font></a></li>
</ol></div>
      
    </div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr400975/">https://habr.com/ru/post/fr400975/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr400961/index.html">Comment les clients VPN Android espionnent les utilisateurs</a></li>
<li><a href="../fr400963/index.html">La beauté des images de jeu de rendu: un bref aperçu des outils + vidéo intéressante</a></li>
<li><a href="../fr400965/index.html">Софт ИИ обучается делать ИИ: учёные сообщают об успехах в самообучении искусственного интеллекта</a></li>
<li><a href="../fr400967/index.html">L'algorithme d'apprentissage en profondeur diagnostique le cancer de la peau pas pire qu'un dermatologue qualifié</a></li>
<li><a href="../fr400971/index.html">Evolution: de la vidéosurveillance analogique au numérique. Partie 1</a></li>
<li><a href="../fr400977/index.html">Examen Tefal OptiGrill avec capteur de steak intelligent</a></li>
<li><a href="../fr400979/index.html">Philips Xenium V787 Review: un cheval de bataille de longue date</a></li>
<li><a href="../fr400981/index.html">Perfectionnisme des câbles</a></li>
<li><a href="../fr400983/index.html">Colonie. Chapitre 1: La vie éveillée</a></li>
<li><a href="../fr400985/index.html">Aperçu de la dernière impression 3D du CES 2017</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>