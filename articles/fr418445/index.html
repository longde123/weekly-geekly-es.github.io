<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ü•ò üíó ü§πüèø Django Channels - la r√©ponse au web moderne üõ†Ô∏è üòî üêè</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Dans le monde de Django, le module compl√©mentaire Django Channels gagne en popularit√©. Cette biblioth√®que devrait apporter √† Django la programmation r...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Django Channels - la r√©ponse au web moderne</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/oleg-bunin/blog/418445/">  Dans le monde de Django, le module compl√©mentaire Django Channels gagne en popularit√©.  Cette biblioth√®que devrait apporter √† Django la programmation r√©seau asynchrone que nous attendions.  <strong>Artyom Malyshev</strong> √† Moscou Python Conf 2017 a expliqu√© comment la premi√®re version de la biblioth√®que le fait (maintenant l'auteur a d√©j√† copi√© les canaux2), pourquoi le fait-il et le fait-il du tout. <br><br>  Tout d'abord, Zen Zen dit que toute solution doit √™tre la seule.  Par cons√©quent, <strong>en Python, il y en a au moins trois chacun</strong> .  Il existe d√©j√† de nombreux frameworks asynchrones r√©seau: <br><br><ul><li>  Tordu <br></li><li>  Eventlet <br></li><li>  Gevent <br></li><li>  Tornade; <br></li><li>  Asyncio <br></li></ul><br>  Il semblerait, pourquoi √©crire une autre biblioth√®que et si c'est n√©cessaire du tout. <br><br><iframe width="560" height="315" src="https://www.youtube.com/embed/ij0PiSlYBu0" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br>  <strong><em>√Ä propos du conf√©rencier:</em></strong> Artyom Malyshev est un d√©veloppeur Python ind√©pendant.  Il est engag√© dans le d√©veloppement de syst√®mes distribu√©s, intervient lors de conf√©rences sur Python.  Artyom peut √™tre trouv√© par le surnom <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" class="user_link">PROOFIT404</a> sur Github et sur les r√©seaux sociaux. <br><a name="habracut"></a><br>  <strong>Django est synchrone par d√©finition</strong> .  Si nous parlons d'ORM, l'acc√®s synchrone √† la base de donn√©es pendant l'acc√®s aux attributs, lorsque nous √©crivons, par exemple, post.author.username, ne co√ªte rien. <br><br>  De plus, Django est un framework WSGI. <br><br><h2>  WSGI <br></h2><br>  WSGI est une interface synchrone pour travailler avec des serveurs Web. <br><br><pre><code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">app</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(environ, callback)</span></span></span><span class="hljs-function"> :</span></span> status, headers = <span class="hljs-string"><span class="hljs-string">'200 OK'</span></span>, [] callback (status, headers) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> [<span class="hljs-string"><span class="hljs-string">'Hello world!\n'</span></span>]</code> </pre> <br>  Sa principale caract√©ristique est que nous avons une fonction qui prend un argument et renvoie imm√©diatement une valeur.  C'est tout ce que le serveur Web peut attendre de nous.  <strong>Pas asynchrone et ne sent pas</strong> . <br><br>  Cela a √©t√© fait il y a longtemps, en 2003, lorsque le Web √©tait simple, les utilisateurs lisaient toutes sortes de nouvelles sur Internet et se sont tourn√©s vers les livres d'or.  Il suffisait juste d'accepter la demande et de la traiter.  Donnez une r√©ponse et oubliez que cet utilisateur l'√©tait. <br><img src="https://habrastorage.org/webt/-a/3e/ly/-a3elynsjri1d0qbc73yl256qbo.jpeg"><br><br>  Mais, pour une seconde, ce n'est pas l'ann√©e 2003, donc les utilisateurs veulent beaucoup plus de nous. <br><img src="https://habrastorage.org/webt/-j/fp/nz/-jfpnzpcfn0w2hpbvmcejswxnaw.jpeg"><br>  Ils veulent une application Web riche, du contenu en direct, ils veulent que l'application fonctionne tr√®s bien sur le bureau, sur l'ordinateur portable, sur d'autres sommets, sur l'horloge.  Plus important encore, les <strong>utilisateurs ne veulent pas appuyer sur F5</strong> , car, par exemple, les tablettes ne disposent pas d'un tel bouton. <br><br><img src="https://habrastorage.org/webt/bq/gi/ql/bqgiql6zzob87g74yngfmwvkehs.jpeg"><br><br>  Les navigateurs Web viennent naturellement √† notre rencontre - ils ajoutent de nouveaux protocoles et de nouvelles fonctionnalit√©s.  Si vous et moi ne d√©veloppions que l'interface, nous prendrions simplement le navigateur comme une plate-forme et utiliserions ses fonctionnalit√©s principales, car il est pr√™t √† nous les fournir. <br><br>  <strong>Mais, pour les programmeurs backend, tout a beaucoup chang√©</strong> .  Les sockets Web, HTTP2 et similaires sont une √©norme douleur en termes d'architecture, car ce sont des connexions de longue dur√©e avec leurs √©tats qui doivent √™tre g√©r√©es d'une mani√®re ou d'une autre. <br><img src="https://habrastorage.org/webt/g1/pn/gi/g1pngi6z8op3aesfec2rtiodv4q.jpeg"><br><br>  C'est le probl√®me que Django Channels for Django essaie de r√©soudre.  Cette biblioth√®que est con√ßue pour vous donner la possibilit√© de g√©rer les connexions, laissant le Django Core que nous avons l'habitude de compl√®tement inchang√©. <br><br>  Il est devenu une personne merveilleuse par <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><strong>Andrew Godwin</strong></a> , le propri√©taire d'un terrible accent anglais qui parle tr√®s rapidement.  Vous devriez le savoir par des choses comme les migrations Django Sud et Django longtemps oubli√©es, qui nous sont venues de la version 1.7.  Depuis qu'il a corrig√© les migrations pour Django, il a commenc√© √† r√©parer les sockets web et HTTP2. <br><br>  Comment l'a-t-il fait?  Il √©tait une fois l'image suivante sur Internet: des carr√©s vides, des fl√®ches, l'inscription ¬´Bonne architecture¬ª - vous entrez vos technologies pr√©f√©r√©es dans ces petits carr√©s, vous obtenez un site Web qui √©volue bien. <br><br><img src="https://habrastorage.org/webt/r1/rz/z9/r1rzz99ck74ggy5uy8vnn7kebks.jpeg"><br><br>  Andrew Godwin est entr√© dans un serveur dans ces bo√Ætes, qui se tient devant et accepte toutes les demandes, qu'elles soient asynchrones, synchrones, e-mail, peu importe.  Entre eux se trouve le soi-disant Channel Layer, qui stocke les messages re√ßus dans un format accessible au pool de travailleurs synchrones.  D√®s que la connexion asynchrone nous a envoy√© quelque chose, nous l'enregistrons dans la couche de canal, puis le travailleur synchrone peut le r√©cup√©rer √† partir de l√† et le traiter de la m√™me mani√®re que n'importe quelle vue Django ou autre, de mani√®re synchrone.  D√®s que le code synchrone a renvoy√© une r√©ponse √† Channel Layer, le serveur asynchrone lui donnera, le diffusera, fera tout ce dont il a besoin.  Ainsi, l'abstraction est effectu√©e. <br><br>  Cela implique plusieurs impl√©mentations, et en production, il est propos√© d'utiliser <strong>Twisted comme serveur asynchrone</strong> qui impl√©mente le frontend pour Django et <strong>Redis</strong> , qui sera le m√™me canal de communication entre Django synchrone et Twisted asynchrone. <br><br><blockquote>  La bonne nouvelle: pour utiliser les canaux Django, vous n'avez pas besoin de conna√Ætre Twisted ou Redis - ce sont tous des d√©tails d'impl√©mentation.  Votre DevOps le saura, ou vous vous rencontrerez lorsque vous r√©parerez une production tomb√©e √† trois heures du matin. </blockquote><br><h2>  ASGI </h2><br>  L'abstraction est un protocole appel√© ASGI.  Il s'agit de l'interface standard qui se situe entre n'importe quelle interface r√©seau, serveur, qu'il s'agisse d'un protocole synchrone ou asynchrone et de votre application.  Son concept principal est la cha√Æne. <br><br><h3>  Cha√Æne </h3><br>  Un canal est une file d'attente de messages premier entr√©, premier sorti qui a une dur√©e de vie.  Ces messages peuvent √™tre remis z√©ro ou une fois, et ne peuvent √™tre re√ßus que par un seul consommateur. <br><br><h3>  Les consommateurs </h3><br>  Chez Consumer, vous √©crivez simplement votre code. <br><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ws_message</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(message)</span></span></span><span class="hljs-function"> :</span></span> message.reply_channel.send ( { <span class="hljs-string"><span class="hljs-string">'text'</span></span>: message.content [<span class="hljs-string"><span class="hljs-string">'text'</span></span>], } )</code> </pre><br>  Une fonction qui accepte un message peut envoyer plusieurs r√©ponses ou ne pas envoyer de r√©ponse du tout.  Tr√®s similaire √† la vue, la seule diff√©rence est qu'il n'y a pas de fonction de retour, nous pouvons donc parler du nombre de r√©ponses que nous retournons de la fonction. <br><br>  Nous ajoutons cette fonction au routage, par exemple, le suspendons pour recevoir un message sur une socket web. <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> channels.routing <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> route <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> myapp.consumers <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> ws_message channel_routing = [ route (<span class="hljs-string"><span class="hljs-string">'websocket.receive'</span></span> ws_message), }</code> </pre><br>  Nous √©crivons cela dans les param√®tres de Django, tout comme la base de donn√©es serait prescrite. <br><br><pre> <code class="python hljs">CHANNEL_LAYERS = { <span class="hljs-string"><span class="hljs-string">'default'</span></span>: { <span class="hljs-string"><span class="hljs-string">'BACKEND'</span></span>: <span class="hljs-string"><span class="hljs-string">'asgiref.inmemory'</span></span>, <span class="hljs-string"><span class="hljs-string">'ROUTING'</span></span>: <span class="hljs-string"><span class="hljs-string">'myproject.routing'</span></span>, }, }</code> </pre><br>  Un projet peut avoir plusieurs couches de canaux, tout comme il peut y avoir plusieurs bases de donn√©es.  Cette chose est tr√®s similaire au routeur db si quelqu'un l'a utilis√©. <br><br>  Ensuite, nous d√©finissons notre application ASGI.  Il synchronise le d√©marrage de Twisted et le d√©marrage des travailleurs synchronis√©s - ils ont tous besoin de cette application. <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> os <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> channels.asgi <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> get_channel_layer os.environ.setdefault( <span class="hljs-string"><span class="hljs-string">'DJANGO_SETTINGS_MODULE'</span></span>, <span class="hljs-string"><span class="hljs-string">'myproject.settings'</span></span>, ) channel_layer = get_channel_layer()</code> </pre><br>  Apr√®s cela, d√©ployez le code: ex√©cutez gunicorn, envoyez normalement une demande HTTP, de mani√®re synchrone, avec vue, comme vous en avez l'habitude.  Nous d√©marrons le serveur asynchrone, qui sera le devant devant notre Django synchrone, et les travailleurs qui traiteront les messages. <br><br><pre> <code class="python hljs">$ gunicorn myproject.wsgi $ daphne myproject.asgi:channel_layer $ django-admin runworker</code> </pre><br><h3>  Cha√Æne de r√©ponse </h3><br>  Comme nous l'avons vu, le message a un concept comme le canal de r√©ponse.  Pourquoi est-ce n√©cessaire? <br><br>  Canal unidirectionnel, respectivement r√©ception WebSocket, connexion WebSocket, d√©connexion WebSocket - il s'agit d'un canal commun au syst√®me pour les messages entrants.  Un canal de r√©ponse est un canal strictement li√© √† la connexion de l'utilisateur.  Par cons√©quent, le message a un canal d'entr√©e et de sortie.  Cette paire vous permet d'identifier de qui provient ce message. <br><img src="https://habrastorage.org/webt/rp/_k/wm/rp_kwmeuccjs2bunsar-hoei9au.jpeg"><br><br><h3>  Les groupes </h3><br>  Un groupe est une collection de canaux.  Si nous envoyons un message √† un groupe, il est automatiquement envoy√© √† tous les canaux de ce groupe.  C'est pratique car personne n'aime √©crire pour les boucles.  De plus, l'impl√©mentation des groupes se fait g√©n√©ralement √† l'aide des fonctions natives de la couche Channel, c'est donc plus rapide que d'envoyer des messages un par un. <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> channels <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> Group <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ws_connect</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(message)</span></span></span><span class="hljs-function">:</span></span> Group (<span class="hljs-string"><span class="hljs-string">'chat'</span></span>).add (message.reply_channel) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ws_disconnect</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(message)</span></span></span><span class="hljs-function">:</span></span> Group (<span class="hljs-string"><span class="hljs-string">'chat'</span></span>).discard(message.reply_channel) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ws_message</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(message)</span></span></span><span class="hljs-function">:</span></span> Group (<span class="hljs-string"><span class="hljs-string">'chat'</span></span>). Send ({ <span class="hljs-string"><span class="hljs-string">'text'</span></span>: message.content [<span class="hljs-string"><span class="hljs-string">'text'</span></span>], })</code> </pre><br>  Les groupes sont √©galement ajout√©s au routage de la m√™me mani√®re. <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> channels.routing <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> route <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> myapp.consumers <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> * channel_routing = [ route (<span class="hljs-string"><span class="hljs-string">'websocket.connect'</span></span> , ws_connect), route (<span class="hljs-string"><span class="hljs-string">'websocket.disconnect'</span></span> , ws_disconnect), route (<span class="hljs-string"><span class="hljs-string">'websocket.receive'</span></span> , ws_message), ]</code> </pre><br>  Et d√®s que la cha√Æne est ajout√©e au groupe, la r√©ponse ira √† tous les utilisateurs connect√©s √† notre site, et pas seulement √† la r√©ponse d'√©cho √† nous-m√™mes. <br><br><h3>  Consommateurs g√©n√©riques </h3><br>  Ce que j'aime Django est d√©claratif.  De m√™me, il existe des consommateurs d√©claratifs. <br><br>  Le consommateur de base est un consommateur de base, il ne peut mapper que le canal que vous avez d√©fini sur une m√©thode et l'appeler. <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> channels.generic <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> BaseConsumer <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MyComsumer</span></span></span><span class="hljs-class"> </span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(BaseConsumer)</span></span></span><span class="hljs-class"> :</span></span> method_mapping = { <span class="hljs-string"><span class="hljs-string">'channel.name.here'</span></span>: <span class="hljs-string"><span class="hljs-string">'method_name'</span></span>, } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">method_name</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, message, **kwargs)</span></span></span><span class="hljs-function"> :</span></span> <span class="hljs-keyword"><span class="hljs-keyword">pass</span></span></code> </pre><br>  Il existe un grand nombre de consommateurs pr√©d√©finis avec un comportement d√©lib√©r√©ment augment√©, comme WebSocket Consumer, qui d√©termine √† l'avance qu'il g√©rera la connexion WebSocket, la r√©ception WebSocket, la d√©connexion WebSocket.  Vous pouvez imm√©diatement indiquer dans quels groupes ajouter un canal de r√©ponse, et d√®s que vous utilisez self.send, il comprendra s'il faut l'envoyer √† un groupe ou √† un utilisateur. <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> channels.generic <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> WebsocketConsumer <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MyConsumer</span></span></span><span class="hljs-class"> </span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(WebsocketConsumer)</span></span></span><span class="hljs-class"> :</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">connection_groups</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function"> :</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> [<span class="hljs-string"><span class="hljs-string">'chat'</span></span>] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">connect</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, message)</span></span></span><span class="hljs-function"> :</span></span> <span class="hljs-keyword"><span class="hljs-keyword">pass</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">receive</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, text=None, bytes=None)</span></span></span><span class="hljs-function"> :</span></span> self.send (text=text, bytes=bytes)</code> </pre><br>  Il existe √©galement une option client WebSocket avec JSON, c'est-√†-dire pas de texte, pas d'octets, mais JSON d√©j√† analys√© viendra √† recevoir, ce qui est pratique. <br><br>  En routage, il est ajout√© de la m√™me mani√®re via route_class.  Myapp est pris dans route_class, qui est d√©termin√© par le consommateur, tous les canaux sont pris √† partir de l√† et tous les canaux sp√©cifi√©s dans myapp sont rout√©s.  √âcrivez moins de cette fa√ßon. <br><br><h2>  Acheminement </h2><br>  Parlons en d√©tail du routage et de ce qu'il nous offre. <br><br>  Premi√®rement, ce sont des filtres. <br><br><pre> <code class="python hljs">// app.js S = new WebSocket (<span class="hljs-string"><span class="hljs-string">'ws://localhost:8000/chat/'</span></span>) <span class="hljs-comment"><span class="hljs-comment"># routing.py route('websocket.connect', ws_connect, path=r'^/chat/$')</span></span></code> </pre><br>  Il peut s'agir du chemin qui nous est venu de l'URI de connexion de socket Web ou de la m√©thode de demande http.  Il peut s'agir de n'importe quel champ de message du canal, par exemple pour le courrier √©lectronique: texte, corps, copie conforme, etc.  Le nombre d'arguments de mot-cl√© pour route est arbitraire. <br><br>  Le routage vous permet de cr√©er des itin√©raires imbriqu√©s.  Si plusieurs consommateurs sont d√©termin√©s par certaines caract√©ristiques communes, il est pratique de les regrouper et d'ajouter tout le monde √† l'itin√©raire en m√™me temps. <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> channels <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> route, include blog_routes = [ route ( <span class="hljs-string"><span class="hljs-string">'websocket.connect'</span></span>, blog, path = <span class="hljs-string"><span class="hljs-string">r'^/stream/'</span></span>) , ] routing = [ include (blog_routes, path= <span class="hljs-string"><span class="hljs-string">r'^/blog'</span></span> ), ]</code> </pre><br><h2>  Multiplexage </h2><br>  Si nous ouvrons plusieurs sockets Web, chacun a un URI diff√©rent et nous pouvons y suspendre plusieurs gestionnaires.  Mais pour √™tre honn√™te, ouvrir plusieurs connexions juste pour faire quelque chose de beau sur le backend ne ressemble pas √† une approche d'ing√©nierie. <br><br>  Par cons√©quent, il est possible d'appeler plusieurs gestionnaires sur une m√™me socket Web.  Nous d√©finissons un tel WebsocketDemultiplexer qui fonctionne sur le concept de flux au sein d'une seule socket Web.  Gr√¢ce √† ce flux, il redirigera votre message vers un autre canal. <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> channels <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> WebsocketDemultiplexer <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Demultiplexer</span></span></span><span class="hljs-class"> </span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(WebsocketDemultiplexer)</span></span></span><span class="hljs-class"> :</span></span> mapping = { <span class="hljs-string"><span class="hljs-string">'intval'</span></span>: <span class="hljs-string"><span class="hljs-string">'binding.intval'</span></span>, }</code> </pre><br>  En routage, le multiplexeur est ajout√© de la m√™me mani√®re que dans tout autre consommateur d√©claratif route_class. <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> channels <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> route_class, route <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> .consumers <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> Demultiplexer, ws_message channel_routing = [ route_class (Demultiplexer, path=<span class="hljs-string"><span class="hljs-string">'^/binding/'</span></span>) , route (<span class="hljs-string"><span class="hljs-string">'binding.intval'</span></span>, ws_message ) , ]</code> </pre><br>  L'argument stream est ajout√© au message afin que le multiplexeur puisse d√©terminer o√π placer le message donn√©.  L'argument de charge utile contient tout ce qui entre dans le canal une fois que le multiplexeur l'a trait√©. <br><br>  Il est tr√®s important de noter que dans Channel Layer, le message sera obtenu <strong>deux fois</strong> : avant le multiplexeur et apr√®s le multiplexeur.  Ainsi, d√®s que vous commencez √† utiliser le multiplexeur, vous ajoutez automatiquement une latence √† vos demandes. <br><br><pre> <code class="python hljs">{ <span class="hljs-string"><span class="hljs-string">"stream"</span></span> : <span class="hljs-string"><span class="hljs-string">"intval"</span></span>, <span class="hljs-string"><span class="hljs-string">"payload"</span></span> : { ‚Ä¶ } }</code> </pre><br><h2>  S√©ances </h2><br>  Chaque cha√Æne a ses propres sessions.  C'est une chose tr√®s pratique, par exemple, pour stocker l'√©tat entre les appels aux gestionnaires.  Vous pouvez les regrouper par canal de r√©ponse, car il s'agit d'un identifiant qui appartient √† l'utilisateur.  La session est stock√©e dans le m√™me moteur que la session http standard.  Pour des raisons √©videntes, les cookies sign√©s ne sont pas pris en charge, ils ne sont tout simplement pas dans la socket Web. <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> channels.sessions <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> channel_session @channel_session <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ws_connect</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(message)</span></span></span><span class="hljs-function"> :</span></span> room=message.content [<span class="hljs-string"><span class="hljs-string">'path'</span></span>] message.channel_session [<span class="hljs-string"><span class="hljs-string">'room'</span></span>] = room Croup (<span class="hljs-string"><span class="hljs-string">'chat-%s'</span></span> % room).add ( message.reply_channel )</code> </pre><br>  Pendant la connexion, vous pouvez obtenir une session http et l'utiliser dans votre consommateur.  Dans le cadre du processus de n√©gociation, la mise en place d'une connexion socket Web, des cookies sont envoy√©s √† l'utilisateur.  Par cons√©quent, vous pouvez donc obtenir une session utilisateur, obtenir l'objet utilisateur que vous utilisiez auparavant dans Django, comme si vous travailliez avec view. <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> channels.sessions <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> http_session_user @http_session_user <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ws_connect</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(message)</span></span></span><span class="hljs-function"> :</span></span> message.http_session [<span class="hljs-string"><span class="hljs-string">'room'</span></span>] = room <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> message.user.username : ‚Ä¶</code> </pre><br><h2>  Ordre des messages </h2><br>  Les canaux peuvent r√©soudre un probl√®me tr√®s important.  Si nous √©tablissons une connexion √† un socket Web et envoyons imm√©diatement, cela conduit au fait que les deux √©v√©nements - WebSocket Connect et WebSocket Receive - sont tr√®s proches dans le temps.  Il est tr√®s probable que le consommateur de ces sockets Web s'ex√©cute en parall√®le.  Le d√©bogage sera tr√®s amusant. <br><br>  Les canaux Django vous permettent d'entrer un verrou de deux types: <br><br><ol><li>  <strong>Verrouillage</strong> <strong>facile</strong> .  En utilisant le m√©canisme de session, nous garantissons que tant que le consommateur ne sera pas trait√© pour recevoir un message, nous ne traiterons aucun message sur les sockets Web.  Une fois la connexion √©tablie, l'ordre est arbitraire, une ex√©cution parall√®le est possible. </li><li>  <strong>Verrouillage fixe</strong> - un seul consommateur d'un utilisateur particulier est en cours d'ex√©cution √† la fois.  Il s'agit d'une surcharge pour la synchronisation, car elle utilise un moteur de session lente.  N√©anmoins, il existe une telle opportunit√©. </li></ol><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> channels.generic <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> WebsocketConsumer <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MyConsumer</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(WebsocketConsumer)</span></span></span><span class="hljs-class"> :</span></span> http_user = <span class="hljs-keyword"><span class="hljs-keyword">True</span></span> slight_ordering = <span class="hljs-keyword"><span class="hljs-keyword">True</span></span> strict_ordering = <span class="hljs-keyword"><span class="hljs-keyword">False</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">connection_groups</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, **kwargs)</span></span></span><span class="hljs-function"> :</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> [<span class="hljs-string"><span class="hljs-string">'chat'</span></span>]</code> </pre><br>  Pour √©crire ceci, il y a les m√™mes d√©corateurs que nous avons vu plus t√¥t dans la session http, la session channel.  Dans le consommateur d√©claratif, vous pouvez simplement √©crire des attributs, d√®s que vous les √©crivez, cela s'appliquera automatiquement √† toutes les m√©thodes de ce consommateur. <br><br><h2>  Liaison de donn√©es </h2><br>  √Ä une certaine √©poque, Meteor est devenu c√©l√®bre pour la liaison de donn√©es. <br><br>  Nous ouvrons deux navigateurs, allons sur la m√™me page et dans l'un d'eux, nous cliquons sur la barre de d√©filement.  Dans le m√™me temps, dans le deuxi√®me navigateur, sur cette page, la barre de d√©filement change sa valeur.  C'est cool. <br><br><pre> <code class="python hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">IntegerValueBinding</span></span></span><span class="hljs-class"> </span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(WebsocketBinding)</span></span></span><span class="hljs-class"> :</span></span> model = IntegerValue stream = intval<span class="hljs-string"><span class="hljs-string">' fields= ['</span></span>name<span class="hljs-string"><span class="hljs-string">', '</span></span>value<span class="hljs-string"><span class="hljs-string">'] def group_names (self, instance, action ) : return ['</span></span>intval-updates<span class="hljs-string"><span class="hljs-string">'] def has_permission (self, user, action, pk) : return True</span></span></code> </pre><br>  Django fait maintenant de m√™me. <br><br>  Ceci est impl√©ment√© √† l'aide de crochets fournis par <strong>Django Signals</strong> .  Si la liaison est d√©finie pour le mod√®le, toutes les connexions qui sont dans le groupe pour cette instance du mod√®le seront notifi√©es de chaque √©v√©nement.  Nous avons cr√©√© un mod√®le, chang√© le mod√®le, supprim√© - tout cela sera un avertissement.  La notification se produit sur les champs indiqu√©s: la valeur de ce champ a chang√© - une charge utile est en cours de formation, envoy√©e via le socket web.  C'est pratique. <br><br>  Il est important de comprendre que si dans notre exemple, nous cliquons constamment sur la barre de d√©filement, les messages iront constamment et le mod√®le sera enregistr√©.  Cela fonctionnera jusqu'√† une certaine charge, puis tout reposera contre la base. <br><br><h2>  Redis calque </h2><br>  Parlons un peu plus de la fa√ßon dont la couche de canaux de production la plus populaire - Redis. <br><br>  Il est bien agenc√©: <br><br><ul><li>  fonctionne avec des connexions synchrones au niveau des travailleurs; </li><li>  tr√®s convivial pour Twisted, ne ralentit pas, l√† o√π c'est particuli√®rement n√©cessaire, c'est-√†-dire sur votre serveur frontal; </li><li>  MSGPACK est utilis√© pour s√©rialiser les messages √† l'int√©rieur de Redis, ce qui r√©duit l'empreinte sur chaque message; </li><li>  vous pouvez r√©partir la charge sur plusieurs instances Redis, elle sera automatiquement m√©lang√©e √† l'aide de l'algorithme de hachage coh√©rent.  Ainsi, un seul point de d√©faillance dispara√Æt. </li></ul><br>  Un canal est juste une liste d'id de Redis.  Par id est la valeur d'un message particulier.  Cette op√©ration permet de contr√¥ler s√©par√©ment la dur√©e de vie de chaque message et canal.  En principe, c'est logique. <br><br><pre> <code class="python hljs">&gt;&gt; SET <span class="hljs-string"><span class="hljs-string">"b6dc0dfce"</span></span> <span class="hljs-string"><span class="hljs-string">" \x81\xa4text\xachello"</span></span> &gt;&gt; RPUSH <span class="hljs-string"><span class="hljs-string">"websocket.send!sGOpfny"</span></span> <span class="hljs-string"><span class="hljs-string">"b6dc0dfce"</span></span> &gt;&gt; EXPIRE <span class="hljs-string"><span class="hljs-string">"b6dc0dfce"</span></span> <span class="hljs-string"><span class="hljs-string">"60"</span></span> &gt;&gt; EXPIRE <span class="hljs-string"><span class="hljs-string">"websocket.send!sGOpfny"</span></span> <span class="hljs-string"><span class="hljs-string">"61"</span></span></code> </pre><br>  Les groupes sont impl√©ment√©s par des ensembles tri√©s.  La distribution aux groupes est effectu√©e √† l'int√©rieur du script Lua - c'est tr√®s rapide. <br><br><pre> <code class="python hljs">&gt;&gt; type group:chat zset &gt;&gt; ZRANGE group:chat <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> WITHSCORES <span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-string"><span class="hljs-string">"websocket.send!sGOpfny"</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span>) <span class="hljs-string"><span class="hljs-string">"1476199781.8159261"</span></span></code> </pre><br><h2>  Probl√®mes </h2><br>  Voyons quels sont les probl√®mes de cette approche. <br><br><h3>  Enfer de rappel </h3><br>  Le premier probl√®me est l'enfer de rappel nouvellement invent√©.  Il est tr√®s important de comprendre que la plupart des probl√®mes avec les cha√Ænes que vous rencontrerez seront de style: des arguments sont venus au consommateur auxquels il ne s'attendait pas.  D'o√π ils viennent, qui les a mis sur Redis - tout cela est une t√¢che d'enqu√™te douteuse.  D√©bogage des syst√®mes distribu√©s en g√©n√©ral pour les volontaires.  AsyncIO r√©sout ce probl√®me. <br><br><h3>  C√©leri </h3><br>  Sur Internet, ils √©crivent que Django Channels est un remplacement de Celery. <br><img src="https://habrastorage.org/webt/x9/be/j8/x9bej8oul6vevk2r8e12q9-i_ia.jpeg"><br>  J'ai de mauvaises nouvelles pour vous - non, ce n'est pas √ßa. <br><br>  Dans les canaux: <br><br><ul><li>  pas de nouvelle tentative, vous ne pouvez pas retarder l'ex√©cution d'un gestionnaire; <br></li><li>  pas de toile - juste un rappel.  Celery fournit √©galement des groupes, une cha√Æne, mon accord pr√©f√©r√©, qui, apr√®s avoir ex√©cut√© des groupes en parall√®le, provoque un autre rappel avec synchronisation.  Tout cela n'est pas dans les canaux; </li><li>  il n'y a pas de r√©glage de l'heure d'arriv√©e des messages, certains syst√®mes sans cela sont tout simplement impossibles √† concevoir. </li></ul><br><blockquote>  Je vois l'avenir comme un support officiel pour l'utilisation conjointe des cha√Ænes et du c√©leri, √† un co√ªt minimal, avec un effort minimal.  Mais Django Channels ne remplace pas le c√©leri. <br></blockquote><br><h2>  Django pour le web moderne </h2><br>  Django Channels est Django pour le web moderne.  C'est le m√™me Django que nous sommes tous habitu√©s √† utiliser: synchrone, d√©claratif, avec beaucoup de batteries.  Django Channels est juste plus une batterie.  Vous devez toujours savoir o√π l'utiliser et si cela vaut la peine.  Si Django n'est pas n√©cessaire dans le projet, les canaux n'y sont pas non plus n√©cessaires.  Ils ne sont utiles que dans les projets pour lesquels Django est justifi√©. <br><br><blockquote>  <strong><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Moscou Python Conf ++</a></strong> <br><br>  Une conf√©rence professionnelle pour les d√©veloppeurs Python atteint un nouveau niveau - <strong>les 22 et 23 octobre</strong> 2018, nous r√©unirons les 600 meilleurs programmeurs Python en Russie, pr√©senterons les rapports les plus int√©ressants et, bien s√ªr, cr√©erons un environnement de r√©seautage dans les meilleures traditions de la communaut√© Python de Moscou avec le soutien de l'√©quipe Ontiko. <br><br>  Nous invitons des experts √† faire un rapport.  Le comit√© de programme travaille d√©j√† et accepte les <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">candidatures</a> jusqu'au 7 septembre. <br><br>  Pour les participants, un programme de brainstorming en ligne est en cours.  Vous pouvez ajouter des sujets manquants √† ce <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">document</a> ou des conf√©renciers dont les discours vous int√©ressent.  Le document sera mis √† jour, en fait, tout le temps que vous pourrez suivre la formation du programme. <br></blockquote></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr418445/">https://habr.com/ru/post/fr418445/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr418433/index.html">4 ao√ªt Peter. La premi√®re qu√™te de v√©lo pour les programmeurs</a></li>
<li><a href="../fr418437/index.html">L'√©quipe d'OC √† la rescousse</a></li>
<li><a href="../fr418439/index.html">Notions de base sur les applications Web progressives</a></li>
<li><a href="../fr418441/index.html">Bases de l'√©l√©vation de privil√®ges Windows</a></li>
<li><a href="../fr418443/index.html">GObject: encapsulation, instanciation, introspection</a></li>
<li><a href="../fr418447/index.html">Pourquoi Moscow Python Conf est maintenant ++</a></li>
<li><a href="../fr418449/index.html">Modules binaires pour Python</a></li>
<li><a href="../fr418451/index.html">Cours d'impression 3D. Prise en charge efficace et changement de hauteur de couche dans la pratique de 3Dtool</a></li>
<li><a href="../fr418453/index.html">Les observations GRAVITY valident davantage la relativit√© g√©n√©rale</a></li>
<li><a href="../fr418455/index.html">Webinaire ouvert ¬´Sp√©cialiste √† la barre: premi√®re exp√©rience et erreurs¬ª</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>