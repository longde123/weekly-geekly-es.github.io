<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üí¢ ‚ù§Ô∏è üë©üèº‚Äçüöí ShIoTiny: une horloge sans ressort ni temps r√©el et comment travailler avec üî∞ üöô ‚èÆÔ∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="De quoi parle cet article 

 Nous continuons la s√©rie d'articles sur ShIoTiny - un contr√¥leur visuellement programmable bas√© sur la puce ESP8266 . 

 ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>ShIoTiny: une horloge sans ressort ni temps r√©el et comment travailler avec</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/467545/"><img src="https://habrastorage.org/webt/pv/8m/zb/pv8mzbyp-nmax1aoau00apxxuly.jpeg"><br><br>  <b>De quoi parle cet article</b> <br><br>  Nous continuons la s√©rie d'articles sur <b>ShIoTiny</b> - un contr√¥leur visuellement programmable bas√© sur la puce <b>ESP8266</b> . <br><br>  Cet article <b>parle</b> de l'horloge en temps r√©el dans le contr√¥leur <b>ShIoTiny</b> , de la synchronisation de l'heure et de l'utilisation de n≈ìuds pour travailler avec l'horloge. <br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><b>Site du</b> projet <b>ShIoTiny</b></a> <br><br>  <b>Articles pr√©c√©dents de la s√©rie.</b> <br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ShIoTiny: petite automatisation, Internet des objets, ou ¬´six mois avant les vacances¬ª</a> <br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ShIoTiny: n≈ìuds, liens et √©v√©nements ou caract√©ristiques des programmes de dessin</a> <br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ShIoTiny: ventilation de pi√®ce humide (exemple de projet)</a> <br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ShIoTiny et le monde environnant: connexion de capteurs aux entr√©es binaires, rebond de contact et autres probl√®mes</a> <br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ShIoTiny et le monde: capteurs analogiques ou ADC pour les plus petits</a> <br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Micrologiciel binaire, circuits de contr√¥leur et documentation</a> <br><a name="habracut"></a><br><h3>  Entr√©e </h3><br>  Aujourd'hui, nous parlons du temps.  Pas √† propos du temps, dans le sens o√π les philosophes se disputent √† ce sujet depuis des si√®cles et le bout du fil n'est pas visible dans ce d√©bat.  Et sur l'heure que nous voyons sur l'horloge et selon laquelle nous allons au travail, √† l'√©cole ou √† la h√¢te sur une date. <br><br>  Le fait est que l'horloge en temps r√©el non volatile de la puce <b>ESP8266</b> et le contr√¥leur <b>ShIoTiny</b> sont manquants.  Cette blessure √† la naissance du contr√¥leur <b>ShIoTiny</b> est enti√®rement de ma faute.  Mais ce qui a √©t√© fait est fait. <br><br>  D√®s que le firmware a vu le jour, le public, indign√© par mon attitude en temps r√©el, a commenc√© √† me taper le nez sur cette faille. <br><br>  Comme les erreurs doivent √™tre corrig√©es, et cette fois du moins pas avec du sang, je suis all√© rencontrer le nombre toujours croissant d'utilisateurs de mon firmware et j'ai fait ce que j'ai pu.  √Ä savoir, j'ai ajout√© des n≈ìuds au firmware du contr√¥leur <b>ShIoTiny</b> qui le rendent plus ou moins pratique pour travailler avec cela en temps r√©el. <br><br><h3>  √Ä propos de la montre ShIoTiny </h3><br>  Comme d√©j√† mentionn√©, il n'y a pas ¬´d'heures avec une batterie¬ª dans <b>ShIoTiny</b> .  Mais en m√™me temps, le compte √† rebours des secondes √† partir du 1er janvier 1970 est mis en ≈ìuvre. <br><br>  Il s'agit de la m√™me heure appel√©e UNIX-time, stock√©e dans des variables de type <b>time_t</b> dans les langages C / C ++ et qui devrait se terminer le 19 janvier 2038 dans les syst√®mes 32 bits. <br><br>  Mais n'ayez pas peur.  Je pense que d'ici 2038, tout le monde aura le temps de faire le type <b>time_t</b> 64 bits et le probl√®me sera r√©solu dans les 292 milliards d'ann√©es √† venir.  Eh bien, nous allons trouver autre chose. <br><br>  Notez que l'heure au format <b>time_t</b> est parfois appel√©e (dans mon article aussi) - horodatage ou, en russe, <b>horodatage</b> . <br><br>  Mais revenons √† notre contr√¥leur.  Donc, il y a une horloge, mais cette horloge est remise √† 0 apr√®s avoir coup√© l'alimentation.  Cela <b>conduit</b> √† la conclusion triviale que le principal probl√®me du comptage du temps dans le contr√¥leur <b>ShIoTiny</b> est la n√©cessit√© de synchroniser l'horloge du contr√¥leur lorsque l'alimentation est allum√©e.  Le reste est purement technique. <br><br><h3>  Synchronisation horaire </h3><br>  Les serveurs <b>NTP</b> constituent un moyen √©tabli depuis longtemps de synchroniser l'heure sur Internet.  Et la premi√®re id√©e √©tait de cr√©er un n≈ìud qui synchronise l'heure avec un serveur <b>NTP</b> donn√©. <br><br>  Mais, en respirant un peu d'air frais et en r√©fl√©chissant √† ma citrouille, j'ai r√©alis√© que cette approche √©tait id√©ologiquement erron√©e. <br><br>  Ce n'est pas un fait que l'utilisateur souhaite retirer le contr√¥leur avec le firmware <b>ShIoTiny</b> sur Internet.  Et le temps de synchronisation peut √™tre envoy√© non seulement depuis le serveur <b>NTP</b> , mais √©galement via la <b>multidiffusion UDP,</b> ou avec une qualit√© de connexion connue - via <b>MQTT</b> . <br><br>  Par cons√©quent, une d√©cision fatidique a √©t√© prise - s√©parer les n≈ìuds pour recevoir l'heure du serveur <b>NTP</b> et r√©gler l'heure du syst√®me. <br><br>  Au total, deux n≈ìuds ont √©t√© d√©velopp√©s pour la synchronisation de l'heure: le n≈ìud de r√©ception de l'heure du serveur <b>NTP NTP Time</b> <br><br><img src="https://habrastorage.org/webt/ym/27/br/ym27brh824hmp7rw33-teekhkum.png"><br><br>  et noeud d'installation de l'horloge syst√®me <b>Set Time</b> <br><br><img src="https://habrastorage.org/webt/hc/ux/h9/hcuxh97i2xfof8neay76nrb9cpw.png"><br><br>  Le n≈ìud recevant l'heure du serveur <b>NTP</b> en tant que param√®tres re√ßoit le nom ou l'adresse IP du serveur <b>NTP</b> et, s√©par√©s par une virgule, la p√©riode de temps du serveur <b>NTP</b> en minutes.  Par d√©faut, l'heure est demand√©e au serveur <b>NTP</b> toutes les 60 minutes ou 1 heure.  En sortie, ce noeud d√©finit 0 jusqu'√† ce que l'heure soit synchronis√©e ou que l'horodatage soit le r√©sultat de la derni√®re synchronisation avec le serveur. <br><br>  Le noeud d'installation d'horloge syst√®me re√ßoit un horodatage en entr√©e et r√®gle l'horloge syst√®me conform√©ment √† cette √©tiquette. <br><br>  Le sch√©ma le plus simple pour synchroniser l'horloge syst√®me avec un serveur <b>NTP</b> est illustr√© dans la figure. <br><br><img src="https://habrastorage.org/webt/gg/jx/fd/ggjxfdr-vc1qyg49jltaywrjtli.png"><br><br>  La p√©riode de synchronisation n'est pas d√©finie et est de 60 minutes par d√©faut.  La figure montre l'horodatage. <br><br>  Je note qu'il ne peut y avoir plus d'un n≈ìud pour recevoir l'heure d'un serveur <b>NTP</b> et plus d'un n≈ìud pour r√©gler l'heure syst√®me dans le sch√©ma du programme. <br><br>  Si vous avez besoin d'un sch√©ma de synchronisation exotique, vous pouvez utiliser la <b>multidiffusion UDP</b> ou <b>MQTT</b> .  Les sch√©mas sont compl√®tement similaires. <br><br>  Pour <b>la</b> synchronisation <b>UDP-multicast</b> , approximativement la m√™me que sur la figure. <br><br><img src="https://habrastorage.org/webt/d9/vm/mh/d9vmmhwjiouw-bim7xsk7jdwoik.png"><br><br>  Et pour la synchronisation via <b>MQTT</b> (je ne conseille pas, bien s√ªr, mais dans les cas extr√™mes) - tel. <br><br><img src="https://habrastorage.org/webt/em/yp/fq/emypfq7h46bxluup4k7zj5_rplk.png"><br><br>  J'esp√®re que maintenant tout est clair avec la synchronisation de l'horloge syst√®me du contr√¥leur <b>ShIoTIny</b> .  Passons aux n≈ìuds de r√©ception et de traitement. <br><br><h3>  Quelle heure est-il? </h3><br>  La question est simple, mais il n‚Äôest parfois pas facile de r√©pondre.  Apr√®s tout, le temps √† chaque point de la Terre est diff√©rent.  Notre vaste patrie comprend de Kaliningrad au Kamchatka jusqu'√† 11 fuseaux horaires. <br><br>  <b>Le</b> serveur <b>NTP</b> , selon les param√®tres, peut renvoyer un horodatage associ√© √† diff√©rents fuseaux horaires.  En r√®gle g√©n√©rale, cet horodatage est li√© √† <b>UTC</b> - heure universelle. <br><br>  Mais g√©n√©ralement, nous avons besoin de l'heure locale de la r√©gion o√π travaille notre contr√¥leur.  Comment √™tre ici? <br><br>  Et c'est tr√®s simple - pour obtenir l'horodatage de l'horloge syst√®me du contr√¥leur <b>ShIoTIny</b> , le n≈ìud <b>Get Time a</b> √©t√© d√©velopp√©, dans lequel vous pouvez d√©finir le fuseau horaire comme un d√©calage horaire de -12 heures √† +12 heures par rapport √† l'horloge syst√®me du contr√¥leur. <br><br>  Supposons que nous obtenions l'heure du serveur <b>pool.ntp.org</b> et synchronisons l'horloge syst√®me, comme dans notre exemple pr√©c√©dent.  Ce serveur renvoie l'heure universelle.  Nous avons besoin de locaux, comme Tomsk, comme le mien.  Je sais que Tomsk est dans le <b>fuseau</b> horaire <b>UTC + 7</b> .  Donc, d√©finissons l'unit√© de r√©ception de l'heure sur un d√©calage de +7 ou juste 7. Comme dans la figure ci-dessous. <br><br><img src="https://habrastorage.org/webt/sc/t0/en/sct0en2l8lmwbvucefraveh2rbw.png"><br><br>  Et si nous vivions dans la province canadienne de l'Alberta, le quart de travail serait de -7 heures.  N'oubliez pas l'essentiel - le <b>fuseau horaire est d√©fini dans le n≈ìud pour obtenir l'heure en heures</b> .  Et il est d√©fini sous la forme d'un d√©calage par rapport √† l'heure de l'horloge syst√®me.  L'horodatage est r√©gl√© √† la sortie de l'unit√© de r√©ception de l'heure.  Il peut y avoir plusieurs n≈ìuds pour obtenir du temps sur un circuit. <br><br><h3>  V√©rifiez l'horloge </h3><br>  Il est tr√®s pratique pour la machine de travailler avec l'heure au format d'horodatages <b>time_t</b> .  Apr√®s tout, ce n'est qu'un entier qui indique le nombre de secondes par rapport au point de d√©part - 1er janvier 1970.  Dans ce format, vous pouvez facilement trouver la distance entre deux points dans le temps, compter les p√©riodes, etc.  Ce n'est que l'addition et la soustraction d'entiers. <br><br>  Mais l'homme n'est pas une machine.  Il est beaucoup plus √† l'aise avec la repr√©sentation habituelle du temps sous la forme d'une ann√©e, d'un mois, d'un jour, d'heures, de minutes et de secondes.  Nous, les humains, sommes donc arrang√©s. <br><br>  Par cons√©quent, les n≈ìuds de la traduction de l'horodatage dans les unit√©s de changement de temps famili√®res √† la personne ont √©t√© introduits, et vice versa, la synth√®se de l'horodatage √† partir des unit√©s de changement de temps compr√©hensible pour la personne.  Ces n≈ìuds sont appel√©s respectivement <b>Split Time</b> et <b>Synth Time</b> . <br><br>  Le fonctionnement de tout cela ressort clairement de la figure ci-dessous. <br><br><img src="https://habrastorage.org/webt/d_/xd/xl/d_xdxlxtdrynelvluhzdi74ratu.png"><br><br>  Je note que les n≈ìuds <b>Split Time</b> et <b>Synth Time</b> mois (mois) et jours de la semaine (wday) sont compt√©s √† partir de z√©ro.  Pour les mois: 0-janvier, 11-d√©cembre.  Pour les jours de la semaine 0-dimanche, 6-samedi. <br>  Autres sorties: jour du mois (jour), ann√©e (ann√©e), heure (heure), min (minute), sec (seconde) - sont compt√©es sous la forme habituelle.  Heures, minutes, secondes - de 0 √† 59. Jour du mois - selon le mois du premier jour au 30 ou 31 et, pour f√©vrier, au 28 ou 29. <br>  Eh bien, un an - il est l'ann√©e.  2019 maintenant. <br>  J'esp√®re que tout est clair. <br><br><h3>  Exemple de syst√®me </h3><br>  Afin de ne pas √™tre infond√©, je vais donner un exemple d'utilisation des montres.  Bien s√ªr, simplifi√©. <br><br>  Supposons que nous ayons une pi√®ce humide que nous voulons ventiler de force.  Mais pas toujours, mais seulement lorsque l'humidit√© est sup√©rieure √† un niveau donn√© et uniquement la nuit.  La nuit - pour ne pas d√©ranger les gens pendant la journ√©e avec le bruit des ventilateurs.  Eh bien, nous sommes ici des esth√®tes et nous nous soucions des gens. <br><br>  Essayons d'impl√©menter cela. <br><br><img src="https://habrastorage.org/webt/yp/wi/_4/ypwi_4ckfmwujmthsq1e0tlfrl8.png"><br><br>  Toutes les parties du circuit nous sont famili√®res.  L'heure est synchronis√©e √† partir du serveur <b>NTP</b> .  Bien qu'il ne soit pas synchronis√©, le n≈ìud de <b>temps NTP</b> renvoie 0 et le relais d'activation du ventilateur est d√©sactiv√©.  Pour cela, l'√©l√©ment sup√©rieur <b>Et</b> selon le sch√©ma est responsable. <br><br>  Une fois l'heure synchronis√©e, la mise en marche / arr√™t du ventilateur est d√©termin√©e par l'heure actuelle et le niveau d'humidit√©.  D√®s que le taux d'humidit√© d√©passe <b>70%</b> et que l'heure est de <b>23h00</b> √† <b>06h00</b> , le ventilateur se met en marche et ne ventile pas la pi√®ce. <br><br>  Bien s√ªr, il est pr√©f√©rable de remplacer les constantes de temps et d'humidit√© dans un projet r√©el par les param√®tres stock√©s dans <b>FLASH</b> et d√©finis, par exemple, selon <b>MQTT</b> .  Oui, et l'√©tat actuel du syst√®me - niveau d'humidit√©, courant, heure, √©tat du ventilateur - ne fait pas de mal √† publier sur le r√©seau pour contr√¥ler le syst√®me √† partir d'un smartphone.  Mais d√©j√† je laisse de la place √† votre imagination. <br><br><h3>  Conclusion </h3><br>  Nous avons donc introduit notre contr√¥leur avec un temps r√©el plus proche. <br><br>  <i>Je tiens √† remercier tous ceux qui m'ont envoy√© des lettres de critiques constructives et des conseils sur les mises √† niveau logicielles.</i>  <i><b>Merci les gars!</b></i> <br><br>  Comme d'habitude, les critiques constructives sont les bienvenues.  De plus, les commentaires et suggestions sont les bienvenus. <br><br>  Vous pouvez envoyer toutes les critiques, commentaires, suggestions comme d'habitude dans un commentaire ou par mail: <b>shiotiny@yandex.ru</b> . </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr467545/">https://habr.com/ru/post/fr467545/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr467529/index.html">CQM est un regard diff√©rent dans l'apprentissage en profondeur pour optimiser les recherches en langage naturel</a></li>
<li><a href="../fr467531/index.html">Machine √† √©tats r√©actifs</a></li>
<li><a href="../fr467533/index.html">√âcouter du bruit informationnel: de la musique et des vid√©os que personne n'aurait d√ª trouver</a></li>
<li><a href="../fr467539/index.html">Forum CA / B vot√© contre le raccourcissement des certificats SSL √† 397 jours</a></li>
<li><a href="../fr467543/index.html">Ssh-chat, partie 2</a></li>
<li><a href="../fr467547/index.html">Contourner les verrous ILV avec DNSTap et BGP</a></li>
<li><a href="../fr467549/index.html">SpaceX pr√©voit de d√©ployer un r√©seau Internet par satellite plus t√¥t que pr√©vu</a></li>
<li><a href="../fr467551/index.html">Frontend Weekly Digest (9-15 septembre 2019)</a></li>
<li><a href="../fr467555/index.html">Connaissez-vous bien CSS? (+ mini-test)</a></li>
<li><a href="../fr467557/index.html">Le condens√© de mati√®res fra√Æches du monde du front-end de la derni√®re semaine n ¬∞ 380 (8-15 septembre 2019)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>