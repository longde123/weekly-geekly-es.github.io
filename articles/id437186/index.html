<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🕘 👶🏽 👌🏿 Monolith ke layanan microser. Sudut pandang infrastruktur 👃 👏🏿 🗣️</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Saya ingin membagikan cerita saya tentang aplikasi monolit migrasi ke layanan microser. Tolong, ingat bahwa itu selama 2012 - 2014. Ini adalah transkr...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Monolith ke layanan microser. Sudut pandang infrastruktur</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/437186/"><p><img src="https://habrastorage.org/webt/9-/yd/06/9-yd0651cdfemyxqsuo8hecigpm.png"></p><br><p>  Saya ingin membagikan cerita saya tentang aplikasi monolit migrasi ke layanan microser.  Tolong, ingat bahwa itu selama 2012 - 2014. Ini adalah transkripsi presentasi saya di <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">dotnetconf (RU)</a> .  Saya akan berbagi cerita tentang mengubah setiap bagian dari infrastruktur. </p><a name="habracut"></a><br><h1 id="project-description">  Deskripsi proyek </h1><br><p><img src="https://habrastorage.org/webt/xx/ui/gi/xxuigia4vy1hxggqqzh9rapnleq.png" alt="deskripsi proyek"></p><br><p> Gagasan proyek utama adalah merangkak artikel dari internet, menganalisisnya, menyimpan &amp; membuat umpan pengguna.  Di satu sisi, infrastruktur kami harus dapat diandalkan, tetapi di sisi lain, kami memiliki anggaran.  Sebagai hasilnya, kami sepakat bahwa: </p><br><ul><li>  Degradasi kinerja sistem diizinkan. </li><li>  Beberapa bagian dari infrastruktur kami mungkin turun selama 30 menit. </li><li>  Jika terjadi bencana, downtime mungkin beberapa hari. </li></ul><br><h1 id="crawlers">  Perayap </h1><br><p><img src="https://habrastorage.org/webt/ue/hz/7g/uehz7getj-pxvftz5k8owjpm3ss.png" alt="Perayap"></p><br><p>  Itu adalah bagian sederhana dari infrastruktur.  Crawler harus mengunduh, menganalisis, &amp; menyimpan.  Implementasi pertama adalah perayap tunggal, namun dunia berubah &amp; banyak perayap yang berbeda muncul.  Crawler sedang berkomunikasi satu sama lain oleh MsSQL. </p><br><p>  Waktu henti bukanlah masalah bagi perayap, jadi sangat mudah untuk mengukurnya: </p><br><ul><li>  Ketentuan otomatis. </li><li>  Tambahkan metrik bisnis. </li><li>  Kumpulkan kesalahan. </li></ul><br><h1 id="mssql">  Msql </h1><br><p><img src="https://habrastorage.org/webt/si/xp/cl/sixpcl7jggtkciqn47cjrbr0sis.png" alt="Msql"></p><br><p>  Basis data kami sekitar 1TB. </p><br><h2 id="mssql-cluster">  MSSQL cluster </h2><br><p>  Ada beberapa cara berbeda cara membuat cluster: </p><br><ol><li>  SQL mirroring. </li><li>  Windows failover cluster - itu bukan kasus karena tidak ada san / Nas. </li><li>  AlwaysOn - itu benar-benar baru bagi kami dan tidak ada keahlian di dalamnya, jadi, itu bukan kasus bagi kami. </li></ol><br><p>  Akibatnya, kami memutuskan untuk menggunakan tanggal 1.  Saya ingin memperhatikan bahwa kami tidak menggunakan saksi karena mode async, jadi kami membuat skrip untuk master sakelar otomatis -&gt; budak &amp; budak manual -&gt; master. </p><br><h2 id="mssql-perfomance">  Kinerja MSSQL </h2><br><p><img src="https://habrastorage.org/webt/ab/fa/hy/abfahya7iiildt32myzsm9sm6jc.png" alt="Msql"></p><br><p>  Jam terus berdetak, kinerja merosot, kami mencari kemacetan.  Kadang-kadang, itu tidak mudah, yaitu mengoptimalkan query SQL dengan disk io, ketika, kami menemukan bahwa kinerjanya rendah karena kurangnya RAM.  Namun itu tidak cukup, sebagai solusi sementara, kami bermigrasi dari HDD ke SSD.  Di satu sisi, itu meningkatkan kinerja secara dramatis, tetapi di sisi lain, itu bukan solusi jangka panjang. </p><br><h1 id="message-queue">  Antrian pesan </h1><br><p><img src="https://habrastorage.org/webt/e-/cx/hx/e-cxhxer9x0dk3avntdiwpbvbcs.png" alt="Antrian pesan"></p><br><p>  Aplikasi kami telah dimigrasikan ke antrian pesan.  Kami hanya menulis hasil dalam database.  Akibatnya, kami mengurangi beban basis data.  Tapi kami menghadapi masalah: bagaimana cara mengatur kluster antrian pesan?  Pada awalnya, kami membuat siaga dingin. </p><br><h1 id="web">  WEB </h1><br><p><img src="https://habrastorage.org/webt/h0/2x/cy/h02xcyis8eh7miz8tn-dz3vdbzy.png" alt="WEB"></p><br><p>  Komponen web terdiri dari dua bagian: konten statis &amp; konten dinamis pengguna. </p><br><h2 id="web-static">  WEB statis </h2><br><p><img src="https://habrastorage.org/webt/rc/lc/ek/rclcekb2jkvua3xc8avbogjnbxq.png" alt="WEB statis"></p><br><p>  Bagian statis infrastruktur WEB adalah sekitar 2TB, ia harus: </p><br><ul><li>  Simpan gambar. </li><li>  Konversi gambar. </li><li>  Merayapi gambar asal &amp; pangkas jika perlu. </li></ul><br><p><img src="https://habrastorage.org/webt/qz/7q/qm/qz7qqm_wh_veujcnwo6a44u9abi.png" alt="WEB statis"></p><br><p>  Ada 2 masalah utama: cara menyinkronkan file &amp; cara membuat cluster web.  Ada beberapa cara bagaimana menyinkronkan file: membeli penyimpanan, menggunakan DFS &amp; menyimpan file di setiap server.  Itu keputusan yang sulit, namun, kami memutuskan untuk memilih cara ke-3.  Untuk kluster web, kami memutuskan untuk menggunakan NLB &amp; CDN. </p><br><h2 id="web-balancer">  WEB Balancer </h2><br><p><img src="https://habrastorage.org/webt/nt/e6/9f/nte69fci_xqh_j5rvayg-o6x9fu.png" alt="WEB Balancer"></p><br><p>  Bukan ide yang bagus untuk menggunakan satu server untuk proyek beban tinggi, Anda harus menyeimbangkan lalu lintas.  Ada 4 cara dalam kasus kami: </p><br><ol><li>  Penyeimbang perangkat keras - terlalu mahal bagi kami. </li><li>  IIS &amp; ARR - terlalu rumit untuk didukung. </li><li>  Nginx - itu cukup baik, namun, kami menghadapi beberapa masalah dengan pemeriksaan kesehatan. </li><li>  Haproxy - itu adalah solusi dengan salah satu overhead terkecil. </li></ol><br><p><img src="https://habrastorage.org/webt/zs/jo/am/zsjoam1tong9nbn84r1hoc5qmo8.png" alt="haproxy"><br>  Kami memilih cara ke-4.  Kami menyeimbangkan haproxy oleh DNS round robin &amp; pengguna dengan cookie. </p><br><h1 id="mongodb">  Mongodb </h1><br><p><img src="https://habrastorage.org/webt/e4/vk/je/e4vkjevef6tp419eee7hiokv3_w.png" alt="Mongodb"></p><br><p>  Beberapa bulan kemudian, kami menghadapi bahwa kinerja SQL tidak cukup baik lagi.  Itu adalah masalah yang canggih, namun, setelah percakapan panjang kami memutuskan untuk memilih <em>Ketersediaan</em> &amp; <em>Toleransi partisi</em> dari <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">teorema CAP</a> .  Sebagai hasilnya, kami mengimplementasikan cluster MongoDB (sharding &amp; replica).  Ada pengalaman yang menarik: cara membuat cadangan MongoDB, cara meningkatkan &amp; banyak bug MongoDB. </p><br><h1 id="backups--monitoring">  Pencadangan &amp; pemantauan </h1><br><p>  Kami menerapkan aturan 3-2-1: </p><br><ul><li>  Setidaknya 3 salinan. </li><li>  Setidaknya 2 jenis penyimpanan yang berbeda. </li><li>  Setidaknya 1 salinan harus disimpan di suatu tempat di luar. </li></ul><br><p>  Kami juga membuat &amp; menguji rencana pemulihan bencana.  Anda dapat membaca tentang pemantauan di <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">sini</a> . </p><br><h2 id="applications-updates">  Pembaruan aplikasi </h2><br><p><img src="https://habrastorage.org/webt/9-/yd/06/9-yd0651cdfemyxqsuo8hecigpm.png" alt="Infrastruktur"></p><br><p>  Seperti yang Anda lihat, infrastrukturnya tidak semudah pie.  Kami harus memperbaruinya entah bagaimana.  Pembaruan kasual terlihat seperti: </p><br><ol><li>  Lakukan beberapa persiapan. </li><li>  Menjalankan migrasi. </li><li>  Perbarui aplikasi web. </li><li>  Perbarui aplikasi backend. </li></ol><br><p>  Semua langkah logis identik untuk lingkungan pementasan / praproduksi / produksi, namun, sedikit berbeda pada detailnya.  Jadi, kami membuat skrip PowerShell dengan sihir OOP.  Itu adalah proses berkelanjutan untuk meningkatkan infrastruktur CI / CD kami. </p><br><h1 id="conclusion">  Kesimpulan </h1><br><table><thead><tr><th></th><th>  2012 </th><th>  2014 </th></tr></thead><tbody><tr><td>  Server </td><td>  3 </td><td>  60 </td></tr><tr><td>  RAM GB </td><td>  72 </td><td>  800 </td></tr><tr><td>  SSD GB </td><td>  200 </td><td>  10.000 </td></tr><tr><td>  MsSQL gb </td><td>  150 </td><td>  700 </td></tr><tr><td>  MongoDB GB </td><td>  0 </td><td>  700 </td></tr><tr><td>  Artikel per hari </td><td>  10.000 </td><td>  150.000 </td></tr></tbody></table><br><p>  Itu adalah kisah yang luar biasa tentang memindahkan 3 PC desktop ke infrastruktur yang andal.  Sabar &amp; lakukan rencana. </p><br><h1 id="ps">  PS </h1><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">dotnetconf (RU)</a> . </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Slide (RU)</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Video (RU)</a> </li><li>  Itu adalah <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">crosspost</a> </li></ul></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/id437186/">https://habr.com/ru/post/id437186/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../id437174/index.html">.NET, TensorFlow, dan kincir angin Kaggle - perjalanan dimulai</a></li>
<li><a href="../id437176/index.html">Aplikasi untuk iOS dan Android di Kotlin + Flutter UI</a></li>
<li><a href="../id437180/index.html">Harsh Siberian JVM: wawancara hebat tentang Excelsior JET</a></li>
<li><a href="../id437182/index.html">Intersepsi panggilan sistem dalam modul Linux-kernel</a></li>
<li><a href="../id437184/index.html">Nikolay Durov 90% menyelesaikan pengembangan platform Telegram Open Network</a></li>
<li><a href="../id437190/index.html">Tentang pemantauan</a></li>
<li><a href="../id437194/index.html">Cloud check list, atau bagaimana pelanggan mengevaluasi kami</a></li>
<li><a href="../id437196/index.html">Global Game Jam 2019 (pengumuman)</a></li>
<li><a href="../id437198/index.html">Global Game Jam 2019 (pengumuman)</a></li>
<li><a href="../id437200/index.html">Cara kami menguji seret & lepas dalam HTML5</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>