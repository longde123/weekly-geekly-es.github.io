<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👩🏼‍🔧 🐹 💺 Telegraff: Kotlin DSL pour Telegram 🧑🏼‍🤝‍🧑🏻 🔓 🍡</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Sur Habré des milliers d'articles sur la façon de créer un bot Telegram pour différents langages de programmation et plates-formes. Le sujet est loin ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Telegraff: Kotlin DSL pour Telegram</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/445072/"><p><img src="https://habrastorage.org/webt/3v/da/0z/3vda0ztz83mtq8efycve_gfyrqa.png" alt="Le logo"></p><br><p>  Sur Habré des milliers d'articles sur la façon de créer un bot Telegram pour différents langages de programmation et plates-formes.  Le sujet est loin d'être nouveau. </p><br><p>  Mais Telegraff est le meilleur cadre pour implémenter les robots Telegram, et je vais le prouver sous la coupe. </p><a name="habracut"></a><br><h2 id="preambula">  Préambule </h2><br><p>  En 2015, le rouble russe avait de la fièvre.  J'ai fait des économies en dollars et j'ai vérifié le taux toutes les cinq minutes pour vendre la monnaie au taux dont j'avais besoin.  La fièvre a traîné, je me suis fatigué et j'ai écrit un bot Telegram ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">@TinkoffRatesBot</a> ), qui vous avertit si le taux de change atteint la valeur seuil (attendue). <br>  J'ai été très touché par cette tâche.  Botha a écrit assez rapidement, mais il n'a pas été satisfait. </p><br><p> L'intégration avec Telegram ne l'est pas et il n'y a eu aucun problème.  Ce problème est résolu en quelques heures.  Et je suis même surpris qu'il y ait des bibliothèques entières en Java (subjectivement, avec du code dégoûtant en qualité) pour l'intégration avec Telegrams, qui ont gagné plus de mille étoiles sur Github. </p><br><p>  Le principal défi pour moi était le système de script: l'utilisateur appelle une commande, par exemple, "/ taxi", le bot lui pose une série de questions, chaque réponse est validée et peut affecter l'ordre des questions suivantes, le "formulaire" habituel est formé, donné à la méthode de traitement final pour former réponse. <br>  Je l'ai fait, mais la structure des classes, les niveaux d'abstraction, tout était si hétérogène que c'était amer à regarder.  J'ai été tourmenté par la question: comment cela peut-il être transposé succinctement et organiquement à un modèle orienté objet? </p><br><p>  Je voulais avoir quelque chose de simple, de pratique et, surtout, de pouvoir décrire l'intégralité du script dans un fichier isolé afin de ne pas avoir besoin de visualiser la moitié du projet pour comprendre la chaîne d'interaction utilisateur. </p><br><p>  Pour ne pas dire que la question était très aiguë, car la tâche a déjà été résolue.  Au contraire, parfois je pensais à lui.  L'idée était Groovy DSL, mais quand Kotlin est arrivé, le choix est devenu évident.  Telegraff est donc apparu. </p><br><p>  Oui, bien sûr, il n'y avait aucune compétition que Telegraff gagnerait.  Et l'affirmation selon laquelle Telegraff est le meilleur ne doit pas être prise au pied de la lettre.  Mais Telegraff est une nouvelle approche unique à ce défi.  Il est facile d'être le meilleur, étant le seul. </p><br><h2 id="kak-etim-polzovatsya">  Comment l'utiliser? </h2><br><h3 id="zavisimosti">  Dépendances </h3><br><p>  La première étape consiste à spécifier un référentiel supplémentaire pour les dépendances.  Peut-être qu'à un moment donné, je publierai Telegraff dans Maven Central ou dans JCenter, mais pour l'instant. </p><br><div class="spoiler">  <b class="spoiler_title">Gradle</b> <div class="spoiler_text"><pre><code class="kotlin hljs">repositories { maven { url <span class="hljs-string"><span class="hljs-string">"https://dl.bintray.com/ruslanys/maven"</span></span> } }</code> </pre> </div></div><br><div class="spoiler">  <b class="spoiler_title">Maven</b> <div class="spoiler_text"><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">repositories</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">repository</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">snapshots</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">enabled</span></span></span><span class="hljs-tag">&gt;</span></span>false<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">enabled</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">snapshots</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">id</span></span></span><span class="hljs-tag">&gt;</span></span>bintray-ruslanys-maven<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">id</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">name</span></span></span><span class="hljs-tag">&gt;</span></span>bintray<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">name</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">url</span></span></span><span class="hljs-tag">&gt;</span></span>https://dl.bintray.com/ruslanys/maven<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">url</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">repository</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">repositories</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> </div></div><br><p>  Cela reste le cas pour les petits.  Pour utiliser Telegraff, vous devez spécifier une seule dépendance Spring-Boot-Starter: </p><br><div class="spoiler">  <b class="spoiler_title">Gradle</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">compile("me.ruslanys.telegraff:telegraff-starter:1.0.0")</code> </pre> </div></div><br><div class="spoiler">  <b class="spoiler_title">Maven</b> <div class="spoiler_text"><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">dependency</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">groupId</span></span></span><span class="hljs-tag">&gt;</span></span>me.ruslanys.telegraff<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">groupId</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">artifactId</span></span></span><span class="hljs-tag">&gt;</span></span>telegraff-starter<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">artifactId</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">version</span></span></span><span class="hljs-tag">&gt;</span></span>1.0.0<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">version</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">dependency</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> </div></div><br><h3 id="konfiguraciya">  La configuration </h3><br><p>  La configuration du projet est simple et peut se limiter aux deux ou trois premiers paramètres: </p><br><div class="spoiler">  <b class="spoiler_title">application.properties</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">telegram.access-key=123 # ① telegram.mode=webhook # ② telegram.webhook-base-url=https://ruslanys.me # ③ telegram.webhook-endpoint-url=/telegram # ④ telegram.handlers-path=handlers # ⑤ telegram.unresolved-filter.enabled=false # ⑥</code> </pre> </div></div><br><ol><li>  Votre clé pour l'API Telegram. </li><li>  Mode de réception des messages (mises à jour) de Telegram.  Il peut s'agir d'un sondage ou d'un webhook. </li><li>  Si la méthode de réception des mises à jour est indiquée par «webhook», vous devez spécifier le chemin d'accès à votre application. </li><li>  Si vous le souhaitez, vous pouvez spécifier votre propre chemin vers le point de terminaison.  Si ce paramètre n'est pas redéfini, un chemin de la forme suivante sera généré: <code>/telegram/${UUID}</code> .  Avant de démarrer l'application, l'adresse spécifiée est définie en tant qu'adresse de raccordement Web.  À la fin du travail, l'adresse du hook Web est écrasée pour pouvoir basculer en interrogation au prochain démarrage. </li><li>  Si vous le souhaitez, vous pouvez modifier le dossier dans lequel les scripts des gestionnaires seront situés.  Par défaut, il s'agit du dossier des <code>handlers</code> . </li><li>  <code>UnresolvedFilter</code> est inclus dans la «livraison» et il est activé par défaut.  Dans le cas où aucun gestionnaire n'a été trouvé sur le message de l'utilisateur, <code>UnresolvedFilter</code> répond avec quelque chose comme "Désolé, je ne vous comprends pas :(". </li></ol><br><p>  Il est temps d'écrire des scripts! </p><br><h3 id="obrabotchiki">  Gestionnaires </h3><br><p>  Les gestionnaires (scripts) sont un élément clé de Telegraff.  C'est là que la chaîne d'interaction utilisateur est définie.  En fin de compte, chaque commande, telle que «/ start», «/ taxi», «/ help», est un script / script / handler / handler distinct. </p><br><p>  Un script peut contenir un ensemble d'étapes (questions) qu'un utilisateur doit parcourir pour exécuter une commande.  En d'autres termes, l'utilisateur doit remplir le formulaire.  Et puisque le messager provient de l'interface, vous devez parler et demander à l'utilisateur. </p><br><p>  Dois-je expliquer que les réponses des utilisateurs doivent être validées?  La première chose que l'utilisateur fera, c'est qu'il répondra différemment de ce que vous attendez. </p><br><p>  Eh bien, au final, le script peut se ramifier, c'est-à-dire  Chaque réponse à une question peut affecter l'ordre des questions suivantes. </p><br><p>  Par exemple! </p><br><p>  Pour commencer, placez le fichier avec l'extension <code>.kts</code> dans le dossier contenant les <code>handlers</code> ressources: <code>src/main/resources/handlers/ExampleHandler.kts</code> . </p><br><div class="spoiler">  <b class="spoiler_title">Scénario d'appel de taxi</b> <div class="spoiler_text"><pre> <code class="kotlin hljs"><span class="hljs-keyword"><span class="hljs-keyword">enum</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PaymentMethod</span></span></span><span class="hljs-class"> </span></span>{ CARD, CASH } handler(<span class="hljs-string"><span class="hljs-string">"/taxi"</span></span>, <span class="hljs-string"><span class="hljs-string">""</span></span>) { <span class="hljs-comment"><span class="hljs-comment">// ① step&lt;String&gt;("locationFrom") { // ② question { // ③ MarkdownMessage(" ?") } } step&lt;String&gt;("locationTo") { question { MarkdownMessage(" ?") } } step&lt;PaymentMethod&gt;("paymentMethod") { question { state -&gt; MarkdownMessage("   ?", "", "") // ④ } validation { // ⑤ when (it.toLowerCase()) { "" -&gt; PaymentMethod.CARD "" -&gt; PaymentMethod.CASH else -&gt; throw ValidationException(",    ") // ⑥ } } next { state -&gt; null // ⑦ } } process { state, answers -&gt; // ⑧ val from = answers["locationFrom"] as String val to = answers["locationTo"] as String val paymentMethod = answers["paymentMethod"] as PaymentMethod // ⑨ // Business logic MarkdownMessage("""     #${state.chat.id}.   $from  $to.  $paymentMethod. """.trimIndent()) // ⑩ } }</span></span></code> </pre> </div></div><br><p>  Les clés des steppes n'ont pas été délibérément prises en constantes.  En production, bien sûr, il vaut mieux éviter cela. </p><br><p>  Voyons cela: </p><br><ol><li>  Nous déclarons le script.  Au moins un nom d'équipe est requis.  Dans ce cas, il y a deux équipes: «/ taxi», «taxi».  Si le message de l'utilisateur commence par ces mots, le gestionnaire correspondant sera appelé. </li><li>  Nous déterminons les étapes (questions).  Un nom d'étape unique est requis car  par la suite, la réponse de l'utilisateur est accessible précisément par cette touche («locationFrom»). </li><li>  Chaque étape contient trois sections, dont la première est la question elle-même.  La question est une section obligatoire qui doit être présente à chaque étape.  Il n'y a aucun sens dans une étape sans question. </li><li>  Vous pouvez remplir la question comme vous le souhaitez.  Dans ce cas, l'utilisateur sera invité par le clavier à sélectionner l'une des options: «Carte» ou «Argent».  À la suite de l'appel de ce bloc, il devrait y avoir un objet de type <code>TelegramSendRequest</code> .  Désolé, je n'ai pas pu trouver mieux que le suffixe <code>SendRequest</code> , qui décrit la structure comme une demande sortante dans Telegram. <br><img src="https://habrastorage.org/webt/zc/fg/u0/zcfgu08yo--cn3bhnrnhawcfad0.png" alt="Structure des classes"></li><li>  La deuxième section de l'étape la plus importante consiste à vérifier la réponse de l'utilisateur.  Le type de chaque étape est paramétré (générique), et par conséquent, le bloc de validation doit retourner exactement le type par lequel son étape est paramétrée. </li><li>  Si la réponse de l'utilisateur n'est pas satisfaisante, vous pouvez lever une <code>ValidationException</code> avec un texte de clarification, mais le même clavier, si cela a été indiqué dans la question. </li><li>  La dernière étape est un bloc indiquant l'étape suivante.  Par défaut, les étapes seront exécutées dans l'ordre de leur déclaration, de haut en bas.  Mais ce processus peut être influencé en remplaçant le bloc correspondant.  La clé de l'étape suivante ( <code>String</code> ) ou «null» peut être retournée à la suite de l'exécution de ce bloc, indiquant qu'il n'y a plus d'étapes et qu'il est temps de procéder à l'exécution de la commande. </li><li>  Lorsqu'une demande d'utilisateur est générée, son traitement est requis.  Les arguments dans le lambda sont State (c'est quelque chose comme une session) et les réponses des utilisateurs. </li><li>  Notez que la réponse ayant échoué n'est plus la chaîne de réponse de l'utilisateur, mais un objet déjà traité du type souhaité. </li><li>  La réponse à la commande peut être quelconque, similaire au paragraphe 4. Si la réponse à la commande n'est pas requise, vous pouvez retourner "null". </li></ol><br><p>  Un gestionnaire peut ne pas avoir d'étapes du tout.  Dans ce cas, il vous suffit de déterminer le comportement du gestionnaire pour appeler la commande. </p><br><div class="spoiler">  <b class="spoiler_title">Script de bienvenue</b> <div class="spoiler_text"><pre> <code class="kotlin hljs">handler(<span class="hljs-string"><span class="hljs-string">"/start"</span></span>) { process { _, _ -&gt; MarkdownMessage(<span class="hljs-string"><span class="hljs-string">"!"</span></span>) } }</code> </pre> </div></div><br><h3 id="probuem">  Essayez </h3><br><p>  Pour essayer, forkez le <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">référentiel</a> , clonez-le sur la machine locale et accédez au dossier <code>telegraff-sample</code> .  Configurez, lancez, touchez! </p><br><p>  En général, <code>telegraff-sample</code> est un projet délibérément indépendant qui n'est pas lié au parent et a même son propre Gradle Wrapper.  Vous ne pouvez laisser que ce dossier.  C'est une sorte d'archétype. </p><br><h2 id="kak-eto-ustroeno">  Comment ça marche? </h2><br><h3 id="telegram">  Télégramme </h3><br><p>  L'intégration avec Telegram est très simple et implémentée dans <a href=""><code>TelegramApi</code></a> . </p><br><p>  Chaque méthode a été délibérément implémentée individuellement en raison d'un certain nombre de circonstances: à partir de l'utilisation de Spring's RestTemplate (et des tests pour celui-ci), à la spécificité de l'API Telegram. </p><br><p>  Comme vous pouvez le voir dans la configuration, il existe deux types de clients de cette API dans Telegraff: <a href="">PollingClient</a> , <a href="">WebhookClient</a> .  Selon la configuration, un bac particulier sera déclaré. </p><br><p>  Et bien que les méthodes de réception des mises à jour (nouveaux messages) diffèrent de Telegram, l'essence est inchangée et se résume à une chose - publier un événement ( <a href=""><code>TelegramUpdateEvent</code></a> ) sur les nouveaux messages via <code>EventPublisher</code> de Spring ( <code>EventPublisher</code> «Observer»).  Si vous le souhaitez, vous pouvez implémenter votre propre écouteur en vous abonnant à ce type d'événement.  Une couche d'abstraction logique, me semble-t-il, car la façon dont le message a été reçu n'a absolument aucune importance. </p><br><h3 id="filtry">  Filtres </h3><br><p>  Dès qu'un nouveau message est reçu, il est nécessaire de le traiter et de répondre à l'utilisateur.  Pour ce faire, le message doit passer par la chaîne de filtrage. </p><br><p>  Ceci est similaire aux filtres Java EE familiers aux programmeurs Java.  La seule différence est que les soi-disant gestionnaires (si nous établissons un parallèle avec Java EE, ce sont des servlets) ne sont pas indépendants des filtres, mais en font partie. </p><br><p><img src="https://habrastorage.org/webt/uo/ok/y8/uooky82zpiurpncn-szq4bdejni.png" alt="Chaîne de filtre"></p><br><p>  Ainsi, les filtres sont rationalisés et peuvent laisser les messages aller plus loin dans la chaîne, peut-être pas. </p><br><p>  <code>LoggingFilter</code> est évidemment le premier (premier) filtre de priorité qui sera appelé dans le cadre du traitement d'un nouveau message.  Enregistre les informations sur un message entrant et les envoie plus loin dans la chaîne.  J'ai volontairement ajouté <code>LoggingFilter</code> comme exemple.  En fait, cela peut ne pas avoir de sens, car  Les messages entrants sont enregistrés au niveau du client. </p><br><p>  Le filtre suivant est <code>CancelFilter</code> .  Il fonctionne essentiellement en conjonction avec <code>HandlersFilter</code> et est un complément à celui-ci.  Sa tâche est simple: si l'utilisateur veut abandonner le script en cours, il peut écrire «/ annuler» ou «annuler» et son statut (session) doit être effacé.  Il peut commencer n'importe quel nouveau scénario sans terminer le précédent.  Pour cette raison, <code>CancelFilter</code> «supérieur» (prioritaire). </p><br><p>  <code>HandlersFilter</code> est le filtre principal du processus actuel.  C'est ce filtre qui stocke l'état des conversations utilisateur, trouve et appelle le gestionnaire souhaité (script), applique les blocs de validation, détermine l'ordre des étapes et répond à l'utilisateur. </p><br><p>  Si <code>HandlersFilter</code> n'a trouvé aucun gestionnaire approprié pour le message utilisateur, que ce soit dans la session ou dans le contenu, le message est envoyé plus bas dans la chaîne.  Le filtre extrême est <code>UnresolvedFilter</code> .  C'est un filtre qui sait que c'est le dernier, donc sa fonctionnalité est simple: s'ils m'ont atteint, comment répondre à un message n'est pas clair, je dirai que je n'ai rien compris.  Il me semble qu'il vaut mieux recevoir au moins quelques messages du bot s'il ne sait pas répondre, que de ne rien recevoir du tout. </p><br><p>  Pour ajouter votre filtre, vous devez déclarer un Bean de la classe <code>TelegramFilter</code> et spécifier l'annotation <code>@TelegramFilterOrder(ORDER_NUMBER)</code> . </p><br><div class="spoiler">  <b class="spoiler_title">Exemple de filtre</b> <div class="spoiler_text"><pre> <code class="kotlin hljs"><span class="hljs-meta"><span class="hljs-meta">@Component</span></span> <span class="hljs-meta"><span class="hljs-meta">@TelegramFilterOrder(Integer.MIN_VALUE)</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">LoggingFilter</span></span></span><span class="hljs-class"> : </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">TelegramFilter { override fun handleMessage</span></span></span></span>(message: TelegramMessage, chain: TelegramFilterChain) { log.info(<span class="hljs-string"><span class="hljs-string">"New message from #{}: {}"</span></span>, message.chat.id, message.text) chain.doFilter(message) } <span class="hljs-keyword"><span class="hljs-keyword">companion</span></span> <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> log = LoggerFactory.getLogger(LoggingFilter::<span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">java</span></span></span><span class="hljs-class">) } }</span></span></code> </pre> </div></div><br><p>  C'est ainsi que <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">@TinkoffRatesBot</a> implémente une «calculatrice».  Sans appeler de script et de commande, vous pouvez envoyer un nombre, par exemple, "1000", ou même une expression entière, par exemple, "4500 * 3 - 12000".  Le bot calculera le résultat de l'expression, appliquera les taux de change actuels au résultat et affichera des informations à ce sujet.  En fait, le résultat de ces actions est l'exécution du <code>CalculationFilter</code> , qui est dans la chaîne en dessous du <code>HandlersFilter</code> , mais au-dessus du <code>UnresolvedFilter</code> . </p><br><h3 id="obrabotchiki-1">  Gestionnaires </h3><br><p>  Le système de script Telegraff (gestionnaires) est basé sur le DSL Kotlin.  En bref, il s'agit de lambdas et de constructeurs. </p><br><p>  Je ne vois pas l'intérêt de visualiser séparément le DSL Kotlin, car  c'est une conversation complètement différente.  Il existe une excellente <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">documentation</a> de JetBrains et un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">rapport</a> complet d' <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" class="user_link">i_osipov</a> . </p><br><h3 id="nyuansy">  Nuances </h3><br><p>  Cette section est consacrée aux fonctionnalités actuelles.  Tous, à mon avis, ne sont pas critiques, certains peuvent être corrigés, d'autres non.  Mais vous devez connaître ces aspects. </p><br><p>  Si vous souhaitez participer ou savoir comment corriger l'un ou l'autre point de cette section, je vous en serai très reconnaissant. </p><br><h4 id="telegram-1">  Télégramme </h4><br><p>  La couche d'intégration avec Telegram n'est probablement pas entièrement décrite.  Seules les méthodes dont j'avais besoin ont été mises en œuvre.  S'il y a quelque chose qui vous manque personnellement, corrigez <a href=""><code>TelegramApi</code></a> et envoyez des RP! </p><br><p>  Pour le moment, le manque de prise en charge du clavier en ligne est important (c'est lorsque le clavier est directement en dessous du message dans le ruban).  La tâche est aggravée par le fait que les claviers en ligne doivent être correctement «introduits» dans la structure existante afin qu'elle reste simple, pratique et isolée.  Il existe déjà une bonne idée pour implémenter cette fonctionnalité, mais elle n'a pas encore été implémentée et testée sous aucune forme. </p><br><h4 id="fat-jar">  Pot de graisse </h4><br><p>  Malheureusement, certaines bibliothèques, telles que <code>JRuby</code> et probablement le <code>Kotlin Embedded Compiler</code> (nécessaire pour la compilation de scripts) peuvent avoir des problèmes dans le cadre du <code>Fat JAR</code> .  <code>Fat JAR</code> c'est quand votre code et toutes vos dépendances sont regroupés dans un seul fichier ( <code>*.jar</code> ). </p><br><p>  Afin de résoudre ce problème, vous pouvez décompresser les dépendances lors de l'exécution.  En d'autres termes, lorsque l'application démarre, le fichier JAR de dépendance du package principal est déployé quelque part sur le disque et le chemin de classe est indiqué avant celui-ci.  C'est assez facile à faire grâce à <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">la configuration</a> <code>bootJar</code> : </p><br><div class="spoiler">  <b class="spoiler_title">Configuration du plugin</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">bootJar { requiresUnpack "**/**kotlin**.jar" requiresUnpack "**/**telegraff**.jar" }</code> </pre> </div></div><br><p>  Cependant, afin de se référer des gestionnaires (scripts) à vos beans (services, par exemple), ils doivent également être décompressés.  Ce qui, en principe, élimine le bénéfice de cette approche. </p><br><p>  Selon moi, l'utilisation du plugin d' <code>application</code> Gradle reste la méthode la plus fiable, simple et pratique.  De plus, si vous conteneurisez votre application, il n'y a pas de différence par le résultat. </p><br><p>  À propos de tout cela, j'ai écrit en détail <a href="">ici</a> . </p><br><h4 id="poryadok-inicializacii">  Ordre d'initialisation </h4><br><p>  Ici, je voudrais noter deux circonstances. </p><br><p>  Premièrement, si vous regardez le scénario d'appel de taxi, vous pouvez voir que la classe <code>enum</code> est définie au-dessus de l'appel au <code>handler(...)</code> .  Cette nécessité est imposée par le fait qu'en fait, <code>handler</code> est un appel de fonction.  Un appel de fonction, dont le résultat devrait être une structure, que Telegraff utilisera plus tard.  Si, selon le résultat de l'exécution de votre script, la fabrique ne peut pas amener le résultat au type souhaité, une erreur va se produire lors de l'initialisation. </p><br><p>  Deuxièmement, vous devez vous rappeler que vos scripts peuvent être initialisés plus tôt que l'ensemble de votre application et de vos beans.  Si, par exemple, nous mettons un lien vers le contexte dans une variable statique et essayons d'obtenir un service sur la première ligne du fichier de script, il se peut que le contexte ne l'ait pas, car  il n'a pas encore été initialisé.  Afin d'éviter de tels problèmes, utilisez <a href="">cette</a> méthode Telegraff.  Il garantit que le contexte est initialisé et que tous les beans nécessaires sont disponibles.  Un exemple peut être vu <a href="">ici</a> . </p><br><h2 id="zaklyuchenie">  Conclusion </h2><br><p>  Je voulais essayer - fourchette, <br>  Je voulais le réparer - envoyer des relations publiques, <br>  Je voulais remercier - mettre un astérisque dans Github, comme le message et le dire à vos amis! </p><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Dépôt de projets</a> </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr445072/">https://habr.com/ru/post/fr445072/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr445060/index.html">Organisation des recherches de données à l'aide des référentiels de valeurs-clés Spring Data</a></li>
<li><a href="../fr445062/index.html">Format de présentation moderne?</a></li>
<li><a href="../fr445064/index.html">La bataille pour la neutralité du net - une chance de revenir</a></li>
<li><a href="../fr445066/index.html">Comment j'écris des notes mathématiques sur LaTeX dans Vim</a></li>
<li><a href="../fr445070/index.html">Le condensé de matériaux intéressants pour le développeur mobile # 291 (18 mars - 24 mars)</a></li>
<li><a href="../fr445074/index.html">Programmation de LibreOffice Base. Partie 1</a></li>
<li><a href="../fr445076/index.html">Le géant informatique a introduit un pare-feu défini par service</a></li>
<li><a href="../fr445078/index.html">La physique quantique est susceptible de protéger les réseaux électriques américains contre les pirates</a></li>
<li><a href="../fr445080/index.html">En Russie, va créer un "chemin de fer numérique"</a></li>
<li><a href="../fr445082/index.html">Le mois dernier, nous avons appelé Zuckerberg un boob; corrigé: en fait, lui et son Facebook sont juste une putain de honte</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>