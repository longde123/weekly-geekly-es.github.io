<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ğŸ‘©ğŸ¼â€ğŸ”§ ğŸ¹ ğŸ’º Telegraff: Kotlin DSL pour Telegram ğŸ§‘ğŸ¼â€ğŸ¤â€ğŸ§‘ğŸ» ğŸ”“ ğŸ¡</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Sur HabrÃ© des milliers d'articles sur la faÃ§on de crÃ©er un bot Telegram pour diffÃ©rents langages de programmation et plates-formes. Le sujet est loin ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Telegraff: Kotlin DSL pour Telegram</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/445072/"><p><img src="https://habrastorage.org/webt/3v/da/0z/3vda0ztz83mtq8efycve_gfyrqa.png" alt="Le logo"></p><br><p>  Sur HabrÃ© des milliers d'articles sur la faÃ§on de crÃ©er un bot Telegram pour diffÃ©rents langages de programmation et plates-formes.  Le sujet est loin d'Ãªtre nouveau. </p><br><p>  Mais Telegraff est le meilleur cadre pour implÃ©menter les robots Telegram, et je vais le prouver sous la coupe. </p><a name="habracut"></a><br><h2 id="preambula">  PrÃ©ambule </h2><br><p>  En 2015, le rouble russe avait de la fiÃ¨vre.  J'ai fait des Ã©conomies en dollars et j'ai vÃ©rifiÃ© le taux toutes les cinq minutes pour vendre la monnaie au taux dont j'avais besoin.  La fiÃ¨vre a traÃ®nÃ©, je me suis fatiguÃ© et j'ai Ã©crit un bot Telegram ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">@TinkoffRatesBot</a> ), qui vous avertit si le taux de change atteint la valeur seuil (attendue). <br>  J'ai Ã©tÃ© trÃ¨s touchÃ© par cette tÃ¢che.  Botha a Ã©crit assez rapidement, mais il n'a pas Ã©tÃ© satisfait. </p><br><p> L'intÃ©gration avec Telegram ne l'est pas et il n'y a eu aucun problÃ¨me.  Ce problÃ¨me est rÃ©solu en quelques heures.  Et je suis mÃªme surpris qu'il y ait des bibliothÃ¨ques entiÃ¨res en Java (subjectivement, avec du code dÃ©goÃ»tant en qualitÃ©) pour l'intÃ©gration avec Telegrams, qui ont gagnÃ© plus de mille Ã©toiles sur Github. </p><br><p>  Le principal dÃ©fi pour moi Ã©tait le systÃ¨me de script: l'utilisateur appelle une commande, par exemple, "/ taxi", le bot lui pose une sÃ©rie de questions, chaque rÃ©ponse est validÃ©e et peut affecter l'ordre des questions suivantes, le "formulaire" habituel est formÃ©, donnÃ© Ã  la mÃ©thode de traitement final pour former rÃ©ponse. <br>  Je l'ai fait, mais la structure des classes, les niveaux d'abstraction, tout Ã©tait si hÃ©tÃ©rogÃ¨ne que c'Ã©tait amer Ã  regarder.  J'ai Ã©tÃ© tourmentÃ© par la question: comment cela peut-il Ãªtre transposÃ© succinctement et organiquement Ã  un modÃ¨le orientÃ© objet? </p><br><p>  Je voulais avoir quelque chose de simple, de pratique et, surtout, de pouvoir dÃ©crire l'intÃ©gralitÃ© du script dans un fichier isolÃ© afin de ne pas avoir besoin de visualiser la moitiÃ© du projet pour comprendre la chaÃ®ne d'interaction utilisateur. </p><br><p>  Pour ne pas dire que la question Ã©tait trÃ¨s aiguÃ«, car la tÃ¢che a dÃ©jÃ  Ã©tÃ© rÃ©solue.  Au contraire, parfois je pensais Ã  lui.  L'idÃ©e Ã©tait Groovy DSL, mais quand Kotlin est arrivÃ©, le choix est devenu Ã©vident.  Telegraff est donc apparu. </p><br><p>  Oui, bien sÃ»r, il n'y avait aucune compÃ©tition que Telegraff gagnerait.  Et l'affirmation selon laquelle Telegraff est le meilleur ne doit pas Ãªtre prise au pied de la lettre.  Mais Telegraff est une nouvelle approche unique Ã  ce dÃ©fi.  Il est facile d'Ãªtre le meilleur, Ã©tant le seul. </p><br><h2 id="kak-etim-polzovatsya">  Comment l'utiliser? </h2><br><h3 id="zavisimosti">  DÃ©pendances </h3><br><p>  La premiÃ¨re Ã©tape consiste Ã  spÃ©cifier un rÃ©fÃ©rentiel supplÃ©mentaire pour les dÃ©pendances.  Peut-Ãªtre qu'Ã  un moment donnÃ©, je publierai Telegraff dans Maven Central ou dans JCenter, mais pour l'instant. </p><br><div class="spoiler">  <b class="spoiler_title">Gradle</b> <div class="spoiler_text"><pre><code class="kotlin hljs">repositories { maven { url <span class="hljs-string"><span class="hljs-string">"https://dl.bintray.com/ruslanys/maven"</span></span> } }</code> </pre> </div></div><br><div class="spoiler">  <b class="spoiler_title">Maven</b> <div class="spoiler_text"><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">repositories</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">repository</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">snapshots</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">enabled</span></span></span><span class="hljs-tag">&gt;</span></span>false<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">enabled</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">snapshots</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">id</span></span></span><span class="hljs-tag">&gt;</span></span>bintray-ruslanys-maven<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">id</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">name</span></span></span><span class="hljs-tag">&gt;</span></span>bintray<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">name</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">url</span></span></span><span class="hljs-tag">&gt;</span></span>https://dl.bintray.com/ruslanys/maven<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">url</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">repository</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">repositories</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> </div></div><br><p>  Cela reste le cas pour les petits.  Pour utiliser Telegraff, vous devez spÃ©cifier une seule dÃ©pendance Spring-Boot-Starter: </p><br><div class="spoiler">  <b class="spoiler_title">Gradle</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">compile("me.ruslanys.telegraff:telegraff-starter:1.0.0")</code> </pre> </div></div><br><div class="spoiler">  <b class="spoiler_title">Maven</b> <div class="spoiler_text"><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">dependency</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">groupId</span></span></span><span class="hljs-tag">&gt;</span></span>me.ruslanys.telegraff<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">groupId</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">artifactId</span></span></span><span class="hljs-tag">&gt;</span></span>telegraff-starter<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">artifactId</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">version</span></span></span><span class="hljs-tag">&gt;</span></span>1.0.0<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">version</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">dependency</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> </div></div><br><h3 id="konfiguraciya">  La configuration </h3><br><p>  La configuration du projet est simple et peut se limiter aux deux ou trois premiers paramÃ¨tres: </p><br><div class="spoiler">  <b class="spoiler_title">application.properties</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">telegram.access-key=123 # â‘  telegram.mode=webhook # â‘¡ telegram.webhook-base-url=https://ruslanys.me # â‘¢ telegram.webhook-endpoint-url=/telegram # â‘£ telegram.handlers-path=handlers # â‘¤ telegram.unresolved-filter.enabled=false # â‘¥</code> </pre> </div></div><br><ol><li>  Votre clÃ© pour l'API Telegram. </li><li>  Mode de rÃ©ception des messages (mises Ã  jour) de Telegram.  Il peut s'agir d'un sondage ou d'un webhook. </li><li>  Si la mÃ©thode de rÃ©ception des mises Ã  jour est indiquÃ©e par Â«webhookÂ», vous devez spÃ©cifier le chemin d'accÃ¨s Ã  votre application. </li><li>  Si vous le souhaitez, vous pouvez spÃ©cifier votre propre chemin vers le point de terminaison.  Si ce paramÃ¨tre n'est pas redÃ©fini, un chemin de la forme suivante sera gÃ©nÃ©rÃ©: <code>/telegram/${UUID}</code> .  Avant de dÃ©marrer l'application, l'adresse spÃ©cifiÃ©e est dÃ©finie en tant qu'adresse de raccordement Web.  Ã€ la fin du travail, l'adresse du hook Web est Ã©crasÃ©e pour pouvoir basculer en interrogation au prochain dÃ©marrage. </li><li>  Si vous le souhaitez, vous pouvez modifier le dossier dans lequel les scripts des gestionnaires seront situÃ©s.  Par dÃ©faut, il s'agit du dossier des <code>handlers</code> . </li><li>  <code>UnresolvedFilter</code> est inclus dans la Â«livraisonÂ» et il est activÃ© par dÃ©faut.  Dans le cas oÃ¹ aucun gestionnaire n'a Ã©tÃ© trouvÃ© sur le message de l'utilisateur, <code>UnresolvedFilter</code> rÃ©pond avec quelque chose comme "DÃ©solÃ©, je ne vous comprends pas :(". </li></ol><br><p>  Il est temps d'Ã©crire des scripts! </p><br><h3 id="obrabotchiki">  Gestionnaires </h3><br><p>  Les gestionnaires (scripts) sont un Ã©lÃ©ment clÃ© de Telegraff.  C'est lÃ  que la chaÃ®ne d'interaction utilisateur est dÃ©finie.  En fin de compte, chaque commande, telle que Â«/ startÂ», Â«/ taxiÂ», Â«/ helpÂ», est un script / script / handler / handler distinct. </p><br><p>  Un script peut contenir un ensemble d'Ã©tapes (questions) qu'un utilisateur doit parcourir pour exÃ©cuter une commande.  En d'autres termes, l'utilisateur doit remplir le formulaire.  Et puisque le messager provient de l'interface, vous devez parler et demander Ã  l'utilisateur. </p><br><p>  Dois-je expliquer que les rÃ©ponses des utilisateurs doivent Ãªtre validÃ©es?  La premiÃ¨re chose que l'utilisateur fera, c'est qu'il rÃ©pondra diffÃ©remment de ce que vous attendez. </p><br><p>  Eh bien, au final, le script peut se ramifier, c'est-Ã -dire  Chaque rÃ©ponse Ã  une question peut affecter l'ordre des questions suivantes. </p><br><p>  Par exemple! </p><br><p>  Pour commencer, placez le fichier avec l'extension <code>.kts</code> dans le dossier contenant les <code>handlers</code> ressources: <code>src/main/resources/handlers/ExampleHandler.kts</code> . </p><br><div class="spoiler">  <b class="spoiler_title">ScÃ©nario d'appel de taxi</b> <div class="spoiler_text"><pre> <code class="kotlin hljs"><span class="hljs-keyword"><span class="hljs-keyword">enum</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PaymentMethod</span></span></span><span class="hljs-class"> </span></span>{ CARD, CASH } handler(<span class="hljs-string"><span class="hljs-string">"/taxi"</span></span>, <span class="hljs-string"><span class="hljs-string">""</span></span>) { <span class="hljs-comment"><span class="hljs-comment">// â‘  step&lt;String&gt;("locationFrom") { // â‘¡ question { // â‘¢ MarkdownMessage(" ?") } } step&lt;String&gt;("locationTo") { question { MarkdownMessage(" ?") } } step&lt;PaymentMethod&gt;("paymentMethod") { question { state -&gt; MarkdownMessage("   ?", "", "") // â‘£ } validation { // â‘¤ when (it.toLowerCase()) { "" -&gt; PaymentMethod.CARD "" -&gt; PaymentMethod.CASH else -&gt; throw ValidationException(",    ") // â‘¥ } } next { state -&gt; null // â‘¦ } } process { state, answers -&gt; // â‘§ val from = answers["locationFrom"] as String val to = answers["locationTo"] as String val paymentMethod = answers["paymentMethod"] as PaymentMethod // â‘¨ // Business logic MarkdownMessage("""     #${state.chat.id}.   $from  $to.  $paymentMethod. """.trimIndent()) // â‘© } }</span></span></code> </pre> </div></div><br><p>  Les clÃ©s des steppes n'ont pas Ã©tÃ© dÃ©libÃ©rÃ©ment prises en constantes.  En production, bien sÃ»r, il vaut mieux Ã©viter cela. </p><br><p>  Voyons cela: </p><br><ol><li>  Nous dÃ©clarons le script.  Au moins un nom d'Ã©quipe est requis.  Dans ce cas, il y a deux Ã©quipes: Â«/ taxiÂ», Â«taxiÂ».  Si le message de l'utilisateur commence par ces mots, le gestionnaire correspondant sera appelÃ©. </li><li>  Nous dÃ©terminons les Ã©tapes (questions).  Un nom d'Ã©tape unique est requis car  par la suite, la rÃ©ponse de l'utilisateur est accessible prÃ©cisÃ©ment par cette touche (Â«locationFromÂ»). </li><li>  Chaque Ã©tape contient trois sections, dont la premiÃ¨re est la question elle-mÃªme.  La question est une section obligatoire qui doit Ãªtre prÃ©sente Ã  chaque Ã©tape.  Il n'y a aucun sens dans une Ã©tape sans question. </li><li>  Vous pouvez remplir la question comme vous le souhaitez.  Dans ce cas, l'utilisateur sera invitÃ© par le clavier Ã  sÃ©lectionner l'une des options: Â«CarteÂ» ou Â«ArgentÂ».  Ã€ la suite de l'appel de ce bloc, il devrait y avoir un objet de type <code>TelegramSendRequest</code> .  DÃ©solÃ©, je n'ai pas pu trouver mieux que le suffixe <code>SendRequest</code> , qui dÃ©crit la structure comme une demande sortante dans Telegram. <br><img src="https://habrastorage.org/webt/zc/fg/u0/zcfgu08yo--cn3bhnrnhawcfad0.png" alt="Structure des classes"></li><li>  La deuxiÃ¨me section de l'Ã©tape la plus importante consiste Ã  vÃ©rifier la rÃ©ponse de l'utilisateur.  Le type de chaque Ã©tape est paramÃ©trÃ© (gÃ©nÃ©rique), et par consÃ©quent, le bloc de validation doit retourner exactement le type par lequel son Ã©tape est paramÃ©trÃ©e. </li><li>  Si la rÃ©ponse de l'utilisateur n'est pas satisfaisante, vous pouvez lever une <code>ValidationException</code> avec un texte de clarification, mais le mÃªme clavier, si cela a Ã©tÃ© indiquÃ© dans la question. </li><li>  La derniÃ¨re Ã©tape est un bloc indiquant l'Ã©tape suivante.  Par dÃ©faut, les Ã©tapes seront exÃ©cutÃ©es dans l'ordre de leur dÃ©claration, de haut en bas.  Mais ce processus peut Ãªtre influencÃ© en remplaÃ§ant le bloc correspondant.  La clÃ© de l'Ã©tape suivante ( <code>String</code> ) ou Â«nullÂ» peut Ãªtre retournÃ©e Ã  la suite de l'exÃ©cution de ce bloc, indiquant qu'il n'y a plus d'Ã©tapes et qu'il est temps de procÃ©der Ã  l'exÃ©cution de la commande. </li><li>  Lorsqu'une demande d'utilisateur est gÃ©nÃ©rÃ©e, son traitement est requis.  Les arguments dans le lambda sont State (c'est quelque chose comme une session) et les rÃ©ponses des utilisateurs. </li><li>  Notez que la rÃ©ponse ayant Ã©chouÃ© n'est plus la chaÃ®ne de rÃ©ponse de l'utilisateur, mais un objet dÃ©jÃ  traitÃ© du type souhaitÃ©. </li><li>  La rÃ©ponse Ã  la commande peut Ãªtre quelconque, similaire au paragraphe 4. Si la rÃ©ponse Ã  la commande n'est pas requise, vous pouvez retourner "null". </li></ol><br><p>  Un gestionnaire peut ne pas avoir d'Ã©tapes du tout.  Dans ce cas, il vous suffit de dÃ©terminer le comportement du gestionnaire pour appeler la commande. </p><br><div class="spoiler">  <b class="spoiler_title">Script de bienvenue</b> <div class="spoiler_text"><pre> <code class="kotlin hljs">handler(<span class="hljs-string"><span class="hljs-string">"/start"</span></span>) { process { _, _ -&gt; MarkdownMessage(<span class="hljs-string"><span class="hljs-string">"!"</span></span>) } }</code> </pre> </div></div><br><h3 id="probuem">  Essayez </h3><br><p>  Pour essayer, forkez le <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">rÃ©fÃ©rentiel</a> , clonez-le sur la machine locale et accÃ©dez au dossier <code>telegraff-sample</code> .  Configurez, lancez, touchez! </p><br><p>  En gÃ©nÃ©ral, <code>telegraff-sample</code> est un projet dÃ©libÃ©rÃ©ment indÃ©pendant qui n'est pas liÃ© au parent et a mÃªme son propre Gradle Wrapper.  Vous ne pouvez laisser que ce dossier.  C'est une sorte d'archÃ©type. </p><br><h2 id="kak-eto-ustroeno">  Comment Ã§a marche? </h2><br><h3 id="telegram">  TÃ©lÃ©gramme </h3><br><p>  L'intÃ©gration avec Telegram est trÃ¨s simple et implÃ©mentÃ©e dans <a href=""><code>TelegramApi</code></a> . </p><br><p>  Chaque mÃ©thode a Ã©tÃ© dÃ©libÃ©rÃ©ment implÃ©mentÃ©e individuellement en raison d'un certain nombre de circonstances: Ã  partir de l'utilisation de Spring's RestTemplate (et des tests pour celui-ci), Ã  la spÃ©cificitÃ© de l'API Telegram. </p><br><p>  Comme vous pouvez le voir dans la configuration, il existe deux types de clients de cette API dans Telegraff: <a href="">PollingClient</a> , <a href="">WebhookClient</a> .  Selon la configuration, un bac particulier sera dÃ©clarÃ©. </p><br><p>  Et bien que les mÃ©thodes de rÃ©ception des mises Ã  jour (nouveaux messages) diffÃ¨rent de Telegram, l'essence est inchangÃ©e et se rÃ©sume Ã  une chose - publier un Ã©vÃ©nement ( <a href=""><code>TelegramUpdateEvent</code></a> ) sur les nouveaux messages via <code>EventPublisher</code> de Spring ( <code>EventPublisher</code> Â«ObserverÂ»).  Si vous le souhaitez, vous pouvez implÃ©menter votre propre Ã©couteur en vous abonnant Ã  ce type d'Ã©vÃ©nement.  Une couche d'abstraction logique, me semble-t-il, car la faÃ§on dont le message a Ã©tÃ© reÃ§u n'a absolument aucune importance. </p><br><h3 id="filtry">  Filtres </h3><br><p>  DÃ¨s qu'un nouveau message est reÃ§u, il est nÃ©cessaire de le traiter et de rÃ©pondre Ã  l'utilisateur.  Pour ce faire, le message doit passer par la chaÃ®ne de filtrage. </p><br><p>  Ceci est similaire aux filtres Java EE familiers aux programmeurs Java.  La seule diffÃ©rence est que les soi-disant gestionnaires (si nous Ã©tablissons un parallÃ¨le avec Java EE, ce sont des servlets) ne sont pas indÃ©pendants des filtres, mais en font partie. </p><br><p><img src="https://habrastorage.org/webt/uo/ok/y8/uooky82zpiurpncn-szq4bdejni.png" alt="ChaÃ®ne de filtre"></p><br><p>  Ainsi, les filtres sont rationalisÃ©s et peuvent laisser les messages aller plus loin dans la chaÃ®ne, peut-Ãªtre pas. </p><br><p>  <code>LoggingFilter</code> est Ã©videmment le premier (premier) filtre de prioritÃ© qui sera appelÃ© dans le cadre du traitement d'un nouveau message.  Enregistre les informations sur un message entrant et les envoie plus loin dans la chaÃ®ne.  J'ai volontairement ajoutÃ© <code>LoggingFilter</code> comme exemple.  En fait, cela peut ne pas avoir de sens, car  Les messages entrants sont enregistrÃ©s au niveau du client. </p><br><p>  Le filtre suivant est <code>CancelFilter</code> .  Il fonctionne essentiellement en conjonction avec <code>HandlersFilter</code> et est un complÃ©ment Ã  celui-ci.  Sa tÃ¢che est simple: si l'utilisateur veut abandonner le script en cours, il peut Ã©crire Â«/ annulerÂ» ou Â«annulerÂ» et son statut (session) doit Ãªtre effacÃ©.  Il peut commencer n'importe quel nouveau scÃ©nario sans terminer le prÃ©cÃ©dent.  Pour cette raison, <code>CancelFilter</code> Â«supÃ©rieurÂ» (prioritaire). </p><br><p>  <code>HandlersFilter</code> est le filtre principal du processus actuel.  C'est ce filtre qui stocke l'Ã©tat des conversations utilisateur, trouve et appelle le gestionnaire souhaitÃ© (script), applique les blocs de validation, dÃ©termine l'ordre des Ã©tapes et rÃ©pond Ã  l'utilisateur. </p><br><p>  Si <code>HandlersFilter</code> n'a trouvÃ© aucun gestionnaire appropriÃ© pour le message utilisateur, que ce soit dans la session ou dans le contenu, le message est envoyÃ© plus bas dans la chaÃ®ne.  Le filtre extrÃªme est <code>UnresolvedFilter</code> .  C'est un filtre qui sait que c'est le dernier, donc sa fonctionnalitÃ© est simple: s'ils m'ont atteint, comment rÃ©pondre Ã  un message n'est pas clair, je dirai que je n'ai rien compris.  Il me semble qu'il vaut mieux recevoir au moins quelques messages du bot s'il ne sait pas rÃ©pondre, que de ne rien recevoir du tout. </p><br><p>  Pour ajouter votre filtre, vous devez dÃ©clarer un Bean de la classe <code>TelegramFilter</code> et spÃ©cifier l'annotation <code>@TelegramFilterOrder(ORDER_NUMBER)</code> . </p><br><div class="spoiler">  <b class="spoiler_title">Exemple de filtre</b> <div class="spoiler_text"><pre> <code class="kotlin hljs"><span class="hljs-meta"><span class="hljs-meta">@Component</span></span> <span class="hljs-meta"><span class="hljs-meta">@TelegramFilterOrder(Integer.MIN_VALUE)</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">LoggingFilter</span></span></span><span class="hljs-class"> : </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">TelegramFilter { override fun handleMessage</span></span></span></span>(message: TelegramMessage, chain: TelegramFilterChain) { log.info(<span class="hljs-string"><span class="hljs-string">"New message from #{}: {}"</span></span>, message.chat.id, message.text) chain.doFilter(message) } <span class="hljs-keyword"><span class="hljs-keyword">companion</span></span> <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> log = LoggerFactory.getLogger(LoggingFilter::<span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">java</span></span></span><span class="hljs-class">) } }</span></span></code> </pre> </div></div><br><p>  C'est ainsi que <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">@TinkoffRatesBot</a> implÃ©mente une Â«calculatriceÂ».  Sans appeler de script et de commande, vous pouvez envoyer un nombre, par exemple, "1000", ou mÃªme une expression entiÃ¨re, par exemple, "4500 * 3 - 12000".  Le bot calculera le rÃ©sultat de l'expression, appliquera les taux de change actuels au rÃ©sultat et affichera des informations Ã  ce sujet.  En fait, le rÃ©sultat de ces actions est l'exÃ©cution du <code>CalculationFilter</code> , qui est dans la chaÃ®ne en dessous du <code>HandlersFilter</code> , mais au-dessus du <code>UnresolvedFilter</code> . </p><br><h3 id="obrabotchiki-1">  Gestionnaires </h3><br><p>  Le systÃ¨me de script Telegraff (gestionnaires) est basÃ© sur le DSL Kotlin.  En bref, il s'agit de lambdas et de constructeurs. </p><br><p>  Je ne vois pas l'intÃ©rÃªt de visualiser sÃ©parÃ©ment le DSL Kotlin, car  c'est une conversation complÃ¨tement diffÃ©rente.  Il existe une excellente <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">documentation</a> de JetBrains et un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">rapport</a> complet d' <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" class="user_link">i_osipov</a> . </p><br><h3 id="nyuansy">  Nuances </h3><br><p>  Cette section est consacrÃ©e aux fonctionnalitÃ©s actuelles.  Tous, Ã  mon avis, ne sont pas critiques, certains peuvent Ãªtre corrigÃ©s, d'autres non.  Mais vous devez connaÃ®tre ces aspects. </p><br><p>  Si vous souhaitez participer ou savoir comment corriger l'un ou l'autre point de cette section, je vous en serai trÃ¨s reconnaissant. </p><br><h4 id="telegram-1">  TÃ©lÃ©gramme </h4><br><p>  La couche d'intÃ©gration avec Telegram n'est probablement pas entiÃ¨rement dÃ©crite.  Seules les mÃ©thodes dont j'avais besoin ont Ã©tÃ© mises en Å“uvre.  S'il y a quelque chose qui vous manque personnellement, corrigez <a href=""><code>TelegramApi</code></a> et envoyez des RP! </p><br><p>  Pour le moment, le manque de prise en charge du clavier en ligne est important (c'est lorsque le clavier est directement en dessous du message dans le ruban).  La tÃ¢che est aggravÃ©e par le fait que les claviers en ligne doivent Ãªtre correctement Â«introduitsÂ» dans la structure existante afin qu'elle reste simple, pratique et isolÃ©e.  Il existe dÃ©jÃ  une bonne idÃ©e pour implÃ©menter cette fonctionnalitÃ©, mais elle n'a pas encore Ã©tÃ© implÃ©mentÃ©e et testÃ©e sous aucune forme. </p><br><h4 id="fat-jar">  Pot de graisse </h4><br><p>  Malheureusement, certaines bibliothÃ¨ques, telles que <code>JRuby</code> et probablement le <code>Kotlin Embedded Compiler</code> (nÃ©cessaire pour la compilation de scripts) peuvent avoir des problÃ¨mes dans le cadre du <code>Fat JAR</code> .  <code>Fat JAR</code> c'est quand votre code et toutes vos dÃ©pendances sont regroupÃ©s dans un seul fichier ( <code>*.jar</code> ). </p><br><p>  Afin de rÃ©soudre ce problÃ¨me, vous pouvez dÃ©compresser les dÃ©pendances lors de l'exÃ©cution.  En d'autres termes, lorsque l'application dÃ©marre, le fichier JAR de dÃ©pendance du package principal est dÃ©ployÃ© quelque part sur le disque et le chemin de classe est indiquÃ© avant celui-ci.  C'est assez facile Ã  faire grÃ¢ce Ã  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">la configuration</a> <code>bootJar</code> : </p><br><div class="spoiler">  <b class="spoiler_title">Configuration du plugin</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">bootJar { requiresUnpack "**/**kotlin**.jar" requiresUnpack "**/**telegraff**.jar" }</code> </pre> </div></div><br><p>  Cependant, afin de se rÃ©fÃ©rer des gestionnaires (scripts) Ã  vos beans (services, par exemple), ils doivent Ã©galement Ãªtre dÃ©compressÃ©s.  Ce qui, en principe, Ã©limine le bÃ©nÃ©fice de cette approche. </p><br><p>  Selon moi, l'utilisation du plugin d' <code>application</code> Gradle reste la mÃ©thode la plus fiable, simple et pratique.  De plus, si vous conteneurisez votre application, il n'y a pas de diffÃ©rence par le rÃ©sultat. </p><br><p>  Ã€ propos de tout cela, j'ai Ã©crit en dÃ©tail <a href="">ici</a> . </p><br><h4 id="poryadok-inicializacii">  Ordre d'initialisation </h4><br><p>  Ici, je voudrais noter deux circonstances. </p><br><p>  PremiÃ¨rement, si vous regardez le scÃ©nario d'appel de taxi, vous pouvez voir que la classe <code>enum</code> est dÃ©finie au-dessus de l'appel au <code>handler(...)</code> .  Cette nÃ©cessitÃ© est imposÃ©e par le fait qu'en fait, <code>handler</code> est un appel de fonction.  Un appel de fonction, dont le rÃ©sultat devrait Ãªtre une structure, que Telegraff utilisera plus tard.  Si, selon le rÃ©sultat de l'exÃ©cution de votre script, la fabrique ne peut pas amener le rÃ©sultat au type souhaitÃ©, une erreur va se produire lors de l'initialisation. </p><br><p>  DeuxiÃ¨mement, vous devez vous rappeler que vos scripts peuvent Ãªtre initialisÃ©s plus tÃ´t que l'ensemble de votre application et de vos beans.  Si, par exemple, nous mettons un lien vers le contexte dans une variable statique et essayons d'obtenir un service sur la premiÃ¨re ligne du fichier de script, il se peut que le contexte ne l'ait pas, car  il n'a pas encore Ã©tÃ© initialisÃ©.  Afin d'Ã©viter de tels problÃ¨mes, utilisez <a href="">cette</a> mÃ©thode Telegraff.  Il garantit que le contexte est initialisÃ© et que tous les beans nÃ©cessaires sont disponibles.  Un exemple peut Ãªtre vu <a href="">ici</a> . </p><br><h2 id="zaklyuchenie">  Conclusion </h2><br><p>  Je voulais essayer - fourchette, <br>  Je voulais le rÃ©parer - envoyer des relations publiques, <br>  Je voulais remercier - mettre un astÃ©risque dans Github, comme le message et le dire Ã  vos amis! </p><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">DÃ©pÃ´t de projets</a> </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr445072/">https://habr.com/ru/post/fr445072/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr445060/index.html">Organisation des recherches de donnÃ©es Ã  l'aide des rÃ©fÃ©rentiels de valeurs-clÃ©s Spring Data</a></li>
<li><a href="../fr445062/index.html">Format de prÃ©sentation moderne?</a></li>
<li><a href="../fr445064/index.html">La bataille pour la neutralitÃ© du net - une chance de revenir</a></li>
<li><a href="../fr445066/index.html">Comment j'Ã©cris des notes mathÃ©matiques sur LaTeX dans Vim</a></li>
<li><a href="../fr445070/index.html">Le condensÃ© de matÃ©riaux intÃ©ressants pour le dÃ©veloppeur mobile # 291 (18 mars - 24 mars)</a></li>
<li><a href="../fr445074/index.html">Programmation de LibreOffice Base. Partie 1</a></li>
<li><a href="../fr445076/index.html">Le gÃ©ant informatique a introduit un pare-feu dÃ©fini par service</a></li>
<li><a href="../fr445078/index.html">La physique quantique est susceptible de protÃ©ger les rÃ©seaux Ã©lectriques amÃ©ricains contre les pirates</a></li>
<li><a href="../fr445080/index.html">En Russie, va crÃ©er un "chemin de fer numÃ©rique"</a></li>
<li><a href="../fr445082/index.html">Le mois dernier, nous avons appelÃ© Zuckerberg un boob; corrigÃ©: en fait, lui et son Facebook sont juste une putain de honte</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>