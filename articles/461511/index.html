<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üéä üë©üèº‚Äçüç≥ üôé Python Dependency Management: una comparaci√≥n de enfoques üë©üèº‚Äçüé§ üë∂üèæ ü¶Ç</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="He estado escribiendo en Python durante cinco a√±os, de los cuales los √∫ltimos tres a√±os han estado desarrollando mi propio proyecto. La mayor parte de...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Python Dependency Management: una comparaci√≥n de enfoques</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/461511/"><img src="http://ftcdn.pw/cd64d5e9-af9a-46cc-868b-c8873c98adb6.png" alt="imagen"><br><br>  He estado escribiendo en Python durante cinco a√±os, de los cuales los √∫ltimos tres a√±os han estado desarrollando mi propio proyecto.  La mayor parte de esta manera, mi equipo me ayuda con esto.  Y con cada versi√≥n, con cada nueva caracter√≠stica, estamos tratando cada vez m√°s de asegurarnos de que el proyecto no se convierta en un desastre debido al c√≥digo no compatible;  luchamos con importaciones c√≠clicas, dependencias mutuas, asignamos m√≥dulos reutilizados, reconstruimos la estructura. <br><br>  Desafortunadamente, en la comunidad de Python no existe un concepto universal de "buena arquitectura", solo existe el concepto de "pitonicidad", por lo que tenemos que idear la arquitectura nosotros mismos.  Bajo el corte, Longrid con reflexiones sobre la arquitectura y, en primer lugar, sobre la gesti√≥n de dependencias, es aplicable a Python. <br><a name="habracut"></a><br><h1>  django.setup () </h1><br>  Comenzar√© con una pregunta a los dzhangistas.  ¬øEscribes a menudo estas dos l√≠neas? <br><br><pre><code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> django django.setup()</code> </pre> <br>  Debe iniciar el archivo a partir de esto si desea trabajar con objetos django sin iniciar el servidor web django.  Esto se aplica a los modelos y herramientas para trabajar con el tiempo ( <code><b>django.utils.timezone</b></code> ) y las <code><b>django.urls.reverse</b></code> ( <code><b>django.urls.reverse</b></code> ), y mucho m√°s.  Si esto no se hace, obtendr√° un error: <br><br><pre> <code class="plaintext hljs">django.core.exceptions.AppRegistryNotReady: Apps aren't loaded yet.</code> </pre><br>  Constantemente escribo estas dos l√≠neas.  Soy un gran admirador del c√≥digo de expulsi√≥n;  Me gusta crear un archivo <code><b>.py</b></code> separado, torcer cosas en √©l, descifrarlo y luego incrustarlo en el proyecto. <br><br>  Y esta constante <code><b>django.setup()</b></code> me molesta mucho.  En primer lugar, te cansas de repetirlo en todas partes;  y, en segundo lugar, la inicializaci√≥n de django lleva unos segundos (tenemos un gran monolito), y cuando reinicia el mismo archivo 10, 20, 100 veces, simplemente ralentiza el desarrollo. <br><br>  ¬øC√≥mo deshacerse de <code><b>django.setup()</b></code> ?  Necesita escribir c√≥digo que dependa m√≠nimamente de django. <br><br>  Por ejemplo, si escribimos un cliente de una API externa, entonces podemos hacerlo dependiente de django: <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> django.conf <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> settings <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">APIClient</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__init__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> self.api_key = settings.SOME_API_KEY <span class="hljs-comment"><span class="hljs-comment"># : client = APIClient()</span></span></code> </pre><br>  o puede ser independiente de django: <br><br><pre> <code class="python hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">APIClient</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__init__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, api_key)</span></span></span><span class="hljs-function">:</span></span> self.api_key = api_key <span class="hljs-comment"><span class="hljs-comment"># : client = APIClient(api_key='abc')</span></span></code> </pre><br>  En el segundo caso, el constructor es m√°s engorroso, pero cualquier manipulaci√≥n con esta clase se puede hacer sin cargar toda la maquinaria dzhangovskoy. <br><br>  Las pruebas tambi√©n se est√°n volviendo m√°s f√°ciles.  ¬øC√≥mo probar un componente que depende de la configuraci√≥n de <code><b>django.conf.settings</b></code> ?  Solo ci√©rrelos con el decorador <code><b>@override_settings</b></code> .  Y si el componente no depende de nada, entonces no habr√° nada que mojar: pas√≥ los par√°metros al constructor y lo condujo. <br><br><h1>  Gesti√≥n de dependencias </h1><br>  La historia de dependencia de <code><b>django</b></code> es el ejemplo m√°s sorprendente de un problema que encuentro todos los d√≠as: problemas de administraci√≥n de dependencias en python, y la arquitectura general de las aplicaciones de python. <br><br>  La relaci√≥n con la gesti√≥n de dependencias en la comunidad Python es mixta.  Se pueden distinguir tres campamentos principales: <br><br><ul><li>  Python es un lenguaje flexible.  Escribimos como queramos, dependiendo de lo que queramos.  No somos t√≠midos con respecto a las dependencias c√≠clicas, la sustituci√≥n de atributos para clases en tiempo de ejecuci√≥n, etc. <br><br></li><li>  Python es un lenguaje especial.  Hay formas idiom√°ticas de construir arquitectura y dependencias.  La transferencia de datos hacia arriba y hacia abajo en la pila de llamadas es realizada por iteradores, corutinas y administradores de contexto. <br><br><div class="spoiler">  <b class="spoiler_title">Informe de clase sobre este tema y ejemplo</b> <div class="spoiler_text">  Brandon Rhodes, Dropbox: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Eleva tu IO</a> . <br><br>  Ejemplo del informe: <br><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-string"><span class="hljs-string">"""          """</span></span> <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> open(<span class="hljs-string"><span class="hljs-string">"/etc/hosts"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> file: <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> line <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> parse_hosts(file): print(line) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">parse_hosts</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(lines)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-string"><span class="hljs-string">"""    -   """</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> line <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> lines: <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> line.startswith(<span class="hljs-string"><span class="hljs-string">"#"</span></span>): <span class="hljs-keyword"><span class="hljs-keyword">continue</span></span> <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span> line</code> </pre><br></div></div><br></li><li>  La flexibilidad de Python es una forma adicional de dispararte en el pie.  Necesita un conjunto r√≠gido de reglas para administrar dependencias.  Un buen ejemplo son los chicos rusos <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">de pit√≥n seco</a> .  Todav√≠a hay un enfoque menos duro: la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">estructura de Django para escala y longevidad</a> , pero la idea es la misma. <br></li></ul><br>  Hay varios art√≠culos sobre gesti√≥n de dependencias en python ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">ejemplo 1</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">ejemplo 2</a> ), pero todos se reducen a anunciar los marcos de inyecci√≥n de dependencias de alguien.  Este art√≠culo es una nueva entrada sobre el mismo tema, pero esta vez es un experimento de pensamiento puro sin publicidad.  Este es un intento de encontrar un equilibrio entre los tres enfoques anteriores, prescindir de un marco adicional y hacerlo "pit√≥nico". <br><br>  Recientemente le√≠ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Clean Architecture</a> , y parece que entiendo cu√°l es el valor de la inyecci√≥n de dependencia en python y c√≥mo se puede implementar.  Vi esto en el ejemplo de mi propio proyecto.  En pocas palabras, esto est√° <b>protegiendo el c√≥digo para que no se rompa cuando otro c√≥digo cambia</b> . <br><br><h1>  Datos de origen </h1><br>  Hay un cliente API que ejecuta solicitudes HTTP para el acortador de servicios: <br><br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment"># shortener_client.py import requests class ShortenerClient: def __init__(self, api_key): self.api_key = api_key def shorten_link(self, url): response = requests.post( url='https://fstrk.cc/short', headers={'Authorization': self.api_key}, json={'url': url} ) return response.json()['url']</span></span></code> </pre><br>  Y hay un m√≥dulo que acorta todos los enlaces en el texto.  Para hacer esto, usa el cliente API acortador: <br><br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment"># text_processor.py import re from shortener_client import ShortenerClient class TextProcessor: def __init__(self, text): self.text = text def process(self): changed_text = self.text links = re.findall( r'https?://[^\r\n\t") ]*', self.text, flags=re.MULTILINE ) api_client = ShortenerClient('abc') for link in links: shortened = api_client.shorten_link(link) changed_text = changed_text.replace(link, shortened) return changed_text</span></span></code> </pre><br>  La l√≥gica de la ejecuci√≥n del c√≥digo vive en un archivo de control separado (llam√©moslo controlador): <br><br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment"># controller.py from text_processor import TextProcessor processor = TextProcessor("""  1: https://ya.ru  2: https://google.com """) print(processor.process())</span></span></code> </pre><br>  Todo funciona  El procesador analiza el texto, acorta los enlaces con un acortador y devuelve el resultado.  Las dependencias se ven as√≠: <br><br><img src="http://ftcdn.pw/58d8aa1d-0024-42c6-918e-05b2d41f126d.png" alt="imagen"><br><br><h1>  El problema </h1><br>  Este es el problema: la clase <code><b>TextProcessor</b></code> depende de la clase <code><b>TextProcessor</b></code> , y se <b>interrumpe cuando cambia la interfaz de</b> <code><b>ShortenerClient</b></code> . <br><br>  ¬øC√≥mo puede pasar esto? <br><br>  Supongamos que en nuestro proyecto decidimos rastrear <code><b>shorten_link</b></code> y agregamos el argumento <code><b>callback_url</b></code> al m√©todo <code><b>shorten_link</b></code> .  Este argumento significa la direcci√≥n a la que deben llegar las notificaciones al hacer clic en un enlace. <br><br>  El m√©todo <code><b>ShortenerClient.shorten_link</b></code> comenz√≥ a verse as√≠: <br><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">shorten_link</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, url, callback_url)</span></span></span><span class="hljs-function">:</span></span> response = requests.post( url=<span class="hljs-string"><span class="hljs-string">'https://fstrk.cc/short'</span></span>, headers={<span class="hljs-string"><span class="hljs-string">'Authorization'</span></span>: self.api_key}, json={<span class="hljs-string"><span class="hljs-string">'url'</span></span>: url, <span class="hljs-string"><span class="hljs-string">'callback_on_click'</span></span>: callback_url} ) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> response.json()[<span class="hljs-string"><span class="hljs-string">'url'</span></span>]</code> </pre><br>  Y que pasa  Y resulta que cuando intentamos comenzar, recibimos un error: <br><br><pre> <code class="python hljs">TypeError: shorten_link() missing <span class="hljs-number"><span class="hljs-number">1</span></span> required positional argument: <span class="hljs-string"><span class="hljs-string">'callback_url'</span></span></code> </pre><br>  Es decir, cambiamos el acortador, pero no fue √©l quien rompi√≥, sino su cliente: <br><br><img src="http://ftcdn.pw/13e9dcd5-7866-4c82-b1d0-e56134650b62.png" alt="imagen"><br><br>  ¬øY qu√©?  Bueno, el archivo de llamadas se rompi√≥, fuimos y lo arreglamos.  Cual es el problema <br><br>  Si esto se resuelve en un minuto, fueron y se corrigieron, entonces esto, por supuesto, no es un problema en absoluto.  Si hay poco c√≥digo en las clases y si los admite usted mismo (este es su proyecto paralelo, estas son dos clases peque√±as del mismo subsistema, etc.), puede detenerse all√≠. <br><br>  Los problemas comienzan cuando: <br><br><ul><li>  los m√≥dulos que llaman y los que llaman tienen mucho c√≥digo; </li><li>  diferentes m√≥dulos son compatibles con diferentes personas / equipos. </li></ul><br>  Si escribe la clase <code><b>TextProcessor</b></code> y su colega escribe <code><b>TextProcessor</b></code> , obtendr√° una situaci√≥n ofensiva: <b>cambi√≥ el c√≥digo, pero se rompi√≥.</b>  Y se rompi√≥ en un lugar que no has visto en la vida, y ahora necesitas sentarte y entender el c√≥digo de otra persona. <br><br>  A√∫n m√°s interesante es cuando su m√≥dulo se usa en varios lugares, y no en uno;  y su edici√≥n romper√° el c√≥digo en el mont√≥n de archivos. <br><br>  Por lo tanto, el problema se puede formular de la siguiente manera: ¬øc√≥mo organizar el c√≥digo para que cuando se cambie la interfaz de <code><b>ShortenerClient</b></code> , <code><b>ShortenerClient</b></code> <b><code><b>ShortenerClient</b></code> y no sus consumidores</b> (de los cuales puede haber muchos)? <br><br>  La soluci√≥n aqu√≠ es: <br><br><ul><li>  Los consumidores de la clase y la clase misma deben acordar una interfaz com√∫n.  Esta interfaz deber√≠a convertirse en ley. </li><li>  Si la clase deja de corresponder a su interfaz, ser√°n sus problemas y no los problemas de los consumidores. </li></ul><br><img src="http://ftcdn.pw/dbb4d320-2683-4f2e-821e-dea621b54b53.png" alt="imagen"><br><br><h1>  Congelar la interfaz </h1><br>  ¬øC√≥mo se ve arreglar una interfaz en Python?  Esta es una clase abstracta: <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> abc <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> ABC, abstractmethod <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AbstractClient</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(ABC)</span></span></span><span class="hljs-class">:</span></span> @abstractmethod <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__init__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, api_key)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">pass</span></span> @abstractmethod <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">shorten_link</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, link)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">pass</span></span></code> </pre><br>  Si ahora heredamos de esta clase y olvidamos implementar alg√∫n m√©todo, obtendremos un error: <br><br><pre> <code class="python hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ShortenerClient</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(AbstractClient)</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__ini__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, api_key)</span></span></span><span class="hljs-function">:</span></span> self.api_key = api_key client = ShortenerClient(<span class="hljs-string"><span class="hljs-string">'123'</span></span>) &gt;&gt;&gt; TypeError: Can<span class="hljs-string"><span class="hljs-string">'t instantiate abstract class ShortenerClient with abstract methods __init__, shorten_link</span></span></code> </pre><br>  Pero esto no es suficiente.  Una clase abstracta captura solo los nombres de los m√©todos, pero no su firma. <br><br>  Necesita una segunda herramienta de verificaci√≥n de firma Esta segunda herramienta es <code><b>mypy</b></code> .  Ayudar√° a verificar las firmas de los m√©todos heredados.  Para hacer esto, debemos agregar anotaciones a la interfaz: <br><br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment"># shortener_client.py from abc import ABC, abstractmethod class AbstractClient(ABC): @abstractmethod def __init__(self, api_key: str) -&gt; None: pass @abstractmethod def shorten_link(self, link: str) -&gt; str: pass class ShortenerClient(AbstractClient): def __init__(self, api_key: str) -&gt; None: self.api_key = api_key def shorten_link(self, link: str, callback_url: str) -&gt; str: return 'xxx'</span></span></code> </pre><br>  Si ahora verificamos este c√≥digo con <code><b>mypy</b></code> , obtenemos un error debido al argumento adicional <code><b>callback_url</b></code> : <br><br><pre> <code class="plaintext hljs">mypy shortener_client.py &gt;&gt;&gt; error: Signature of "shorten_link" incompatible with supertype "AbstractClient"</code> </pre><br>  Ahora tenemos una forma confiable de confirmar la interfaz de la clase. <br><br><h1>  Inversi√≥n de dependencia </h1><br>  Despu√©s de depurar la interfaz, debemos moverla a otro lugar para eliminar por completo la dependencia del consumidor del archivo <code><b>shortener_client.py</b></code> .  Por ejemplo, puede arrastrar la interfaz directamente al consumidor, a un archivo con el procesador <code><b>TextProcessor</b></code> : <br><br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment"># text_processor.py import re from abc import ABC, abstractmethod class AbstractClient(ABC): @abstractmethod def __init__(self, api_key: str) -&gt; None: pass @abstractmethod def shorten_link(self, link: str) -&gt; str: pass class TextProcessor: def __init__(self, text, shortener_client: AbstractClient) -&gt; None: self.text = text self.shortener_client = shortener_client def process(self) -&gt; str: changed_text = self.text links = re.findall( r'https?://[^\r\n\t") ]*', self.text, flags=re.MULTILINE ) for link in links: shortened = self.shortener_client.shorten_link(link) changed_text = changed_text.replace(link, shortened) return changed_text</span></span></code> </pre><br>  ¬°Y eso cambiar√° la direcci√≥n de la adicci√≥n!  Ahora el <code><b>TextProcessor</b></code> posee la interfaz de interacci√≥n y, como resultado, <code><b>ShortenerClient</b></code> depende de ella, y no al rev√©s. <br><br><img src="http://ftcdn.pw/33f3c619-63bf-420d-99d0-67bed0dfa628.png" alt="imagen"><br><br>  En palabras simples, podemos describir la esencia de nuestra transformaci√≥n de la siguiente manera: <br><br><ul><li>  <code><b>TextProcessor</b></code> dice: Soy un procesador y estoy involucrado en la conversi√≥n de texto.  No quiero saber nada sobre el mecanismo de acortamiento: este no es asunto m√≠o.  Quiero extraer el m√©todo <code><b>shorten_link</b></code> para que <code><b>shorten_link</b></code> todo para m√≠.  Entonces, por favor, dame un objeto que juegue de acuerdo con mis reglas.  Las decisiones sobre c√≥mo interact√∫o las tomo yo, no √©l. </li><li>  <code><b>ShortenerClient</b></code> dice: parece que no puedo existir en el vac√≠o, y ellos requieren cierto comportamiento de mi parte.  Voy a preguntarle a <code><b>TextProcessor</b></code> qu√© necesito para que no coincida. </li></ul><br><h1>  M√∫ltiples consumidores </h1><br>  Si varios m√≥dulos usan enlaces de acortamiento, entonces la interfaz no debe colocarse en uno de ellos, sino en un archivo separado, que se encuentra por encima de los otros archivos, en una jerarqu√≠a m√°s alta: <br><br><img src="http://ftcdn.pw/a81ef19a-45aa-4b23-b93a-e9a6b9094670.png" alt="imagen"><br><br><h1>  Componente de control </h1><br>  Si los consumidores no importan <code><b>ShortenerClient</b></code> , ¬øqui√©n lo importar√° y crear√° un objeto de clase?  Deber√≠a ser un componente de control, en nuestro caso es <code><b>controller.py</b></code> . <br><br>  El enfoque m√°s simple es una inyecci√≥n de dependencia directa, la inyecci√≥n de dependencia "en la frente".  Creamos objetos en el c√≥digo de llamada, transferimos un objeto a otro.  Ganancia <br><br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment"># controller.py import TextProcessor import ShortenerClient processor = TextProcessor( text=' 1: https://ya.ru  2: https://google.com', shortener_client=ShortenerClient(api_key='123') ) print(processor.process())</span></span></code> </pre><br><h1>  Enfoque de Python </h1><br>  Se cree que un enfoque m√°s "pit√≥nico" es la inyecci√≥n de dependencia a trav√©s de la herencia. <br><br><div class="spoiler">  <b class="spoiler_title">Raymond Hettinger habla sobre esto con gran detalle en su informe Super considerado Super.</b> <div class="spoiler_text"><div class="oembed">  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">https://www.youtube.com/watch?v=EiOglTERPEo</a> </div><br></div></div><br>  Para adaptar el c√≥digo a este estilo, debe cambiar ligeramente el <code><b>TextProcessor</b></code> que sea heredable: <br><br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment"># text_processor.py class TextProcessor: def __init__(self, text: str) -&gt; None: self.text = text self.shortener_client: AbstractClient = self.get_shortener_client() def get_shortener_client(self) -&gt; AbstractClient: """      """ raise NotImplementedError</span></span></code> </pre><br>  Y luego, en el c√≥digo de llamada, herede: <br><br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment"># controller.py import TextProcessor import ShortenerClient class ProcessorWithClient(TextProcessor): """   ,    """ def get_shortener_client(self) -&gt; ShortenerClient: return ShortenerClient(api_key='abc') processor = ProcessorWithClient( text=' 1: https://ya.ru  2: https://google.com' ) print(processor.process())</span></span></code> </pre><br>  El segundo ejemplo es omnipresente en los marcos populares: <br><br><ul><li>  En Django, somos constantemente heredados.  Redefinimos los m√©todos de vista basada en clase, modelos, formularios;  en otras palabras, inyecta nuestras dependencias en el trabajo ya depurado del framework. </li><li>  En DRF, lo mismo.  Estamos ampliando vistas, serializadores, permisos. </li><li>  Y as√≠ sucesivamente.  Muchos ejemplos </li></ul><br>  El segundo ejemplo parece m√°s bonito y m√°s familiar, ¬øno?  Vamos a desarrollarlo y ver si se conserva esta belleza. <br><br><h1>  Desarrollo de Python </h1><br>  En la l√≥gica de negocios, generalmente hay m√°s de dos componentes.  Supongamos que nuestro <code><b>TextProcessor</b></code> no es una clase independiente, sino solo uno de los elementos de la <code><b>TextPipeline</b></code> que procesa el texto y lo env√≠a al correo: <br><br><pre> <code class="python hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">TextPipeline</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__init__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, text, email)</span></span></span><span class="hljs-function">:</span></span> self.text_processor = TextProcessor(text) self.mailer = Mailer(email) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">process_and_mail</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function"> -&gt; </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">None</span></span></span><span class="hljs-function">:</span></span> processed_text = self.text_processor.process() self.mailer.send_text(text=processed_text)</code> </pre><br>  Si queremos aislar <code><b>TextPipeline</b></code> de las clases utilizadas, debemos seguir el mismo procedimiento que antes: <br><br><ul><li>  la clase <code><b>TextPipeline</b></code> declarar√° interfaces para los componentes utilizados; </li><li>  los componentes usados ‚Äã‚Äãse ver√°n obligados a cumplir con estas interfaces; </li><li>  alg√∫n c√≥digo externo juntar√° todo y se ejecutar√°. </li></ul><br>  El diagrama de dependencia se ver√° as√≠: <br><br><img src="http://ftcdn.pw/35f207fa-3ad7-4779-92c3-ae8f63401b8e.png" alt="imagen"><br><br>  Pero, ¬øc√≥mo ser√° ahora el c√≥digo de ensamblaje de estas dependencias? <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> TextProcessor <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> ShortenerClient <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> Mailer <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> TextPipeline <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ProcessorWithClient</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(TextProcessor)</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">get_shortener_client</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function"> -&gt; ShortenerClient:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ShortenerClient(api_key=<span class="hljs-string"><span class="hljs-string">'123'</span></span>) <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PipelineWithDependencies</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(TextPipeline)</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">get_text_processor</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, text: str)</span></span></span><span class="hljs-function"> -&gt; ProcessorWithClient:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ProcessorWithClient(text) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">get_mailer</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, email: str)</span></span></span><span class="hljs-function"> -&gt; Mailer:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Mailer(email) pipeline = PipelineWithDependencies( email=<span class="hljs-string"><span class="hljs-string">'abc@def.com'</span></span>, text=<span class="hljs-string"><span class="hljs-string">' 1: https://ya.ru  2: https://google.com'</span></span> ) pipeline.process_and_mail()</code> </pre><br>  ¬øTe has dado cuenta?  Primero heredamos la clase <code><b>TextProcessor</b></code> para insertar el <code><b>ShortenerClient</b></code> en √©l, y luego heredamos <code><b>TextPipeline</b></code> para insertar nuestro <code><b>TextProcessor</b></code> anulado (as√≠ como <code><b>Mailer</b></code> ) en √©l.  Tenemos varios niveles de redefinici√≥n secuencial.  Ya complicado <br><br>  ¬øPor qu√© todos los marcos est√°n organizados de esta manera?  <b>S√≠, porque solo es adecuado para marcos.</b> <br><br><ul><li>  Todos los niveles del marco est√°n claramente definidos y su n√∫mero es limitado.  Por ejemplo, en Django, puede anular <code><b>FormField</b></code> para insertarlo en una anulaci√≥n de un <code><b>Form</b></code> , para insertar un formulario en una anulaci√≥n de <code><b>View</b></code> .  Eso es todo.  Tres niveles </li><li>  Cada marco tiene un prop√≥sito.  Esta tarea est√° claramente definida. </li><li>  Cada marco tiene documentaci√≥n detallada que describe c√≥mo y qu√© heredar;  qu√© y con qu√© combinar. </li></ul><br>  ¬øPuede identificar y documentar de manera clara e inequ√≠voca su l√≥gica empresarial?  ¬øEspecialmente la arquitectura de los niveles en los que trabaja?  Yo no  Desafortunadamente, el enfoque de Raymond Hettinger no se adapta a la l√≥gica empresarial. <br><br><h1>  Volver al enfoque de la frente </h1><br>  En varios niveles de dificultad, gana un enfoque simple.  Parece m√°s simple y m√°s f√°cil de cambiar cuando cambia la l√≥gica. <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> TextProcessor <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> ShortenerClient <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> Mailer <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> TextPipeline pipeline = TextPipeline( text_processor=TextProcessor( text=<span class="hljs-string"><span class="hljs-string">' 1: https://ya.ru  2: https://google.com'</span></span>, shortener_client=ShortenerClient(api_key=<span class="hljs-string"><span class="hljs-string">'abc'</span></span>) ), mailer=Mailer(<span class="hljs-string"><span class="hljs-string">'abc@def.com'</span></span>) ) pipeline.process_and_mail()</code> </pre><br>  Pero, cuando aumenta el n√∫mero de niveles de l√≥gica, incluso este enfoque se vuelve inconveniente.  Tenemos que iniciar imperativamente un grupo de clases, pas√°ndolas entre s√≠.  Quiero evitar muchos niveles de anidamiento. <br><br>  Probemos una llamada m√°s. <br><br><h1>  Almacenamiento de instancia global </h1><br>  Intentemos crear un diccionario global en el que se encuentren las instancias de los componentes que necesitamos.  Y deje que estos componentes se obtengan entre s√≠ mediante el acceso a este diccionario. <br><br>  Llam√©moslo <code><b>INSTANCE_DICT</b></code> : <br><br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment"># text_processor.py import INSTANCE_DICT class TextProcessor(AbstractTextProcessor): def __init__(self, text) -&gt; None: self.text = text def process(self) -&gt; str: shortener_client: AbstractClient = INSTANCE_DICT['Shortener'] # ...  </span></span></code> </pre><br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment"># text_pipeline.py import INSTANCE_DICT class TextPipeline: def __init__(self) -&gt; None: self.text_processor: AbstractTextProcessor = INSTANCE_DICT[ 'TextProcessor'] self.mailer: AbstractMailer = INSTANCE_DICT['Mailer'] def process_and_mail(self) -&gt; None: processed_text = self.text_processor.process() self.mailer.send_text(text=processed_text)</span></span></code> </pre><br>  El truco es <b>poner nuestros objetos en este diccionario antes de acceder a ellos</b> .  Esto es lo que haremos en <code><b>controller.py</b></code> : <br><br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment"># controller.py import INSTANCE_DICT import TextProcessor import ShortenerClient import Mailer import TextPipeline INSTANCE_DICT['Shortener'] = ShortenerClient('123') INSTANCE_DICT['Mailer'] = Mailer('abc@def.com') INSTANCE_DICT['TextProcessor'] = TextProcessor(text=' : https://ya.ru') pipeline = TextPipeline() pipeline.process_and_mail()</span></span></code> </pre><br>  Ventajas de trabajar a trav√©s de un diccionario global: <br><br><ul><li>  sin magia del cap√≥ del motor y marcos DI extra; </li><li>  una lista plana de dependencias en las que no necesita administrar el anidamiento; </li><li>  todos los bonos DI: pruebas simples, independencia, protecci√≥n de componentes contra aver√≠as cuando otros componentes cambian. </li></ul><br>  Por supuesto, en lugar de crear <code><b>INSTANCE_DICT</b></code> , puede usar alg√∫n tipo de marco DI;  pero la esencia de esto no cambiar√°.  El marco proporcionar√° una gesti√≥n m√°s flexible de las instancias;  √©l te permitir√° crearlos en forma de singletones o paquetes, como una f√°brica;  pero la idea seguir√° siendo la misma. <br><br>  Quiz√°s en alg√∫n momento esto no sea suficiente para m√≠, y todav√≠a elijo alg√∫n tipo de marco. <br><br>  Y, tal vez, todo esto es innecesario, y es m√°s f√°cil prescindir de √©l: escribir importaciones directas y no crear interfaces abstractas innecesarias. <br><br>  ¬øCu√°l es su experiencia con la gesti√≥n de dependencias en python?  Y en general, ¬øes necesario o estoy inventando un problema desde el aire? </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/461511/">https://habr.com/ru/post/461511/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../461501/index.html">¬øPor qu√© en los Estados Unidos est√°n investigando el trabajo de grandes empresas de TI?</a></li>
<li><a href="../461503/index.html">Hacer que la base de datos est√© disponible para conexi√≥n remota</a></li>
<li><a href="../461505/index.html">8 errores de desarrolladores JavaScript novatos que te impiden convertirte en un profesional</a></li>
<li><a href="../461507/index.html">¬øPor qu√© decidimos lanzar el acelerador corporativo Gazprom Neft StartupDrive y qui√©n ya lo ha aprobado?</a></li>
<li><a href="../461509/index.html">Asistentes de viaje: una selecci√≥n de gadgets y accesorios</a></li>
<li><a href="../461517/index.html">Los mejores algoritmos de copiar y pegar para C y C ++. Haiku OS Cookbook</a></li>
<li><a href="../461519/index.html">Los mejores algoritmos de copiar y pegar para C y C ++. Colecci√≥n de Recetas Haiku OS</a></li>
<li><a href="../461523/index.html">WAL en PostgreSQL: 4. Configuraci√≥n de registro</a></li>
<li><a href="../461525/index.html">C√≥mo hice un control deslizante realmente adaptable (carrusel)</a></li>
<li><a href="../461527/index.html">Levitaci√≥n ac√∫stica de bricolaje</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>