<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üéΩ ü•Ñ üë®üèΩ‚Äçüíª Experi√™ncia GSoC: como dois (tr√™s) alunos realmente aprimoraram o c√≥digo CRIU üïâÔ∏è ‚ò¶Ô∏è üíÆ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Todos os anos, o Google realiza o evento Google Summer of Code, onde os principais projetos OpenSource encontram novos desenvolvedores talentosos entr...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Experi√™ncia GSoC: como dois (tr√™s) alunos realmente aprimoraram o c√≥digo CRIU</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/virtuozzo/blog/473362/">  Todos os anos, o Google realiza o evento Google Summer of Code, onde os principais projetos OpenSource encontram novos desenvolvedores talentosos entre os estudantes.  Em 2019, nosso projeto CRIU conseguiu n√£o apenas passar na fase de qualifica√ß√£o, mas tamb√©m atrair v√°rios jovens desenvolvedores ao mesmo tempo.  Sobre por que tudo isso e como o trabalho em CRUI continuou no √¢mbito do GSoC - leia abaixo. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/109/de4/c31/109de4c31759545abe5fd1cd510484db.png" alt="imagem"><br><br><a name="habracut"></a><br><br>  N√≥s da Virtuozzo temos um projeto pequeno, mas j√° bastante popular, chamado CRIU.  Este √© um utilit√°rio de sistema bastante complexo e um conjunto de patches do kernel (a maioria deles, a prop√≥sito, j√° foram aceitos na √°rvore principal do kernel), com os quais voc√™ pode fazer coisas como, por exemplo, migra√ß√£o ao vivo de cont√™ineres ou atualizar o kernel sem reiniciar os aplicativos. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/5f4/ea0/8ed/5f4ea08edfc77cbbb9aad905a193f0d3.png" alt="imagem"><br><br>  Iniciamos este projeto em 2011.  E apesar do fato de o utilit√°rio inicialmente ter causado muitas perguntas e algumas considerarem sua implementa√ß√£o imposs√≠vel, a CRIU gradualmente se transformou em uma ferramenta madura.  At√© o momento, mais de uma centena e meia de colaboradores de v√°rias dezenas de empresas, incluindo gigantes como Google e IBM, conseguiram participar.  Apesar disso, a busca por novos membros continua e, finalmente, chegamos ao Google Summer of Code (GSoC). <br><br>  O GSoC √© um evento anual patrocinado pelo Google que visa atrair estudantes para v√°rios projetos de c√≥digo aberto.  Por um lado, equipes de projetos abertos buscam participar do evento e, por outro lado, estudantes que desejam contribuir para o desenvolvimento da comunidade e provar seu profissionalismo em projetos reais. <br><br>  Para entrar na equipe do GSoC, √© necess√°rio enviar uma inscri√ß√£o especificando a descri√ß√£o do projeto, v√°rios t√≥picos nos quais os alunos podem trabalhar e uma lista dos chamados "mentores" - participantes ativos do projeto que ajudar√£o o aluno em seu dif√≠cil trabalho.  Os alunos devem selecionar um ou mais projetos e enviar seus curr√≠culos aos mentores. <br><br>  No meio do ano letivo, o Google considera as aplica√ß√µes das equipes e seleciona os projetos que participar√£o, e mais perto das f√©rias de ver√£o, as equipes escolhem os alunos com quem est√£o prontos para trabalhar, ap√≥s o que o Google realiza a filtragem final e distribui os alunos de acordo com as equipes.  No ver√£o, come√ßa o trabalho, que dura tr√™s meses.  A cada 30 dias, os alunos enviam relat√≥rios intermedi√°rios e seus mentores avaliam os resultados e fazem recomenda√ß√µes para a continua√ß√£o (ou t√©rmino) do trabalho. <br><br><h3>  Otimiza√ß√£o de mem√≥ria e implementa√ß√£o de logs bin√°rios <br></h3><br>  Admito que em 2019 n√£o foi nossa primeira tentativa de entrar no GSoC.  At√© o momento, n√£o conseguimos passar pelo est√°gio de sele√ß√£o de projetos do Google.  Mas n√£o desistimos (em geral, n√£o √© dif√≠cil enviar uma inscri√ß√£o) e, finalmente, tudo deu certo - o Google reconheceu o desenvolvimento do nosso projeto como importante e lan√ßou a CRUI no GSoC. <br><br>  Tivemos muitos t√≥picos para os alunos, um mais bonito e mais complexo.  Uma surpresa agrad√°vel foi o fato de que para cada um deles na comunidade havia artistas.  Havia pessoas que conheciam os problemas expressados ‚Äã‚Äãe estavam prontas para trabalhar como mentoras.  No est√°gio de inscri√ß√£o dos alunos, recebemos uma ‚Äúcompeti√ß√£o‚Äù inteira - 2 alunos se inscreveram em cada um dos t√≥picos e quase todos tinham dados de entrada maravilhosos.  A sele√ß√£o final permitiu obter dois alunos que abordaram t√≥picos de otimiza√ß√£o do c√≥digo de preserva√ß√£o de mem√≥ria do processo em andamento, bem como a implementa√ß√£o de logs bin√°rios. <br><br>  Como o CRIU √© um sistema de migra√ß√£o de aplicativos ao vivo, ele possui esse modo de opera√ß√£o quando a mem√≥ria usada pelo processo √© lida e gravada em arquivos de imagem em paralelo com a execu√ß√£o do pr√≥prio processo.  Chamamos isso de "opera√ß√£o do cora√ß√£o vivo" do processo, porque continua a funcionar sem parar.  Antes da rodada do GSoC, toda a mem√≥ria era armazenada em pipes usando a chamada do sistema vmsplice, que fazia barulho de uma s√≥ vez e, em seguida, o processo continuava sendo executado, e o CRIU despejou essa mem√≥ria lentamente em arquivos (ou em um canal de rede, se fosse uma migra√ß√£o ao vivo).  Em princ√≠pio, essa √© uma abordagem funcional, mas o problema √© que a mem√≥ria localizada nos pipes est√° efetivamente bloqueada (mlock) e o kernel n√£o pode descarreg√°-la no disco (troca), se necess√°rio. <br><br>  Do ponto de vista da arquitetura, quer√≠amos substituir os pipes para copiar a mem√≥ria em pequenas por√ß√µes chamando process_vm_readv.  Essa inova√ß√£o apareceu no kernel do Linux h√° pouco tempo (a prop√≥sito, esta chamada tem um irm√£o g√™meo chamado process_vm_writev).  Mas, ao mesmo tempo, permite facilitar e acelerar bastante, por exemplo, o trabalho do utilit√°rio strace e dos depuradores, que podem ser observados na mem√≥ria dos processos para resolver outras tarefas. <br><br>  O trabalho de otimiza√ß√£o foi complicado pelo fato de o c√≥digo para trabalhar com a mem√≥ria do processo ser um dos principais do utilit√°rio e, portanto, deve ser absolutamente confi√°vel.  Qualquer erro ao salvar p√°ginas pode levar o processo a receber um estado inconsistente de seus objetos internos (sobre o qual a CRIU, √© claro, n√£o ‚Äúsabe‚Äù nada) e, ap√≥s a recupera√ß√£o, cair√° sem nenhum diagn√≥stico claro. <br><br>  A segunda dificuldade desse desenvolvimento foi que trabalhar com mem√≥ria est√° envolvido em quase todos os recursos da CRIU.  Estes s√£o os procedimentos habituais de restaura√ß√£o de pontos de verifica√ß√£o, s√£o as v√°rias vers√µes otimizadas, por exemplo, restaura√ß√£o pr√©-despejo ou lenta.  Uma vez durante a pr√≥xima semana de relat√≥rio, planejamos at√© "dispensar" o aluno do projeto, mas, felizmente, n√£o fizemos isso e agora temos a t√£o esperada otimiza√ß√£o em nosso ramo de desenvolvimento. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/b31/4a8/e69/b314a8e6945d365f2dbc1b4e73412ad8.png" alt="imagem"><br><br>  A segunda tarefa no √¢mbito do GSoC 2019 foi o desenvolvimento e a implementa√ß√£o dos chamados logs bin√°rios.  O problema √© que, quando o CRIU funciona, o utilit√°rio grava mensagens sobre seu trabalho em um arquivo (ou na tela, mas ainda melhor em um arquivo).  A import√¢ncia desses posts √© enorme!  Se, por algum motivo, o procedimento de backup ou restaura√ß√£o n√£o terminar com √™xito, a √∫nica maneira de entender o motivo √© analisar cada etapa com o m√°ximo de detalhes poss√≠vel, e para isso voc√™ precisar√° de informa√ß√µes sobre a opera√ß√£o do utilit√°rio.  Idealmente, os procedimentos exigem os logs e arquivos de imagem mais detalhados, se houver.  Na pr√°tica, esses requisitos s√£o dif√≠ceis de satisfazer. <br><br>  Para obter os logs mais detalhados, o CRIU fornece um modo apropriado e a grande maioria dos usu√°rios (e talvez at√© todos) sempre o ativam.  Mas a quantidade de informa√ß√µes que o criu gera no processo √© t√£o grande que o pr√≥prio registro come√ßa a afetar visivelmente a velocidade do sistema.  Um pequeno estudo mostrou que gastamos 90% do nosso tempo registrando opera√ß√µes de formata√ß√£o de sa√≠da - ou seja, nos ‚Äúmesmos‚Äù% d,% 08s,% .2f e outros modificadores da fam√≠lia de fun√ß√µes printf.  Desativar os logs reduz o tempo de salvar e restaurar processos de 10 a 30%, dependendo do tamanho dos pr√≥prios processos. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/035/8cc/429/0358cc42935b88b0792a1c693e84f7c6.png" alt="imagem"><br><br>  Para desativar o uso de uma quantidade t√£o grande de recursos do sistema para o log, mas deixar os logs o mais informativos poss√≠vel, decidimos nos livrar da formata√ß√£o e salvar os dados bin√°rios nos arquivos de log.  Afinal, voc√™ pode format√°-los mais tarde, se necess√°rio.  O segundo aluno lidou com essa tarefa, cujos patches tamb√©m j√° foram aceitos no ramo de desenvolvimento. <br><br><h3>  E n√£o apenas no GSoC <br></h3><br>  A prop√≥sito, outro fato interessante de participar do GSoC √© que um terceiro estudante veio at√© n√≥s, e expressou o desejo de resolver o problema do anonimato.  Afinal, muitas vezes √© imposs√≠vel obter arquivos de imagem devido ao fato de que eles cont√™m informa√ß√µes secretas que o usu√°rio n√£o deseja compartilhar com ningu√©m - o conte√∫do da mem√≥ria, os arquivos com os quais o processo trabalha, o conte√∫do das filas nas conex√µes de rede e assim por diante.  Para resolver esse problema, enviamos um recurso chamado "anonimiza√ß√£o de imagens" no aplicativo, mas o Google n√£o o aceitou. <br><br>  No entanto, o t√≥pico n√£o perdeu sua relev√¢ncia, e o aluno que queria lidar com ele no √¢mbito do GSoC, no final, decidiu trabalhar sobre o assunto de forma independente, fora do evento do Google. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/521/6c2/3cd/5216c23cdb38140d3997e8d928e03b86.png" alt="imagem"><br><br><h3>  Conclus√£o <br></h3><br>  Foi, √© claro, uma experi√™ncia positiva participando do GSoC.  Nossa ferramenta CRIU, que amamos e valorizamos muito, recebeu alguns impulsos mais poderosos para o desenvolvimento, tornou-se ainda mais madura e conveniente.  Ent√£o, para quem pode ser √∫til, use-o com prazer! <br><br>  Por outro lado, est√°vamos convencidos de que a quest√£o da participa√ß√£o em tais eventos √© uma quest√£o de perseveran√ßa e confian√ßa em nosso projeto.  Se voc√™ precisa de desenvolvedores, n√£o se cansa de enviar aplicativos e formular t√≥picos novos e interessantes.  Voc√™ pode encontrar colaboradores completamente inesperados de outro pa√≠s ou mesmo de outra empresa. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt473362/">https://habr.com/ru/post/pt473362/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt473348/index.html">A id√©ia de in√©rcia (SGDm), a id√©ia de escalonamento (Adagrad) e regulariza√ß√£o no aprendizado de m√°quina usando o problema de classifica√ß√£o como exemplo</a></li>
<li><a href="../pt473350/index.html">Criando uma API REST com Node.js e um Banco de Dados Oracle. Parte 3</a></li>
<li><a href="../pt473352/index.html">Cole√ß√µes atuais em 10 minutos</a></li>
<li><a href="../pt473354/index.html">Sobre as esquisitices da hemostat√≠stica</a></li>
<li><a href="../pt473358/index.html">Instale e configure o Nexus Sonatype usando a infraestrutura como abordagem de c√≥digo</a></li>
<li><a href="../pt473364/index.html">H√° um g√≥bio, balan√ßando: uma lista de verifica√ß√£o para o com√©rcio eletr√¥nico na temporada de vendas</a></li>
<li><a href="../pt473366/index.html">O que est√° na minha tv inteligente para voc√™? Ou o que pode ser amontoado na TV?</a></li>
<li><a href="../pt473368/index.html">O MIRO √© uma plataforma de rob√¥ indoor aberta. Parte 3 - Componente de software: ESP8266</a></li>
<li><a href="../pt473372/index.html">Criando um servi√ßo simples de rastreamento de chamadas, parte 1</a></li>
<li><a href="../pt473374/index.html">Como integramos o YouTube Live com o Zoom</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>