<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🏯 🎅🏼 🚞 通过PVS-Studio静态分析器验证.NET Core库的源代码 😼 🏴󠁧󠁢󠁳󠁣󠁴󠁿 👩🏾‍🤝‍👨🏻</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content=".NET Core库是GitHub上最受欢迎的C＃项目之一。 鉴于其广泛的流行性和可用性，不足为奇。 试图找出在这些库的源代码中可以找到哪些暗角，这将变得更加有趣，我们将尝试使用PVS-Studio静态分析器来做到这一点。 您认为您最终发现了什么有趣的东西吗？ 

 我去这篇文章已经一年半了。 在某...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>通过PVS-Studio静态分析器验证.NET Core库的源代码</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/pvs-studio/blog/463537/"><p></p><div style="text-align:center;"><img src="https://habrastorage.org/webt/-a/bm/pb/-abmpb2yelga7y1zu59bejm6vgo.png" alt="图片19"></div><br>  .NET Core库是GitHub上最受欢迎的C＃项目之一。 鉴于其广泛的流行性和可用性，不足为奇。 试图找出在这些库的源代码中可以找到哪些暗角，这将变得更加有趣，我们将尝试使用PVS-Studio静态分析器来做到这一点。 您认为您最终发现了什么有趣的东西吗？ <br><a name="habracut"></a><br> 我去这篇文章已经一年半了。 在某个时候，我的脑海里浮现出一个想法：.NET Core库是一个花哨的东西，将它们检出将很有趣。 我几次检查该项目时，分析器发现了越来越多的有趣地方，但是它并没有超出警告列表的快速滚动范围。 这就是-完成！ 项目已选中，文章就在您眼前。 <br><br><h2> 有关项目和分析的更多信息 </h2><br> 如果您热衷于分析代码-您可以跳过本节，但我真的很想阅读它-在这里我将更多地讨论项目和分析器，以及有关如何分析和再现错误的一些知识。 <br><br><h3> 审核项目 </h3><br> 可能不告诉您什么是CoreFX（.NET Core库），但是，如果您没有听到，则在下面进行描述。 我没有改写它的意思，而是<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">从GitHub上的项目页面上获取的</a> ，您还可以在其中下载源代码。 <br><br> 说明： <i>此存储库包含.NET Core的库实现（称为“ CoreFX”）。</i>  <i>它包括System.Collections，System.IO，System.Xml和许多其他组件。</i>  <i>相应的.NET Core运行时存储库（称为“ CoreCLR”）包含.NET Core的运行时实现。</i>  <i>它包括RyuJIT，.NET GC和许多其他组件。</i>  <i>运行时特定的库代码（System.Private.CoreLib）位于CoreCLR存储库中。</i>  <i>它需要与运行时一起构建和版本控制。</i>  <i>其余CoreFX与运行时实现无关，可以在任何兼容的.NET运行时（例如CoreRT）上运行</i> 。 <br><br><h3> 二手分析仪及分析方法 </h3><br> 我使用<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">PVS-Studio静态分析器</a>检查了源代码。 通常，PVS-Studio不仅可以分析C＃代码，还可以分析C，C ++，Java。 到目前为止，对C＃代码的分析仅适用于Windows，而您可以在Windows，Linux，macOS下对C，C ++，Java中的代码进行分析。 <br><br> 我通常使用Visual Studio的PVS-Studio插件来测试C＃项目（支持2010-2019版本），因为这可能是最简单，最方便的分析方法：打开解决方案，开始分析，处理警告列表。 但是，使用CoreFX，事情变得更加复杂。 <br><br> 事实是该项目没有单个.sln文件，因此，在Visual Studio中打开该文件并使用PVS-Studio插件进行全面分析将失败。 可能很好，我真的不知道Visual Studio如何处理这种规模的解决方案。 <br><br> 但是，分析没有问题，因为PVS-Studio分发工具包包括用于MSBuild项目（实际上是.sln）的分析器的命令行版本。 我需要做的就是编写一个小脚本，为CoreFX目录中的每个.sln运行“ PVS-Studio_Cmd.exe”，并将分析结果放在单独的目录中（由分析器启动标志指示）。 <br><br> 瞧！  -在出口处，我有一组日志，其中包含很多有趣的东西。 如果需要，可以使用分发工具包随附的PlogConverter实用程序合并日志。 但是使用单个日志对我来说更方便，因此我没有开始将它们组合在一起。 <br><br> 在描述一些错误时，我参考了docs.microsoft.com上的文档以及可从nuget.org下载的NuGet软件包。 我承认文档中描述的代码/在软件包中找到的代码可能与所分析的代码略有不同。 但是，例如，如果在文档中没有描述针对许多输入数据生成的异常的情况，并且在软件包的新版本中它们将出现，这将是非常奇怪的-同意，这将是令人怀疑的惊喜。 在用于调试库的相同输入数据上，从NuGet复制程序包中的错误表明该问题不是新问题，更重要的是，无需从源代码构建项目，就可以“解决”该问题。 <br><br> 因此，假设存在一些理论上的代码错误同步的可能性，我发现可以参考docs.microsoft.com上相应方法的描述，并在nuget.org的程序包中重现问题。 <br><br> 我还注意到，在撰写本文期间，提供的链接的描述以及程序包（其他版本）中的信息（注释）可能会更改。 <br><br><h3> 其他经过验证的项目 </h3><br> 顺便说一句，这不是一篇独特的文章，我们<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">还会</a>撰写其他有关检查项目的文章， <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">可在此处找到</a>其列表。 而且，在该站点上，我们不仅收集了有关项目分析的文章，还收集了有关C，C ++，C＃，Java的各种技术文章，以及有趣的注释。 您可以在<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">博客</a>上找到所有这些内容。 <br><br> 我的同事之前在2015年测试过.NET Core库。 先前分析的结果可以在相应的文章中找到：“ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">.NET核心库（CoreFX）的新年检查</a> ”。 <br><br><h2> 发现错误，可疑和有趣的地方 </h2><br> 与往常一样，出于更大的兴趣，我建议您首先自己搜索片段中的错误，然后再阅读分析器警告和问题描述。 <br><br> 为方便起见，我使用<b>问题N</b>形式的标签将要考虑的片段彼此明确地分开-更容易理解一个错误的描述在哪里结束而另一个错误的分析从哪里开始。 是的，并且引用特定片段也更容易。 <br><br>  <b>第1期</b> <br><br><pre><code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">abstract</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Principal</span></span> : <span class="hljs-title"><span class="hljs-title">IDisposable</span></span> { .... <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Save</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">PrincipalContext context</span></span></span><span class="hljs-function">)</span></span> { .... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( context.ContextType == ContextType.Machine || _ctx.ContextType == ContextType.Machine) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> InvalidOperationException( SR.SaveToNotSupportedAgainstMachineStore); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (context == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { Debug.Assert(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.unpersisted == <span class="hljs-literal"><span class="hljs-literal">true</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> InvalidOperationException(SR.NullArguments); } .... } .... }</code> </pre> <br>  <b>PVS-Studio警告</b> ： <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">V3095</a>在对null进行验证之前，已使用“上下文”对象。 检查行：340，346。Principal.cs 340 <br><br> 开发人员明确指出<i>context</i>参数的<i>null</i>值无效，并希望强调这一点，但类型为<i>InvalidOperationException</i> 。 但是，在更高的条件下，在先前条件下， <i>上下文</i>链接<i>-context.ContextType会</i>无条件取消引用。 结果，如果<i>context的</i>值为<i>null</i> ，则将<i>抛出</i> <i>NullReferenceException</i>类型的异常，而不是预期的<i>InvalidOperationExcetion</i> 。 <br><br> 让我们尝试重现该问题。 将适当的库（ <i>System.DirectoryServices.AccountManagement</i> ）连接到项目，并执行以下代码： <br><br><pre> <code class="cs hljs">GroupPrincipal groupPrincipal = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> GroupPrincipal(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> PrincipalContext(ContextType.Machine)); groupPrincipal.Save(<span class="hljs-literal"><span class="hljs-literal">null</span></span>);</code> </pre> <br>  <i>GroupPrincipal</i>是抽象类<i>Principal</i>的后继者，该类包含我们需要的<i>Save</i>方法的实现。 我们运行代码以执行代码，然后查看需要证明的内容。 <br><br><p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/290/09a/2cc/29009a2cc3a5408808b9814d48bb0dea.png" alt="图片1"></div><br><br> 为了娱乐，您可以尝试从NuGet下载适当的软件包，然后尝试以相同的方式重复该问题。 我安装了4.5.0版的软件包，并得到了预期的结果。 <br><br><p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/3de/891/b4a/3de891b4a4ba8100bb63af19e4455842.png" alt="图片2"></div><br><br>  <b>第2期</b> <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> SearchResultCollection </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">FindAll</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">bool</span></span></span></span><span class="hljs-function"><span class="hljs-params"> findMoreThanOne</span></span></span><span class="hljs-function">)</span></span> { searchResult = <span class="hljs-literal"><span class="hljs-literal">null</span></span>; DirectoryEntry clonedRoot = <span class="hljs-literal"><span class="hljs-literal">null</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (_assertDefaultNamingContext == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { clonedRoot = SearchRoot.CloneBrowsable(); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { clonedRoot = SearchRoot.CloneBrowsable(); } .... }</code> </pre> <br>  <b>PVS-Studio警告</b> ： <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">V3004'then</a> '语句等效于'else'语句。  DirectorySearcher.cs 629 <br><br> 不管<i>_assertDefaultNamingContext == null</i>条件是否成立，都将执行相同的操作， <i>此后</i> ， <i>if语句</i> <i>的</i>分支具有相同的主体。 在某个分支中应该有另一个动作，或者可以省略<i>if语句，</i>以免混淆程序员和分析器。 <br><br>  <b>第3期</b> <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">DirectoryEntry</span></span> : <span class="hljs-title"><span class="hljs-title">Component</span></span> { .... <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">RefreshCache</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params">[] propertyNames</span></span></span><span class="hljs-function">)</span></span> { .... <span class="hljs-keyword"><span class="hljs-keyword">object</span></span>[] names = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">object</span></span>[propertyNames.Length]; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; propertyNames.Length; i++) names[i] = propertyNames[i]; .... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (_propertyCollection != <span class="hljs-literal"><span class="hljs-literal">null</span></span> &amp;&amp; propertyNames != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) .... .... } .... }</code> </pre> <br>  <b>PVS-Studio警告</b> ： <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">V3095</a>在对null进行验证之前，已使用'propertyNames'对象。 检查行：990、1004。DirectoryEntry.cs 990 <br><br> 我们再次看到一个奇怪的过程。 该方法具有<i>propertyNames！=空</i>检查，即 开发人员请确保该方法返回<i>null</i> 。 在上面，您可以观察到对该可能为空的引用的多个访问<i>-propertyNames.Length</i>和<i>propertyNames [i]</i> 。 结果是可以预料的-如果将null引用传递给方法， <i>则会</i>发生<i>NullReferenceExcepption</i>类型的异常。 <br><br>  <i>RefreshCache</i>是公共类中的公共方法，这是一个巧合。 尝试重复该问题？ 为此，将所需的库<i>-System.DirectoryServices</i>连接到项目，并编写如下代码： <br><br><pre> <code class="cs hljs">DirectoryEntry de = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> DirectoryEntry(); de.RefreshCache(<span class="hljs-literal"><span class="hljs-literal">null</span></span>);</code> </pre> <br> 运行代码以执行并查看预期的图片。 <br><br><p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/2d9/040/d0a/2d9040d0ae8d91394c476d6788aa7275.png" alt="图片3"></div><br><br> 为了好玩，您可以尝试在NuGet软件包的发行版上重现该问题。 我们将<i>System.DirectoryServices</i>包连接到NuGet项目（我使用的是4.5.0版），然后运行已经熟悉的代码来执行。 结果较低。 <br><br><p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/0d6/31e/309/0d631e3096fa8ba00b41fe10ad1001db.png" alt="图片4"></div><br><br>  <b>第4期</b> <br><br> 现在我们从相反的角度出发-首先尝试编写使用该类实例的代码，然后再查看内部。 让我们来看一下<i>System.Drawing.Common</i>库中的<i>System.Drawing.CharacterRange</i>的结构和同名的NuGet包。 <br><br> 使用的代码如下： <br><br><pre> <code class="cs hljs">CharacterRange range = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> CharacterRange(); <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> eq = range.Equals(<span class="hljs-literal"><span class="hljs-literal">null</span></span>); Console.WriteLine(eq);</code> </pre> <br> 为了以防万一，要刷新内存，我们将转到<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">docs.microsoft.com</a>来记住表达式<i>obj.Equals（null）</i>期望返回的值： <br><br>  <i>对于<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><i>Equals（Object）</i></a>方法的所有实现，以下语句必须为true。</i>  <i>在列表中，x，y和z表示不为null的对象引用。</i> <br><br>  <i>....</i> <br><br>  <b><i>x.Equals（null）返回false。</i></b> <br><br> 您是否认为“ False”将显示在控制台中？ 当然不是，那太容易了。  :)我们执行代码并查看结果。 <br><br><p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/e87/159/8f6/e871598f6ca5dacdb4a4fae7b5776520.png" alt="图片5"></div><br> 这是使用NuGet包<i>System.Drawing.Common</i> 4.5.1执行上述代码时的结论。 我们使用库的调试版本运行相同的代码，然后查看以下内容： <br><br><p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/6e9/f27/f1a/6e9f27f1a78768078fdd940e0a4be0ad.png" alt="图片6"></div><br><br> 现在让我们看一下源代码<i>-CharacterRange</i>结构中<i>Equals</i>方法的实现以及分析器警告： <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Equals</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">object</span></span></span></span><span class="hljs-function"><span class="hljs-params"> obj</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (obj.GetType() != <span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(CharacterRange)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; CharacterRange cr = (CharacterRange)obj; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ((_first == cr.First) &amp;&amp; (_length == cr.Length)); }</code> </pre> <br>  <b>PVS-Studio</b> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">警告</a> ： <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">V3115将</a> “ null”传递给“ Equals”方法不应导致“ NullReferenceException”。 字符范围56 <br><br> 我们看到了需要证明的内容<i>-obj</i>参数处理不正确，因此在调用<i>GetType</i>实例方法时，条件表达式中会发生<i>NullReferenceException</i>类型的异常。 <br><br>  <b>第5期</b> <br><br> 浏览此库时，请考虑另一个有趣的地方<i>-Icon.Save</i>方法。 在研究之前，请参见方法说明。 <br><br> 没有该方法的描述： <br><br><p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/ffd/fef/402/ffdfef402f77c462c94b9ff284f42e0c.png" alt="图片7"></div><br> 我们转向docs.microsoft.com-“ <a href="">Icon.Save（流）方法</a> ”。 但是，这里对输入值也没有限制，也没有有关生成的异常的信息。 <br><br> 现在让我们继续进行代码研究。 <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">sealed</span></span> <span class="hljs-keyword"><span class="hljs-keyword">partial</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Icon</span></span> : <span class="hljs-title"><span class="hljs-title">MarshalByRefObject</span></span>, <span class="hljs-title"><span class="hljs-title">ICloneable</span></span>, <span class="hljs-title"><span class="hljs-title">IDisposable</span></span>, <span class="hljs-title"><span class="hljs-title">ISerializable</span></span> { .... <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Save</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Stream outputStream</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (_iconData != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { outputStream.Write(_iconData, <span class="hljs-number"><span class="hljs-number">0</span></span>, _iconData.Length); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { .... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (outputStream == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ArgumentNullException(<span class="hljs-string"><span class="hljs-string">"dataStream"</span></span>); .... } } .... }</code> </pre> <br>  <b>PVS-Studio警告</b> ： <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">V3095</a>在对null进行验证之前，已使用'outputStream'对象。 检查行：654、672。Icon.Windows.cs 654 <br><br> 同样，我们已经知道的故事是可能取消引用null，因为方法参数被取消引用而不检查<i>null</i> 。 同样，情况（类和方法）的良好组合是公开的，这意味着您可以尝试重现该问题。 <br><br> 任务很简单-将代码执行带到表达式<i>outputStream.Write（_iconData，0，_iconData.Length）;</i> 同时保持变量<i>outputStream</i> - <i>null的值</i> 。 为此，满足条件<i>_iconData！= Null就</i>足够了。 <br><br> 让我们看一下最简单的公共构造函数： <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Icon</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> fileName</span></span></span><span class="hljs-function">) : </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">this</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">fileName, </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0</span></span></span></span></span><span class="hljs-function">)</span></span> { }</code> </pre> <br> 他只是将工作委托给另一个构造函数。 好吧，进一步看-这里使用的构造函数。 <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Icon</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> fileName, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> width, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> height</span></span></span><span class="hljs-function">) : </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">this</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> (FileStream f = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> FileStream(fileName, FileMode.Open, FileAccess.Read, FileShare.Read)) { Debug.Assert(f != <span class="hljs-literal"><span class="hljs-literal">null</span></span>, <span class="hljs-string"><span class="hljs-string">"File.OpenRead returned null instead of throwing an exception"</span></span>); _iconData = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[(<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>)f.Length]; f.Read(_iconData, <span class="hljs-number"><span class="hljs-number">0</span></span>, _iconData.Length); } Initialize(width, height); }</code> </pre> <br> 这就是您需要的。 调用此构造函数后，如果我们成功地从文件中读取了数据，并且在<i>Initialize</i>方法中没有发生崩溃，则<i>_iconData</i>字段将包含指向某些对象的链接，这正是我们所需要的。 <br><br> 事实证明，要重现此问题，您需要使用实际的图标创建<i>Icon</i>类的实例，然后调用<i>Save</i>方法，并将<i>null</i>作为参数传递，我们将这样做。 该代码可能如下所示： <br><br><pre> <code class="cs hljs">Icon icon = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Icon(<span class="hljs-string"><span class="hljs-string">@"D:\document.ico"</span></span>); icon.Save(<span class="hljs-literal"><span class="hljs-literal">null</span></span>);</code> </pre> <br> 执行结果是预期的。 <br><br><p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/b37/fdb/dd1/b37fdbdd1288c054fdaaa0add0ffcfcf.png" alt="图片8"></div><br>  <b>第6期</b> <br><br> 我们继续进行审查，然后转到<i>System.Management</i>库。 尝试找出在<i>情况</i> <i>CimType.UInt32</i>和其余<i>情况下</i>执行的操作之间的3个差异。 <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">string</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ConvertToNumericValueAndAddToArray</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">....</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> retFunctionName = <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.Empty; enumType = <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.Empty; <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span>(cimType) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> CimType.UInt8: <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> CimType.SInt8: <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> CimType.SInt16: <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> CimType.UInt16: <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> CimType.SInt32: arrayToAdd.Add(System.Convert.ToInt32( numericValue, (IFormatProvider)CultureInfo.InvariantCulture .GetFormat(<span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>)))); retFunctionName = <span class="hljs-string"><span class="hljs-string">"ToInt32"</span></span>; enumType = <span class="hljs-string"><span class="hljs-string">"System.Int32"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> CimType.UInt32: arrayToAdd.Add(System.Convert.ToInt32( numericValue, (IFormatProvider)CultureInfo.InvariantCulture .GetFormat(<span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>)))); retFunctionName = <span class="hljs-string"><span class="hljs-string">"ToInt32"</span></span>; enumType = <span class="hljs-string"><span class="hljs-string">"System.Int32"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> retFunctionName; }</code> </pre> <br> 当然，没有任何差异，分析仪会发出警告。 <br><br>  <b>PVS-Studio警告</b> ： <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">V3139</a>两个或更多分支机构执行相同的操作。  WMIGenerator.cs 5220 <br><br> 我个人对这种代码风格不太清楚。 如果这里没有错误，我认为将相同的逻辑分散到不同的案例中是不值得的。 <br><br>  <b>第7期</b> <br><br>  <i>Microsoft.CSharp</i>库。 <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> IList&lt;KeyValuePair&lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">object</span></span>&gt;&gt; QueryDynamicObject(<span class="hljs-keyword"><span class="hljs-keyword">object</span></span> obj) { .... List&lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>&gt; names = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> List&lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>&gt;(mo.GetDynamicMemberNames()); names.Sort(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (names != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { .... } .... }</code> </pre> <br>  <b>PVS-Studio</b> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">警告</a> ： <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">V3022</a>表达式'names！= Null'始终为true。  DynamicDebuggerProxy.cs 426 <br><br> 我可能会忽略此警告以及<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">V3022</a>和<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">V3063诊断程序</a>发出的许多类似警告。 有很多（很多）奇怪的支票，但这以某种方式渗入了我的灵魂。 在将带有<i>null</i>的局部变量<i>名称</i>与此变量进行比较之前，不仅可能会写入对新创建对象的引用，还会调用实例方法<i>Sort</i> 。 当然，这不是一个错误，但是就我而言，这个地方很有趣。 <br><br>  <b>第8期</b> <br><br> 这是另一段有趣的代码。 <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">InsertChildNoGrow</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Symbol child</span></span></span><span class="hljs-function">)</span></span> { .... <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (sym?.nextSameName != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { sym = sym.nextSameName; } Debug.Assert(sym != <span class="hljs-literal"><span class="hljs-literal">null</span></span> &amp;&amp; sym.nextSameName == <span class="hljs-literal"><span class="hljs-literal">null</span></span>); sym.nextSameName = child; .... }</code> </pre> <br>  <b>PVS-Studio警告</b> ： <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">V3042</a>可能为NullReferenceException。  '？。' 和“。” 运算符用于访问'sym'对象SymbolStore.cs的成员56 <br><br> 看看这里有什么。 满足以下两个条件之一时，循环结束： <br><br><ul><li>  <i>sym == null</i> ; </li><li>  <i>sym.nextSameName == null</i> 。 </li></ul><br> 第二个条件没有问题，因为第一个条件不能说，因为下面是对<i>nextSameName</i>实例字段的无条件调用，并且，如果<i>sym</i>为<i>null</i> ，则<i>在调用过程</i>中将抛出<i>NullReferenceException</i>类型的异常。 <br><br>  “你瞎了吗？ 还调用了<i>Debug.Assert</i> ，其中检查了<i>sym！= Null</i> “-有人可能反对。 但这全是盐！ 在<i>Debug.Assert</i>的发行版中<i>工作时，</i>没有任何帮助，在上述状态下，我们得到的只是<i>NullReferenceException</i> 。 此外，在Microsoft- <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Roslyn的</a>另一个项目中，我已经看到了类似的错误，其中<i>Debug.Assert的</i>情况非常相似。 罗斯林在您的允许下有点分心。 <br><br> 可以使用<i>Microsoft.CodeAnalysis</i>库重现该问题，也可以使用Syntax Visualizer直接在Visual Studio中重现该问题。 在Visual Studio版本16.1.6 +语法Visualizer 1.0上，此问题仍然存在。 <br><br> 要重现，下面的代码就足够了： <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">C1</span></span>&lt;<span class="hljs-title"><span class="hljs-title">T1</span></span>, <span class="hljs-title"><span class="hljs-title">T2</span></span>&gt; { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">foo</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { T1 val = <span class="hljs-keyword"><span class="hljs-keyword">default</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (val <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { } } }</code> </pre> <br> 接下来，在Syntax Visualizer中，您需要找到类型为<i>ConstantPatternSyntax</i>的语法树的节点，该节点对应于代码中的<i>null</i> ，并<i>为其</i>请求<i>TypeSymbol</i> 。 <br><br><p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/855/b9c/baa/855b9cbaa67c9a5909117d513e154293.png" alt="图片9"></div><br> 之后，Visual Studio将重新启动。 如果进入事件查看器，我们将在库中找到有关问题的信息： <br><br><pre> <code class="cs hljs">Application: devenv.exe Framework Version: v4<span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.30319</span></span> Description: The process was terminated due to an unhandled exception. Exception Info: System.Resources.MissingManifestResourceException at System.Resources.ManifestBasedResourceGroveler .HandleResourceStreamMissing(System.String) at System.Resources.ManifestBasedResourceGroveler.GrovelForResourceSet( System.Globalization.CultureInfo, System.Collections.Generic.Dictionary<span class="hljs-string"><span class="hljs-string">'2 &lt;System.String,System.Resources.ResourceSet&gt;, Boolean, Boolean, System.Threading.StackCrawlMark ByRef) at System.Resources.ResourceManager.InternalGetResourceSet( System.Globalization.CultureInfo, Boolean, Boolean, System.Threading.StackCrawlMark ByRef) at System.Resources.ResourceManager.InternalGetResourceSet( System.Globalization.CultureInfo, Boolean, Boolean) at System.Resources.ResourceManager.GetString(System.String, System.Globalization.CultureInfo) at Roslyn.SyntaxVisualizer.DgmlHelper.My. Resources.Resources.get_SyntaxNodeLabel() ....</span></span></code> </pre> <br> 关于devenv.exe的问题： <br><br><pre> <code class="cs hljs">Faulting application name: devenv.exe, version: <span class="hljs-number"><span class="hljs-number">16.1</span></span><span class="hljs-number"><span class="hljs-number">.29102</span></span><span class="hljs-number"><span class="hljs-number">.190</span></span>, time stamp: <span class="hljs-number"><span class="hljs-number">0x5d1c133b</span></span> Faulting module name: KERNELBASE.dll, version: <span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.18362</span></span><span class="hljs-number"><span class="hljs-number">.145</span></span>, time stamp: <span class="hljs-number"><span class="hljs-number">0xf5733ace</span></span> Exception code: <span class="hljs-number"><span class="hljs-number">0xe0434352</span></span> Fault offset: <span class="hljs-number"><span class="hljs-number">0x001133d2</span></span> ....</code> </pre> <br> 具有Roslyn库的调试版本，您可以找到发生异常的位置： <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> Conversion </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ClassifyImplicitBuiltInConversionSlow</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"> TypeSymbol source, TypeSymbol destination, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">ref</span></span></span></span><span class="hljs-function"><span class="hljs-params"> HashSet&lt;DiagnosticInfo&gt; useSiteDiagnostics</span></span></span><span class="hljs-function">)</span></span> { Debug.Assert((<span class="hljs-keyword"><span class="hljs-keyword">object</span></span>)source != <span class="hljs-literal"><span class="hljs-literal">null</span></span>); Debug.Assert((<span class="hljs-keyword"><span class="hljs-keyword">object</span></span>)destination != <span class="hljs-literal"><span class="hljs-literal">null</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( source.SpecialType == SpecialType.System_Void || destination.SpecialType == SpecialType.System_Void) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Conversion.NoConversion; } .... }</code> </pre> <br> 在这里，就像上面.NET Core库中的代码一样，也可以通过<i>Debug.Assert</i>进行检查，但是，在使用库的发行版时，它没有任何帮助。 <br><br>  <b>第9期</b> <br><br> 分散注意力-就足够了，回到.NET Core库。  <i>System.IO.IsolatedStorage</i>程序包包含以下有趣的代码。 <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ContainsUnknownFiles</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> directory</span></span></span><span class="hljs-function">)</span></span> { .... <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (files.Length &gt; <span class="hljs-number"><span class="hljs-number">2</span></span> || ( (!IsIdFile(files[<span class="hljs-number"><span class="hljs-number">0</span></span>]) &amp;&amp; !IsInfoFile(files[<span class="hljs-number"><span class="hljs-number">0</span></span>]))) || (files.Length == <span class="hljs-number"><span class="hljs-number">2</span></span> &amp;&amp; !IsIdFile(files[<span class="hljs-number"><span class="hljs-number">1</span></span>]) &amp;&amp; !IsInfoFile(files[<span class="hljs-number"><span class="hljs-number">1</span></span>])) ); }</code> </pre> <br>  <b>警告PVS-Studio</b> ： <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">V3088</a>表达式用括号括起来两次：（（表达式））。 不需要一对括号，否则会出现打印错误。 孤立的StorageFile.cs 839 <br><br> 说代码格式化令人迷惑不说。 简要浏览一下这段代码，我会说第一个运算符||的左操作数。  <i>-files.Length&gt; 2</i> ，右边的是括号中的那个。 至少代码是这样格式化的。 再仔细一点，您可以了解并非如此。 实际上，正确的操作数是<i>（（！IsIdFile（文件[0]）&amp;&amp;！IsInfoFile（文件[0]））））</i> 。 我认为，此代码非常令人困惑。 <br><br>  <b>第10期</b> <br><br> 在PVS-Studio 7.03版本中，添加了诊断规则V3138，该规则可查找插补行中的错误。 更确切地说，在最有可能插值的行中，但是由于缺少<i>$</i>字符，所以它们不是。  <i>System.Net</i>库发现了对该诊断规则的一些有趣的响应。 <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">internal</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CacheCredential</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">SafeFreeCredentials newHandle</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { .... } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (Exception e) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!ExceptionCheck.IsFatal(e)) { NetEventSource.Fail(<span class="hljs-literal"><span class="hljs-literal">null</span></span>, <span class="hljs-string"><span class="hljs-string">"Attempted to throw: {e}"</span></span>); } } }</code> </pre> <br>  <b>PVS-Studio警告</b> ： <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">V3138</a>字符串文字包含潜在的内插表达式。 考虑检查：e。  SSPIHandleCache.cs 42 <br><br>  <i>Fail</i>方法的第二个参数很可能应该是一个内插字符串，其中<i>e</i>异常的字符串表示形式将被替换为该字符串。 但是，由于缺少<i>$</i>字符，因此不会抛出该异常的字符串表示形式。 <br><br>  <b>第11期</b> <br><br> 我遇到了另一个类似的案例。 <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">async</span></span></span><span class="hljs-function"> Task&lt;</span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">string</span></span></span><span class="hljs-function">&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetDigestTokenForCredential</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">....</span></span></span><span class="hljs-function">)</span></span> { .... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (NetEventSource.IsEnabled) NetEventSource.Error(digestResponse, <span class="hljs-string"><span class="hljs-string">"Algorithm not supported: {algorithm}"</span></span>); .... }</code> </pre> <br>  <b>PVS-Studio警告</b> ： <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">V3138</a>字符串文字包含潜在的内插表达式。 考虑检查：算法。  AuthenticationHelper.Digest.cs 58 <br><br> 这种情况类似于上述情况，再次跳过<i>$</i>符号-错误的行转到<i>Error</i>方法。 <br><br>  <b>第十二期</b> <br><br> 打包<i>System.Net.Mail</i> 。 该方法很小，我将全部介绍它，以便使错误更有趣。 <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">internal</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">SetContent</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Stream stream</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (stream == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ArgumentNullException(<span class="hljs-keyword"><span class="hljs-keyword">nameof</span></span>(stream)); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (_streamSet) { _stream.Close(); _stream = <span class="hljs-literal"><span class="hljs-literal">null</span></span>; _streamSet = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } _stream = stream; _streamSet = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; _streamUsedOnce = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; TransferEncoding = TransferEncoding.Base64; }</code> </pre> <br>  <b>PVS-Studio警告</b> ： <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">V3008为</a> '_streamSet'变量连续两次分配值。 也许这是一个错误。 检查行：123、119。MimePart.cs 123 <br><br> 变量<i>_streamSet</i>的值的双重分配看起来很奇怪（首先-在条件下；然后-外部）。 将<i>_stream</i>变量清零的<i>情况</i>与此相同。 结果， <i>_stream</i>仍将设置为<i>stream</i> ，而<i>_streamSet</i>为<i>true</i> 。 <br><br>  <b>第13期</b> <br><br> 分析器立即向<i>System.Linq.Expressions</i>库中的一个有趣位置发出了2条警告。 在这种情况下，它是一个功能而不是错误，但是，该方法还是非常有趣的…… <br><br><pre> <code class="cs hljs"><span class="hljs-comment"><span class="hljs-comment">// throws NRE when o is null protected static void NullCheck(object o) { if (o == null) { o.GetType(); } }</span></span></code> </pre> <br>  <b>PVS-Studio警告</b> ： <br><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">V3010</a>需要使用函数“ GetType”的返回值。  Instruction.cs 36 </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">V3080</a>可能为空的取消引用。 考虑检查“ o”。  Instruction.cs 36 </li></ul><br> 甚至没有什么可评论的。 <br><br><p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/5c9/a88/a22/5c9a88a221d4cd5ba5f4f1d9f74a346b.png" alt="图片20"></div><br>  <b>第14期</b> <br><br> 让我们看看另一种情况，我们将“从外部”进行工作。 首先，我们将编写代码，确定问题，然后深入内部。 要研究，请使用<i>System.Configuration.ConfigurationManager</i>库和同名的NuGet包。 我使用的软件包版本为4.5.0。 我们将使用<i>System.Configuration.CommaDelimitedStringCollection</i>类。 <br><br> 让我们做一些不太棘手的事情。 例如，创建一个对象，提取其字符串表示形式，获取该字符串的长度并进行打印。 相关代码： <br><br><pre> <code class="cs hljs">CommaDelimitedStringCollection collection = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> CommaDelimitedStringCollection(); Console.WriteLine(collection.ToString().Length);</code> </pre> <br> 以防万一，请看一下<i>ToString</i>方法的描述： <br><br><p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/8dc/544/56d/8dc54456dd1296d89fbe447fac71ac17.png" alt="图片11"></div><br> 没什么不寻常的，只是返回对象的字符串表示形式。 以防万一，我还要看看docs.microsoft.com-“ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">CommaDelimitedStringCollection.ToString方法</a> ”。 似乎也没什么特别的。 <br><br> 好了，运行代码执行，ii ... <br><br><p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/fa5/89f/1af/fa589f1afc8ceb9415694e1261e59ab7.png" alt="图片12"></div><br> 嗯，出乎意料。 好吧，让我们尝试将元素添加到集合中，然后获取其字符串表示形式。  “完全偶然”，我们将添加一个空字符串:)。 代码将更改，如下所示： <br><br><pre> <code class="cs hljs">CommaDelimitedStringCollection collection = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> CommaDelimitedStringCollection(); collection.Add(String.Empty); Console.WriteLine(collection.ToString().Length);</code> </pre> <br> 我们启动它，看看... <br><br><p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/d37/4bc/d2e/d374bcd2ed23bd048276493ed19d30fe.png" alt="图片13"></div><br> 又是什么？！ 好了，让我们最后看一下<i>CommaDelimitedStringCollection</i>类的<i>ToString</i>方法的<i>实现</i> 。 代码如下所示： <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">string</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ToString</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Count &lt;= <span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; StringBuilder sb = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> StringBuilder(); <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">string</span></span> str <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>) { ThrowIfContainsDelimiter(str); <span class="hljs-comment"><span class="hljs-comment">// .... sb.Append(str.Trim()); sb.Append(','); } if (sb.Length &gt; 0) sb.Length = sb.Length - 1; return sb.Length == 0 ? null : sb.ToString(); }</span></span></code> </pre> <br>  <b>PVS-Studio警告</b> ： <br><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">V3108</a>不建议从“ ToSting（）”方法返回“ null”。  StringAttributeCollection.cs 57 </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">V3108</a>不建议从“ ToSting（）”方法返回“ null”。  StringAttributeCollection.cs 71 </li></ul><br> 在这里，我们看到两个地方，当前的<i>ToString</i>实现可以返回<i>null</i> 。 回想一下Microsoft在实现<i>ToString</i>方法时的建议，为此，我们再次转到docs.microsoft.com-“ Object.ToString <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Method</a> ”： <br><br>  <i>对继承者的说明.... ToString（）方法的重写应遵循以下准则：</i> <ul><li>  <i>....</i> </li><li>  <i>您的ToString（）重写不应返回Empty或</i> <b><i>空</i></b> <i>字符串。</i> </li><li>  <i>....</i> </li></ul><br> 实际上，这就是PVS-Studio警告的地方。 上面我们写来重现问题的两个代码段到达了不同的退出点-分别返回<i>null</i>的第一和第二位。 挖得更深一些。 <br><br> 第一种情况。  <i>Count-</i>基类<i>StringCollection的</i>一个属性。 由于未添加任何元素， <i>Count == 0</i> ，条件<i>Count &lt;= 0</i>满足，返回<i>null</i> 。 <br><br> 在第二种情况下，我们为此使用实例方法<i>CommaDelimitedStringCollection.Add</i>添加了一个元素。 <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> new </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Add</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">value</span></span></span></span></span><span class="hljs-function">)</span></span> { ThrowIfReadOnly(); ThrowIfContainsDelimiter(<span class="hljs-keyword"><span class="hljs-keyword">value</span></span>); _modified = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">base</span></span>.Add(<span class="hljs-keyword"><span class="hljs-keyword">value</span></span>.Trim()); }</code> </pre> <br> 检入<i>ThrowIf ...</i>方法成功<i>通过，</i>并将该项目添加到基本集合中。 因此， <i>Count</i>的值等于1。现在返回<i>ToString</i>方法。 表达式<i>Count &lt;= 0的</i>值为<i>false</i> ，因此，该方法不会退出并且代码将继续执行。 内部遍历开始，并将2个元素添加到<i>StringBuilder中</i> -一个空字符串和一个逗号。 结果，发现<i>sb</i>仅包含一个逗号， <i>Length</i>属性的值分别为1。 表达式<i>sb.Length&gt; 0的</i>值为<i>true</i> ，执行减法并写入<i>sb.Length</i> ，现在<i>sb.Length的</i>值为0。这导致该方法再次返回<i>null</i> 。 <br><br>  <b>第十五期</b> <br><br> 出乎意料的是，我想使用<i>System.Configuration.ConfigurationProperty</i>类。 选择具有最多参数的构造函数： <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ConfigurationProperty</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> name, Type type, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">object</span></span></span></span><span class="hljs-function"><span class="hljs-params"> defaultValue, TypeConverter typeConverter, ConfigurationValidatorBase validator, ConfigurationPropertyOptions options, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> description</span></span></span><span class="hljs-function">)</span></span>;</code> </pre> <br> 让我们看一下最后一个参数的描述： <br><br><pre> <code class="cs hljs"><span class="hljs-comment"><span class="hljs-comment">// description: // The description of the configuration entity.</span></span></code> </pre> <br>  docs.microsoft.com上的构造函数说明也是如此。 好，让我们看一下在构造函数主体中如何使用此参数： <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ConfigurationProperty</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">...., </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> description</span></span></span><span class="hljs-function">)</span></span> { ConstructorInit(name, type, options, validator, typeConverter); SetDefaultValue(defaultValue); }</code> </pre> <br> 并且不使用该参数。 <br><br>  <b>PVS-Studio警告</b> ： <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">V3117</a>未使用构造函数参数“ description”。  ConfigurationProperty.cs 62 <br><br> 他们可能没有故意使用它，但是相应参数的描述令人困惑。 <br><br>  <b>第16期</b> <br><br> 我遇到了另一个类似的地方。 尝试自己查找错误，构造函数的代码如下。 <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">internal</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">SectionXmlInfo</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> configKey, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> definitionConfigPath, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> targetConfigPath, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> subPath, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> filename, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> lineNumber, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">object</span></span></span></span><span class="hljs-function"><span class="hljs-params"> streamVersion, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> rawXml, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> configSource, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> configSourceStreamName, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">object</span></span></span></span><span class="hljs-function"><span class="hljs-params"> configSourceStreamVersion, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> protectionProviderName, OverrideModeSetting overrideMode, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">bool</span></span></span></span><span class="hljs-function"><span class="hljs-params"> skipInChildApps</span></span></span><span class="hljs-function">)</span></span> { ConfigKey = configKey; DefinitionConfigPath = definitionConfigPath; TargetConfigPath = targetConfigPath; SubPath = subPath; Filename = filename; LineNumber = lineNumber; StreamVersion = streamVersion; RawXml = rawXml; ConfigSource = configSource; ConfigSourceStreamName = configSourceStreamName; ProtectionProviderName = protectionProviderName; OverrideModeSetting = overrideMode; SkipInChildApps = skipInChildApps; }</code> </pre> <br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PVS-Studio警告</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">V3117</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">构造函数参数“ configSourceStreamVersion”未使用。</font><font style="vertical-align: inherit;">SectionXmlInfo.cs 16 </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">有一个对应的属性，尽管看起来有点奇怪：</font></font><br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">internal</span></span> <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> ConfigSourceStreamVersion { <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> { } }</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">通常，该代码看起来可疑。</font><font style="vertical-align: inherit;">也许为了兼容性而保留了参数/属性，但这只是我的猜测。</font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第17期，</font></font></b> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">让我们看看在</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">System.Runtime.WindowsRuntime.UI.Xaml</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">库</font><font style="vertical-align: inherit;">和同名的NuGet包</font><font style="vertical-align: inherit;">的代码中发现了什么有趣的东西</font><font style="vertical-align: inherit;">。</font></font><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">struct</span></span> RepeatBehavior : IFormattable { .... <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">string</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ToString</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> InternalToString(<span class="hljs-literal"><span class="hljs-literal">null</span></span>, <span class="hljs-literal"><span class="hljs-literal">null</span></span>); } .... }</code> </pre> <br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PVS-Studio警告</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">V3108</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">不建议从“ ToSting（）”方法返回“ null”。 113个RepeatBehavior.cs </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">已经被通过熟悉的故事-一个方法</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">的ToString</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">可以返回值</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">空</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。因此，假设</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">RepeatBehavior.ToString</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">始终返回非零引用，</font><font style="vertical-align: inherit;">那么调用代码的作者</font><font style="vertical-align: inherit;">可能会在某些时候感到不愉快。同样，这与Microsoft准则有所不同。</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">当然，仅从此方法尚不清楚</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ToString是否</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">可以返回</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">null-</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">您需要更深入地研究并查看</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">InternalToString</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">方法</font><font style="vertical-align: inherit;">。</font></font><br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">internal</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">string</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">InternalToString</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> format, IFormatProvider formatProvider</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> (_Type) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> RepeatBehaviorType.Forever: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"Forever"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> RepeatBehaviorType.Count: StringBuilder sb = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> StringBuilder(); sb.AppendFormat( formatProvider, <span class="hljs-string"><span class="hljs-string">"{0:"</span></span> + format + <span class="hljs-string"><span class="hljs-string">"}x"</span></span>, _Count); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> sb.ToString(); <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> RepeatBehaviorType.Duration: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> _Duration.ToString(); <span class="hljs-keyword"><span class="hljs-keyword">default</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } }</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">分析器发现，如果在</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">开关中</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">执行</font><font style="vertical-align: inherit;">了</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">默认</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">分支，则</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">InternalToString</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">将返回</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">null</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，因此</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">null</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">将返回</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ToString</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br><br> <i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">RepeatBehavior</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">是一个公共结构，而</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ToString</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">是一个公共方法，因此您可以尝试在实践中重现该问题。为此，创建一个</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">RepeatBehavior</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">实例，</font><font style="vertical-align: inherit;">在其上调用</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ToString</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">方法</font><font style="vertical-align: inherit;">，但请记住</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">_Type</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">不能等于</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">RepeatBehaviorType.Forever</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">RepeatBehaviorType.Count</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">或</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">RepeatBehaviorType.Duration</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br><br> <i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">_Type</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">是可以通过公共属性分配的私有字段：</font></font><br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">struct</span></span> RepeatBehavior : IFormattable { .... <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> RepeatBehaviorType _Type; .... <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> RepeatBehaviorType Type { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> _Type; } <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> { _Type = <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>; } } .... }</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">到目前为止，一切看起来都不错。</font><font style="vertical-align: inherit;">继续，看看</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">RepeatBehaviorType</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">类型</font><i><font style="vertical-align: inherit;">是</font></i><font style="vertical-align: inherit;">什么</font><font style="vertical-align: inherit;">。</font></font><br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">enum</span></span> RepeatBehaviorType { Count, Duration, Forever }</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">如您所见，</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">RepeatBehaviorType</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">是包含所有三个元素的枚举。</font><font style="vertical-align: inherit;">此外，所有这三个元素都包含在所需的</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">switch</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">表达式中</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">但是，这并不意味着</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">默认</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">分支不可访问。</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">要重现此问题，请将</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">System.Runtime.WindowsRuntime.UI.Xaml</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">程序包</font><font style="vertical-align: inherit;">（我使用的是版本4.3.0）</font><font style="vertical-align: inherit;">连接到项目，</font><font style="vertical-align: inherit;">然后执行以下代码。</font></font><br><br><pre> <code class="cs hljs">RepeatBehavior behavior = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> RepeatBehavior() { Type = (RepeatBehaviorType)<span class="hljs-number"><span class="hljs-number">666</span></span> }; Console.WriteLine(behavior.ToString() <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>);</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">预计</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">True</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">将输出到控制台</font><font style="vertical-align: inherit;">，这意味着</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ToString</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">返回</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">null</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，因为 </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">_Type</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">不等于</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">case</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">分支</font><font style="vertical-align: inherit;">中的任何值</font><font style="vertical-align: inherit;">，并且控制权传递给</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">default</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">分支</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">实际上，我们追求的是。</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">我还想指出，在方法的注释或</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">docs.microsoft.com</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">上的注释中都没有</font><font style="vertical-align: inherit;">指出该方法可以返回</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">null</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第18期</font></font></b> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">接下来，我们将</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">研究System.Private.DataContractSerialization的</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">一些警告</font><font style="vertical-align: inherit;">。</font></font><br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">CharType</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span> None = <span class="hljs-number"><span class="hljs-number">0x00</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span> FirstName = <span class="hljs-number"><span class="hljs-number">0x01</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span> Name = <span class="hljs-number"><span class="hljs-number">0x02</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span> Whitespace = <span class="hljs-number"><span class="hljs-number">0x04</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span> Text = <span class="hljs-number"><span class="hljs-number">0x08</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span> AttributeText = <span class="hljs-number"><span class="hljs-number">0x10</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span> SpecialWhitespace = <span class="hljs-number"><span class="hljs-number">0x20</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span> Comment = <span class="hljs-number"><span class="hljs-number">0x40</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[] s_charType = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[<span class="hljs-number"><span class="hljs-number">256</span></span>] { .... CharType.None, <span class="hljs-comment"><span class="hljs-comment">/* 9 (.) */</span></span> CharType.None| CharType.Comment| CharType.Comment| CharType.Whitespace| CharType.Text| CharType.SpecialWhitespace, <span class="hljs-comment"><span class="hljs-comment">/* A (.) */</span></span> CharType.None| CharType.Comment| CharType.Comment| CharType.Whitespace| CharType.Text| CharType.SpecialWhitespace, <span class="hljs-comment"><span class="hljs-comment">/* B (.) */</span></span> CharType.None, <span class="hljs-comment"><span class="hljs-comment">/* C (.) */</span></span> CharType.None, <span class="hljs-comment"><span class="hljs-comment">/* D (.) */</span></span> CharType.None| CharType.Comment| CharType.Comment| CharType.Whitespace, <span class="hljs-comment"><span class="hljs-comment">/* E (.) */</span></span> CharType.None, .... };</code> </pre> <br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PVS-Studio警告</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：</font></font><br><br><ul><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">V3001</a> There are identical sub-expressions 'CharType.Comment' to the left and to the right of the '|' 操作员。 XmlUTF8TextReader.cs 56 </li><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">V3001</a> There are identical sub-expressions 'CharType.Comment' to the left and to the right of the '|' 操作员。 XmlUTF8TextReader.cs 58 </li><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">V3001</a> There are identical sub-expressions 'CharType.Comment' to the left and to the right of the '|' 操作员。 XmlUTF8TextReader.cs 64 </li></ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">分析器发现</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CharType.Comment</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">表达式的使用可疑</font><i><font style="vertical-align: inherit;">。 CharType.Comment</font></i><font style="vertical-align: inherit;">。自</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（CharType.Comment | CharType.Comment）== CharType.Comment</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">以来，它看起来有点奇怪</font><font style="vertical-align: inherit;">。初始化使用</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CharType.Comment</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">的数组的其他元素时</font><font style="vertical-align: inherit;">，没有这样的重复。</font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第19期</font></font></b> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">继续。让我们</font><font style="vertical-align: inherit;">在方法说明中和在docs.microsoft.com </font><font style="vertical-align: inherit;">上查看有关</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">XmlBinaryWriterSession.TryAdd</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">方法的返回值的信息</font><font style="vertical-align: inherit;">-“ </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">XmlBinaryWriterSession.TryAdd（XmlDictionaryString，Int32）Method</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ”：</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">返回：如果可以添加字符串，则为true；否则为false。否则为假。</font></font></i> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">现在让我们看一下该方法的主体：</font></font><br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">virtual</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">TryAdd</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">XmlDictionaryString </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">value</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">out</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> key</span></span></span><span class="hljs-function">)</span></span> { IntArray keys; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">value</span></span> == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> System.Runtime .Serialization .DiagnosticUtility .ExceptionUtility .ThrowHelperArgumentNull(<span class="hljs-keyword"><span class="hljs-keyword">nameof</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">value</span></span>)); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (_maps.TryGetValue(<span class="hljs-keyword"><span class="hljs-keyword">value</span></span>.Dictionary, <span class="hljs-keyword"><span class="hljs-keyword">out</span></span> keys)) { key = (keys[<span class="hljs-keyword"><span class="hljs-keyword">value</span></span>.Key] - <span class="hljs-number"><span class="hljs-number">1</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (key != <span class="hljs-number"><span class="hljs-number">-1</span></span>) { <span class="hljs-comment"><span class="hljs-comment">// If the key is already set, then something is wrong throw System.Runtime .Serialization .DiagnosticUtility .ExceptionUtility .ThrowHelperError( new InvalidOperationException( SR.XmlKeyAlreadyExists)); } key = Add(value.Value); keys[value.Key] = (key + 1); return true; } key = Add(value.Value); keys = AddKeys(value.Dictionary, value.Key + 1); keys[value.Key] = (key + 1); return true; }</span></span></code> </pre> <br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PVS-Studio警告</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">V3009</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">奇怪的是，此方法始终返回一个相同的“ true”值。 XmlBinaryWriterSession.cs 29 </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">该方法返回</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">true</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">或引发异常，但从</font><font style="vertical-align: inherit;">不返回</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">false</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，</font><font style="vertical-align: inherit;">这看起来很奇怪</font><font style="vertical-align: inherit;">。</font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第20期我</font></font></b> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">遇到了具有类似问题的代码，但现在却又相反了-它始终返回</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">false</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：</font></font><br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">internal</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">virtual</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OnHandleReference</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">....</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (xmlWriter.depth &lt; depthToCheckCyclicReference) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (canContainCyclicReference) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (_byValObjectsInScope.Contains(obj)) <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> ....; _byValObjectsInScope.Push(obj); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; }</code> </pre> <br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PVS-Studio警告</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">V3009</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">奇怪的是，此方法始终返回一个相同的'false'值。</font><font style="vertical-align: inherit;">XmlObjectSerializerWriteContext.cs 415 </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">因此，我们已经走了很长一段路！</font><font style="vertical-align: inherit;">因此，在继续之前，我建议稍事休息-伸展肌肉，走一点，让眼睛休息，看着窗外...</font></font><br><br><p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/008/d6a/92d/008d6a92d6f4cf4066e744e4c857b47d.png" alt="图片21"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 我希望在这一点上您再次充满活力，所以让我们继续。 </font></font> :) <br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第21期</font></font></b> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">让我们看一下</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">System.Security.Cryptography.Algorithms</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">项目中有趣的地方</font><font style="vertical-align: inherit;">。</font></font><br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">byte</span></span></span><span class="hljs-function">[] </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GenerateMask</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">byte</span></span></span></span><span class="hljs-function"><span class="hljs-params">[] rgbSeed, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> cbReturn</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> (HashAlgorithm hasher = (HashAlgorithm)CryptoConfig.CreateFromName(_hashNameValue)) { <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[] rgbCounter = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[<span class="hljs-number"><span class="hljs-number">4</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[] rgbT = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[cbReturn]; <span class="hljs-keyword"><span class="hljs-keyword">uint</span></span> counter = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> ib = <span class="hljs-number"><span class="hljs-number">0</span></span>; ib &lt; rgbT.Length;) { <span class="hljs-comment"><span class="hljs-comment">// Increment counter -- up to 2^32 * sizeof(Hash) Helpers.ConvertIntToByteArray(counter++, rgbCounter); hasher.TransformBlock(rgbSeed, 0, rgbSeed.Length, rgbSeed, 0); hasher.TransformFinalBlock(rgbCounter, 0, 4); byte[] hash = hasher.Hash; hasher.Initialize(); Buffer.BlockCopy(hash, 0, rgbT, ib, Math.Min(rgbT.Length - ib, hash.Length)); ib += hasher.Hash.Length; } return rgbT; } }</span></span></code> </pre> <br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PVS-Studio警告</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">V3080</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">可能取消空引用。考虑检查“哈希”。 PKCS1MaskGenerationMethod.cs 37 </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">分析器警告说，在评估</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">hasher.TransformBlock</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">表达式时</font><i><font style="vertical-align: inherit;">，hasher</font></i><font style="vertical-align: inherit;">变量</font><i><font style="vertical-align: inherit;">的</font></i><font style="vertical-align: inherit;">值</font><font style="vertical-align: inherit;">可以为</font><i><font style="vertical-align: inherit;">null</font></i><font style="vertical-align: inherit;">，在这种情况下</font><font style="vertical-align: inherit;">将</font><i><font style="vertical-align: inherit;">抛出</font></i></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">NullReferenceException</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。由于进行了过程间分析，因此出现了此警告。</font><font style="vertical-align: inherit;">因此，要了解</font><font style="vertical-align: inherit;">这种情况下</font><font style="vertical-align: inherit;">的</font><i><font style="vertical-align: inherit;">哈希</font></i><i><font style="vertical-align: inherit;">值</font></i><font style="vertical-align: inherit;">是否</font><font style="vertical-align: inherit;">可以为</font><i><font style="vertical-align: inherit;">null</font></i><font style="vertical-align: inherit;">，您需要</font><i><font style="vertical-align: inherit;">转到CreateFromName</font></i><font style="vertical-align: inherit;">方法</font><font style="vertical-align: inherit;">。</font></font><i><font style="vertical-align: inherit;"></font></i><font style="vertical-align: inherit;"></font><i><font style="vertical-align: inherit;"></font></i><font style="vertical-align: inherit;"></font><br><br><font style="vertical-align: inherit;"></font><i><font style="vertical-align: inherit;"></font></i><font style="vertical-align: inherit;"></font><i><font style="vertical-align: inherit;"></font></i><font style="vertical-align: inherit;"></font><i><font style="vertical-align: inherit;"></font></i><font style="vertical-align: inherit;"></font><br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">object</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CreateFromName</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> name</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> CreateFromName(name, <span class="hljs-literal"><span class="hljs-literal">null</span></span>); }</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">到目前为止，什么都没有-我们会更深入。</font><font style="vertical-align: inherit;">具有两个参数</font><font style="vertical-align: inherit;">的</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CreateFromName</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">重载版本的主体</font><font style="vertical-align: inherit;">非常大，因此我引入了一个简化版本。</font></font><br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">object</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CreateFromName</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> name, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">params</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">object</span></span></span></span><span class="hljs-function"><span class="hljs-params">[] args</span></span></span><span class="hljs-function">)</span></span> { .... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (retvalType == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } .... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (cons == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } .... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (candidates.Count == <span class="hljs-number"><span class="hljs-number">0</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } .... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (rci == <span class="hljs-literal"><span class="hljs-literal">null</span></span> || <span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(Delegate).IsAssignableFrom(rci.DeclaringType)) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } .... <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> retval; }</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">如您所见，方法中有多个出口点，其中显式返回</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">null</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">因此，至少从理论上讲，在前面提到的向其发出警告的方法中，可能会发生</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">NullReferenceException</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">类型的异常</font><font style="vertical-align: inherit;">。</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">理论是好的，但让我们尝试在实践中重现问题。</font><font style="vertical-align: inherit;">为此，请再次查看原始方法并注意要点。</font><font style="vertical-align: inherit;">该方法的无关代码是可简化的。</font></font><br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">PKCS1MaskGenerationMethod</span></span> : .... <span class="hljs-comment"><span class="hljs-comment">// &lt;= 1 { .... public PKCS1MaskGenerationMethod() // &lt;= 2 { _hashNameValue = DefaultHash; } .... public override byte[] GenerateMask(byte[] rgbSeed, int cbReturn) // &lt;= 3 { using (HashAlgorithm hasher = (HashAlgorithm)CryptoConfig.CreateFromName(_hashNameValue)) // &lt;= 4 { byte[] rgbCounter = new byte[4]; byte[] rgbT = new byte[cbReturn]; // &lt;= 5 uint counter = 0; for (int ib = 0; ib &lt; rgbT.Length;) // &lt;= 6 { .... Helpers.ConvertIntToByteArray(counter++, rgbCounter); // &lt;= 7 hasher.TransformBlock(rgbSeed, 0, rgbSeed.Length, rgbSeed, 0); .... } .... } } }</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">让我们更详细地考虑关键点：</font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1，3</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。该类和方法具有</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">公共</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">访问</font><i><font style="vertical-align: inherit;">修饰符</font></i><font style="vertical-align: inherit;">。因此，连接库时此接口可用-您可以尝试重复该问题。</font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。一个类（非抽象实例）具有一个公共构造函数，创建一个我们将使用的实例应该很容易。在某些情况下，我检查了班级是抽象的，因此要重复这个问题，我仍然必须寻找继承人和获取继承人的方法。</font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">4</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CreateFromName</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">不应引发任何异常，并且应返回</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">null-</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">最重要的一点，我们将在稍后返回。</font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">5、6</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><i><font style="vertical-align: inherit;">Cb返回</font></i><font style="vertical-align: inherit;">值</font></font><i><font style="vertical-align: inherit;"></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">应该大于0（当然，在成功创建数组的适当范围内）。</font><font style="vertical-align: inherit;">要满足进一步的条件</font><i><font style="vertical-align: inherit;">ib &lt;rgbT.Length</font></i><font style="vertical-align: inherit;">并进入循环体，</font><font style="vertical-align: inherit;">必须满足</font><font style="vertical-align: inherit;">条件</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">cbReturn&gt; 0</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><b><font style="vertical-align: inherit;">7</font></b><font style="vertical-align: inherit;">。</font><i><font style="vertical-align: inherit;">Helpres.ConvertIntToByteArray</font></i><font style="vertical-align: inherit;">应该可以正常工作。</font><font style="vertical-align: inherit;">要满足依赖于方法参数的条件，只需传递足够的参数就足够了，例如：</font></font><i><font style="vertical-align: inherit;"></font></i><font style="vertical-align: inherit;"></font><br><br> <b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"></font><i><font style="vertical-align: inherit;"></font></i><font style="vertical-align: inherit;"></font><br><br><font style="vertical-align: inherit;"></font><br><br><ul><li> <i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">rgbCeed-</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">新字节[] {0，1，2，3};</font></font></li><li> <i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">cbReturn</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> -42。</font></font></li></ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">为了“破坏” </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CryptoConfig.CreateFromName</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">方法</font><font style="vertical-align: inherit;">，您必须能够更改</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">_hashNameValue</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">字段的值</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">对我们来说幸运的是，它存在，因为在该字段的类中定义了包装器属性：</font></font><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> HashName { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> _hashNameValue; } <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> { _hashNameValue = <span class="hljs-keyword"><span class="hljs-keyword">value</span></span> ?? DefaultHash; } }</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">通过为</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">HashName</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">设置一个“ synthetic”值</font><font style="vertical-align: inherit;">（更准确地说是</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">_hashNameValue</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">），可以在</font><font style="vertical-align: inherit;">标记的第一个返回点上</font><font style="vertical-align: inherit;">从</font><i><font style="vertical-align: inherit;">CreateFromName</font></i><font style="vertical-align: inherit;">方法</font><font style="vertical-align: inherit;">获得</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">空</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">值</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">我将不讨论解析此方法的细节（希望您对此宽恕），因为它很长。</font><font style="vertical-align: inherit;">结果，将引发类型为</font><i><font style="vertical-align: inherit;">NullReferenceException</font></i><font style="vertical-align: inherit;">的异常的代码</font><font style="vertical-align: inherit;">可能如下所示：</font></font><i><font style="vertical-align: inherit;"></font></i><font style="vertical-align: inherit;"></font><br><br><font style="vertical-align: inherit;"></font><i><font style="vertical-align: inherit;"></font></i><font style="vertical-align: inherit;"></font><br><br><pre> <code class="cs hljs">PKCS1MaskGenerationMethod tempObj = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> PKCS1MaskGenerationMethod(); tempObj.HashName = <span class="hljs-string"><span class="hljs-string">"Dummy"</span></span>; tempObj.GenerateMask(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[] { <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-number"><span class="hljs-number">3</span></span> }, <span class="hljs-number"><span class="hljs-number">42</span></span>);</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 我们将调试库连接到项目，运行它并获得预期的结果： </font></font><br><br><p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/2ab/384/8e5/2ab3848e542172cd92a7e03f55bba9fe.png" alt="图片10"></div><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 为了引起兴趣，我尝试在NuGet软件包4.3.1版上执行相同的代码。 </font></font><br><br><p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/7b4/a94/766/7b4a947666444496ca077e7530415c76.png" alt="图片14"></div><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">docs.microsoft.com上也没有描述有关生成的异常的信息，即输出参数对方法说明的限制-“ </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PKCS1MaskGenerationMethod.GenerateMask（字节[]，Int32）方法</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ”。</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">顺便说一下，在撰写本文和描述问题回放顺序的过程中，我发现了另外两种“破坏”该方法的方法：</font></font><br><br><ul><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">将</font><font style="vertical-align: inherit;">太大的值</font><font style="vertical-align: inherit;">作为参数传递给</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">cbReturn</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ;</font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">通过如</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">rgbSeed</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">值</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">零</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font></li></ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">在第一种情况下，我们获得</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">OutOfMemoryException</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">类型的异常</font><font style="vertical-align: inherit;">。</font></font><br><br><p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/c50/474/7f9/c504747f9a771843da10a128866811dd.png" alt="图片15"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">在第二种情况下，</font><font style="vertical-align: inherit;">当执行</font><i><font style="vertical-align: inherit;">rgbSeed.Length</font></i><font style="vertical-align: inherit;">表达式时</font><font style="vertical-align: inherit;">，我们将获得</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">NullReferenceException</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">类型的异常</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">在这种情况下，</font><i><font style="vertical-align: inherit;">hasher必须</font></i><font style="vertical-align: inherit;">具有非零值</font><font style="vertical-align: inherit;">非常重要</font><font style="vertical-align: inherit;">，否则执行线程将不会达到</font><i><font style="vertical-align: inherit;">rgbSeed.Length</font></i><font style="vertical-align: inherit;">。</font><b><font style="vertical-align: inherit;">第22期</font></b><font style="vertical-align: inherit;">遇到了更多类似的地方。</font></font><i><font style="vertical-align: inherit;"></font></i><font style="vertical-align: inherit;"></font><i><font style="vertical-align: inherit;"></font></i><font style="vertical-align: inherit;"></font><i><font style="vertical-align: inherit;"></font></i><font style="vertical-align: inherit;"></font><br><br> <b><font style="vertical-align: inherit;"></font></b> <br><br><font style="vertical-align: inherit;"></font><br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">SignatureDescription</span></span> { .... <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> FormatterAlgorithm { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> DeformatterAlgorithm { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">SignatureDescription</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { } .... <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">virtual</span></span></span><span class="hljs-function"> AsymmetricSignatureDeformatter </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CreateDeformatter</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"> AsymmetricAlgorithm key</span></span></span><span class="hljs-function">)</span></span> { AsymmetricSignatureDeformatter item = (AsymmetricSignatureDeformatter) CryptoConfig.CreateFromName(DeformatterAlgorithm); item.SetKey(key); <span class="hljs-comment"><span class="hljs-comment">// &lt;= return item; } public virtual AsymmetricSignatureFormatter CreateFormatter( AsymmetricAlgorithm key) { AsymmetricSignatureFormatter item = (AsymmetricSignatureFormatter) CryptoConfig.CreateFromName(FormatterAlgorithm); item.SetKey(key); // &lt;= return item; } .... }</span></span></code> </pre> <br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PVS-Studio警告</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：</font></font><br><br><ul><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">V3080</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">可能为空的取消引用。</font><font style="vertical-align: inherit;">考虑检查“项目”。</font><font style="vertical-align: inherit;">SignatureDescription.cs 31</font></font></li><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">V3080</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">可能为空的取消引用。</font><font style="vertical-align: inherit;">考虑检查“项目”。</font><font style="vertical-align: inherit;">签名说明.cs 38</font></font></li></ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">同样，我们可以将</font><font style="vertical-align: inherit;">值</font><font style="vertical-align: inherit;">写入</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">FormatterAlgorithm</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">和</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DeformatterAlgorithm</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">属性</font><font style="vertical-align: inherit;">，对于</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CryptoConfig.CreateFromName</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">方法</font><font style="vertical-align: inherit;">，在</font><i><font style="vertical-align: inherit;">CreateDeformatter</font></i><font style="vertical-align: inherit;">和</font><i><font style="vertical-align: inherit;">CreateFormatter</font></i><font style="vertical-align: inherit;">方法中</font><font style="vertical-align: inherit;">，该</font><font style="vertical-align: inherit;">属性</font><font style="vertical-align: inherit;">将返回</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">null</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。接下来，当调用实例方法</font><i><font style="vertical-align: inherit;">SetKey时，</font></i><font style="vertical-align: inherit;">将</font><i><font style="vertical-align: inherit;">抛出</font></i><i><font style="vertical-align: inherit;">NullReferenceException</font></i><font style="vertical-align: inherit;">。同样，该问题在实践中很容易重现：</font></font><i><font style="vertical-align: inherit;"></font></i><font style="vertical-align: inherit;"></font><i><font style="vertical-align: inherit;"></font></i><font style="vertical-align: inherit;"></font><i><font style="vertical-align: inherit;"></font></i><font style="vertical-align: inherit;"></font><i><font style="vertical-align: inherit;"></font></i><font style="vertical-align: inherit;"></font><br><br><pre> <code class="cs hljs">SignatureDescription signature = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SignatureDescription() { DeformatterAlgorithm = <span class="hljs-string"><span class="hljs-string">"Dummy"</span></span>, FormatterAlgorithm = <span class="hljs-string"><span class="hljs-string">"Dummy"</span></span> }; signature.CreateDeformatter(<span class="hljs-literal"><span class="hljs-literal">null</span></span>); <span class="hljs-comment"><span class="hljs-comment">// NRE signature.CreateFormatter(null); // NRE</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">在这种情况下，当调用</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CreateDeformatter</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">和调用</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CreateFormatter时，</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">将抛出</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">NullReferenceException</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">类型</font><i><font style="vertical-align: inherit;">的异常</font></i><font style="vertical-align: inherit;">。</font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第23期</font></font></b> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">让我们看一下</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">System.Private.Xml</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">项目中有趣的地方</font><font style="vertical-align: inherit;">。</font></font><br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">WriteBase64</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">byte</span></span></span></span><span class="hljs-function"><span class="hljs-params">[] buffer, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> index, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> count</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!_inAttr &amp;&amp; (_inCDataSection || StartCDataSection())) _wrapped.WriteBase64(buffer, index, count); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> _wrapped.WriteBase64(buffer, index, count); }</code> </pre> <br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PVS-Studio警告</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">V3004'then</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> '语句等效于'else'语句。</font><font style="vertical-align: inherit;">QueryOutputWriterV1.cs 242 </font><i><font style="vertical-align: inherit;">if语句</font></i></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">的</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">then</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">和</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">else</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">分支</font><font style="vertical-align: inherit;">包含相同的代码</font><font style="vertical-align: inherit;">看起来很奇怪</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">可能是一个错误，并且其中一个分支应该执行其他操作，或者</font><font style="vertical-align: inherit;">可以省略</font><i><font style="vertical-align: inherit;">if语句</font></i><font style="vertical-align: inherit;">。</font><b><font style="vertical-align: inherit;">第24期</font></b></font><i><font style="vertical-align: inherit;"></font></i><font style="vertical-align: inherit;"></font><i><font style="vertical-align: inherit;"></font></i><font style="vertical-align: inherit;"></font><br><br> <b><font style="vertical-align: inherit;"></font></b> <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">internal</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Depends</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">XmlSchemaObject item, ArrayList refs</span></span></span><span class="hljs-function">)</span></span> { .... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (content <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> XmlSchemaSimpleTypeRestriction) { baseType = ((XmlSchemaSimpleTypeRestriction)content).BaseType; baseName = ((XmlSchemaSimpleTypeRestriction)content).BaseTypeName; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (content <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> XmlSchemaSimpleTypeList) { .... } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (content <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> XmlSchemaSimpleTypeRestriction) { baseName = ((XmlSchemaSimpleTypeRestriction)content).BaseTypeName; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (t == <span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(XmlSchemaSimpleTypeUnion)) { .... } .... }</code> </pre> <br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PVS-Studio </font></font></b><font style="vertical-align: inherit;"></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">警告</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;">V3003检测到</font></a><font style="vertical-align: inherit;">使用'if（A）{...} else if（A）{...}'模式。</font><font style="vertical-align: inherit;">存在逻辑错误的可能性。</font><font style="vertical-align: inherit;">检查行：381，396。ImportContext.cs 381 </font><i><font style="vertical-align: inherit;">if-else-if</font></i></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">序列</font><font style="vertical-align: inherit;">具有两个相同的条件表达式- </font><i><font style="vertical-align: inherit;">内容为XmlSchemaSimpleTypeRestriction</font></i><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">更有趣的是，</font><font style="vertical-align: inherit;">相应运算符的</font><i><font style="vertical-align: inherit;">then</font></i><font style="vertical-align: inherit;">分支主体包含一组不同的表达式。</font><font style="vertical-align: inherit;">一种或另一种方式，将执行第一个对应的</font><i><font style="vertical-align: inherit;">then</font></i><font style="vertical-align: inherit;">分支</font><font style="vertical-align: inherit;">的主体</font><font style="vertical-align: inherit;">（如果条件表达式为true），或者如果对应的表达式为false，</font><i><font style="vertical-align: inherit;">则不</font></i><font style="vertical-align: inherit;">执行</font><font style="vertical-align: inherit;">任何操作。</font><b><font style="vertical-align: inherit;">第25期</font></b></font><i><font style="vertical-align: inherit;"></font></i><font style="vertical-align: inherit;"></font><i><font style="vertical-align: inherit;"></font></i><font style="vertical-align: inherit;"></font><i><font style="vertical-align: inherit;"></font></i><font style="vertical-align: inherit;"></font><i><font style="vertical-align: inherit;"></font></i><font style="vertical-align: inherit;"></font><br><br> <b><font style="vertical-align: inherit;"></font></b> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 为了使在以下方法中查找错误更加有趣，我将他的整个身体带了起来。 </font></font><br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">MatchesXmlType</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">IList&lt;XPathItem&gt; seq, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> indexType</span></span></span><span class="hljs-function">)</span></span> { XmlQueryType typBase = GetXmlType(indexType); XmlQueryCardinality card; <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> (seq.Count) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>: card = XmlQueryCardinality.Zero; <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>: card = XmlQueryCardinality.One; <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">default</span></span>: card = XmlQueryCardinality.More; <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!(card &lt;= typBase.Cardinality)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; typBase = typBase.Prime; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; seq.Count; i++) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!CreateXmlType(seq[<span class="hljs-number"><span class="hljs-number">0</span></span>]).IsSubtypeOf(typBase)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>; }</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">如果您做到了，那就恭喜！</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">如果不是，PVS-Studio警告将帮助您：</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">V3102</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">通过循环内的常量索引可疑访问“ seq”对象的元素。 XmlQueryRuntime.cs 738 </font><font style="vertical-align: inherit;">使用表达式</font><i><font style="vertical-align: inherit;">i &lt;seq.Count</font></i><font style="vertical-align: inherit;">作为退出条件，</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">执行</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">for</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">循环</font><font style="vertical-align: inherit;">。建议他们要绕过</font><i><font style="vertical-align: inherit;">seq</font></i><font style="vertical-align: inherit;">的序列</font><font style="vertical-align: inherit;">。仅在循环中，它们不使用计数器（</font><i><font style="vertical-align: inherit;">seq [i]</font></i><font style="vertical-align: inherit;">）而是使用数字文字-零（</font><i><font style="vertical-align: inherit;">seq [0]</font></i><font style="vertical-align: inherit;">）</font><font style="vertical-align: inherit;">访问序列的元素</font><font style="vertical-align: inherit;">。</font><b><font style="vertical-align: inherit;">问题26</font></b><font style="vertical-align: inherit;">下面的错误仅适用于一小段代码，但因此也很有趣。</font></font><i><font style="vertical-align: inherit;"></font></i><font style="vertical-align: inherit;"></font><i><font style="vertical-align: inherit;"></font></i><font style="vertical-align: inherit;"></font><i><font style="vertical-align: inherit;"></font></i><font style="vertical-align: inherit;"></font><i><font style="vertical-align: inherit;"></font></i><font style="vertical-align: inherit;"></font><br><br> <b><font style="vertical-align: inherit;"></font></b> <br><br><font style="vertical-align: inherit;"></font><br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">WriteValue</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">value</span></span></span></span></span><span class="hljs-function">)</span></span> { WriteValue(<span class="hljs-keyword"><span class="hljs-keyword">value</span></span>); }</code> </pre> <br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">警告工作室PVS的</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">V3110</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">的可能无限递归内“WriteValue”的方法。 XmlAttributeCache.cs 166 </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">该方法调用自身，从而形成没有退出条件的递归。</font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第27期</font></font></b> <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> IList&lt;XPathNavigator&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">DocOrderDistinct</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">IList&lt;XPathNavigator&gt; seq</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (seq.Count &lt;= <span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> seq; XmlQueryNodeSequence nodeSeq = (XmlQueryNodeSequence)seq; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (nodeSeq == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) nodeSeq = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> XmlQueryNodeSequence(seq); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> nodeSeq.DocOrderDistinct(_docOrderCmp); }</code> </pre> <br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PVS-Studio警告</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">V3095</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">在对null进行验证之前，已使用'seq'对象。检查行：880、884。XmlQueryRuntime.cs 880 </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">作为参数，该方法可能会</font><font style="vertical-align: inherit;">收到</font><font style="vertical-align: inherit;">一个</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">空</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">值</font><font style="vertical-align: inherit;">，这就是为什么在调用</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Count</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">属性时</font><font style="vertical-align: inherit;">会</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">抛出NullReferenceException</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">类型的</font><i><font style="vertical-align: inherit;">异常的原因</font></i><font style="vertical-align: inherit;">。下面我们检查</font><font style="vertical-align: inherit;">由于显式转换</font><i><font style="vertical-align: inherit;">seq</font></i><font style="vertical-align: inherit;">而</font><font style="vertical-align: inherit;">获得</font><font style="vertical-align: inherit;">的</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">nodeSeq</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">变量</font><font style="vertical-align: inherit;">，但是为什么不很清楚。如果</font><i><font style="vertical-align: inherit;">seq</font></i><font style="vertical-align: inherit;">为</font><i><font style="vertical-align: inherit;">null</font></i><font style="vertical-align: inherit;">，则由于异常，线程将无法进行此检查。如果</font><i><font style="vertical-align: inherit;">seq</font></i><font style="vertical-align: inherit;">的值</font><font style="vertical-align: inherit;">不为</font><i><font style="vertical-align: inherit;">null</font></i><font style="vertical-align: inherit;">，则：</font></font><i><font style="vertical-align: inherit;"></font></i><font style="vertical-align: inherit;"></font><i><font style="vertical-align: inherit;"></font></i><font style="vertical-align: inherit;"></font><i><font style="vertical-align: inherit;"></font></i><font style="vertical-align: inherit;"></font><i><font style="vertical-align: inherit;"></font></i><font style="vertical-align: inherit;"></font><i><font style="vertical-align: inherit;"></font></i><font style="vertical-align: inherit;"></font><br><br><ul><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">如果</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">强制</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">类型</font><i><font style="vertical-align: inherit;">转换</font></i><font style="vertical-align: inherit;">失败，</font><font style="vertical-align: inherit;">将</font><i><font style="vertical-align: inherit;">抛出InvalidCastException</font></i><font style="vertical-align: inherit;">类型的异常</font><font style="vertical-align: inherit;">；</font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">如果</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">强制转换</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">成功，则</font><i><font style="vertical-align: inherit;">nodeSeq</font></i><font style="vertical-align: inherit;">肯定具有非</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">null的值</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font></li></ul><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第28期</font></font></b> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">遇到了4个没有使用参数的设计器。</font><font style="vertical-align: inherit;">可能出于兼容性考虑而保留它们，但我尚未找到有关这些未使用参数的任何注释。</font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PVS-Studio警告</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：</font></font><br><br><ul><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">V3117</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">未使用构造函数参数“ securityUrl”。</font><font style="vertical-align: inherit;">XmlSecureResolver.cs 15</font></font></li><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">V3117</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">未使用构造函数参数“ strdata”。</font><font style="vertical-align: inherit;">XmlEntity.cs 18</font></font></li><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">V3117</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">不使用构造函数参数“位置”。</font><font style="vertical-align: inherit;">编译.cs 58</font></font></li><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">V3117</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">不使用构造函数参数“ access”。</font><font style="vertical-align: inherit;">XmlSerializationILGen.cs 38</font></font></li></ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 我对第一个感兴趣（至少我将它写到了这篇文章的警告列表中）。 </font></font>什么啊<font style="vertical-align: inherit;"><font style="vertical-align: inherit;">不知道 </font><font style="vertical-align: inherit;">也许是名字。</font></font><br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">XmlSecureResolver</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">XmlResolver resolver, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> securityUrl</span></span></span><span class="hljs-function">)</span></span> { _resolver = resolver; }</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">为了感兴趣，我去看看他们在docs.microsoft.com上写的关于</font><i><font style="vertical-align: inherit;">securityUrl</font></i><font style="vertical-align: inherit;">参数的</font><font style="vertical-align: inherit;">“ </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">XmlSecureResolver构造函数</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ” </font><font style="vertical-align: inherit;">：</font><i><font style="vertical-align: inherit;">用于创建将应用于基础XmlResolver的PermissionSet的URL。 XmlSecureResolver在基础XmlResolver上调用GetEntity（Uri，String，Type）之前，在创建的PermissionSet上调用PermitOnly（）。</font></i><b><font style="vertical-align: inherit;">问题29</font></b><font style="vertical-align: inherit;">在</font><i><font style="vertical-align: inherit;">System.Private.Uri</font></i><font style="vertical-align: inherit;">程序包中</font><i><font style="vertical-align: inherit;">，</font></i><font style="vertical-align: inherit;">我发现一种方法与Microsoft重写</font><i><font style="vertical-align: inherit;">ToString</font></i><font style="vertical-align: inherit;">方法的准则几乎没有冲突</font><font style="vertical-align: inherit;">。回忆一下</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;">Object.ToString方法</font></a><font style="vertical-align: inherit;">页面上的提示之一</font><font style="vertical-align: inherit;">：</font><b><i><font style="vertical-align: inherit;">您的ToString（）重写不应引发异常</font></i></b><i><font style="vertical-align: inherit;">。</font></i></font><i><font style="vertical-align: inherit;"></font></i><font style="vertical-align: inherit;"></font><br><br> <i><font style="vertical-align: inherit;"></font></i> <br><br> <b><font style="vertical-align: inherit;"></font></b> <br><br><font style="vertical-align: inherit;"></font><i><font style="vertical-align: inherit;"></font></i><font style="vertical-align: inherit;"></font><i><font style="vertical-align: inherit;"></font></i><font style="vertical-align: inherit;"></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"></font><b><i><font style="vertical-align: inherit;"></font></i></b> <i><font style="vertical-align: inherit;"></font></i> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 被覆盖的方法本身看起来像这样： </font></font><br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">string</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ToString</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (_username.Length == <span class="hljs-number"><span class="hljs-number">0</span></span> &amp;&amp; _password.Length &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> UriFormatException(SR.net_uri_BadUserPassword); } .... }</code> </pre> <br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PVS-Studio警告</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">V3108</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">不建议从“ ToSting（）”方法引发异常。</font><font style="vertical-align: inherit;">UriBuilder.cs 406 </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">通过公共属性</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">UserName</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">和</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Password</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">分别</font><font style="vertical-align: inherit;">为</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">_username</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">字段</font><font style="vertical-align: inherit;">设置</font><font style="vertical-align: inherit;">空字符串和</font><i><font style="vertical-align: inherit;">_password</font></i><font style="vertical-align: inherit;">字段</font><font style="vertical-align: inherit;">设置非</font><font style="vertical-align: inherit;">空行</font><font style="vertical-align: inherit;">，然后</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">调用</font></font></i><font style="vertical-align: inherit;"></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ToString</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">方法的代码</font><font style="vertical-align: inherit;">将获得异常。</font><font style="vertical-align: inherit;">此类代码的示例：</font></font><br><br><pre> <code class="cs hljs">UriBuilder uriBuilder = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> UriBuilder() { UserName = String.Empty, Password = <span class="hljs-string"><span class="hljs-string">"Dummy"</span></span> }; String stringRepresentation = uriBuilder.ToString(); Console.WriteLine(stringRepresentation);</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">但是在这种情况下，开发人员会诚实地警告称，在调用时可能会引发异常-在方法和docs.microsoft.com的注释“ </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">UriBuilder.ToString方法</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ” </font><font style="vertical-align: inherit;">中均对此进行了描述</font><font style="vertical-align: inherit;">。</font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第30期</font></font></b> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">看一下在</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">System.Data.Common</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">项目代码上发出的​​警告</font><font style="vertical-align: inherit;">。</font></font><br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> ArrayList _tables; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> DataTable </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetTable</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> tableName, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> ns</span></span></span><span class="hljs-function">)</span></span> { .... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (_tables.Count == <span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (DataTable)_tables[<span class="hljs-number"><span class="hljs-number">0</span></span>]; .... }</code> </pre> <br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PVS-Studio警告</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">V3106</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">可能索引超出范围。</font><font style="vertical-align: inherit;">索引“ 0”指向“ _tables”界限之外。</font><font style="vertical-align: inherit;">XMLDiffLoader.cs 277 </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">这段代码看起来异常吗？</font><font style="vertical-align: inherit;">您认为这是什么？</font><font style="vertical-align: inherit;">想办法抛出</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ArgumentOutOfRangeException</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">类型的异常</font><font style="vertical-align: inherit;">吗？</font><font style="vertical-align: inherit;">我可能不会对此方法感到惊讶。</font><font style="vertical-align: inherit;">通常，该代码是奇怪且可疑的。</font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第31期</font></font></b> <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">internal</span></span></span><span class="hljs-function"> XmlNodeOrder </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ComparePosition</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">XPathNodePointer other</span></span></span><span class="hljs-function">)</span></span> { RealFoliate(); other.RealFoliate(); Debug.Assert(other != <span class="hljs-literal"><span class="hljs-literal">null</span></span>); .... }</code> </pre> <br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PVS-Studio警告</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">V3095</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">在对null进行验证之前，已使用“其他”对象。检查线路：1095，1096 XPathNodePointer.cs 1095 </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">表达</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">其他！= NULL</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">作为参数</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Debug.Assert的</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">明确暗示，作为参数</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ComparePosition</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">可以得到的值</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">无效</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。至少，他们想抓住这种情况。但同时，</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">另一</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">行上方的行</font><font style="vertical-align: inherit;">调用实例方法</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">RealFoliate</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。结果，如果</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">other</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">为</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">null</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，则将</font><i><font style="vertical-align: inherit;">抛出NullReferenceException</font></i><font style="vertical-align: inherit;">类型的</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">异常。</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">在通过</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Assert</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">检查之前</font><font style="vertical-align: inherit;">。</font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第32期</font></font></b> <br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> PropertyDescriptorCollection </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetProperties</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Attribute[] attributes</span></span></span><span class="hljs-function">)</span></span> { .... <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (Attribute attribute <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> attributes) { Attribute attr = property.Attributes[attribute.GetType()]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( (attr == <span class="hljs-literal"><span class="hljs-literal">null</span></span> &amp;&amp; !attribute.IsDefaultAttribute()) || !attr.Match(attribute)) { match = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } } .... }</code> </pre> <br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PVS-Studio警告</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">V3080</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">可能取消空引用。</font><font style="vertical-align: inherit;">考虑检查“ attr”。</font><font style="vertical-align: inherit;">DbConnectionStringBuilder.cs 534 </font><i><font style="vertical-align: inherit;">if语句</font></i><font style="vertical-align: inherit;">的</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">条件表达式</font><font style="vertical-align: inherit;">看起来有点可疑。</font><i><font style="vertical-align: inherit;">Match</font></i><font style="vertical-align: inherit;">是一个实例方法。</font><font style="vertical-align: inherit;">通过检查</font><i><font style="vertical-align: inherit;">attr == null来</font></i><font style="vertical-align: inherit;">判断</font><font style="vertical-align: inherit;">，</font><i><font style="vertical-align: inherit;">null</font></i><font style="vertical-align: inherit;">是此变量的有效（预期）值。</font><font style="vertical-align: inherit;">因此，如果执行线程到达了运算符||的右操作数。</font><font style="vertical-align: inherit;">如果</font><i><font style="vertical-align: inherit;">attr</font></i><font style="vertical-align: inherit;">为</font><i><font style="vertical-align: inherit;">null</font></i><font style="vertical-align: inherit;">，我们将获得</font><i><font style="vertical-align: inherit;">NullReferenceException</font></i><font style="vertical-align: inherit;">类型的异常</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">因此，例外情况如下：</font></font><i><font style="vertical-align: inherit;"></font></i><font style="vertical-align: inherit;"></font><i><font style="vertical-align: inherit;"></font></i><font style="vertical-align: inherit;"></font><i><font style="vertical-align: inherit;"></font></i><font style="vertical-align: inherit;"></font><i><font style="vertical-align: inherit;"></font></i><font style="vertical-align: inherit;"></font><i><font style="vertical-align: inherit;"></font></i><font style="vertical-align: inherit;"></font><i><font style="vertical-align: inherit;"></font></i><font style="vertical-align: inherit;"></font><i><font style="vertical-align: inherit;"></font></i><font style="vertical-align: inherit;"></font><br><br><font style="vertical-align: inherit;"></font><br><br><ol><li>  <i>attr</i> — <i>null</i> .     &amp;&amp;. </li><li>  <i>!attribute.IsDefaultAttribute()</i> — <i>false</i> .      &amp;&amp; — <i>false</i> . </li><li>      ||   <i>false</i> ,   . </li><li>   <i>attr</i> — <i>null</i> ,    <i>Match</i>  . </li></ol><br> <b>Issue 33</b> <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ReadOldRowData</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"> DataSet ds, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">ref</span></span></span></span><span class="hljs-function"><span class="hljs-params"> DataTable table, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">ref</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> pos, XmlReader row</span></span></span><span class="hljs-function">)</span></span> { .... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (table == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { row.Skip(); <span class="hljs-comment"><span class="hljs-comment">// need to skip this element if we dont know about it, // before returning -1 return -1; } .... if (table == null) throw ExceptionBuilder.DiffgramMissingTable( XmlConvert.DecodeName(row.LocalName)); .... }</span></span></code> </pre> <br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PVS-Studio警告</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">V3021</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">有两个带有相同条件表达式的'if'语句。第一个'if'语句包含方法return。这意味着第二个“ if”语句是毫无意义的XMLDiffLoader.cs301。</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">有两个</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">if语句</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">包含相同的条件表达式</font><font style="vertical-align: inherit;">-table </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">== null</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。此外，这些运算符的分支包含不同的动作-在一种情况下，该方法以值-1退出，在第二种情况下，引发异常。在两次检查之间，</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">表</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">变量</font><font style="vertical-align: inherit;">不会更改。因此，不会抛出有问题的异常。</font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第34期</font></font></b> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">看一下</font><i><font style="vertical-align: inherit;">System.ComponentModel.TypeConverter</font></i><font style="vertical-align: inherit;">项目中的一个有趣方法</font></font><i><font style="vertical-align: inherit;"></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。更准确地说，首先看一下描述它的注释：</font></font><br><br> <i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">从格式化的字符串中删除最后一个字符。 （删除虚拟字符串中的最后一个字符）。退出时，out参数包含实际执行操作的位置。此位置相对于测试字符串。 MaskedTextResultHint输出参数可提供有关操作结果的更多信息。</font></font></i> <font style="vertical-align: inherit;"><i><font style="vertical-align: inherit;">成功</font></i><i><font style="vertical-align: inherit;">返回</font></i></font><b><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">true</font></font></i></b> <i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，</font></font></i> <font style="vertical-align: inherit;"><i><font style="vertical-align: inherit;">否则</font></i><i><font style="vertical-align: inherit;">返回</font></i></font><b><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">false</font></font></i></b> <i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font></i> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">返回值的关键：如果操作成功，则该方法返回</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">true</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，否则</font><font style="vertical-align: inherit;">返回</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">false</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。让我们看看实际上发生了什么。</font></font><br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Remove</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">out</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> testPosition, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">out</span></span></span></span><span class="hljs-function"><span class="hljs-params"> MaskedTextResultHint resultHint</span></span></span><span class="hljs-function">)</span></span> { .... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (lastAssignedPos == INVALID_INDEX) { .... <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>; <span class="hljs-comment"><span class="hljs-comment">// nothing to remove. } .... return true; }</span></span></code> </pre> <br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PVS-Studio警告</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">V3009</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">奇怪的是，此方法始终返回一个相同的“ true”值。 MaskedTextProvider.cs 1529 </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">实际上，事实证明该方法的唯一返回值为</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">true</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第35期</font></font></b> <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Clear</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (_table != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { .... } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (_table.fInitInProgress &amp;&amp; _delayLoadingConstraints != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { .... } .... }</code> </pre> <br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PVS-Studio警告</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">V3125</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">在验证为空后使用了'_table'对象。检查行：437，423. ConstraintCollection.cs 437 </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">检查</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">_table！= Null</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">代表自己</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-_table</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">变量</font><font style="vertical-align: inherit;">可以为</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">null</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。至少在这种情况下，需要重新保险。但是，它们下面通过</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">_table</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">访问实例字段，</font><font style="vertical-align: inherit;">而不检查</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">null</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">_table .fInitInProgress</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第36期</font></font></b> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">现在，让我们看看在</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">System.Runtime.Serialization.Formatters</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">项目的项目代码上发出的​​一些警告</font><font style="vertical-align: inherit;">。</font></font><br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Write</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">....</span></span></span><span class="hljs-function">)</span></span> { .... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (memberNameInfo != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { .... _serWriter.WriteObjectEnd(memberNameInfo, typeNameInfo); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((objectInfo._objectId == _topId) &amp;&amp; (_topName != <span class="hljs-literal"><span class="hljs-literal">null</span></span>)) { _serWriter.WriteObjectEnd(topNameInfo, typeNameInfo); .... } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!ReferenceEquals(objectInfo._objectType, Converter.s_typeofString)) { _serWriter.WriteObjectEnd(typeNameInfo, typeNameInfo); } }</code> </pre> <br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PVS-Studio警告</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">V3038</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">参数多次传递给方法。</font><font style="vertical-align: inherit;">可能应改为传递其他参数。</font><font style="vertical-align: inherit;">BinaryObjectWriter.cs 262 </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">分析仪不好意思最后一次通话</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">_serWriter.WriteObjectEnd</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">有两个相同的参数- </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">typeNameInfo</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">这似乎是一个错字，但肯定不能说。</font><font style="vertical-align: inherit;">我决定看看所谓的</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">WriteObjectEnd</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">方法</font><i><font style="vertical-align: inherit;">是</font></i><font style="vertical-align: inherit;">什么</font><font style="vertical-align: inherit;">。</font></font><br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">internal</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">WriteObjectEnd</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">NameInfo memberNameInfo, NameInfo typeNameInfo</span></span></span><span class="hljs-function">)</span></span> { }</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 好吧...继续前进。 </font></font> :) <br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第37期</font></font></b> <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">internal</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">WriteSerializationHeader</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> topId, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> headerId, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> minorVersion, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> majorVersion</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> record = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SerializationHeaderRecord( BinaryHeaderEnum.SerializedStreamHeader, topId, headerId, minorVersion, majorVersion); record.Write(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>); }</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">查看此代码，您不会立即在这里说错或看起来可疑。但是分析仪可能会说它已经警告了他。</font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">警告PVS-Studio</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">V3066</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">传递给'SerializationHeaderRecord'构造函数的参数的可能错误顺序：'minorVersion'和'majorVersion'。 BinaryFormatterWriter.cs 111 </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">让我们看一下被称为的</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SerializationHeaderRecord</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">类的构造函数</font><font style="vertical-align: inherit;">。</font></font><br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">internal</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">SerializationHeaderRecord</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"> BinaryHeaderEnum binaryHeaderEnum, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> topId, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> headerId, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> majorVersion, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> minorVersion</span></span></span><span class="hljs-function">)</span></span> { _binaryHeaderEnum = binaryHeaderEnum; _topId = topId; _headerId = headerId; _majorVersion = majorVersion; _minorVersion = minorVersion; }</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">如您所见，构造函数参数的顺序为</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">majorVersion</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">minorVersion</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">；调用构造函数时，它们以</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">minorVersion</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">majorVersion</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">的顺序传输</font><font style="vertical-align: inherit;">。听起来像错字。如果这是计划的（突然之间？）-我认为应该留下解释性意见。</font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第38期</font></font></b> <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">internal</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ObjectManager</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"> ISurrogateSelector selector, StreamingContext context, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">bool</span></span></span></span><span class="hljs-function"><span class="hljs-params"> checkSecurity, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">bool</span></span></span></span><span class="hljs-function"><span class="hljs-params"> isCrossAppDomain</span></span></span><span class="hljs-function">)</span></span> { _objects = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ObjectHolder[DefaultInitialSize]; _selector = selector; _context = context; _isCrossAppDomain = isCrossAppDomain; }</code> </pre> <br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PVS-Studio警告</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">V3117</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">未使用构造函数参数'checkSecurity'。</font><font style="vertical-align: inherit;">ObjectManager.cs 33 </font><font style="vertical-align: inherit;">不会以任何方式使用</font><i><font style="vertical-align: inherit;">checkSecurity</font></i></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">的构造函数参数</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">尚无评论。</font><font style="vertical-align: inherit;">我将假定它是为了兼容而保留的，但是在最近几年有关安全性的讨论中，这看起来还是很有趣的。</font><b><font style="vertical-align: inherit;">第39期</font></b><font style="vertical-align: inherit;">遇到了另一个代码，这对我来说似乎很不寻常。</font><font style="vertical-align: inherit;">在检测到的所有三种情况下，该模式看起来都是1比1，并且在具有相同名称和变量名称的方法中找到。</font><font style="vertical-align: inherit;">因此：</font></font><i><font style="vertical-align: inherit;"></font></i><font style="vertical-align: inherit;"></font><br><br> <b><font style="vertical-align: inherit;"></font></b> <br><br><font style="vertical-align: inherit;"></font><br><br><ul><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 我要么没有足够的开悟，也不了解这种重复的含义； </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 使用复制粘贴方法通过代码传播的错误。 </font></font></li></ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 代码本身： </font></font><br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">EnlargeArray</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> newLength = _values.Length * <span class="hljs-number"><span class="hljs-number">2</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (newLength &lt; <span class="hljs-number"><span class="hljs-number">0</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (newLength == <span class="hljs-keyword"><span class="hljs-keyword">int</span></span>.MaxValue) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SerializationException(SR.Serialization_TooManyElements); } newLength = <span class="hljs-keyword"><span class="hljs-keyword">int</span></span>.MaxValue; } FixupHolder[] temp = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> FixupHolder[newLength]; Array.Copy(_values, <span class="hljs-number"><span class="hljs-number">0</span></span>, temp, <span class="hljs-number"><span class="hljs-number">0</span></span>, _count); _values = temp; }</code> </pre> <br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PVS-Studio警告</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：</font></font><br><br><ul><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">V3022</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">表达式'newLength == int.MaxValue'始终为false。</font><font style="vertical-align: inherit;">ObjectManager.cs 1423</font></font></li><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">V3022</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">表达式'newLength == int.MaxValue'始终为false。</font><font style="vertical-align: inherit;">ObjectManager.cs 1511</font></font></li><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">V3022</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">表达式'newLength == int.MaxValue'始终为false。</font><font style="vertical-align: inherit;">对象管理器.cs 1558</font></font></li></ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">其他方法的不同之处在于</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">临时</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">数组的元素类型</font><font style="vertical-align: inherit;">（不是</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">FixupHolder</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，而是</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">long</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">或</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">object</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）。</font><font style="vertical-align: inherit;">所以我仍然对复制粘贴有所怀疑... </font><i><font style="vertical-align: inherit;">System.Data.Odbc</font></i><font style="vertical-align: inherit;">项目中的</font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第40版</font></font></b> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">代码</font><font style="vertical-align: inherit;">。</font></font><i><font style="vertical-align: inherit;"></font></i><font style="vertical-align: inherit;"></font><br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">string</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">UnquoteIdentifier</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">....</span></span></span><span class="hljs-function">)</span></span> { .... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.IsNullOrEmpty(quotePrefix) || quotePrefix != <span class="hljs-string"><span class="hljs-string">" "</span></span>) { .... } .... }</code> </pre> <br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PVS-Studio警告</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">V3022</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">表达式'！String.IsNullOrEmpty（quotePrefix）|| quotePrefix！=“”'始终为true。 OdbcCommandBuilder.cs 338 </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">分析器认为上述表达式始终为</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">true</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。确实是。</font><font style="vertical-align: inherit;">实际上，</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">quotePrefix</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">包含什么值都没有关系</font><font style="vertical-align: inherit;">-条件本身的写法不正确。让我们做对。</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">我们有运营商||，因此，表达式的值是</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">真</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，如果左边或右边（或两者）将操作数</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">真</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。左边的一切都很清楚。仅当左侧操作数为</font><i><font style="vertical-align: inherit;">false时</font></i><font style="vertical-align: inherit;">，才对右侧操作数进行求值</font></font><i><font style="vertical-align: inherit;"></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">因此，如果表达式的组成使得右操作数的值始终为</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">true</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，则当左值的值为</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">false时</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，整个表达式的结果将始终为</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">true</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">从上面的代码中我们知道，如果计算出正确的操作数，则</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">字符串</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">的值</font><i><font style="vertical-align: inherit;">。IsNullOrEmpty（quotePrefix）</font></i><font style="vertical-align: inherit;">表达式</font><font style="vertical-align: inherit;">为</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">true</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，因此，其中一条语句</font><font style="vertical-align: inherit;">为</font><i><font style="vertical-align: inherit;">true</font></i><font style="vertical-align: inherit;">：</font></font><br><br><ul><li> <i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">quotePrefix == null</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ;</font></font></li><li> <i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">quotePrefix.Length == 0</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font></li></ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">如果这些语句中的任何一个为true，则表达式</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">quotePrefix！=“”</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">也将为true </font><font style="vertical-align: inherit;">，我们想证明这一点。因此，</font><font style="vertical-align: inherit;">无论</font><i><font style="vertical-align: inherit;">quotePrefix</font></i><font style="vertical-align: inherit;">的内容如何，</font><font style="vertical-align: inherit;">整个表达式的值始终为</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">true</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><b><font style="vertical-align: inherit;">第41期</font></b><font style="vertical-align: inherit;">返回有关带有未使用参数的构造函数的讨论：</font></font><i><font style="vertical-align: inherit;"></font></i><font style="vertical-align: inherit;"></font><br><br> <b><font style="vertical-align: inherit;"></font></b> <br><br><font style="vertical-align: inherit;"></font><br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">sealed</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">PendingGetConnection</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">PendingGetConnection</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">long</span></span></span></span><span class="hljs-function"><span class="hljs-params"> dueTime, DbConnection owner, TaskCompletionSource&lt;DbConnectionInternal&gt; completion, DbConnectionOptions userOptions</span></span></span><span class="hljs-function">)</span></span> { DueTime = dueTime; Owner = owner; Completion = completion; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> DueTime { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> DbConnection Owner { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> TaskCompletionSource&lt;DbConnectionInternal&gt; Completion { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> DbConnectionOptions UserOptions { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } }</code> </pre> <br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PVS-Studio </font></font></b><font style="vertical-align: inherit;"></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">警告</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;">V3117</font></a><font style="vertical-align: inherit;">未使用构造函数参数“ userOptions”。</font><font style="vertical-align: inherit;">DbConnectionPool.cs 26 </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">从分析器代码和警告中可以明显看出，仅使用了一个构造函数参数— </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">userOptions</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，而其他</font><font style="vertical-align: inherit;">参数</font><font style="vertical-align: inherit;">用于初始化相同名称的属性。</font><font style="vertical-align: inherit;">好像他们忘记了初始化属性之一。</font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">问题42</font></font></b> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">在此项目中有两次遇到可疑代码。</font><font style="vertical-align: inherit;">模式是相同的。</font></font><br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> DataTable </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ExecuteCommand</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">....</span></span></span><span class="hljs-function">)</span></span> { .... <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (DataRow row <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> schemaTable.Rows) { resultTable.Columns .Add(row[<span class="hljs-string"><span class="hljs-string">"ColumnName"</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>, (Type)row[<span class="hljs-string"><span class="hljs-string">"DataType"</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> Type); } .... }</code> </pre> <br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PVS-Studio警告</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：</font></font><br><br><ul><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">V3051</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">类型</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;">转换</font></a><font style="vertical-align: inherit;">过多。</font><font style="vertical-align: inherit;">该对象已经是“类型”类型。</font><font style="vertical-align: inherit;">dbMetaDataFactory.cs 176</font></font></li><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">V3051</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">类型</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;">转换</font></a><font style="vertical-align: inherit;">过多。</font><font style="vertical-align: inherit;">该对象已经是“类型”类型。</font><font style="vertical-align: inherit;">OdbcMetaDataFactory.cs 1109</font></font></li></ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">作为</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Type</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">的表达式</font><i><font style="vertical-align: inherit;">（Type）行[“ DataType”]</font></i><font style="vertical-align: inherit;">看起来可疑</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">首先将执行显式转换，然后通过</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">as</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">运算符进行转换</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">如果</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">row [“ DataType”]的</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">值为</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">null</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，则它将成功通过两个强制转换，并作为</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Add</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">方法的参数</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">如果</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">row [“ DataType”]</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">返回的值不能转换为</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Type</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，则显式</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">转换</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">将抛出</font><i><font style="vertical-align: inherit;">InvalidCastException</font></i><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">最后，为什么会有两个鬼？</font></font>问题是开放的。 <br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">发行第43期</font></font></b> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">让我们看一下</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">System.Runtime.InteropServices.RuntimeInformation</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">中的可疑代码段</font><font style="vertical-align: inherit;">。</font></font><br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> FrameworkDescription { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (s_frameworkDescription == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> versionString = (<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>)AppContext.GetData(<span class="hljs-string"><span class="hljs-string">"FX_PRODUCT_VERSION"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (versionString == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { .... versionString = <span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">object</span></span>).Assembly .GetCustomAttribute&lt; AssemblyInformationalVersionAttribute&gt;() ?.InformationalVersion; .... <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> plusIndex = versionString.IndexOf(<span class="hljs-string"><span class="hljs-string">'+'</span></span>); .... } .... } .... } }</code> </pre> <br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PVS-Studio警告</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">V3105</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">通过空条件运算符分配了'versionString'变量后，即可使用。 NullReferenceException是可能的。 RuntimeInformation.cs 29 </font><font style="vertical-align: inherit;">当</font><font style="vertical-align: inherit;">为</font><i><font style="vertical-align: inherit;">versionString</font></i><font style="vertical-align: inherit;">变量</font><font style="vertical-align: inherit;">调用</font><i><font style="vertical-align: inherit;">IndexOf</font></i><font style="vertical-align: inherit;">方法时，</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">分析器会警告</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">NullReferenceException</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">类型的可能异常</font><font style="vertical-align: inherit;">。检索变量的值时，代码作者</font><font style="vertical-align: inherit;">在访问</font><i><font style="vertical-align: inherit;">InfromationalVersion</font></i><font style="vertical-align: inherit;">属性时</font><font style="vertical-align: inherit;">使用'？。'运算符不会获取</font><i><font style="vertical-align: inherit;">NullReferenceException</font></i><font style="vertical-align: inherit;">。笑话是，如果对</font><i><font style="vertical-align: inherit;">GetCustomAttribute &lt;...&gt;</font></i><font style="vertical-align: inherit;">的调用</font><font style="vertical-align: inherit;">返回</font><i><font style="vertical-align: inherit;">null</font></i></font><i><font style="vertical-align: inherit;"></font></i><font style="vertical-align: inherit;"></font><i><font style="vertical-align: inherit;"></font></i><font style="vertical-align: inherit;"></font><i><font style="vertical-align: inherit;"></font></i><font style="vertical-align: inherit;"></font><i><font style="vertical-align: inherit;"></font></i><font style="vertical-align: inherit;"></font><i><font style="vertical-align: inherit;"></font></i><font style="vertical-align: inherit;"></font><i><font style="vertical-align: inherit;"></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，仍然会引发异常，但是会更低-调用</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">IndexOf</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">方法时</font><font style="vertical-align: inherit;">，因为</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">versionString</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">将为</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">null</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">发行第44期</font></font></b> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">我们转到</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">System.ComponentModel.Composition</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">项目，</font><font style="vertical-align: inherit;">并看到一些警告。</font><font style="vertical-align: inherit;">立即针对以下代码发出2条警告：</font></font><br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CanSpecialize</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">....</span></span></span><span class="hljs-function">)</span></span> { .... <span class="hljs-keyword"><span class="hljs-keyword">object</span></span>[] genericParameterConstraints = ....; GenericParameterAttributes[] genericParameterAttributes = ....; <span class="hljs-comment"><span class="hljs-comment">// if no constraints and attributes been specifed, anything can be created if ((genericParameterConstraints == null) &amp;&amp; (genericParameterAttributes == null)) { return true; } if ((genericParameterConstraints != null) &amp;&amp; (genericParameterConstraints.Length != partArity)) { return false; } if ((genericParameterAttributes != null) &amp;&amp; (genericParameterAttributes.Length != partArity)) { return false; } for (int i = 0; i &lt; partArity; i++) { if (!GenericServices.CanSpecialize( specialization[i], (genericParameterConstraints[i] as Type[]). CreateTypeSpecializations(specialization), genericParameterAttributes[i])) { return false; } } return true; }</span></span></code> </pre> <br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PVS-Studio警告</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：</font></font><br><br><ul><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">V3125</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">在对null进行验证之后，使用了'genericParameterConstraints'对象。</font><font style="vertical-align: inherit;">检查行：603、589。GenericSpecializationPartCreationInfo.cs 603</font></font></li><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">V3125</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">在对null进行验证后，使用了'genericParameterAttributes'对象。</font><font style="vertical-align: inherit;">检查行：604、594。GenericSpecializationPartCreationInfo.cs 604</font></font></li></ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">代码中有</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">genericParameterAttributes！= Null</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">和</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">genericParameterConstraints！= Null</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">检查</font><font style="vertical-align: inherit;">。因此，</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">空</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> -这些变量考虑允许值。如果两个变量都为</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">null</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，则退出方法-没有问题。但是，如果任何变量为</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">null</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，但方法未退出怎么办？如果这样的状态是可能的，并且执行到达循环，我们将得到</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">NullReferenceException</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">类型的异常</font><font style="vertical-align: inherit;">。</font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第45期</font></font></b> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">让我们看一下来自同一项目的另一个有趣的警告。</font><font style="vertical-align: inherit;">而且，尽管我们做不同的事情-首先我们再次使用该类，然后查看代码。</font><font style="vertical-align: inherit;">我们会将最新可用的预发行版本的NuGet软件包连接到项目（我安装了4.6.0-preview6.19303.8软件包）。</font><font style="vertical-align: inherit;">让我们编写一个简单的代码，例如：</font></font><br><br><pre> <code class="cs hljs">LazyMemberInfo lazyMemberInfo = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> LazyMemberInfo(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> eq = lazyMemberInfo.Equals(<span class="hljs-literal"><span class="hljs-literal">null</span></span>); Console.WriteLine(eq);</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">在docs.microsoft.com上未对</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Equals</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">方法进行</font><font style="vertical-align: inherit;">评论，我没有为.NET Core（仅针对.NET Framework）找到此方法的描述。</font><font style="vertical-align: inherit;">如果您查看它（“ </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">LazyMemberInfo.Equals（Object）方法</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ”）-看不到任何异常-它返回</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">true</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">或</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">false</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，没有关于生成的异常的信息。</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">我们运行代码以执行，请参见：</font></font><br><br><p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/8e5/8f7/aa4/8e58f7aa4e5a274751cde57da4d9497f.png" alt="图片16"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 我们可以稍作改动，编写以下代码，并得出一个有趣的结论： </font></font><br><br><pre> <code class="cs hljs">LazyMemberInfo lazyMemberInfo = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> LazyMemberInfo(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> eq = lazyMemberInfo.Equals(<span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(String)); Console.WriteLine(eq);</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 代码执行的结果。 </font></font><br><br><p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/e74/199/292/e74199292d39b2df8a7b205218c9c1fe.png" alt="图片17"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">有趣的是，这两个异常都是在同一表达式中生成的。</font><font style="vertical-align: inherit;">让我们看一下</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Equals</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">方法</font><font style="vertical-align: inherit;">。</font></font><br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Equals</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">object</span></span></span></span><span class="hljs-function"><span class="hljs-params"> obj</span></span></span><span class="hljs-function">)</span></span> { LazyMemberInfo that = (LazyMemberInfo)obj; <span class="hljs-comment"><span class="hljs-comment">// Difefrent member types mean different members if (_memberType != that._memberType) { return false; } // if any of the lazy memebers create accessors in a delay-loaded fashion, // we simply compare the creators if ((_accessorsCreator != null) || (that._accessorsCreator != null)) { return object.Equals(_accessorsCreator, that._accessorsCreator); } // we are dealing with explicitly passed accessors in both cases if(_accessors == null || that._accessors == null) { throw new Exception(SR.Diagnostic_InternalExceptionMessage); } return _accessors.SequenceEqual(that._accessors); }</span></span></code> </pre> <br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PVS-Studio </font></font></b><font style="vertical-align: inherit;"></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">警告</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;">V3115将</font></a><font style="vertical-align: inherit;"> “ null”传递给“ Equals”方法不应导致“ NullReferenceException”。 LazyMemberInfo.cs 116 </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">实际上，在此分析器稍作摇摆，因为它对表达式</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">that._memberType</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">发出了警告</font><font style="vertical-align: inherit;">。但是，异常在上面-执行表达式</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（LazyMemberInfo）obj时发生</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。已经记录在案。</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">使用</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">InvalidCastException</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，我认为一切都清楚了。为什么会</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">引发NullReferenceException</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">？事实是</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">LazyMemberInfo</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">是一个结构；因此，将执行解</font><i><font style="vertical-align: inherit;">压缩</font></i><font style="vertical-align: inherit;">。解压缩</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">null</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">值</font><font style="vertical-align: inherit;">只会导致type的异常</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">NullReferenceException</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">好吧，这也是注释中的一些错别字，也可以同时修正。</font><font style="vertical-align: inherit;">好吧，作者的良知仍然明确地抛出了例外。</font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第四十六期</font></font></b> <font style="vertical-align: inherit;"><font style="vertical-align: inherit;">在</font><i><font style="vertical-align: inherit;">TriState</font></i><font style="vertical-align: inherit;">结构的</font><i><font style="vertical-align: inherit;">System.Drawing.Common</font></i><font style="vertical-align: inherit;">中</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">发现了类似的内容</font><font style="vertical-align: inherit;">。</font></font><i><font style="vertical-align: inherit;"></font></i><font style="vertical-align: inherit;"></font><i><font style="vertical-align: inherit;"></font></i><font style="vertical-align: inherit;"></font><br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Equals</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">object</span></span></span></span><span class="hljs-function"><span class="hljs-params"> o</span></span></span><span class="hljs-function">)</span></span> { TriState state = (TriState)o; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> _value == state._value; }</code> </pre> <br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PVS-Studio </font></font></b><font style="vertical-align: inherit;"></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">警告</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;">V3115将</font></a><font style="vertical-align: inherit;"> “ null”传递给“ Equals”方法不应导致“ NullReferenceException”。</font><font style="vertical-align: inherit;">TriState.cs 53 </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">问题与上述情况相同。</font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第47期</font></font></b> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">考虑</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">System.Text.Json</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">的一些摘要</font><font style="vertical-align: inherit;">。</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">记住，我们说过</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ToString</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">不应该返回</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">null</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">？</font><font style="vertical-align: inherit;">系好</font></font><br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">string</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ToString</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> (TokenType) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> JsonTokenType.None: <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> JsonTokenType.Null: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.Empty; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> JsonTokenType.True: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span>.TrueString; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> JsonTokenType.False: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span>.FalseString; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> JsonTokenType.Number: <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> JsonTokenType.StartArray: <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> JsonTokenType.StartObject: { <span class="hljs-comment"><span class="hljs-comment">// null parent should have hit the None case Debug.Assert(_parent != null); return _parent.GetRawValueAsString(_idx); } case JsonTokenType.String: return GetString(); case JsonTokenType.Comment: case JsonTokenType.EndArray: case JsonTokenType.EndObject: default: Debug.Fail($"No handler for {nameof(JsonTokenType)}.{TokenType}"); return string.Empty; } }</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">乍一看，此方法为</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">null</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">并且不会返回，但分析器主张相反。</font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PVS-Studio警告</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">V3108</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">不建议从“ ToSting（）”方法返回“ null”。</font><font style="vertical-align: inherit;">JsonElement.cs 1460 </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">分析器指向调用</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GetString（）</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">方法的一行</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">让我们看一下：</font></font><br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">string</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetString</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { CheckValidInstance(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> _parent.GetString(_idx, JsonTokenType.String); }</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">深入探讨-进入</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GetString</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">方法的重载版本</font><font style="vertical-align: inherit;">：</font></font><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">internal</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">string</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetString</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> index, JsonTokenType expectedType</span></span></span><span class="hljs-function">)</span></span> { .... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (tokenType == JsonTokenType.Null) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } .... }</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">在这里，我们已经看到了</font><font style="vertical-align: inherit;">从该方法以及最初考虑的</font><i><font style="vertical-align: inherit;">ToString</font></i><font style="vertical-align: inherit;">返回</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">null</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">的条件</font><font style="vertical-align: inherit;">。</font><b><font style="vertical-align: inherit;">第48期</font></b><font style="vertical-align: inherit;">另一个有趣的地方：</font></font><i><font style="vertical-align: inherit;"></font></i><font style="vertical-align: inherit;"></font><br><br> <b><font style="vertical-align: inherit;"></font></b> <br><br><font style="vertical-align: inherit;"></font><br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">internal</span></span></span><span class="hljs-function"> JsonPropertyInfo </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CreatePolymorphicProperty</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">....</span></span></span><span class="hljs-function">)</span></span> { JsonPropertyInfo runtimeProperty = CreateProperty(property.DeclaredPropertyType, runtimePropertyType, property.ImplementedPropertyType, property?.PropertyInfo, Type, options); property.CopyRuntimeSettingsTo(runtimeProperty); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> runtimeProperty; }</code> </pre> <br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PVS-Studio警告</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">V3042</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">可能为NullReferenceException。 '？。'和“。”运算符用于访问“属性”对象JsonClassInfo.AddProperty.cs的成员。179 </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">在调用</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CreateProperty</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">方法时，</font><font style="vertical-align: inherit;">它们通过变量</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">property</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">多次访问</font><i><font style="vertical-align: inherit;">属性</font></i><font style="vertical-align: inherit;">：</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">property.DeclaredPropertyType</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">property.ImplementedPropertyType</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">property？.PropertyInfo</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。如您所见，在一种情况下，它们使用“？。”运算符。如果此处不是多余的，并且</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">property</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">可以为</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">null</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，则此操作符将无济于事，因为在直接访问时将生成该类型的异常</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">NullReferenceException</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第49期</font></font></b> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，在</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">System.Security.Cryptography.Xml</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">项目中发现以下可疑位置</font><font style="vertical-align: inherit;">，它们成对出现，其他警告也多次发生。</font><font style="vertical-align: inherit;">代码看起来又像复制粘贴，自己比较。</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第一个片段：</font></font><br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Write</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">StringBuilder strBuilder, DocPosition docPos, AncestralNamespaceContextManager anc</span></span></span><span class="hljs-function">)</span></span> { docPos = DocPosition.BeforeRootElement; <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (XmlNode childNode <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> ChildNodes) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (childNode.NodeType == XmlNodeType.Element) { CanonicalizationDispatcher.Write( childNode, strBuilder, DocPosition.InRootElement, anc); docPos = DocPosition.AfterRootElement; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { CanonicalizationDispatcher.Write(childNode, strBuilder, docPos, anc); } } }</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 第二段： </font></font><br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">WriteHash</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">HashAlgorithm hash, DocPosition docPos, AncestralNamespaceContextManager anc</span></span></span><span class="hljs-function">)</span></span> { docPos = DocPosition.BeforeRootElement; <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (XmlNode childNode <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> ChildNodes) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (childNode.NodeType == XmlNodeType.Element) { CanonicalizationDispatcher.WriteHash( childNode, hash, DocPosition.InRootElement, anc); docPos = DocPosition.AfterRootElement; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { CanonicalizationDispatcher.WriteHash(childNode, hash, docPos, anc); } } }</code> </pre> <br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PVS-Studio警告</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：</font></font><br><br><ul><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">V3061</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">参数'docPos'总是在使用前在方法主体中重写。</font><font style="vertical-align: inherit;">CanonicalXmlDocument.cs 37</font></font></li><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">V3061</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">参数'docPos'总是在使用前在方法主体中重写。</font><font style="vertical-align: inherit;">CanonicalXmlDocument.cs 54</font></font></li></ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">在这两种方法中，</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">docPos</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">参数</font><font style="vertical-align: inherit;">在使用其值之前</font><i><font style="vertical-align: inherit;">都会被</font></i><font style="vertical-align: inherit;">覆盖，因此，用作该方法参数的值将被简单地忽略。</font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第50期</font></font></b> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">考虑有关</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">System.Data.SqlClient</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">项目代码的一些警告</font><font style="vertical-align: inherit;">。</font></font><br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">IsBOMNeeded</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">MetaType type, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">object</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">value</span></span></span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (type.NullableType == TdsEnums.SQLXMLTYPE) { Type currentType = <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>.GetType(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (currentType == <span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(SqlString)) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!((SqlString)<span class="hljs-keyword"><span class="hljs-keyword">value</span></span>).IsNull &amp;&amp; ((((SqlString)<span class="hljs-keyword"><span class="hljs-keyword">value</span></span>).Value).Length &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>)) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((((SqlString)<span class="hljs-keyword"><span class="hljs-keyword">value</span></span>).Value[<span class="hljs-number"><span class="hljs-number">0</span></span>] &amp; <span class="hljs-number"><span class="hljs-number">0xff</span></span>) != <span class="hljs-number"><span class="hljs-number">0xff</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((currentType == <span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>)) &amp;&amp; (((String)<span class="hljs-keyword"><span class="hljs-keyword">value</span></span>).Length &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>)) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((<span class="hljs-keyword"><span class="hljs-keyword">value</span></span> != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) &amp;&amp; (((<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>)<span class="hljs-keyword"><span class="hljs-keyword">value</span></span>)[<span class="hljs-number"><span class="hljs-number">0</span></span>] &amp; <span class="hljs-number"><span class="hljs-number">0xff</span></span>) != <span class="hljs-number"><span class="hljs-number">0xff</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (currentType == <span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(SqlXml)) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!((SqlXml)<span class="hljs-keyword"><span class="hljs-keyword">value</span></span>).IsNull) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (currentType == <span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(XmlDataFeed)) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>; <span class="hljs-comment"><span class="hljs-comment">// Values will eventually converted to unicode string here } } return false; }</span></span></code> </pre> <br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PVS-Studio警告</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">V3095</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">在对空值进行验证之前，已使用“值”对象。检查行：8696，8708。TdsParser.cs 8696 </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">分析器被检查</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">值</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">弄糊涂了</font><i><font style="vertical-align: inherit;">！=</font></i><font style="vertical-align: inherit;">在其中一种情况下</font><i><font style="vertical-align: inherit;">为Null</font></i><font style="vertical-align: inherit;">。似乎她在重构期间迷路了，因为</font><font style="vertical-align: inherit;">多次取消引用</font><font style="vertical-align: inherit;">上述</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">值</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。如果</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">value</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">可以为</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">null</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，则表示情况不好。</font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第51期</font></font></b> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">测试中的下一个错误，但对我来说似乎很有趣，因此我决定提出。</font></font><br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">virtual</span></span></span><span class="hljs-function"> TDSMessageCollection </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CreateQueryResponse</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">....</span></span></span><span class="hljs-function">)</span></span> { .... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (....) { .... } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( lowerBatchText.Contains(<span class="hljs-string"><span class="hljs-string">"name"</span></span>) &amp;&amp; lowerBatchText.Contains(<span class="hljs-string"><span class="hljs-string">"state"</span></span>) &amp;&amp; lowerBatchText.Contains(<span class="hljs-string"><span class="hljs-string">"databases"</span></span>) &amp;&amp; lowerBatchText.Contains(<span class="hljs-string"><span class="hljs-string">"db_name"</span></span>)) <span class="hljs-comment"><span class="hljs-comment">// SELECT [name], [state] FROM [sys].[databases] WHERE [name] = db_name() { // Delegate to current database response responseMessage = _PrepareDatabaseResponse(session); } .... }</span></span></code> </pre> <br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">警告PVS-Studio</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">V3053</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">表达式过多。检查子字符串“名称”和“ db_name”。 QueryEngine.cs 151 </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">实际上，在这种情况下，</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">lowerBatchText.Contains（“名称”）</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">和</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">lowerBatchText.Contains（“ db_name”）子表达式的组合</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">是多余的。实际上，如果要检查的字符串包含子字符串</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">“ db_name”</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，那么它还将包含子字符串</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">“ name”</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。如果字符串不包含</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">“ name”</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，那么</font><font style="vertical-align: inherit;">它也将不包含</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">“ db_name”</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。事实证明，检查</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">lowerBatchText.Contains（“ name”）</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">是多余的。如果所检查的字符串不包含</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">“ name”，</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">则除非它可以减少所评估表达式的数量，否则它会被禁用</font><font style="vertical-align: inherit;">。</font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第52期</font></font></b> <font style="vertical-align: inherit;"><i><font style="vertical-align: inherit;">System.Net.Requests</font></i></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">项目中的可疑代码段</font><font style="vertical-align: inherit;">。</font></font><i><font style="vertical-align: inherit;"></font></i><font style="vertical-align: inherit;"></font><br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> PipelineInstruction </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">PipelineCallback</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"> PipelineEntry entry, ResponseDescription response, ....</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (NetEventSource.IsEnabled) NetEventSource.Info(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>, <span class="hljs-string"><span class="hljs-string">$"Command:</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{entry?.Command}</span></span></span><span class="hljs-string"> Description:</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{response?.StatusDescription}</span></span></span><span class="hljs-string">"</span></span>); <span class="hljs-comment"><span class="hljs-comment">// null response is not expected if (response == null) return PipelineInstruction.Abort; .... if (entry.Command == "OPTS utf8 on\r\n") .... .... }</span></span></code> </pre> <br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PVS-Studio警告</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">V3125</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">在对null进行验证后，使用了“ entry”对象。检查行：270，227。FtpControlStream.cs 270 </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">编译内插行时，使用表达式</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">条目？。命令</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">和</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">响应？</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。代替'。'运算符</font><font style="vertical-align: inherit;">如果任何对应的参数为</font><i><font style="vertical-align: inherit;">null</font></i><font style="vertical-align: inherit;">，则</font><font style="vertical-align: inherit;">使用'？。'不会获得</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">NullReferenceException</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">类型的异常</font><font style="vertical-align: inherit;">。在这种情况下，此技术有效。此外，从代码中可以看到</font><font style="vertical-align: inherit;">，</font><i><font style="vertical-align: inherit;">响应</font></i><font style="vertical-align: inherit;">的可能的</font><i><font style="vertical-align: inherit;">空</font></i><font style="vertical-align: inherit;">值</font><i><font style="vertical-align: inherit;">被</font></i><font style="vertical-align: inherit;">切除（如果</font><i><font style="vertical-align: inherit;">response == null</font></i><font style="vertical-align: inherit;">，</font><font style="vertical-align: inherit;">则从方法中退出</font><font style="vertical-align: inherit;">），但是用于</font><i><font style="vertical-align: inherit;">输入</font></i></font><i><font style="vertical-align: inherit;"></font></i><font style="vertical-align: inherit;"></font><i><font style="vertical-align: inherit;"></font></i><font style="vertical-align: inherit;"></font><i><font style="vertical-align: inherit;"></font></i><font style="vertical-align: inherit;"></font><i><font style="vertical-align: inherit;"></font></i><font style="vertical-align: inherit;"></font><i><font style="vertical-align: inherit;"></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">没什么 </font><font style="vertical-align: inherit;">结果，如果</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">entry</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">为</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">null</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，</font><font style="vertical-align: inherit;">则</font><font style="vertical-align: inherit;">在调用</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">entry.Command</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">时</font><font style="vertical-align: inherit;">将引发异常（已经使用'。' </font><i><font style="vertical-align: inherit;">而</font></i><font style="vertical-align: inherit;">不是'？。'）。</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">接下来，我们将再次对代码进行相当详细的研究，因此我建议您再休息一会儿-分心，冲泡茶或煮咖啡，之后我很高兴再次在这里见到您。</font></font><br><br><p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/56a/3fc/f07/56a3fcf075284f021a56249627e518bb.png" alt="图片23"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">你回来了吗 </font><font style="vertical-align: inherit;">然后，让我们继续。</font></font> :) <br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第53期</font></font></b> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">现在让我们看一下</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">System.Collections.Immutable</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">项目中的一些有趣内容</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">这次，让我们对</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">System.Collections.Immutable.ImmutableArray &lt;T&gt;</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">结构进行一些实验</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">我们对方法</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">IStructuralEquatable.Equals</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">和</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">IStructuralComparable.CompareTo</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">感兴趣</font><font style="vertical-align: inherit;">。</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">让我们从</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">IStructuralEquatable.Equals</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">方法开始</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">下面给出了代码，我建议尝试自行了解它的问题：</font></font><br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> IStructuralEquatable.Equals(<span class="hljs-keyword"><span class="hljs-keyword">object</span></span> other, IEqualityComparer comparer) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> self = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>; Array otherArray = other <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> Array; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (otherArray == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> theirs = other <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> IImmutableArray; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (theirs != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { otherArray = theirs.Array; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (self.array == <span class="hljs-literal"><span class="hljs-literal">null</span></span> &amp;&amp; otherArray == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (self.array == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } } } IStructuralEquatable ours = self.array; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ours.Equals(otherArray, comparer); }</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">你成功了吗？</font><font style="vertical-align: inherit;">如果是这样，再次表示祝贺。</font></font> :) <br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PVS-Studio警告</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">V3125</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">在针对空值验证了“我们的”对象之后，使用了该对象。检查行：1212，1204。ImmutableArray_1.cs 1212 </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">分析器</font><font style="vertical-align: inherit;">通过</font><font style="vertical-align: inherit;">位于最后一个</font><i><font style="vertical-align: inherit;">return语句中</font></i><font style="vertical-align: inherit;">的</font><i><font style="vertical-align: inherit;">ours</font></i><font style="vertical-align: inherit;">变量</font><font style="vertical-align: inherit;">混淆了实例</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Equals</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">方法的调用</font><font style="vertical-align: inherit;">，因为它假定此处可能存在</font><i><font style="vertical-align: inherit;">NullReferenceException</font></i><font style="vertical-align: inherit;">类型的异常</font><font style="vertical-align: inherit;">。他是如何得出这个结论的？为了便于解释，下面是同一方法的简化代码。</font></font><i><font style="vertical-align: inherit;"></font></i><font style="vertical-align: inherit;"></font><i><font style="vertical-align: inherit;"></font></i><font style="vertical-align: inherit;"></font><i><font style="vertical-align: inherit;"></font></i><font style="vertical-align: inherit;"></font><br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> IStructuralEquatable.Equals(<span class="hljs-keyword"><span class="hljs-keyword">object</span></span> other, IEqualityComparer comparer) { .... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (....) { .... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (....) { .... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (self.array == <span class="hljs-literal"><span class="hljs-literal">null</span></span> &amp;&amp; otherArray == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { .... } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (self.array == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { .... } } } IStructuralEquatable ours = self.array; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ours.Equals(otherArray, comparer); }</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">根据最新的表述，我们看到的价值</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">我们</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">是从获得</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">self.array</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。上面，</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">self.array == null</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">检查执行了几次</font><font style="vertical-align: inherit;">。因此，</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">self.array</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">以及</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">我们的</font></font></i><font style="vertical-align: inherit;"><i><font style="vertical-align: inherit;">self.array</font></i><font style="vertical-align: inherit;">可以为</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">null</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。至少在理论上。在实践中是否可以实现这种条件？让我们尝试找出答案。为此，我再次将方法的主体与关键点分开。</font></font><br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> IStructuralEquatable.Equals(<span class="hljs-keyword"><span class="hljs-keyword">object</span></span> other, IEqualityComparer comparer) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> self = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>; <span class="hljs-comment"><span class="hljs-comment">// &lt;= 1 Array otherArray = other as Array; if (otherArray == null) // &lt;= 2 { var theirs = other as IImmutableArray; if (theirs != null) // &lt;= 3 { otherArray = theirs.Array; if (self.array == null &amp;&amp; otherArray == null) { return true; } else if (self.array == null) // &lt;= 4 { return false; } } IStructuralEquatable ours = self.array; // &lt;= 5 return ours.Equals(otherArray, comparer); }</span></span></code> </pre> <br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">要点1</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">self.array == this.array</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（由于</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">self = this</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）。因此，在调用该方法之前，必须达到状态</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">this.array == null</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">重点2</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。我们可以忽略</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">if</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，这将是实现目标或进入内部的最简单选择。要忽略这种</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">情况</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，变量</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">other</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">的类型必须是</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Array</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">类型</font><font style="vertical-align: inherit;">或它的派生</font><font style="vertical-align: inherit;">类型</font><font style="vertical-align: inherit;">，而</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">other</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">不为</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">null </font></font></i><font style="vertical-align: inherit;"><i><font style="vertical-align: inherit;">就</font></i><font style="vertical-align: inherit;">足够了</font><font style="vertical-align: inherit;">。然后</font><font style="vertical-align: inherit;">在</font><i><font style="vertical-align: inherit;">otherArray中</font></i><font style="vertical-align: inherit;">使用</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">as</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">运算符</font><font style="vertical-align: inherit;">后</font></font><i><font style="vertical-align: inherit;"></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">将写入非零引用，并且我们将忽略第一个</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">if语句</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">重点3</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">这一点意味着一条更复杂的道路。</font><font style="vertical-align: inherit;">我们绝对需要在第二条</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">if语句</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（具有条件表达式“ </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">他们的！”的那条</font></font></i><font style="vertical-align: inherit;"><i><font style="vertical-align: inherit;">语句）中</font></i><font style="vertical-align: inherit;">退出</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">如果这没有发生，</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">那么then</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">分支</font><font style="vertical-align: inherit;">的执行开始</font><font style="vertical-align: inherit;">，我们保证不会达到我们需要的点5，</font><font style="vertical-align: inherit;">因为关键点4导致</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">self.array == null</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。为了不进入</font><font style="vertical-align: inherit;">关键点3 </font><font style="vertical-align: inherit;">的</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">if语句</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，您必须执行以下操作之一条件：</font></font><br><br><ul><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">为一个值</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">其他</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">为</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">空</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ;</font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">因此</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">other</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">的实际类型</font><font style="vertical-align: inherit;">不实现</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">IImmutableArray</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">接口</font><font style="vertical-align: inherit;">。</font></font></li></ul><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">重点5</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">如果使用</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">self.array == null</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">值达到这一点</font><font style="vertical-align: inherit;">，则说明我们已经实现了目标，该方法中将抛出</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">NullReferenceException</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">类型的异常</font><font style="vertical-align: inherit;">。</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">我们获得以下数据集，这些数据集将使我们达到目标。</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">首先：</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">this.array为null</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第二个是以下之一：</font></font><br><br><ul><li> <i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">其他</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">空</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ;</font></font></li><li> <i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">other</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">是</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Array</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">类型</font><font style="vertical-align: inherit;">或它的派生</font><font style="vertical-align: inherit;">类型</font><font style="vertical-align: inherit;">；</font></font></li><li> <i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">other</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">没有</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Array</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">类型</font><font style="vertical-align: inherit;">或其派生类，也没有实现</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">IImmutableArray</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">接口</font><font style="vertical-align: inherit;">。</font></font></li></ul><br> <i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">数组</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">是声明如下的字段：</font></font><br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">internal</span></span> T[] array;</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">由于</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ImmutableArray &lt;T&gt;</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">是结构，因此它具有默认的构造函数（不带参数），其结果是</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">数组</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">字段</font><font style="vertical-align: inherit;">将成为默认值，即</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">null</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">这就是我们所需要的。</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">好吧，我们不会忘记我们已经研究了接口方法的显式实现，因此，在调用之前，我们需要执行强制转换。</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">现在，我们已经准备就绪，可以通过三种方式实现异常。</font><font style="vertical-align: inherit;">我们连接该库的调试版本，编写代码，执行并观察。</font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">代码段1</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> comparer = EqualityComparer&lt;String&gt;.Default; ImmutableArray&lt;String&gt; immutableArray = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ImmutableArray&lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>&gt;(); ((IStructuralEquatable)immutableArray).Equals(<span class="hljs-literal"><span class="hljs-literal">null</span></span>, comparer);</code> </pre> <br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">代码段2</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> comparer = EqualityComparer&lt;String&gt;.Default; ImmutableArray&lt;String&gt; immutableArray = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ImmutableArray&lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>&gt;(); ((IStructuralEquatable)immutableArray).Equals(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>[] { }, comparer);</code> </pre> <br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">代码段3</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> comparer = EqualityComparer&lt;String&gt;.Default; ImmutableArray&lt;String&gt; immutableArray = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ImmutableArray&lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>&gt;(); ((IStructuralEquatable)immutableArray).Equals(<span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(Object), comparer);</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 所有三个代码片段的执行结果将是相同的，只是由于不同的输入数据和不同的执行路径才能实现。 </font></font><br><br><p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/13a/a3b/e8a/13aa3be8a0b68a646aee130773f2c862.png" alt="图片18"></div><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第54期</font></font></b> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">如果您没有忘记我们提供的另一种方法，您应该尝试妥协。</font><font style="vertical-align: inherit;">:)只有这次，我们才不会对它进行详细的分解。</font><font style="vertical-align: inherit;">而且，我们已经从上一个示例中了解了一些信息。</font></font><br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">int</span></span> IStructuralComparable.CompareTo(<span class="hljs-keyword"><span class="hljs-keyword">object</span></span> other, IComparer comparer) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> self = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>; Array otherArray = other <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> Array; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (otherArray == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> theirs = other <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> IImmutableArray; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (theirs != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { otherArray = theirs.Array; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (self.array == <span class="hljs-literal"><span class="hljs-literal">null</span></span> &amp;&amp; otherArray == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (self.array == <span class="hljs-literal"><span class="hljs-literal">null</span></span> ^ otherArray == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ArgumentException( SR.ArrayInitializedStateNotEqual, <span class="hljs-keyword"><span class="hljs-keyword">nameof</span></span>(other)); } } } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (otherArray != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { IStructuralComparable ours = self.array; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ours.CompareTo(otherArray, comparer); <span class="hljs-comment"><span class="hljs-comment">// &lt;= } throw new ArgumentException(SR.ArrayLengthsNotEqual, nameof(other)); }</span></span></code> </pre> <br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PVS-Studio警告</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">V3125</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">在针对空值验证了“我们的”对象之后，使用了该对象。</font><font style="vertical-align: inherit;">检查行：1265，1251。ImmutableArray_1.cs 1265 </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">如您所见，情况与之前考虑的示例非常相似。</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">我们将编写以下代码：</font></font><br><br><pre> <code class="cs hljs">Object other = ....; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> comparer = Comparer&lt;String&gt;.Default; ImmutableArray&lt;String&gt; immutableArray = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ImmutableArray&lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>&gt;(); ((IStructuralComparable)immutableArray).CompareTo(other, comparer);</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">让我们尝试选择输入值，以到达</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">发生NullReferenceException</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">类型的异常的地步</font><font style="vertical-align: inherit;">。</font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">值</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">other</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">new String [] {}</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ;</font></font><br><br> 结果： <br><br><p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/eef/d77/08a/eefd7708a187f5060f2074e642f18434.png" alt="图片22"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">因此，我们再次设法选择了一组输入数据，该方法中发生了输入异常。</font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第55期</font></font></b> <font style="vertical-align: inherit;"><i><font style="vertical-align: inherit;">System.Net.HttpListener</font></i></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">项目中有</font><font style="vertical-align: inherit;">多个位置，不仅可疑，而且彼此非常相似。</font><font style="vertical-align: inherit;">再一次，关于复制粘贴蔓延的模糊的怀疑。</font><font style="vertical-align: inherit;">由于模式相同，请考虑一个示例代码；对于其他情况，我将给出分析器警告：</font></font><i><font style="vertical-align: inherit;"></font></i><font style="vertical-align: inherit;"></font><br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> IAsyncResult </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">BeginRead</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">byte</span></span></span></span><span class="hljs-function"><span class="hljs-params">[] buffer, ....</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (NetEventSource.IsEnabled) { NetEventSource.Enter(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>); NetEventSource.Info(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>, <span class="hljs-string"><span class="hljs-string">"buffer.Length:"</span></span> + buffer.Length + <span class="hljs-string"><span class="hljs-string">" size:"</span></span> + size + <span class="hljs-string"><span class="hljs-string">" offset:"</span></span> + offset); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (buffer == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ArgumentNullException(<span class="hljs-keyword"><span class="hljs-keyword">nameof</span></span>(buffer)); } .... }</code> </pre> <br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PVS-Studio警告</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">V3095</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">在对null进行验证之前，已使用“缓冲区”对象。检查行：51，53。HttpRequestStream.cs 51 </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">抛出</font><font style="vertical-align: inherit;">带有</font><i><font style="vertical-align: inherit;">缓冲区== null的</font></i></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ArgumentNullException</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">类型的异常，</font><font style="vertical-align: inherit;">显式暗示</font><i><font style="vertical-align: inherit;">null</font></i><font style="vertical-align: inherit;">是此变量的无效值。但是，如果</font><i><font style="vertical-align: inherit;">NetEventSource.IsEnabled</font></i><font style="vertical-align: inherit;">表达式的</font><font style="vertical-align: inherit;">值为</font><i><font style="vertical-align: inherit;">true</font></i><font style="vertical-align: inherit;">且</font><i><font style="vertical-align: inherit;">buffer</font></i><font style="vertical-align: inherit;">为</font><i><font style="vertical-align: inherit;">null</font></i><font style="vertical-align: inherit;">，则</font><font style="vertical-align: inherit;">在评估表达式</font><i><font style="vertical-align: inherit;">buffer.Length</font></i><font style="vertical-align: inherit;">时</font><font style="vertical-align: inherit;">将</font><i><font style="vertical-align: inherit;">抛出NullReferenceException</font></i><font style="vertical-align: inherit;">类型的异常</font><font style="vertical-align: inherit;">。因此，在检查</font><i><font style="vertical-align: inherit;">缓冲区== null</font></i><font style="vertical-align: inherit;">之前</font></font><i><font style="vertical-align: inherit;"></font></i><font style="vertical-align: inherit;"></font><i><font style="vertical-align: inherit;"></font></i><font style="vertical-align: inherit;"></font><i><font style="vertical-align: inherit;"></font></i><font style="vertical-align: inherit;"></font><i><font style="vertical-align: inherit;"></font></i><font style="vertical-align: inherit;"></font><i><font style="vertical-align: inherit;"></font></i><font style="vertical-align: inherit;"></font><i><font style="vertical-align: inherit;"></font></i><font style="vertical-align: inherit;"></font><i><font style="vertical-align: inherit;"></font></i><font style="vertical-align: inherit;"></font><i><font style="vertical-align: inherit;"></font></i><font style="vertical-align: inherit;"></font><i><font style="vertical-align: inherit;"></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">在这种情况下，问题甚至无法解决。</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">在其他方法上使用完全相同的模式发出的PVS-Studio警告：</font></font><br><br><ul><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">V3095</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">在对null进行验证之前，已使用'buffer'对象。</font><font style="vertical-align: inherit;">检查行：49，51。HttpResponseStream.cs 49</font></font></li><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">V3095</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">在对null进行验证之前，已使用'buffer'对象。</font><font style="vertical-align: inherit;">检查行：74，75。HttpResponseStream.cs 74</font></font></li></ul><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">问题56</font></font></b> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">在</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">System.Transactions.Local</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">项目中找到类似的代码</font><font style="vertical-align: inherit;">。</font></font><br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">internal</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">EnterState</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">InternalTransaction tx</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (tx._outcomeSource._isoLevel == IsolationLevel.Snapshot) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> TransactionException.CreateInvalidOperationException( TraceSourceType.TraceSourceLtm, SR.CannotPromoteSnapshot, <span class="hljs-literal"><span class="hljs-literal">null</span></span>, tx == <span class="hljs-literal"><span class="hljs-literal">null</span></span> ? Guid.Empty : tx.DistributedTxId); } .... }</code> </pre> <br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PVS-Studio警告</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">V3095</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">在对null进行验证之前，已使用'tx'对象。检查行：3282，3285。TransactionState.cs 3282 </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">在特定条件下，他们想要引发</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">InvalidOperationException</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">类型的异常</font><font style="vertical-align: inherit;">。调用该方法时，将使用</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tx</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">参数创建异常对象</font><font style="vertical-align: inherit;">，并检查</font><font style="vertical-align: inherit;">该对象</font><font style="vertical-align: inherit;">是否为</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">null，</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">以便</font><font style="vertical-align: inherit;">在评估表达式</font><i><font style="vertical-align: inherit;">tx.DistributedTxId</font></i><font style="vertical-align: inherit;">时</font><font style="vertical-align: inherit;">不会引发</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">NullReferenceException</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">类型的异常</font><font style="vertical-align: inherit;">。具有讽刺意味的是，如果</font><i><font style="vertical-align: inherit;">tx</font></i><font style="vertical-align: inherit;"> - </font><i><font style="vertical-align: inherit;">null</font></i><font style="vertical-align: inherit;">，则</font><font style="vertical-align: inherit;">此检查将无济于事，因为在计算</font><i><font style="vertical-align: inherit;">if语句</font></i><font style="vertical-align: inherit;">的条件时</font></font><i><font style="vertical-align: inherit;"></font></i><font style="vertical-align: inherit;"></font><i><font style="vertical-align: inherit;"></font></i><font style="vertical-align: inherit;"></font><i><font style="vertical-align: inherit;"></font></i><font style="vertical-align: inherit;"></font><i><font style="vertical-align: inherit;"></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">访问通过一个实例变量的字段</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">TX</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tx._outcomeSource._isoLevel</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><i><font style="vertical-align: inherit;">System.Runtime.Caching</font></i><font style="vertical-align: inherit;">项目中的</font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Issue 57</font></font></b> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">代码</font><font style="vertical-align: inherit;">。</font></font><i><font style="vertical-align: inherit;"></font></i><font style="vertical-align: inherit;"></font><br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">internal</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">SetLimit</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> cacheMemoryLimitMegabytes</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> cacheMemoryLimit = cacheMemoryLimitMegabytes; cacheMemoryLimit = cacheMemoryLimit &lt;&lt; MEGABYTE_SHIFT; _memoryLimit = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-comment"><span class="hljs-comment">// never override what the user specifies as the limit; // only call AutoPrivateBytesLimit when the user does not specify one. if (cacheMemoryLimit == 0 &amp;&amp; _memoryLimit == 0) { // Zero means we impose a limit _memoryLimit = EffectiveProcessMemoryLimit; } else if (cacheMemoryLimit != 0 &amp;&amp; _memoryLimit != 0) { // Take the min of "cache memory limit" and // the host's "process memory limit". _memoryLimit = Math.Min(_memoryLimit, cacheMemoryLimit); } else if (cacheMemoryLimit != 0) { // _memoryLimit is 0, but "cache memory limit" // is non-zero, so use it as the limit _memoryLimit = cacheMemoryLimit; } .... }</span></span></code> </pre> <br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PVS-Studio </font></font></b><font style="vertical-align: inherit;"></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">警告</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;">V3022</font></a><font style="vertical-align: inherit;">表达式'cacheMemoryLimit！= 0 &amp;&amp; _memoryLimit！= 0'始终为false。 CacheMemoryMonitor.cs 250 </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">如果仔细查看代码，您会发现表达式之一</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-cacheMemoryLimit！= 0 &amp;&amp; _memoryLimit！= 0-</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">始终为</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">false</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。由于</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">_memoryLimit</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">的值为0（</font><i><font style="vertical-align: inherit;">放置</font></i><font style="vertical-align: inherit;">在</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">if语句</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">之前</font><font style="vertical-align: inherit;">）</font><font style="vertical-align: inherit;">，因此</font><font style="vertical-align: inherit;">&amp;&amp;运算符的右操作数为</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">false</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，因此，整个表达式的结果也为</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">false</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">发行第58期</font></font></b> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">以下是</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">System.Diagnostics.TraceSource</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">项目中的可疑代码</font><font style="vertical-align: inherit;">。</font></font><br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">object</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Pop</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { StackNode n = _stack.Value; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (n == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">base</span></span>.Pop(); } _stack.Value = n.Prev; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> n.Value; }</code> </pre> <br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PVS-Studio警告</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">V3125</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">在对null进行验证之后，使用了'n'对象。检查行：115，111。CorrelationManager.cs 115 </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">有趣的代码。由于检查</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">n == null，我将</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">假定</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">null</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">是此局部变量的可能值。在这种情况下，</font><font style="vertical-align: inherit;">访问实例属性</font><i><font style="vertical-align: inherit;">-n.Prev</font></i><font style="vertical-align: inherit;">时</font><font style="vertical-align: inherit;">将</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">引发NullReferenceException</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">类型的</font><i><font style="vertical-align: inherit;">异常</font></i><font style="vertical-align: inherit;">。如果</font><i><font style="vertical-align: inherit;">n</font></i><font style="vertical-align: inherit;">在这种情况下永远不能为</font><i><font style="vertical-align: inherit;">null</font></i><font style="vertical-align: inherit;">，则</font><font style="vertical-align: inherit;">在此上下文中</font><font style="vertical-align: inherit;">调用</font><i><font style="vertical-align: inherit;">base.Pop（）</font></i><font style="vertical-align: inherit;">将永远不会执行。</font><b><font style="vertical-align: inherit;">第59</font></b><font style="vertical-align: inherit;">期在项目</font><i><font style="vertical-align: inherit;">System.Drawing.Primitives中</font></i><font style="vertical-align: inherit;">找到一个有趣的地方</font></font><i><font style="vertical-align: inherit;"></font></i><font style="vertical-align: inherit;"></font><i><font style="vertical-align: inherit;"></font></i><font style="vertical-align: inherit;"></font><i><font style="vertical-align: inherit;"></font></i><font style="vertical-align: inherit;"></font><i><font style="vertical-align: inherit;"></font></i><font style="vertical-align: inherit;"></font><br><br> <b><font style="vertical-align: inherit;"></font></b> <br><br><font style="vertical-align: inherit;"></font><i><font style="vertical-align: inherit;"></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">再一次，我建议自己寻找问题。</font><font style="vertical-align: inherit;">这是代码：</font></font><br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">string</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ToHtml</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Color c</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> colorString = <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.Empty; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (c.IsEmpty) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> colorString; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ColorUtil.IsSystemColor(c)) { <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> (c.ToKnownColor()) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> KnownColor.ActiveBorder: colorString = <span class="hljs-string"><span class="hljs-string">"activeborder"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> KnownColor.GradientActiveCaption: <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> KnownColor.ActiveCaption: colorString = <span class="hljs-string"><span class="hljs-string">"activecaption"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> KnownColor.AppWorkspace: colorString = <span class="hljs-string"><span class="hljs-string">"appworkspace"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> KnownColor.Desktop: colorString = <span class="hljs-string"><span class="hljs-string">"background"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> KnownColor.Control: colorString = <span class="hljs-string"><span class="hljs-string">"buttonface"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> KnownColor.ControlLight: colorString = <span class="hljs-string"><span class="hljs-string">"buttonface"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> KnownColor.ControlDark: colorString = <span class="hljs-string"><span class="hljs-string">"buttonshadow"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> KnownColor.ControlText: colorString = <span class="hljs-string"><span class="hljs-string">"buttontext"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> KnownColor.ActiveCaptionText: colorString = <span class="hljs-string"><span class="hljs-string">"captiontext"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> KnownColor.GrayText: colorString = <span class="hljs-string"><span class="hljs-string">"graytext"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> KnownColor.HotTrack: <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> KnownColor.Highlight: colorString = <span class="hljs-string"><span class="hljs-string">"highlight"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> KnownColor.MenuHighlight: <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> KnownColor.HighlightText: colorString = <span class="hljs-string"><span class="hljs-string">"highlighttext"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> KnownColor.InactiveBorder: colorString = <span class="hljs-string"><span class="hljs-string">"inactiveborder"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> KnownColor.GradientInactiveCaption: <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> KnownColor.InactiveCaption: colorString = <span class="hljs-string"><span class="hljs-string">"inactivecaption"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> KnownColor.InactiveCaptionText: colorString = <span class="hljs-string"><span class="hljs-string">"inactivecaptiontext"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> KnownColor.Info: colorString = <span class="hljs-string"><span class="hljs-string">"infobackground"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> KnownColor.InfoText: colorString = <span class="hljs-string"><span class="hljs-string">"infotext"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> KnownColor.MenuBar: <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> KnownColor.Menu: colorString = <span class="hljs-string"><span class="hljs-string">"menu"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> KnownColor.MenuText: colorString = <span class="hljs-string"><span class="hljs-string">"menutext"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> KnownColor.ScrollBar: colorString = <span class="hljs-string"><span class="hljs-string">"scrollbar"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> KnownColor.ControlDarkDark: colorString = <span class="hljs-string"><span class="hljs-string">"threeddarkshadow"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> KnownColor.ControlLightLight: colorString = <span class="hljs-string"><span class="hljs-string">"buttonhighlight"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> KnownColor.Window: colorString = <span class="hljs-string"><span class="hljs-string">"window"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> KnownColor.WindowFrame: colorString = <span class="hljs-string"><span class="hljs-string">"windowframe"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> KnownColor.WindowText: colorString = <span class="hljs-string"><span class="hljs-string">"windowtext"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (c.IsNamedColor) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (c == Color.LightGray) { <span class="hljs-comment"><span class="hljs-comment">// special case due to mismatch between Html and enum spelling colorString = "LightGrey"; } else { colorString = c.Name; } } else { colorString = "#" + cRToString("X2", null) + cGToString("X2", null) + cBToString("X2", null); } return colorString; }</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">好吧，好吧，这些都是我的笑话...还是可以吗？</font><font style="vertical-align: inherit;">无论如何，我们都会缩短代码以更清楚地指出问题所在。</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">这是代码的简化版：</font></font><br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> (c.ToKnownColor()) { .... <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> KnownColor.Control: colorString = <span class="hljs-string"><span class="hljs-string">"buttonface"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> KnownColor.ControlLight: colorString = <span class="hljs-string"><span class="hljs-string">"buttonface"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; .... }</code> </pre> <br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PVS-Studio警告</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">V3139</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">两个或更多分支机构执行相同的操作。</font><font style="vertical-align: inherit;">ColorTranslator.cs 302 </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">我不能肯定地说，但是我认为这仍然是一个错误。</font><font style="vertical-align: inherit;">在其他情况下，当他们想为多个枚举元素返回相同的值时，他们会使用多个</font><font style="vertical-align: inherit;">随后的</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">情况</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">在我看来，复制粘贴出错很容易。</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">挖得更深一些。</font><font style="vertical-align: inherit;">要在分析的</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ToHtml</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">方法的输出处获取</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">“ buttonface”</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">值</font><font style="vertical-align: inherit;">，可以将以下值之一传递给输入（预期）：</font></font><br><br><ul><li> <i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SystemColors.Control</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ;</font></font></li><li> <i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SystemColors.ControlLight</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font></li></ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 如果查看每种颜色的ARGB值，则可以看到以下内容： </font></font><br><br><ul><li> <i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SystemColors.Control</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">（255，240，240，240）</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ;</font></font></li><li> <i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SystemColors.ControlLight-（255，227，227，227）</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font></li></ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">如果您调用接收到的值（</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">“ buttonface”</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">），则采用相反的转换方法</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-FromHtml</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，我们将获得颜色</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Control（</font></font></i><font style="vertical-align: inherit;"><i><font style="vertical-align: inherit;">255、240、240、240 </font></i><i><font style="vertical-align: inherit;">）</font></i><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">我可以从</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">FromHtml</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">获取</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ControlLight</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">颜色</font><font style="vertical-align: inherit;">吗？</font></font>是的<font style="vertical-align: inherit;"><font style="vertical-align: inherit;">在此方法中，有一个颜色表，根据该颜色表（在特定情况下）获得颜色。</font><font style="vertical-align: inherit;">表初始化程序具有以下行：</font></font><br><br><pre> <code class="cs hljs">s_htmlSysColorTable[<span class="hljs-string"><span class="hljs-string">"threedhighlight"</span></span>] = ColorUtil.FromKnownColor(KnownColor.ControlLight);</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">因此，</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">FromHtml</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">返回</font><font style="vertical-align: inherit;">值</font><i><font style="vertical-align: inherit;">“ threedhighlight”</font></i><font style="vertical-align: inherit;">的颜色</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ControlLight（</font></font></i><font style="vertical-align: inherit;"></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">255、227、227、227）</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。我认为在</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">KnownColor.ControlLight的情况下</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">应该使用此值</font><font style="vertical-align: inherit;">。</font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第60期</font></font></b> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">让我们看一下</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">System.Text.RegularExpressions</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">项目中的一些有趣的警告</font><font style="vertical-align: inherit;">。</font></font><br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">internal</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">virtual</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">string</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">TextposDescription</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> sb = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> StringBuilder(); <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> remaining; sb.Append(runtextpos); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (sb.Length &lt; <span class="hljs-number"><span class="hljs-number">8</span></span>) sb.Append(<span class="hljs-string"><span class="hljs-string">' '</span></span>, <span class="hljs-number"><span class="hljs-number">8</span></span> - sb.Length); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (runtextpos &gt; runtextbeg) sb.Append(RegexCharClass.CharDescription(runtext[runtextpos - <span class="hljs-number"><span class="hljs-number">1</span></span>])); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> sb.Append(<span class="hljs-string"><span class="hljs-string">'^'</span></span>); sb.Append(<span class="hljs-string"><span class="hljs-string">'&gt;'</span></span>); remaining = runtextend - runtextpos; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = runtextpos; i &lt; runtextend; i++) { sb.Append(RegexCharClass.CharDescription(runtext[i])); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (sb.Length &gt;= <span class="hljs-number"><span class="hljs-number">64</span></span>) { sb.Length = <span class="hljs-number"><span class="hljs-number">61</span></span>; sb.Append(<span class="hljs-string"><span class="hljs-string">"..."</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { sb.Append(<span class="hljs-string"><span class="hljs-string">'$'</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> sb.ToString(); }</code> </pre> <br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PVS-Studio警告</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">V3137</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">分配了“剩余”变量，但在功能结束时未使用该变量。 RegexRunner.cs 612 </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">将值</font><font style="vertical-align: inherit;">写入</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">剩余</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">的</font><font style="vertical-align: inherit;">局部变量</font><font style="vertical-align: inherit;">，但是直到方法结束之前不再使用它。也许删除了一些使用它的代码，但他们忘记了变量本身。或者这是一个更严重的错误，应该以某种方式使用此变量。</font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第61期</font></font></b> <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">AddRange</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> first, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> last</span></span></span><span class="hljs-function">)</span></span> { _rangelist.Add(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SingleRange(first, last)); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (_canonical &amp;&amp; _rangelist.Count &gt; <span class="hljs-number"><span class="hljs-number">0</span></span> &amp;&amp; first &lt;= _rangelist[_rangelist.Count - <span class="hljs-number"><span class="hljs-number">1</span></span>].Last) { _canonical = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } }</code> </pre> <br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PVS-Studio </font></font></b><font style="vertical-align: inherit;"></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">警告</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;">V3063</font></a><font style="vertical-align: inherit;">如果条件表达式的一部分被评估</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，则该部分</font><font style="vertical-align: inherit;">始终为</font><i><font style="vertical-align: inherit;">true</font></i><font style="vertical-align: inherit;">：_rangelist.Count&gt;0。RegexCharClass.cs 523 </font><font style="vertical-align: inherit;">分析器正确地指出，</font><font style="vertical-align: inherit;">如果该条件表达式</font><font style="vertical-align: inherit;">的一部分</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">-_rangelist.Count&gt; 0-</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">如果</font><font style="vertical-align: inherit;">该部分</font><font style="vertical-align: inherit;">始终为</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">true</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">此代码将被执行。即使</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">_rangelist</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">指向的列表</font><font style="vertical-align: inherit;">为空，在添加元素</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">_rangelist.Add（....）之后</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，也不会再这样了。</font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">发行第62期</font></font></b> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">让我们看一下</font><i><font style="vertical-align: inherit;">System.Drawing.Common</font></i><font style="vertical-align: inherit;">和</font><i><font style="vertical-align: inherit;">System.Transactions.Local</font></i><font style="vertical-align: inherit;">项目中</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">V3128</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">诊断规则的触发</font><font style="vertical-align: inherit;">。</font></font><i><font style="vertical-align: inherit;"></font></i><font style="vertical-align: inherit;"></font><i><font style="vertical-align: inherit;"></font></i><font style="vertical-align: inherit;"></font><br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">ArrayEnumerator</span></span> : <span class="hljs-title"><span class="hljs-title">IEnumerator</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">object</span></span>[] _array; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> _item; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> _index; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> _startIndex; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> _endIndex; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ArrayEnumerator</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">object</span></span></span></span><span class="hljs-function"><span class="hljs-params">[] array, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> startIndex, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> count</span></span></span><span class="hljs-function">)</span></span> { _array = array; _startIndex = startIndex; _endIndex = _index + count; _index = _startIndex; } .... }</code> </pre> <br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PVS-Studio警告</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">V3128</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">在构造函数中初始化“ _index”字段之前，</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;">请先使用</font></a><font style="vertical-align: inherit;">该字段。 1679个PrinterSettings.Windows.cs </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">当初始化场</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">_endIndex</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">使用其它字段- </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">_index</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，其在使用时具有标准值- </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">默认（INT）</font><font style="vertical-align: inherit;">，</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">即</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">0</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">_index</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">字段下方</font><font style="vertical-align: inherit;">已被初始化。如果突然这不是错误，则</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">_index</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">变量</font><font style="vertical-align: inherit;">应在此表达式中省略，以免造成混淆。</font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第63期</font></font></b> <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">internal</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">TransactionTable</span></span> { .... <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> _timerInterval; .... <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">internal</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">TransactionTable</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-comment"><span class="hljs-comment">// Create a timer that is initially disabled by specifing // an Infinite time to the first interval _timer = new Timer(new TimerCallback(ThreadTimer), null, Timeout.Infinite, _timerInterval); .... // Store the timer interval _timerInterval = 1 &lt;&lt; TransactionTable.timerInternalExponent; .... } }</span></span></code> </pre> <br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PVS-Studio警告</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">V3128</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">在构造函数中初始化“ _timerInterval”字段之前，</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;">请先使用</font></a><font style="vertical-align: inherit;">该字段。</font><font style="vertical-align: inherit;">TransactionTable.cs 151 </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">情况与上述类似。</font><font style="vertical-align: inherit;">首先，使用</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">_timerInterval</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">字段的值</font><font style="vertical-align: inherit;">（尽管它仍然等于</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">默认值（int）</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">）来初始化</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">_timer</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，然后才初始化</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">_timerInterval</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">字段</font><i><font style="vertical-align: inherit;">本身</font></i><font style="vertical-align: inherit;">。</font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第64版</font></font></b> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，仍然在开发中的诊断规则收到以下警告。</font><font style="vertical-align: inherit;">他还没有文档和最终报告，但在他的帮助下，他已经设法找到了几个有趣的地方。</font><font style="vertical-align: inherit;">同样，这些地方看起来像</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">复制粘贴</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ，因此我们将只考虑一段代码。 </font></font><br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ProcessNotifyConnection</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">....</span></span></span><span class="hljs-function">)</span></span> { .... WeakReference reference = (WeakReference)( LdapConnection.s_handleTable[referralFromConnection]); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( reference != <span class="hljs-literal"><span class="hljs-literal">null</span></span> &amp;&amp; reference.IsAlive &amp;&amp; <span class="hljs-literal"><span class="hljs-literal">null</span></span> != ((LdapConnection)reference.Target)._ldapHandle) { .... } .... }</code> </pre> <br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PVS-Studio警告（桩）</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">：VXXXX TODO_MESSAGE。 LdapSessionOptions.cs 974 </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">此处的危险是，如果在检查了</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">reference.IsAlive</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">后</font><font style="vertical-align: inherit;">执行了垃圾回收，并且</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">WeakReference引用</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">的对象位于其下</font><font style="vertical-align: inherit;">，则</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">reference.Target</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">将返回</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">null</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。结果，当访问实例字段</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">_ldapHandle时，</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">将</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">抛出NullReferenceException</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">类型的</font><i><font style="vertical-align: inherit;">异常</font></i><font style="vertical-align: inherit;">。实际上，Microsoft本身也会通过验证IsAlive警告此陷阱。引用docs.microsoft.com-“ </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">WeakReference.IsAlive属性</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ”：</font></font><i>Because an object could potentially be reclaimed for garbage collection immediately after the IsAlive property returns true, using this property is not recommended unless you are testing only for a false return value.</i> <br><br><h2>     </h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">分析是否找到了所有这些错误和有趣的地方？当然不是！开始查看分析结果后，我仔细查看了警告。随着他们数量的增加，并且很明显文章上会出现警告，我翻阅了结果，试图只选择对我来说最有趣的东西。当我到达最后一个日志（最大的日志）时，剩下的就是浏览所有警告，直到我的眼睛被异常的东西所吸引。因此，如果您深入研究它，我相信您可以找到更多有趣的地方。</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">例如，我忽略了几乎所有警告</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">V3022</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">和</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">V3063</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。相对而言，如果有以下形式的代码：</font></font><br><br><pre> <code class="cs hljs">String str = <span class="hljs-literal"><span class="hljs-literal">null</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (str == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) ....</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">我想念它，因为我想描述一些有趣的地方。使用不安全锁的触发器，该锁使用</font><font style="vertical-align: inherit;">带有</font><i><font style="vertical-align: inherit;">对此this</font></i><font style="vertical-align: inherit;">的锁</font><font style="vertical-align: inherit;">的</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">lock语句</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，等等。 - </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;">V3090</font></a><font style="vertical-align: inherit;"> ;不安全事件调用</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;">-V3083</font></a><font style="vertical-align: inherit;">；这些对象的类型实现</font><i><font style="vertical-align: inherit;">了IDisposable</font></i><font style="vertical-align: inherit;">，但对于没有呼叫</font><i><font style="vertical-align: inherit;">处置</font></i><font style="vertical-align: inherit;"> / </font><i><font style="vertical-align: inherit;">关闭</font></i><font style="vertical-align: inherit;"> - </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;">V3072</font></a><font style="vertical-align: inherit;">和类似的诊断;还有更多。</font></font><i><font style="vertical-align: inherit;"></font></i><font style="vertical-align: inherit;"></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"></font><i><font style="vertical-align: inherit;"></font></i><font style="vertical-align: inherit;"></font><i><font style="vertical-align: inherit;"></font></i><font style="vertical-align: inherit;"></font><i><font style="vertical-align: inherit;"></font></i><font style="vertical-align: inherit;"></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">我没有写出来（至少我尝试过，我偶然写了一些东西），但我发现测试中发现了问题。除了几个对我来说似乎很有趣的地方，它引起了我的注意。但是测试代码也可能包含错误，这就是为什么测试无法正常工作的原因。</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">总的来说，还有很多东西要学习，但是</font><font style="vertical-align: inherit;">我没有设定一个目标，那</font><font style="vertical-align: inherit;">就是</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">绝对</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">写出</font><i><font style="vertical-align: inherit;">所有发现的问题</font></i><font style="vertical-align: inherit;">。</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">代码的质量似乎参差不齐。有些项目非常干净，而另一些则包含可疑的地方。也许可以预期项目的纯度，特别是在最常用的库类的情况下。</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">如果概括一下，考虑到已经分析了大量的代码，我们可以说代码的质量很高。</font><font style="vertical-align: inherit;">但是，如下文所述，存在一些阴暗的角落。</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">顺便说一句，这个规模的项目对分析仪也是一个很好的测试。</font><font style="vertical-align: inherit;">我设法找到了一系列我选择检查和纠正的错误/奇怪的警告。</font><font style="vertical-align: inherit;">因此，作为分析的结果，我们设法找到了一些值得在PVS-Studio本身上工作的地方。</font></font><br><br><h2> 结论 </h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">如果您在阅读全文后到了这个地方，请让我握手！</font><font style="vertical-align: inherit;">希望我能够向您展示有趣的错误，并演示静态分析的好处。</font><font style="vertical-align: inherit;">如果您还为自己学习了一些新知识，可以使您编写更好的代码-我将倍加高兴。</font></font><br><br><p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/6ef/dbc/f2d/6efdbcf2d984bef000cf44face04c6a4.png" alt="图片24"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">无论如何，静态分析的帮助不会是多余的，因此我建议</font><font style="vertical-align: inherit;">您在项目上</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">尝试使用PVS-Studio</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，并查看可以从中找到哪些有趣的地方。</font><font style="vertical-align: inherit;">如果您有任何疑问，或者只是想分享发现的有趣地点，请随时发送电子邮件至</font></font><a href=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">support@viva64.com</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font> :) <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 祝一切顺利！ </font></font><br><br><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> PS与.NET Core库开发人员联系 </font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">非常感谢您所做的！</font><font style="vertical-align: inherit;">你是好人 </font><font style="vertical-align: inherit;">我希望本文有助于使代码更好。</font><font style="vertical-align: inherit;">请记住，我并没有写下文章中所有可疑的地方，最好是使用分析器独立检查项目-这样，您可以更详细地研究所有警告，比起简单的文本日志/错误列表，它会更方便工作（</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">我为此写了</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">更多</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;">内容在这里</font></a><font style="vertical-align: inherit;">）。</font></font><br><br><p> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><img src="https://habrastorage.org/getpro/habr/post_images/898/3b6/5a7/8983b65a74adb29a2113eba12fbec3f1.png" align="left"></a> </p><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">如果您想与讲英语的读者分享这篇文章，请使用以下链接：Sergey Vasiliev。</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">通过PVS-Studio静态分析器检查.NET Core库源代码</font></font></a> </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN463537/">https://habr.com/ru/post/zh-CN463537/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN463515/index.html">使用HTMS API来处理关系网络数据库</a></li>
<li><a href="../zh-CN463525/index.html">硒，硒化物，硒化物，硒化物……这是什么意思？</a></li>
<li><a href="../zh-CN463527/index.html">弹出！ 在iOS上转录</a></li>
<li><a href="../zh-CN463533/index.html">每个开发人员从一开始就应该知道什么</a></li>
<li><a href="../zh-CN463535/index.html">通过PVS-Studio静态分析器检查.NET Core库源代码</a></li>
<li><a href="../zh-CN463541/index.html">培训Cisco 200-125 CCNA v3.0。 第17天。CCNA课程摘要和路线图</a></li>
<li><a href="../zh-CN463551/index.html">如何与员工联系并组织大型IT公司的工作流程</a></li>
<li><a href="../zh-CN463553/index.html">“你是谷歌人吗？” 或我们录用时做的5件事（但不再）</a></li>
<li><a href="../zh-CN463559/index.html">培训Cisco 200-125 CCNA v3.0。 第18天。路由基础</a></li>
<li><a href="../zh-CN463563/index.html">培训Cisco 200-125 CCNA v3.0。 第19天。路由器入门</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>