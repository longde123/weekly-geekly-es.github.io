<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë± ü§úüèª üå± Como eu ensinei AI a jogar Tetris para NES. Parte 1: an√°lise do c√≥digo do jogo üë©üèø‚Äçüè≠ üèä üë®üèæ‚Äçüåæ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Neste artigo, explorarei a mec√¢nica enganosamente simples do Nintendo Tetris e, na segunda parte, explicarei como criei uma IA que explora essas mec√¢n...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Como eu ensinei AI a jogar Tetris para NES. Parte 1: an√°lise do c√≥digo do jogo</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/420725/">  Neste artigo, explorarei a mec√¢nica enganosamente simples do Nintendo Tetris e, na segunda parte, explicarei como criei uma IA que explora essas mec√¢nicas. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/48f/1a4/9b8/48f1a49b87860e6139e8d298e1fe6188.png"></div><br><h2>  Experimente voc√™ mesmo </h2><br><h3>  Sobre o projeto </h3><br>  Para aqueles que n√£o t√™m a perseveran√ßa, paci√™ncia e tempo necess√°rios para dominar o Nintendo Tetris, criei uma IA que pode jogar por conta pr√≥pria.  Voc√™ pode finalmente chegar ao n√≠vel 30 e ainda mais.  Voc√™ ver√° como obter o n√∫mero m√°ximo de pontos e observar√° a mudan√ßa intermin√°vel de contadores de linhas, n√≠veis e estat√≠sticas.  Voc√™ aprender√° quais cores aparecem em n√≠veis acima dos quais uma pessoa n√£o pode subir.  Veja at√© onde voc√™ pode ir. <br><a name="habracut"></a><br><h3>  Exig√™ncias </h3><br>  Para executar o AI, voc√™ precisa de um <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">emulador</a> universal NES / Famicom <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">FCEUX</a> .  A intelig√™ncia artificial foi desenvolvida para o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">FCEUX 2.2.2</a> , a vers√£o mais recente do emulador no momento da escrita. <br><br>  Voc√™ tamb√©m precisar√° do arquivo ROM do Nintendo Tetris (vers√£o dos EUA).  Tente pesquisar no <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Google</a> . <br><br><h3>  Baixar </h3><br>  Descompacte <code>lua/NintendoTetrisAI.lua</code> deste <a href="">arquivo zip de origem</a> . <br><br><h3>  Lan√ßamento </h3><br>  Inicie o FCEUX.  No menu, selecione Arquivo |  Abrir ROM ... Na caixa de di√°logo Abrir arquivo, selecione o arquivo ROM do Nintendo Tetris e clique em Abrir.  O jogo come√ßar√°. <br><br>  No menu, selecione Arquivo |  Lua |  Nova janela Lua Script ... Na janela Lua Script, digite o caminho para <code>NintendoTetrisAI.lua</code> ou clique no bot√£o Procurar para encontr√°-lo.  Depois disso, clique em Executar. <br><br>  O script em Lua o redirecionar√° para a primeira tela do menu.  Deixe o tipo de jogo A-Type e voc√™ pode escolher qualquer m√∫sica.  Em computadores lentos, a m√∫sica pode tocar muito rapidamente, ent√£o voc√™ deve deslig√°-la.  Pressione Iniciar (Enter) para ir para a pr√≥xima tela do menu.  No segundo menu, voc√™ pode usar as teclas de seta para alterar o n√≠vel inicial.  Clique em Iniciar para iniciar o jogo.  E aqui a IA assumir√° o controle. <br><br>  Se depois de selecionar um n√≠vel na segunda tela do menu, mantenha pressionado o bot√£o A do gamepad (voc√™ pode alterar o layout do teclado no menu Config | Entrada ...) e pressione Iniciar, ent√£o o n√≠vel inicial ser√° 10 a mais que o valor selecionado.  O n√≠vel m√°ximo de entrada √© d√©cimo nono. <br><br><h3>  Configura√ß√£o </h3><br>  Para acelerar o jogo, abra o script Lua em um editor de texto.  No in√≠cio do arquivo, encontre a seguinte linha. <br><br> <code>PLAY_FAST = false</code> <br> <br>  Substitua <code>false</code> por <code>true</code> como mostrado abaixo. <br><br> <code>PLAY_FAST = true</code> <br> <br>  Salve o arquivo.  Em seguida, clique no bot√£o Reiniciar na janela Lua Script. <br><br><h2>  Nintendo Tetris Mechanics </h2><br><h3>  Descri√ß√£o de Tetrimino </h3><br>  Cada figura tetrimino corresponde a um nome de uma letra que se assemelha √† sua forma. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/975/440/5ed/9754405ed7b3d83a47181edef3de6913.png"></div><br>  Os designers do Nintendo Tetris definem arbitrariamente a ordem do tetrimino mostrada acima.  As figuras s√£o mostradas na orienta√ß√£o em que aparecem na tela, e o circuito cria uma imagem quase sim√©trica (talvez seja por isso que essa ordem foi escolhida).  O √≠ndice de sequ√™ncia fornece a cada tetrimino um ID num√©rico √∫nico.  Identificadores de sequ√™ncia e tipo s√£o importantes no n√≠vel de programa√ß√£o;  al√©m disso, eles se manifestam na ordem das figuras exibidas no campo de estat√≠sticas (veja abaixo). <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/dc2/35d/778/dc235d778c47654e1abbc5896581fd6a.png"></div><br>  As 19 orienta√ß√µes usadas no Nintendo Tetris tetrimino s√£o codificadas em uma tabela localizada em <code>$8A9C</code> da mem√≥ria do console NES.  Cada figura √© representada como uma sequ√™ncia de 12 bytes que pode ser dividida em triplos <code>(Y, tile, X)</code> que descrevem cada quadrado da figura.  Os valores hexadecimais acima das coordenadas acima de <code>$7F</code> indicam n√∫meros inteiros negativos ( <code>$FF= ‚àí1</code> e <code>$FE = ‚àí2</code> ). <br><br> <code>; Y0 T0 X0 Y1 T1 X1 Y2 T2 X2 Y3 T3 X3 <br> <br> 8A9C: 00 7B FF 00 7B 00 00 7B 01 FF 7B 00 ; 00: T up <br> 8AA8: FF 7B 00 00 7B 00 00 7B 01 01 7B 00 ; 01: T right <br> 8AB4: 00 7B FF 00 7B 00 00 7B 01 01 7B 00 ; 02: T down (spawn) <br> 8AC0: FF 7B 00 00 7B FF 00 7B 00 01 7B 00 ; 03: T left <br> <br> 8ACC: FF 7D 00 00 7D 00 01 7D FF 01 7D 00 ; 04: J left <br> 8AD8: FF 7D FF 00 7D FF 00 7D 00 00 7D 01 ; 05: J up <br> 8AE4: FF 7D 00 FF 7D 01 00 7D 00 01 7D 00 ; 06: J right <br> 8AF0: 00 7D FF 00 7D 00 00 7D 01 01 7D 01 ; 07: J down (spawn) <br> <br> 8AFC: 00 7C FF 00 7C 00 01 7C 00 01 7C 01 ; 08: Z horizontal (spawn) <br> 8B08: FF 7C 01 00 7C 00 00 7C 01 01 7C 00 ; 09: Z vertical <br> <br> 8B14: 00 7B FF 00 7B 00 01 7B FF 01 7B 00 ; 0A: O (spawn) <br> <br> 8B20: 00 7D 00 00 7D 01 01 7D FF 01 7D 00 ; 0B: S horizontal (spawn) <br> 8B2C: FF 7D 00 00 7D 00 00 7D 01 01 7D 01 ; 0C: S vertical <br> <br> 8B38: FF 7C 00 00 7C 00 01 7C 00 01 7C 01 ; 0D: L right <br> 8B44: 00 7C FF 00 7C 00 00 7C 01 01 7C FF ; 0E: L down (spawn) <br> 8B50: FF 7C FF FF 7C 00 00 7C 00 01 7C 00 ; 0F: L left <br> 8B5C: FF 7C 01 00 7C FF 00 7C 00 00 7C 01 ; 10: L up <br> <br> 8B68: FE 7B 00 FF 7B 00 00 7B 00 01 7B 00 ; 11: I vertical <br> 8B74: 00 7B FE 00 7B FF 00 7B 00 00 7B 01 ; 12: I horizontal (spawn) <br> <br> 8B80: 00 FF 00 00 FF 00 00 FF 00 00 FF 00 ; 13: Unused</code> <br> <br>  Na parte inferior da tabela, h√° um registro n√£o utilizado, potencialmente dando a oportunidade de adicionar outra orienta√ß√£o.  No entanto, em v√°rias partes do c√≥digo, <code>$13</code> indica que o identificador de orienta√ß√£o do tetrimino ativo n√£o recebe um valor. <br><br>  Para facilitar a leitura, as coordenadas dos quadrados em decimal s√£o mostradas abaixo. <br><br> <code>-- { { X0, Y0 }, { X1, Y1 }, { X2, Y2 }, { X3, Y3 }, }, <br> <br> { { -1, 0 }, { 0, 0 }, { 1, 0 }, { 0, -1 }, }, -- 00: T up <br> { { 0, -1 }, { 0, 0 }, { 1, 0 }, { 0, 1 }, }, -- 01: T right <br> { { -1, 0 }, { 0, 0 }, { 1, 0 }, { 0, 1 }, }, -- 02: T down (spawn) <br> { { 0, -1 }, { -1, 0 }, { 0, 0 }, { 0, 1 }, }, -- 03: T left <br> <br> { { 0, -1 }, { 0, 0 }, { -1, 1 }, { 0, 1 }, }, -- 04: J left <br> { { -1, -1 }, { -1, 0 }, { 0, 0 }, { 1, 0 }, }, -- 05: J up <br> { { 0, -1 }, { 1, -1 }, { 0, 0 }, { 0, 1 }, }, -- 06: J right <br> { { -1, 0 }, { 0, 0 }, { 1, 0 }, { 1, 1 }, }, -- 07: J down (spawn) <br> <br> { { -1, 0 }, { 0, 0 }, { 0, 1 }, { 1, 1 }, }, -- 08: Z horizontal (spawn) <br> { { 1, -1 }, { 0, 0 }, { 1, 0 }, { 0, 1 }, }, -- 09: Z vertical <br> <br> { { -1, 0 }, { 0, 0 }, { -1, 1 }, { 0, 1 }, }, -- 0A: O (spawn) <br> <br> { { 0, 0 }, { 1, 0 }, { -1, 1 }, { 0, 1 }, }, -- 0B: S horizontal (spawn) <br> { { 0, -1 }, { 0, 0 }, { 1, 0 }, { 1, 1 }, }, -- 0C: S vertical <br> <br> { { 0, -1 }, { 0, 0 }, { 0, 1 }, { 1, 1 }, }, -- 0D: L right <br> { { -1, 0 }, { 0, 0 }, { 1, 0 }, { -1, 1 }, }, -- 0E: L down (spawn) <br> { { -1, -1 }, { 0, -1 }, { 0, 0 }, { 0, 1 }, }, -- 0F: L left <br> { { 1, -1 }, { -1, 0 }, { 0, 0 }, { 1, 0 }, }, -- 10: L up <br> <br> { { 0, -2 }, { 0, -1 }, { 0, 0 }, { 0, 1 }, }, -- 11: I vertical <br> { { -2, 0 }, { -1, 0 }, { 0, 0 }, { 1, 0 }, }, -- 12: I horizontal (spawn)</code> <br> <br>  Todas as orienta√ß√µes s√£o colocadas em uma matriz 5 √ó 5. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/8ca/435/322/8ca435322ee85d07cc631640c11a9aee.png"></div><br>  Na figura acima, o quadrado branco indica o centro da matriz, o ponto de refer√™ncia para a rota√ß√£o da figura. <br><br>  A tabela de orienta√ß√£o √© apresentada graficamente abaixo. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/b18/4e0/f0e/b184e0f0ea182222b58d151c09217567.png"></div><br>  O identificador de orienta√ß√£o (√≠ndice da tabela) √© mostrado em hexadecimal no canto superior direito de cada matriz.  E os mnem√¥nicos inventados para este projeto s√£o mostrados no canto superior esquerdo.  <code>u</code> , <code>r</code> , <code>d</code> , <code>l</code> , <code>h</code> <code>v</code> s√£o abrevia√ß√µes de ‚Äúcima, direita, baixo, esquerda, horizontal e vertical‚Äù.  Por exemplo, √© mais f√°cil denotar a orienta√ß√£o de <code>Jd</code> do que <code>$07</code> . <br><br>  Matrizes contendo as orienta√ß√µes das figuras durante a cria√ß√£o s√£o marcadas com uma moldura branca. <br><br>  Tetrimino I, S e Z podem receber quatro orienta√ß√µes separadas, mas os criadores do Nintendo Tetris decidiram se limitar a dois.  Al√©m disso, <code>Zv</code> e <code>Sv</code> n√£o s√£o imagens espelhadas ideais um do outro.  Ambos s√£o criados girando no sentido anti-hor√°rio, o que leva a um desequil√≠brio. <br><br>  A tabela de orienta√ß√£o tamb√©m cont√©m valores de bloco para cada quadrado em cada figura orientada.  No entanto, com um estudo cuidadoso, fica claro que os valores para um tipo de tetrimino s√£o sempre os mesmos. <br><br><div class="scrollable-table"><table><tbody><tr><th>  T </th><th>  J </th><th>  Z </th><th>  O </th><th>  S </th><th>  L </th><th>  Eu </th></tr><tr><td> <code>7B</code> </td> <td> <code>7D</code> </td> <td> <code>7C</code> </td> <td> <code>7B</code> </td> <td> <code>7D</code> </td> <td> <code>7C</code> </td> <td> <code>7B</code> </td> </tr></tbody></table></div><br>  Os valores do bloco s√£o os √≠ndices da tabela (pseudo-cor) do padr√£o mostrado abaixo. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/e00/97a/713/e0097a713f629afaf73936d3192820e3.png"></div><br>  Os blocos de <code>$7D</code> <code>$7C</code> , <code>$7C</code> e <code>$7D</code> est√£o localizados diretamente abaixo de "ATIS" da palavra "ESTAT√çSTICAS".  Estes s√£o os tr√™s tipos de quadrados dos quais o tetrimino √© feito. <br><br>  Para os curiosos, direi que avestruzes e ping√ºins s√£o usados ‚Äã‚Äãno final do modo B-Type.  Este t√≥pico √© discutido em detalhes na se√ß√£o "Finaliza√ß√£o". <br><br>  Abaixo est√° o resultado da modifica√ß√£o da ROM ap√≥s a substitui√ß√£o de <code>$7B</code> por <code>$29</code> .  O cora√ß√£o √© o ladrilho sob o s√≠mbolo P na tabela de padr√µes para todas as orienta√ß√µes T. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/5fa/551/215/5fa55121523b443f8f3b6daa2bd46ad8.png"></div><br>  As pe√ßas do cora√ß√£o permanecem no campo de jogo mesmo depois que os Ts modificados s√£o travados no lugar.  Conforme indicado abaixo na se√ß√£o "Criando Tetrimino", isso significa que o campo de jogo armazena os valores reais dos √≠ndices de pe√ßas do Tetrimino jogado. <br><br>  Os programadores de jogos tornaram poss√≠vel o uso de 4 pe√ßas separadas para cada figura, e n√£o apenas um tipo de quadrados invari√°vel.  Este √© um recurso √∫til que pode ser usado para modificar a apar√™ncia do jogo.  A tabela de padr√µes possui muito espa√ßo vazio para novos ladrilhos que podem dar a cada tetrimino uma apar√™ncia √∫nica. <br><br>  As coordenadas dos quadrados s√£o muito f√°ceis de manipular.  Por exemplo, uma vers√£o modificada dos quatro primeiros triplos na tabela de orienta√ß√£o √© mostrada abaixo. <br><br> <code>8A9C: FE 7B FE FE 7B 02 02 7B FE 02 7B 02 ; 00: T up</code> <br> <br>  Essa altera√ß√£o √© semelhante √† seguinte: <br><br> <code>{ { -2, -2 }, { 2, -2 }, { -2, 2 }, { 2, 2 }, }, -- 00: T up</code> <br> <br>  O resultado √© um tetrimino dividido. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/3a6/ab5/86d/3a6ab586d06a57b92208bd612b755109.png"></div><br>  Ao mover um tetrimino dividido, seus quadrados n√£o podem ir al√©m dos limites do campo de jogo e n√£o podem passar por figuras previamente bloqueadas no local.  Al√©m disso, o jogo pro√≠be a rota√ß√£o nessa orienta√ß√£o se levar a um quadrado que caia fora dos limites do campo de jogo ou ao fato de o quadrado se sobrepor a um quadrado que j√° esteja. <br><br>  O tetrimino dividido √© travado no lugar quando h√° suporte para qualquer um de seus quadrados.  Se a figura estiver bloqueada, os quadrados suspensos no ar continuam pendurados. <br><br>  O jogo lida com tetriminos divididos como qualquer figura normal.  Isso nos faz entender que n√£o h√° tabela adicional armazenando os metadados das figuras.  Por exemplo, poderia haver uma tabela armazenando o tamanho da caixa delimitadora de cada orienta√ß√£o para verificar colis√µes com o per√≠metro do campo de jogo.  Mas essa tabela n√£o √© usada.  Em vez disso, o jogo simplesmente verifica todos os quatro quadrados antes de manipular a forma. <br><br>  Al√©m disso, as coordenadas dos quadrados podem ser quaisquer valores;  eles n√£o est√£o limitados ao intervalo <code>[‚àí2, 2]</code> .  Obviamente, valores que excedem muito esse intervalo nos fornecer√£o n√∫meros inaplic√°veis ‚Äã‚Äãque n√£o cabem no campo de jogo.  Mais importante, como declarado na se√ß√£o ‚ÄúEstados do jogo e modos de renderiza√ß√£o‚Äù, quando uma figura est√° travada no lugar, o mecanismo de limpeza de linhas preenchidas varre apenas os deslocamentos das linhas de -2 a 1 do quadrado central da figura;  um quadrado com uma coordenada <code>y</code> fora desse intervalo n√£o ser√° reconhecido. <br><br><h3>  Rota√ß√£o Tetrimino </h3><br>  Em uma ilustra√ß√£o gr√°fica da tabela de orienta√ß√£o, a rota√ß√£o consiste em mover de uma matriz para uma das matrizes √† esquerda ou √† direita com a transfer√™ncia da s√©rie, se necess√°rio.  Esse conceito √© codificado em uma tabela de <code>$88EE</code> . <br><br> <code>; CCW CW <br> 88EE: 03 01 ; Tl Tr <br> 88F0: 00 02 ; Tu Td <br> 88F2: 01 03 ; Tr Tl <br> 88F4: 02 00 ; Td Tu <br> 88F6: 07 05 ; Jd Ju <br> 88F8: 04 06 ; Jl Jr <br> 88FA: 05 07 ; Ju Jd <br> 88FC: 06 04 ; Jr Jl <br> 88FE: 09 09 ; Zv Zv <br> 8900: 08 08 ; Zh Zh <br> 8902: 0A 0A ; OO <br> 8904: 0C 0C ; Sv Sv <br> 8906: 0B 0B ; Sh Sh <br> 8908: 10 0E ; Lu Ld <br> 890A: 0D 0F ; Lr Ll <br> 890C: 0E 10 ; Ld Lu <br> 890E: 0F 0D ; Ll Lr <br> 8910: 12 12 ; Ih Ih <br> 8912: 11 11 ; Iv Iv</code> <br> <br>  Para tornar mais claro, moveremos cada coluna desta tabela para a linha da tabela abaixo. <br><div class="scrollable-table"><table><tbody><tr><th></th><th> <code>Tu</code> </th> <th> <code>Tr</code> </th> <th> <code>Td</code> </th> <th> <code>Tl</code> </th> <th> <code>Jl</code> </th> <th> <code>Ju</code> </th> <th> <code>Jr</code> </th> <th> <code>Jd</code> </th> <th> <code>Zh</code> </th> <th> <code>Zv</code> </th> <th> <code>O</code> </th> <th> <code>Sh</code> </th> <th> <code>Sv</code> </th> <th> <code>Lr</code> </th> <th> <code>Ld</code> </th> <th> <code>Ll</code> </th> <th> <code>Lu</code> </th> <th> <code>Iv</code> </th> <th> <code>Ih</code> </th> </tr><tr><th>  Sentido anti-hor√°rio </th><td> <code>Tl</code> </td> <td> <code>Tu</code> </td> <td> <code>Tr</code> </td> <td> <code>Td</code> </td> <td> <code>Jd</code> </td> <td> <code>Jl</code> </td> <td> <code>Ju</code> </td> <td> <code>Jr</code> </td> <td> <code>Zv</code> </td> <td> <code>Zh</code> </td> <td> <code>O</code> </td> <td> <code>Sv</code> </td> <td> <code>Sh</code> </td> <td> <code>Lu</code> </td> <td> <code>Lr</code> </td> <td> <code>Ld</code> </td> <td> <code>Ll</code> </td> <td> <code>Ih</code> </td> <td> <code>Iv</code> </td> </tr><tr><th>  No sentido hor√°rio </th><td> <code>Tr</code> </td> <td> <code>Td</code> </td> <td> <code>Tl</code> </td> <td> <code>Tu</code> </td> <td> <code>Ju</code> </td> <td> <code>Jr</code> </td> <td> <code>Jd</code> </td> <td> <code>Jl</code> </td> <td> <code>Zv</code> </td> <td> <code>Zh</code> </td> <td> <code>O</code> </td> <td> <code>Sv</code> </td> <td> <code>Sh</code> </td> <td> <code>Ld</code> </td> <td> <code>Ll</code> </td> <td> <code>Lu</code> </td> <td> <code>Lr</code> </td> <td> <code>Ih</code> </td> <td> <code>Iv</code> </td> </tr></tbody></table></div><br>  Os mnem√¥nicos nos t√≠tulos acima podem ser interpretados como um √≠ndice de sequ√™ncia ou chave de distribui√ß√£o.  Por exemplo, girar <code>Tu</code> sentido anti-hor√°rio fornece <code>Tl</code> e girar <code>Tu</code> no sentido hor√°rio d√° <code>Tr</code> . <br><br>  A tabela de rota√ß√£o codifica sequ√™ncias encadeadas em cadeia de IDs de orienta√ß√£o;  portanto, podemos modificar as grava√ß√µes para que a rota√ß√£o transforme um tipo de tetrimino em outro.  Essa t√©cnica pode potencialmente ser usada para tirar proveito de uma linha n√£o utilizada na tabela de orienta√ß√£o. <br><br>  Na frente da tabela de rota√ß√£o h√° um c√≥digo para acess√°-lo. <br><br> <code>88AB: LDA $0042 <br> 88AD: STA $00AE ; originalOrientationID = orientationID; <br> <br> 88AF: CLC <br> 88B0: LDA $0042 <br> 88B2: ASL <br> 88B3: TAX ; index = 2 * orientationID; <br> <br> 88B4: LDA $00B5 <br> 88B6: AND #$80 ; if (not just pressed button A) { <br> 88B8: CMP #$80 ; goto aNotPressed; <br> 88BA: BNE $88CF ; } <br> <br> 88BC: INX <br> 88BD: LDA $88EE,X <br> 88C0: STA $0042 ; orientationID = rotationTable[index + 1]; <br> <br> 88C2: JSR $948B ; if (new orientation not valid) { <br> 88C5: BNE $88E9 ; goto restoreOrientationID; <br> ; } <br> <br> 88C7: LDA #$05 <br> 88C9: STA $06F1 ; play rotation sound effect; <br> 88CC: JMP $88ED ; return; <br> <br> aNotPressed: <br> <br> 88CF: LDA $00B5 <br> 88D1: AND #$40 ; if (not just pressed button B) { <br> 88D3: CMP #$40 ; return; <br> 88D5: BNE $88ED ; } <br> <br> 88D7: LDA $88EE,X <br> 88DA: STA $0042 ; orientationID = rotationTable[index]; <br> <br> 88DC: JSR $948B ; if (new orientation not valid) { <br> 88DF: BNE $88E9 ; goto restoreOrientationID; <br> ; } <br> <br> 88E1: LDA #$05 <br> 88E3: STA $06F1 ; play rotation sound effect; <br> 88E6: JMP $88ED ; return; <br> <br> restoreOrientationID: <br> <br> 88E9: LDA $00AE <br> 88EB: STA $0042 ; orientationID = originalOrientationID; <br> <br> 88ED: RTS ; return;</code> <br> <br>  Para rota√ß√£o no sentido anti-hor√°rio, o √≠ndice da tabela de rota√ß√£o √© subtra√≠do dobrando o ID da orienta√ß√£o.  Ao adicionar 1, obtemos o √≠ndice de rota√ß√£o no sentido hor√°rio. <br><br>  As coordenadas <code>x</code> , <code>y</code> e o ID da orienta√ß√£o do tetrimino atual s√£o armazenados nos endere√ßos <code>$0040</code> , <code>$0041</code> e <code>$0042</code> respectivamente. <br><br>  O c√≥digo usa uma vari√°vel tempor√°ria para fazer backup do ID da orienta√ß√£o.  Posteriormente, ap√≥s alterar a orienta√ß√£o, o c√≥digo verifica se todos os quatro quadrados est√£o dentro dos limites do campo de jogo e que nenhum deles se sobrep√µe aos quadrados j√° existentes (o c√≥digo de verifica√ß√£o est√° localizado em <code>$948B</code> , no fragmento de c√≥digo mostrado acima).  Se a nova orienta√ß√£o estiver incorreta, a original ser√° restaurada, n√£o permitindo que o reprodutor gire a figura. <br><br>  Contando com uma cruz, o controlador NES possui oito bot√µes, cujo status √© representado pelo bit de endere√ßo <code>$00B6</code> . <br><br><div class="scrollable-table"><table><tbody><tr><th> <code>7</code> </th> <th> <code>6</code> </th> <th> <code>5</code> </th> <th> <code>4</code> </th> <th> <code>3</code> </th> <th> <code>2</code> </th> <th> <code>1</code> </th> <th> <code>0</code> </th> </tr><tr><td>  Um </td><td>  B </td><td>  Selecione </td><td>  Iniciar </td><td>  Para cima </td><td>  Para baixo </td><td>  Para a esquerda </td><td>  Para a direita </td></tr></tbody></table></div><br>  Por exemplo, <code>$00B6</code> conter√° o valor <code>$81</code> enquanto o jogador segura A e Esquerda. <br><br>  Por outro lado, <code>$00B5</code> informa quando os bot√µes foram pressionados;  os bits <code>$00B5</code> s√£o verdadeiros apenas durante uma itera√ß√£o do loop do jogo (1 quadro renderizado).  O c√≥digo usa <code>$00B5</code> para responder a pressionar A e B. Cada um deles precisa ser liberado antes de ser usado novamente. <br><br>  <code>$00B5</code> e <code>$00B6</code> s√£o espelhos de <code>$00F5</code> e <code>$00F6</code> .  O c√≥digo nas se√ß√µes a seguir usa esses endere√ßos de forma intercambi√°vel. <br><br><h3>  Criar Tetrimino </h3><br>  O campo de jogo do Nintendo Tetris consiste em uma matriz com 22 linhas e 10 colunas, para que as duas primeiras linhas fiquem ocultas do jogador. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/6e1/0dc/33b/6e10dc33b40eaa5dec35bc6e7bf42c5f.png"></div><br>  Como mostrado no c√≥digo abaixo, ao criar uma figura do Tetrimino, ela sempre est√° localizada nas coordenadas <code>(5, 0)</code> campo de jogo. <br><br> <code>98BA: LDA #$00 <br> 98BC: STA $00A4 <br> 98BE: STA $0045 <br> 98C0: STA $0041 ; Tetrimino Y = 0 <br> 98C2: LDA #$01 <br> 98C4: STA $0048 <br> 98C6: LDA #$05 <br> 98C8: STA $0040 ; Tetrimino X = 5</code> <br> <br>  Abaixo est√° uma matriz 5 √ó 5 sobreposta neste ponto. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/fcf/d3b/d94/fcfd3bd94514779d6e967770a1f216cb.png"></div><br>  Nenhuma das matrizes de cria√ß√£o possui quadrados acima do ponto de partida.  Ou seja, ao criar um tetrimino, todos os quatro quadrados imediatamente se tornam vis√≠veis para o jogador.  No entanto, se o jogador girar rapidamente a pe√ßa antes que ela tenha tempo de cair, parte da pe√ßa ficar√° temporariamente oculta nas duas primeiras linhas do campo de jogo. <br><br>  Geralmente pensamos que o jogo termina quando o heap chega ao topo.  Mas, de fato, isso n√£o √© inteiramente verdade.  O jogo termina quando n√£o √© mais poss√≠vel criar a pr√≥xima pe√ßa.  Ou seja, antes do aparecimento da figura, todas as quatro c√©lulas do campo de jogo correspondentes √†s posi√ß√µes dos quadrados do tetrimino criado devem estar livres.  A figura pode ser travada no lugar de maneira que parte de seus quadrados apare√ßa em linhas numeradas negativamente, e o jogo n√£o termine;  no entanto, no Nintendo Tetris, as linhas negativas s√£o uma abstra√ß√£o relacionada apenas ao tetrimino ativo.  Depois que a figura √© bloqueada (fica mentindo), apenas quadrados em linhas de zero e mais s√£o gravados no campo.  Conceitualmente, as linhas numeradas negativamente s√£o automaticamente limpas ap√≥s o bloqueio.  Mas, na realidade, o jogo simplesmente n√£o armazena esses dados, cortando as partes superiores das figuras. <br><br>  A √°rea vis√≠vel do campo de jogo 20 √ó 10 √© armazenada em <code>$0400</code> linha por linha, cada byte cont√©m o valor do bloco de plano de fundo.  As c√©lulas vazias s√£o indicadas pelo bloco <code>$EF</code> , um quadrado preto s√≥lido. <br><br>  Ao criar uma forma, tr√™s tabelas de pesquisa s√£o usadas.  Se houver um ID de orienta√ß√£o arbitr√°rio, a tabela em <code>$9956</code> nos fornecer√° o ID de orienta√ß√£o ao criar o tipo correspondente de tetrimino. <br><br> <code>9956: 02 02 02 02 ; Td <br> 995A: 07 07 07 07 ; Jd <br> 995E: 08 08 ; Zh <br> 9960: 0A ; O <br> 9961: 0B 0B ; Sh <br> 9963: 0E 0E 0E 0E ; Ld <br> 9967: 12 12 ; Ih</code> <br> <br>  √â mais f√°cil mostrar isso na tabela. <br><br><div class="scrollable-table"><table><tbody><tr><th> <code>Tu</code> </th> <th> <code>Tr</code> </th> <th> <code>Td</code> </th> <th> <code>Tl</code> </th> <th> <code>Jl</code> </th> <th> <code>Ju</code> </th> <th> <code>Jr</code> </th> <th> <code>Jd</code> </th> <th> <code>Zh</code> </th> <th> <code>Zv</code> </th> <th> <code>O</code> </th> <th> <code>Sh</code> </th> <th> <code>Sv</code> </th> <th> <code>Lr</code> </th> <th> <code>Ld</code> </th> <th> <code>Ll</code> </th> <th> <code>Lu</code> </th> <th> <code>Iv</code> </th> <th> <code>Ih</code> </th> </tr><tr><td> <code>Td</code> </td> <td> <code>Td</code> </td> <td> <code>Td</code> </td> <td> <code>Td</code> </td> <td> <code>Jd</code> </td> <td> <code>Jd</code> </td> <td> <code>Jd</code> </td> <td> <code>Jd</code> </td> <td> <code>Zh</code> </td> <td> <code>Zh</code> </td> <td> <code>O</code> </td> <td> <code>Sh</code> </td> <td> <code>Sh</code> </td> <td> <code>Ld</code> </td> <td> <code>Ld</code> </td> <td> <code>Ld</code> </td> <td> <code>Ld</code> </td> <td> <code>Ih</code> </td> <td> <code>Ih</code> </td> </tr></tbody></table></div><br>  Por exemplo, todas as orienta√ß√µes de J s√£o anexadas a <code>Jd</code> . <br><br>  A tabela em <code>$993B</code> cont√©m o tipo de Tetrimino para o ID de orienta√ß√£o fornecido. <br><br> <code>993B: 00 00 00 00 ; T <br> 993F: 01 01 01 01 ; J <br> 9943: 02 02 ; Z <br> 9945: 03 ; O <br> 9946: 04 04 ; S <br> 9948: 05 05 05 05 ; L <br> 994C: 06 06 ; I</code> <br> <br>  Para maior clareza, mostrarei tudo de forma tabular. <br><br><div class="scrollable-table"><table><tbody><tr><th> <code>Tu</code> </th> <th> <code>Tr</code> </th> <th> <code>Td</code> </th> <th> <code>Tl</code> </th> <th> <code>Jl</code> </th> <th> <code>Ju</code> </th> <th> <code>Jr</code> </th> <th> <code>Jd</code> </th> <th> <code>Zh</code> </th> <th> <code>Zv</code> </th> <th> <code>O</code> </th> <th> <code>Sh</code> </th> <th> <code>Sv</code> </th> <th> <code>Lr</code> </th> <th> <code>Ld</code> </th> <th> <code>Ll</code> </th> <th> <code>Lu</code> </th> <th> <code>Iv</code> </th> <th> <code>Ih</code> </th> </tr><tr><td> <code>T</code> </td> <td> <code>T</code> </td> <td> <code>T</code> </td> <td> <code>T</code> </td> <td> <code>J</code> </td> <td> <code>J</code> </td> <td> <code>J</code> </td> <td> <code>J</code> </td> <td> <code>Z</code> </td> <td> <code>Z</code> </td> <td> <code>O</code> </td> <td> <code>S</code> </td> <td> <code>S</code> </td> <td> <code>L</code> </td> <td> <code>L</code> </td> <td> <code>L</code> </td> <td> <code>L</code> </td> <td> <code>I</code> </td> <td> <code>I</code> </td> </tr></tbody></table></div><br>  Veremos a terceira tabela de pesquisa na pr√≥xima se√ß√£o. <br><br><h3>  Sele√ß√£o Tetrimino </h3><br>  O Nintendo Tetris usa um registro de troca de feedback linear de 16 bits (LFSR) como seu gerador de n√∫meros pseudo-aleat√≥rios (PRNG) em sua configura√ß√£o de Fibonacci.  O valor de 16 bits √© armazenado como big endian nos endere√ßos <code>$0017</code> - <code>$0018</code> .  Um n√∫mero arbitr√°rio de <code>$8988</code> usado como uma semente. <br><br> <code>80BC: LDX #$89 <br> 80BE: STX $0017 <br> 80C0: DEX <br> 80C1: STX $0018</code> <br> <br>  Cada n√∫mero pseudo-aleat√≥rio subsequente √© gerado da seguinte forma: o valor √© percebido como um n√∫mero de 17 bits e o bit mais significativo √© obtido executando XOR para os bits 1 e 9. Em seguida, o valor √© deslocado para a direita, descartando o bit menos significativo. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/3a0/45d/3f2/3a045d3f2d64a94aa272aa15f351ac7a.png"></div><br>  Esse processo ocorre em <code>$AB47</code> . <br><br> <code>AB47: LDA $00,X <br> AB49: AND #$02 <br> AB4B: STA $0000 ; extract bit 1 <br> <br> AB4D: LDA $01,X <br> AB4F: AND #$02 ; extract bit 9 <br> <br> AB51: EOR $0000 <br> AB53: CLC <br> AB54: BEQ $AB57 <br> AB56: SEC ; XOR bits 1 and 9 together <br> <br> AB57: ROR $00,X <br> AB59: INX <br> AB5A: DEY ; right shift <br> AB5B: BNE $AB57 ; shifting in the XORed value <br> <br> AB5D: RTS ; return</code> <br> <br>  Curiosamente, os par√¢metros da sub-rotina acima podem ser configurados para que a fun√ß√£o de chamada possa especificar a largura do registro de deslocamento e o endere√ßo no qual ele pode ser encontrado na mem√≥ria.  No entanto, os mesmos par√¢metros s√£o usados ‚Äã‚Äãem todos os lugares, para que possamos assumir que os desenvolvedores tenham emprestado esse c√≥digo em algum lugar. <br><br>  Para aqueles que desejam modificar ainda mais o algoritmo, escrevi em Java. <br><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">generateNextPseudorandomNumber</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> value)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> bit1 = (value &gt;&gt; <span class="hljs-number"><span class="hljs-number">1</span></span>) &amp; <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> bit9 = (value &gt;&gt; <span class="hljs-number"><span class="hljs-number">9</span></span>) &amp; <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> leftmostBit = bit1 ^ bit9; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (leftmostBit &lt;&lt; <span class="hljs-number"><span class="hljs-number">15</span></span>) | (value &gt;&gt; <span class="hljs-number"><span class="hljs-number">1</span></span>); }</code> </pre> <br>  E todo esse c√≥digo pode ser compactado em uma linha. <br><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">generateNextPseudorandomNumber</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> value)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ((((value &gt;&gt; <span class="hljs-number"><span class="hljs-number">9</span></span>) &amp; <span class="hljs-number"><span class="hljs-number">1</span></span>) ^ ((value &gt;&gt; <span class="hljs-number"><span class="hljs-number">1</span></span>) &amp; <span class="hljs-number"><span class="hljs-number">1</span></span>)) &lt;&lt; <span class="hljs-number"><span class="hljs-number">15</span></span>) | (value &gt;&gt; <span class="hljs-number"><span class="hljs-number">1</span></span>); }</code> </pre> <br>  Esse PRNG gera cont√≠nua e deterministicamente 32.767 valores exclusivos, iniciando cada ciclo a partir da semente original.  Esse √© um menos da metade dos n√∫meros poss√≠veis que podem caber no registro e qualquer valor nesse conjunto pode ser usado como semente.  Muitos dos valores fora do conjunto criam uma cadeia que eventualmente leva a um n√∫mero do conjunto.  No entanto, alguns n√∫meros iniciais resultam em uma sequ√™ncia infinita de zeros. <br><br>  Para avaliar aproximadamente o desempenho desse PRNG, gerei uma representa√ß√£o gr√°fica dos valores criados com base em uma frase com <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">RANDOM.ORG</a> . <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/254/477/bef/254477befbd14f540925a6d3169e5179.png"></div><br>  Ao criar a imagem, o PRNG foi usado como um gerador de n√∫meros pseudo-aleat√≥rios, em vez de n√∫meros inteiros de 16 bits.  Cada pixel √© colorido com base no valor do bit 0. A imagem possui um tamanho de 128 √ó 256, ou seja, cobre toda a sequ√™ncia. <br><br>  Al√©m das listras quase impercept√≠veis nos lados superior e esquerdo, parece aleat√≥rio.  Nenhum padr√£o √≥bvio aparece. <br><br>  Ap√≥s o in√≠cio, o PRNG muda constantemente o registro, trabalhando pelo menos uma vez por quadro.  Isso n√£o acontece n√£o apenas na tela inicial e nas telas de menu, mas tamb√©m quando o tetrimino fica entre as opera√ß√µes de cria√ß√£o de formas.  Ou seja, a figura que aparece a seguir depende do n√∫mero de quadros que o jogador leva para colocar a figura.  De fato, o jogo se baseia na aleatoriedade das a√ß√µes da pessoa que interage com ele. <br><br>  Durante a cria√ß√£o da figura, o c√≥digo √© executado no endere√ßo <code>$9907</code> , que seleciona o tipo da nova figura. <br><br> <code>9907: INC $001A ; spawnCount++; <br> <br> 9909: LDA $0017 ; index = high byte of randomValue; <br> <br> 990B: CLC <br> 990C: ADC $001A ; index += spawnCount; <br> <br> 990E: AND #$07 ; index &amp;= 7; <br> <br> 9910: CMP #$07 ; if (index == 7) { <br> 9912: BEQ $991C ; goto invalidIndex; <br> ; } <br> <br> 9914: TAX <br> 9915: LDA $994E,X ; newSpawnID = spawnTable[index]; <br> <br> 9918: CMP $0019 ; if (newSpawnID != spawnID) { <br> 991A: BNE $9938 ; goto useNewSpawnID; <br> ; } <br> <br> invalidIndex: <br> <br> 991C: LDX #$17 <br> 991E: LDY #$02 <br> 9920: JSR $AB47 ; randomValue = generateNextPseudorandomNumber(randomValue); <br> <br> 9923: LDA $0017 ; index = high byte of randomValue; <br> <br> 9925: AND #$07 ; index &amp;= 7; <br> <br> 9927: CLC <br> 9928: ADC $0019 ; index += spawnID; <br> <br> 992A: CMP #$07 <br> 992C: BCC $9934 <br> 992E: SEC <br> 992F: SBC #$07 <br> 9931: JMP $992A ; index %= 7; <br> <br> 9934: TAX <br> 9935: LDA $994E,X ; newSpawnID = spawnTable[index]; <br> <br> useNewSpawnID: <br> <br> 9938: STA $0019 ; spawnID = newSpawnID; <br> <br> 993A: RTS ; return;</code> <br> <br>  No endere√ßo <code>$001A</code> armazena um contador do n√∫mero de figuras criadas com a inicializa√ß√£o.  O incremento do contador √© realizado pela primeira linha da sub-rotina e, como √© um contador de byte √∫nico, ap√≥s cada 256 pe√ßas, ele volta a zero novamente.  Como o contador n√£o √© zerado entre os jogos, o hist√≥rico dos jogos anteriores afeta o processo de sele√ß√£o de figuras.  Essa √© outra maneira de o jogo usar o jogador como fonte de aleatoriedade. <br><br>  A rotina converte o byte mais significativo do n√∫mero pseudo-aleat√≥rio ( <code>$0017</code> ) em um tipo de tetrimino e o utiliza como o √≠ndice da tabela localizada em <code>$994E</code> para converter o tipo no ID da orienta√ß√£o de cria√ß√£o da forma. <br><br> <code>994E: 02 ; Td <br> 994F: 07 ; Jd <br> 9950: 08 ; Zh <br> 9951: 0A ; O <br> 9952: 0B ; Sh <br> 9953: 0E ; Ld <br> 9954: 12 ; Ih</code> <br> <br>  No primeiro est√°gio da convers√£o, o contador de figuras criadas √© adicionado ao byte superior.  Em seguida, uma m√°scara √© aplicada para salvar apenas os 3 bits inferiores.  Se o resultado n√£o for 7, esse √© o tipo correto de tetrimino e, se n√£o for o mesmo que a figura anterior selecionada, o n√∫mero ser√° usado como um √≠ndice na tabela para cria√ß√£o de figuras.  Caso contr√°rio, o pr√≥ximo n√∫mero pseudo-aleat√≥rio √© gerado e a m√°scara √© aplicada para obter os 3 bits inferiores do byte superior e, em seguida, o ID da orienta√ß√£o de cria√ß√£o de forma anterior √© adicionado.  Finalmente, uma opera√ß√£o de m√≥dulo √© realizada para obter o tipo correto de tetrimino, que √© usado como um √≠ndice na tabela de cria√ß√£o de formas. <br><br>  Como o processador n√£o suporta a divis√£o com o restante, esse operador √© emulado subtraindo repetidamente 7 at√© que o resultado se torne menor que 7. A divis√£o com o restante √© aplicada √† soma do byte superior com a m√°scara aplicada e ao ID anterior da orienta√ß√£o de cria√ß√£o de forma.  O valor m√°ximo dessa soma √© 25. Ou seja, para reduzi-lo ao restante de 4, s√£o necess√°rias apenas 3 itera√ß√µes. <br><br>  No in√≠cio de cada jogo, o ID da orienta√ß√£o de cria√ß√£o da forma ( <code>$0019</code> ) √© inicializado com um valor de <code>Tu</code> ( <code>$00</code> ).  Esse valor pode ser potencialmente usado em <code>$9928</code> durante a primeira cria√ß√£o de forma. <br><br>  Ao usar o ID de orienta√ß√£o anterior para criar uma figura, em vez do tipo anterior, o Tetrimino adiciona distor√ß√£o, porque os valores do ID de orienta√ß√£o n√£o s√£o distribu√≠dos uniformemente.  Isso √© mostrado na tabela: <br><br><div class="scrollable-table"><table><tbody><tr><th>  $ 00 </th><th> <code>$02</code> </th> <th> <code>$07</code> </th> <th> <code>$08</code> </th> <th> <code>$0A</code> </th> <th> <code>$0B</code> </th> <th> <code>$0E</code> </th> <th> <code>$12</code> </th> </tr><tr><th>  0 0 </th><td>  2 </td><td>  0 0 </td><td>  1 </td><td>  3 </td><td>  4 </td><td>  0 0 </td><td>  4 </td></tr><tr><th>  1 </th><td>  3 </td><td>  1 </td><td>  2 </td><td>  4 </td><td>  5 </td><td>  1 </td><td>  5 </td></tr><tr><th>  2 </th><td>  4 </td><td>  2 </td><td>  3 </td><td>  5 </td><td>  6 </td><td>  2 </td><td>  6 </td></tr><tr><th>  3 </th><td>  5 </td><td>  3 </td><td>  4 </td><td>  6 </td><td>  0 0 </td><td>  3 </td><td>  0 0 </td></tr><tr><th>  4 </th><td>  6 </td><td>  4 </td><td>  5 </td><td>  0 0 </td><td>  1 </td><td>  4 </td><td>  1 </td></tr><tr><th>  5 </th><td>  0 0 </td><td>  5 </td><td>  6 </td><td>  1 </td><td>  2 </td><td>  5 </td><td>  2 </td></tr><tr><th>  6 </th><td>  1 </td><td>  6 </td><td>  0 0 </td><td>  2 </td><td>  3 </td><td>  6 </td><td>  3 </td></tr><tr><th>  7 </th><td>  2 </td><td>  0 0 </td><td>  1 </td><td>  3 </td><td>  4 </td><td>  0 0 </td><td>  4 </td></tr></tbody></table></div><br>  Cada c√©lula cont√©m um tipo de tetrimino, calculado adicionando o ID de orienta√ß√£o da figura criada (coluna) a um valor de 3 bits (linha) e aplicando o restante da divis√£o por 7 √† soma. Cada linha cont√©m duplicatas, porque <code>$07</code> e <code>$0E</code> divididos igualmente por 7, enquanto <code>$0B</code> e <code>$12</code> t√™m um saldo comum.  As linhas 0 e 7 s√£o as mesmas porque est√£o a uma dist√¢ncia de 7. <br><br>  Existem 56 combina√ß√µes de entradas poss√≠veis e, se os tipos de tetrimino resultantes forem distribu√≠dos uniformemente, podemos esperar que, na tabela acima, cada tipo apare√ßa exatamente 8 vezes.  Mas, como mostrado abaixo, este n√£o √© o caso. <br><br><div class="scrollable-table"><table><tbody><tr><th>  Tipo </th><th>  Frequ√™ncia </th></tr><tr><td>  T </td><td>  9 </td></tr><tr><td>  J </td><td>  8 </td></tr><tr><td>  Z </td><td>  8 </td></tr><tr><td>  O </td><td>  8 </td></tr><tr><td>  S </td><td>  9 </td></tr><tr><td>  L </td><td>  7 </td></tr><tr><td>  Eu </td><td>  7 </td></tr></tbody></table></div><br>  T e S aparecem com mais frequ√™ncia, e L e I - com menos frequ√™ncia.  Mas o c√≥digo inclinado usando o ID da orienta√ß√£o n√£o √© executado toda vez que a sub-rotina √© chamada. <br><br>  Suponha que o PRNG crie uma sequ√™ncia de valores independentes estat√≠sticos uniformemente distribu√≠dos.  Esta √© realmente uma suposi√ß√£o justa, considerando como o jogo tenta obter a aleatoriedade correta das a√ß√µes do jogador.  Adicionar o n√∫mero de figuras criadas ao endere√ßo <code>$990C</code> n√£o afetar√° a distribui√ß√£o, porque o n√∫mero aumenta igualmente entre as chamadas.  O uso da m√°scara de bits em <code>$990E</code> semelhante √† aplica√ß√£o da divis√£o por 8 com o restante, o que tamb√©m n√£o afeta a distribui√ß√£o.  Portanto, a verifica√ß√£o em <code>$9910</code> vai para <code>invalidIndex</code> em 1/8 de todos os casos.  E a probabilidade de acertar ao verificar no endere√ßo <code>$9918</code> , onde o valor selecionado recentemente √© comparado com o valor anterior, √© 7/8, com probabilidade de coincid√™ncia de 1/7.<font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Isso significa que h√° uma chance adicional de </font></font><code>7/8 √ó 1/7 = 1/8</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">entrar </font></font><code>invalidIndex</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Em geral, h√° uma probabilidade de 25% de usar um c√≥digo distorcido e uma probabilidade de 75% de usar um c√≥digo que selecione o Tetrimino uniformemente. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Em um conjunto de 224 tetriminos criados, a expectativa matem√°tica √© de 32 inst√¢ncias para cada tipo. </font><font style="vertical-align: inherit;">Mas, na verdade, o c√≥digo cria a seguinte distribui√ß√£o:</font></font><br><br><div class="scrollable-table"><table><tbody><tr><th>  Tipo </th><th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Frequ√™ncia </font></font></th></tr><tr><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> T </font></font></td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 33 </font></font></td></tr><tr><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> J </font></font></td><td>  32. </td></tr><tr><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Z </font></font></td><td>  32. </td></tr><tr><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> O </font></font></td><td>  32. </td></tr><tr><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> S </font></font></td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 33 </font></font></td></tr><tr><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> L </font></font></td><td>  31 </td></tr><tr><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Eu </font></font></td><td>  31 </td></tr></tbody></table></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ou seja, limpando 90 linhas e atingindo o n√≠vel 9, o jogador receber√° um T e S extra e um L e I a menos do que o esperado estatisticamente. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O Tetrimino √© escolhido com as seguintes probabilidades:</font></font><br><br><div class="scrollable-table"><table><tbody><tr><th>  Tipo </th><th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Probabilidade </font></font></th></tr><tr><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> T </font></font></td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 14,73% </font></font></td></tr><tr><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> J </font></font></td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 14,29% </font></font></td></tr><tr><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Z </font></font></td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 14,29% </font></font></td></tr><tr><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> O </font></font></td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 14,29% </font></font></td></tr><tr><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> S </font></font></td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 14,73% </font></font></td></tr><tr><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> L </font></font></td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 13,84% </font></font></td></tr><tr><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Eu </font></font></td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 13,84% </font></font></td></tr></tbody></table></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Parece que na afirma√ß√£o de que o ‚Äúbast√£o longo‚Äù que nunca aparece quando √© necess√°rio, existe parte da verdade (pelo menos para o Nintendo Tetris). </font></font><br><br><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Tetrimino Shift </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O Nintendo Tetris usa o Delayed Auto Shift (DAS). </font><font style="vertical-align: inherit;">Clicar em "Esquerda" ou "Direita" move instantaneamente o tetrimino uma c√©lula na horizontal. </font><font style="vertical-align: inherit;">Manter um desses bot√µes de dire√ß√£o pressionado faz com que o jogo mude automaticamente a figura a cada 6 quadros, com um atraso inicial de 16 quadros. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Esse tipo de movimento horizontal √© controlado pelo c√≥digo no endere√ßo </font></font><code>$89AE</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Como no c√≥digo de rota√ß√£o, uma vari√°vel tempor√°ria √© usada aqui para fazer backup das coordenadas </font><font style="vertical-align: inherit;">, caso a nova posi√ß√£o esteja incorreta. </font><font style="vertical-align: inherit;">Observe que o teste impede que voc√™ mova a pe√ßa enquanto o jogador pressiona para baixo.</font></font><br><br> <code>89AE: LDA $0040 <br> 89B0: STA $00AE ; originalX = tetriminoX; <br> <br> 89B2: LDA $00B6 ; if (pressing down) { <br> 89B4: AND #$04 ; return; <br> 89B6: BNE $8A09 ; } <br> <br> 89B8: LDA $00B5 ; if (just pressed left/right) { <br> 89BA: AND #$03 ; goto resetAutorepeatX; <br> 89BC: BNE $89D3 ; } <br> <br> 89BE: LDA $00B6 ; if (not pressing left/right) { <br> 89C0: AND #$03 ; return; <br> 89C2: BEQ $8A09 ; } <br> <br> 89C4: INC $0046 ; autorepeatX++; <br> 89C6: LDA $0046 ; if (autorepeatX &lt; 16) { <br> 89C8: CMP #$10 ; return; <br> 89CA: BMI $8A09 ; } <br> <br> 89CC: LDA #$0A <br> 89CE: STA $0046 ; autorepeatX = 10; <br> 89D0: JMP $89D7 ; goto buttonHeldDown; <br> <br> resetAutorepeatX: <br> <br> 89D3: LDA #$00 <br> 89D5: STA $0046 ; autorepeatX = 0; <br> <br> buttonHeldDown: <br> <br> 89D7: LDA $00B6 ; if (not pressing right) { <br> 89D9: AND #$01 ; goto notPressingRight; <br> 89DB: BEQ $89EC ; } <br> <br> 89DD: INC $0040 ; tetriminoX++; <br> 89DF: JSR $948B ; if (new position not valid) { <br> 89E2: BNE $8A01 ; goto restoreX; <br> ; } <br> <br> 89E4: LDA #$03 <br> 89E6: STA $06F1 ; play shift sound effect; <br> 89E9: JMP $8A09 ; return; <br> <br> notPressingRight: <br> <br> 89EC: LDA $00B6 ; if (not pressing left) { <br> 89EE: AND #$02 ; return; <br> 89F0: BEQ $8A09 ; } <br> <br> 89F2: DEC $0040 ; tetriminoX--; <br> 89F4: JSR $948B ; if (new position not valid) { <br> 89F7: BNE $8A01 ; goto restoreX; <br> ; } <br> <br> 89F9: LDA #$03 <br> 89FB: STA $06F1 ; play shift sound effect; <br> 89FE: JMP $8A09 ; return; <br> <br> restoreX: <br> <br> 8A01: LDA $00AE <br> 8A03: STA $0040 ; tetriminoX = originalX; <br> <br> 8A05: LDA #$10 <br> 8A07: STA $0046 ; autorepeatX = 16; <br> <br> 8A09: RTS ; return;</code> <br> <br><font style="vertical-align: inherit;"></font><code>x</code><font style="vertical-align: inherit;"></font><br><br><font style="vertical-align: inherit;"></font><br><br><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Jogando Tetrimino </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A velocidade da descida autom√°tica do Tetrimino √© uma fun√ß√£o do n√∫mero do n√≠vel. </font><font style="vertical-align: inherit;">As velocidades s√£o codificadas como o n√∫mero de quadros renderizados para descida na tabela localizada em </font></font><code>$898E</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Como o NES opera a 60.0988 quadros / s, √© poss√≠vel calcular o per√≠odo entre descidas e velocidade.</font></font><br><br><div class="scrollable-table"><table><tbody><tr><th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> N√≠vel </font></font></th><th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Quadros de descida </font></font></th><th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Per√≠odo (s / descida) </font></font></th><th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Velocidade (c√©lulas / s) </font></font></th></tr><tr><td>  0 0 </td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 48. </font></font></td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .799 </font></font></td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 1,25 </font></font></td></tr><tr><td>  1 </td><td>  43 </td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .715 </font></font></td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 1,40 </font></font></td></tr><tr><td>  2 </td><td>  38. </td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .632 </font></font></td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 1,58 </font></font></td></tr><tr><td>  3 </td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 33 </font></font></td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .549 </font></font></td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 1,82 </font></font></td></tr><tr><td>  4 </td><td>  28. </td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .466 </font></font></td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 2,15 </font></font></td></tr><tr><td>  5 </td><td>  23 </td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .383 </font></font></td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 2,61 </font></font></td></tr><tr><td>  6 </td><td>  18 </td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .300 </font></font></td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 3,34 </font></font></td></tr><tr><td>  7 </td><td>  13 </td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .216 </font></font></td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 4,62 </font></font></td></tr><tr><td>  8 </td><td>  8 </td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .133 </font></font></td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 7,51 </font></font></td></tr><tr><td>  9 </td><td>  6 </td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .100 </font></font></td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 10,02 </font></font></td></tr><tr><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 10-12 </font></font></td><td>  5 </td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .083 </font></font></td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 12,02 </font></font></td></tr><tr><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 13-15 </font></font></td><td>  4 </td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .067 </font></font></td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 15,05 </font></font></td></tr><tr><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 16-18 </font></font></td><td>  3 </td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .050 </font></font></td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 20/03 </font></font></td></tr><tr><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 19-28 </font></font></td><td>  2 </td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .033 </font></font></td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 30.05 </font></font></td></tr><tr><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 29+ </font></font></td><td>  1 </td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .017 </font></font></td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 60.10 </font></font></td></tr></tbody></table></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A tabela possui um total de 30 entradas. Ap√≥s o n√≠vel 29, o valor dos quadros para descida √© sempre 1. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Um n√∫mero inteiro de quadros para descida n√£o √© uma maneira muito detalhada de descrever a velocidade. Como mostra o gr√°fico abaixo, a velocidade aumenta exponencialmente a cada n√≠vel. De fato, o n√≠vel 29 √© duas vezes mais r√°pido que o n√≠vel 28.</font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/ddd/18c/a29/ddd18ca2950f9055bd5f82108a4d3ddc.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Com 1 quadro / descida, o jogador n√£o tem mais que 1/3 de segundo para posicionar a figura, ap√≥s o que come√ßar√° a se mover. A essa velocidade de descida, o DAS n√£o permite que a figura alcance as bordas do campo de jogo at√© que ela trave no lugar, o que para a maioria das pessoas significa um final r√°pido do jogo. No entanto, alguns jogadores, principalmente </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Thor Akerlund</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , conseguiram derrotar o DAS com a vibra√ß√£o r√°pida dos bot√µes de cruz ( </font></font><code>D-pad</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">). No c√≥digo de mudan√ßa mostrado acima, pode-se ver que, enquanto o bot√£o de dire√ß√£o horizontal √© liberado atrav√©s do quadro, √© poss√≠vel mudar o tetrimino nos n√≠veis 29 e acima com meia frequ√™ncia. Esse √© um m√°ximo te√≥rico, mas qualquer vibra√ß√£o do polegar acima de 3,75 toques / s pode anular o atraso original de 16 quadros.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Se a descida autom√°tica e controlada pelo jogador (pressionando "Para baixo") coincidir e ocorrer em um quadro, o efeito n√£o ser√° adicionado. Um ou ambos os eventos fazem com que a forma diminua exatamente uma c√©lula nesse quadro. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A l√≥gica de controle do acionador est√° localizada em </font></font><code>$8914</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">A tabela do quadro de descida est√° sob o r√≥tulo </font><font style="vertical-align: inherit;">. Como mencionado acima, no n√≠vel 29 e acima, a velocidade √© constantemente igual a 1 obturador / quadro. </font><font style="vertical-align: inherit;">(endere√ßo </font><font style="vertical-align: inherit;">) inicia a descida quando atinge </font><font style="vertical-align: inherit;">( </font><font style="vertical-align: inherit;">). O incremento </font><font style="vertical-align: inherit;">√© realizado em um endere√ßo </font><font style="vertical-align: inherit;">fora deste fragmento de c√≥digo. Durante a descida autom√°tica ou controlada, √© redefinido para 0. A </font><font style="vertical-align: inherit;">vari√°vel </font><font style="vertical-align: inherit;">( </font><font style="vertical-align: inherit;">) √© inicializada com o valor </font><font style="vertical-align: inherit;">(no endere√ßo</font></font><br><br> <code>8914: LDA $004E ; if (autorepeatY &gt; 0) { <br> 8916: BPL $8922 ; goto autorepeating; <br> ; } else if (autorepeatY == 0) { <br> ; goto playing; <br> ; } <br> <br> ; game just started <br> ; initial Tetrimino hanging at spawn point <br> <br> 8918: LDA $00B5 ; if (not just pressed down) { <br> 891A: AND #$04 ; goto incrementAutorepeatY; <br> 891C: BEQ $8989 ; } <br> <br> ; player just pressed down ending startup delay <br> <br> 891E: LDA #$00 <br> 8920: STA $004E ; autorepeatY = 0; <br> 8922: BNE $8939 <br> <br> playing: <br> <br> 8924: LDA $00B6 ; if (left or right pressed) { <br> 8926: AND #$03 ; goto lookupDropSpeed; <br> 8928: BNE $8973 ; } <br> <br> ; left/right not pressed <br> <br> 892A: LDA $00B5 <br> 892C: AND #$0F ; if (not just pressed only down) { <br> 892E: CMP #$04 ; goto lookupDropSpeed; <br> 8930: BNE $8973 ; } <br> <br> ; player exclusively just presssed down <br> <br> 8932: LDA #$01 <br> 8934: STA $004E ; autorepeatY = 1; <br> <br> 8936: JMP $8973 ; goto lookupDropSpeed; <br> <br> autorepeating: <br> <br> 8939: LDA $00B6 <br> 893B: AND #$0F ; if (down pressed and not left/right) { <br> 893D: CMP #$04 ; goto downPressed; <br> 893F: BEQ $894A ; } <br> <br> ; down released <br> <br> 8941: LDA #$00 <br> 8943: STA $004E ; autorepeatY = 0 <br> 8945: STA $004F ; holdDownPoints = 0 <br> 8947: JMP $8973 ; goto lookupDropSpeed; <br> <br> downPressed: <br> <br> 894A: INC $004E ; autorepeatY++; <br> 894C: LDA $004E <br> 894E: CMP #$03 ; if (autorepeatY &lt; 3) { <br> 8950: BCC $8973 ; goto lookupDropSpeed; <br> ; } <br> <br> 8952: LDA #$01 <br> 8954: STA $004E ; autorepeatY = 1; <br> <br> 8956: INC $004F ; holdDownPoints++; <br> <br> drop: <br> <br> 8958: LDA #$00 <br> 895A: STA $0045 ; fallTimer = 0; <br> <br> 895C: LDA $0041 <br> 895E: STA $00AE ; originalY = tetriminoY; <br> <br> 8960: INC $0041 ; tetriminoY++; <br> 8962: JSR $948B ; if (new position valid) { <br> 8965: BEQ $8972 ; return; <br> ; } <br> <br> ; the piece is locked <br> <br> 8967: LDA $00AE <br> 8969: STA $0041 ; tetriminoY = originalY; <br> <br> 896B: LDA #$02 <br> 896D: STA $0048 ; playState = UPDATE_PLAYFIELD; <br> 896F: JSR $9CAF ; updatePlayfield(); <br> <br> 8972: RTS ; return; <br> <br> lookupDropSpeed: <br> <br> 8973: LDA #$01 ; tempSpeed = 1; <br> <br> 8975: LDX $0044 ; if (level &gt;= 29) { <br> 8977: CPX #$1D ; goto noTableLookup; <br> 8979: BCS $897E ; } <br> <br> 897B: LDA $898E,X ; tempSpeed = framesPerDropTable[level]; <br> <br> noTableLookup: <br> <br> 897E: STA $00AF ; dropSpeed = tempSpeed; <br> <br> 8980: LDA $0045 ; if (fallTimer &gt;= dropSpeed) { <br> 8982: CMP $00AF ; goto drop; <br> 8984: BPL $8958 ; } <br> <br> 8986: JMP $8972 ; return; <br> <br> incrementAutorepeatY: <br> <br> 8989: INC $004E ; autorepeatY++; <br> 898B: JMP $8972 ; return;</code> <br> <br><font style="vertical-align: inherit;"></font><code>lookupDropSpeed</code><font style="vertical-align: inherit;"></font><br><br> <code>fallTimer</code><font style="vertical-align: inherit;"></font><code>$0045</code><font style="vertical-align: inherit;"></font><code>dropSpeed</code><font style="vertical-align: inherit;"></font><code>$00AF</code><font style="vertical-align: inherit;"></font><code>fallTimer</code><font style="vertical-align: inherit;"></font><code>$8892</code><font style="vertical-align: inherit;"></font><br><br><font style="vertical-align: inherit;"></font><code>autorepeatY</code><font style="vertical-align: inherit;"></font><code>$004E</code><font style="vertical-align: inherit;"></font><code>$0A</code><font style="vertical-align: inherit;"></font><code>$8739</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">), que √© interpretado como -96. Uma condi√ß√£o no in√≠cio causa um atraso inicial. O primeiro Tetrimino permanece suspenso no ar no ponto de cria√ß√£o at√© </font></font><code>autorepeatY</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">aumentar para 0, o que leva 1,6 segundos. No entanto, quando voc√™ pressiona Para baixo nesta fase, √© </font></font><code>autorepeatY</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">atribu√≠do 0 instantaneamente. √â interessante que voc√™ possa mover e girar a figura nessa fase do atraso inicial sem cancel√°-la. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O incremento </font></font><code>autorepeatY</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">√© realizado enquanto mant√©m pressionado. Quando atinge 3, ocorre uma descida controlada pelo homem (descida "suave") e √© </font></font><code>autorepeatY</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">atribu√≠da a 1. Portanto, a descida suave inicial requer 3 quadros, mas depois √© repetida em cada quadro. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Al√©m disso, ele </font></font><code>autorepeatY</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">aumenta de 0 para 1 somente quando o jogo reconhece que o jogador acabou de clicar em Para baixo (em</font></font><code>$00B5</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">), mas n√£o reconhece manter pressionado. Isso √© importante porque √© </font></font><code>autorepeatY</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">redefinido para 0 ao criar um tetrimino (no endere√ßo </font></font><code>$98E8</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">), o que cria um recurso importante: se o pr√≥prio jogador abaixa a figura e ele √© bloqueado, e continua pressionando "Baixo" ao criar a pr√≥xima figura, o que geralmente acontece em n√≠veis altos, ent√£o isso n√£o levar√° a uma descida suave da nova figura. Para que isso aconte√ßa, o jogador deve soltar ‚ÄúDown‚Äù e pressionar o bot√£o novamente. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Uma descida potencialmente suave pode aumentar pontos. </font></font><code>holdDownPoints</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">( </font></font><code>$004F</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) aumenta a cada descida, mas quando liberado, ‚ÄúDown‚Äù √© redefinido para 0. Portanto, para marcar pontos, √© necess√°rio abaixar o tetrimino na fechadura com uma descida suave. A descida suave de curto prazo, que pode ocorrer no caminho da figura, n√£o afeta os pontos. A conta √© atualizada em</font></font><code>$9BFE</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, mas √© </font></font><code>holdDownPoints</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">redefinido para 0 logo ap√≥s, no endere√ßo </font></font><code>$9C2F</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A verifica√ß√£o, que impede o jogador de fazer uma descida suave com um deslocamento horizontal da figura, complica o conjunto de pontos. Isso significa que o √∫ltimo movimento antes de travar a pe√ßa no lugar deve ser "Para baixo". </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Quando a descida ocorre, </font></font><code>tetriminoY</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">( </font></font><code>$0041</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) √© copiado para </font></font><code>originalY</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">( </font></font><code>$00AE</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">). Se a nova posi√ß√£o criada pelo incremento </font></font><code>tetriminoY</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">estiver incorreta (ou seja, a figura empurra o ch√£o do campo de jogo ou se sobrep√µe a quadrados j√° existentes), o tetrimino permanece na posi√ß√£o anterior. Nesse caso, ele √© restaurado</font></font><code>tetriminoY</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">e a figura √© considerada bloqueada. </font><font style="vertical-align: inherit;">Isso significa que o atraso antes do bloqueio (o n√∫mero m√°ximo de quadros que um tetrimino espera, mantendo o ar antes do bloqueio) √© igual ao atraso na descida. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A descida r√≠gida (queda instant√¢nea) n√£o √© suportada no Nintendo Tetris.</font></font><br><br><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Deslizamento e rolagem </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> O manual do Nintendo Tetris tem um exemplo ilustrado de um deslize: </font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/f6f/4bb/647/f6f4bb647937094d3d68fae530b0bfd4.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Deslizar consiste em deslocar-se ao longo da superf√≠cie de outras figuras ou ao longo do ch√£o do campo de jogo. </font><font style="vertical-align: inherit;">Geralmente √© usado para empurrar uma figura sob um quadrado pendente. </font><font style="vertical-align: inherit;">O deslizamento pode ser realizado at√© que o cron√¥metro de queda atinja a velocidade de descida, ap√≥s o qual a figura ser√° travada no lugar. </font><font style="vertical-align: inherit;">Um exemplo animado √© mostrado abaixo.</font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/efe/9f5/022/efe9f502248d4185409fc20db3a47647.gif"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Por outro lado, a rolagem permite inserir figuras em espa√ßos que s√£o inating√≠veis de qualquer outra maneira (veja abaixo). </font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/c53/ca5/350/c53ca53509826b9f2c462c0290ffa9c9.gif"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Como deslizar, a rolagem n√£o √© poss√≠vel sem um atraso de bloqueio. </font><font style="vertical-align: inherit;">Al√©m disso, a rolagem explora a maneira como o jogo manipula formas. </font><font style="vertical-align: inherit;">Antes de mover ou girar a figura, o jogo verifica se, ap√≥s alterar a posi√ß√£o, todos os quadrados do tetrimino estar√£o em c√©lulas vazias dentro dos limites do campo de jogo. </font><font style="vertical-align: inherit;">Essa verifica√ß√£o, como mostrado abaixo, n√£o impede a rota√ß√£o atrav√©s de blocos preenchidos nas proximidades. </font><font style="vertical-align: inherit;">Conforme declarado na se√ß√£o Descri√ß√£o do Tetrimino, cada linha da tabela de orienta√ß√£o cont√©m 12 bytes; </font><font style="vertical-align: inherit;">portanto, o √≠ndice nesta tabela √© calculado multiplicando o ID da orienta√ß√£o do tetrimino ativo por 12. Como mostrado abaixo, todas as multiplica√ß√µes na rotina s√£o executadas usando turnos e adi√ß√µes.</font></font><br><br> <code>948B: LDA $0041 <br> 948D: ASL <br> 948E: STA $00A8 <br> 9490: ASL <br> 9491: ASL <br> 9492: CLC <br> 9493: ADC $00A8 <br> 9495: ADC $0040 <br> 9497: STA $00A8 <br> <br> 9499: LDA $0042 <br> 949B: ASL <br> 949C: ASL <br> 949D: STA $00A9 <br> 949F: ASL <br> 94A0: CLC <br> 94A1: ADC $00A9 <br> 94A3: TAX ; index = 12 * orientationID; <br> 94A4: LDY #$00 <br> <br> 94A6: LDA #$04 <br> 94A8: STA $00AA ; for(i = 0; i &lt; 4; i++) { <br> <br> 94AA: LDA $8A9C,X ; squareY = orientationTable[index]; <br> 94AD: CLC <br> 94AE: ADC $0041 ; cellY = squareY + tetriminoY; <br> 94B0: ADC #$02 ; if (cellY &lt; -2 || cellY &gt;= 20) { <br> 94B2: CMP #$16 ; return false; <br> 94B4: BCS $94E9 ; } <br> <br> 94B6: LDA $8A9C,X <br> 94B9: ASL <br> 94BA: STA $00AB <br> 94BC: ASL <br> 94BD: ASL <br> 94BE: CLC <br> 94BF: ADC $00AB <br> 94C1: CLC <br> 94C2: ADC $00A8 <br> 94C4: STA $00AD <br> <br> 94C6: INX <br> 94C7: INX ; index += 2; <br> <br> 94C8: LDA $8A9C,X ; squareX = orientationTable[index]; <br> 94CB: CLC <br> 94CC: ADC $00AD <br> 94CE: TAY ; cellX = squareX + tetriminoX; <br> 94CF: LDA ($B8),Y ; if (playfield[10 * cellY + cellX] != EMPTY_TILE) { <br> 94D1: CMP #$EF ; return false; <br> 94D3: BCC $94E9 ; } <br> <br> 94D5: LDA $8A9C,X <br> 94D8: CLC <br> 94D9: ADC $0040 ; if (cellX &lt; 0 || cellX &gt;= 10) { <br> 94DB: CMP #$0A ; return false; <br> 94DD: BCS $94E9 ; } <br> <br> 94DF: INX ; index++; <br> 94E0: DEC $00AA <br> 94E2: BNE $94AA ; } <br> <br> 94E4: LDA #$00 <br> 94E6: STA $00A8 <br> 94E8: RTS ; return true; <br> <br> 94E9: LDA #$FF <br> 94EB: STA $00A8 <br> 94ED: RTS</code> <br> <br><font style="vertical-align: inherit;"></font><br><br> <code>index = (orientationID &lt;&lt; 3) + (orientationID &lt;&lt; 2); // index = 8 * orientationID + 4 * orientationID; <br> <br> (cellY &lt;&lt; 3) + (cellY &lt;&lt; 1) // 8 * cellY + 2 * cellY</code> <br> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cada itera√ß√£o do ciclo muda a posi√ß√£o do tetrimino pelas coordenadas relativas de um dos quadrados da tabela de orienta√ß√£o para obter a localiza√ß√£o da c√©lula correspondente no campo de jogo. Ela ent√£o verifica se as coordenadas da c√©lula est√£o dentro dos limites do campo de jogo e se a pr√≥pria c√©lula est√° vazia. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Os coment√°rios descrevem mais claramente como verificar o espa√ßamento entre linhas. </font><font style="vertical-align: inherit;">Al√©m das c√©lulas nas linhas vis√≠veis, o c√≥digo considera as duas linhas ocultas acima do campo de jogo como as posi√ß√µes legais dos quadrados sem usar uma condi√ß√£o composta. Isso funciona porque no </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;">c√≥digo adicional os</font></a><font style="vertical-align: inherit;"> n√∫meros negativos representados por vari√°veis ‚Äã‚Äãde byte √∫nico s√£o equivalentes a valores maiores que 127. Nesse caso, o valor m√≠nimo </font><font style="vertical-align: inherit;">√© ‚àí2, que √© armazenado como</font></font><br><br> <code>94AA: LDA $8A9C,X ; squareY = orientationTable[index]; <br> 94AD: CLC <br> 94AE: ADC $0041 ; cellY = squareY + tetriminoY; <br> 94B0: ADC #$02 ; if (cellY + 2 &gt;= 22) { <br> 94B2: CMP #$16 ; return false; <br> 94B4: BCS $94E9 ; }</code> <br> <br><font style="vertical-align: inherit;"></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"></font><code>cellY</code><font style="vertical-align: inherit;"></font><code>$FE</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(254 em nota√ß√£o decimal). </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O √≠ndice do campo de jogo √© a soma </font></font><code>cellY</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">multiplicada por 10 e </font></font><code>cellX</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. No entanto, quando </font></font><code>cellY</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">‚àí1 ( </font></font><code>$FF</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">= 255) ou ‚àí2 ( </font></font><code>$FE</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">= 254), o produto produz ‚àí10 ( </font></font><code>$F6</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">= 246) e ‚àí20 ( </font></font><code>$EC</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">= 236). Estando no intervalo, n√£o </font></font><code>cellX</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pode ser superior a 9, o que fornece um √≠ndice m√°ximo de 246 + 9 = 255, e isso √© muito mais do que o fim do campo de jogo. No entanto, o jogo √© inicializado </font></font><code>$0400</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- </font></font><code>$04FF</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">com um valor </font></font><code>$EF</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(de um bloco vazio), criando outros 56 bytes adicionais de espa√ßo vazio. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Estranho que verifica√ß√£o de intervalo</font></font><code>cellX</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">realizada ap√≥s examinar a c√©lula do campo de jogo. </font><font style="vertical-align: inherit;">Mas funciona corretamente em qualquer ordem. </font><font style="vertical-align: inherit;">Al√©m disso, a verifica√ß√£o do intervalo evita a condi√ß√£o composta, conforme indicado no coment√°rio abaixo. </font><font style="vertical-align: inherit;">Os exemplos de rolagem mostrados abaixo s√£o poss√≠veis devido √† maneira como esse c√≥digo verifica as posi√ß√µes.</font></font><br><br> <code>94D5: LDA $8A9C,X <br> 94D8: CLC <br> 94D9: ADC $0040 ; if (cellX &gt;= 10) { <br> 94DB: CMP #$0A ; return false; <br> 94DD: BCS $94E9 ; }</code> <br> <br><font style="vertical-align: inherit;"></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/45f/c2d/dc0/45fc2ddc0d156d534aad4fd065b86aa4.gif"></div><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/15f/185/0db/15f1850dbfca0b491498e8d81ab03877.gif"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Como mostrado abaixo, voc√™ pode at√© deslizar com rolagem. </font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/08f/74c/c78/08f74cc7825cd53d5a8002b8e33c4612.gif"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> A IA aproveita ao m√°ximo as capacidades de movimenta√ß√£o do Nintendo Tetris, incluindo deslizar e rolar. </font></font><br><br><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> N√≠vel 30 e acima </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Depois de atingir o n√≠vel 30, parece que o n√≠vel √© redefinido para zero. </font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/feb/fee/b1f/febfeeb1faafda1a70f5da385c2276ac.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Mas o n√≠vel 31 mostra que algo mais est√° acontecendo: </font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/26e/057/20c/26e05720ca15aa302a0b61e09498e5a0.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Os valores de n√≠vel exibidos est√£o localizados na tabela no endere√ßo </font></font><code>$96B8</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br><br> <code>96B8: 00 01 02 03 04 05 06 07 08 09 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29</code> <br> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Como mostrado abaixo, a tabela padr√£o √© ordenado para que as telhas com </font></font><code>$00</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">on </font></font><code>$0F</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">s√£o s√≠mbolos para glifos </font></font><code>0</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">no </font></font><code>F</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Isso significa que, ao exibir um d√≠gito decimal ou hexadecimal, o valor do pr√≥prio d√≠gito √© usado como o √≠ndice da tabela de padr√µes. No nosso caso, os valores de n√≠vel s√£o armazenados como decimal com c√≥digo bin√°rio (BCD); cada mordidela de cada byte na sequ√™ncia √© um valor de bloco.</font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/e00/97a/713/e0097a713f629afaf73936d3192820e3.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Infelizmente, parece que os designers do jogo presumiram que ningu√©m passaria no n√≠vel 29 e, portanto, decidiram inserir apenas 30 entradas na tabela. Valores estranhos exibidos s√£o bytes diferentes ap√≥s a tabela. Apenas um byte (no endere√ßo </font></font><code>$0044</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) √© </font><font style="vertical-align: inherit;">usado para indicar o n√∫mero do n√≠vel </font><font style="vertical-align: inherit;">, e √© por isso que o jogo alterna lentamente os 256 valores mostrados abaixo.</font></font><br><br><div class="scrollable-table"><table><tbody><tr><th> <code>00</code> </th> <th> <code>0</code> </th> <th> <code>1</code> </th> <th> <code>2</code> </th> <th> <code>3</code> </th> <th> <code>4</code> </th> <th> <code>5</code> </th> <th> <code>6</code> </th> <th> <code>7</code> </th> <th> <code>8</code> </th> <th> <code>9</code> </th> <th> <code>A</code> </th> <th> <code>B</code> </th> <th> <code>C</code> </th> <th> <code>D</code> </th> <th> <code>E</code> </th> <th> <code>F</code> </th> </tr><tr><th> <code>0</code> </th> <td> <code>00</code> </td> <td> <code>01</code> </td> <td> <code>02</code> </td> <td> <code>03</code> </td> <td> <code>04</code> </td> <td> <code>05</code> </td> <td> <code>06</code> </td> <td> <code>07</code> </td> <td> <code>08</code> </td> <td> <code>09</code> </td> <td> <code>10</code> </td> <td> <code>11</code> </td> <td> <code>12</code> </td> <td> <code>13</code> </td> <td> <code>14</code> </td> <td> <code>15</code> </td> </tr><tr><th> <code>1</code> </th> <td> <code>16</code> </td> <td> <code>17</code> </td> <td> <code>18</code> </td> <td> <code>19</code> </td> <td> <code>20</code> </td> <td> <code>21</code> </td> <td> <code>22</code> </td> <td> <code>23</code> </td> <td> <code>24</code> </td> <td> <code>25</code> </td> <td> <code>26</code> </td> <td> <code>27</code> </td> <td> <code>28</code> </td> <td> <code>29</code> </td> <td> <code>00</code> </td> <td> <code>0A</code> </td> </tr><tr><th> <code>2</code> </th> <td> <code>14</code> </td> <td> <code>1E</code> </td> <td> <code>28</code> </td> <td> <code>32</code> </td> <td> <code>3C</code> </td> <td> <code>46</code> </td> <td> <code>50</code> </td> <td> <code>5A</code> </td> <td> <code>64</code> </td> <td> <code>6E</code> </td> <td> <code>78</code> </td> <td> <code>82</code> </td> <td> <code>8C</code> </td> <td> <code>96</code> </td> <td> <code>A0</code> </td> <td> <code>AA</code> </td> </tr><tr><th> <code>3</code> </th> <td> <code>B4</code> </td> <td> <code>BE</code> </td> <td> <code>C6</code> </td> <td> <code>20</code> </td> <td> <code>E6</code> </td> <td> <code>20</code> </td> <td> <code>06</code> </td> <td> <code>21</code> </td> <td> <code>26</code> </td> <td> <code>21</code> </td> <td> <code>46</code> </td> <td> <code>21</code> </td> <td> <code>66</code> </td> <td> <code>21</code> </td> <td> <code>86</code> </td> <td> <code>21</code> </td> </tr><tr><th> <code>4</code> </th> <td> <code>A6</code> </td> <td> <code>21</code> </td> <td> <code>C6</code> </td> <td> <code>21</code> </td> <td> <code>E6</code> </td> <td> <code>21</code> </td> <td> <code>06</code> </td> <td> <code>22</code> </td> <td> <code>26</code> </td> <td> <code>22</code> </td> <td> <code>46</code> </td> <td> <code>22</code> </td> <td> <code>66</code> </td> <td> <code>22</code> </td> <td> <code>86</code> </td> <td> <code>22</code> </td> </tr><tr><th> <code>5</code> </th> <td> <code>A6</code> </td> <td> <code>22</code> </td> <td> <code>C6</code> </td> <td> <code>22</code> </td> <td> <code>E6</code> </td> <td> <code>22</code> </td> <td> <code>06</code> </td> <td> <code>23</code> </td> <td> <code>26</code> </td> <td> <code>23</code> </td> <td> <code>85</code> </td> <td> <code>A8</code> </td> <td> <code>29</code> </td> <td> <code>F0</code> </td> <td> <code>4A</code> </td> <td> <code>4A</code> </td> </tr><tr><th> <code>6</code> </th> <td> <code>4A</code> </td> <td> <code>4A</code> </td> <td> <code>8D</code> </td> <td> <code>07</code> </td> <td> <code>20</code> </td> <td> <code>A5</code> </td> <td> <code>A8</code> </td> <td> <code>29</code> </td> <td> <code>0F</code> </td> <td> <code>8D</code> </td> <td> <code>07</code> </td> <td> <code>20</code> </td> <td> <code>60</code> </td> <td> <code>A6</code> </td> <td> <code>49</code> </td> <td> <code>E0</code> </td> </tr><tr><th> <code>7</code> </th> <td> <code>15</code> </td> <td> <code>10</code> </td> <td> <code>53</code> </td> <td> <code>BD</code> </td> <td> <code>D6</code> </td> <td> <code>96</code> </td> <td> <code>A8</code> </td> <td> <code>8A</code> </td> <td> <code>0A</code> </td> <td> <code>AA</code> </td> <td> <code>E8</code> </td> <td> <code>BD</code> </td> <td> <code>EA</code> </td> <td> <code>96</code> </td> <td> <code>8D</code> </td> <td> <code>06</code> </td> </tr><tr><th> <code>8</code> </th> <td> <code>20</code> </td> <td> <code>CA</code> </td> <td> <code>A5</code> </td> <td> <code>BE</code> </td> <td> <code>C9</code> </td> <td> <code>01</code> </td> <td> <code>F0</code> </td> <td> <code>1E</code> </td> <td> <code>A5</code> </td> <td> <code>B9</code> </td> <td> <code>C9</code> </td> <td> <code>05</code> </td> <td> <code>F0</code> </td> <td> <code>0C</code> </td> <td> <code>BD</code> </td> <td> <code>EA</code> </td> </tr><tr><th> <code>9</code> </th> <td> <code>96</code> </td> <td> <code>38</code> </td> <td> <code>E9</code> </td> <td> <code>02</code> </td> <td> <code>8D</code> </td> <td> <code>06</code> </td> <td> <code>20</code> </td> <td> <code>4C</code> </td> <td> <code>67</code> </td> <td> <code>97</code> </td> <td> <code>BD</code> </td> <td> <code>EA</code> </td> <td> <code>96</code> </td> <td> <code>18</code> </td> <td> <code>69</code> </td> <td> <code>0C</code> </td> </tr><tr><th> <code>A</code> </th> <td> <code>8D</code> </td> <td> <code>06</code> </td> <td> <code>20</code> </td> <td> <code>4C</code> </td> <td> <code>67</code> </td> <td> <code>97</code> </td> <td> <code>BD</code> </td> <td> <code>EA</code> </td> <td> <code>96</code> </td> <td> <code>18</code> </td> <td> <code>69</code> </td> <td> <code>06</code> </td> <td> <code>8D</code> </td> <td> <code>06</code> </td> <td> <code>20</code> </td> <td> <code>A2</code> </td> </tr><tr><th> <code>B</code> </th> <td> <code>0A</code> </td> <td> <code>B1</code> </td> <td> <code>B8</code> </td> <td> <code>8D</code> </td> <td> <code>07</code> </td> <td> <code>20</code> </td> <td> <code>C8</code> </td> <td> <code>CA</code> </td> <td> <code>D0</code> </td> <td> <code>F7</code> </td> <td> <code>E6</code> </td> <td> <code>49</code> </td> <td> <code>A5</code> </td> <td> <code>49</code> </td> <td> <code>C9</code> </td> <td> <code>14</code> </td> </tr><tr><th> <code>C</code> </th> <td> <code>30</code> </td> <td> <code>04</code> </td> <td> <code>A9</code> </td> <td> <code>20</code> </td> <td> <code>85</code> </td> <td> <code>49</code> </td> <td> <code>60</code> </td> <td> <code>A5</code> </td> <td> <code>B1</code> </td> <td> <code>29</code> </td> <td> <code>03</code> </td> <td> <code>D0</code> </td> <td> <code>78</code> </td> <td> <code>A9</code> </td> <td> <code>00</code> </td> <td> <code>85</code> </td> </tr><tr><th> <code>D</code> </th> <td> <code>AA</code> </td> <td> <code>A6</code> </td> <td> <code>AA</code> </td> <td> <code>B5</code> </td> <td> <code>4A</code> </td> <td> <code>F0</code> </td> <td> <code>5C</code> </td> <td> <code>0A</code> </td> <td> <code>A8</code> </td> <td> <code>B9</code> </td> <td> <code>EA</code> </td> <td> <code>96</code> </td> <td> <code>85</code> </td> <td> <code>A8</code> </td> <td> <code>A5</code> </td> <td> <code>BE</code> </td> </tr><tr><th> <code>E</code> </th> <td> <code>C9</code> </td> <td> <code>01</code> </td> <td> <code>D0</code> </td> <td> <code>0A</code> </td> <td> <code>A5</code> </td> <td> <code>A8</code> </td> <td> <code>18</code> </td> <td> <code>69</code> </td> <td> <code>06</code> </td> <td> <code>85</code> </td> <td> <code>A8</code> </td> <td> <code>4C</code> </td> <td> <code>BD</code> </td> <td> <code>97</code> </td> <td> <code>A5</code> </td> <td> <code>B9</code> </td> </tr><tr><th> <code>F</code> </th> <td> <code>C9</code> </td> <td> <code>04</code> </td> <td> <code>D0</code> </td> <td> <code>0A</code> </td> <td> <code>A5</code> </td> <td> <code>A8</code> </td> <td> <code>38</code> </td> <td> <code>E9</code> </td> <td> <code>02</code> </td> <td> <code>85</code> </td> <td> <code>A8</code> </td> <td> <code>4C</code> </td> <td> <code>BD</code> </td> <td> <code>97</code> </td> <td> <code>A5</code> </td> <td> <code>A8</code> </td> </tr></tbody></table></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Os primeiros 20 valores ordinais s√£o na verdade outra tabela que armazena deslocamentos no campo de jogo para cada uma das 20 linhas. </font><font style="vertical-align: inherit;">Como o campo de jogo come√ßa </font><font style="vertical-align: inherit;">e cada linha cont√©m 10 c√©lulas, o endere√ßo de uma c√©lula arbitr√°ria √©: </font><font style="vertical-align: inherit;">Dado que o processador n√£o suporta multiplica√ß√£o diretamente, esta tabela de pesquisa fornece uma maneira extremamente r√°pida de obter o produto. </font><font style="vertical-align: inherit;">A tabela correspondente ocupa os pr√≥ximos 40 bytes. </font><font style="vertical-align: inherit;">Ele cont√©m 20 endere√ßos no formato little endian para a tabela nomeada 0 (uma √°rea de mem√≥ria VRAM que cont√©m os valores dos blocos de segundo plano). </font><font style="vertical-align: inherit;">Eles s√£o ponteiros para as linhas de deslocamento do campo de jogo </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Os bytes restantes a partir dos quais os valores de n√≠vel exibidos s√£o compostos s√£o instru√ß√µes.</font></font><br><br> <code>96D6: 00 ; 0 <br> 96D7: 0A ; 10 <br> 96D8: 14 ; 20 <br> 96D9: 1E ; 30 <br> 96DA: 28 ; 40 <br> 96DB: 32 ; 50 <br> 96DC: 3C ; 60 <br> 96DD: 46 ; 70 <br> 96DE: 50 ; 80 <br> 96DF: 5A ; 90 <br> 96E0: 64 ; 100 <br> 96E1: 6E ; 110 <br> 96E2: 78 ; 120 <br> 96E3: 82 ; 130 <br> 96E4: 8C ; 140 <br> 96E5: 96 ; 150 <br> 96E6: A0 ; 160 <br> 96E7: AA ; 170 <br> 96E8: B4 ; 180 <br> 96E9: BE ; 190</code> <br> <br><font style="vertical-align: inherit;"></font><code>$0400</code><font style="vertical-align: inherit;"></font><br><br> <code>$0400 + 10 * y + x</code> <br> <br><font style="vertical-align: inherit;"></font><br><br> <code>$0400 + [$96D6 + y] + x</code> <br> <br><font style="vertical-align: inherit;"></font><code>$06</code><font style="vertical-align: inherit;"></font><br><br><font style="vertical-align: inherit;"></font><br><br><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Linhas e estat√≠sticas </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> O n√∫mero de linhas conclu√≠das e estat√≠sticas do tetrimino ocupa 2 bytes cada nos seguintes endere√ßos. </font></font><br><br><div class="scrollable-table"><table><tbody><tr><th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Endere√ßos </font></font></th><th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Quantidade </font></font></th></tr><tr><td> <code>0050</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - </font></font><code>0051</code> </td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Classifica√ß√µes </font></font></td></tr><tr><td> <code>03F0</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - </font></font><code>03F1</code> </td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> T </font></font></td></tr><tr><td> <code>03F2</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - </font></font><code>03F3</code> </td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> J </font></font></td></tr><tr><td> <code>03F4</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - </font></font><code>03F5</code> </td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Z </font></font></td></tr><tr><td> <code>03F6</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - </font></font><code>03F7</code> </td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> O </font></font></td></tr><tr><td> <code>03F8</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - </font></font><code>03F9</code> </td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> S </font></font></td></tr><tr><td> <code>03FA</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - </font></font><code>03FB</code> </td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> L </font></font></td></tr><tr><td> <code>03FC</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - </font></font><code>03FD</code> </td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Eu </font></font></td></tr></tbody></table></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">De fato, esses valores s√£o armazenados como pequenos BCDs endian compactados de 16 bits. </font><font style="vertical-align: inherit;">Por exemplo, o n√∫mero de linhas √© mostrado abaixo, que √© 123. Os bytes s√£o contados da direita para a esquerda para que os d√≠gitos decimais fiquem na ordem.</font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/4f4/68b/c0e/4f468bc0e6f22afe40d74f1711bad46e.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">No entanto, os designers de jogos assumiram que nenhum dos valores seria maior que 999. Portanto, a l√≥gica de exibi√ß√£o processa corretamente o primeiro byte como um BCD compactado, em que cada petisco √© usado como um valor de bloco. </font><font style="vertical-align: inherit;">Mas o segundo byte inteiro √© realmente usado como o d√≠gito decimal superior. </font><font style="vertical-align: inherit;">Quando os d√≠gitos inferiores passam de </font></font><code>99</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">para </font></font><code>00</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, ocorre o incremento normal do segundo byte. </font><font style="vertical-align: inherit;">Como resultado, o segundo byte percorre todos os 256 blocos. </font><font style="vertical-align: inherit;">Um exemplo disso √© mostrado abaixo.</font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/6c7/b4a/d52/6c7b4ad52a59641b8c2e04971415f0df.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Depois de limpar a linha, o c√≥digo a seguir √© executado para aumentar o n√∫mero de linhas. </font><font style="vertical-align: inherit;">As verifica√ß√µes s√£o realizadas para os d√≠gitos m√©dio e inferior, para que permane√ßam entre 0 e 9. Mas o d√≠gito superior pode ser aumentado infinitamente. </font><font style="vertical-align: inherit;">Se ap√≥s o incremento do n√∫mero de linhas o d√≠gito inferior for 0, isso significa que o jogador acabou de completar um conjunto de 10 linhas e voc√™ precisar√° aumentar o n√∫mero do n√≠vel. Como voc√™ pode ver no c√≥digo abaixo, uma verifica√ß√£o adicional √© realizada antes do incremento de n√≠vel. </font><font style="vertical-align: inherit;">A segunda verifica√ß√£o est√° relacionada ao n√≠vel de entrada selecionado. Para ir para um determinado n√≠vel </font><font style="vertical-align: inherit;">, independentemente do n√≠vel inicial, o jogador deve limpar</font></font><br><br> <code>9BA8: INC $0050 ; increment middle-lowest digit pair <br> 9BAA: LDA $0050 <br> 9BAC: AND #$0F <br> 9BAE: CMP #$0A ; if (lowest digit &gt; 9) { <br> 9BB0: BMI $9BC7 <br> 9BB2: LDA $0050 <br> 9BB4: CLC <br> 9BB5: ADC #$06 ; set lowest digit to 0, increment middle digit <br> 9BB7: STA $0050 <br> 9BB9: AND #$F0 <br> 9BBB: CMP #$A0 ; if (middle digit &gt; 9) { <br> 9BBD: BCC $9BC7 <br> 9BBF: LDA $0050 <br> 9BC1: AND #$0F <br> 9BC3: STA $0050 ; set middle digit to 0 <br> 9BC5: INC $0051 ; increment highest digit <br> ; } <br> ; }</code> <br> <br><font style="vertical-align: inherit;"></font><br><br><font style="vertical-align: inherit;"></font><br><br> <code>9BC7: LDA $0050 <br> 9BC9: AND #$0F <br> 9BCB: BNE $9BFB ; if (lowest digit == 0) { <br> 9BCD: JMP $9BD0 <br> <br> 9BD0: LDA $0051 <br> 9BD2: STA $00A9 <br> 9BD4: LDA $0050 <br> 9BD6: STA $00A8 ; copy digits from $0050-$0051 to $00A8-$00A9 <br> <br> 9BD8: LSR $00A9 <br> 9BDA: ROR $00A8 <br> 9BDC: LSR $00A9 <br> 9BDE: ROR $00A8 <br> 9BE0: LSR $00A9 <br> 9BE2: ROR $00A8 ; treat $00A8-$00A9 as a 16-bit packed BCD value <br> 9BE4: LSR $00A9 ; and right-shift it 4 times <br> 9BE6: ROR $00A8 ; this leaves the highest and middle digits in $00A8 <br> <br> 9BE8: LDA $0044 <br> 9BEA: CMP $00A8 ; if (level &lt; [$00A8]) { <br> 9BEC: BPL $9BFB <br> <br> 9BEE: INC $0044 ; increment level <br> ; } <br> ; }</code> <br> <br><font style="vertical-align: inherit;"></font><code>X</code><font style="vertical-align: inherit;"></font><code>10X</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">linhas Por exemplo, se um jogador come√ßa no n√≠vel 5, ele permanecer√° nele at√© completar 60 linhas, ap√≥s o que passar√° para o n√≠vel 6. Depois disso, a cada 10 linhas adicionais, voc√™ aumentar√° o n√∫mero do n√≠vel. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Para executar essa verifica√ß√£o, o valor das linhas preenchidas √© copiado de </font></font><code>$0050</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- </font></font><code>$0051</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">para </font></font><code>$00A8</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- </font></font><code>$00A9</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Em seguida, a c√≥pia √© deslocada para a direita 4 vezes, o que para um BCD compactado √© semelhante a dividir por 10. O menor d√≠gito decimal √© descartado e os d√≠gitos mais altos e m√©dios s√£o deslocados em uma posi√ß√£o, resultando em mordidelas </font></font><code>$00A8</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/8e4/c0b/2e7/8e4c0b2e7d53a33d54cea8717a872a65.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">No entanto, no endere√ßo, </font></font><code>$9BEA</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">o n√∫mero do n√≠vel √© diretamente comparado ao valor compactado do BCD </font></font><code>$00A8</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">N√£o h√° pesquisa na tabela para converter o valor BCD em decimal, e esse √© um erro claro. </font><font style="vertical-align: inherit;">Por exemplo, na figura acima, o n√∫mero do n√≠vel deve ser comparado com </font></font><code>$12</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(18 em decimal), e n√£o 12. Portanto, se um jogador decidir come√ßar no n√≠vel 17, o n√≠vel passar√° para 120 linhas, porque 18 √© mais que 17. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A tabela mostra o n√∫mero esperado de linhas necess√°rias para a transi√ß√£o em cada n√≠vel inicial. </font><font style="vertical-align: inherit;">√â comparado ao que realmente acontece devido a um bug.</font></font><br><br><div class="scrollable-table"><table><tbody><tr><th> <code> </code> </th> <td>  0 0 </td><td>  1 </td><td>  2 </td><td>  3 </td><td>  4 </td><td>  5 </td><td>  6 </td><td>  7 </td><td>  8 </td><td>  9 </td><td>  10 </td><td>  11 </td><td>  12 </td><td>  13 </td><td>  14 </td><td>  15 </td><td>  16 </td><td>  17 </td><td>  18 </td><td>  19 </td></tr><tr><th> <code>  </code> </th> <td>  10 </td><td>  20 </td><td>  30 </td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 40. </font></font></td><td>  50. </td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 60 </font></font></td><td>  70 </td><td>  80 </td><td>  90 </td><td>  100 </td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 110 </font></font></td><td>  120 </td><td>  130 </td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 140 </font></font></td><td>  150 </td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 160 </font></font></td><td>  170 </td><td>  180 </td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 190 </font></font></td><td>  200 </td></tr><tr><th> <code>    </code> </th> <td>  10 </td><td>  20 </td><td>  30 </td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 40. </font></font></td><td>  50. </td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 60 </font></font></td><td>  70 </td><td>  80 </td><td>  90 </td><td>  100 </td><td>  100 </td><td>  100 </td><td>  100 </td><td>  100 </td><td>  100 </td><td>  100 </td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 110 </font></font></td><td>  120 </td><td>  130 </td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 140 </font></font></td></tr></tbody></table></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O valor esperado √© o mesmo que verdadeiro para os n√≠veis iniciais de 0 a 9. </font><font style="vertical-align: inherit;">De fato, a coincid√™ncia para o n√≠vel de entrada 9 √© aleat√≥ria; </font><font style="vertical-align: inherit;">10-15 tamb√©m vai para o pr√≥ximo n√≠vel com 100 linhas, porque </font></font><code>$10</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- este √© 16 na forma decimal. </font><font style="vertical-align: inherit;">A maior diferen√ßa entre o esperado e o real √© de 60 linhas. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Suspeito que o bug se deva a altera√ß√µes de design nos est√°gios posteriores do desenvolvimento. </font><font style="vertical-align: inherit;">Veja a tela do menu, permitindo ao jogador escolher um n√≠vel de entrada.</font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/858/51e/019/85851e019d65bf00d265fa4ea277b8c2.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> N√£o h√° explica√ß√£o sobre como come√ßar a partir dos n√≠veis acima de 9. Mas no livreto Nintendo Tetris, esse segredo √© revelado: </font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/c20/cee/c3b/c20ceec3b4b30879812be109b6666b79.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Parece que esse recurso oculto foi inventado no √∫ltimo momento. Talvez tenha sido adicionado muito perto da data de lan√ßamento, o que n√£o permitiu test√°-lo completamente. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">De fato, a verifica√ß√£o da s√©rie inicial cont√©m um segundo erro relacionado √† sa√≠da de valores para o intervalo. Abaixo est√£o os coment√°rios no c√≥digo que explicam melhor o que acontece em um n√≠vel baixo. </font><font style="vertical-align: inherit;">A compara√ß√£o √© realizada subtraindo e verificando o sinal do resultado. Mas um n√∫mero assinado de byte √∫nico √© limitado a -128 a 127. Se a diferen√ßa for menor que -128, o n√∫mero √© transferido e o resultado se torna um n√∫mero positivo. Este princ√≠pio √© explicado nos coment√°rios no c√≥digo. </font><font style="vertical-align: inherit;">Ao verificar se a diferen√ßa est√° nesse intervalo, deve-se levar em considera√ß√£o que o n√∫mero do n√≠vel, ao aumentar para valores maiores que 255, efetua a transfer√™ncia para 0 e</font></font><br><br> <code>9BE8: LDA $0044 <br> 9BEA: CMP $00A8 ; if (level - [$00A8] &lt; 0) { <br> 9BEC: BPL $9BFB <br> <br> 9BEE: INC $0044 ; increment level <br> ; }</code> <br> <br><font style="vertical-align: inherit;"></font><br><br> <code>9BE8: LDA $0044 ; difference = level - [$00A8]; <br> 9BEA: CMP $00A8 ; if (difference &lt; 0 &amp;&amp; difference &gt;= -128) { <br> 9BEC: BPL $9BFB <br> <br> 9BEE: INC $0044 ; increment level <br> ; }</code> <br> <br><font style="vertical-align: inherit;"></font><code>$00A8</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">potencialmente, ele pode conter qualquer valor, porque sua mordidela superior √© retirada </font></font><code>$0051</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, cujo incremento pode ocorrer infinitamente. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Esses efeitos se sobrep√µem, criando per√≠odos nos quais o n√∫mero do n√≠vel permanece inalterado por engano. </font><font style="vertical-align: inherit;">Os per√≠odos ocorrem em intervalos regulares de 2.900 linhas, iniciando em 2.190 linhas e duram 800 linhas. </font><font style="vertical-align: inherit;">Por exemplo, de 2190 ( </font></font><code>L90</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) a 2990 ( </font></font><code>T90</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">), o n√≠vel permanece igual a </font></font><code>$DB</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">( </font></font><code>96</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">), como mostrado abaixo.</font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/055/e15/8de/055e158de2ecde24e0f052cd325bef32.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O pr√≥ximo per√≠odo acontece de 5090 a 5890, o n√≠vel √© constantemente igual a </font></font><code>$AD</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">( </font></font><code>06</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">). </font><font style="vertical-align: inherit;">Al√©m disso, durante esses per√≠odos, a paleta de cores tamb√©m n√£o muda.</font></font><br><br><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Desenho de Tetrimino para colorir </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Em cada n√≠vel, as pe√ßas de tetrimino recebem 4 cores √∫nicas. </font><font style="vertical-align: inherit;">As cores s√£o retiradas da tabela localizada em </font></font><code>$984C</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Seus registros s√£o reutilizados a cada 10 n√≠veis. </font><font style="vertical-align: inherit;">Da esquerda para a direita: as colunas da tabela correspondentes √†s √°reas em preto, branco, azul e vermelho da imagem abaixo.</font></font><br><br> <code>984C: 0F 30 21 12 ; level 0 <br> 9850: 0F 30 29 1A ; level 1 <br> 9854: 0F 30 24 14 ; level 2 <br> 9858: 0F 30 2A 12 ; level 3 <br> 985C: 0F 30 2B 15 ; level 4 <br> 9860: 0F 30 22 2B ; level 5 <br> 9864: 0F 30 00 16 ; level 6 <br> 9868: 0F 30 05 13 ; level 7 <br> 986C: 0F 30 16 12 ; level 8 <br> 9870: 0F 30 27 16 ; level 9</code> <br> <br><font style="vertical-align: inherit;"></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/68e/fc4/7d7/68efc47d771e9c673b003d76810d74fb.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Os valores correspondem √† paleta de cores do NES. </font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/e80/c0a/8b6/e80c0a8b624b90261042d71eb21d50db.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">As 2 primeiras cores de cada entrada s√£o sempre em preto e branco. No entanto, a primeira cor √© realmente ignorada; independentemente do valor, √© considerada uma cor transparente atrav√©s da qual um fundo preto s√≥lido √© exibido. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O acesso √† tabela de cores √© realizado na rotina em </font></font><code>$9808</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">O √≠ndice da tabela de cores √© baseado no n√∫mero do n√≠vel dividido por um restante de 10. O ciclo copia a entrada para as tabelas da paleta na VRAM. </font><font style="vertical-align: inherit;">A divis√£o com o restante √© emulada por uma subtra√ß√£o constante de 10 at√© o resultado ser menor que 10. O in√≠cio da sub-rotina com coment√°rios √© mostrado abaixo.</font></font><br><br> <code>9808: LDA $0064 <br> 980A: CMP #$0A <br> 980C: BMI $9814 <br> 980E: SEC <br> 980F: SBC #$0A <br> 9811: JMP $980A ; index = levelNumber % 10; <br> <br> 9814: ASL <br> 9815: ASL <br> 9816: TAX ; index *= 4; <br> <br> 9817: LDA #$00 <br> 9819: STA $00A8 ; for(i = 0; i &lt; 32; i += 16) { <br> <br> 981B: LDA #$3F <br> 981D: STA $2006 <br> 9820: LDA #$08 <br> 9822: CLC <br> 9823: ADC $00A8 <br> 9825: STA $2006 ; palette = $3F00 + i + 8; <br> <br> 9828: LDA $984C,X <br> 982B: STA $2007 ; palette[0] = colorTable[index + 0]; <br> <br> 982E: LDA $984D,X <br> 9831: STA $2007 ; palette[1] = colorTable[index + 1]; <br> <br> 9834: LDA $984E,X <br> 9837: STA $2007 ; palette[2] = colorTable[index + 2]; <br> <br> 983A: LDA $984F,X <br> 983D: STA $2007 ; palette[3] = colorTable[index + 3]; <br> <br> 9840: LDA $00A8 <br> 9842: CLC <br> 9843: ADC #$10 <br> 9845: STA $00A8 <br> 9847: CMP #$20 <br> 9849: BNE $981B ; } <br> <br> 984B: RTS ; return;</code> <br> <br><font style="vertical-align: inherit;"></font><br><br><font style="vertical-align: inherit;"></font><br><br> <code>9808: LDA $0064 ; index = levelNumber; <br> 980A: CMP #$0A ; while(index &gt;= 10) { <br> 980C: BMI $9814 <br> 980E: SEC <br> 980F: SBC #$0A ; index -= 10; <br> 9811: JMP $980A ; }</code> <br> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">No entanto, conforme declarado na se√ß√£o anterior, subtra√ß√£o e ramifica√ß√£o com base no sinal de diferen√ßa s√£o usadas em compara√ß√£o. </font><font style="vertical-align: inherit;">Um n√∫mero assinado de byte √∫nico √© limitado a -128 a 127. Os coment√°rios atualizados abaixo refletem esse princ√≠pio. </font><font style="vertical-align: inherit;">Os coment√°rios abaixo s√£o mais simplificados. </font><font style="vertical-align: inherit;">Esta reda√ß√£o revela um erro no c√≥digo. </font><font style="vertical-align: inherit;">A opera√ß√£o de divis√£o restante √© completamente ignorada para n√≠veis de 138 e superiores. </font><font style="vertical-align: inherit;">Em vez disso, o √≠ndice √© atribu√≠do diretamente ao n√∫mero do n√≠vel, que fornece acesso a bytes muito al√©m do final da tabela de cores. </font><font style="vertical-align: inherit;">Como mostrado abaixo, isso pode at√© levar a um tetrimino quase invis√≠vel.</font></font><br><br> <code>9808: LDA $0064 ; index = levelNumber; <br> ; difference = index - 10; <br> 980A: CMP #$0A ; while(difference &gt;= 0 &amp;&amp; difference &lt;= 127) { <br> 980C: BMI $9814 <br> 980E: SEC ; index -= 10; <br> 980F: SBC #$0A ; difference = index - 10; <br> 9811: JMP $980A ; }</code> <br> <br><font style="vertical-align: inherit;"></font><br><br> <code>9808: LDA $0064 ; index = levelNumber; <br> 980A: CMP #$0A ; while(index &gt;= 10 &amp;&amp; index &lt;= 137) { <br> 980C: BMI $9814 <br> 980E: SEC <br> 980F: SBC #$0A ; index -= 10; <br> 9811: JMP $980A ; }</code> <br> <br><font style="vertical-align: inherit;"></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/6ed/2e5/2c6/6ed2e52c6a20dc9c8c1ffd1bf13d9b37.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Abaixo est√£o as cores de todos os 256 n√≠veis. </font><font style="vertical-align: inherit;">As pe√ßas s√£o organizadas em 10 colunas para enfatizar o uso c√≠clico da tabela de cores, violada no n√≠vel 138. Linhas e colunas nos cabe√ßalhos s√£o indicadas em decimal.</font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/423/6f0/ed6/4236f0ed6a508633b746d773a530fe90.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ap√≥s 255, o n√∫mero do n√≠vel retorna a 0. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Al√©m disso, como mencionado na se√ß√£o anterior, alguns n√≠veis n√£o mudam at√© que 800 linhas sejam removidas. </font><font style="vertical-align: inherit;">Durante esses longos n√≠veis, as cores permanecem inalteradas.</font></font><br><br><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Modo de jogo </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O modo de jogo armazenado no endere√ßo </font></font><code>$00C0</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">determina qual das v√°rias telas e menus √© atualmente exibida ao usu√°rio.</font></font><br><br><div class="scrollable-table"><table><tbody><tr><th>  Valor </th><th>  Descri√ß√£o do produto </th></tr><tr><td> <code>00</code> </td> <td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Tela de informa√ß√µes legais </font></font></td></tr><tr><td> <code>01</code> </td> <td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Tela inicial </font></font></td></tr><tr><td> <code>02</code> </td> <td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Menu Tipo de Jogo </font></font></td></tr><tr><td> <code>03</code> </td> <td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Menu de n√≠veis e alturas </font></font></td></tr><tr><td> <code>04</code> </td> <td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Jogo / pontua√ß√£o m√°xima / final / pausa </font></font></td></tr><tr><td> <code>05</code> </td> <td>  Demo </td></tr></tbody></table></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Como mostrado acima, o jogo possui uma rotina inteligentemente escrita que atua como uma instru√ß√£o de troca usando a pequena tabela de navega√ß√£o endian localizada imediatamente ap√≥s a chamada. </font><font style="vertical-align: inherit;">A lista acima mostra os endere√ßos de todos os modos de jogo. Observe que os modos "Jogo" e "Demo" usam o mesmo c√≥digo. </font><font style="vertical-align: inherit;">Essa rotina nunca volta. Em vez disso, o c√≥digo usa o endere√ßo de retorno; normalmente aponta para a instru√ß√£o imediatamente ap√≥s a chamada para o salto para a sub-rotina (menos 1 byte), mas neste caso aponta para a tabela de salto. O endere√ßo de retorno √© retirado da pilha e armazenado em </font><font style="vertical-align: inherit;">- </font><font style="vertical-align: inherit;">. Depois de salvar o endere√ßo da tabela de salto, o c√≥digo usa o valor no registro A como um √≠ndice e executa a transi√ß√£o correspondente.</font></font><br><br> <code>8161: LDA $00C0 <br> 8163: JSR $AC82 ; switch(gameMode) { <br> 8166: 00 82 ; case 0: goto 8200; //     <br> 8168: 4F 82 ; case 1: goto 824F; //   <br> 816A: D1 82 ; case 2: goto 82D1; //    <br> 816C: D7 83 ; case 3: goto 83D7; //     <br> 816E: 5D 81 ; case 4: goto 815D; //  /   /  /  <br> 8170: 5D 81 ; case 5: goto 815D; //  <br> ; }</code> <br> <br><font style="vertical-align: inherit;"></font><br><br><font style="vertical-align: inherit;"></font><code>$0000</code><font style="vertical-align: inherit;"></font><code>$0001</code><font style="vertical-align: inherit;"></font><br><br> <code>AC82: ASL <br> AC83: TAY <br> AC84: INY <br> <br> AC85: PLA <br> AC86: STA $0000 <br> AC88: PLA ; pop return address off of stack <br> AC89: STA $0001 ; and store it at $0000-$0001 <br> <br> AC8B: LDA ($00),Y <br> AC8D: TAX <br> AC8E: INY <br> AC8F: LDA ($00),Y <br> AC91: STA $0001 <br> AC93: STX $0000 <br> AC95: JMP ($0000) ; goto Ath 16-bit address <br> ; in table at [$0000-$0001]</code> <br> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> O c√≥digo pode usar essa rotina de comuta√ß√£o desde que os √≠ndices estejam pr√≥ximos de 0 e n√£o haja espa√ßos ou poucos entre os casos poss√≠veis. </font></font><br><br><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Tela de informa√ß√µes legais </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> O jogo come√ßa com uma tela mostrando um aviso legal. </font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/524/4e2/d4b/5244e2d4b26989579afaad64838c0962.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Na parte inferior da tela, </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Aleksey Pazhitnov</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> √© mencionado </font><font style="vertical-align: inherit;">como o inventor, designer e programador do primeiro Tetris. Em 1984, trabalhando como desenvolvedor de computadores no </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dorodnitsyn Computing Center</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (um instituto de pesquisa l√≠der da Academia Russa de Ci√™ncias em Moscou), ele desenvolveu um prot√≥tipo do jogo na </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Electronics-60</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (clone sovi√©tico DEC </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">LSI-11</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ). Um prot√≥tipo foi desenvolvido para um modo de texto monocrom√°tico verde no qual os quadrados s√£o indicados por pares de colchetes </font></font><code>[]</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Com a ajuda do estudante de 16 anos </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Vadim Gerasimov</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> e do engenheiro de computa√ß√£o Dmitry Pavlovsky alguns dias ap√≥s a inven√ß√£o do jogo, o prot√≥tipo foi portado para um PC IBM com MS DOS e </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Turbo Pascal</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Ao longo de dois anos, eles aperfei√ßoaram o jogo juntos, adicionando recursos como cores do tetrimino, estat√≠sticas e, mais importante, um c√≥digo de tempo e gr√°ficos que permitia que o jogo funcionasse em uma variedade de modelos e clones de PC. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Infelizmente, devido √†s peculiaridades da Uni√£o Sovi√©tica na √©poca, suas tentativas de monetizar o jogo n√£o tiveram √™xito e, no final, eles decidiram compartilhar a vers√£o para PC com seus amigos de gra√ßa. A partir desse momento, "Tetris" come√ßou a se espalhar viralmente por todo o pa√≠s e al√©m, copiado de disco para disco. Mas desde que o jogo foi desenvolvido por funcion√°rios de uma ag√™ncia governamental, o estado era o propriet√°rio e, em 1987, a organiza√ß√£o respons√°vel pelo com√©rcio internacional de tecnologias eletr√¥nicas assumiu o licenciamento do jogo ( </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Electronorgtekhnika (ELORG)</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) A abreviatura V / O na tela de informa√ß√µes legais pode ser abreviada para Version Originale. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A empresa de software brit√¢nica </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Andromeda</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> tentou obter direitos sobre a Tetris e, antes da conclus√£o da transa√ß√£o, sublicenciou o jogo para outros fornecedores, por exemplo, a editora brit√¢nica de jogos de computador </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mirrorsoft</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . A Mirrorsoft, por sua vez, a sublicenciou para a </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tengen</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , uma subsidi√°ria da Atari Games. Tengen concedeu ao Bullet-Proof Software os direitos de desenvolver um jogo para computadores e consoles no Jap√£o, o que resultou em Tetris para a Nintendo </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Famicom</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Abaixo est√° sua tela de informa√ß√µes legais.</font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/750/b96/6c0/750b966c0d526110e504b409b3f1a1af.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Curiosamente, nesta vers√£o, o estudante Vadim Gerasimov √© chamado de designer e programador original. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tentando proteger a vers√£o port√°til do console Game Boy, a Nintendo usou o Bullet-Proof Software para concluir um acordo bem-sucedido diretamente com a ELORG. No processo de conclus√£o do acordo, a ELORG revisou seu contrato com a Andr√¥meda, acrescentando que a Andr√¥meda s√≥ tinha direitos de jogos para computadores e m√°quinas de fliperama. Por esse motivo, o Bullet-Proof Software teve que pagar royalties da ELORG por todos os cartuchos vendidos para a Famicom, porque os direitos que recebeu de Tengen acabaram sendo falsos. Mas, por meio da reconcilia√ß√£o com a ELORG, a Bullet-Proof Software finalmente conseguiu obter direitos mundiais de jogos de console para a Nintendo.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O software √† prova de balas sublicenciou os direitos dos jogos port√°teis da Nintendo e juntos eles desenvolveram o Game Boy Tetris, que √© refletido na tela de informa√ß√µes legais abaixo.</font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/0dc/d28/e4c/0dcd28e4c4f7b3da1a0259fcdbcf9b70.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Com direitos globais de jogos de console, a Nintendo desenvolveu a vers√£o Tetris para NES que estamos explorando neste artigo. Em seguida, o software √† prova de balas sublicenciou os direitos da Nintendo, o que lhe permitiu continuar vendendo cartuchos para a Famicom no Jap√£o. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Isto foi seguido por uma complexa batalha jur√≠dica. Tanto a Nintendo quanto a Tengen exigiram que a parte contr√°ria parasse de produzir e vender sua vers√£o do jogo. Como resultado, a Nintendo venceu e centenas de milhares de cartuchos </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tengen Tetris</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> foram destru√≠dos. O veredicto do tribunal tamb√©m proibiu v√°rias outras empresas, como a Mirrorsoft, de criar vers√µes de console. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pajitnov nunca recebeu dedu√ß√µes da ELORG ou do estado sovi√©tico. No entanto, em 1991 ele se mudou para os EUA e em 1996, com o apoio do propriet√°rio do Bullet-Proof Software</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Henka Rogers</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> co-fundou a </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The Tetris Company</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , que lhe permitiu lucrar com vers√µes para dispositivos m√≥veis e consoles modernos.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">√â interessante olhar para a tela de informa√ß√µes legais como uma janela que d√° uma id√©ia da origem modesta do jogo e das batalhas subsequentes pelos direitos de propriedade intelectual, porque para a maioria dos jogadores essa tela √© apenas um obst√°culo irritante, cujo desaparecimento parece ter que esperar para sempre. O atraso √© definido por dois contadores, contando sequencialmente de 255 a 0. A primeira fase n√£o pode ser pulada e a segunda √© pulada pressionando o bot√£o Iniciar. Portanto, a tela de informa√ß√µes legais √© exibida por pelo menos 4,25 segundos e n√£o mais do que 8,5 segundos. No entanto, acho que a maioria dos jogadores desiste, parando de pressionar Iniciar durante o primeiro intervalo e, por isso, eles est√£o aguardando a conclus√£o completa.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O tempo das fases, assim como o resto do jogo, √© governado por um manipulador de interrup√ß√µes n√£o mascarado chamado no in√≠cio de cada intervalo de apagamento vertical, um curto per√≠odo de tempo entre a renderiza√ß√£o de quadros de televis√£o. Ou seja, a cada 16.6393 milissegundos, a execu√ß√£o normal do programa √© interrompida pelo seguinte c√≥digo. </font><font style="vertical-align: inherit;">O manipulador come√ßa passando os valores dos principais registradores para a pilha e recuperando-os ap√≥s a conclus√£o, para n√£o interferir na tarefa interrompida. A chamada </font><font style="vertical-align: inherit;">atualiza o VRAM, convertendo a descri√ß√£o do modelo de mem√≥ria para o que √© exibido na tela. Al√©m disso, o manipulador reduz o valor do contador da tela de informa√ß√µes legais se for maior que zero. Desafio</font></font><br><br> <code>8005: PHA <br> 8006: TXA <br> 8007: PHA <br> 8008: TYA <br> 8009: PHA ; save A, X, Y <br> <br> 800A: LDA #$00 <br> 800C: STA $00B3 <br> 800E: JSR $804B ; render(); <br> <br> 8011: DEC $00C3 ; legalScreenCounter1--; <br> <br> 8013: LDA $00C3 <br> 8015: CMP #$FF ; if (legalScreenCounter1 &lt; 0) { <br> 8017: BNE $801B ; legalScreenCounter1 = 0; <br> 8019: INC $00C3 ; } <br> <br> 801B: JSR $AB5E ; initializeOAM(); <br> <br> 801E: LDA $00B1 <br> 8020: CLC <br> 8021: ADC #$01 <br> 8023: STA $00B1 <br> 8025: LDA #$00 <br> 8027: ADC $00B2 <br> 8029: STA $00B2 ; frameCounter++; <br> <br> 802B: LDX #$17 <br> 802D: LDY #$02 <br> 802F: JSR $AB47 ; randomValue = generateNextPseudorandomNumber(randomValue); <br> <br> 8032: LDA #$00 <br> 8034: STA $00FD <br> 8036: STA $2005 ; scrollX = 0; <br> 8039: STA $00FC <br> 803B: STA $2005 ; scrollY = 0; <br> <br> 803E: LDA #$01 <br> 8040: STA $0033 ; verticalBlankingInterval = true; <br> <br> 8042: JSR $9D51 ; pollControllerButtons(); <br> <br> 8045: PLA <br> 8046: TAY <br> 8047: PLA <br> 8048: TAX <br> 8049: PLA ; restore A, X, Y <br> <br> 804A: RTI ; resume interrupted task</code> <br> <br><font style="vertical-align: inherit;"></font><code>render()</code><font style="vertical-align: inherit;"></font><code>initializeOAM()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">executa a etapa exigida pelo equipamento de gera√ß√£o de quadros. O manipulador continua a trabalhar incrementando o contador de quadros - o pequeno valor endian de 16 bits armazenado no endere√ßo </font></font><code>$00B1</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- </font></font><code>$00B2</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">que ele usa em locais diferentes para tempo controlado. Depois disso, o seguinte n√∫mero pseudo-aleat√≥rio √© gerado; como mencionado acima, isso acontece independentemente do modo pelo menos uma vez por quadro. O </font></font><code>$8040</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sinalizador de intervalo de apagamento vertical √© definido </font><font style="vertical-align: inherit;">no endere√ßo </font><font style="vertical-align: inherit;">, o que significa que o manipulador acabou de ser executado. Finalmente, os bot√µes do controlador s√£o pesquisados; o comportamento dessa rotina √© descrito abaixo na se√ß√£o Demo. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O sinalizador √© </font></font><code>verticalBlankingInterval</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">usado pela rotina discutida acima. Ele continua at√© que a execu√ß√£o do manipulador de interrup√ß√£o comece.</font></font><br><br> <code>AA2F: JSR $E000 ; updateAudio(); <br> <br> AA32: LDA #$00 <br> AA34: STA $0033 ; verticalBlankingInterval = false; <br> <br> AA36: NOP <br> <br> AA37: LDA $0033 <br> AA39: BEQ $AA37 ; while(!verticalBlankingInterval) { } <br> <br> AA3B: LDA #$FF <br> AA3D: LDX #$02 <br> AA3F: LDY #$02 <br> AA41: JSR $AC6A ; fill memory page 2 with all $FF's <br> <br> AA44: RTS ; return;</code> <br> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Essa rotina de bloqueio √© usada por dois est√°gios de tempo da tela de informa√ß√µes legais, que s√£o executados um ap√≥s o outro. </font><font style="vertical-align: inherit;">O script Lua AI ignora esse atraso definindo os dois contadores como 0.</font></font><br><br> <code>8236: LDA #$FF <br> 8238: JSR $A459 <br> <br> ... <br> <br> A459: STA $00C3 ; legalScreenCounter1 = 255; <br> <br> A45B: JSR $AA2F ; do { <br> A45E: LDA $00C3 ; waitForVerticalBlankingInterval(); <br> A460: BNE $A45B ; } while(legalScreenCounter1 &gt; 0); <br> <br> A462: RTS ; return;</code> <br> <br> <code>823B: LDA #$FF <br> 823D: STA $00A8 ; legalScreenCounter2 = 255; <br> <br> ; do { <br> <br> 823F: LDA $00F5 ; if (just pressed Start) { <br> 8241: CMP #$10 ; break; <br> 8243: BEQ $824C ; } <br> <br> 8245: JSR $AA2F ; waitForVerticalBlankingInterval(); <br> <br> 8248: DEC $00A8 ; legalScreenCounter2--; <br> 824A: BNE $823F ; } while(legalScreenCounter2 &gt; 0); <br> <br> 824C: INC $00C0 ; gameMode = TITLE_SCREEN;</code> <br> <br><font style="vertical-align: inherit;"></font><br><br><h3>  Demo </h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A demo mostra cerca de 80 segundos de jogabilidade pr√©-gravada. Ele n√£o apenas exibe o arquivo de v√≠deo, mas usa o mesmo mecanismo do jogo. Durante a reprodu√ß√£o, duas tabelas s√£o usadas. O primeiro, localizado no endere√ßo </font></font><code>$DF00</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, cont√©m a seguinte sequ√™ncia de cria√ß√£o do tetrimino: </font></font><br><br> <code>TJTSZJTSZJSZLZJTTSITO JSZLZLIOLZLIOJTSITOJ</code> <br> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ao criar uma figura, ela √© selecionada aleatoriamente ou lida da tabela, dependendo do modo. A troca ocorre no endere√ßo </font></font><code>$98EB</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">O tipo tetrimino √© extra√≠do dos bits 6, 5 e 4 de cada byte. De tempos em tempos, essa opera√ß√£o nos d√° um valor </font><font style="vertical-align: inherit;">- o tipo errado. No entanto, a tabela a cria√ß√£o de formas ( </font><font style="vertical-align: inherit;">) utilizado para uma convers√£o de tipo em Tetrimino orienta√ß√£o ID √© na verdade localizada entre as duas tabelas ligadas: </font><font style="vertical-align: inherit;">Significado</font></font><br><br> <code>98EB: LDA $00C0 <br> 98ED: CMP #$05 <br> 98EF: BNE $9903 ; if (gameMode == DEMO) { <br> <br> 98F1: LDX $00D3 <br> 98F3: INC $00D3 <br> 98F5: LDA $DF00,X ; value = demoTetriminoTypeTable[++demoIndex]; <br> <br> 98F8: LSR <br> 98F9: LSR <br> 98FA: LSR <br> 98FB: LSR <br> 98FC: AND #$07 <br> 98FE: TAX ; tetriminoType = bits 6,5,4 of value; <br> <br> 98FF: LDA $994E,X <br> 9902: RTS ; return spawnTable[tetriminoType]; <br> ; } else { <br> ; pickRandomTetrimino(); <br> ; }</code> <br> <br><font style="vertical-align: inherit;"></font><code>$07</code><font style="vertical-align: inherit;"></font><code>$994E</code><font style="vertical-align: inherit;"></font><br><br> <code>993B: 00 00 00 00 ; T <br> 993F: 01 01 01 01 ; J <br> 9943: 02 02 ; Z <br> 9945: 03 ; O <br> 9946: 04 04 ; S <br> 9948: 05 05 05 05 ; L <br> 994C: 06 06 ; I</code> <br> <br> <code>994E: 02 ; Td <br> 994F: 07 ; Jd <br> 9950: 08 ; Zh <br> 9951: 0A ; O <br> 9952: 0B ; Sh <br> 9953: 0E ; Ld <br> 9954: 12 ; Ih</code> <br> <br> <code>9956: 02 02 02 02 ; Td <br> 995A: 07 07 07 07 ; Jd <br> 995E: 08 08 ; Zh <br> 9960: 0A ; O <br> 9961: 0B 0B ; Sh <br> 9963: 0E 0E 0E 0E ; Ld <br> 9967: 12 12 ; Ih</code> <br> <br><font style="vertical-align: inherit;"></font><code>$07</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">obriga a ler al√©m do final da tabela, na pr√≥xima, que fornece </font></font><code>Td</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">( </font></font><code>$02</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">). </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Devido a esse efeito, esse esquema pode nos fornecer uma sequ√™ncia ilimitada, mas reproduz√≠vel, de IDs pseudo-aleat√≥rios da orienta√ß√£o das figuras criadas. O c√≥digo funcionar√° porque qualquer endere√ßo arbitr√°rio em uma sequ√™ncia vari√°vel de bytes n√£o nos permite determinar onde a tabela termina. De fato, a sequ√™ncia no endere√ßo </font></font><code>$DF00</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pode ser parte de algo completamente n√£o relacionado a isso, especialmente considerando que o objetivo dos 5 bits diferentes de zero restantes n√£o √© claro, e a sequ√™ncia gerada demonstra repetibilidade. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Durante a inicializa√ß√£o do modo de demonstra√ß√£o, o √≠ndice da tabela ( </font></font><code>$00D3</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) √© redefinido para o endere√ßo </font></font><code>$872B</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A segunda tabela da demonstra√ß√£o cont√©m um registro dos bot√µes do gamepad codificados em pares de bytes. </font><font style="vertical-align: inherit;">Os bits do primeiro byte correspondem aos bot√µes.</font></font><br><br><div class="scrollable-table"><table><tbody><tr><th> <code>7</code> </th> <th> <code>6</code> </th> <th> <code>5</code> </th> <th> <code>4</code> </th> <th> <code>3</code> </th> <th> <code>2</code> </th> <th> <code>1</code> </th> <th> <code>0</code> </th> </tr><tr><td>  Um </td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> B </font></font></td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Selecione </font></font></td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Iniciar </font></font></td><td>  Para cima </td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Para baixo </font></font></td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Para a esquerda </font></font></td><td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Para a direita </font></font></td></tr></tbody></table></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O segundo byte armazena o n√∫mero de quadros durante os quais uma combina√ß√£o de bot√µes √© pressionada. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A tabela ocupa endere√ßos </font></font><code>$DD00</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- </font></font><code>$DEFF</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">e consiste em 256 pares. O acesso √© realizado pela sub-rotina no endere√ßo </font></font><code>$9D5B</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Como a tabela de bot√µes de demonstra√ß√£o tem 512 bytes, √© necess√°rio um √≠ndice de dois bytes para acess√°-la. O √≠ndice √© armazenado como pouco endian em </font><font style="vertical-align: inherit;">- </font><font style="vertical-align: inherit;">. √â inicializado com o valor do endere√ßo da tabela </font><font style="vertical-align: inherit;">e seu incremento √© realizado pelo seguinte c√≥digo. </font><font style="vertical-align: inherit;">Os programadores deixaram o processamento de entrada do player no c√≥digo, o que nos permite analisar o processo de desenvolvimento e substituir a demo por outro registro. O modo de grava√ß√£o demo √© ativado quando </font><font style="vertical-align: inherit;">um valor √© atribu√≠do.</font></font><br><br> <code>9D5B: LDA $00D0 ; if (recording mode) { <br> 9D5D: CMP #$FF ; goto recording; <br> 9D5F: BEQ $9DB0 ; } <br> <br> 9D61: JSR $AB9D ; pollController(); <br> 9D64: LDA $00F5 ; if (start button pressed) { <br> 9D66: CMP #$10 ; goto startButtonPressed; <br> 9D68: BEQ $9DA3 ; } <br> <br> 9D6A: LDA $00CF ; if (repeats == 0) { <br> 9D6C: BEQ $9D73 ; goto finishedMove; <br> ; } else { <br> 9D6E: DEC $00CF ; repeats--; <br> 9D70: JMP $9D9A ; goto moveInProgress; <br> ; } <br> <br> finishedMove: <br> <br> 9D73: LDX #$00 <br> 9D75: LDA ($D1,X) <br> 9D77: STA $00A8 ; buttons = demoButtonsTable[index]; <br> <br> 9D79: JSR $9DE8 ; index++; <br> <br> 9D7C: LDA $00CE <br> 9D7E: EOR $00A8 <br> 9D80: AND $00A8 <br> 9D82: STA $00F5 ; setNewlyPressedButtons(difference between heldButtons and buttons); <br> <br> 9D84: LDA $00A8 <br> 9D86: STA $00CE ; heldButtons = buttons; <br> <br> 9D88: LDX #$00 <br> 9D8A: LDA ($D1,X) <br> 9D8C: STA $00CF ; repeats = demoButtonsTable[index]; <br> <br> 9D8E: JSR $9DE8 ; index++; <br> <br> 9D91: LDA $00D2 ; if (reached end of demo table) { <br> 9D93: CMP #$DF ; return; <br> 9D95: BEQ $9DA2 ; } <br> <br> 9D97: JMP $9D9E ; goto holdButtons; <br> <br> moveInProgress: <br> <br> 9D9A: LDA #$00 <br> 9D9C: STA $00F5 ; clearNewlyPressedButtons(); <br> <br> holdButtons: <br> <br> 9D9E: LDA $00CE <br> 9DA0: STA $00F7 ; setHeldButtons(heldButtons); <br> <br> 9DA2: RTS ; return; <br> <br> startButtonPressed: <br> <br> 9DA3: LDA #$DD <br> 9DA5: STA $00D2 ; reset index; <br> <br> 9DA7: LDA #$00 <br> 9DA9: STA $00B2 ; counter = 0; <br> <br> 9DAB: LDA #$01 <br> 9DAD: STA $00C0 ; gameMode = TITLE_SCREEN; <br> <br> 9DAF: RTS ; return;</code> <br> <br><font style="vertical-align: inherit;"></font><code>$00D1</code><font style="vertical-align: inherit;"></font><code>$00D2</code><font style="vertical-align: inherit;"></font><code>$872D</code><font style="vertical-align: inherit;"></font><br><br> <code>9DE8: LDA $00D1 <br> 9DEA: CLC ; increment [$00D1] <br> 9DEB: ADC #$01 ; possibly causing wrap around to 0 <br> 9DED: STA $00D1 ; which produces a carry <br> <br> 9DEF: LDA #$00 <br> 9DF1: ADC $00D2 <br> 9DF3: STA $00D2 ; add carry to [$00D2] <br> <br> 9DF5: RTS ; return</code> <br> <br><font style="vertical-align: inherit;"></font><code>$00D0</code><font style="vertical-align: inherit;"></font><code>$FF</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Nesse caso, o c√≥digo a seguir √© iniciado, destinado a gravar na tabela de bot√µes da demonstra√ß√£o. </font><font style="vertical-align: inherit;">No entanto, a tabela √© armazenada no PRG-ROM. </font><font style="vertical-align: inherit;">Tentar gravar nele n√£o afetar√° os dados salvos. </font><font style="vertical-align: inherit;">Em vez disso, cada opera√ß√£o de grava√ß√£o aciona um comutador de banco, resultando no efeito de falha mostrado abaixo.</font></font><br><br> <code>recording: <br> <br> 9DB0: JSR $AB9D ; pollController(); <br> <br> 9DB3: LDA $00C0 ; if (gameMode != DEMO) { <br> 9DB5: CMP #$05 ; return; <br> 9DB7: BNE $9DE7 ; } <br> <br> 9DB9: LDA $00D0 ; if (not recording mode) { <br> 9DBB: CMP #$FF ; return; <br> 9DBD: BNE $9DE7 ; } <br> <br> 9DBF: LDA $00F7 ; if (getHeldButtons() == heldButtons) { <br> 9DC1: CMP $00CE ; goto buttonsNotChanged; <br> 9DC3: BEQ $9DE4 ; } <br> <br> 9DC5: LDX #$00 <br> 9DC7: LDA $00CE <br> 9DC9: STA ($D1,X) ; demoButtonsTable[index] = heldButtons; <br> <br> 9DCB: JSR $9DE8 ; index++; <br> <br> 9DCE: LDA $00CF <br> 9DD0: STA ($D1,X) ; demoButtonsTable[index] = repeats; <br> <br> 9DD2: JSR $9DE8 ; index++; <br> <br> 9DD5: LDA $00D2 ; if (reached end of demo table) { <br> 9DD7: CMP #$DF ; return; <br> 9DD9: BEQ $9DE7 ; } <br> <br> 9DDB: LDA $00F7 <br> 9DDD: STA $00CE ; heldButtons = getHeldButtons(); <br> <br> 9DDF: LDA #$00 <br> 9DE1: STA $00CF ; repeats = 0; <br> <br> 9DE3: RTS ; return; <br> <br> buttonsNotChanged: <br> <br> 9DE4: INC $00CF ; repeats++; <br> <br> 9DE6: RTS <br> 9DE7: RTS ; return;</code> <br> <br><font style="vertical-align: inherit;"></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/a07/66a/261/a0766a261967e1ee2e7d4a61d3367ee6.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Isso sugere que os desenvolvedores possam executar o programa parcial ou totalmente na RAM. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Para contornar esse obst√°culo, criei </font></font><code>lua/RecordDemo.lua</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">um localizado em um </font></font><a href=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">zip com c√≥digo-fonte</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Ap√≥s alternar para o modo de grava√ß√£o demo, ele redireciona as opera√ß√µes de grava√ß√£o para a tabela no console Lua. </font><font style="vertical-align: inherit;">A partir dele, os bytes podem ser copiados e colados na ROM.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Para gravar sua pr√≥pria demonstra√ß√£o, execute o FCEUX e fa√ßa o download do arquivo ROM do Nintendo Tetris (Arquivo | Abrir ROM ...). Em seguida, abra a janela Lua Script (Arquivo | Lua | Nova janela Lua Script ...), navegue at√© o arquivo ou insira o caminho. Pressione o bot√£o Executar para iniciar o modo de grava√ß√£o demo e clique na janela do FCEUX para mudar o foco para ele. Voc√™ pode controlar as formas at√© que a tabela de bot√µes esteja cheia. Depois disso, o jogo retornar√° automaticamente ao protetor de tela. Clique em Parar na janela Lua Script para parar o script. Os dados gravados aparecer√£o no console de sa√≠da, como mostrado na figura abaixo.</font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/f2e/3cd/f61/f2e3cdf61589005f2e1cae0659f66467.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Selecione todo o conte√∫do e copie para a √°rea de transfer√™ncia (Ctrl + C). </font><font style="vertical-align: inherit;">Em seguida, execute o Hex Editor (Debug | Hex Editor ...). </font><font style="vertical-align: inherit;">No menu Editor hexadecimal, selecione Exibir | </font><font style="vertical-align: inherit;">Arquivo ROM e depois Arquivo | </font><font style="vertical-align: inherit;">Ir para Endere√ßo. </font><font style="vertical-align: inherit;">Na caixa de di√°logo Goto, digite 5D10 (endere√ßo da tabela de bot√µes de demonstra√ß√£o no arquivo ROM) e clique em Ok. </font><font style="vertical-align: inherit;">Em seguida, cole o conte√∫do da √°rea de transfer√™ncia (Ctrl + V).</font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/bef/599/392/bef599392455c773652e850de13f6413.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Por fim, no menu FCEUX, selecione NES | </font><font style="vertical-align: inherit;">Reset </font><font style="vertical-align: inherit;">Se voc√™ conseguiu repetir todas essas etapas, a demonstra√ß√£o deve ser substitu√≠da por sua pr√≥pria vers√£o. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Se voc√™ deseja salvar as altera√ß√µes, selecione Arquivo | </font><font style="vertical-align: inherit;">Salvar Rom como ... e digite o nome do arquivo ROM modificado e clique em Salvar. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">De maneira semelhante, voc√™ pode ajustar a sequ√™ncia de tetriminos criados.</font></font><br><br><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Tela da morte </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Como mencionado acima, a maioria dos jogadores n√£o consegue lidar com a velocidade da descida das figuras no n√≠vel 29, o que rapidamente leva √† conclus√£o do jogo. Portanto, os jogadores que ele se associou ao nome "tela da morte". Mas, do ponto de vista t√©cnico, a tela da morte n√£o permite que o jogador v√° mais longe devido a um bug no qual uma descida r√°pida n√£o √© realmente um bug, mas um recurso. Os designers foram t√£o gentis que permitiram que o jogo continuasse enquanto o jogador era capaz de suportar velocidade sobre-humana. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Uma tela verdadeira da morte aparece em aproximadamente 1550 linhas retra√≠das. Manifesta-se de maneiras diferentes. √Äs vezes o jogo √© reiniciado. Em outros casos, a tela fica preta. Normalmente, um jogo congela ("congela") imediatamente ap√≥s a exclus√£o de uma linha, conforme mostrado abaixo. Tais efeitos s√£o frequentemente precedidos por artefatos gr√°ficos aleat√≥rios.</font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/09d/7fe/4f3/09d7fe4f3ec1e77057c7ee5e252d8d75.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A tela de morte √© o resultado de um erro no c√≥digo que adiciona pontos ao excluir linhas. A conta de seis caracteres √© armazenada como um BCD little endian compactado de 24 bits e est√° localizada em </font></font><code>$0053</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- </font></font><code>$0055</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Para realizar convers√µes entre o n√∫mero de linhas limpas e pontos obtidos, uma tabela √© usada; cada entrada √© um BCD de 16 bits com pouco valor endian. </font><font style="vertical-align: inherit;">Depois de incrementar o n√∫mero total de linhas e, possivelmente, o n√≠vel, o valor nesta lista √© multiplicado pelo n√∫mero do n√≠vel mais um e o resultado √© adicionado aos pontos. Isso est√° claramente demonstrado na tabela do manual do Nintendo Tetris:</font></font><br><br> <code>9CA5: 00 00 ; 0: 0 <br> 9CA7: 40 00 ; 1: 40 <br> 9CA9: 00 01 ; 2: 100 <br> 9CAB: 00 03 ; 3: 300 <br> 9CAD: 00 12 ; 4: 1200</code> <br> <br><font style="vertical-align: inherit;"></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/34b/a36/7cf/34ba367cfefad47e493306fa6ef8fe3e.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Como mostrado abaixo, a multiplica√ß√£o √© simulada por um ciclo que adiciona pontos √† pontua√ß√£o. √â executado ap√≥s o bloqueio da forma, mesmo que nenhuma linha seja limpa. </font><font style="vertical-align: inherit;">Infelizmente, o </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;">Ricoh 2A03</font></a><font style="vertical-align: inherit;"> n√£o possui um modo decimal bin√°rio 6502; ele poderia simplificar bastante o corpo do ciclo. Em vez disso, a adi√ß√£o √© realizada em etapas usando o modo bin√°rio. Qualquer d√≠gito que exceda 9 ap√≥s a adi√ß√£o √© obtido essencialmente subtraindo 10 e incrementando os d√≠gitos √† esquerda. Por exemplo, </font><font style="vertical-align: inherit;">isso √© convertido em </font><font style="vertical-align: inherit;">. Mas esse esquema n√£o est√° totalmente protegido. Tomar </font><font style="vertical-align: inherit;">: uma verifica√ß√£o n√£o pode converter o resultado em</font></font><br><br> <code>9C31: LDA $0044 <br> 9C33: STA $00A8 <br> 9C35: INC $00A8 ; for(i = 0; i &lt;= level; i++) { <br> <br> 9C37: LDA $0056 <br> 9C39: ASL <br> 9C3A: TAX <br> 9C3B: LDA $9CA5,X ; points[0] = pointsTable[2 * completedLines]; <br> <br> 9C3E: CLC <br> 9C3F: ADC $0053 <br> 9C41: STA $0053 ; score[0] += points[0]; <br> <br> 9C43: CMP #$A0 <br> 9C45: BCC $9C4E ; if (upper digit of score[0] &gt; 9) { <br> <br> 9C47: CLC <br> 9C48: ADC #$60 <br> 9C4A: STA $0053 ; upper digit of score[0] -= 10; <br> 9C4C: INC $0054 ; score[1]++; <br> ; } <br> <br> 9C4E: INX <br> 9C4F: LDA $9CA5,X ; points[1] = pointsTable[2 * completedLines + 1]; <br> <br> 9C52: CLC <br> 9C53: ADC $0054 <br> 9C55: STA $0054 ; score[1] += points[1]; <br> <br> 9C57: AND #$0F <br> 9C59: CMP #$0A <br> 9C5B: BCC $9C64 ; if (lower digit of score[1] &gt; 9) { <br> <br> 9C5D: LDA $0054 <br> 9C5F: CLC ; lower digit of score[1] -= 10; <br> 9C60: ADC #$06 ; increment upper digit of score[1]; <br> 9C62: STA $0054 ; } <br> <br> 9C64: LDA $0054 <br> 9C66: AND #$F0 <br> 9C68: CMP #$A0 <br> 9C6A: BCC $9C75 ; if (upper digit of score[1] &gt; 9) { <br> <br> 9C6C: LDA $0054 <br> 9C6E: CLC <br> 9C6F: ADC #$60 <br> 9C71: STA $0054 ; upper digit of score[1] -= 10; <br> 9C73: INC $0055 ; score[2]++; <br> ; } <br> <br> 9C75: LDA $0055 <br> 9C77: AND #$0F <br> 9C79: CMP #$0A <br> 9C7B: BCC $9C84 ; if (lower digit of score[2] &gt; 9) { <br> <br> 9C7D: LDA $0055 <br> 9C7F: CLC ; lower digit of score[2] -= 10; <br> 9C80: ADC #$06 ; increment upper digit of score[2]; <br> 9C82: STA $0055 ; } <br> <br> 9C84: LDA $0055 <br> 9C86: AND #$F0 <br> 9C88: CMP #$A0 <br> 9C8A: BCC $9C94 ; if (upper digit of score[2] &gt; 9) { <br> <br> 9C8C: LDA #$99 <br> 9C8E: STA $0053 <br> 9C90: STA $0054 <br> 9C92: STA $0055 ; max out score to 999999; <br> ; } <br> <br> 9C94: DEC $00A8 <br> 9C96: BNE $9C37 ; }</code> <br> <br><font style="vertical-align: inherit;"></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"></font><code>$07 + $07 = $0E</code><font style="vertical-align: inherit;"></font><code>$14</code><font style="vertical-align: inherit;"></font><code>$09 + $09 = $12</code><font style="vertical-align: inherit;"></font><code>$18</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Para compensar isso, nenhum dos d√≠gitos decimais nas entradas do scorecard excede 6. Al√©m disso, para poder us√°-lo, o √∫ltimo d√≠gito de todas as entradas √© sempre 0. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Leva um tempo para concluir esse ciclo longo e complicado. </font><font style="vertical-align: inherit;">Em n√≠veis altos, um grande n√∫mero de itera√ß√µes afeta o tempo do jogo, porque leva mais de 1/60 segundo para gerar cada quadro. </font><font style="vertical-align: inherit;">Tudo isso, como resultado, leva a v√°rias manifesta√ß√µes da "tela da morte". </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O script Lua AI limita o n√∫mero de itera√ß√µes em um loop para 30 - o valor m√°ximo que os designers podem alcan√ßar conforme projetado pelos designers, o que elimina a tela mortal.</font></font><br><br><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Finais </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> No livreto Nintendo Tetris, o jogo A-Type √© descrito da seguinte maneira: </font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/c53/f16/5ea/c53f165ea675badb06f75f6409f6c836.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O jogo recompensa os jogadores que marcaram um n√∫mero suficientemente grande de pontos em uma das cinco anima√ß√µes dos finais. A escolha do final √© inteiramente baseada nos dois d√≠gitos mais √† esquerda da pontua√ß√£o de seis d√≠gitos. Como mostrado abaixo, para obter um dos finais, o jogador deve marcar pelo menos 30.000 pontos. </font><font style="vertical-align: inherit;">Vale ressaltar que </font><font style="vertical-align: inherit;">- </font><font style="vertical-align: inherit;">√© um espelho de endere√ßos </font><font style="vertical-align: inherit;">- </font><font style="vertical-align: inherit;">. A conta √© duplicada nos endere√ßos </font><font style="vertical-align: inherit;">- </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Depois de passar no primeiro teste, a anima√ß√£o final √© selecionada pela seguinte instru√ß√£o switch.</font></font><br><br> <code>9A4D: LDA $0075 <br> 9A4F: CMP #$03 <br> 9A51: BCC $9A5E ; if (score[2] &gt;= $03) { <br> <br> 9A53: LDA #$80 <br> 9A55: JSR $A459 <br> 9A58: JSR $9E3A <br> 9A5B: JMP $9A64 ; select ending; <br> ; }</code> <br> <br><font style="vertical-align: inherit;"></font><code>$0060</code><font style="vertical-align: inherit;"></font><code>$007F</code><font style="vertical-align: inherit;"></font><code>$0040</code><font style="vertical-align: inherit;"></font><code>$005F</code><font style="vertical-align: inherit;"></font><code>$0073</code><font style="vertical-align: inherit;"></font><code>$0075</code><font style="vertical-align: inherit;"></font><br><br><font style="vertical-align: inherit;"></font><br><br> <code>A96E: LDA #$00 <br> A970: STA $00C4 <br> A972: LDA $0075 ; if (score[2] &lt; $05) { <br> A974: CMP #$05 ; ending = 0; <br> A976: BCC $A9A5 ; } <br> <br> A978: LDA #$01 <br> A97A: STA $00C4 <br> A97C: LDA $0075 ; else if (score[2] &lt; $07) { <br> A97E: CMP #$07 ; ending = 1; <br> A980: BCC $A9A5 ; } <br> <br> A982: LDA #$02 <br> A984: STA $00C4 <br> A986: LDA $0075 ; else if (score[2] &lt; $10) { <br> A988: CMP #$10 ; ending = 2; <br> A98A: BCC $A9A5 ; } <br> <br> A98C: LDA #$03 <br> A98E: STA $00C4 <br> A990: LDA $0075 ; else if (score[2] &lt; $12) { <br> A992: CMP #$12 ; ending = 3; <br> A994: BCC $A9A5 ; } <br> <br> A996: LDA #$04 ; else { <br> A998: STA $00C4 ; ending = 4; <br> ; }</code> <br> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">No final, foguetes de tamanho crescente s√£o lan√ßados a partir da plataforma de lan√ßamento ao lado da Catedral de S√£o Bas√≠lio. </font><font style="vertical-align: inherit;">No quarto final, a espa√ßonave Buran √© mostrada - a vers√£o sovi√©tica do √¥nibus espacial americano. </font><font style="vertical-align: inherit;">No melhor final, a pr√≥pria catedral se eleva no ar e um OVNI paira sobre a plataforma de lan√ßamento. </font><font style="vertical-align: inherit;">Abaixo est√° uma imagem de cada final e a pontua√ß√£o associada a ele.</font></font><br><div class="scrollable-table"><table><tbody><tr><td> <code>30000‚Äì49999</code> <div style="text-align:center;"> <img src="https://habrastorage.org/getpro/habr/post_images/0b9/b73/4b4/0b9b734b43dae52eccafaa71e3c1441d.png"></div></td><td> <code>50000‚Äì69999</code> <div style="text-align:center;"> <img src="https://habrastorage.org/getpro/habr/post_images/ade/f93/f39/adef93f395eb2bef2c1fd71562857c39.png"></div></td><td> <code>70000‚Äì99999</code> <div style="text-align:center;"> <img src="https://habrastorage.org/getpro/habr/post_images/df3/480/b63/df3480b63de128a70b7c9e4dd7cec81f.png"></div></td></tr><tr><td> <code>100000‚Äì119999</code> <div style="text-align:center;"> <img src="https://habrastorage.org/getpro/habr/post_images/8e3/91a/658/8e391a6581df6e7ec0c08134b6a6d5bf.png"></div></td><td> <code>120000+</code> <div style="text-align:center;"> <img src="https://habrastorage.org/getpro/habr/post_images/3e1/2bd/42f/3e12bd42ffc331742d809325db418f78.png"></div></td><td></td></tr></tbody></table></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> No modo de jogo do tipo B, outro teste √© implementado, descrito no livreto Nintendo Tetris da seguinte maneira: </font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/0aa/929/624/0aa929624f41a68ea1388b6ba9013dd3.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Se o jogador limpa com sucesso 25 linhas, o jogo mostra o final, dependendo do n√≠vel inicial. As termina√ß√µes dos n√≠veis de 0 a 8 consistem em animais e objetos voando ou correndo no quadro, passando misteriosamente atr√°s da Catedral de S√£o Bas√≠lio. O UFO do melhor final do modo A-Type aparece no final 3. No final 4, pterossauros voadores extintos aparecem e no final 7 s√£o mostrados os m√≠ticos drag√µes voadores. Nos finais 2 e 6, s√£o mostrados p√°ssaros sem asas: ping√ºins e avestruzes correndo. No final de 5, o c√©u est√° cheio de aeronaves BOAS (n√£o confundir com aeronaves da Goodyear). E no final de 8, muitas "Buranas" varrem a tela, embora na realidade houvesse apenas uma. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A altura inicial (mais 1) √© usada como multiplicador, recompensando o jogador com um grande n√∫mero de animais / objetos por maior complexidade.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">No melhor final do tipo B, √© mostrado um castelo cheio de personagens do universo Nintendo: a princesa Peach bate palmas, Kid Icarus toca violino, Donkey Kong bate no grande tambor, Mario e Luigi dan√ßam, Bowser toca acorde√£o, Samus toca violoncelo, Link - em uma flauta, enquanto as c√∫pulas da Catedral de S√£o Bas√≠lio voam no ar. A quantidade desses elementos mostrados no final depende da altura inicial. Abaixo est√£o as imagens dos 10 finais.</font></font><br><br><div class="scrollable-table"><table><tbody><tr><td><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/5d9/c8e/525/5d9c8e525177613cb3fcd59c7c6aa53a.png"></div></td><td><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/ade/2fc/f3d/ade2fcf3d389b67e5d4b3d7e8c5c1ea0.png"></div></td><td><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/ec9/bd3/9dd/ec9bd39dd26529013d7d408f6a4e855b.png"></div></td></tr><tr><td><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/fdb/125/132/fdb125132ecaed550966562b5e08f169.png"></div></td><td><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/22b/758/028/22b75802841a3b558f8fae476f2d2598.png"></div></td><td><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/43e/710/858/43e710858220b08e1860da00a309c665.png"></div></td></tr><tr><td><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/dda/332/1d5/dda3321d5e5246d2aa92eafb69f3cf5d.png"></div></td><td><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/c6f/2d0/843/c6f2d0843995d294393bbbf277b83bdf.png"></div></td><td><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/572/3b8/f29/5723b8f2919ac35746b52923d59dbf41.png"></div></td></tr><tr><td><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/639/938/9df/6399389dfff187a8db7ac92f1dc815e3.png"></div></td><td></td><td></td></tr></tbody></table></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A IA pode limpar rapidamente todas as 25 linhas necess√°rias no modo Tipo B em qualquer n√≠vel e altura inicial, o que permite ver qualquer um dos finais. Tamb√©m vale a pena avaliar o qu√£o legal ele lida com grandes montes de blocos aleat√≥rios. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nas termina√ß√µes de 0 a 8, at√© 6 objetos podem se mover no quadro. As coordenadas y dos objetos s√£o armazenadas em uma tabela localizada em at </font></font><code>$A7B7</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">As dist√¢ncias horizontais entre os objetos s√£o armazenadas em uma tabela no endere√ßo </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Uma sequ√™ncia de valores com um sinal no endere√ßo </font><font style="vertical-align: inherit;">determina a velocidade e a dire√ß√£o dos objetos. </font><font style="vertical-align: inherit;">Os √≠ndices de Sprite s√£o armazenados em </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">De fato, cada objeto consiste em dois sprites com √≠ndices adjacentes. Para obter o segundo √≠ndice, voc√™ precisa adicionar 1. Por exemplo, um drag√£o consiste em</font></font><br><br> <code>A7B7: 98 A8 C0 A8 90 B0 ; 0 <br> A7BD: B0 B8 A0 B8 A8 A0 ; 1 <br> A7C3: C8 C8 C8 C8 C8 C8 ; 2 <br> A7C9: 30 20 40 28 A0 80 ; 3 <br> A7CF: A8 88 68 A8 48 78 ; 4 <br> A7D5: 58 68 18 48 78 38 ; 5 <br> A7DB: C8 C8 C8 C8 C8 C8 ; 6 <br> A7E1: 90 58 70 A8 40 38 ; 7 <br> A7E7: 68 88 78 18 48 A8 ; 8</code> <br> <br><font style="vertical-align: inherit;"></font><code>$A77B</code><font style="vertical-align: inherit;"></font><br><br> <code>A77B: 3A 24 0A 4A 3A FF ; 0 <br> A781: 22 44 12 32 4A FF ; 1 <br> A787: AE 6E 8E 6E 1E 02 ; 2 <br> A78D: 42 42 42 42 42 02 ; 3 <br> A793: 22 0A 1A 04 0A FF ; 4 <br> A799: EE DE FC FC F6 02 ; 5 <br> A79F: 80 80 80 80 80 FF ; 6 <br> A7A5: E8 E8 E8 E8 48 FF ; 7 <br> A7AB: 80 AE 9E 90 80 02 ; 8</code> <br> <br><font style="vertical-align: inherit;"></font><code>$A771</code><font style="vertical-align: inherit;"></font><br><br> <code>A771: 01 ; 0: 1 <br> A772: 01 ; 1: 1 <br> A773: FF ; 2: -1 <br> A774: FC ; 3: -4 <br> A775: 01 ; 4: 1 <br> A776: FF ; 5: -1 <br> A777: 02 ; 6: 2 <br> A778: 02 ; 7: 2 <br> A779: FE ; 8: -1</code> <br> <br><font style="vertical-align: inherit;"></font><code>$A7F3</code><font style="vertical-align: inherit;"></font><br><br> <code>A7F3: 2C ; 0: dragonfly <br> A7F4: 2E ; 1: dove <br> A7F5: 54 ; 2: penguin <br> A7F6: 32 ; 3: UFO <br> A7F7: 34 ; 4: pterosaur <br> A7F8: 36 ; 5: blimp <br> A7F9: 4B ; 6: ostrich <br> A7FA: 38 ; 7: dragon <br> A7FB: 3A ; 8: Buran</code> <br> <br><font style="vertical-align: inherit;"></font><code>$38</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">e </font></font><code>$39</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">As pe√ßas para esses sprites est√£o contidas nas tabelas de padr√µes abaixo.</font></font><br><br><div class="scrollable-table"><table><tbody><tr><td><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/86d/524/373/86d5243738d9c3e34db5318889c4f894.png"></div></td><td><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/d82/2d1/229/d822d122984b77a0973f08feac962647.png"></div></td><td><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/d8a/3c1/9b5/d8a3c19b513fb9f7338e250b97fdeac1.png"></div></td></tr></tbody></table></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Examinamos a tabela central do padr√£o acima, usada para exibir o tetrimino e o campo de jogo. </font><font style="vertical-align: inherit;">Curiosamente, ele cont√©m o alfabeto inteiro, enquanto outros cont√™m apenas parte dele para economizar espa√ßo. </font><font style="vertical-align: inherit;">Mas ainda mais interessantes s√£o os sprites de aeronaves e helic√≥pteros na tabela de padr√µes √† esquerda; </font><font style="vertical-align: inherit;">eles n√£o aparecem nos finais ou em outras partes do jogo. </font><font style="vertical-align: inherit;">Descobriu-se que o avi√£o eo helic√≥ptero tem √≠ndices sprites </font></font><code>$30</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">e </font></font><code>$16</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">e voc√™ pode mudar a tabela mostrada acima, para v√™-los em a√ß√£o.</font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/04e/2e2/203/04e2e2203b1581876d99736ad9b56fd6.png"></div><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/445/153/3b4/4451533b43874485cb5a0cdfd9df0c58.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Infelizmente, as montagens de helic√≥ptero n√£o s√£o exibidas, mas os rotores principal e de cauda s√£o lindamente animados. </font></font><br><br><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 2 Jogadores Versus </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O Nintendo Tetris cont√©m um modo incompleto para dois jogadores que voc√™ pode ativar alterando o n√∫mero de jogadores ( </font></font><code>$00BE</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) para 2. Como mostrado abaixo, dois campos de jogo s√£o exibidos no plano de fundo do modo para um jogador.</font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/418/6e7/2af/4186e72af40c6c617996ca2f8d39a72c.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">N√£o h√° borda entre os campos porque a regi√£o central do plano de fundo √© preta s√≥lida. Os valores </font></font><code>003</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mostrados acima dos campos de jogo indicam o n√∫mero de linhas limpas por cada jogador. A √∫nica figura comum para dois jogadores aparece no mesmo local que no modo single player. Infelizmente, ele est√° localizado no campo de jogo certo. Quadrados e outros ladrilhos est√£o coloridos incorretamente. E quando o jogador perde o jogo reinicia. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mas se voc√™ ignorar esses problemas, o modo √© bastante reproduz√≠vel. Cada jogador pode controlar independentemente as pe√ßas no campo de jogo correspondente. E quando um jogador digita Double, Triple ou Tetris (isto √©, limpa duas, tr√™s ou quatro linhas), as linhas de lixo com um quadrado ausente aparecem na parte inferior do campo de jogo do oponente.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Um campo adicional est√° localizado em </font></font><code>$0500</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. A </font></font><code>$0060</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- </font></font><code>$007F</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, geralmente sendo um espelho </font></font><code>$0040</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- </font></font><code>$005F</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, s√£o usados ‚Äã‚Äãpara o segundo jogador. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Provavelmente, esse modo interessante foi abandonado devido a um cronograma de desenvolvimento ocupado. Ou talvez ele tenha sido deixado intencionalmente inacabado. Uma das raz√µes pelas quais Tetris foi escolhido como o jogo fornecido com o Nintendo Game Boy foi porque incentivou a compra do </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">cabo Game Link.</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- um acess√≥rio que conecta dois Game Boys para iniciar o modo 2 jogadores versus. </font><font style="vertical-align: inherit;">Esse cabo adicionou um elemento de "socialidade" ao sistema - incentivou os amigos a comprar um Game Boy para participar da divers√£o. </font><font style="vertical-align: inherit;">Talvez a Nintendo tenha medo de que, se a vers√£o para console do jogo tivesse 2 jogadores versus o modo, o poder de "publicidade" de Tetris, que estimulou a compra do Game Boy, poderia ser enfraquecido.</font></font><br><br><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> M√∫sica e efeitos sonoros </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A m√∫sica de fundo √© ativada quando </font></font><code>$06F5</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">um dos valores listados na tabela √© atribu√≠do.</font></font><br><br><div class="scrollable-table"><table><tbody><tr><th>  Valor </th><th>  Descri√ß√£o do produto </th></tr><tr><td> <code>01</code> </td> <td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> M√∫sica n√£o utilizada na tela inicial </font></font></td></tr><tr><td> <code>02</code> </td> <td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Alvo do modo B-Type alcan√ßado </font></font></td></tr><tr><td> <code>03</code> </td> <td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> M√∫sica-1 </font></font></td></tr><tr><td> <code>04</code> </td> <td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> M√∫sica-2 </font></font></td></tr><tr><td> <code>05</code> </td> <td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> M√∫sica-3 </font></font></td></tr><tr><td> <code>06</code> </td> <td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> M√∫sica-1 allegro </font></font></td></tr><tr><td> <code>07</code> </td> <td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Music-2 allegro </font></font></td></tr><tr><td> <code>08</code> </td> <td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> M√∫sica-3 allegro </font></font></td></tr><tr><td> <code>09</code> </td> <td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Tela de Parab√©ns </font></font></td></tr><tr><td> <code>0A</code> </td> <td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Finais </font></font></td></tr><tr><td> <code>0B</code> </td> <td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Alvo do modo B-Type alcan√ßado </font></font></td></tr></tbody></table></div><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Voc√™ pode ouvir m√∫sica n√£o utilizada no protetor de tela </font></font><a href=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">aqui</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . No pr√≥prio jogo, nada soa durante a tela de prote√ß√£o de tela. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Music-1 √© uma vers√£o de " </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dance of the Dragee Fairy</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ", m√∫sica para a bailarina do terceiro ato da </font><font style="vertical-align: inherit;">valsa </font><font style="vertical-align: inherit;">do </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pas de deux </font></font></a><font style="vertical-align: inherit;"></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">"The Nutcracker" de</font></font></i></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Tchaikovsky. A m√∫sica final √© uma varia√ß√£o dos " </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Versos do Toureiro</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ", uma √°ria da √≥pera </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Carmen</font></font></i></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Georges Bizet. Essas composi√ß√µes s√£o organizadas pelo compositor do resto da m√∫sica de </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hirokazu Tanaka</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A Music-2 foi inspirada nas m√∫sicas tradicionais do folclore russo. Music-3 √© misterioso, futurista e terno; Por um tempo, foi o toque do telefone de suporte ao cliente da Nintendo of America.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Para ajudar o jogador a entrar em p√¢nico quando a altura da pilha se aproxima do teto do campo de jogo, uma vers√£o da m√∫sica de fundo come√ßa a tocar rapidamente ( </font></font><code>$06</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- </font></font><code>$08</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">). </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Curiosamente, entre as composi√ß√µes musicais n√£o existe " </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Chapman</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ", um famoso tema que soa em Game Boy Tetris. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Os efeitos sonoros s√£o acionados pela grava√ß√£o em </font></font><code>$06F0</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">e </font></font><code>$06F1</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, de acordo com a tabela a seguir.</font></font><br><br><div class="scrollable-table"><table><tbody><tr><th><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> O endere√ßo </font></font></th><th>  Valor </th><th>  Descri√ß√£o do produto </th></tr><tr><td> <code>06F0</code> </td> <td> <code>02</code> </td> <td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> A cortina do final do jogo </font></font></td></tr><tr><td> <code>06F0</code> </td> <td> <code>03</code> </td> <td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Foguete no final </font></font></td></tr><tr><td> <code>06F1</code> </td> <td> <code>01</code> </td> <td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Sele√ß√£o de op√ß√£o de menu </font></font></td></tr><tr><td> <code>06F1</code> </td> <td> <code>02</code> </td> <td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Sele√ß√£o da tela do menu </font></font></td></tr><tr><td> <code>06F1</code> </td> <td> <code>03</code> </td> <td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Tetrimino Shift </font></font></td></tr><tr><td> <code>06F1</code> </td> <td> <code>04</code> </td> <td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Tetris recebido </font></font></td></tr><tr><td> <code>06F1</code> </td> <td> <code>05</code> </td> <td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Rota√ß√£o Tetrimino </font></font></td></tr><tr><td> <code>06F1</code> </td> <td> <code>06</code> </td> <td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Novo n√≠vel </font></font></td></tr><tr><td> <code>06F1</code> </td> <td> <code>07</code> </td> <td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Tetrimino Lock </font></font></td></tr><tr><td> <code>06F1</code> </td> <td> <code>08</code> </td> <td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Chilrear </font></font></td></tr><tr><td> <code>06F1</code> </td> <td> <code>09</code> </td> <td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Limpeza de linhas </font></font></td></tr><tr><td> <code>06F1</code> </td> <td> <code>0A</code> </td> <td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Linha preenchida </font></font></td></tr></tbody></table></div><br><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Estados do jogo e modos de renderiza√ß√£o </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Durante a jogabilidade, o estado atual do jogo √© representado por um n√∫mero inteiro no endere√ßo </font></font><code>$0048</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Na maioria das vezes, tem um significado </font></font><code>$01</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">que indica que o jogador controla o tetrimino ativo. </font><font style="vertical-align: inherit;">No entanto, quando a pe√ßa √© travada no lugar, o jogo passa gradualmente de estado </font></font><code>$02</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">para estado </font></font><code>$08</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, conforme mostrado na tabela.</font></font><br><br><div class="scrollable-table"><table><tbody><tr><th>  Condi√ß√£o </th><th>  Descri√ß√£o do produto </th></tr><tr><td> <code>00</code> </td> <td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ID de orienta√ß√£o n√£o atribu√≠do </font></font></td></tr><tr><td> <code>01</code> </td> <td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> O jogador controla o tetrimino ativo </font></font></td></tr><tr><td> <code>02</code> </td> <td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Bloqueio de Tetrimino no campo de jogo </font></font></td></tr><tr><td> <code>03</code> </td> <td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Verificando linhas preenchidas </font></font></td></tr><tr><td> <code>04</code> </td> <td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Exibir anima√ß√£o de limpeza de linha </font></font></td></tr><tr><td> <code>05</code> </td> <td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Atualizando linhas e estat√≠sticas </font></font></td></tr><tr><td> <code>06</code> </td> <td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Verificando o alvo do modo B </font></font></td></tr><tr><td> <code>07</code> </td> <td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> N√£o usado </font></font></td></tr><tr><td> <code>08</code> </td> <td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Criar Pr√≥ximo Tetrimino </font></font></td></tr><tr><td> <code>09</code> </td> <td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> N√£o usado </font></font></td></tr><tr><td> <code>0A</code> </td> <td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Atualiza√ß√£o da cortina de jogo </font></font></td></tr><tr><td> <code>0B</code> </td> <td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Incremento do estado do jogo </font></font></td></tr></tbody></table></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A ramifica√ß√£o do c√≥digo, dependendo do estado do jogo, ocorre no seguinte endere√ßo </font></font><code>$81B2</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">: </font><font style="vertical-align: inherit;">No estado do </font><font style="vertical-align: inherit;">comutador, ele salta para o c√≥digo que atribui um </font><font style="vertical-align: inherit;">valor </font><font style="vertical-align: inherit;">indicando que a orienta√ß√£o n√£o est√° especificada. </font><font style="vertical-align: inherit;">O manipulador nunca √© chamado; no entanto, o estado do jogo </font><font style="vertical-align: inherit;">serve como um sinal para outras partes do c√≥digo. </font><font style="vertical-align: inherit;">O estado </font><font style="vertical-align: inherit;">permite que o jogador alterne, gire e abaixe o tetrimino ativo: </font><font style="vertical-align: inherit;">Conforme declarado nas se√ß√µes anteriores, as rotinas de deslocamento, rota√ß√£o e abaixamento da figura antes de executar o c√≥digo, verifique as novas posi√ß√µes do tetrimino. A √∫nica maneira de bloquear uma forma na posi√ß√£o incorreta √© cri√°-la em cima de uma forma existente. Nesse caso, o jogo termina. Como mostrado abaixo, o c√≥digo de status executa essa verifica√ß√£o.</font></font><br><br> <code>81B2: LDA $0048 <br> 81B4: JSR $AC82 ; switch(playState) { <br> 81B7: 2F 9E ; case 00: goto 9E2F; // Unassign orientationID <br> 81B9: CF 81 ; case 01: goto 81CF; // Player controls active Tetrimino <br> 81BB: A2 99 ; case 02: goto 99A2; // Lock Tetrimino into playfield <br> 81BD: 6B 9A ; case 03: goto 9A6B; // Check for completed rows <br> 81BF: 39 9E ; case 04: goto 9E39; // Display line clearing animation <br> 81C1: 58 9B ; case 05: goto 9B58; // Update lines and statistics <br> 81C3: F2 A3 ; case 06: goto A3F2; // B-Type goal check; Unused frame for A-Type <br> 81C5: 03 9B ; case 07: goto 9B03; // Unused frame; Execute unfinished 2 player mode logic <br> 81C7: 8E 98 ; case 08: goto 988E; // Spawn next Tetrimino <br> 81C9: 39 9E ; case 09: goto 9E39; // Unused <br> 81CB: 11 9A ; case 0A: goto 9A11; // Update game over curtain <br> 81CD: 37 9E ; case 0B: goto 9E37; // Increment play state <br> ; }</code> <br> <br><font style="vertical-align: inherit;"></font><code>$00</code><font style="vertical-align: inherit;"></font><code>orientationID</code><font style="vertical-align: inherit;"></font><code>$13</code><font style="vertical-align: inherit;"></font><br><br> <code>9E2F: LDA #$13 <br> 9E31: STA $0042 ; orientationID = UNASSIGNED; <br> <br> 9E33: RTS ; return;</code> <br> <br><font style="vertical-align: inherit;"></font><code>$00</code><font style="vertical-align: inherit;"></font><br><br><font style="vertical-align: inherit;"></font><code>$01</code><font style="vertical-align: inherit;"></font><br><br> <code>81CF: JSR $89AE ; shift Tetrimino; <br> 81D2: JSR $88AB ; rotate Tetrimino; <br> 81D5: JSR $8914 ; drop Tetrimino; <br> <br> 81D8: RTS ; return;</code> <br> <br><font style="vertical-align: inherit;"></font><code>$02</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Se a posi√ß√£o bloqueada estiver correta, marcar√° as 4 c√©lulas associadas do campo de jogo como ocupadas. Caso contr√°rio, ela faz a transi√ß√£o para um estado </font><font style="vertical-align: inherit;">- a cortina sinistra do fim do jogo.</font></font><br><br> <code>99A2: JSR $948B ; if (new position valid) { <br> 99A5: BEQ $99B8 ; goto updatePlayfield; <br> ; } <br> <br> 99A7: LDA #$02 <br> 99A9: STA $06F0 ; play curtain sound effect; <br> <br> 99AC: LDA #$0A <br> 99AE: STA $0048 ; playState = UPDATE_GAME_OVER_CURTAIN; <br> <br> 99B0: LDA #$F0 <br> 99B2: STA $0058 ; curtainRow = -16; <br> <br> 99B4: JSR $E003 ; updateAudio(); <br> <br> 99B7: RTS ; return;</code> <br> <br><font style="vertical-align: inherit;"></font><code>$0A</code><font style="vertical-align: inherit;"></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/b1b/7c0/a46/b1b7c0a4637995c25423a07984bce24e.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A cortina √© desenhada do topo do campo de jogo para baixo, descendo uma linha a cada 4 quadros. </font></font><code>curtainRow</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">( </font></font><code>$0058</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) √© inicializado com um valor de -16, criando um atraso adicional de 0,27 segundos entre o bloqueio final e o in√≠cio da anima√ß√£o. No endere√ßo </font></font><code>$9A21</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">no estado do </font></font><code>$0A</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">c√≥digo mostrado abaixo, a tabela de multiplica√ß√£o √© acessada, que √© exibida erroneamente como n√∫meros de n√≠vel. Isso √© feito na escala </font></font><code>curtainRow</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">de 10. Al√©m disso, como mostrado acima, o c√≥digo no endere√ßo </font></font><code>$9A51</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">inicia a anima√ß√£o final se a pontua√ß√£o do jogador n√£o for inferior a 30.000 pontos; caso contr√°rio, ele espera clicar em Iniciar. </font><font style="vertical-align: inherit;">O c√≥digo √© conclu√≠do atribuindo um valor ao estado do jogo </font><font style="vertical-align: inherit;">, mas o manipulador correspondente n√£o √© chamado porque o jogo est√° conclu√≠do.</font></font><br><br> <code>9A11: LDA $0058 ; if (curtainRow == 20) { <br> 9A13: CMP #$14 ; goto endGame; <br> 9A15: BEQ $9A47 ; } <br> <br> 9A17: LDA $00B1 ; if (frameCounter not divisible by 4) { <br> 9A19: AND #$03 ; return; <br> 9A1B: BNE $9A46 ; } <br> <br> 9A1D: LDX $0058 ; if (curtainRow &lt; 0) { <br> 9A1F: BMI $9A3E ; goto incrementCurtainRow; <br> ; } <br> <br> 9A21: LDA $96D6,X <br> 9A24: TAY ; rowIndex = 10 * curtainRow; <br> <br> 9A25: LDA #$00 <br> 9A27: STA $00AA ; i = 0; <br> <br> 9A29: LDA #$13 <br> 9A2B: STA $0042 ; orientationID = NONE; <br> <br> drawCurtainRow: <br> <br> 9A2D: LDA #$4F <br> 9A2F: STA ($B8),Y ; playfield[rowIndex + i] = CURTAIN_TILE; <br> 9A31: INY <br> 9A32: INC $00AA ; i++; <br> 9A34: LDA $00AA <br> 9A36: CMP #$0A ; if (i != 10) { <br> 9A38: BNE $9A2D ; goto drawCurtainRow; <br> ; } <br> <br> 9A3A: LDA $0058 <br> 9A3C: STA $0049 ; vramRow = curtainRow; <br> <br> incrementCurtainRow: <br> <br> 9A3E: INC $0058 ; curtainRow++; <br> <br> 9A40: LDA $0058 ; if (curtainRow != 20) { <br> 9A42: CMP #$14 ; return; <br> 9A44: BNE $9A46 ; } <br> <br> 9A46: RTS ; return; <br> <br> endGame: <br> <br> 9A47: LDA $00BE <br> 9A49: CMP #$02 <br> 9A4B: BEQ $9A64 ; if (numberOfPlayers == 1) { <br> <br> 9A4D: LDA $0075 <br> 9A4F: CMP #$03 <br> 9A51: BCC $9A5E ; if (score[2] &gt;= $03) { <br> <br> 9A53: LDA #$80 <br> 9A55: JSR $A459 <br> 9A58: JSR $9E3A <br> 9A5B: JMP $9A64 ; select ending; <br> ; } <br> <br> 9A5E: LDA $00F5 ; if (not just pressed Start) { <br> 9A60: CMP #$10 ; return; <br> 9A62: BNE $9A6A ; } <br> ; } <br> <br> 9A64: LDA #$00 <br> 9A66: STA $0048 ; playState = INITIALIZE_ORIENTATION_ID; <br> 9A68: STA $00F5 ; clear newly pressed buttons; <br> <br> 9A6A: RTS ; return;</code> <br> <br><font style="vertical-align: inherit;"></font><code>$00</code><font style="vertical-align: inherit;"></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">As linhas do campo de jogo s√£o copiadas incrementalmente para o VRAM para exibi-las. </font><font style="vertical-align: inherit;">O √≠ndice da linha atual a ser copiada est√° contido em </font></font><code>vramRow</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">( </font></font><code>$0049</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">). </font><font style="vertical-align: inherit;">Um </font></font><code>$9A3C</code> <code>vramRow</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">valor √© atribu√≠do </font><font style="vertical-align: inherit;">no endere√ßo </font></font><code>curtainRow</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, o que torna essa linha vis√≠vel ao renderizar. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">As manipula√ß√µes com VRAM ocorrem durante um intervalo de apagamento vertical, que √© reconhecido pelo manipulador de interrup√ß√£o descrito na se√ß√£o "Tela de informa√ß√µes legais". </font><font style="vertical-align: inherit;">Ele chama a sub-rotina mostrada abaixo (marcada nos coment√°rios do manipulador de interrup√ß√µes como </font></font><code>render()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">). </font><font style="vertical-align: inherit;">O modo de renderiza√ß√£o √© semelhante ao modo de jogo. </font><font style="vertical-align: inherit;">Ele √© armazenado no endere√ßo </font><font style="vertical-align: inherit;">e pode ter um dos seguintes valores:</font></font><br><br> <code>804B: LDA $00BD <br> 804D: JSR $AC82 ; switch(renderMode) { <br> 8050: B1 82 ; case 0: goto 82B1; // Legal and title screens <br> 8052: DA 85 ; case 1: goto 85DA; // Menu screens <br> 8054: 44 A3 ; case 2: goto A344; // Congratulations screen <br> 8056: EE 94 ; case 3: goto 94EE; // Play and demo <br> 8058: 95 9F ; case 4: goto 9F95; // Ending animation <br> ; }</code> <br> <br><font style="vertical-align: inherit;"></font><code>$00BD</code><font style="vertical-align: inherit;"></font><br><br><div class="scrollable-table"><table><tbody><tr><th>  Valor </th><th>  Descri√ß√£o do produto </th></tr><tr><td> <code>00</code> </td> <td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tela com tela </font><font style="vertical-align: inherit;">prote√ß√£o de informa√ß√µes e tela</font></font></td></tr><tr><td> <code>01</code> </td> <td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Telas de menu </font></font></td></tr><tr><td> <code>02</code> </td> <td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Tela de Parab√©ns </font></font></td></tr><tr><td> <code>03</code> </td> <td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Jogo e demo </font></font></td></tr><tr><td> <code>04</code> </td> <td><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Anima√ß√£o final </font></font></td></tr></tbody></table></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Parte do modo de renderiza√ß√£o √© </font></font><code>$03</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mostrada abaixo. </font><font style="vertical-align: inherit;">Como voc√™ pode ver abaixo, ele </font><font style="vertical-align: inherit;">passa no VRAM uma linha do campo de jogo com um √≠ndice </font><font style="vertical-align: inherit;">. Se </font><font style="vertical-align: inherit;">maior que 20, a rotina n√£o faz nada. </font><font style="vertical-align: inherit;">A Tabela </font><font style="vertical-align: inherit;">( </font><font style="vertical-align: inherit;">) cont√©m os endere√ßos VRAM no formato little endian correspondente √†s linhas exibidas do campo de jogo deslocadas 6 em modo normal e por -2 e 12 para o campo em modo inacabado 2 Player Versus. Os bytes desta tabela fazem parte da lista de valores que s√£o erroneamente exibidos como n√∫meros de n√≠vel ap√≥s o n√≠vel 29. Os bytes inferiores e superiores adjacentes de cada endere√ßo s√£o obtidos separadamente e s√£o essencialmente combinados em um endere√ßo de 16 bits, usado no ciclo de c√≥pia. </font><font style="vertical-align: inherit;">Um incremento √© executado no final da sub-rotina.</font></font><br><br> <code>952A: JSR $9725 ; copyPlayfieldRowToVRAM(); <br> 952D: JSR $9725 ; copyPlayfieldRowToVRAM(); <br> 9530: JSR $9725 ; copyPlayfieldRowToVRAM(); <br> 9533: JSR $9725 ; copyPlayfieldRowToVRAM();</code> <br> <br><font style="vertical-align: inherit;"></font><code>copyPlayfieldRowToVRAM()</code><font style="vertical-align: inherit;"></font><code>vramRow</code><font style="vertical-align: inherit;"></font><code>vramRow</code><font style="vertical-align: inherit;"></font><br><br> <code>9725: LDX $0049 ; if (vramRow &gt; 20) { <br> 9727: CPX #$15 ; return; <br> 9729: BPL $977E ; } <br> <br> 972B: LDA $96D6,X <br> 972E: TAY ; playfieldAddress = 10 * vramRow; <br> <br> 972F: TXA <br> 9730: ASL <br> 9731: TAX <br> 9732: INX ; high = vramPlayfieldRows[vramRow * 2 + 1]; <br> 9733: LDA $96EA,X <br> 9736: STA $2006 <br> 9739: DEX <br> <br> 973A: LDA $00BE <br> 973C: CMP #$01 <br> 973E: BEQ $975E ; if (numberOfPlayers == 2) { <br> <br> 9740: LDA $00B9 <br> 9742: CMP #$05 <br> 9744: BEQ $9752 ; if (leftPlayfield) { <br> <br> 9746: LDA $96EA,X <br> 9749: SEC <br> 974A: SBC #$02 <br> 974C: STA $2006 ; low = vramPlayfieldRows[vramRow * 2] - 2; <br> <br> 974F: JMP $9767 ; } else { <br> <br> 9752: LDA $96EA,X <br> 9755: CLC <br> 9756: ADC #$0C <br> 9758: STA $2006 ; low = vramPlayfieldRows[vramRow * 2] + 12; <br> <br> 975B: JMP $9767 ; } else { <br> <br> 975E: LDA $96EA,X <br> 9761: CLC <br> 9762: ADC #$06 ; low = vramPlayfieldRows[vramRow * 2] + 6; <br> 9764: STA $2006 ; } <br> <br> ; vramAddress = (high &lt;&lt; 8) | low; <br> <br> 9767: LDX #$0A <br> 9769: LDA ($B8),Y <br> 976B: STA $2007 <br> 976E: INY ; for(i = 0; i &lt; 10; i++) { <br> 976F: DEX ; vram[vramAddress + i] = playfield[playfieldAddress + i]; <br> 9770: BNE $9769 ; } <br> <br> 9772: INC $0049 ; vramRow++; <br> 9774: LDA $0049 ; if (vramRow &lt; 20) { <br> 9776: CMP #$14 ; return; <br> 9778: BMI $977E ; } <br> <br> 977A: LDA #$20 <br> 977C: STA $0049 ; vramRow = 32; <br> <br> 977E: RTS ; return;</code> <br> <br><font style="vertical-align: inherit;"></font><code>vramPlayfieldRows</code><font style="vertical-align: inherit;"></font><code>$96EA</code><font style="vertical-align: inherit;"></font><br><br><font style="vertical-align: inherit;"></font><code>vramRow</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Se o valor atingir 20, ser√° atribu√≠do um valor 32, o que significa que a c√≥pia est√° totalmente conclu√≠da. Como mostrado acima, apenas 4 linhas s√£o copiadas por quadro. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O manipulador de estado </font></font><code>$03</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">√© respons√°vel por reconhecer as linhas conclu√≠das e remov√™-las do campo de jogo. Durante 4 chamadas separadas, ele verifica as </font></font><code>[‚àí2, 1]</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">desloca√ß√µes de </font><font style="vertical-align: inherit;">linha </font><font style="vertical-align: inherit;">pr√≥ximas ao centro do tetrimino (ambas as coordenadas de todos os quadrados do tetrimino est√£o nesse intervalo). Os √≠ndices de linhas conclu√≠das s√£o armazenados em </font></font><code>$004A</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- </font></font><code>$004D</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">; o √≠ndice 0 registrado √© usado para indicar que nenhuma linha conclu√≠da foi encontrada nesta passagem. O manipulador √© mostrado abaixo. </font><font style="vertical-align: inherit;">A verifica√ß√£o </font><font style="vertical-align: inherit;">no in√≠cio n√£o permite que o manipulador execute ao transferir linhas do campo de jogo para VRAM (manipulador de estado</font></font><br><br> <code>9A6B: LDA $0049 <br> 9A6D: CMP #$20 ; if (vramRow &lt; 32) { <br> 9A6F: BPL $9A74 ; return; <br> 9A71: JMP $9B02 ; } <br> <br> 9A74: LDA $0041 ; rowY = tetriminoY - 2; <br> 9A76: SEC <br> 9A77: SBC #$02 ; if (rowY &lt; 0) { <br> 9A79: BPL $9A7D ; rowY = 0; <br> 9A7B: LDA #$00 ; } <br> <br> 9A7D: CLC <br> 9A7E: ADC $0057 <br> 9A80: STA $00A9 ; rowY += lineIndex; <br> <br> 9A82: ASL <br> 9A83: STA $00A8 <br> 9A85: ASL <br> 9A86: ASL <br> 9A87: CLC <br> 9A88: ADC $00A8 <br> 9A8A: STA $00A8 ; rowIndex = 10 * rowY; <br> <br> 9A8C: TAY <br> 9A8D: LDX #$0A <br> 9A8F: LDA ($B8),Y <br> 9A91: CMP #$EF ; for(i = 0; i &lt; 10; i++) { <br> 9A93: BEQ $9ACC ; if (playfield[rowIndex + i] == EMPTY_TILE) { <br> 9A95: INY ; goto rowNotComplete; <br> 9A96: DEX ; } <br> 9A97: BNE $9A8F ; } <br> <br> 9A99: LDA #$0A <br> 9A9B: STA $06F1 ; play row completed sound effect; <br> <br> 9A9E: INC $0056 ; completedLines++; <br> <br> 9AA0: LDX $0057 <br> 9AA2: LDA $00A9 <br> 9AA4: STA $4A,X ; lines[lineIndex] = rowY; <br> <br> 9AA6: LDY $00A8 <br> 9AA8: DEY <br> 9AA9: LDA ($B8),Y <br> 9AAB: LDX #$0A <br> 9AAD: STX $00B8 <br> 9AAF: STA ($B8),Y <br> 9AB1: LDA #$00 <br> 9AB3: STA $00B8 <br> 9AB5: DEY ; for(i = rowIndex - 1; i &gt;= 0; i--) { <br> 9AB6: CPY #$FF ; playfield[i + 10] = playfield[i]; <br> 9AB8: BNE $9AA9 ; } <br> <br> 9ABA: LDA #$EF <br> 9ABC: LDY #$00 <br> 9ABE: STA ($B8),Y <br> 9AC0: INY ; for(i = 0; i &lt; 10; i++) { <br> 9AC1: CPY #$0A ; playfield[i] = EMPTY_TILE; <br> 9AC3: BNE $9ABE ; } <br> <br> 9AC5: LDA #$13 <br> 9AC7: STA $0042 ; orientationID = UNASSIGNED; <br> <br> 9AC9: JMP $9AD2 ; goto incrementLineIndex; <br> <br> rowNotComplete: <br> <br> 9ACC: LDX $0057 <br> 9ACE: LDA #$00 <br> 9AD0: STA $4A,X ; lines[lineIndex] = 0; <br> <br> incrementLineIndex: <br> <br> 9AD2: INC $0057 ; lineIndex++; <br> <br> 9AD4: LDA $0057 ; if (lineIndex &lt; 4) { <br> 9AD6: CMP #$04 ; return; <br> 9AD8: BMI $9B02 ; } <br> <br> 9ADA: LDY $0056 <br> 9ADC: LDA $9B53,Y <br> 9ADF: CLC <br> 9AE0: ADC $00BC <br> 9AE2: STA $00BC ; totalGarbage += garbageLines[completedLines]; <br> <br> 9AE4: LDA #$00 <br> 9AE6: STA $0049 ; vramRow = 0; <br> 9AE8: STA $0052 ; clearColumnIndex = 0; <br> <br> 9AEA: LDA $0056 <br> 9AEC: CMP #$04 <br> 9AEE: BNE $9AF5 ; if (completedLines == 4) { <br> 9AF0: LDA #$04 ; play Tetris sound effect; <br> 9AF2: STA $06F1 ; } <br> <br> 9AF5: INC $0048 ; if (completedLines &gt; 0) { <br> 9AF7: LDA $0056 ; playState = DISPLAY_LINE_CLEARING_ANIMATION; <br> 9AF9: BNE $9B02 ; return; <br> ; } <br> <br> 9AFB: INC $0048 ; playState = UPDATE_LINES_AND_STATISTICS; <br> <br> 9AFD: LDA #$07 <br> 9AFF: STA $06F1 ; play piece locked sound effect; <br> <br> 9B02: RTS ; return;</code> <br> <br><font style="vertical-align: inherit;"></font><code>vramRow</code><font style="vertical-align: inherit;"></font><code>$03</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">chamado em todos os quadros). Se forem detectadas linhas preenchidas, ela ser√° </font></font><code>vramRow</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">redefinida para 0, o que for√ßa uma transfer√™ncia completa. </font></font><br><br> <code>lineIndex</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">( </font></font><code>$00A9</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) √© inicializado com o valor 0 e seu incremento √© realizado em cada passagem. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Diferentemente do estado do jogo </font></font><code>$0A</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">e da rotina de c√≥pia do campo de jogo, que usa a tabela de multiplica√ß√£o de endere√ßos </font></font><code>$96D6</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, um bloco que come√ßa com </font></font><code>$9A82</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">multiplica </font></font><code>rowY</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">por 10 usando turnos e adi√ß√µes: </font></font><br><br> <code>rowIndex = (rowY &lt;&lt; 1) + (rowY &lt;&lt; 3); // rowIndex = 2 * rowY + 8 * rowY;</code> <br> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Isso √© feito apenas porque √© </font></font><code>rowY</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">limitado pelo intervalo </font></font><code>[0, 20]</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, e a tabela de multiplica√ß√£o cobre apenas </font></font><code>[0, 19]</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. A varredura de linhas pode se estender al√©m do final do campo de jogo. No entanto, como dito anteriormente, o jogo inicializa </font></font><code>$0400</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- </font></font><code>$04FF</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">com um valor</font></font><code>$EF</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(ladrilho vazio), criando mais de 5 linhas ocultas vazias adicionais sob o piso do campo de jogo. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Um bloco que come√ßa com </font></font><code>$9ADA</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">faz parte do modo incompleto de 2 Player Versus. Como mencionado acima, limpar as linhas adiciona detritos ao campo de jogo do oponente. O n√∫mero de linhas de lixo √© determinado pela tabela no endere√ßo </font></font><code>$9B53</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">: </font><font style="vertical-align: inherit;">O ciclo no endere√ßo </font><font style="vertical-align: inherit;">desloca o material acima da linha preenchida uma linha para baixo. Ele aproveita o fato de que cada linha em uma sequ√™ncia cont√≠nua √© separada da outra por 10 bytes. O pr√≥ximo loop limpa a linha superior. </font><font style="vertical-align: inherit;">A anima√ß√£o de limpeza de linha √© executada durante o estado do jogo </font><font style="vertical-align: inherit;">, mas, como mostrado abaixo, n√£o ocorre no manipulador de estado do jogo, que est√° completamente vazio.</font></font><br><br> <code>9B53: 00 ; no cleared lines <br> 9B54: 00 ; Single <br> 9B55: 01 ; Double <br> 9B56: 02 ; Triple <br> 9B57: 04 ; Tetris</code> <br> <br><font style="vertical-align: inherit;"></font><code>$9AA6</code><font style="vertical-align: inherit;"></font><br><br><font style="vertical-align: inherit;"></font><code>$04</code><font style="vertical-align: inherit;"></font><br><br> <code>9E39: RTS ; return;</code> <br> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Em vez disso, durante o estado do jogo </font></font><code>$04</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, a pr√≥xima ramifica√ß√£o do modo de renderiza√ß√£o √© executada </font></font><code>$03</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">e valores espelhados s√£o necess√°rios para o modo inacabado 2 Player Versus. </font><font style="vertical-align: inherit;">A sub-rotina √© mostrada abaixo </font><font style="vertical-align: inherit;">. √â chamado em todos os quadros, mas a condi√ß√£o no in√≠cio permite que ele seja executado apenas em cada quarto quadro. Em cada passagem, ele percorre a lista de √≠ndices de linhas conclu√≠das e limpa 2 colunas nessas linhas, movendo-se da coluna central para fora. </font><font style="vertical-align: inherit;">Um endere√ßo VRAM de 16 bits √© constru√≠do da mesma maneira que √© mostrado na rotina do campo de c√≥pia. No entanto, nesse caso, ele executa um deslocamento pelo √≠ndice da coluna obtido da tabela abaixo.</font></font><br><br> <code>94EE: LDA $0068 <br> 94F0: CMP #$04 <br> 94F2: BNE $9522 ; if (playState == DISPLAY_LINE_CLEARING_ANIMATION) { <br> <br> 94F4: LDA #$04 <br> 94F6: STA $00B9 ; leftPlayfield = true; <br> <br> 94F8: LDA $0072 <br> 94FA: STA $0052 <br> 94FC: LDA $006A <br> 94FE: STA $004A <br> 9500: LDA $006B <br> 9502: STA $004B <br> 9504: LDA $006C <br> 9506: STA $004C <br> 9508: LDA $006D <br> 950A: STA $004D <br> 950C: LDA $0068 <br> 950E: STA $0048 ; mirror values; <br> <br> 9510: JSR $977F ; updateLineClearingAnimation(); <br> <br> ; ... <br> ; }</code> <br> <br> <code>leftPlayfield</code><font style="vertical-align: inherit;"></font><br><br><font style="vertical-align: inherit;"></font><code>updateLineClearingAnimation()</code><font style="vertical-align: inherit;"></font><br><br> <code>977F: LDA $00B1 ; if (frameCounter not divisible by 4) { <br> 9781: AND #$03 ; return; <br> 9783: BNE $97FD ; } <br> <br> 9785: LDA #$00 ; for(i = 0; i &lt; 4; i++) { <br> 9787: STA $00AA ; rowY = lines[i]; <br> 9789: LDX $00AA ; if (rowY == 0) { <br> 978B: LDA $4A,X ; continue; <br> 978D: BEQ $97EB ; } <br> <br> 978F: ASL <br> 9790: TAY <br> 9791: LDA $96EA,Y <br> 9794: STA $00A8 ; low = vramPlayfieldRows[2 * rowY]; <br> <br> 9796: LDA $00BE ; if (numberOfPlayers == 2) { <br> 9798: CMP #$01 ; goto twoPlayers; <br> 979A: BNE $97A6 ; } <br> <br> 979C: LDA $00A8 <br> 979E: CLC <br> 979F: ADC #$06 <br> 97A1: STA $00A8 ; low += 6; <br> <br> 97A3: JMP $97BD ; goto updateVRAM; <br> <br> twoPlayers: <br> <br> 97A6: LDA $00B9 <br> 97A8: CMP #$04 <br> 97AA: BNE $97B6 ; if (leftPlayfield) { <br> <br> 97AC: LDA $00A8 <br> 97AE: SEC <br> 97AF: SBC #$02 <br> 97B1: STA $00A8 ; low -= 2; <br> <br> 97B3: JMP $97BD ; } else { <br> <br> 97B6: LDA $00A8 <br> 97B8: CLC <br> 97B9: ADC #$0C ; low += 12; <br> 97BB: STA $00A8 ; } <br> <br> updateVRAM: <br> <br> 97BD: INY <br> 97BE: LDA $96EA,Y <br> 97C1: STA $00A9 <br> 97C3: STA $2006 <br> 97C6: LDX $0052 ; high = vramPlayfieldRows[2 * rowY + 1]; <br> 97C8: LDA $97FE,X <br> 97CB: CLC ; rowAddress = (high &lt;&lt; 8) | low; <br> 97CC: ADC $00A8 <br> 97CE: STA $2006 ; vramAddress = rowAddress + leftColumns[clearColumnIndex]; <br> 97D1: LDA #$FF <br> 97D3: STA $2007 ; vram[vramAddress] = 255; <br> <br> 97D6: LDA $00A9 <br> 97D8: STA $2006 <br> 97DB: LDX $0052 ; high = vramPlayfieldRows[2 * rowY + 1]; <br> 97DD: LDA $9803,X <br> 97E0: CLC ; rowAddress = (high &lt;&lt; 8) | low; <br> 97E1: ADC $00A8 <br> 97E3: STA $2006 ; vramAddress = rowAddress + rightColumns[clearColumnIndex]; <br> 97E6: LDA #$FF <br> 97E8: STA $2007 ; vram[vramAddress] = 255; <br> <br> 97EB: INC $00AA <br> 97ED: LDA $00AA <br> 97EF: CMP #$04 <br> 97F1: BNE $9789 ; } <br> <br> 97F3: INC $0052 ; clearColumnIndex++; <br> 97F5: LDA $0052 ; if (clearColumnIndex &lt; 5) { <br> 97F7: CMP #$05 ; return; <br> 97F9: BMI $97FD ; } <br> <br> 97FB: INC $0048 ; playState = UPDATE_LINES_AND_STATISTICS; <br> <br> 97FD: RTS ; return;</code> <br> <br><font style="vertical-align: inherit;"></font><br><br> <code>97FE: 04 03 02 01 00 ; left columns <br> 9803: 05 06 07 08 09 ; right columns</code> <br> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Para anima√ß√£o de limpeza, s√£o necess√°rios 5 passes. Em seguida, o c√≥digo prossegue para o pr√≥ximo estado do jogo. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O manipulador de estado do jogo </font></font><code>$05</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">cont√©m o c√≥digo descrito na se√ß√£o "Linhas e estat√≠sticas". O manipulador termina com este c√≥digo: A </font><font style="vertical-align: inherit;">vari√°vel </font><font style="vertical-align: inherit;">n√£o </font><font style="vertical-align: inherit;">√© </font><font style="vertical-align: inherit;">redefinida at√© o final do estado do jogo </font><font style="vertical-align: inherit;">, ap√≥s o qual √© usada para atualizar o n√∫mero total de linhas e a pontua√ß√£o. Essa sequ√™ncia permite que um bug interessante seja executado. No modo de demonstra√ß√£o, voc√™ precisa esperar at√© o jogo reunir a linha completa e pressionar rapidamente Iniciar at√© que a anima√ß√£o para limpar a s√©rie termine. O jogo retornar√° ao protetor de tela, mas se voc√™ escolher a hora certa, o valor ser√° </font><font style="vertical-align: inherit;">salvo. Agora voc√™ pode iniciar o jogo no modo A-Type. Quando bloqueado no lugar da primeira figura, o manipulador de estado do jogo</font></font><br><br> <code>9C9E: LDA #$00 <br> 9CA0: STA $0056 ; completedLines = 0; <br> <br> 9CA2: INC $0048 ; playState = B_TYPE_GOAL_CHECK; <br> <br> 9CA4: RTS ; return;</code> <br> <br><font style="vertical-align: inherit;"></font><code>completedLines</code><font style="vertical-align: inherit;"></font><code>$05</code><font style="vertical-align: inherit;"></font><code>completedLines</code><font style="vertical-align: inherit;"></font><code>$03</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">inicia a verifica√ß√£o de linhas conclu√≠das. Ele n√£o os encontrar√°, mas os deixar√° </font></font><code>completedLines</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">inalterados. Finalmente, quando o estado do jogo for cumprido, o </font></font><code>$05</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">n√∫mero total de linhas e a pontua√ß√£o aumentar√°, como se voc√™ as tivesse marcado. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A maneira mais f√°cil de fazer isso √© obter o maior valor, aguardando a demo coletar o Tetris (haver√° 2 deles na demo). Assim que a tela piscar, clique em Iniciar.</font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/2a8/80a/091/2a880a09173c42fb8c5256f9921a635b.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Depois de iniciar um novo jogo, a tela continuar√° piscando. Tudo isso gra√ßas ao seguinte c√≥digo chamado pelo manipulador de interrup√ß√µes. </font><font style="vertical-align: inherit;">De fato, se voc√™ deixar o primeiro n√∫mero descer automaticamente para o ch√£o do campo de jogo, a pontua√ß√£o aumentar√° em um valor ainda maior, porque </font><font style="vertical-align: inherit;">( </font><font style="vertical-align: inherit;">) tamb√©m salvar√° seu valor na demonstra√ß√£o. Isso ocorre mesmo nos casos em que a demonstra√ß√£o n√£o preencheu uma √∫nica linha. </font><font style="vertical-align: inherit;">N√£o √© reiniciado at√© que o bot√£o "Para baixo" seja pressionado. </font><font style="vertical-align: inherit;">Al√©m disso, se voc√™ clicar em Iniciar durante a anima√ß√£o para limpar as linhas de combina√ß√£o do Tetris no modo de demonstra√ß√£o e aguardar a demonstra√ß√£o iniciar novamente, n√£o apenas os pontos do Tetris ser√£o contados na demonstra√ß√£o, mas todo o tempo ser√° misturado. Como resultado, a demo perder√° o jogo. Depois de terminar o jogo, voc√™ pode retornar ao protetor de tela clicando em Iniciar.</font></font><br><br> <code>9673: LDA #$3F <br> 9675: STA $2006 <br> 9678: LDA #$0E <br> 967A: STA $2006 ; prepare to modify background tile color; <br> <br> 967D: LDX #$00 ; color = DARK_GRAY; <br> <br> 967F: LDA $0056 <br> 9681: CMP #$04 <br> 9683: BNE $9698 ; if (completedLines == 4) { <br> <br> 9685: LDA $00B1 <br> 9687: AND #$03 <br> 9689: BNE $9698 ; if (frameCounter divisible by 4) { <br> <br> 968B: LDX #$30 ; color = WHITE; <br> <br> 968D: LDA $00B1 <br> 968F: AND #$07 <br> 9691: BNE $9698 ; if (frameCounter divisible by 8) { <br> <br> 9693: LDA #$09 <br> 9695: STA $06F1 ; play clear sound effect; <br> <br> ; } <br> ; } <br> ; } <br> <br> 9698: STX $2007 ; update background tile color;</code> <br> <br><font style="vertical-align: inherit;"></font><code>holdDownPoints</code><font style="vertical-align: inherit;"></font><code>$004F</code><font style="vertical-align: inherit;"></font><code>holdDownPoints</code><font style="vertical-align: inherit;"></font><br><br><font style="vertical-align: inherit;"></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O estado do jogo </font></font><code>$06</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">executa uma verifica√ß√£o de destino para jogos do tipo B. </font><font style="vertical-align: inherit;">No modo A-Type, √© essencialmente um quadro n√£o utilizado. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O estado do jogo </font></font><code>$07</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">cont√©m exclusivamente a l√≥gica 2 Player Versus incompleta. </font><font style="vertical-align: inherit;">No modo single player, ele se comporta como um quadro n√£o utilizado. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O estado do jogo √© </font></font><code>$08</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">discutido nas se√ß√µes ‚ÄúCriando Tetrimino‚Äù e ‚ÄúEscolhendo Tetrimino‚Äù. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O estado do jogo </font></font><code>$09</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">n√£o </font><font style="vertical-align: inherit;">√© </font><font style="vertical-align: inherit;">usado. </font></font><code>$0B</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">aumenta o estado do jogo, mas tamb√©m parece n√£o utilizado. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">E, finalmente, o ciclo principal do jogo:</font></font><br><br> <code>; while(true) { <br> <br> 8138: JSR $8161 ; branchOnGameMode(); <br> <br> 813B: CMP $00A7 ; if (vertical blanking interval wait requested) { <br> 813D: BNE $8142 ; waitForVerticalBlankingInterval(); <br> 813F: JSR $AA2F ; } <br> <br> 8142: LDA $00C0 <br> 8144: CMP #$05 <br> 8146: BNE $815A ; if (gameMode == DEMO) { <br> <br> 8148: LDA $00D2 <br> 814A: CMP #$DF <br> 814C: BNE $815A ; if (reached end of demo table) { <br> <br> 814E: LDA #$DD <br> 8150: STA $00D2 ; reset demo table index; <br> <br> 8152: LDA #$00 <br> 8154: STA $00B2 ; clear upper byte of frame counter; <br> <br> 8156: LDA #$01 <br> 8158: STA $00C0 ; gameMode = TITLE_SCREEN; <br> ; } <br> ; } <br> 815A: JMP $8138 ; }</code> </div> </div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt420725/">https://habr.com/ru/post/pt420725/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt420707/index.html">Inicializa√ß√£o da JITX usa IA para automatizar o desenvolvimento de placas de circuito impresso complexas</a></li>
<li><a href="../pt420709/index.html">T2F: um projeto para converter texto em desenho facial com aprendizado profundo</a></li>
<li><a href="../pt420711/index.html">Moscow Data Science Major: an√∫ncio e registro</a></li>
<li><a href="../pt420713/index.html">Como Chuck Hull inventou a impress√£o 3D</a></li>
<li><a href="../pt420715/index.html">A dura verdade sobre a gravidade da aprendizagem</a></li>
<li><a href="../pt420729/index.html">Semin√°rio on-line aberto "Naive Bayes Classifier"</a></li>
<li><a href="../pt420731/index.html">Zabbix em ester√≥ides: como funciona a plataforma de monitoramento unificado da Sbertech</a></li>
<li><a href="../pt420735/index.html">Convidamos voc√™ para o final da maratona Encontre-se na Digital no escrit√≥rio do Mail.Ru Group</a></li>
<li><a href="../pt420737/index.html">Mini ta√ßa ai 2 ou quase AgarIO - o que poderia ser feito para vencer</a></li>
<li><a href="../pt420739/index.html">A caixa ainda est√° dispon√≠vel: por que em 2018 voc√™ ainda precisa aprender idiomas</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>