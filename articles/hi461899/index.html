<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ЁЯзЭЁЯП┐ ЁЯЩПЁЯП╛ ЁЯМия╕П рдЗрд╡реЗрдВрдЯ рдЬрдирд░реЗрд╢рди, CQRS рдФрд░ рд▓рд╛рд░рд╡реЗрд▓ ЁЯЩЖЁЯП╜ ЁЯЦРЁЯП╜ тЫ▒я╕П</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="рдкреЗрд╢реЗрд╡рд░ рдкрд╛рдареНрдпрдХреНрд░рдо "рдлреНрд░реЗрдорд╡рд░реНрдХ рд▓рд╛рд░рд╡реЗрд▓" рдХреЗ рдЫрд╛рддреНрд░реЛрдВ рдХреЗ рд▓рд┐рдП рд▓реЗрдЦ рдХрд╛ рдЕрдиреБрд╡рд╛рдж рддреИрдпрд╛рд░ рдХрд┐рдпрд╛ рдЧрдпрд╛ рдерд╛ред 
 



 рдкрд░рд┐рдЪрдп 
 рдпрд╣ рд▓реЗрдЦ PHP рднрд╛рд╖рд╛ рдФрд░ рд▓рд╛рд░реНрд╡реЗрд▓ рдврд╛рдВрдЪреЗ рдореЗрдВ рдШрдЯрдирд╛ CQRS- ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>рдЗрд╡реЗрдВрдЯ рдЬрдирд░реЗрд╢рди, CQRS рдФрд░ рд▓рд╛рд░рд╡реЗрд▓</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/otus/blog/461899/">  <i>рдкреЗрд╢реЗрд╡рд░ рдкрд╛рдареНрдпрдХреНрд░рдо <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=">"рдлреНрд░реЗрдорд╡рд░реНрдХ рд▓рд╛рд░рд╡реЗрд▓" рдХреЗ</a> рдЫрд╛рддреНрд░реЛрдВ рдХреЗ рд▓рд┐рдП рд▓реЗрдЦ рдХрд╛ рдЕрдиреБрд╡рд╛рдж рддреИрдпрд╛рд░ рдХрд┐рдпрд╛ рдЧрдпрд╛ рдерд╛ред</i> <i><br></i> <br><img src="https://habrastorage.org/webt/h8/4u/y5/h84uy5i5spnt3rdmpaiw2aynd0s.png"><br><br><hr><br><h2>  рдкрд░рд┐рдЪрдп </h2><br>  рдпрд╣ рд▓реЗрдЦ PHP рднрд╛рд╖рд╛ рдФрд░ рд▓рд╛рд░реНрд╡реЗрд▓ рдврд╛рдВрдЪреЗ рдореЗрдВ рдШрдЯрдирд╛ CQRS- рд╕рд┐рд╕реНрдЯрдо рдмрдирд╛рдиреЗ рдХреА рдореВрд▓ рдмрд╛рддреЗрдВ рдХреЗ рд▓рд┐рдП рд╕рдорд░реНрдкрд┐рдд рд╣реИред  рдпрд╣ рдорд╛рдирд╛ рдЬрд╛рддрд╛ рд╣реИ рдХрд┐ рдЖрдк рдХрдорд╛рдВрдб рдмрд╕ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рд╡рд┐рдХрд╛рд╕ рдпреЛрдЬрдирд╛ рд╕реЗ рдкрд░рд┐рдЪрд┐рдд рд╣реИрдВ рдФрд░ рдЗрд╕рдореЗрдВ рдШрдЯрдирд╛рдУрдВ рдХрд╛ рдПрдХ рд╡рд┐рдЪрд╛рд░ рд╣реИ (рд╡рд┐рд╢реЗрд╖ рд░реВрдк рд╕реЗ, рд╢реНрд░реЛрддрд╛рдУрдВ рдХреА рдПрдХ рд╕рд░рдгреА рдХреЗ рд▓рд┐рдП рдШрдЯрдирд╛рдУрдВ рдХрд╛ рдкреНрд░рдХрд╛рд╢рди)ред  рдЗрд╕ рдЬреНрдЮрд╛рди рдХреЛ рддрд╛рдЬрд╝рд╛ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП, рдЖрдк рд▓реИрд░рд╛рдХреИрдЯреНрд╕ рд╕реЗрд╡рд╛ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред  рдЗрд╕рдХреЗ рдЕрд▓рд╛рд╡рд╛, рдпрд╣ рдорд╛рдирд╛ рдЬрд╛рддрд╛ рд╣реИ рдХрд┐ рдЖрдкрдХреЛ CQRS рд╕рд┐рджреНрдзрд╛рдВрдд рдХреА рдПрдХ рдирд┐рд╢реНрдЪрд┐рдд рд╕рдордЭ рд╣реИред  рдпрджрд┐ рдирд╣реАрдВ, рддреЛ рдореИрдВ рдЕрддреНрдпрдзрд┐рдХ рджреЛ рд╡реНрдпрд╛рдЦреНрдпрд╛рди рд╕реБрдирдиреЗ рдХреА рд╕рд▓рд╛рд╣ рджреЗрддрд╛ рд╣реВрдВ: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=">рдЗрд╡реЗрдВрдЯ рдЬрдирд░реЗрд╢рди</a> рдФрд░ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=">рдЧреНрд░реЗрдЧ рдпрдВрдЧ рдХреЗ CQRS рдФрд░ рдЗрд╡реЗрдВрдЯ рдЬрдирд░реЗрд╢рди</a> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=">рдкрд░ рдореИрдерд┐рдпрд╛рд╕ рд╡реЗрд░реЗрдЬ рд╡рд░реНрдХрд╢реЙрдк</a> ред <br><a name="habracut"></a><br>  рдЕрдкрдиреА рдкрд░рд┐рдпреЛрдЬрдирд╛рдУрдВ рдореЗрдВ рдпрд╣рд╛рдВ рджрд┐рдП рдЧрдП рдХреЛрдб рдХрд╛ рдЙрдкрдпреЛрдЧ рди рдХрд░реЗрдВ!  рдпрд╣ CQRS рдХреЗ рдкреАрдЫреЗ рдХреЗ рд╡рд┐рдЪрд╛рд░реЛрдВ рдХреЛ рд╕рдордЭрдиреЗ рдХрд╛ рдПрдХ рд╕реАрдЦрдиреЗ рдХрд╛ рдордВрдЪ рд╣реИред  рдЗрд╕ рдХреЛрдб рдХреЛ рд╡рд┐рд╢реНрд╡рд╕рдиреАрдп рдирд╣реАрдВ рдХрд╣рд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ, рдЗрд╕рдХрд╛ рдЦрд░рд╛рдм рдкрд░реАрдХреНрд╖рдг рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИ, рдФрд░ рдЗрд╕рдХреЗ рдЕрд▓рд╛рд╡рд╛, рдореИрдВ рд╢рд╛рдпрдж рд╣реА рдХрднреА рдкреНрд░реЛрдЧреНрд░рд╛рдо рдЗрдВрдЯрд░рдлреЗрд╕ рдХрд░рддрд╛ рд╣реВрдВ, рдЗрд╕рд▓рд┐рдП рдХреЛрдб рдХреЗ рдЕрд▓рдЧ-рдЕрд▓рдЧ рд╣рд┐рд╕реНрд╕реЛрдВ рдХреЛ рдмрджрд▓рдирд╛ рдмрд╣реБрдд рдореБрд╢реНрдХрд┐рд▓ рд╣реЛрдЧрд╛ред  CQRS рдкреИрдХреЗрдЬ рдХрд╛ рдПрдХ рдмреЗрд╣рддрд░ рдЙрджрд╛рд╣рд░рдг рдЖрдк рдЙрдкрдпреЛрдЧ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=">рдмреНрд░реЙрдбрд╡реЗ рд╣реИ, рдЬреЛ Qandidate Lab рджреНрд╡рд╛рд░рд╛ рд╡рд┐рдХрд╕рд┐рдд рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИ</a> ред  рдпрд╣ рд╕рд╛рдл, рд╢рд┐рдерд┐рд▓ рдпреБрдЧреНрдорд┐рдд рдХреЛрдб рд╣реИ, рд╣рд╛рд▓рд╛рдВрдХрд┐, рдХреБрдЫ рд╕рд╛рд░ рдпрд╣ рдкреВрд░реА рддрд░рд╣ рд╕реЗ рд╕реНрдкрд╖реНрдЯ рдирд╣реАрдВ рдХрд░рддреЗ рд╣реИрдВ рдпрджрд┐ рдЖрдкрдиреЗ рдХрднреА рдЗрд╡реЗрдВрдЯ рд╕рд┐рд╕реНрдЯрдо рдХрд╛ рд╕рд╛рдордирд╛ рдирд╣реАрдВ рдХрд┐рдпрд╛ рд╣реИред <br><br>  рдФрд░ рдЖрдЦрд┐рд░реА - рдореЗрд░рд╛ рдХреЛрдб рдШрдЯрдирд╛рдУрдВ рдФрд░ рд▓рд╛рд░рд╡реЗрд▓ рдХрдорд╛рдВрдб рдмрд╕ рд╕реЗ рдЬреБрдбрд╝рд╛ рд╣реБрдЖ рд╣реИред  рдореИрдВ рдпрд╣ рджреЗрдЦрдирд╛ рдЪрд╛рд╣рддрд╛ рдерд╛ рдХрд┐ рд▓рд╛рд░рд╡реЗрд▓ рдореЗрдВ рдХреЛрдб рдХреИрд╕реЗ рджрд┐рдЦреЗрдЧрд╛ (рдореИрдВ рдЖрдорддреМрд░ рдкрд░ рдЫреЛрдЯреА рдПрдЬреЗрдВрд╕рд┐рдпреЛрдВ рдХреА рдкрд░рд┐рдпреЛрдЬрдирд╛рдУрдВ рдХреЗ рд▓рд┐рдП рдЗрд╕ рдврд╛рдВрдЪреЗ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рддрд╛ рд╣реВрдВ), рд╣рд╛рд▓рд╛рдВрдХрд┐, рдкреАрдЫреЗ рдореБрдбрд╝рдХрд░ рджреЗрдЦрддрд╛ рд╣реВрдВ, рддреЛ рдореБрдЭреЗ рд▓рдЧрддрд╛ рд╣реИ рдХрд┐ рдореБрдЭреЗ рдЕрдкрдирд╛ рдХрд╛рд░реНрдпрд╛рдиреНрд╡рдпрди рдмрдирд╛рдирд╛ рдЪрд╛рд╣рд┐рдПред  рдореБрдЭреЗ рдЙрдореНрдореАрдж рд╣реИ рдХрд┐ рдореЗрд░рд╛ рдХреЛрдб рдЙрди рд▓реЛрдЧреЛрдВ рдХреЗ рд▓рд┐рдП рднреА рд╕реНрдкрд╖реНрдЯ рд╣реЛрдЧрд╛ рдЬреЛ рдлреНрд░реЗрдорд╡рд░реНрдХ рдХрд╛ рдЙрдкрдпреЛрдЧ рдирд╣реАрдВ рдХрд░рддреЗ рд╣реИрдВред <br><br>  Github рдкрд░, рдХреЛрдб <a href="">https://github.com/scazz/cqrs-tutorial.git</a> рдкрд░ рд╕реНрдерд┐рдд рд╣реИ, рдФрд░ рд╣рдорд╛рд░реЗ рдЧрд╛рдЗрдб рдореЗрдВ рд╣рдо рддрд░реНрдХ рдмрдврд╝рд╛рдиреЗ рдХреЗ рд▓рд┐рдП рдЗрд╕рдХреЗ рдШрдЯрдХреЛрдВ рдкрд░ рд╡рд┐рдЪрд╛рд░ рдХрд░реЗрдВрдЧреЗред <br><br>  рд╣рдо рдПрдХ рд╕рд░реНрдл рд╕реНрдХреВрд▓ рдХреЗ рд▓рд┐рдП рдПрдХ рдкреНрд░рд╛рд░рдВрднрд┐рдХ рдкрдВрдЬреАрдХрд░рдг рдкреНрд░рдгрд╛рд▓реА рдмрдирд╛рдПрдВрдЧреЗред  рдЗрд╕рдХреА рдорджрдж рд╕реЗ, рд╕реНрдХреВрд▓ рдЧреНрд░рд╛рд╣рдХ рдХрдХреНрд╖рд╛рдУрдВ рдХреЗ рд▓рд┐рдП рдкрдВрдЬреАрдХрд░рдг рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред  рд░рд┐рдХреЙрд░реНрдбрд┐рдВрдЧ рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдХреЗ рд▓рд┐рдП, рд╣рдо рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рдирд┐рдпрдо рдмрдирд╛рддреЗ рд╣реИрдВ: <br><br><ul><li>  рдкреНрд░рддреНрдпреЗрдХ рдкрд╛рда рдореЗрдВ рдХрдо рд╕реЗ рдХрдо рдПрдХ рдЧреНрд░рд╛рд╣рдХ рд╣реЛрдирд╛ рдЪрд╛рд╣рд┐рдП ... </li><li>  ... рд▓реЗрдХрд┐рди рддреАрди рд╕реЗ рдЬреНрдпрд╛рджрд╛ рдирд╣реАрдВред </li></ul><br>  рдЗрд╡реЗрдВрдЯ-рдЖрдзрд╛рд░рд┐рдд CQRS рд╕рд┐рд╕реНрдЯрдо рдХреА рд╕рдмрд╕реЗ рдкреНрд░рднрд╛рд╡рд╢рд╛рд▓реА рд╡рд┐рд╢реЗрд╖рддрд╛рдУрдВ рдореЗрдВ рд╕реЗ рдПрдХ рд╣реИ рд╕рд┐рд╕реНрдЯрдо рд╕реЗ рдЖрд╡рд╢реНрдпрдХ рдкреНрд░рддреНрдпреЗрдХ рдореАрдЯреНрд░рд┐рдХ рдХреЗ рд▓рд┐рдП рд╡рд┐рд╢рд┐рд╖реНрдЯ рд░реАрдбрд┐рдВрдЧ рдореЙрдбрд▓ рдХрд╛ рдирд┐рд░реНрдорд╛рдгред  рдЖрдкрдХреЛ ElasticSearch рдореЗрдВ рд░реАрдбрд┐рдВрдЧ рдореЙрдбрд▓ рдХреЗ рдкреНрд░рдХреНрд╖реЗрдкрдг рдХреЗ рдЙрджрд╛рд╣рд░рдг рдорд┐рд▓реЗрдВрдЧреЗ, рдФрд░ рдЧреНрд░реЗрдЧ рдпрдВрдЧ рдиреЗ рдЬрдЯрд┐рд▓ рдШрдЯрдирд╛рдУрдВ рд╕реЗ рдирд┐рдкрдЯрдиреЗ рдХреЗ рд▓рд┐рдП рдЕрдкрдиреЗ рдЗрд╡реЗрдВрдЯ рд╕реНрдЯреЛрд░ рдореЗрдВ рдПрдХ рд╡рд┐рд╖рдп-рдЙрдиреНрдореБрдЦ рднрд╛рд╖рд╛ рдХреЛ рд▓рд╛рдЧреВ рдХрд┐рдпрд╛ рд╣реИред  рд╣рд╛рд▓рд╛рдБрдХрд┐, рд╕рд╛рджрдЧреА рдХреЗ рд▓рд┐рдП, рд╣рдорд╛рд░рд╛ рдкрдврд╝рд╛ рд╣реБрдЖ рдкреНрд░рдХреНрд╖реЗрдкрдг рдПрд▓реЛрдХреЗрдВрдЯ рдХреЗ рд╕рд╛рде рдЙрдкрдпреЛрдЧ рдХреЗ рд▓рд┐рдП рдПрдХ рдорд╛рдирдХ SQL рдбреЗрдЯрд╛рдмреЗрд╕ рд╣реЛрдЧрд╛ред  рдирддреАрдЬрддрди, рд╣рдорд╛рд░реЗ рдкрд╛рд╕ рдХрдХреНрд╖рд╛рдУрдВ рдХреЗ рд▓рд┐рдП рдПрдХ рдЯреЗрдмрд▓ рдФрд░ рдЧреНрд░рд╛рд╣рдХреЛрдВ рдХреЗ рд▓рд┐рдП рдПрдХ рд╣реЛрдЧрд╛ред <br><br>  рдЗрд╡реЗрдВрдЯ рдЬрдирд░реЗрд╢рди рдХреА рдЕрд╡рдзрд╛рд░рдгрд╛ рдЖрдкрдХреЛ рдШрдЯрдирд╛рдУрдВ рдХреЛ рдСрдлрд╝рд▓рд╛рдЗрди рд╕рдВрд╕рд╛рдзрд┐рдд рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддреА рд╣реИред  рд▓реЗрдХрд┐рди рдЗрд╕ рд▓реЗрдЦ рдореЗрдВ рдореИрдВ "рдкрд╛рд░рдВрдкрд░рд┐рдХ" рд╡рд┐рдХрд╛рд╕ рдореЙрдбрд▓ рдХреЛ рдЕрдзрд┐рдХрддрдо (рдлрд┐рд░ рд╕реЗ, рд╕рд░рд▓ рдмрдирд╛рдиреЗ рдХреЗ рд▓рд┐рдП) рдХрд╛ рдкрд╛рд▓рди рдХрд░реВрдВрдЧрд╛, рдФрд░ рд╣рдорд╛рд░реЗ рдкрдврд╝рдиреЗ рдХреЗ рдЕрдиреБрдорд╛рдиреЛрдВ рдХреЛ рд╡рд╛рд╕реНрддрд╡рд┐рдХ рд╕рдордп рдореЗрдВ рдЕрдкрдбреЗрдЯ рдХрд┐рдпрд╛ рдЬрд╛рдПрдЧрд╛, рдШрдЯрдирд╛рдУрдВ рдХреЗ рднрдВрдбрд╛рд░ рдореЗрдВ рд╕рдВрдЧреНрд░рд╣реАрдд рдХрд┐рдП рдЬрд╛рдиреЗ рдХреЗ рддреБрд░рдВрдд рдмрд╛рджред <br><br><h2>  рдкреНрд░реЛрдЬреЗрдХреНрдЯ рд╕реЗрдЯрдЕрдк рдФрд░ рдкрд╣рд▓рд╛ рдкрд░реАрдХреНрд╖рдг </h2><br><pre><code class="plaintext hljs">git clone https://github.com/scazz/cqrs-tutorial</code> </pre> <br>  рдПрдХ рдирдпрд╛ Laravel 5 рдкреНрд░реЛрдЬреЗрдХреНрдЯ рдмрдирд╛рдПрдВ <br><br><pre> <code class="plaintext hljs">$&gt; laravel new cqrs-tutorial</code> </pre> <br>  рдФрд░ рд╢реБрд░реБрдЖрдд рдХреЗ рд▓рд┐рдП, рд╣рдореЗрдВ рдПрдХ рдкрд░реАрдХреНрд╖рдг рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реИред  рд╣рдо рдПрдХреАрдХрд░рдг рдкрд░реАрдХреНрд╖рдг рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░реЗрдВрдЧреЗ, рдЬреЛ рдпрд╣ рд╕реБрдирд┐рд╢реНрдЪрд┐рдд рдХрд░реЗрдЧрд╛ рдХрд┐ рдХрдХреНрд╖рд╛рдУрдВ рдХреЗ рд▓рд┐рдП рдЧреНрд░рд╛рд╣рдХ рдХрд╛ рдкрдВрдЬреАрдХрд░рдг рдЗрд╕ рддрдереНрдп рдХреА рдУрд░ рдЬрд╛рддрд╛ рд╣реИ рдХрд┐ рд╕рдмрдХ рд╣рдорд╛рд░реЗ рдПрд▓реЛрдХреЗрдВрдЯ рдореЙрдбрд▓ рдореЗрдВ рдмрдирд╛рдпрд╛ рдЧрдпрд╛ рд╣реИред <br><br>  рд▓рд┐рд╕реНрдЯрд┐рдВрдЧ рдкрд░реАрдХреНрд╖рдг / CQRSTest.php: <br><br><pre> <code class="plaintext hljs">use Illuminate\Foundation\Bus\DispatchesCommands; class CQRSTest extends TestCase { use DispatchesCommands;</code> </pre><br><pre> <code class="bash hljs">/** *  ,   BookLesson       * @<span class="hljs-built_in"><span class="hljs-built_in">return</span></span> void */ public <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> <span class="hljs-function"><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">testFiringEventUpdatesReadModel</span></span></span></span>() { <span class="hljs-variable"><span class="hljs-variable">$testLessonId</span></span> = <span class="hljs-string"><span class="hljs-string">'123e4567-e89b-12d3-a456-426655440000'</span></span>; <span class="hljs-variable"><span class="hljs-variable">$clientName</span></span> = <span class="hljs-string"><span class="hljs-string">"George"</span></span>; <span class="hljs-variable"><span class="hljs-variable">$lessonId</span></span> = new LessonId(<span class="hljs-variable"><span class="hljs-variable">$testLessonId</span></span>); <span class="hljs-variable"><span class="hljs-variable">$command</span></span> = new BookLesson(<span class="hljs-variable"><span class="hljs-variable">$lessonId</span></span>, <span class="hljs-variable"><span class="hljs-variable">$clientName</span></span>); <span class="hljs-variable"><span class="hljs-variable">$this</span></span>-&gt;dispatch(<span class="hljs-variable"><span class="hljs-variable">$command</span></span>); <span class="hljs-variable"><span class="hljs-variable">$this</span></span>-&gt;assertNotNull(Lesson::find(<span class="hljs-variable"><span class="hljs-variable">$testLessonId</span></span>)); <span class="hljs-variable"><span class="hljs-variable">$this</span></span>-&gt;assertEquals( Lesson::find(<span class="hljs-variable"><span class="hljs-variable">$testLessonId</span></span>)-&gt;clientName, <span class="hljs-variable"><span class="hljs-variable">$clientName</span></span> ); } }</code> </pre> <br>  рд╣рдо рдПрдХ рдЖрдИрдбреА рдХреЗ рд▓рд┐рдП рдирдИ рдЧрддрд┐рд╡рд┐рдзрд┐ рдХрд╛ рдкреНрд░рдЪрд╛рд░ рдХрд░рддреЗ рд╣реИрдВ, рдПрдХ рдирдИ рдЧрддрд┐рд╡рд┐рдзрд┐ рдХреЗ рд▓рд┐рдП рд╕рд╛рдЗрди рдЕрдк рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдПрдХ рдЯреАрдо рдмрдирд╛рддреЗ рд╣реИрдВ, рдФрд░ рд▓рд╛рд░рд╡реЗрд▓ рдХреЛ рдЗрд╕реЗ рднреЗрдЬрдиреЗ рдХреЗ рд▓рд┐рдП рдХрд╣рддреЗ рд╣реИрдВред  рдкрд╛рда рддрд╛рд▓рд┐рдХрд╛ рдореЗрдВ, рд╣рдореЗрдВ рдПрдХ рдирдпрд╛ рд░рд┐рдХреЙрд░реНрдб рдмрдирд╛рдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реИ рдЬрд┐рд╕реЗ рд╣рдо рдПрд▓реЛрдХреЗрдВрдЯ рдореЙрдбрд▓ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдкрдврд╝ рд╕рдХрддреЗ рд╣реИрдВред  рд╣рдореЗрдВ рдПрдХ рдбреЗрдЯрд╛рдмреЗрд╕ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реИ, рдЗрд╕рд▓рд┐рдП рдЕрдкрдиреА .env рдлрд╝рд╛рдЗрд▓ рдХреЛ рдареАрдХ рд╕реЗ рднрд░реЗрдВред <br><br>  рд╣рдорд╛рд░реЗ рдИрд╡реЗрдВрдЯ рд╕реНрдЯреЛрд░ рдореЗрдВ рджрд░реНрдЬ рдкреНрд░рддреНрдпреЗрдХ рдШрдЯрдирд╛ рдПрдЧреНрд░реАрдЧреЗрдЯ рдХреА рдЬрдбрд╝ рд╕реЗ рдЬреБрдбрд╝реА рд╣реЛрддреА рд╣реИ, рдЬрд┐рд╕реЗ рд╣рдо рдмрд╕ рдЗрдХрд╛рдИ (рдЗрдХрд╛рдИ) рдХрд╣реЗрдВрдЧреЗ - рд╢реИрдХреНрд╖рд┐рдХ рдЙрджреНрджреЗрд╢реНрдпреЛрдВ рдХреЗ рд▓рд┐рдП рдПрдХ рдЕрдореВрд░реНрддрддрд╛ рдХреЗрд╡рд▓ рднреНрд░рдо рдкреИрджрд╛ рдХрд░рддреА рд╣реИред  рдЖрдИрдбреА рдПрдХ рд╕рд╛рд░реНрд╡рднреМрдорд┐рдХ рд╡рд┐рд╢рд┐рд╖реНрдЯ рдкрд╣рдЪрд╛рдирдХрд░реНрддрд╛ (UUID) рд╣реИред  рдпрджрд┐ рдИрд╡реЗрдВрдЯ рдкрд╛рда рдпрд╛ рдХреНрд▓рд╛рдЗрдВрдЯ рдкрд░ рд▓рд╛рдЧреВ рд╣реЛрддрд╛ рд╣реИ рддреЛ рдИрд╡реЗрдВрдЯ рд╕реНрдЯреЛрд░ рдзреНрдпрд╛рди рдирд╣реАрдВ рд░рдЦрддрд╛ рд╣реИред  рд╡рд╣ рдХреЗрд╡рд▓ рдпрд╣ рдЬрд╛рдирддрд╛ рд╣реИ рдХрд┐ рдпрд╣ рдПрдХ рдЖрдИрдбреА рд╕реЗ рдЬреБрдбрд╝рд╛ рд╣реИред <br><br>  рдкрд░реАрдХреНрд╖рдг рдХреЗ рджреМрд░рд╛рди рдкрд╣рдЪрд╛рдиреА рдЧрдИ рддреНрд░реБрдЯрд┐рдпреЛрдВ рдХреЗ рдЖрдзрд╛рд░ рдкрд░, рд╣рдо рд▓рд╛рдкрддрд╛ рдХрдХреНрд╖рд╛рдПрдВ рдмрдирд╛ рд╕рдХрддреЗ рд╣реИрдВред  рд╕рдмрд╕реЗ рдкрд╣рд▓реЗ, рд╣рдо рд▓реЗрд╕рдиреЙрдЗрдб рдХреНрд▓рд╛рд╕ рдмрдирд╛рдПрдВрдЧреЗ, рдлрд┐рд░ рдмреБрдХрд▓реИрд╕рди рдХрдорд╛рдВрдб (рд╣реИрдВрдбрд▓рд░ рд╡рд┐рдзрд┐ рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рдЕрднреА рддрдХ рдЪрд┐рдВрддрд╛ рди рдХрд░реЗрдВ, рдмрд╕ рдкрд░реАрдХреНрд╖рдг рдЪрд▓рд╛рдирд╛ рдЬрд╛рд░реА рд░рдЦреЗрдВ)ред  рд▓реЗрд╕рди рдХреНрд▓рд╛рд╕, рд▓реЗрд╕рд╕рди рдиреЗрдорд╕реНрдкреЗрд╕ рдХреЗ рдмрд╛рд╣рд░ рдПрдХ рд░реАрдбрд┐рдВрдЧ рдореЙрдбрд▓ рд╣реИред  рдПрдХ рд╡рд┐рд╢реЗрд╖ рд░реАрдбрд┐рдВрдЧ рдореЙрдбрд▓ - рд╡рд┐рд╖рдп рдХреНрд╖реЗрддреНрд░ рдХрд╛ рддрд░реНрдХ рдпрд╣рд╛рдВ рдХрднреА рд╕рдВрдЧреНрд░рд╣реАрдд рдирд╣реАрдВ рдХрд┐рдпрд╛ рдЬрд╛рдПрдЧрд╛ред  рдирд┐рд╖реНрдХрд░реНрд╖ рдореЗрдВ, рд╣рдореЗрдВ рдкрд╛рда рддрд╛рд▓рд┐рдХрд╛ рдХреЗ рд▓рд┐рдП рдПрдХ рдорд╛рдЗрдЧреНрд░реЗрд╢рди рдмрдирд╛рдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реЛрдЧреАред <br><br>  рдХреЛрдб рдХреА рд╕реНрдкрд╖реНрдЯрддрд╛ рдмрдирд╛рдП рд░рдЦрдиреЗ рдХреЗ рд▓рд┐рдП, рдореИрдВ рд╕рддреНрдпрд╛рдкрди рд╕рддреНрдпрд╛рдкрди рдкреБрд╕реНрддрдХрд╛рд▓рдп рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░реВрдВрдЧрд╛ред  рдЗрд╕реЗ рдирд┐рдореНрди рдХрдорд╛рдВрдб рдХреЗ рд╕рд╛рде рдЬреЛрдбрд╝рд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ: <br><br><pre> <code class="plaintext hljs">$&gt; composer require beberlei/assert</code> </pre> <br>  рдЗрд╕ рдХрдорд╛рдВрдб рджреНрд╡рд╛рд░рд╛ рд╢реБрд░реВ рдХреА рдЬрд╛рдиреЗ рд╡рд╛рд▓реА рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдкрд░ рд╡рд┐рдЪрд╛рд░ рдХрд░реЗрдВ: <br><br><ol><li>  рдорд╛рдиреНрдпрддрд╛: рдЖрд╡рд╢реНрдпрдХ рдЖрджреЗрд╢ рд╡рд┐рдлрд▓ рд╣реЛ рд╕рдХрддреЗ рд╣реИрдВ, рдФрд░ рдШрдЯрдирд╛рдПрдБ рдкрд╣рд▓реЗ рд╣реА рдШрдЯрд┐рдд рд╣реЛ рдЪреБрдХреА рд╣реИрдВ рдФрд░ рдЗрд╕рд▓рд┐рдП рд╡рд┐рдлрд▓ рдирд╣реАрдВ рд╣реЛрдиреА рдЪрд╛рд╣рд┐рдПред </li><li>  рдПрдХ рдирдпрд╛ рдкрд╛рда рдмрдирд╛рдПрдБ рдШрдЯрдирд╛ (рдПрдХ рдкрд╛рда рдХреЗ рд▓рд┐рдП рд╕рд╛рдЗрди рдЕрдк)ред </li><li>  рдЧрддрд┐рд╡рд┐рдзрд┐ рдХреА рд╕реНрдерд┐рддрд┐ рдЕрдкрдбреЗрдЯ рдХрд░реЗрдВред  (рд░рд┐рдХреЙрд░реНрдб рдореЙрдбрд▓ рдХреЛ рдореЙрдбрд▓ рдХреА рд╕реНрдерд┐рддрд┐ рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рдкрддрд╛ рд╣реЛрдирд╛ рдЪрд╛рд╣рд┐рдП рддрд╛рдХрд┐ рд╡рд╣ рд╕рддреНрдпрд╛рдкрди рдХрд░ рд╕рдХреЗред) </li><li>  рдЗрд╕ рдШрдЯрдирд╛ рдХреЛ рдЧрддрд┐рд╡рд┐рдзрд┐ рд░рд┐рдХреЙрд░реНрдб рдореЙрдбрд▓ рдореЗрдВ рд╕рдВрдЧреНрд░рд╣реАрдд рдЕрдирдЕрдорд╛рдЗрдВрдб рдЗрд╡реЗрдВрдЯ рдХреА рдзрд╛рд░рд╛ рдореЗрдВ рдЬреЛрдбрд╝реЗрдВред </li><li>  рд╕реНрдЯреЛрд░ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЕрдкреНрд░рдХрд╛рд╢рд┐рдд рдШрдЯрдирд╛рдУрдВ рдХреА рдзрд╛рд░рд╛ рдХреЛ рдмрдЪрд╛рдПрдВред </li><li>  рдкрд╛рда рддрд╛рд▓рд┐рдХрд╛ рдХреЛ рдЕрджреНрдпрддрди рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рд╕рднреА рдкрдарди рдкреНрд░реЛрдЬреЗрдХреНрдЯрд░реЛрдВ рдХреЛ рд╕реВрдЪрд┐рдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рд╡рд┐рд╢реНрд╡ рд╕реНрддрд░ рдкрд░ рд▓реЗрд╕рдиреЙрд╕реНрдХрдмреБрдХ рдХреА рдЧрдИ рдШрдЯрдирд╛ рдЙрдард╛рдПрдБред </li></ol><br>  рдкрд╣рд▓реЗ рдЖрдкрдХреЛ рдкрд╛рда рдХреЗ рд▓рд┐рдП рдПрдХ рд░рд┐рдХреЙрд░реНрдбрд┐рдВрдЧ рдореЙрдбрд▓ рдмрдирд╛рдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реИред  рд╣рдо рд╕реНрдереИрддрд┐рдХ рдХрд╛рд░рдЦрд╛рдирд╛ рд╡рд┐рдзрд┐ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░реЗрдВрдЧреЗ <code>Lesson::bookClientOntoNewLesson()</code> ред  рдпрд╣ рдПрдХ рдирдпрд╛ <code>LessonWasOpened</code> рдИрд╡реЗрдВрдЯ рдЙрддреНрдкрдиреНрди рдХрд░рддрд╛ рд╣реИ (рдкрд╛рда рдЦреБрд▓рд╛ рд╣реИ), рдЗрд╕ рдИрд╡реЗрдВрдЯ рдХреЛ рд╕реНрд╡рдпрдВ рдкрд░ рд▓рд╛рдЧреВ рдХрд░рддрд╛ рд╣реИ (рдмрд╕ рдЕрдкрдиреА рдЖрдИрдбреА рд╕реЗрдЯ рдХрд░рддрд╛ рд╣реИ), рдирдП рдИрд╡реЗрдВрдЯ рдХреЛ <code>DomainEventMessage</code> (рдИрд╡реЗрдВрдЯ рдкреНрд▓рд╕ рдХреБрдЫ рдореЗрдЯрд╛рдбреЗрдЯрд╛ рдХреЗ рд░реВрдк рдореЗрдВ рдЙрдкрдпреЛрдЧ рдХрд░рддрд╛ рд╣реИ рдЬреЛ рд╣рдо рдЗрд╡реЗрдВрдЯ рд╕реНрдЯреЛрд░ рдореЗрдВ рд╕рд╣реЗрдЬрддреЗ рд╕рдордп рдЙрдкрдпреЛрдЧ рдХрд░рддреЗ рд╣реИрдВ)ред <br><br>  рдЗрд╡реЗрдВрдЯ рдореЗрдВ рдХреНрд▓рд╛рдЗрдВрдЯ рдЬреЛрдбрд╝рдиреЗ рдХреЗ рд▓рд┐рдП рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдХреЛ рджреЛрд╣рд░рд╛рдпрд╛ рдЬрд╛рддрд╛ рд╣реИред  <code>ClientWasBookedOntoLesson</code> рдИрд╡реЗрдВрдЯ рд▓рд╛рдЧреВ рдХрд░рддреЗ <code>ClientWasBookedOntoLesson</code> (рдХреНрд▓рд╛рдЗрдВрдЯ рдХреЛ рдкрд╛рда рдореЗрдВ рдирд╛рдорд╛рдВрдХрд┐рдд рдХрд┐рдпрд╛ рдЧрдпрд╛ рдерд╛), рд░рд┐рдХреЙрд░реНрдбрд┐рдВрдЧ рдореЙрдбрд▓ рдХреНрд▓рд╛рдЗрдВрдЯ рдирд╛рдореЛрдВ рдХреЛ рдЯреНрд░реИрдХ рдирд╣реАрдВ рдХрд░рддрд╛ рд╣реИ, рд▓реЗрдХрд┐рди рдХреЗрд╡рд▓ рдкрдВрдЬреАрдХреГрдд рдЧреНрд░рд╛рд╣рдХреЛрдВ рдХреА рд╕рдВрдЦреНрдпрд╛ред  рд░рд┐рдХреЙрд░реНрдб рдореЙрдбрд▓ рдХреЛ рд╕реНрдерд┐рд░рддрд╛ рд╕реБрдирд┐рд╢реНрдЪрд┐рдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЧреНрд░рд╛рд╣рдХ рдХреЗ рдирд╛рдо рдЬрд╛рдирдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рдирд╣реАрдВ рд╣реИред <br><br>  <code>applyLessonWasOpened</code> рдФрд░ <code>applyClientWasBookedOntoLesson</code> рд╡рд┐рдзрд┐рдпрд╛рдВ рдЕрднреА рдереЛрдбрд╝реА рдЕрдЬреАрдм рд▓рдЧ рд╕рдХрддреА рд╣реИрдВред  рд╣рдо рдмрд╛рдж рдореЗрдВ рдЙрдирдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░реЗрдВрдЧреЗ рдЬрдм рд╣рдореЗрдВ рд░рд┐рдХреЙрд░реНрдбрд┐рдВрдЧ рдореЙрдбрд▓ рдХреА рд╕реНрдерд┐рддрд┐ рдмрдирд╛рдиреЗ рдХреЗ рд▓рд┐рдП рдкреБрд░рд╛рдиреА рдШрдЯрдирд╛рдУрдВ рдХреЛ рдкреБрди: рдкреЗрд╢ рдХрд░рдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реЛрдЧреАред  рдпрд╣ рд╕рдордЭрд╛рдирд╛ рдЖрд╕рд╛рди рдирд╣реАрдВ рд╣реИ, рдЗрд╕рд▓рд┐рдП рдореИрдВ рдПрдХ рдХреЛрдб рджреВрдВрдЧрд╛ рдЬреЛ рдЖрдкрдХреЛ рдЗрд╕ рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдХреЛ рд╕рдордЭрдиреЗ рдореЗрдВ рдорджрдж рдХрд░реЗрдЧрд╛ред  рдмрд╛рдж рдореЗрдВ рд╣рдо рдЙрд╕ рдХреЛрдб рдХреЛ рдирд┐рдХрд╛рд▓реЗрдВрдЧреЗ рдЬреЛ uncommittedEvents рдХреЛ рд╕рдВрд╕рд╛рдзрд┐рдд рдХрд░рддрд╛ рд╣реИ рдФрд░ рдбреЛрдореЗрди рдИрд╡реЗрдВрдЯ рд╕рдВрджреЗрд╢ рдЙрддреНрдкрдиреНрди рдХрд░рддрд╛ рд╣реИред <br><br><pre> <code class="bash hljs">app/School/Lesson/Lesson.php public <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> openLesson( LessonId <span class="hljs-variable"><span class="hljs-variable">$lessonId</span></span> ) { /*      ,      ,       */ <span class="hljs-variable"><span class="hljs-variable">$this</span></span>-&gt;apply( new LessonWasOpened( <span class="hljs-variable"><span class="hljs-variable">$lessonId</span></span>) ); } protected <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> applyLessonWasOpened( LessonWasOpened <span class="hljs-variable"><span class="hljs-variable">$event</span></span> ) { <span class="hljs-variable"><span class="hljs-variable">$this</span></span>-&gt;lessonId = <span class="hljs-variable"><span class="hljs-variable">$event</span></span>-&gt;getLessonId(); <span class="hljs-variable"><span class="hljs-variable">$this</span></span>-&gt;numberOfClients = 0; } public <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> bookClient( <span class="hljs-variable"><span class="hljs-variable">$clientName</span></span> ) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-variable"><span class="hljs-variable">$this</span></span>-&gt;numberOfClients &gt;= 3) { throw new TooManyClientsAddedToLesson(); } <span class="hljs-variable"><span class="hljs-variable">$this</span></span>-&gt;apply( new ClientBookedOntoLesson( <span class="hljs-variable"><span class="hljs-variable">$this</span></span>-&gt;lessonId, <span class="hljs-variable"><span class="hljs-variable">$clientName</span></span>) ); } /** *       тАФ *  ,       *      ,       , *      . */ protected <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> applyClientBookedOntoLesson( ClientBookedOntoLesson <span class="hljs-variable"><span class="hljs-variable">$event</span></span> ) { <span class="hljs-variable"><span class="hljs-variable">$this</span></span>-&gt;numberOfClients++; }</code> </pre> <br>  рд╣рдо рдЕрдкрдиреЗ рд░рд┐рдХреЙрд░реНрдбрд┐рдВрдЧ рдореЙрдбрд▓ рд╕реЗ CQRS рдШрдЯрдХреЛрдВ рдХреЛ рдирд┐рдХрд╛рд▓ рд╕рдХрддреЗ рд╣реИрдВ - рдЕрд╕рдореНрдмрджреНрдз рдШрдЯрдирд╛рдУрдВ рдХреЗ рдкреНрд░рд╕рдВрд╕реНрдХрд░рдг рдореЗрдВ рд╢рд╛рдорд┐рд▓ рд╡рд░реНрдЧ рдХреЗ рдЯреБрдХрдбрд╝реЗред  рд╣рдо рдИрд╡реЗрдВрдЯ-рдЬрдирд░реЗрдЯ рдХрд┐рдП рдЧрдП рдирд┐рдХрд╛рдп рдХреЗ рд▓рд┐рдП API рдХреЛ рдПрдХ рд╕реБрд░рдХреНрд╖рд┐рдд <code>applyEventName()</code> рдлрд╝рдВрдХреНрд╢рди рдХреЗ рд▓рд┐рдП рднреА рд╕реНрдкрд╖реНрдЯ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ рдЬреЛ рдИрд╡реЗрдВрдЯ рдХреЛ рд╕реНрд╡реАрдХрд╛рд░ рдХрд░рддрд╛ рд╣реИ, рдЬреЛ рд╕рдВрдмрдВрдзрд┐рдд <code>applyEventName()</code> рд╡рд┐рдзрд┐ рдХреЛ рдХреЙрд▓ рдХрд░рддрд╛ рд╣реИ, рдФрд░ рдПрдХ рдирдП <code>DomainEventMessage</code> рдИрд╡реЗрдВрдЯ рдХреЛ <code>DomainEventMessage</code> рдИрд╡реЗрдВрдЯ рдХреА рд╕реВрдЪреА рдореЗрдВ рдЬреЛрдбрд╝рддрд╛ рд╣реИред  рдирд┐рдХрд╛рд▓рд╛ рдЧрдпрд╛ рд╡рд░реНрдЧ CQRS рдХрд╛рд░реНрдпрд╛рдиреНрд╡рдпрди рдХрд╛ рдПрдХ рд╡рд┐рд╡рд░рдг рд╣реИ рдФрд░ рдЗрд╕рдореЗрдВ рдбреЛрдореЗрди рддрд░реНрдХ рд╢рд╛рдорд┐рд▓ рдирд╣реАрдВ рд╣реИ, рдЗрд╕рд▓рд┐рдП рд╣рдо рдПрдХ рдирдпрд╛ рдирд╛рдорд╕реНрдерд╛рди рдмрдирд╛ рд╕рдХрддреЗ рд╣реИрдВ: App \ CQRS: <br><br>  <i>рдХреЛрдб <code>app/CQRS/EventSourcedEntity.php</code> рдкрд░ рдзреНрдпрд╛рди <code>app/CQRS/EventSourcedEntity.php</code></i> <i><br></i>  <i>рдХреЛрдб рдХреЛ рдХрд╛рдо рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП, рд╣рдореЗрдВ <code>DomainEventMessage</code> рдХреНрд▓рд╛рд╕ рдХреЛ рдЬреЛрдбрд╝рдирд╛ рд╣реЛрдЧрд╛, рдЬреЛ рдХрд┐ рдПрдХ рд╕рд╛рдзрд╛рд░рдг DTO рд╣реИ - рдЗрд╕реЗ <code>app/CQRS/DomainEventMessage.php</code> рдореЗрдВ рдкрд╛рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИред</i> <br><br>  рдЗрд╕ рдкреНрд░рдХрд╛рд░, рд╣рдореЗрдВ рдПрдХ рдкреНрд░рдгрд╛рд▓реА рдорд┐рд▓реА рдЬреЛ рдкреНрд░рддреНрдпреЗрдХ рд▓рд┐рдЦрдиреЗ рдХреЗ рдкреНрд░рдпрд╛рд╕ рдХреЗ рд▓рд┐рдП рдШрдЯрдирд╛рдУрдВ рдХреЛ рдЙрддреНрдкрдиреНрди рдХрд░рддреА рд╣реИ рдФрд░ рдЖрдХреНрд░рдордгрдХрд╛рд░рд┐рдпреЛрдВ рдХреЛ рд░реЛрдХрдиреЗ рдХреЗ рд▓рд┐рдП рдЖрд╡рд╢реНрдпрдХ рдкрд░рд┐рд╡рд░реНрддрдиреЛрдВ рдХреЛ рд░рд┐рдХреЙрд░реНрдб рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдШрдЯрдирд╛рдУрдВ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рддреА рд╣реИред  рдЕрдЧрд▓рд╛ рдХрджрдо рд╕реНрдЯреЛрд░ рдореЗрдВ рдЗрди рдШрдЯрдирд╛рдУрдВ рдХреЛ рдмрдЪрд╛рдиреЗ рдХреЗ рд▓рд┐рдП рд╣реИ (EventStore)ред  рд╕рдмрд╕реЗ рдкрд╣рд▓реЗ, рдЗрд╕ рдШрдЯрдирд╛ рдХреЗ рднрдВрдбрд╛рд░ рдХреЛ рдмрдирд╛рдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реИред  рд╕рд░рд▓ рдмрдирд╛рдиреЗ рдХреЗ рд▓рд┐рдП, рд╣рдо рдПрд▓реЛрдХреЗрдВрдЯ рдореЙрдбрд▓, рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рдХреНрд╖реЗрддреНрд░реЛрдВ рдХреЗ рд╕рд╛рде рдПрдХ рд╕рд╛рдзрд╛рд░рдг рдПрд╕рдХреНрдпреВрдПрд▓ рдЯреЗрдмрд▓ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░реЗрдВрдЧреЗ: * <code>UUID</code> (рдпрд╣ рдЬрд╛рдирдиреЗ рдХреЗ рд▓рд┐рдП рдХрд┐ рдХрд┐рд╕ рдЗрдХрд╛рдИ рдХреЛ рдШрдЯрдирд╛ рдХреЛ рд▓рд╛рдЧреВ рдХрд░рдирд╛ рд╣реИ) * <code>event_payload</code> (рдШрдЯрдирд╛ рдХреЛ рдлрд┐рд░ рд╕реЗ рдмрдирд╛рдиреЗ рдХреЗ рд▓рд┐рдП рдЖрд╡рд╢реНрдпрдХ рд╕рдм рдХреБрдЫ рдпреБрдХреНрдд рдзрд╛рд░рд╛рд╡рд╛рд╣рд┐рдХ рд╕рдВрджреЗрд╢) - <code>event_payload</code> рдЯрд╛рдЗрдорд╕реНрдЯреИрдореНрдк рдЬрдм рдШрдЯрдирд╛ рдХреЛ рдЬрд╛рдирдиреЗ рдХреЗ рд▓рд┐рдПред рдпрд╣ рдХреНрдпрд╛ рд╣реБрдЖред  рдпрджрд┐ рдЖрдк рдХреЛрдб рдХреА рд╕рд╛рд╡рдзрд╛рдиреАрдкреВрд░реНрд╡рдХ рд╕рдореАрдХреНрд╖рд╛ рдХрд░рддреЗ рд╣реИрдВ, рддреЛ рдЖрдк рджреЗрдЦреЗрдВрдЧреЗ рдХрд┐ рдореИрдВрдиреЗ рджреЛ рдЖрджреЗрд╢ рдмрдирд╛рдП - рд╣рдорд╛рд░реЗ рд╕реНрдЯреЛрд░реЗрдЬ рдЯреЗрдмрд▓ рдХреЛ рдмрдирд╛рдиреЗ рдФрд░ рдирд╖реНрдЯ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП: <br><br><ul><li>  php рдХрд╛рд░реАрдЧрд░ eloquenteventstore: рдмрдирд╛рдПрдБ (App \ CQRS \ EloquentEventStore \ CreateEloquentEventStore) </li><li>  php рдХрд╛рд░реАрдЧрд░ eloquenteventstore: drop (App \ CQRS \ EloquentEventStore \ DropEloquentEventStore) (рдЙрдиреНрд╣реЗрдВ рдРрдк \ _ рдХрдВрд╕реЛрд▓ / рдХрд░реНрдиреЗрд▓ рдореЗрдВ рдЬреЛрдбрд╝рдирд╛ рди рднреВрд▓реЗрдВред рддрд╛рдХрд┐ рд╡реЗ рд▓реЛрдб рд╣реЛрдВ)ред </li></ul><br>  SQL рдХреЛ рдЗрд╡реЗрдВрдЯ рд╕реНрдЯреЛрд░ рдХреЗ рд░реВрдк рдореЗрдВ рдЙрдкрдпреЛрдЧ рдирд╣реАрдВ рдХрд░рдиреЗ рдХреЗ рджреЛ рдмрд╣реБрдд рд╣реА рдЕрдЪреНрдЫреЗ рдХрд╛рд░рдг рд╣реИрдВ: рдпрд╣ рдПрдкреЗрдВрдб-рдУрдирд▓реА рдореЙрдбрд▓ (рдХреЗрд╡рд▓ рдбреЗрдЯрд╛ рдЬреЛрдбрд╝рдирд╛, рдИрд╡реЗрдВрдЯ рдЕрдкрд░рд┐рд╡рд░реНрддрдиреАрдп рд╣реЛрдирд╛ рдЪрд╛рд╣рд┐рдП) рдХреЛ рд▓рд╛рдЧреВ рдирд╣реАрдВ рдХрд░рддрд╛ рд╣реИ, рдФрд░ рдпрд╣ рднреА рдХрд┐ SQL рдЯреЗрдореНрдкреЛрд░рд▓ рдбреЗрдЯрд╛рдмреЗрд╕ рдХреЗ рд▓рд┐рдП рдПрдХ рдЖрджрд░реНрд╢ рдХреНрд╡реЗрд░реА рд▓реИрдВрдЧреНрд╡реЗрдЬ рдирд╣реАрдВ рд╣реИред  рд╣рдо рдмрд╛рдж рдХреЗ рдкреНрд░рдХрд╛рд╢рдиреЛрдВ рдореЗрдВ рдЗрд╡реЗрдВрдЯ рд╕реНрдЯреЛрд░ рдХреЗ рдкреНрд░рддрд┐рд╕реНрдерд╛рдкрди рдХреА рд╕реБрд╡рд┐рдзрд╛ рдХреЗ рд▓рд┐рдП рдЗрдВрдЯрд░рдлрд╝реЗрд╕ рдХреЛ рдкреНрд░реЛрдЧреНрд░рд╛рдо рдХрд░рддреЗ рд╣реИрдВред <br><br>  рдШрдЯрдирд╛рдУрдВ рдХреЛ рдмрдЪрд╛рдиреЗ рдХреЗ рд▓рд┐рдП, рднрдВрдбрд╛рд░ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░реЗрдВред  рдЬрдм рднреА рд░рд┐рдХреЙрд░реНрдбрд┐рдВрдЧ рдореЙрдбрд▓ рдХреЗ рд▓рд┐рдП <code>save()</code> рдХрд╣рд╛ рдЬрд╛рддрд╛ рд╣реИ, рддреЛ рд╣рдо рдИрд╡реЗрдВрдЯ рд╕реНрдЯреЛрд░ рдореЗрдВ рдЕрдирдХрдореНрдпреВрдЯрд┐рд╡ рд▓рд┐рд╕реНрдЯ рдХреЛ рд╕рд╣реЗрдЬрддреЗ рд╣реИрдВред  рдШрдЯрдирд╛рдУрдВ рдХреЛ рд╕рдВрдЧреНрд░рд╣реАрдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП, рд╣рдореЗрдВ рдЙрдирдХреЗ рдХреНрд░рдорд╛рдВрдХрди рдФрд░ рдбреАрд░рд╛рдЗрдЬрд╝реЗрд╢рди рдХреЗ рд▓рд┐рдП рдПрдХ рддрдВрддреНрд░ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реИред  рдЗрд╕рдХреЗ рд▓рд┐рдП рдПрдХ Serializer рдмрдирд╛рдПрдВред  рд╣рдореЗрдВ рдореЗрдЯрд╛рдбреЗрдЯрд╛ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реИ, рдЬреИрд╕реЗ рдХрд┐ рдПрдХ рдШрдЯрдирд╛ рд╡рд░реНрдЧ (рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдП, <code>App\School\Lesson\Events\LessonWasOpened</code> ) рдФрд░ рдПрдХ рдЗрд╡реЗрдВрдЯ рдкреЗрд▓реЛрдб (рдХрд┐рд╕реА рдШрдЯрдирд╛ рдХреЛ рдлрд┐рд░ рд╕реЗ рд╕рдВрдЧрдард┐рдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЖрд╡рд╢реНрдпрдХ рдбреЗрдЯрд╛)ред <br><br>  рдпрд╣ рд╕рдм JSON рдкреНрд░рд╛рд░реВрдк рдореЗрдВ рдПрдиреНрдХреЛрдб рдХрд┐рдпрд╛ рдЬрд╛рдПрдЧрд╛, рдФрд░ рдлрд┐рд░ рдЗрдХрд╛рдИ UUID рдФрд░ рдЯрд╛рдЗрдорд╕реНрдЯреИрдореНрдк рдХреЗ рд╕рд╛рде рд╣рдорд╛рд░реЗ рдбреЗрдЯрд╛рдмреЗрд╕ рдХреЛ рд▓рд┐рдЦрд╛ рдЬрд╛рдПрдЧрд╛ред  рд╣рдо рдШрдЯрдирд╛рдУрдВ рдХреЛ рдХреИрдкреНрдЪрд░ рдХрд░рдиреЗ рдХреЗ рдмрд╛рдж рдЕрдкрдиреЗ рд░реАрдбрд┐рдВрдЧ рдореЙрдбрд▓ рдХреЛ рдЕрдкрдбреЗрдЯ рдХрд░рдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВ, рдЗрд╕рд▓рд┐рдП рдмрдЪрдд рдХреЗ рдмрд╛рдж рд░рд┐рдкреЙрдЬрд┐рдЯрд░реА рд╣рд░ рдШрдЯрдирд╛ рдХреЛ рдЯреНрд░рд┐рдЧрд░ рдХрд░реЗрдЧреАред  рд╕реАрд░рд┐рдпрд▓ рдХреНрд▓рд╛рд╕ рдХреЗ рд▓рд┐рдП рдЬрд┐рдореНрдореЗрджрд╛рд░ рд╣реЛрдЧрд╛, рдЬрдмрдХрд┐ рдЗрд╡реЗрдВрдЯ рдЙрд╕рдХреЗ рдкреЗрд▓реЛрдб рдХреЛ рд╕реАрд░рд┐рдпрд▓ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЬрд┐рдореНрдореЗрджрд╛рд░ рд╣реЛрдЧрд╛ред  рдПрдХ рдкреВрд░реА рддрд░рд╣ рд╕реЗ рдХреНрд░рдордмрджреНрдз рдШрдЯрдирд╛ рдХреБрдЫ рдЗрд╕ рддрд░рд╣ рджрд┐рдЦрд╛рдИ рджреЗрдЧреА: <br><br><pre> <code class="plaintext hljs"> { class: "App\\School\\Lesson\\Events\\", event: $event-&gt;serialize() }</code> </pre> <br>  рдЪреВрдБрдХрд┐ рд╕рднреА рдШрдЯрдирд╛рдУрдВ рдХреЛ рдХреНрд░рдордмрджреНрдзрддрд╛ рдФрд░ рдбреАрд░рд┐рдПрд▓рд╛рдЗрдЬрд╝реЗрд╢рди рд╡рд┐рдзрд┐ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реЛрддреА рд╣реИ, рдЗрд╕рд▓рд┐рдП рд╣рдо рдПрдХ <code>SerializableEvent</code> рдЗрдВрдЯрд░рдлрд╝реЗрд╕ рдмрдирд╛ рд╕рдХрддреЗ рд╣реИрдВ рдФрд░ рдЕрдкреЗрдХреНрд╖рд┐рдд рдореВрд▓реНрдп рдХреЗ рдкреНрд░рдХрд╛рд░ рдХрд╛ рдПрдХ рд╕рдВрдХреЗрдд рдЬреЛрдбрд╝ рд╕рдХрддреЗ рд╣реИрдВред  рд╣рдорд╛рд░реЗ <code>LessonWasOpened</code> рдЕрдкрдбреЗрдЯ рдХрд░реЗрдВ: <br><br><pre> <code class="bash hljs">app/School/Lesson/Events/LessonWasOpened.php class LessonWasOpened implements SerializableEvent { public <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> <span class="hljs-function"><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">serialize</span></span></span></span>() { <span class="hljs-built_in"><span class="hljs-built_in">return</span></span> array( <span class="hljs-string"><span class="hljs-string">'lessonId'</span></span>=&gt; (string) <span class="hljs-variable"><span class="hljs-variable">$this</span></span>-&gt;getLessonId() ); } }</code> </pre> <br>  рдПрдХ <code>LessonRepository</code> рд░рд┐рдкреЛрдЬрд┐рдЯрд░реА рд░рд┐рдкреЛрдЬрд┐рдЯрд░реА рдмрдирд╛рдПрдВред  рд╣рдо рдмрд╛рдж рдореЗрдВ рдХреЛрд░ CQRS рдШрдЯрдХреЛрдВ рдХреЛ рд░рд┐рдлреНрд▓реЗрдХреНрдЯрд░ рдФрд░ рдирд┐рдХрд╛рд▓ рд╕рдХрддреЗ рд╣реИрдВред <br><br> <code>app/School/Lesson/LessonRepository.php</code> <br> <pre> <code class="plaintext hljs">eventStoreRepository = new EloquentEventStoreRepository( new EventSerializer() ); } public function save(Lesson $lesson) { /** @var DomainEventMessage $domainEventMessage */ foreach( $lesson-&gt;getUncommittedDomainEvents() as $domainEventMessage ) { $this-&gt;eventStoreRepository-&gt;append( $domainEventMessage-&gt;getId(), $domainEventMessage-&gt;getEvent(), $domainEventMessage-&gt;getRecordedAt() ); Event::fire($domainEventMessage-&gt;getEvent()); } } }</code> </pre> <br>  рдпрджрд┐ рдЖрдк рдлрд┐рд░ рд╕реЗ рдПрдХреАрдХрд░рдг рдкрд░реАрдХреНрд╖рдг рдЪрд▓рд╛рддреЗ рд╣реИрдВ рдФрд░ рдлрд┐рд░ <code>domain_events</code> SQL рддрд╛рд▓рд┐рдХрд╛ рдХреА рдЬрд╛рдБрдЪ рдХрд░рддреЗ рд╣реИрдВ, рддреЛ рдЖрдкрдХреЛ рдбреЗрдЯрд╛рдмреЗрд╕ рдореЗрдВ рджреЛ рдШрдЯрдирд╛рдУрдВ рдХреЛ рджреЗрдЦрдирд╛ рдЪрд╛рд╣рд┐рдПред <br><br>  рдкрд░реАрдХреНрд╖рдг рдХреЛ рд╕рдлрд▓рддрд╛рдкреВрд░реНрд╡рдХ рдкрд╛рд╕ рдХрд░рдиреЗ рдореЗрдВ рд╣рдорд╛рд░рд╛ рдЕрдВрддрд┐рдо рдЪрд░рдг рдкреНрд░рд╕рд╛рд░рдг рдШрдЯрдирд╛рдУрдВ рдХреЛ рд╕реБрди рд░рд╣рд╛ рд╣реИ рдФрд░ рдкрд╛рда рдкрдврд╝рдиреЗ рдХреЗ рдореЙрдбрд▓ рдХреЗ рдкреНрд░рдХреНрд╖реЗрдкрдг рдХреЛ рдЕрджреНрдпрддрди рдХрд░рдирд╛ рд╣реИред  рдкрд╛рда рдкреНрд░рд╕рд╛рд░рдг рдХреА рдШрдЯрдирд╛рдУрдВ рдХреЛ <code>LessonProjector</code> рджреНрд╡рд╛рд░рд╛ рдЗрдВрдЯрд░рд╕реЗрдкреНрдЯ рдХрд┐рдпрд╛ рдЬрд╛рдПрдЧрд╛, рдЬреЛ <code>LessonProjection</code> (рдкрд╛рда рддрд╛рд▓рд┐рдХрд╛ рдХреЗ <code>LessonProjection</code> рдореЙрдбрд▓) рдореЗрдВ рдЖрд╡рд╢реНрдпрдХ рдкрд░рд┐рд╡рд░реНрддрди рд▓рд╛рдЧреВ рдХрд░реЗрдЧрд╛: <br><br><pre> <code class="bash hljs"> app/School/Lesson/Projections/LessonProjector.php class LessonProjector { public <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> applyLessonWasOpened( LessonWasOpened <span class="hljs-variable"><span class="hljs-variable">$event</span></span> ) { <span class="hljs-variable"><span class="hljs-variable">$lessonProjection</span></span> = new LessonProjection(); <span class="hljs-variable"><span class="hljs-variable">$lessonProjection</span></span>-&gt;id = <span class="hljs-variable"><span class="hljs-variable">$event</span></span>-&gt;getLessonId(); <span class="hljs-variable"><span class="hljs-variable">$lessonProjection</span></span>-&gt;save(); } public <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> subscribe(Dispatcher <span class="hljs-variable"><span class="hljs-variable">$events</span></span>) { <span class="hljs-variable"><span class="hljs-variable">$fullClassName</span></span> = self::class; <span class="hljs-variable"><span class="hljs-variable">$events</span></span>-&gt;listen( LessonWasOpened::class, <span class="hljs-variable"><span class="hljs-variable">$fullClassName</span></span>.<span class="hljs-string"><span class="hljs-string">'@applyLessonWasOpened'</span></span>); } }  app/School/Lesson/Projections/LessonProjection.php class LessonProjection extends Model { public <span class="hljs-variable"><span class="hljs-variable">$timestamps</span></span> = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; protected <span class="hljs-variable"><span class="hljs-variable">$table</span></span> = <span class="hljs-string"><span class="hljs-string">"lessons"</span></span>; }</code> </pre> <br>  рдпрджрд┐ рдЖрдк рдкрд░реАрдХреНрд╖рдг рдЪрд▓рд╛рддреЗ рд╣реИрдВ, рддреЛ рдЖрдк рджреЗрдЦреЗрдВрдЧреЗ рдХрд┐ рдПрдХ SQL рддреНрд░реБрдЯрд┐ рд╣реБрдИ рд╣реИ: <br><br><pre> <code class="plaintext hljs">Unknown column 'clientName' in 'field list'</code> </pre> <br>  рдЬреИрд╕реЗ рд╣реА рд╣рдо <code>clientName</code> рдХреЛ рдкрд╛рда рддрд╛рд▓рд┐рдХрд╛ рдореЗрдВ рдЬреЛрдбрд╝рдиреЗ рдХреЗ рд▓рд┐рдП рдорд╛рдЗрдЧреНрд░реЗрд╢рди рдмрдирд╛рддреЗ рд╣реИрдВ, рд╣рдо рд╕рдлрд▓рддрд╛рдкреВрд░реНрд╡рдХ рдкрд░реАрдХреНрд╖рдг рдкрд╛рд╕ рдХрд░ рд▓реЗрдВрдЧреЗред  рд╣рдордиреЗ CQRS рдХреА рдмреБрдирд┐рдпрд╛рджреА рдХрд╛рд░реНрдпрдХреНрд╖рдорддрд╛ рдХреЛ рд▓рд╛рдЧреВ рдХрд┐рдпрд╛ рд╣реИ: рдЯреАрдореЗрдВ рдРрд╕реА рдШрдЯрдирд╛рдУрдВ рдХрд╛ рдирд┐рд░реНрдорд╛рдг рдХрд░рддреА рд╣реИрдВ рдЬрд┐рдирдХрд╛ рдЙрдкрдпреЛрдЧ рд░реАрдбрд┐рдВрдЧ рдореЙрдбрд▓ рдмрдирд╛рдиреЗ рдХреЗ рд▓рд┐рдП рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИред <br><br><h2>  рд▓рд┐рдВрдХ рдХреЗ рд╕рд╛рде рд░реАрдбрд┐рдВрдЧ рдореЙрдбрд▓ рдореЗрдВ рд╕реБрдзрд╛рд░ </h2><br>  рд╣рдо рдПрдХ рдорд╣рддреНрд╡рдкреВрд░реНрдг рдореБрдХрд╛рдо рдкрд░ рдкрд╣реБрдВрдЪ рдЧрдП рд╣реИрдВ, рд▓реЗрдХрд┐рди рдпрд╣ рд╕рдм рдирд╣реАрдВ рд╣реИ!  рдЕрдм рддрдХ, рд░реАрдбрд┐рдВрдЧ рдореЙрдбрд▓ рдХреЗрд╡рд▓ рдПрдХ рдХреНрд▓рд╛рдЗрдВрдЯ рдХрд╛ рд╕рдорд░реНрдерди рдХрд░рддрд╛ рд╣реИ (рд╣рдордиреЗ рдЕрдкрдиреЗ рдбреЛрдореЗрди рдирд┐рдпрдореЛрдВ рдореЗрдВ рддреАрди рдирд┐рд░реНрджрд┐рд╖реНрдЯ рдХрд┐рдП рд╣реИрдВ)ред  рд░реАрдбрд┐рдВрдЧ рдореЙрдбрд▓ рдореЗрдВ рд╣рдо рдЬреЛ рдмрджрд▓рд╛рд╡ рдХрд░рддреЗ рд╣реИрдВ, рд╡реЗ рдХрд╛рдлреА рд╕рд░рд▓ рд╣реИрдВ: рд╣рдо рд╕рд┐рд░реНрдл рдПрдХ рдХреНрд▓рд╛рдЗрдВрдЯ рдкреНрд░реЛрдЬреЗрдХреНрд╢рди рдореЙрдбрд▓ рдФрд░ рдПрдХ <code>ClientBookedOntoLesson</code> рдЬреЛ <code>ClientBookedOntoLesson</code> рдЗрд╡реЗрдВрдЯ рдХреЛ рдкрдХрдбрд╝рддрд╛ рд╣реИред  рд╕рдмрд╕реЗ рдкрд╣рд▓реЗ, рд╣рдо рдЕрдкрдиреЗ рдкрд░реАрдХреНрд╖рдг рдХреЛ рдЙрди рдкрд░рд┐рд╡рд░реНрддрдиреЛрдВ рдХреЛ рдкреНрд░рддрд┐рдмрд┐рдВрдмрд┐рдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЕрджреНрдпрддрди рдХрд░рддреЗ рд╣реИрдВ рдЬрд┐рдиреНрд╣реЗрдВ рд╣рдо рдЕрдкрдиреЗ рдкрдврд╝рдиреЗ рдХреЗ рдореЙрдбрд▓ рдореЗрдВ рджреЗрдЦрдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВ: <br><br><pre> <code class="bash hljs">tests/CQRSTest.php public <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> <span class="hljs-function"><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">testFiringEventUpdatesReadModel</span></span></span></span>() { <span class="hljs-variable"><span class="hljs-variable">$lessonId</span></span> = new LessonId( (string) \Rhumsaa\Uuid\Uuid::uuid1() ); <span class="hljs-variable"><span class="hljs-variable">$clientName</span></span> = <span class="hljs-string"><span class="hljs-string">"George"</span></span>; <span class="hljs-variable"><span class="hljs-variable">$command</span></span> = new BookLesson(<span class="hljs-variable"><span class="hljs-variable">$lessonId</span></span>, <span class="hljs-variable"><span class="hljs-variable">$clientName</span></span>); <span class="hljs-variable"><span class="hljs-variable">$this</span></span>-&gt;dispatch(<span class="hljs-variable"><span class="hljs-variable">$command</span></span>); <span class="hljs-variable"><span class="hljs-variable">$lesson</span></span> = Lesson::find( (string) <span class="hljs-variable"><span class="hljs-variable">$lessonId</span></span>); <span class="hljs-variable"><span class="hljs-variable">$this</span></span>-&gt;assertEquals( <span class="hljs-variable"><span class="hljs-variable">$lesson</span></span>-&gt;id, (string) <span class="hljs-variable"><span class="hljs-variable">$lessonId</span></span> ); <span class="hljs-variable"><span class="hljs-variable">$client</span></span> = <span class="hljs-variable"><span class="hljs-variable">$lesson</span></span>-&gt;clients()-&gt;first(); <span class="hljs-variable"><span class="hljs-variable">$this</span></span>-&gt;assertEquals(<span class="hljs-variable"><span class="hljs-variable">$client</span></span>-&gt;name, <span class="hljs-variable"><span class="hljs-variable">$clientName</span></span>); }</code> </pre><br>  рдпрд╣ рдПрдХ рд╕реНрдкрд╖реНрдЯ рдкреНрд░рджрд░реНрд╢рди рд╣реИ рдХрд┐ рд░реАрдбрд┐рдВрдЧ рдореЙрдбрд▓ рдХреЛ рдмрджрд▓рдирд╛ рдХрд┐рддрдирд╛ рдЖрд╕рд╛рди рд╣реИред  рд╕рдм рдХреБрдЫ, рдШрдЯрдирд╛ рдХреЗ рднрдВрдбрд╛рд░ рдХреЗ рдиреАрдЪреЗ, рдЕрдкрд░рд┐рд╡рд░реНрддрд┐рдд рд░рд╣рддрд╛ рд╣реИред  рдПрдХ рдмреЛрдирд╕ рдХреЗ рд░реВрдк рдореЗрдВ, рдИрд╡реЗрдВрдЯ рд╕рд┐рд╕реНрдЯрдо рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рддреЗ рд╕рдордп, рд╣рдореЗрдВ рдмреБрдирд┐рдпрд╛рджреА рдкрд░реАрдХреНрд╖рдгреЛрдВ рдХреЗ рд▓рд┐рдП рдбреЗрдЯрд╛ рдорд┐рд▓рддрд╛ рд╣реИ - рд░реАрдбрд┐рдВрдЧ рдореЙрдбрд▓ рдХреЗ рдкреНрд░реЛрдЬреЗрдХреНрдЯрд░ рдХреЛ рдмрджрд▓рддреЗ рд╕рдордп, рд╣рдо рд╣рд░ рдЙрд╕ рдШрдЯрдирд╛ рдХреЛ рд╕реБрдирддреЗ рд╣реИрдВ рдЬреЛ рдХрднреА рд╣рдорд╛рд░реЗ рд╕рд┐рд╕реНрдЯрдо рдореЗрдВ рд╣реБрдИ рд╣реИред <br><br>  рд╣рдо рдирдП рдкреНрд░реЛрдЬреЗрдХреНрдЯрд░ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдЗрди рдШрдЯрдирд╛рдУрдВ рдХреЛ рдкреБрди: рдкреЗрд╢ рдХрд░рддреЗ рд╣реИрдВ, рдЕрдкрд╡рд╛рджреЛрдВ рдХреА рдЬрд╛рдВрдЪ рдХрд░рддреЗ рд╣реИрдВ, рдФрд░ рдкрд┐рдЫрд▓реЗ рдЕрдиреБрдорд╛рдиреЛрдВ рдХреЗ рд╕рд╛рде рдкрд░рд┐рдгрд╛рдореЛрдВ рдХреА рддреБрд▓рдирд╛ рдХрд░рддреЗ рд╣реИрдВред  рд╕рд┐рд╕реНрдЯрдо рдХреБрдЫ рд╕рдордп рдХреЗ рд▓рд┐рдП рдХрд╛рдо рдХрд░рдиреЗ рдХреЗ рдмрд╛рдж, рд╣рдорд╛рд░реЗ рдкрд╛рд╕ рд╣рдорд╛рд░реЗ рдкреНрд░реЛрдЬреЗрдХреНрдЯрд░реЛрдВ рдХреЗ рдкрд░реАрдХреНрд╖рдг рдХреЗ рд▓рд┐рдП рдШрдЯрдирд╛рдУрдВ рдХрд╛ рдПрдХ рдХрд╛рдлреА рдкреНрд░рддрд┐рдирд┐рдзрд┐ рдЪрдпрди рд╣реЛрдЧрд╛ред <br><br>  рд╣рдорд╛рд░реЗ рд░рд┐рдХреЙрд░реНрдбрд┐рдВрдЧ рдореЙрдбрд▓ рдореЗрдВ рд╡рд░реНрддрдорд╛рди рд╕реНрдерд┐рддрд┐ рдХреЛ рд▓реЛрдб рдХрд░рдиреЗ рдХреА рдХреНрд╖рдорддрд╛ рдирд╣реАрдВ рд╣реИред  рдпрджрд┐ рд╣рдо рдкрд╛рда рдореЗрдВ рджреВрд╕рд░рд╛ рдЧреНрд░рд╛рд╣рдХ рдЬреЛрдбрд╝рдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВ, рддреЛ рд╣рдо рдмрд╕ рдПрдХ рджреВрд╕рд░рд╛ ClientWasAddedToLesson рдИрд╡реЗрдВрдЯ рдмрдирд╛ рд╕рдХрддреЗ рд╣реИрдВ, рд▓реЗрдХрд┐рди рд╣рдо рдЗрдирд╡рд┐рдпрд░реНрд╕ рдХреЗ рдЦрд┐рд▓рд╛рдл рд╕реБрд░рдХреНрд╖рд╛ рдкреНрд░рджрд╛рди рдирд╣реАрдВ рдХрд░ рд╕рдХрддреЗред  рдЕрдзрд┐рдХ рд╕реНрдкрд╖реНрдЯрддрд╛ рдХреЗ рд▓рд┐рдП, рдореИрдВ рдкреНрд░рддрд┐ рдкрд╛рда рджреЛ рдЧреНрд░рд╛рд╣рдХреЛрдВ рдХреА рд░рд┐рдХреЙрд░реНрдбрд┐рдВрдЧ рдХрд╛ рдЕрдиреБрдХрд░рдг рдХрд░рддреЗ рд╣реБрдП рдПрдХ рджреВрд╕рд░рд╛ рдкрд░реАрдХреНрд╖рдг рд▓рд┐рдЦрдиреЗ рдХрд╛ рдкреНрд░рд╕реНрддрд╛рд╡ рдХрд░рддрд╛ рд╣реВрдВред <br><br><pre> <code class="bash hljs">tests/CQRSTest.php public <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> <span class="hljs-function"><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">testLoadingWriteModel</span></span></span></span>() { <span class="hljs-variable"><span class="hljs-variable">$lessonId</span></span> = new LessonId( (string) \Rhumsaa\Uuid\Uuid::uuid1() ); <span class="hljs-variable"><span class="hljs-variable">$clientName_1</span></span> = <span class="hljs-string"><span class="hljs-string">"George"</span></span>; <span class="hljs-variable"><span class="hljs-variable">$clientName_2</span></span> = <span class="hljs-string"><span class="hljs-string">"Fred"</span></span>; <span class="hljs-variable"><span class="hljs-variable">$command</span></span> = new BookLesson(<span class="hljs-variable"><span class="hljs-variable">$lessonId</span></span>, <span class="hljs-variable"><span class="hljs-variable">$clientName_1</span></span>); <span class="hljs-variable"><span class="hljs-variable">$this</span></span>-&gt;dispatch(<span class="hljs-variable"><span class="hljs-variable">$command</span></span>); <span class="hljs-variable"><span class="hljs-variable">$command</span></span> = new BookClientOntoLesson(<span class="hljs-variable"><span class="hljs-variable">$lessonId</span></span>, <span class="hljs-variable"><span class="hljs-variable">$clientName_2</span></span>); <span class="hljs-variable"><span class="hljs-variable">$this</span></span>-&gt;dispatch(<span class="hljs-variable"><span class="hljs-variable">$command</span></span>); <span class="hljs-variable"><span class="hljs-variable">$lesson</span></span> = Lesson::find( (string) <span class="hljs-variable"><span class="hljs-variable">$lessonId</span></span> ); <span class="hljs-variable"><span class="hljs-variable">$this</span></span>-&gt;assertClientCollectionContains(<span class="hljs-variable"><span class="hljs-variable">$lesson</span></span>-&gt;clients, <span class="hljs-variable"><span class="hljs-variable">$clientName_1</span></span>); <span class="hljs-variable"><span class="hljs-variable">$this</span></span>-&gt;assertClientCollectionContains(<span class="hljs-variable"><span class="hljs-variable">$lesson</span></span>-&gt;clients, <span class="hljs-variable"><span class="hljs-variable">$clientName_2</span></span>); }</code> </pre> <br>  рд╣рдорд╛рд░реЗ рд░рд┐рдХреЙрд░реНрдбрд┐рдВрдЧ рдореЙрдбрд▓ рдХреЗ рд▓рд┐рдП, рд╣рдореЗрдВ рдПрдХ рдЗрдХрд╛рдИ рдХреЛ "рд▓реЛрдб" рдХрд░рдиреЗ рдХреА рдПрдХ рд╡рд┐рдзрд┐ рдХреЛ рд▓рд╛рдЧреВ рдХрд░рдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реИ рдЬрд┐рд╕рдХреЗ рд▓рд┐рдП рдЗрд╡реЗрдВрдЯ рд╕реНрдЯреЛрд░ рдореЗрдВ рдкрд╣рд▓реЗ рд╕реЗ рд╣реА рдЗрд╕рдХреЗ рд▓рд┐рдП рдЖрд╡реЗрджрди рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред  рд╣рдо рдЗрдХрд╛рдИ рдХреЗ рдпреВрдпреВрдЖрдИрдбреА рдХреЛ рд╕рдВрджрд░реНрднрд┐рдд рдХрд░рдиреЗ рд╡рд╛рд▓реА рдкреНрд░рддреНрдпреЗрдХ рдШрдЯрдирд╛ рдХреЛ рд╡рд╛рдкрд╕ рдЦреЗрд▓рдХрд░ рдЗрд╕реЗ рдкреНрд░рд╛рдкреНрдд рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред  рд╕рд╛рдорд╛рдиреНрдп рд╢рдмреНрджреЛрдВ рдореЗрдВ, рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдЗрд╕ рдкреНрд░рдХрд╛рд░ рд╣реИ: <br><br><ol><li>  рд╣рдореЗрдВ рдИрд╡реЗрдВрдЯ рд╕реНрдЯреЛрд░ рд╕реЗ рд╕рднреА рдкреНрд░рд╛рд╕рдВрдЧрд┐рдХ рдИрд╡реЗрдВрдЯ рд╕рдВрджреЗрд╢ рдкреНрд░рд╛рдкреНрдд рд╣реЛрддреЗ рд╣реИрдВред </li><li>  рдкреНрд░рддреНрдпреЗрдХ рд╕рдВрджреЗрд╢ рдХреЗ рд▓рд┐рдП, рд╣рдо рдЗрд╕реА рдШрдЯрдирд╛ рдХреЛ рдлрд┐рд░ рд╕реЗ рдмрдирд╛рддреЗ рд╣реИрдВред </li><li>  рд╣рдо рдПрдХ рдирдпрд╛ рдЗрдХрд╛рдИ рд░рд┐рдХреЙрд░реНрдб рдореЙрдбрд▓ рдмрдирд╛рддреЗ рд╣реИрдВ рдФрд░ рдкреНрд░рддреНрдпреЗрдХ рдШрдЯрдирд╛ рдХреЛ рд╡рд╛рдкрд╕ рдЦреЗрд▓рддреЗ рд╣реИрдВред </li></ol><br>  рдлрд┐рд▓рд╣рд╛рд▓, рд╣рдорд╛рд░реЗ рдкрд░реАрдХреНрд╖рдг рдЕрдкрд╡рд╛рджреЛрдВ рдХреЛ рдлреЗрдВрдХрддреЗ рд╣реИрдВ, рдЗрд╕рд▓рд┐рдП рд╣рдо <code>BookLesson</code> рдХрдорд╛рдВрдб рдХреЛ рдЯреЗрдореНрдкрд▓реЗрдЯ рдХреЗ рд░реВрдк рдореЗрдВ рдЙрдкрдпреЛрдЧ рдХрд░рддреЗ рд╣реБрдП, рдЖрд╡рд╢реНрдпрдХ <code>BookClientOntoLesson</code> (рдкрд╛рда рдХреЗ рд▓рд┐рдП рдПрдХ рдХреНрд▓рд╛рдЗрдВрдЯ рд░рдЬрд┐рд╕реНрдЯрд░ рдХрд░реЗрдВ) <code>BookLesson</code> рдХрд░реЗрдВрдЧреЗред  рд╣реИрдВрдбрд▓рд░ рд╡рд┐рдзрд┐ рдЗрд╕ рддрд░рд╣ рджрд┐рдЦрд╛рдИ рджреЗрдЧреА: <br><br><pre> <code class="bash hljs"> app/School/Lesson/Commands/BookClientOntoLesson.php public <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> handle(LessonRepository <span class="hljs-variable"><span class="hljs-variable">$repository</span></span>) { /** @var Lesson <span class="hljs-variable"><span class="hljs-variable">$lesson</span></span> */ <span class="hljs-variable"><span class="hljs-variable">$lesson</span></span> = <span class="hljs-variable"><span class="hljs-variable">$repository</span></span>-&gt;load(<span class="hljs-variable"><span class="hljs-variable">$this</span></span>-&gt;lessonId); <span class="hljs-variable"><span class="hljs-variable">$lesson</span></span>-&gt;bookClient(<span class="hljs-variable"><span class="hljs-variable">$this</span></span>-&gt;clientName); <span class="hljs-variable"><span class="hljs-variable">$repository</span></span>-&gt;save(<span class="hljs-variable"><span class="hljs-variable">$lesson</span></span>); }      : app/School/Lesson/LessonRepository.php public <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> load(LessonId <span class="hljs-variable"><span class="hljs-variable">$id</span></span>) { <span class="hljs-variable"><span class="hljs-variable">$events</span></span> = <span class="hljs-variable"><span class="hljs-variable">$this</span></span>-&gt;eventStoreRepository-&gt;load(<span class="hljs-variable"><span class="hljs-variable">$id</span></span>); <span class="hljs-variable"><span class="hljs-variable">$lesson</span></span> = new Lesson(); <span class="hljs-variable"><span class="hljs-variable">$lesson</span></span>-&gt;initializeState(<span class="hljs-variable"><span class="hljs-variable">$events</span></span>); <span class="hljs-built_in"><span class="hljs-built_in">return</span></span> <span class="hljs-variable"><span class="hljs-variable">$lesson</span></span>; }</code> </pre> <br>  рд░рд┐рдкреЙрдЬрд┐рдЯрд░реА рд▓реЛрдб рдлрд╝рдВрдХреНрд╢рди рд░реАрдХреНрд░рд┐рдПрдЯреЗрдб рдЗрд╡реЗрдВрдЯ рдХреА рдПрдХ рд╕рд░рдгреА рджреЗрддрд╛ рд╣реИред  рдРрд╕рд╛ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП, рд╡рд╣ рдкрд╣рд▓реЗ рд░рд┐рдкреЙрдЬрд┐рдЯрд░реА рдореЗрдВ рдШрдЯрдирд╛рдУрдВ рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рд╕рдВрджреЗрд╢ рдкрд╛рддрд╛ рд╣реИ, рдФрд░ рдлрд┐рд░ рдкреНрд░рддреНрдпреЗрдХ рд╕рдВрджреЗрд╢ рдХреЛ рдПрдХ рдШрдЯрдирд╛ рдореЗрдВ рдмрджрд▓рдиреЗ рдХреЗ рд▓рд┐рдП рдЙрдиреНрд╣реЗрдВ <code>Serializer</code> рдореЗрдВ <code>Serializer</code> рд╣реИред  <code>Serializer</code> рдШрдЯрдирд╛рдУрдВ рд╕реЗ рд╕рдВрджреЗрд╢ рдмрдирд╛рддрд╛ рд╣реИ, рдЗрд╕рд▓рд┐рдП рд╣рдореЗрдВ рд╡реНрдпреБрддреНрдХреНрд░рдо рдкрд░рд┐рд╡рд░реНрддрди рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП <code>deserialize()</code> рд╡рд┐рдзрд┐ рдХреЛ рдЬреЛрдбрд╝рдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реИред  рдпрд╛рдж рд░рдЦреЗрдВ рдХрд┐ рдШрдЯрдирд╛ рдХреЗ рдбреЗрдЯрд╛ (рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдП, рдХреНрд▓рд╛рдЗрдВрдЯ рдХрд╛ рдирд╛рдо) рдХреЛ рдХреНрд░рдордмрджреНрдз рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдкреНрд░рддреНрдпреЗрдХ рдШрдЯрдирд╛ рдХреЗ рд▓рд┐рдП <code>Serializer</code> рдкрд╛рд░рд┐рдд рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИред  рд╣рдо рд╡реНрдпреБрддреНрдХреНрд░рдо рдкрд░рд┐рд╡рд░реНрддрди рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдРрд╕рд╛ рд╣реА рдХрд░реЗрдВрдЧреЗ, рдЬрдмрдХрд┐ рд╣рдорд╛рд░реЗ <code>SerializableEvent</code> рдЗрдВрдЯрд░рдлрд╝реЗрд╕ рдХреЛ <code>deserialize()</code> рд╡рд┐рдзрд┐ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдЕрдкрдбреЗрдЯ рдХрд┐рдпрд╛ рдЬрд╛рдирд╛ рдЪрд╛рд╣рд┐рдПред  рдХреЛрдб рдХреЛ рджреЗрдЦрддреЗ рд╣реИрдВ рддрд╛рдХрд┐ рд╕рдм рдХреБрдЫ рдЬрдЧрд╣ рдореЗрдВ рдЧрд┐рд░ рдЬрд╛рдПред  рд╕рдмрд╕реЗ рдкрд╣рд▓реЗ <code>EventStoreRepository</code> рд▓реЛрдб <code>EventStoreRepository</code> : <br><br><pre> <code class="bash hljs">app/CQRS/EloquentEventStore/EloquentEventStoreRepository.php public <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> load(<span class="hljs-variable"><span class="hljs-variable">$uuid</span></span>) { <span class="hljs-variable"><span class="hljs-variable">$eventMessages</span></span> = EloquentEventStoreModel::<span class="hljs-built_in"><span class="hljs-built_in">where</span></span>(<span class="hljs-string"><span class="hljs-string">'uuid'</span></span>, <span class="hljs-variable"><span class="hljs-variable">$uuid</span></span>)-&gt;get(); <span class="hljs-variable"><span class="hljs-variable">$events</span></span> = []; foreach(<span class="hljs-variable"><span class="hljs-variable">$eventMessages</span></span> as <span class="hljs-variable"><span class="hljs-variable">$eventMessage</span></span>) { /*       event_payload,        . */ <span class="hljs-variable"><span class="hljs-variable">$events</span></span>[] = <span class="hljs-variable"><span class="hljs-variable">$this</span></span>-&gt;eventSerializer-&gt;deserialize( json_decode(<span class="hljs-variable"><span class="hljs-variable">$eventMessage</span></span>-&gt;event_payload)); } <span class="hljs-built_in"><span class="hljs-built_in">return</span></span> <span class="hljs-variable"><span class="hljs-variable">$events</span></span>; }</code> </pre><br>  <code>eventSerializer</code> рдореЗрдВ рдЙрдЪрд┐рдд deserialization рдлрд╝рдВрдХреНрд╢рди рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдирд╛: <br><br><pre> <code class="bash hljs">app/CQRS/Serializer/EventSerializer.php public <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> serialize( SerializableEvent <span class="hljs-variable"><span class="hljs-variable">$event</span></span> ) { <span class="hljs-built_in"><span class="hljs-built_in">return</span></span> array( <span class="hljs-string"><span class="hljs-string">'class'</span></span> =&gt; get_class(<span class="hljs-variable"><span class="hljs-variable">$event</span></span>), <span class="hljs-string"><span class="hljs-string">'payload'</span></span> =&gt; <span class="hljs-variable"><span class="hljs-variable">$event</span></span>-&gt;serialize() ); } public <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> deserialize( <span class="hljs-variable"><span class="hljs-variable">$serializedEvent</span></span> ) { <span class="hljs-variable"><span class="hljs-variable">$eventClass</span></span> = <span class="hljs-variable"><span class="hljs-variable">$serializedEvent</span></span>-&gt;class; <span class="hljs-variable"><span class="hljs-variable">$eventPayload</span></span> = <span class="hljs-variable"><span class="hljs-variable">$serializedEvent</span></span>-&gt;payload; <span class="hljs-built_in"><span class="hljs-built_in">return</span></span> <span class="hljs-variable"><span class="hljs-variable">$eventClass</span></span>::deserialize(<span class="hljs-variable"><span class="hljs-variable">$eventPayload</span></span>); }</code> </pre> <br>  рдЕрдВрдд рдореЗрдВ, рд╣рдо <code>LessonWasOpened</code> рдореЗрдВ рд╕реНрдЯреИрдЯрд┐рдХ рдлреИрдХреНрдЯреНрд░реА рд╡рд┐рдзрд┐ <code>deserialize()</code> рдХрд╛ рдЙрдкрдпреЛрдЧ <code>LessonWasOpened</code> (рд╣рдореЗрдВ рдкреНрд░рддреНрдпреЗрдХ рдИрд╡реЗрдВрдЯ рдореЗрдВ рдЗрд╕ рд╡рд┐рдзрд┐ рдХреЛ рдЬреЛрдбрд╝рдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реИ) <br><br><pre> <code class="bash hljs">app/School/Lesson/Events/LessonWasOpened.php public static <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> deserialize(<span class="hljs-variable"><span class="hljs-variable">$data</span></span>) { <span class="hljs-variable"><span class="hljs-variable">$lessonId</span></span> = new LessonId(<span class="hljs-variable"><span class="hljs-variable">$data</span></span>-&gt;lessonId); <span class="hljs-built_in"><span class="hljs-built_in">return</span></span> new self(<span class="hljs-variable"><span class="hljs-variable">$lessonId</span></span>); }</code> </pre> <br>  рдЕрдм рд╣рдорд╛рд░реЗ рдкрд╛рд╕ рдЙрди рд╕рднреА рдШрдЯрдирд╛рдУрдВ рдХреА рдПрдХ рд╕рд░рдгреА рд╣реИ, рдЬрд┐рдиреНрд╣реЗрдВ рд╣рдордиреЗ <code>app/CQRS/EventSouredEntity.php</code> рдореЗрдВ <code>initializeState</code> рд╡рд┐рдзрд┐ рдореЗрдВ рд░рд╛рдЬреНрдп рдХреЛ рд╢реБрд░реВ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рд╣рдорд╛рд░реЗ рдПрдВрдЯрд┐рдЯреА рд░рд┐рдХреЙрд░реНрдб рдореЙрдбрд▓ рдХреЗ рд╕рд╛рдкреЗрдХреНрд╖ рдкреБрди: рдкреНрд░рд╕реНрддреБрдд рдХрд┐рдпрд╛ рд╣реИред <br><br>  рдЕрдм рд╣рдорд╛рд░реА рдкрд░реАрдХреНрд╖рд╛ рдЪрд▓рд╛рдУред  рдмрд┐рдВрдЧреЛ! <br>  рд╡рд╛рд╕реНрддрд╡ рдореЗрдВ, рдЗрд╕ рд╕рдордп рд╣рдорд╛рд░реЗ рдкрд╛рд╕ рд╣рдорд╛рд░реЗ рдбреЛрдореЗрди рдирд┐рдпрдореЛрдВ рдХреЗ рдЕрдиреБрдкрд╛рд▓рди рдХреЛ рд╕рддреНрдпрд╛рдкрд┐рдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдПрдХ рдкрд░реАрдХреНрд╖рдг рдирд╣реАрдВ рд╣реИ, рдЗрд╕рд▓рд┐рдП рдЗрд╕реЗ рд▓рд┐рдЦреЗрдВ: <br><br><pre> <code class="bash hljs">tests/CQRSTest.php public <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> <span class="hljs-function"><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">testMoreThan3ClientsCannotBeAddedToALesson</span></span></span></span>() { <span class="hljs-variable"><span class="hljs-variable">$lessonId</span></span> = new LessonId( (string) \Rhumsaa\Uuid\Uuid::uuid1() ); <span class="hljs-variable"><span class="hljs-variable">$this</span></span>-&gt;dispatch( new BookLesson(<span class="hljs-variable"><span class="hljs-variable">$lessonId</span></span>, <span class="hljs-string"><span class="hljs-string">"bob"</span></span>) ); <span class="hljs-variable"><span class="hljs-variable">$this</span></span>-&gt;dispatch( new BookClientOntoLesson(<span class="hljs-variable"><span class="hljs-variable">$lessonId</span></span>, <span class="hljs-string"><span class="hljs-string">"george"</span></span>) ); <span class="hljs-variable"><span class="hljs-variable">$this</span></span>-&gt;dispatch( new BookClientOntoLesson(<span class="hljs-variable"><span class="hljs-variable">$lessonId</span></span>, <span class="hljs-string"><span class="hljs-string">"fred"</span></span>) ); <span class="hljs-variable"><span class="hljs-variable">$this</span></span>-&gt;setExpectedException( TooManyClientsAddedToLesson::class ); <span class="hljs-variable"><span class="hljs-variable">$this</span></span>-&gt;dispatch( new BookClientOntoLesson(<span class="hljs-variable"><span class="hljs-variable">$lessonId</span></span>, <span class="hljs-string"><span class="hljs-string">"emma"</span></span>) ); }</code> </pre> <br>  рдХреГрдкрдпрд╛ рдзреНрдпрд╛рди рджреЗрдВ рдХрд┐ рд╣рдореЗрдВ рдХреЗрд╡рд▓ <code>lessonId</code> рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реИ - рдпрд╣ рдкрд░реАрдХреНрд╖рдг рдкреНрд░рддреНрдпреЗрдХ рдХрдорд╛рдВрдб рдХреЗ рджреМрд░рд╛рди рдкрд╛рда рдХреА рд╕реНрдерд┐рддрд┐ рдХреЛ <code>lessonId</code> ред <br><br>  рдлрд┐рд▓рд╣рд╛рд▓, рд╣рдо рдХреЗрд╡рд▓ рдореИрдиреНрдпреБрдЕрд▓ рд░реВрдк рд╕реЗ рдмрдирд╛рдП рдЧрдП <code>UUID</code> рд╕реНрдерд╛рдирд╛рдВрддрд░рд┐рдд рдХрд░рддреЗ рд╣реИрдВ, рдЬрдмрдХрд┐ рд╡рд╛рд╕реНрддрд╡ рдореЗрдВ рд╣рдо рдЙрдиреНрд╣реЗрдВ рд╕реНрд╡рдЪрд╛рд▓рд┐рдд рд░реВрдк рд╕реЗ рдЙрддреНрдкрдиреНрди рдХрд░рдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВред  рдореИрдВ <code>Ramsy\UUID</code> рдкреИрдХреЗрдЬ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдиреЗ рдЬрд╛ рд░рд╣рд╛ рд╣реВрдВ, рдЗрд╕рд▓рд┐рдП <code>composer</code> рд╕рд╛рде рдЗрд╕реЗ рд╕реНрдерд╛рдкрд┐рдд рдХрд░реЗрдВ: <br><br><pre> <code class="plaintext hljs">$&gt; composer require ramsey/uuid</code> </pre> <br>  рдЕрдм рдирдП рдкреИрдХреЗрдЬ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рд╣рдорд╛рд░реЗ рдкрд░реАрдХреНрд╖рдг рдЕрдкрдбреЗрдЯ рдХрд░реЗрдВ: <br><br><pre> <code class="bash hljs">tests/CQRSTest.php public <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> <span class="hljs-function"><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">testEntityCreationWithUUIDGenerator</span></span></span></span>() { <span class="hljs-variable"><span class="hljs-variable">$lessonId</span></span> = new LessonId( (string) \Rhumsaa\Uuid\Uuid::uuid1() ); <span class="hljs-variable"><span class="hljs-variable">$this</span></span>-&gt;dispatch( new BookLesson(<span class="hljs-variable"><span class="hljs-variable">$lessonId</span></span>, <span class="hljs-string"><span class="hljs-string">"bob"</span></span>) ); <span class="hljs-variable"><span class="hljs-variable">$this</span></span>-&gt;assertInstanceOf( Lesson::class, Lesson::find( (string) <span class="hljs-variable"><span class="hljs-variable">$lessonId</span></span>) ); }</code> </pre><br>  рдЕрдм рдирдП рдкреНрд░реЛрдЬреЗрдХреНрдЯ рдбреЗрд╡рд▓рдкрд░ рдХреЛрдб рдХреЛ рджреЗрдЦ рд╕рдХрддреЗ рд╣реИрдВ, <code>App\School\ReadModels</code> , рдЬрд┐рд╕рдореЗрдВ <code>App\School\ReadModels</code> рдореЙрдбрд▓ рдХрд╛ рдПрдХ рд╕реЗрдЯ рд╣реИ, рдФрд░ рдкрд╛рда рддрд╛рд▓рд┐рдХрд╛ рдореЗрдВ рдкрд░рд┐рд╡рд░реНрддрди рд▓рд┐рдЦрдиреЗ рдХреЗ рд▓рд┐рдП рдЗрди рдореЙрдбрд▓реЛрдВ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░реЗрдВред  рд╣рдо рдПрдХ рдРрд╕рд╛ <code>app/CQRS/ReadModelImmutableModel.php</code> рдХреНрд▓рд╛рд╕ рдмрдирд╛рдХрд░ рдЗрд╕реЗ рд░реЛрдХ рд╕рдХрддреЗ рд╣реИрдВ, рдЬреЛ рдПрд▓реЛрдХреНрд╡реЗрдВрдЯ рдореЙрдбрд▓ рдХреНрд▓рд╛рд╕ рдХрд╛ рд╡рд┐рд╕реНрддрд╛рд░ рдХрд░рддрд╛ рд╣реИ рдФрд░ <code>app/CQRS/ReadModelImmutableModel.php</code> рдореЗрдВ рд╕реЗрд╡ рдореЗрдердб рдХреЛ рдУрд╡рд░рд░рд╛рдЗрдб рдХрд░рддрд╛ рд╣реИред </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/hi461899/">https://habr.com/ru/post/hi461899/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../hi461885/index.html">EDS рдзреЛрдЦрд╛рдзрдбрд╝реА рдХрд╛ рдПрдХ рдЕрдиреНрдп рдкреНрд░рдХрд╛рд░ рд╣реИ</a></li>
<li><a href="../hi461887/index.html">рдПрд░реЛрдиреЗрдЯ рдПрдкрд┐рд╕реЛрдб 2 рдореЗрдВ рдкреНрд░рд╡реЗрд╢: рд╣реЛрдорд┐рдВрдЧ рдбреНрд░реЛрди</a></li>
<li><a href="../hi461891/index.html">рд╣рдордиреЗ ManageIQ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдмреИрдВрдХ рдХреЗ рдмреБрдирд┐рдпрд╛рджреА рдврд╛рдВрдЪреЗ рдореЗрдВ рджреЛрд╕реНрдд рдХреИрд╕реЗ рдмрдирд╛рдП</a></li>
<li><a href="../hi461895/index.html">рдпрд╛рддреНрд░рд╛ рдХреЗ рджреМрд░рд╛рди рдЬрд╛рдиреЗрдВ - рд╣рдордиреЗ 1 рдпреВрд░реЛрдкреАрдп рд╡реНрдпрд╛рдкрд╛рд░ рд╡рд┐рд╢реНрд▓реЗрд╖рдг рджрд┐рд╡рд╕ рдкрд░ рдХреИрд╕реЗ рдпрд╛рддреНрд░рд╛ рдХреА</a></li>
<li><a href="../hi461897/index.html">рд╣рдо рд▓рдореЛрдбрд╛ рдПрдкреНрд▓рд┐рдХреЗрд╢рди рдХреА рд╕реНрдерд┐рд░рддрд╛ рдХреИрд╕реЗ рдмрдирд╛рдП рд░рдЦрддреЗ рд╣реИрдВ</a></li>
<li><a href="../hi461901/index.html">рдСрдЯреЛрдЯреЗрд╕реНрдЯреНрд╕ рдХреЗ рддреАрди рд╕рд╛рд▓: рдХреИрд╕реЗ рдЧрддрд┐ рдмрдврд╝рд╛рдиреЗ рдХреЗ рд▓рд┐рдП рдФрд░ рди рдХреЗрд╡рд▓</a></li>
<li><a href="../hi461903/index.html">рд░рд╣рд╕реНрдпрдордп рдкреНрд░рддрд┐рдХреВрд▓: рдлрдЬреА рдЙрдзрд╛рд░реА</a></li>
<li><a href="../hi461905/index.html">рдЯрд┐рдХ рдЯреАрдПрд╕реА рдХреЛ рдкреИрд░ рдХреА рдЕрдВрдЧреБрд▓реА, рднрд╛рдЧ 7: pytest рдФрд░ рдЯреНрд░реИрд╡рд┐рд╕ CI</a></li>
<li><a href="../hi461907/index.html">рдПрдХ рдкреВрд░реНрдг-рдЪрдХреНрд░ рд╕реНрдЯреВрдбрд┐рдпреЛ рдореЗрдВ рдЙрддреНрдкрд╛рдж рд╡рд┐рд╢реНрд▓реЗрд╖рдг</a></li>
<li><a href="../hi461913/index.html">рдИ-рдХреЙрдорд░реНрд╕ рдореЗрдВ рдореЛрдмрд╛рдЗрд▓ рдкреНрд░рдпреЛрдЬреНрдпрддрд╛: рд░реВрд╕ рдореЗрдВ TOP-20 рдСрдирд▓рд╛рдЗрди рд╕реНрдЯреЛрд░ рдХрд╛ рд╡рд┐рд╢реНрд▓реЗрд╖рдг</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>