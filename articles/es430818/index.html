<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë®üèº‚Äç‚öïÔ∏è üìº üåê SQLAlchemy Acceleration for Architectural Astronauts üéÆ ‚òùüèæ üåì</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Habr, este es un informe del ingeniero de software Alexei Starkov en la conferencia Moscow Python Conf ++ 2018 en Mosc√∫. Video al final de la publicac...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>SQLAlchemy Acceleration for Architectural Astronauts</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/qrator/blog/430818/"><img src="https://habrastorage.org/webt/nk/mr/3o/nkmr3o45oaha-8h6n1elhxx3nai.png"><br><blockquote> Habr, este es un informe del ingeniero de software Alexei Starkov en la conferencia Moscow Python Conf ++ 2018 en Mosc√∫.  Video al final de la publicaci√≥n. </blockquote>  Hola a todos!  Mi nombre es Alexei Starkov, soy yo, en mis mejores a√±os, trabajo en una f√°brica. <br>  Ahora trabajo en Qrator Labs.  B√°sicamente, toda mi vida, estudi√© C y C ++, me encanta Alexandrescu, The Gang of Four, los principios de SOLID, eso es todo.  Lo que me convierte en un astronauta arquitect√≥nico.  He estado escribiendo Python durante los √∫ltimos a√±os porque me gusta. <br><br>  En realidad, ¬øqui√©nes son los "cosmonautas arquitect√≥nicos"?  La primera vez que conoc√≠ este t√©rmino con Joel Spolsky, probablemente lo ley√≥.  Describe a los "astronautas" como personas que quieren construir una arquitectura ideal, que cuelgan la abstracci√≥n, sobre la abstracci√≥n, sobre la abstracci√≥n, que se est√° volviendo cada vez m√°s general.  Al final, estos niveles son tan altos que describen todos los programas posibles, pero no resuelven ning√∫n problema pr√°ctico.  En este momento, el "astronauta" (esta es la √∫ltima vez que este t√©rmino est√° rodeado de comillas) se queda sin aire y muere. <br><br>  Tambi√©n tengo tendencias hacia la exploraci√≥n espacial arquitect√≥nica, pero en este informe hablar√© un poco sobre c√≥mo me mordi√≥ y no me permiti√≥ construir un sistema con el rendimiento necesario.  Lo principal es c√≥mo lo super√©. <br><br>  Resumen de mi informe: was / was. <br><a name="habracut"></a><br><img src="https://habrastorage.org/webt/wj/_u/7c/wj_u7c0h2uaody3dj48xsbytsb4.png"><br><br>  Un aumento de miles y millones de veces.  Cuando hice esta diapositiva, el √∫nico pensamiento que tuve fue "¬øC√≥mo?" <br><br><img src="https://habrastorage.org/webt/of/cb/q_/ofcbq_bd033u4wh31hzexjkstfc.png"><br><br>  ¬øD√≥nde podr√≠a fastidiar tanto?  Si no quieres equivocarte como yo, sigue leyendo. <br><br><img src="https://habrastorage.org/webt/md/ni/gt/mdnigtyu3igzmlqmcf89isptecc.png"><br><br>  Hablar√© sobre el sistema de configuraci√≥n.  El sistema de configuraci√≥n es una herramienta interna en Qrator Labs que almacena configuraciones para la Red definida por software (SDN), nuestra red de filtrado.  Se compromete a sincronizar la configuraci√≥n entre componentes y monitorear su estado. <br><br><img src="https://habrastorage.org/webt/xz/kg/zr/xzkgzr2wrphmvslxnx3v2qezxta.png"><br><br>  ¬øEn qu√© consiste, en resumen?  Tenemos una base de datos que almacena una instant√°nea de nuestra configuraci√≥n para toda la red, y tenemos un servidor que procesa los comandos que ingresan y de alguna manera cambia la configuraci√≥n. <br><br>  Nuestros administradores y clientes t√©cnicos llegan a este servidor y a trav√©s de la consola, a trav√©s de las API de punto final, las API REST, JSON RPC y otras cosas emiten comandos al servidor, como resultado de lo cual cambia nuestra configuraci√≥n. <br><br>  Los equipos pueden ser muy simples o m√°s complicados.  Luego, tenemos un cierto conjunto de receptores que componen nuestro SDN y el servidor env√≠a la configuraci√≥n a estos receptores.  Eso suena bastante simple.  B√°sicamente, hablar√© sobre esta parte. <br><br><img src="https://habrastorage.org/webt/yp/uq/c7/ypuqc7pzaeqvmbzsrksb9gefq-w.png"><br><br>  Ya que es ella quien est√° relacionada con la base de datos y la alquimia. <br><br><img src="https://habrastorage.org/webt/qg/sz/np/qgsznprvrp4smdpbuoxopevxxt4.png"><br><br>  ¬øCu√°l es la peculiaridad de este sistema?  Es bastante peque√±o, mediocre.  Cientos de miles, hasta millones, de entidades se almacenan en esta base de datos.  La peculiaridad es que el gr√°fico de las relaciones entre entidades es bastante complejo.  Hay varias jerarqu√≠as de herencia entre entidades, hay inclusiones, simplemente hay dependencias entre ellas.  Todas estas restricciones est√°n determinadas por la l√≥gica empresarial y debemos cumplirlas. <br><br>  La proporci√≥n de solicitudes de escritura a solicitudes de lectura es de aproximadamente 15: 1.  Aqu√≠ est√° claro: hay muchos comandos para cambiar la configuraci√≥n y una vez en un per√≠odo de tiempo prolongado tenemos la configuraci√≥n de inserci√≥n a los puntos finales. <br><br>  MySQL se usa internamente: tambi√©n est√° disponible en otros productos de nuestra empresa, tenemos una experiencia bastante seria en esta base de datos, hay personas que pueden trabajar con ella: crear un esquema de datos, dise√±ar consultas y todo lo dem√°s.  Por lo tanto, tomamos MySQL como una base de datos relacional universal. <br><br><img src="https://habrastorage.org/webt/x0/xs/ae/x0xsae3wqaqw4dfth-y8q7i3tqk.png"><br><br>  ¬øCu√°l fue el problema despu√©s de dise√±ar este sistema?  La ejecuci√≥n de un comando tom√≥ de uno a treinta segundos, dependiendo de la complejidad del equipo.  En consecuencia, el retraso en la ejecuci√≥n lleg√≥ a cinco minutos.  Lleg√≥ un equipo, 30 segundos, el segundo y as√≠ sucesivamente, una acumulaci√≥n de acumulados, un retraso de 5 minutos. <br><br>  El retraso en la aplicaci√≥n de la configuraci√≥n es de hasta diez minutos.  Se decidi√≥ que esto no era suficiente para nosotros y que la optimizaci√≥n era necesaria. <br><br><img src="https://habrastorage.org/webt/ah/6t/fj/ah6tfjmleq-fzvoecldzw5qxxu0.png"><br><br>  Primero, antes de realizar cualquier optimizaci√≥n, es necesario llevar a cabo una investigaci√≥n y descubrir cu√°l es el problema. <br><br><img src="https://habrastorage.org/webt/nu/wf/g6/nuwfg6v2hg2jangw6agmu9i6bw0.png"><br><br>  Al final result√≥ que no ten√≠amos el componente m√°s importante para la investigaci√≥n: no ten√≠amos telemetr√≠a.  Por lo tanto, si est√° dise√±ando alg√∫n tipo de sistema, primero, en la etapa de dise√±o, agregue telemetr√≠a.  Incluso si el sistema es inicialmente peque√±o, luego un poco m√°s, luego a√∫n m√°s; al final, todos llegan a una situaci√≥n en la que necesita ver pistas, pero no hay telemetr√≠a. <br><br><img src="https://habrastorage.org/webt/eh/ws/3t/ehws3tezqmrdlvfcljs1pxbttgm.png"><br><br>  ¬øQu√© se puede hacer a continuaci√≥n si no tiene telemetr√≠a?  Puedes analizar los registros.  Aqu√≠, los guiones bastante simples pasan por nuestros registros y los convierten en una tabla de este tipo, ilustrando los tiempos de ejecuci√≥n de comandos m√°s r√°pidos, lentos y promedio.  A partir de aqu√≠, ya podemos ver en qu√© lugares tenemos gags: qu√© equipos tardan m√°s en ejecutarse y cu√°les m√°s r√°pido. <br><br><img src="https://habrastorage.org/webt/m6/0a/gc/m60agccykga4hl82ktrjfjglzqq.png"><br><br>  Lo √∫nico a tener en cuenta es que al analizar los registros, solo consideramos el tiempo de ejecuci√≥n de estos comandos en el servidor.  Esta es la primera etapa, la marcada como t2.  t1: as√≠ es como el cliente ver√° el tiempo de ejecuci√≥n de nuestro equipo: entrar en la cola, esperar, ejecutar en el servidor.  Este tiempo ser√° m√°s largo, por lo que optimizamos el tiempo t2 y luego usamos el tiempo t1 para determinar si hemos alcanzado el objetivo. <br><br>  t1 es la m√©trica de calidad de nuestro rendimiento. <br><br><img src="https://habrastorage.org/webt/dx/dd/05/dxdd05sisxq1ciu6nu-na0zons8.png"><br><br>  En consecuencia, as√≠ es como perfilamos a todos los equipos, es decir, tomamos el registro del servidor, lo manejamos a trav√©s de nuestros scripts, buscamos e identificamos los componentes que funcionaron m√°s lentamente.  El servidor est√° construido de forma bastante modular, un componente separado es responsable de cada comando, y podemos perfilar los componentes individualmente, y hacer puntos de referencia para ellos.  As√≠ que aqu√≠ ten√≠amos una clase, para cada componente problem√°tico que escribimos en el que en code_under_test () realizamos alguna actividad que representa el uso de combate del componente.  Y hab√≠a dos m√©todos: profile () y bench ().  La primera llama a cProfile, que muestra cu√°ntas veces se llam√≥, d√≥nde est√°n los cuellos de botella. <br><br>  bench () se ejecut√≥ varias veces y consider√≥ diferentes m√©tricas para nosotros; as√≠ es como evaluamos el rendimiento. <br><br>  ¬°Pero result√≥ que este no es el problema! <br><br><img src="https://habrastorage.org/webt/wz/r8/-p/wzr8-pc9epal61cjoraog7bkvxc.png"><br><br>  El principal problema fue la cantidad de consultas a la base de datos.  Hubo muchas solicitudes, y para entender por qu√© hab√≠a tantas, veamos c√≥mo se organiz√≥ todo. <br><br><img src="https://habrastorage.org/webt/bg/r0/rz/bgr0rzhohcouyykpc3raznbi4rq.png"><br><br>  Ante nosotros hay una pieza de un circuito simple que representa a nuestros receptores, presentada en forma de la clase Receptor.  Est√°n unidos en alg√∫n grupo - grupo receptor.  Y, en consecuencia, hay algunos planos de configuraci√≥n: segmentos de la configuraci√≥n, que son un subconjunto de las configuraciones que son responsables de un "rol" de este receptor.  Por ejemplo, para enrutamiento - plano de enrutamiento.  Las llanuras con receptores se pueden conectar en cualquier orden, es decir, esta es una relaci√≥n de muchos a muchos. <br><br>  Esta es una parte del gran esquema que estoy presentando aqu√≠ para que los ejemplos puedan entenderse mejor. <br><br>  ¬øQu√© quiere hacer cada cosmonauta arquitect√≥nico cuando ve la API de otra persona?  Quiere ocultarlo, abstraer y escribir su interfaz para poder eliminar esta API, o m√°s bien ocultarla. <br><br><img src="https://habrastorage.org/webt/nq/zq/7-/nqzq7-zlnbxkkmy7mywbp8lqvq4.png"><br><br>  En consecuencia, hay una API de alquimia "sucia", en la que hay, de hecho, mapeadores y nuestra clase "pura" - Receiver, en la que se almacena alguna configuraci√≥n y hay m√©todos: load (), save (), delete ().  Y todas las otras clases asociadas con √©l.  Obtenemos un gr√°fico de objetos Python, de alguna manera conectados entre s√≠: cada uno de ellos tiene un m√©todo load (), save (), delete (), que se refiere al mapeador de alquimia, que, a su vez, llama a la API. <br><br><img src="https://habrastorage.org/webt/cs/bo/lr/csbolr6uozuvbxhimmqik_llgak.png"><br><br>  La implementaci√≥n aqu√≠ es muy simple.  Tenemos un m√©todo de carga que realiza una consulta a la base de datos y para cada objeto recibido crea su propio objeto Python.  Hay un m√©todo de guardar que hace la operaci√≥n opuesta: busca si hay un objeto en la base de datos utilizando la clave primaria, si no, crea, agrega y luego guardamos el estado de este objeto.  delete en la clave primaria recibe y elimina el objeto de la base de datos. <br><br><img src="https://habrastorage.org/webt/fl/hq/lp/flhqlp2vg6srgo7wswpbowrlq6e.png"><br><br>  El problema principal es inmediatamente visible: esto es el mapeo.  Primero, lo hacemos una vez desde el objeto Python al mapeador, luego el mapeador a la base.  El mapeo adicional es una o dos llamadas, lo que puede no ser tan aterrador todav√≠a.  El principal problema fue la sincronizaci√≥n manual.  Tenemos dos objetos de nuestra interfaz "limpia" y uno de ellos cambia el atributo: ¬øc√≥mo vemos que el atributo ha cambiado en el otro?  De ninguna manera  Es necesario fusionar los cambios en la base de datos y obtener el atributo en otro objeto.  Por supuesto, si sabemos que los objetos est√°n presentes en el mismo contexto, de alguna manera podemos rastrear esto.  Pero si tenemos dos sesiones en diferentes lugares, solo a trav√©s de la base, o bloqueamos la base en la memoria, lo que no hicimos. <br><br>  Este cargar / guardar / eliminar es otro mapeador que duplica completamente el interior de la alquimia, que est√° bien escrito, probado.  Esta herramienta tiene muchos a√±os, hay mucha ayuda en Internet y duplicarla tampoco es muy buena. <br><br>  ¬øVes el √≠cono en la esquina superior derecha?  As√≠ que marcar√© las diapositivas en las que se hace algo por "pureza", para aumentar el nivel de abstracci√≥n, para la astron√°utica arquitect√≥nica.  Es decir, las diapositivas sin este √≠cono son pragm√°ticas y aburridas, poco interesantes y no se pueden leer. <br><br>  Qu√© hacer si muchas consultas son lentas.  Cuantas  En realidad mucho.  Imagine una cadena de herencia: un objeto, tiene un padre, ese tiene otro padre.  Sincronizamos el objeto hijo; para hacer esto, primero debe sincronizar los padres.  Para sincronizar un padre, debe sincronizar su padre.  Bueno, todos estaban sincronizados.  De hecho, dependiendo de c√≥mo hayamos construido el gr√°fico, podr√≠amos caminar y sincronizar todos estos objetos cientos de veces, de ah√≠ una gran cantidad de solicitudes. <br><br><img src="https://habrastorage.org/webt/zo/n7/uh/zon7uhhtngwjd5rnaztxexuatsu.png"><br><br>  Que hemos hecho  Tomamos toda nuestra l√≥gica de negocios y la metimos en el mapeador.  Todos los dem√°s objetos aqu√≠ tambi√©n se fusionaron con los mapeadores, y nuestra API completa, toda la capa de abstracci√≥n de datos, result√≥ sucia. <br><br><img src="https://habrastorage.org/webt/qn/4a/fz/qn4afzy7q6yrh0t-yw4r4m6c9se.png"><br><br>  As√≠ es como se ve en Python: nuestro mapeador tiene alg√∫n tipo de l√≥gica de negocios, hay una descripci√≥n declarativa de esta placa all√≠ mismo.  Se enumeran columnas, relaciones.  Aqu√≠ tenemos tal clase. <br><br><img src="https://habrastorage.org/webt/ez/ud/sg/ezudsgqk1b9domctg8sdvzh4uj8.png"><br><br>  Por supuesto, desde el punto de vista de cualquier astronauta, una API sucia es un inconveniente.  L√≥gica empresarial en una descripci√≥n declarativa de la base.  Los esquemas se mezclan con la l√≥gica empresarial.  Uf  Feo <br><br>  La descripci√≥n del circuito est√° abarrotada.  Esto es realmente un problema: si la l√≥gica de negocios no tiene dos l√≠neas, sino un volumen mayor, entonces en esta clase necesitamos desplazarnos o buscar mucho tiempo para llegar a descripciones espec√≠ficas.  Antes de eso, todo era hermoso: en un lugar, la descripci√≥n de la base, declarativa, descripci√≥n de los esquemas, en otro lugar, la l√≥gica de negocios.  Y luego el circuito est√° abarrotado. <br><br>  Pero, por otro lado, obtenemos inmediatamente los mecanismos de la alquimia: unidad de trabajo, que le permite rastrear qu√© objetos est√°n sucios y qu√© rel√©s deben actualizarse;  obtenemos una relaci√≥n que nos permite deshacernos de preguntas adicionales en la base de datos, sin garantizar que se llenen las colecciones relevantes;  y el mapa de identidad que m√°s nos ayud√≥.  El mapa de identidad garantiza que dos objetos de Python ser√°n el mismo objeto de Python si tienen la misma clave primaria. <br><br>  En consecuencia, redujimos inmediatamente la complejidad a lineal. <br><br><img src="https://habrastorage.org/webt/j4/ek/x8/j4ekx8dvwphpdavetrxejd1uvxg.png"><br><br>  Estos son resultados intermedios.  El rendimiento aument√≥ de inmediato 10 veces, el n√∫mero de consultas a la base de datos disminuy√≥ entre 40 y 80 veces y el RPS aument√≥ a 1-5.  Pues bien.  Pero la API est√° sucia.  Que hacer <br><br><img src="https://habrastorage.org/webt/kj/po/hs/kjpohswqs8svlzroeizbub0tpmk.png"><br><br>  Mixins  Tomamos la l√≥gica comercial, nuevamente la eliminamos de nuestro mapeador, pero para que no haya mapeo nuevamente, heredaremos nuestro mapeador dentro de la alquimia de nuestro mixin.  ¬øPor qu√© no al rev√©s?  Esto no funcionar√° en la alquimia, ella jurar√° y dir√°: "Tienes dos clases diferentes que se refieren a una tableta, no hay polformismo, ve desde aqu√≠".  Y as√≠, es posible. <br><br>  Por lo tanto, tenemos una descripci√≥n declarativa en el mapeador, que se hereda del mixin y recibe toda la l√≥gica de negocios.  Muy comodo  Y el resto de las clases son exactamente iguales.  Parece - genial, todo est√° limpio.  Pero hay una advertencia: las conexiones y los rel√©s permanecen dentro de la alquimia, y cuando, por ejemplo, nos unimos a trav√©s de una tabla secundaria de placas intermedias, entonces el mapeador de esta placa estar√° de alguna manera presente en el c√≥digo del cliente, lo que no es muy hermoso. <br><br>  La alquimia no habr√≠a sido un marco tan bueno y famoso si no me hubiera dado la oportunidad de luchar contra esto. <br><br><img src="https://habrastorage.org/webt/g6/dz/gg/g6dzggup-pvokdl7h4mguhedazc.png"><br><br>  ¬øC√≥mo se ve un mixin?  Tiene l√≥gica de negocios, mapeadores por separado, una descripci√≥n declarativa de la placa.  Las conexiones permanecen dentro de la alquimia, pero la l√≥gica de negocios est√° separada. <br><br>  ¬øC√≥mo se ve el esquema general? <br><br><img src="https://habrastorage.org/webt/xl/1c/eh/xl1cehyjtaoqytk_gz5h-wbc5we.png"><br><br>  Tenemos un archivo con un esquema en el que se recopilan todas nuestras clases declarativas, llam√©moslo schema.py.  Y tenemos entidades en l√≥gica de negocios, por separado.  Y, estas entidades se heredan dentro del archivo de esquema: escribimos una clase separada para cada entidad y la heredamos en el esquema.  Por lo tanto, la l√≥gica empresarial se encuentra en un mont√≥n, el esquema en otro y se pueden cambiar de forma independiente. <br><br><img src="https://habrastorage.org/webt/rj/cl/ql/rjclqll79e8wcjwkjfxova8hhpe.png"><br><br>  Como ejemplo de mejora, consideraremos un esquema simple de dos etiquetas: receptores (tabla de receptores) y segmentos de la configuraci√≥n (tabla de planos de receptores).  Muchos segmentos de configuraci√≥n uno a uno est√°n asociados con la etiqueta del receptor.  No hay nada particularmente complicado. <br><br>  Para ocultar las relaciones dentro de la interfaz "sucia" de la alquimia, utilizamos relaciones y colecciones. <br><br><img src="https://habrastorage.org/webt/mz/ih/qg/mzihqg-lfqb8vhflbkxjpf8igp8.png"><br><br>  Nos permiten ocultar nuestros mapeadores del c√≥digo del cliente. <br><br><img src="https://habrastorage.org/webt/y8/qc/v1/y8qcv1qj8_jq3y_pn-2xw-t6bji.png"><br><br>  En particular, dos colecciones muy √∫tiles son association_proxy y attribute_mapped_collection.  Los usamos juntos.  C√≥mo funciona la relaci√≥n cl√°sica en alquimia: tenemos una relaci√≥n: esta es una cierta colecci√≥n, lista, mapeadores.  Los mapeadores son objetos de relaci√≥n de extremo lejano.  Attribute_mapped_collection le permite reemplazar esta lista con un dict, cuyas claves ser√°n algunos de los atributos de los mapeadores, y los valores son los propios mapeadores. <br><br>  Este es el primer paso. <br><br><img src="https://habrastorage.org/webt/ho/tj/tt/hotjtty0hmg99f_kquecwyo4ms4.png"><br><br>  El segundo paso, hacemos asociaci√≥n_proxy sobre esta relaci√≥n.  Nos permite no pasar el mapeador a la colecci√≥n, sino pasar alg√∫n valor que luego se utilizar√° para inicializar nuestro mapeador, ReceiverPlanes. <br><br>  Aqu√≠ tenemos lambda, en el que pasamos la clave y el valor.  La clave se convierte en el nombre del segmento de configuraci√≥n y el valor en el valor del segmento de configuraci√≥n.  Como resultado, en el c√≥digo del cliente, todo se ve as√≠. <br><br><img src="https://habrastorage.org/webt/ko/00/s7/ko00s71bgaxu6i-h_baocnnqz-w.png"><br><br>  Acabamos de poner alg√∫n tipo de dictado en alg√∫n tipo de diccionario.  Todo funciona: sin mapeadores, sin alquimia, sin bases de datos. <br><br>  Es cierto que hay dificultades. <br><br><img src="https://habrastorage.org/webt/ux/ji/uy/uxjiuybsymdbtrvqlazqhckdv8c.png"><br><br>  Si asignamos valores diferentes, o incluso uno, a la misma clave dos veces, se llama lambda para cada elemento del conjunto, se crea un objeto, un mapeador.  Y, dependiendo de c√≥mo est√© estructurado el esquema, esto puede llevar a varias consecuencias, desde "solo violaciones de las constantes" hasta consecuencias impredecibles.  Por ejemplo, elimin√≥ un objeto de la colecci√≥n, pero a√∫n permaneci√≥ all√≠: elimin√≥ solo uno.  Cuando comenc√©, mataba mucho tiempo en esas cosas. <br><br>  Y una peque√±a sincronizaci√≥n impl√≠cita.  Association_proxy y attribute_mapped_collection puede retrasarse un poco: cuando creamos un objeto de mapeador, se agrega a la base de datos, pero a√∫n no est√° presente en el atributo de colecci√≥n.  Aparecer√° all√≠ solo cuando el atributo caduque en esta sesi√≥n.  Cuando caduque, se producir√° una nueva sincronizaci√≥n con la base de datos y llegar√° all√≠. <br><br>  Para superar esto, utilizamos nuestras propias colecciones, auto escritas.  Esto ni siquiera es alquimia: simplemente puede crear su propia colecci√≥n para superar todo esto. <br><br><img src="https://habrastorage.org/webt/bk/l6/ya/bkl6yaerwagttjp6qprlfbsdpaw.png"><br><br>  Hay m√°s c√≥digo y se resalta la parte m√°s importante.  Tenemos una cierta colecci√≥n que hereda del mapeo mutable: esta es una sentencia, en cuyas claves puede cambiar los valores.  Y hay un m√©todo _get_plane_obj: para obtener el objeto de segmento de configuraci√≥n. <br><br>  Aqu√≠ hacemos cosas simples: intentamos obtenerlo por nombre, por alguna clave primaria y, si no es as√≠, creamos y devolvemos este objeto. <br><br>  A continuaci√≥n, redefinimos solo dos m√©todos: __setitem__ y __getitem__ <br>  En __setitem__, ponemos estos objetos en nuestra colecci√≥n, en una relaci√≥n.  Lo √∫nico es que asignamos valor al final.  Por lo tanto, implementamos el mismo mecanismo que association_proxy: pasa el valor, dict all√≠, y se asigna al atributo correspondiente. <br><br>  __getitem__ realiza la manipulaci√≥n inversa.  Recibe por clave alg√∫n objeto del rel√© y devuelve su atributo.  Tambi√©n hay un peque√±o inconveniente aqu√≠: si almacena en cach√© la colecci√≥n dentro de nuestro mapeo, es posible que se salga un poco de la sincronizaci√≥n.  Porque cuando el atributo de la colecci√≥n caduca en alquimia, la colecci√≥n se reemplaza por otra, despu√©s de la caducidad.  Por lo tanto, podemos mantener la referencia a la colecci√≥n anterior y no saber si la anterior ha expirado y ya ha aparecido una nueva.  Por lo tanto, en la √∫ltima parte, vamos directamente a la instancia de alquimia, nuevamente obtenemos la colecci√≥n a trav√©s de __getattr__ y hacemos __getitem__ con ella.  Es decir, no podemos almacenar en cach√© la colecci√≥n Planes aqu√≠. <br><br><img src="https://habrastorage.org/webt/_0/l6/tt/_0l6tt3pcdjmsxlwy2hivf1b4ty.png"><br><br>  ¬øC√≥mo afecta esta colecci√≥n a nuestros mixins?  Como de costumbre, configure un atributo de colecci√≥n.  El √∫nico lugar interesante es que cuando cargamos una instancia de la base de datos, no se llama al m√©todo __init__.  Todos los atributos se sustituyen ex post. <br><br>  Alchemy ofrece un decorador de reconstrucci√≥n est√°ndar, que le permite marcar alg√∫n m√©todo como llamado despu√©s de cargar un objeto desde la base de datos.  Y justo en el momento del arranque tenemos que inicializar nuestra colecci√≥n.  El yo es solo esa instancia.  El uso es exactamente el mismo que en el ejemplo anterior. <br><br><img src="https://habrastorage.org/webt/qe/yr/h4/qeyrh4fd3cmfpm8-exbfd1rwpkw.png"><br><br>  Pero en nuestro esquema, los o√≠dos de la base de datos todav√≠a son visibles: esta es la configuraci√≥n.  ¬øQu√© tipo de configuraci√≥n?  ¬øEs varchar o es blob?  De hecho, el cliente no est√° interesado.<font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Debe trabajar con entidades abstractas de su nivel. Para esto, la alquimia proporciona una decoraci√≥n tipo. </font></font><br><br><img src="https://habrastorage.org/webt/ds/lc/ic/dslcicbf3yrljfchfwbxhcucleq.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Un simple ejemplo. Nuestra base de datos almacena IPAddress como varchar. Usamos la clase TypeDecorator, que es parte de la alquimia, que permite, en primer lugar, indicar qu√© tipo de base de datos subyacente se usar√° para este tipo y, en segundo lugar, determinar dos par√°metros: process_bind_param que convierte el valor al tipo de base de datos y process_result_value cuando valoramos desde el tipo de base de datos, convertir a un objeto Python.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">El atributo de la direcci√≥n toma el tipo de direcci√≥n IP de tipo python. Y podemos llamar a m√©todos de este tipo y asignarle objetos de este tipo, y todo funciona para nosotros. Y se almacena en la base de datos ... No s√© qu√© se almacena, varchar (45), pero podemos reemplazar esa l√≠nea y se almacenar√° el blob. O si alg√∫n tipo nativo admite direcciones IP, puede usarlo. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">El c√≥digo del cliente no depende de esto, no necesita ser reescrito. </font></font><br><br><img src="https://habrastorage.org/webt/xb/m5/uu/xbm5uu_ryeji94kthsv0rp2ogdw.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Otra cosa interesante es que tenemos una versi√≥n. Queremos que tan pronto como cambiemos nuestro objeto, la versi√≥n aumente de inmediato. Tenemos un contador de versiones, cambiamos el objeto; ha cambiado, la versi√≥n ha aumentado. Hacemos esto autom√°ticamente para no olvidar.</font></font><br><br><img src="https://habrastorage.org/webt/zy/g5/ro/zyg5rofkv1ibi-yb-kuv3kikbww.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Para esto, utilizamos eventos. Los eventos son eventos que ocurren en diferentes etapas de la vida de un mapeador y pueden activarse cuando los atributos cambian, cuando una entidad cambia de un estado a otro, por ejemplo, "creado", "guardado en la base de datos", "cargado de la base de datos", "eliminado"; y tambi√©n - en eventos a nivel de sesi√≥n, antes de que el c√≥digo sql se emita a la base de datos, antes de la confirmaci√≥n, despu√©s de la confirmaci√≥n y tambi√©n despu√©s de la reversi√≥n. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Alchemy nos permite asignar controladores para todos estos eventos, pero no se garantiza el orden en que se ejecutan los controladores para el mismo evento. Es decir, es espec√≠fico, pero no se sabe cu√°l. Por lo tanto, si la orden de ejecuci√≥n es importante para usted, entonces necesita hacer un mecanismo de registro. </font></font><br><br><img src="https://habrastorage.org/webt/wb/h2/w1/wbh2w1k4s4y6jqemt4oatlknwug.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Aqu√≠ hay un ejemplo. Aqu√≠ se utilizan tres eventos:</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">on_before_flush: antes de que el c√≥digo sql se emita a la base de datos, revisamos todos los objetos que la alquimia marc√≥ como sucios en esta sesi√≥n y verificamos si este objeto est√° modificado o no. ¬øPor qu√© es esto necesario si la alquimia ya ha marcado todo? Alchemy marca un objeto sucio tan pronto como alg√∫n atributo ha cambiado. Si asignamos el mismo valor a este atributo que ten√≠a, se marcar√° como sucio. Hay un m√©todo de sesi√≥n is_modified para esto: se usa internamente, no lo dibuj√©. Adem√°s, desde el punto de vista de nuestra sem√°ntica, desde el punto de vista de nuestra l√≥gica empresarial, incluso si el atributo ha cambiado, el objeto puede permanecer sin modificaciones. Por ejemplo, hay una cierta lista en la que se intercambian dos elementos: desde el punto de vista de la alquimia, el atributo ha cambiado, pero no importa la l√≥gica de negocios si, por ejemplo,alg√∫n tipo</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Y, al final, llamamos a otro m√©todo espec√≠fico para cada objeto para comprender si el objeto se modifica o no. Y los agregamos a una determinada variable asociada con la sesi√≥n que creamos nosotros mismos: esta es nuestra variable dirty_instances, en la que agregamos este objeto. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">El siguiente evento ocurre antes del commit - before_commit. Aqu√≠ tambi√©n hay un peque√±o inconveniente: si durante toda la transacci√≥n no tuvimos una sola descarga, entonces se llamar√° a la descarga antes de la confirmaci√≥n; en mi caso, se llam√≥ al controlador antes de la confirmaci√≥n antes de la descarga. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Como puede ver, lo que hicimos en el p√°rrafo anterior puede no ayudarnos y session.dirty_instances estar√° vac√≠o. Por lo tanto, dentro del manejador, nuevamente hacemos vaciado para que todos los manejadores sean llamados antes del vaciado y simplemente incrementen la versi√≥n en uno.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">after_commit, after_soft_rollback: despu√©s del commit, simplemente lo limpiamos para que no haya excesos la pr√≥xima vez. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Por lo tanto, ver√°: este m√©todo install_handler instala controladores para tres eventos a la vez. Como clase, pasamos la sesi√≥n aqu√≠, ya que este es un evento de su nivel. </font></font><br><br><img src="https://habrastorage.org/webt/oi/w8/pk/oiw8pkhgdpx7shz7rqrovfmg6lk.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bueno aqui. Te recordar√© lo que hemos logrado: velocidad de 30-40 segundos para equipos complejos y grandes. En absoluto, algunos se completaron en un segundo, otros en 200 milisegundos, como puede ver en RPS. Las consultas de bases de datos comenzaron a contarse en cientos. </font></font><br><br><img src="https://habrastorage.org/webt/7p/wk/qo/7pwkqo4-g_hksl5m_cqoo3xph5y.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">El resultado es un sistema bastante equilibrado. Hubo, sin embargo, una advertencia. Algunas solicitudes nos llegan en lotes, emisiones. Es decir, ¬°llegan unas 30 solicitudes y cada una de ellas es as√≠! (el orador muestra el pulgar)</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Si los procesamos un segundo a la vez, la √∫ltima solicitud en la cola funcionar√° durante 30 segundos. El primero, los segundos dos, y as√≠ sucesivamente. </font></font><br><br><img src="https://habrastorage.org/webt/ut/br/gl/utbrglrwurgv0uux2yk8eme4owg.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Por lo tanto, a√∫n necesitamos acelerar. Que haremos </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">De hecho, la alquimia tiene dos partes. El primero es una abstracci√≥n sobre una base de datos sql llamada SQLAlchemy Core. El segundo es ORM, el mapeo real entre la base de datos relacional y la representaci√≥n del objeto. En consecuencia, el n√∫cleo de alquimia es uno a uno coincide con sql: si conoce el √∫ltimo, entonces no tendr√° problemas con el n√∫cleo. Si no conoce sql, aprenda sql. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Adem√°s, el n√∫cleo representa la sobrecarga m√°s peque√±a. Pr√°cticamente no hay bombeo: las consultas se generan utilizando el generador de consultas y luego se ejecutan. Los gastos generales sobre dbapi son m√≠nimos.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Podemos crear solicitudes de cualquier complejidad, de cualquier tipo, podemos optimizarlas para la tarea. Es decir, si en el caso general a ORM no le importa c√≥mo se construye el esquema de la base de datos: hay alguna descripci√≥n de las tablas, genera algunas consultas, sin saber que en este caso ser√°, por ejemplo, √≥ptimo seleccionar desde aqu√≠, en otro, desde all√≠, tal aplique el filtro, y all√≠, otro, luego aqu√≠ podemos hacer solicitudes para la tarea. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La desventaja es que volvimos a la sincronizaci√≥n manual. Todos los eventos, retransmisiones: todo esto en el n√∫cleo no funciona. Hicimos una selecci√≥n, los objetos vinieron a nosotros, hicimos algo con ellos, luego actualizamos, insertamos ... necesita incrementar la versi√≥n con sus manos, verifique las constantes usted mismo. Core no permite que todo esto se haga convenientemente, a un alto nivel. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bueno, no vivimos el primer d√≠a.</font></font><br><br><img src="https://habrastorage.org/webt/qx/kk/bx/qxkkbxwleeqwvdukaghimiat7sw.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Un caso de uso simple. Cada asignador contiene internamente un objeto __table__, que se utiliza en el n√∫cleo. A continuaci√≥n, ver√°: tomamos la selecci√≥n habitual, enumeramos las columnas, unimos dos placas, indicamos la izquierda y la derecha, indicamos en qu√© condici√≥n la unimos, bueno, por el gusto agregamos una orden de compra. Adem√°s, alimentamos esta solicitud generada en la sesi√≥n y nos la devuelve iterable, en la que los objetos tipo tap se indexan tanto por el nombre de la columna como por el n√∫mero. El n√∫mero corresponde al orden en que se enumeran en la selecci√≥n. </font></font><br><br><img src="https://habrastorage.org/webt/r2/uq/f4/r2uqf4wn-wa-cvigivokusan6um.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Se ha vuelto mucho mejor. El rendimiento en el peor de los casos cay√≥ a 2-4 segundos, la solicitud m√°s compleja y m√°s larga conten√≠a 14 comandos y RPS 10-15. Es solido. </font></font><br><br><img src="https://habrastorage.org/webt/m9/8d/mw/m98dmwpmo0trjpw3vta7dylmryw.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Lo que me gustar√≠a decir en conclusi√≥n.</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">No produzca entidades donde no sean necesarias, no atornille las suyas donde est√©n listas. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Use SQLA ORM: esta es una herramienta muy conveniente que le permite rastrear eventos a un alto nivel, responder a varios eventos asociados con la base de datos, ocultar todos los o√≠dos de la alquimia. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Si todo lo dem√°s falla, el rendimiento no es suficiente: use SQLA Core. </font><font style="vertical-align: inherit;">Esto es a√∫n mejor que usar SQL puro puro porque proporciona una abstracci√≥n relacional sobre la base de datos. </font><font style="vertical-align: inherit;">Se escapa autom√°ticamente de los par√°metros, hace las carpetas correctamente, no importa qu√© base de datos se encuentre debajo, se puede cambiar y Core admite diferentes dialectos.</font></font> Es muy conveniente. <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Eso es todo lo que quer√≠a decirte hoy. </font></font><br><br><iframe width="560" height="315" src="https://www.youtube.com/embed/flA2lEl2a0M" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/es430818/">https://habr.com/ru/post/es430818/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../es430804/index.html">Las bater√≠as Tesla / Panasonic son las bater√≠as de veh√≠culos el√©ctricos m√°s asequibles del mercado.</a></li>
<li><a href="../es430806/index.html">Comenzamos a aprender ingl√©s - escribimos una aplicaci√≥n: EWM - experiencia en la creaci√≥n de un proyecto de capacitaci√≥n</a></li>
<li><a href="../es430808/index.html">Teor√≠a del orador: 16 materiales sobre c√≥mo funcionan los oradores y los oradores</a></li>
<li><a href="../es430810/index.html">Prueba de carga con langosta. Parte 2</a></li>
<li><a href="../es430812/index.html">Lo que developer.android.com est√° hablando de RecyclerView</a></li>
<li><a href="../es430820/index.html">Black Friday 2018 - VDS en Mosc√∫ y Amsterdam</a></li>
<li><a href="../es430822/index.html">Seguridad de la informaci√≥n de Internet de las cosas: ¬øqui√©n es la cosa y qui√©n es el maestro?</a></li>
<li><a href="../es430824/index.html">Buscar objetos da√±ados por n√∫mero de p√°gina da√±ado en MS SQL Server 2005</a></li>
<li><a href="../es430826/index.html">C√≥mo desarrollar un gerente de desarrollo</a></li>
<li><a href="../es430828/index.html">Experiencia en el uso de pantallas LCD basadas en productos MELT</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>