<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë©üèΩ‚Äç‚öñÔ∏è ü§õüèΩ ü§∑ Node.js e renderiza√ß√£o de servidor no Airbnb üí± üçΩÔ∏è üíí</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="O material, cuja tradu√ß√£o estamos publicando hoje, √© dedicado √† hist√≥ria de como o Airbnb otimiza as partes de servidor de aplicativos da Web, visando...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Node.js e renderiza√ß√£o de servidor no Airbnb</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/ruvds/blog/418009/">  O material, cuja tradu√ß√£o estamos publicando hoje, √© dedicado √† hist√≥ria de como o Airbnb otimiza as partes de servidor de aplicativos da Web, visando o crescente uso das tecnologias de renderiza√ß√£o de servidor.  Ao longo de v√°rios anos, a empresa mudou gradualmente todo o front-end para uma arquitetura <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">uniforme</a> , segundo a qual as p√°ginas da web s√£o estruturas hier√°rquicas dos componentes do React preenchidos com dados de sua API.  Em particular, durante esse processo, houve um abandono sistem√°tico do Ruby on Rails.  De fato, o Airbnb planeja mudar para um novo servi√ßo baseado exclusivamente no Node.js., gra√ßas ao qual as p√°ginas totalmente preparadas renderizadas no servidor ser√£o entregues aos navegadores dos usu√°rios.  Este servi√ßo ir√° gerar a maior parte do c√≥digo HTML para todos os produtos Airbnb.  O mecanismo de renderiza√ß√£o em quest√£o difere da maioria dos servi√ßos de back-end usados ‚Äã‚Äãpela empresa devido ao fato de n√£o estar escrito em Ruby ou Java.  No entanto, difere dos servi√ßos Node.j tradicionais altamente carregados, em torno dos quais os modelos mentais e as ferramentas auxiliares usadas no Airbnb s√£o constru√≠dos. <br><br> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><img src="https://habrastorage.org/webt/rg/zm/64/rgzm64dbdvumj6ycekqpoxbqxhw.png"></a> <br><a name="habracut"></a><br>
<h2>  <font color="#3AC1EF">Plataforma Node.js</font> </h2><br>  Pensando na plataforma Node.js., voc√™ pode imaginar como um determinado aplicativo, constru√≠do levando em conta os recursos dessa plataforma para processamento de dados ass√≠ncrono, serve de maneira r√°pida e eficiente centenas ou milhares de conex√µes paralelas.  O servi√ßo extrai os dados necess√°rios de qualquer lugar e os processa um pouco para atender √†s necessidades de um grande n√∫mero de clientes.  O propriet√°rio de tal aplicativo n√£o tem motivos para reclamar, est√° confiante no modelo leve de processamento simult√¢neo de dados usado por ele (neste material, usamos a palavra "simult√¢neo" para transmitir o termo "simult√¢neo", para o termo "paralelo" - "paralelo").  Ela resolve perfeitamente a tarefa definida para ela. <br><br>  A renderiza√ß√£o do lado do servidor (SSR) altera as id√©ias b√°sicas que levam a uma vis√£o semelhante do problema.  Portanto, a renderiza√ß√£o do servidor requer muitos recursos de computa√ß√£o.  O c√≥digo no ambiente Node.js √© executado em um √∫nico encadeamento, como resultado, para resolver problemas computacionais (diferente das tarefas de E / S), o c√≥digo pode ser executado simultaneamente, mas n√£o em paralelo.  A plataforma Node.js. √© capaz de lidar com um grande n√∫mero de opera√ß√µes de E / S paralelas; no entanto, quando se trata de computa√ß√£o, a situa√ß√£o muda. <br><br>  Como ao aplicar a renderiza√ß√£o do lado do servidor, a parte computacional da tarefa de processamento de solicita√ß√µes aumenta em compara√ß√£o com a parte relacionada √† entrada / sa√≠da, as solicita√ß√µes recebidas simultaneamente afetam a velocidade de resposta do servidor devido ao fato de competirem pelos recursos do processador.  Deve-se notar que, ao usar a renderiza√ß√£o ass√≠ncrona, a competi√ß√£o por recursos ainda est√° presente.  A renderiza√ß√£o ass√≠ncrona resolve a capacidade de resposta de um processo ou navegador, mas n√£o melhora a situa√ß√£o com atrasos ou simultaneidade.  Neste artigo, focaremos em um modelo simples que inclui exclusivamente cargas computacionais.  Se falarmos sobre uma carga mista, que inclui opera√ß√µes de entrada / sa√≠da e c√°lculo, as solicita√ß√µes recebidas simultaneamente aumentar√£o o atraso, mas levando em considera√ß√£o a vantagem de uma maior taxa de transfer√™ncia do sistema. <br><br>  Considere um comando no formato <code>Promise.all([fn1, fn2])</code> .  Se <code>fn1</code> ou <code>fn2</code> forem promessas resolvidas pelo subsistema de E / S, durante a execu√ß√£o deste comando, √© poss√≠vel obter a execu√ß√£o paralela de opera√ß√µes.  √â assim: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/96e/6f8/d81/96e6f8d8187475775542576cabbc51ca.png"></div><br>  <i><font color="#999999">Execu√ß√£o paralela de opera√ß√µes por meio do subsistema de entrada / sa√≠da</font></i> <br><br>  Se <code>fn1</code> e <code>fn2</code> forem tarefas computacionais, elas ser√£o executadas da seguinte maneira: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/8e8/03d/803/8e803d80347cb302f3e86af0bbcd1e84.png"></div><br>  <i><font color="#999999">Tarefas de computa√ß√£o</font></i> <br><br>  Uma das opera√ß√µes precisar√° aguardar a conclus√£o da segunda opera√ß√£o, pois h√° apenas um encadeamento no Node.js. <br><br>  No caso de renderiza√ß√£o do servidor, esse problema ocorre quando o processo do servidor precisa processar v√°rias solicita√ß√µes simult√¢neas.  O processamento de tais solicita√ß√µes ser√° adiado at√© que as solicita√ß√µes recebidas anteriormente sejam processadas.  Aqui est√° como fica. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/135/03e/54f/13503e54f4aa44cd1481c0848e7406c7.png"></div><br>  <i><font color="#999999">Processando solicita√ß√µes simult√¢neas</font></i> <br><br>  Na pr√°tica, o processamento de solicita√ß√µes geralmente consiste em muitas fases ass√≠ncronas, mesmo que envolvam uma carga computacional s√©ria no sistema.  Isso pode levar a uma situa√ß√£o ainda mais dif√≠cil com a altern√¢ncia de tarefas para processar essas solicita√ß√µes. <br><br>  Suponha que nossas consultas sejam compostas de uma cadeia de tarefas semelhante a essa: <code>renderPromise().then(out =&gt; formatResponsePromise(out)).then(body =&gt; res.send(body))</code> .  Quando um par de solicita√ß√µes chega ao sistema, com um pequeno intervalo entre elas, podemos observar a figura a seguir. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/958/ecf/070/958ecf0704405b06a60e230631ac7730.png"></div><br>  <i><font color="#999999">Processando solicita√ß√µes que chegam em um pequeno intervalo, o problema da luta por recursos do processador</font></i> <br><br>  Nesse caso, leva cerca de duas vezes mais tempo para processar cada solicita√ß√£o do que para processar uma solicita√ß√£o individual.  Com um aumento no n√∫mero de solicita√ß√µes processadas simultaneamente, a situa√ß√£o se torna ainda pior. <br><br>  Al√©m disso, um dos objetivos t√≠picos da implementa√ß√£o do SSR √© a capacidade de usar o mesmo c√≥digo ou um c√≥digo muito semelhante no cliente e no servidor.  A grande diferen√ßa entre esses ambientes √© que o ambiente do cliente √© essencialmente um ambiente no qual um cliente opera e os ambientes do servidor, por natureza, s√£o ambientes com v√°rios clientes.  O que funciona bem no cliente, como singletones ou outras abordagens para armazenar o estado global do aplicativo, leva a erros, vazamentos de dados e, em geral, confus√£o, ao processar muitas solicita√ß√µes que chegam ao servidor. <br><br>  Esses recursos se tornam problemas em uma situa√ß√£o em que voc√™ precisa processar v√°rias solicita√ß√µes ao mesmo tempo.  Tudo normalmente funciona normalmente com cargas mais baixas em um ambiente aconchegante do ambiente de desenvolvimento, que √© usado por um cliente na pessoa de um programador. <br><br>  Isso leva a uma situa√ß√£o muito diferente dos exemplos cl√°ssicos de aplicativos Node.js.  Deve-se observar que usamos o tempo de execu√ß√£o JavaScript para o rico conjunto de bibliotecas dispon√≠veis, e devido ao fato de ser suportado por navegadores, e n√£o pelo modelo de processamento simult√¢neo de dados.  Nesta aplica√ß√£o, o modelo ass√≠ncrono de processamento simult√¢neo de dados demonstra todas as suas desvantagens, n√£o compensadas pelas vantagens, que s√£o muito poucas ou n√£o s√£o de todo. <br><br><h2>  <font color="#3AC1EF">Tutoriais do projeto Hypernova</font> </h2><br>  Nosso novo servi√ßo de renderiza√ß√£o, Hyperloop, ser√° o principal servi√ßo com o qual os usu√°rios do Airbnb ir√£o interagir.  Como resultado, sua confiabilidade e desempenho desempenham um papel crucial para garantir a conveni√™ncia de trabalhar com um recurso.  Ao introduzir o Hyperloop na produ√ß√£o, levamos em conta a experi√™ncia que adquirimos ao trabalhar com nosso sistema anterior de renderiza√ß√£o de servidores - o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Hypernova</a> . <br><br>  O Hypernova n√£o funciona como nosso novo servi√ßo.  Este √© um sistema de renderiza√ß√£o puro.  Ele √© chamado a partir de nosso servi√ßo monol√≠tico de Trilho, chamado Monotrilho, e retorna apenas trechos HTML para componentes renderizados espec√≠ficos.  Em muitos casos, esse "trecho" representa a maior parte da p√°gina, e o Rails fornece apenas o layout da p√°gina.  Com a tecnologia herdada, partes de uma p√°gina podem ser vinculadas usando o ERB.  Em qualquer caso, no entanto, o Hypernova n√£o carrega nenhum dado necess√°rio para formar a p√°gina.  Essa √© a tarefa do Rails. <br><br>  Assim, Hyperloop e Hypernova t√™m desempenho computacional semelhante.  Ao mesmo tempo, o Hypernova, como um servi√ßo de produ√ß√£o e processando volumes significativos de tr√°fego, fornece um bom campo para testes, levando a uma compreens√£o de como a substitui√ß√£o do Hypernova se comportar√° em condi√ß√µes de combate. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/cee/51a/2f7/cee51a2f7e198d242ce8e5294f4e972f.png"></div><br>  <i><font color="#999999">Fluxo de trabalho do Hypernova</font></i> <br><br>  Veja como o Hypernova funciona.  As solicita√ß√µes dos usu√°rios chegam ao nosso aplicativo principal do Rails, o Monorail, que coleta as propriedades dos componentes do React que precisam ser exibidas em uma p√°gina e faz uma solicita√ß√£o ao Hypernova, passando essas propriedades e nomes de componentes.  O Hypernova renderiza componentes com propriedades para gerar o c√≥digo HTML que precisa ser retornado ao aplicativo Monorail, que incorpora esse c√≥digo no modelo da p√°gina e envia tudo de volta ao cliente. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/86d/d7d/35b/86dd7d35b582f66de058a0aa60f5ad0a.png"></div><br>  <i><font color="#999999">Enviando uma p√°gina finalizada para um cliente</font></i> <br><br>  No caso de uma emerg√™ncia (isso pode ser um erro ou o tempo limite da resposta) no Hypernova, existe uma op√ß√£o de fallback, ao usar quais componentes e suas propriedades s√£o incorporados na p√°gina sem o HTML gerado no servidor, ap√≥s o qual tudo isso √© enviado ao cliente e renderizado l√° esperan√ßosamente bem sucedido.  Isso nos levou ao fato de n√£o considerarmos o servi√ßo Hypernova uma parte cr√≠tica do sistema.  Como resultado, poder√≠amos permitir a ocorr√™ncia de um certo n√∫mero de falhas e situa√ß√µes nas quais um tempo limite √© acionado.  Ajustando os tempos limite da solicita√ß√£o, n√≥s, com base nas observa√ß√µes, os definimos para aproximadamente o n√≠vel P95.  Como resultado, n√£o √© de surpreender que o sistema funcione com uma taxa de resposta de tempo limite inferior a 5%. <br><br>  Em situa√ß√µes em que o tr√°fego atingiu valores m√°ximos, pudemos ver que at√© 40% das solicita√ß√µes ao Hypernova foram encerradas por tempos limite no monotrilho.  No lado do Hypernova, vimos picos de <code>BadRequestError: Request aborted</code> altura inferior.  Al√©m disso, esses erros existiam em condi√ß√µes normais, enquanto em opera√ß√£o normal, devido √† arquitetura da solu√ß√£o, os erros restantes n√£o eram particularmente percept√≠veis. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/746/8c1/192/7468c11924fcf883eb3a6e73c734a263.png"></div><br>  <i><font color="#999999">Valores de tempo limite de pico (linhas vermelhas)</font></i> <br><br>  Como nosso sistema funcionava sem o Hypernova, n√£o prestamos muita aten√ß√£o a esses recursos, eles foram percebidos mais como insignificantes, do que como problemas s√©rios.  Explicamos esses problemas pelos recursos da plataforma, porque o lan√ßamento do aplicativo √© lento devido √† dif√≠cil opera√ß√£o inicial de coleta de lixo, devido √†s peculiaridades da compila√ß√£o de c√≥digo e do cache de dados, e por outros motivos.  Esper√°vamos que os novos lan√ßamentos React ou Node inclu√≠ssem melhorias de desempenho que mitigassem as defici√™ncias do lento lan√ßamento do servi√ßo. <br><br>  Suspeitei que o que estava acontecendo fosse muito provavelmente o resultado de um balanceamento de carga insuficiente ou a consequ√™ncia de problemas na implanta√ß√£o da solu√ß√£o, quando atrasos crescentes foram manifestados devido √† carga computacional excessiva nos processos.  Adicionei uma camada auxiliar ao sistema para registrar informa√ß√µes sobre o n√∫mero de solicita√ß√µes processadas simultaneamente por processos individuais, bem como para registrar casos nos quais o processo recebeu mais de uma solicita√ß√£o de processamento. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/ce1/5c2/70c/ce15c270c4ccdcd301f40fad7312e769.png"></div><br>  <i><font color="#999999">Resultados da pesquisa</font></i> <br><br>  Consideramos o in√≠cio lento do servi√ßo o culpado dos atrasos, mas, na verdade, o problema foi causado por solicita√ß√µes paralelas que lutavam pelo tempo da CPU.  De acordo com os resultados da medi√ß√£o, verificou-se que o tempo gasto pela solicita√ß√£o antes da conclus√£o do processamento de outras solicita√ß√µes corresponde ao tempo gasto no processamento da solicita√ß√£o.  Al√©m disso, isso significava que um aumento nos atrasos devido ao processamento simult√¢neo de solicita√ß√µes parece o mesmo que um aumento nos atrasos devido a um aumento na complexidade computacional do c√≥digo, o que leva a um aumento na carga do sistema ao processar cada solicita√ß√£o. <br><br>  Al√©m disso, isso tornou mais √≥bvio que o <code>BadRequestError: Request aborted</code> n√£o p√¥de ser explicado com seguran√ßa por uma inicializa√ß√£o lenta do sistema.  O erro procedeu do c√≥digo de an√°lise do corpo da solicita√ß√£o e ocorreu quando o cliente cancelou a solicita√ß√£o antes que o servidor pudesse ler completamente o corpo da solicita√ß√£o.  O cliente parou de funcionar, fechou a conex√£o, privando-nos dos dados necess√°rios para continuar processando a solicita√ß√£o.  √â muito mais prov√°vel que isso tenha acontecido porque come√ßamos a processar a solicita√ß√£o, depois que o loop de eventos acabou sendo uma renderiza√ß√£o bloqueada para outra solicita√ß√£o e, em seguida, retornamos √† tarefa interrompida para conclu√≠-la, mas, como resultado, verificou-se que o cliente quem nos enviou esta solicita√ß√£o j√° desconectou, abortando a solicita√ß√£o.  Al√©m disso, os dados transmitidos nos pedidos √† Hypernova eram bastante volumosos, em m√©dia, na regi√£o de v√°rias centenas de kilobytes, e isso, √© claro, n√£o contribuiu para melhorar a situa√ß√£o. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/0b4/b62/bc6/0b4b62bc6a1b5e902413711b0d3272e0.png"></div><br>  <i><font color="#999999">Erro causado pela desconex√£o de um cliente que n√£o esperou por uma resposta</font></i> <br><br>  Decidimos lidar com esse problema usando algumas ferramentas padr√£o com as quais possu√≠mos uma experi√™ncia consider√°vel.  Estamos falando de um servidor proxy reverso ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">nginx</a> ) e um balanceador de carga ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">HAProxy</a> ). <br><br><h2>  <font color="#3AC1EF">Proxy reverso e balanceamento de carga</font> </h2><br>  Para tirar proveito da arquitetura do processador de v√°rios n√∫cleos, executamos v√°rios processos Hypernova usando o m√≥dulo de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">cluster</a> Node.js.  Como esses processos s√£o independentes, podemos processar simultaneamente as solicita√ß√µes recebidas. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/9df/cbe/aae/9dfcbeaae2d82fa13007670288d8b461.png"></div><br>  <i><font color="#999999">Processamento paralelo de solicita√ß√µes que chegam simultaneamente</font></i> <br><br>  O problema aqui √© que cada processo do N√≥ fica completamente ocupado o tempo necess√°rio para processar uma solicita√ß√£o, incluindo a leitura do corpo da solicita√ß√£o enviada pelo cliente (o monotrilho desempenha seu papel nesse caso).  Embora possamos ler muitas consultas em um √∫nico processo ao mesmo tempo, quando se trata de renderiza√ß√£o, isso leva a uma altern√¢ncia de opera√ß√µes computacionais. <br><br>  O uso dos recursos do processo do N√≥ est√° vinculado √† velocidade do cliente e da rede. <br><br>  Como solu√ß√£o para esse problema, podemos considerar um servidor proxy reverso em buffer, que nos permitir√° manter sess√µes de comunica√ß√£o com os clientes.  A inspira√ß√£o para essa id√©ia foi o servidor da web unicorn, que usamos para nossos aplicativos Rails.  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Os princ√≠pios</a> declarados pelo unic√≥rnio explicam perfeitamente por que isso acontece.  Para esse fim, usamos o nginx.  O Nginx l√™ a solicita√ß√£o do cliente no buffer e transmite a solicita√ß√£o ao servidor Node somente ap√≥s sua leitura completa.  Essa sess√£o de transfer√™ncia de dados √© realizada na m√°quina local, atrav√©s da interface de loopback ou usando soquetes de dom√≠nio Unix, e isso √© muito mais r√°pido e confi√°vel do que a transfer√™ncia de dados entre computadores separados. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/a20/50e/77b/a2050e77b5ff48219773729978481244.png"></div><br>  <i><font color="#999999">O Nginx armazena em buffer as solicita√ß√µes e as envia para o servidor Node</font></i> <br><br>  Devido ao fato de o nginx agora estar envolvido em solicita√ß√µes de leitura, conseguimos obter um carregamento mais uniforme dos processos do N√≥. <br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/bea/eb0/875/beaeb08758e4926cb3072670993f606f.png"></div><br>  <i><font color="#999999">Carregamento uniforme de processo usando nginx</font></i> <br><br>  Al√©m disso, usamos o nginx para manipular algumas solicita√ß√µes que n√£o requerem acesso aos processos do N√≥.  A camada de detec√ß√£o e roteamento de nosso servi√ßo usa solicita√ß√µes <code>/ping</code> que n√£o criam uma grande carga no sistema para verificar a comunica√ß√£o entre hosts.  O processamento de tudo isso no nginx elimina uma fonte significativa de carga de trabalho adicional (embora pequena) para o Node.js. <br><br>  A pr√≥xima melhoria diz respeito ao balanceamento de carga.  Precisamos tomar decis√µes informadas sobre a distribui√ß√£o de solicita√ß√µes entre os processos do N√≥.  O m√≥dulo de <code>cluster</code> distribui solicita√ß√µes de acordo com o algoritmo round-robin, na maioria dos casos com tentativas de ignorar processos que n√£o respondem a solicita√ß√µes.  Com essa abordagem, cada processo recebe uma solicita√ß√£o em ordem de prioridade. <br><br>  O m√≥dulo de <code>cluster</code> distribui conex√µes, n√£o solicita√ß√µes, para que tudo isso n√£o funcione conforme necess√°rio.  A situa√ß√£o fica ainda pior quando s√£o usadas conex√µes persistentes.  Qualquer conex√£o permanente do cliente est√° vinculada a um √∫nico fluxo de trabalho espec√≠fico, o que complica a distribui√ß√£o eficiente de tarefas. <br><br>  O algoritmo round-robin √© bom quando h√° baixa variabilidade nos atrasos nas solicita√ß√µes.  Por exemplo, na situa√ß√£o ilustrada abaixo. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/883/4f2/ed5/8834f2ed56f7410de5f306f15e66e5e9.png"></div><br>  <i><font color="#999999">Algoritmo round-robin e conex√µes atrav√©s das quais as solicita√ß√µes s√£o recebidas de forma est√°vel</font></i> <br><br>  Esse algoritmo j√° n√£o √© t√£o bom quando voc√™ precisa processar solicita√ß√µes de tipos diferentes, para o processamento do qual custos de tempo completamente diferentes podem ser necess√°rios.  A solicita√ß√£o mais recente enviada para um determinado processo √© for√ßada a aguardar a conclus√£o do processamento de todas as solicita√ß√µes enviadas anteriormente, mesmo se houver outro processo com a capacidade de processar essa solicita√ß√£o. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/037/381/8c8/0373818c8632668b96f2ae77c32c9be2.png"></div><br>  <i><font color="#999999">Carga de processo desigual</font></i> <br><br>  Se voc√™ distribuir as consultas mostradas acima de maneira mais racional, obter√° algo como o mostrado na figura abaixo. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/944/8a3/b32/9448a3b328094d81d73480e6b0e9d6d6.png"></div><br>  <i><font color="#999999">Distribui√ß√£o racional de pedidos por encadeamentos</font></i> <br><br>  Com essa abordagem, a espera √© minimizada e torna-se poss√≠vel enviar respostas √†s solicita√ß√µes mais rapidamente. <br><br>  Isso pode ser conseguido colocando solicita√ß√µes em uma fila e atribuindo-as a um processo apenas quando n√£o estiver ocupado processando outra solicita√ß√£o.  Para esse fim, usamos o HAProxy. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/fda/2cc/367/fda2cc367f401ef351cad7bff55a13ea.png"></div><br>  <i><font color="#999999">HAProxy e balanceamento de carga de processo</font></i> <br><br>  Quando usamos o HAProxy para equilibrar a carga no Hypernova, eliminamos completamente os picos de tempo limite, bem como os erros <code>BadRequestErrors</code> . <br><br>  Solicita√ß√µes simult√¢neas tamb√©m foram a principal causa de atrasos durante a opera√ß√£o normal; essa abordagem reduziu esses atrasos.  Uma das conseq√º√™ncias disso foi que agora apenas 2% das solicita√ß√µes foram encerradas por tempo limite, e n√£o 5%, com as mesmas configura√ß√µes de tempo limite.  O fato de termos conseguido passar de uma situa√ß√£o com erros de 40% para uma situa√ß√£o com um tempo limite acionado em 2% dos casos mostrou que estamos caminhando na dire√ß√£o certa.  Como resultado, hoje nossos usu√°rios veem a tela de carregamento do site com muito menos frequ√™ncia.  Deve-se notar que a estabilidade do sistema ser√° de particular import√¢ncia para n√≥s com a transi√ß√£o esperada para um novo sistema que n√£o possui o mesmo mecanismo de backup que o Hypernova. <br><br><h2>  <font color="#3AC1EF">Detalhes sobre o sistema e suas configura√ß√µes</font> </h2><br>  Para que tudo isso funcione, voc√™ precisa configurar os aplicativos nginx, HAProxy e Node.  Aqui est√° <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">um exemplo de</a> aplicativo semelhante usando nginx e HAProxy, analisando quais voc√™ pode entender o dispositivo do sistema em quest√£o.  Este exemplo √© baseado no sistema que usamos na produ√ß√£o, mas √© simplificado e modificado para que possa ser executado em primeiro plano em nome de um usu√°rio n√£o privilegiado.  Na produ√ß√£o, tudo deve ser configurado usando algum tipo de supervisor (usamos runit ou, mais frequentemente, kubernetes). <br><br>  <a href="">A configura√ß√£o do nginx √©</a> bastante padr√£o, ela usa um servidor que escuta na porta 9000, configurado para solicita√ß√µes de proxy para o servidor HAProxy, que escuta na porta 9001 (em nossa configura√ß√£o, usamos soquetes de dom√≠nio Unix). <br><br>  Al√©m disso, este servidor intercepta solicita√ß√µes ao terminal <code>/ping</code> para atender diretamente √†s solicita√ß√µes destinadas a verificar a conectividade da rede.         nginx ,     <code>worker_processes</code>  1,     nginx ‚Äî           HAProxy  Node-.  ,       ,    ,  Hypernova,     ( ).             . <br><br>  Node.js <code>cluster</code>        .        HAProxy,        <code>cluster</code> ,    .        <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">pool-hall</a> .  ‚Äî ,        ,   ,   <code>cluster</code> ,        .  <a href=""></a>   <code>pool-hall</code>     ,      . <br><br>  <a href=""> HAProxy</a> ,     9001       ,    9002  9005.     ‚Äî <code>maxconn 1</code> ,     .          .       HAProxy (    8999). <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/232/d95/515/232d95515b1541bccfab440f8fe12cc8.png"></div><br> <i><font color="#999999">  HAProxy</font></i> <br><br> HAProxy            .    ,    <code>maxconn</code> .    <code>static-rr</code> (static round-robin),  ,  ,       .   ,      round-robin, ,        , ,   ,     .     ,          ,   .      . <br><br> ,       ,        .       (   ).         ,   ,     ,   ,     .  ,                   ,        . <br><br><h2> <font color="#3AC1EF">  HAProxy</font> </h2><br>         HAProxy.       ,         ,    ,               .  ,    ,    (  )   .      ,        ,    <code>cluster</code> .     ,    . <br><br>       <code>ab</code> (Apache Benchmark)   10000   .       -   .       : <br><br><pre> <code class="hljs powershell">ab <span class="hljs-literal"><span class="hljs-literal">-l</span></span> <span class="hljs-literal"><span class="hljs-literal">-c</span></span> &lt;CONCURRENCY&gt; <span class="hljs-literal"><span class="hljs-literal">-n</span></span> <span class="hljs-number"><span class="hljs-number">10000</span></span> http://&lt;HOSTNAME&gt;:<span class="hljs-number"><span class="hljs-number">9000</span></span>/render</code> </pre> <br>     15    4-  -,    <code>ab</code>     ,        .       ( <code>concurrency=5</code> ),    ( <code>concurrency=13</code> ),     ,        ( <code>concurrency=20</code> ).      ,      . <br><br>         ,  -,      .          ,      .       ,  ,   ,     ,       .  ,     ,       ,     . <br><br>    ,   ‚Äî      . <br><br>     <code>maxconn 1</code>     ,  ,         . <br><br>      HTTP  TCP  ,    ,     ,  .   ,      <code>maxconn</code> ,       .     ,            ,          (, ,    ). <br><br>  ,         , ,   ,  ,      ,       . <br><br>    ‚Äî  ,     .    <code>option redispatch</code>    <code>retries 3</code> ,    ,          ,   , ,    ,   .            . <br><br>     ,  - ,       .        ,       .   ,          ,     .     100    ,        10 ,    ,    .        ,      .   ,            <code>accept</code> . <br><br>      ,        ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">backlog</a> )    ,    .       SYN-ACK ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="></a> ,   , ,        ACK  ).      ,      ,     ,       ,      . <br><br>      ,   ,    ,   ,       .    ,       ,      1.   <code>maxconn</code>                .     0  ,   ,     ,  ,           ,     .       ,     .         -  ,      ,         .  <code>abortonclose</code>        ,    .  ,        <code>abortonclose</code> .            nginx. <br><br>  ,     ,    .       (    )   ,       ,        ,     ,       ,  .  HAProxy          ,      ,        (       ).               ,     ,         ,    HTML.          ,   ,       .  ,       ,       (     ,  ,     ).            ,   ,            .   ,  ,   ,  .           HAProxy,            MAINT    HAProxy. <br><br>   ,     ,   ,  <code>server.close</code>  Node.js    ,     HAProxy   ,       ,      ,      .     ,     ,       ,     ,   ,     . <br><br>  ,  ,    <code>balance first</code> ,           (   <code>worker1</code> )        15%   ,    ,   ,     <code>balance static-rr</code> .        ,       ¬´¬ª .      .     (12 ),  , , -      .   ,  ,       ,   ¬´¬ª     ¬´¬ª.        . <br><br> , ,      Node <code>server.maxconnections</code> , ( ,   ),   ,  ,   ,         .        ,    <code>maxconnection</code> ,      ,  ,    .     JavaScript,          (        ).  ,    ,        ,          .  ,     ,   ,      HAProxy  Node    ,       .     ,        ,         . <br><br>   ,      ,   , , <a href=""></a> . <br><br><h2> <font color="#3AC1EF"></font> </h2><br>     Node.js      .     , , ,    -.      Node.js    .   , ,       ,    ,   ,        , ,  nginx  HAProxy. <br><br> ,   Airbnb  ,   Node.js     . <br><br>  <b>Caros leitores!</b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Voc√™ usa a renderiza√ß√£o do lado do servidor em seus projetos? </font></font><br><br><div style="text-align:center;"> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><img src="https://habrastorage.org/files/1ba/550/d25/1ba550d25e8846ce8805de564da6aa63.png"></a> </div></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt418009/">https://habr.com/ru/post/pt418009/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt417997/index.html">Comece com voc√™ mesmo ou 60 dias no Kubuntu</a></li>
<li><a href="../pt417999/index.html">Ingl√™s: perspectiva do engenheiro</a></li>
<li><a href="../pt418001/index.html">5 modelos de trabalho em equipe eficaz</a></li>
<li><a href="../pt418005/index.html">Os desenvolvedores de software n√£o concordam com a defini√ß√£o de "hardware especial" do FSB</a></li>
<li><a href="../pt418007/index.html">Desenvolvimento de plataforma cruzada com .NET, programa√ß√£o reativa, padr√£o MVVM e gera√ß√£o de c√≥digo</a></li>
<li><a href="../pt418011/index.html">P√°ginas individuais e SEO. Segredos de otimiza√ß√£o</a></li>
<li><a href="../pt418013/index.html">O Intel Core i7-8086K (parte 3)</a></li>
<li><a href="../pt418015/index.html">Novo Vasyuki. Desenvolvimento inovador de Moscou at√© 2100</a></li>
<li><a href="../pt418017/index.html">An√°lise do comportamento do Trojan Pegasus na rede</a></li>
<li><a href="../pt418023/index.html">Ponteiros em C s√£o mais abstratos do que voc√™ imagina</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>