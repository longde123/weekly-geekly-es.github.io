<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ü•ï üëàüèø üçÉ Op√©ration TA505, quatri√®me partie. Des jumeaux ‚úãüèæ üì∂ ü§≥üèæ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Nous continuons √† parler des activit√©s du groupe de hackers TA505. L'expression bien connue ¬´le nouveau est l'ancien bien oubli√©¬ª est la plus adapt√©e ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Op√©ration TA505, quatri√®me partie. Des jumeaux</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/pt/blog/475328/"> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><img src="https://habrastorage.org/webt/79/gv/mv/79gvmv2kznpjzybycyw7scp5zus.jpeg"></a> <br><br>  Nous continuons √† parler des activit√©s du groupe de hackers TA505.  L'expression bien connue ¬´le nouveau est l'ancien bien oubli√©¬ª est la plus adapt√©e comme √©pigraphe au chapitre suivant de l'histoire du groupe TA505.  Certes, cette fois ¬´l'ancien¬ª n'est pas tant ¬´oubli√©¬ª qu'il est retravaill√© et am√©lior√©. <br><br>  D√©but septembre, nous avons d√©couvert plusieurs t√©l√©chargeurs malveillants fournis avec le packer PE sp√©cial du groupe dont nous avons <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">parl√© plus t√¥t</a> .  √Ä premi√®re vue, ils ressemblaient aux stagers de porte d√©rob√©e FlawedAmmyy bien connus.  Mais une analyse plus approfondie a montr√© que ce n'est pas le cas.  Les techniques d'√©criture de code les plus avanc√©es ne nous ont pas conduits √† des charges utiles radicalement oppos√©es en termes de qualit√© d'ex√©cution. <br><br>  Dans cet article, nous allons examiner de plus pr√®s les outils trouv√©s et √©tablir des parall√®les avec ce qui est d√©j√† connu. <a name="habracut"></a><br><br><h2>  Bootloader twein </h2><br>  Tout d'abord, ce qui est curieux: de tous les √©chantillons de bootloader que nous avons r√©ussi √† collecter, un seul a une signature num√©rique: <br><br><img src="https://habrastorage.org/webt/im/iu/-a/imiu-af4otgk3nhalsj7mhe3hwy.jpeg"><br><br>  <i>Fig.</i>  <i>1. Signature num√©rique du chargeur de d√©marrage</i> <br><br>  Certificat d√©livr√© au nom de PEAR SOLUTIONS LTD.  Soit dit en passant, ce n'est pas la premi√®re fois qu'un groupe signe ses outils, les faisant passer pour des logiciels l√©gitimes d'organisations fictives.  Voici quelques autres noms qui ont utilis√© le TA505 pour d'autres familles de logiciels malveillants: <br><br><ul><li>  ET HOMES LTD, </li><li>  FIT AND FLEX LIMITED, </li><li>  MISHA LONDON LTD, </li><li>  SATOJI KAIDA MB, </li><li>  TR√àS T√âL√â LIMIT√â. </li></ul><br>  √âtant donn√© que les chargeurs de d√©marrage d√©tect√©s ne diff√®rent pas entre eux, nous s√©lectionnons celui sign√© ci-dessus et nous y attardons plus en d√©tail. <br><br>  Tout au long du travail des logiciels malveillants, presque chaque action est accompagn√©e d'une √©criture dans le fichier journal et d'une sortie de d√©bogage de tout ce qui se passe: <br><br><img src="https://habrastorage.org/webt/dm/7f/1j/dm7f1jjwkhlfkj8k987uvp8ixjw.jpeg"><br><br>  <i>Fig.</i>  <i>2. D√©boguer la sortie et la journalisation</i> <br><br>  Un tel tra√ßage simplifie non seulement l'analyse statique du fichier, mais aide √©galement √† d√©couvrir ce qui ne va pas dans les syst√®mes d'analyse dynamique: <br><br><img src="https://habrastorage.org/webt/d4/g1/kg/d4g1kgeiovdgo-ecz3ytg5ki26c.jpeg"><br><br>  <i>Fig.</i>  <i>3. D√©boguer la sortie dans l'analyseur en ligne ANY.RUN</i> <br><br>  Troyan v√©rifie la disposition de la langue du clavier - et ne fonctionne pas en Russie et dans les pays voisins: <br><br><img src="https://habrastorage.org/webt/bz/hr/my/bzhrmynjo9dlc50xi_nucjdpuf4.jpeg"><br><br>  <i>Fig.</i>  <i>4. V√©rification de la disposition des langues du clavier</i> <br>  Il cr√©e ensuite le mutex <code>Global\system32_mutant_service</code> et v√©rifie la disponibilit√© Internet √† l'aide d'une demande HTTP GET √† google.com.  Apr√®s cela, il d√©termine la mani√®re d'acc√©der au r√©seau (adresse d√©di√©e ou <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">NAT</a> ) en d√©terminant l'adresse IP externe par les services myexternalip.com, ipecho.net et ifconfig.me et en comparant la valeur obtenue avec celles sp√©cifi√©es dans les param√®tres r√©seau du syst√®me: <br><br><img src="https://habrastorage.org/webt/ld/80/7w/ld807wry4cgdc1qzj3mwjogabf8.jpeg"><br><br>  <i>Fig.</i>  <i>5. Comparaison des adresses IP internes et externes</i> <br><br>  Ensuite, le malware d√©termine la version de la biblioth√®que <code>%SystemRoot%\system32\crypt32.dll</code> et, si le num√©ro de version et le num√©ro de r√©vision sont respectivement inf√©rieurs √† <code>7601</code> et <code>18741</code> , t√©l√©charge et installe la mise √† jour <code>KB3033929</code> fonction de la version du syst√®me d'exploitation: <br><br><img src="https://habrastorage.org/webt/su/zu/ig/suzuighncp_psgtfbtnbvcdbb1y.jpeg"><br><br>  <i>Fig.</i>  <i>6. T√©l√©chargez et installez les mises √† jour du syst√®me</i> <br><br>  Les attaquants TA505 prennent soin de la victime et corrigent le syst√®me au besoin?  Pas du tout.  L'installation de la mise √† jour est associ√©e √† la fin de la prise en charge des certificats de s√©curit√© de code sign√©s √† l'aide de SHA-1 et √† son abandon au profit de l'algorithme SHA-2.  Tr√®s probablement, les pirates ont d√©j√† eu du mal √† ex√©cuter des charges utiles sign√©es sur des syst√®mes non mis √† jour.  Fait int√©ressant, apr√®s avoir install√© la mise √† jour, le cheval de Troie envoie le journal des actions g√©n√©r√© au serveur de gestion, arr√™te son travail et se supprime lui-m√™me, effa√ßant les traces restantes. <br><br><img src="https://habrastorage.org/webt/k6/jk/-y/k6jk-yijoanmpjtwath42fioh10.jpeg"><br><br>  <i>Fig.</i>  <i>7. Arr√™t apr√®s l'installation d'une mise √† jour du syst√®me</i> <br><br>  Si l'installation de la mise √† jour n'est pas requise, le chargeur de d√©marrage collecte et envoie les informations suivantes au serveur de gestion: <br><br><ul><li>  informations syst√®me </li><li>  des informations sur les logiciels install√©s, </li><li>  des informations sur les logiciels sign√©s dans les r√©pertoires% ProgramFiles% et% ProgramFiles (x86)% (le cas √©ch√©ant), </li><li>  Informations sur les pilotes sign√©s dans le r√©pertoire% SystemRoot% \ drivers. </li></ul><br>  Notez qu'un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">code l√©gitime a</a> √©t√© utilis√© pour obtenir des informations sur les signatures. <br><br><img src="https://habrastorage.org/webt/z4/1o/p_/z41op_q3q8pzlli3zlapjreaxd0.jpeg"><br><br>  <i>Fig.</i>  <i>8. Obtention des informations de certificat</i> <br><br>  Apr√®s cela, le chargeur de d√©marrage cr√©e le r√©pertoire <code>C:\Windows\Logs\diag</code> et d√©marre un thread dans lequel il suit les modifications dans le r√©pertoire, en envoyant des notifications au serveur de gestion: <br><br><img src="https://habrastorage.org/webt/ra/rh/-g/rarh-gd4x8yafwiipdft7r9duiq.jpeg"><br><br>  <i>Fig.</i>  <i>9. Surveillance des changements de r√©pertoire</i> <br><br>  Ensuite, il pr√©pare les informations existantes et manquantes sur le syst√®me (nom d'utilisateur, version du syst√®me, domaine, adresse IP, informations sur la carte vid√©o, connexion r√©seau - NAT ou non NAT) et g√©n√®re un fichier JSON de ce type: <br><br><pre> <code class="json hljs">{ <span class="hljs-attr"><span class="hljs-attr">"adm"</span></span>: <span class="hljs-string"><span class="hljs-string">"0"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"bid"</span></span>: <span class="hljs-string"><span class="hljs-string">"M3xwwhqLH/AUOhmU2+W55A=="</span></span>, <span class="hljs-attr"><span class="hljs-attr">"bit"</span></span>: <span class="hljs-string"><span class="hljs-string">"1"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"bnet"</span></span>: <span class="hljs-string"><span class="hljs-string">"ldr"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"cam"</span></span>: <span class="hljs-string"><span class="hljs-string">"0"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"cis"</span></span>: <span class="hljs-string"><span class="hljs-string">"0"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"dmn"</span></span>: <span class="hljs-string"><span class="hljs-string">"WORKGROUP"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"hash_r"</span></span>: <span class="hljs-string"><span class="hljs-string">"0"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"lip"</span></span>: <span class="hljs-string"><span class="hljs-string">"192.168.100.153"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"lvl"</span></span>: <span class="hljs-string"><span class="hljs-string">"0"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"nat"</span></span>: <span class="hljs-string"><span class="hljs-string">"1"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"osb"</span></span>: <span class="hljs-string"><span class="hljs-string">"0"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"osv"</span></span>: <span class="hljs-string"><span class="hljs-string">"Windows 7 Professional"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"pc"</span></span>: <span class="hljs-string"><span class="hljs-string">"USER-PC"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"proc_c"</span></span>: <span class="hljs-string"><span class="hljs-string">"0"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"proc_n"</span></span>: <span class="hljs-string"><span class="hljs-string">"cpu"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"rep"</span></span>: <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-attr"><span class="hljs-attr">"tmt"</span></span>: <span class="hljs-string"><span class="hljs-string">"0"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"ver"</span></span>: <span class="hljs-string"><span class="hljs-string">"163"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"video"</span></span>: <span class="hljs-string"><span class="hljs-string">"Standard VGA Graphics Adapter,"</span></span> }</code> </pre> <br>  Plus tard, ces donn√©es seront chiffr√©es avec RC4 (la <code>gJypA9RWUlYpnBbzujVqE6fDcEAk0zoz</code> chiffrement <code>gJypA9RWUlYpnBbzujVqE6fDcEAk0zoz</code> est chiffr√©e dans le corps du cheval de Troie), encod√©e avec Base64 et envoy√©e par une requ√™te HTTP POST au serveur de gestion: <br><br><img src="https://habrastorage.org/webt/wu/4p/x8/wu4px8dxpkvy5mshywjkrskevlm.jpeg"><br><br>  <i>Fig.</i>  <i>10. Demande HTTP POST au serveur de gestion</i> <br><br><img src="https://habrastorage.org/webt/uv/lw/bg/uvlwbgwcx0ejyfndmzdybhtqrsy.jpeg"><br><br>  <i>Fig.</i>  <i>11. La liste des serveurs de contr√¥le dans le chargeur de d√©marrage</i> <br><br>  La r√©ponse du serveur est d√©crypt√©e par RC4 (la cl√© de cryptage est la m√™me que celle utilis√©e pour envoyer les donn√©es) et v√©rifi√©e: les deux premiers octets doivent correspondre √† la ligne MZ, qui est un signe du fichier PE.  Nous avons d√©j√† rencontr√© cette s√©quence plus t√¥t lorsque nous avons analys√© un autre chargeur de groupe qui a livr√© FlawedAmmyy RAT: <br><br><img src="https://habrastorage.org/webt/pb/oe/hi/pboehibfeoivvna7bl6xkumibuo.jpeg"><br><br>  <i>Fig.</i>  <i>12. Un code similaire pour d√©chiffrer et v√©rifier le fichier t√©l√©charg√© pour le chargeur de d√©marrage en question (√† gauche) et le chargeur de d√©marrage FlawedAmmyy RAT (√† droite)</i> <br><br>  Le chargement de la charge utile se produit non seulement dans le thread principal, mais √©galement dans un thread cr√©√© s√©par√©ment.  En d'autres termes, il existe deux charges utiles.  Dans un cas, le mutex Global \ system32_host_service est pr√©-v√©rifi√©, et en cas d'absence, le composant est charg√©, ce qui est d√©sign√© dans les informations de d√©bogage comme charge utile ou bot.  Fait int√©ressant, apr√®s avoir re√ßu une r√©ponse du serveur, le fichier PE ne d√©marre en aucune fa√ßon.  Au lieu de cela, son corps est √©crit dans le Registre dans la section <code>HKEY_LOCAL_MACHINE\SYSTEM</code> dans la cl√© <code>0x228028</code> .  Ensuite, le chargeur de d√©marrage d√©sactive la redirection du syst√®me de fichiers WoW64 pour les applications 32 bits √† l'aide de <code>Wow64DisableWow64FsRedirection</code> et d√©marre le processus <code>%SystemRoot%\System32\services.exe</code> avec le param√®tre -ww.  L'utilisation de ce param√®tre n'a pas de sens, mais cela termine la cha√Æne d'installation de la charge utile r√©sultante. <br><br><img src="https://habrastorage.org/webt/bn/eb/w1/bnebw1pcir-t8io211poejmlzbe.jpeg"><br><br>  <i>Fig.</i>  <i>13. R√©glage de la charge utile</i> <br><br>  Nous parlerons de la deuxi√®me charge utile plus tard. <br><br><h2>  Plugins Twein </h2><br>  En examinant le cheval de Troie discut√© ci-dessus, nous avons remarqu√© une fonction qui supprime deux fichiers du <code>%SystemRoot%</code> - <code>twein_32.dll</code> et <code>twein_64.dll</code> : <br><br><img src="https://habrastorage.org/webt/hk/v2/ht/hkv2ht9lipkhgz-ydz622exxzds.jpeg"><br><br>  <i>Fig.</i>  <i>14. Suppression des fichiers twein_32.dll et twein_64.dll</i> <br><br>  Ces fichiers ne se trouvent nulle part ailleurs, ils n'apparaissent pas dans la logique du chargeur de d√©marrage.  Cependant, les noms des biblioth√®ques nous ont rappel√© un autre groupe de logiciels malveillants, que nous allons maintenant consid√©rer. <br>  Deux mois plus t√¥t, nous avons trouv√© un cheval de Troie du groupe TA505, d'une taille d'environ 9 Mo.  Le fichier est conditionn√© par <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">UPX</a> .  Le cheval de Troie est install√© dans le syst√®me en tant que service <code>WMDICToss</code> .  Les ressources contiennent trois fichiers: <code>systemdiron.bat</code> , <code>twein__32.dll</code> et <code>twein__64.dll</code> , qui sont chiffr√©s avec XOR lin√©aire. <br><br><img src="https://habrastorage.org/webt/tj/op/xh/tjopxhpvsrbmlstkvm2fidukk7w.jpeg"><br><br>  <i>Fig.</i>  <i>15. D√©chiffrement de l'une des ressources du compte-gouttes</i> <br><br>  Notez que les noms des deux fichiers co√Øncident presque avec ceux d√©j√† mentionn√©s pr√©c√©demment: la diff√©rence ne concerne que le nombre de soulignements. <br><br>  L'une des ressources d√©chiffr√©es portant le nom <code>systemdiron.bat</code> devrait √™tre un script de commande qui permet le lancement d'autres composants en fonction de la capacit√© du syst√®me: <br><br><pre> <code class="bash hljs">@<span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> off <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> defined PROCESSOR_ARCHITEW6432 (goto LABEL_X64) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> %PROCESSOR_ARCHITECTURE%==IA64 (goto LABEL_X64) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> %PROCESSOR_ARCHITECTURE%==AMD64 (goto LABEL_X64) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> %PROCESSOR_ARCHITECTURE%==x86 (goto LABEL_X86) goto LABEL_NON :LABEL_X64 <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> OS <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>: x64 copy c:\temp\tmp.log c:\i.txt rundll32.exe C:\Windows\twein__64.dll,Install copy c:\temp\tmp.log c:\i.txt rundll32.exe C:\Windows\twein__32.dll,Install del c:\temp\tmp.log del c:\i.txt shutdown.exe -r -t 00 goto LABEL_END :LABEL_X86 <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> OS <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>: x86 copy c:\temp\tmp.log c:\i.txt rundll32.exe C:\Windows\twein__32.dll,Install del c:\temp\tmp.log del c:\i.txt shutdown.exe -r -t 00 goto LABEL_END :LABEL_NON <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> OS <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>: undefined goto LABEL_END :LABEL_END pause</code> </pre> <br>  Les deux biblioth√®ques twein agissent de mani√®re similaire.  Emball√© avec le packer caract√©ristique du groupe TA505.  Noms de biblioth√®que d'origine: <code>av_block.dll</code> .  L'analyse est consid√©rablement compliqu√©e par l'utilisation d'un obfuscateur, et la proportion de code obscurci est d'environ 80%.  En cons√©quence, l'ex√©cution du programme est satur√©e de nombreuses transitions, d√©codage des prochaines √©tapes de code, appels de fonctions non lin√©aires. <br><br>  Les biblioth√®ques contiennent une liste impressionnante de cha√Ænes de type Base64, qui sont d√©crypt√©es comme suit: <br><br>  1. La cha√Æne d'entr√©e est divis√©e en blocs de 4 octets; <br>  2. Chaque bloc est d√©cod√© en utilisant l'algorithme de remplacement et de d√©calage: <br><br><pre> <code class="bash hljs">import binascii def block_decode(input_str, len_of_block): alphabet = <span class="hljs-string"><span class="hljs-string">'\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x3E\x00\x00\x00\x3F\x34\x35\x36\x37\x38\x39\x3A\x3B\x3C\x3D\x00\x00\x00\x00\x00\x00\x00\x00\x01\x02\x03\x04\x05\x06\x07\x08\x09\x0A\x0B\x0C\x0D\x0E\x0F\x10\x11\x12\x13\x14\x15\x16\x17\x18\x19\x00\x00\x00\x00\x00\x00\x1A\x1B\x1C\x1D\x1E\x1F\x20\x21\x22\x23\x24\x25\x26\x27\x28\x29\x2A\x2B\x2C\x2D\x2E\x2F\x30\x31\x32\x33\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00'</span></span> int_result = 0 <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> i <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> range(len_of_block): alph = ord(alphabet[ord(input_str[i])]) alph &lt;&lt;= 0x6 * i int_result += alph str_result = hex(int_result)[2:] <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> len(str_result) % 2 != 0: str_result = <span class="hljs-string"><span class="hljs-string">'0'</span></span> + str_result <span class="hljs-built_in"><span class="hljs-built_in">return</span></span> binascii.unhexlify(str_result).decode(<span class="hljs-string"><span class="hljs-string">'latin1'</span></span>)[::-1]</code> </pre> <br><br>  3) les blocs sont collect√©s sur une seule ligne; <br>  4) le r√©sultat est d√©crypt√© par l'algorithme <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">eexec</a> avec une cl√© √† deux octets, pass√©e en param√®tre: <br><br><img src="https://habrastorage.org/webt/qs/mj/ah/qsmjah4gzyqwizgrothw1hlbkdc.jpeg"><br><br>  <i>Fig.</i>  <i>16. Impl√©mentation de l'algorithme eexec</i> <br><br>  La plupart des lignes sont les noms et les chemins d'acc√®s aux fichiers des produits antivirus, mais certains d'entre eux n'appartiennent pas du tout aux outils de s√©curit√©: MS Exchange Server, MySQL Server, SAP, Apache, PostgreSQL, Elasticsearch, etc. Il y avait m√™me de tels chemins uniques: <br><br><ul><li>  C: \ Users \ tislam \ Desktop \ salik app \ Aye_salik_data \ Aye_salik_data \ bin \ Debug \ Aye_salik_data.exe </li><li>  C: \ oem13c \ agent13c \ agent_13.2.0.0.0 \ perl \ bin \ perl.exe </li><li>  C: \ Users \ adadmin \ Ubiquiti UniFi \ bin \ mongod.exe </li><li>  C: \ Users \ sakella \ AppData \ Local \ Microsoft \ OneDrive \ OneDrive.exe </li><li>  D: \ Add-ons \ IMI_CREDIT_POLICY Test v 02.01 \ IMI_CREDIT_POLICY.exe </li></ul><br>  Si un logiciel se trouve dans le syst√®me dans la liste, les fichiers et les r√©pertoires sont supprim√©s. <br><br>  Pour se s√©curiser dans le syst√®me, les biblioth√®ques se d√©finissent comme l' <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">interface Windows Sockets</a> Service Provider (SPI), appel√©e Intel et IntelFiltr.  De plus, ils modifient l'ordre des gestionnaires de la cha√Æne de protocole pour √™tre le premier SPI √† g√©rer la demande du client. <br><br>  En 2015, nos coll√®gues FireEye ont pr√©sent√© l' <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">analyse de</a> bots <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">LatentBot</a> .  Il est curieux que l'algorithme de cryptage de cha√Ænes dans LatentBot et les biblioth√®ques de twein examin√©es soient compl√®tement les m√™mes.  En outre, LatentBot utilise un module de s√©curit√© comme l'un des plug-ins, qui recherche des outils de s√©curit√© dans le syst√®me en utilisant les chemins d'acc√®s et les noms de produits sp√©cifi√©s, bien qu'il se limite √† v√©rifier la disponibilit√©. <br><br><h2>  Rootkit twein </h2><br>  Revenons au chargeur de d√©marrage, √† savoir la deuxi√®me charge utile.  √Ä partir des lignes de d√©bogage d'essayer d'ouvrir rootkit ... et du pilote% S install√©, il est facile de deviner le format de la prochaine charge utile.  Une fois le chargement r√©ussi, le pilote sera √©crit dans le <code>%SystemRoot%\System32\drivers</code> avec un nom form√© de mani√®re pseudo-al√©atoire √† partir des noms des autres fichiers l√©gitimes.  Ensuite, le service sera cr√©√© et lanc√©: <br><br><img src="https://habrastorage.org/webt/hw/dp/vi/hwdpvipfgx2-rra5iqecj2o5t8w.jpeg"><br><br>  <i>Fig.</i>  <i>17. Installation et d√©marrage du service</i> <br><br>  √Ä la derni√®re √©tape de son travail, le chargeur de d√©marrage configurera le pilote pour qu'il soit mis sur liste noire dans les cl√©s de registre: les noms des processus antivirus, des outils d'analyse et des fournisseurs de protection dans les signatures de fichiers num√©riques seront entr√©s dans les valeurs num√©riques sp√©cifi√©es des cl√©s de la branche <code>HKEY_LOCAL_MACHINE\SYSTEM</code> : <br><br><img src="https://habrastorage.org/webt/u2/fw/zj/u2fwzjlb_hjgmabjwa4filz9fn4.jpeg"><br><br>  <i>Fig.</i>  <i>18. Configuration du pilote sur liste noire</i> <br><br>  Lors de la recherche du chargeur de d√©marrage, nous n'avons pas pu obtenir un exemple de pilote √† partir du serveur de gestion.  Cependant, nous avons trouv√© la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">mention d'un rootkit</a> qui a √©t√© pomp√© par un autre chargeur de d√©marrage similaire. <br><br>  Le pilote est sign√© num√©riquement au nom de <code>Lizas Limited</code> avec <code>administrator@lizaslimited.site</code> par e-mail: <br><br><img src="https://habrastorage.org/webt/o_/tm/yy/o_tmyyrx3dayywf-jnfkoijecvm.jpeg"><br><br>  <i>Fig.</i>  <i>19. Pilote sign√© num√©riquement</i> <br><br>  Au cours de la recherche, nous avons trouv√© beaucoup de choses en <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">commun</a> avec le rootkit bien connu du botnet Necurs, qui √©tait activement utilis√© par le groupe TA505 pour envoyer du spam et diffuser des malwares.  Examinons plus en d√©tail les caract√©ristiques les plus int√©ressantes de son travail. <br><br>  Le pilote enregistre les gestionnaires d'√©v√©nements pour d√©marrer les processus et charger les images PE √† l'aide de <code>PsSetCreateProcessNotifyRoutine</code> et <code>PsSetLoadImageNotifyRoutine</code> .  En d'autres termes, cela permet au conducteur de contr√¥ler le lancement de tous les nouveaux processus et services.  En utilisant les listes noires que nous avons mentionn√©es plus t√¥t, le rootkit termine les processus ind√©sirables avec ZwTerminateProcess et emp√™che le chargement d'autres pilotes potentiellement dangereux pour lui, √©crasant la valeur du point d'entr√©e dans les instructions: <br><br><pre> <code class="bash hljs">mov eax, 0C0000001 retn 8</code> </pre> <br>  Par cons√©quent, le service sera d√©charg√© avec l'erreur <code>STATUS_UNSUCCESSFULL</code> . <br><br><img src="https://habrastorage.org/webt/td/l7/ea/tdl7ea03jvxszqftk9rks9wqgqc.jpeg"><br><br>  <i>Fig.</i>  <i>20. Ach√®vement du processus</i> <br><br><img src="https://habrastorage.org/webt/va/6k/bb/va6kbbjuepdp1x99ktenowebmc0.jpeg"><br><br>  <i>Fig.</i>  <i>21. √âcrasement des points d'entr√©e du pilote</i> <br><br>  Au moyen de CmRegisterCallback, le pilote intercepte les √©v√©nements d'acc√®s au Registre syst√®me.  En particulier, ses travaux ult√©rieurs sont param√©tr√©s par les valeurs num√©riques des cl√©s auxquelles on acc√®de dans les √©v√©nements intercept√©s. <br><br><img src="https://habrastorage.org/webt/af/ka/b6/afkab6erynqiphtoyzztal2wjq8.jpeg"><br><br>  <i>Fig.</i>  <i>22. Gestion des rootkits d'acc√®s aux cl√©s de registre</i> <br><br>  Fait int√©ressant, dans certaines versions du rootkit Necurs, les m√™mes valeurs num√©riques ont √©t√© utilis√©es comme codes de requ√™te ioctl. <br><br><img src="https://habrastorage.org/webt/nn/vx/rh/nnvxrhxmoftlziclt9dgak73ydk.jpeg"><br><br>  <i>Fig.</i>  <i>23. Gestion d'un rootkit Necurs √† l'aide de requ√™tes ioctl</i> <br><br>  Cette astuce peut √™tre consid√©r√©e comme une √©tape vers une plus grande confidentialit√©: l'acc√®s au registre provoque moins de suspicion que les requ√™tes ioctl √† DeviceObject. <br><br>  Le corps du rootkit contient une biblioth√®que DLL auxiliaire chiffr√©e avec XOR √† un octet.  Lors de la cr√©ation d'un nouveau processus, le pilote injecte la biblioth√®que avec un autre fichier PE, qui est extrait du registre et √† nouveau d√©chiffr√© avec un XOR √† un octet. <br><br><img src="https://habrastorage.org/webt/nu/ze/03/nuze03jkif4-7sl9mux_j8_roz8.jpeg"><br><br>  <i>Fig.</i>  <i>24. D√©cryptage et injection de la biblioth√®que auxiliaire dans le processus cr√©√©</i> <br><br>  Le composant auxiliaire est un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">chargeur r√©fl√©chissant</a> personnalis√© qui place correctement le deuxi√®me fichier PE dans la m√©moire, qui agit comme une charge utile et lui transf√®re le contr√¥le.  Maintenant, il devient clair comment exactement la charge utile qui a √©t√© √©crite dans le registre par le chargeur de d√©marrage √† partir de la premi√®re partie de l'article commence √† fonctionner. <br><br><img src="https://habrastorage.org/webt/wa/zr/c3/wazrc3yxq9pul3vzf3jjbgsdeyg.jpeg"><br><br>  <i>Fig.</i>  <i>25. Remplir la table d'importation avec une biblioth√®que auxiliaire</i> <br><br><h2>  Conclusion </h2><br>  Dans l'article, nous nous sommes familiaris√©s avec les caract√©ristiques du travail de nombreux chevaux de Troie jumeaux.  Pourquoi des jumeaux?  Le chargeur de d√©marrage malveillant avec lequel nous avons commenc√© nos recherches est tr√®s similaire au chargeur de d√©marrage bien connu FlawedAmmyy par la qualit√© de l'√©criture de code et des nuances d'impl√©mentation.  Les deux biblioth√®ques qu'il essaie de supprimer du syst√®me sont probablement celles que nous examinons ensuite.  Les biblioth√®ques sont tr√®s similaires au plugin de s√©curit√© LatentBot.  L'une des charges utiles du chargeur de d√©marrage est un pilote qui est un d√©riv√© du rootkit Necurs populaire. <br><br>  Certaines familles de logiciels malveillants ont plus de 5 ans, cependant, les attaquants continuent de les mettre √† jour et de les am√©liorer, en tenant compte du d√©veloppement des syst√®mes d'exploitation et des outils de s√©curit√©. <br><br>  <b>Auteurs</b> : Alexey Vishnyakov et Daniil Koloskov, Positive Technologies <br><br><div class="spoiler">  <b class="spoiler_title">CIO</b> <div class="spoiler_text">  a28a54abc30805cc6ea2ce0732989287 - Chargeur d'amor√ßage Twein <br>  f6b6526b8d494dce14568e3703368432 - compte-gouttes de plugin twein <br>  983dd279722154a12093410067fe070e - rootkit Twein <br></div></div><br><h2>  Articles pr√©c√©dents de la s√©rie: </h2><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Op√©ration TA505: comment nous avons analys√© les nouveaux outils des cr√©ateurs du cheval de Troie Dridex, du ransomware Locky et du botnet Neutrino.</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Partie 1</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Op√©ration TA505: apprentissage de la porte d√©rob√©e ServHelper avec NetSupport RAT.</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">2e partie</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Op√©ration TA505: regroupement de l'infrastructure r√©seau.</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">3e partie</a> </li></ul></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr475328/">https://habr.com/ru/post/fr475328/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr475306/index.html">Le costume: histoire et perspectives</a></li>
<li><a href="../fr475308/index.html">Comment passer pour un bon programmeur</a></li>
<li><a href="../fr475320/index.html">Recommandations de Microsoft pour d√©sactiver l'expiration des mots de passe: cons√©quences et conclusions</a></li>
<li><a href="../fr475322/index.html">Son d'os de niveau sup√©rieur - Aftershokz Aeropex Review</a></li>
<li><a href="../fr475326/index.html">Comment les escrocs font cela. Outils de triche</a></li>
<li><a href="../fr475330/index.html">Concours de plug-in de plateforme Miro avec un prize pool de 21 000 $</a></li>
<li><a href="../fr475332/index.html">3. Conception de r√©seaux d'entreprise sur des commutateurs extr√™mes</a></li>
<li><a href="../fr475336/index.html">Comment arr√™ter correctement (instruction)</a></li>
<li><a href="../fr475338/index.html">Si vous n'avez pas Python, mais qu'il existe un mod√®le Keras et Java</a></li>
<li><a href="../fr475340/index.html">AMD pr√©sente les processeurs Threadripper - les processeurs de bureau les plus rapides</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>