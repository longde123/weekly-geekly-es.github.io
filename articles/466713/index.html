<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë©üèø‚Äçü§ù‚Äçüë®üèª üçõ üßïüèª ¬øEs posible en 1C no observar la tecnolog√≠a de los componentes externos? O ¬øC√≥mo felicitar a los colegas que usan 1C? üíÑ üëú üë®üèø‚Äçü§ù‚Äçüë®üèΩ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="¬øHubo una idea aqu√≠ para felicitar a nuestro contador principal de una manera m√°s o menos original, por ejemplo, con la ayuda de su programa favorito ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>¬øEs posible en 1C no observar la tecnolog√≠a de los componentes externos? O ¬øC√≥mo felicitar a los colegas que usan 1C?</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/466713/">  ¬øHubo una idea aqu√≠ para felicitar a nuestro contador principal de una manera m√°s o menos original, por ejemplo, con la ayuda de su programa favorito de 1C?  Pero como? <br><br>  Despu√©s de pensarlo un poco, la idea lleg√≥ a usarse para felicitaciones de fondo en la imagen de fondo en el √°rea del cliente de formularios convencionales para configuraciones en 1C77-1C82 o en una ventana externa para formularios administrados 1C82 y en todos los casos para 1C83.  En √©l, muestre el mensaje deseado y proporcione enlaces al video de felicitaci√≥n, como se muestra en la figura. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/a77/0bd/055/a770bd055ca43fdb5ad8d6f1f124253b.jpg" alt="Enhorabuena en 1C"><br><a name="habracut"></a><br><h2>  Primera parte: resultante </h2><br>  Obviamente, esta idea no es nueva.  Entonces, en 2011, <b><i>Aleksey Fedorov, alias ALF,</i></b> propuso una <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">soluci√≥n similar</a> basada en <b>FormEx.dll</b> .  Y las preguntas sobre <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">c√≥mo lograr esto</a> se hicieron en 2008. <br><br>  Hubo un tiempo en que tambi√©n utilizamos este componente para cargar la imagen de fondo en 1C77.  Pero la descarga de archivos bmp grandes (y otros no se pudieron usar) fue lenta (debido a esto, se usaron peque√±as im√°genes con mosaicos), por lo que hubo un deseo de escribir su propio componente externo (VK), que solo descargar√° las im√°genes necesarias y nada m√°s, a menos que qu√© m√°s ser un terreno de prueba para experimentos. <br><br>  Tal componente fue escrito (tambi√©n, solo para archivos bmp, usando, si es necesario, mosaico).  <b>All√≠ se utiliz√≥ la</b> funci√≥n <b>WinAPI LoadImage ()</b> .  Este dll no entr√≥ en conflicto con FormEx.dll, fue simple, lo suficientemente r√°pido y sirvi√≥ durante mucho tiempo. <br><br>  Todo esto fue maravilloso, pero era hora de ampliar sus capacidades, y aqu√≠ se necesitaba un enfoque diferente. <br><br>  En este art√≠culo, no abordamos los problemas de la creaci√≥n de archivos multimedia.  Esta no es nuestra especialidad.  Nos restringimos solo a algunos matices de programaci√≥n de componentes externos para 1C. <br><br><h3>  1C77 </h3><br>  Dado que las versiones de la plataforma 1C pueden ser diferentes, puede haber varias soluciones.  En nuestro caso, estas fueron configuraciones en 1C77 (Fig. 1). <br><br><img src="https://habrastorage.org/getpro/habr/post_images/8b4/611/4ad/8b46114ad1ae83e57667cc4bb84aae7e.jpg" alt="Fig. 1. Imagen de felicitaci√≥n en la configuraci√≥n de prueba en 1C77"><br>  Fig.  1. Imagen de felicitaci√≥n en la configuraci√≥n de prueba en 1C77. <br><br>  El video aqu√≠, aunque es propio, pero la idea de su creaci√≥n se obtuvo de <b><i>Anna Shiyanova, bajo el apodo de "Caso especial"</i></b> .  Esta chica tiene talento, puede ser imitada, pero es casi imposible repetir completamente el estilo.  En este caso, solo quer√≠a al menos alg√∫n elemento de creatividad. <br><br>  Si uno de los colegas ya est√° cansado de mirar las felicitaciones de otras personas, puede sobrecargar la imagen con " <b>Alt + I</b> " (Fig. 2-3). <br><br><img src="https://habrastorage.org/getpro/habr/post_images/01a/8c1/200/01a8c120008b72dd648b7c8697298d65.jpg" alt="Fig. 2. Seleccionar otra imagen de fondo en el men√∫ &quot;Archivo / Seleccionar fondo&quot; o mediante &quot;Alt + I&quot;"><br>  Fig.  2. Seleccionando una imagen de fondo diferente en el men√∫ "Archivo / Seleccionar fondo" o con "Alt + I". <br><br>  Y al mismo tiempo, vea la informaci√≥n sobre el m√≥dulo utilizado por " <b>Alt + L</b> " (Fig. 3). <br><br><img src="https://habrastorage.org/getpro/habr/post_images/499/499/f23/499499f23ec33734bd6a5068f5d493b8.jpg" alt="Fig. 3. Una imagen de fondo sobrecargada junto con informaci√≥n sobre el programa (&quot;Ayuda / Acerca del m√≥dulo LionExt32.dll&quot; o &quot;Alt + L&quot;)"><br>  Fig.  3. Imagen de fondo sobrecargada junto con informaci√≥n sobre el programa ("Ayuda / Acerca del m√≥dulo LionExt32.dll" o "Alt + L"). <br><br><h3>  1C82 formas convencionales </h3><br>  Naturalmente, la mayor√≠a ahora est√° orientada hacia el G8 (1C8x).  Sin embargo, trabajar con la imagen de fondo en 1C solo es posible en formularios normales en la versi√≥n 8.2 y anteriores, y si no utiliza ning√∫n procesamiento que comience en el modo "escritorio", que simplemente se superpondr√° completamente a nuestro fondo (Fig. 4). <br><br><img src="https://habrastorage.org/getpro/habr/post_images/390/123/bfd/390123bfd2ef88bfbc108dbe44c70835.jpg" alt="Fig. 4. Imagen de felicitaci√≥n en la configuraci√≥n de prueba en formularios ordinarios 1C82"><br>  Fig.  4. Imagen de felicitaci√≥n en la configuraci√≥n de prueba en los formularios habituales 1C82. <br><br>  Tenga en cuenta que los enlaces a la Fig.  4 indican que no es nuestro video.  Se muestran solo para la prueba. <br><br>  En formas ordinarias, 1C82 ya no proporciona la forma est√°ndar de acceder al men√∫, ya que no es sist√©mico all√≠, como en "siete", sino "propio" (aunque el sistema se puede crear, pero ¬øpor qu√© necesitamos dos men√∫s principales?).  Sin embargo, se pueden usar teclas de acceso r√°pido.  Del mismo modo, "Alt + I", en nuestro componente, invocamos un di√°logo, como en la Fig. 2, y cargamos otro fondo (Fig. 5). <br><br><img src="https://habrastorage.org/getpro/habr/post_images/c3f/535/deb/c3f535deb522e2ae7ad8937ce31b1188.jpg" alt="Fig. 5. Imagen de fondo sobrecargada en formas &quot;gruesas&quot; 1C82"><br>  Fig.  5. Imagen de fondo sobrecargada en formas "gruesas" 1C82. <br><br>  Del mismo modo, puede obtener informaci√≥n sobre el m√≥dulo presionando la tecla "Alt + L", como en la fig.  3) <br><br><h3>  1C82 formularios gestionados </h3><br>  Para los formularios administrados en 1C82, a√∫n puede encontrar la ventana que necesitamos en el s√©ptimo nivel de anidaci√≥n, como " <b>V8FormElement</b> " y dibujar en ella, pero de alguna manera no es interesante. <br><br>  Para nosotros, de estas consideraciones se deduce que es m√°s f√°cil crear una ventana externa con un mensaje de felicitaci√≥n (Fig. 6) que manejar cada caso individual.  La ventana en s√≠ puede cerrarse, o m√°s bien minimizarse con " <b>Esc</b> ", " <b>Ctrl + F4</b> ", " <b>Alt + F4</b> " o haciendo clic en la " <b>cruz</b> ". <br><br><img src="https://habrastorage.org/getpro/habr/post_images/790/cd9/79d/790cd979df8a4d97ff5488c50fa4bd6c.jpg" alt="Fig. 6. Imagen de felicitaci√≥n en una configuraci√≥n de prueba en formularios administrados 1C82"><br>  Fig.  6. Imagen de felicitaci√≥n en una configuraci√≥n de prueba en formularios administrados 1C82. <br><br>  Adem√°s, la ventana minimizada (Fig. 7) puede expandirse nuevamente. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/66c/1a7/c7f/66c1a7c7f725404604318cdcde3a9915.jpg" alt="Fig. 7. La imagen minimizada de la ventana externa en los formularios administrados 1C82"><br>  Fig.  7. Una imagen minimizada de la ventana externa en los formularios administrados 1C82. <br><br>  Las dimensiones y la posici√≥n relativa de la ventana externa se pueden cambiar, todo est√° como de costumbre aqu√≠ (ver im√°genes ampliadas de ventanas externas en la Fig. 6 y Fig. 10).  Tenga en cuenta que las teclas de acceso r√°pido solo funcionan si la ventana externa est√° activa. <br><br><h3>  1C83 formas convencionales </h3><br>  En 1C83 no hay m√°s ventanas secundarias, lo que puede servir como criterio para la versi√≥n 1C en nuestro dll.  Adem√°s, los formularios "gruesos" son una ventana de marco (Fig. 8), y los formularios administrados no tienen marco (Fig. 9).  Es decir, todo lo que no sea un marco se puede volver a dibujar.  Un marco tambi√©n se puede volver a dibujar, pero solo como un elemento del sistema. <br><div class="scrollable-table"><table><tbody><tr><th><img src="https://habrastorage.org/getpro/habr/post_images/f9c/35e/0da/f9c35e0da01025306525d14f700d22a4.jpg" alt="Fig. 8. Ventana de marco en formas &quot;gruesas&quot; 1C83"></th><th><img src="https://habrastorage.org/getpro/habr/post_images/962/5f9/e7c/9625f9e7c28fed4c9226ee73d8126ed8.jpg" alt="Fig. 9. Ventana sin marco en formularios gestionados 1C83"></th></tr><tr><th>  Fig.  8. Ventana de marco en formas "gruesas" 1C83. </th><th>  Fig.  9. Ventana sin marco en formas controladas 1C83. </th></tr></tbody></table></div>  Aqu√≠ creamos una ventana de prueba usando una biblioteca din√°mica y la subordinamos a la ventana principal 1C.  La diferencia de comportamiento se ve en las figuras. <br><br><h3>  1C83 formularios gestionados </h3><br>  En el caso de 1C83, como en los formularios administrados 1C82, dibujaremos nuestras felicitaciones no en el fondo, sino en una ventana separada, cuyo prototipo se muestra en la Fig.  8-9.  Como resultado, el componente deseado ( <b>LionExt32.dll</b> o <b>LionExt64.dll</b> ) dar√° el siguiente resultado (Fig. 10-12). <br><br><img src="https://habrastorage.org/getpro/habr/post_images/104/cf1/f10/104cf1f10c6ae652d24edea7082c7e6c.jpg" alt="Fig. 10. La imagen de fondo en la ventana externa para formularios convencionales 1C83"><br>  Fig.  10. La imagen de fondo en la ventana externa para los formularios convencionales 1C83. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/56a/03f/fc7/56a03ffc7fe1f2bfee6358ecb81af9fa.jpg" alt="Fig. 11. Imagen de fondo en la ventana externa de los formularios administrados 1C83, versi√≥n 14, versi√≥n de 64 bits"><br>  Fig.  11. La imagen de fondo en la ventana externa de los formularios administrados 1C83, versi√≥n 14, versi√≥n de 64 bits. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/05e/12f/71c/05e12f71ccfb9212b96bc3db92630869.jpg" alt="Fig. 12. Imagen de fondo en la ventana externa de los formularios administrados 1C83, versi√≥n 15, versi√≥n de 64 bits"><br>  Fig.  12. La imagen de fondo en la ventana externa de los formularios administrados 1C83, versi√≥n 15, versi√≥n de 64 bits. <br><br><h3>  Hallazgos preliminares </h3><br>  Este componente se us√≥ realmente en la pr√°ctica (Fig. 1), el contador principal estaba satisfecho, todo sali√≥ maravillosamente.  En el camino, result√≥ que a los usuarios les gusta elegir sus propias im√°genes de fondo, en este caso, para trabajar en el "siete".  Para el G8, nuestro componente est√° adaptado con una reserva para el futuro, mientras que debe considerarse como una versi√≥n demo. <br><br>  El inter√©s aqu√≠ era que <b><i>este componente no requer√≠a conformidad con la tecnolog√≠a de creaci√≥n de componentes externos a partir de 1C</i></b> .  Quiz√°s surjan ideas adicionales para ampliar sus capacidades.  Por ejemplo, para configuraciones que son totalmente compatibles, no desea realizar cambios en el c√≥digo 1C sin necesidad especial.  En este caso, se podr√≠a ofrecer la opci√≥n de cargar externamente una dll arbitraria en el espacio de direcciones 1C.  Pero este es el tema de otro art√≠culo. <br><br>  De las innovaciones t√©cnicas, se utiliz√≥ un bloqueo para descargar nuestro componente con la plataforma 1C (ya que no cumple con el formato VK).  Adem√°s, otro truco permiti√≥ asignar un <b>men√∫ local</b> a la ventana secundaria, ya que el sistema operativo Windows bloquea la creaci√≥n de dicho men√∫ para ventanas subordinadas.  Por lo tanto, no ver√° men√∫s locales en el mismo <b>MDI</b> (Interfaz de documentos m√∫ltiples) en ning√∫n lado.  Es reemplazado por paneles de comandos, barras de herramientas y un men√∫ contextual.  Todav√≠a hay un momento para actualizar Windows.  A veces sucede que ni <b>UpdateWindow ()</b> ni <b>InvalidateRect ()</b> funcionan correctamente.  Pero un par de funciones en este caso son exitosas: <br><br><pre><code class="cpp hljs">ShowWindow(hWnd, SW_HIDE); ShowWindow(hWnd, SW_SHOW);</code> </pre> <br>  Tambi√©n debe tenerse en cuenta que nuestro componente puede entrar en conflicto con otros, por ejemplo, con FormEx.dll para 1C77.  En este caso, debe cargarse en √∫ltimo lugar. <br><br>  Por cierto, se observa que si crea una configuraci√≥n en la versi√≥n 1C-8.3.14 y superior, entonces el componente no se carga de manera regular.  Pero si la base de datos se cre√≥ en una versi√≥n anterior de 1C y se abre en las √∫ltimas versiones, entonces no hay problemas para cargar nuestro VK.  Una vez m√°s, esto sugiere la necesidad de crear un gestor de arranque externo. <br><br>  Este proyecto utiliza el subsistema <b>WinAPI GDI +</b> .  Al usarlo, puede mostrar im√°genes de varios formatos: <b>bmp, jpg, gif, png, tif</b> y otros.  En el mismo orden, el componente intenta cargar el primer archivo <b>Main. *</b> Disponible desde el directorio local de <b>fotos</b> en la configuraci√≥n actual.  Si no se encuentra ninguno de estos archivos, se utiliza una imagen de fondo simple de los recursos del componente.  En la fig.  La Figura 13 muestra esta imagen de fondo para las formas habituales de 1C83 de 64 bits, versi√≥n 15. Para variar, la ventana externa de la jerga se ha ampliado y otra imagen del archivo <b>Main1.png</b> , que se ha "mosaico", se ha agregado a su fondo. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/71c/80a/48a/71c80a48a18236e495a1d62b0f316e11.jpg" alt="Fig. 13. El fondo de pantalla predeterminado para formularios regulares 1C83 de 64 bits, versi√≥n 15"><br>  Fig.  13. La imagen de fondo predeterminada para las formas habituales de 1C83 de 64 bits, versi√≥n 15. Adem√°s, se ha agregado otra imagen del archivo Main1.png, "mosaico". <br><br>  No hay diferencia en la operaci√≥n del componente en diferentes modos de bit. <br><br>  Tambi√©n se puede observar que nuestro componente subclasifica la ventana principal 1C y su cliente MDI, si corresponde.  Esto, aparentemente, sirve como una fuente de conflicto con FormEx.dll cuando se carga por √∫ltima vez (en 1C77). <br><br><h2>  Segunda parte: t√©cnica </h2><br>  El proyecto en s√≠ se puede encontrar en los siguientes enlaces: <br><br><ul><li>  <a href="">Configuraci√≥n de prueba en 1C77</a> </li><li>  <a href="">Configuraci√≥n de prueba en 1C82</a> </li><li>  <a href="">Configuraci√≥n de prueba en 1C83</a> </li><li>  <a href="">Proyecto en MS VS C ++, v.</a>  <a href="">13</a> </li></ul><br>  Un proyecto <b>C ++</b> se puede adaptar f√°cilmente para la versi√≥n <b>10</b> si la cadena ‚Äú <b>v120</b> ‚Äù se reemplaza por ‚Äú <b>v100</b> ‚Äù y ‚Äú <b>ToolsVersion =‚Äú 12.0 ‚Äù</b> ‚Äù por ‚Äú <b>ToolsVersion =‚Äú 4.0 ‚Äù</b> en los archivos de configuraci√≥n. <br><br>  El c√≥digo para las versiones de <b>32</b> bits y <b>64</b> bits de <b>1C es</b> el mismo y puede compilarse al mismo tiempo. <br><br>  La versi√≥n 1C77 est√° determinada en el componente externo por el <b>controlador de</b> funci√≥n GetMenu <b>()</b> distinto de cero, y la versi√≥n 1C83, por la ausencia de ventanas secundarias en la ventana principal, cuyo controlador est√° determinado por la funci√≥n <b>GetForegroundWindow ()</b> . <br><br><h3>  Sobre la tecnolog√≠a de creaci√≥n de componentes externos para 1C </h3><br>  En los discos ITS de la compa√±√≠a 1C, y en Internet, se puede encontrar f√°cilmente informaci√≥n sobre la creaci√≥n de VC y las plantillas correspondientes en diferentes lenguajes de programaci√≥n.  Sin embargo, en los tiempos del 1C77, estos patrones satisfac√≠an "no solo a todos". <br><br>  Si observa algunos componentes ampliamente utilizados, especialmente para 1C77, ver√° que sus autores a menudo utilizan m√©todos de programaci√≥n especiales para ampliar las capacidades de sus dise√±os. <br><br>  Quiz√°s uno de los primeros componentes externos fue <b><i>"RAINBOW ADDIN 2000 para 1C: Enterprise 7.7"</i></b> .  Quiz√°s lo m√°s importante aqu√≠ fue una penetraci√≥n m√°s profunda en los intestinos de los "siete" que la tecnolog√≠a VK oficial permitida, aunque sigui√≥ el formato VK.  Esto se logr√≥ debido a los encabezados recibidos, posiblemente posiblemente no est√°ndar, encabezados (archivos * .h) de los archivos de la biblioteca 1C77 utilizados en otros proyectos ampliamente conocidos. <br><br>  De hecho, si las funciones 1C como <b>LoadExternalComponent ()</b> y <b>ConnectExternalComponent () le</b> permiten incrustar <b>archivos dlls externos</b> en su propio espacio de direcciones (en primer lugar, que satisfacen el formato de tecnolog√≠a VK), entonces ¬øpor qu√© los programas de usuario no sucumben a la tentaci√≥n e intentan acceder a otros ocultos? ellos, procedimientos y otros objetos de la plataforma de destino?  Este enfoque ha sido demostrado con √©xito por el componente <b>Rainbow.dll</b> . <br><br>  Posteriormente, otros autores del componente 1C versi√≥n 7.7 adoptaron un mecanismo similar.  De particular inter√©s es el componente para el "siete" <b>1C ++. Dll</b> y su, por as√≠ <b>decirlo</b> , un caso especial de <b>FormEx.dll</b> . <br><br>  Pero el enfoque no trivial para el dise√±o de componentes externos para 1C77 no termin√≥ ah√≠.  Aparentemente, alguien deber√≠a haber dicho: ‚Äú¬øPor qu√© necesitamos un herrero?  ¬°No necesitamos un herrero! "  Aqu√≠, por "herrero" nos referimos a la tecnolog√≠a COM de MicroSoft, que, en cierto sentido, fue seguida por la tecnolog√≠a VK para los "siete".  No, bueno, realmente, ¬øpor qu√© necesitamos un registro si descargamos nuestro VK directamente?  Esto puede tener sentido para los navegadores web que funcionan con Internet, pero para la operaci√≥n local, el uso del registro es claramente redundante.  Por lo menos, esto no deber√≠a ser un requisito previo.  Adem√°s, para editar el registro necesita derechos administrativos. <br><br>  Tenga en cuenta que 1C era muy aficionado a esta tecnolog√≠a (al menos hasta que se transfiri√≥ 1C a Linux).  La tratamos muy bien.  COM es conveniente para usar el componente ActiveX y esto es natural, ya que este √∫ltimo se desarroll√≥ originalmente para Internet. <br><br>  Sin embargo, en las √∫ltimas versiones, 1C agreg√≥ la capacidad de usar la tecnolog√≠a <b>Native API</b> , lo que elimina la necesidad de un registro.  En principio, esto es lo que necesitamos, excepto que esta tecnolog√≠a no es aplicable en los "siete" y, para algunos, sigue siendo relevante. <br><br>  Pero a veces surgen tareas relativamente simples cuando no desea utilizar un mont√≥n de c√≥digo repetitivo para VK y es recomendable trabajar con 1C solo desde el lado del componente externo.  Como, digamos, en nuestro caso, la demostraci√≥n de una imagen de felicitaci√≥n en el √°rea del cliente o, si es necesario, en una ventana separada, la configuraci√≥n 1C. <br><br>  En otras palabras, si no vamos a intercambiar datos directamente entre 1C y VK, entonces estaremos bastante contentos con una versi√≥n m√°s simple y m√°s universal del componente externo para 1C.  La simplicidad aqu√≠ se lograr√° debido a la falta de c√≥digo repetitivo. <br><br><h3>  Tecnolog√≠a alternativa para crear VK para 1C </h3><br>  Dado que VK para 1C es un caso especial de un <b>servidor COM</b> (antes de la tecnolog√≠a <b>API nativa</b> ), hubo desarrolladores de VK que dijeron: "¬°COM - no!".  La actividad en esta direcci√≥n de <b><i>Alexander Orefkov</i></b> es especialmente notable.  Sus componentes " <b>1sqlite.dll</b> ", " <b>TurboMD.dll</b> ", y posiblemente otros, no usan COM de la palabra "completamente".  El componente <b>Yoksel</b> (" <b>SpreadSheet.dll</b> ") tambi√©n se desarrolla a lo largo de este camino. <br><br>  Pero, ¬øc√≥mo carga entonces el cargador VK de 1C77 estos componentes?  Despu√©s de todo, ni siquiera intentan imitar alg√∫n tipo de COM all√≠.  De hecho, si tratamos de deslizar sin rodeos algunos dll est√°ndar generados por, por ejemplo, el asistente <b>MS VC ++</b> en la funci√≥n <b>LoadExternalComponent ()</b> , entonces tendremos un fastidio. <br><br>  En el "siete" recibimos un mensaje como: <blockquote>  Se produjo un error al crear un objeto desde el componente &lt;Ruta completa \ Nombre del componente&gt; .dll (falta CLSID) </blockquote><br>  En el cliente "grueso" de 32 bits del mensaje "ocho" ser√° similar.  El mismo dll causar√° un juramento similar (Fig. 15): <blockquote>  Error al llamar al m√©todo de contexto (Cargar componente externo): Error al cargar componente externo </blockquote><br>  A√∫n as√≠, ¬øc√≥mo resuelven este problema las bibliotecas mencionadas?  Al estudiar los textos de los programas Orefkov y Yoksel, finalmente concluimos que las siguientes " <b>l√≠neas m√°gicas</b> " en el archivo de recursos (* .rc o * .rc2) son "culpables": <br><br><pre> <code class="plaintext hljs">STRINGTABLE DISCARDABLE BEGIN 100 "\0sd" // 1sqlite.dll 100 "\0tmd" // TurboMD.dll 100 "\0f" // SpreadSheet.dll END</code> </pre> <br>  Es decir  sin falta, en los recursos del programa hay una l√≠nea con el identificador <b>100</b> y alg√∫n valor de cadena, cuyo primer car√°cter es cero.  Puede experimentar con variaciones de tales cadenas, pero la cadena " <b>\ 0L</b> " est√° bien conmigo.  Por lo tanto, creamos un archivo de recursos y escribimos l√≠neas como esta: <br><br><pre> <code class="plaintext hljs">STRINGTABLE DISCARDABLE BEGIN 100 "\0L" //    1     ! END</code> </pre> <br>  Conectamos este archivo a nuestro proyecto dll m√°s simple generado por el asistente de MS C ++, agregue el c√≥digo: <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-function">BOOL APIENTRY </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">DllMain</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(HANDLE hModule, DWORD dwReason, LPVOID lpReserved)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span>(dwReason) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> DLL_PROCESS_ATTACH: MessageBox(<span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">",  DllMain()!"</span></span>, <span class="hljs-string"><span class="hljs-string">""</span></span>, MB_OK); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> DLL_THREAD_ATTACH: <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> DLL_THREAD_DETACH: <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> DLL_PROCESS_DETACH: <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } <span class="hljs-comment"><span class="hljs-comment">// switch(dwReason) return TRUE; } // DllMain()</span></span></code> </pre> <br>  y observar (Fig. 14). <br><br><img src="https://habrastorage.org/getpro/habr/post_images/715/a71/7f7/715a717f7ee778dd219e79e5fbd43e97.jpg" alt="Fig. 14. Uso del &quot;VK&quot; m√°s simple en 1C82"><br>  Fig.  14. Uso del "VK" m√°s simple en 1C82. <br><br>  Sin "l√≠neas m√°gicas" en el archivo de recursos, nuestro dll, despu√©s de mostrar MessageBox, se descarga inmediatamente con una maldici√≥n de 1C (Fig. 15). <br><br><img src="https://habrastorage.org/getpro/habr/post_images/a98/cec/432/a98cec4326033180917940aa248dbc96.jpg" alt="Fig. 15. Error al cargar dll regular en 1C82"><br>  Fig.  15. Error al cargar dll regular en 1C82. <br><br>  Es decir, estas l√≠neas realmente tienen un efecto m√°gico en el cargador de componentes externos 1C. <br><br>  Parece que las primeras "l√≠neas m√°gicas" fueron descritas en su antiguo art√≠culo por <b><i>Alexei Fedorov (ALF)</i></b> , pero el enlace ya no est√° disponible, y el autor no ve el punto en su nueva publicaci√≥n.  Adem√°s, <b><i>Alexander Orefkov los</i></b> utiliz√≥ con mayor intensidad, y aparentemente, seg√∫n su presentaci√≥n, el autor fue <b><i>Yoksel</i></b> .  Por lo tanto, hablaremos sobre las <b><i>l√≠neas "m√°gicas" de Fedorov-Orefkov</i></b> .  Su significado es bloquear la descarga de archivos dll no est√°ndar (desde el punto de vista de 1C) mediante la funci√≥n <b>LoadExternalComponent ()</b> .  Adem√°s, como vemos, esta t√©cnica funciona no solo en 1C77, sino tambi√©n en formas "gruesas" 1C82. <br><br>  Sin embargo, en los formularios administrados 1C82 y en todas las versiones de 1C83, esta caracter√≠stica ya est√° completamente bloqueada (apareci√≥ otro cargador: <b>Conectar</b> componente externo <b>()</b> ). <br><br>  Por lo tanto, en las versiones modernas de 1C, debe buscar otras alternativas simples a las l√≠neas "m√°gicas" de Fedorov-Orefkov. <br><br>  Y esa alternativa es f√°cil de ofrecer.  El punto es simple.  El cargador 1C descarga el componente "incorrecto" si arroja una excepci√≥n al intentar acceder a √©l utilizando el protocolo especificado, por ejemplo, al solicitar la versi√≥n del componente.  Naturalmente, no tenemos nada de este tipo, que sirve como base para descargar un archivo DLL no est√°ndar.  Pero el sistema puede ignorar el requisito de 1C para que el sistema operativo descargue esta biblioteca din√°mica si este VK todav√≠a se usa en alguna parte.  En lugar de la eliminaci√≥n en s√≠, el sistema simplemente reduce el contador de uso del m√≥dulo deseado.  Y eliminar f√≠sicamente no antes de que se restablezca este contador.  Por lo tanto, nuestra tarea es aumentar artificialmente este contador. <br><br>  Para hacer esto, puede llamar a nuestra funci√≥n dll WinAPI <b>LoadLibrary ()</b> nuevamente en la secci√≥n <b>DLL_THREAD_ATTACH</b> <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-function">BOOL APIENTRY </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">DllMain</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(HANDLE hModule, DWORD dwReason, LPVOID lpReserved)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span>(dwReason) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> DLL_PROCESS_ATTACH: { WCHAR szDllName[_MAX_PATH] = {<span class="hljs-number"><span class="hljs-number">0</span></span>}; <span class="hljs-comment"><span class="hljs-comment">//     dll GetModuleFileName(hModule, szDllName, _MAX_PATH); //MessageBox(NULL, szDllName, L"Info", MB_OK); //    dll (     183), //      DLL_PROCESS_ATTACH HMODULE hDll = LoadLibrary(szDllName); break; } // case DLL_PROCESS_ATTACH case DLL_THREAD_ATTACH: break; case DLL_THREAD_DETACH: break; case DLL_PROCESS_DETACH: break; } // switch(dwReason) return TRUE; } // DllMain()</span></span></code> </pre> <br>  Eso es todo!  El problema est√° resuelto.  Recuperar la misma biblioteca din√°mica aumentar√° su contador de uso en uno, y la descarga (con acceso preliminar a la secci√≥n <b>DLL_THREAD_DETACH</b> ) disminuir√° en uno.  Total tenemos <b>2 - 1 = 1&gt; 0</b> , por lo tanto, el sistema operativo no descargar√° nuestro dll.  Adem√°s, lo que es importante, no se reiniciar√° la secci√≥n <b>DLL_PROCESS_ATTACH</b> . <br><br>  A partir de esto, por cierto, uno puede ver c√≥mo 1C puede lidiar con un truco similar en sus √∫ltimas versiones (y, aparentemente, ya lo hace en las configuraciones creadas en 1C-8.3.14 y superior).  Puede usar la funci√≥n <b>LoadLibraryEx ()</b> con un par√°metro que bloquea la ejecuci√≥n de la secci√≥n de inicializaci√≥n <b>DLL_PROCESS_ATTACH</b> , despu√©s de lo cual llamar√° inmediatamente a las funciones exportadas necesarias.  Y, de hecho, si observa el c√≥digo del ejemplo de VK para la API nativa, puede ver que no es necesario llamar al c√≥digo de inicializaci√≥n, ya que debe estar vac√≠o por el formato VK. <br><br>  Con respecto a los ejemplos de uso de la tecnolog√≠a COM, es obvio que la ejecuci√≥n de la secci√≥n de inicializaci√≥n <b>DLL_PROCESS_ATTACH</b> es necesaria all√≠, por lo tanto, en versiones no demasiado nuevas de 1C, m√°s precisamente, en las configuraciones realizadas en 1C-8.3.13 y siguientes, el cargador 1C es adecuado para nosotros: <br><br><pre> <code class="plaintext hljs">(, , .COM);</code> </pre> <br>  Aqu√≠ se puede eliminar el √∫ltimo par√°metro, ya que est√° impl√≠cito de forma predeterminada.  Al mismo tiempo, se pueden abrir normalmente en cualquier versi√≥n superior.  En las versiones 1C83, el cargador de arranque anterior <b>LoadExternalComponent (Direcci√≥n del componente)</b> ya no nos conviene (respectivamente, las "l√≠neas m√°gicas" de Fedorov-Orefkov no funcionan all√≠). <br><br>  En el caso general, como ya se mencion√≥, el problema se puede resolver utilizando un gestor de arranque externo.  O, lo cual es bastante natural, observar, en una medida u otra, la tecnolog√≠a de los componentes externos de 1C. <br><br>  Tambi√©n debe tenerse en cuenta que los experimentos que realizamos en versiones de archivo de 1C con diferentes profundidades de bits.  Para descargar nuestro componente, es posible que deba configurar la propiedad " <b>Modo de uso de llamadas s√≠ncronas</b> " en " <b>Usar</b> " en la configuraci√≥n. <br><br>  Tambi√©n debe entenderse que lleva a cabo el uso de dicha t√©cnica bajo su propio riesgo, experimente de antemano las configuraciones de prueba o copias de los trabajadores para evitar posibles problemas en los programas principales. <br><br><h3>  Actualizaci√≥n del 11/09/2019 </h3><br>  Result√≥ que me preocupaba en vano que: "en las versiones 1C-8.3.14 y superiores, la secci√≥n de inicializaci√≥n en el componente externo ya no se realiza a partir de la palabra" completamente "". <br><br>  Resulta que solo el mensaje de retorno en la funci√≥n <b>ConnectExternalComponent ()</b> no necesita ser procesado.  Adem√°s, no importa qu√© tipo de componente especifiquemos: <b>COM</b> o <b>Native API</b> . <br><br>  Por lo tanto, puede crear una configuraci√≥n en todas las versiones actualmente disponibles de 1C, nuestro componente deber√≠a funcionar bien en todas partes, y la creaci√≥n de un gestor de arranque externo ser√° relevante, a menos que no desee cambiar la configuraci√≥n, que es totalmente compatible. <br><br>  A este respecto, el c√≥digo en las configuraciones de prueba para 1C82 y 1C83 se modifica ligeramente, aunque las diferencias entre ellos ya no son fundamentales. <br><br>  Al mismo tiempo, nuestra observaci√≥n de que la compa√±√≠a 1C puede bloquear f√°cilmente la ejecuci√≥n del c√≥digo de inicializaci√≥n en cualquier VK, al menos para componentes externos como la <b>API nativa</b> , obviamente sigue siendo v√°lida, porque a juzgar por su plantilla, esto no es necesario.  Para un <b>COM</b> tipo VK <b>, existe</b> tal necesidad hasta ahora, pero ¬øqu√© le impide deshacerse de √©l?  Al mismo tiempo, ¬øveremos si tienen en cuenta esta informaci√≥n? </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/466713/">https://habr.com/ru/post/466713/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../466699/index.html">Domar protocolos de confianza: autenticaci√≥n OAuth con InterSystems IRIS</a></li>
<li><a href="../466701/index.html">Let's Encrypt sirve casi el 30% de los dominios</a></li>
<li><a href="../466705/index.html">Vivaldi Beta para Android - Navegador real</a></li>
<li><a href="../466709/index.html">Desarrollo de un sistema operativo monol√≠tico tipo Unix - Biblioteca C (2)</a></li>
<li><a href="../466711/index.html">Vulnerabilidad DaOffice permiti√≥ eliminar a cualquier usuario de la red social</a></li>
<li><a href="../466719/index.html">Perfiles de velocidad superligera: teor√≠a y pr√°ctica. Parte 1</a></li>
<li><a href="../466721/index.html">[Ekaterimburgo, anuncio] java.ural.Meetup @ 3 - anuncio de los terceros informes de video Java mitap + de java.ural.Meetup @ 2</a></li>
<li><a href="../466723/index.html">Apple Text Broadcast - 10 de septiembre de 2019</a></li>
<li><a href="../466725/index.html">Dagger 2 es elemental (Parte 1)</a></li>
<li><a href="../466727/index.html">Actualizaci√≥n perezosa: c√≥mo PostgreSQL 12 mejora el rendimiento</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>