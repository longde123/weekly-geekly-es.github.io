<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>๐ผ ๐บ ๐จ๐พโ๐คโ๐จ๐ป ุงูุงูุถูุงู ุฅูู ูุฌููุนุฉ ูุญููุฉ ู DbSet ูู ุฅุทุงุฑ ุงูููุงู ๐ ๐ ๐คฑ๐ป</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="ุจุนุฏ ุฃูุซุฑ ูู ุนุงู ุจูููู ุจูุดุงุฑูุชู ุ ุฌุฑู "ุงูุญูุงุฑ" ุงูุชุงูู: 


 .Net App : Hey Entity Framework ุ ูู ูุถูู ุฃุนุทูู ุงููุซูุฑ ูู ุงูุจูุงูุงุช! 
 ุฅุทุงุฑ ุงูููุงู : ุขุณู ุ ูู...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>ุงูุงูุถูุงู ุฅูู ูุฌููุนุฉ ูุญููุฉ ู DbSet ูู ุฅุทุงุฑ ุงูููุงู</h1><div class="post__body post__body_full" style=";text-align:right;direction:rtl"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/435810/" style=";text-align:right;direction:rtl"><p style=";text-align:right;direction:rtl">  ุจุนุฏ ุฃูุซุฑ ูู ุนุงู ุจูููู ุจูุดุงุฑูุชู ุ ุฌุฑู "ุงูุญูุงุฑ" ุงูุชุงูู: </p><br><p style=";text-align:right;direction:rtl">  <strong>.Net App</strong> : Hey Entity Framework ุ ูู ูุถูู ุฃุนุทูู ุงููุซูุฑ ูู ุงูุจูุงูุงุช! <br>  <strong>ุฅุทุงุฑ ุงูููุงู</strong> : ุขุณู ุ ูู ุฃูููู.  ูุงุฐุง ุชูุตุฏุ <br>  <strong>.Net App</strong> : ูุนู ุ ุฃูุง ููุท ุญุตูุช ุนูู ูุฌููุนุฉ ูู ุงููุนุงููุงุช 100K.  ูุงูุขู ูุญู ุจุญุงุฌุฉ ุฅูู ุงูุชุญูู ุจุณุฑุนุฉ ูู ุตุญุฉ ุฃุณุนุงุฑ ุงูุฃูุฑุงู ุงููุงููุฉ ุงููุดุงุฑ ุฅูููุง ููุงู. <br>  <strong>ุฅุทุงุฑ ุงูููุงู</strong> : ุญุณููุง ุ ุญุณููุง ุ ุฏุนููุง ูุญุงูู ... <br>  <strong>.Net App</strong> : ููุง ูู ุงูููุฏ: </p><br><pre style=";text-align:right;direction:rtl"><code class="cpp hljs">var query = from p in context.Prices join t in transactions on <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> { p.Ticker, p.TradedOn, p.PriceSourceId } equals <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> { t.Ticker, t.TradedOn, t.PriceSourceId } select p; query.ToList();</code> </pre> <br><p style=";text-align:right;direction:rtl">  <strong>ุฅุทุงุฑ ุงูููุงู</strong> : </p><br><p style=";text-align:right;direction:rtl"><img src="https://habrastorage.org/webt/kc/jh/lp/kcjhlpnggo_fhkdgik481svjuea.png"></p><br><p style=";text-align:right;direction:rtl">  ุงูููุงุณูููุฉ  ุฃุนุชูุฏ ุฃู ุงูุนุฏูุฏ ูู ุงูุฃุดุฎุงุต ุนูู ุฏุฑุงูุฉ ุจูุฐุง ุงููููู: ุนูุฏูุง ุฃุฑุบุจ ุญููุง "ุจุดูู ุฌููู" ูุจุณุฑุนุฉ ูู ุงูุจุญุซ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช ุจุงุณุชุฎุฏุงู <em>JOIN ูู</em> ุงููุฌููุนุฉ ุงููุญููุฉ ู <em>DbSet</em> .  ุนุงุฏุฉ ูุง ุชููู ูุฐู ุงูุชุฌุฑุจุฉ ูุฎูุจุฉ ููุขูุงู. </p><br><p style=";text-align:right;direction:rtl">  ูู ูุฐู ุงูููุงูุฉ (ุงูุชู ูู <em>ุชุฑุฌูุฉ ูุฌุงููุฉ ูููุงูุชู ุงูุฃุฎุฑู</em> ) ุณุฃุฌุฑู ุณูุณูุฉ ูู ุงูุชุฌุงุฑุจ ูุฃุญุงูู ุทุฑููุง ูุฎุชููุฉ ููุชุบูุจ ุนูู ูุฐุง ุงูููุฏ.  ุณูููู ููุงู ุฑูุฒ (ุบูุฑ ูุนูุฏ) ุ ูุงูุฃููุงุฑ ูุดูุก ูู ูุฐุง ุงููุจูู ููุงูุฉ ุณุนูุฏุฉ. </p><a name="habracut"></a><br><h2 id="vvedenie" style=";text-align:right;direction:rtl">  ููุฏูุฉ </h2><br><p style=";text-align:right;direction:rtl">  ูุนูู ุงูุฌููุน ุญูู <em>Entity Framework</em> ุ ูุงููุซูุฑ ูููู ูุณุชุฎุฏูููู ูููููุง ุ ูููุงู ุงูุนุฏูุฏ ูู ุงูููุงูุงุช ุงูุฌูุฏุฉ ุญูู ููููุฉ ุทุจุฎู ุจุดูู ุตุญูุญ (ุงุณุชุฎุฏู ุงุณุชุนูุงูุงุช ุฃุจุณุท ุ ูุงุณุชุฎุฏู ุงููุนููุงุช ูู Skip and Take ุ ูุงุณุชุฎุฏู VIEW ุ ูุงุทูุจ ููุท ุงูุญููู ุงููุงุฒูุฉ ุ ูุฑุงุจุท ุงูุชุฎุฒูู ุงููุคูุช ููุงุณุชุนูุงู ู ุฃุฎุฑู) ุ ููุน ุฐูู ุ ูุฅู <em>ุณูุฉ</em> <em>JOIN</em> ุงูุฎุงุตุฉ ุจุงููุฌููุนุฉ ุงููุญููุฉ ู <em>DbSet</em> ูุง ุชุฒุงู ููุทุฉ ุถุนู. </p><br><h2 id="zadacha" style=";text-align:right;direction:rtl">  ุงูุชุญุฏู </h2><br><p style=";text-align:right;direction:rtl">  ุงูุชุฑุถ ุฃู ููุงู ูุงุนุฏุฉ ุจูุงูุงุช ุชุญุชูู ุนูู ุฃุณุนุงุฑ ูููุงู ูุฌููุนุฉ ูู ุงููุนุงููุงุช ุงูุชู ุชุญุชุงุฌ ุฅูู ุงูุชุญูู ูู ุตุญุฉ ุงูุฃุณุนุงุฑ.  ูููุชุฑุถ ุฃู ูุฏููุง ุงูููุฏ ุงูุชุงูู. </p><br><pre style=";text-align:right;direction:rtl"> <code class="cpp hljs">var localData = GetDataFromApiOrUser(); var query = from p in context.Prices join s in context.Securities on p.SecurityId equals s.SecurityId join t in localData on <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> { s.Ticker, p.TradedOn, p.PriceSourceId } equals <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> { t.Ticker, t.TradedOn, t.PriceSourceId } select p; var result = query.ToList();</code> </pre> <br><p style=";text-align:right;direction:rtl">  ูุง ูุนูู ูุฐุง ุงูุฑูุฒ ูู <em>Entity Framework 6</em> ุนูู ุงูุฅุทูุงู.  ูู <em>Entity Framework Core</em> - ูุนูู ุ ููู ูู ุดูุก ุณูุชู ุนูู ุฌุงูุจ ุงูุนููู ููู ุญุงูุฉ ูุฌูุฏ ุงูููุงููู ูู ุงูุณุฌูุงุช ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช - ูุฐุง ููุณ ุฎูุงุฑูุง. </p><br><p style=";text-align:right;direction:rtl">  ููุง ููุช ุ ุณุฃุญุงูู ุทุฑู ูุฎุชููุฉ ููุชุบูุจ ุนูู ูุฐุง.  ูู ุงูุจุณูุท ุงูู ุงููุนูุฏ.  ุจุงููุณุจุฉ ููุชุฌุงุฑุจ ุงูุชู ุฃุฌุฑููุง ุ ุฃุณุชุฎุฏู ุงูููุฏ ูู <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">ุงููุณุชูุฏุน</a> ุงูุชุงูู.  ุชุชู ูุชุงุจุฉ ุงูุฑูุฒ ุจุงุณุชุฎุฏุงู: <em>C #</em> ู <em>.Net Core</em> ู <em>EF Core</em> ู <em>PostgreSQL</em> . </p><br><p style=";text-align:right;direction:rtl">  ููุฏ ููุช ุฃูุถูุง ุจุชุตููุฑ ุจุนุถ ุงูููุงููุณ: ุงูููุช ุงููุณุชุบุฑู ูุงุณุชููุงู ุงูุฐุงูุฑุฉ.  ุฅุฎูุงุก ุงููุณุฆูููุฉ: ุฅุฐุง ุชู ุฅุฌุฑุงุก ุงูุงุฎุชุจุงุฑ ูุฃูุซุฑ ูู 10 ุฏูุงุฆู ุ ููุฏ ูุงุทุนุชู (ุงูููุฏ ุฃุนูุงู).  ุขูุฉ ุงุฎุชุจุงุฑ Intel Core i5 ุ ุฐุงูุฑุฉ ูุตูู ุนุดูุงุฆู ุณุนุชูุง 8 ุฌูุฌุงุจุงูุช ุ SSD. </p><br><div class="spoiler" style=";text-align:right;direction:rtl">  <b class="spoiler_title">ูุฎุทุท ูุงุนุฏุฉ ุงูุจูุงูุงุช</b> <div class="spoiler_text" style=";text-align:right;direction:rtl"><p style=";text-align:right;direction:rtl"><img src="https://habrastorage.org/getpro/habr/post_images/1d5/f8c/cec/1d5f8ccec6ef1b7361195c18ac139d09.png" alt="ุงูุตูุฑุฉ"></p><br><p style=";text-align:right;direction:rtl">  ุงูุฌุฏุงูู 3 ููุท: <em>ุงูุฃุณุนุงุฑ</em> <em>ูุงูุฃูุฑุงู ุงููุงููุฉ</em> <em>ููุตุงุฏุฑ ุงูุฃุณุนุงุฑ</em> .  <em>ุงูุฃุณุนุงุฑ</em> - ุชุญุชูู ุนูู 10 ููููู ุฅุฏุฎุงู. </p></div></div><br><h4 id="sposob-1-naive" style=";text-align:right;direction:rtl">  ุทุฑููุฉ 1. ุณุงุฐุฌ </h4><br><p style=";text-align:right;direction:rtl">  ุฏุนูุง ูุจุฏุฃ ุจุณูุทุฉ ูุงุณุชุฎุฏุงู ุงูููุฏ ุงูุชุงูู: </p><br><div class="spoiler" style=";text-align:right;direction:rtl">  <b class="spoiler_title">ุฑูุฒ ุงูุทุฑููุฉ ุงูุฃููู</b> <div class="spoiler_text" style=";text-align:right;direction:rtl"><pre style=";text-align:right;direction:rtl"> <code class="cpp hljs">var result = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> List&lt;Price&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> (var context = CreateContext()) { foreach (var testElement in TestData) { result.AddRange(context.Prices.Where( x =&gt; x.Security.Ticker == testElement.Ticker &amp;&amp; x.TradedOn == testElement.TradedOn &amp;&amp; x.PriceSourceId == testElement.PriceSourceId)); } }</code> </pre> </div></div><br><p style=";text-align:right;direction:rtl">  ุงูููุฑุฉ ุจุณูุทุฉ: ูู ุญููุฉ ููุฑุฃ ุงูุณุฌูุงุช ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช ูุงุญุฏูุง ุชูู ุงูุขุฎุฑ ููุถูููุง ุฅูู ุงููุฌููุนุฉ ุงููุงุชุฌุฉ.  ูุฐุง ุงูุฑูุฒ ูุฏูู ููุฒุฉ ูุงุญุฏุฉ ููุท - ุงูุจุณุงุทุฉ.  ูููุงู ุนูุจ ูุงุญุฏ ูู ุงูุณุฑุนุฉ ุงูููุฎูุถุฉ: ุญุชู ุฅุฐุง ูุงู ููุงู ููุฑุณ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช ุ ูุบุงูุจูุง ูุง ุณูุณุชุบุฑู ุงูุงุชุตุงู ุจุฎุงุฏู ูุงุนุฏุฉ ุงูุจูุงูุงุช.  ุงูููุงููุณ ูู ููุง ููู: </p><br><p style=";text-align:right;direction:rtl"><img src="https://habrastorage.org/getpro/habr/post_images/985/61c/b6a/98561cb6a2566faff490fc2bf7432fb9.png" alt="ุงูุตูุฑุฉ"></p><br><p style=";text-align:right;direction:rtl">  ุงุณุชููุงู ุงูุฐุงูุฑุฉ ุตุบูุฑ.  ูุฌููุนุฉ ูุจูุฑุฉ ุชุณุชุบุฑู ุฏูููุฉ ูุงุญุฏุฉ.  ูุจุฏุงูุฉ ุ ููุณุช ุณูุฆุฉ ุ ููููู ุฃุฑูุฏ ุฐูู ุจุดูู ุฃุณุฑุน. </p><br><h4 id="sposob-2-naive-parallel" style=";text-align:right;direction:rtl">  ุงูุทุฑููุฉ 2: ุณุงุฐุฌ ููุงุฒูุฉ </h4><br><p style=";text-align:right;direction:rtl">  ุฏุนููุง ูุญุงูู ุฅุถุงูุฉ ุงูุชูุงุฒู.  ูุงูููุฑุฉ ูู ุงููุตูู ุฅูู ูุงุนุฏุฉ ุงูุจูุงูุงุช ูู ุฎููุท ูุชุนุฏุฏุฉ. </p><br><div class="spoiler" style=";text-align:right;direction:rtl">  <b class="spoiler_title">ุฑูุฒ ุงูุทุฑููุฉ 2</b> <div class="spoiler_text" style=";text-align:right;direction:rtl"><pre style=";text-align:right;direction:rtl"> <code class="cpp hljs">var result = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ConcurrentBag&lt;Price&gt;(); var partitioner = Partitioner.Create(<span class="hljs-number"><span class="hljs-number">0</span></span>, TestData.Count); Parallel.ForEach(partitioner, range =&gt; { var subList = TestData.Skip(range.Item1) .Take(range.Item2 - range.Item1) .ToList(); <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> (var context = CreateContext()) { foreach (var testElement in subList) { var query = context.Prices.Where( x =&gt; x.Security.Ticker == testElement.Ticker &amp;&amp; x.TradedOn == testElement.TradedOn &amp;&amp; x.PriceSourceId == testElement.PriceSourceId); foreach (var el in query) { result.Add(el); } } } });</code> </pre> </div></div><br><p style=";text-align:right;direction:rtl">  ุงููุชูุฌุฉ: </p><br><p style=";text-align:right;direction:rtl"><img src="https://habrastorage.org/getpro/habr/post_images/916/d22/428/916d224282a3020dc31df6c67a18b070.png" alt="ุงูุตูุฑุฉ"></p><br><p style=";text-align:right;direction:rtl">  ุจุงููุณุจุฉ ูููุฌููุนุงุช ุงูุตุบูุฑุฉ ุ ูููู ูุฐุง ุงูููุฌ ุฃุจุทุฃ ูู ุงูุทุฑููุฉ ุงูุฃููู.  ูููุฃูุจุฑ - 2 ูุฑุงุช ุฃุณุฑุน.  ููู ุงููุซูุฑ ููุงูุชูุงู ุ ุชู ุฅูุดุงุก 4 ูุคุดุฑุงุช ุชุฑุงุจุท ุนูู ุงูุฌูุงุฒ ุงูุฎุงุต ุจู ุ ูููู ูุฐุง ูู ูุคุฏู ุฅูู ุชุณุงุฑุน 4x.  ูุดูุฑ ูุฐุง ุฅูู ุฃู ุงูุญูู ูู ูุฐู ุงูุทุฑููุฉ ููู: ูู ุฌุงูุจ ุงูุนููู ููู ุฌุงูุจ ุงูุฎุงุฏู.  ุฒุงุฏ ุงุณุชููุงู ุงูุฐุงูุฑุฉ ุ ูููู ููุณ ุจุดูู ูุจูุฑ. </p><br><h4 id="sposob-3-multiple-contains" style=";text-align:right;direction:rtl">  ูุญุชูู ุงูุฃุณููุจ 3: ูุชุนุฏุฏุฉ </h4><br><p style=";text-align:right;direction:rtl">  ุญุงู ุงูููุช ูุชุฌุฑุจุฉ ุดูุก ุขุฎุฑ ููุญุงููุฉ ุชูููู ุงููููุฉ ุฅูู ุงุณุชุนูุงู ูุงุญุฏ.  ูููู ุงูููุงู ุจู ุนูู ุงููุญู ุงูุชุงูู: </p><br><ol style=";text-align:right;direction:rtl"><li style=";text-align:right;direction:rtl">  ุฅุนุฏุงุฏ 3 ูุฌููุนุงุช ูุฑูุฏุฉ ูู <em>ุดุฑูุท</em> ุ <em>PriceSourceId ุ</em> <em>ูุงูุชุงุฑูุฎ</em> </li><li style=";text-align:right;direction:rtl">  ูู ุจุชุดุบูู ุงูุทูุจ ูุงุณุชุฎุฏู 3 <em>Contains</em> </li><li style=";text-align:right;direction:rtl">  ุฅุนุงุฏุฉ ูุญุต ุงููุชุงุฆุฌ ูุญูููุง </li></ol><br><div class="spoiler" style=";text-align:right;direction:rtl">  <b class="spoiler_title">ุฑูุฒ ุงูุทุฑููุฉ ุงูุซุงูุซุฉ</b> <div class="spoiler_text" style=";text-align:right;direction:rtl"><pre style=";text-align:right;direction:rtl"> <code class="cpp hljs">var result = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> List&lt;Price&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> (var context = CreateContext()) { <span class="hljs-comment"><span class="hljs-comment">//   var tickers = TestData.Select(x =&gt; x.Ticker).Distinct().ToList(); var dates = TestData.Select(x =&gt; x.TradedOn).Distinct().ToList(); var ps = TestData.Select(x =&gt; x.PriceSourceId).Distinct().ToList(); //    3 Contains var data = context.Prices .Where(x =&gt; tickers.Contains(x.Security.Ticker) &amp;&amp; dates.Contains(x.TradedOn) &amp;&amp; ps.Contains(x.PriceSourceId)) .Select(x =&gt; new { Price = x, Ticker = x.Security.Ticker, }) .ToList(); var lookup = data.ToLookup(x =&gt; $"{x.Ticker}, {x.Price.TradedOn}, {x.Price.PriceSourceId}"); //  foreach (var el in TestData) { var key = $"{el.Ticker}, {el.TradedOn}, {el.PriceSourceId}"; result.AddRange(lookup[key].Select(x =&gt; x.Price)); } }</span></span></code> </pre> </div></div><br><p style=";text-align:right;direction:rtl">  ุงููุดููุฉ ููุง ูู ุฃู ููุช ุงูุชูููุฐ ูููุฏุงุฑ ุงูุจูุงูุงุช ุงูุชู ูุชู ุฅุฑุฌุงุนูุง ูุนุชูุฏุงู ุจุดูู ูุจูุฑ ุนูู ุงูุจูุงูุงุช ููุณูุง (ุณูุงุก ูู ุงูุงุณุชุนูุงู ุฃู ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช).  ุจูุนูู ุฃูู ูููู ุฅุฑุฌุงุน ูุฌููุนุฉ ูู ุงูุจูุงูุงุช ุงูุถุฑูุฑูุฉ ููุท ุ ููููู ุฅุฑุฌุงุน ุณุฌูุงุช ุฅุถุงููุฉ (ุญุชู 100 ูุฑุฉ ุฃูุซุฑ). </p><br><p style=";text-align:right;direction:rtl">  ูููู ุชูุณูุฑ ุฐูู ุจุงุณุชุฎุฏุงู ุงููุซุงู ุงูุชุงูู.  ุงูุชุฑุถ ุฃู ุงูุฌุฏูู ุงูุชุงูู ูุญุชูู ุนูู ุจูุงูุงุช: </p><br><p style=";text-align:right;direction:rtl"><img src="https://habrastorage.org/getpro/habr/post_images/f3f/2bb/ea5/f3f2bbea5148127963cab9010d2b2f10.png" alt="ุงูุตูุฑุฉ"></p><br><p style=";text-align:right;direction:rtl">  ูููุชุฑุถ ุฃูุถูุง ุฃููู ุจุญุงุฌุฉ ุฅูู ุฃุณุนุงุฑ <em>Ticker1</em> ูุน <em>TradedOn</em> = <em>2018-01-01</em> ู <em>Ticker2</em> ูุน <em>TradedOn</em> = <em>2018-01-02</em> . </p><br><p style=";text-align:right;direction:rtl">  ุซู ุงูููู ุงููุฑูุฏุฉ ูู <em>Ticker</em> = ( <em>Ticker1</em> ุ <em>Ticker2</em> ) <br>  ูุงูููู ุงููุฑูุฏุฉ ูู <em>TradedOn</em> = ( <em>2018-01-01</em> ุ <em>2018-01-02</em> ) </p><br><p style=";text-align:right;direction:rtl">  ููุน ุฐูู ุ ุณูุชู ุฅุฑุฌุงุน 4 ุณุฌูุงุช ูุชูุฌุฉ ูุฐูู ุ ูุฃููุง ุชุชูุงูู ุญููุง ูุน ูุฐู ุงููุฌููุนุงุช.  ุงูุฃูุฑ ุงูุณูุฆ ูู ุฃูู ูููุง ุชู ุงุณุชุฎุฏุงู ุงููุฒูุฏ ูู ุงูุญููู ุ ุฒุงุฏุช ูุฑุตุฉ ุงูุญุตูู ุนูู ุณุฌูุงุช ุฅุถุงููุฉ ูุชูุฌุฉ ูุฐูู. </p><br><p style=";text-align:right;direction:rtl">  ููุฐุง ุงูุณุจุจ ุ ูุฌุจ ุชุตููุฉ ุงูุจูุงูุงุช ุงูุชู ุชู ุงูุญุตูู ุนูููุง ุจูุฐู ุงูุทุฑููุฉ ุจุงูุฅุถุงูุฉ ุฅูู ุฐูู ูู ุฌุงูุจ ุงูุนููู.  ููุฐุง ูู ุฃูุจุฑ ุนูุจ. <br>  ุงูููุงููุณ ูู ููุง ููู: </p><br><p style=";text-align:right;direction:rtl"><img src="https://habrastorage.org/getpro/habr/post_images/dd5/078/5ef/dd50785efd38900c4d18467607b87a1e.png" alt="ุงูุตูุฑุฉ"></p><br><p style=";text-align:right;direction:rtl">  ุงุณุชููุงู ุงูุฐุงูุฑุฉ ุฃุณูุฃ ูู ุฌููุน ุงูุทุฑู ุงูุณุงุจูุฉ.  ุนุฏุฏ ุงูุฃุณุทุฑ ุงูููุฑูุกุฉ ุฃูุจุฑ ุจูุซูุฑ ูู ุงูุนุฏุฏ ุงููุทููุจ.  ุชูุช ููุงุทุนุฉ ุงุฎุชุจุงุฑุงุช ุงููุฌููุนุงุช ุงููุจูุฑุฉ ูุฃููุง ุงุณุชูุฑุช ูุฃูุซุฑ ูู 10 ุฏูุงุฆู.  ูุฐู ุงูุทุฑููุฉ ููุณุช ุฌูุฏุฉ. </p><br><h4 id="sposob-4-predicate-builder" style=";text-align:right;direction:rtl">  ุทุฑููุฉ 4. ุงููุณูุฏ ุงูุจูุงุก </h4><br><p style=";text-align:right;direction:rtl">  ููุฌุฑุจูุง ุนูู ุงูุฌุงูุจ ุงูุขุฎุฑ: <em>ุงูุชุนุจูุฑ</em> ุงููุฏูู ุงูุฌูุฏ.  ุจุงุณุชุฎุฏุงููู ุ ููููู ุฅูุดุงุก ุงุณุชุนูุงู ูุจูุฑ ูุงุญุฏ ูู ุงููููุฐุฌ ุงูุชุงูู: </p><br><p style=";text-align:right;direction:rtl"> <code>โฆ (.. AND .. AND ..) OR (.. AND .. AND ..) OR (.. AND .. AND ..) โฆ</code> </p> <br><p style=";text-align:right;direction:rtl">  ูุฐุง ูุนุทู ุงูุฃูู ูู ุฃูู ุณูููู ูู ุงููููู ุจูุงุก ุทูุจ ูุงุญุฏ ูุงูุญุตูู ุนูู ุงูุจูุงูุงุช ุงูุถุฑูุฑูุฉ ููุท ูููุงููุฉ ูุงุญุฏุฉ.  ุงูุฑูุฒ: </p><br><div class="spoiler" style=";text-align:right;direction:rtl">  <b class="spoiler_title">ุฑูุฒ ุงูุทุฑููุฉ ุงูุฑุงุจุนุฉ</b> <div class="spoiler_text" style=";text-align:right;direction:rtl"><pre style=";text-align:right;direction:rtl"> <code class="cpp hljs">var result = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> List&lt;Price&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> (var context = CreateContext()) { var baseQuery = from p in context.Prices join s in context.Securities on p.SecurityId equals s.SecurityId select <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> TestData() { Ticker = s.Ticker, TradedOn = p.TradedOn, PriceSourceId = p.PriceSourceId, PriceObject = p }; var tradedOnProperty = typeof(TestData).GetProperty(<span class="hljs-string"><span class="hljs-string">"TradedOn"</span></span>); var priceSourceIdProperty = typeof(TestData).GetProperty(<span class="hljs-string"><span class="hljs-string">"PriceSourceId"</span></span>); var tickerProperty = typeof(TestData).GetProperty(<span class="hljs-string"><span class="hljs-string">"Ticker"</span></span>); var paramExpression = Expression.Parameter(typeof(TestData)); Expression wholeClause = null; foreach (var td in TestData) { var elementClause = Expression.AndAlso( Expression.Equal( Expression.MakeMemberAccess( paramExpression, tradedOnProperty), Expression.Constant(td.TradedOn) ), Expression.AndAlso( Expression.Equal( Expression.MakeMemberAccess( paramExpression, priceSourceIdProperty), Expression.Constant(td.PriceSourceId) ), Expression.Equal( Expression.MakeMemberAccess( paramExpression, tickerProperty), Expression.Constant(td.Ticker)) )); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (wholeClause == null) wholeClause = elementClause; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> wholeClause = Expression.OrElse(wholeClause, elementClause); } var query = baseQuery.Where( (Expression&lt;Func&lt;TestData, <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span>&gt;&gt;)Expression.Lambda( wholeClause, paramExpression)).Select(x =&gt; x.PriceObject); result.AddRange(query); }</code> </pre> </div></div><br><p style=";text-align:right;direction:rtl">  ููุฏ ุชุจูู ุฃู ุงูุดูุฑุฉ ุฃูุซุฑ ุชุนููุฏูุง ููุง ูุงูุช ุนููู ูู ุงูุทุฑู ุงูุณุงุจูุฉ.  ุจูุงุก <em>ุชุนุจูุฑ</em> ูุฏูู ููุณ ุฃุณูู ูุฃุณุฑุน ุนูููุฉ. </p><br><p style=";text-align:right;direction:rtl">  ุงูููุงููุณ: </p><br><p style=";text-align:right;direction:rtl"><img src="https://habrastorage.org/getpro/habr/post_images/312/373/4fc/3123734fc82c4fc4d783f4f9ce2cf225.png" alt="ุงูุตูุฑุฉ"></p><br><p style=";text-align:right;direction:rtl">  ุงููุชุงุฆุฌ ุงููุคูุชุฉ ูุงูุช ุฃุณูุฃ ููุง ูุงูุช ุนููู ูู ุงูุทุฑููุฉ ุงูุณุงุจูุฉ.  ูุจุฏู ุฃู ุงููููุงุช ุงูุนุงูุฉ ุฃุซูุงุก ุงูุจูุงุก ูุนูุฏ ุงููุดู ุนุจุฑ ุงูุดุฌุฑุฉ ุชุจูู ุฃููุง ุฃูุซุฑ ุจูุซูุฑ ูู ุงูููุณุจ ูู ุงุณุชุฎุฏุงู ุทูุจ ูุงุญุฏ. </p><br><h4 id="sposob-5-shared-query-data-table" style=";text-align:right;direction:rtl">  ุงูุทุฑููุฉ ุงูุฎุงูุณุฉ: ุฌุฏูู ุจูุงูุงุช ุงูุงุณุชุนูุงู ุงููุดุชุฑู </h4><br><p style=";text-align:right;direction:rtl">  ููุฌุฑุจ ุฎูุงุฑูุง ุขุฎุฑ: <br>  ููุฏ ููุช ุจุฅูุดุงุก ุฌุฏูู ุฌุฏูุฏ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช ุญูุซ ุณุฃูุชุจ ุงูุจูุงูุงุช ุงููุงุฒูุฉ ูุฅููุงู ุงูุทูุจ (ุถููููุง ุฃุญุชุงุฌ ุฅูู <em>DbSet</em> ุฌุฏูุฏ ูู ุงูุณูุงู). </p><br><p style=";text-align:right;direction:rtl">  ุงูุขู ุ ููุญุตูู ุนูู ุงููุชูุฌุฉ ุงูุชู ุชุญุชุงุฌูุง: </p><br><ol style=";text-align:right;direction:rtl"><li style=";text-align:right;direction:rtl">  ุจุฏุก ุงููุนุงููุฉ </li><li style=";text-align:right;direction:rtl">  ุชุญููู ุจูุงูุงุช ุงูุงุณุชุนูุงู ุฅูู ุฌุฏูู ุฌุฏูุฏ </li><li style=";text-align:right;direction:rtl">  ูู ุจุชุดุบูู ุงูุงุณุชุนูุงู ููุณู (ุจุงุณุชุฎุฏุงู ุงูุฌุฏูู ุงูุฌุฏูุฏ) </li><li style=";text-align:right;direction:rtl">  ุงุณุชุฑุฌุงุน ูุนุงููุฉ (ููุณุญ ุฌุฏูู ุงูุจูุงูุงุช ููุงุณุชุนูุงูุงุช) </li></ol><br><p style=";text-align:right;direction:rtl">  ุงูุฑูุฒ ูุดุจู ูุฐุง: </p><br><div class="spoiler" style=";text-align:right;direction:rtl">  <b class="spoiler_title">ุฑูุฒ ุงูุทุฑููุฉ 5</b> <div class="spoiler_text" style=";text-align:right;direction:rtl"><pre style=";text-align:right;direction:rtl"> <code class="cpp hljs">var result = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> List&lt;Price&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> (var context = CreateContext()) { context.Database.BeginTransaction(); var reducedData = TestData.Select(x =&gt; <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SharedQueryModel() { PriceSourceId = x.PriceSourceId, Ticker = x.Ticker, TradedOn = x.TradedOn }).ToList(); <span class="hljs-comment"><span class="hljs-comment">//      context.QueryDataShared.AddRange(reducedData); context.SaveChanges(); var query = from p in context.Prices join s in context.Securities on p.SecurityId equals s.SecurityId join t in context.QueryDataShared on new { s.Ticker, p.TradedOn, p.PriceSourceId } equals new { t.Ticker, t.TradedOn, t.PriceSourceId } select p; result.AddRange(query); context.Database.RollbackTransaction(); }</span></span></code> </pre> </div></div><br><p style=";text-align:right;direction:rtl">  ุงูููุงููุณ ุงูุฃููู: </p><br><p style=";text-align:right;direction:rtl"><img src="https://habrastorage.org/getpro/habr/post_images/df0/ab7/d7d/df0ab7d7d01b0aeaeebf2b9a41f5e75b.png" alt="ุงูุตูุฑุฉ"></p><br><p style=";text-align:right;direction:rtl">  ุฌููุน ุงูุงุฎุชุจุงุฑุงุช ุนููุช ูุนููุช ุจุณุฑุนุฉ!  ุงุณุชููุงู ุงูุฐุงูุฑุฉ ููุจูู ุฃูุถุง. <br>  ูุจุงูุชุงูู ุ ูู ุฎูุงู ุงุณุชุฎุฏุงู ูุนุงููุฉ ุ ูููู ุงุณุชุฎุฏุงู ูุฐุง ุงูุฌุฏูู ูู ููุช ูุงุญุฏ ูู ุฎูุงู ุนุฏุฉ ุนูููุงุช.  ูุธุฑูุง ูุฃู ูุฐุง ุฌุฏูู ููุฌูุฏ ุจุงููุนู ุ ูุฅู ุฌููุน ููุฒุงุช <em>Entity Framework</em> ูุชุงุญุฉ ููุง: ูุง ุนููู ุณูู ุชุญููู ุงูุจูุงูุงุช ูู ุงูุฌุฏูู ุ ูุจูุงุก ุงุณุชุนูุงู ุจุงุณุชุฎุฏุงู <em>JOIN</em> ูุชูููุฐู.  ูููููุฉ ุงูุฃููู ุ ูุฐุง ูู ูุง ุชุญุชุงุฌู ุ ูููู ููุงู ุนููุจ ูุจูุฑุฉ: </p><br><ul style=";text-align:right;direction:rtl"><li style=";text-align:right;direction:rtl">  ูุฌุจ ุนููู ุฅูุดุงุก ุฌุฏูู ูููุน ูุนูู ูู ุงูุงุณุชุนูุงู </li><li style=";text-align:right;direction:rtl">  ูู ุงูุถุฑูุฑู ุงุณุชุฎุฏุงู ุงููุนุงููุงุช (ูุฅูุฏุงุฑ ููุงุฑุฏ ูุธู ุฅุฏุงุฑุฉ ููุงุนุฏ ุงูุจูุงูุงุช ุนูููุง) </li><li style=";text-align:right;direction:rtl">  ูููุฑุฉ ุฃูู ุชุญุชุงุฌ ุฅูู ูุชุงุจุฉ ุดูุก ูุง ุ ุนูุฏูุง ุชุญุชุงุฌ ุฅูู ูุฑุงุกุฉ ุ ุชุจุฏู ุบุฑูุจุฉ.  ูุนูู ูุฑุงุกุฉ ุงููุณุฎุฉ ุงููุชูุงุซูุฉ ุ ูุฅูู ูู ููุฌุญ. <br>  ูุงูุจุงูู ูู ุญู ุนููู ุฃูุซุฑ ุฃู ุฃูู ูููู ุงุณุชุฎุฏุงูู ุจุงููุนู. </li></ul><br><h4 id="sposob-6-memoryjoin-extension" style=";text-align:right;direction:rtl">  ุงูุทุฑููุฉ 6. ุชูุฏูุฏ MemoryJoin </h4><br><p style=";text-align:right;direction:rtl">  ุงูุขู ููููู ูุญุงููุฉ ุชุญุณูู ุงูููุฌ ุงูุณุงุจู.  ุงูุฃููุงุฑ ูู: </p><br><ul style=";text-align:right;direction:rtl"><li style=";text-align:right;direction:rtl">  ุจุฏูุงู ูู ุงุณุชุฎุฏุงู ุฌุฏูู ุฎุงุต ุจููุน ูุงุญุฏ ูู ุงูุงุณุชุนูุงู ุ ููููู ุงุณุชุฎุฏุงู ุฎูุงุฑ ูุนูู.  ููู ุฅูุดุงุก ุฌุฏูู ุจุงุณู ูุซู <em>Shared_query_data</em> ุ ูุฅุถุงูุฉ ุงูุนุฏูุฏ ูู ุญููู <em>Guid</em> ุ ูุงูุนุฏูุฏ ูู <em>Long</em> ุ <em>String</em> ุ ุฅูุฎ.  ูููู ุฃุฎุฐ ุฃุณูุงุก ุจุณูุทุฉ: <em>Guid1</em> ุ <em>Guid2</em> ุ <em>String1</em> ุ <em>Long1</em> ุ <em>Date2</em> ุ ุฅูุฎ.  ุซู ูููู ุงุณุชุฎุฏุงู ูุฐุง ุงูุฌุฏูู ูู 95ูช ูู ุฃููุงุน ุงูุงุณุชุนูุงู.  ูููู "ุชุนุฏูู" ุฃุณูุงุก ุงูุนูุงุฑุงุช ูุงุญููุง ุจุงุณุชุฎุฏุงู ููุธูุฑ <strong>ุงูุชุญุฏูุฏ</strong> . </li><li style=";text-align:right;direction:rtl">  ุจุนุฏ ุฐูู ุ ุชุญุชุงุฌ ุฅูู ุฅุถุงูุฉ <em>DbSet</em> ูู <em>Shared_query_data</em> . </li><li style=";text-align:right;direction:rtl">  ูููู ูุงุฐุง ูู ุ ุจุฏูุงู ูู ูุชุงุจุฉ ุงูุจูุงูุงุช ุฅูู ูุงุนุฏุฉ ุงูุจูุงูุงุช ุ ุชูุฑูุฑ ุงูููู ุจุงุณุชุฎุฏุงู <strong>VALUES</strong> ุ  ุฃู ุฃูู ูู ุงูุถุฑูุฑู ุฃู <strong>ูุชู ุงุณุชุฎุฏุงู</strong> ูุฏุงุก ุฅูู <strong>VALUES ูู</strong> ุงุณุชุนูุงู SQL ุงูููุงุฆู ุ ุจุฏูุงู ูู ุงููุตูู ุฅูู <em>Shared_query_data</em> .  ููู ููุนู ุฐููุ <br><ul style=";text-align:right;direction:rtl"><li style=";text-align:right;direction:rtl">  ูู Entity Framework Core - ููุท ุจุงุณุชุฎุฏุงู <em>FromSql</em> . </li><li style=";text-align:right;direction:rtl">  ูู Entity Framework 6 - ูุฌุจ ุนููู ุงุณุชุฎุฏุงู <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">DbInterception</a> - ุฃู ุชุบููุฑ SQL ุงูุฐู ุชู ุฅูุดุงุคู ุนู ุทุฑูู ุฅุถุงูุฉ ุจููุฉ <strong>VALUES</strong> ูุจู ุงูุชูููุฐ ูุจุงุดุฑุฉ.  ุณูุคุฏู ุฐูู ุฅูู ูุฌูุฏ ูููุฏ: ูู ุทูุจ ูุงุญุฏ ุ ูุง ููุฌุฏ ุฃูุซุฑ ูู ุจููุฉ <strong>VALUES</strong> .  ููููุง ุณุชุนูู! </li></ul></li><li style=";text-align:right;direction:rtl">  ูุธุฑูุง ูุฃููุง ูู ููุชุจ ุฅูู ูุงุนุฏุฉ ุงูุจูุงูุงุช ุ <em>ูุณูุญุตู ุนูู</em> ุฌุฏูู ุงูุจูุงูุงุช <em>ุงููุดุชุฑูุฉ Shared_query_data ุงูุฐู</em> ุชู ุฅูุดุงุคู ูู ุงูุฎุทูุฉ ุงูุฃููู ุ ุฃููุณ ููุงู ุญุงุฌุฉ ุนูู ุงูุฅุทูุงูุ  ุงูุฅุฌุงุจุฉ: ูุนู ุ ููุณุช ููุงู ุญุงุฌุฉ ุ ูููู ูุง ุชุฒุงู ููุงู ุญุงุฌุฉ ุฅูู <em>DbSet</em> ุ ูุฃู ุฅุทุงุฑ ุนูู ุงูููุงู ูุฌุจ ุฃู ูุนุฑู ูุธุงู ุงูุจูุงูุงุช ูู ุฃุฌู ุจูุงุก ุงูุงุณุชุนูุงูุงุช.  ุงุชุถุญ ุฃููุง ูุญุชุงุฌ ุฅูู <em>DbSet</em> ูุจุนุถ ุงูููุงุฐุฌ ุงููุนููุฉ ุบูุฑ ุงูููุฌูุฏุฉ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช ููุชู ุงุณุชุฎุฏุงููุง ููุท ูุฅููุงู Entity Framework ุ ููู ุชุนุฑู ูุง ุชููู ุจู. </li></ul><br><div class="spoiler" style=";text-align:right;direction:rtl">  <b class="spoiler_title">ุชุญููู IEnumerable ุฅูู ูุซุงู IQueryable</b> <div class="spoiler_text" style=";text-align:right;direction:rtl"><ol style=";text-align:right;direction:rtl"><li style=";text-align:right;direction:rtl">  ุชููู ุงูุฅุฏุฎุงู ูุฌููุนุฉ ูู ุงููุงุฆูุงุช ูู ุงูููุน ุงูุชุงูู: <br><pre style=";text-align:right;direction:rtl"> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SomeQueryData</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-built_in"><span class="hljs-built_in">string</span></span> Ticker {get; <span class="hljs-built_in"><span class="hljs-built_in">set</span></span>;} <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> DateTimeTradedOn {get; <span class="hljs-built_in"><span class="hljs-built_in">set</span></span>;} <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> PriceSourceId {get; <span class="hljs-built_in"><span class="hljs-built_in">set</span></span>;} }</code> </pre> </li><li style=";text-align:right;direction:rtl">  ูุฏููุง ุชุญุช <em>ุชุตุฑููุง DbSet</em> ูุน ุงูุญููู <em>String1</em> ุ <em>String2</em> ุ <em>Date1</em> ุ <em>Long1</em> ุ <em>ุฅูุฎ</em> </li><li style=";text-align:right;direction:rtl">  ุงุณูุญ ููุชู ุชุฎุฒูู <em>Ticker</em> ูู <em>String1</em> ู <em>TradedOn</em> ูู <em>Date1</em> ู <em>PriceSourceId</em> ูู <em>Long1</em> (mapps <em>ุทูููุฉ</em> ุ ุญุชู ูุง ุชุฌุนู ุงูุญููู ูููุตูุฉ ููุซูุฑุฉ) </li><li style=";text-align:right;direction:rtl">  ุซู <em>ุณูููู FromSql</em> + <em>VALUES</em> ูุซู ูุฐุง: <br><pre style=";text-align:right;direction:rtl"> <code class="cpp hljs">var query = context.QuerySharedData.FromSql( <span class="hljs-string"><span class="hljs-string">"SELECT * FROM ( VALUES (1, 'Ticker1', @date1, @id1), (2, 'Ticker2', @date2, @id2) ) AS __gen_query_data__ (id, string1, date1, long1)"</span></span>)</code> </pre> </li><li style=";text-align:right;direction:rtl">  ููููู ุงูุขู ุชูุฏูู ุนุฑุถ ูุฅุฑุฌุงุน <em>IQueryable</em> ุจุงุณุชุฎุฏุงู ููุณ ุงูููุน ุงูุฐู ูุงู ุนูุฏ ุงูุฅุฏุฎุงู: <br><pre style=";text-align:right;direction:rtl"> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">return</span></span> query.Select(x =&gt; <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SomeQueryData() { Ticker = x.String1, TradedOn = x.Date1, PriceSourceId = (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>)x.Long1 });</code> </pre> </li></ol></div></div><br><p style=";text-align:right;direction:rtl">  ุชูููุช ูู ุชูููุฐ ูุฐุง ุงูููุฌ ูุญุชู ุชุตูููู ูุญุฒูุฉ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">NuGet EntityFrameworkCore.MemoryJoin</a> ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">ุชุชููุฑ</a> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">ุงูููุฏ</a> ุฃูุถูุง).  ุนูู ุงูุฑุบู ูู ุญูููุฉ ุฃู ุงูุงุณู ูุญุชูู ุนูู ุงููููุฉ <em>ุงูุฃุณุงุณูุฉ</em> ุ ูุชู ุฏุนู <em>Entity Framework</em> 6 ุฃูุถูุง.  ุฏุนูุชูุง <strong>MemoryJoin</strong> ุ ููููุง ูู ุงููุงูุน ุชุฑุณู ุจูุงูุงุช ูุญููุฉ ุฅูู ููุงุนุฏ ุจูุงูุงุช ุฅุฏุงุฑุฉ ููุงุนุฏ ุงูุจูุงูุงุช ูู ุจูุงุก <em>ุงูููู</em> ููุชู ูู ุงูุนูู ุนูููุง. </p><br><p style=";text-align:right;direction:rtl">  ุงูููุฏ ููุง ููู: </p><br><div class="spoiler" style=";text-align:right;direction:rtl">  <b class="spoiler_title">ุฑูุฒ ุงูุทุฑููุฉ 6</b> <div class="spoiler_text" style=";text-align:right;direction:rtl"><pre style=";text-align:right;direction:rtl"> <code class="cpp hljs">var result = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> List&lt;Price&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> (var context = CreateContext()) { <span class="hljs-comment"><span class="hljs-comment">// :    ,      var reducedData = TestData.Select(x =&gt; new { x.Ticker, x.TradedOn, x.PriceSourceId }).ToList(); //  IEnumerable&lt;&gt;   IQueryable&lt;&gt; var queryable = context.FromLocalList(reducedData); var query = from p in context.Prices join s in context.Securities on p.SecurityId equals s.SecurityId join t in queryable on new { s.Ticker, p.TradedOn, p.PriceSourceId } equals new { t.Ticker, t.TradedOn, t.PriceSourceId } select p; result.AddRange(query); }</span></span></code> </pre> </div></div><br><p style=";text-align:right;direction:rtl">  ุงูููุงููุณ: </p><br><p style=";text-align:right;direction:rtl"><img src="https://habrastorage.org/getpro/habr/post_images/6a7/d72/bb2/6a7d72bb265d9dedbc8e54d94fe16a4f.png" alt="ุงูุตูุฑุฉ"></p><br><p style=";text-align:right;direction:rtl">  ูุฐู ูู ุฃูุถู ูุชูุฌุฉ ุฌุฑุจุชูุง ุนูู ุงูุฅุทูุงู.  ูุงู ุงูุฑูุฒ ุจุณูุทูุง ุฌุฏูุง ููุจุงุดุฑูุง ุ ููู ุงูููุช ููุณู ูุงู ูุนูู ูู ุฃุฌู ูุฑุงุกุฉ ุงููุณุฎุฉ ุงููุชูุงุซูุฉ. </p><br><div class="spoiler" style=";text-align:right;direction:rtl">  <b class="spoiler_title">ูุซุงู ุนูู ุทูุจ ุชู ุฅูุดุงุคู ูุงุณุชูุงู 3 ุนูุงุตุฑ</b> <div class="spoiler_text" style=";text-align:right;direction:rtl"><pre style=";text-align:right;direction:rtl"> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-string"><span class="hljs-string">"p"</span></span>.<span class="hljs-string"><span class="hljs-string">"PriceId"</span></span>, <span class="hljs-string"><span class="hljs-string">"p"</span></span>.<span class="hljs-string"><span class="hljs-string">"ClosePrice"</span></span>, <span class="hljs-string"><span class="hljs-string">"p"</span></span>.<span class="hljs-string"><span class="hljs-string">"OpenPrice"</span></span>, <span class="hljs-string"><span class="hljs-string">"p"</span></span>.<span class="hljs-string"><span class="hljs-string">"PriceSourceId"</span></span>, <span class="hljs-string"><span class="hljs-string">"p"</span></span>.<span class="hljs-string"><span class="hljs-string">"SecurityId"</span></span>, <span class="hljs-string"><span class="hljs-string">"p"</span></span>.<span class="hljs-string"><span class="hljs-string">"TradedOn"</span></span>, <span class="hljs-string"><span class="hljs-string">"t"</span></span>.<span class="hljs-string"><span class="hljs-string">"Ticker"</span></span>, <span class="hljs-string"><span class="hljs-string">"t"</span></span>.<span class="hljs-string"><span class="hljs-string">"TradedOn"</span></span>, <span class="hljs-string"><span class="hljs-string">"t"</span></span>.<span class="hljs-string"><span class="hljs-string">"PriceSourceId"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> <span class="hljs-string"><span class="hljs-string">"Price"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-string"><span class="hljs-string">"p"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INNER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> <span class="hljs-string"><span class="hljs-string">"Security"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-string"><span class="hljs-string">"s"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-string"><span class="hljs-string">"p"</span></span>.<span class="hljs-string"><span class="hljs-string">"SecurityId"</span></span> = <span class="hljs-string"><span class="hljs-string">"s"</span></span>.<span class="hljs-string"><span class="hljs-string">"SecurityId"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INNER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-string"><span class="hljs-string">"x"</span></span>.<span class="hljs-string"><span class="hljs-string">"string1"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-string"><span class="hljs-string">"Ticker"</span></span>, <span class="hljs-string"><span class="hljs-string">"x"</span></span>.<span class="hljs-string"><span class="hljs-string">"date1"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-string"><span class="hljs-string">"TradedOn"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">CAST</span></span>(<span class="hljs-string"><span class="hljs-string">"x"</span></span>.<span class="hljs-string"><span class="hljs-string">"long1"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> int4) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-string"><span class="hljs-string">"PriceSourceId"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (<span class="hljs-number"><span class="hljs-number">1</span></span>, @__gen_q_p0, @__gen_q_p1, @__gen_q_p2), (<span class="hljs-number"><span class="hljs-number">2</span></span>, @__gen_q_p3, @__gen_q_p4, @__gen_q_p5), (<span class="hljs-number"><span class="hljs-number">3</span></span>, @__gen_q_p6, @__gen_q_p7, @__gen_q_p8) ) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> __gen_query_data__ (<span class="hljs-keyword"><span class="hljs-keyword">id</span></span>, string1, date1, long1) ) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-string"><span class="hljs-string">"x"</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-string"><span class="hljs-string">"t"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> ((<span class="hljs-string"><span class="hljs-string">"s"</span></span>.<span class="hljs-string"><span class="hljs-string">"Ticker"</span></span> = <span class="hljs-string"><span class="hljs-string">"t"</span></span>.<span class="hljs-string"><span class="hljs-string">"Ticker"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> (<span class="hljs-string"><span class="hljs-string">"p"</span></span>.<span class="hljs-string"><span class="hljs-string">"PriceSourceId"</span></span> = <span class="hljs-string"><span class="hljs-string">"t"</span></span>.<span class="hljs-string"><span class="hljs-string">"PriceSourceId"</span></span>)</code> </pre> <br><p style=";text-align:right;direction:rtl">  ููุง ููููู ุฃูุถูุง ุฑุคูุฉ ููู ูุชุญูู ุงููููุฐุฌ ุงููุนูู (ูุน ุงูุญููู <em>String1</em> ู <em>Date1</em> ู <em>Long1</em> ) ุจุงุณุชุฎุฏุงู Select ุฅูู ุงููููุฐุฌ ุงููุณุชุฎุฏู ูู ุงูููุฏ (ูุน ุงูุญููู <em>Ticker</em> ู <em>TradedOn</em> ู <em>PriceSourceId</em> ). </p></div></div><br><p style=";text-align:right;direction:rtl">  ูู ุงูุนูู ูุชู ูู ุงุณุชุนูุงู ูุงุญุฏ ุนูู ุฎุงุฏู SQL.  ููุฐู ููุงูุฉ ุณุนูุฏุฉ ุตุบูุฑุฉ ุ ุชุญุฏุซุช ุนููุง ูู ุงูุจุฏุงูุฉ.  ููุน ุฐูู ุ ูุฅู ุงุณุชุฎุฏุงู ูุฐู ุงูุทุฑููุฉ ูุชุทูุจ ููู ูุงูุฎุทูุงุช ุงูุชุงููุฉ: </p><br><ul style=";text-align:right;direction:rtl"><li style=";text-align:right;direction:rtl">  ุชุญุชุงุฌ ุฅูู ุฅุถุงูุฉ <em>DbSet</em> ุฅุถุงููุฉ ุฅูู ุงูุณูุงู ุงูุฎุงุต ุจู (ุนูู ุงูุฑุบู ูู ุฃูู ูููู <em>ุญุฐู</em> ุงูุฌุฏูู ููุณู) </li><li style=";text-align:right;direction:rtl">  ูู ุงููููุฐุฌ ุงููุนูู ุ ูุงูุฐู ูุชู ุงุณุชุฎุฏุงูู ุงูุชุฑุงุถููุง ุ ูุชู ุงูุฅุนูุงู ุนู 3 ุญููู ูู ุฃููุงุน <em>Guid</em> ู <em>String</em> ู <em>Double</em> ู <em>Long</em> ู <em>Date</em> ุ ุฅูุฎ.  ูุฌุจ ุฃู ูููู ุฐูู ูุงูููุง ูู 95ูช ูู ุฃููุงุน ุงูุทูุจุงุช.  ูุฅุฐุง ููุช ุจุชูุฑูุฑ ูุฌููุนุฉ ูู ุงููุงุฆูุงุช ุฐุงุช 20 ุญูููุง ุฅูู <em>FromLocalList</em> ุ ูุณูุชู ุทุฑุญ <em>ุงุณุชุซูุงุก</em> ูุงุฆูุงู ุฅู ุงููุงุฆู ูุนูุฏ ููุบุงูุฉ.  ูุฐุง ุชูููุฏ ุจุณูุท ููููู ุงูุชุญุงูู ุนููู - ููููู ุฅุนูุงู ููุนู ูุฅุถุงูุฉ 100 ุญูู ุนูู ุงูุฃูู ููุงู.  ููุน ุฐูู ุ ุงููุฒูุฏ ูู ุงูุญููู ุฃุจุทุฃ ูู ุงูุนูู. </li><li style=";text-align:right;direction:rtl">  ููุฑุฏ ุงููุฒูุฏ ูู ุงูุชูุงุตูู ุงูุชูููุฉ ูู ููุงูุชู. </li></ul><br><h2 id="zaklyuchenie" style=";text-align:right;direction:rtl">  ุงูุฎุงุชูุฉ </h2><br><p style=";text-align:right;direction:rtl">  ูู ูุฐู ุงูููุงูุฉ ุ ูุฏูุช ุฃููุงุฑู ุญูู ููุถูุน JOIN local collection ู DbSet.  ุจุฏุง ูู ุฃู <em>ุชุทูุฑู</em> ุจุงุณุชุฎุฏุงู <em>ุงูููู</em> ูุฏ ูููู ุฐุง ุฃูููุฉ ูููุฌุชูุน.  ุนูู ุงูุฃูู ุ ูู ุฃูุงุฌู ูุซู ูุฐุง ุงูููุฌ ุนูุฏูุง ุญููุช ูุฐู ุงููุดููุฉ ุจููุณู.  ุดุฎุตููุง ุ ุณุงุนุฏุชูู ูุฐู ุงูุทุฑููุฉ ูู ุงูุชุบูุจ ุนูู ุนุฏุฏ ูู ูุดููุงุช ุงูุฃุฏุงุก ูู ูุดุงุฑูุนู ุงูุญุงููุฉ ุ ูุฑุจูุง ูุณุงุนุฏู ุฐูู ุฃูุถูุง. </p><br><p style=";text-align:right;direction:rtl">  ุณูููู ุดุฎุต ูุง ุฃู ุงุณุชุฎุฏุงู <em>MemoryJoin</em> "ููุฑุท" ููุบุงูุฉ ูุฃูู ูุญุชุงุฌ ุฅูู ูุฒูุฏ ูู ุงูุชุทููุฑ ุ ูุญุชู ุฐูู ุงูุญูู ูุง ุชุญุชุงุฌ ุฅูู ุงุณุชุฎุฏุงูู.  ูุฐุง ูู ุจุงูุถุจุท ุงูุณุจุจ ูู ุฃููู ููุช ูุดููููุง ููู ููุบุงูุฉ ููู ุฃูุชุจ ูุฐุง ุงูููุงู ููุฏุฉ ุนุงู ุชูุฑูุจูุง.  ุฃูุงูู ุนูู ุฃููู ุฃุฑูุฏ ุฃู ูููู ุงูุนูู ุฃุณูู (ุขูู ุฃู ูุญุฏุซ ุฐูู ููููุง ูุง) ุ ููููู ุฃููู ุฃูุถูุง ุฃู ุงูุชุญุณูู ูู ููู ุฃุจุฏูุง ูููุฉ ุฌููููุฑุฒ.  ูุชุทูุจ ุงูุชุญุณูู ุฏุงุฆููุง ููู ููููุฉ ุนูู ุงูุฃุฏุงุฉ.  ูุฅุฐุง ูุงูุช ููุงู ูุฑุตุฉ ููุญุตูู ุนูู ุชุณุฑูุน ุจูุณุจุฉ 8 ูุฑุงุช ุชูุฑูุจูุง ( <em>Naive Parallel</em> vs <em>MemoryJoin</em> ) ุ ูุณูู ุฃุชูู 2 ููุทุฉ ููุซุงุฆู. </p><br><p style=";text-align:right;direction:rtl">  ูุฃุฎูุฑุง ุ ุงูุฑุณูู ุงูุจูุงููุฉ: </p><br><p style=";text-align:right;direction:rtl">  ุงูููุช ุงูุฐู ููุถูู.  ุฃูููุช 4 ุทุฑู ููุท ุงููููุฉ ูู ุฃูู ูู 10 ุฏูุงุฆู ุ ู <em>MemoryJoin</em> ูู ุงูุทุฑููุฉ ุงููุญูุฏุฉ ุงูุชู ุฃูููุช ุงููููุฉ ูู ุฃูู ูู 10 ุซูุงูู. </p><br><p style=";text-align:right;direction:rtl"><img src="https://habrastorage.org/getpro/habr/post_images/720/256/846/72025684620477d221c0f113a6cb354f.png" alt="ุงูุตูุฑุฉ"></p><br><p style=";text-align:right;direction:rtl">  ุงุณุชููุงู ุงูุฐุงูุฑุฉ.  ุฃุธูุฑุช ุฌููุน ุงูุทุฑู ุชูุฑูุจูุง ููุณ ุงุณุชููุงู ุงูุฐุงูุฑุฉ ุ ุจุงุณุชุซูุงุก <em>ูุญุชููุงุช ูุชุนุฏุฏุฉ</em> .  ูุฐุง ูุฑุฌุน ุฅูู ูููุฉ ุงูุจูุงูุงุช ุงูุชู ุชู ุฅุฑุฌุงุนูุง. </p><br><p style=";text-align:right;direction:rtl"><img src="https://habrastorage.org/getpro/habr/post_images/e07/a91/b63/e07a91b63375d49a21adb81e8213ffdb.png" alt="ุงูุตูุฑุฉ"></p><br><p style=";text-align:right;direction:rtl">  ุดูุฑุง ูููุฑุงุกุฉ! </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/ar435810/">https://habr.com/ru/post/ar435810/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ar435798/index.html">Sony WH-1000XM3 - ุฃูุถู ุณูุงุนุงุช ุฑุฃุณ ูุงุณูููุฉุ</a></li>
<li><a href="../ar435800/index.html">ุฑุณุงูุฉ ุฏูุณูุจุฑูุณุช 11</a></li>
<li><a href="../ar435802/index.html">ุงููุณูุฌุฑ ุ ุงูุฐู ููุช ุชุนุฑู ุงููููู ุนูู</a></li>
<li><a href="../ar435804/index.html">ูุง ูุญูุธ Intel Cyclone ุงูุชูููู ุจุนุฏ ุฅุนุงุฏุฉ ุงูุชุดุบูู</a></li>
<li><a href="../ar435806/index.html">ุฃุนููุช ุงูุชุฌุงุฑุจ ุงูุณุฑูุฑูุฉ ูู ุฎููุท ุงูููุฏุณุฉ ุงูุญูููุฉ ุนูู ุงูููุจ ูู ุงููุงุจุงู</a></li>
<li><a href="../ar435812/index.html">ูุธุฑูุฉ ุงูุณุนุงุฏุฉ. ุงูุฅุญุตุงุก ูุทุฑููุฉ ุนูููุฉ ูุนุฏู ูุนุฑูุฉ ุฃู ุดูุก</a></li>
<li><a href="../ar435814/index.html">[ุงูุดูุก ุงูุฌุฏูุฏ ุงููุฏูู] ูู ูููููู ุงุณุชุฎุฏุงู ูุฌููุนุชู ููุง ุฃุฑูุฏุ</a></li>
<li><a href="../ar435816/index.html">ุงูุชุชุญ ูุณุชุดูู Massachusetts ู DeepMind ุงูุตูุฏูู ุงูุฃุณูุฏ ูููุธูุฉ ุงูุนูู ุงูุฏูููุฉ ุจุดูู ูุณุชูู</a></li>
<li><a href="../ar435822/index.html">ููููุฉ ุงูุชุญูู ูู ุงูุฃุฌูุฒุฉ ูู ูุฑูุฒ ุงูุจูุงูุงุช ุจุงุณุชุฎุฏุงู ุงูุตูุช</a></li>
<li><a href="../ar435824/index.html">ูุง ุชุญุชุงุฌ ุฅูู ูุนุฑูุชู ูุจู ุงูุจุฏุก ูู ูููุฉ ูู ุตูุงุนุฉ ุงูุตูุช</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>