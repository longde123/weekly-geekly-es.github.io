<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë©‚Äçüíª üë©üèª‚Äçü§ù‚Äçüë®üèø üö£üèΩ Configuration de Out-Of-Memory Killer sous Linux pour PostgreSQL üí• üë∏üèº üèïÔ∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Lorsque le serveur de base de donn√©es s'arr√™te de mani√®re inattendue sous Linux, vous devez trouver la raison. Il peut y avoir plusieurs raisons. Par ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Configuration de Out-Of-Memory Killer sous Linux pour PostgreSQL</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/southbridge/blog/464245/"><p><img src="https://habrastorage.org/webt/xn/ip/86/xnip86u-h8mejjpjkpvpaun7emc.png"></p><br><p>  Lorsque le serveur de base de donn√©es s'arr√™te de mani√®re inattendue sous Linux, vous devez trouver la raison.  Il peut y avoir plusieurs raisons.  Par exemple, <strong>SIGSEGV</strong> - plantage en raison d'un bogue sur le serveur principal.  Mais c'est une raret√©.  Plus souvent qu'autrement, l'espace disque ou la m√©moire est tout simplement √©puis√©.  Si l'espace disque est √©puis√©, une solution consiste √† lib√©rer de l'espace et √† red√©marrer la base de donn√©es. </p><br><h3 id="out-of-memory-killer">  Tueur de m√©moire insuffisante </h3><br><p>  Lorsque le serveur ou le processus manque de m√©moire, Linux propose 2 solutions: planter le syst√®me entier ou terminer le processus (application) qui consomme de la m√©moire.  Il est pr√©f√©rable, bien s√ªr, de terminer le processus et de sauver le syst√®me d'exploitation d'une interruption anormale.  En bref, Out-Of-Memory Killer est le processus qui met fin √† une application pour sauver le noyau d'un plantage.  Il sacrifie l'application pour faire fonctionner l'OS.  Voyons d'abord comment fonctionne OOM et comment le contr√¥ler, puis voyons comment OOM Killer d√©cide quelle application mettre fin. </p><a name="habracut"></a><br><p>  L'une des principales t√¢ches de Linux consiste √† allouer de la m√©moire aux processus lorsqu'ils le demandent.  Habituellement, un processus ou une application demande de la m√©moire au syst√®me d'exploitation, mais eux-m√™mes ne l'utilisent pas pleinement.  Si le syst√®me d'exploitation √©met de la m√©moire √† tous ceux qui le demandent, mais ne pr√©voit pas de l'utiliser, tr√®s vite la m√©moire se terminera et le syst√®me √©chouera.  Pour √©viter cela, le syst√®me d'exploitation r√©serve de la m√©moire pour le processus, mais ne le fait pas r√©ellement.  La m√©moire n'est allou√©e que lorsque le processus va vraiment l'utiliser.  Il arrive que le syst√®me d'exploitation n'ait pas de m√©moire libre, mais il attribue de la m√©moire au processus, et lorsque le processus en a besoin, le syst√®me d'exploitation l'alloue s'il le peut.  L'inconv√©nient est que parfois le syst√®me d'exploitation r√©serve de la m√©moire, mais au bon moment, il n'y a pas de m√©moire libre et le syst√®me se bloque.  Le MOO joue un r√¥le important dans ce sc√©nario et met fin aux processus pour emp√™cher le noyau de paniquer.  Lorsque le processus PostgreSQL est interrompu de force, un message appara√Æt dans le journal: </p><br><pre><code class="plaintext hljs">Out of Memory: Killed process 12345 (postgres).</code> </pre> <br><p>  S'il y a peu de m√©moire dans le syst√®me et qu'il est impossible de la lib√©rer, la fonction <code>out_of_memory</code> est <code>out_of_memory</code> .  √Ä ce stade, il ne lui reste qu'une chose: terminer un ou plusieurs processus.  OOM-killer doit-il mettre fin imm√©diatement au processus ou puis-je attendre?  √âvidemment, lorsque out_of_memory est appel√©, cela est d√ª √† l'attente d'une op√©ration d'E / S ou d'un √©change de page sur le disque.  Par cons√©quent, le MOO-tueur doit d'abord effectuer des v√©rifications et, sur cette base, d√©cider que le processus doit √™tre termin√©.  Si toutes les v√©rifications ci-dessous donnent un r√©sultat positif, le MOO mettra fin au processus. </p><br><h3 id="vybor-processa">  S√©lection de processus </h3><br><p>  Lorsque la m√©moire est √©puis√©e, la fonction <code>out_of_memory()</code> est <code>out_of_memory()</code> .  Il a une fonction <code>select_bad_process()</code> , qui re√ßoit une estimation de la fonction <code>select_bad_process()</code> .  La distribution du processus le plus "mauvais".  La fonction <code>badness()</code> s√©lectionne un processus selon certaines r√®gles. </p><br><ol><li>  Le noyau a besoin d'un minimum de m√©moire pour lui-m√™me. </li><li>  Vous devez lib√©rer beaucoup de m√©moire. </li><li>  Pas besoin de terminer les processus qui utilisent peu de m√©moire. </li><li>  Vous devez effectuer un minimum de processus. </li><li>  Algorithmes complexes qui augmentent les chances d'ach√®vement des processus que l'utilisateur lui-m√™me souhaite terminer. </li></ol><br><p>  Apr√®s avoir effectu√© toutes ces v√©rifications, le MOO examine la note ( <code>oom_score</code> ).  Le MOO affecte <code>oom_score</code> chaque processus, puis multiplie cette valeur par la quantit√© de m√©moire.  Les processus avec des valeurs plus √©lev√©es sont plus susceptibles de devenir victimes de OOM Killer.  Les processus associ√©s √† un utilisateur privil√©gi√© ont une note inf√©rieure et sont moins susceptibles de forcer l'arr√™t. </p><br><pre> <code class="plaintext hljs">postgres=# SELECT pg_backend_pid(); pg_backend_pid ----------------    3813 (1 row)</code> </pre> <br><p>  L'identifiant du processus Postgres est 3813, donc dans un autre shell, vous pouvez obtenir une estimation en utilisant ce <code>oom_score</code> noyau <code>oom_score</code> : </p><br><pre> <code class="plaintext hljs">vagrant@vagrant:~$ sudo cat /proc/3813/oom_score 2</code> </pre> <br><p>  Si vous ne voulez pas que OOM-Killer termine le processus, il existe un autre param√®tre du noyau: <code>oom_score_adj</code> .  Ajoutez une grande valeur n√©gative pour r√©duire les chances de terminer le processus que vous aimez. </p><br><pre> <code class="plaintext hljs">sudo echo -100 &gt; /proc/3813/oom_score_adj</code> </pre> <br><p>  Pour d√©finir la valeur <code>oom_score_adj</code> , d√©finissez OOMScoreAdjust dans le bloc de service: </p><br><pre> <code class="plaintext hljs">[Service] OOMScoreAdjust=-1000</code> </pre> <br><p>  Ou utilisez <code>oomprotect</code> dans la <code>rcctl</code> . </p><br><pre> <code class="plaintext hljs">rcctl set &lt;i&gt;servicename&lt;/i&gt; oomprotect -1000</code> </pre> <br><h3 id="prinuditelnoe-zavershenie-processa">  Arr√™t forc√© du processus </h3><br><p>  Lorsqu'un ou plusieurs processus sont d√©j√† s√©lectionn√©s, OOM-Killer appelle la fonction <code>oom_kill_task()</code> .  Cette fonction envoie un signal de terminaison au processus.  S'il n'y a pas assez de m√©moire, <code>oom_kill()</code> appelle cette fonction pour envoyer un signal SIGKILL au processus.  Un message est √©crit dans le journal du noyau. </p><br><pre> <code class="plaintext hljs">Out of Memory: Killed process [pid] [name].</code> </pre> <br><h3 id="kak-kontrolirovat-oom-killer">  Comment contr√¥ler OOM-Killer </h3><br><p>  Sous Linux, vous pouvez activer ou d√©sactiver OOM-Killer (bien que ce dernier ne soit pas recommand√©).  Pour activer et d√©sactiver, utilisez l'option <code>vm.oom-kill</code> .  Pour activer OOM-Killer √† l'ex√©cution, ex√©cutez la commande <code>sysctl</code> . </p><br><pre> <code class="plaintext hljs">sudo -s sysctl -w vm.oom-kill = 1</code> </pre> <br><p>  Pour d√©sactiver OOM-Killer, sp√©cifiez la valeur 0 dans la m√™me commande: </p><br><pre> <code class="plaintext hljs">sudo -s sysctl -w vm.oom-kill = 0</code> </pre> <br><p>  Le r√©sultat de cette commande ne sera pas enregistr√© pour toujours, mais uniquement jusqu'au premier red√©marrage.  Si vous avez besoin de plus de persistance, ajoutez cette ligne au fichier <code>/etc/sysctl.conf</code> : </p><br><pre> <code class="plaintext hljs">echo vm.oom-kill = 1 &gt;&gt;/etc/sysctl.conf</code> </pre> <br><p>  Une autre fa√ßon d'activer et de d√©sactiver consiste √† √©crire la variable <code>panic_on_oom</code> .  La valeur peut toujours √™tre archiv√©e dans <code>/proc</code> . </p><br><pre> <code class="plaintext hljs">$ cat /proc/sys/vm/panic_on_oom 0</code> </pre> <br><p>  Si vous d√©finissez la valeur sur 0, lorsque la m√©moire est √©puis√©e, la panique du noyau ne le sera pas. </p><br><pre> <code class="plaintext hljs">$ echo 0 &gt; /proc/sys/vm/panic_on_oom</code> </pre> <br><p>  Si vous d√©finissez la valeur sur 1, lorsque la m√©moire est √©puis√©e, une panique du noyau se produit. </p><br><pre> <code class="plaintext hljs">echo 1 &gt; /proc/sys/vm/panic_on_oom</code> </pre> <br><p>  OOM-Killer peut non seulement √™tre activ√© ou d√©sactiv√©.  Nous avons d√©j√† dit que Linux peut r√©server plus de m√©moire aux processus qu'il n'y en a, mais ne pas l'allouer en fait, et ce comportement est contr√¥l√© par le param√®tre du noyau Linux.  La variable <code>vm.overcommit_memory</code> est responsable. </p><br><p>  Vous pouvez lui sp√©cifier les valeurs suivantes: </p><br><p>  <strong>0: le</strong> noyau lui-m√™me d√©cide de r√©server trop de m√©moire.  Il s'agit de la valeur par d√©faut sur la plupart des versions de Linux. <br>  <strong>1: le</strong> noyau r√©servera toujours de la m√©moire suppl√©mentaire.  C'est risqu√©, car la m√©moire peut s'arr√™ter, car, tr√®s probablement, un jour, les processus exigeront ce qui est cens√© √™tre. <br>  <strong>2: le</strong> noyau ne r√©servera pas plus de m√©moire que celle sp√©cifi√©e dans le param√®tre <code>overcommit_ratio</code> . </p><br><p>  Dans ce param√®tre, vous sp√©cifiez le pourcentage de m√©moire pour lequel la redondance est autoris√©e.  S'il n'y a pas d'espace pour cela, la m√©moire n'est pas allou√©e, la r√©servation sera refus√©e.  Il s'agit de l'option la plus s√ªre recommand√©e pour PostgreSQL.  OOM-Killer est affect√© par un autre √©l√©ment - la fonction de swap, qui est contr√¥l√©e par la variable <code>cat /proc/sys/vm/swappiness</code> .  Ces valeurs indiquent au noyau comment g√©rer la pagination.  Plus la valeur est √©lev√©e, moins il est probable que le MOO termine le processus, mais en raison des E / S, cela affecte n√©gativement la base de donn√©es.  Et vice versa - plus la valeur est petite, plus la probabilit√© d'intervention d'OOM-Killer est √©lev√©e, mais les performances de la base de donn√©es sont √©galement plus √©lev√©es.  La valeur par d√©faut est 60, mais si la base de donn√©es enti√®re tient en m√©moire, il est pr√©f√©rable de d√©finir la valeur sur 1. </p><br><h3 id="itogi">  R√©sum√© </h3><br><p>  N'ayez pas peur du tueur dans OOM-Killer.  Dans ce cas, le tueur sera le sauveur de votre syst√®me.  Il ¬´tue¬ª les pires processus et sauve le syst√®me d'une interruption anormale.  Pour √©viter d'avoir √† utiliser OOM-Killer pour terminer PostgreSQL, d√©finissez <code>vm.overcommit_memory</code> sur 2. Cela ne garantit pas que OOM-Killer n'a pas √† intervenir, mais r√©duira la probabilit√© de fin forc√©e d'un processus PostgreSQL. </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr464245/">https://habr.com/ru/post/fr464245/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr464225/index.html">REST assur√©: ce que nous avons appris de cinq ans d'utilisation de l'outil</a></li>
<li><a href="../fr464227/index.html">Comment ils vivent et travaillent √† Krasnodar</a></li>
<li><a href="../fr464233/index.html">Chaos Constructions 2019 arrive ...</a></li>
<li><a href="../fr464235/index.html">¬´Slurm¬ª cr√©e une forte d√©pendance. Comment transformer une cabale en projet global</a></li>
<li><a href="../fr464237/index.html">Pascal Tanchiki: comment les enfants apprenaient la programmation dans les ann√©es 90 et ce qui n'allait pas</a></li>
<li><a href="../fr464249/index.html">Travail √† distance en mode temps plein: par o√π commencer si vous n'√™tes pas senior</a></li>
<li><a href="../fr464253/index.html">Arr√™tez d'utiliser datetime</a></li>
<li><a href="../fr464255/index.html">Meetup NX JAVA # 14: recherche de performances sur les avantages, les inconv√©nients et les avantages de Spark dans des solutions bas√©es sur Cassandra</a></li>
<li><a href="../fr464257/index.html">R√©sum√© UX: red√©marrage</a></li>
<li><a href="../fr464259/index.html">Jeux en nuage: √©valuation de premi√®re main des capacit√©s des services pour jouer sur des PC faibles</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>