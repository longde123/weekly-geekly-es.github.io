<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üî∞ üé• üë≤üèæ Como configurar a an√°lise da web nas p√°ginas AMP ‚òîÔ∏è üìÅ üëçüèº</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Oi Habr. Sou analista de dados na Wrike Marketing: coleto e analiso todos os dados de publicidade, modelagem de LTV e outras tarefas t√©cnicas que ajud...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Como configurar a an√°lise da web nas p√°ginas AMP</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/wrike/blog/451928/">  Oi Habr.  Sou analista de dados na Wrike Marketing: coleto e analiso todos os dados de publicidade, modelagem de LTV e outras tarefas t√©cnicas que ajudam a equipe a fazer a publicidade mais eficaz em todas as fontes.  Recentemente, tive o problema de configurar a coleta de dados nas p√°ginas AMP e encontrei muito poucas informa√ß√µes sobre o assunto, ent√£o decidi dizer como lidar com essa tarefa. <br><br><img src="https://habrastorage.org/webt/7b/ks/f8/7bksf83vi2h7m3vfnu1vpljt50c.png"><br><a name="habracut"></a><br>  Na Wrike, constru√≠mos um sistema de an√°lise da web que atende a um grande n√∫mero de diferentes partes interessadas: equipes de sites, gera√ß√£o de leads, opera√ß√µes de marketing, gerentes de conte√∫do, gerenciamento de marketing e n√≠vel C.  √â muito importante para a equipe de an√°lise manter a integridade, a consist√™ncia e a pontualidade dos dados coletados no site, porque um grande n√∫mero de relat√≥rios √© criado com base nas mesmas e a receita esperada √© calculada para avaliar a efic√°cia da campanha publicit√°ria em tempo real. <br><br>  No lado do cliente, nossas an√°lises s√£o executadas no <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Google Tag Manager</a> (GTM) - essa solu√ß√£o permite que a equipe adicione e modifique convenientemente scripts anal√≠ticos sem a participa√ß√£o de especialistas em sites.  Os scripts instalados podem ser divididos em tr√™s grupos por ponto final para dados: <br><br><ol><li>  Google Analytics </li><li>  Nossos logs internos, dos quais os dados s√£o enviados para o PostgreSQL; </li><li>  Rastreadores para sites de publicidade e outros sistemas de an√°lise (LinkedIn, Twitter e outros sites contam exibi√ß√µes de p√°gina e convers√µes para exibir relat√≥rios de publicidade em sua interface). </li></ol><br>  O banco de dados interno se comunica com o Google Analytics e sites de terceiros.  Durante a troca, geralmente identificamos o usu√°rio pelo ID do cliente atribu√≠do pela an√°lise: ele √© armazenado em nosso banco de dados e no Google Analytics como par√¢metro do usu√°rio.  Para n√≥s mesmos, tiramos o valor dos cookies <code>_ga</code> . <br><br><img src="https://habrastorage.org/webt/4y/sn/-v/4ysn-v3ini_8xfnegwfnesshgia.png"><br><br>  Recentemente, a equipe do nosso site adaptou <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">as</a> p√°ginas do <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">blog corporativo</a> ao padr√£o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">AMP</a> .  Em resumo, o AMP (Accelerated Mobile Pages) √© um padr√£o especial para a cria√ß√£o de p√°ginas para dispositivos m√≥veis, o que pode acelerar significativamente seu trabalho.  Se a p√°gina estiver em conformidade com o padr√£o, o AMP Project armazenar√° em cache a p√°gina em sua CDN e a p√°gina ser√° incorporada na pesquisa do Google em dispositivos m√≥veis. <br><br><img src="https://habrastorage.org/webt/bz/a1/vz/bza1vzf7j9ovqzq7287hhflwjoa.png"><br><br>  <sub>A p√°gina do nosso blog nos resultados da pesquisa.</sub>  <sub>O √≠cone AMP √† esquerda do link significa que a p√°gina ser√° aberta em um quadro (iframe) diretamente na p√°gina de pesquisa.</sub> <br><br>  Em particular, a alta velocidade de carregamento das p√°ginas AMP √© obtida pela aus√™ncia de JS execut√°vel do usu√°rio no c√≥digo da p√°gina (a tag de <code>script</code> √© proibida se n√£o for do tipo <code>application/ld+json</code> ou <code>text/plain</code> ) e a pr√≥pria p√°gina √© criada a partir de um conjunto limitado de tags pr√©-otimizadas.  Para an√°lise da web, este foi um teste que n√≥s passamos com sucesso. <br><br>  Existem dois problemas ao adicionar p√°ginas AMP ao nosso ecossistema: <br><br><ol><li>  Os m√©todos convencionais de coleta de dados baseados em JS param de funcionar; </li><li>  O AMP usa armazenamento local em vez de cookies e o ID do cliente √© gerado por uma m√°scara completamente diferente: </li></ol><br><img src="https://habrastorage.org/webt/4k/z3/mq/4kz3mqfo8po38axhb6jtbvsdnse.png"><br><br>  Consideramos os problemas separadamente. <br><br><h2>  Coleta de informa√ß√µes </h2><br>  No GTM, voc√™ pode criar um cont√™iner separado adequado para p√°ginas AMP, mas o √∫ltimo reduziu bastante a variedade de tipos de tags que podem ser adicionadas.  O maior problema √©, √© claro, a falta do tipo HTML personalizado atrav√©s do qual geralmente colocamos nossos scripts.  Vamos ver como resolver esse e outros problemas para cada terminal de dados. <br><br><h3>  Google analytics </h3><br>  Esta √© a categoria mais f√°cil.  Os cont√™ineres AMP fornecem o tipo de tag Universal Analytics, atrav√©s do qual voc√™ pode instalar o Google Analytics.  Juntamente com o envio de visualiza√ß√µes de p√°gina e eventos, apenas par√¢metros e indicadores definidos pelo usu√°rio entram na an√°lise.  Grupos de conte√∫do, dados de com√©rcio eletr√¥nico e outros campos dispon√≠veis no GTM para p√°ginas regulares n√£o podem ser configurados aqui. <br><br>  Se voc√™ usar o Yandex.Metrica junto com o Google Analytics, ele tamb√©m poder√° ser entregue, mas n√£o funcionar√° atrav√©s do GTM: voc√™ precisar√° conectar os desenvolvedores.  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Aqui</a> voc√™ pode encontrar instru√ß√µes detalhadas. <br><br><img src="https://habrastorage.org/webt/zr/bb/de/zrbbde6kkrw4an5uzfm6gsmpy4i.png"><br>  <sub>Exemplo de envio de uma visualiza√ß√£o de p√°gina ao Google Analytics via GTM para AMP</sub> <br><br><h3>  Logs pr√≥prios </h3><br>  Qualquer solicita√ß√£o pode ser enviada usando a tag Imagem personalizada.  No back-end, √© importante fornecer um pixel que registre dados dos par√¢metros de solicita√ß√£o GET.  Para configurar o envio de dados, adicione as vari√°veis ‚Äã‚Äãnecess√°rias ao endere√ßo da p√°gina solicitada e n√£o se esque√ßa de usar a op√ß√£o Ativar rebentamento de cache para que o pixel n√£o seja armazenado em cache. <br>  Por exemplo, voc√™ pode enviar dados sobre a exibi√ß√£o de uma p√°gina com um ID de cliente e referenciador usando um pixel: <br><br> <code>//www.your-site.com/log?event=pageview&amp;page={{Page Path}}&amp;ga={{Page Client ID}}&amp;referrer={{Document Referrer}} <br></code> <br>  Os links nas vari√°veis ‚Äã‚Äãdo GTM s√£o indicados entre colchetes; eles podem ser configurados na se√ß√£o correspondente da interface do GTM.  O conjunto de vari√°veis ‚Äã‚Äãembutidas √©, obviamente, limitado.  Tamb√©m √© imposs√≠vel calcular valores pr√≥prios devido √† aus√™ncia de JS.  Se necess√°rio, voc√™ pode calcular os valores desejados no lado do cliente usando vari√°veis ‚Äã‚ÄãAMP - eles podem ser acessados ‚Äã‚Äãno GTM. <br><br>  Como o AMP recebe principalmente tr√°fego org√¢nico, n√£o √© necess√°rio instalar rastreadores complexos para sites de publicidade.  Portanto, t√≠nhamos vari√°veis ‚Äã‚Äãinternas suficientes para configurar nosso rastreamento. <br><br><h3>  Outros rastreadores </h3><br>  Adaptar outros rastreadores que n√£o est√£o integrados ao AMP √© bastante dif√≠cil.  Para entender o que pode ser adaptado e o que n√£o pode, voc√™ precisa examinar as solicita√ß√µes enviadas por esses rastreadores.  Se os par√¢metros enviados pelo rastreador estiverem dispon√≠veis no GTM, voc√™ poder√° enviar os dados necess√°rios usando a mesma imagem personalizada.  Se o contador tiver uma parte noscript, geralmente poder√° ser transferida para o GTM. <br><br>  Tivemos que abandonar muitos rastreadores, cuja adapta√ß√£o para a AMP parecia muito trabalhosa em compara√ß√£o com os benef√≠cios que ela pode trazer. <br><br><h3>  Unifica√ß√£o de ID do Cliente </h3><br>  Juntamente com a AMP, obtemos n√£o uma, mas tr√™s op√ß√µes poss√≠veis para carregar a p√°gina.  Juntamente com a vers√£o regular, quatro s√£o obtidos: <br><br><ol><li>  Vers√£o normal (por exemplo, <code>www.your-site.com/blog/article-name/</code> ) </li><li>  Fa√ßa o download diretamente no site (aqui o artigo √© publicado para armazenamento em cache, por exemplo, <code>www.your-site.com/blog/article-name/amp/</code> ) </li><li>  Vers√£o armazenada em cache no AMP CDN (o endere√ßo ser√° algo assim: <code>www-your-site-com.cdn.ampproject.org/v/s/www.your-site.com/blog/article-name/amp/</code> ) </li><li>  Fa√ßa o download via iframe nos resultados da pesquisa: o iframe procurar√° o mesmo endere√ßo do par√°grafo 3, mas formalmente o usu√°rio navegar√° em <code>www.google.com</code> . </li></ol><br>  Se a equipe de an√°lise n√£o tomar nenhuma medida para integrar o AMP ao seu sistema de an√°lise, o ID do cliente ser√° transferido apenas entre as vers√µes normal e AMP localizadas no seu dom√≠nio. <br><br><img src="https://habrastorage.org/webt/es/yk/jw/esykjwmlhjr8q0sfuvtajgwckyw.png"><br>  <sub>Por padr√£o, apenas as p√°ginas localizadas no seu dom√≠nio trocam dados e sess√µes do cliente.</sub> <br><br>  Em todos os outros casos, o ID do cliente n√£o √© transmitido.  Portanto, o usu√°rio que leu o artigo nos resultados da pesquisa e depois foi ao site, do ponto de vista da automa√ß√£o, s√£o duas pessoas diferentes.  Como resultado, na an√°lise, voc√™ ver√° um aumento acentuado nos "novos" usu√°rios, os dados nas fontes n√£o refletir√£o a realidade e, no sistema interno de an√°lise, voc√™ perder√° a oportunidade de tra√ßar o verdadeiro caminho do usu√°rio desde a primeira visita √† convers√£o. <br><br><h3>  Solu√ß√£o 1. API de ID do cliente </h3><br>  O Google sugere usar a <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">API de ID</a> do <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">cliente</a> . <br><br>  A implementa√ß√£o desta solu√ß√£o √© bastante simples: voc√™ precisa adicionar a metatag opt-in √†s p√°ginas AMP e adicionar a configura√ß√£o ao c√≥digo do Google Analytics nas p√°ginas regulares do site.  No entanto, esta solu√ß√£o tem muitas desvantagens: <br><br><ol><li>  Ele funcionar√° apenas em um par de pesquisa do Google - seu site; </li><li>  Ele funcionar√° apenas em uma dire√ß√£o: se o usu√°rio efetuou login pela primeira vez no AMP, em um site comum, ele usar√° o identificador AMP.  Se o usu√°rio j√° esteve no seu site e efetuou login no AMP, um novo identificador ser√° gerado para ele; </li><li>  Ele usa identificadores AMP.  Se o seu banco de dados interno for constru√≠do com uma identifica√ß√£o de cliente regular, isso poder√° causar problemas inesperados. </li></ol><br><img src="https://habrastorage.org/webt/wq/sb/wx/wqsbwxcrfk32gxjt34kgwxxbv1k.png"><br>  <sub>A API de ID do cliente permite transferir dados do usu√°rio dos resultados da pesquisa para o seu dom√≠nio, mas isso funciona apenas em uma dire√ß√£o.</sub> <br><br><h3>  Solu√ß√£o 2. Configura√ß√£o customizada de anal√≠tica de amp </h3><br>  Diferentemente da vers√£o em tamanho real, o AMP GTM √© conectado n√£o atrav√©s de JS, mas atrav√©s de um arquivo JSON.  O arquivo de configura√ß√£o cont√©m informa√ß√µes sobre todas as tags, gatilhos e outras configura√ß√µes do GTM.  No n√≠vel superior, o arquivo se parece com isso: <br><br><pre> <code class="json hljs">{ <span class="hljs-attr"><span class="hljs-attr">"requests"</span></span>:{...}, <span class="hljs-attr"><span class="hljs-attr">"triggers"</span></span>:{...}, <span class="hljs-attr"><span class="hljs-attr">"vars"</span></span>:{...}, <span class="hljs-attr"><span class="hljs-attr">"transport"</span></span>:{...}, <span class="hljs-attr"><span class="hljs-attr">"linkers"</span></span>:{...}, }</code> </pre><br>  O n√≠vel de vars cont√©m informa√ß√µes sobre o ID do cliente: <br><br><pre> <code class="json hljs"> <span class="hljs-string"><span class="hljs-string">"vars"</span></span>:{ <span class="hljs-attr"><span class="hljs-attr">"clientId"</span></span>:<span class="hljs-string"><span class="hljs-string">"CLIENT_ID(AMP_ECID_GOOGLE,,_ga)"</span></span>, }</code> </pre><br>  O GTM usar√° qualquer ID de cliente que seja passado neste campo.  Portanto, podemos fazer o download desse arquivo, coloc√°-lo em nosso dom√≠nio principal e substituir o ID do cliente por aquele armazenado em cookies (e dispon√≠vel no dom√≠nio principal).  Para fazer isso, crie um gerador de arquivo JSON no dom√≠nio principal, que: <br><br><ol><li>  Pega a configura√ß√£o JSON do GTM em <code>https://www.googletagmanager.com/amp.json?id=GTM-XXXXXXX&amp;gtm.url=SOURCE_URL</code> (substitua GTM-XXXXXXX pelo identificador do seu cont√™iner e SOURCE_URL pelo endere√ßo da p√°gina aberta pelo usu√°rio; </li><li>  L√™ <code>_ga</code> cookies.  Se n√£o estiver l√°, voc√™ precisar√° criar um ID de cliente no formato do Google na forma de: um n√∫mero aleat√≥rio de nove d√≠gitos, per√≠odo, carimbo de data / hora (carimbo de data / hora).  Se voc√™ tiver que criar um valor, lembre-se dele em <code>_ga</code> cookies.  Retornamos o arquivo obtido do GTM com falsifica√ß√£o de ID do cliente: </li></ol><br><pre> <code class="json hljs"> <span class="hljs-string"><span class="hljs-string">"vars"</span></span>:{ <span class="hljs-attr"><span class="hljs-attr">"clientId"</span></span>:<span class="hljs-string"><span class="hljs-string">"111111111.111111111"</span></span>, //      }</code> </pre><br><img src="https://habrastorage.org/webt/bo/m6/wk/bom6wk2vfoa9giwmskhu_onx4ko.png"><br>  <sub>Substitu√≠mos o JSON GTM de instala√ß√£o pelo seu pr√≥prio ID de cliente personalizado e transferimos o mesmo ID de cliente para um usu√°rio para todos os poss√≠veis clientes AMP.</sub> <br><br>  Nessa configura√ß√£o, todas as solicita√ß√µes de an√°lise JSON, independentemente do dom√≠nio de visualiza√ß√£o, passar√£o pelo seu dom√≠nio e receber√£o um ID de cliente nele.  Portanto, todas as quatro maneiras poss√≠veis de carregar uma p√°gina AMP receber√£o o mesmo ID do cliente. <br><br><img src="https://habrastorage.org/webt/jy/ll/d2/jylld22d3hzthsedu2lack-an0s.png"><br>  <sub>Usando a falsifica√ß√£o de ID do cliente, todos os dom√≠nios com p√°ginas AMP usam os mesmos dados sobre o visitante e n√£o criam sess√µes desnecess√°rias.</sub> <br><br>  Obrigado, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Simo Ahava</a> , pela id√©ia de falsificar o ID do cliente na configura√ß√£o JSON. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt451928/">https://habr.com/ru/post/pt451928/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt451916/index.html">PHP ass√≠ncrono e a hist√≥ria de uma bicicleta</a></li>
<li><a href="../pt451918/index.html">Para a quest√£o da TI</a></li>
<li><a href="../pt451920/index.html">Otimize o armazenamento de mensagens no Zimbra Collaboration Suite</a></li>
<li><a href="../pt451922/index.html">Aritm√©tica de ponto fixo em C ++</a></li>
<li><a href="../pt451926/index.html">Sobre o c√≥digo ao vivo ap√≥s 130 transmiss√µes</a></li>
<li><a href="../pt451930/index.html">Automa√ß√£o da ilumina√ß√£o de escadas</a></li>
<li><a href="../pt451932/index.html">PHDays 9: Bem-vindo √† Se√ß√£o de Desenvolvimento Seguro</a></li>
<li><a href="../pt451934/index.html">Alexander Lamden: ‚ÄúQualquer peda√ßo de ferro tem car√°ter‚Äù</a></li>
<li><a href="../pt451936/index.html">Procurando vulnerabilidades no navegador UC</a></li>
<li><a href="../pt451938/index.html">Ir para √≠ndices de bitmap: pesquisa selvagem</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>