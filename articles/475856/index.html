<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>‚òÉÔ∏è ‚ú≥Ô∏è üëö Google App Script, Mikrotik, Telegram y VPNBook comenzaron a tocar un cuarteto üóùÔ∏è ‚öïÔ∏è üòÑ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hoy en el programa: ¬øD√≥nde m√°s puede aplicar Google Apps Script si las ideas normales han terminado? Automatizaci√≥n del trabajo con VPNBook a trav√©s d...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Google App Script, Mikrotik, Telegram y VPNBook comenzaron a tocar un cuarteto</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/475856/">  Hoy en el programa: ¬øD√≥nde m√°s puede aplicar Google Apps Script si las ideas normales han terminado?  Automatizaci√≥n del trabajo con VPNBook a trav√©s de una cadena de scripts en diferentes idiomas que no conozco.  Nedo-cURL por Mikrotik.  Telegrama a trav√©s de un lugar, para no estar en otro, la auto-supervisi√≥n lo permite. <br><a name="habracut"></a><br><h3>  Parte 1. Sin t√≠tulo </h3><br>  Hace un a√±o, escrib√≠ una nota " <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Casi OCR para obtener una contrase√±a de VPNBook. PHP + Mikrotik</a> " sobre c√≥mo configurar la recuperaci√≥n autom√°tica de contrase√±a en un enrutador Mikrotik para acceso VPN gratuito a trav√©s de VPNBook.  El comienzo de la historia est√° ah√≠. <br><br>  Desde entonces, ha fluido mucha agua, en Rusia bloquearon el sitio VPNBook, pero no los servidores VPN p√∫blicos, que est√°n publicados en √©l.  Ese script PHP para decodificar una imagen PNG de una contrase√±a en una cadena de texto ahora tambi√©n deber√≠a funcionar cuando se inicia en un servidor cuyo tr√°fico no pasa a trav√©s del sistema de bloqueo.  Pero hace un tiempo, al experimentar con el servicio script de Google Apps (GAS) <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">script.google.com</a> , decid√≠ abandonar el script PHP en un servidor web externo, reemplaz√°ndolo parcial o totalmente con un script GAS que se ejecuta como una aplicaci√≥n web (aplicaci√≥n web).  No entend√≠a la pol√≠tica de ejecuci√≥n y las restricciones de GAS, pero todo lo que hice funciona en una cuenta gratuita de Google y todav√≠a no pide dinero.  No tengo el objetivo de describir Google Apps Script en detalle.  GAS se basa en el lenguaje JavaScript, puede usar bibliotecas JS de terceros, puede publicar el script como una aplicaci√≥n web, que puede estar disponible para todos sin autorizaci√≥n.  Las capacidades de la implementaci√≥n actual de GAS no fueron suficientes para m√≠, as√≠ que tuve que salir y buscar soluciones. <br><br>  Al principio decid√≠ escribir un proxy para im√°genes PNG.  Se supon√≠a que el script web deb√≠a solicitar una imagen de contrase√±a del sitio web de VPNBook (recuerdo que la contrase√±a se public√≥ all√≠ en PNG) y se la dio al cliente que llam√≥ a este script para decodificar.  Tal forma de sortear la cerradura.  Aqu√≠ se cumpli√≥ la primera restricci√≥n de GAS.  Resulta que el script no puede renderizar MIME image / png, sino solo formatos de texto, JSON, TEXT, XML, etc.  Pero hab√≠a una manera de evitar esto.  Puede codificar PNG a Base64 y devolver una cadena de texto al cliente.  Hay scripts similares en Internet, por ejemplo <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">techslides.com/image-proxy-with-google-app-scripts</a> .  Simplemente simplifiqu√© uno de ellos.  Solo necesitaba una imagen y generar solo cadenas Base64.  El resultado es un script que consta de una sola funci√≥n doGet: un controlador de solicitud GET que devuelve una cadena en respuesta. <br><br><pre><code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">doGet</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> response = UrlFetchApp.fetch(<span class="hljs-string"><span class="hljs-string">'https://www.vpnbook.com/password.php'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> b64 = Utilities.base64Encode(response.getContent()); <span class="hljs-comment"><span class="hljs-comment">//var data = 'data:'+type+';base64,'+b64; return ContentService.createTextOutput(b64); }</span></span></code> </pre> <br>  Ejemplo de salida del navegador: <br><br><pre> <code class="plaintext hljs">iVBORw0KGgoAAAANSUhEUgAAAGQAAAANAQMAAABl11mFAAAABlBMVEX29vZMTExY89ZbAAAACXBIWXMAAA7EAAAOxAGVKw4bAAAAVUlEQVQImWNgIBrwSzCw/2ZgOADhSc5gYJCG8wxQedLdCcYFNXcgPHOZsxuSZxx7BuFZzsjdcJi34TBU5Y3cjc3IvM3McJ7kjNxtzDwwffwSIB7UTACt/h52C5DFqQAAAABJRU5ErkJggg==</code> </pre> <br>  Luego viene el script PHP, que se puede colocar en el servidor dentro de la zona con bloqueo de recursos.  Es muy similar al script del art√≠culo anterior, excepto por un peque√±o cambio en los par√°metros de la llamada cURL.  Debe permitir que cURL pase por HTTP / 1.1 302 movido temporalmente, porque  GAS, cuando se le llama, redirige desde la direcci√≥n del script web a una direcci√≥n temporal din√°mica: <br><br><pre> <code class="php hljs">curl_setopt($ch, CURLOPT_FOLLOWLOCATION, <span class="hljs-number"><span class="hljs-number">1</span></span>);</code> </pre> <br>  Y decodificaci√≥n Base64: <br><br><pre> <code class="php hljs">$imgOCR = imagecreatefromstring(base64_decode($output));</code> </pre> <br><div class="spoiler">  <b class="spoiler_title">Script en s√≠</b> <div class="spoiler_text"><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-comment"><span class="hljs-comment">//   $wchar = 9; $hchar = 13; $strDict = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789 '; $imgDict = imagecreatetruecolor(2 + strlen($strDict)* $wchar, $hchar); $bg = imagecolorallocate($imgDict, 0xF6, 0xF6, 0xF6); $textcolor = imagecolorallocate($imgDict, 0x4C, 0x4C, 0x4C); imagefill($imgDict, 0, 0, $bg); imagestring($imgDict, 5, 2, 0, $strDict, $textcolor); //  cURL $ch = curl_init(); //  url,      //curl_setopt($ch, CURLOPT_URL, 'https://www.vpnbook.com/password.php'); curl_setopt($ch, CURLOPT_URL, 'https://script.google.com/macros/s/AKfycbwYPfaZobtjbFv0mSYI8U4NIXPh1Sft_DkGH8QKgg/exec'); //  ,      string curl_setopt($ch, CURLOPT_FOLLOWLOCATION, 1); curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1); curl_setopt($ch, CURLOPT_BINARYTRANSFER, 1); // also, this seems wise considering output is image. //   $output = curl_exec($ch); //  cURL curl_close($ch); // echo $output; $imgOCR = imagecreatefromstring(base64_decode($output)); //$imgOCR = imageCreateFromPng('password.png'); //      10  . 2 + 10*9 = 92 &lt; 100 $maxchar = floor((imagesx($imgOCR) - 2) / 9); $imgBox = imagecreatetruecolor($wchar, $hchar); $hashDict = Array(); //   for ($k = 0; $k &lt; strlen($strDict) ; $k++) { imagecopy($imgBox, $imgDict, 0, 0, 2 + $k * $wchar, 0, $wchar, $hchar); $hashStr = ""; for($y = 0; $y &lt; $hchar ; $y++) for($x = 0; $x &lt; $wchar; $x++) $hashStr .= (imagecolorat($imgBox, $x, $y) != 0xF6F6F6)? '1': '0'; $hashDict[$hashStr] = $strDict[$k]; } //     for ($k = 0; $k &lt; $maxchar ; $k++) { imagecopy($imgBox, $imgOCR, 0, 0, 2 + $k * $wchar, 0, $wchar, $hchar); $hashStr = ""; for($y = 0; $y &lt; $hchar ; $y++) for($x = 0; $x &lt; $wchar; $x++) $hashStr .= (imagecolorat($imgBox, $x, $y) != 0xF6F6F6)? '1': '0'; $tempchar = $hashDict[$hashStr]; if ($tempchar=='u' || $tempchar=='y') //    $tempchar = (mt_rand(0, 1))? 'u': 'y'; //$tempchar = (time() / 60 % 60 % 2)? 'u': 'y'; elseif ($tempchar==' ') break; print($tempchar); } /* header('Content-type: image/png'); imagepng($imgDict); */ //var_dump($hashDict); imagedestroy($imgDict); imagedestroy($imgOCR); imagedestroy($imgBox); </span><span class="hljs-meta"><span class="hljs-comment"><span class="hljs-meta">?&gt;</span></span></span></span></code> </pre> <br></div></div><br>  Este script PHP decodifica la contrase√±a PNG y la devuelve como una cadena de texto.  Adem√°s, como en el primer art√≠culo en la parte sobre Mikrotik.  El enrutador recoge la contrase√±a usando fetch. <br>  El resultado fue un esquema de trabajo de 2 servicios intermedios frente a Mikrotik. <br><br><h3>  Parte 2. Presione sobre GAS.  Deshazte del script decodificador PHP </h3><br>  Durante los experimentos con GAS, surgi√≥ la idea de abandonar el decodificador de contrase√±a en PHP y reescribirlo en GAS.  Y aqu√≠ se descubri√≥ un gran problema: el script de Google no tiene funciones de procesamiento PNG, lo √∫nico que se puede hacer es convertir PNG a una matriz de bytes.  No se trataba de manipulaciones con partes de im√°genes y p√≠xeles.  Me sub√≠ a Github en busca de la biblioteca JS para trabajar con PNG, encontr√© muchos de ellos: PNG.js, UPNG.js, pngjs.  Algunos no admiten la profundidad de color de 1 bit de un p√≠xel PNG (imagen con contrase√±a).  Tiraron de varias bibliotecas de compresi√≥n zlib.  En general, todo me pareci√≥ un poco engorroso, y decid√≠ escribir por mi cuenta un convertidor primitivo solo para mi imagen PNG en un mapa de bits con la funci√≥n de acceder a p√≠xeles mediante coordenadas XY.  Luego vino una inmersi√≥n completa en formato PNG: editor hexadecimal, est√°ndares de lectura, montones de descripciones en la red.  Y finalmente, me encontr√© con la secci√≥n PNG del archivo IDAT, empaquetada con zlib, que conten√≠a una matriz de p√≠xeles. <br><br>  Se requer√≠a una funci√≥n para desempaquetar zlib, que por supuesto no estaba en GAS.  Sorprendentemente, tienen gzip / ungzip y zip / unzip, pero no zlib.  Despu√©s de leer sobre gzip (el segundo nivel de inmersi√≥n despu√©s del formato PNG), llegu√© a la conclusi√≥n de que no ser√≠a posible ensamblar una "bicicleta" en forma de cuasi-archivo gzip de la secci√≥n IDAT, aunque la compresi√≥n zlib se usa all√≠ y all√°.  Porque  Para construir un archivo gzip v√°lido, necesita saber la longitud de los datos desempaquetados, que no podr√≠a obtener sin desempacarlos :) Y con la longitud incorrecta, GAS consider√≥ que el archivo estaba da√±ado.  Al final, recurr√≠ a Github y encontr√© una gran soluci√≥n: zlib.js para la biblioteca de Google Apps Script (https://github.com/hinimub/zlib.js/blob/develop/README.en.md).  Que fue especialmente preparado para la integraci√≥n en proyectos de GAS a trav√©s de bibliotecas de claves de proyecto.  Entonces el rompecabezas comenz√≥ a converger.  Despu√©s de escribir la descompresi√≥n de la matriz de p√≠xeles y la funci√≥n para acceder a las coordenadas del p√≠xel XY, fue posible transferir el script del decodificador de PHP a GAS. <br><br>  Se calcul√≥ por separado una tabla hash de un diccionario de posibles caracteres de contrase√±a.  Esta es una acci√≥n √∫nica que hice en un programa de terceros (en LabVIEW, hola, colegas).  Cada car√°cter en la imagen se puede asignar como 8 bits (sin sangr√≠a) x 10 l√≠neas.  1 byte es suficiente para codificar 8 p√≠xeles de una l√≠nea de un car√°cter.  Puede almacenar una cadena de p√≠xeles en un n√∫mero entero (byte) y el car√°cter completo como una secuencia de 10 bytes.  Resulta 10 n√∫meros hexadecimales por personaje.  A continuaci√≥n, el decodificador GAS repite su progenitor PHP. <br><br><div class="spoiler">  <b class="spoiler_title">El resultado es un script que funciona completamente en GAS.</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">doGet</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//var file = DriveApp.getFilesByName("password2.png").next(); //var image = file.getBlob(); var image = UrlFetchApp.fetch('https://www.vpnbook.com/password.php').getBlob(); var imageString = image.getDataAsString(); var imageArray = image.getBytes().map(function(e) { return e &amp; 0xff; }); // imageArray = blobToUint8(imageArray); var chunkIDATStart = imageString.indexOf("IDAT") + 4; //   IDAT var chunkIDATLen = bytesToUint32(imageArray, imageString.indexOf("IDAT") - 4); //   IDAT var IDATArray = imageArray.slice(chunkIDATStart, chunkIDATStart + chunkIDATLen) var inflate = new zlibjs.Inflate(IDATArray); //  IDAT   zlib var plain = inflate.decompress(); const Width = 100; //   const Height = 13; //   const wchar = 9; //   const hchar = 13; //   //Logger.log(typeof(plain)); //Logger.log(plain); rowlen = (Width / 8) &gt;&gt; 0; //   ,    if ((Width - rowlen * 8) &gt; 0) { //    rowlen+=2; // +1 filter byte at the beginning of each row.    PNG } else { rowlen++; } function getXY(x, y) { //  : 0/1 var xbyte = (x / 8 &gt;&gt; 0); //  ,   //Logger.log("xbyte: " + xbyte); var xbit = x - xbyte * 8; //  ,    //Logger.log("xbit: " + xbit); return (plain[xbyte + 1 + y * rowlen] &lt;&lt; xbit &amp; 0x80) &gt;&gt; 7; // +1 filter byte at the beginning of each row } // Logger.log("getXY: " + getXY(4, 3)); // - .        8  (  ) x 10 ,        (byte),      10  . //  10 hex   . var hashDict = {'183C66C3C3C3FFC3C3C3':'A','FCC6C3C6FCC6C3C3C6FC':'B','3E63C1C0C0C0C0C1633E':'C','FCC6C3C3C3C3C3C3C6FC':'D', 'FEC0C0C0FCC0C0C0C0FE':'E','FFC0C0C0FCC0C0C0C0C0':'F','3E63C0C0C0C7C3C3633E':'G','C3C3C3C3FFC3C3C3C3C3':'H', '7E18181818181818187E':'I','1E666666466C38':'J','C3C6CCD8F0F0D8CCC6C3':'K','C0C0C0C0C0C0C0C0C0FE':'L', 'C3E7FFDBDBDBC3C3C3C3':'M','C3E3F3F3DBDBCFC7C7C3':'N','3C66C3C3C3C3C3C3663C':'O','FEC3C3C3FEC0C0C0C0C0':'P', '3C66C3C3C3C3DBCF663D':'Q','FEC3C3C3FEF8CCC6C3C3':'R','7EC3C0C07E333C37E':'S','FF181818181818181818':'T', 'C3C3C3C3C3C3C3C3663C':'U','C3C3C36666663C3C1818':'V','C3C3C3C3DBDBDBFFE7C3':'W','C3C3663C18183C66C3C3':'X', 'C3C3663C181818181818':'Y','FE66C183060C0C0FE':'Z','0003E6337FC3C77B':'a','C0C0C0DCE6C3C3C3E6DC':'b', '0003E63C0C0C0633E':'c','3333B67C3C3C3673B':'d','0003C66C3FFC0633E':'e','1E33333030FC30303030':'f', '0007DC7C6C67CC07E':'g','C0C0C0DCE6C3C3C3C3C3':'h','181803818181818187E':'i','660E66666C6':'j', '606060666C78786C6663':'k','3818181818181818183C':'l','000B6DBDBDBDBDBDB':'m','000DCE6C3C3C3C3C3':'n', '0003C66C3C3C3663C':'o','000DCE6C3C3C3E6DC':'p','0003B67C3C3C3673B':'q','000DE736060606060':'r', '0007EC3C07E3C37E':'s','03030FC30303030331E':'t','000C3C3C3C3C3673B':'u','000C3C366663C3C18':'v', '000C3C3DBDBDBFF66':'w','000C3663C183C66C3':'x','000C3C3C3C3C3673B':'y','0007E6C1830607E':'z', '183C66C3C3C3C3663C18':'0','1838781818181818187E':'1','3C66C336C183060FF':'2','7CC6361C633C67C':'3', '6E1E3666C6FF666':'4','FEC0C0DCE633C3663C':'5','3C66C2C0DCE6C3C3663C':'6','FF336C183060C0C0':'7', '3C66C3663C66C3C3663C':'8','3C66C3C3673B343663C':'9','0000000000':' '}; //      10  . 2 + 10*9 = 92 &lt; 100 const maxchar = (Width - 2) / wchar &gt;&gt; 0; var password = ''; for (var charX = 2; charX &lt; maxchar * wchar + 2; charX+=wchar) { //    var hash = ''; //   for (var charY = 3; charY &lt; hchar; charY++) { //   Y- var charrow = 0; //   -  8   for (var charXbit = 0; charXbit &lt; 8; charXbit++) { //   X- charrow &lt;&lt;= 1; charrow |= getXY(charX + charXbit, charY); } hash += charrow.toString(16).toUpperCase(); //Logger.log("charrow: " + charrow.toString(2)); //Logger.log("charrow: " + charrow.toString(16).toUpperCase()); } var tempChar = hashDict[hash]; if (tempChar === 'u' || tempChar === 'y') { //     tempChar = (Date.now() % 2) ? 'u': 'y'; } if (tempChar !== ' ') { password += tempChar; // Logger.log("hash: " + hash); // Logger.log("Char: " + tempChar); } } Logger.log("password: " + password); return ContentService.createTextOutput(password); } function blobToUint8(blob) { return blob.map(function(e){ return e &amp; 0xff; }); } function bytesToUint32(byteArray, start) { var value = 0; for (var i = start; i &lt; start + 4; i++) { value = (value * 256) + (byteArray[i] &amp; 0xff); } return value; } function my2() { var file = DriveApp.getFilesByName("password2.png").next(); // var file = DriveApp.getFilesByName("test.bin").next(); var image = file.getBlob(); //var imageArray = image.getBytes(); //var img = UrlFetchApp.fetch('http://example.com/image.png'); var reader = new pngjs.PNGReader(image.getBytes()); var png = reader.parse(function(err, png){ if (err) throw err; return png; }); Logger.log(png); }</span></span></code> 'A', 'FCC6C3C6FCC6C3C3C6FC': 'B', '3E63C1C0C0C0C0C1633E': 'C', 'FCC6C3C3C3C3C3C3C6FC': 'D', 'FEC0C0C0FCC0C0C0C0FE': 'E', 'FFC0C0C0FCC0C0C0C0C0': 'F <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">doGet</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//var file = DriveApp.getFilesByName("password2.png").next(); //var image = file.getBlob(); var image = UrlFetchApp.fetch('https://www.vpnbook.com/password.php').getBlob(); var imageString = image.getDataAsString(); var imageArray = image.getBytes().map(function(e) { return e &amp; 0xff; }); // imageArray = blobToUint8(imageArray); var chunkIDATStart = imageString.indexOf("IDAT") + 4; //   IDAT var chunkIDATLen = bytesToUint32(imageArray, imageString.indexOf("IDAT") - 4); //   IDAT var IDATArray = imageArray.slice(chunkIDATStart, chunkIDATStart + chunkIDATLen) var inflate = new zlibjs.Inflate(IDATArray); //  IDAT   zlib var plain = inflate.decompress(); const Width = 100; //   const Height = 13; //   const wchar = 9; //   const hchar = 13; //   //Logger.log(typeof(plain)); //Logger.log(plain); rowlen = (Width / 8) &gt;&gt; 0; //   ,    if ((Width - rowlen * 8) &gt; 0) { //    rowlen+=2; // +1 filter byte at the beginning of each row.    PNG } else { rowlen++; } function getXY(x, y) { //  : 0/1 var xbyte = (x / 8 &gt;&gt; 0); //  ,   //Logger.log("xbyte: " + xbyte); var xbit = x - xbyte * 8; //  ,    //Logger.log("xbit: " + xbit); return (plain[xbyte + 1 + y * rowlen] &lt;&lt; xbit &amp; 0x80) &gt;&gt; 7; // +1 filter byte at the beginning of each row } // Logger.log("getXY: " + getXY(4, 3)); // - .        8  (  ) x 10 ,        (byte),      10  . //  10 hex   . var hashDict = {'183C66C3C3C3FFC3C3C3':'A','FCC6C3C6FCC6C3C3C6FC':'B','3E63C1C0C0C0C0C1633E':'C','FCC6C3C3C3C3C3C3C6FC':'D', 'FEC0C0C0FCC0C0C0C0FE':'E','FFC0C0C0FCC0C0C0C0C0':'F','3E63C0C0C0C7C3C3633E':'G','C3C3C3C3FFC3C3C3C3C3':'H', '7E18181818181818187E':'I','1E666666466C38':'J','C3C6CCD8F0F0D8CCC6C3':'K','C0C0C0C0C0C0C0C0C0FE':'L', 'C3E7FFDBDBDBC3C3C3C3':'M','C3E3F3F3DBDBCFC7C7C3':'N','3C66C3C3C3C3C3C3663C':'O','FEC3C3C3FEC0C0C0C0C0':'P', '3C66C3C3C3C3DBCF663D':'Q','FEC3C3C3FEF8CCC6C3C3':'R','7EC3C0C07E333C37E':'S','FF181818181818181818':'T', 'C3C3C3C3C3C3C3C3663C':'U','C3C3C36666663C3C1818':'V','C3C3C3C3DBDBDBFFE7C3':'W','C3C3663C18183C66C3C3':'X', 'C3C3663C181818181818':'Y','FE66C183060C0C0FE':'Z','0003E6337FC3C77B':'a','C0C0C0DCE6C3C3C3E6DC':'b', '0003E63C0C0C0633E':'c','3333B67C3C3C3673B':'d','0003C66C3FFC0633E':'e','1E33333030FC30303030':'f', '0007DC7C6C67CC07E':'g','C0C0C0DCE6C3C3C3C3C3':'h','181803818181818187E':'i','660E66666C6':'j', '606060666C78786C6663':'k','3818181818181818183C':'l','000B6DBDBDBDBDBDB':'m','000DCE6C3C3C3C3C3':'n', '0003C66C3C3C3663C':'o','000DCE6C3C3C3E6DC':'p','0003B67C3C3C3673B':'q','000DE736060606060':'r', '0007EC3C07E3C37E':'s','03030FC30303030331E':'t','000C3C3C3C3C3673B':'u','000C3C366663C3C18':'v', '000C3C3DBDBDBFF66':'w','000C3663C183C66C3':'x','000C3C3C3C3C3673B':'y','0007E6C1830607E':'z', '183C66C3C3C3C3663C18':'0','1838781818181818187E':'1','3C66C336C183060FF':'2','7CC6361C633C67C':'3', '6E1E3666C6FF666':'4','FEC0C0DCE633C3663C':'5','3C66C2C0DCE6C3C3663C':'6','FF336C183060C0C0':'7', '3C66C3663C66C3C3663C':'8','3C66C3C3673B343663C':'9','0000000000':' '}; //      10  . 2 + 10*9 = 92 &lt; 100 const maxchar = (Width - 2) / wchar &gt;&gt; 0; var password = ''; for (var charX = 2; charX &lt; maxchar * wchar + 2; charX+=wchar) { //    var hash = ''; //   for (var charY = 3; charY &lt; hchar; charY++) { //   Y- var charrow = 0; //   -  8   for (var charXbit = 0; charXbit &lt; 8; charXbit++) { //   X- charrow &lt;&lt;= 1; charrow |= getXY(charX + charXbit, charY); } hash += charrow.toString(16).toUpperCase(); //Logger.log("charrow: " + charrow.toString(2)); //Logger.log("charrow: " + charrow.toString(16).toUpperCase()); } var tempChar = hashDict[hash]; if (tempChar === 'u' || tempChar === 'y') { //     tempChar = (Date.now() % 2) ? 'u': 'y'; } if (tempChar !== ' ') { password += tempChar; // Logger.log("hash: " + hash); // Logger.log("Char: " + tempChar); } } Logger.log("password: " + password); return ContentService.createTextOutput(password); } function blobToUint8(blob) { return blob.map(function(e){ return e &amp; 0xff; }); } function bytesToUint32(byteArray, start) { var value = 0; for (var i = start; i &lt; start + 4; i++) { value = (value * 256) + (byteArray[i] &amp; 0xff); } return value; } function my2() { var file = DriveApp.getFilesByName("password2.png").next(); // var file = DriveApp.getFilesByName("test.bin").next(); var image = file.getBlob(); //var imageArray = image.getBytes(); //var img = UrlFetchApp.fetch('http://example.com/image.png'); var reader = new pngjs.PNGReader(image.getBytes()); var png = reader.parse(function(err, png){ if (err) throw err; return png; }); Logger.log(png); }</span></span></code> '' C3C3C3C3FFC3C3C3C3C3 ':' H '' 7E18181818181818187E ':' I '' 1E666666466C38 ':' J '' C3C6CCD8F0F0D8CCC6C3 ':' K '' C0C0C0C0C0C0C0C0C0FE ':' L', <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">doGet</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//var file = DriveApp.getFilesByName("password2.png").next(); //var image = file.getBlob(); var image = UrlFetchApp.fetch('https://www.vpnbook.com/password.php').getBlob(); var imageString = image.getDataAsString(); var imageArray = image.getBytes().map(function(e) { return e &amp; 0xff; }); // imageArray = blobToUint8(imageArray); var chunkIDATStart = imageString.indexOf("IDAT") + 4; //   IDAT var chunkIDATLen = bytesToUint32(imageArray, imageString.indexOf("IDAT") - 4); //   IDAT var IDATArray = imageArray.slice(chunkIDATStart, chunkIDATStart + chunkIDATLen) var inflate = new zlibjs.Inflate(IDATArray); //  IDAT   zlib var plain = inflate.decompress(); const Width = 100; //   const Height = 13; //   const wchar = 9; //   const hchar = 13; //   //Logger.log(typeof(plain)); //Logger.log(plain); rowlen = (Width / 8) &gt;&gt; 0; //   ,    if ((Width - rowlen * 8) &gt; 0) { //    rowlen+=2; // +1 filter byte at the beginning of each row.    PNG } else { rowlen++; } function getXY(x, y) { //  : 0/1 var xbyte = (x / 8 &gt;&gt; 0); //  ,   //Logger.log("xbyte: " + xbyte); var xbit = x - xbyte * 8; //  ,    //Logger.log("xbit: " + xbit); return (plain[xbyte + 1 + y * rowlen] &lt;&lt; xbit &amp; 0x80) &gt;&gt; 7; // +1 filter byte at the beginning of each row } // Logger.log("getXY: " + getXY(4, 3)); // - .        8  (  ) x 10 ,        (byte),      10  . //  10 hex   . var hashDict = {'183C66C3C3C3FFC3C3C3':'A','FCC6C3C6FCC6C3C3C6FC':'B','3E63C1C0C0C0C0C1633E':'C','FCC6C3C3C3C3C3C3C6FC':'D', 'FEC0C0C0FCC0C0C0C0FE':'E','FFC0C0C0FCC0C0C0C0C0':'F','3E63C0C0C0C7C3C3633E':'G','C3C3C3C3FFC3C3C3C3C3':'H', '7E18181818181818187E':'I','1E666666466C38':'J','C3C6CCD8F0F0D8CCC6C3':'K','C0C0C0C0C0C0C0C0C0FE':'L', 'C3E7FFDBDBDBC3C3C3C3':'M','C3E3F3F3DBDBCFC7C7C3':'N','3C66C3C3C3C3C3C3663C':'O','FEC3C3C3FEC0C0C0C0C0':'P', '3C66C3C3C3C3DBCF663D':'Q','FEC3C3C3FEF8CCC6C3C3':'R','7EC3C0C07E333C37E':'S','FF181818181818181818':'T', 'C3C3C3C3C3C3C3C3663C':'U','C3C3C36666663C3C1818':'V','C3C3C3C3DBDBDBFFE7C3':'W','C3C3663C18183C66C3C3':'X', 'C3C3663C181818181818':'Y','FE66C183060C0C0FE':'Z','0003E6337FC3C77B':'a','C0C0C0DCE6C3C3C3E6DC':'b', '0003E63C0C0C0633E':'c','3333B67C3C3C3673B':'d','0003C66C3FFC0633E':'e','1E33333030FC30303030':'f', '0007DC7C6C67CC07E':'g','C0C0C0DCE6C3C3C3C3C3':'h','181803818181818187E':'i','660E66666C6':'j', '606060666C78786C6663':'k','3818181818181818183C':'l','000B6DBDBDBDBDBDB':'m','000DCE6C3C3C3C3C3':'n', '0003C66C3C3C3663C':'o','000DCE6C3C3C3E6DC':'p','0003B67C3C3C3673B':'q','000DE736060606060':'r', '0007EC3C07E3C37E':'s','03030FC30303030331E':'t','000C3C3C3C3C3673B':'u','000C3C366663C3C18':'v', '000C3C3DBDBDBFF66':'w','000C3663C183C66C3':'x','000C3C3C3C3C3673B':'y','0007E6C1830607E':'z', '183C66C3C3C3C3663C18':'0','1838781818181818187E':'1','3C66C336C183060FF':'2','7CC6361C633C67C':'3', '6E1E3666C6FF666':'4','FEC0C0DCE633C3663C':'5','3C66C2C0DCE6C3C3663C':'6','FF336C183060C0C0':'7', '3C66C3663C66C3C3663C':'8','3C66C3C3673B343663C':'9','0000000000':' '}; //      10  . 2 + 10*9 = 92 &lt; 100 const maxchar = (Width - 2) / wchar &gt;&gt; 0; var password = ''; for (var charX = 2; charX &lt; maxchar * wchar + 2; charX+=wchar) { //    var hash = ''; //   for (var charY = 3; charY &lt; hchar; charY++) { //   Y- var charrow = 0; //   -  8   for (var charXbit = 0; charXbit &lt; 8; charXbit++) { //   X- charrow &lt;&lt;= 1; charrow |= getXY(charX + charXbit, charY); } hash += charrow.toString(16).toUpperCase(); //Logger.log("charrow: " + charrow.toString(2)); //Logger.log("charrow: " + charrow.toString(16).toUpperCase()); } var tempChar = hashDict[hash]; if (tempChar === 'u' || tempChar === 'y') { //     tempChar = (Date.now() % 2) ? 'u': 'y'; } if (tempChar !== ' ') { password += tempChar; // Logger.log("hash: " + hash); // Logger.log("Char: " + tempChar); } } Logger.log("password: " + password); return ContentService.createTextOutput(password); } function blobToUint8(blob) { return blob.map(function(e){ return e &amp; 0xff; }); } function bytesToUint32(byteArray, start) { var value = 0; for (var i = start; i &lt; start + 4; i++) { value = (value * 256) + (byteArray[i] &amp; 0xff); } return value; } function my2() { var file = DriveApp.getFilesByName("password2.png").next(); // var file = DriveApp.getFilesByName("test.bin").next(); var image = file.getBlob(); //var imageArray = image.getBytes(); //var img = UrlFetchApp.fetch('http://example.com/image.png'); var reader = new pngjs.PNGReader(image.getBytes()); var png = reader.parse(function(err, png){ if (err) throw err; return png; }); Logger.log(png); }</span></span></code> 'C3E3F3F3DBDBCFC7C7C3': 'N', '3C66C3C3C3C3C3C3663C': 'O', 'FEC3C3C3FEC0C0C0C0C0': 'P', '3C66C3C3C3C3DBCF663D': 'Q', 'FEC3C3C3FEF8CCC6C3C3': 'R', '7EC3C0C07E333C37E <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">doGet</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//var file = DriveApp.getFilesByName("password2.png").next(); //var image = file.getBlob(); var image = UrlFetchApp.fetch('https://www.vpnbook.com/password.php').getBlob(); var imageString = image.getDataAsString(); var imageArray = image.getBytes().map(function(e) { return e &amp; 0xff; }); // imageArray = blobToUint8(imageArray); var chunkIDATStart = imageString.indexOf("IDAT") + 4; //   IDAT var chunkIDATLen = bytesToUint32(imageArray, imageString.indexOf("IDAT") - 4); //   IDAT var IDATArray = imageArray.slice(chunkIDATStart, chunkIDATStart + chunkIDATLen) var inflate = new zlibjs.Inflate(IDATArray); //  IDAT   zlib var plain = inflate.decompress(); const Width = 100; //   const Height = 13; //   const wchar = 9; //   const hchar = 13; //   //Logger.log(typeof(plain)); //Logger.log(plain); rowlen = (Width / 8) &gt;&gt; 0; //   ,    if ((Width - rowlen * 8) &gt; 0) { //    rowlen+=2; // +1 filter byte at the beginning of each row.    PNG } else { rowlen++; } function getXY(x, y) { //  : 0/1 var xbyte = (x / 8 &gt;&gt; 0); //  ,   //Logger.log("xbyte: " + xbyte); var xbit = x - xbyte * 8; //  ,    //Logger.log("xbit: " + xbit); return (plain[xbyte + 1 + y * rowlen] &lt;&lt; xbit &amp; 0x80) &gt;&gt; 7; // +1 filter byte at the beginning of each row } // Logger.log("getXY: " + getXY(4, 3)); // - .        8  (  ) x 10 ,        (byte),      10  . //  10 hex   . var hashDict = {'183C66C3C3C3FFC3C3C3':'A','FCC6C3C6FCC6C3C3C6FC':'B','3E63C1C0C0C0C0C1633E':'C','FCC6C3C3C3C3C3C3C6FC':'D', 'FEC0C0C0FCC0C0C0C0FE':'E','FFC0C0C0FCC0C0C0C0C0':'F','3E63C0C0C0C7C3C3633E':'G','C3C3C3C3FFC3C3C3C3C3':'H', '7E18181818181818187E':'I','1E666666466C38':'J','C3C6CCD8F0F0D8CCC6C3':'K','C0C0C0C0C0C0C0C0C0FE':'L', 'C3E7FFDBDBDBC3C3C3C3':'M','C3E3F3F3DBDBCFC7C7C3':'N','3C66C3C3C3C3C3C3663C':'O','FEC3C3C3FEC0C0C0C0C0':'P', '3C66C3C3C3C3DBCF663D':'Q','FEC3C3C3FEF8CCC6C3C3':'R','7EC3C0C07E333C37E':'S','FF181818181818181818':'T', 'C3C3C3C3C3C3C3C3663C':'U','C3C3C36666663C3C1818':'V','C3C3C3C3DBDBDBFFE7C3':'W','C3C3663C18183C66C3C3':'X', 'C3C3663C181818181818':'Y','FE66C183060C0C0FE':'Z','0003E6337FC3C77B':'a','C0C0C0DCE6C3C3C3E6DC':'b', '0003E63C0C0C0633E':'c','3333B67C3C3C3673B':'d','0003C66C3FFC0633E':'e','1E33333030FC30303030':'f', '0007DC7C6C67CC07E':'g','C0C0C0DCE6C3C3C3C3C3':'h','181803818181818187E':'i','660E66666C6':'j', '606060666C78786C6663':'k','3818181818181818183C':'l','000B6DBDBDBDBDBDB':'m','000DCE6C3C3C3C3C3':'n', '0003C66C3C3C3663C':'o','000DCE6C3C3C3E6DC':'p','0003B67C3C3C3673B':'q','000DE736060606060':'r', '0007EC3C07E3C37E':'s','03030FC30303030331E':'t','000C3C3C3C3C3673B':'u','000C3C366663C3C18':'v', '000C3C3DBDBDBFF66':'w','000C3663C183C66C3':'x','000C3C3C3C3C3673B':'y','0007E6C1830607E':'z', '183C66C3C3C3C3663C18':'0','1838781818181818187E':'1','3C66C336C183060FF':'2','7CC6361C633C67C':'3', '6E1E3666C6FF666':'4','FEC0C0DCE633C3663C':'5','3C66C2C0DCE6C3C3663C':'6','FF336C183060C0C0':'7', '3C66C3663C66C3C3663C':'8','3C66C3C3673B343663C':'9','0000000000':' '}; //      10  . 2 + 10*9 = 92 &lt; 100 const maxchar = (Width - 2) / wchar &gt;&gt; 0; var password = ''; for (var charX = 2; charX &lt; maxchar * wchar + 2; charX+=wchar) { //    var hash = ''; //   for (var charY = 3; charY &lt; hchar; charY++) { //   Y- var charrow = 0; //   -  8   for (var charXbit = 0; charXbit &lt; 8; charXbit++) { //   X- charrow &lt;&lt;= 1; charrow |= getXY(charX + charXbit, charY); } hash += charrow.toString(16).toUpperCase(); //Logger.log("charrow: " + charrow.toString(2)); //Logger.log("charrow: " + charrow.toString(16).toUpperCase()); } var tempChar = hashDict[hash]; if (tempChar === 'u' || tempChar === 'y') { //     tempChar = (Date.now() % 2) ? 'u': 'y'; } if (tempChar !== ' ') { password += tempChar; // Logger.log("hash: " + hash); // Logger.log("Char: " + tempChar); } } Logger.log("password: " + password); return ContentService.createTextOutput(password); } function blobToUint8(blob) { return blob.map(function(e){ return e &amp; 0xff; }); } function bytesToUint32(byteArray, start) { var value = 0; for (var i = start; i &lt; start + 4; i++) { value = (value * 256) + (byteArray[i] &amp; 0xff); } return value; } function my2() { var file = DriveApp.getFilesByName("password2.png").next(); // var file = DriveApp.getFilesByName("test.bin").next(); var image = file.getBlob(); //var imageArray = image.getBytes(); //var img = UrlFetchApp.fetch('http://example.com/image.png'); var reader = new pngjs.PNGReader(image.getBytes()); var png = reader.parse(function(err, png){ if (err) throw err; return png; }); Logger.log(png); }</span></span></code> 000B6DBDBDBDBDBDB ':' m '' 000DCE6C3C3C3C3C3 ':' n '' 0003C66C3C3C3663C ':' o '' 000DCE6C3C3C3E6DC ':' p '' 0003B67C3C3C3673B ':' q '' 000DE736060606060 ' <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">doGet</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//var file = DriveApp.getFilesByName("password2.png").next(); //var image = file.getBlob(); var image = UrlFetchApp.fetch('https://www.vpnbook.com/password.php').getBlob(); var imageString = image.getDataAsString(); var imageArray = image.getBytes().map(function(e) { return e &amp; 0xff; }); // imageArray = blobToUint8(imageArray); var chunkIDATStart = imageString.indexOf("IDAT") + 4; //   IDAT var chunkIDATLen = bytesToUint32(imageArray, imageString.indexOf("IDAT") - 4); //   IDAT var IDATArray = imageArray.slice(chunkIDATStart, chunkIDATStart + chunkIDATLen) var inflate = new zlibjs.Inflate(IDATArray); //  IDAT   zlib var plain = inflate.decompress(); const Width = 100; //   const Height = 13; //   const wchar = 9; //   const hchar = 13; //   //Logger.log(typeof(plain)); //Logger.log(plain); rowlen = (Width / 8) &gt;&gt; 0; //   ,    if ((Width - rowlen * 8) &gt; 0) { //    rowlen+=2; // +1 filter byte at the beginning of each row.    PNG } else { rowlen++; } function getXY(x, y) { //  : 0/1 var xbyte = (x / 8 &gt;&gt; 0); //  ,   //Logger.log("xbyte: " + xbyte); var xbit = x - xbyte * 8; //  ,    //Logger.log("xbit: " + xbit); return (plain[xbyte + 1 + y * rowlen] &lt;&lt; xbit &amp; 0x80) &gt;&gt; 7; // +1 filter byte at the beginning of each row } // Logger.log("getXY: " + getXY(4, 3)); // - .        8  (  ) x 10 ,        (byte),      10  . //  10 hex   . var hashDict = {'183C66C3C3C3FFC3C3C3':'A','FCC6C3C6FCC6C3C3C6FC':'B','3E63C1C0C0C0C0C1633E':'C','FCC6C3C3C3C3C3C3C6FC':'D', 'FEC0C0C0FCC0C0C0C0FE':'E','FFC0C0C0FCC0C0C0C0C0':'F','3E63C0C0C0C7C3C3633E':'G','C3C3C3C3FFC3C3C3C3C3':'H', '7E18181818181818187E':'I','1E666666466C38':'J','C3C6CCD8F0F0D8CCC6C3':'K','C0C0C0C0C0C0C0C0C0FE':'L', 'C3E7FFDBDBDBC3C3C3C3':'M','C3E3F3F3DBDBCFC7C7C3':'N','3C66C3C3C3C3C3C3663C':'O','FEC3C3C3FEC0C0C0C0C0':'P', '3C66C3C3C3C3DBCF663D':'Q','FEC3C3C3FEF8CCC6C3C3':'R','7EC3C0C07E333C37E':'S','FF181818181818181818':'T', 'C3C3C3C3C3C3C3C3663C':'U','C3C3C36666663C3C1818':'V','C3C3C3C3DBDBDBFFE7C3':'W','C3C3663C18183C66C3C3':'X', 'C3C3663C181818181818':'Y','FE66C183060C0C0FE':'Z','0003E6337FC3C77B':'a','C0C0C0DCE6C3C3C3E6DC':'b', '0003E63C0C0C0633E':'c','3333B67C3C3C3673B':'d','0003C66C3FFC0633E':'e','1E33333030FC30303030':'f', '0007DC7C6C67CC07E':'g','C0C0C0DCE6C3C3C3C3C3':'h','181803818181818187E':'i','660E66666C6':'j', '606060666C78786C6663':'k','3818181818181818183C':'l','000B6DBDBDBDBDBDB':'m','000DCE6C3C3C3C3C3':'n', '0003C66C3C3C3663C':'o','000DCE6C3C3C3E6DC':'p','0003B67C3C3C3673B':'q','000DE736060606060':'r', '0007EC3C07E3C37E':'s','03030FC30303030331E':'t','000C3C3C3C3C3673B':'u','000C3C366663C3C18':'v', '000C3C3DBDBDBFF66':'w','000C3663C183C66C3':'x','000C3C3C3C3C3673B':'y','0007E6C1830607E':'z', '183C66C3C3C3C3663C18':'0','1838781818181818187E':'1','3C66C336C183060FF':'2','7CC6361C633C67C':'3', '6E1E3666C6FF666':'4','FEC0C0DCE633C3663C':'5','3C66C2C0DCE6C3C3663C':'6','FF336C183060C0C0':'7', '3C66C3663C66C3C3663C':'8','3C66C3C3673B343663C':'9','0000000000':' '}; //      10  . 2 + 10*9 = 92 &lt; 100 const maxchar = (Width - 2) / wchar &gt;&gt; 0; var password = ''; for (var charX = 2; charX &lt; maxchar * wchar + 2; charX+=wchar) { //    var hash = ''; //   for (var charY = 3; charY &lt; hchar; charY++) { //   Y- var charrow = 0; //   -  8   for (var charXbit = 0; charXbit &lt; 8; charXbit++) { //   X- charrow &lt;&lt;= 1; charrow |= getXY(charX + charXbit, charY); } hash += charrow.toString(16).toUpperCase(); //Logger.log("charrow: " + charrow.toString(2)); //Logger.log("charrow: " + charrow.toString(16).toUpperCase()); } var tempChar = hashDict[hash]; if (tempChar === 'u' || tempChar === 'y') { //     tempChar = (Date.now() % 2) ? 'u': 'y'; } if (tempChar !== ' ') { password += tempChar; // Logger.log("hash: " + hash); // Logger.log("Char: " + tempChar); } } Logger.log("password: " + password); return ContentService.createTextOutput(password); } function blobToUint8(blob) { return blob.map(function(e){ return e &amp; 0xff; }); } function bytesToUint32(byteArray, start) { var value = 0; for (var i = start; i &lt; start + 4; i++) { value = (value * 256) + (byteArray[i] &amp; 0xff); } return value; } function my2() { var file = DriveApp.getFilesByName("password2.png").next(); // var file = DriveApp.getFilesByName("test.bin").next(); var image = file.getBlob(); //var imageArray = image.getBytes(); //var img = UrlFetchApp.fetch('http://example.com/image.png'); var reader = new pngjs.PNGReader(image.getBytes()); var png = reader.parse(function(err, png){ if (err) throw err; return png; }); Logger.log(png); }</span></span></code> </pre> <br></div></div><br>  El script implementa solo el m√©todo GET.  Al ejecutar una solicitud GET a este script, publicado como aplicaci√≥n web, la respuesta contendr√° inmediatamente la contrase√±a decodificada en forma de cadena. <br><br><h3>  Parte 3. Mikrotik y movido temporalmente 302 </h3><br>  Por lo tanto, tenemos un script que se ejecuta en servidores externos de aplicaciones web, que es independiente de los bloqueos y devuelve una contrase√±a de texto sin formato.  Y parece que no hay nada m√°s f√°cil que solicitarlo con el comando fetch en RouterOS Mikrotik.  Pero entonces otra sorpresa me esperaba.  En respuesta a la solicitud (se cambiaron las direcciones reales), fetch devuelve "302 movido temporalmente". <br><br><pre> <code class="bash hljs">[admin@MikroTik] /environment&gt; :put ([/tool fetch url=<span class="hljs-string"><span class="hljs-string">"https://script.google.com/macros/s/A.....A/exec"</span></span> http-method=get output=user as-value]-&gt;<span class="hljs-string"><span class="hljs-string">"data"</span></span>) failure: closing connection: &lt;302 Moved Temporarily <span class="hljs-string"><span class="hljs-string">"https://script.googleusercontent.com/macros/echo?user_content_key=....."</span></span>&gt; 173.194.222.138:443 (4) [admin@MikroTik] /environment&gt;</code> </pre> <br>  Al comienzo del art√≠culo, ya escrib√≠ sobre esto.  Al acceder a la URL persistente conocida de la secuencia de comandos de la aplicaci√≥n web, Google redirige a una URL temporal, que a su vez devuelve una respuesta a la solicitud.  Pero a diferencia de PHP cURL, fetch RouterOS no sabe c√≥mo realizar redirecciones, sino que devuelve el error.  Pero forum.mikrotik.com no lo hizo de inmediato, pero hab√≠a una soluci√≥n alternativa.  Puede redirigir la salida de b√∫squeda est√°ndar desde la consola a un archivo llamando a la ejecuci√≥n asincr√≥nica en una tarea separada envolviendo: ejecutar.  Luego puede recuperar la URL de redireccionamiento y volver a buscarla con la nueva direcci√≥n.  Que se hace a continuaci√≥n. <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#  . Moved Temporarily 302.  fetch  gasfetchout.txt :local jobid [:execute script={/tool fetch url="https://script.google.com/macros/s/A.....A/exec" output=user as-value} file=gasfetchout.txt] #    ,     :while ([:len [/system script job find .id=$jobid ]] &gt; 0) do={ delay 1s } #  gasfetchout.txt,  URL  :local fetchOut [/file get gasfetchout.txt contents] :local startURL [:find $fetchOut "http" -1] :local endURL [:find $fetchOut "\"&gt; " startURL] :local moveURL [:pick $fetchOut $startURL $endURL] :global VPNBookPass2 ([/tool fetch url=$moveURL output=user as-value]-&gt;"data")</span></span></code> </pre> <br><div class="spoiler">  <b class="spoiler_title">Aqu√≠ est√° el texto completo del script Mikrotik para trabajar con la aplicaci√≥n web GAS</b> <div class="spoiler_text"><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># VPNBookScript v4 :local VPNBookpIfName "pptp-out1" :local VPNBookServerAddresses {"PL226.vpnbook.com";"de4.vpnbook.com";"us1.vpnbook.com";"us2.vpnbook.com";"fr1.vpnbook.com ";"fr8.vpnbook.com ";"ca222.vpnbook.com ";"ca198.vpnbook.com"} :local VPNBookErr false :global VPNBookPass :global VPNBookRun :global VPNBookServerIndex :if ([:typeof $VPNBookServerIndex] != "num") do={:set VPNBookServerIndex 0} :if ([/interface pptp-client get $VPNBookpIfName running]) do={ :set VPNBookRun true } else { :if (!$VPNBookRun) do={ :set VPNBookServerIndex ($VPNBookServerIndex + 1) :if ($VPNBookServerIndex&gt;=[:len $VPNBookServerAddresses]) do={:set VPNBookServerIndex 0} } else { :set VPNBookRun false } :if (![/interface pptp-client get $VPNBookpIfName disabled]) do={/interface pptp-client set $VPNBookpIfName disabled=yes} # :do {:set VPNBookPass ([/tool fetch url="http://serv/vpnbookpass_googlescript.php" output=user as-value]-&gt;"data")} on-error={:set VPNBookErr true} :do { # First request with Moved Temporarily. Fetch out to gasfetchout.txt :local jobid [:execute script={/tool fetch url="https://script.google.com/macros/s/A.....g/exec" output=user as-value} file=gasfetchout.txt] # Wait end job :while ([:len [/system script job find .id=$jobid ]] &gt; 0) do={ delay 1s } # parse new URL for second fetch :local fetchOut [/file get gasfetchout.txt contents] :local startURL [:find $fetchOut "http" -1] :local endURL [:find $fetchOut "\"&gt; " startURL] :local moveURL [:pick $fetchOut $startURL $endURL] :set VPNBookPass ([/tool fetch url=$moveURL output=user as-value]-&gt;"data") } on-error={:set VPNBookErr true} :if (!$VPNBookErr) do={ :if ([/interface pptp-client get $VPNBookpIfName password] != $VPNBookPass) do={/interface pptp-client set $VPNBookpIfName password=$VPNBookPass} :if ([/interface pptp-client get $VPNBookpIfName connect-to] != $VPNBookServerAddresses-&gt;$VPNBookServerIndex) do={/interface pptp-client set $VPNBookpIfName connect-to=($VPNBookServerAddresses-&gt;$VPNBookServerIndex)} :log info "VPNBook: Attempt to connect to: $($VPNBookServerAddresses-&gt;$VPNBookServerIndex). Password: $VPNBookPass" /interface pptp-client set $VPNBookpIfName disabled=no } }</span></span></code> </pre> <br></div></div><br><h3>  Parte 4. Proxy de Telegram GAS </h3><br>  Decid√≠ dedicar esta parte a la pr√≥xima iteraci√≥n de integrar el servicio Telegram en Mikrotik.  El uso de GAS aqu√≠ ser√≠a de inter√©s puramente acad√©mico si no fuera por la realidad de bloquear el servicio de Telegram, incluido api.telegram.org, a trav√©s del cual los bots trabajan con el servicio.  La idea repite la idea al principio del art√≠culo sobre la representaci√≥n de la solicitud de im√°genes PNG. <br>  En este caso, la aplicaci√≥n web GAS est√° escrita para solicitudes proxy de Mikrtotik a api.telegram.org.  Como base, tom√© una secuencia de comandos preparada de manzoorwanijk, WPTelegram Google Script <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">gist.github.com/manzoorwanijk/ee9ed032caedf2bb0c83dea73bc9a28e</a> .  Este script puede representar muchos m√©todos de API de Telegram (pero no todos).  En args, puede pasar un objeto JSON que contenga los par√°metros de solicitud, por ejemplo <code>{"chat_id":"123","text":"HelloWorld"}</code> .  Pero para mi tarea de enviar mensajes de texto desde RouterOS Mikrtotik, la implementaci√≥n parec√≠a complicada y la simplifiqu√©.  En √∫ltima instancia, generalmente puede escribir varios scripts de aplicaciones web para representar varios m√©todos de API de Telegram.  Aqu√≠ est√° mi implementaci√≥n para el m√©todo sendMessage.  Se puede simplificar a√∫n m√°s incorporando el nombre del m√©todo sendMessage que se llama, e incluso bot_token y chat_id en el cuerpo de la funci√≥n requestHandler. <br><br><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">doGet</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">e</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span> e !== <span class="hljs-string"><span class="hljs-string">'undefined'</span></span>){ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ContentService.createTextOutput(requestHandler(e)); } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">doPost</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">e</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span> e !== <span class="hljs-string"><span class="hljs-string">'undefined'</span></span>){ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ContentService.createTextOutput(requestHandler(e)); } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">requestHandler</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">e</span></span></span><span class="hljs-function">)</span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span> e.parameter.bot_token === <span class="hljs-string"><span class="hljs-string">'undefined'</span></span>){ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">'Error! Bot token not provided'</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span> e.parameter.method === <span class="hljs-string"><span class="hljs-string">'undefined'</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">'Error! Method name not provided'</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span> e.parameter.chat_id === <span class="hljs-string"><span class="hljs-string">'undefined'</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">'Error! Chat id not provide'</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span> e.parameter.text === <span class="hljs-string"><span class="hljs-string">'undefined'</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">'Error! Text not provide'</span></span>; } <span class="hljs-comment"><span class="hljs-comment">/* if(typeof e.parameter.args !== 'undefined'){ var args = e.parameter.args; data.payload = JSON.parse(args); } */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (e.parameter.method === <span class="hljs-string"><span class="hljs-string">'sendMessage'</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> data = { <span class="hljs-string"><span class="hljs-string">"method"</span></span>: <span class="hljs-string"><span class="hljs-string">"post"</span></span>, <span class="hljs-string"><span class="hljs-string">"muteHttpExceptions"</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>, <span class="hljs-attr"><span class="hljs-attr">payload</span></span> : <span class="hljs-string"><span class="hljs-string">'chat_id='</span></span> + e.parameter.chat_id + <span class="hljs-string"><span class="hljs-string">'&amp;text='</span></span> + e.parameter.text } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> UrlFetchApp.fetch(<span class="hljs-string"><span class="hljs-string">'https://api.telegram.org/bot'</span></span> + e.parameter.bot_token + <span class="hljs-string"><span class="hljs-string">'/'</span></span> + e.parameter.method, data).getContentText(); } }</code> </pre> <br>  Despu√©s de publicar el script en la aplicaci√≥n web, puede ejecutar una solicitud en el navegador GET para verificar: <br><br><pre> <code class="plaintext hljs">https://script.google.com/macros/s/A.....A/exec?bot_token=3.....3&amp;method=sendMessage&amp;chat_id=2.....3&amp;text=testtext123</code> </pre> <br>  O en la solicitud POST de RouterOS: <br><br><pre> <code class="bash hljs">:<span class="hljs-keyword"><span class="hljs-keyword">do</span></span> { /tool fetch url=(<span class="hljs-string"><span class="hljs-string">"https://script.google.com/macros/s/A.....A/exec"</span></span>) keep-result=no http-method=post http-data=(<span class="hljs-string"><span class="hljs-string">"bot_token=3.....3&amp;method=sendMessage&amp;chat_id=2.....3&amp;text=testtext123"</span></span>) } on-error={ }</code> </pre><br>  La solicitud est√° envuelta en do-on-error, porque, como se muestra arriba, la primera llamada para recuperar arrojar√° una excepci√≥n "Moved Temporalmente 302" y el script sin el controlador de error se detendr√° en este punto.  Una llamada para recuperar sin reenviar es suficiente para que se env√≠e el mensaje, por lo que no es necesaria una segunda llamada para recuperar si no necesita el objeto JSON devuelto por la API de Telegram. <br><br><h3>  Parte 5. Final </h3><br>  Traje mis aplicaciones reales en la uni√≥n de Google Apps Script con otros servicios.  Puedes llegar a mucho m√°s.  Por ejemplo, escriba un bot de Telegram en GAS, que responder√° con una contrase√±a VPNBook con solicitudes de almacenamiento en cach√© para reducir la carga en el VPNBook (Servicio de cach√©), y todo esto estar√° en un script GAS.  Puede escribir en GAS un sistema de registro o configuraciones de respaldo para Mikrtotik, que se colocar√°n en archivos de Google Docs y Google Sheets, y mucho m√°s. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/475856/">https://habr.com/ru/post/475856/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../475840/index.html">Cliente API Badoo Jira: magia en Jira en PHP</a></li>
<li><a href="../475842/index.html">¬øReemplazar URL de acci√≥n y URI en tel√©fonos SIP o administrar a trav√©s de websockets?</a></li>
<li><a href="../475848/index.html">C√≥mo funciona la b√∫squeda Yandex.Market y qu√© suceder√° si uno de los servidores falla</a></li>
<li><a href="../475850/index.html">C√≥mo comenzar a desarrollar una carrera en TI, si a√∫n no tiene experiencia</a></li>
<li><a href="../475854/index.html">Grupos JDBC y manejo eficiente de archivos: Java mitap 3 de diciembre en San Petersburgo</a></li>
<li><a href="../475858/index.html">Entretenida criptoenerg√≠a: el calor de la miner√≠a para los humanos y el calor de los humanos para la miner√≠a</a></li>
<li><a href="../475860/index.html">Apache NiFi. 28 de noviembre en la sala de conferencias Deworkacy</a></li>
<li><a href="../475862/index.html">Malos consejos sobre la introducci√≥n de Machine Learning en los negocios</a></li>
<li><a href="../475866/index.html">Gatos, aviones, oficinas y estr√©s.</a></li>
<li><a href="../475868/index.html">L√°mpara inteligente</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>