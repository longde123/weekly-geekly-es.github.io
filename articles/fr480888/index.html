<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>‚úäüèø üöü üõ≥Ô∏è Coroutines de bricolage. Partie 1. G√©n√©rateurs paresseux üññüèæ ü§±üèΩ üÜï</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Dans le monde JVM, les coroutines sont mieux connues gr√¢ce au langage Kotlin et Project Loom . Je n'ai pas vu une bonne description du principe des co...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Coroutines de bricolage. Partie 1. G√©n√©rateurs paresseux</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/haulmont/blog/480888/"><p>  Dans le monde JVM, les coroutines sont mieux connues gr√¢ce au langage Kotlin et <a href="https://habr.com/ru/company/jugru/blog/422519/">Project Loom</a> .  Je n'ai pas vu une bonne description du principe des coroutines Kotlinovsky, et le code de la biblioth√®que kotlin-coroutines est compl√®tement incompr√©hensible pour une personne non pr√©par√©e.  D'apr√®s mon exp√©rience, la plupart des gens ne connaissent des coroutines que ce sont des "flux l√©gers" et que dans kotlin, ils fonctionnent gr√¢ce √† la g√©n√©ration de bytecode intelligent.  J'√©tais donc jusqu'√† r√©cemment.  Et l'id√©e m'est venue que puisque les coroutines peuvent √™tre impl√©ment√©es en bytecode, pourquoi ne pas les impl√©menter en java.  De cette id√©e, par la suite, une petite biblioth√®que assez simple est apparue, dont l'appareil, je l'esp√®re, peut √™tre compris par presque tous les d√©veloppeurs.  D√©tails sous la coupe. </p><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/2_/7f/s4/2_7fs4po74_uoaqwmucjmnyjcuw.jpeg"></div><a name="habracut"></a><br><h3 id="ishodnyy-kod">  Code source </h3><br><p>  J'ai appel√© le projet Microutines, qui venait des mots Micro et Coroutines. </p><br><p>  Tout le code est disponible sur <a href="https://github.com/alexander-shustanov/microutines">github</a> .  Au d√©part, je voulais construire le r√©cit en fonction du d√©veloppement de ma propre compr√©hension du sujet, parler de mes mauvaises d√©cisions et id√©es, du d√©veloppement de l'API, mais ensuite le code de l'article serait tr√®s diff√©rent du code avec github (ce qui est in√©vitable dans tous les cas, j'√©cris un article fois, et sur github comique de temps en temps).  Par cons√©quent, je d√©crirai principalement la version finale de la biblioth√®que, et si certaines parties de l'API ne sont pas tr√®s claires √† premi√®re vue, elles sont probablement n√©cessaires pour r√©soudre les probl√®mes que nous examinerons dans les articles suivants. </p><br><h3 id="disclaimer">  Clause de non-responsabilit√© </h3><br><p>  Il s'agit d'une sorte de projet de formation.  Je serai heureux si l'un des lecteurs l'incline √† jouer ou m√™me √† lancer une demande de tirage.  Mais l'utiliser en production n'en vaut pas la peine.  La meilleure fa√ßon de comprendre une technologie en profondeur est de la mettre en ≈ìuvre vous-m√™me, ce qui est le seul objectif de ce projet. </p><br><p>  Et je ne garantis pas l'exactitude des termes utilis√©s.  Peut-√™tre certains d'entre eux que j'ai entendus quelque part, mal m√©moris√©s, et certains d'entre eux sont m√™me venus avec moi et ont oubli√©. </p><br><h3 id="chto-takoe-korutiny">  Que sont les coroutines </h3><br><p> Comme je l'ai d√©j√† remarqu√©, on dit souvent √† propos des coroutines qu'il s'agit de ¬´flux facilit√©s¬ª.  Ce n'est pas une vraie d√©finition.  Je ne donnerai pas non plus une vraie d√©finition, mais j'essaierai de d√©crire ce qu'elles sont, des coroutines.  L'appel de flux coroutines ne sera pas enti√®rement correct.  Coroutine est une unit√© de planification plus petite qu'un flux, et un flux, √† son tour, est plus petit qu'une unit√© de planification.  La planification des processus et des threads est g√©r√©e par le syst√®me d'exploitation.  Corutin est engag√© dans la planification ... nous serons nous-m√™mes engag√©s dans leur planification.  Les coroutines fonctionnent au-dessus des threads normaux, et leur principal truc est qu'elles ne bloquent pas le thread lorsqu'elles attendent qu'une autre t√¢che soit termin√©e, mais la lib√®rent pour une autre coroutine.  Cette approche est appel√©e multit√¢che coop√©ratif.  Corutin peut fonctionner d'abord dans un fil, puis dans un autre.  Un thread pour coroutine agit comme une ressource, et un million de coroutines peuvent fonctionner sur un seul thread.  Vous pouvez voir cette photo: </p><br><p><img src="https://habrastorage.org/webt/41/xu/3j/41xu3j8m3cgly0vdiixkaomex2o.png"></p><br><p>  Les t√¢ches des contributions 1 et des contributions 2 r√©pondent √† une sorte de demande et ne bloquent pas le flux en attendant les r√©ponses, mais suspendent leur travail et le poursuivent apr√®s avoir re√ßu les r√©ponses.  Nous pouvons √©crire un tel code √† l'aide de rappels, dites-vous.  C'est vrai, mais l'essence de coroutine est que nous √©crivons du code sans rappel, nous √©crivons du code s√©quentiel ordinaire qui s'ex√©cute de mani√®re asynchrone. </p><br><h3 id="generatory">  G√©n√©rateurs </h3><br><p>  Nous allons commencer le d√©veloppement de simple √† complexe.  La premi√®re chose que nous ferons est la g√©n√©ration de collection paresseuse, impl√©ment√©e dans certaines langues √† l'aide du mot-cl√© yield.  Les g√©n√©rateurs ne sont pas accidentels ici, comme nous le verrons plus tard, et les g√©n√©rateurs et coroutines peuvent √™tre impl√©ment√©s en utilisant le m√™me m√©canisme. </p><br><p>  Prenons un exemple en python, simplement parce que les g√©n√©rateurs sont pr√™ts √† l'emploi. </p><br><pre><code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">generator</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">:</span></span> k = <span class="hljs-number"><span class="hljs-number">10</span></span> <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span> k k += <span class="hljs-number"><span class="hljs-number">10</span></span> <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span> k k += <span class="hljs-number"><span class="hljs-number">10</span></span> <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span> k <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> i <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> generator(): print(i)</code> </pre> <br><p>  Le cycle se d√©roule en quelque chose comme √ßa (peut-√™tre pas tout √† fait comme √ßa, mais le principe est important pour nous): </p><br><pre> <code class="python hljs">gen = generator() <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> <span class="hljs-keyword"><span class="hljs-keyword">True</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">try</span></span>: i = next(gen) print(i) <span class="hljs-keyword"><span class="hljs-keyword">except</span></span> StopIteration: <span class="hljs-keyword"><span class="hljs-keyword">break</span></span></code> </pre> <br><p>  Un appel √† <code>generator()</code> cr√©era un it√©rateur sp√©cial appel√© g√©n√©rateur.  Le premier appel √† <code>next(gen)</code> ex√©cute le code depuis le d√©but de la fonction <code>generator</code> jusqu'au premier <code>yield</code> , et la valeur de la variable locale <code>k</code> de <code>genertator()</code> √©crite dans la variable <code>i</code> .  Chaque prochain appel au <code>next</code> continuera √† ex√©cuter la fonction avec l'instruction suivant imm√©diatement le <code>yield</code> pr√©c√©dent <code>yield</code> et ainsi de suite.  Dans ce cas, entre les <code>next</code> appels, les valeurs de toutes les variables locales √† l'int√©rieur du <code>generator</code> sont enregistr√©es. </p><br><p>  C'est √† peu pr√®s la m√™me chose, mais dans la langue Kotlin. </p><br><pre> <code class="kotlin hljs"><span class="hljs-keyword"><span class="hljs-keyword">val</span></span> seq = sequence { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> i = <span class="hljs-number"><span class="hljs-number">10</span></span> yield(i) i += <span class="hljs-number"><span class="hljs-number">10</span></span> yield(i) i += <span class="hljs-number"><span class="hljs-number">10</span></span> yield(i) } <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (i <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> seq) { println(i) }</code> </pre> <br><p>  En Java, nous pourrions faire quelque chose comme la g√©n√©ration paresseuse: </p><br><pre> <code class="java hljs">Iterable&lt;Integer&gt; seq = DummySequence.first(() -&gt; { <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">10</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> DummySequence.next(i, () -&gt; { <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i1 = i + <span class="hljs-number"><span class="hljs-number">10</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> DummySequence.next(i1, () -&gt; DummySequence.end(i1 + <span class="hljs-number"><span class="hljs-number">10</span></span>)); }); }); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i: seq) { System.out.println(i); }</code> </pre> <br><div class="spoiler">  <b class="spoiler_title">Impl√©mentation de DummySequence</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.junit.Assert; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.junit.Test; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.util.Iterator; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.util.List; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.util.function.Supplier; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.util.stream.Collectors; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.util.stream.StreamSupport; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">DummySequenceTest</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Test</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">dummySequenceTest</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ DummySequence&lt;Integer&gt; sequence = DummySequence.first(() -&gt; { <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">10</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> DummySequence.next(<span class="hljs-number"><span class="hljs-number">10</span></span>, () -&gt; { <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i1 = i + <span class="hljs-number"><span class="hljs-number">10</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> DummySequence.next(i1, () -&gt; DummySequence.end(i1 + <span class="hljs-number"><span class="hljs-number">10</span></span>)); }); }); List&lt;Integer&gt; list = StreamSupport.stream(sequence.spliterator(), <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>) .collect(Collectors.toList()); Assert.assertEquals(<span class="hljs-number"><span class="hljs-number">10</span></span>, ((<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>) list.get(<span class="hljs-number"><span class="hljs-number">0</span></span>))); Assert.assertEquals(<span class="hljs-number"><span class="hljs-number">20</span></span>, ((<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>) list.get(<span class="hljs-number"><span class="hljs-number">1</span></span>))); Assert.assertEquals(<span class="hljs-number"><span class="hljs-number">30</span></span>, ((<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>) list.get(<span class="hljs-number"><span class="hljs-number">2</span></span>))); } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">DummySequence</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">T</span></span></span><span class="hljs-class">&gt; </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Iterable</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">T</span></span></span><span class="hljs-class">&gt;, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Iterator</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">T</span></span></span><span class="hljs-class">&gt; </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Step&lt;T&gt; step; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">DummySequence</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Step&lt;T&gt; step)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.step = step; } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Iterator&lt;T&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">iterator</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>; } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">hasNext</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (step <span class="hljs-keyword"><span class="hljs-keyword">instanceof</span></span> EndStep) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; step = step.nextStep(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> T </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">next</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> step.getValue(); } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> &lt;T&gt; <span class="hljs-function"><span class="hljs-function">DummySequence&lt;T&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">first</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Supplier&lt;Step&lt;T&gt;&gt; next)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> DummySequence&lt;&gt;(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> FirstStep&lt;T&gt;(next)); } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> &lt;T&gt; <span class="hljs-function"><span class="hljs-function">Step&lt;T&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">next</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(T value, Supplier&lt;Step&lt;T&gt;&gt; next)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> IntermediateStep&lt;&gt;(value, next); } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> &lt;T&gt; <span class="hljs-function"><span class="hljs-function">Step&lt;T&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">end</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(T value)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> EndStep&lt;&gt;(value); } } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Step</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">T</span></span></span><span class="hljs-class">&gt; </span></span>{ <span class="hljs-function"><span class="hljs-function">T </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getValue</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; <span class="hljs-function"><span class="hljs-function">Step&lt;T&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">nextStep</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">FirstStep</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">T</span></span></span><span class="hljs-class">&gt; </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Step</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">T</span></span></span><span class="hljs-class">&gt; </span></span>{ Supplier&lt;Step&lt;T&gt;&gt; nextStep; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">FirstStep</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Supplier&lt;Step&lt;T&gt;&gt; next)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.nextStep = next; } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> T </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getValue</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> IllegalStateException(); } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Step&lt;T&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">nextStep</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> nextStep.get(); } } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">IntermediateStep</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">T</span></span></span><span class="hljs-class">&gt; </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Step</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">T</span></span></span><span class="hljs-class">&gt; </span></span>{ T value; Supplier&lt;Step&lt;T&gt;&gt; nextStep; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">IntermediateStep</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(T value, Supplier&lt;Step&lt;T&gt;&gt; nextStep)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.value = value; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.nextStep = nextStep; } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> T </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getValue</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> value; } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Step&lt;T&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">nextStep</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> nextStep.get(); } } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">EndStep</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">T</span></span></span><span class="hljs-class">&gt; </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Step</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">T</span></span></span><span class="hljs-class">&gt; </span></span>{ T value; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">EndStep</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(T value)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.value = value; } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> T </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getValue</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> value; } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Step&lt;T&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">nextStep</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> IllegalStateException(); } } }</code> </pre> </div></div><br><p>  Chaque lambda imbriqu√© suivant capture toutes les variables de tous les lambdas pr√©c√©dents et n'est ex√©cut√© que lorsque l'√©l√©ment suivant est demand√©.  Le r√©sultat de chaque lambda sera l'√©l√©ment g√©n√©r√© et le bloc de code suivant.  Cela a l'air tr√®s √©trange, et je doute que quelqu'un √©crive comme √ßa.  Nous d√©notons l'id√©al que nous viserons (et nous le r√©aliserons, sauf que nous utiliserons une classe anonyme au lieu de lambdas). </p><br><pre> <code class="java hljs">Sequence&lt;Integer&gt; sequence = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Sequence&lt;Integer&gt;(() -&gt; { <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">10</span></span>; yield(i); i += <span class="hljs-number"><span class="hljs-number">10</span></span>; yield(i); i += <span class="hljs-number"><span class="hljs-number">10</span></span>; yield(i); });</code> </pre> <br><p>  La fonction pass√©e au constructeur Sequence ne doit passer de <code>yield</code> √† <code>yield</code> que si n√©cessaire, les valeurs des variables locales doivent √™tre stock√©es entre les appels √† <code>sequence.next()</code> .  Cette sauvegarde de la pile et du num√©ro de la derni√®re instruction ex√©cut√©e est appel√©e <em>pr√©emption</em> (le rendement est traduit en russe) ou <em>suspension</em> . </p><br><h3 id="kontinuacii">  Continuation </h3><br><p>  Un morceau qui peut √™tre √©vinc√© s'appelle Continuation.  La suite est traduite en russe par ¬´continuation¬ª, mais je l'appellerai continuation.  Wikipedia √©crit sur la suite: </p><br><blockquote>  Continuation (Eng. Continuation) repr√©sente l'√©tat du programme √† un certain moment, qui peut √™tre enregistr√© et utilis√© pour passer √† cet √©tat.  Les suites contiennent toutes les informations pour continuer √† ex√©cuter un programme √† partir d'un point sp√©cifique. </blockquote><p>  Supposons que nous ayons d√©j√† une sorte de mani√®re magique impl√©ment√©e le m√©canisme de continuations, qui est repr√©sent√© par l'interface suivante.  La m√©thode <code>run</code> peut arr√™ter son ex√©cution.  Chaque appel suivant reprend l'ex√©cution √† partir du dernier <code>yield</code> .  Nous pouvons consid√©rer la continuation comme un <code>Runnable</code> qui peut √™tre ex√©cut√© en plusieurs parties. </p><br><pre> <code class="java hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Continuation</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">T</span></span></span><span class="hljs-class">&gt; </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">run</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(SequenceScope&lt;T&gt; scope)</span></span></span></span>; }</code> </pre> <br><p>  Nous utiliserons la suite comme ceci: </p><br><pre> <code class="java hljs">Sequence&lt;Integer&gt; sequence = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Sequence&lt;&gt;(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Continuation&lt;&gt;() { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">run</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(SequenceScope&lt;Integer&gt; scope)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">1</span></span>; System.out.println(<span class="hljs-string"><span class="hljs-string">"Continuation start"</span></span>); scope.yield(i++); System.out.println(<span class="hljs-string"><span class="hljs-string">"Continuation resume"</span></span>); scope.yield(i++); System.out.println(<span class="hljs-string"><span class="hljs-string">"Continuation resume"</span></span>); scope.yield(i++); System.out.println(<span class="hljs-string"><span class="hljs-string">"Continuation end"</span></span>); } }); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>(Integer i: sequence) { System.out.println(<span class="hljs-string"><span class="hljs-string">"Next element :"</span></span> + i); }</code> </pre> <br><p>  Et nous nous attendons √† obtenir cette conclusion: </p><br><div class="spoiler">  <b class="spoiler_title">Sortie</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">Continuation start Next element: 1 Continuation resume Next element: 2 Continuation resume Next element: 3 Continuation end</code> </pre> </div></div><br><p>  <code>Sequence</code> √† la demande de l'√©l√©ment suivant appellera <code>Continuation.run(scope)</code> , qui ex√©cutera un bloc de code jusqu'au prochain rendement et sera √©vinc√©.  Le prochain appel √† <code>Continuation.run(scope)</code> d√©marrera le travail √† partir du dernier emplacement d'√©viction et ex√©cutera le code jusqu'au prochain <code>yield</code> .  <code>Sequence</code> code de <code>Sequence</code> pourrait ressembler √† ceci: </p><br><pre> <code class="java hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Sequence</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Iterator</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">T</span></span></span><span class="hljs-class">&gt;, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SequenceScope</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">T</span></span></span><span class="hljs-class">&gt;, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Iterable</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">T</span></span></span><span class="hljs-class">&gt; </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Object STOP = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Object(); <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Object next = STOP; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Continuation&lt;T&gt; nextStep; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Sequence</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Continuation&lt;T&gt; nextStep)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.nextStep = nextStep; } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">hasNext</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (next == STOP) { nextStep.run(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> next != STOP; } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> T </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">next</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (next == STOP) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!hasNext()) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> NoSuchElementException(); } } T result = (T) next; next = STOP; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> result; } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">yield</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(T t)</span></span></span><span class="hljs-function"> </span></span>{ next = t; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Iterator&lt;T&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">iterator</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//  ,       return this; } } interface SequenceScope&lt;T&gt; { void yield(T t); }</span></span></code> </pre> <br><p>  Tout va bien, sauf que java n'est pas en mesure d'arr√™ter l'ex√©cution de la m√©thode dans un endroit arbitraire, afin qu'il puisse ensuite continuer l'ex√©cution √† partir du lieu du dernier arr√™t.  Par cons√©quent, nous devrons le faire manuellement.  Nous introduisons le champ label, dans lequel nous enregistrerons le num√©ro du dernier rendement appel√©. </p><br><pre> <code class="java hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">IntegerSequenceContinuation</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Continuation</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Integer</span></span></span><span class="hljs-class">&gt; </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> label = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">run</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(SequenceScope&lt;Integer&gt; scope)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.i; <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> (label) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>: System.out.println(<span class="hljs-string"><span class="hljs-string">"Continuation start"</span></span>); scope.yield(i++); label = <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.i = i; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>: System.out.println(<span class="hljs-string"><span class="hljs-string">"Continuation resume"</span></span>); scope.yield(i++); label = <span class="hljs-number"><span class="hljs-number">2</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.i = i; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span>: System.out.println(<span class="hljs-string"><span class="hljs-string">"Continuation resume"</span></span>); scope.yield(i++); label = <span class="hljs-number"><span class="hljs-number">3</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.i = i; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-number"><span class="hljs-number">3</span></span>: System.out.println(<span class="hljs-string"><span class="hljs-string">"Continuation end"</span></span>); label = <span class="hljs-number"><span class="hljs-number">4</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">default</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> RuntimeException(); } } }</code> </pre> <br><p>  Nous avons une machine √† √©tats (machine √† √©tats finis), et dans l'ensemble c'est exactement ce que fait Kotlin dans ses coroutines (vous pouvez d√©compiler et voir si, bien s√ªr, vous comprenez quelque chose).  Nous avons 4 √©tats, chaque appel ex√©cut√© ex√©cute un morceau de code et effectue la transition vers l'√©tat suivant.  Nous devons enregistrer la variable locale i dans le champ de classe.  En plus d'une complexit√© injustifi√©e, ce code a un autre probl√®me: nous pouvons passer diff√©rentes valeurs comme param√®tre de port√©e pour chaque appel d'ex√©cution.  Par cons√©quent, il serait int√©ressant d'enregistrer le param√®tre scope dans le champ de classe lors du premier appel et de continuer √† travailler avec. </p><br><p>  La continuation sur java est impl√©ment√©e en nous, mais d'une mani√®re assez √©trange et dans un seul cas.  Chaque fois que personne n'√©crira quelque chose de similaire, √©diter un tel code est difficile, lire un tel code est difficile.  Par cons√©quent, nous allons construire la machine √† √©tats apr√®s la compilation. </p><br><h3 id="suspendable--continuation">  Suspendable &amp; Continuation </h3><br><p>  Comment pouvons-nous comprendre si la poursuite a termin√© les travaux ou si elle a √©t√© suspendue?  Laissez la m√©thode <code>run</code> retourner un objet <code>SUSPEND</code> sp√©cial en cas de suspension. </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Continuation</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">T</span></span></span><span class="hljs-class">&gt; </span></span>{ Object SUSPEND = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Object() { <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">toString</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"[SUSPEND]"</span></span>; } }; <span class="hljs-function"><span class="hljs-function">T </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">run</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; }</code> </pre> <br><p>  Notez que j'ai supprim√© le param√®tre d'entr√©e de la suite.  Nous devons nous assurer que les param√®tres ne changent pas d'un appel √† l'autre, la meilleure fa√ßon de le faire est de les supprimer.  L'utilisateur, au contraire, a besoin du param√®tre <code>scope</code> (il sera utilis√© pour beaucoup de choses, mais maintenant <code>SequenceScope</code> est pass√© √† sa place, √† partir de laquelle notre <code>yield</code> est appel√©).  De plus, l'utilisateur ne veut rien savoir de <code>SUSPEND</code> et ne veut rien retourner.  Pr√©sentez l'interface <code>Suspendable</code> . </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">abstract</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Suspendable</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">C</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Scope</span></span></span><span class="hljs-class">&gt; </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">abstract</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">run</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(C scope)</span></span></span></span>; } <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Scope</span></span></span><span class="hljs-class"> </span></span>{}</code> </pre> <br><div class="spoiler">  <b class="spoiler_title">Pourquoi une classe abstraite, pas une interface?</b> <div class="spoiler_text"><p>  L'utilisation d'une classe au lieu d'une interface ne permet pas d'√©crire des lambdas et force l'√©criture de classes anonymes.  Il sera tr√®s pratique pour nous de travailler en bytecode avec des continuations comme avec des classes, car les champs locaux peuvent √™tre stock√©s dans leurs champs.  Mais les lambdas en bytecode ne ressemblent pas √† une classe.  Pour plus de d√©tails, rendez-vous <a href="https://habr.com/ru/company/haulmont/blog/432418/">ici</a> . </p></div></div><br><p>  <code>Suspendable</code> est <code>Continuation</code> au moment de la conception, tandis que <code>Continuation</code> est <code>Suspendable</code> √† l' <code>Suspendable</code> .  L'utilisateur √©crit du code au niveau <code>Suspendable</code> et le code de bas niveau de la biblioth√®que fonctionne avec <code>Continuation</code> .  Il se transforme en un apr√®s la modification du bytecode. </p><br><p>  Avant de parler de pr√©emption apr√®s avoir appel√© <code>yield</code> , mais √† l'avenir, nous devrons pr√©empter apr√®s d'autres m√©thodes.  Nous marquerons ces m√©thodes avec l'annotation <code>@Suspend</code> .  Cela s'applique pour se rendre: </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SequenceScope</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">T</span></span></span><span class="hljs-class">&gt; </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Scope</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Suspend</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">yield</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(T t)</span></span></span><span class="hljs-function"> </span></span>{...} }</code> </pre> <br><p>  N'oubliez pas que nos suites seront construites sur des automates finis.  Arr√™tons-nous ici plus en d√©tail.  On l'appelle une machine √† √©tats finis car elle a un nombre fini d'√©tats.  Pour stocker l'√©tat actuel, nous utiliserons un champ d'√©tiquette sp√©cial.  Initialement, <code></code> √©tiquette est 0 - un √©tat z√©ro (initial).  Chaque appel √† <code>Continuation.run</code> ex√©cutera une sorte de code et entrera dans un √©tat (dans un autre que celui initial).  Apr√®s chaque transition, la suite doit enregistrer toutes les variables locales, le num√©ro d'√©tat actuel et ex√©cuter <code>return SUSPEND</code> .  La transition vers l'√©tat final sera d√©not√©e par <code>return null</code> (dans les articles suivants, nous retournerons non seulement <code>null</code> ).  Un appel √† <code>Continuation.run</code> partir de l'√©tat final doit se terminer par une exception <code>ContinuationEndException</code> . </p><br><p>  Ainsi, l'utilisateur √©crit le code dans <code>Suspendable</code> , apr√®s la compilation, il se transforme en <code>Continuation</code> , avec lequel la biblioth√®que fonctionne, et, en particulier, nos g√©n√©rateurs.  La cr√©ation d'un nouveau g√©n√©rateur pour l'utilisateur ressemble √† ceci: </p><br><pre> <code class="java hljs">Sequence&lt;Integer&gt; seq = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Sequence(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Suspendable() {...});</code> </pre> <br><p>  Mais le g√©n√©rateur lui-m√™me a besoin de continuation, car il doit initialiser le <code>Continuation&lt;T&gt; nextStep;</code>  .  Pour obtenir la <code>Continuation</code> de <code>Suspendable</code> dans le code, j'ai √©crit une classe sp√©ciale <code>Magic</code> . </p><br><p><img src="https://habrastorage.org/webt/le/hn/sk/lehnsk5dh-wi0l_awsdjm9ykz8m.jpeg"></p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">package</span></span> microutine.core; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> microutine.coroutine.CoroutineScopeImpl; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.lang.reflect.Field; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Magic</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> String SCOPE = <span class="hljs-string"><span class="hljs-string">"scope$S"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> &lt;C extends Scope, R&gt; <span class="hljs-function"><span class="hljs-function">Continuation&lt;R&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">createContinuation</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Suspendable&lt;C&gt; suspendable, C scope)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { Field contextField = suspendable.getClass().getDeclaredField(SCOPE); contextField.setAccessible(<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (contextField.get(suspendable) != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> IllegalArgumentException(<span class="hljs-string"><span class="hljs-string">"Continuation already created"</span></span>); contextField.set(suspendable, scope); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (Exception e) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> RuntimeException(e); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> getContinuation(suspendable); } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> &lt;R, C extends Scope&gt; <span class="hljs-function"><span class="hljs-function">Continuation&lt;R&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getContinuation</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Suspendable suspendable)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (getScope(suspendable) == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> RuntimeException(<span class="hljs-string"><span class="hljs-string">"No continuation created for provided suspendable"</span></span>); <span class="hljs-comment"><span class="hljs-comment">//noinspection unchecked return ((Continuation&lt;R&gt;) suspendable); } private static Scope getScope(Suspendable suspendable) { try { Field contextField = suspendable.getClass().getDeclaredField(SCOPE); contextField.setAccessible(true); return (Scope) contextField.get(suspendable); } catch (Exception e) { throw new RuntimeException(e); } } }</span></span></code> </pre> <br><p>  Comment fonctionne cette magie?  Avec le param√®tre <code>scope</code> , le <code>scope$S</code> est initialis√© par r√©flexion (le champ synth√©tique que nous allons cr√©er dans le bytecode).  Une continuation n'est initialis√©e qu'une seule fois dans <code>createContinuation</code> , et une deuxi√®me tentative d'initialisation entra√Ænera une ex√©cution.  Vient ensuite la conversion de type habituelle en <code>Continuation</code> .  En g√©n√©ral, je vous ai tromp√©, toute la magie n'est pas l√†.  Puisqu'une telle conversion de type est possible, le <code>Suspendable</code> sp√©cifique pass√© <code>Suspendable</code> impl√©mente d√©j√† <code>Continuation</code> .  Et cela s'est produit lors de la compilation. </p><br><h3 id="struktura-proekta">  Structure du projet </h3><br><p>  Le projet comprendra trois parties: </p><br><ul><li>  Code de biblioth√®que (API de bas niveau et de haut niveau) </li><li>  Tests (En fait, seulement en eux maintenant vous pouvez utiliser cette biblioth√®que) </li><li>  Convertible Suspendable -&gt; Continuation (impl√©ment√© comme t√¢che gradle dans gradle buildSrc) </li></ul><br><p>  Comme le convertisseur est actuellement dans buildSrc, il sera impossible de l'utiliser quelque part en dehors de la biblioth√®que elle-m√™me.  Mais pour l'instant, nous n'en avons pas besoin.  √Ä l'avenir, nous aurons deux options: en faire un plugin s√©par√©, ou cr√©er notre propre agent java (comme le fait <a href="https://github.com/puniverse/quasar">Quasar</a> ) et effectuer des transformations lors de l'ex√©cution. </p><br><div class="spoiler">  <b class="spoiler_title">build.gradle</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">plugins { id "java" } group 'microutines' version '1.0-SNAPSHOT' sourceCompatibility = 1.8 task processYield(type: microutine.ProcessSuspendableTask) { classPath = compileJava.outputs.files + compileJava.classpath inputs.files(compileJava.outputs.files) } task processTestYield(type: microutine.ProcessSuspendableTask) { classPath = compileJava.outputs.files + compileTestJava.classpath inputs.files(compileTestJava.outputs.files) } compileJava.finalizedBy(processYield) //      compileTestJava.finalizedBy(processTestYield) repositories { mavenCentral() } dependencies { testCompile group: 'junit', name: 'junit', version: '4.12' compile group: 'junit', name: 'junit', version: '4.12' }</code> </pre> </div></div><br><p>  <code>Suspendable</code> to <code>Continuation</code> sera g√©r√© par la t√¢che TaskSuspendableTask.  Il n'y a rien d'int√©ressant dans la classe de t√¢che gr√™le, elle s√©lectionne simplement les classes n√©cessaires et les envoie pour conversion en classe <code>SuspendableConverter</code> .  C'est lui qui nous int√©resse maintenant. </p><br><h3 id="generaciya-baytkoda">  G√©n√©ration de bytecode </h3><br><p>  Pour travailler avec le bytecode, nous utiliserons la biblioth√®que OW2 ASM.  La biblioth√®que fonctionne sur le principe de l'analyseur SAX.  Nous cr√©ons un nouveau ClassReader, lui donnons une classe compil√©e sous forme de tableau d'octets et appelons la m√©thode <code>accept(ClassVisitor visitor)</code> .  ClassReader analysera le bytecode et appellera les m√©thodes appropri√©es sur le visiteur pass√© ( <code>visitMethod</code> , <code>visitClass</code> , <code>visitInsn</code> ).  Le visiteur peut travailler en mode adaptateur et d√©l√©guer les appels au visiteur suivant.  En r√®gle g√©n√©rale, le dernier visiteur est un <code>ClassWriter</code> , dans lequel le bytecode final est g√©n√©r√©.  Si la t√¢che est non lin√©aire (nous n'en avons qu'une), elle peut prendre plusieurs passes dans la classe.  Une autre approche fournie par asm consiste √† √©crire la classe dans un <code>ClassNode</code> sp√©cial et √† effectuer les transformations d√©j√† sur celui-ci.  La premi√®re approche est plus rapide, mais peut ne pas convenir √† la r√©solution de probl√®mes non lin√©aires, j'ai donc utilis√© les deux approches. </p><br><p>  <code>Suspendable</code> y a 3 classes <code>Suspendable</code> dans la conversion de <code>Suspendable</code> en <code>Continuation</code> : </p><br><ul><li>  <code>SuspendInfoCollector</code> - analyse la m√©thode <code>Suspendable.run</code> , collecte des informations sur tous les appels aux m√©thodes <code>@Suspend</code> et sur les variables locales utilis√©es. </li><li>  <code>SuspendableConverter</code> - cr√©e les champs requis, modifie la signature et le handle de la m√©thode <code>Suspendable.run</code> pour obtenir <code>Continuation.run</code> . </li><li>  <code>SuspendableMethodConverter</code> - Convertit le code de la m√©thode <code>Suspendable.run</code> .  Ajoute un code pour enregistrer et restaurer les variables locales, enregistrer l'√©tat actuel dans le champ d' <code>label</code> et passer √† l'instruction souhait√©e. </li></ul><br><p>  D√©crivons quelques points plus en d√©tail. </p><br><p>  La recherche de la m√©thode d' <code>run</code> ressemble √† ceci: </p><br><pre> <code class="java hljs">MethodNode method = classNode.methods.stream() .filter(methodNode -&gt; methodNode.name.equals(<span class="hljs-string"><span class="hljs-string">"run"</span></span>) &amp;&amp; (methodNode.access &amp; Opcodes.ACC_BRIDGE) == <span class="hljs-number"><span class="hljs-number">0</span></span>) .findFirst() .orElseThrow(() -&gt; <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> RuntimeException(<span class="hljs-string"><span class="hljs-string">"Unable to find method to convert"</span></span>));</code> </pre> <br><p>  Il est pr√©vu que dans la classe convertible, il y aura deux m√©thodes d' <code>run</code> , et l'une d'entre elles avec le modificateur de pont (ce que cela est lu <a href="https://habr.com/ru/company/haulmont/blog/426419/">ici</a> ).  Nous nous int√©ressons √† une m√©thode sans modificateur. </p><br><p>  Dans le bytecode JVM, une transition conditionnelle (et inconditionnelle) peut √™tre effectu√©e n'importe o√π.  ASM a une abstraction d' <code>Label</code> sp√©ciale (√©tiquette), qui est une position dans le bytecode.  Tout au long du code, apr√®s chaque appel aux m√©thodes <code>@Suspend</code> , nous <code>@Suspend</code> les √©tiquettes auxquelles nous effectuerons un saut conditionnel au d√©but de la m√©thode <code>run</code> . </p><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">visitCode</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//    super.visitCode(); Label startLabel = new Label(); super.visitVarInsn(Opcodes.ALOAD, THIS_VAR_INDEX); //    this super.visitFieldInsn(Opcodes.GETFIELD, myClassJvmName, "label$S$S", "I"); //  label$S$S super.visitVarInsn(Opcodes.ISTORE, labelVarIndex); //      super.visitVarInsn(Opcodes.ILOAD, labelVarIndex); //   label   super.visitIntInsn(Opcodes.BIPUSH, 0); //  0   super.visitJumpInsn(Opcodes.IF_ICMPEQ, startLabel); //      startLabel        (label == 0) for (int i = 0; i &lt; numLabels; i++) { //   ,     super.visitVarInsn(Opcodes.ILOAD, labelVarIndex); super.visitIntInsn(Opcodes.BIPUSH, i + 1); super.visitJumpInsn(Opcodes.IF_ICMPEQ, labels[i]); } super.visitTypeInsn(Opcodes.NEW, "microutine/core/ContinuationEndException"); // run      ,   super.visitInsn(Opcodes.DUP); super.visitMethodInsn(Opcodes.INVOKESPECIAL, "microutine/core/ContinuationEndException", "&lt;init&gt;", "()V", false); super.visitInsn(Opcodes.ATHROW); super.visitLabel(startLabel); // ,      }</span></span></code> </pre> <br><p>  Nous <code>@Suspend</code> des √©tiquettes apr√®s les appels des m√©thodes <code>@Suspend</code> . </p><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">visitMethodInsn</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> opcode, String owner, String name, String descriptor, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">boolean</span></span></span></span><span class="hljs-function"><span class="hljs-params"> isInterface)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">boolean</span></span> suspendPoint = Utils.isSuspendPoint(classLoader, owner, name); <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>.visitMethodInsn(opcode, owner, name, descriptor, isInterface); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (suspendPoint) { <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>.visitVarInsn(Opcodes.ALOAD, THIS_VAR_INDEX); <span class="hljs-comment"><span class="hljs-comment">//    this super.visitIntInsn(Opcodes.BIPUSH, suspensionNumber); //   ,       super.visitFieldInsn(Opcodes.PUTFIELD, myClassJvmName, "label$S$S", "I"); //     label$S$S saveFrame(); //    suspend(); super.visitLabel(labels[suspensionNumber - 1]); // ,     restoreFrame(); //    suspensionNumber++; } } private void suspend() { super.visitFieldInsn(Opcodes.GETSTATIC, "microutine/core/Continuation", "SUSPEND", "Ljava/lang/Object;"); //    Continuation.SUSPEND super.visitInsn(Opcodes.ARETURN); //   }</span></span></code> </pre> <br><h3 id="testy">  Les tests </h3><br><p>  Nous √©crivons un g√©n√©rateur qui donne trois nombres d'affil√©e. </p><br><div class="spoiler">  <b class="spoiler_title">testIntSequence</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">YieldTest</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Test</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">testIntSequence</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ Sequence&lt;Integer&gt; sequence = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Sequence&lt;Integer&gt;(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SequenceSuspendable&lt;Integer&gt;() { <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">run</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(SequenceScope&lt;Integer&gt; scope)</span></span></span><span class="hljs-function"> </span></span>{ scope.yield(<span class="hljs-number"><span class="hljs-number">10</span></span>); scope.yield(<span class="hljs-number"><span class="hljs-number">20</span></span>); scope.yield(<span class="hljs-number"><span class="hljs-number">30</span></span>); } }); List&lt;Integer&gt; list = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ArrayList&lt;&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (Integer integer : sequence) { list.add(integer); } assertEquals(<span class="hljs-number"><span class="hljs-number">10</span></span>, (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>) list.get(<span class="hljs-number"><span class="hljs-number">0</span></span>)); assertEquals(<span class="hljs-number"><span class="hljs-number">20</span></span>, (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>) list.get(<span class="hljs-number"><span class="hljs-number">1</span></span>)); assertEquals(<span class="hljs-number"><span class="hljs-number">30</span></span>, (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>) list.get(<span class="hljs-number"><span class="hljs-number">2</span></span>)); } }</code> </pre> </div></div><br><p>  Le test lui-m√™me ne repr√©sente rien d'int√©ressant, mais il est suffisamment int√©ressant pour d√©compiler le fichier de classe. </p><br><div class="spoiler">  <b class="spoiler_title">testIntSequence d√©compil√©</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">YieldTest</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">YieldTest</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ } <span class="hljs-meta"><span class="hljs-meta">@Test</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">testIntSequence</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">NamelessClass_1</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SequenceSuspendable</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Integer</span></span></span><span class="hljs-class">&gt; </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Continuation</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> SequenceScope scope$S; NamelessClass_1() { } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Object </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">run</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Object var1)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> label = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.label$S$S; SequenceScope var2; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (label != <span class="hljs-number"><span class="hljs-number">0</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (label != <span class="hljs-number"><span class="hljs-number">1</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (label != <span class="hljs-number"><span class="hljs-number">2</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (label != <span class="hljs-number"><span class="hljs-number">3</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ContinuationEndException(); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { var2 = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.scope$S; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.label$S$S = <span class="hljs-number"><span class="hljs-number">4</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; } } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { var2 = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.scope$S; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.yield(<span class="hljs-number"><span class="hljs-number">30</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.label$S$S = <span class="hljs-number"><span class="hljs-number">3</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.scope$S = var2; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Continuation.SUSPEND; } } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { var2 = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.scope$S; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.yield(<span class="hljs-number"><span class="hljs-number">20</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.label$S$S = <span class="hljs-number"><span class="hljs-number">2</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.scope$S = var2; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Continuation.SUSPEND; } } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { var2 = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.scope$S; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.yield(<span class="hljs-number"><span class="hljs-number">10</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.label$S$S = <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.scope$S = var2; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Continuation.SUSPEND; } } } Sequence&lt;Integer&gt; sequence = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Sequence(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> NamelessClass_1()); List&lt;Integer&gt; list = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ArrayList(); Iterator var3 = sequence.iterator(); <span class="hljs-keyword"><span class="hljs-keyword">while</span></span>(var3.hasNext()) { Integer integer = (Integer)var3.next(); list.add(integer); } Assert.assertEquals(<span class="hljs-number"><span class="hljs-number">10L</span></span>, (<span class="hljs-keyword"><span class="hljs-keyword">long</span></span>)(Integer)list.get(<span class="hljs-number"><span class="hljs-number">0</span></span>)); Assert.assertEquals(<span class="hljs-number"><span class="hljs-number">20L</span></span>, (<span class="hljs-keyword"><span class="hljs-keyword">long</span></span>)(Integer)list.get(<span class="hljs-number"><span class="hljs-number">1</span></span>)); Assert.assertEquals(<span class="hljs-number"><span class="hljs-number">30L</span></span>, (<span class="hljs-keyword"><span class="hljs-keyword">long</span></span>)(Integer)list.get(<span class="hljs-number"><span class="hljs-number">2</span></span>)); } }</code> </pre> </div></div><br><p>  Le code est tr√®s gonfl√©, la plupart des instructions enregistrent et restaurent le cadre de pile (variables locales).  Cependant, cela fonctionne.  L'exemple donn√© fonctionnerait parfaitement sans g√©n√©ration paresseuse.  Prenons un exemple plus difficile. </p><br><div class="spoiler">  <b class="spoiler_title">fibonacci</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">YieldTest</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Test</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">fibonacci</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ Sequence&lt;Integer&gt; sequence = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Sequence&lt;&gt;(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Suspendable&lt;Integer&gt;() { <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">run</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(SequenceScope&lt;Integer&gt; scope)</span></span></span><span class="hljs-function"> </span></span>{ scope.yield(<span class="hljs-number"><span class="hljs-number">1</span></span>); scope.yield(<span class="hljs-number"><span class="hljs-number">1</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> a = <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> b = <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>) { b += a; scope.yield(b); a += b; scope.yield(a); } } }); <span class="hljs-comment"><span class="hljs-comment">//noinspection OptionalGetWithoutIsPresent Integer tenthFibonacci = StreamSupport.stream(sequence.spliterator(), false) .skip(9).findFirst().get(); assertEquals(55, ((int) tenthFibonacci)); } }</span></span></code> </pre> </div></div><br><p>  Le code ci-dessus g√©n√®re une s√©quence de Fibonacci infinie.  Nous compilons et d√©compilons: </p><br><div class="spoiler">  <b class="spoiler_title">fibonacci d√©compil√©</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">YieldTest</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">YieldTest</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ } <span class="hljs-meta"><span class="hljs-meta">@Test</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">fibonacci</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">NamelessClass_1</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SequenceSuspendable</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Integer</span></span></span><span class="hljs-class">&gt; </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Continuation</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> SequenceScope scope$S; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> aa$S; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> ba$S; NamelessClass_1() { } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Object </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">run</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Object var1)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> label = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.label$S$S; SequenceScope var2; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (label != <span class="hljs-number"><span class="hljs-number">0</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (label != <span class="hljs-number"><span class="hljs-number">1</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> var3; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> var4; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (label != <span class="hljs-number"><span class="hljs-number">2</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (label == <span class="hljs-number"><span class="hljs-number">3</span></span>) { var2 = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.scope$S; var3 = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.aa$S; var4 = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.ba$S; var3 += var4; var2.yield(var3); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.label$S$S = <span class="hljs-number"><span class="hljs-number">4</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.scope$S = var2; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.aa$S = var3; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.ba$S = var4; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Continuation.SUSPEND; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (label != <span class="hljs-number"><span class="hljs-number">4</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ContinuationEndException(); } var2 = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.scope$S; var3 = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.aa$S; var4 = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.ba$S; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { var2 = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.scope$S; var3 = <span class="hljs-number"><span class="hljs-number">1</span></span>; var4 = <span class="hljs-number"><span class="hljs-number">1</span></span>; } var4 += var3; var2.yield(var4); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.label$S$S = <span class="hljs-number"><span class="hljs-number">3</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.scope$S = var2; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.aa$S = var3; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.ba$S = var4; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Continuation.SUSPEND; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { var2 = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.scope$S; var2.yield(<span class="hljs-number"><span class="hljs-number">1</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.label$S$S = <span class="hljs-number"><span class="hljs-number">2</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.scope$S = var2; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Continuation.SUSPEND; } } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { var2 = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.scope$S; var2.yield(<span class="hljs-number"><span class="hljs-number">1</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.label$S$S = <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.scope$S = var2; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Continuation.SUSPEND; } } } Sequence&lt;Integer&gt; sequence = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Sequence(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> NamelessClass_1()); Integer tenthFibonacci = (Integer)StreamSupport.stream(sequence.spliterator(), <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>).skip(<span class="hljs-number"><span class="hljs-number">9L</span></span>).findFirst().get(); Assert.assertEquals(<span class="hljs-number"><span class="hljs-number">55L</span></span>, (<span class="hljs-keyword"><span class="hljs-keyword">long</span></span>)tenthFibonacci); } }</code> </pre> </div></div><br><p>  Comprendre ce qui rend une classe d√©compil√©e assez difficile.  Comme la derni√®re fois, la plupart des instructions y conduisent des variables locales.  Certaines affectations sont inutiles et les variables sont imm√©diatement effiloch√©es par d'autres valeurs.         ,      . </p><br><p>          while,      .     .        .              ,     ''  <code>return SUSPEND</code> . </p><br><h3 id="rezyume">  R√©sum√© </h3><br><p> ,   ,   ,   .        yield.           ,   ,      ‚Äî ,   .      ,    (    )   .  ,   JIT     .  <code>yield</code>   <code>yieldAll</code> ‚Äî ,       ,        ,             ,    .        ,      ,    . </p><br><p>      ‚Äî  ‚Äî   ,     .         ,         .  ,          :       ,   . </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr480888/">https://habr.com/ru/post/fr480888/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr480874/index.html">L'√©tude des neutrinos a conduit √† une d√©couverte inattendue en math√©matiques</a></li>
<li><a href="../fr480876/index.html">Nous nettoyons le Dock et faisons l'application sans xCode</a></li>
<li><a href="../fr480878/index.html">Android Surface</a></li>
<li><a href="../fr480884/index.html">Interface graphique Python en 5 minutes</a></li>
<li><a href="../fr480886/index.html">R√©seaux de neurones et nombre d'or: deuxi√®me s√©rie</a></li>
<li><a href="../fr480890/index.html">R√©sultats de l'enqu√™te sur l'utilisation du panneau Express</a></li>
<li><a href="../fr480892/index.html">Internet en montgolfi√®re</a></li>
<li><a href="../fr480900/index.html">Ramenez mon b√©b√©! (Histoire N.-F.)</a></li>
<li><a href="../fr480902/index.html">Nouvelles fonctionnalit√©s de surveillance PostgreSQL PostgreSQL</a></li>
<li><a href="../fr480904/index.html">PHP Microservice Framework: environnement de d√©veloppement pour Swoft</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>