<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ü¶å üí• üèø QUIC em a√ß√£o: como o Uber o implementou para otimizar o desempenho ü§ô üçø üéµ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="O protocolo QUIC √© extremamente interessante de se assistir, por isso gostamos de escrever sobre ele. Mas se as publica√ß√µes anteriores sobre o QUIC er...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>QUIC em a√ß√£o: como o Uber o implementou para otimizar o desempenho</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/Voximplant/blog/463073/">  O protocolo QUIC √© extremamente interessante de se assistir, por isso gostamos de escrever sobre ele.  Mas se as publica√ß√µes anteriores sobre o QUIC eram mais de natureza e material hist√≥rico (hist√≥ria local, se voc√™ quiser), hoje temos o prazer de publicar uma interpreta√ß√£o diferente - falaremos sobre a aplica√ß√£o real do protocolo em 2019.  E n√£o se trata de uma pequena infraestrutura baseada em uma garagem condicional, mas do Uber, que funciona em quase todo o mundo.  Como os engenheiros da empresa tomaram a decis√£o de usar o QUIC na produ√ß√£o, como testaram e o que viram ap√≥s entrar na produ√ß√£o - sob o corte. <br><blockquote> As imagens s√£o clic√°veis.  Boa leitura! </blockquote><br><div style="text-align:center;"> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><img src="https://habrastorage.org/webt/t-/vf/ou/t-vfouxapcoi45iq_uugxs3-4lo.png"></a> </div> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><br></a> <a name="habracut"></a><br>  O Uber √© uma escala global, ou seja, 600 cidades de presen√ßa, em cada uma das quais o aplicativo depende inteiramente da Internet sem fio de mais de 4.500 operadoras m√≥veis.  Os usu√°rios esperam que o aplicativo funcione n√£o apenas r√°pido, mas em tempo real - para garantir isso, o aplicativo Uber precisa de baixa lat√™ncia e uma conex√£o muito confi√°vel.  Infelizmente, a pilha <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">HTTP / 2</a> n√£o se sente bem em redes sem fio din√¢micas e propensas a perdas.  Percebemos que, nesse caso, o baixo desempenho est√° diretamente relacionado √†s implementa√ß√µes de TCP nos kernels dos sistemas operacionais. <br><br>  Para solucionar o problema, aplicamos o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">QUIC</a> , um protocolo moderno com multiplexa√ß√£o de canais, que nos d√° mais controle sobre o desempenho do protocolo de transporte.  O <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">grupo de</a> trabalho <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">IETF</a> est√° atualmente padronizando QUIC como <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">HTTP / 3</a> . <br><br>  Ap√≥s testes detalhados, chegamos √† conclus√£o de que a implementa√ß√£o do QUIC em nosso aplicativo reduzir√° os atrasos "finais" em compara√ß√£o ao TCP.  Observamos uma redu√ß√£o na faixa de 10 a 30% para o tr√°fego HTTPS no exemplo de aplicativos de motorista e passageiro.  O QUIC tamb√©m nos deu controle de ponta a ponta sobre pacotes personalizados. <br><br>  Neste artigo, compartilhamos nossa experi√™ncia na otimiza√ß√£o de aplicativos TCP para Uber usando uma pilha que suporta QUIC. <br><br><h2>  √öltima palavra da tecnologia: TCP </h2><br>  Hoje, o TCP √© o protocolo de transporte mais usado para fornecer tr√°fego HTTPS na Internet.  O TCP fornece um fluxo confi√°vel de bytes, lidando com o congestionamento da rede e a perda da camada de link.  O uso generalizado do TCP para tr√°fego HTTPS √© explicado pela onipresen√ßa do antigo (quase todos os sistemas operacionais cont√™m TCP), disponibilidade na maior parte da infraestrutura (por exemplo, em balanceadores de carga, proxies HTTPS e CDNs) e funcionalidade pronta para uso, que est√° dispon√≠vel na maioria das plataformas e redes. <br><br>  A maioria dos usu√°rios usa nosso aplicativo em qualquer lugar, e os atrasos de TCP est√£o longe dos requisitos em tempo real do tr√°fego HTTPS.  Simplificando, usu√°rios de todo o mundo enfrentaram isso - a Figura 1 mostra atrasos nas grandes cidades: <br><br><div style="text-align:center;"> <a href=""><img src="https://habrastorage.org/webt/z1/4r/dr/z14rdrs2ba8rzmrb8akbtadvqxy.png"></a> </div><br>  <font color="grey">Figura 1. A magnitude dos atrasos na cauda varia nas principais cidades onde a Uber opera.</font> <br><br>  Apesar de haver mais atrasos nas redes indianas e brasileiras do que nos EUA e na Gr√£-Bretanha, os atrasos s√£o muito maiores que os atrasos m√©dios.  E isso √© verdade mesmo para os EUA e a Gr√£-Bretanha. <br><br><h2>  Desempenho TCP over the air </h2><br>  O TCP foi criado para redes <b>com fio</b> , ou seja, com √™nfase em links bem previs√≠veis.  No entanto, <b>as</b> redes <b>sem fio</b> t√™m caracter√≠sticas e dificuldades pr√≥prias.  Primeiro, as redes sem fio s√£o suscet√≠veis √† perda devido √† interfer√™ncia e atenua√ß√£o do sinal.  Por exemplo, as redes Wi-Fi s√£o sens√≠veis a microondas, bluetooth e outras ondas de r√°dio.  As redes celulares sofrem com perda de sinal (perda de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">caminho</a> ) devido √† reflex√£o / absor√ß√£o do sinal por objetos e edif√≠cios, bem como <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">interfer√™ncia</a> de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">torres de c√©lulas</a> vizinhas.  Isso leva a mais significantes (4-10 vezes) e uma variedade de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">atrasos</a> de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">ida e volta (RTT)</a> e perda de pacotes em compara√ß√£o com uma conex√£o com fio. <br><br>  Para combater flutua√ß√µes e perdas de largura de banda, as redes celulares geralmente usam buffers grandes para rajadas de tr√°fego.  Isso pode levar a uma prioridade excessiva, o que significa atrasos maiores.  Muitas vezes, o TCP trata uma sequ√™ncia como perda devido a um aumento do tempo limite, de modo que o TCP est√° inclinado a fazer um rel√© e, assim, preencher o buffer.  Esse problema √© conhecido como <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">bufferbloat</a> ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">buffer excessivo de rede, aumento de buffer</a> ) e √© um <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">problema</a> muito <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">s√©rio da</a> Internet moderna. <br><br>  Finalmente, o desempenho da rede celular varia de acordo com a operadora, regi√£o e tempo.  Na Figura 2, coletamos os atrasos medianos do tr√°fego HTTPS nas c√©lulas em um intervalo de 2 quil√¥metros.  Os dados s√£o coletados para as duas maiores operadoras de telefonia m√≥vel de Delhi, na √çndia.  Como voc√™ pode ver, o desempenho varia de c√©lula para c√©lula.  Al√©m disso, o desempenho de um operador √© diferente do desempenho do segundo.  Isso √© influenciado por fatores como padr√µes de acesso √† rede, levando em considera√ß√£o o tempo e o local, a mobilidade do usu√°rio e a infraestrutura da rede, levando em considera√ß√£o a densidade das torres e a propor√ß√£o dos tipos de rede (LTE, 3G, etc.). <br><br><div style="text-align:center;"> <a href=""><img src="https://habrastorage.org/webt/ln/vz/ya/lnvzyai54p_xde2mfcr50ddoopa.png"></a> </div><br>  <font color="grey">Figura 2. Atrasos para um exemplo de raio de 2 km.</font>  <font color="grey">Delhi, √çndia.</font> <br><br>  Al√©m disso, o desempenho das redes celulares varia ao longo do tempo.  A Figura 3 mostra o atraso m√©dio por dia da semana.  Tamb√©m observamos uma diferen√ßa em menor escala - dentro de um dia e uma hora. <br><br><div style="text-align:center;"> <a href=""><img src="https://habrastorage.org/webt/xu/oo/u_/xuoou_03qrdllnyebxvrpiwa1iy.png"></a> </div><br>  <font color="grey">Figura 3. Atrasos na cauda podem variar significativamente em dias diferentes, mas com o mesmo operador.</font> <br><br>  Tudo isso leva ao fato de que o desempenho do TCP √© ineficiente em redes sem fio.  No entanto, antes de procurar alternativas ao TCP, quer√≠amos desenvolver um entendimento preciso dos seguintes pontos: <br><ul><li>  O TCP √© o principal culpado por atrasos nas nossas aplica√ß√µes? </li><li>  As redes modernas t√™m atrasos significativos e variados de ida e volta (RTT)? </li><li>  Qual √© o efeito da perda de desempenho de RTT e TCP? </li></ul><br><h2>  An√°lise de desempenho TCP </h2><br>  Para entender como analisamos o desempenho do TCP, vamos relembrar brevemente como o TCP transfere dados de um remetente para um destinat√°rio.  Primeiro, o remetente estabelece uma conex√£o TCP executando um <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">handshake de</a> tr√™s vias: o remetente envia um pacote SYN, aguarda um pacote SYN-ACK do destinat√°rio e envia um pacote ACK.  Segunda e terceira passagens adicionais v√£o para a cria√ß√£o de uma conex√£o TCP.  O destinat√°rio confirma o recebimento de cada pacote (ACK) para garantir a entrega confi√°vel. <br><br>  Se um pacote ou ACK for perdido, o remetente retransmitir√° ap√≥s um tempo limite (RTO, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">tempo de retransmiss√£o</a> ).  O RTO √© calculado dinamicamente com base em v√°rios fatores, por exemplo, o atraso esperado do RTT entre o remetente e o destinat√°rio. <br><br><div style="text-align:center;"> <a href=""><img src="https://habrastorage.org/webt/-w/nf/g8/-wnfg8rew9-lbfsaxfw6k9fnnxi.png"></a> </div><br>  <font color="grey">Figura 4. A troca de pacotes TCP / TLS inclui um mecanismo de retransmiss√£o.</font> <br><br>  Para determinar como o TCP funcionava em nossos aplicativos, monitoramos os pacotes TCP com o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">tcpdump</a> por uma semana no tr√°fego de combate vindo dos servidores de fronteira da √çndia.  Em seguida, analisamos as conex√µes TCP usando <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">tcptrace</a> .  Al√©m disso, criamos um aplicativo Android que envia tr√°fego emulado para um servidor de teste, imitando o tr√°fego real o m√°ximo poss√≠vel.  Os smartphones com esse aplicativo foram entregues a v√°rios funcion√°rios que coletaram registros por v√°rios dias. <br><br>  Os resultados de ambas as experi√™ncias foram consistentes entre si.  Vimos altos atrasos na RTT;  os valores da cauda foram quase 6 vezes superiores ao valor m√©dio;  valor m√©dio aritm√©tico dos atrasos - mais de 1 segundo.  Muitas conex√µes estavam com perdas, fazendo com que o TCP retransmitisse 3,5% de todos os pacotes.  Em √°reas com congestionamento, como aeroportos e esta√ß√µes de trem, observamos uma perda de 7%.  Tais resultados lan√ßam d√∫vidas sobre a convic√ß√£o convencional de que os <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">esquemas avan√ßados de retransmiss√£o</a> usados ‚Äã‚Äãnas redes celulares reduzem significativamente a perda de transporte.  Abaixo est√£o os resultados do teste do aplicativo "simulador": <br><div class="scrollable-table"><table><tbody><tr><th>  M√©tricas de rede </th><th>  Valores </th></tr><tr><td>  <b>RTT, milissegundos [50%, 75%, 95%, 99%]</b> </td><td>  [350, 425, 725, 2300] </td></tr><tr><td>  <b>Discrep√¢ncia RTT, segundos</b> </td><td>  ~ 1,2 s em m√©dia </td></tr><tr><td>  <b>Perda de pacotes em conex√µes inst√°veis</b> </td><td>  Em m√©dia ~ 3,5% (7% em √°reas com congestionamento) </td></tr></tbody></table></div><br>  Quase metade dessas conex√µes teve pelo menos uma perda de pacotes, a maioria dos quais eram pacotes SYN e SYN-ACK.  A maioria das implementa√ß√µes TCP usa um valor RTO de 1 segundo para pacotes SYN, o que aumenta exponencialmente para perdas subsequentes.  O tempo de carregamento do aplicativo pode aumentar devido ao fato de o TCP exigir mais tempo para estabelecer conex√µes. <br><br>  No caso de pacotes de dados, as RTOs altas reduzem bastante a utiliza√ß√£o √∫til da rede na presen√ßa de perdas tempor√°rias nas redes sem fio.  Descobrimos que o tempo m√©dio de retransmiss√£o √© de cerca de 1 segundo com um atraso de quase 30 segundos.  Esses altos atrasos no n√≠vel do TCP causaram tempos limite e novas tentativas de HTTPS, o que aumentou ainda mais a lat√™ncia e a inefici√™ncia da rede. <br><br>  Enquanto o percentil 75 da RTT medido era de cerca de 425 ms, o percentil 75 para o TCP era de quase 3 segundos.  Isso sugere que a perda for√ßou o TCP a fazer 7 a 10 passagens para transmitir dados com √™xito.  Isso pode ser devido a um c√°lculo RTO ineficaz, √† incapacidade do TCP de responder rapidamente √† perda dos <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">√∫ltimos pacotes</a> na janela e √† inefici√™ncia do algoritmo de controle de congestionamento, que n√£o distingue entre perdas e perdas sem fio devido ao congestionamento da rede.  Abaixo est√£o os resultados do teste de perda de TCP: <br><div class="scrollable-table"><table><tbody><tr><th>  Estat√≠sticas de perda de pacotes TCP </th><th>  Valor </th></tr><tr><td>  Porcentagem de conex√µes com pelo menos 1 perda de pacote </td><td>  45% </td></tr><tr><td>  A porcentagem de conex√µes com perda durante o estabelecimento da conex√£o </td><td>  30% </td></tr><tr><td>  A porcentagem de conex√µes com perda durante a troca de dados </td><td>  76% </td></tr><tr><td>  Distribui√ß√£o do retardo de retransmiss√£o, segundos [50%, 75%, 95%, 99%] </td><td>  [1, 2.8, 15, 28] </td></tr><tr><td>  Distribui√ß√£o de retransmiss√µes para um √∫nico pacote ou segmento TCP </td><td>  [1,3,6,7] </td></tr></tbody></table></div><br><h2>  Aplica√ß√£o QUIC </h2><br>  Originalmente projetado pelo Google, o QUIC √© um protocolo de transporte moderno e multiencadeado que roda sobre o UDP.  No momento, o QUIC est√° em <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">processo de padroniza√ß√£o</a> (j√° escrevemos que existem, por assim dizer, duas vers√µes do QUIC, os curiosos <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">podem seguir o link</a> - aproximadamente tradutor).  Conforme mostrado na Figura 5, o QUIC √© hospedado em HTTP / 3 (na verdade, HTTP / 2 em cima de QUIC - este √© o HTTP / 3, que agora √© altamente padronizado).  Ele substitui parcialmente as camadas HTTPS e TCP, usando UDP para formar pacotes.  O QUIC suporta apenas transfer√™ncia segura de dados, uma vez que o TLS est√° totalmente integrado no QUIC. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/y4/an/qg/y4anqgxplkww-bc3thmjykbdg2i.png"></div><br>  <font color="grey">Figura 5: O QUIC funciona no HTTP / 3, substituindo o TLS, que costumava funcionar no HTTP / 2.</font> <br><br>  Abaixo, listamos os motivos que nos convenceram a usar o QUIC para fortalecer o TCP: <br><ul><li>  <b>Configura√ß√£o da conex√£o 0-RTT.</b>  O QUIC permite a reutiliza√ß√£o de autoriza√ß√µes de conex√µes anteriores, reduzindo o n√∫mero de handshakes de seguran√ßa.  No futuro, o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">TLS1.3</a> suportar√° 0-RTT, mas um handshake TCP de tr√™s vias ainda ser√° necess√°rio. </li><li>  <b>Superando o bloqueio de HoL.</b>  O HTTP / 2 usa uma conex√£o TCP para cada cliente para melhorar o desempenho, mas isso pode levar a um bloco HoL (cabe√ßalho da linha).  O QUIC simplifica a multiplexa√ß√£o e entrega solicita√ß√µes ao aplicativo independentemente uma da outra. </li><li>  <b>gerenciamento de congestionamentos.</b>  O QUIC est√° no n√≠vel do aplicativo, facilitando a atualiza√ß√£o do algoritmo principal de transporte, que controla o envio, com base nos par√¢metros da rede (quantidade de perda ou RTT).  A maioria das implementa√ß√µes de TCP usa o algoritmo <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">CUBIC</a> , que n√£o √© ideal para tr√°fego sens√≠vel a atrasos.  Algoritmos recentemente desenvolvidos, como o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">BBR,</a> modelam com mais precis√£o a rede e otimizam a lat√™ncia.  O QUIC permite usar o BBR e atualizar esse algoritmo √† medida que ele <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">melhora</a> . </li><li>  <b>compensar as perdas.</b>  O QUIC chama dois TLPs ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">probe de perda de cauda</a> ) antes que o RTO seja acionado - mesmo quando as perdas s√£o muito vis√≠veis.  Isso √© diferente das implementa√ß√µes de TCP.  O TLP retransmite principalmente o √∫ltimo pacote (ou novo, se houver) para acionar o reabastecimento r√°pido.  O processamento do atraso de cauda √© especialmente √∫til para o modo como o Uber trabalha com a rede, principalmente para transmiss√µes de dados curtas, epis√≥dicas e sens√≠veis a atrasos. </li><li>  <b>ACK otimizado.</b>  Como cada pacote possui um n√∫mero de s√©rie exclusivo, n√£o h√° problema em <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">distinguir entre</a> pacotes quando eles s√£o retransmitidos.  Os pacotes ACK tamb√©m cont√™m tempo para processar o pacote e gerar ACKs do lado do cliente.  Esses recursos garantem que o QUIC calcule o RTT com mais precis√£o.  O QUIC ACK suporta at√© 256 intervalos <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">NACK</a> , ajudando o remetente a ser mais resiliente √† troca de pacotes e usar menos bytes no processo.  ACK seletivo ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">SACK</a> ) no TCP n√£o resolve esse problema em todos os casos. </li><li>  <b>migra√ß√£o de conex√£o.</b>  As conex√µes QUIC s√£o identificadas por um ID de 64 bits; portanto, se o cliente alterar os endere√ßos IP, voc√™ poder√° continuar usando o ID da conex√£o antiga no novo endere√ßo IP, sem interrup√ß√£o.  Essa √© uma pr√°tica muito comum para aplicativos m√≥veis quando um usu√°rio alterna entre conex√µes Wi-Fi e celulares. </li></ul><br><h2>  Alternativas ao QUIC </h2><br>  Analisamos abordagens alternativas para resolver o problema antes de escolher o QUIC. <br><br>  Primeiro, tentamos implantar TPC PoPs (Pontos de Presen√ßa) para concluir as conex√µes TCP mais pr√≥ximas dos usu√°rios.  Essencialmente, os PoPs encerram a conex√£o TCP com o dispositivo m√≥vel mais pr√≥ximo da rede celular e aproximam o tr√°fego da infraestrutura original.  Aproximando o TCP, podemos reduzir o RTT potencialmente e garantir que o TCP seja mais responsivo a ambientes sem fio din√¢micos.  No entanto, nossos experimentos mostraram que, na maioria das vezes, o RTT e as perdas s√£o provenientes de redes celulares e o uso de PoPs n√£o fornece melhorias significativas de desempenho. <br><br>  Tamb√©m procuramos ajustar os par√¢metros TCP.  A configura√ß√£o da pilha TCP em nossos servidores de borda heterog√™neos foi dif√≠cil porque o TCP possui implementa√ß√µes diferentes em diferentes vers√µes do sistema operacional.  Foi dif√≠cil implementar isso e testar v√°rias configura√ß√µes de rede.  A configura√ß√£o do TCP diretamente em dispositivos m√≥veis n√£o foi poss√≠vel devido √† falta de autoridade.  Mais importante, chips como conex√µes com 0-RTT e previs√£o de RTT aprimorada s√£o cr√≠ticos para a arquitetura do protocolo e, portanto, n√£o √© poss√≠vel obter benef√≠cios significativos apenas configurando o TCP. <br><br>  Por fim, avaliamos v√°rios protocolos baseados em UDP que solucionam problemas de streaming de v√≠deo - quer√≠amos saber se esses protocolos ajudariam em nosso caso.  Infelizmente, eles careciam de muitas configura√ß√µes de seguran√ßa e tamb√©m precisavam de uma conex√£o TCP adicional para obter metadados e informa√ß√µes de controle. <br><br>  Nossa pesquisa mostrou que o QUIC √© quase o √∫nico protocolo que pode ajudar com o problema do tr√°fego da Internet, levando em considera√ß√£o a seguran√ßa e o desempenho. <br><br><h2>  Integra√ß√£o QUIC na plataforma </h2><br>  Para integrar com √™xito o QUIC e melhorar o desempenho do aplicativo em condi√ß√µes de comunica√ß√£o ruins, substitu√≠mos a pilha antiga (HTTP / 2 sobre TLS / TCP) pelo protocolo QUIC.  Usamos a biblioteca de rede <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Cronet</a> da <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Chromium Projects</a> , que cont√©m a vers√£o original do protocolo do Google, o gQUIC.  Essa implementa√ß√£o tamb√©m est√° sendo constantemente aprimorada para seguir a mais recente especifica√ß√£o IETF. <br><br>  Primeiro, integramos o Cronet em nossos aplicativos Android para adicionar suporte a QUIC.  A integra√ß√£o foi realizada para minimizar os custos de migra√ß√£o.  Em vez de substituir completamente a pilha de rede antiga que usava a biblioteca <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=https://square.github.io/ok">OkHttp</a> , integramos o Cronet UNDER √† estrutura da API OkHttp.  Ao integrar dessa maneira, evitamos altera√ß√µes em nossas chamadas de rede (que o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Retrofit</a> usa) no n√≠vel da API. <br><br>  Semelhante √† abordagem dos dispositivos Android, implementamos o Cronet nos aplicativos Uber para iOS, interceptando o tr√°fego HTTP das <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">APIs</a> da rede usando o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">NSURLProtocol</a> .  Essa abstra√ß√£o, fornecida pela iOS Foundation, processa dados de URL espec√≠ficos do protocolo e garante que podemos integrar o Cronet em nossos aplicativos iOS sem custos significativos de migra√ß√£o. <br><br><h2>  Quic conclu√≠do no Google Cloud Balancers </h2><br>  No lado de back-end, a termina√ß√£o QUIC √© fornecida pela infraestrutura de balanceamento do Google Cloud Load, que usa cabe√ßalhos <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">alt-svc</a> nas respostas para oferecer suporte ao QUIC.  Em geral, o balanceador adiciona o cabe√ßalho alt-svc a cada solicita√ß√£o HTTP e j√° valida o suporte QUIC para o dom√≠nio.  Quando o cliente Cronet recebe uma resposta HTTP com esse cabe√ßalho, ele usa QUIC para solicita√ß√µes HTTP subseq√ºentes a este dom√≠nio.  Assim que o balanceador concluir o QUIC, nossa infraestrutura envia explicitamente essa a√ß√£o via HTTP2 / TCP para nossos data centers. <br><br><h2>  Desempenho: Resultados </h2><br>  O excelente desempenho √© o principal motivo de nossa busca por um protocolo melhor.  Primeiro, criamos um suporte com <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">emula√ß√£o de rede</a> para descobrir como o QUIC se comportar√° com diferentes perfis de rede.  Para testar a opera√ß√£o do QUIC em redes reais, experimentamos Nova D√©lhi usando tr√°fego de rede emulado muito semelhante √†s chamadas HTTP no aplicativo do passageiro. <br><br><h3>  Experi√™ncia 1 </h3><br>  Invent√°rio para experi√™ncia: <br><ul><li>  Dispositivos de teste Android com pilhas OkHttp e Cronet para garantir o envio de tr√°fego HTTPS por TCP e QUIC, respectivamente; </li><li>  um servidor de emula√ß√£o baseado em Java que envia o mesmo tipo de cabe√ßalhos HTTPS nas respostas e carrega os dispositivos clientes para receber solicita√ß√µes deles; </li><li>  Proxies na nuvem localizados fisicamente perto da √çndia para concluir as conex√µes TCP e QUIC.  Embora tenhamos usado o proxy reverso no <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">NGINX</a> para concluir o TCP, foi dif√≠cil encontrar o proxy reverso de c√≥digo aberto para o QUIC.  Criamos o proxy reverso para o QUIC, usando a pilha QUIC b√°sica do Chromium e o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">publicamos</a> no cromo como c√≥digo aberto. </li></ul><br> <a href=""><img src="https://habrastorage.org/webt/vp/qt/sx/vpqtsxbastzm3um6hjwcdz2giv8.png" width="49%"></a> <a href=""><img src="https://habrastorage.org/webt/qc/ti/vz/qctivzpddsppzzfxhfqbkgzopyk.png" width="49%"></a> <br>  <font color="grey">Figura 6. O conjunto de viagens para os testes TCP vs QUIC consistia em dispositivos Android com OkHttp e Cronet, proxies na nuvem para finalizar conex√µes e um servidor de emula√ß√£o.</font> <br><br><h3>  Experi√™ncia 2 </h3><br>  Quando o Google disponibilizou o QUIC usando o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=https://cloud.google.com/blog/products/gcp/introducing-quic-support-">Google Cloud Load Balancing</a> , usamos um mesmo invent√°rio, mas com uma modifica√ß√£o: em vez do NGINX, levamos os balanceadores do Google para concluir as conex√µes TCP e QUIC dos dispositivos, bem como para direcionar o tr√°fego HTTPS para o servidor de emula√ß√£o .  Os balanceadores s√£o distribu√≠dos em todo o mundo, mas usam o servidor PoP mais pr√≥ximo ao dispositivo (gra√ßas √† geolocaliza√ß√£o). <br><br><div style="text-align:center;"> <a href=""><img src="https://habrastorage.org/webt/bl/ec/v-/blecv-4m260dn8_ufg9d0tuq5e4.png"></a> </div><br>  <font color="grey">Figura 7. No segundo experimento, quer√≠amos comparar o atraso de conclus√£o do TCP e o QUIC: usando o Google Cloud e nosso proxy de nuvem.</font> <br><br>  Como resultado, v√°rias revela√ß√µes nos aguardavam: <br><ul><li>  <b>A termina√ß√£o de PoP melhorou o desempenho do TCP.</b>  Como os balanceadores concluem a conex√£o TCP mais pr√≥xima dos usu√°rios e s√£o perfeitamente otimizados, isso resulta em menor RTT, o que melhora o desempenho do TCP.    QUIC   ,     TCP      ( 10-30 ). </li><li> <b>   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">  (hops)</a> .</b>   QUIC-     (   50  ),   ,     ‚Äì 15%-    20%-   99   TCP.    ,      ‚Äì    (bottleneck)   . </li></ul><br> <a href=""><img src="https://habrastorage.org/webt/ne/co/7c/neco7cpjmlkjsp0uxdnwfez9cuk.png" width="49%"></a> <a href=""><img src="https://habrastorage.org/webt/zd/gl/2d/zdgl2d_tftg33ztgy_t90ikfcui.png" width="49%"></a> <br> <font color="grey"> 8.    ,  QUIC   TCP.</font> <br><br><h2>   </h2><br>  ,    QUIC   Android  iOS-.   A/B ,    QUIC    Uber.  ,          ,       . <br><br>        (95  99 )       ‚Äì LTE, 3G, 2G. <br> <a href=""><img src="https://habrastorage.org/webt/-7/p7/11/-7p711t91dffb4aoecw6f_woexw.png" width="49%"></a> <a href=""><img src="https://habrastorage.org/webt/oo/q4/gr/ooq4grp5mldwwmiyxyy8poqyqug.png" width="49%"></a> <br> <font color="grey"> 9.    QUIC  TCP  .</font> <br><br><h2>   </h2><br> ,    ‚Äì  QUIC           ,    ,  : <br><br><h3>   </h3><br>      ,  ,   80%    QUIC  <b></b> ,     15%    QUIC  TCP.  ,    - ,   Cronet    TCP  ,        UDP-    .      ,        QUIC. <br><br><h3>  QUIC </h3><br>       ,     .        .   ,     ,        TCP  QUIC   .           QUIC-  . <br><br>                 ,           . </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt463073/">https://habr.com/ru/post/pt463073/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt463061/index.html">Regras para preparar layouts em Figma</a></li>
<li><a href="../pt463063/index.html">Lidamos com interfaces no Go</a></li>
<li><a href="../pt463067/index.html">Primeiro a frente e depois as costas (algum dia)</a></li>
<li><a href="../pt463069/index.html">Guia animado b√°sico de React</a></li>
<li><a href="../pt463071/index.html">Qual o impacto das interrup√ß√µes na Internet?</a></li>
<li><a href="../pt463075/index.html">Novas licen√ßas de c√≥digo aberto</a></li>
<li><a href="../pt463083/index.html">Protegendo backups do iPhone</a></li>
<li><a href="../pt463085/index.html">Sistema de acesso remoto a arquivos Cage</a></li>
<li><a href="../pt463089/index.html">Implementa√ß√£o de um sistema de busca de empresas para projetistas mec√¢nicos usando a plataforma Low-Code</a></li>
<li><a href="../pt463095/index.html">Por que n√£o SQL?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>