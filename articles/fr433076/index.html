<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üÜî üï∫ ‚öïÔ∏è Comment nous avons cr√©√© notre biblioth√®que Android Gallery pour afficher le contenu multim√©dia üë©üèΩ‚Äçüé§ üò∞ üë®üèΩ‚Äçüé§</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Bonjour, Habr! Il n'y a pas si longtemps, √† la recherche d'aventures, de nouveaux projets et technologies, je  est devenu un robot  install√©s √† Redmad...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Comment nous avons cr√©√© notre biblioth√®que Android Gallery pour afficher le contenu multim√©dia</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/redmadrobot/blog/433076/"><p><img src="https://habrastorage.org/webt/fl/a3/rh/fla3rh2hkzl_guxybjkro7f8hua.png"><br><br>  Bonjour, Habr!  Il n'y a pas si longtemps, √† la recherche d'aventures, de nouveaux projets et technologies, je <del>  est devenu un robot </del>  install√©s √† Redmadrobot.  J'ai eu une chaise, un moniteur et un macbook, et un petit projet interne pour me r√©chauffer.  Il √©tait n√©cessaire de terminer et de publier une biblioth√®que auto-√©crite pour visualiser le contenu multim√©dia que nous utilisons dans nos projets.  Dans l'article, je vais vous expliquer comment comprendre les √©v√©nements tactiles en une semaine, devenir un open source, trouver un bug dans Android sdk et publier une biblioth√®que. </p><a name="habracut"></a><br><h2 id="nachalo">  Commencer </h2><br><p>  L'une des caract√©ristiques importantes de nos applications de magasin est la possibilit√© de visualiser des vid√©os et des photos de produits et services √† proximit√© et de tous c√¥t√©s.  Nous ne voulions pas r√©inventer la roue et sommes all√©s √† la recherche d'une biblioth√®que finie qui nous conviendrait. </p><br><p>  Nous avions pr√©vu de trouver une telle solution pour que l'utilisateur puisse: </p><br><ul><li>  voir des photos; </li><li>  Redimensionnez les photos √† l'aide d'une pinc√©e pour zoomer et appuyez deux fois; </li><li>  Regardez une vid√©o </li><li>  retourner le contenu multim√©dia; </li><li>  fermez la carte photo avec un glissement vertical (glissez pour ignorer). </li></ul><br><p>  Voici ce que nous avons trouv√©: </p><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">FrescoImageViewer</a> - prend en charge l'affichage et le d√©filement des photos et des gestes de base, mais ne prend pas en charge l'affichage des vid√©os et est destin√© √† la biblioth√®que <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Fresco</a> . </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">PhotoView</a> - prend en charge l'affichage des photos, la plupart des principaux gestes de contr√¥le, √† l'exception du d√©filement, du balayage pour ignorer, ne prend pas en charge l'affichage des vid√©os. </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">PhotoDraweeView</a> - fonctionnalit√©s similaires √† PhotoView, mais destin√©es √† Fresco. </li></ul><br><p>  Puisqu'aucune des biblioth√®ques trouv√©es ne r√©pondait pleinement aux exigences, nous avons d√ª √©crire la n√¥tre. </p><br><h2 id="realizuem-biblioteku">  Nous r√©alisons la biblioth√®que </h2><br><p>  Pour obtenir les fonctionnalit√©s n√©cessaires, nous avons finalis√© les solutions existantes d'autres biblioth√®ques.  Ils ont d√©cid√© de donner le modeste nom <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Android Gallery √†</a> ce qui s'est pass√©. </p><br><h3 id="realizuem-funkcionalnost">  Nous impl√©mentons des fonctionnalit√©s </h3><br><p>  <strong>Afficher et agrandir des photos</strong> <br>  Pour voir les photos, nous avons pris la biblioth√®que PhotoView, qui prend en charge la mise √† l'√©chelle hors de la bo√Æte. </p><br><p>  <strong>Regardez la vid√©o</strong> <br>  Pour regarder la vid√©o, ils ont pris <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ExoPlayer</a> , qui est r√©utilis√© dans le <a href="">MediaPagerAdapter</a> .  Lorsqu'un utilisateur ouvre une vid√©o pour la premi√®re fois, ExoPlayer est cr√©√©.  Lorsque vous passez √† un autre √©l√©ment, il est mis en file d'attente, donc au prochain d√©marrage de la vid√©o, l'instance ExoPlayer d√©j√† cr√©√©e sera utilis√©e.  Cela facilite la transition entre les √©l√©ments. </p><br><p> <strong>D√©filement du contenu multim√©dia</strong> <br>  Ici, nous avons utilis√© le <a href="">MultiTouchViewPager</a> de FrescoImageViewer, qui n'intercepte pas les √©v√©nements multi-touch, nous avons donc pu lui ajouter des gestes pour mettre l'image √† l'√©chelle. </p><br><p>  <strong>Glissez pour ignorer</strong> <br>  PhotoView ne prend pas en charge le balayage pour ignorer et rebondir (restauration de la taille d'image d'origine lorsque l'image est agrandie ou r√©duite). <br>  Voici comment nous avons r√©ussi √† le g√©rer. </p><br><h3 id="izuchaem-touch-events-dlya-realizacii-swipe-to-dismiss">  Apprentissage des √©v√©nements tactiles pour impl√©menter le balayage pour ignorer </h3><br><p> Avant de passer √† la prise en charge du balayage pour ignorer, vous devez comprendre le fonctionnement des √©v√©nements tactiles.  Lorsque l'utilisateur touche l'√©cran, la m√©thode <code>dispatchTouchEvent(motionEvent: MotionEvent)</code> est appel√©e dans l'activit√© en cours, o√π se trouve <code>MotionEvent.ACTION_DOWN</code> .  Cette m√©thode d√©cide du sort de l'√©v√©nement.  Vous pouvez passer <code>motionEvent</code> √† <code>onTouchEvent(motionEvent: MotionEvent)</code> pour le traitement tactile, ou le laisser aller plus loin, de haut en bas, dans la hi√©rarchie des vues.  La vue, qui s'int√©resse √† un √©v√©nement et / ou aux √©v√©nements ult√©rieurs avant <code>ACTION_UP</code> , renvoie true. </p><br><p>  Apr√®s cela, tous les √©v√©nements du geste actuel tomberont dans cette vue jusqu'√† ce que le geste se termine avec l'√©v√©nement <code>ACTION_UP</code> ou que le ViewGroup parent prenne le contr√¥le (puis l'√©v√©nement <code>ACTION_CANCELED</code> viendra √† View).  Si l'√©v√©nement a contourn√© la hi√©rarchie de View enti√®re et que personne n'√©tait int√©ress√©, il revient √† l'activit√© dans <code>onTouchEvent(motionEvent: MotionEvent)</code> . <br><br><img src="https://habrastorage.org/webt/yz/np/jd/yznpjdfaodnwmd3tzy_wldagyak.png"><br><br>  Dans notre biblioth√®que Android Gallery, le premier √©v√©nement <code>ACTION_DOWN</code> vient √† <code>dispatchTouchEvent()</code> dans PhotoView, o√π <code>motionEvent</code> pass√© √† l' <code>onTouch()</code> , qui retourne true.  De plus, tous les √©v√©nements passent par la m√™me cha√Æne jusqu'√† l'un des √©v√©nements suivants: </p><br><ul><li>  <code>ACTION_UP</code> ; </li><li>  ViewPager tentera d'intercepter l'√©v√©nement pour le d√©filement; </li><li>  <a href="">VerticalDragLayout</a> essaiera d'intercepter l'√©v√©nement pour que le balayage soit ignor√©. </li></ul><br><p>  Seul ViewGroup de la <code>onInterceptTouchEvent(motionEvent: MotionEvent)</code> peut intercepter des √©v√©nements.  M√™me si la vue est int√©ress√©e par un MotionEvent, l'√©v√©nement lui-m√™me passera par le <code>dispatchTouchEvent(motionEvent: MotionEvent)</code> toute la cha√Æne ViewGroup pr√©c√©dente.  Par cons√©quent, les parents ¬´surveillent¬ª toujours leurs enfants.  Tout ViewGroup parent peut intercepter l'√©v√©nement et renvoyer true dans la <code>onInterceptTouchEvent(motionEvent: MotionEvent)</code> , puis toutes les <code>MotionEvent.ACTION_CANCEL</code> enfants recevront <code>MotionEvent.ACTION_CANCEL</code> dans <code>onTouchEvent(motionEvent: MotionEvent)</code> . </p><br><p>  Exemple: l'utilisateur tient un doigt sur un √©l√©ment dans un RecyclerView, puis les √©v√©nements sont trait√©s dans le m√™me √©l√©ment.  Mais d√®s qu'il commence √† d√©placer son doigt vers le haut / bas, le RecyclerView interceptera les √©v√©nements, et le d√©filement commencera, et la vue recevra l'√©v√©nement <code>ACTION_CANCEL</code> . <br><br><img src="https://habrastorage.org/webt/yp/x9/kf/ypx9kf8alvwtag0jfihj-jrzjmo.png"><br><br>  Dans la galerie Android, VerticalDragLayout peut intercepter des √©v√©nements pour un balayage √† ignorer ou ViewPager pour un d√©filement.  Mais View peut emp√™cher le parent d' <code>requestDisallowInterceptTouchEvent(true)</code> √©v√©nements en appelant la <code>requestDisallowInterceptTouchEvent(true)</code> .  Cela peut √™tre n√©cessaire si la vue doit effectuer des actions dont l'interception par le parent n'est pas souhaitable pour nous. </p><br><p>  Par exemple, lorsqu'un utilisateur d'un lecteur saute une piste √† une heure sp√©cifique.  Si le ViewPager parent interceptait un d√©filement horizontal, il y aurait une transition vers la piste suivante. </p><br><p>  Pour g√©rer le balayage √† ignorer, nous avons √©crit VerticalDragLayout, mais il n'a pas re√ßu d'√©v√©nements tactiles de PhotoView.  Pour comprendre pourquoi cela se produit, j'ai d√ª comprendre comment les √©v√©nements tactiles sont trait√©s dans PhotoView. </p><br><p>  Ordre de traitement: </p><br><ol><li>  Lorsque MotionEvent.ACTION_DOWN dans VerticalDragLayout, <code>interceptTouchEvent()</code> d√©clench√©, ce qui renvoie false, car  ce ViewGroup n'est int√©ress√© que par ACTION_MOVE vertical.  La direction ACTION_MOVE est d√©finie dans <code>dispatchTouchEvent()</code> , apr√®s quoi l'√©v√©nement est transmis √† la m√©thode <code>super.dispatchTouchEvent()</code> dans ViewGroup, o√π l'√©v√©nement est transmis √† l'impl√©mentation <code>interceptTouchEvent()</code> dans VerticalDragLayout. <br><br><img src="https://habrastorage.org/webt/le/zg/xb/lezgxbf8n-_tnhdpqc96drpjqvm.png"><br><br></li><li>  Lorsque l'√©v√©nement <code>ACTION_DOWN</code> atteint la m√©thode <code>onTouch()</code> dans PhotoView, la vue enl√®ve la possibilit√© d'intercepter la gestion des √©v√©nements.  Tous les √©v√©nements de mouvement suivants ne tombent pas dans la m√©thode <code>interceptTouchEvent()</code> .  La capacit√© d'intercepter le contr√¥le n'est donn√©e au parent que si le geste est termin√© ou si <code>ACTION_MOVE</code> horizontal <code>ACTION_MOVE</code> sur la bordure droite / gauche de l'image. <br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (mAllowParentInterceptOnEdge &amp;&amp; !mScaleDragDetector.isScaling() &amp;&amp; !mBlockParentIntercept) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (mScrollEdge == EDGE_BOTH || (mScrollEdge == EDGE_LEFT &amp;&amp; dx &gt;= <span class="hljs-number"><span class="hljs-number">1f</span></span>) || (mScrollEdge == EDGE_RIGHT &amp;&amp; dx &lt;= -<span class="hljs-number"><span class="hljs-number">1f</span></span>)) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (parent != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { parent.requestDisallowInterceptTouchEvent(<span class="hljs-keyword"><span class="hljs-keyword">false</span></span>); } } } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (parent != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { parent.requestDisallowInterceptTouchEvent(<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); } }</code> </pre> <br><p><img src="https://habrastorage.org/webt/kk/s3/pj/kks3pjkovqsyiyiaif64bc_qh3e.png"><br><br>  √âtant donn√© que PhotoView permet au parent d'intercepter le contr√¥le uniquement en cas d' <code>ACTION_MOVE</code> horizontal et que le balayage pour <code>ACTION_MOVE</code> est <code>ACTION_MOVE</code> vertical, VerticalDragLayout ne peut pas intercepter le contr√¥le d'√©v√©nements pour impl√©menter un geste.  Pour r√©soudre ce probl√®me, vous devez ajouter la possibilit√© d'intercepter le contr√¥le en cas de <code>ACTION_MOVE</code> vertical. <br></p><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (mAllowParentInterceptOnEdge &amp;&amp; !mScaleDragDetector.isScaling() &amp;&amp; !mBlockParentIntercept) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (mHorizontalScrollEdge == HORIZONTAL_EDGE_BOTH || (mHorizontalScrollEdge == HORIZONTAL_EDGE_LEFT &amp;&amp; dx &gt;= <span class="hljs-number"><span class="hljs-number">1f</span></span>) || (mHorizontalScrollEdge == HORIZONTAL_EDGE_RIGHT &amp;&amp; dx &lt;= -<span class="hljs-number"><span class="hljs-number">1f</span></span>) || mVerticalScrollEdge == VERTICAL_EDGE_BOTH || (mVerticalScrollEdge == VERTICAL_EDGE_TOP &amp;&amp; dy &gt;= <span class="hljs-number"><span class="hljs-number">1f</span></span>) || (mVerticalScrollEdge == VERTICAL_EDGE_BOTTOM &amp;&amp; dy &lt;= -<span class="hljs-number"><span class="hljs-number">1f</span></span>)) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (parent != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { parent.requestDisallowInterceptTouchEvent(<span class="hljs-keyword"><span class="hljs-keyword">false</span></span>); } } } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (parent != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { parent.requestDisallowInterceptTouchEvent(<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); } }</code> </pre> <br><p>  Maintenant, dans le cas de la premi√®re <code>ACTION_MOVE</code> verticale, <code>ACTION_MOVE</code> donnera la possibilit√© d'intercepter le parent: <br><br><img src="https://habrastorage.org/webt/j7/ea/_z/j7ea_zwmamtooghpppzcyxl-bne.png"><br><br>  L' <code>ACTION_MOVE</code> suivant sera intercept√© dans VerticalDragLyout et l'√©v√©nement <code>ACTION_CANCEL</code> volera dans la vue enfant: <br><br><img src="https://habrastorage.org/webt/jb/ag/tz/jbagtzmul81dakmf0nujxzumw6u.png"><br><br>  Tous les autres <code>ACTION_MOVE</code> voleront vers VerticalDragLayout le long de la cha√Æne standard.  Il est important qu'apr√®s que le ViewGroup ait pris le contr√¥le des √©v√©nements de la vue enfant, la vue enfant ne puisse pas reprendre le contr√¥le. <br><br><img src="https://habrastorage.org/webt/ud/ql/yv/udqlyv7d4-aigffi5hdwypwfy5u.png"><br><br>  Nous avons donc impl√©ment√© le balayage pour d√©sactiver la prise en charge de la biblioth√®que PhotoView.  Dans notre biblioth√®que, nous avons utilis√© les sources modifi√©es de PhotoView extraites dans un module distinct et cr√©√© une <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">demande de fusion</a> dans le r√©f√©rentiel PhotoView d'origine. <br><br></p><h3 id="realizuem-debauns-v-photoview">  Nous impl√©mentons des debinds dans PhotoView </h3><br><p>  Rappelons qu'un anti-rebond est une animation-restauration d'une √©chelle acceptable lorsque l'image est mise √† l'√©chelle au-del√† de ses limites. <br><br><img src="https://habrastorage.org/webt/op/rv/wb/oprvwbemhg9ikmrm1zfv45w6fvo.gif"><br><br>  Il n'y avait pas une telle possibilit√© dans PhotoView.  Mais depuis que nous avons commenc√© √† creuser l'open source de quelqu'un d'autre, pourquoi s'arr√™ter l√†?  Dans PhotoView, vous pouvez d√©finir une limite de zoom.  Au d√©part, c'est le minimum - x1 et le maximum - x3.  L'image ne peut pas d√©passer ces limites. </p><br><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onScale</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params"> scaleFactor, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params"> focusX, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params"> focusY)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((getScale() &lt; mMaxScale || scaleFactor &lt; <span class="hljs-number"><span class="hljs-number">1f</span></span>) &amp;&amp; (getScale() &gt; mMinScale || scaleFactor &gt; <span class="hljs-number"><span class="hljs-number">1f</span></span>)) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (mScaleChangeListener != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { mScaleChangeListener.onScaleChange(scaleFactor, focusX, focusY); } mSuppMatrix.postScale(scaleFactor, scaleFactor, focusX, focusY); <span class="hljs-comment"><span class="hljs-comment">//      checkAndDisplayMatrix(); } }</span></span></code> </pre> <br><p>  Pour commencer, nous avons d√©cid√© de supprimer la condition ¬´interdiction de mise √† l'√©chelle pour atteindre un minimum¬ª: nous avons simplement supprim√© la condition <code>getScale() &gt; mMinScale || scaleFactor &gt; 1f</code>  <code>getScale() &gt; mMinScale || scaleFactor &gt; 1f</code> .  Et puis soudain ... <br><br><img src="https://habrastorage.org/webt/z_/ra/xg/z_raxgeezaf7o0h0zprufgrtggq.jpeg"><br><br>  Debuns gagn√©!  Apparemment, cela s'est produit en raison du fait que les cr√©ateurs de la biblioth√®que ont d√©cid√© de la jouer deux fois en toute s√©curit√©, faisant √† la fois un rebond et une restriction sur la mise √† l'√©chelle.  Dans l'impl√©mentation de l'√©v√©nement onTouch, √† savoir dans le cas de <code>MotionEvent.ACTION_UP</code> , si l'utilisateur a √©volu√© plus / moins que le maximum / minimum, <a href="">AnimatedZoomRunnable est</a> lanc√©, ce qui ram√®ne l'image √† sa taille d'origine. </p><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onTouch</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(View v, MotionEvent ev)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">boolean</span></span> handled = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> (ev.getAction()) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> MotionEvent.ACTION_UP: <span class="hljs-comment"><span class="hljs-comment">// If the user has zoomed less than min scale, zoom back // to min scale if (getScale() &lt; mMinScale) { RectF rect = getDisplayRect(); if (rect != null) { v.post(new AnimatedZoomRunnable(getScale(), mMinScale, rect.centerX(), rect.centerY())); handled = true; } } else if (getScale() &gt; mMaxScale) { RectF rect = getDisplayRect(); if (rect != null) { v.post(new AnimatedZoomRunnable(getScale(), mMaxScale, rect.centerX(), rect.centerY())); handled = true; } } break; } }</span></span></code> </pre> <br><p>  En plus de glisser pour ignorer, nous avons finalis√© PhotoView dans les sources de notre biblioth√®que et cr√©√© une <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">pull request</a> avec ¬´l'ajout¬ª d'un anti-rebond au PhotoView d'origine. </p><br><h3 id="ispravlyaem-vnezapnyy-bag-v-photoview">  Correction d'un bug soudain dans PhotoView </h3><br><p>  PhotoView a un bug tr√®s m√©chant.  Lorsque l'utilisateur souhaite agrandir l'image avec un double tap et <del>  il a une crise d'√©pilepsie </del>  l'image commence √† l'√©chelle, elle peut basculer de 180 degr√©s verticalement.  Ce bogue peut √™tre trouv√© m√™me dans les applications populaires de Google Play, par exemple, dans Cyan. <br><br><img src="https://habrastorage.org/webt/m7/y1/hm/m7y1hmgkwqachpwst660vkrilwa.gif"><br><br>  Apr√®s une longue recherche, nous avons toujours localis√© ce bogue: parfois un scaleFactor n√©gatif est appliqu√© √† la matrice d'entr√©e pour la mise √† l'√©chelle de l'image pour la mise √† l'√©chelle, ce qui provoque le retournement de l'image. </p><br><p>  <a href="">CustomGestureDetector</a> </p><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onScale</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ScaleGestureDetector detector)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//  -   scaleFactor &lt; 0 //      float scaleFactor = detector.getScaleFactor(); if (Float.isNaN(scaleFactor) || Float.isInfinite(scaleFactor)) return false; //    scaleFactor   callback //      mListener.onScale(scaleFactor, detector.getFocusX(), detector.getFocusY()); return true; }</span></span></code> </pre> <br><p>  Pour √©voluer √† partir d'Android ScaleGestureDetector, <a href="">nous</a> obtenons scaleFactor, qui est calcul√© comme suit: </p><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">float</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getScaleFactor</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (inAnchoredScaleMode()) { <span class="hljs-comment"><span class="hljs-comment">// Drag is moving up; the further away from the gesture // start, the smaller the span should be, the closer, // the larger the span, and therefore the larger the scale final boolean scaleUp = (mEventBeforeOrAboveStartingGestureEvent &amp;&amp; (mCurrSpan &lt; mPrevSpan)) || (!mEventBeforeOrAboveStartingGestureEvent &amp;&amp; (mCurrSpan &gt; mPrevSpan)); final float spanDiff = (Math.abs(1 - (mCurrSpan / mPrevSpan)) * SCALE_FACTOR); return mPrevSpan &lt;= 0 ? 1 : scaleUp ? (1 + spanDiff) : (1 - spanDiff); } return mPrevSpan &gt; 0 ? mCurrSpan / mPrevSpan : 1; }</span></span></code> </pre> <br><p>  Si vous remplacez cette m√©thode par des journaux de d√©bogage, vous pouvez suivre √† quelles valeurs particuli√®res des variables un scaleFactor n√©gatif est obtenu: </p><br><pre> <code class="plaintext hljs">mEventBeforeOrAboveStartingGestureEvent is true; SCALE_FACTOR is 0.5; mCurrSpan: 1075.4398; mPrevSpan 38.867798; scaleUp: false; spanDiff: 13.334586; eval result is -12.334586</code> </pre> <br><p>  On soup√ßonne qu'ils ont essay√© de r√©soudre ce probl√®me en multipliant spanDiff par SCALE_FACTOR == 0,5.  Mais cette solution n'aidera pas si la diff√©rence entre mCurrSpan et mPrevSpan est plus de trois fois.  Un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ticket</a> a d√©j√† √©t√© d√©marr√© pour ce bug, mais il n'a pas encore √©t√© corrig√©. <br><del>  B√©quille </del>  La solution la plus simple √† ce probl√®me consiste simplement √† ignorer les valeurs scaleFactor n√©gatives.  En pratique, l'utilisateur ne remarquera pas que l'image est parfois agrandie l√©g√®rement moins r√©guli√®rement que d'habitude. </p><br><h1 id="vmesto-zaklyucheniya">  Au lieu d'une conclusion </h1><br><h3 id="sudba-pull-rekvestov">  Le sort des demandes de pull </h3><br><p>  Nous avons effectu√© un correctif local et cr√©√© la derni√®re <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">demande</a> d'extraction dans PhotoView.  Malgr√© le fait que certains PR sont suspendus depuis un an, nos PR ont √©t√© ajout√©s √† la branche principale et m√™me une nouvelle version de PhotoView a √©t√© publi√©e.  Apr√®s quoi, nous avons d√©cid√© de couper le module local de la galerie Android et de r√©cup√©rer les sources officielles de PhotoView.  Pour ce faire, j'ai d√ª ajouter la prise en charge d'AndroidX, qui a √©t√© ajout√© √† PhotoView dans la version <a href="">2.1.3</a> . </p><br><h3 id="gde-nayti-biblioteku">  O√π trouver la biblioth√®que </h3><br><p>  Recherchez le code source de la biblioth√®que Android Gallery ici - <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">https://github.com/redmadrobot-spb/android-gallery</a> , ainsi que les instructions d'utilisation.  Et pour prendre en charge les projets qui utilisent toujours la biblioth√®que de support, nous avons cr√©√© une version distincte de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">android-gallery-deprecated</a> .  Mais attention, car dans un an, la biblioth√®que de support se transformera en citrouille! </p><br><h3 id="chto-dalshe">  Et ensuite </h3><br><p>  Maintenant, la biblioth√®que nous convient parfaitement, mais en cours de d√©veloppement, de nouvelles id√©es sont apparues.  En voici quelques uns: </p><br><ul><li>  la possibilit√© d'utiliser la biblioth√®que dans n'importe quelle mise en page, et pas seulement un FragmentDialog s√©par√©; </li><li>  la possibilit√© de personnaliser l'interface utilisateur; </li><li>  la possibilit√© de remplacer Gilde et ExoPlayer; </li><li>  la possibilit√© d'utiliser quelque chose au lieu de ViewPager. </li></ul><br><h3 id="ssylki">  Les r√©f√©rences </h3><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Le syst√®me tactile Android dans une perspective l√©g√®rement diff√©rente</a> - un tr√®s bon article sur le sujet avec des liens vers d'autres articles et vid√©os int√©ressants, qui d√©taille le fonctionnement du syst√®me tactile Android. </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Ma√Ætrise des gestes dans Android</a> - article sur Android Touch System en russe. </li></ul><br><h3 id="upd">  UPD </h3><br><p>  Lors de la r√©daction d'un article, une <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">biblioth√®que</a> similaire des d√©veloppeurs de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">FrescoImageViewer est sortie</a> .  Ils ont ajout√© la prise en charge de l' <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">animation de transition</a> , mais jusqu'√† pr√©sent, nous n'avons qu'une prise en charge vid√©o.  :) </p></li></ol></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr433076/">https://habr.com/ru/post/fr433076/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr433064/index.html">Gestion des incidents: ¬´vous ne pouvez pas abandonner¬ª ou l'art de placer des virgules</a></li>
<li><a href="../fr433066/index.html">Coupe HighLoad # 2. Championnat pour les d√©veloppeurs backend de retour en service</a></li>
<li><a href="../fr433070/index.html">Comment distinguer le shampoing des champignons et les brochettes du champagne ... Elasticsearch - rechercher des produits dans les bases de donn√©es du magasin</a></li>
<li><a href="../fr433072/index.html">Comment pirater la protection contre la copie de la console Sega Dreamcast</a></li>
<li><a href="../fr433074/index.html">Passer √† Kotlin dans un projet Android: trucs et astuces</a></li>
<li><a href="../fr433078/index.html">Nous √©crivons des robots de trading en utilisant le cadre graphique StockSharp. 2e partie</a></li>
<li><a href="../fr433082/index.html">Pomper les comptes d'autrui est devenu une infraction p√©nale en Cor√©e du Sud</a></li>
<li><a href="../fr433084/index.html">Le√ßon ouverte "Ing√©nierie des fonctionnalit√©s sur l'exemple du jeu de donn√©es Titanic classique"</a></li>
<li><a href="../fr433086/index.html">Tinkoff et tout, tout, tout: IoT, analyse et surveillance pour les banques</a></li>
<li><a href="../fr433088/index.html">Comment aimez-vous cela, Elon Musk: BMW et Porsche ont d√©velopp√© une recharge qui ajoute 100 km de voyage en 3 minutes</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>