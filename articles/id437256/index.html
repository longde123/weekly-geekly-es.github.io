<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🧛🏾 🛌🏽 👦 Memvalidasi alamat memori pada Cortex-M0 / M3 / M4 / M7 👨🏽‍🎤 🏂🏿 👩🏻‍🤝‍👨🏿</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Halo, Habr! 

 Mengenai pelonggaran rezim di hari lain, kemarahan dalam komentar dari satu pos tetangga bahwa artikel tentang mikrokontroler semua han...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Memvalidasi alamat memori pada Cortex-M0 / M3 / M4 / M7</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/437256/">  Halo, Habr! <br><br>  Mengenai <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">pelonggaran rezim di</a> hari lain, kemarahan dalam komentar dari satu pos tetangga bahwa artikel tentang mikrokontroler semua hanya berkedip oleh LED, dan juga kematian terlalu dini dari blog standar saya, yang saya terlalu malas untuk mengembalikannya, saya akan mentransfer materi berguna tentang sedikit cahaya yang disesalkan. trik pers dalam bekerja dengan inti Cortex-M - memeriksa alamat acak untuk validitas. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/rl/he/2w/rlhe2wjgxij3ej65fi5t8lverts.jpeg"></div><br>  Salah satu yang sangat berguna dan pada saat yang sama karena beberapa alasan fitur yang dibuat tidak dijelaskan di mana saja pada mikrokontroler Cortex-M (semua) adalah kemampuan untuk memeriksa kebenaran alamat dalam memori.  Dengan itu, Anda dapat menentukan ukuran flash, RAM dan EEPROM, menentukan keberadaan pada prosesor tertentu dari periferal dan register tertentu, mengalahkan proses jatuh sambil menjaga kesehatan keseluruhan OS, dll. <br><a name="habracut"></a><br>  Dalam mode normal, ketika Anda sampai ke alamat yang tidak ada di Cortex-M3 / M4 / M7, pengecualian BusFault dilemparkan, dan jika tidak ada handler, itu meningkat ke HardFault.  Pada Cortex-M0 tidak ada pengecualian "terperinci" (MemFault, BusFault, UsageFault), dan setiap kegagalan segera meningkat ke HardFault. <br><br>  Secara umum, Anda tidak dapat mengabaikan HardFault - ini mungkin karena kegagalan perangkat keras, misalnya, dan perilaku lebih lanjut dari perangkat akan menjadi tidak dapat diprediksi.  Tetapi dalam kasus khusus ini dapat dan harus dilakukan. <br><br><h4>  Cortex-M3 dan Cortex-M4: BusFault yang tidak terpenuhi </h4><br>  Pada Cortex-M3 dan lebih tinggi, memeriksa validitas alamat cukup sederhana - Anda harus melarang semua pengecualian (kecuali, jelas, tidak dapat ditutup-tutupi) melalui register FAULTMASK, nonaktifkan pemrosesan BusFault secara khusus, dan kemudian masukkan ke alamat yang sedang diperiksa dan lihat apakah bendera BFARVALID dalam register BFAR , mis. Daftar Alamat Kesalahan Bus.  Jika Anda telah mengambilnya, Anda baru saja mengalami BusFault, mis.  Alamatnya salah. <br><br>  Kode tersebut terlihat seperti ini, semua definisi dan fungsi dari CMSIS (non-vendor) standar, sehingga harus bekerja pada M3, M4 atau M7: <br><br><pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">cpu_check_address</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">volatile</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *address)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">/* Cortex-M3, Cortex-M4, Cortex-M4F, Cortex-M7 are supported */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span> BFARVALID_MASK = (<span class="hljs-number"><span class="hljs-number">0x80</span></span> &lt;&lt; SCB_CFSR_BUSFAULTSR_Pos); <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> is_valid = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; <span class="hljs-comment"><span class="hljs-comment">/* Clear BFARVALID flag by writing 1 to it */</span></span> SCB-&gt;CFSR |= BFARVALID_MASK; <span class="hljs-comment"><span class="hljs-comment">/* Ignore BusFault by enabling BFHFNMIGN and disabling interrupts */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span> mask = __get_FAULTMASK(); __disable_fault_irq(); SCB-&gt;CCR |= SCB_CCR_BFHFNMIGN_Msk; <span class="hljs-comment"><span class="hljs-comment">/* probe address in question */</span></span> *address; <span class="hljs-comment"><span class="hljs-comment">/* Check BFARVALID flag */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((SCB-&gt;CFSR &amp; BFARVALID_MASK) != <span class="hljs-number"><span class="hljs-number">0</span></span>) { <span class="hljs-comment"><span class="hljs-comment">/* Bus Fault occured reading the address */</span></span> is_valid = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } <span class="hljs-comment"><span class="hljs-comment">/* Reenable BusFault by clearing BFHFNMIGN */</span></span> SCB-&gt;CCR &amp;= ~SCB_CCR_BFHFNMIGN_Msk; __set_FAULTMASK(mask); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> is_valid; }</code> </pre> <br><h4>  Cortex-M0 dan Cortex-M0 + </h4><br>  Dengan Cortex-M0 dan Cortex-M0 + semuanya lebih rumit, seperti yang saya katakan di atas, mereka tidak memiliki BusFault dan semua register yang sesuai, dan pengecualian segera ditingkatkan ke HardFault.  Oleh karena itu, hanya ada satu jalan keluar - untuk membuat penangan HardFault dapat memahami bahwa pengecualian itu sengaja disebabkan, dan untuk kembali ke fungsi yang memanggilnya, melewati di sana bendera yang menunjukkan bahwa HardFault ada di sana. <br><br>  Ini dilakukan murni di assembler.  Dalam contoh di bawah ini, register R5 diatur ke 1, dan dua "angka ajaib" ditulis ke register R1 dan R2.  Jika HardFault terjadi setelah mencoba memuat nilai ke alamat yang diperiksa, maka itu harus memeriksa nilai R1 dan R2, dan jika mereka menemukan angka yang diperlukan, atur R5 ke nol.  Nilai R5 ditransfer ke kode syshech melalui variabel khusus yang terikat erat ke register ini, alamat yang akan dirakit menjadi assembler adalah implisit, kita hanya tahu bahwa di arm-none-eabi parameter pertama dari fungsi ditempatkan di R0. <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">cpu_check_address</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">volatile</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *address)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">/* Cortex-M0 doesn't have BusFault so we need to catch HardFault */</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>)address; <span class="hljs-comment"><span class="hljs-comment">/* R5 will be set to 0 by HardFault handler */</span></span> <span class="hljs-comment"><span class="hljs-comment">/* to indicate HardFault has occured */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">register</span></span> <span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span> result __asm(<span class="hljs-string"><span class="hljs-string">"r5"</span></span>); __<span class="hljs-function"><span class="hljs-function">asm__ </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">volatile</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"ldr r5, =1 \n"</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-comment"><span class="hljs-function"><span class="hljs-params"><span class="hljs-comment">/* set default R5 value */</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"ldr r1, =0xDEADF00D \n"</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-comment"><span class="hljs-function"><span class="hljs-params"><span class="hljs-comment">/* set magic number */</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"ldr r2, =0xCAFEBABE \n"</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-comment"><span class="hljs-function"><span class="hljs-params"><span class="hljs-comment">/* 2nd magic to be sure */</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"ldrb r3, [r0] \n"</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-comment"><span class="hljs-function"><span class="hljs-params"><span class="hljs-comment">/* probe address */</span></span></span></span><span class="hljs-function"><span class="hljs-params"> )</span></span></span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> result; }</code> </pre> <br>  Kode penangan HardFault dalam bentuknya yang paling sederhana terlihat seperti ini: <br><br><pre> <code class="cpp hljs">__attribute__((naked)) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">hard_fault_default</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">/* Get stack pointer where exception stack frame lies */</span></span> __<span class="hljs-function"><span class="hljs-function">asm__ </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">volatile</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( </span></span><span class="hljs-comment"><span class="hljs-function"><span class="hljs-params"><span class="hljs-comment">/* decide if we need MSP or PSP stack */</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"movs r0, #4 \n"</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-comment"><span class="hljs-function"><span class="hljs-params"><span class="hljs-comment">/* r0 = 0x4 */</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"mov r2, lr \n"</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-comment"><span class="hljs-function"><span class="hljs-params"><span class="hljs-comment">/* r2 = lr */</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"tst r2, r0 \n"</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-comment"><span class="hljs-function"><span class="hljs-params"><span class="hljs-comment">/* if(lr &amp; 0x4) */</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"bne use_psp \n"</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-comment"><span class="hljs-function"><span class="hljs-params"><span class="hljs-comment">/* { */</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"mrs r0, msp \n"</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-comment"><span class="hljs-function"><span class="hljs-params"><span class="hljs-comment">/* r0 = msp */</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"b out \n"</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-comment"><span class="hljs-function"><span class="hljs-params"><span class="hljs-comment">/* } */</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">" use_psp: \n"</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-comment"><span class="hljs-function"><span class="hljs-params"><span class="hljs-comment">/* else { */</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"mrs r0, psp \n"</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-comment"><span class="hljs-function"><span class="hljs-params"><span class="hljs-comment">/* r0 = psp */</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">" out: \n"</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-comment"><span class="hljs-function"><span class="hljs-params"><span class="hljs-comment">/* } */</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-comment"><span class="hljs-function"><span class="hljs-params"><span class="hljs-comment">/* catch intended HardFaults on Cortex-M0 to probe memory addresses */</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"ldr r1, [r0, #0x04] \n"</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-comment"><span class="hljs-function"><span class="hljs-params"><span class="hljs-comment">/* read R1 from the stack */</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"ldr r2, =0xDEADF00D \n"</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-comment"><span class="hljs-function"><span class="hljs-params"><span class="hljs-comment">/* magic number to be found */</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"cmp r1, r2 \n"</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-comment"><span class="hljs-function"><span class="hljs-params"><span class="hljs-comment">/* compare with the magic number */</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"bne regular_handler \n"</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-comment"><span class="hljs-function"><span class="hljs-params"><span class="hljs-comment">/* no magic -&gt; handle as usual */</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"ldr r1, [r0, #0x08] \n"</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-comment"><span class="hljs-function"><span class="hljs-params"><span class="hljs-comment">/* read R2 from the stack */</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"ldr r2, =0xCAFEBABE \n"</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-comment"><span class="hljs-function"><span class="hljs-params"><span class="hljs-comment">/* 2nd magic number to be found */</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"cmp r1, r2 \n"</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-comment"><span class="hljs-function"><span class="hljs-params"><span class="hljs-comment">/* compare with 2nd magic number */</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"bne regular_handler \n"</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-comment"><span class="hljs-function"><span class="hljs-params"><span class="hljs-comment">/* no magic -&gt; handle as usual */</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"ldr r1, [r0, #0x18] \n"</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-comment"><span class="hljs-function"><span class="hljs-params"><span class="hljs-comment">/* read PC from the stack */</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"add r1, r1, #2 \n"</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-comment"><span class="hljs-function"><span class="hljs-params"><span class="hljs-comment">/* move to the next instruction */</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"str r1, [r0, #0x18] \n"</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-comment"><span class="hljs-function"><span class="hljs-params"><span class="hljs-comment">/* modify PC in the stack */</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"ldr r5, =0 \n"</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-comment"><span class="hljs-function"><span class="hljs-params"><span class="hljs-comment">/* set R5 to indicate HardFault */</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"bx lr \n"</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-comment"><span class="hljs-function"><span class="hljs-params"><span class="hljs-comment">/* exit the exception handler */</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">" regular_handler: \n"</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-comment"><span class="hljs-function"><span class="hljs-params"><span class="hljs-comment">/* here comes the rest of the fucking owl */</span></span></span></span><span class="hljs-function"><span class="hljs-params"> )</span></span></span></span></code> </pre> <br>  Pada saat meninggalkan handler pengecualian, Cortex melempar register, yang dijamin akan rusak oleh handler (R0-R3, R12, LR, PC ...), ke stack.  Fragmen pertama - sudah ada di sebagian besar penangan HardFault yang sudah jadi, kecuali yang ditulis dengan logam telanjang murni - menentukan tumpukan mana: ketika bekerja di OS, bisa berupa MSP atau PSP, dan mereka memiliki alamat yang berbeda.  Dalam proyek bare metal, tumpukan MSP (Main Stack Pointer) biasanya dipasang apriori, tanpa memeriksa - karena PSP (Process Stack Pointer) tidak dapat berada di sana karena kurangnya proses. <br><br>  Setelah menentukan tumpukan yang diinginkan dan meletakkan alamatnya di R0, kami membaca nilai R1 (offset 0x04) dan R2 (offset 0x08) darinya, bandingkan dengan kata-kata ajaib, jika keduanya cocok - kami membaca nilai PC (offset 0x18) dari tumpukan, tambahkan 2 (2 byte - ukuran instruksi pada Cortex-M *) dan simpan kembali ke stack.  Jika ini tidak dilakukan, ketika kami kembali dari handler, kami akan menemukan diri kami pada instruksi yang sama yang sebenarnya menyebabkan pengecualian, dan kami akan selalu berjalan berputar-putar.  Lampiran 2 menggerakkan kita ke instruksi berikutnya pada saat kembali. <br><br>  <i><b>* Pembaruan.</b></i>  <i>Dalam komentar, muncul pertanyaan tentang ukuran instruksi pada Cortex-M, saya akan membuat jawaban yang benar di sini: dalam kasus ini, crash menyebabkan instruksi LDRB, yang tersedia dalam arsitektur ARMv7-M dalam dua versi - 16-bit dan 32-bit.</i>  <i>Opsi kedua akan dipilih jika setidaknya salah satu syarat terpenuhi:</i> <i><br><br></i> <ul><li>  <i>penulis dengan jelas menunjukkan instruksi LDRB.W bukan LDRB (kami tidak)</i> </li><li>  <i>register di atas R7 digunakan (untuk kita - R0 dan R3)</i> </li><li>  <i>Offset yang lebih besar dari 31 byte ditentukan (kami tidak memiliki offset)</i> </li></ul> <i><br><br></i>  <i>Dalam semua kasus lainnya (mis., Ketika operan cocok dengan format versi 16-bit instruksi), assembler <b>harus</b> memilih versi 16-bit.</i> <i><br><br></i>  <i>Oleh karena itu, dalam kasus kami, akan selalu ada instruksi 2-byte yang perlu diloncati, tetapi jika Anda mengedit kode dengan kuat, opsi dimungkinkan.</i> <br><br>  Selanjutnya, tulis 0 di R5, yang berfungsi sebagai indikator untuk masuk ke HardFault.  Register setelah R3 tidak disimpan ke stack sebelum register khusus, dan ketika keluar dari handler, mereka tidak dipulihkan dengan cara apa pun, jadi hati nurani kita untuk merusak atau tidak merusaknya.  Dalam hal ini, kami mengubah R5 dari 1 menjadi 0 dengan sengaja. <br><br>  Pengembalian dari interrupt handler dilakukan persis dengan satu cara.  Ketika memasuki handler, nilai khusus dituliskan dalam register LR yang disebut EXC_RETURN, yang diperlukan untuk menulis ke PC untuk keluar dari handler - dan tidak hanya menulisnya, tetapi melakukannya dengan perintah POP atau BX (yaitu, “pc pc, lr, misalnya, tidak berfungsi , meskipun pertama kali menurut Anda itu berfungsi).  BX LR terlihat seperti upaya untuk pergi ke alamat yang tidak berarti (di LR akan ada sesuatu seperti 0xFFFFFFF1 yang tidak ada hubungannya dengan alamat sebenarnya dari prosedur yang perlu kita kembalikan), tetapi pada kenyataannya prosesor melihat nilai ini pada PC (ke mana ia akan pergi secara otomatis), ini akan mengembalikan register dari stack dan melanjutkan untuk menjalankan prosedur kami - dengan prosedur selanjutnya setelah memanggil HardFault karena fakta bahwa kami secara manual meningkatkan PC dalam stack ini sebanyak 2. <br><br>  Anda dapat membaca tentang semua offset dan perintah <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">dengan jelas di mana</a> , tentu saja. <br><br>  Nah, atau jika angka ajaib tidak terlihat, maka semuanya akan pergi ke regular_handler, setelah itu prosedur pemrosesan HardFault mengikuti - sebagai aturan, ini adalah fungsi yang mencetak nilai register ke konsol, memutuskan apa yang harus dilakukan selanjutnya dengan prosesor, dll. <br><br><h4>  Penentuan ukuran RAM </h4><br>  Menggunakan semua ini sederhana dan mudah.  Kami ingin menulis firmware yang berfungsi pada beberapa mikrokontroler dengan jumlah RAM yang berbeda, sementara setiap kali menggunakan RAM dalam program penuh? <br><br>  Ya mudah: <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> uint32_t </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">cpu_find_memory_size</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *base, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint32_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> block, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint32_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> maxsize)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> *address = base; <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> { address += block; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!cpu_check_address(address)) { <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } } <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> ((<span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span>)(address - base) &lt; maxsize); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span>)(address - base); } <span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span> get_cpu_ram_size(<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> cpu_find_memory_size((<span class="hljs-keyword"><span class="hljs-keyword">char</span></span> *)SRAM_BASE, <span class="hljs-number"><span class="hljs-number">4096</span></span>, <span class="hljs-number"><span class="hljs-number">80</span></span>*<span class="hljs-number"><span class="hljs-number">1024</span></span>); }</code> </pre> <br>  maxsize di sini diperlukan kemudian, bahwa pada jumlah maksimum yang mungkin RAM antara itu dan blok alamat berikutnya mungkin tidak ada celah di mana cpu_check_address akan pecah.  Dalam contoh ini, 80 KB.  Juga tidak masuk akal untuk menyelidiki semua alamat - lihat saja lembar data untuk melihat apa langkah minimum yang mungkin antara dua model pengontrol dan setel sebagai blok. <br><br><h4>  Transisi terprogram ke bootloader yang terletak di antah berantah </h4><br>  Kadang-kadang Anda dapat melakukan trik yang lebih rumit - misalnya, bayangkan Anda ingin secara terprogram melompat ke bootloader pabrik pabrik STM32 untuk beralih ke mode pembaruan firmware melalui UART atau USB, tanpa repot-repot menulis bootloader Anda. <br><br>  Bootloader STM32 terletak di area yang disebut System Memory, yang perlu Anda kunjungi, tetapi ada satu masalah - area ini memiliki alamat yang berbeda tidak hanya pada seri prosesor yang berbeda, tetapi pada model berbeda dari seri yang sama (pelat epik dapat ditemukan di <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">AN2606</a> pada halaman 22 hingga 26).  Saat Anda menambahkan fungsionalitas yang sesuai ke platform secara umum, dan bukan hanya ke produk tertentu, Anda menginginkan keserbagunaan. <br><br>  Dalam file CMSIS, alamat awal Memori Sistem juga tidak ada.  Tidak mungkin untuk menentukannya dengan ID Bootloader, karena  ini masalah ayam dan telur - ID Bootloader terletak di byte terakhir Memori Sistem, yang membawa kita kembali ke pertanyaan tentang alamat. <br><br>  Namun, jika kita melihat kartu memori STM32, kita akan melihat sesuatu seperti ini: <br><br><img src="https://habrastorage.org/webt/l4/nf/b3/l4nfb3xcw87qnsrey9n4mp3t0we.png"><br>  Dalam hal ini, kami tertarik dengan lingkungan Memori Sistem - misalnya, di atas adalah area yang dapat diprogram (tidak semua STM32) dan Opsi byte (semuanya).  Struktur ini diamati tidak hanya pada model yang berbeda, tetapi pada garis STM32 yang berbeda, dengan satu-satunya perbedaan dalam keberadaan OTP dan adanya kesenjangan dalam alamat antara memori sistem dan opsi. <br><br>  Tetapi bagi kami dalam hal ini, hal yang paling penting adalah bahwa alamat mulai dari Opsi Bytes ada di header CMSIS biasa - disebut OB_BASE di sana. <br><br>  Lebih sederhana.  Kami menulis fungsi untuk mencari alamat yang valid atau tidak valid turun atau naik dari yang ditentukan: <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">char</span></span></span><span class="hljs-function"> *</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">cpu_find_next_valid_address</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *start, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *stop, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">bool</span></span></span></span><span class="hljs-function"><span class="hljs-params"> valid)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> *address = start; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (<span class="hljs-literal"><span class="hljs-literal">true</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (address == stop) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (cpu_check_address(address) == valid) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> address; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (stop &gt; start) { address++; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { address--; } }; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>; }</code> </pre> <br>  Dan lihat ke bawah dari Opsi byte, pertama akhir dari memori sistem, atau OTP yang berdekatan dengannya, dan kemudian awal memori sistem dalam dua lintasan: <br><br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">/* System memory is the valid area next _below_ Option bytes */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> *a, *b, *c; a = (<span class="hljs-keyword"><span class="hljs-keyword">char</span></span> *)(OB_BASE - <span class="hljs-number"><span class="hljs-number">1</span></span>); b = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-comment"><span class="hljs-comment">/* Here we have System memory top address */</span></span> c = cpu_find_next_valid_address(a, b, <span class="hljs-literal"><span class="hljs-literal">true</span></span>); <span class="hljs-comment"><span class="hljs-comment">/* Here we have System memory bottom address */</span></span> c = cpu_find_next_valid_address(c, b, <span class="hljs-literal"><span class="hljs-literal">false</span></span>) + <span class="hljs-number"><span class="hljs-number">1</span></span>;</code> </pre> <br>  Dan tanpa banyak kesulitan, kami mengatur ini menjadi fungsi yang menemukan awal memori sistem dan melompat ke atasnya, yaitu meluncurkan bootloader: <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">jump_to_bootloader</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> __</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">attribute__</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">((noreturn))</span></span></span></span>; <span class="hljs-comment"><span class="hljs-comment">/* Sets up and jumps to the bootloader */</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">jump_to_bootloader</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">/* System memory is the valid area next _below_ Option bytes */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> *a, *b, *c; a = (<span class="hljs-keyword"><span class="hljs-keyword">char</span></span> *)(OB_BASE - <span class="hljs-number"><span class="hljs-number">1</span></span>); b = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-comment"><span class="hljs-comment">/* Here we have System memory top address */</span></span> c = cpu_find_next_valid_address(a, b, <span class="hljs-literal"><span class="hljs-literal">true</span></span>); <span class="hljs-comment"><span class="hljs-comment">/* Here we have System memory bottom address */</span></span> c = cpu_find_next_valid_address(c, b, <span class="hljs-literal"><span class="hljs-literal">false</span></span>) + <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!c) { NVIC_SystemReset(); } <span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span> boot_addr = (<span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span>)c; <span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span> boot_stack_ptr = *(<span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span>*)(boot_addr); <span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span> dfu_reset_addr = *(<span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span>*)(boot_addr+<span class="hljs-number"><span class="hljs-number">4</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> (*dfu_bootloader)(<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>) = (<span class="hljs-keyword"><span class="hljs-keyword">void</span></span> (*))(dfu_reset_addr); <span class="hljs-comment"><span class="hljs-comment">/* Reset the stack pointer */</span></span> __set_MSP(boot_stack_ptr); dfu_bootloader(); <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (<span class="hljs-number"><span class="hljs-number">1</span></span>); }</code> </pre> <br>  Itu tergantung pada model prosesor spesifik ... tidak ada yang bergantung.  Logika tidak akan berfungsi pada model yang memiliki lubang antara OTP dan memori sistem - tetapi saya belum memeriksa apakah ada sama sekali.  Akan aktif bekerja dengan OTP - centang. <br><br>  Trik lain hanya berlaku pada prosedur biasa untuk memanggil bootloader dari kode Anda - jangan lupa untuk mereset penunjuk tumpukan dan memanggil prosedur untuk meninggalkan bootloader sebelum menginisialisasi periferal, kecepatan jam, dll. Karena minimalis, bootloader dapat menyumbat menginisialisasi periferal dan berharap bahwa itu dalam keadaan default.  Pilihan yang baik untuk memanggil bootloader dari tempat yang sewenang-wenang dalam program Anda adalah menulis ke Register Cadangan RTC atau hanya ke alamat yang diketahui dalam memori nomor ajaib, mem-boot ulang program dan memeriksa pada tahap pertama menginisialisasi nomor ini. <br><br>  PS Karena semua alamat dalam kartu memori prosesor disejajarkan dalam kasus terburuk dengan 4, prosedur di atas akan sangat dipercepat oleh gagasan melangkah melalui mereka dalam peningkatan 4 byte, bukan satu. <br><br><h4>  Pemberitahuan penting </h4><br>  NB: harap dicatat bahwa pada pengontrol tertentu validitas alamat tertentu tidak selalu menunjukkan keberadaan fungsionalitas aktual yang mungkin terletak di alamat itu.  Misalnya, alamat register yang mengendalikan beberapa blok periferal opsional mungkin valid, meskipun blok itu sendiri tidak ada dalam model ini.  Dari sisi pabrikan, trik paling menarik adalah mungkin, biasanya berakar pada penggunaan kristal yang sama untuk model prosesor yang berbeda.  Namun, dalam kebanyakan kasus, prosedur ini bekerja dan terbukti sangat bermanfaat. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/id437256/">https://habr.com/ru/post/id437256/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../id437244/index.html">Google mengajarkan pengguna untuk mengenali email phising</a></li>
<li><a href="../id437248/index.html">FPGA mitap di St. Petersburg</a></li>
<li><a href="../id437250/index.html">Bagaimana kami membuat aplikasi seluler yang tidak perlu seorang desainer</a></li>
<li><a href="../id437252/index.html">SDL 2.0 Siklus Pelajaran: Pelajaran 3 - Perpustakaan Ekstensi SDL</a></li>
<li><a href="../id437254/index.html">Komputasi ternary: dasar-dasar</a></li>
<li><a href="../id437258/index.html">Proyek unik tim DESAIN CATIA: Mobil konsep Bleu</a></li>
<li><a href="../id437260/index.html">Windows Phone 8.1: pengembangan pasca nostalgia. Riwayat aplikasi tunggal</a></li>
<li><a href="../id437262/index.html">Bagaimana air sungai bisa diminum?</a></li>
<li><a href="../id437264/index.html">Kelelahan profesional dalam IT (hasil studi My Circle)</a></li>
<li><a href="../id437270/index.html">Kami menggunakan mesin virtual Windows dengan penerusan kartu video virtual menggunakan QEMU dan Intel GVT-g</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>