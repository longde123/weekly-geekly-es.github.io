<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üö∂üèª üï§ üôÖüèø Salta a la nube. Creaci√≥n de una soluci√≥n de IoT econ√≥mica en NodeMCU + Azure IoT Hub üï∫üèæ üïü üë®üèæ‚Äçüöí</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="El destino m√°s popular para dispositivos IoT es la recolecci√≥n de telemetr√≠a. Hasta la fecha, los precios de los servicios de IoT en la nube han dismi...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Salta a la nube. Creaci√≥n de una soluci√≥n de IoT econ√≥mica en NodeMCU + Azure IoT Hub</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/microsoft/blog/421847/"><p>  El destino m√°s popular para dispositivos IoT es la recolecci√≥n de telemetr√≠a.  Hasta la fecha, los precios de los servicios de IoT en la nube han disminuido tanto que incluso un usuario ordinario puede permitirse el lujo de usarlos.  Hoy hablaremos sobre c√≥mo enviar datos a la nube desde la placa NodeMCU usando el idioma Lua. </p><br><p><img src="https://habrastorage.org/webt/k3/f5/nx/k3f5nxom4hfjshqqwpgl43ppjwo.jpeg"><a name="habracut"></a></p><br><p>  <em>Nota: continuamos la serie de publicaciones de versiones completas de art√≠culos de la revista Hacker.</em>  <em>Ortograf√≠a y puntuaci√≥n del autor guardado.</em> </p><br><p>  Doy la palabra al autor. </p><br><p>  Como trabajo en la pila de tecnolog√≠a de Microsoft, uso Azure Functions y Table Storage para crear la parte de la nube de la soluci√≥n IoT, pero mi PoC para NodeMCU y Lua tambi√©n se puede usar con otros proveedores de soluciones de IoT en la nube. </p><br><h1>  INFORMACI√ìN </h1><br><p>  Expressif NodeMCU es una de las placas base m√°s asequibles con Wi-Fi, micro USB y un programador integrado.  Se basa en el m√≥dulo ESP8266.  La placa de segunda generaci√≥n se puede comprar por alrededor de $ 6-7.  Puede trabajar con la placa desde el IDE de Arduino.  Adem√°s, la placa admite un lenguaje de secuencias de comandos llamado Lua (traducido del portugu√©s como "Luna"). </p><br><h2>  Conectar y configurar el dispositivo </h2><br><p>  Para que el dispositivo sea reconocido en Windows, debe descargar el controlador desde el siguiente enlace: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Controladores CP210x USB a UART Bridge VCP</a> </p><br><p> La velocidad del puerto serie est√°ndar de NodeMCU es 115'200bps.  Puede establecer una velocidad diferente, en el primer reinicio del dispositivo volver√° a 115200. <br>  Es importante que el controlador est√© configurado exactamente a la misma velocidad: </p><br><p><img src="https://habrastorage.org/webt/ce/sq/y5/cesqy5kslu5pos-rrdqsxvch-vo.png"></p><br><h2>  Firmware </h2><br><p>  Lo m√°s probable es que se pierda algo en el firmware inicial, por lo que lo ideal es actualizar el dispositivo usted mismo.  Hay varias formas de crear una imagen de firmware.  Usar un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">servicio en la nube</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">una imagen de Docker</a> o usar <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">instrucciones para Linux</a> .  Recolect√© usando un servicio en la nube.  Tambi√©n te aconsejo esta opci√≥n. </p><br><p>  Si necesita enviar datos a la nube, las funciones necesarias para la selecci√≥n son SNTP, MQTT, HTTP (WiFi, temporizador, archivo, GPIO, red, nodo, UART ya est√°n seleccionados de forma predeterminada).  Tambi√©n es necesario marcar como requerido el soporte TLS / SSL en Opciones varias <br>  El enlace con el archivo bin llega al correo.  M√°s precisamente, incluso 2 enlaces vienen de inmediato.  Uno con una imagen que admite operaciones de punto flotante, y el segundo con una no compatible. </p><br><p>  Antes de flashear el ESP8266, debe ponerlo en modo especial.  Hay un bot√≥n FLASH separado en el tablero.  Al presionarlo durante el encendido o al reiniciar, el dispositivo pasa al modo de cargador de arranque.  Si de repente no hay tal bot√≥n en la modificaci√≥n de su placa, entonces antes de parpadear necesita conectar GPIO0 a GND y presionar reiniciar (este m√©todo es adecuado para ESP-12). </p><br><p>  El firmware se puede <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">actualizar</a> con la utilidad <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">PyFlasher</a> .  Py en el nombre significa que la aplicaci√≥n est√° escrita en Python.  Tambi√©n hay <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">nodemcu-flasher</a> , pero no se ha actualizado durante mucho tiempo.  No lo he probado </p><br><p>  La ventana de PyFlasher se ve as√≠: </p><br><p><img src="https://habrastorage.org/webt/1a/ns/rh/1ansrh_oc-zpqvaif8eujfvetvg.png"></p><br><p>  El modo de flash se selecciona seg√∫n la placa que tenga.  La mayor√≠a de las placas base modernas basadas en los m√≥dulos ESP8266 ESP-12 y ESP32 usan el modo DIO.  ESP8266 01 a 07 se ajusta al modo QIO m√°s r√°pido.  DOUT es utilizado por ESP8285. </p><br><h2>  Configuraci√≥n IDE </h2><br><p>  Descargue el IDE gratuito en el enlace de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">ESPlorer</a> .  Alternativamente, hay <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">ZeroBrane Studio</a> .  Lo que m√°s me gust√≥ de ESPlorer, as√≠ que dar√© un ejemplo de c√≥mo trabajar con √©l.  ESPlorer est√° escrito en JAVA.  La interfaz de la aplicaci√≥n es </p><br><p><img src="https://habrastorage.org/webt/gi/lj/vs/giljvs_zxesytj7k52d_nlka_u8.png"></p><br><p>  En el lado izquierdo se encuentra el c√≥digo, la configuraci√≥n y alguna otra funcionalidad similar.  A la derecha est√° la ventana de monitoreo y los comandos de administraci√≥n de dispositivos.  Abra la aplicaci√≥n, seleccione el puerto.  Establezca la velocidad a la que se realizar√° el intercambio (lo m√°s probable es que sea 115200) y haga clic en Abrir. </p><br><p><img src="https://habrastorage.org/webt/1p/iq/xr/1piqxr933-f-nwkk6wagwtw42ea.png"></p><br><p>  Para calentar, puede ejecutar un script simple que parpadea con un LED incorporado: </p><br><pre><code class="hljs powershell">LED = <span class="hljs-number"><span class="hljs-number">0</span></span> gpio.mode(LED, gpio.OUTPUT) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">flash_led</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">gpio</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">write</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(LED, gpio.LOW)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">tmr</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">delay</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(500000)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">gpio</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">write</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(LED, gpio.HIGH)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">end</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">tmr</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">alarm</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(1, 1000, tmr.ALARM_AUTO, flash_led)</span></span></span></span></code> </pre> <br><p>  Si su placa no tiene un LED incorporado (o si ya est√° completamente harto de ejemplos de LED parpadeante =), puede intentar ejecutar un script a√∫n m√°s simple que muestre la l√≠nea: </p><br><pre> <code class="hljs swift"><span class="hljs-built_in"><span class="hljs-built_in">print</span></span>(<span class="hljs-string"><span class="hljs-string">"Hello from Lua!"</span></span>)</code> </pre> <br><p>  Despu√©s de crear un archivo .lua (digamos test.lua), agregue el c√≥digo y gu√°rdelo en el disco, puede descargarlo en su dispositivo.  Para hacer esto, abra el puerto si no est√° abierto (bot√≥n Abrir) y haga clic en el bot√≥n Cargar.  Puede encontrarlo entre los botones que se encuentran debajo del c√≥digo (a la izquierda). </p><br><p>  Despu√©s de descargar el archivo, puede ejecutarlo enviando el comando: </p><br><pre> <code class="hljs lisp">dofile(<span class="hljs-string"><span class="hljs-string">"test.lua"</span></span>)</code> </pre> <br><p>  El comando se puede ingresar manualmente en el campo inferior ubicado a la derecha debajo del monitor.  O, si no desea escribir ning√∫n texto, puede hacer clic en el bot√≥n Recargar (la fila extrema de botones a la derecha).  Despu√©s de hacer clic en este bot√≥n, recibir√° una lista de botones con los archivos .lua cargados en el tablero.  Al hacer clic en el bot√≥n con el nombre del archivo, se iniciar√° la ejecuci√≥n del archivo. </p><br><p>  Si desea que el archivo se inicie inmediatamente despu√©s de encender el tablero, cree un archivo llamado init.lua. </p><br><h2>  Configurar la parte de la nube para trabajar con el dispositivo </h2><br><p>  Dejemos nuestro dispositivo por un tiempo y creemos su doble en la nube.  Recientemente, se puede crear un dispositivo doble directamente en Azure Portal, utilizando la nueva funcionalidad.  En el grupo de configuraci√≥n de IoT Hub llamado Exploradores, debe seleccionar Dispositivos IoT y hacer clic en "+ Agregar" </p><br><p>  Para conectar el dispositivo al centro de IoT, necesitamos generar SAS (firma de acceso compartido).  Para generar SAS, se usa una doble clave de dispositivo, que se puede obtener usando alguna utilidad auxiliar (Device Explorer, iothub-explorer, IoT Extension para Azure CLI 2.0).  Pero la forma m√°s f√°cil de obtener la clave est√° all√≠, en el portal de Azure, yendo al IoT Hub -&gt; Dispositivos IoT. </p><br><p><img src="https://habrastorage.org/webt/gu/fn/jz/gufnjz89qukktzouxgsoauw01ww.png"></p><br><p>  SAS puede generarse en el dispositivo, o puede generarse utilizando cualquiera de sus servicios en l√≠nea.  Si usa el SDK, puede generar SAS autom√°ticamente (es suficiente para especificar la doble clave del dispositivo en el c√≥digo). </p><br><p><img src="https://habrastorage.org/webt/ob/gs/v1/obgsv1ag1bhj7rrcjejvonpvs3u.png"></p><br><p>  La forma en que un token SAS es generado por un servicio web por un cierto tiempo limitado es un poco m√°s seguro.  Aunque hay un cierto matiz.  Si env√≠a solo el nombre del dispositivo al servicio, alguien puede buscar a trav√©s de los nombres para obtener el token de otro dispositivo.  Por lo tanto, para que el proceso sea un poco m√°s seguro, propongo esta soluci√≥n: guardemos el hash de Azure de la doble clave del dispositivo en el dispositivo.  Y en el c√≥digo de servicio, antes de generar el SAS, verificaremos si el hash coincide con el hash de la clave del dispositivo.  Por lo tanto, ser√° posible obtener SAS solo conociendo el nombre del dispositivo y el hash de su clave. </p><br><p>  La primera forma en que se genera SAS en el dispositivo es m√°s simple y m√°s conveniente, pero un poco menos segura.  Dado que, despu√©s de obtener acceso al dispositivo, un atacante podr√° obtener la clave y generar el dispositivo SAS de forma independiente.  En el segundo caso, despu√©s de obtener acceso al dispositivo, el cracker podr√° recibir solo tokens SAS, cuya vida √∫til es limitada. </p><br><p>  Resulta que ambos m√©todos son, en general, no ideales si el hacker tiene acceso al dispositivo.  Incluso asegurar una conexi√≥n usando una VPN no ayudar√° aqu√≠.  En este caso, el canal de transmisi√≥n estar√° protegido, pero aquellos que tengan el dispositivo en sus manos podr√°n acceder al canal.  Desafortunadamente, en dispositivos NodeMCU, Arduino, etc.  no hay forma de almacenar claves / contrase√±as en ning√∫n almacenamiento seguro.  Quiz√°s el mercado de dispositivos IoT de bajo costo requiere una nueva funcionalidad de hardware. </p><br><h2>  Crear una funci√≥n de Azure para la generaci√≥n SAS </h2><br><p>  Como servicio en l√≠nea, es m√°s f√°cil usar las caracter√≠sticas de Azure.  Estos son fragmentos √∫nicos que se pueden escribir de inmediato en el portal de Azure en el navegador.  Bromeando como una broma, pero de esta manera puedes programar incluso desde un tel√©fono inteligente.  Por supuesto, nadie proh√≠be crearlos y depurarlos desde Visual Studio, y solo luego publicarlo en Azure en forma compilada. </p><br><p>  La tarea de la funci√≥n es realizar algunas operaciones generalmente no muy complicadas.  Seg√∫n la idea del microservicio, cada funci√≥n puede hacer una cosa, pero es muy buena (principio de responsabilidad √∫nica). </p><br><p>  Puede crear una aplicaci√≥n Azure Function en el portal completando un breve formulario </p><br><p><img src="https://habrastorage.org/webt/hd/ec/cu/hdeccuzb_kfv3cz7ggi1x5cnwe4.png"></p><br><p>  El Plan de consumo le permite pagar solo por las llamadas de funci√≥n que se han comprometido.  Esta es la opci√≥n m√°s barata.  Actualmente, un mill√≥n de llamadas a funciones son gratuitas. </p><br><p>  Tenga en cuenta que junto con la creaci√≥n de la funci√≥n, tambi√©n se crea un almacenamiento de datos auxiliar (Almacenamiento). </p><br><p>  Despu√©s de crear la aplicaci√≥n de funciones, puede crear la funci√≥n en s√≠.  En este caso, necesitamos una funci√≥n como Webhook + API.  La funci√≥n puede estar abierta a todos (acceso an√≥nimo) y puede estar disponible solo para los propietarios de un c√≥digo especial.  El c√≥digo se puede obtener desde la ventana con la funci√≥n haciendo clic en el enlace &lt;/&gt; Obtener URL de la funci√≥n: </p><br><p><img src="https://habrastorage.org/webt/fl/mi/4w/flmi4wk8td66jpkudkozeqaec_o.png"></p><br><p>  Las funciones se pueden escribir en varios idiomas.  Prefiero C #. </p><br><pre> <code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">using</span></span> <span class="hljs-keyword"><span class="hljs-keyword">System</span></span>.Net; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> Microsoft.Azure.Devices; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> Microsoft.Azure.Devices.Common.<span class="hljs-keyword"><span class="hljs-keyword">Security</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> <span class="hljs-keyword"><span class="hljs-keyword">System</span></span>.Globalization; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> <span class="hljs-keyword"><span class="hljs-keyword">System</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">Security</span></span>.Cryptography; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> <span class="hljs-keyword"><span class="hljs-keyword">System</span></span>.Text; <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> static async Task&lt;HttpResponseMessage&gt; Run(HttpRequestMessage req, TraceWriter <span class="hljs-keyword"><span class="hljs-keyword">log</span></span>) { string deviceid = req.GetQueryNameValuePairs() .FirstOrDefault(q =&gt; string.Compare(q.Key, "deviceid", <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>, CultureInfo.InvariantCulture) == <span class="hljs-number"><span class="hljs-number">0</span></span>).<span class="hljs-keyword"><span class="hljs-keyword">Value</span></span>; string hash = req.GetQueryNameValuePairs() .FirstOrDefault(q =&gt; string.Compare(q.Key, "hash", <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>, CultureInfo.InvariantCulture) == <span class="hljs-number"><span class="hljs-number">0</span></span>).<span class="hljs-keyword"><span class="hljs-keyword">Value</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (String.IsNullOrEmpty(deviceid)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> req.CreateResponse(HttpStatusCode.BadRequest, "device id missing"); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (String.IsNullOrEmpty(hash)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> req.CreateResponse(HttpStatusCode.BadRequest, "hash missing"); var resourceUri ="ArduinoDemoHub.azure-devices.net/devices/"+deviceid; // taken <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> IoT Hub <span class="hljs-keyword"><span class="hljs-keyword">user</span></span> <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Connect</span></span> devices rights (<span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> Device Explorer) var connectionString = "HostName=ArduinoDemoHub.azure-devices.net;SharedAccessKeyName=iothubowner;SharedAccessKey=cuYBKc42lfJr4oSRGQGQ8IiKWxGQkLre7rprZDZ/ths="; var registryManager = RegistryManager.CreateFromConnectionString(connectionString); var device = await registryManager.GetDeviceAsync(deviceid); var key = device.Authentication.SymmetricKey.PrimaryKey; HMACSHA256 hmac = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> HMACSHA256(<span class="hljs-keyword"><span class="hljs-keyword">Encoding</span></span>.UTF8.GetBytes("somerandomkeyKJBWyfy4gski")); var hashedkey = Convert.ToBase64String(hmac.ComputeHash(<span class="hljs-keyword"><span class="hljs-keyword">Encoding</span></span>.UTF8.GetBytes(key))); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (hashedkey!=hash) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> req.CreateResponse(HttpStatusCode.BadRequest, "wrong hash"); SharedAccessSignatureBuilder sasBuilder = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> SharedAccessSignatureBuilder() { Key = key, Target = resourceUri, TimeToLive = TimeSpan.FromDays(Convert.ToDouble(<span class="hljs-number"><span class="hljs-number">7</span></span>)) }; var SAS = sasBuilder.ToSignature(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> req.CreateResponse(HttpStatusCode.OK, SAS); }</code> </pre> <br><p>  Creamos el archivo project.json y le agregamos los siguientes contenidos: </p><br><pre> <code class="hljs json">{ <span class="hljs-attr"><span class="hljs-attr">"frameworks"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"net46"</span></span>:{ <span class="hljs-attr"><span class="hljs-attr">"dependencies"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"Microsoft.Azure.Devices"</span></span>: <span class="hljs-string"><span class="hljs-string">"1.4.1"</span></span> } } } }</code> </pre> <br><p>  El c√≥digo usa la cadena de conexi√≥n al centro de IoT.  Se puede confundir con la cadena de conexi√≥n al dispositivo.  Para que no se confunda, perm√≠tame recordarle d√≥nde puede obtenerlo: </p><br><p><img src="https://habrastorage.org/webt/7v/i9/jd/7vi9jdnq12-lsf2gwv82pbbhge0.png"></p><br><p>  Es necesario tomar la cadena de conexi√≥n de alguna pol√≠tica con los derechos de conexi√≥n de dispositivo. <br>  Es mejor no especificar la cadena de conexi√≥n en el c√≥digo, como hice.  Hice esto solo por el ejemplo.  Lo mejor es acceder a la funci√≥n de configuraci√≥n de la aplicaci√≥n </p><br><p><img src="https://habrastorage.org/webt/u2/e_/uc/u2e_uchy0i1np_d6ikqjpbtpflw.png"></p><br><p>  Y especifique la cadena de conexi√≥n all√≠.  Despu√©s de eso, puede "obtenerlo" de la tienda segura usando </p><br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">ConfigurationManager</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.ConnectionStrings</span></span><span class="hljs-selector-attr"><span class="hljs-selector-attr">["___"]</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.ConnectionString</span></span></code> </pre> <br><p>  En el dispositivo, necesitamos guardar la clave hash.  Pero primero debes codificar los caracteres.  HttpUtility.UrlEncode del sistema. El espacio web nos ayudar√° con esto. </p><br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">hashedkey</span></span> = HttpUtility.UrlEncode(hashedkey);</code> </pre> <br><p>  Enviaremos la solicitud usando Get, pero no todos los caracteres se pueden pasar como un valor de par√°metro. </p><br><h2>  Escribir c√≥digo para enviar datos a la nube </h2><br><p>  Escrib√≠ un peque√±o c√≥digo en Lua enviando datos a la nube.  El resultado fue una especie de PoC.  Puede usarlo y modificarlo seg√∫n sus necesidades. <br>  Cree 2 archivos init.lua y SendDataToCloud.lua <br>  El contenido de la primera: </p><br><pre> <code class="hljs php">--    <span class="hljs-keyword"><span class="hljs-keyword">print</span></span>(<span class="hljs-string"><span class="hljs-string">'init.lua ver 1.2'</span></span>) wifi.setmode(wifi.STATION) <span class="hljs-keyword"><span class="hljs-keyword">print</span></span>(<span class="hljs-string"><span class="hljs-string">'set mode=STATION (mode='</span></span>..wifi.getmode()..<span class="hljs-string"><span class="hljs-string">')'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">print</span></span>(<span class="hljs-string"><span class="hljs-string">'MAC: '</span></span>..wifi.sta.getmac()) <span class="hljs-keyword"><span class="hljs-keyword">print</span></span>(<span class="hljs-string"><span class="hljs-string">'chip: '</span></span>..node.chipid()) <span class="hljs-keyword"><span class="hljs-keyword">print</span></span>(<span class="hljs-string"><span class="hljs-string">'heap: '</span></span>..node.heap()) --  Wifi station_cfg={} station_cfg.ssid=<span class="hljs-string"><span class="hljs-string">"_SSID"</span></span> station_cfg.pwd=<span class="hljs-string"><span class="hljs-string">"___"</span></span> station_cfg.save=<span class="hljs-keyword"><span class="hljs-keyword">false</span></span> wifi.sta.config(station_cfg) wifi_status_codes = { [<span class="hljs-number"><span class="hljs-number">0</span></span>] = <span class="hljs-string"><span class="hljs-string">"Idle"</span></span>, [<span class="hljs-number"><span class="hljs-number">1</span></span>] = <span class="hljs-string"><span class="hljs-string">"Connecting"</span></span>, [<span class="hljs-number"><span class="hljs-number">2</span></span>] = <span class="hljs-string"><span class="hljs-string">"Wrong Password"</span></span>, [<span class="hljs-number"><span class="hljs-number">3</span></span>] = <span class="hljs-string"><span class="hljs-string">"No AP Found"</span></span>, [<span class="hljs-number"><span class="hljs-number">4</span></span>] = <span class="hljs-string"><span class="hljs-string">"Connection Failed"</span></span>, [<span class="hljs-number"><span class="hljs-number">5</span></span>] = <span class="hljs-string"><span class="hljs-string">"Got IP"</span></span> } sntp_connect_status_codes = { [<span class="hljs-number"><span class="hljs-number">1</span></span>] = <span class="hljs-string"><span class="hljs-string">"DNS lookup failed"</span></span>, [<span class="hljs-number"><span class="hljs-number">2</span></span>] = <span class="hljs-string"><span class="hljs-string">"Memory allocation failure"</span></span>, [<span class="hljs-number"><span class="hljs-number">3</span></span>] = <span class="hljs-string"><span class="hljs-string">"UDP send failed"</span></span>, [<span class="hljs-number"><span class="hljs-number">4</span></span>] = <span class="hljs-string"><span class="hljs-string">"Timeout, no NTP response received"</span></span> } --    Wi-fi (   ) tmr.alarm(<span class="hljs-number"><span class="hljs-number">6</span></span>,<span class="hljs-number"><span class="hljs-number">1000</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">if</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">wifi</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sta</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getip</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">==</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">nil</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">then</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">print</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"Waiting for IP address! (Status: "</span></span></span></span><span class="hljs-function"><span class="hljs-params">..wifi_status_codes[wifi.sta.status</span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"><span class="hljs-params">()</span></span></span></span><span class="hljs-function"><span class="hljs-params">]..</span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">")"</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">else</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">print</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"New IP address is "</span></span></span></span><span class="hljs-function"><span class="hljs-params">..wifi.sta.getip</span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"><span class="hljs-params">()</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">tmr</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">stop</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">6</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> --    </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">NTP</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sntp</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sync</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">({</span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">'pool.ntp.org'</span></span></span></span><span class="hljs-function"><span class="hljs-params">}, function</span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"><span class="hljs-params">(sec, usec, server)</span></span></span></span><span class="hljs-function"><span class="hljs-params"> print</span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"><span class="hljs-params">(</span></span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-params"><span class="hljs-string">"Clock Synced: "</span></span></span></span></span><span class="hljs-function"><span class="hljs-params"><span class="hljs-params">..sec..</span></span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-params"><span class="hljs-string">", "</span></span></span></span></span><span class="hljs-function"><span class="hljs-params"><span class="hljs-params">..usec..</span></span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-params"><span class="hljs-string">", "</span></span></span></span></span><span class="hljs-function"><span class="hljs-params"><span class="hljs-params">..server)</span></span></span></span><span class="hljs-function"><span class="hljs-params"> tls.cert.verify</span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"><span class="hljs-params">(false)</span></span></span></span><span class="hljs-function"><span class="hljs-params"> --    dofile</span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"><span class="hljs-params">(</span></span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-params"><span class="hljs-string">'SendDataToCloud.lua'</span></span></span></span></span><span class="hljs-function"><span class="hljs-params"><span class="hljs-params">)</span></span></span></span><span class="hljs-function"><span class="hljs-params"> end, function</span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"><span class="hljs-params">(error_code)</span></span></span></span><span class="hljs-function"><span class="hljs-params"> print</span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"><span class="hljs-params">(</span></span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-params"><span class="hljs-string">"Clock Sync Failed: "</span></span></span></span></span><span class="hljs-function"><span class="hljs-params"><span class="hljs-params">..sntp_connect_status_codes[error_code])</span></span></span></span><span class="hljs-function"><span class="hljs-params"> end, </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">1</span></span></span></span><span class="hljs-function"><span class="hljs-params"> --      )</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">end</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">end</span></span></span><span class="hljs-function"> )</span></span></code> </pre> <br><p>  Este archivo se conecta a la red y ejecuta el c√≥digo del archivo SendDataToCloud.lua si la conexi√≥n es exitosa. </p><br><p>  Debe especificar los datos de su punto de acceso Wi-Fi como los valores de station_cfg.ssid y station_cfg.pwd. </p><br><p>  En el siguiente archivo, debe cambiar el nombre del dispositivo y el IoT del concentrador (variables DEVICE e IOTHUB).  La variable funcurl contiene la direcci√≥n de la funci√≥n generadora de SAS y el hash de la clave del dispositivo (que codificamos previamente usando HttpUtility.UrlEncode) como el valor del par√°metro hash </p><br><pre> <code class="hljs powershell">--  DEVICE = <span class="hljs-string"><span class="hljs-string">"LuaDevice"</span></span> IOTHUB = <span class="hljs-string"><span class="hljs-string">"ArduinoDemoHub.azure-devices.net"</span></span> PORT = <span class="hljs-number"><span class="hljs-number">8883</span></span> USER = <span class="hljs-string"><span class="hljs-string">"ArduinoDemoHub.azure-devices.net/"</span></span>..DEVICE..<span class="hljs-string"><span class="hljs-string">"/api-version=2016-11-14"</span></span> telemetry_topic=<span class="hljs-string"><span class="hljs-string">"devices/"</span></span>..DEVICE..<span class="hljs-string"><span class="hljs-string">"/messages/events/"</span></span> connected = false local headers = <span class="hljs-string"><span class="hljs-string">'Content-Type: application/x-www-form-urlencoded\r\n'</span></span>.. <span class="hljs-string"><span class="hljs-string">'Accept: */*\r\n'</span></span>.. <span class="hljs-string"><span class="hljs-string">'User-Agent: Mozilla/5.0 (Windows NT 6.1; Win64; x64; rv:47.0) Gecko/20100101 Firefox/47.0'</span></span> funcurl = <span class="hljs-string"><span class="hljs-string">"https://arduinofunction.azurewebsites.net/api/GenerateSASFunction?code=Jn7j54PbR31BSRa0UZrDwp4ZEltjmWHmblG9zLo0Ne0tyGM7w/wQ7w=="</span></span> funcurl = funcurl..<span class="hljs-string"><span class="hljs-string">"&amp;hash=oJzykimyQsTPtzgJxYq90Xfqmw1rZTPTCH%2bJ5sSurKI%3d"</span></span> funcurl = funcurl..<span class="hljs-string"><span class="hljs-string">"&amp;deviceid="</span></span>..DEVICE tmr.alarm(<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-number"><span class="hljs-number">5000</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, function() http.get(funcurl, headers, function(code, <span class="hljs-keyword"><span class="hljs-keyword">data</span></span>, header) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (code &lt; <span class="hljs-number"><span class="hljs-number">0</span></span>) then print(<span class="hljs-string"><span class="hljs-string">"HTTP request failed"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> sas = true print(code, <span class="hljs-keyword"><span class="hljs-keyword">data</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> string.match(<span class="hljs-keyword"><span class="hljs-keyword">data</span></span>, <span class="hljs-string"><span class="hljs-string">"Shared"</span></span>) then tmr.stop(<span class="hljs-number"><span class="hljs-number">1</span></span>) SAS = string.sub(<span class="hljs-keyword"><span class="hljs-keyword">data</span></span>,<span class="hljs-number"><span class="hljs-number">2</span></span>,string.len(<span class="hljs-keyword"><span class="hljs-keyword">data</span></span>)<span class="hljs-literal"><span class="hljs-literal">-1</span></span>) print(SAS) connect(SAS) <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">connect</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(SAS)</span></span></span><span class="hljs-function"> --   </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">MQTT</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">client</span></span></span><span class="hljs-function"> = </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">mqtt</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Client</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(DEVICE, 240, USER, SAS)</span></span></span><span class="hljs-function"> --   </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">IoTHub</span></span></span><span class="hljs-function">    </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">MQTT</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">print</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">("Connecting to MQTT broker. Please wait...")</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">tmr</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">alarm</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(2,1000, 1, function()</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">client</span></span></span><span class="hljs-function">:</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">connect</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(IOTHUB, PORT, 1, -- Callback     function(client)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">tmr</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">stop</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(2)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">print</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">("Connected to MQTT: "..IOTHUB..":"..PORT.." as "..DEVICE)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">connected</span></span></span><span class="hljs-function"> = </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">true</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">senddata</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">end</span></span></span><span class="hljs-function">, -- </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Callback</span></span></span><span class="hljs-function">    </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(client, reason)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">print</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">("Error Connecting: "..reason)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">end</span></span></span><span class="hljs-function"> ) </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">end</span></span></span><span class="hljs-function">) </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">end</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">senddata</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">math</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">randomseed</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(1)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">tmr</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">alarm</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(3, 1000, tmr.ALARM_AUTO, publish_data)</span></span></span><span class="hljs-function"> --   ,     </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">callback</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">client</span></span></span><span class="hljs-function">:</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">on</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">("offline", function(client)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">print</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">("MQTT Disconnected.")</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">connected</span></span></span><span class="hljs-function"> = </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">false</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">end</span></span></span><span class="hljs-function">) </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">end</span></span></span><span class="hljs-function"> --      </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">publish_data</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">if</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">connected</span></span></span><span class="hljs-function"> == </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">true</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">then</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">somedata</span></span></span><span class="hljs-function"> = </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">math</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">random</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(1,100)</span></span></span><span class="hljs-function"> --     </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">payload</span></span></span><span class="hljs-function"> = "</span></span>{ \<span class="hljs-string"><span class="hljs-string">"deviceId\"</span></span> : \<span class="hljs-string"><span class="hljs-string">""</span></span>..DEVICE..<span class="hljs-string"><span class="hljs-string">"\"</span></span>,<span class="hljs-string"><span class="hljs-string">".. "</span></span>\<span class="hljs-string"><span class="hljs-string">"iotdata\"</span></span> :<span class="hljs-string"><span class="hljs-string">"..somedata.."</span></span>}<span class="hljs-string"><span class="hljs-string">" --   client:publish(telemetry_topic, payload, 1, 0, function(client) print("</span></span><span class="hljs-keyword"><span class="hljs-keyword">Data</span></span> published successfully.<span class="hljs-string"><span class="hljs-string">") end) end end</span></span></code> </pre> <br><p>  Los datos se env√≠an sin usar el SDK de Azure, por lo que puede usar este c√≥digo no solo para enviar datos a Azure.  Hay muchas alternativas: AWS, Google Cloud IoT, IBM Watson IoT Platform. </p><br><p>  El ejemplo utiliza el protocolo MQTT (Transporte de telemetr√≠a de colas de mensajes).  Este es un protocolo abierto dise√±ado espec√≠ficamente para dispositivos IoT.  Los datos se env√≠an en formato JSON.  Cuando en proyectos reales se toman datos de sensores, se genera un n√∫mero aleatorio en el ejemplo. </p><br><p>  Durante el proceso de enlace entre el dispositivo y el centro de IoT, el servidor puede enviar su certificado o puede solicitar un certificado de dispositivo.  Si recuerdas, la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">√∫ltima vez que</a> trabajamos con el dispositivo Arduino, lo flasheamos con un certificado.  Ahora un sumidero de c√≥digo es suficiente: </p><br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">tls</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.cert</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.verify</span></span>(<span class="hljs-selector-tag"><span class="hljs-selector-tag">false</span></span>)</code> </pre> <br><p>  Estamos limitados al certificado que el servidor nos enviar√°. </p><br><h2>  INFORMACI√ìN </h2><br><p>  Puede interesarle el contenido de los certificados para su concentrador utilizando el siguiente comando OpenSSL. </p><br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">openssl</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">s_client</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-showcerts</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-connect</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">ArduinoDemoHub</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.azure-devices</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.net</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:8883</span></span></code> </pre> <br><p>  Para preparar el material, se utilizaron los laboratorios, que est√°n disponibles en el enlace: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Env√≠o de mensajes de dispositivo a la nube (D2C)</a> <br>  El c√≥digo no est√° muy actualizado y tuve que actualizarlo un poco, pero en general el enlace puede ser √∫til. </p><br><h2>  Trabajando con NodeMCU desde Arduino IDE </h2><br><p>  No puedo ignorar el tema del uso del SDK.  Su soluci√≥n es buena, pero el SDK es el mismo c√≥digo que ya est√° depurado, simplificado y listo para usar.  Algunas palabras sobre c√≥mo configurar y usar el IDE de Arduino para trabajar con NodeMCU. </p><br><p>  Despu√©s de instalar el IDE de Arduino, debe ir al men√∫ Archivo - Preferencias </p><br><p><img src="https://habrastorage.org/webt/ea/u_/fq/eau_fqwxsvtujmn50otjftkgwvi.png"></p><br><p>  Y agregue un enlace al administrador de la junta adicional: ingrese en el campo URL del Administrador de la Junta Adicional la direcci√≥n: <a href="">http://arduino.esp8266.com/versions/2.4.0/package_esp8266com_index.json</a> </p><br><p>  Luego vaya al men√∫ Herramientas - Tablero xxx - Administrador de Boardx e instale ESP8266 <br>  Instale las bibliotecas AzureIoTHub, AzureIoTUtility, AzureIoTProtocol_MQTT.  Despu√©s de instalar la √∫ltima biblioteca en los ejemplos (men√∫ Archivo - Ejemplos - AzureIoTProtocol_MQTT), puede encontrar un ejemplo simpleample_mqtt para ESP8266. </p><br><p>  El ejemplo est√° listo para comenzar.  Simplemente complete los valores de las variables en el archivo iot_configs.h <br>  Menciono una peque√±a desventaja.  Compilar el proyecto y descargarlo en el tablero, en comparaci√≥n con Lua, lleva bastante tiempo. </p><br><h2>  Guardar datos en la nube de Azure </h2><br><p>  Con el env√≠o de datos, todo est√° claro, pero qu√© tan econ√≥mico es guardar datos en la nube. <br>  La forma m√°s econ√≥mica de enviar datos desde el centro de IoT a la base de datos es Azure Functions.  Y el almacenamiento de datos m√°s econ√≥mico es Azure Table Storage. </p><br><p>  Curiosamente, cuando crea una aplicaci√≥n de funci√≥n, el almacenamiento tambi√©n se crea autom√°ticamente, que la funci√≥n en s√≠ misma necesita para funcionar.  Si crea un repositorio separado, es aconsejable hacer la configuraci√≥n b√°sica de la siguiente manera: </p><br><p><img src="https://habrastorage.org/webt/zg/va/sz/zgvaszlilbyzjh6srxdmrq3cjyi.png"></p><br><p>  La replicaci√≥n de LSR es actualmente la opci√≥n m√°s econ√≥mica.  Se selecciona cuando se crea autom√°ticamente un repositorio vinculado a una funci√≥n. <br>  Lo que necesitamos ahora es recibir datos del centro de IoT y escribirlos en el almacenamiento.  Para este caso, al crear una funci√≥n, la ventana de Inicio r√°pido no podr√° ofrecernos la opci√≥n deseada. </p><br><p><img src="https://habrastorage.org/webt/x5/vw/6i/x5vw6ia4ubsfidgvpqmlrretqru.png"></p><br><p>  Por lo tanto, haga clic en el enlace de la funci√≥n personalizada ubicado en la parte inferior y seleccione la opci√≥n IoT Hub (Event Hub). <br>  Esta ventana se abrir√° para nosotros: </p><br><p><img src="https://habrastorage.org/webt/gu/t6/ry/gut6ryx8peg_aq2mqfv0dr62agk.jpeg"></p><br><p>  En el que podemos completar el campo de conexi√≥n de Event Hub con una opci√≥n simple (haciendo clic en nuevo).  Pero para indicar el nombre del Event Hub, debe ir al IoT Hub.  En el centro, debe ir a Puntos finales (puntos finales) y obtener el nombre compatible con Event Hub desde all√≠ </p><br><p><img src="https://habrastorage.org/webt/dl/tk/lb/dltklbv7hubhxdhe07nioe7ckgu.png"></p><br><p>  Pasemos al c√≥digo de funci√≥n.  El siguiente fragmento recibe datos del centro de IoT y los almacena en Table Storage: </p><br><pre> <code class="hljs lua">#r <span class="hljs-string"><span class="hljs-string">"Microsoft.WindowsAzure.Storage"</span></span> #r <span class="hljs-string"><span class="hljs-string">"Newtonsoft.Json"</span></span> using Microsoft.Azure; // Namespace <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> CloudConfigurationManager using Microsoft.WindowsAzure.Storage; // Namespace <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> CloudStorageAccount using Microsoft.WindowsAzure.Storage.Table; // Namespace <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> Table storage types using Newtonsoft.Json; public static void Run(<span class="hljs-built_in"><span class="hljs-built_in">string</span></span> myIoTHubMessage, TraceWriter <span class="hljs-built_in"><span class="hljs-built_in">log</span></span>) { var e = JsonConvert.DeserializeObject&lt;EventDataEntity&gt;(myIoTHubMessage); <span class="hljs-built_in"><span class="hljs-built_in">log</span></span>.Info($<span class="hljs-string"><span class="hljs-string">"C# IoT Hub trigger function processed a message: {myIoTHubMessage}"</span></span>); CloudStorageAccount storageAccount = CloudStorageAccount.Parse (<span class="hljs-string"><span class="hljs-string">"DefaultEndpointsProtocol=https;AccountName=iotdatademostorage;AccountKey=JgStNcJvlQYeNsVCmpkHQUkWlZiQ7tJwAm6OCL34+lGx3XrR+0CPiY9RoxIDA6VSvMKlOEUrVWL+KWP0qLMLrw==;EndpointSuffix=core.windows.net"</span></span>); CloudTableClient tableClient = storageAccount.CreateCloudTableClient(); CloudTable <span class="hljs-built_in"><span class="hljs-built_in">table</span></span> = tableClient.GetTableReference(<span class="hljs-string"><span class="hljs-string">"iottable"</span></span>); <span class="hljs-built_in"><span class="hljs-built_in">table</span></span>.CreateIfNotExists(); EventDataEntity edata = new EventDataEntity(<span class="hljs-string"><span class="hljs-string">"IOTpartition"</span></span>, Guid.NewGuid().ToString()); edata.DeviceId = e.DeviceId; edata.IotData = e.IotData; TableOperation insertOperation = TableOperation.Insert(edata); <span class="hljs-built_in"><span class="hljs-built_in">table</span></span>.Execute(insertOperation); } public class EventDataEntity : TableEntity { public EventDataEntity(<span class="hljs-built_in"><span class="hljs-built_in">string</span></span> pkey, <span class="hljs-built_in"><span class="hljs-built_in">string</span></span> rkey) { this.PartitionKey = pkey; this.RowKey = rkey; } public EventDataEntity() { } public <span class="hljs-built_in"><span class="hljs-built_in">string</span></span> DeviceId { get; set; } public int IotData { get; set; } }</code> </pre> <br><p>  Si va a utilizar este c√≥digo en un proyecto real, no olvide colocar la cadena de conexi√≥n en un lugar m√°s seguro, en la configuraci√≥n de la aplicaci√≥n (exactamente igual que la cadena de conexi√≥n de la primera funci√≥n). </p><br><p>  La cadena de conexi√≥n en s√≠ se puede tomar en el elemento de configuraci√≥n llamado Teclas de acceso: </p><br><p><img src="https://habrastorage.org/webt/ot/z9/pb/otz9pbjqyflhjivwztvvsmkjms4.png"></p><br><p>  Ver el contenido de la tabla con la utilidad gratuita <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Azure Storage Explorer</a> </p><br><p>  Dado que el costo de Azure Table Storage es bastante bajo, y Azure Functions e IoT Hub ofrecen ciertos recursos mensuales de forma gratuita, el costo de la soluci√≥n completa por mes puede ser inferior a $ 1.  Por supuesto, depende de la cantidad de datos.  Cuenta por ti mismo.  Hoy, 1 GB de datos cuesta 7 centavos por mes y por cada mill√≥n de transacciones se le cobrar√° solo 4 centavos. </p><br><h2>  INFORMACI√ìN </h2><br><p>  Cuando utilice servicios en la nube de cualquier proveedor, siempre le aconsejo que vincule una tarjeta de cr√©dito con la cantidad m√≠nima de dinero a su cuenta.  Es una casualidad que al elegir alg√∫n tipo de configuraci√≥n err√≥nea pague mucho m√°s de lo que espera. </p><br><p>  Le recordamos que esta es la versi√≥n completa de un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">art√≠culo de la revista Hacker</a> .  Su autor es <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Alexey Sommer</a> . </p><br><h2>  Materiales utiles </h2><br><h4>  Gu√≠a de arquitectura de aplicaciones en la nube </h4><br><p> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><img width="200" align="left" src="https://habrastorage.org/webt/zk/ns/pq/zknspqark8ose3vto4iom_kbdaq.jpeg"></a>  Adopte un enfoque estructurado para desarrollar aplicaciones en la nube.  Este libro electr√≥nico de 300 p√°ginas sobre arquitectura de computaci√≥n en la nube analiza las pautas de arquitectura, desarrollo e implementaci√≥n que se aplican independientemente de la plataforma de nube que elija.  Esta gu√≠a incluye pasos para: </p><br><ul><li>  Elegir el estilo de arquitectura de aplicaciones en la nube adecuado para su aplicaci√≥n o soluci√≥n; </li><li>  selecci√≥n de tecnolog√≠as apropiadas de computaci√≥n y almacenamiento de datos; </li><li>  implementando 10 principios de desarrollo para crear una aplicaci√≥n escalable, resistente y manejable; </li><li>  siguiendo los cinco principios de crear software de calidad que garantice el √©xito de su aplicaci√≥n en la nube; </li><li>  Usando patrones de dise√±o dise√±ados para el problema que est√° tratando de resolver. </li></ul><br><p>  ‚Üí <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><b>Descargar</b></a> </p><br><h4>  Gu√≠a del desarrollador de Azure </h4><br><p> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><img width="200" align="right" src="https://habrastorage.org/webt/ik/2g/ot/ik2gotwyadnbqcjeusitbjdk550.png"></a> </p><br><p>  En esta actualizaci√≥n de la Gu√≠a del desarrollador de Azure, ver√° c√≥mo el conjunto completo de servicios para la plataforma de software de Azure satisface sus necesidades.  Aqu√≠ encontrar√° informaci√≥n sobre enfoques arquitect√≥nicos y las situaciones m√°s comunes que surgen al crear aplicaciones en la nube. </p><br><p>  ‚Üí <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><b>Descargar</b></a> </p><br><h4>  Conceptos b√°sicos de Microsoft Azure </h4><br><p> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><img width="200" align="left" src="https://habrastorage.org/webt/w1/pe/sj/w1pesji9lrslkdggsjzwdkya2la.png"></a>  Este libro proporciona informaci√≥n importante sobre los servicios clave de Azure para desarrolladores y profesionales de TI que son nuevos en la computaci√≥n en la nube.  Se incluyen demostraciones paso a paso para ayudar al lector a comprender c√≥mo comenzar con cada uno de los servicios clave.  Cada cap√≠tulo es independiente, no es necesario realizar demostraciones pr√°cticas de cap√≠tulos anteriores para comprender un cap√≠tulo en particular. </p><br><p>  Los siguientes temas est√°n cubiertos en este libro: </p><br><ul><li>  Comenzando con Azure; </li><li>  Azure Application Service y aplicaciones web; </li><li>  M√°quinas virtuales; </li><li>  Servicio de almacenamiento; </li><li>  Bases de datos </li><li>  Servicios adicionales de Azure. </li></ul><br><p>  ‚Üí <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><b>Descargar</b></a> </p><br><h2>  Enlaces utiles </h2><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Documentaci√≥n en ruso para IoT Hub</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Ejemplos de Azure IoT para Csharp (.NET)</a> </li></ul></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/es421847/">https://habr.com/ru/post/es421847/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../es421835/index.html">La Comisi√≥n Interagencial desarrolla nueva tecnolog√≠a para bloquear Telegram</a></li>
<li><a href="../es421837/index.html">Creaci√≥n de 1k intro Chaos para ZX-Spectrum</a></li>
<li><a href="../es421839/index.html">Programaci√≥n funcional de Java con Vavr</a></li>
<li><a href="../es421841/index.html">Robotaxi Waymo no est√° listo para acceder a la v√≠a p√∫blica</a></li>
<li><a href="../es421845/index.html">¬øQu√© hacen realmente los analistas de datos? Hallazgos de 35 entrevistas</a></li>
<li><a href="../es421849/index.html">Eventos para RRHH en TI en septiembre de 2018: My Circle Digest</a></li>
<li><a href="../es421851/index.html">Problemas de b√∫ho y globo: conectando dos ensamblajes con espacios de nombres y nombres de clase id√©nticos</a></li>
<li><a href="../es421855/index.html">Proyectores caseros: los mejores "seg√∫n versi√≥n", enfoque ultracorto, campeones en brillo y velocidad</a></li>
<li><a href="../es421857/index.html">ToFoIn v 1. Reserva de puertas de enlace y cambio entre canales externos en FreeBSD</a></li>
<li><a href="../es421859/index.html">Notas del proveedor de IoT. Dispositivos y superados</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>