<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🤲 🕤 💡 我的家庭自动化系统 👩🏿‍🎨 ➡️ 🤷🏾</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="哈Ha！ 

 本文（周期）的目的是Habra效应，这是有关我的家庭自动化系统的介绍性故事，当然，我并不是从零开始发明并创建所有内容的，而是仅收集了我认为最适合此目的的技术和项目，并从自己身上添加了一些东西。 业余级别，但结果一切正常，人们使用它，并且没有在俱乐部追赶我。 我自己做了一切。 我们欢迎...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>我的家庭自动化系统</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/442600/"> 哈Ha！ <br><br> 本文（周期）的目的是<s>Habra效应，这是</s>有关我的家庭自动化系统<s>的</s>介绍性故事，当然，我并不是从零开始发明并创建所有内容的，而是仅收集了我认为最适合此目的的技术和项目，并从自己身上添加了一些东西。 业余级别，但结果一切正常，人们使用它，并且没有在俱乐部追赶我。 我自己做了一切。 我们欢迎建设性的批评，知道任何观点都会很有趣。 <br><br> 该系统包括设备和一组程序：直接用于设备通信和可视化的自动化系统，用于远程监视和更新的通信和遥测，Yandex的语音助手。 所有内容<i>（几乎所有内容）</i> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">均已</a>打开并发布在<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Github上</a> 。 <br><a name="habracut"></a><br><h3> 设备水平 </h3><br> 主要和必要的部分是基于Raspberry Pi的服务器，但是它可以在装有Debian或Ubuntu的PC上正常工作。  Raspbian操作系统。 系统应该可以在24/7/365正常工作，因此您需要高质量的电源，例如，理想的iPad电源。 <br><br><img src="https://habrastorage.org/webt/_v/-j/fk/_v-jfkopnckaqd6d2url7bbyso4.jpeg"><br><br> 对于远程管理，我还具有语音助手Yandex的技能，它需要一台具有“白色” IP和域的服务器。  MQTT服务器正在服务器上运行； SSL / TLS用于安全性。 <br><br> 通过BAOS 771-774网关提供KNX支持。  BAOS是KNX总线和LAN之间的接口。 允许通过Web服务以JSON格式访问总线上的地址。 <br><br>  <b>我的设备：</b> <br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Arduino IDE的项目</a> <br><br>  <b>基于Wemos D1 mini的Wifi控制器</b> <br><br><img src="https://habrastorage.org/webt/rg/tk/85/rgtk85up8tdsr6xayaj8ocg47-w.jpeg"><br><br> 通过230伏网络供电，也可以不使用公共5伏总线上的电源来为Wemos或它控制的设备（例如窗帘驱动器）供电。 可以将其安装在足够深的安装和接线盒中，例如在开关后面。 <br><br> 可以用来代替各种窗帘驱动器的无线电控制。 <br><br><div class="spoiler">  <b class="spoiler_title">方案</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/oy/xk/4w/oyxk4wsdxrvbw4dpkhtzajo6kt0.png"><br></div></div><br> 受控输出的引脚排列： <br>  L1，L2-来自BT-137S三端双向可控硅开关的功率输出，由wemos输出D0，D5通过MOC 3063S光耦合器控制，相位转换控制为零。 打开和关闭负载不会对网络造成干扰。 <br>  p1，p2-调光器或电动窗帘驱动器或其他按钮的pwm输出，具体取决于设置。 对应于Wemos'a D6，D7的结论。 <br>  A0模拟输入，用于连接各种传感器，例如灯光或附加按钮。 <br>  ds-DS18B20温度传感器的连接对应于引脚D1。 <br>  DHT-连接温度传感器DHT22对应于引脚D2。 <br>  b1，b2-短按和长按的按钮，具有点击计数器的功能，可以连接到电表，水表等的脉冲输出。 <br><br><div class="spoiler">  <b class="spoiler_title">工作示范</b> <div class="spoiler_text"><iframe width="560" height="315" src="https://www.youtube.com/embed/PPkzPMNiBQY" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br></div></div><br> 在Arduino IDE中创建的控制器程序。 适用于所有基于ESP-8266的主板。 控制器的网络设置，控制和操作由MQTT进行。 为了方便查看设置，这里有一个Web界面，以前可以通过http进行控制，但是后来我认为它是多余的并删除了它。 <br><br><div class="spoiler">  <b class="spoiler_title">网页界面</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/xs/ru/id/xsruid9tfryat8x2raxfmv7dggu.png"><br></div></div><br> 可以禁用Web界面。 为了方便初始配置，提供了winit.sh脚本和说明。 要将控制器重置为默认设置，必须输入命令“ default 1”或同时按下按钮b1，b2 20秒钟。 该程序还有一个简化版，用于托管的Sonoff网点。 <br><br>  <b>基于Arduino Mega的控制器</b> <br><br><img src="https://habrastorage.org/webt/ld/_e/cy/ld_ecy2suip8ef20lc4nmpqi53k.jpeg"><br><br> 它由mega本身和W5100网卡的屏蔽组成，该板具有用于调光器的单独输出以及用于传感器和按钮的输入，继电器输出必须使用电缆分别连接到mega板上位于电源和USB端口相反一侧的2行连接器。 该控制器是为D6MG机箱设计的。 <br><br> 引脚排列： <br><br>  D2-9，D11-13-调光器的PWM输出，PWM频率比标准频率增加。 <br>  D14-21-DS18B20和DHT22温度传感器。 <br>  D22-49-继电器输出，D22-29输出可配置用于百叶窗，门，窗帘驱动器。 <br>  D 10.50-53-使用W5100网卡。 <br>  A0-16-按键输入，短按和长按。 可以将A0-A6配置为模拟传感器。 <br><br>  mega的网络设置在闪烁之前已在程序中设置。  IP地址是固定的。 <br><br><div class="spoiler">  <b class="spoiler_title">网页界面</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/tv/9g/pp/tv9gppypwll3i_iyaqbpnjfzhbq.png"><br></div></div><br>  <b>双向可控硅BT137-600E上的调光器</b> <br><br><img src="https://habrastorage.org/webt/ss/uy/ah/ssuyahexjpkmq75dsydnyyefyie.jpeg"><br><br> 输入220伏，PWM控制0-5 / 3.3伏，通过设置跳线进行设置。 在Arduino Mega上工作时为0-5伏，在wemos情况下为0-3.3伏。  PWM信号被馈送到Arduino Pro的模拟输入A0，在此它被转换为打开三端双向可控硅开关的延迟，并提供了一个连接器，用于将arduino闪光。 散热器的指定空间。 在arduino的侧面上，有arduino的控制和电源连接器（PWM，-，+），在smimstor的侧面上有一个4针电源连接器-电源和输出到负载，如有必要，还可以配备压敏电阻或缓冲器。 调光板专为D2MG机箱而设计。 <br><br> 调光器项目： <br><br> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><img src="https://habrastorage.org/getpro/habr/post_images/8a1/ec4/335/8a1ec433583539dc1962e14fe1f031cd.png" alt="PCBWay的PCB"></a> <br><br><div class="spoiler">  <b class="spoiler_title">工作示范</b> <div class="spoiler_text"><iframe width="560" height="315" src="https://www.youtube.com/embed/Dj-iw9Rz5CE" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br></div></div><br>  D9MG封装中<b>还有一个28通道双向可控硅单元</b> 。 <br><br><div class="spoiler">  <b class="spoiler_title">我为图片质量表示歉意</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/os/iy/ri/osiyriitdnczwrpxqcxttd3saaq.jpeg"><br></div></div><br> 设备通过局域网连接，这是MQTT通信的协议。 我正在使用MQTT Mosquitto服务器。 <br><br><h3> 软件部分 </h3><br> 为了方便起见，首先您需要使用所有必需的程序准备操作系统的映像，我使用Raspbian Stretch Lite。 您将需要安装nodejs，python-pip，python3-pip，supervisor，mosquitto，mosquitto-clients和sqlite3。 和pip包：paho-mqtt和psutil。 您还可以安装Node-red，非常适合各种实验。 <br><br> 在2016年发布Apple Homekit之后，事实证明，与homkit相比，就整个智能家居系统而言，所有制造商和开发人员在便利性和功能性上都做不了任何事情，这与第一款iPhone的发布情况相似，当时整个动物园手机，智能手机，通讯器变成了一堆垃圾。 无论如何，使用高质量的成品总是令人愉快的。 <br><br> 我选择了<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">homekit2mqtt</a>项目作为主要的可视化系统。 当然，您可以使用OpenHUB或Homeassistant，这些系统也可以与MQTT一起使用。 <br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">hjmqtt</a> <br>  Homekit2mqtt创建Homekit Bridge，可以在Apple设备上的Home程序中找到它。 附件（照明，传感器，温度控制器等）必须以JSON格式注册在特殊文件中。 脚本filegen.sh和install.sh负责创建此文件。 您需要在filegen.sh中注册附件，install.sh将homekit2mqtt添加到自动加载并启动。 最主要的事情发生在hjmqtt.py文件中-附件与设备的连接，也手动在文件中，您需要注册附件和设备参数，KNX地址。 <br> 附件的功能已在文件annex.py和annexknx.py中注册。 设备状态存储在sqlite数据库中； statdb.py库用于数据库操作。 <br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">hjconnect</a> <br> 远程遥测需要下一个项目。 这是对内存，磁盘，负载和温度的使用，为此使用psutil软件包。 现在，开放访问仅适用于hjconnect版本，仅用于监视且没有加密，并且作为单独的项目，用于链接文件的程序也是MQTT <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">file-transfer-via-mqtt</a> 。 设置直接在主hjconnect.py文件中。 如果使用-l选项运行它，则可以在本地MQTT服务器上对其进行测试，远程服务器的设置位于第160行 <br><br><pre><code class="python hljs">rclient.connect(<span class="hljs-string"><span class="hljs-string">"test.mosquitto.org"</span></span>, <span class="hljs-number"><span class="hljs-number">1883</span></span>, <span class="hljs-number"><span class="hljs-number">60</span></span>)</code> </pre> <br> 服务器test.mosquitto.org可以替换为您的域或IP。 为了识别Raspberry Pi，该主题中包含了处理器的序列号，如果该程序在另一台计算机上运行，​​则将使用字符串“ SN”代替该序列号。 消息间隔在第96行设置。 <br><br><pre> <code class="python hljs">th = threading.Timer(<span class="hljs-number"><span class="hljs-number">9</span></span>, my_stat) <span class="hljs-comment"><span class="hljs-comment"># interval</span></span></code> </pre> <br> 其中9是秒。 <br><br><div class="spoiler">  <b class="spoiler_title">监视效果的示例</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/xa/dk/tu/xadktutaa2aiieil1rcwxzhz7zs.png"><br></div></div><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">西马</a> <br> 现在只有Yandex拥有唯一的俄语专栏。 为爱丽丝创建技能很容易。 与Siri不同，它具有完全的行动自由。 并在任何设备上访问。 不幸的是，虽然没有健全的方法来发动一项技能，但不断地运行一项技能并不方便。 <br><br><div class="spoiler">  <b class="spoiler_title">演示版</b> <div class="spoiler_text"><iframe width="560" height="315" src="https://www.youtube.com/embed/XiIFVnCSt-M" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br></div></div><br> 这是一个工作技能的例子。 要开始这项技能，您需要一个SSL证书；可以使用openssl生成它。 在第14行的sima.py行中​​，有一个证书生成的示例 <br><br><pre> <code class="bash hljs">openssl req -new -keyout crt.pem -out crt.pem -x509 -days 365 -nodes -subj <span class="hljs-string"><span class="hljs-string">'/CN=site.com/O=user/C=RU'</span></span></code> </pre> <br>  site.com和用户需要替换为其数据。 <br><br> 在新设备上启动技能时，会记录其标识符。 为了链接标识符和自动化系统，首先需要基于示例my.csv文件在客户目录中创建一个新的csv文件。 序列号根据模板写入文件中，与hjconnect程序中的序列号相同，并且写入了控制对象：名称，类型，主题。 主题是homekit2mqtt的JSON文件中MQTT附件主题的重要组成部分。 然后，需要使用sn.py将序列号转换为密码，并在要管理的设备上命名该密码。  hjconnect程序提供通信，并且MQTT监视服务器与运行该技能的计算机相同。 <br><br> 谢谢再见 </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN442600/">https://habr.com/ru/post/zh-CN442600/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN442590/index.html">数字取证技巧和窍门：如何在内存转储中查找活动的VPN连接</a></li>
<li><a href="../zh-CN442592/index.html">在Django项目中使用Joomla帐户</a></li>
<li><a href="../zh-CN442594/index.html">您会为我监视一切吗？ 是啊</a></li>
<li><a href="../zh-CN442596/index.html">游戏原声：人文也哭泣</a></li>
<li><a href="../zh-CN442598/index.html">需要猎头吗？</a></li>
<li><a href="../zh-CN442602/index.html">速度降低速度会降低吗？</a></li>
<li><a href="../zh-CN442606/index.html">龙目岛域对象：战斗经典</a></li>
<li><a href="../zh-CN442608/index.html">QuadrigaCX加密货币交易所的创建者去世的钱包被证明是空的</a></li>
<li><a href="../zh-CN442610/index.html">电报机器人+ Google Analytics</a></li>
<li><a href="../zh-CN442612/index.html">电子棋盘游戏的纸板引擎。 我们如何使其更接近现实</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>