<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👨🏽‍🍳 ⛹🏿 🔸 O que você precisa saber antes de migrar para o Akka toolkit para implementar o Event Sourcing e o CQRS 👩🏾‍🍳 🧙🏿 🏇🏼</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Olá, queridos leitores de Habr. Meu nome é Rustem e sou o principal desenvolvedor da empresa de TI do Cazaquistão DAR. Neste artigo, mostrarei o que v...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>O que você precisa saber antes de migrar para o Akka toolkit para implementar o Event Sourcing e o CQRS</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/453418/"><p>  Olá, queridos leitores de Habr.  Meu nome é Rustem e sou o principal desenvolvedor da empresa de TI do Cazaquistão DAR.  Neste artigo, mostrarei o que você precisa saber antes de passar para os modelos de Event Sourcing e CQRS usando o kit de ferramentas Akka. </p><br><p>  Por volta de 2015, começamos a projetar nosso ecossistema.  Após a análise e com base na experiência com Scala e Akka, decidimos parar no kit de ferramentas Akka.  Tivemos implementações bem-sucedidas de modelos de Sourcing de Eventos com CQRS e não.  A acumulação de conhecimentos nesta área, que quero compartilhar com os leitores.  Veremos como a Akka implementa esses padrões, bem como quais ferramentas estão disponíveis e falaremos sobre as armadilhas da Akka.  Espero que, depois de ler este artigo, você tenha mais compreensão dos riscos de mudar para o kit de ferramentas Akka. </p><a name="habracut"></a><br><p>  Sobre assuntos do CQRS e Event Sourcing, muitos artigos sobre Habré e outros recursos foram escritos.  Este artigo é destinado a leitores que já entendem o que são CQRS e Event Sourcing.  No artigo, quero me concentrar na Akka. </p><br><h3 id="domain-driven-design">  Design orientado a domínio </h3><br><p>  Muito material foi escrito sobre DDD (Domain-Driven Design).  Existem oponentes e apoiadores dessa abordagem.  Quero acrescentar por mim mesmo que, se você decidir mudar para Event Sourcing e CQRS, não será supérfluo estudar o DDD.  Além disso, a filosofia DDD é sentida em todas as ferramentas Akka. </p><br><p>  De fato, o Event Sourcing e o CQRS são apenas uma pequena parte do cenário geral chamado Design Orientado a Domínio.  Ao projetar e desenvolver, você pode ter muitas perguntas sobre como implementar adequadamente esses modelos e integrar-se ao ecossistema, e saber que o DDD facilitará sua vida. </p><br><blockquote>  Neste artigo, o termo entidade (entidade por DDD) significará um ator de persistência que possui um identificador exclusivo. </blockquote><br><h3 id="pochemu-scala">  Por que Scala? </h3><br><p>  Muitas vezes nos perguntam por que Scala, e não Java.  Uma razão é Akka.  A estrutura em si, escrita na linguagem Scala, com suporte para a linguagem Java.  Aqui devo dizer que também há uma implementação no <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">.NET</a> , mas esse é outro tópico.  Para não causar discussão, não escreverei por que o Scala é melhor ou pior que o Java.  Vou apenas citar alguns exemplos que, na minha opinião, o Scala tem uma vantagem sobre o Java ao trabalhar com o Akka: </p><br><ul><li> Objetos imutáveis.  Em Java, você precisa escrever objetos imutáveis.  Acredite, não é fácil nem muito conveniente escrever constantemente os parâmetros finais.  Na <code>case class</code> Scala já <code>case class</code> imutável com a função de <code>copy</code> integrada </li><li>  Estilo de codificação.  Quando implementado em Java, você ainda escreverá no estilo Scala, ou seja, funcionalmente. </li></ul><br><p>  Aqui está um exemplo de implementação do ator no Scala e Java: </p><br><p>  <strong>Scala:</strong> </p><br><pre> <code class="scala hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">object</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">DemoActor</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">props</span></span></span></span>(magicNumber: <span class="hljs-type"><span class="hljs-type">Int</span></span>): <span class="hljs-type"><span class="hljs-type">Props</span></span> = <span class="hljs-type"><span class="hljs-type">Props</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-type"><span class="hljs-type">DemoActor</span></span>(magicNumber)) } <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">DemoActor</span></span></span><span class="hljs-class">(</span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">magicNumber: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Int</span></span></span></span></span><span class="hljs-class">) </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Actor</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">receive</span></span></span><span class="hljs-function"> </span></span>= { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> x: <span class="hljs-type"><span class="hljs-type">Int</span></span> =&gt; sender() ! (x + magicNumber) } } <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SomeOtherActor</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Actor</span></span></span><span class="hljs-class"> </span></span>{ context.actorOf(<span class="hljs-type"><span class="hljs-type">DemoActor</span></span>.props(<span class="hljs-number"><span class="hljs-number">42</span></span>), <span class="hljs-string"><span class="hljs-string">"demo"</span></span>) <span class="hljs-comment"><span class="hljs-comment">// ... }</span></span></code> </pre> <br><p>  <strong>Java:</strong> </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">DemoActor</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AbstractActor</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> Props </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">props</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Integer magicNumber)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Props.create(DemoActor.class, () -&gt; <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> DemoActor(magicNumber)); } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Integer magicNumber; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">DemoActor</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Integer magicNumber)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.magicNumber = magicNumber; } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Receive </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">createReceive</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> receiveBuilder() .match( Integer.class, i -&gt; { getSender().tell(i + magicNumber, getSelf()); }) .build(); } } <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SomeOtherActor</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AbstractActor</span></span></span><span class="hljs-class"> </span></span>{ ActorRef demoActor = getContext().actorOf(DemoActor.props(<span class="hljs-number"><span class="hljs-number">42</span></span>), <span class="hljs-string"><span class="hljs-string">"demo"</span></span>); <span class="hljs-comment"><span class="hljs-comment">// ... }</span></span></code> </pre> <br><p>  (Exemplo retirado <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">daqui</a> ) </p><br><p>  Preste atenção na implementação do método <code>createReceive()</code> usando o exemplo da linguagem Java.  Internamente, através da fábrica do <code>ReceiveBuilder</code> , a correspondência de padrões é implementada.  <code>receiveBuilder()</code> é um método da Akka para suportar expressões lambda, ou seja, correspondência de padrões em Java.  Em Scala, isso é implementado nativamente.  Concordo, o código no Scala é mais curto e fácil de ler. </p><br><ul><li>  Documentação e exemplos.  Apesar do fato de que na documentação oficial existem exemplos em Java, na Internet, quase todos os exemplos estão em Scala.  Além disso, será mais fácil navegar nas fontes da biblioteca Akka. </li></ul><br><blockquote>  Em termos de desempenho, não haverá diferença entre Scala e Java, pois tudo gira na JVM. </blockquote><br><h3 id="hranilische">  Armazenamento </h3><br><p>  Antes de implementar o Event Sourcing com Akka Persistence, recomendo que você pré-selecione um banco de dados para armazenamento permanente de dados.  A escolha da base depende dos requisitos do sistema, de seus desejos e preferências.  Os dados podem ser armazenados no NoSQL e RDBMS e em um sistema de arquivos, por exemplo, LevelDB do <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Google</a> . </p><br><p>  É importante observar que o Akka Persistence não é responsável por escrever e ler dados do banco de dados, mas por meio de um plug-in que deve implementar a API do Akka Persistence. </p><br><p>  Depois de escolher uma ferramenta para armazenar dados, você precisa selecionar um <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">plug</a> - <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">in</a> da lista ou gravá-lo.  A segunda opção, eu não recomendo por que reinventar a roda. </p><br><p>  Para armazenamento permanente de dados, decidimos ficar no Cassandra.  O fato é que precisávamos de uma base confiável, rápida e distribuída.  Além disso, o Typesafe acompanha o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">plug</a> - <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">in</a> , que implementa completamente a <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">API</a> do <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Akka Persistence</a> .  É constantemente atualizado e, em comparação com outros, o plug-in Cassandra escreveu uma documentação mais completa. </p><br><p>  Vale ressaltar que o plugin também possui vários problemas.  Por exemplo, ainda não existe uma versão estável (no momento da redação deste documento, a versão mais recente é 0,97).  Para nós, o maior incômodo que encontramos ao usar este plug-in foi a perda de eventos ao ler a Consulta Persistente para algumas entidades.  Para uma imagem completa, abaixo está o gráfico do CQRS: </p><br><p><img src="https://habrastorage.org/webt/xd/3o/hk/xd3ohkb_wfvtfds2qangxxoctws.png"></p><br><p>  A entidade persistente distribui os eventos da entidade em tags usando o algoritmo de hash consistente (por exemplo, 10 shards): </p><br><p><img src="https://habrastorage.org/webt/eb/sq/zj/ebsqzjcj_nom7zs4pyizzkq5o0q.png"></p><br><p>  Em seguida, a consulta persistente assina essas tags e inicia um fluxo que adiciona dados à pesquisa elástica.  Como o Cassandra está em um cluster, os eventos serão espalhados pelos nós.  Alguns nós podem ceder e responderão mais lentamente que outros.  Não há garantia de que você receberá eventos em ordem estrita.  Para resolver esse problema, o plug-in é implementado para que, se ele receber um evento não ordenado, por exemplo, o <code>entity-A event NR 2</code> , aguarde um certo tempo pelo evento inicial e, se não o receber, simplesmente ignorará todos os eventos dessa entidade.  Mesmo sobre isso, houve discussões sobre Gitter.  Se alguém estiver interessado, você pode ler a correspondência entre o @kotdv e os desenvolvedores do plugin: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Gitter</a> </p><br><p>  <strong>Como esse mal-entendido pode ser resolvido:</strong> </p><br><ul><li>  Você precisa atualizar o plug-in para a versão mais recente.  Nas versões recentes, os desenvolvedores do Typesafe resolveram muitos problemas relacionados à consistência eventual.  Mas ainda estamos esperando por uma versão estável </li><li>  Configurações mais precisas foram adicionadas para o componente responsável por receber eventos.  Você pode tentar aumentar o tempo limite de eventos não ordenados para uma operação mais confiável do plug-in: c <code>assandra-query-journal.events-by-tag.eventual-consistency.delay=10s</code> </li><li>  Configure o Cassandra conforme recomendado pelo DataStax.  Coloque o coletor de lixo G1 e aloque o máximo de memória possível para o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Cassandra</a> . </li></ul><br><p>  No final, resolvemos o problema com os eventos ausentes, mas agora há um atraso de dados estável no lado da Consulta de Persistência (de cinco a dez segundos).  Foi decidido deixar a abordagem para os dados usados ​​para análise e, onde a velocidade é importante, publicamos eventos manualmente no barramento.  O principal é escolher o mecanismo apropriado para processar ou publicar dados: pelo menos uma vez ou no máximo uma vez.  Uma boa descrição da Akka pode ser encontrada <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">aqui</a> .  Era importante para nós manter a consistência dos dados e, portanto, após gravar com sucesso os dados no banco de dados, introduzimos um estado de transição que controla a publicação bem-sucedida de dados no barramento.  A seguir, é apresentado um código de exemplo: </p><br><pre> <code class="scala hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">object</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SomeEntity</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">sealed</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">trait</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Event</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">uuid</span></span></span></span>: <span class="hljs-type"><span class="hljs-type">String</span></span> } <span class="hljs-comment"><span class="hljs-comment">/** * ,    . */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">DidSomething</span></span></span><span class="hljs-class">(</span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">uuid: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">String</span></span></span></span></span><span class="hljs-class">) </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Event</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">/**</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">*</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title"></span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title"></span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title"></span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title"></span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title"></span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title"></span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title"></span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title"></span></span></span><span class="hljs-class">. </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">*/</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">case</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">LastEventPublished</span></span></span><span class="hljs-class">(</span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">uuid: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">String</span></span></span></span></span><span class="hljs-class">) </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Event</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">/**</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">*</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title"></span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title"></span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title"></span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title"></span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title"></span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title"></span></span></span><span class="hljs-class">. </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">*</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">@param</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">unpublishedEvents</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">–</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title"></span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title"></span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title"></span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title"></span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title"></span></span></span><span class="hljs-class">. </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">*/</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">case</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">State</span></span></span><span class="hljs-class">(</span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">unpublishedEvents: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Seq</span></span></span></span><span class="hljs-class"><span class="hljs-params">[</span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Event</span></span></span></span><span class="hljs-class"><span class="hljs-params">]</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">object</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">State</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">updated</span></span></span></span>(event: <span class="hljs-type"><span class="hljs-type">Event</span></span>): <span class="hljs-type"><span class="hljs-type">State</span></span> = event <span class="hljs-keyword"><span class="hljs-keyword">match</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> evt: <span class="hljs-type"><span class="hljs-type">DidSomething</span></span> =&gt; copy( unpublishedEvents = unpublishedEvents :+ evt ) <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> evt: <span class="hljs-type"><span class="hljs-type">LastEventPublished</span></span> =&gt; copy( unpublishedEvents = unpublishedEvents.filter(_.uuid != evt.uuid) ) } } } <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SomeEntity</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PersistentActor</span></span></span><span class="hljs-class"> </span></span>{ … persist(newEvent) { evt =&gt; updateState(evt) publishToEventBus(evt) } … }</code> </pre> <br><p>  Se, por algum motivo, não foi possível publicar o evento, no próximo início de <code>SomeEntity</code> , ele saberá que o evento <code>DidSomething</code> não chegou ao barramento e tentará republicar os dados novamente. </p><br><h3 id="serializator">  Serializer </h3><br><p>  A serialização é um ponto igualmente importante no uso do Akka.  Ele tem um módulo interno - <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Akka Serialization</a> .  Este módulo é usado para serializar mensagens ao trocá-las entre atores e ao armazená-las através da API Persistence.  Por padrão, o Java serializer é usado, mas é recomendável usar outro.  O problema é que o Java Serializer é lento e ocupa muito espaço.  Existem duas soluções populares - estas são JSON e Protobuf.  O JSON, embora lento, é mais fácil de implementar e manter.  Se você precisar minimizar o custo de serialização e armazenamento de dados, poderá parar no Protobuf, mas o processo de desenvolvimento será mais lento.  Além do modelo de domínio, você precisará escrever outro modelo de dados.  Não se esqueça da versão dos dados.  Esteja preparado para escrever constantemente o mapeamento entre o Modelo de Domínio e o Modelo de Dados. </p><br><p><img src="https://habrastorage.org/webt/ag/fk/h0/agfkh04g1ykq5ymlxl0ma5ciwmo.png"></p><br><p>  Adicionado um novo evento - mapeamento de gravação.  Mudou a estrutura de dados - escreva uma nova versão do Modelo de Dados e altere a função de mapeamento.  Não se esqueça dos testes para serializadores.  Em geral, haverá muito trabalho, mas no final você obterá componentes fracamente acoplados. </p><br><h3 id="vyvody">  Conclusões </h3><br><ul><li>  Estude cuidadosamente e escolha uma base e um plug-in adequados para si.  Eu recomendo escolher um plugin que seja bem mantido e não pare de se desenvolver.  A área é relativamente nova, ainda há um monte de falhas que ainda precisam ser resolvidas </li><li>  Se você selecionar o armazenamento distribuído, terá que resolver o problema com um atraso de até 10 segundos, ou suportá-lo </li><li>  A complexidade da serialização.  Você pode sacrificar a velocidade e parar no JSON, ou escolher Protobuf e escrever muitos adaptadores e suportá-los. </li><li>  Há vantagens nesse modelo: são componentes fracamente acoplados e equipes de desenvolvimento independentes que constroem um grande sistema. </li></ul></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt453418/">https://habr.com/ru/post/pt453418/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt453408/index.html">Caixa de ferramentas para pesquisadores - segunda edição: uma coleção de 15 bancos de dados temáticos</a></li>
<li><a href="../pt453410/index.html">Não jogue lâmpadas inteligentes no lixo ou o perigo da IoT</a></li>
<li><a href="../pt453412/index.html">Top 3D Shop se torna distribuidora exclusiva da UFactory</a></li>
<li><a href="../pt453414/index.html">A ascensão e queda do IEO, tudo o que você precisa saber sobre a nova onda de captação de recursos</a></li>
<li><a href="../pt453416/index.html">Como a configuração funciona no .NET Core</a></li>
<li><a href="../pt453422/index.html">Familiaridade com o ITSM: 10 habratópicos e materiais especializados para “imersão rápida” no tópico</a></li>
<li><a href="../pt453428/index.html">Aumentando a legibilidade do código no desenvolvimento do iOS</a></li>
<li><a href="../pt453430/index.html">Como eu escrevi meu monitoramento</a></li>
<li><a href="../pt453432/index.html">Da crítica aos algoritmos: a voz fraca das elites no mundo da música</a></li>
<li><a href="../pt453434/index.html">Versatilidade de cartucho: sensores em jogos para Game Boy</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>