<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üïô üç´ üëÉüèæ Escrever um driver de laptop para divers√£o e lucro ou Como se comprometer com o kernel, mesmo que voc√™ n√£o seja t√£o inteligente üîì ü§òüèø üë©‚Äçüîß</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Onde tudo come√ßou 
 Vamos come√ßar com a nossa declara√ß√£o do problema. Temos 1 (um) laptop. Um novo laptop para jogadores. Com alguma luz de fundo RGB ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Escrever um driver de laptop para divers√£o e lucro ou Como se comprometer com o kernel, mesmo que voc√™ n√£o seja t√£o inteligente</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/484752/"><h2>  Onde tudo come√ßou </h2><br>  Vamos come√ßar com a nossa declara√ß√£o do problema.  Temos 1 (um) laptop.  Um novo laptop para jogadores.  Com alguma luz de fundo RGB no teclado.  √â assim: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/f6d/ef2/d0f/f6def2d0ff5bcc3fe56d7805f257fd7c.jpg" alt="imagem"><br>  <i>Foto tirada no lenovo.com</i> <br><br>  H√° tamb√©m um programa instalado neste laptop.  √â isso que controla nossa luz de fundo. <br><br>  Um problema - o programa √© executado no Windows e queremos que tudo funcione no nosso Linux favorito.  Quer que os LEDs pisquem e que cores bonitas pisquem e apagem, e assim por diante.  Uma quest√£o natural surge: podemos fazer tudo isso sem fazer engenharia reversa e escrever nossos pr√≥prios drivers? <br><br>  Uma resposta natural surge, n√£o.  Vamos abrir a IDA e come√ßar a quebrar. <br><br><a name="habracut"></a><br><br><h3>  Etapa 1 - Digitando o c√≥digo </h3><br>  Existem tr√™s gatilhos que fazem a luz de fundo brilhar.  Em ordem de dificuldade crescente: <br><br>  1. Um programa de jogadores com grandes buffs chamado Lenovo Nerve Center, que possui um menu de configura√ß√£o de grandes buffs apenas para essa luz de fundo. <br><br>  2. Combina√ß√£o de teclas de atalho Fn + Space - possivelmente gerenciada pelo programa acima mencionado tamb√©m. <br><br>  3. BIOS.  Enquanto o laptop est√° carregando, a luz de fundo pisca em vermelho por um breve momento.  Talvez possamos usar isso? <br><br>  Eu tive que tentar todos os 3. Mas houve algum sucesso apenas ao longo do primeiro, ent√£o vamos falar sobre o primeiro aqui. <br><br>  Abrimos a pasta com o nosso programa: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/105/aaa/774/105aaa77430d926b8df36807cb177f77.png" alt="pasta"><br><br>  Observe aqui!  H√° uma DLL com um nome muito interessante - LedSettingsPlugin.dll.  Poderia ser ...?  Vamos abri-lo no IDA Pro e ver por n√≥s mesmos. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/39c/994/5ae/39c9945aec86778f668c0f14ec97fe00.png" alt="metade direita"><br><br>  Veja a metade direita da tela aqui - tantas informa√ß√µes de depura√ß√£o!  Vamos us√°-lo.  Algumas strings parecem nomes de fun√ß√£o aqui.  Eu me pergunto por que ... <br><br><img src="https://habrastorage.org/getpro/habr/post_images/8e8/cd8/77d/8e8cd877d3551b32d680a2ce399f34d6.png" alt="nome da fun√ß√£o"><br><br>  Oh, esses <i>s√£o</i> nomes de fun√ß√µes.  Conveniente!  Vamos chamar algumas coisas com seus pr√≥prios nomes e depois ver a lista de fun√ß√µes novamente.  Para nomear itens na IDA, voc√™ pode usar a tecla de atalho N ou clicar com o bot√£o direito do mouse na coisa que deseja nomear. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/dc1/0a0/fd7/dc10a0fd790c45cfe0ace4303a971c64.png" alt="setledstatusex"><br><br>  Observando as fun√ß√µes, vemos algo chamado Y720LedSetHelper :: SetLEDStatusEx.  Parece que precisamos!  Ele forma algum tipo de string e, em seguida, o atribui a algo chamado CHidDevHelper :: HidRequestsByPath.  A parte interessante que devemos examinar √© var_38, destacada com carinho pela IDA. <br><br>  Var_34 tamb√©m √© interessante.  Isso acontece logo ap√≥s var_38 - nas tradi√ß√µes assembler, as vari√°veis ‚Äã‚Äãs√£o armazenadas em ordem inversa no RSP.  Var_34 no IDA √© apenas o nome da constante - -34h. <br><br>  A partir de var_38, nosso programa coloca zero, depois estilo, cor, o n√∫mero tr√™s e o bloco - parte do teclado que ganhar√° essa cor.  (Mais tarde, os experimentos mostrar√£o que o n√∫mero tr√™s √© realmente o brilho. Adicionar um controle sobre isso tornar√° nosso motorista ainda melhor do que o oficial!) <br><br>  Agora, vamos nos aprofundar no HidRequestsByPath e tentar descobrir o que precisamos enviar e para onde. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/bd3/368/4ea/bd33684ea9ec9a7253bb2902c91c1e04.png" alt="devhelper"><br><br>  Olha, duas fun√ß√µes.  HidD_GetFeature e HidD_SetFeature. <br><br>  Eles n√£o s√£o rastreados no arquivo ... mas s√£o muito bem rastreados na documenta√ß√£o oficial da Microsoft - <a href="https://docs.microsoft.com/en-us/windows-hardware/drivers/ddi/hidsdi/nf-hidsdi-hidd_setfeature" rel="nofollow">aqui</a> e <a href="https://docs.microsoft.com/en-us/windows-hardware/drivers/ddi/hidsdi/nf-hidsdi-hidd_getfeature" rel="nofollow">aqui</a> . <br><br>  Bem, podemos dar um tapinha nas costas agora.  Este √© o fundo do po√ßo, n√£o h√° onde cavar mais fundo.  O Linux tem essas duas fun√ß√µes - n√≥s apenas retornamos e as chamamos com os mesmos argumentos.  ... certo? <br><br><h3>  Etapa 2 - lan√ßando o prot√≥tipo ...? </h3><br><br>  N√£o exatamente.  Vamos voltar ao Linux e abrir o lsusb.  Encontraremos nosso teclado l√° e enviaremos algo para ele. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/461/304/5cd/4613045cd623936511a7edbb734b365a.png" alt="lsusb"><br><br>  Integrated Technology Express, Inc.  √© o mais interessante aqui.  Vamos usar a ferramenta popular / dev / hidraw.  Podemos encontrar o correto apenas olhando para o / sys / class / hidraw / hidraw * / device / uevent correspondente. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/0fd/aa4/39a/0fdaa439a9fb9b995fbf543e08858a57.png" alt="hidraw"><br><br>  Este aqui.  Todos os d√≠gitos correspondem - o que significa / dev / hidraw0 √© o nosso dispositivo.  Mas vamos tentar enviar algo ... e nada acontece!  Porque  Nesse ponto, o burnout entra em a√ß√£o.  Talvez n√£o seja por meros mortais, essa coisa de engenharia reversa? <br><br>  Mas vamos continuar tentando.  Se o autor fosse mais bom nisso, ele teria revertido o Nerve Center um pouco mais e teria uma solu√ß√£o ... Mas n√£o temos c√©rebro.  Vamos reiniciar no Windows, h√° uma ideia. <br><br>  Existe essa coisa no Windows - o Gerenciador de dispositivos, como eles chamam.  Tem muitas fun√ß√µes - mas estamos interessados ‚Äã‚Äãem uma.  Permite desativar dispositivos.  Simples e autorit√°rio. <br><br>  Ent√£o, vamos desativar todos os dispositivos at√© que nosso LED pare de piscar! <br><br><img src="https://habrastorage.org/getpro/habr/post_images/96f/778/0f1/96f7780f1987136f81aa5cbf842ac7b9.jpg" alt="desativar dispositivo"><br><br>  Isso foi feito.  Se espiarmos o seu ID de hardware - veremos o que √©, esse misterioso dispositivo de LED. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/7c5/a44/265/7c5a4426568f1c71e0c7426b3f9e20e4.jpg" alt="nosso dispositivo"><br><br>  Olha - √© ele. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/7f8/99d/a6a/7f899da6af09b1d0eb9159f6ffd6a151.png" alt="dmesg"><br><br>  O dispositivo que incomoda meu dmesg h√° v√°rios anos. <br><br>  <i>[Por que n√£o foi mostrado em LSUSB?</i>  <i>N√£o √© USB, √© claro!</i>  <i>A luz de fundo usa um protocolo chamado I2C HID - permite que o fabricante <s>esconda o dispositivo das m√£os de pessoas mal-intencionadas de DIY e</s> instale gadgets HID no barramento do sistema do pr√≥prio computador.]</i> <br><br><h3>  Sidestep 2.5 - vamos fazer um commit </h3><br>  Essa busca pelo dispositivo correto foi fortemente abreviada.  Na vers√£o original, eu tive que abrir minha configura√ß√£o quase at√© o kernel antes de perceber por que nada funcionava.  Al√©m disso, eu n√£o gostei desse log do dmesg aparecendo para mim toda vez que desbloqueio o computador.  J√° que estamos aqui - por que n√£o escrever um pequeno commit? <br><br>  Precisamos encontrar duas coisas - o local onde os dispositivos I2C HID s√£o manipulados e o local onde suas peculiaridades s√£o armazenadas.  <a href="" rel="nofollow">Aqui.</a>  N√£o vamos pensar muito e analisar o erro: relat√≥rio incompleto.  Vamos completar. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/eda/5da/50d/eda5da50dce50157f772a8a227702323.png" alt="tamanho de entrada ruim"><br><br>  Adicione uma nova peculiaridade, vamos cham√°-la de I2C_HID_QUIRK_BAD_INPUT_SIZE ou algo assim.  Para manter o tema. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/932/33e/296/93233e296f0d07184be67ca04cfb7539.png" alt="peculiaridade"><br><br>  Tamb√©m vamos adicionar nosso dispositivo √† lista de peculiaridades.  O que fizemos at√© agora: <br><br>  1. Procurei "i2c hid linux kernel" em um mecanismo de pesquisa.  Clicou no quarto resultado no DuckDuckGo. <br><br>  2. Escreveu tr√™s (!) Palavras em ingl√™s - BAD_INPUT_SIZE <br><br>  3. Adicionado um ao BIT (4).  Resultado - BIT (5). <br><br>  4. Adicionado um n√∫mero ao hid-ids.h - o ID do nosso dispositivo (n√£o ilustrado, mas com dificuldade semelhante) <br><br>  Somos programadores, vamos fazer uma programa√ß√£o agora. <br><br>  Veja a linha: <br> <code>ret_size = ihid-&gt;inbuf[0] | ihid-&gt;inbuf[1] &lt;&lt; 8;</code> <br> <br>  E depois reclama que ret_size n√£o √© o que quer. <br><br>  Sempre que nossa peculiaridade estiver ativa, vamos fazer isso apenas ao contr√°rio. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/dfe/693/f6c/dfe693f6c3d4bd88162f3902c6dd79af.png" alt="if-condition"><br><br>  Envie o patch para a lista de discuss√£o ... (teste antes!).  Para ser sincero, entrar nessa lista de discuss√£o foi mais complicado que o patch atual.  N√£o √© simples de forma alguma. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/33b/dc0/148/33bdc0148925600e067f37a385d5f09f.png" alt="aplicado"><br><br>  √â isso a√≠! <br><br><h3>  Etapa 3 - motorista! </h3><br>  Nesse ponto, lembrei - eu estava tentando escrever um driver.  Decidi que n√£o vou comprometer isso com o kernel ainda - as perguntas come√ßaram a surgir; nesse momento, voc√™ realmente precisa pensar em algumas.  Se algu√©m lendo isso √© bom no kernel e pode me consultar, ficaria feliz em falar. <br><br>  Vamos abrir o python.  (Costumava ser festan√ßa, mas voc√™ muda de id√©ia muito rapidamente com esse tipo de linguagem).  Vamos usar a ferramenta popular / dev / hidraw. <br><br>  / dev / hidraw0, / dev / hidraw1 - como esses arquivos funcionam?  Para E / S simples, voc√™ pode us√°-las como qualquer outra, e parece que isso funcionaria.  E GetFeature e SetFeature - bem, essa √© uma hist√≥ria completamente diferente. <br><br>  O StackOverflow (ou qualquer outra pessoa, n√£o me lembro) me disse que eu teria que procurar algo chamado ioctl.  √â uma maneira especial de trabalhar com arquivos incomuns, como dispositivos HID, terminais e coisas nojentas semelhantes. <br><br>  Parece simples na superf√≠cie - voc√™ fornece um identificador de arquivo aberto (n√£o no n√≠vel Python, no SO! Leia mais sobre identificadores do SO <a href="https://en.wikipedia.org/wiki/File_descriptor" rel="nofollow">aqui,</a> se quiser saber.) algo com esse buffer e devolva para voc√™.  Eu n√£o estou tentando ser inteligente aqui, √© apenas que √© quase totalmente dependente da implementa√ß√£o.  Aqui est√° um exemplo: 0xC0114806.  O que √© isso?  Isso √© SetFeature.  Isso tamb√©m <br><br> <code>(6 &lt;&lt; 29) | (ord('H') &lt;&lt; 8) | (0x06 &lt;&lt; 0) | (0x11 &lt;&lt; 16).</code> <br> <br>  Os 6 primeiros significam que o arquivo ser√° aberto tanto para leitura quanto para grava√ß√£o.  N√≥s escrevemos apenas, mas os documentos disseram 6, o que significa que colocamos 6. Ord ('H') significa HID.  √Äs vezes, representa outras coisas, dependendo do arquivo.  Mas agora est√° escondido. <br><br>  0x06 √© o pr√≥prio comando.  O sexto comando do HID √© o SetFeature, do qual precisamos.  E a √∫ltima parte?  O tamanho do buffer. <br><br>  Tudo o que resta √© junt√°-lo em uma chamada ioctl e voc√™ recebe um motorista.  <a href="https://gitlab.com/kryma/lenovo-y720-backlight-driver" rel="nofollow">Isso funciona.</a>  . <br><br><h3>  Posf√°cio do autor </h3><br>  Espero que o artigo tenha sido uma leitura interessante.  At√© uma leitura √∫til, possivelmente.  Algumas partes foram omitidas ou encurtadas por quest√µes de concis√£o - um leitor mais atento pode perceber que o driver pode ler o estado atual do teclado e a fun√ß√£o set_status possui uma segunda chamada ioctl que nem foi mencionada no texto.  O desenvolvimento de hardware e o kernel Linux s√£o grandes coisas, e um conto n√£o cobre tudo.  E no final do dia, talvez o artigo n√£o seja sobre isso.  Talvez seja apenas sobre como fazer algo pequeno e bom, para c√≥digo aberto ou para si mesmo, n√£o seja nada dif√≠cil.  Voc√™ s√≥ precisa encontrar o valor de uma semana de noites gratuitas, um pouco de ch√° e um desejo de procurar por c√≥digos. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt484752/">https://habr.com/ru/post/pt484752/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt484736/index.html">Linux: removendo o conjunto de bloqueios / dev / random</a></li>
<li><a href="../pt484738/index.html">Passo a passo de integra√ß√£o cont√≠nua para o Laravel 6 no Google Cloud Run</a></li>
<li><a href="../pt484740/index.html">Semana 04 de seguran√ßa: problemas de criptografia no Windows 10</a></li>
<li><a href="../pt484744/index.html">Como eu fiz sombras 2D no Unity</a></li>
<li><a href="../pt484750/index.html">Esquizofrenia: um cuidado</a></li>
<li><a href="../pt484754/index.html">A Intel n√£o pode decidir quem √© mais r√°pido: Comet Lake ou Ice Lake</a></li>
<li><a href="../pt484756/index.html">Teoria da Informa√ß√£o Visual (Parte 2)</a></li>
<li><a href="../pt484758/index.html">O que √© comum entre programar e iniciar um neg√≥cio</a></li>
<li><a href="../pt484760/index.html">Eventos digitais em Moscou, de 21 a 26 de janeiro</a></li>
<li><a href="../pt484762/index.html">6 maneiras de cancelar a inscri√ß√£o de Observables em Angular</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>