<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë®‚Äç‚úàÔ∏è üåó üêÉ C√≥mo preparar t√© usando MQTT o una toma inteligente asequible con control de temperatura y corriente üëì üëî üí£</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Por qu√© 
 Incluso en este centro hay un aumento en el inter√©s en IoT, en mi opini√≥n subjetiva, esta es una tendencia global que va mucho m√°s all√° del ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>C√≥mo preparar t√© usando MQTT o una toma inteligente asequible con control de temperatura y corriente</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/407541/"><blockquote><h2>  Por qu√© </h2></blockquote><br>  Incluso en este centro hay un aumento en el inter√©s en IoT, en mi opini√≥n subjetiva, esta es una tendencia global que va mucho m√°s all√° del alcance de este sitio.  Por lo tanto, vale la pena insertar sus 5 kopecks en el desarrollo de la direcci√≥n, especialmente porque la idea ha estado girando para un hogar inteligente durante mucho tiempo, lo que podr√≠a controlar el consumo de cualquier dispositivo alimentado por una red de 220V y permiti√≥ programar la l√≥gica de control dependiendo de los par√°metros de consumo, temperatura, fase la luna etc.  Hay soluciones listas para usar, pero a menudo algo no les conviene, y las listas no son nuestro m√©todo si puedes intentar construir tu propia bicicleta √∫nica. <br><br><img src="https://habrastorage.org/webt/59/ed/ea/59edeab0efb41513240944.jpeg"><br><br>  <b>Par√°metros de la futura bicicleta:</b> <br><br>  - Dispositivo barato de componentes disponibles p√∫blicamente. <br>  - Control de corriente en el circuito de consumo. <br>  - Gesti√≥n de dispositivos a trav√©s del protocolo MQTT. <br>  - Dispositivo de control de temperatura. <br>  - Dos sensores remotos para controlar la temperatura del consumidor. <br>  - Indicaci√≥n de estado en la pantalla del dispositivo. <br>  - Apagado de emergencia del consumidor si la temperatura o la corriente excede los valores establecidos. <br><a name="habracut"></a><br>  <b>Caso de aplicaci√≥n:</b> <br><br><ul><li>  Monitoreo del consumo de electricidad. </li><li>  La capacidad de desconectar remotamente el dispositivo en caso de accidente o simplemente as√≠. </li><li>  Un dispositivo simple para monitorear la temperatura en despensas de servidores semi-profesionales donde a menudo ocurren situaciones de emergencia, ya que nada monitorea la temperatura en la habitaci√≥n. </li><li>  Regulaci√≥n termost√°tica (manteniendo la temperatura, en mi caso, necesito predecir el deshielo y encender el calentamiento del agua de tormenta con un "cable calefactor" de antemano). </li><li>  El nodo del sistema de casa inteligente para implementar las funciones anteriores. </li><li>  <s>Y, por supuesto, la tetera Wifi!</s>  <s>El resto es por cantidad.</s> </li></ul><br>  <b>Y me gustar√≠a mostrar cu√°n simple y barato es implementar el paquete: [Dispositivo] &lt;-&gt; [Wifi] &lt;-&gt; [MQTT] &lt;-&gt; [Monitoreo centralizado del estado y administraci√≥n del dispositivo final].</b> <br><br><blockquote><h2>  Selecci√≥n de componentes. </h2></blockquote><br><img src="https://habrastorage.org/webt/59/ed/e8/59ede8b648464293203023.jpeg"><br><br><h4>  ¬øC√≥mo medir la corriente? </h4><br>  A diferencia de las mediciones de voltaje, los sensores de corriente no son tan comunes en la electr√≥nica de aficionados.  Pero hay varios tipos de sensores de corriente disponibles: derivaciones de corriente, tipo de transformador y sensores de efecto Hall.  Est√° claro que la clasificaci√≥n es amateur, pero si miras la tienda en l√≠nea, los nombres ser√°n algo as√≠. <br><br>  No quer√≠a usar la derivaci√≥n debido a la necesidad de crear un aislamiento galv√°nico (esto es para que 220 V no se precipite con todos sus amplificadores a nuestro microcontrolador y no salga todo el humo m√°gico en el que se sabe que funcionan).  Los sensores de transformador tambi√©n tienen sus propias caracter√≠sticas.  Pero el √∫ltimo tipo no solo era muy asequible, sino tambi√©n conveniente de usar.  Eso pens√© cuando lo orden√©. <br><br>  Si tiene un circuito de bajo voltaje, es m√°s razonable usar una resistencia de un valor peque√±o conocido en lugar de una derivaci√≥n.  Para m√°s detalles sobre c√≥mo y c√≥mo medir la corriente, lea el buen <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">art√≠culo</a> de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" class="user_link">radiolok</a> . <br><br>  Los sensores ACS712 se venden con mayor frecuencia ya soldados a una placa peque√±a con el cableado m√≠nimo requerido.  Puedo aconsejarle que proteja el chip con una pantalla de metal de la influencia de campos magn√©ticos extra√±os antes de usarlo.  El sensor para ellos es muy sensible y en forma de stock es m√°s adecuado para buscar cableado oculto que para medir la corriente.  Con una protecci√≥n improvisada, la inmunidad al ruido aumenta significativamente. <br><br><img src="https://habrastorage.org/webt/59/e7/92/59e7927d42459385719247.jpeg"><br><br>  Pegamos en el conector verde grande dos cables obtenidos cortando uno de los dos cables del circuito de 220V (conexi√≥n en serie al circuito).  Enviamos + 5V al conector en el otro lado del sensor, eliminamos la se√±al anal√≥gica del pin restante, que oscila en relaci√≥n con el medio (2.5V) dependiendo de la fuerza y ‚Äã‚Äãla direcci√≥n de la corriente.  Eso es tan simple ... en papel. <br><br><img src="https://habrastorage.org/webt/59/e7/95/59e795072a53a139870657.png"><br><br>  <s>Alrededor de este lugar, comienza el aplastamiento √≥seo.</s>  Estos sensores est√°n disponibles en versiones de 5.20.30 amperios.  Si los dos √∫ltimos son menos o menos claros, entonces la versi√≥n de 5 amperios result√≥ ser especial, esta caracter√≠stica fue que la se√±al (de acuerdo con la documentaci√≥n) cambia solo en + -1V desde el medio (2.5V).  A qui√©n le importan sus detalles <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">aqu√≠</a> .  Por referencia, el autor supone que estos son en realidad sensores de 10 amperios que no funcionaron.  Si a esto le sumamos el fuerte ruido del sensor en s√≠ y su tendencia a reaccionar a los campos magn√©ticos, la tarea de eliminar una se√±al m√°s o menos inteligible deja de ser aburrida.  Pero como los sensores ya estaban comprados, decid√≠ intentar hacer uno de ellos. <br><br><h4>  M√≥dulo principal del dispositivo </h4><br>  Este m√≥dulo es necesario para mantener la comunicaci√≥n preferiblemente a trav√©s de Wifi y torcer el ciclo de trabajo principal con sensores de sondeo, verificar condiciones, responder botones, etc.  ¬øQu√© elegir de una opci√≥n?  Y de repente, elegimos el ESP8266.  En mi caso es ESP-12F.  Oh si!  Tambi√©n hay un ESP-32. <br><br><img src="https://habrastorage.org/webt/59/e7/99/59e79966e0ed6050062855.jpeg"><br><br>  Lo mejor de todo es llevarlo inmediatamente soldado a una placa con un arn√©s y un adaptador USB a UART.  Pero tambi√©n puede conectarlo usted mismo, ya que comprar productos confeccionados no est√° de acuerdo con los preceptos de la construcci√≥n de bicicletas.  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Material sobre este tema</a> . <br><br>  Perd√≠ algo de tiempo tratando de flashear un ESP-shku auto conectado.  Us√≥ USBtoUART en el chip CH340.  La placa tercamente no quer√≠a parpadear hasta que cambi√© la l√≥gica CH340 a 5V con el riesgo de quemar las conclusiones de ESP.  Pero hasta ahora sin p√©rdida. <br><br><img src="https://habrastorage.org/webt/59/e7/9a/59e79ae603d33354441422.jpeg"><br><br>  Adem√°s, todo se <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">conecta al Arduino IDE</a> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" class="user_link">HWman</a> y no es muy diferente en la programaci√≥n del Arduino habitual.  Pero es muy diferente en capacidades y recursos inform√°ticos: <br><br><ul><li>  Procesador Tensilica de 80 MHz y 32 bits  Xtensa L106.  Es posible el overclocking no garantizado de hasta 160 MHz. </li><li>  IEEE 802.11 b / g / n Wi-Fi.  Soportado por WEP y WPA / WPA2. </li><li>  14 puertos de E / S (11 de los cuales se pueden usar), SPI, I¬≤C, I¬≤S, UART, ADC de 10 bits. </li><li>  Fuente de alimentaci√≥n 2.2 ... 3.6 V. Consumo de hasta 200 mA en modo de transmisi√≥n, 60 mA en modo de recepci√≥n, 40 mA en modo de espera.  Modo de bajo consumo mientras se mantiene la conexi√≥n con el punto de acceso ~ 1 mA, modo de reposo profundo 0.1 ŒºA. </li></ul><br><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="></a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><i>en.wikipedia.org/wiki/ESP8266</i></a> <br><br>  <b>¬øPor qu√© Arduino IDE?</b>  Soy consciente de que hay al menos dos formas m√°s de implementar lo mismo, es usar firmware con scripts en LUA y desarrollo nativo en C usando el SDK del fabricante.  El primer m√©todo me pareci√≥ muy superficial, creo que no podr√≠a haberme dado cuenta de algunos de los matices yendo por este camino.  El segundo m√©todo es el m√°s prometedor, pero lleva mucho tiempo dominarlo, pero esta es la √∫nica opci√≥n si se supone que debe implementar un dispositivo m√°s serio. <br><br>  Usando Arduino IDE, la parte m√°s importante fue la menos problem√°tica en t√©rminos de inclusi√≥n en el proyecto.  Sin embargo, la depuraci√≥n normal es muy deficiente.  Inicialmente, hab√≠a dudas de que todas las funciones previstas juntas (1-Wire, i2c, ADC, MQTT, EEPROM, wifi) coexistir√≠an en el ESP-12F en un boceto, pero lo hizo. <br><br><h4>  Stm8s103f3p6 </h4><br>  Parecer√≠a, ¬øpor qu√© hay otro microcontrolador?  Hoy mismo, un dispositivo de un solo n√∫cleo ya no se toma en serio, solo es broma.  La raz√≥n es diferente: el sensor de corriente es tan "especial" que es m√°s f√°cil y econ√≥mico colgar todo el procesamiento de sus lecturas en un microcontrolador separado y dejar que lo cuide.  De hecho, tenemos un sensor de corriente digital que se conecta a trav√©s del bus i2c.  Te√≥ricamente, puede usar el microcontrolador m√°s barato, pero como estas placas son muy asequibles y bastante decentes en t√©rminos de par√°metros, lo apliqu√©.  En el futuro, lo he vuelto a medir y los voy a usar, como reemplazo del PIC12, que sol√≠a agregar "cerebros" a manualidades completamente diferentes.  Al principio, esta idea me parec√≠a redundante, pero ahora veo que ni siquiera tuve que perder tiempo en otra opci√≥n. <br><br><img src="https://habrastorage.org/webt/59/e7/9f/59e79ff42e5a1052654373.jpeg"><br><br>  Estos microcontroladores est√°n programados en el entorno IAR Embedded Workbench, es gratis para c√≥digo de hasta 8kb, nuestro microcontrolador tiene tanta memoria.  Una gran ventaja es la posibilidad de depuraci√≥n humana.  Es cierto que debe dejar de usar las funciones habituales de C-standard como printf y trabajar con n√∫meros de punto flotante, ya que esto borrar√° r√°pidamente toda la memoria.  Te contar√© m√°s sobre el firmware a continuaci√≥n. <br><br><h4>  Pantalla </h4><br>  Casi no hay opciones aqu√≠: utilizamos OLED SSD1306, una hermosa pantalla con un brillo muy hermoso y una conexi√≥n simple.  Las bibliotecas para √©l est√°n incluso bajo el espectro.  Hay pantallas de diferentes colores.  Tambi√©n hay placas en las que se sueldan inmediatamente ESP y una pantalla similar.  El color azul parece el m√°s ventajoso.  Hay dos tonos cuando la parte superior es de un color diferente. <br><br>  La pantalla est√° conectada a trav√©s del bus i2c, estos son solo 4 cables teniendo en cuenta la fuente de alimentaci√≥n.  El sensor de corriente tambi√©n se conectar√° a trav√©s del mismo bus.  La pantalla no entreg√≥ ning√∫n problema en absoluto.  ¬°Definitivamente imprescindible! <br><br><img src="https://habrastorage.org/webt/59/ed/00/59ed00ca082ba631487484.png"><br><br>  Vale la pena considerar que es probable que la pantalla brille las 24 horas, los 7 d√≠as de la semana, y la tecnolog√≠a de la pantalla es tal que los p√≠xeles LED individuales se desvanecen con el tiempo, por lo que debe intentar usarlos de manera uniforme.  Se me ocurri√≥ solo cambiar la imagen en diferentes direcciones a intervalos regulares.  En general, creo que si de repente la imagen se vuelve completamente ilegible, reemplazar la pantalla no es un problema.  Veamos cu√°nto tiempo vive. <br><br>  Un video detallado sobre dicha pantalla y el canal de youtube. <br><br><iframe width="560" height="315" src="https://www.youtube.com/embed/-IFwwWj11Kw" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><br><h4>  Sensores de temperatura </h4><br>  Us√© el conocido DS18B20.  En el modo de potencia par√°sita, tres sensores funcionan silenciosamente en un par de cables trenzados a una distancia que excede lo que es razonable para dicho proyecto (suficiente con un margen para cualquier parte del apartamento). <br><br><img src="https://habrastorage.org/webt/59/ec/a8/59eca82c15777409271533.jpeg"><br><br>  La √∫nica diferencia con la figura es el uso de una resistencia de 1K, de lo contrario no hay suficiente potencia.  Cuando esto sucede, el sensor da una temperatura igual a 85 grados.  La solicitud de conversi√≥n y la posterior lectura del valor se produce secuencialmente para cada sensor para que no interfieran entre s√≠. <br><br>  Cont√© las direcciones de los sensores por adelantado y las codifiqu√© en un boceto.  Se intent√≥ hacer una autodetecci√≥n de sensores en el bus, pero no me gust√≥ la estabilidad de este algoritmo, y dado que la temperatura es un par√°metro importante, el juego no vale la pena. <br><br><h4>  Elementos estructurales y "encrespamiento" </h4><br>  Todo este hierro se coloc√≥ con una peque√±a caja de bufanda que se puede recoger en cualquier mercado de radio al gusto.  Por lo general, se us√≥ un rel√© de contacto para 220V.  Muchos kil√≥metros de cable del antiguo bucle FDD, medio kilo de resistencias por cada 10K, un par de botones, un par de salida debajo de los "tulipanes" para conectar la l√≠nea 1-Wire y ADC ESP-shki.  Mucho pegamento caliente.  Una unidad de fuente de alimentaci√≥n de alta calidad a 5 voltios, que se coloc√≥ por completo en el dispositivo.  Y, por desgracia, casi no hay cinta aislante azul. <br><br>  Si est√° armando un prototipo, intente no colocar nada en una de las cubiertas, entonces ser√° conveniente quitarlo y recogerlo en el dispositivo.  Piense d√≥nde entrar√°n los cables de conexi√≥n externos y qu√© conectores tienen para que no resulte que el enchufe debe estar atascado en √°ngulos salvajes, etc. <br><br><h4>  Costos de los componentes: </h4><br><ol><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Sensor de corriente</a> - $ 2.1 </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">ESP-12F</a> - 3.2 $ </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Tablero Stm8</a> - $ 0.75 </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Convertidor l√≥gico</a> - 0.5 $ </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Sensor de temperatura</a> - $ 0.6 </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Pantalla</a> - $ 4.2 </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Rel√©</a> - $ 0.75 </li><li>  Caja y otras musgo ~ xs, que sea $ 3 </li></ol><br>  <b>Total: $ 15</b> <br><br><blockquote><h2>  Armado con el archivo correcto ... </h2></blockquote><br><img src="https://habrastorage.org/webt/59/e8/9a/59e89a3739490406680171.jpeg"><br><br><h4>  Sensor de corriente </h4><br>  Como escrib√≠ anteriormente, el sensor de corriente estaba muy malhumorado.  Adem√°s, medir el valor efectivo de la corriente alterna es algo m√°s complicado que medir el valor de la corriente continua.  Creo que es mejor que se lo explique una persona que <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" class="user_link">conozca</a> bien <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" class="user_link">radiolok</a> : <br><br><div class="spoiler">  <b class="spoiler_title">Video</b> <div class="spoiler_text"><iframe width="560" height="315" src="https://www.youtube.com/embed/TOaW9xvr8NE" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br></div></div><br>  Y tambi√©n: <br><br><ul><li>  1. <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Art√≠culo</a> de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" class="user_link">grekeh</a> </li><li>  2. Mensaje del usuario <b>residente</b> en este <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">foro:</a> </li></ul>  <i>‚ÄúEn lugar de I (corriente) sustituto en la f√≥rmula U (voltaje).</i>  <i>La integral es el √°rea de la figura debajo del sobre.</i>  <i>La integral se puede calcular aproximadamente por el m√©todo de rect√°ngulos intermedios, aproximando la figura con rect√°ngulos con una altura igual a una muestra discreta del voltaje y un ancho igual al intervalo de tiempo entre muestras ".</i> <br><br><img src="https://habrastorage.org/webt/59/e8/64/59e864a11540f816221584.jpeg"><br><br>  Por lo tanto, resulta que necesitamos medir el √°rea "debajo del gr√°fico" de la corriente alterna durante un per√≠odo.  Como la frecuencia de nuestro voltaje es de <b>50 Hz,</b> obtenemos una duraci√≥n de per√≠odo de <b>20 ms</b> .  Cuando comenzar a medir no importa, lo principal es hacerlo por un tiempo m√∫ltiplo de 20 <b>ms</b> .  Casi todo se reduce a sumar el m√≥dulo de las lecturas de ADC durante un per√≠odo con el c√°lculo posterior del promedio.  Esta ser√° nuestra corriente.  Para el per√≠odo entre dos mediciones, se toma el tiempo de respuesta del ADC, es bastante estable. <br><br>  Como beneficio adicional, este m√©todo le permite medir tanto la corriente alterna como la continua.  Fuera de los corchetes, dejamos la probabilidad de caminar frecuencia y voltaje en la salida. <br><br>  Puede intentar realizar mediciones en el ESP8266 ADC y lo intent√©, pero la precisi√≥n result√≥ ser muy mediocre, as√≠ como el ESP, la mayor√≠a de las veces tuve que tratar exclusivamente con el procesamiento de se√±ales desde el ADC.  Adem√°s, el ADC incorporado tiene un rango de voltaje de aproximadamente 1 voltio.  Es necesario usar un divisor de voltaje.  El ESP funciona con 3.3V, y el sensor de corriente es de 5V, lo que significa que los datos del ADC pueden distorsionarse si la fuente de alimentaci√≥n no cambia su valor proporcionalmente.  Todo esto no agrega precisi√≥n a las mediciones.  El plan inicial fue el siguiente: si no puede usar el ESP de ADC correctamente, entonces usaremos un microcontrolador separado, y sucedi√≥. <br><br>  Usando Stm8s103f3p6 la situaci√≥n ha mejorado mucho.  En primer lugar, tanto el sensor como el microcontrolador funcionan con 5V, lo que evita que los resultados de la medici√≥n se "floten" durante las sobretensiones.  En segundo lugar, el microcontrolador puede dedicar todos sus recursos inform√°ticos al procesamiento, filtrado y refinamiento de se√±ales.  De hecho, por supuesto, no todo es sencillo, puedes colgar algo m√°s en √©l. <br><br>  Se determin√≥ experimentalmente que en 20 ms, stm8 logra obtener unos 600 valores del ADC sin comprometer la precisi√≥n.  Si es necesario, puede cronometrar el ADC m√°s r√°pido, pero el gr√°fico se vuelve m√°s obviamente falso.  Supervis√© las mediciones con el software de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">procesamiento</a> , este es un producto para visualizar algo, en mi caso fue un mont√≥n de valores tomados del ADC.  Se obtuvieron lecturas bastante estables despu√©s de la medici√≥n durante 100 ms, es decir, aproximadamente 3000 mediciones.  Luego lo multiplicamos por un coeficiente seleccionado emp√≠ricamente (no tengo idea de cu√°l es este n√∫mero y c√≥mo calcularlo porque se obtuvieron otros n√∫meros con todas las f√≥rmulas apropiadas, simplemente lo ajust√© y todo) A continuaci√≥n, el valor se ejecuta a trav√©s del <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">filtro</a> .  Todo lo que queda por hacer es poner el siguiente valor en el lugar donde ESP lo recoger√°. <br><br>  Como resultado, conseguimos tal estabilidad si enciende la bombilla de 100W. <br><br><iframe width="560" height="315" src="https://www.youtube.com/embed/DZJQnvXJUmo" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><br>  Durante la depuraci√≥n, result√≥ que el sensor puede colgarse cuando se dispara el rel√©, aparentemente desde fuertes campos magn√©ticos en el momento en que se abre el rel√©, con la formaci√≥n de un arco.  Tuve que agregar una cadena de "malabarismo" con el sensor para la nutrici√≥n.  Aunque al principio pens√© que se estaba congelando stm8 o alg√∫n bloque porque no hab√≠a nada que colgar en el sensor, pero pod√≠a. <br><br>  Debido al ruido del sensor, es pr√°cticamente imposible medir una corriente de hasta 100 mA.  En alg√∫n lugar de los foros vi una menci√≥n de que esto es normal.  Trat√© de organizar la detecci√≥n de ruido y la emisi√≥n, en este caso, de lecturas de corriente cero para que la corriente no salte incluso con un circuito abierto. <br><br>  <i>El algoritmo de este detector es que el ruido tiene una distribuci√≥n igual de valores por encima y por debajo de "cero", mientras que la se√±al real en una secci√≥n particular del per√≠odo todav√≠a tiene un valor promedio distinto de cero, a menos que, por supuesto, comencemos a medir en el momento de transici√≥n cero por una sinusoide.</i>  <i>Por lo tanto, escucho la se√±al en tres intervalos aleatorios del mismo per√≠odo, que se ubican uno con respecto al otro de tal manera que se garantiza que al menos uno no caiga en el momento en que la sinusoide cruza cero y da un valor total distinto de cero.</i>  <i>Quiz√°s haya una manera m√°s simple, pero la construcci√≥n de bicicletas, ya sabes, no tolera un largo estudio del problema.</i> <br><br>  Stm8 se congela, pero solo durante el intercambio en el bus i2c con ESP, posiblemente debido a mi poco conocimiento de programaci√≥n de este microcontrolador, pero tal vez porque puede.  Usar un perro de observaci√≥n ayud√≥ a resolver este problema. <br><br>  Es m√°s f√°cil obtener voltaje alterno seguro para la depuraci√≥n desmontando una fuente de alimentaci√≥n del transformador (naturalmente bajando, preferiblemente un voltio a 12) y desconectando el puente de diodos y el condensador de suavizado del transformador, generalmente no hay nada m√°s. <br><br>  Sucedi√≥ que no ten√≠a un dispositivo que pueda medir el valor efectivo de la corriente alterna.  En este caso, puede obtenerlo midiendo el voltaje efectivo en la resistencia de un valor conocido, y la corriente ya se puede calcular dividiendo el voltaje por el valor de la resistencia.  El valor efectivo de la tensi√≥n alterna puede mostrar cualquier mult√≠metro.  Y la segunda forma es medir la ca√≠da de voltaje a trav√©s de la misma resistencia, pero conect√°ndola despu√©s del puente de diodos y el condensador de suavizado.  Naturalmente, en este caso, el valor actual ser√° ligeramente menor porque el convertidor AC-DC tiene su propia eficiencia. <br><br>  Naturalmente, quiero decir que las operaciones anteriores se llevan a cabo con voltaje alterno reducido, y no con la red. <br><br><img src="https://habrastorage.org/webt/59/ef/30/59ef3019b0a63862486681.jpeg"><br><br>  Como parte de este art√≠culo, no analizar√© el proceso de programaci√≥n para stm8.  Pero no es dif√≠cil, hay bibliotecas est√°ndar para perif√©ricos y Google resuelve la mayor parte de los problemas.  Los que no quieran entrar en detalles est√°n invitados a <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">completar el</a> firmware ( <a href="">CurrentMeter (IAR) \ STM8S103 \ Exe \ Project.hex</a> ) en el microcontrolador y olvidarse de √©l.  Si quieres profundizar, entonces para comenzar el <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">art√≠culo</a> y el video: <br><br><div class="spoiler">  <b class="spoiler_title">Video</b> <div class="spoiler_text"><iframe width="560" height="315" src="https://www.youtube.com/embed/LvcW-vhc6rU" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br></div></div><br>  Hay intentos de adaptar Arduino a este microcontrolador, pero por el momento no he encontrado m√°s o menos listo para un uso real. <br><br>  Entonces tenemos un sensor de corriente con interfaz i2c.  Dado que el ESP tiene una l√≥gica de 3.3V y un stm8 de 5V, se necesita un convertidor de nivel l√≥gico, y de dos v√≠as, no hay forma de obtener un divisor de voltaje aqu√≠.<font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Todo tipo de trucos con la instalaci√≥n de resistencias en serie le permiten establecer una conexi√≥n de alguna manera, pero la estabilidad de tal soluci√≥n no es satisfactoria. </font><font style="vertical-align: inherit;">Es mucho m√°s f√°cil usar un convertidor bidireccional listo, que cuesta un centavo. </font></font><br><img src="https://habrastorage.org/webt/59/e8/8d/59e88d999bd82323948398.jpeg"><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Su trabajo se basa en el uso de transistores de efecto de campo, </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">aqu√≠</font></font></a> <font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> puede encontrar m√°s informaci√≥n sobre la conversi√≥n de nivel </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;">. </font></a></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">[ </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Firmware y fuente para stm8</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ]</font></font><br><br><h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Montaje y disposici√≥n del dispositivo. </font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">El prototipo del dispositivo, se decidi√≥ recoger la instalaci√≥n montada. Existe la posibilidad de que algunos puntos tengan que rehacerse durante la operaci√≥n, y todav√≠a no he dominado el dise√±o normal y simple de las placas de circuito impreso. Despu√©s de que el dispositivo haya funcionado durante varios meses sin modificaciones, probablemente tenga sentido desarrollar y solicitar placas de circuito impreso en China. Mientras tanto, tenemos un monstruo de pasta: un </font></font><br><br><img src="https://habrastorage.org/webt/59/eb/2f/59eb2f9f33582057597084.jpeg"><br> <i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">diagrama intuitivo e intuitivo de los elementos de conmutaci√≥n del dispositivo.</font></font></i> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> El principio general del ensamblaje del prototipo es simple: marcamos aproximadamente en una caja de pl√°stico que donde se ubicar√°, fijamos los elementos principales all√≠ y luego todo est√° conectado por un cable de ensamblaje. Vale la pena considerar la ubicaci√≥n de los elementos para no crear inconvenientes innecesarios.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Usando el escaneo irremplazable chino, se hacen los agujeros necesarios (y no solo), la ventana de la pantalla se ajusta con un archivo. </font></font><br><img src="https://habrastorage.org/webt/59/ec/af/59ecaf20055ba125249194.jpeg"><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Para alimentar la electr√≥nica, se utiliza una unidad de fuente de alimentaci√≥n de 5V de alta calidad que est√° conectada en paralelo a una red de 220V directamente dentro de la carcasa del dispositivo. </font></font><br><br> <b><u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Es muy importante comprender que 220 V ya es un voltaje peligroso, aseg√∫rese de aislar todas las conexiones y, si es posible, localizar dichas conexiones en una parte del dispositivo y la parte de bajo voltaje en otra. Durante las primeras conexiones de prueba, puede cambiar a trav√©s de una m√°quina normal, nadie es inmune a los errores.</font></font></u></b> <br><br><img src="https://habrastorage.org/webt/59/f0/c1/59f0c1e57785d168849742.jpeg"><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Sobre los errores y la probabilidad de que se cometan.</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nada inusual, solo un poco tomado por bombas termonucleares al tocar el suelo en caso de accidente accidental con el avi√≥n despu√©s de un reabastecimiento de combustible fallido sobre Espa√±a en el a√±o 66. </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Foto de este </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">art√≠culo</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> de </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" class="user_link"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MagisterLudi</font></font></a></i> <br><br> <s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> No te consideres el m√°s inteligente y cauteloso. Bueno, o al menos toca los cables con alto voltaje en el exterior de la palma de tu mano, pero es mejor no hacerlo.</font></font></s> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> La foto muestra que el sensor de corriente est√° pegado a la fuente de alimentaci√≥n, sorprendentemente no not√© ninguna interferencia, pero not√© que la interferencia penetra desde arriba, tuve que desmontar el sensor y protegerlo con papel de aluminio. Puede verificar la efectividad del blindaje con un im√°n de neodimio.</font></font><u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Es importante no olvidar que se aplica un voltaje de 220 V en un lado del chip del sensor, por lo que debe protegerlo con aislamiento </font></font></u> <s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">exclusivamente con una cinta </font></font></s><font style="vertical-align: inherit;"><u><font style="vertical-align: inherit;">aislante </font></u><s><font style="vertical-align: inherit;">azul</font></s><font style="vertical-align: inherit;"> . </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Si alguien no comprende el diagrama del circuito visual de los bloques de conmutaci√≥n dados anteriormente, hay un diagrama de circuito torcido. La primera experiencia con fritzing parece haber sido irregular. </font></font><br><br><img src="https://habrastorage.org/webt/59/eb/81/59eb81f2e4d58730142159.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Lo √∫nico que no se refleja en el diagrama es la conclusi√≥n de los contactos necesarios, para el firmware, de ESP y STM8 a un conector separado en el costado del dispositivo. Por lo tanto, puede terminar con el ensamblaje para comenzar a flashear el dispositivo terminado, y no un cruce entre nodos y cables dispersos en la mesa.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Antes de aplicar energ√≠a varias veces, haga sonar el circuito de alimentaci√≥n para un cortocircuito o la polaridad correcta. </font><font style="vertical-align: inherit;">Parece que son cosas simples, pero una peque√±a pila de chales muertos en el caj√≥n de mi escritorio elocuentemente requiere no descuidar estas simples reglas.</font></font><br><br><h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Comunicaci√≥n con el mundo exterior. </font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Comenzaremos a terminar lentamente el software. Para organizar la gesti√≥n y la interacci√≥n con nuestro punto de venta, utilizaremos el protocolo MQTT. </font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MQTT.</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Como funciona Todo est√° organizado de la siguiente manera: en la red local (o tal vez no en la local) hay un determinado host en el que </font><font style="vertical-align: inherit;">se </font><font style="vertical-align: inherit;">inicia un programa especial ( </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">agente MQTT</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ) que recibe diversos datos de varios dispositivos y organiza su almacenamiento de forma similar a un sistema de archivos y directorios en su disco. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Por ejemplo: </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">"SmartPowerSocket1 / Current"</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : as√≠ es como se ve el </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tema</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> MQTT real </font><font style="vertical-align: inherit;">. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La carpeta de este dispositivo es </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">"SmartPowerSocket1"</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , las subcarpetas son algunos par√°metros internos del dispositivo, por ejemplo, el valor actual es </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">"Actual"</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. La ruta completa al par√°metro (tema) se usa para que los dispositivos se suscriban a los cambios en estos par√°metros. All√≠ los par√°metros son grabados por el propio dispositivo. Puede suscribirse a toda la "carpeta" (tema) y recibir todos los cambios de par√°metros para un dispositivo espec√≠fico (tema o subtema): </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SmartPowerSocket1 / #</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br><br><img src="https://habrastorage.org/webt/59/ee/14/59ee1487b1d35208233896.jpeg"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Un video m√°s detallado sobre este tema.</font></font><br><br><div class="spoiler">  <b class="spoiler_title">Video</b> <div class="spoiler_text"><iframe width="560" height="315" src="https://www.youtube.com/embed/4O-2dJwRQtg" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br></div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Y nuevamente recomiendo este canal, all√≠ encontrar√°s mucha informaci√≥n √∫til. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">El corredor de MQTT m√°s famoso es </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mosquitto</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Y dado que decid√≠ implementar inmediatamente el sistema de administraci√≥n inteligente del hogar </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MajorDoMo</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , que ya figuraba en el video anterior, todo esto se gener√≥ en masa al implementar la imagen final para </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">la PC Orange Pi</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Todo ya est√° instalado all√≠. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">El uso del protocolo MQTT permitir√° utilizar diferentes sistemas de control inteligente para el hogar y no solo este protocolo est√° ganando popularidad. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Solo puede sobrevivir con el agente MQTT instal√°ndolo en su PC, y hay muchos </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;">clientes MQTT</font></a><font style="vertical-align: inherit;"> interactuando con √©l, por ejemplo, desde el tel√©fono, para Android</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Y no solo para Android. Est√°n configurados de manera bastante simple. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Con MajorDoMo, puede organizar una hermosa visualizaci√≥n de informaci√≥n, dibujar gr√°ficos y administrar a trav√©s de cualquier navegador. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Puede intentar adivinar qu√© tipo de dispositivo como experimental se muestra en los gr√°ficos a continuaci√≥n. </font></font><br><br><img src="https://habrastorage.org/webt/59/ee/fc/59eefc5862611092456787.png"><br><img src="https://habrastorage.org/webt/59/ee/fc/59eefc8497210678422831.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Este es un refrigerador, un sensor de temperatura en el congelador. Estoy un poco sorprendido de que si configura la perilla de control en el refrigerador a "2", se obtienen las lecturas de las capturas de pantalla anteriores. Si se establece en "3", el refrigerador ha estado martillando durante 40 minutos en lugar de 7 y mantiene la temperatura entre -16 / -18 grados. Ajuste no muy suave en cuanto a m√≠. La informaci√≥n no tiene un valor excesivo; fue interesante verla.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Tambi√©n es interesante que se muestren los momentos de la alta corriente inicial y que se vea la discreci√≥n del sensor de temperatura (paso), ya que el filtro promedio se usa para la corriente, no esperaba ver tales sobretensiones en el gr√°fico. </font></font><br><br><h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Boceto para ESP-12F </font></font></h4><br>  Para forzar a ESP a intercambiar datos a trav√©s de MQTT, solo necesita usar la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">biblioteca</a> apropiada en Arduino.  Vale la pena se√±alar que tambi√©n hay bibliotecas similares. <br><br><div class="spoiler">  <b class="spoiler_title">Un ejemplo de trabajo con esta biblioteca en ESP8266</b> <div class="spoiler_text"><pre><code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;ESP8266WiFi.h&gt; #include &lt;PubSubClient.h&gt; // Update these with values suitable for your network. const char* ssid = "........"; const char* password = "........"; const char* mqtt_server = "broker.mqtt-dashboard.com"; WiFiClient espClient; PubSubClient client(espClient); long lastMsg = 0; char msg[50]; int value = 0; void setup_wifi() { delay(10); // We start by connecting to a WiFi network Serial.println(); Serial.print("Connecting to "); Serial.println(ssid); WiFi.begin(ssid, password); while (WiFi.status() != WL_CONNECTED) { delay(500); Serial.print("."); } randomSeed(micros()); Serial.println(""); Serial.println("WiFi connected"); Serial.println("IP address: "); Serial.println(WiFi.localIP()); } void callback(char* topic, byte* payload, unsigned int length) { Serial.print("Message arrived ["); Serial.print(topic); Serial.print("] "); for (int i = 0; i &lt; length; i++) { Serial.print((char)payload[i]); } Serial.println(); // Switch on the LED if an 1 was received as first character if ((char)payload[0] == '1') { digitalWrite(BUILTIN_LED, LOW); // Turn the LED on (Note that LOW is the voltage level // but actually the LED is on; this is because // it is acive low on the ESP-01) } else { digitalWrite(BUILTIN_LED, HIGH); // Turn the LED off by making the voltage HIGH } } void reconnect() { // Loop until we're reconnected while (!client.connected()) { Serial.print("Attempting MQTT connection..."); // Create a random client ID String clientId = "ESP8266Client-"; clientId += String(random(0xffff), HEX); // Attempt to connect if (client.connect(clientId.c_str())) { Serial.println("connected"); // Once connected, publish an announcement... client.publish("outTopic", "hello world"); // ... and resubscribe client.subscribe("inTopic"); } else { Serial.print("failed, rc="); Serial.print(client.state()); Serial.println(" try again in 5 seconds"); // Wait 5 seconds before retrying delay(5000); } } } void setup() { pinMode(BUILTIN_LED, OUTPUT); // Initialize the BUILTIN_LED pin as an output Serial.begin(115200); setup_wifi(); client.setServer(mqtt_server, 1883); client.setCallback(callback); } void loop() { if (!client.connected()) { reconnect(); } client.loop(); long now = millis(); if (now - lastMsg &gt; 2000) { lastMsg = now; ++value; snprintf (msg, 75, "hello world #%ld", value); Serial.print("Publish message: "); Serial.println(msg); client.publish("outTopic", msg); } }</span></span></span></span></code> </pre> <br></div></div><br>  En resumen, cuando necesita transferir datos, son transmitidos por la funci√≥n de publicaci√≥n ("SmartPowerSocket1 / Current", "2").  Transmitimos el valor actual igual a 2 loros. <br><br>  Para recibir datos de un intermediario, solo tiene que suscribirse al tema que nos interesa y verificar la funci√≥n de la que provienen los datos clasific√°ndolos en las variables correspondientes.  Eso es todo <br><br>  El bosquejo final result√≥ ser bastante voluminoso, pero utiliza enfoques absolutamente est√°ndar para organizar el intercambio en i2c, 1-wire y trabajar con otras entidades.  Creo que la persona que ya ha tratado con Arduino no tendr√° muchas dificultades para descubrir y modificar la l√≥gica de control para que se ajuste a sus necesidades, si es que lo hace. <br><br>  <b>EEPROM</b> .  El boceto organiz√≥ el almacenamiento de par√°metros en la EEPROM, y adem√°s de esto, cuando el servidor MQTT est√° disponible, se retiran de all√≠ cuando se inicia el dispositivo. <br><br>  <b>ArduinoOTA</b> .  Incluso en el boceto, se <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">omite</a> algo como <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">ArduinoOTA</a> (OTA - "por aire", que se puede traducir como "por aire"), es decir, el firmware se puede descargar a trav√©s de Wifi. <br><br>  El enlace de arriba tiene una receta sobre c√≥mo usarlo.  Agregar√© que cargar de esta manera es varias veces m√°s r√°pido, pero esto requiere un procesamiento especial para integrarse en el boceto.  El bucle principal no debe sobrecargarse, de lo contrario no habr√° conexi√≥n entre el ESP y el ArduinoIDE.  Es por eso que hay tantos tiempos de espera diferentes en el boceto y se mide el tiempo de una ejecuci√≥n del ciclo principal.  La mayor√≠a de las veces, ESP comprueba "¬øpero quieren mostrarme?"  cuanto m√°s estable funciona todo.  Otra caracter√≠stica que a√∫n no he superado, ArduinoOTA se niega a flashear en algunas redes wifi, aunque todo responde.  Es m√°s probable que tenga √©xito si ArduinoIDE y ESP est√°n conectados por un punto de acceso dedicado (solo IoT). <br><br>  <b>Botones</b>  Al principio quer√≠a hacer m√°s de dos botones, pero result√≥ que el GPIO en el ESP-12F estaba llegando a su fin.  A juzgar por el hecho de que nadie presionar√≠a estos botones de todos modos (si hay control a trav√©s del webmord del hogar inteligente), se decidi√≥ limitarlo a dos.  Los at√≥ para regular la configuraci√≥n actual, y si presiona ambos a la vez, el rel√© se apaga.  Despu√©s de eso, puede encenderlo solo si reinicia el dispositivo a trav√©s de la alimentaci√≥n o mediante un webmord.  Por lo tanto, trat√© de agregar un poco de protecci√≥n contra cambios bruscos si la corriente superaba el l√≠mite permitido, ya que esto podr√≠a significar una emergencia. <br><br>  [ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Publicar√© el boceto a medida que actualice.</a>  ] <br><br><blockquote><h2>  "¬°Lo hice!" </h2></blockquote><br><img src="https://habrastorage.org/webt/59/e8/a7/59e8a7e09eee8669285885.jpeg"><br><br>  La misteriosa caja negra comenz√≥ a hacer clic en el rel√© y emiti√≥, no menos misteriosos, silenciosos chirridos de alta frecuencia de diferentes tonos en diferentes modos de funcionamiento: una caracter√≠stica / error que apareci√≥ como resultado de la fuente de alimentaci√≥n, aparentemente hay un choque de m√∫sica suelto. <br><br>  <i>Es curioso que fue √©l quien indirectamente me ayud√≥ a atrapar los momentos de la ca√≠da de los nodos individuales.</i>  <i>Puedes verlo con tus ojos, pero es agotador, escuchar en el fondo es muy f√°cil captar el momento en que cambia el ritmo del sonido.</i>  <i>Por lo tanto, no comenc√© a calmar este acelerador e incluso pens√© en agregar esa funci√≥n a otros dispositivos de depuraci√≥n.</i> <br><br>  Durante alg√∫n tiempo pens√© en c√≥mo demostrar el dispositivo si es una caja negra aburrida y ni siquiera se mueve.  Tratemos de hacer t√© usando una caldera y uno de los sensores de temperatura, para calcular la cantidad de energ√≠a que tomar√°. <br><br><iframe width="560" height="315" src="https://www.youtube.com/embed/dmL-wbCozQI" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><br>  Despu√©s de presionar el bot√≥n que desbloquea el rel√© varias veces, no pas√≥ nada, luego result√≥ que la configuraci√≥n actual era muy baja y funcion√≥ las primeras veces. <br>  Cuando la caldera se calent√≥ un poco, la corriente cay√≥ un poco y el rel√© se desbloque√≥. <br><br>  Cuando me puse c√≥modo, me prepar√© para esperar mucho tiempo para que el agua hirviera, pero la caldera china de shaitan hirvi√≥ el agua tan r√°pido que apenas logr√© apagarla en modo de control manual.  Y result√≥ que el sensor de temperatura no era tan √°gil, y aunque configur√© el ajuste a 95 grados, me temo que cuando se active, todo estar√° en agua hirviendo, me temo que no quiero tanto t√©. <br><br>  Al principio, estaba confundido por la inscripci√≥n en la caldera de 500W, pero la corriente muestra que esto es cierto.  Al final, ya ten√≠a miedo de que la parte pl√°stica de la caldera se derritiera y se pudriera. <br>  "Experimento", pero no pas√≥ nada. <br><br>  <i>Por supuesto, ser√≠a posible grabar un video de acuerdo con el gui√≥n, pero me parece que el resultado real es m√°s valioso en los experimentos, por lo que mostr√≥ lo que sucedi√≥ la primera vez sin ensayos.</i>  <i>En general, aqu√≠ hay un bautizo c√≥mico de fuego inteligente.</i> <br><br><img src="https://habrastorage.org/webt/59/ef/a6/59efa6771e2ec068346209.jpeg"><br><br>  Es muy f√°cil calcular la energ√≠a gastada en base al hecho de que el agua hierve despu√©s de 2.5 minutos.  y todo este tiempo la corriente fue de aproximadamente 2.5A: <b>(2.5A * 220V) / 60min.</b>  <b>* 2.5min.</b>  <b>= 0.023 kWh.</b> <br><br>  Si su objetivo es mantener un medidor de electricidad, es bueno agregar otro sensor de voltaje que se pueda hacer con un transformador reductor, de esta manera puede obtener aislamiento galv√°nico y el voltaje no es peligroso para medir con un microcontrolador ADC.  Y debe agregarlo porque el voltaje en nuestros enchufes casi nunca es de 220V, pero ¬± 10V lo hace en el mejor de los casos. <br><br>  Y otra opci√≥n si no necesita lecturas de corriente y voltaje por su cuenta, y solo necesita tener en cuenta el consumo de electricidad: estos son <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">medidores el√©ctricos</a> chinos de un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">solo din</a> , generalmente tienen una salida de baja tensi√≥n pulsada y son muy compactos.  En este caso, su uso est√° justificado. <br><br><img src="https://habrastorage.org/webt/59/f0/75/59f075f5a1331511963267.jpeg"><br><br>  <i>PD: Si realmente planea armar un hervidor Wifi real, le recomiendo calcular el grosor de los cables y la potencia del rel√©, ya que el hervidor el√©ctrico promedio es muy voraz.</i> <br><br>  <b>UPD No. 1:</b> En los comentarios, se propusieron varios dispositivos m√°s, incluidos los terminados: <br><br>  1. M√≥dulo preparado para medir par√°metros el√©ctricos <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">PZEM-004T</a> . <br><img src="https://habrastorage.org/webt/6j/6v/dz/6j6vdze5jkwofqjw5crmaawlyty.jpeg"><br><br>  2. M√≥dulos completos <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Sonoff Pow</a> . <br><br>  3. Tambi√©n m√≥dulo terminado en <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">electrodragon</a> esp8266. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/es407541/">https://habr.com/ru/post/es407541/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../es407531/index.html">La historia de la llegada a Francia (y 150 a√±os del avi√≥n dom√©stico)</a></li>
<li><a href="../es407533/index.html">Radio juega: muy bien olvidado viejo</a></li>
<li><a href="../es407535/index.html">Los evaluadores se quejaron de que las computadoras port√°tiles ARM con Windows 10 no ten√≠an un indicador de bater√≠a, pero esto result√≥ no ser un error</a></li>
<li><a href="../es407537/index.html">Anatom√≠a de un p√°nico moralista.</a></li>
<li><a href="../es407539/index.html">122 d√≠as bajo rayos UV: pruebas comparativas de productos impresos en 3D de ABS y ASA</a></li>
<li><a href="../es407543/index.html">Control de bomba de pozo semiautom√°tico</a></li>
<li><a href="../es407545/index.html">¬øPor qu√© se encuentran los mayores mineros de Bitcoin en China?</a></li>
<li><a href="../es407547/index.html">Wilson Center: un arma biol√≥gica de OGM es peligrosa como arma nuclear, pero es mucho m√°s f√°cil de fabricar</a></li>
<li><a href="../es407551/index.html">Preg√∫ntele a Ethan: ¬øC√≥mo viajar sin problemas en el espacio?</a></li>
<li><a href="../es407553/index.html">10 sitios de TI de noticias interesantes que vale la pena marcar</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>