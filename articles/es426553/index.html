<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>💅 🌸 🤦🏽 Anuncios de banner en la aplicación iOS 🚾 👵🏿 👞</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hoy estamos abriendo una serie de artículos sobre lo que generalmente no se habla en conferencias y reuniones técnicas. Esta y las publicaciones poste...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Anuncios de banner en la aplicación iOS</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/funcorp/blog/426553/"><img src="https://habrastorage.org/webt/ce/j2/t9/cej2t9yugiyn0bnzyhfnwtckqmq.jpeg"><br><br>  Hoy estamos abriendo una serie de artículos sobre lo que generalmente no se habla en conferencias y reuniones técnicas.  Esta y las publicaciones posteriores le dirán cómo funciona el mecanismo de monetización en la aplicación de entretenimiento iFunny iOS popular en los Estados Unidos, que estamos desarrollando. <br><a name="habracut"></a><br>  La publicidad es una de las principales formas de monetizar aplicaciones gratuitas.  Pero ahora, ¿qué opciones había en 2011 cuando apareció iFunny?  El servicio se creó originalmente como un negocio fuerte y sostenible, por lo que desde el primer día la compañía decidió no coquetear con los usuarios y no participar en juegos con capitalización condicional. <br><br>  En ese momento, la opción principal para la monetización era crear una versión gratuita y simplificada del servicio, y luego tratar de vender la funcionalidad principal.  El consumidor era joven, inexperto y no estaba listo para desprenderse de cantidades superiores a un dólar. <br><br>  Las matemáticas simples mostraron que con una conversión del 10%, obtener un ARPU de más de 10 centavos es una tarea casi imposible. <br><br>  Luego tuve que pensar en cómo más puedes monetizar el producto.  El modelo publicitario ya ha funcionado muy bien en la web, y se podría suponer que pronto también florecerá en los teléfonos. <br>  En general, el comienzo del modelo de monetización de publicidad móvil puede considerarse la aparición de AdWhirl, un servicio que le permitió integrar el SDK de las redes publicitarias y rotarlas.  Su apariencia nos permitió elevar FillRate a un promedio del 50% en el mercado y hacer que los ingresos del modelo publicitario sean al menos comparables a las ventas de un dólar.  El principio mismo de la implementación de todas las posibles fuentes de demanda y la organización de la competencia entre ellas se ha convertido en el principal impulsor del crecimiento en la industria publicitaria y continúa siendo explotado hasta nuestros días. <br><br>  Pero cuanto más complejo es el sistema, menos estable se vuelve, lo que es absolutamente inaceptable para grandes servicios del nivel iFunny.  Comenzando a moverse en esta dirección en 2011, la compañía creó uno de los mecanismos más efectivos para trabajar con pancartas móviles y publicidad nativa y aumentó sus ingresos por usuario en 40 veces, lo que permitió desarrollar no solo proyectos internos, sino también invertir en otras compañías. <br><br><h2>  MoPub y compañía </h2><br>  Desde 2012, nos hemos mudado de AdWhirl a MoPub. <br><br>  MoPub es una plataforma de publicidad móvil con la capacidad de agregar sus propios módulos, que incluye varias herramientas excelentes: <br><br><ul><li>  Mercado de MoPub: intercambio publicitario propio; </li><li>  mediador de redes publicitarias para trabajar con redes externas; </li><li>  Un mecanismo de pedido que le permite colocar pancartas de forma independiente en su propia aplicación y personalizar sus pantallas. </li></ul><br>  Las principales ventajas de MoPub: <br><br><ul><li>  capaz de trabajar con la mayoría de las redes publicitarias; </li><li>  mecanismo claro para conectar nuevas redes de terceros; </li><li>  código abierto </li><li>  una gran cantidad de configuraciones y objetivos básicos; </li><li>  Una gran comunidad alrededor de la red, incluso hay una conferencia propia. </li></ul><br>  MoPub también tiene desventajas: <br><br><ul><li> No se aceptan solicitudes de grupo en GitHub y no hay ninguna reacción a ellas; </li><li>  El panel de control es muy complejo, y para el desarrollador, mientras se depura, lleva algún tiempo profundizar en su estructura. </li></ul><br><h2>  El poder de la verdad </h2><br>  Como dijo el héroe de una película rusa: "La fuerza es la verdad".  En esta parte, hablaré sobre las dificultades que nosotros, como desarrolladores de aplicaciones, tuvimos que enfrentar después del primer millón de descargas de iFunny, el crecimiento de la audiencia y el tráfico publicitario de más de 100 socios. <br><br><h3>  Contenido </h3><br>  El mercado publicitario es una "casta" muy cerrada de empresas tecnológicas, pero al mismo tiempo, los agregadores tienen una gran red de socios: desde grandes empresas que trabajan con millones de presupuestos hasta pequeñas empresas adaptadas a públicos específicos. <br><br>  Esta cercanía y fragmentación de los socios, a pesar de la moderación previa del banner y las reglas bastante estrictas sobre el contenido publicitario, no permite que los vendedores de publicidad más honestos publiquen creatividades que estén prohibidas o estropeen la experiencia del usuario en la aplicación. <br><br>  Existen varias categorías principales de contenido "obsceno" en los banners publicitarios: <br><br><ul><li>  contenido porno.  Recientemente, parece cada vez menos, pero sin embargo tiene lugar para ser.  No podemos publicar este contenido en el artículo, por lo que la imagen no estará aquí </li><li>  alertas del sistema en pancartas, se puede ver un ejemplo en uno de los usuarios <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">twitter.com/IfunnyStates/status/1029393804749668352</a> </li><li>  contenido con sonido.  Las redes publicitarias y las animaciones no prohíben los sonidos, pero si el sonido se reproduce sin interactuar con la interfaz, los usuarios lo perciben como un error de la aplicación y afecta negativamente la experiencia del usuario. </li><li>  Llama la atención.  Un buen banner debería atraer la atención del usuario, pero esto no siempre sucede de manera honesta: a veces los videos parpadeantes caen en los banners.  Otra forma deshonesta de hacer que el usuario toque el banner es simular la interfaz de la aplicación, por ejemplo, así: <br><br><img src="https://habrastorage.org/webt/p5/3u/lk/p53ulkue4iz7ofr14t3i7xyrqpq.png"></li></ul><br>  Por cierto, en Rusia, un toque ordinario en este banner puede emitir una suscripción paga para algunos operadores móviles, y ni siquiera lo sabrá hasta que vea los detalles.  Esta es también una forma deshonesta de trabajar con publicidad, pero los operadores en los Estados Unidos no tienen esta oportunidad. <br><br><h3>  Clics automáticos </h3><br>  Como muestra mi experiencia, este es un caso extremadamente negativo para los usuarios.  Usando las capacidades de JavaScript, WKWebView o UIWebView, así como los agujeros dentro de la implementación de las bibliotecas publicitarias, puede crear anuncios que abrirán el contenido del banner y sacarán al usuario de la aplicación. <br><br>  Para repetir este problema usando el ejemplo de MoPub, simplemente agregue el código javascript del siguiente contenido al banner: <br><br><pre><code class="hljs xml"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">href</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"https://ifunny.co"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"testbutton"</span></span></span><span class="hljs-tag">&gt;</span></span>test<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span><span class="javascript"><span class="hljs-built_in"><span class="javascript"><span class="hljs-built_in">document</span></span></span><span class="javascript">.getElementById(</span><span class="hljs-string"><span class="javascript"><span class="hljs-string">'testbutton'</span></span></span><span class="javascript">).click(); </span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br>  Esto funcionó durante mucho tiempo en muchas versiones de MoPub, hasta la versión 4.13. <br><br>  Al explorar la implementación de MoPub, fue posible generar enlaces más complejos que permitirían no solo abrir anuncios en pantalla completa, sino también enviar al usuario a la AppStore a una aplicación específica y ni siquiera tener en cuenta la visualización del banner. <br><br>  Por cierto, en las notas de la versión 4.13.0 del SDK de MoPub para iOS no hay información sobre esta solución, ya que era un agujero bastante serio en el SDK, y los socios deshonestos de MoPub lo explotaron de manera bastante activa.  Como muestran los registros, que analizaré más adelante, todos los días tenía que bloquear hasta 2 millones de intentos para abrir el banner sin la interacción del usuario con él. <br><br>  En el caso de MoPub, resultó ser fácil de encontrar y repetir el problema, pero otras redes con las que trabaja iFunny tienen un código cerrado, y tienes que lidiar con los clics automáticos emergentes bloqueando pancartas o incluso desconectando las redes por un tiempo. <br>  iFunny trabaja en estrecha colaboración con todos los socios publicitarios y les informa de dichos banners.  Dado que el público joven de iFunny es interesante para los anunciantes, los socios están dispuestos a conocerlos y eliminar dicha publicidad de la rotación. <br><br><h3>  Choque </h3><br>  Chocar siempre es malo.  Peor aún, cuando suceden debido a una dependencia con fuente cerrada, y puede influir en ellos solo indirectamente.  A lo largo de los años de trabajo con publicidad en iFunnu, se han identificado varios tipos de accidentes, que se pueden dividir en varios grupos. <br><br><ul><li>  Sistema </li></ul><br>  Estos incluyen excepciones en la biblioteca de red, WKWebView (UIWebView), OpenGL. <br>  Es muy difícil afectar directamente este tipo de bloqueos, pero aún fue posible afectar algunos de ellos, ya que había estudiado previamente el funcionamiento del componente WebView con WebGL. <br><br>  Así es como se ve el stackrace de tales accidentes: <br><br> <code>1 libGPUSupportMercury.dylib gpus_ReturnNotPermittedKillClient + 12 <br> 2 AGXGLDriver gldUpdateDispatch + 7132 <br> 3 libGPUSupportMercury.dylib gpusSubmitDataBuffers + 172 <br> 4 AGXGLDriver gldUpdateDispatch + 12700 <br> 5 WebCore WebCore::GraphicsContext3D::reshape(int, int) + 524 <br> 6 WebCore WebCore::WebGLRenderingContextBase::initializeNewContext() + 712 <br> 7 WebCore WebCore::WebGLRenderingContextBase::WebGLRenderingContextBase(WebCore::HTMLCanvasElement*, WTF::RefPtr&lt;WebCore::GraphicsContext3D&gt;&amp;&amp;, WebCore::GraphicsContext3D::Attributes) + 512 <br> 8 WebCore WebCore::WebGLRenderingContext::WebGLRenderingContext(WebCore::HTMLCanvasElement*, WTF::PassRefPtr&lt;WebCore::GraphicsContext3D&gt;, WebCore::GraphicsContext3D::Attributes) + 36 <br> 9 WebCore WebCore::WebGLRenderingContextBase::create(WebCore::HTMLCanvasElement*, WebCore::WebGLContextAttributes*, WTF::String const&amp;) + 1272 <br> 10 WebCore WebCore::HTMLCanvasElement::getContext(WTF::String const&amp;, WebCore::CanvasContextAttributes*) + 520 <br> 11 WebCore WebCore::JSHTMLCanvasElement::getContext(JSC::ExecState&amp;) + 212 <br> 12 JavaScriptCore llint_entry + 27340 <br> 13 JavaScriptCore llint_entry + 24756 <br> 14 JavaScriptCore llint_entry + 24756 <br> 15 JavaScriptCore llint_entry + 24756 <br> 16 JavaScriptCore llint_entry + 25676 <br> 17 JavaScriptCore llint_entry + 24756 <br> 18 JavaScriptCore llint_entry + 24656 <br> 19 JavaScriptCore vmEntryToJavaScript + 260 <br> 20 JavaScriptCore JSC::JITCode::execute(JSC::VM*, JSC::ProtoCallFrame*) + 164 <br> 21 JavaScriptCore JSC::Interpreter::executeCall(JSC::ExecState*, JSC::JSObject*, JSC::CallType, JSC::CallData const&amp;, JSC::JSValue, JSC::ArgList const&amp;) + 348 <br> 22 JavaScriptCore JSC::profiledCall(JSC::ExecState*, JSC::ProfilingReason, JSC::JSValue, JSC::CallType, JSC::CallData const&amp;, JSC::JSValue, JSC::ArgList const&amp;, WTF::NakedPtr&lt;JSC::Exception&gt;&amp;) + 160 <br> 23 WebCore WebCore::JSEventListener::handleEvent(WebCore::ScriptExecutionContext*, WebCore::Event*) + 980 <br> 24 WebCore WebCore::EventTarget::fireEventListeners(WebCore::Event&amp;, WebCore::EventTargetData*, WTF::Vector&lt;WebCore::RegisteredEventListener, 1ul, WTF::CrashOnOverflow, 16ul&gt;&amp;) + 616 <br> 25 WebCore WebCore::EventTarget::fireEventListeners(WebCore::Event&amp;) + 324 <br> 26 WebCore WebCore::EventContext::handleLocalEvents(WebCore::Event&amp;) const + 108 <br> 27 WebCore WebCore::EventDispatcher::dispatchEvent(WebCore::Node*, WebCore::Event&amp;) + 876 <br> 28 WebCore non-virtual thunk to WebCore::HTMLScriptElement::dispatchLoadEvent() + 80 <br> 29 WebCore WebCore::ScriptElement::execute(WebCore::CachedScript*) + 360 <br> 30 WebCore WebCore::ScriptRunner::timerFired() + 456 <br> 31 WebCore WebCore::ThreadTimers::sharedTimerFiredInternal() + 144 <br> 32 WebCore WebCore::timerFired(__CFRunLoopTimer*, void*) + 24 <br> 33 CoreFoundation __CFRUNLOOP_IS_CALLING_OUT_TO_A_TIMER_CALLBACK_FUNCTION__ + 24 <br> 34 CoreFoundation __CFRunLoopDoTimer + 868 <br> 35 CoreFoundation __CFRunLoopDoTimers + 240 <br> 36 CoreFoundation __CFRunLoopRun + 1568 <br> 37 CoreFoundation CFRunLoopRunSpecific + 440 <br> 38 WebCore RunWebThread(void*) + 452 <br> 39 libsystem_pthread.dylib _pthread_body + 236 <br> 40 libsystem_pthread.dylib _pthread_start + 280 <br> 41 libsystem_pthread.dylib thread_start + 0</code> <br> <br>  Además, se producen exclusivamente cuando se dejan en segundo plano.  Esto se debe al hecho de que el motor OpenGL no debería funcionar cuando la aplicación está en segundo plano. <br><br>  La solución aquí resultó ser bastante simple: <br><br>  Al salir en segundo plano, debe tomar una captura de pantalla del banner. <br><br>  Elimine la Vista publicitaria de la pantalla para que el componente WebView deje de usar OpenGL. <br>  Cuando salga del fondo, devuelva todo como estaba. <br><br>  En el código Objective-C, se ve así: <br><br><pre> <code class="objectivec hljs">- (<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>)onWillResignActive { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.adView.superview) { <span class="hljs-built_in"><span class="hljs-built_in">UIGraphicsBeginImageContext</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.adView.bounds.size); [<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.adView.layer renderInContext:<span class="hljs-built_in"><span class="hljs-built_in">UIGraphicsGetCurrentContext</span></span>()]; <span class="hljs-built_in"><span class="hljs-built_in">UIImage</span></span> *adViewScreenShot = <span class="hljs-built_in"><span class="hljs-built_in">UIGraphicsGetImageFromCurrentImageContext</span></span>(); <span class="hljs-built_in"><span class="hljs-built_in">UIGraphicsEndImageContext</span></span>(); adViewThumbView = [[<span class="hljs-built_in"><span class="hljs-built_in">UIImageView</span></span> alloc] initWithImage:adViewScreenShot]; adViewThumbView.backgroundColor = [<span class="hljs-built_in"><span class="hljs-built_in">UIColor</span></span> clearColor]; adViewThumbView.frame = <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.adView.frame; <span class="hljs-built_in"><span class="hljs-built_in">NSInteger</span></span> adIndex = [<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.adView.superview.subviews indexOfObject:<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.adView]; [<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.adView.superview insertSubview:adViewThumbView atIndex:adIndex]; [<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.adView removeFromSuperview]; } } - (<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>)onDidBecomeActive { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.adView &amp;&amp; adViewThumbView) { <span class="hljs-built_in"><span class="hljs-built_in">NSInteger</span></span> adIndex = [adViewThumbView.superview.subviews indexOfObject:adViewThumbView]; [adViewThumbView.superview insertSubview:<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.adView atIndex:adIndex]; [adViewThumbView removeFromSuperview]; adViewThumbView = <span class="hljs-literal"><span class="hljs-literal">nil</span></span>; } }</code> </pre><br><ul><li>  Integración </li></ul><br>  Estos son problemas que ocurren en la unión de iFunny, Mopub y el proveedor de publicidad. <br>  Como regla, surgen después de actualizar la biblioteca del proveedor y debido a nuevas formas de interactuar con ellos. <br><br>  El último caso fue en junio de este año, después de la próxima actualización de una de las bibliotecas utilizadas.  Una nueva forma de inicializar la biblioteca sugiere usar singleton para configurar la red. <br><br>  Volviéndolo dos veces, como sucedió en la implementación, periódicamente causaba un friso del hilo principal, por lo que tuve que ajustar la inicialización en dispatch_once. <br><br>  El departamento de control de calidad de iFunny puede probar bien las bibliotecas publicitarias, por lo que este problema se encontró durante la prueba de la actualización. <br><br><ul><li>  Inesperado </li></ul><br>  Este tipo de bloqueos no se puede controlar en absoluto, ya que ocurre sin ningún cambio en el cliente. <br><br>  Están asociados con la actualización del backend de los socios y la falta de compatibilidad con versiones anteriores.  Tales bloqueos a menudo ocurren en grandes proveedores de publicidad, pero se solucionan rápidamente, ya que afectan una gran cantidad de aplicaciones al mismo tiempo. <br><br>  Hubo casos en los que iFunny sin accidentes por día cayó del 99.8% estándar al 80%, y la cantidad de comentarios enojados en la historia fue de diez. <br><br><h4>  Rendimiento </h4><br>  La publicidad de banner, por regla general, utiliza componentes de WebView para mostrar publicidad, por lo que cada banner que se muestra es una inicialización de un nuevo WebView con todas sus dependencias. <br><br>  Además, algunos socios también usan WebView para comunicarse con su propio backend, ya que la publicidad de banner en dispositivos móviles es un descendiente de la publicidad en la web. <br><br>  Sucede que después de la actualización hay pérdidas de memoria dentro de la nueva biblioteca.  Después de la aparición de la herramienta Memory Graph en Xcode, se hizo mucho más fácil encontrar fugas en bibliotecas de terceros, por lo que ahora los socios pueden ser informados rápidamente sobre ellas. <br><br>  A continuación se muestra el GIF de iFunny inactivo cuando no hay publicidad para el usuario: <br><br><img src="https://habrastorage.org/webt/oq/eg/ul/oqegulmbyh7j3zejhcmf4g_oage.gif"><br><br><h2>  Soluciones </h2><br>  Pero a pesar de todos los problemas descritos anteriormente, iFunny es estable y todos los días sonríe entre millones de usuarios. <br><br>  A lo largo de los años de trabajo activo con la publicidad, el equipo de desarrollo tiene varias herramientas que pueden monitorear con éxito los problemas de publicidad y responder a tiempo. <br><br><h3>  Sistema de registro </h3><br>  Ahora el sistema de registro de excepciones en iFunny se ha extendido a toda la aplicación: para esto, utilizamos nuestro propio backend con una base en ClickHouse y lo mostramos en Grafana. <br><br>  Pero la primera tarea para trabajar con registros en la aplicación fue precisamente el registro de situaciones excepcionales en publicidad. <br><br>  Hay varios componentes relacionados para determinar si una llamada se reenvía a iFunny.  Te contaré más sobre cada uno de ellos. <br><br><h4>  IFAdView </h4><br>  Este es el descendiente de la clase MPAdView (es responsable de mostrar anuncios en MoPub). <br><br>  El método hitTest: withEvent se reemplaza en esta clase: <br><br><pre> <code class="objectivec hljs">- (<span class="hljs-built_in"><span class="hljs-built_in">UIView</span></span> *)hitTest:(<span class="hljs-built_in"><span class="hljs-built_in">CGPoint</span></span>)point withEvent:(<span class="hljs-built_in"><span class="hljs-built_in">UIEvent</span></span> *)event { <span class="hljs-built_in"><span class="hljs-built_in">UIView</span></span> *hitView = [<span class="hljs-keyword"><span class="hljs-keyword">super</span></span> hitTest:point withEvent:event]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (hitView) { [[IFAdsExceptionManager instance] triggerTouchView]; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> hitView; }</code> </pre> <br>  Por lo tanto, activamos el hecho de que el usuario interactuó con el anuncio. <br><br><h4>  IFURLProtocol </h4><br>  Heredamos de NSURLProtocol y describimos el método: <br><br><pre> <code class="objectivec hljs">+ (<span class="hljs-built_in"><span class="hljs-built_in">BOOL</span></span>)canInitWithRequest:(<span class="hljs-built_in"><span class="hljs-built_in">NSURLRequest</span></span> *)request { __<span class="hljs-keyword"><span class="hljs-keyword">weak</span></span> <span class="hljs-built_in"><span class="hljs-built_in">NSString</span></span> *wRequestURL = request.URL.absoluteString; <span class="hljs-built_in"><span class="hljs-built_in">dispatch_async</span></span>(dispatch_get_main_queue(), ^{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (wRequestURL == <span class="hljs-literal"><span class="hljs-literal">nil</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ([wRequestURL hasPrefix:<span class="hljs-string"><span class="hljs-string">@"itms-appss://itunes.apple.com"</span></span>] || [wRequestURL hasPrefix:<span class="hljs-string"><span class="hljs-string">@"itms-apps://itunes.apple.com"</span></span>] || [wRequestURL hasPrefix:<span class="hljs-string"><span class="hljs-string">@"itmss://itunes.apple.com"</span></span>] || [wRequestURL hasPrefix:<span class="hljs-string"><span class="hljs-string">@"http://itunes.apple.com"</span></span>] || [wRequestURL hasPrefix:<span class="hljs-string"><span class="hljs-string">@"https://itunes.apple.com"</span></span>]) { [[IFAdsExceptionManager instance] adsTriggerItunesURL:wRequestURL]; } }); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">NO</span></span>; }</code> </pre><br>  Este es un desencadenante para abrir la AppStore desde la aplicación, enumeramos todas las URL disponibles para esto. <br><br><h4>  IFAdsExceptionManager </h4><br>  Una clase que recopila desencadenantes y genera un registro de excepción en el registro. <br><br>  Para dejar en claro qué tipo de disparadores son, describiré cada método de la interfaz de esta clase. <br><br><pre> <code class="objectivec hljs">- (<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>)triggerTouchView;       . &lt;source lang=<span class="hljs-string"><span class="hljs-string">"objectivec"</span></span>&gt;- (<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>)triggerItunesURL:(<span class="hljs-built_in"><span class="hljs-built_in">NSString</span></span> *)itunesURL;</code> </pre> <br>  Un disparador que determina si se produce una redirección en iTunes. <br><br><pre> <code class="objectivec hljs">- (<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>)triggerResignActive;</code> </pre> <br>  Un disparador para determinar la pérdida de actividad de una aplicación.  Compara los dos disparadores anteriores. <br><br><pre> <code class="objectivec hljs">- (<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>)resetTriggers;</code> </pre> <br>  Restablecer disparadores.  Lo llamamos al dejar el fondo o cuando abrimos la AppStore nosotros mismos, por ejemplo, cuando enviamos al usuario a calificar en versiones anteriores de iOS. <br><br><pre> <code class="objectivec hljs"><span class="hljs-keyword"><span class="hljs-keyword">@property</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">nonatomic</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">strong</span></span>) FNAdConfigurationInfo *lastRequestedConfiguration; <span class="hljs-keyword"><span class="hljs-keyword">@property</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">nonatomic</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">strong</span></span>) FNAdConfigurationInfo *lastLoadedConfiguration; <span class="hljs-keyword"><span class="hljs-keyword">@property</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">nonatomic</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">strong</span></span>) FNAdConfigurationInfo *lastFailedConfiguration;</code> </pre> <br>  Propiedades para registrar los últimos anuncios solicitados y descargados con éxito o sin éxito.  Necesario para formar un mensaje en el registro. <br><br>  Se puede ver que el algoritmo resultó ser bastante simple, pero efectivo.  Nos permite rastrear no solo los descubrimientos automáticos de MoPub, sino también de otras redes. <br><br>  Recientemente, los anuncios con apertura automática a menudo abren SKStoreProductViewController, por lo que ahora estamos trabajando en la definición de apertura automática de este controlador.  El algoritmo para definir esta excepción será un poco más complicado, pero Objective-C Runtime nos ayudará aquí. <br><br><h2>  Stand local </h2><br>  Basado en el sistema de registro, iFunny también comenzó a desarrollar un stand local para recibir y depurar anuncios que los usuarios ven en tiempo real. <br><br>  El stand consta de: <br><br><ul><li>  agente de construcción </li><li>  dispositivos </li><li>  conjunto de pruebas para cada proveedor </li></ul><br>  Una de las soluciones interesantes que se utiliza en el stand es IDFA a partir de las quejas de los usuarios por publicidad real. <br><br>  Desde aproximadamente 2016, dejamos de recibir anuncios reales dirigidos a los EE. UU. Utilizando solo VPN, por lo que tenemos que reemplazar los dispositivos IDFA con IDFA para usuarios reales. <br><br>  Esto se hace con bastante facilidad utilizando Objective-C Runtime y swizzling. <br>  Debe reemplazar el método advertisingIdentifier de la clase ASIdentifierManager. <br><br>  Aquí lo hacemos a través de la categoría: <br><br><pre> <code class="objectivec hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">@interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ASIdentifierManager</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">IDFARewrite</span></span></span><span class="hljs-class">) @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">implementation</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ASIdentifierManager</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">IDFARewrite</span></span></span><span class="hljs-class">) + (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">void</span></span></span><span class="hljs-class">)</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">load</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-built_in"><span class="hljs-built_in">dispatch_once_t</span></span> onceToken; <span class="hljs-built_in"><span class="hljs-built_in">dispatch_once</span></span>(&amp;onceToken, ^{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (AdsMonitorTests.customIDFA != <span class="hljs-literal"><span class="hljs-literal">nil</span></span>) { [<span class="hljs-keyword"><span class="hljs-keyword">self</span></span> swizzleIDFA]; } }); } + (<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>)swizzleIDFA { Class <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> = [<span class="hljs-keyword"><span class="hljs-keyword">self</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span>]; SEL originalSelector = <span class="hljs-keyword"><span class="hljs-keyword">@selector</span></span>(advertisingIdentifier); SEL swizzledSelector = <span class="hljs-keyword"><span class="hljs-keyword">@selector</span></span>(swizzled_advertisingIdentifier); Method originalMethod = class_getInstanceMethod(<span class="hljs-keyword"><span class="hljs-keyword">class</span></span>, originalSelector); Method swizzledMethod = class_getInstanceMethod(<span class="hljs-keyword"><span class="hljs-keyword">class</span></span>, swizzledSelector); <span class="hljs-built_in"><span class="hljs-built_in">BOOL</span></span> didAddMethod = class_addMethod(<span class="hljs-keyword"><span class="hljs-keyword">class</span></span>, originalSelector, method_getImplementation(swizzledMethod), method_getTypeEncoding(swizzledMethod)); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (didAddMethod) { class_replaceMethod(<span class="hljs-keyword"><span class="hljs-keyword">class</span></span>, swizzledSelector, method_getImplementation(originalMethod), method_getTypeEncoding(originalMethod)); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { method_exchangeImplementations(originalMethod, swizzledMethod); } } <span class="hljs-meta"><span class="hljs-meta">#pragma mark - Method Swizzling - (NSUUID *)swizzled_advertisingIdentifier { NSUUID *result = AdsMonitorTests.customIDFA; return result; } @end</span></span></code> </pre><br>  El método descrito en el <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">artículo se</a> utiliza para transferir el IDFA de usuario a la compilación desde el agente de compilación. <br><br>  En conclusión, quiero decir que la publicidad de banner funciona muy bien en los Estados Unidos, y durante siete años de su uso activo como método principal de monetización, iFunny ha aprendido a trabajar bien con ella. <br><br>  Pero a pesar del hecho de que las pancartas aportan el 75% de los ingresos de la compañía, se está trabajando en métodos alternativos de monetización y ya se ha ganado algo de experiencia en publicidad nativa y el uso de subastas de publicidad en el mercado estadounidense. <br><br>  En general, hay algo que contar. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/es426553/">https://habr.com/ru/post/es426553/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../es426543/index.html">Copias de seguridad con estado en Kubernetes</a></li>
<li><a href="../es426545/index.html">Bonos Joker 2018: transmisión en línea gratuita, bofs, fiesta y mesa</a></li>
<li><a href="../es426547/index.html">Como el creador de Android está intentando lanzar el primer "anti-teléfono inteligente"</a></li>
<li><a href="../es426549/index.html">Un nuevo tipo de software para gerentes de producto</a></li>
<li><a href="../es426551/index.html">Trekz Air: cómo suenan realmente los auriculares de conducción ósea</a></li>
<li><a href="../es426555/index.html">PC, pero no PC: Entrevista con el Comité del Programa Joker</a></li>
<li><a href="../es426557/index.html">Las habilidades más buscadas en ciencia de datos</a></li>
<li><a href="../es426559/index.html">Redes neuronales para procesamiento de imágenes. Dice Alexander Savsunenko de Skylum Software</a></li>
<li><a href="../es426561/index.html">Los cinco grandes: deben tener herramientas para acelerar el desarrollo</a></li>
<li><a href="../es426563/index.html">Libreta de direcciones jerárquica, cambio de correo electrónico principal y otras innovaciones en Zimbra 8.8.10</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>