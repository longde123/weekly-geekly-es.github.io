<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ğŸ’— ğŸ¸ ğŸ§›ğŸ¾ ä»é«˜Cephå»¶è¿Ÿåˆ°ä½¿ç”¨eBPF / BCCçš„å†…æ ¸è¡¥ä¸ ğŸ¦Š ğŸ¦ ğŸ“«</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="åœ¨Linuxä¸­æœ‰å¾ˆå¤šç”¨äºè°ƒè¯•å†…æ ¸å’Œç”¨æˆ·ç©ºé—´ç¨‹åºçš„å·¥å…·ã€‚ å®ƒä»¬ä¸­çš„å¤§å¤šæ•°ä¼šå½±å“æ€§èƒ½ï¼Œå¹¶ä¸”ä¸èƒ½è½»æ¾åœ°åœ¨ç”Ÿäº§ç¯å¢ƒä¸­è¿è¡Œã€‚ å‡ å¹´å‰ï¼Œ å¼€å‘äº† eBPFï¼Œå®ƒæä¾›äº†ä»¥ä½å¼€é”€è·Ÿè¸ªå†…æ ¸å’Œç”¨æˆ·ç©ºé—´çš„åŠŸèƒ½ï¼Œè€Œæ— éœ€é‡æ–°ç¼–è¯‘ç¨‹åºæˆ–åŠ è½½å†…æ ¸æ¨¡å—ã€‚ 

 ç°åœ¨æœ‰å¾ˆå¤šä½¿ç”¨eBPFçš„å·¥å…·ï¼Œåœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘ä»¬å°†è¯´æ˜å¦‚ä½•ä½¿ç”¨PythonB...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>ä»é«˜Cephå»¶è¿Ÿåˆ°ä½¿ç”¨eBPF / BCCçš„å†…æ ¸è¡¥ä¸</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/selectel/blog/450818/"><img src="https://habrastorage.org/webt/-8/ok/na/-8okna9qfyroicvgoz-zenv7-si.png"><br><br> åœ¨Linuxä¸­æœ‰å¾ˆå¤šç”¨äºè°ƒè¯•å†…æ ¸å’Œç”¨æˆ·ç©ºé—´ç¨‹åºçš„å·¥å…·ã€‚ å®ƒä»¬ä¸­çš„å¤§å¤šæ•°ä¼šå½±å“æ€§èƒ½ï¼Œå¹¶ä¸”ä¸èƒ½è½»æ¾åœ°åœ¨ç”Ÿäº§ç¯å¢ƒä¸­è¿è¡Œã€‚ å‡ å¹´å‰ï¼Œ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">å¼€å‘äº†</a> eBPFï¼Œå®ƒæä¾›äº†ä»¥ä½å¼€é”€è·Ÿè¸ªå†…æ ¸å’Œç”¨æˆ·ç©ºé—´çš„åŠŸèƒ½ï¼Œè€Œæ— éœ€é‡æ–°ç¼–è¯‘ç¨‹åºæˆ–åŠ è½½å†…æ ¸æ¨¡å—ã€‚ <br><br> ç°åœ¨æœ‰å¾ˆå¤šä½¿ç”¨eBPFçš„å·¥å…·ï¼Œåœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘ä»¬å°†è¯´æ˜å¦‚ä½•ä½¿ç”¨<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">PythonBCCåº“</a>ç¼–å†™è‡ªå·±çš„åˆ†æå·¥å…·ã€‚ æœ¬æ–‡åŸºäºç”Ÿäº§ç¯å¢ƒä¸­çš„å®é™…é—®é¢˜ã€‚ æˆ‘ä»¬å°†å¼•å¯¼æ‚¨è§£å†³é—®é¢˜ï¼Œå¹¶è¯´æ˜åœ¨æŸäº›æƒ…å†µä¸‹å¦‚ä½•ä½¿ç”¨ç°æœ‰çš„å¯†ä»¶æŠ„é€å·¥å…·ã€‚ <br><a name="habracut"></a><br><h2>  Cephå¾ˆæ…¢ </h2><br> æ–°å¹³å°å·²æ·»åŠ åˆ°cephé›†ç¾¤ã€‚ å°†æŸäº›æ•°æ®è¿ç§»åˆ°å¹³å°åï¼Œå†™å…¥è¯·æ±‚çš„ç­‰å¾…æ—¶é—´æ¯”å…¶ä»–æœåŠ¡å™¨ä¸Šçš„ç­‰å¾…æ—¶é—´é•¿ã€‚ <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/uk/de/-l/ukde-lsu9sjqnmci1ix942xzgie.png"></div><br><br> è¯¥å¹³å°å…·æœ‰ä¸€ä¸ªæ–°çš„ç¼“å­˜è™šæ‹Ÿè®¾å¤‡-bcacheï¼ˆæˆ‘ä»¬ä¹‹å‰æœªåœ¨æ­¤é›†ç¾¤ä¸­ä½¿ç”¨è¿‡ï¼‰å’Œä¸€ä¸ªæ–°å†…æ ¸-4.15ï¼Œè¯¥å†…æ ¸åœ¨è¯¥é›†ç¾¤ä¸­çš„å…¶ä»–ä»»ä½•åœ°æ–¹å‡æœªä½¿ç”¨ã€‚ é—®é¢˜çš„æ ¹æºå¯èƒ½åœ¨ä»»ä½•åœ°æ–¹ï¼Œå› æ­¤è®©æˆ‘ä»¬æ›´æ·±å…¥åœ°ç ”ç©¶ä¸€ä¸‹ã€‚ <br><br><h3> è°ƒæŸ¥ä¸»æœº </h3><br> è®©æˆ‘ä»¬çœ‹çœ‹ceph-osdè¿›ç¨‹å†…éƒ¨å‘ç”Ÿäº†ä»€ä¹ˆã€‚ æˆ‘ä»¬ä½¿ç”¨è·Ÿè¸ªå·¥å…·<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">perf</a>å’Œ<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Flamescope</a>æ¥æ„å»ºç«ç„°å›¾ï¼š <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/ch/5k/nn/ch5knn22cmukd1oldmcozpxe98i.png"></div><br><br> ä»ç«ç„°å›¾å¯ä»¥çœ‹å‡ºï¼Œ <b>fdatasyncï¼ˆï¼‰</b>èŠ±äº†å¾ˆå¤šæ—¶é—´åœ¨<b>generic_make_requestï¼ˆï¼‰</b>å‡½æ•°ä¸­æäº¤bioã€‚ å› æ­¤ï¼Œæˆ‘ä»¬é—®é¢˜çš„æ ¹æºä¸åœ¨cephå®ˆæŠ¤ç¨‹åºä¹‹å¤–ã€‚ å¯èƒ½æ˜¯å†…æ ¸ï¼Œbcacheæˆ–ç£ç›˜é—®é¢˜ã€‚  iostatè¾“å‡ºæ˜¾ç¤ºbcacheè®¾å¤‡çš„é«˜å»¶è¿Ÿã€‚ <br><br> å¦ä¸€ä¸ªå¯ç–‘çš„å‘ç°æ˜¯systemd-udevdå®ˆæŠ¤ç¨‹åºæ­£åœ¨æ¶ˆè€—CPUï¼›å®ƒæ˜¯CPUã€‚ åœ¨å¤šä¸ªCPUä¸Šå¤§çº¦å 20ï¼…ã€‚ è¿™æ˜¯å¥‡æ€ªçš„è¡Œä¸ºï¼Œæ‰€ä»¥æˆ‘ä»¬å¿…é¡»æ‰¾å‡ºæ­£åœ¨å‘ç”Ÿçš„äº‹æƒ…ã€‚ ç”±äºsystemd-udevdå¯ä¸ueventsä¸€èµ·ä½¿ç”¨ï¼Œå› æ­¤æˆ‘ä»¬å¿…é¡»ä½¿ç”¨<b>udevadm Monitor</b>æ¥ç¡®å®šç³»ç»Ÿä¸­æ˜¯å¦æœ‰ä»»ä½•ueventsã€‚ æ£€æŸ¥åï¼Œæˆ‘ä»¬å‘ç°ç³»ç»Ÿä¸­çš„æ¯ä¸ªå—è®¾å¤‡éƒ½å°†ç”Ÿæˆè®¸å¤šâ€œæ›´æ”¹â€äº‹ä»¶ã€‚ <br><br> è¿™æ˜¯ä¸å¯»å¸¸çš„ï¼Œå› æ­¤æˆ‘ä»¬å°†æ‰¾å‡ºå¯¼è‡´æ‰€æœ‰è¿™äº›äº‹ä»¶å‘é€çš„åŸå› ã€‚ <br><br>
<h3> ä½¿ç”¨BCCå·¥å…·åŒ… </h3><br> ä¼—æ‰€å‘¨çŸ¥ï¼Œå†…æ ¸ï¼ˆå’Œcephå®ˆæŠ¤ç¨‹åºï¼‰èŠ±è´¹å¤§é‡æ—¶é—´æ¥æ‰§è¡Œ<b>generic_make_requstï¼ˆï¼‰</b>å‡½æ•°ã€‚ è®©æˆ‘ä»¬ä½¿ç”¨<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">BCCå·¥å…·åŒ…ä¸­çš„</a> <b>funclatency</b>æ¥è¡¡é‡å…¶å»¶è¿Ÿï¼Œä»¥ç¡®ä¿æˆ‘ä»¬èµ°åœ¨æ­£ç¡®çš„é“è·¯ä¸Šã€‚ æˆ‘ä»¬å°†ä»¥1ç§’çš„é—´éš”ï¼ˆ-iï¼‰è·Ÿè¸ªcephå®ˆæŠ¤ç¨‹åºçš„PIDï¼ˆ-på‚æ•°ï¼‰ï¼Œå¹¶ä»¥æ¯«ç§’ï¼ˆ-mï¼‰æ˜¾ç¤ºå»¶è¿Ÿã€‚ <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/4c/cj/za/4ccjza8x8bq0vqkxfol2j5d9sva.png"></div><br><br> æ­¤åŠŸèƒ½é€šå¸¸è¿è¡Œéå¸¸å¿«ã€‚ å®ƒæ‰€åšçš„åªæ˜¯å°†ç”Ÿç‰©ç»“æ„æäº¤åˆ°è®¾å¤‡é©±åŠ¨ç¨‹åºçš„é˜Ÿåˆ—ä¸­ã€‚ <br><br>  <b>Bcache</b>æ˜¯ä¸€ä¸ªå¤æ‚çš„è®¾å¤‡ï¼› å®é™…ä¸Šï¼Œå®ƒç”±3ä¸ªè®¾å¤‡ç»„æˆï¼šä¸€ä¸ªåå¤‡è®¾å¤‡ï¼Œåœ¨æˆ‘ä»¬çš„ä¾‹å­ä¸­æ˜¯æ…¢é€Ÿç¡¬ç›˜ï¼› ç¼“å­˜è®¾å¤‡ï¼Œå³NVMeé©±åŠ¨å™¨çš„åˆ†åŒºï¼› ä»¥åŠåº”ç”¨ç¨‹åºä½¿ç”¨çš„bcacheè™šæ‹Ÿè®¾å¤‡ã€‚ æˆ‘ä»¬çŸ¥é“æäº¤é€Ÿåº¦å¾ˆæ…¢ï¼Œä½†æ˜¯ä½¿ç”¨å“ªç§è®¾å¤‡ï¼Ÿ æˆ‘ä»¬ç¨åä¼šè®¨è®ºè¿™ä¸€ç‚¹ã€‚ <br><br> åˆ°ç›®å‰ä¸ºæ­¢ï¼Œæˆ‘ä»¬çŸ¥é“ueventä¼šåœ¨cephå®ˆæŠ¤è¿›ç¨‹ä¸­å¯¼è‡´é—®é¢˜ï¼Œæˆ‘ä»¬å¿…é¡»æ‰¾åˆ°è§¦å‘ueventçš„è½¯ä»¶ï¼Œè¦æ‰¾åˆ°å¯¼è‡´ueventç”Ÿæˆçš„åŸå› å¹¶ä¸å®¹æ˜“ã€‚ æˆ‘ä»¬å‡è®¾å®ƒæ˜¯ä»…å®šæœŸè¿è¡Œçš„è½¯ä»¶ã€‚ è¦æŸ¥çœ‹ç³»ç»Ÿä¸Šæ­£åœ¨æ‰§è¡Œä»€ä¹ˆï¼Œæˆ‘ä»¬ä½¿ç”¨BCCå·¥å…·ç®±ä¸­çš„<b>execsnoop</b> ã€‚ æˆ‘ä»¬å¯ä»¥è¿è¡Œå®ƒå¹¶å°†<b>stdout</b>é‡å®šå‘åˆ°æ–‡ä»¶ã€‚ <br><br> ä¾‹å¦‚ï¼š <br><br><pre><code class="bash hljs">/usr/share/bcc/tools/execsnoop | tee ./execdump</code> </pre> <br> æˆ‘ä»¬ä¸ä¼šåœ¨æ­¤å¤„æä¾›å®Œæ•´çš„execsnoopè¾“å‡ºï¼Œä½†æ˜¯æˆ‘ä»¬å‘ç°å…¶ä¸­ä¸€ä¸ªæœ‰è¶£çš„å­—ç¬¦ä¸²æ˜¯ï¼š <br><br><pre> <code class="bash hljs">sh 1764905 5802 0 sudo arcconf getconfig 1 AD | grep Temperature | awk -F <span class="hljs-string"><span class="hljs-string">'[:/]'</span></span> <span class="hljs-string"><span class="hljs-string">'{print $2}'</span></span> | sed <span class="hljs-string"><span class="hljs-string">'s/^ \([0-9]*\) C.*/\1/'</span></span></code> </pre> <br> ç¬¬ä¸‰åˆ—æ˜¯æµç¨‹çš„PPIDã€‚ æˆ‘ä»¬æ£€æŸ¥äº†5802æ˜¯ä»€ä¹ˆï¼Œå¹¶å‘ç°å®ƒæ˜¯æˆ‘ä»¬çš„ç›‘è§†å®ˆæŠ¤ç¨‹åºçº¿ç¨‹ä¹‹ä¸€ã€‚ è¿›ä¸€æ­¥æŸ¥çœ‹ç›‘è§†ç³»ç»Ÿé…ç½®ï¼Œæˆ‘ä»¬å‘ç°ä¸€ä¸ªé”™è¯¯çš„å‚æ•°ã€‚ æ¯30ç§’é’Ÿæ£€ç´¢ä¸€æ¬¡HBAæ¸©åº¦ï¼Œè¿™ç§æƒ…å†µç»å¸¸å‘ç”Ÿã€‚ å°†æ£€æŸ¥é—´éš”æ›´æ”¹ä¸ºæ›´åˆé€‚çš„å€¼åï¼Œæˆ‘ä»¬çœ‹åˆ°æˆ‘ä»¬çš„cephå»¶è¿Ÿä¸å…¶ä»–å¹³å°åŒ¹é…ã€‚ <br><br> ä½†æ˜¯æˆ‘ä»¬ä»ç„¶ä¸çŸ¥é“ä¸ºä»€ä¹ˆbcacheå»¶è¿Ÿå¦‚æ­¤ä¹‹é«˜ã€‚ æˆ‘ä»¬å»ºç«‹äº†å…·æœ‰ç›¸åŒé…ç½®çš„æµ‹è¯•å¹³å°ï¼Œå¹¶å°è¯•åœ¨bcacheè®¾å¤‡ä¸Šé‡ç°fioé—®é¢˜ï¼ŒåŒæ—¶ä½¿ç”¨udevadm triggerå‘½ä»¤è§¦å‘udevã€‚ <br><br><h3> ç¼–å†™åŸºäºBCCçš„å·¥å…· </h3><br> æˆ‘ä»¬åœ¨è¿™é‡Œè¦åšçš„æ˜¯ç¼–å†™ä¸€ä¸ªç®€å•çš„å·¥å…·ï¼Œè¯¥å·¥å…·å¯ä»¥è·Ÿè¸ªæœ€æ…¢çš„generic_make_requestï¼ˆï¼‰è°ƒç”¨ï¼Œå¹¶æ‰“å°è¯¥å‡½æ•°æ‰€éœ€è¦çš„ç£ç›˜çš„åç§°ã€‚ <br><br> è¯¥è®¡åˆ’å¾ˆç®€å•ï¼š <br><br><ul><li> åœ¨<b>generic_make_requestï¼ˆï¼‰</b>ä¸Šæ³¨å†Œ<b>kprobe</b> ï¼š <br><ul><li> ä¿å­˜å‡½æ•°åç§°ä¸­å¯ç”¨çš„ç£ç›˜åç§° </li><li> ä¿å­˜å½“å‰æ—¶é—´æˆ³ </li></ul></li><li> åœ¨<b>generic_make_requestï¼ˆï¼‰</b>è¿”å›è¯­å¥ä¸Šæ³¨å†Œ<b>kretprobe</b> ï¼š <br><ul><li> æ£€ç´¢å½“å‰æ—¶é—´æˆ³ </li><li> æŸ¥æ‰¾ä»¥å‰ä¿å­˜çš„æ—¶é—´æˆ³å¹¶å°†å…¶ä¸å½“å‰æ—¶é—´æˆ³è¿›è¡Œæ¯”è¾ƒ </li><li> å¦‚æœç»“æœé«˜äºé˜ˆå€¼ï¼Œè¯·æŸ¥æ‰¾å…ˆå‰ä¿å­˜çš„ç£ç›˜åç§°ï¼Œå¹¶å°†å…¶ä¸å…¶ä»–ä¿¡æ¯ä¸€èµ·æ‰“å°åˆ°ç»ˆç«¯ä¸Š </li></ul></li></ul><br>  <b>Kprobes</b>å’Œ<b>kretprobes</b>ä½¿ç”¨æ–­ç‚¹åœ¨è¿è¡Œæ—¶æ›´æ”¹å‡½æ•°çš„ä»£ç ã€‚ æ‚¨å¯ä»¥æ‰¾åˆ°<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">æ–‡æ¡£</a>ä»¥åŠå…³äºæ­¤çš„å¾ˆå¥½çš„<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">æ–‡ç« </a> ã€‚ å¦‚æœæŸ¥çœ‹ä¸åŒ<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">BCCå·¥å…·</a>çš„ä»£ç ï¼Œå°±ä¼šå‘ç°å®ƒä»¬éƒ½å…·æœ‰ç›¸åŒçš„ç»“æ„ã€‚ æˆ‘ä»¬å°†è·³è¿‡å‚æ•°è§£æï¼Œè€Œå°†é‡ç‚¹æ”¾åœ¨BPFç¨‹åºæœ¬èº«ä¸Šã€‚ <br><br> æˆ‘ä»¬ç¨‹åºçš„æ–‡æœ¬å°†åœ¨pythonä¸­å®šä¹‰å¦‚ä¸‹ï¼š <br><br><pre> <code class="python hljs">bpf_text = â€œâ€â€ <span class="hljs-comment"><span class="hljs-comment"># Here will be the bpf program code â€œâ€â€</span></span></code> </pre> <br>  BPFç¨‹åºä½¿ç”¨<a href="">å“ˆå¸Œå›¾</a>åœ¨ä¸åŒåŠŸèƒ½ä¹‹é—´å…±äº«æ•°æ®ã€‚ æˆ‘ä»¬å°†ä½¿ç”¨PIDä½œä¸ºé”®ï¼Œå¹¶ä½¿ç”¨è‡ªå®šä¹‰ç»“æ„ä½œä¸ºå€¼ã€‚ <br><br><pre> <code class="python hljs">struct data_t { u64 pid; u64 ts; char comm[TASK_COMM_LEN]; u64 lat; char disk[DISK_NAME_LEN]; }; BPF_HASH(p, u64, struct data_t); BPF_PERF_OUTPUT(events);</code> </pre> <br> åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬ä½¿ç”¨<b>u64</b>é”®ç±»å‹å’Œ<b>struct data_t</b>å€¼ç±»å‹æ³¨å†Œä¸€ä¸ªåä¸º<b>p</b>çš„å“ˆå¸Œæ˜ å°„ã€‚ å¯ä»æˆ‘ä»¬çš„BPFç¨‹åºä¸Šä¸‹æ–‡è®¿é—®æ­¤åœ°å›¾ã€‚  <b>BPF_PERF_OUTPUT</b>å®æ³¨å†Œå¦ä¸€ä¸ªç§°ä¸º<b>äº‹ä»¶çš„</b>æ˜ å°„ï¼Œè¯¥æ˜ å°„ç”¨äº<a href="">å°†æ•°æ®æ¨</a>é€åˆ°ç”¨æˆ·ç©ºé—´ã€‚ <br><br> åœ¨æµ‹é‡å‡½æ•°è°ƒç”¨ä¸å…¶è¿”å›ä¹‹é—´æˆ–ä¸€ä¸ªå‡½æ•°è°ƒç”¨ä¸å¦ä¸€ä¸ªå‡½æ•°è°ƒç”¨ä¹‹é—´çš„ç­‰å¾…æ—¶é—´æ—¶ï¼Œå¿…é¡»ç¡®ä¿ä¿å­˜å¹¶ç¨åè®¿é—®çš„æ•°æ®ä¸åŒä¸€ä¸Šä¸‹æ–‡ç›¸å…³ã€‚ æ¢å¥è¯è¯´ï¼Œæ‚¨å¿…é¡»çŸ¥é“åŒä¸€åŠŸèƒ½çš„ä»»ä½•å…¶ä»–å¹¶è¡Œæ‰§è¡Œã€‚ å¯ä»¥è·Ÿè¸ªä¸€ä¸ªè¿›ç¨‹çš„å‡½æ•°è°ƒç”¨ä¸å¦ä¸€ä¸ªè¿›ç¨‹çš„åŒä¸€å‡½æ•°çš„è¿”å›ä¹‹é—´çš„å»¶è¿Ÿï¼Œä½†è¿™å¯¹æˆ‘ä»¬æ²¡æœ‰å¸®åŠ©ã€‚  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">ç”Ÿç‰©å»¶è¿Ÿå·¥å…·</a>å°±æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„ä¾‹å­ï¼Œå…¶ä¸­å°†æŒ‡å‘<b>ç»“æ„è¯·æ±‚çš„</b>æŒ‡é’ˆç”¨ä½œå“ˆå¸Œæ˜ å°„é”®ã€‚ <br><br> æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å¿…é¡»ç¼–å†™å°†é€šè¿‡kprobeæœºåˆ¶åœ¨å‡½æ•°è°ƒç”¨ä¸Šæ‰§è¡Œçš„ä»£ç ï¼š <br><br><pre> <code class="python hljs">void start(struct pt_regs *ctx, struct bio *bio) { u64 pid = bpf_get_current_pid_tgid(); struct data_t data = {}; u64 ts = bpf_ktime_get_ns(); data.pid = pid; data.ts = ts; bpf_probe_read_str(&amp;data.disk, sizeof(data.disk), (void*)bio-&gt;bi_disk-&gt;disk_name); p.update(&amp;pid, &amp;data); }</code> </pre> <br> åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬æœ‰ç¬¬ä¸€ä¸ª<a href="">generic_make_requestï¼ˆï¼‰å‚æ•°</a>ä½œä¸ºå‡½æ•°çš„ç¬¬äºŒä¸ªå‚æ•°ã€‚ ç„¶åï¼Œæˆ‘ä»¬ä»¥çº³ç§’ä¸ºå•ä½è·å–PIDå’Œå½“å‰æ—¶é—´æˆ³ï¼Œå¹¶å°†å…¶å†™å…¥æ–°åˆ†é…çš„<b>struct data_t dataä¸­</b> ã€‚ æˆ‘ä»¬ä»bioç»“æ„ä¸­è·å–ç£ç›˜åç§°ï¼Œå¹¶å°†å…¶ä¼ é€’ç»™<b>generic_make_requestï¼ˆï¼‰</b> ï¼Œå¹¶å°†å…¶ä¿å­˜åˆ°æˆ‘ä»¬çš„<b>æ•°æ®ä¸­</b> ã€‚ æœ€åä¸€æ­¥æ˜¯å°†æ¡ç›®æ·»åŠ åˆ°æˆ‘ä»¬ä¹‹å‰æè¿°çš„å“ˆå¸Œå›¾ä¸­ã€‚ <br><br> è¯¥å‡½æ•°å°†åœ¨<b>generic_make_requestï¼ˆï¼‰</b>è¿”å›æ—¶æ‰§è¡Œï¼š <br><br><pre> <code class="python hljs">void stop(struct pt_regs *ctx) { u64 pid = bpf_get_current_pid_tgid(); u64 ts = bpf_ktime_get_ns(); struct data_t* data = p.lookup(&amp;pid); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (data != <span class="hljs-number"><span class="hljs-number">0</span></span> &amp;&amp; data-&gt;ts &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) { bpf_get_current_comm(&amp;data-&gt;comm, sizeof(data-&gt;comm)); data-&gt;lat = (ts - data-&gt;ts)/<span class="hljs-number"><span class="hljs-number">1000</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (data-&gt;lat &gt; MIN_US) { FACTOR data-&gt;pid &gt;&gt;= <span class="hljs-number"><span class="hljs-number">32</span></span>; events.perf_submit(ctx, data, sizeof(struct data_t)); } p.delete(&amp;pid); } }</code> </pre> <br> æˆ‘ä»¬ä»å…ˆå‰çš„è¾“å‡ºä¸­è·å¾—PIDå’Œæ—¶é—´æˆ³ï¼Œå¹¶åœ¨å“ˆå¸Œå›¾ä¸­æŸ¥æ‰¾å…¶ä¸­<b>key == current PID</b>çš„å€¼ã€‚ å¦‚æœæ‰¾åˆ°å®ƒï¼Œæˆ‘ä»¬å°†å¾—åˆ°æ­£åœ¨è¿è¡Œçš„è¿›ç¨‹çš„åç§°ï¼Œå¹¶å°†å…¶æ·»åŠ åˆ°<b>æ•°æ®</b>ç»“æ„ä¸­ã€‚ æˆ‘ä»¬åœ¨è¿™é‡Œä½¿ç”¨<b>data-&gt; pid</b>æ‰€åšçš„äº‹æƒ…ä¸ºæˆ‘ä»¬æä¾›äº†çº¿ç¨‹ç»„IDã€‚ å…ˆå‰è°ƒç”¨çš„<a href="">bpf_get_current_pid_tgidï¼ˆï¼‰å‡½æ•°</a>ä»¥ç›¸åŒçš„64ä½å€¼è¿”å›è¿›ç¨‹çš„çº¿ç¨‹GIDå’ŒPIDã€‚ <br><br> æˆ‘ä»¬å¯¹æ¯ä¸ªçº¿ç¨‹çš„IDéƒ½ä¸æ„Ÿå…´è¶£ï¼Œä½†æ˜¯æˆ‘ä»¬æƒ³çŸ¥é“ä¸»çº¿ç¨‹çš„PIDã€‚ åœ¨æ£€æŸ¥äº†å»¶è¿Ÿæ˜¯å¦è¶…è¿‡é˜ˆå€¼ä¹‹åï¼Œæˆ‘ä»¬é€šè¿‡<b>äº‹ä»¶</b>æ˜ å°„å°†<b>æ•°æ®</b>ç»“æ„æäº¤ç»™ç”¨æˆ·ç©ºé—´ï¼Œç„¶åæœ€ååˆ é™¤å“ˆå¸Œæ˜ å°„æ¡ç›®ã€‚ <br><br> åœ¨æˆ‘ä»¬çš„pythonè„šæœ¬ä¸­ï¼Œæˆ‘ä»¬å¿…é¡»æ ¹æ®æƒ³è¦çš„é˜ˆå€¼å’Œæƒ³è¦åœ¨ç»“æœä¸­çœ‹åˆ°çš„æ—¶é—´å•ä½æ¥æ›¿æ¢<b>MIN_US</b>å’Œ<b>FACTOR</b> ï¼š <br><br><pre> <code class="python hljs">bpf_text = bpf_text.replace(<span class="hljs-string"><span class="hljs-string">'MIN_US'</span></span>,str(min_usec)) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> args.milliseconds: bpf_text = bpf_text.replace(<span class="hljs-string"><span class="hljs-string">'FACTOR'</span></span>,<span class="hljs-string"><span class="hljs-string">'data-&gt;lat /= 1000;'</span></span>) label = <span class="hljs-string"><span class="hljs-string">"msec"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>: bpf_text = bpf_text.replace(<span class="hljs-string"><span class="hljs-string">'FACTOR'</span></span>,<span class="hljs-string"><span class="hljs-string">''</span></span>) label = <span class="hljs-string"><span class="hljs-string">"usec"</span></span></code> </pre><br> ç„¶åï¼Œæˆ‘ä»¬å¿…é¡»ä½¿ç”¨<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">BPFï¼ˆï¼‰å®</a>å‡†å¤‡BPFç¨‹åºå¹¶æ³¨å†Œæ¢é’ˆï¼š <br><br><pre> <code class="python hljs">b = BPF(text=bpf_text) b.attach_kprobe(event=<span class="hljs-string"><span class="hljs-string">"generic_make_request"</span></span>,fn_name=<span class="hljs-string"><span class="hljs-string">"start"</span></span>) b.attach_kretprobe(event=<span class="hljs-string"><span class="hljs-string">"generic_make_request"</span></span>,fn_name=<span class="hljs-string"><span class="hljs-string">"stop"</span></span>)</code> </pre><br> æˆ‘ä»¬è¿˜éœ€è¦åœ¨è„šæœ¬ä¸­å®šä¹‰ä¸<b>struct data_t</b>ç›¸åŒçš„ç»“æ„ï¼Œä»¥ä»BPFç¨‹åºä¸­è¯»å–æ•°æ®ï¼š <br><br><pre> <code class="python hljs">TASK_COMM_LEN = <span class="hljs-number"><span class="hljs-number">16</span></span> <span class="hljs-comment"><span class="hljs-comment"># linux/sched.h DISK_NAME_LEN = 32 # linux/genhd.h class Data(ct.Structure): _fields_ = [("pid", ct.c_ulonglong), ("ts", ct.c_ulonglong), ("comm", ct.c_char * TASK_COMM_LEN), ("lat", ct.c_ulonglong), ("disk",ct.c_char * DISK_NAME_LEN)]</span></span></code> </pre> <br> æœ€åä¸€æ­¥æ˜¯æ‰“å°æ‰€éœ€çš„æ•°æ®ï¼š <br><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">print_event</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(cpu, data, size)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">global</span></span> start event = ct.cast(data, ct.POINTER(Data)).contents <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> start == <span class="hljs-number"><span class="hljs-number">0</span></span>: start = event.ts time_s = (float(event.ts - start)) / <span class="hljs-number"><span class="hljs-number">1000000000</span></span> print(<span class="hljs-string"><span class="hljs-string">"%-18.9f %-16s %-6d %-1s %s %s"</span></span> % (time_s, event.comm, event.pid, event.lat, label, event.disk)) b[<span class="hljs-string"><span class="hljs-string">"events"</span></span>].open_perf_buffer(print_event) <span class="hljs-comment"><span class="hljs-comment"># format output start = 0 while 1: try: b.perf_buffer_poll() except KeyboardInterrupt: exit()</span></span></code> </pre><br> å®Œæ•´è„šæœ¬å¯åœ¨<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">GitHubä¸Šè·å¾—</a> ã€‚ è®©æˆ‘ä»¬è¿è¡Œè„šæœ¬å¹¶åœ¨fioå†™å…¥bcacheè®¾å¤‡æ—¶è§¦å‘udeväº‹ä»¶ï¼š <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/tk/ly/vf/tklyvf6i8rws0xu4gy3jothbxbi.png"></div><br><br> æˆåŠŸï¼ ç°åœ¨ï¼Œæˆ‘ä»¬çœ‹åˆ°bcacheçš„é«˜å»¶è¿Ÿå®é™…ä¸Šæ˜¯å…¶åå¤‡è®¾å¤‡çš„<b>generic_make_requestï¼ˆï¼‰</b>å»¶è¿Ÿã€‚ <br><br><h3> æŒ–æ˜å†…æ ¸ </h3><br> æäº¤è¯·æ±‚æ—¶ä¼šæ‹–ç´¯ä»€ä¹ˆï¼Ÿ æˆ‘ä»¬çœ‹åˆ°åœ¨è¯·æ±‚è®¡è´¹å¼€å§‹ä¹‹å‰å°±å‡ºç°äº†å»¶è¿Ÿé«˜å³°ã€‚ å¯ä»¥é€šè¿‡åœ¨é—®é¢˜æœŸé—´è¿è¡Œiostatæˆ–<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">biolatency BCCè„šæœ¬</a> ï¼ˆåŸºäºè®°å¸è¯·æ±‚å¯åŠ¨ï¼‰æ¥è½»æ¾æ£€æŸ¥æ­¤é—®é¢˜ï¼Œå› æ­¤è¿™ä¸¤ç§å·¥å…·éƒ½ä¸ä¼šæ˜¾ç¤ºç£ç›˜é—®é¢˜ã€‚ <br><br> å¦‚æœæˆ‘ä»¬çœ‹ä¸€ä¸‹<b>generic_make_requestï¼ˆï¼‰</b> ï¼Œå°±ä¼šå‘ç°åœ¨å¼€å§‹è®°å¸ä¹‹å‰æœ‰ä¸¤ä¸ªå‡½æ•°æ­£åœ¨è¿è¡Œã€‚ ç¬¬ä¸€ä¸ªæ˜¯<b>generic_make_request_checksï¼ˆï¼‰</b> ï¼Œå®ƒå¾ˆè½»å·§ï¼Œå¹¶æ ¹æ®è®¾å¤‡è®¾ç½®ç­‰æ£€æŸ¥ç”Ÿç‰©ã€‚ ç¬¬äºŒä¸ªæ˜¯<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">blk_queue_enterï¼ˆï¼‰</a> ï¼Œå®ƒå…·æœ‰ä¸€ä¸ª<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">wait_event_interruptibleï¼ˆï¼‰</a>è°ƒç”¨ï¼š <br><br><pre> <code class="python hljs">ret = wait_event_interruptible(q-&gt;mq_freeze_wq, (atomic_read(&amp;q-&gt;mq_freeze_depth) == <span class="hljs-number"><span class="hljs-number">0</span></span> &amp;&amp; (preempt || !blk_queue_preempt_only(q))) || blk_queue_dying(q));</code> </pre><br> åœ¨è¿™é‡Œï¼Œå†…æ ¸ç­‰å¾…ç›´åˆ°é˜Ÿåˆ—è¢«å†»ç»“ä¸ºæ­¢ã€‚ è®©æˆ‘ä»¬æµ‹é‡ä¸€ä¸‹blk_queue_enterï¼ˆï¼‰çš„å»¶è¿Ÿï¼š <br><br><pre> <code class="bash hljs">~<span class="hljs-comment"><span class="hljs-comment"># /usr/share/bcc/tools/funclatency blk_queue_enter -i 1 -m Tracing 1 functions for "blk_queue_enter"... Hit Ctrl-C to end. msecs : count distribution 0 -&gt; 1 : 341 |****************************************| msecs : count distribution 0 -&gt; 1 : 316 |****************************************| msecs : count distribution 0 -&gt; 1 : 255 |****************************************| 2 -&gt; 3 : 0 | | 4 -&gt; 7 : 0 | | 8 -&gt; 15 : 1 | |</span></span></code> </pre><br> çœ‹æ¥æˆ‘ä»¬æ¥è¿‘äº†ã€‚ ç”¨äºå†»ç»“/è§£å†»é˜Ÿåˆ—çš„å‡½æ•°æ˜¯<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">blk_mq_freeze_queue</a>å’Œ<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">blk_mq_unfreeze_queue</a> ã€‚ å®ƒä»¬ç”¨äºæ›´æ”¹é˜Ÿåˆ—è®¾ç½®ï¼Œè¿™å¯èƒ½ä¼šå½±å“å½“å‰æ­£åœ¨è¿è¡Œçš„ioè¯·æ±‚ã€‚ è°ƒç”¨<b>blk_mq_freeze_queueï¼ˆï¼‰æ—¶</b> ï¼Œ <b>q-&gt; mq_freeze_depth</b>åœ¨<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">blk_freeze_queue_startï¼ˆï¼‰ä¸­</a>é€’å¢ã€‚ ä¹‹åï¼Œå†…æ ¸åœ¨<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">blk_mq_freeze_queue_waitï¼ˆï¼‰ä¸­</a>ç­‰å¾…é˜Ÿåˆ—ä¸ºç©ºã€‚ <br><br> æ­¤ç­‰å¾…æ—¶é—´ç­‰äºç£ç›˜å»¶è¿Ÿï¼Œå› ä¸ºå†…æ ¸å¿…é¡»ç­‰å¾…æ‰€æœ‰ioæ“ä½œå®Œæˆã€‚ å½“é˜Ÿåˆ—ä¸ºç©ºæ—¶ï¼Œå¯ä»¥è¿›è¡Œæ›´æ”¹ã€‚ æœ€åä¸€æ­¥æ˜¯è°ƒç”¨<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">blk_mq_unfreeze_queueï¼ˆï¼‰</a> ï¼Œè¿™ä¼šå‡å°‘<b>Frozen_depth</b>è®¡æ•°å™¨ã€‚ <br><br> ç°åœ¨æˆ‘ä»¬çŸ¥é“è¶³ä»¥è§£å†³æ­¤é—®é¢˜ã€‚  udevadm triggerå‘½ä»¤æ›´æ”¹å—è®¾å¤‡çš„è®¾ç½®ã€‚ è¿™äº›è®¾ç½®åœ¨udevè§„åˆ™ä¸­è¿›è¡Œäº†æè¿°ã€‚ æˆ‘ä»¬å¯ä»¥é€šè¿‡sysfsæˆ–æŸ¥çœ‹å†…æ ¸æºä»£ç æ¥æ›´æ”¹å†»ç»“é˜Ÿåˆ—çš„è®¾ç½®ã€‚ å¦å¤–ï¼Œæˆ‘ä»¬å¯ä»¥ä»BCCå·¥å…·ç®±ä¸­<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">è°ƒç”¨trace</a>æ¥ä¸ºæ¯ä¸ª<b>blk_freeze_queue</b>è°ƒç”¨æ‰“å°å†…æ ¸å’Œç”¨æˆ·å †æ ˆï¼š <br><br><pre> <code class="bash hljs">~<span class="hljs-comment"><span class="hljs-comment"># /usr/share/bcc/tools/trace blk_freeze_queue -K -U PID TID COMM FUNC 3809642 3809642 systemd-udevd blk_freeze_queue blk_freeze_queue+0x1 [kernel] elevator_switch+0x29 [kernel] elv_iosched_store+0x197 [kernel] queue_attr_store+0x5c [kernel] sysfs_kf_write+0x3c [kernel] kernfs_fop_write+0x125 [kernel] __vfs_write+0x1b [kernel] vfs_write+0xb8 [kernel] sys_write+0x55 [kernel] do_syscall_64+0x73 [kernel] entry_SYSCALL_64_after_hwframe+0x3d [kernel] __write_nocancel+0x7 [libc-2.23.so] [unknown] 3809631 3809631 systemd-udevd blk_freeze_queue blk_freeze_queue+0x1 [kernel] queue_requests_store+0xb6 [kernel] queue_attr_store+0x5c [kernel] sysfs_kf_write+0x3c [kernel] kernfs_fop_write+0x125 [kernel] __vfs_write+0x1b [kernel] vfs_write+0xb8 [kernel] sys_write+0x55 [kernel] do_syscall_64+0x73 [kernel] entry_SYSCALL_64_after_hwframe+0x3d [kernel] __write_nocancel+0x7 [libc-2.23.so] [unknown]</span></span></code> </pre> <br>  Udevè§„åˆ™ä¸ä¼šç»å¸¸æ›´æ”¹ï¼Œå› æ­¤å³ä½¿å°†å·²ç»å­˜åœ¨çš„å€¼åˆ†é…ç»™æŸäº›å‚æ•°ä¹Ÿä¼šå¯¼è‡´åº”ç”¨ç¨‹åºçš„æäº¤å»¶è¿Ÿé«˜å³°ã€‚ å½“ç„¶ï¼Œå½“è®¾å¤‡çš„é…ç½®æ²¡æœ‰ä»»ä½•å˜åŒ–ï¼ˆæ²¡æœ‰è¿æ¥æˆ–åˆ†ç¦»è®¾å¤‡ï¼‰æ—¶ç”Ÿæˆudeväº‹ä»¶ä¸æ˜¯ä¸€ä¸ªå¥½ä¹ æƒ¯ã€‚ å°½ç®¡å¦‚æ­¤ï¼Œå¦‚æœæ²¡æœ‰ç†ç”±ï¼Œæˆ‘ä»¬å¯ä»¥é˜²æ­¢å†…æ ¸å†»ç»“é˜Ÿåˆ—ã€‚  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">ä¸‰ä¸ª</a> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">å°çš„</a> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">æäº¤</a>è§£å†³äº†è¯¥é—®é¢˜ã€‚ <br><br><h2> ç»“è®º </h2><br>  eBPFæ˜¯é«˜åº¦çµæ´»ä¸”åŠŸèƒ½å¼ºå¤§çš„å·¥å…·ã€‚ åœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘ä»¬ä»…ç ”ç©¶äº†ä¸€ç§æƒ…å†µï¼Œå¹¶æ¼”ç¤ºäº†å…¶åŠŸèƒ½ã€‚ å¦‚æœæ‚¨å¯¹å¼€å‘åŸºäºBCCçš„å·¥å…·æ„Ÿå…´è¶£ï¼Œåˆ™åº”æŸ¥çœ‹<a href="">å®˜æ–¹æ•™ç¨‹</a> ï¼Œå…¶ä¸­æè¿°äº†å…¶åŸºæœ¬æ¦‚å¿µã€‚ <br><br> è¿˜æœ‰å…¶ä»–æœ‰è¶£çš„åŸºäºeBPFçš„å·¥å…·å¯ç”¨äºæ€§èƒ½åˆ†æå’Œè°ƒè¯•ã€‚ å…¶ä¸­ä¹‹ä¸€æ˜¯<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">bpftrace</a> ï¼Œå®ƒä½¿æ‚¨å¯ä»¥ä½¿ç”¨ç±»ä¼¼äºawkçš„è¯­è¨€ç¼–å†™åŠŸèƒ½å¼ºå¤§çš„onelinerså’Œå°ç¨‹åºã€‚ å¦ä¸€ä¸ªæ˜¯<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">ebpf_exporter</a> ï¼Œå®ƒå…·æœ‰å¼ºå¤§çš„å¯è§†åŒ–å’Œè­¦æŠ¥åŠŸèƒ½ï¼Œå¯ä»¥ä¸ºæ‚¨çš„prometheusæœåŠ¡å™¨æ”¶é›†ä½çº§åˆ«çš„é«˜åˆ†è¾¨ç‡æŒ‡æ ‡ã€‚ </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN450818/">https://habr.com/ru/post/zh-CN450818/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN450806/index.html">å½“ç¯å¢ƒå˜é‡å°†è¿‡ç¨‹åŠ å¿«40å€æ—¶</a></li>
<li><a href="../zh-CN450810/index.html">é¢è¯•å‰å¿«é€Ÿæ£€æŸ¥ITä¸“å®¶èƒ½åŠ›çš„7ç§æ–¹æ³•</a></li>
<li><a href="../zh-CN450812/index.html">PSR-14-PHPä¸­çš„ä¸»è¦äº‹ä»¶</a></li>
<li><a href="../zh-CN450814/index.html">BGPå¦‚ä½•å·¥ä½œ</a></li>
<li><a href="../zh-CN450816/index.html">è´Ÿè´£çš„å¼€å‘äººå‘˜çš„HTTPæ ‡å¤´</a></li>
<li><a href="../zh-CN450820/index.html">FrontendConfè®¡åˆ’å§”å‘˜ä¼šï¼šæ¡†æ¶ï¼Œè§†é‡ï¼Œä¸–ç•Œç»éªŒå’Œä¼šè®®ä½¿å‘½</a></li>
<li><a href="../zh-CN450822/index.html">æ¶ˆå¤±çš„æ¡†æ¶</a></li>
<li><a href="../zh-CN450824/index.html">CSSçš„çŠ¶æ€</a></li>
<li><a href="../zh-CN450826/index.html">å¦‚ä½•ä¸JSä¸­çš„å¾®æ§åˆ¶å™¨å¯¹è¯</a></li>
<li><a href="../zh-CN450828/index.html">å½“åŸå¸‚å…¥ç¡æ—¶...</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>