<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üôãüèª üî§ ü•Ö Membuat aplikasi mendengarkan untuk melihat lalu lintas MMORPG seluler üí™üèº üòº üöÖ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Ini adalah bagian kedua dari serangkaian artikel tentang analisis lalu lintas jaringan MMORPG seluler. Contoh topik loop: 



1. Format pesan parsing ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Membuat aplikasi mendengarkan untuk melihat lalu lintas MMORPG seluler</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/457480/">  Ini adalah bagian kedua dari serangkaian artikel tentang analisis lalu lintas jaringan MMORPG seluler.  Contoh topik loop: <br><br><ol><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Format pesan parsing antara server dan klien.</a> </li><li>  Menulis aplikasi mendengarkan untuk melihat lalu lintas game dengan cara yang nyaman. </li><li>  Intersepsi lalu lintas dan modifikasinya menggunakan server proxy non-HTTP. </li><li>  Langkah pertama ke server Anda sendiri ("bajakan"). </li></ol><br>  Pada bagian ini saya akan menjelaskan pembuatan aplikasi pendengaran (sniffer), yang akan memungkinkan kita untuk menyaring acara berdasarkan jenis dan sumbernya, menampilkan informasi tentang pesan dan menyimpannya secara selektif untuk dianalisis, dan juga masuk ke file permainan yang dapat dieksekusi ("biner") sedikit. mendukung informasi dan menambahkan dukungan <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Protokol Buffer</a> ke aplikasi.  Tertarik, saya minta kucing. <br><a name="habracut"></a><br><h3>  Alat Dibutuhkan </h3><br>  Untuk dapat mengulangi langkah-langkah yang dijelaskan di bawah ini, Anda perlu: <br><br><ul><li>  Wireshark untuk analisis paket; </li><li>  .NET </li><li>  Pustaka <a href="">PcapDotNet</a> untuk bekerja dengan WinPcap; </li><li>  perpustakaan <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">protobuf-net</a> untuk bekerja dengan Protokol Buffer. </li></ul><br><h3>  Menulis Aplikasi Mendengarkan </h3><br>  Seperti yang kita ingat dari <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">artikel sebelumnya</a> , game berkomunikasi melalui protokol TCP, dan dalam kerangka sesi melakukan hal ini hanya dengan satu server dan satu port.  Untuk dapat menganalisis lalu lintas game, kita perlu melakukan tugas-tugas berikut: <br><br><ul><li>  paket mencegat perangkat seluler; </li><li>  saring paket game; </li><li>  tambahkan data paket selanjutnya ke buffer untuk diproses lebih lanjut; </li><li>  Dapatkan acara game dari buffer saat dihuni. </li></ul><br>  Tindakan ini diimplementasikan di kelas <code>Sniffer</code> , yang menggunakan perpustakaan PcapDotNet untuk mencegat paket.  Dalam metode <code>Sniff</code> , kami meneruskan alamat IP adaptor (pada kenyataannya, ini adalah alamat PC dari mana Wi-Fi didistribusikan untuk perangkat seluler dalam jaringan yang sama), alamat IP perangkat seluler, dan alamat IP server.  Karena ketidakkonsistenan dari dua yang terakhir (setelah berbulan-bulan memonitor berbagai platform dan server, ternyata server dipilih dari kumpulan ~ 50 server, yang masing-masing masih memiliki 5-7 kemungkinan port), saya hanya mengirimkan tiga oktet pertama.  Penggunaan pemfilteran ini terlihat dalam metode <code>IsTargetPacket</code> . <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Sniffer</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[] _data = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[<span class="hljs-number"><span class="hljs-number">4096</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> Active { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> _adapterIP; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> _target; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> _server; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> List&lt;<span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>&gt; _serverBuffer; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> List&lt;<span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>&gt; _clientBuffer; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> LivePacketDevice _device = <span class="hljs-literal"><span class="hljs-literal">null</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> PacketCommunicator _communicator = <span class="hljs-literal"><span class="hljs-literal">null</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Action&lt;Event&gt; _eventCallback = <span class="hljs-literal"><span class="hljs-literal">null</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Sniff</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> ip, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> target, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> server</span></span></span><span class="hljs-function">)</span></span> { _adapterIP = ip; _target = target; _server = server; _serverBuffer = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> List&lt;<span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>&gt;(); _clientBuffer = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> List&lt;<span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>&gt;(); IList&lt;LivePacketDevice&gt; allDevices = LivePacketDevice.AllLocalMachine; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i != allDevices.Count; ++i) { LivePacketDevice device = allDevices[i]; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> address = device.Addresses[<span class="hljs-number"><span class="hljs-number">1</span></span>].Address + <span class="hljs-string"><span class="hljs-string">""</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (address == <span class="hljs-string"><span class="hljs-string">"Internet "</span></span> + _adapterIP) { _device = device; } } _communicator = _device.Open(<span class="hljs-number"><span class="hljs-number">65536</span></span>, PacketDeviceOpenAttributes.Promiscuous, <span class="hljs-number"><span class="hljs-number">1000</span></span>); _communicator.SetFilter(_communicator.CreateFilter(<span class="hljs-string"><span class="hljs-string">"ip and tcp"</span></span>)); <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Thread(() =&gt; { Thread.CurrentThread.IsBackground = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; BeginReceive(); }).Start(); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">BeginReceive</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { _communicator.ReceivePackets(<span class="hljs-number"><span class="hljs-number">0</span></span>, OnReceive); <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> { PacketCommunicatorReceiveResult result = _communicator.ReceivePacket(<span class="hljs-keyword"><span class="hljs-keyword">out</span></span> Packet packet); <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> (result) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> PacketCommunicatorReceiveResult.Timeout: <span class="hljs-keyword"><span class="hljs-keyword">continue</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> PacketCommunicatorReceiveResult.Ok: OnReceive(packet); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } } <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (Active); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">AddEventCallback</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Action&lt;Event&gt; callback</span></span></span><span class="hljs-function">)</span></span> { _eventCallback = callback; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OnReceive</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Packet packet</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Active) { IpV4Datagram ip = packet.Ethernet.IpV4; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (IsTargetPacket(ip)) { <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { ParseData(ip); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (ObjectDisposedException) { } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (EndOfStreamException e) { Console.WriteLine(e); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (Exception) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span>; } } } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">IsTargetPacket</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">IpV4Datagram ip</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> sourceIp = ip.Source.ToString(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> destIp = ip.Destination.ToString(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (sourceIp != _adapterIP &amp;&amp; destIp != _adapterIP) &amp;&amp; ( (sourceIp.StartsWith(_target) &amp;&amp; destIp.StartsWith(_server)) || (sourceIp.StartsWith(_server) &amp;&amp; destIp.StartsWith(_target)) ); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ParseData</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">IpV4Datagram ip</span></span></span><span class="hljs-function">)</span></span> { TcpDatagram tcp = ip.Tcp; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (tcp.Payload != <span class="hljs-literal"><span class="hljs-literal">null</span></span> &amp;&amp; tcp.PayloadLength &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> payload = ExtractPayload(tcp); AddToBuffer(ip, payload); ProcessBuffers(); } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">byte</span></span></span><span class="hljs-function">[] </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ExtractPayload</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">TcpDatagram tcp</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> payloadLength = tcp.PayloadLength; MemoryStream ms = tcp.Payload.ToMemoryStream(); <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[] payload = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[payloadLength]; ms.Read(payload, <span class="hljs-number"><span class="hljs-number">0</span></span>, payloadLength); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> payload; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">AddToBuffer</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">IpV4Datagram ip, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">byte</span></span></span></span><span class="hljs-function"><span class="hljs-params">[] payload</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ip.Destination.ToString().StartsWith(_target)) { <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> <span class="hljs-keyword"><span class="hljs-keyword">value</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> payload) _serverBuffer.Add(<span class="hljs-keyword"><span class="hljs-keyword">value</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> <span class="hljs-keyword"><span class="hljs-keyword">value</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> payload) _clientBuffer.Add(<span class="hljs-keyword"><span class="hljs-keyword">value</span></span>); } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ProcessBuffers</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { ProcessBuffer(<span class="hljs-keyword"><span class="hljs-keyword">ref</span></span> _serverBuffer); ProcessBuffer(<span class="hljs-keyword"><span class="hljs-keyword">ref</span></span> _clientBuffer); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ProcessBuffer</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">ref</span></span></span></span><span class="hljs-function"><span class="hljs-params"> List&lt;</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">byte</span></span></span></span><span class="hljs-function"><span class="hljs-params">&gt; buffer</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-comment"><span class="hljs-comment">// TODO } public void Suspend() { Active = false; } public void Resume() { Active = true; } }</span></span></code> </pre><br>  Hebat, sekarang kami memiliki dua buffer dengan paket data dari klien dan server.  Ingat format acara antara game dan server: <br><br><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Event</span></span></span><span class="hljs-class"> {</span></span> uint payload_length &lt;bgcolor=<span class="hljs-number"><span class="hljs-number">0xFFFF00</span></span>, name=<span class="hljs-string"><span class="hljs-string">"Payload Length"</span></span>&gt;; ushort event_code &lt;bgcolor=<span class="hljs-number"><span class="hljs-number">0xFF9988</span></span>, name=<span class="hljs-string"><span class="hljs-string">"Event Code"</span></span>&gt;; byte payload[payload_length] &lt;name=<span class="hljs-string"><span class="hljs-string">"Event Payload"</span></span>&gt;; };</code> </pre><br>  Berdasarkan ini, Anda dapat membuat kelas acara Acara: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">enum</span></span> EventSource { Client, Server } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">enum</span></span> EventTypes : <span class="hljs-keyword"><span class="hljs-keyword">ushort</span></span> { Movement = <span class="hljs-number"><span class="hljs-number">11</span></span>, Ping = <span class="hljs-number"><span class="hljs-number">30</span></span>, Pong = <span class="hljs-number"><span class="hljs-number">31</span></span>, Teleport = <span class="hljs-number"><span class="hljs-number">63</span></span>, EnterDungeon = <span class="hljs-number"><span class="hljs-number">217</span></span> } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Event</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">uint</span></span> ID; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">uint</span></span> Length { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ushort</span></span> Type { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">uint</span></span> DataLength { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> EventType { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> EventSource Direction { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[] _data; <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> BinaryReader _br = <span class="hljs-literal"><span class="hljs-literal">null</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Event</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">byte</span></span></span></span><span class="hljs-function"><span class="hljs-params">[] data, EventSource direction</span></span></span><span class="hljs-function">)</span></span> { _data = data; _br = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> BinaryReader(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> MemoryStream(_data)); Length = _br.ReadUInt32(); Type = _br.ReadUInt16(); DataLength = <span class="hljs-number"><span class="hljs-number">0</span></span>; EventType = <span class="hljs-string"><span class="hljs-string">$"Unknown (</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{Type}</span></span></span><span class="hljs-string">)"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (IsKnown()) { EventType = ((EventTypes)Type).ToString(); } Direction = direction; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">virtual</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ParseData</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">IsKnown</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Enum.IsDefined(<span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(EventTypes), Type); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">byte</span></span></span><span class="hljs-function">[] </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetPayload</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">bool</span></span></span></span><span class="hljs-function"><span class="hljs-params"> hasDatLength = </span></span><span class="hljs-literal"><span class="hljs-function"><span class="hljs-params"><span class="hljs-literal">true</span></span></span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> payloadLength = _data.Length - (hasDatLength ? <span class="hljs-number"><span class="hljs-number">10</span></span> : <span class="hljs-number"><span class="hljs-number">6</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> List&lt;<span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>&gt;(_data).GetRange(hasDatLength ? <span class="hljs-number"><span class="hljs-number">10</span></span> : <span class="hljs-number"><span class="hljs-number">6</span></span>, payloadLength).ToArray(); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">virtual</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Save</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> path = Path.Combine(AppDomain.CurrentDomain.BaseDirectory, <span class="hljs-string"><span class="hljs-string">"Packets"</span></span>, EventType); Directory.CreateDirectory(path); File.WriteAllBytes(path + <span class="hljs-string"><span class="hljs-string">$"/</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{ID}</span></span></span><span class="hljs-string">.dump"</span></span>, _data); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">string</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ToString</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">$"Type </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{Type}</span></span></span><span class="hljs-string">. Data length: </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{Length}</span></span></span><span class="hljs-string">."</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">ulong</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ReadVLQ</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">bool</span></span></span></span><span class="hljs-function"><span class="hljs-params"> readFlag = </span></span><span class="hljs-literal"><span class="hljs-function"><span class="hljs-params"><span class="hljs-literal">true</span></span></span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (readFlag) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> flag = _br.ReadByte(); } <span class="hljs-keyword"><span class="hljs-keyword">ulong</span></span> vlq = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (i = <span class="hljs-number"><span class="hljs-number">0</span></span>; ; i += <span class="hljs-number"><span class="hljs-number">7</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> x = _br.ReadByte(); vlq |= (<span class="hljs-keyword"><span class="hljs-keyword">ulong</span></span>)(x &amp; <span class="hljs-number"><span class="hljs-number">0x7F</span></span>) &lt;&lt; i; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((x &amp; <span class="hljs-number"><span class="hljs-number">0x80</span></span>) != <span class="hljs-number"><span class="hljs-number">0x80</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> vlq; } }</code> </pre><br>  Kelas <code>Event</code> akan digunakan sebagai kelas dasar untuk semua acara dalam game.  Berikut adalah contoh kelas untuk acara <code>Ping</code> : <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Ping</span></span> : <span class="hljs-title"><span class="hljs-title">Event</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ulong</span></span> _pingTime; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Ping</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">byte</span></span></span></span><span class="hljs-function"><span class="hljs-params">[] data</span></span></span><span class="hljs-function">) : </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">base</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">data, EventSource.Client</span></span></span><span class="hljs-function">)</span></span> { EventType = <span class="hljs-string"><span class="hljs-string">"Ping"</span></span>; DataLength = <span class="hljs-number"><span class="hljs-number">4</span></span>; _pingTime = _br.ReadUInt32(); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">string</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ToString</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">$"Pinging server at </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{_pingTime}</span></span></span><span class="hljs-string">ms."</span></span>; } }</code> </pre><br>  Sekarang kita memiliki kelas acara, kita dapat menambahkan metode ke <code>Sniffer</code> : <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ProcessBuffer</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">ref</span></span></span></span><span class="hljs-function"><span class="hljs-params"> List&lt;</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">byte</span></span></span></span><span class="hljs-function"><span class="hljs-params">&gt; buffer</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (buffer.Count &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (Active) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (buffer.Count &gt; <span class="hljs-number"><span class="hljs-number">4</span></span>) <span class="hljs-comment"><span class="hljs-comment">//  4        ... { var eventLength = BitConverter.ToInt32(buffer.Take(4).ToArray(), 0) + 6; // ...    -   .. +  4  + 2    if (eventLength &gt;= 6 &amp;&amp; buffer.Count &gt;= eventLength) { var eventData = buffer.Take(eventLength).ToArray(); var ev = CreateEvent(eventData, direction); buffer.RemoveRange(0, eventLength); continue; } } break; } } } private Event CreateEvent(byte[] data, EventSource direction) { var ev = new Event(data, direction); var eventType = Enum.GetName(typeof(EventTypes), ev.Type); if (eventType != null) { try { //     (, &lt;code&gt;Ping&lt;/code&gt;). var className = "Events." + eventType; Type t = Type.GetType(className); ev = (Event)Activator.CreateInstance(t, data); } catch (Exception) { //     -   . ev = new Event(data, direction); } finally { } } _eventCallback?.Invoke(ev); return ev; }</span></span></code> </pre><br>  Buat kelas bentuk yang akan memicu penyadapan: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">partial</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">MainForm</span></span> : <span class="hljs-title"><span class="hljs-title">Form</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Sniffer _sniffer = <span class="hljs-literal"><span class="hljs-literal">null</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> List&lt;Event&gt; _events = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> List&lt;Event&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> List&lt;<span class="hljs-keyword"><span class="hljs-keyword">ushort</span></span>&gt; _eventTypesFilter = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> List&lt;<span class="hljs-keyword"><span class="hljs-keyword">ushort</span></span>&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> _showClientEvents = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> _showServerEvents = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> _showUnknownEvents = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> _clearLogsOnRestart = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">uint</span></span> _eventId = <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">InitializeSniffer</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { _sniffer = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Sniffer(); _sniffer.AddEventCallback(NewEventThreaded); _sniffer.Sniff(<span class="hljs-string"><span class="hljs-string">"192.168.137.1"</span></span>, <span class="hljs-string"><span class="hljs-string">"192.168.137."</span></span>, <span class="hljs-string"><span class="hljs-string">"123.45.67."</span></span>); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">NewEventThreaded</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Event ev</span></span></span><span class="hljs-function">)</span></span> { events_table.Invoke(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> NewEventCallback(NewEvent), ev); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">delegate</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">NewEventCallback</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Event ev</span></span></span><span class="hljs-function">)</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">NewEvent</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Event ev</span></span></span><span class="hljs-function">)</span></span> { ev.ID = _eventId++; _events.Add(ev); LogEvent(ev); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">LogEvent</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Event ev</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (FilterEvent(ev)) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> type = ev.GetType(); events_table.Rows.Add(<span class="hljs-number"><span class="hljs-number">1</span></span>); events_table.Rows[events_table.RowCount - <span class="hljs-number"><span class="hljs-number">1</span></span>].Cells[<span class="hljs-number"><span class="hljs-number">0</span></span>].Value = ev.ID; events_table.Rows[events_table.RowCount - <span class="hljs-number"><span class="hljs-number">1</span></span>].Cells[<span class="hljs-number"><span class="hljs-number">1</span></span>].Value = ev.EventType; events_table.Rows[events_table.RowCount - <span class="hljs-number"><span class="hljs-number">1</span></span>].Cells[<span class="hljs-number"><span class="hljs-number">2</span></span>].Value = Enum.GetName(<span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(EventSource), ev.Direction); events_table.Rows[events_table.RowCount - <span class="hljs-number"><span class="hljs-number">1</span></span>].Cells[<span class="hljs-number"><span class="hljs-number">3</span></span>].Value = ev.ToString(); } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ReloadEvents</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { events_table.Rows.Clear(); events_table.Refresh(); <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> ev <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> _events) { LogEvent(ev); } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">FilterEvent</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Event ev</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ( (ev.Direction == EventSource.Client &amp;&amp; _showClientEvents) || (ev.Direction == EventSource.Server &amp;&amp; _showServerEvents) ) &amp;&amp; (_eventTypesFilter.Contains(ev.Type) || (!ev.IsKnown() &amp;&amp; _showUnknownEvents)); } }</code> </pre><br>  Selesai!  Sekarang Anda dapat menambahkan beberapa tabel untuk mengelola daftar acara (melaluinya <code>_eventTypesFilter</code> diisi) dan melihat secara real time (tabel utama <code>events_table</code> ).  Misalnya, saya memfilter menurut kriteria berikut (metode <code>FilterEvent</code> ): <br><br><ul><li>  perlihatkan acara dari klien; </li><li>  tampilkan acara dari server; </li><li>  tampilan peristiwa yang tidak diketahui; </li><li>  Tampilkan acara yang diketahui diketahui. </li></ul><br><h3>  Mempelajari eksekusi game </h3><br>  Meskipun sekarang mungkin untuk menganalisis peristiwa permainan tanpa masalah, ada sejumlah besar pekerjaan manual untuk menentukan tidak hanya arti dari semua kode acara, tetapi juga struktur payload, yang akan sangat sulit, terutama jika itu berubah tergantung pada beberapa bidang.  Saya memutuskan untuk mencari beberapa informasi dalam file permainan yang dapat dieksekusi.  Karena game ini bersifat lintas platform (tersedia untuk Windows, iOS dan Android), opsi berikut tersedia untuk analisis: <br><br><ul><li>  File .exe (saya temukan di jalur C: / Program Files / WindowsApps /% appname% /; </li><li>  file iOS biner yang dienkripsi oleh Apple, tetapi dengan JailBreak Anda bisa mendapatkan versi yang didekripsi menggunakan Crackulous atau sejenisnya; </li><li>  Pustaka bersama Android  Itu terletak di jalur / data / data /% app-vendor-name% / lib /. </li></ul><br>  Karena tidak tahu arsitektur mana yang harus dipilih untuk Android dan iOS, saya mulai dengan file .exe.  Kami memuat biner ke dalam IDA, kami melihat pilihan arsitektur. <br><br><img src="https://habrastorage.org/webt/jb/q6/vh/jbq6vhlp9nqovpae87uka5jrof0.png"><br><br>  Tujuan pencarian kami adalah beberapa baris yang sangat berguna, yang berarti dekompilasi assembler tidak termasuk dalam rencana, tetapi untuk berjaga-jaga, pilih "executable 80386", karena opsi "Binary File" dan "MS-DOS executable" jelas tidak cocok.  Klik "OK", tunggu sampai file dimuat ke dalam database, dan disarankan untuk menunggu sampai analisis file selesai.  Akhir analisis dapat ditemukan oleh fakta bahwa di bilah status di kiri bawah adalah status berikut: <br><br><img src="https://habrastorage.org/webt/yk/__/fb/yk__fbdgrskjle8c5zf6ro0q_f8.png"><br><br>  Pergi ke tab Strings (Lihat / Buka subviews / Strings atau <code>Shift + F12</code> ).  Proses pembuatan garis mungkin memakan waktu.  Dalam kasus saya, ~ 47k baris ditemukan.  Alamat lokasi string memiliki awalan berupa <code>.rdata</code> , <code>.rdata</code> , dan <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">lainnya</a> .  Dalam kasus saya, semua baris "menarik" ada di bagian <code>.rdata</code> , yang ukurannya ~ 44.5k catatan.  Melihat melalui tabel Anda dapat melihat: <br><br><ul><li>  pesan kesalahan dan segmen permintaan selama fase login; </li><li>  string kesalahan dan informasi inisialisasi untuk game, mesin game, antarmuka; </li><li>  banyak sampah; </li><li>  daftar tabel permainan di sisi klien; </li><li>  nilai-nilai yang digunakan mesin game dalam game; </li><li>  daftar efek; </li><li>  daftar besar kunci lokalisasi antarmuka; </li><li>  dll. </li></ul><br>  Akhirnya, semakin dekat ke ujung meja datang apa yang kita cari. <br><br><img src="https://habrastorage.org/webt/ua/jr/sw/uajrsw8i71x33xuhyhmzonprqku.png"><br><br>  Ini adalah daftar kode acara antara klien dan server.  Ini dapat menyederhanakan hidup kita saat mengurai protokol jaringan gim.  Tapi kami tidak akan berhenti di situ!  Penting untuk memeriksa apakah mungkin untuk mendapatkan nilai numerik dari kode acara.  Kita melihat "familiar" dari kode artikel sebelumnya <code>CMSG_PING</code> dan <code>SMSG_PONG</code> , masing-masing dengan kode 30 ( <code>1E <sub>16</sub></code> ) dan 31 ( <code>1F <sub>16</sub></code> ).  Klik dua kali pada baris untuk pergi ke tempat ini dalam kode. <br><br><img src="https://habrastorage.org/webt/la/ro/wj/larowjnopxrmyc53htrzo_-_2zi.png"><br><br>  Memang, segera setelah nilai string kode adalah urutan <code>0x10 0x1E</code> dan <code>0x10 0x1F</code> .  Nah, itu berarti Anda dapat mem-parsing seluruh tabel dan mendapatkan daftar peristiwa dan nilai numeriknya, yang selanjutnya akan menyederhanakan analisis protokol. <br><br>  Sayangnya, versi Windows dari gim ini ketinggalan banyak versi seluler, dan oleh karena itu informasi dari .exe tidak relevan, dan meskipun dapat membantu, Anda tidak boleh bergantung sepenuhnya pada gim tersebut.  Selanjutnya, saya memutuskan untuk mempelajari perpustakaan dinamis dengan Android, seperti yang saya lihat di satu forum bahwa di sana, tidak seperti binari iOS, berisi banyak meta-informasi tentang kelas.  Namun sayang, pencarian di <code>CMSG_PING</code> nilai <code>CMSG_PING</code> tidak memberikan hasil. <br><br>  Tanpa harapan, saya melakukan pencarian yang sama di biner iOS - sulit dipercaya, tetapi data di sana ternyata sama dengan di .exe!  Unggah file ke IDA. <br><br><img src="https://habrastorage.org/webt/la/ro/wj/larowjnopxrmyc53htrzo_-_2zi.png"><br><br>  Saya memilih opsi yang diusulkan pertama, karena saya tidak yakin mana yang dibutuhkan.  Sekali lagi, kami menunggu akhir dari analisis file (biner hampir 4 kali lebih besar dalam ukuran .exe, waktu analisis, tentu saja, juga meningkat).  Kami membuka jendela dengan garis, yang kali ini ternyata 51k.  Melalui <code>Ctrl + F</code> kita mencari <code>CMSG_PING</code> dan ... kita tidak menemukannya.  Memasukkan karakter kode dengan karakter, Anda dapat melihat hasil ini: <br><br><img src="https://habrastorage.org/webt/jk/rz/be/jkrzbe0uvyj2vi2fxphnldc_vki.png"><br><br>  Untuk beberapa alasan, IDA meletakkan seluruh objek <code>Opcode.proto</code> dalam satu baris.  Klik dua kali pada tempat ini dalam kode dan lihat bahwa strukturnya dijelaskan dengan cara yang sama seperti pada file .exe, sehingga Anda dapat memotongnya dan mengonversinya menjadi <code>Enum</code> . <br><br>  Akhirnya, perlu diingat kembali bagaimana, dalam komentar pada artikel sebelumnya, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=" class="user_link">aml</a> menyarankan bahwa struktur pesan dari permainan adalah implementasi dari <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Protokol Buffer</a> .  Jika Anda melihat dengan cermat kode dalam file biner, Anda dapat melihat bahwa deskripsi <code>Opcode</code> juga dalam format ini. <br><br><img src="https://habrastorage.org/webt/a6/pl/bk/a6plbk-pb8ldifrvha6qfqmh0oi.png"><br><br>  Kami akan menulis templat parser untuk 010Editor untuk mendapatkan semua nilai kode. <br><br><div class="spoiler">  <b class="spoiler_title">Diperbarui Dikemas * Jenis Kode untuk 010Editor</b> <div class="spoiler_text">  Perubahan tipe kecil berisi validasi label bidang untuk melewati yang hilang. <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-function">uint </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">PeekTag</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (FTell() == FileSize()) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>; } Varint tag; FSkip(-tag.size); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> tag._ &gt;&gt; <span class="hljs-number"><span class="hljs-number">3</span></span>; } <span class="hljs-function"><span class="hljs-function">struct </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Packed</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(uint fieldNumber)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (PeekTag() != fieldNumber) { <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } Varint key &lt;bgcolor=<span class="hljs-number"><span class="hljs-number">0xFFBB00</span></span>&gt;; local uint wiredType = key._ &amp; <span class="hljs-number"><span class="hljs-number">0x7</span></span>; local uint field = key._ &gt;&gt; <span class="hljs-number"><span class="hljs-number">3</span></span>; local uint size = key.size; <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> (wiredType) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">double</span></span> value; size += <span class="hljs-number"><span class="hljs-number">8</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-number"><span class="hljs-number">5</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> value; size += <span class="hljs-number"><span class="hljs-number">4</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">default</span></span>: Varint value; size += value.size; <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } }; <span class="hljs-function"><span class="hljs-function">struct </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">PackedString</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(uint fieldNumber)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (PeekTag() != fieldNumber) { <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } <span class="hljs-function"><span class="hljs-function">Packed </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">length</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(fieldNumber)</span></span></span></span>; <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> str[length.value._]; };</code> </pre><br></div></div><br><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Code</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-function"><span class="hljs-function">Packed </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">size</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">2</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> &lt;bgcolor</span></span>=<span class="hljs-number"><span class="hljs-number">0x00FF00</span></span>&gt;; <span class="hljs-function"><span class="hljs-function">PackedString </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">code_name</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">1</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> &lt;bgcolor</span></span>=<span class="hljs-number"><span class="hljs-number">0x00FF00</span></span>&gt;; <span class="hljs-function"><span class="hljs-function">Packed </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">code_value</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">2</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> &lt;bgcolor</span></span>=<span class="hljs-number"><span class="hljs-number">0x00FF00</span></span>&gt;; Printf(<span class="hljs-string"><span class="hljs-string">"%s = %d,\n"</span></span>, code_name.str, code_value.value._); <span class="hljs-comment"><span class="hljs-comment">//        Enum }; struct Property { Packed size(5) &lt;bgcolor=0x00FF00&gt;; PackedString prop_name(1) &lt;bgcolor=0x00FF00&gt;; while (FTell() - 0x176526B - prop_name.length.value._ &lt; size.value._) { Code codes &lt;name="Codes"&gt;; } }; struct { FSkip(0x176526B); PackedString object(1) &lt;bgcolor=0x00FF00&gt;; PackedString format(2) &lt;bgcolor=0x00FFFF&gt;; Property prop; } file;</span></span></code> </pre><br>  Hasilnya kira-kira seperti ini: <br><br><img src="https://habrastorage.org/webt/n5/ge/1d/n5ge1dnylry0n2tdskxrvqg9zmy.png"><br><br>  Lebih menarik!  Apakah Anda memperhatikan <code>pb</code> dalam deskripsi objek?  Akan perlu untuk mencari garis lain, tiba-tiba ada banyak objek seperti itu? <br><br><img src="https://habrastorage.org/webt/wf/cp/fx/wfcpfxmh1c6vhwycv9jnp4k9wle.png"><br><br>  Hasilnya sangat tidak terduga.  Tampaknya, file yang dapat dieksekusi permainan tersebut menjelaskan banyak jenis data, termasuk enumerasi dan format pesan antara server dan klien.  Berikut adalah contoh deskripsi tipe yang menggambarkan posisi suatu objek di dunia: <br><br><img src="https://habrastorage.org/webt/jl/br/ix/jlbrixdyltdfgfmzkdoxvl038eg.png"><br><br>  Pencarian cepat mengungkapkan dua tempat besar dengan deskripsi jenis, meskipun pemeriksaan lebih dekat mungkin akan mengungkapkan tempat-tempat kecil lainnya.  Setelah memotongnya, saya menulis skrip kecil di C # untuk memisahkan deskripsi dengan file (dalam struktur ini mirip dengan deskripsi daftar kode acara) - lebih mudah untuk menganalisisnya di 010Editor. <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Program</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Main</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params">[] args</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> br = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> BinaryReader(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> FileStream(<span class="hljs-string"><span class="hljs-string">"./BinaryFile.partX"</span></span>, FileMode.Open)); <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (br.BaseStream.Position &lt; br.BaseStream.Length) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> startOffset = br.BaseStream.Position; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> length = ReadVLQ(br, <span class="hljs-keyword"><span class="hljs-keyword">out</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> size); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> tag = br.ReadByte(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> eventName = br.ReadString(); br.BaseStream.Position = startOffset; File.WriteAllBytes(<span class="hljs-string"><span class="hljs-string">$"./parsed/</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{eventName}</span></span></span><span class="hljs-string">"</span></span>, br.ReadBytes((<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>)length + size + <span class="hljs-number"><span class="hljs-number">1</span></span>)); } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">ulong</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ReadVLQ</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">BinaryReader br, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">out</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> size</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> flag = br.ReadByte(); <span class="hljs-keyword"><span class="hljs-keyword">ulong</span></span> vlq = <span class="hljs-number"><span class="hljs-number">0</span></span>; size = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (i = <span class="hljs-number"><span class="hljs-number">0</span></span>; ; i += <span class="hljs-number"><span class="hljs-number">7</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> x = br.ReadByte(); vlq |= (<span class="hljs-keyword"><span class="hljs-keyword">ulong</span></span>)(x &amp; <span class="hljs-number"><span class="hljs-number">0x7F</span></span>) &lt;&lt; i; size++; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((x &amp; <span class="hljs-number"><span class="hljs-number">0x80</span></span>) != <span class="hljs-number"><span class="hljs-number">0x80</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> vlq; } }</code> </pre><br>  Saya tidak akan menganalisis format untuk menggambarkan struktur secara terperinci, karena  baik itu khusus untuk game yang dimaksud, atau itu adalah format yang diterima secara umum di <code>Protocol Buffers</code> (jika ada yang tahu pasti, harap cantumkan dalam komentar).  Dari apa yang bisa saya deteksi: <br><br><ul><li>  deskripsi juga datang dalam format <code>Protocol Buffers</code> ; </li><li>  deskripsi setiap bidang berisi nama, nomor, dan tipe datanya, yang digunakan tabel jenisnya sendiri: <br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-built_in">string</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">TypeToStr</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(uint type)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> (type) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"Float"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-number"><span class="hljs-number">4</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"UInt64"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-number"><span class="hljs-number">5</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"UInt32"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-number"><span class="hljs-number">8</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"Boolean"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-number"><span class="hljs-number">9</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"String"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-number"><span class="hljs-number">11</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"Struct"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-number"><span class="hljs-number">14</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"Enum"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">default</span></span>: local <span class="hljs-built_in"><span class="hljs-built_in">string</span></span> s; SPrintf(s, <span class="hljs-string"><span class="hljs-string">"%Lu"</span></span>, type); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> s; } };</code> </pre></li><li>  jika tipe data adalah enumerasi atau struktur, maka ada tautan ke objek yang diinginkan. </li></ul><br>  Nah, hal terakhir yang tersisa bagi kita adalah menggunakan informasi yang diterima dalam aplikasi pendengaran kita: pesan parse menggunakan pustaka <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><code>protobuf-net</code></a> .  Hubungkan perpustakaan melalui NuGet, tambahkan <code>using ProtoBuf;</code>  dan Anda bisa membuat kelas untuk menggambarkan pesan.  Ambil satu contoh dari artikel sebelumnya: pergerakan karakter.  Deskripsi format yang diformat saat menyorot segmen terlihat seperti ini: <br><br><img src="https://habrastorage.org/webt/ce/qg/py/ceqgpyfbuxygvoqx4jnlp8slumy.png"><br><br>  Output debug memungkinkan Anda untuk membuat deskripsi singkat dari ini: <br><br><pre> <code class="plaintext hljs">Field 1 (Type 13): time Field 2 (Struct .pb.CxGS_Vec3): position Field 3 (UInt64): guid Field 4 (Struct .pb.CxGS_Vec3): direction Field 5 (Struct .pb.CxGS_Vec3): speed Field 6 (UInt32): state Field 10 (UInt32): flag Field 11 (Float): y_speed Field 12 (Boolean): is_flying Field 7 (UInt32): emote_id Field 9 (UInt32): emote_duration Field 8 (Boolean): emote_loop</code> </pre><br>  Sekarang Anda dapat membuat kelas yang sesuai menggunakan perpustakaan <code>protobuf-net</code> . <br><br><pre> <code class="cs hljs">[<span class="hljs-meta"><span class="hljs-meta">ProtoContract</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">MoveInfo</span></span> : <span class="hljs-title"><span class="hljs-title">ProtoBufEvent</span></span>&lt;<span class="hljs-title"><span class="hljs-title">MoveInfo</span></span>&gt; { [ProtoMember(<span class="hljs-number"><span class="hljs-number">3</span></span>)] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ulong</span></span> GUID; [ProtoMember(<span class="hljs-number"><span class="hljs-number">1</span></span>)] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ulong</span></span> Time; [ProtoMember(<span class="hljs-number"><span class="hljs-number">2</span></span>)] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Vec3 Position; [ProtoMember(<span class="hljs-number"><span class="hljs-number">4</span></span>)] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Vec3 Direction; [ProtoMember(<span class="hljs-number"><span class="hljs-number">5</span></span>)] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Vec3 Speed; [ProtoMember(<span class="hljs-number"><span class="hljs-number">6</span></span>)] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ulong</span></span> State; [ProtoMember(<span class="hljs-number"><span class="hljs-number">7</span></span>, IsRequired = <span class="hljs-literal"><span class="hljs-literal">false</span></span>)] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">uint</span></span> EmoteID; [ProtoMember(<span class="hljs-number"><span class="hljs-number">8</span></span>, IsRequired = <span class="hljs-literal"><span class="hljs-literal">false</span></span>)] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> EmoteLoop; [ProtoMember(<span class="hljs-number"><span class="hljs-number">9</span></span>, IsRequired = <span class="hljs-literal"><span class="hljs-literal">false</span></span>)] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">uint</span></span> EmoteDuration; [ProtoMember(<span class="hljs-number"><span class="hljs-number">10</span></span>, IsRequired = <span class="hljs-literal"><span class="hljs-literal">false</span></span>)] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">uint</span></span> Flag; [ProtoMember(<span class="hljs-number"><span class="hljs-number">11</span></span>, IsRequired = <span class="hljs-literal"><span class="hljs-literal">false</span></span>)] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> SpeedY; [ProtoMember(<span class="hljs-number"><span class="hljs-number">12</span></span>)] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> IsFlying; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">string</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ToString</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">$"</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{GUID}</span></span></span><span class="hljs-string">: </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{Position}</span></span></span><span class="hljs-string">"</span></span>; } }</code> </pre><br>  Sebagai perbandingan, berikut adalah templat untuk acara yang sama dari artikel sebelumnya: <br><br><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MoveEvent</span></span></span><span class="hljs-class"> {</span></span> uint data_length &lt;bgcolor=<span class="hljs-number"><span class="hljs-number">0x00FF00</span></span>, name=<span class="hljs-string"><span class="hljs-string">"Data Length"</span></span>&gt;; Packed move_time &lt;bgcolor=<span class="hljs-number"><span class="hljs-number">0x00FFFF</span></span>&gt;; PackedVector3 position &lt;bgcolor=<span class="hljs-number"><span class="hljs-number">0x00FF00</span></span>&gt;; PackedVector3 direction &lt;bgcolor=<span class="hljs-number"><span class="hljs-number">0x00FF00</span></span>&gt;; PackedVector3 speed &lt;bgcolor=<span class="hljs-number"><span class="hljs-number">0x00FF00</span></span>&gt;; Packed state &lt;bgcolor=<span class="hljs-number"><span class="hljs-number">0x00FF00</span></span>&gt;; };</code> </pre><br>  Saat mewarisi kelas <code>Event</code> , kita bisa mengganti metode <code>ParseData</code> dengan <code>ParseData</code> deserialisasi data paket: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">CMSG_MOVE_INFO</span></span> : <span class="hljs-title"><span class="hljs-title">Event</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> MoveInfo _message; [...] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ParseData</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { _message = MoveInfo.Deserialize(GetPayload()); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">string</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ToString</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> _message.ToString(); } }</code> </pre><br>  Itu saja.  Langkah selanjutnya adalah mengarahkan lalu lintas game ke server proxy kami untuk tujuan injeksi, spoofing, dan memotong paket. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/id457480/">https://habr.com/ru/post/id457480/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../id457464/index.html">Deduplikasi iklan di Yandex.Real Estate</a></li>
<li><a href="../id457466/index.html">Bagaimana kami mengembangkan IT di Leroy Merlin: membangun kembali sebuah mesin saat bepergian</a></li>
<li><a href="../id457468/index.html">Memori universal: SRAM, DRAM, dan memori flash dalam satu botol</a></li>
<li><a href="../id457470/index.html">Matematika daun: bagaimana satu semak yang tidak biasa mengubah persamaan model pertumbuhan tanaman</a></li>
<li><a href="../id457476/index.html">Mengurangi ukuran gambar buruh pelabuhan dengan aplikasi booting pegas</a></li>
<li><a href="../id457490/index.html">Aisioshechka dari Zuckerberg - secara singkat dan dalam kasus Libra</a></li>
<li><a href="../id457494/index.html">"Dan jika aku tidak tahu matematika, apakah aku putus asa?" - spesialis menjawab pertanyaan yang sering diajukan tentang profesi dalam Ilmu Data</a></li>
<li><a href="../id457496/index.html">"Temukan Lima Perbedaan." Perbedaan Scalable dan Generasi - Kumpulan Tes Baru</a></li>
<li><a href="../id457500/index.html">Bagaimana kami melakukan autopilot untuk stasiun layanan</a></li>
<li><a href="../id457502/index.html">Bagaimana Model Penilaian RICE Meningkatkan Prioritas Fitur Produk</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>