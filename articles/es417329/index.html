<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>‚úçüèΩ üèÇüèª üîΩ Usted y Brad Pitt son 99% üï¶ üë©‚Äçüë¶‚Äçüë¶ ‚óæÔ∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="En el departamento de an√°lisis del cine en l√≠nea, Okko ama automatizar el c√°lculo de las tarifas cinematogr√°ficas de Alexander Nevsky tanto como sea p...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Usted y Brad Pitt son 99%</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/okko/blog/417329/"><p><img src="https://habrastorage.org/webt/bg/8z/-p/bg8z-pmvxneor2kulnu9tmg3qoy.jpeg" alt="Ma√±ana de vacaciones"></p><br><p>  En el departamento de an√°lisis del cine en l√≠nea, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Okko</a> ama automatizar el c√°lculo de las tarifas cinematogr√°ficas de Alexander Nevsky tanto como sea posible, y en el tiempo libre para aprender cosas nuevas e implementar cosas interesantes que por alguna raz√≥n generalmente se traducen en bots para Telegram.  Por ejemplo, antes del comienzo de la Copa Mundial de la FIFA 2018, lanzamos un bot al chat de trabajo, que recolect√≥ apuestas sobre la distribuci√≥n de los lugares finales, y despu√©s de la final, calculamos los resultados de acuerdo con una m√©trica pre-inventada y determinamos los ganadores.  Croacia no ha puesto cuatro entre los cuatro primeros. </p><br><p>  Tiempo libre reciente de compilar comedias rusas TOP-10 que dedicamos a crear un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">bot</a> que encuentre una celebridad a la que se parezca m√°s el usuario.  En el chat de trabajo, todos apreciaron tanto la idea que decidimos poner el bot a disposici√≥n del p√∫blico.  En este art√≠culo, recordamos brevemente la teor√≠a, hablamos sobre la creaci√≥n de nuestro bot y c√≥mo hacerlo usted mismo. </p><a name="habracut"></a><br><h1 id="nemnogo-teorii-v-osnovnom-v-kartinkah">  Un poco de teor√≠a (principalmente en im√°genes) </h1><br><p> En detalle sobre c√≥mo se organizan los sistemas de reconocimiento facial, lo mencion√© en <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">uno de mis art√≠culos anteriores</a> .  Un lector interesado puede seguir el enlace, y resumir√© a continuaci√≥n solo los puntos principales. </p><br><p>  Entonces, tienes una fotograf√≠a en la que, tal vez, incluso se muestra una cara y quieres entender de qui√©n es.  Para hacer esto, debe seguir 4 pasos simples: </p><br><ol><li>  Seleccione el rect√°ngulo que bordea la cara. </li><li>  Resalta los puntos clave de la cara. </li><li>  Alinee y recorte su cara. </li><li>  Convierta una imagen de la cara en alguna representaci√≥n interpretada por m√°quina. </li><li>  Compare esta vista con otras que tenga disponibles. </li></ol><br><h3 id="vydelenie-lica">  Selecci√≥n de la cara </h3><br><p>  Aunque las redes neuronales convolucionales han aprendido recientemente c√≥mo encontrar caras en una imagen no peor que los m√©todos cl√°sicos, siguen siendo inferiores al <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">HOG</a> cl√°sico en velocidad y facilidad de uso. </p><br><p>  HOG - Histogramas de gradientes orientados.  Este tipo asocia cada p√≠xel de la imagen de origen con su gradiente, un vector en la direcci√≥n en que el brillo de los p√≠xeles cambia m√°s.  La ventaja de este enfoque es que no le importan los valores absolutos del brillo de los p√≠xeles, solo su relaci√≥n es suficiente.  Por lo tanto, una cara normal, oscura y mal iluminada y ruidosa se mostrar√° en aproximadamente el mismo histograma de gradientes. </p><br><p><img src="https://habrastorage.org/webt/ke/_h/b_/ke_hb_cyd3odkvkwmqb0soancka.png" alt="Histograma de gradientes direccionales"></p><br><p> No es necesario calcular el gradiente para cada p√≠xel, es suficiente calcular el gradiente promedio para cada cuadrado peque√±o <code>n</code> por <code>n</code> .  Usando el campo de vector recibido, puede pasar por un detector con una ventana y determinar para cada ventana qu√© tan probable es la cara en √©l.  El detector puede ser SVM, un bosque aleatorio o cualquier otra cosa. </p><br><p><img src="https://habrastorage.org/webt/mz/hk/2y/mzhk2ycaurneywpy32a0linnm3o.png" alt="Detecci√≥n de rostros"></p><br><h3 id="vydelenie-klyuchevyh-tochek">  Destacar puntos clave </h3><br><p><img src="https://habrastorage.org/webt/wd/bi/dc/wdbidcix45fpf74iglc7f0f1rpg.png" alt="Puntos clave de la cara cara"></p><br><p>  Los puntos clave son puntos que ayudan a identificar a una persona en el espacio.  Los cient√≠ficos d√©biles e inseguros generalmente necesitan 68 puntos clave, y en casos especialmente descuidados, a√∫n m√°s.  Los ni√±os normales y seguros de s√≠ mismos, que ganaban 300k por segundo, siempre ten√≠an suficiente de cinco: las esquinas internas y externas de los ojos y la nariz. </p><br><p><img src="https://habrastorage.org/webt/6t/tb/-8/6ttb-8bq0ugffanbs0qcrihy2a4.jpeg" alt="Viejo meme"></p><br><p>  Dichos puntos pueden extraerse, por ejemplo, mediante una <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">cascada de regresores</a> . </p><br><h3 id="vyravnivanie-lica">  Alineaci√≥n de la cara </h3><br><p>  ¬øAplicaciones pegadas en la infancia?  Aqu√≠ todo es exactamente igual: construyes una transformaci√≥n af√≠n que traduce tres puntos arbitrarios a sus posiciones est√°ndar.  La nariz se puede dejar como est√°, pero para que los ojos cuenten sus centros: estos son los tres puntos listos. </p><br><p><img src="https://habrastorage.org/webt/ms/3q/s7/ms3qs7hagupsaooas-eqrjjmqpy.png" alt="Girar cara cara"></p><br><h3 id="preobrazovanie-izobrazheniya-lica-v-vektor">  Convierte im√°genes faciales a vectores </h3><br><p><img src="https://habrastorage.org/webt/ab/8w/jo/ab8wjody73ybfs_opnftpipbcz0.png" alt="Meme menos viejo"></p><br><p>  Han pasado tres a√±os desde la publicaci√≥n del art√≠culo sobre <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">FaceNet</a> , durante este tiempo aparecieron muchos esquemas de entrenamiento interesantes y funciones de p√©rdida, pero es ella quien domina entre las soluciones OpenSource disponibles.  Aparentemente, todo es una combinaci√≥n de facilidad de comprensi√≥n, implementaci√≥n y resultados decentes.  Gracias al menos por el hecho de que en los √∫ltimos tres a√±os la arquitectura se ha cambiado a ResNet. </p><br><p><img src="https://habrastorage.org/webt/af/pt/cx/afptcx5ixcu2r0_mjkckckpt2zo.jpeg" alt="Nuevo meme"></p><br><p>  FaceNet aprende de triples ejemplos: (ancla, positivo, negativo).  El ancla y los ejemplos positivos pertenecen a una persona, mientras que el negativo se elige como la cara de otra persona, que por alguna raz√≥n la red est√° demasiado cerca de la primera.  La funci√≥n de p√©rdida est√° dise√±ada de tal manera que corrige este malentendido, re√∫ne los ejemplos necesarios y elimina lo innecesario. </p><br><p><img src="https://habrastorage.org/webt/tp/yf/sw/tpyfswhgnyco4w_0ap3zy8i5zhs.png" alt="Guccinet"></p><br><p><img src="https://habrastorage.org/webt/gj/fi/zq/gjfizqzcwjybnypbv-ugovr5hl0.png" alt="Rostros faciales y Dmitry Malikov"></p><br><p>  La salida de la √∫ltima capa de la red se denomina incrustaci√≥n: una representaci√≥n representativa de una persona en un determinado espacio de peque√±a dimensi√≥n (generalmente de 128 dimensiones). </p><br><h3 id="sravnenie-lic">  Comparaci√≥n de rostros </h3><br><p>  La belleza de las incrustaciones bien entrenadas es que las caras de una persona se muestran en un peque√±o vecindario del espacio, alejado de las incrustaciones de las caras de otras personas.  Entonces, para este espacio puede ingresar una medida de similitud, el rec√≠proco de la distancia: Euclidiana o coseno, dependiendo de la distancia a la que se entren√≥ la red. </p><br><p><img src="https://habrastorage.org/webt/pn/u8/ba/pnu8barwdzvdryma24yezil7kvo.jpeg" alt="Un ejemplo completamente artificial de incrustaciones"></p><br><p>  Por lo tanto, de antemano necesitamos construir incrustaciones para todas las personas entre las cuales se realizar√° la b√∫squeda, y luego, para cada solicitud, encontrar el vector m√°s cercano entre ellas.  O, de otra manera, resuelva el problema de encontrar <code>k</code> vecinos m√°s cercanos, donde <code>k</code> puede ser igual a uno, o tal vez no, si queremos utilizar una l√≥gica empresarial m√°s avanzada.  La persona propietaria del vector de resultados ser√° la persona m√°s similar a la persona solicitada. </p><br><p><img src="https://habrastorage.org/webt/6f/uz/nx/6fuznxdig3uiw1mjuv1eezx5h3u.jpeg" alt="Similitud de cara a cara no cara a cara"></p><br><h3 id="kakuyu-biblioteku-ispolzovat">  ¬øQu√© biblioteca usar? </h3><br><p>  La elecci√≥n de las bibliotecas abiertas que implementan varias partes de la tuber√≠a es excelente.  <code>dlib</code> y <code>OpenCV</code> pueden encontrar caras y puntos clave, y se pueden encontrar versiones pre-entrenadas de redes para cualquier marco de red neuronal grande.  Hay un proyecto <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">OpenFace</a> donde puede elegir la arquitectura para sus requisitos de velocidad y calidad.  Pero solo una biblioteca le permite implementar los 5 puntos de reconocimiento facial en llamadas a tres funciones de alto nivel: <code>dlib</code> .  Al mismo tiempo, est√° escrito en C ++ moderno, usa BLAS, tiene un contenedor para Python, no requiere una GPU y funciona bastante r√°pido en una CPU.  Nuestra elecci√≥n recay√≥ en ella. </p><br><h1 id="delaem-sobstvennogo-bota">  Haciendo tu propio bot </h1><br><p>  Esta secci√≥n ya se ha descrito en literalmente todas las gu√≠as para crear bots, pero una vez que escribamos lo mismo, tendremos que repetirla.  Escribimos <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">@BotFather</a> y le pedimos un token para nuestro nuevo bot. </p><br><p><img src="https://habrastorage.org/webt/um/qe/ew/umqeewdk64wtealh1ldudqsv0m8.png" alt="Blur the token xs why"></p><br><p>  El token se parece a esto: <code>643075690:AAFC8ola8WRdhGbJtzjmkOhne1FGfu1BFg</code> .  Es necesario para la autorizaci√≥n en cada solicitud a la API de bot de Telegram. </p><br><p>  Espero que nadie en esta etapa tenga dudas al elegir un lenguaje de programaci√≥n.  Por supuesto, tienes que escribir en Haskell.  Comencemos con el m√≥dulo principal. </p><br><pre> <code class="haskell hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> System.Process main :: IO () main = do (<span class="hljs-title"><span class="hljs-title">_</span></span>, <span class="hljs-title"><span class="hljs-title">_</span></span>, <span class="hljs-title"><span class="hljs-title">_</span></span>, <span class="hljs-title"><span class="hljs-title">handle</span></span>) &lt;- createProcess (<span class="hljs-title"><span class="hljs-title">shell</span></span> "<span class="hljs-title"><span class="hljs-title">python</span></span> <span class="hljs-title"><span class="hljs-title">bot</span></span>.<span class="hljs-title"><span class="hljs-title">py</span></span>") _ &lt;- waitForProcess handle putStrLn "Done!"</code> </pre> <br><p>  Como puede ver en el c√≥digo, en el futuro utilizaremos un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">DSL</a> especial para escribir bots de telegramas.  El c√≥digo en este DSL est√° escrito en archivos separados.  Instale el idioma del dominio y todo lo necesario. </p><br><pre> <code class="bash hljs">python -m venv .env <span class="hljs-built_in"><span class="hljs-built_in">source</span></span> .env/bin/activate pip install python-telegram-bot</code> </pre> <br><p>  <code>python-telegram-bot</code> es actualmente el marco m√°s conveniente para crear bots.  Es f√°cil de aprender, flexible, escalable, admite subprocesos m√∫ltiples.  Desafortunadamente, en este momento no hay un solo marco asincr√≥nico normal y se deben usar hilos antiguos en lugar de las corutinas divinas. </p><br><p><img src="https://habrastorage.org/webt/t2/8b/qv/t28bqvhxxznqmzsobr4hjmuxlta.jpeg" alt="asyncio es mi √∫nico dios"></p><br><p>  Iniciar un bot con <code>python-telegram-bot</code> es f√°cil.  Agregue el siguiente c√≥digo a <code>bot.py</code> </p><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> telegram.ext <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> Updater <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> telegram.ext <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> MessageHandler, Filters <span class="hljs-comment"><span class="hljs-comment">#      TOKEN = '&lt;TOKEN&gt;' def echo(bot, update): bot.send_message(chat_id=update.message.chat_id, text=update.message.text) updater = Updater(token=TOKEN) dispatcher = updater.dispatcher echo_handler = MessageHandler(Filters.text, echo) dispatcher.add_handler(echo_handler)</span></span></code> </pre> <br><p>  Ejecute el bot.  Para fines de depuraci√≥n, esto se puede hacer con el <code>python bot.py</code> sin ejecutar el c√≥digo Haskell. </p><br><p>  Un bot tan simple es capaz de mantener una conversaci√≥n m√≠nima y, por lo tanto, se puede organizar f√°cilmente para que funcione como desarrollador front-end. </p><br><p><img src="https://habrastorage.org/webt/xs/pk/sm/xspksm1d8ehnslmqjsj33dzyekm.png" alt="Di√°logo t√≠pico con el distribuidor front-end"></p><br><p>  Pero la interfaz de los desarrolladores ya es demasiado, por lo que la eliminaremos lo antes posible y procederemos a implementar la funcionalidad principal.  Por simplicidad, nuestro bot solo responder√° a mensajes que contengan fotos e ignorar√° cualquier otro.  Cambie el c√≥digo a lo siguiente. </p><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> telegram.ext <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> Updater <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> telegram.ext <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> MessageHandler, Filters <span class="hljs-comment"><span class="hljs-comment">#      TOKEN = '&lt;TOKEN&gt;' def handle_photo(bot, update): bot.send_message(chat_id=update.message.chat_id, text='nice') updater = Updater(token=TOKEN) dispatcher = updater.dispatcher photo_handler = MessageHandler(Filters.photo, handle_photo) dispatcher.add_handler(photo_handler) updater.start_polling() updater.idle()</span></span></code> </pre> <br><p><img src="https://habrastorage.org/webt/-8/1k/hq/-81khq5z9redcz29_ut7sunfrpg.png" alt="Ya no soy un desarrollador front-end"></p><br><p>  Cuando la imagen ingresa al servidor de Telegram, se ajusta autom√°ticamente a varios tama√±os predeterminados.  El bot, a su vez, puede descargar una imagen de cualquier tama√±o de las que figuran en el <code>message.photo</code> Lista de <code>message.photo</code> ordenada en orden ascendente.  La opci√≥n m√°s f√°cil: tomar la imagen m√°s grande.  Por supuesto, en un entorno de supermercado, debe pensar en la carga de la red y el tiempo de carga y elegir una imagen del tama√±o m√≠nimo adecuado.  Agregue el c√≥digo de descarga de la imagen en la parte superior de la funci√≥n <code>handle_photo</code> . </p><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> io</code> </pre> <br><pre> <code class="python hljs">message = update.message photo = message.photo[~<span class="hljs-number"><span class="hljs-number">0</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> io.BytesIO() <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> fd: file_id = bot.get_file(photo.file_id) file_id.download(out=fd) fd.seek(<span class="hljs-number"><span class="hljs-number">0</span></span>)</code> </pre> <br><p>  La imagen ha sido descargada y est√° en la memoria.  Para interpretarlo y presentarlo en forma de matriz de intensidad de p√≠xeles, utilizamos las bibliotecas <code>Pillow</code> y <code>numpy</code> . </p><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> PIL <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> Image <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> numpy <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> np</code> </pre> <br><p>  El siguiente c√≥digo debe agregarse al bloque <code>with</code> . </p><br><pre> <code class="python hljs">image = Image.open(fd) image.load() image = np.asarray(image)</code> </pre> <br><p>  Ha llegado el momento dlib.  Fuera de la funci√≥n, cree un detector de rostros. </p><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> dlib</code> </pre> <br><pre> <code class="python hljs">face_detector = dlib.get_frontal_face_detector()</code> </pre> <br><p>  Y dentro de la funci√≥n la usamos. </p><br><pre> <code class="python hljs">face_detects = face_detector(image, <span class="hljs-number"><span class="hljs-number">1</span></span>)</code> </pre> <br><p>  El segundo par√°metro de la funci√≥n significa la ampliaci√≥n que debe aplicarse antes de intentar detectar caras.  Cuanto m√°s grande sea, m√°s peque√±as y complejas ser√°n las caras que el detector podr√° detectar, pero m√°s tiempo funcionar√°.  <code>face_detects</code> : una lista de caras ordenadas en orden descendente de la confianza del detector de que la cara est√° frente a ella.  En una aplicaci√≥n real, lo m√°s probable es que desee aplicar alguna l√≥gica de elecci√≥n de la persona principal, y en el estudio de caso nos limitaremos a elegir la primera. </p><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> face_detects: bot.send_message(chat_id=update.message.chat_id, text=<span class="hljs-string"><span class="hljs-string">'no faces'</span></span>) face = face_detects[<span class="hljs-number"><span class="hljs-number">0</span></span>]</code> </pre> <br><p>  Pasamos a la siguiente etapa: la b√∫squeda de puntos clave.  Descargue el <a href="">modelo entrenado</a> y mueva su carga fuera de la funci√≥n. </p><br><pre> <code class="python hljs">shape_predictor = dlib.shape_predictor(<span class="hljs-string"><span class="hljs-string">'path/to/shape_predictor_5_face_landmarks.dat'</span></span>)</code> </pre> <br><p>  Encuentra los puntos clave. </p><br><pre> <code class="python hljs">landmarks = shape_predictor(image, face)</code> </pre> <br><p>  Lo √∫nico que queda es peque√±o: para enderezar la cara, conducirla a trav√©s de ResNet y obtener una incrustaci√≥n de 128 dimensiones.  Afortunadamente, dlib le permite hacer todo esto con una sola llamada.  Solo necesita descargar el <a href="">modelo previamente entrenado</a> . </p><br><pre> <code class="python hljs">face_recognition_model = dlib.face_recognition_model_v1(<span class="hljs-string"><span class="hljs-string">'path/to/dlib_face_recognition_resnet_model_v1.dat'</span></span>)</code> </pre> <br><pre> <code class="python hljs">embedding = face_recognition_model.compute_face_descriptor(image, landmarks) embedding = np.asarray(embedding)</code> </pre> <br><p>  Solo mira en qu√© maravilloso momento vivimos.  Toda la complejidad de las redes neuronales convolucionales, el m√©todo del vector de soporte y las transformaciones afines aplicadas al reconocimiento facial se encapsulan en tres llamadas a la biblioteca. </p><br><p>  Como todav√≠a no sabemos c√≥mo hacer nada significativo, regresemos al usuario el valor promedio de su incrustaci√≥n, multiplicado por mil. </p><br><pre> <code class="python hljs">bot.send_message( chat_id=update.message.chat_id, text=<span class="hljs-string"><span class="hljs-string">f'yours embedding mean: </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{embedding.mean() * </span></span><span class="hljs-number"><span class="hljs-string"><span class="hljs-subst"><span class="hljs-number">1e3</span></span></span></span><span class="hljs-string"><span class="hljs-subst">:</span></span><span class="hljs-number"><span class="hljs-string"><span class="hljs-subst"><span class="hljs-number">.2</span></span></span></span><span class="hljs-string"><span class="hljs-subst">f}</span></span></span><span class="hljs-string">'</span></span> )</code> </pre> <br><p><img src="https://habrastorage.org/webt/ud/av/o6/udavo6i5srwrl93jbopenn84tae.png" alt="No se lo que estoy haciendo"></p><br><p>  Para que nuestro bot pueda determinar cu√°les de las celebridades son los usuarios, ahora necesitamos encontrar al menos una foto de cada celebridad, construir una incrustaci√≥n en ella y guardarla en alg√∫n lugar.  Agregaremos solo 10 celebridades a nuestro robot de entrenamiento, encontrando sus fotos a mano y coloc√°ndolas en el directorio de <code>photos</code> .  As√≠ es como deber√≠a verse: </p><br><p><img src="https://habrastorage.org/webt/yz/rd/1o/yzrd1ockvqezvybwzo-yulsivqq.png" alt="Mira, no ten√≠a suficiente dinero para una MacBook."></p><br><p>  Si desea tener un mill√≥n de celebridades en la base de datos, todo se ver√° exactamente igual, solo que hay m√°s archivos y es poco probable que pueda buscarlos con sus manos.  Ahora <code>build_embeddings.py</code> utilidad <code>build_embeddings.py</code> usando las llamadas <code>dlib</code> que ya conocemos y <code>dlib</code> las incrustaciones de celebridades junto con sus nombres en formato binario. </p><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> os <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> dlib <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> numpy <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> np <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> pickle <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> PIL <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> Image face_detector = dlib.get_frontal_face_detector() shape_predictor = dlib.shape_predictor(<span class="hljs-string"><span class="hljs-string">'assets/shape_predictor_5_face_landmarks.dat'</span></span>) face_recognition_model = dlib.face_recognition_model_v1(<span class="hljs-string"><span class="hljs-string">'assets/dlib_face_recognition_resnet_model_v1.dat'</span></span>) fs = os.listdir(<span class="hljs-string"><span class="hljs-string">'photos'</span></span>) es = [] <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> f <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> fs: print(f) image = np.asarray(Image.open(os.path.join(<span class="hljs-string"><span class="hljs-string">'photos'</span></span>, f))) face_detects = face_detector(image, <span class="hljs-number"><span class="hljs-number">1</span></span>) face = face_detects[<span class="hljs-number"><span class="hljs-number">0</span></span>] landmarks = shape_predictor(image, face) embedding = face_recognition_model.compute_face_descriptor(image, landmarks, num_jitters=<span class="hljs-number"><span class="hljs-number">10</span></span>) embedding = np.asarray(embedding) name, _ = os.path.splitext(f) es.append((name, embedding)) <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> open(<span class="hljs-string"><span class="hljs-string">'assets/embeddings.pickle'</span></span>, <span class="hljs-string"><span class="hljs-string">'wb'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> f: pickle.dump(es, f)</code> </pre> <br><p>  Agregue carga de incrustaci√≥n a nuestro c√≥digo bot. </p><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> pickle</code> </pre> <br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">with</span></span> open(<span class="hljs-string"><span class="hljs-string">'assets/embeddings.pickle'</span></span>, <span class="hljs-string"><span class="hljs-string">'rb'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> f: star_embeddings = pickle.load(f)</code> </pre> <br><p>  Y mediante una b√∫squeda exhaustiva, descubriremos qui√©n es nuestro usuario. </p><br><pre> <code class="python hljs">ds = [] <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> name, emb <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> star_embeddings: distance = np.linalg.norm(embedding - emb) ds.append((name, distance)) best_match, best_distance = min(ds, key=itemgetter(<span class="hljs-number"><span class="hljs-number">1</span></span>)) bot.send_message( chat_id=update.message.chat_id, text=<span class="hljs-string"><span class="hljs-string">f'your look exactly like *</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{best_match}</span></span></span><span class="hljs-string">*'</span></span>, parse_mode=<span class="hljs-string"><span class="hljs-string">'Markdown'</span></span> )</code> </pre> <br><p>  Tenga en cuenta que usamos la distancia euclidiana como la distancia, porque  la red en dlib fue entrenada precisamente con la ayuda de ella. </p><br><p><img src="https://habrastorage.org/webt/yd/fl/wi/ydflwigundswx6_qbctjir_itge.png" alt="Me decepcion√≥ el art√≠culo"></p><br><p>  Eso es todo, felicidades!  Hemos creado un bot simple que puede determinar qu√© celebridad es el usuario.  Queda por encontrar m√°s fotos, agregar marcas, escalabilidad, una pizca de registro y todo se puede lanzar en producci√≥n.  Todos estos temas son demasiado voluminosos para hablar en detalle con grandes listas de c√≥digos, por lo que esbozar√© los puntos principales en el formato de preguntas y respuestas en la siguiente secci√≥n. </p><br><p>  El c√≥digo completo del bot de entrenamiento est√° disponible en <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">GitHub</a> . </p><br><h1 id="rasskazyvaem-pro-nashego-bota">  Hablamos de nuestro bot </h1><br><h3 id="skolko-u-vas-v-baze-znamenitostey-gde-vy-ih-nashli">  ¬øCu√°ntas celebridades tienes en tu base de datos?  ¬øD√≥nde los encontraste? </h3><br><p>  La decisi√≥n m√°s l√≥gica al crear el bot parec√≠a tomar datos de celebridades de nuestra base de contenido interna.  Ella, en el formato del gr√°fico, almacena pel√≠culas y todas las entidades asociadas con pel√≠culas, incluidos actores y directores.  Para cada persona, conocemos su nombre, nombre de usuario y contrase√±a de iCloud, pel√≠culas relacionadas y alias, que se pueden utilizar para generar enlaces al sitio.  Despu√©s de limpiar y extraer solo la informaci√≥n necesaria, el archivo <code>json</code> permanece de la siguiente manera: </p><br><pre> <code class="json hljs">[ { <span class="hljs-attr"><span class="hljs-attr">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">" "</span></span>, <span class="hljs-attr"><span class="hljs-attr">"alias"</span></span>: <span class="hljs-string"><span class="hljs-string">"tilda-swinton"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"role"</span></span>: <span class="hljs-string"><span class="hljs-string">"actor"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"n_movies"</span></span>: <span class="hljs-number"><span class="hljs-number">14</span></span> }, { <span class="hljs-attr"><span class="hljs-attr">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">" "</span></span>, <span class="hljs-attr"><span class="hljs-attr">"alias"</span></span>: <span class="hljs-string"><span class="hljs-string">"michael-shannon"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"role"</span></span>: <span class="hljs-string"><span class="hljs-string">"actor"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"n_movies"</span></span>: <span class="hljs-number"><span class="hljs-number">22</span></span> }, ... ]</code> </pre> <br><p>  Hab√≠a <strong>22,000</strong> entradas de este tipo en el cat√°logo.  Por cierto, no un cat√°logo, sino un cat√°logo. </p><br><h3 id="gde-nayti-fotografii-dlya-vseh-etih-lyudey">  ¬øD√≥nde encontrar fotos para todas estas personas? </h3><br><p><img src="https://habrastorage.org/webt/_n/5i/pl/_n5iplsi4yqnrm2lpvzyjwhjigm.jpeg" alt="En tiempos peligrosos vivimos"></p><br><p>  Bueno, ya sabes, <em>aqu√≠ y all√°</em> .  Hay, por ejemplo, una <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">biblioteca maravillosa</a> que te permite subir resultados de consultas de im√°genes desde Google.  22 mil personas, no tantas, con 56 transmisiones que logramos descargar fotos para ellos en menos de una hora. </p><br><p>  Entre las fotos descargadas, debe descartar fotos rotas y ruidosas en el formato incorrecto.  Luego, deje solo aquellos donde hay caras y donde estas caras satisfacen ciertas condiciones: la distancia m√≠nima entre los ojos, la inclinaci√≥n de la cabeza.  Todo esto nos deja con <strong>12,000</strong> fotos. </p><br><p>  De los 12 mil famosos, los usuarios han encontrado solo 2 en este momento, es decir, hay aproximadamente 8 mil famosos que todav√≠a no son como nadie.  ¬°No lo dejes as√≠!  Abre telegramas y encu√©ntralos a todos. </p><br><h3 id="kak-opredelit-procent-shozhesti-dlya-evklidovoy-distancii">  ¬øC√≥mo determinar el porcentaje de similitud para la distancia euclidiana? </h3><br><p>  Gran pregunta!  De hecho, la distancia euclidiana, en contraste con el coseno, no est√° limitada anteriormente.  Por lo tanto, surge una pregunta razonable, ¬øc√≥mo mostrarle al usuario algo m√°s significativo que "Felicitaciones, la distancia entre su incrustaci√≥n y la incrustaci√≥n de Angelina Jolie es 0.27635462738"?  Uno de los miembros de nuestro equipo propuso la siguiente soluci√≥n simple e ingeniosa.  Si construye la distribuci√≥n de distancias entre las incrustaciones, ser√° normal.  Entonces, para √©l, puede calcular el promedio y la desviaci√≥n est√°ndar, y luego, para cada usuario, de acuerdo con estos par√°metros, considere <em>cu√°nto porcentaje de personas se parecen menos a sus celebridades que √©l</em> .  Esto es equivalente a integrar una funci√≥n de densidad de probabilidad de <code>d</code> a m√°s infinito, donde <code>d</code> es la distancia entre el usuario y las manifestaciones de celebridades. </p><br><p><img src="https://habrastorage.org/webt/fh/yc/4r/fhyc4r87otryweg9v-xznackhfq.png" alt="Esto no nace"></p><br><p>  Aqu√≠ est√° la funci√≥n exacta que usamos: </p><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">_transform_dist_to_sim</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, dist)</span></span></span><span class="hljs-function">:</span></span> p = <span class="hljs-number"><span class="hljs-number">0.5</span></span> * (<span class="hljs-number"><span class="hljs-number">1</span></span> + erf((dist - self._dist_mean) / (self._dist_std * <span class="hljs-number"><span class="hljs-number">1.4142135623730951</span></span>))) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> max(min(<span class="hljs-number"><span class="hljs-number">1</span></span> - p, <span class="hljs-number"><span class="hljs-number">1.0</span></span>), self._min_similarity)</code> </pre> <br><h3 id="neuzheli-nuzhno-perebirat-spisok-vseh-embedingov-chtoby-nayti-sovpadenie">  ¬øEs realmente necesario iterar sobre la lista de todos los sindicatos para encontrar una coincidencia? </h3><br><p>  Por supuesto que no, esto no es √≥ptimo y lleva mucho tiempo.  La forma m√°s f√°cil de optimizar los c√°lculos es usar operaciones matriciales.  En lugar de restar vectores entre s√≠, puede componer una matriz de ellos y restar un vector de la matriz, y luego calcular la norma L2 en filas. </p><br><pre> <code class="python hljs">scores = np.linalg.norm(emb - embeddings, axis=<span class="hljs-number"><span class="hljs-number">1</span></span>) best_idx = scores.argmax()</code> </pre> <br><p>  Esto ya da un gran aumento en la productividad, pero resulta que puedes hacerlo a√∫n m√°s r√°pido.  La b√∫squeda puede acelerarse significativamente al perder un poco su precisi√≥n utilizando la biblioteca <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">nmslib</a> .  Utiliza el m√©todo <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">HNSW</a> para aproximar la b√∫squeda de <code>k</code> vecinos m√°s cercanos.  Para todos los vectores disponibles, se debe construir un denominado √≠ndice, en el que luego se realizar√° una b√∫squeda.  Puede crear y guardar el √≠ndice para la distancia euclidiana de la siguiente manera: </p><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> nmslib index = nmslib.init(method=<span class="hljs-string"><span class="hljs-string">'hnsw'</span></span>, space=<span class="hljs-string"><span class="hljs-string">'l2'</span></span>, data_type=nmslib.DataType.DENSE_VECTOR) <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> idx, emb <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> enumerate(embeddings): index.addDataPoint(idx, emb) index_time_params = { <span class="hljs-string"><span class="hljs-string">'indexThreadQty'</span></span>: <span class="hljs-number"><span class="hljs-number">4</span></span>, <span class="hljs-string"><span class="hljs-string">'skip_optimized_index'</span></span>: <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-string"><span class="hljs-string">'post'</span></span>: <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-string"><span class="hljs-string">'delaunay_type'</span></span>: <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-string"><span class="hljs-string">'M'</span></span>: <span class="hljs-number"><span class="hljs-number">100</span></span>, <span class="hljs-string"><span class="hljs-string">'efConstruction'</span></span>: <span class="hljs-number"><span class="hljs-number">2000</span></span> } index.createIndex(index_time_params, print_progress=<span class="hljs-keyword"><span class="hljs-keyword">True</span></span>) index.saveIndex(<span class="hljs-string"><span class="hljs-string">'./assets/embeddings.bin'</span></span>)</code> </pre> <br><p>  Los par√°metros <code>M</code> y <code>efConstruction</code> se describen en detalle en la <a href="">documentaci√≥n</a> y se seleccionan experimentalmente seg√∫n la precisi√≥n requerida, el tiempo de construcci√≥n del √≠ndice y la velocidad de b√∫squeda.  Antes de usar el √≠ndice, debe descargar: </p><br><pre> <code class="python hljs">index = nmslib.init(method=<span class="hljs-string"><span class="hljs-string">'hnsw'</span></span>, space=<span class="hljs-string"><span class="hljs-string">'l2'</span></span>, data_type=nmslib.DataType.DENSE_VECTOR) index.loadIndex(<span class="hljs-string"><span class="hljs-string">'./assets/embeddings.bin'</span></span>) query_time_params = {<span class="hljs-string"><span class="hljs-string">'efSearch'</span></span>: <span class="hljs-number"><span class="hljs-number">400</span></span>} index.setQueryTimeParams(query_time_params)</code> </pre> <br><p>  El par√°metro <code>efSearch</code> afecta la precisi√≥n y la velocidad de las consultas y puede no coincidir con la <code>efConstruction</code> .  Ahora puedes hacer solicitudes. </p><br><pre> <code class="python hljs">ids, dists = index.knnQuery(embedding, k=<span class="hljs-number"><span class="hljs-number">1</span></span>) best_dx = ids[<span class="hljs-number"><span class="hljs-number">0</span></span>] best_dist = dists[<span class="hljs-number"><span class="hljs-number">0</span></span>]</code> </pre> <br><p>  En nuestro caso, <code>nmslib</code> es 20 veces m√°s r√°pido que la versi√≥n lineal vectorizada, y una solicitud se procesa en promedio <code>0.005</code> segundos. </p><br><h3 id="kak-sdelat-moego-bota-gotovym-k-prodakshenu">  ¬øC√≥mo preparar mi bot para la producci√≥n? </h3><br><h5 id="1-asinhronnost">  1. Asincron√≠a </h5><br><p>  Primero, debe hacer que la funci√≥n <code>handle_photo</code> as√≠ncrona.  Como ya dije, <code>python-telegram-bot</code> ofrece multihilo para esto e implementa un decorador conveniente. </p><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> telegram.ext.dispatcher <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> run_async @run_async <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">handle_photo</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(bot, update)</span></span></span><span class="hljs-function">:</span></span> ...</code> </pre> <br><p>  Ahora, el marco en s√≠ lanzar√° su controlador en un hilo separado en su grupo.  El tama√±o del grupo se establece al crear el <code>Updater</code> .  "¬°Pero en Python no hay multihilo!"  el m√°s impaciente de ustedes ya ha exclamado.  Y esto no es del todo cierto.  Debido a <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">GIL,</a> el c√≥digo Python normal realmente no se puede ejecutar en paralelo, pero GIL se libera para esperar todas las operaciones de E / S, y tambi√©n puede ser liberado por bibliotecas que usan extensiones C. </p><br><p>  Ahora analice nuestra funci√≥n <code>handle_photo</code> : solo consiste en esperar las operaciones de E / S (cargar una foto, enviar una respuesta, leer una foto desde el disco, etc.) y llamar a funciones desde las <code>numpy</code> , <code>nmslib</code> y <code>Pillow</code> . </p><br><p>  No mencion√© <code>dlib</code> por una raz√≥n.  No es necesario que la biblioteca que llama al c√≥digo nativo libere el GIL y <code>dlib</code> bien.  Ella no necesita esta cerradura, simplemente no la deja ir.  El autor <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">dice</a> que con mucho gusto aceptar√° la solicitud de extracci√≥n apropiada, pero soy demasiado vago. </p><br><h5 id="2-mnogoprocessnost">  2. Multiprocesamiento </h5><br><p>  La forma m√°s f√°cil de lidiar con <code>dlib</code> es encapsular el modelo en una entidad separada y ejecutarlo en un proceso separado.  Y mejor en el grupo de procesos. </p><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">_worker_initialize</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(config)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">global</span></span> model model = Model(config) model.load_state() <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">_worker_do</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(image)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> model.process_image(image) pool = multiprocessing.Pool(<span class="hljs-number"><span class="hljs-number">8</span></span>, initializer=_worker_initialize, initargs=(config,))</code> </pre> <br><pre> <code class="python hljs">result = pool.apply(_worker_do, (image,))</code> </pre> <br><h5 id="3-zhelezo">  3. hierro </h5><br><p>  Si su bot necesita leer constantemente fotos de un disco, aseg√∫rese de que el disco sea un SSD.  O incluso montarlos en la RAM.  Hacer ping a los servidores de telegramas y la calidad del canal tambi√©n es importante. </p><br><h5 id="4-flood-control">  4. Control de inundaciones </h5><br><p>  Los telegramas no permiten que los bots env√≠en m√°s de 30 mensajes por segundo.  Si su bot es popular y mucha gente lo usa al mismo tiempo, entonces es muy f√°cil obtener una prohibici√≥n por unos segundos, lo que resultar√° decepcionante para la expectativa de muchos usuarios.  Para resolver este problema, <code>python-telegram-bot</code> nos ofrece una cola que no puede enviar m√°s del l√≠mite de mensaje especificado por segundo, manteniendo intervalos iguales entre env√≠os. </p><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> telegram.ext.messagequeue <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> MessageQueue</code> </pre> <br><p>  Para usarlo, debe definir su propio bot y reemplazarlo al crear <code>Updater</code> . </p><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> telegram.utils.promise <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> Promise <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MQBot</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(Bot)</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__init__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, *args, **kwargs)</span></span></span><span class="hljs-function">:</span></span> super().__init__(*args, **kwargs) self._message_queue = MessageQueue( all_burst_limit=<span class="hljs-number"><span class="hljs-number">30</span></span>, all_time_limit_ms=<span class="hljs-number"><span class="hljs-number">1000</span></span> ) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__del__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">try</span></span>: self._message_queue.stop() <span class="hljs-keyword"><span class="hljs-keyword">finally</span></span>: super().__del__() <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">send_message</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, *args, **kwargs)</span></span></span><span class="hljs-function">:</span></span> is_group = kwargs.get(<span class="hljs-string"><span class="hljs-string">'chat_id'</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>) &gt;= <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> self._message_queue(Promise(super().send_message, args, kwargs), is_group)</code> </pre> <br><pre> <code class="python hljs">bot = MQBot(token=TOKEN) updater = Updater(bot=bot)</code> </pre> <br><h5 id="5-web-hooks">  5. Ganchos web </h5><br><p>  En un entorno de producto, Web Hooks siempre debe usarse en lugar de Long Polling como una forma de recibir actualizaciones de los servidores de Telegram.  De qu√© se trata y c√≥mo usarlo se puede leer <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">aqu√≠</a> . </p><br><h5 id="6-melochi">  6. Trivia </h5><br><p>              <code>json</code> .    ,      <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">ultrajson</a> . </p><br><p>          IO-:    ,  ,  .      ,         . </p><br><h5 id="6-analitika"> 6.  </h5><br><p>   ,   .        ,   ,  ,       .        ,        . </p><br><p> , ,      BI-tool <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Splunk</a>     . </p><br><p><img src="https://habrastorage.org/webt/oh/8e/ve/oh8eve_hczr4pahrzum56fonxxg.jpeg" alt="Tabl√≥n de publicidad (exti√©ndanos una licencia)"></p><br><p>   ,         .     ,                       . </p><br><p>    ,         .      ,    : <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">@OkkoFaceBot</a> . </p><br><p><del>        </del> ,     . ,      . </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/es417329/">https://habr.com/ru/post/es417329/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../es417319/index.html">Sistemas en el caso o lo que realmente est√° bajo la cubierta del microprocesador</a></li>
<li><a href="../es417321/index.html">¬øC√≥mo buscamos maestros de cursos en l√≠nea entre desarrolladores?</a></li>
<li><a href="../es417323/index.html">Problemas para garantizar el 100% de accesibilidad del proyecto</a></li>
<li><a href="../es417325/index.html">Jornada de puertas abiertas de netrolog√≠a, tema de ciencia de datos</a></li>
<li><a href="../es417327/index.html">Supervisi√≥n del presupuesto de temperatura en la sala de servidores (MP707 + nettop con Linux + PRTG)</a></li>
<li><a href="../es417331/index.html">Semana de la seguridad 26: espectro actualizado, ahora grabaci√≥n de buen gusto</a></li>
<li><a href="../es417333/index.html">Calificaci√≥n social</a></li>
<li><a href="../es417337/index.html">Principios de funcionamiento y caracter√≠sticas de aplicaci√≥n del intercambio at√≥mico</a></li>
<li><a href="../es417339/index.html">3DTouch - Escalas en iPhone: finalizaci√≥n</a></li>
<li><a href="../es417345/index.html">B√∫squeda de amenazas con visibilidad de Cisco</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>