<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🍩 🚱 🖖🏿 Sistema ISP, perdona y adiós! Por qué y cómo escribimos nuestro panel de control del servidor 💯 🦔 💇🏽</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hola Somos "Hosting Technologies" y hace 5 años lanzamos VDSina , el primer hosting vds creado específicamente para desarrolladores. Nos esforzamos pa...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Sistema ISP, perdona y adiós! Por qué y cómo escribimos nuestro panel de control del servidor</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/vdsina/blog/460107/"><img src="https://habrastorage.org/webt/af/l8/yk/afl8yk6hovufiwx1ml-8cwcgaoy.png" alt="imagen"><br><br>  Hola  Somos "Hosting Technologies" y hace 5 años lanzamos <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">VDSina</a> , el primer hosting vds creado específicamente para desarrolladores.  Nos esforzamos para que sea conveniente, como DigitalOcean, pero con soporte ruso, métodos de pago y servidores en Rusia.  Pero DigitalOcean no es solo fiabilidad y precio, también es un servicio. <br><br>  El software de ISPsystem resultó ser una cuerda que nos ató las manos en el camino hacia un servicio genial.  Hace tres años, utilizamos la facturación de Billmanager y el panel de control del servidor VMmanager y rápidamente nos dimos cuenta de que es casi imposible proporcionar un buen servicio sin nuestro propio panel. <br><a name="habracut"></a><br><br><h2>  Cómo el sistema ISP mató la usabilidad </h2><br>  <b>Bichos</b> <br><br>  No pudimos solucionar el error nosotros mismos, cada vez que teníamos que escribir en el soporte de otra persona y esperar.  La solución a cualquier problema requería la respuesta de una empresa externa. <br><br>  El soporte del sistema ISP respondió normalmente, pero las correcciones solo llegaron a través de algunas versiones, y no siempre y no todas.  A veces se corrigieron errores críticos durante varias semanas.  Tuvimos que tranquilizar a los clientes, disculparnos y esperar a que el sistema ISP solucione el error. <br><br>  <b>Amenaza de tiempo de inactividad</b> <br><br>  Las actualizaciones podrían dar lugar a tiempos de inactividad impredecibles que provocaron nuevos errores. <br><br>  Cada actualización era una lotería: era necesario cubrir la facturación y hacer sacrificios a los dioses de las actualizaciones; un par de veces la actualización causó un tiempo de inactividad de 10 a 15 minutos.  En ese momento, nuestros administradores se estaban volviendo grises ante nuestros ojos: nunca supimos cuánto tiempo duraría el tiempo de inactividad y no podíamos predecir cuándo ISPsystem decidió lanzar una nueva actualización. <br><br>  En la quinta generación, Billmanager mejoró, pero para obtener acceso a las funciones necesarias, tuve que instalar una versión beta, que ya se actualizaba cada semana.  Si algo se rompía, tenía que dar acceso a desarrolladores extranjeros para que corrigieran algo. <br><br>  <b>Interfaz de panel inconveniente</b> <br><br>  Todo estaba dividido en diferentes paneles y controlado desde diferentes lugares.  Por ejemplo, los clientes pagaron a través de Billmanager, y tuvieron que reiniciar o reinstalar VDS en VMManager.  Nuestros empleados también tuvieron que cambiar entre ventanas para ayudar al cliente, verificar la carga en su servidor o ver qué sistema operativo usa. <br><br>  Tal interfaz lleva tiempo, tanto la nuestra como la de los clientes.  Sobre cualquier conveniencia, como DigitalOcean, no hay duda en tal situación. <br><br>  <b>Ciclos de vida cortos con actualizaciones frecuentes de API</b> <br><br>  Escribimos nuestros propios complementos, por ejemplo, un complemento con métodos de pago adicionales que no están en VMManager. <br><br>  En los últimos años, VMManager tuvo un ciclo de vida relativamente corto, y en las nuevas versiones los nombres de variables o funciones en la API podrían cambiar arbitrariamente, esto rompió nuestros complementos.  El soporte para versiones anteriores se minimizó rápidamente y tuvo que actualizarse. <br><br>  <b>No puedes modificar</b> <br><br>  Más precisamente, pero extremadamente ineficiente.  Las restricciones de licencia no le permiten realizar cambios en la fuente, solo puede escribir complementos.  El máximo de complementos son algunos elementos del menú, un asistente paso a paso.  El sistema ISP está afilado para mayor versatilidad, y necesitábamos soluciones especializadas. <br><br>  Entonces la decisión de escribir su panel maduró.  Fijamos metas: <br><br><ul><li>  Responda rápidamente a errores, errores y pueda solucionarlos usted mismo, sin hacer que el cliente espere. </li><li>  Modifique libremente la interfaz para los procesos de trabajo y las necesidades del cliente. </li><li>  Mejore la usabilidad con un diseño limpio y comprensible. </li></ul><br>  Y comenzaron el desarrollo. <br><br><h2>  Nueva arquitectura de paneles </h2><br>  Tenemos un equipo de desarrollo autosuficiente, por lo que escribimos el panel nosotros mismos. <br>  El trabajo principal fue realizado por tres ingenieros: el director técnico Sergey ideó la arquitectura y escribió al agente del servidor, Alexey hizo la facturación, y nuestra interfaz Artysh reunió la interfaz. <br><br><h3>  Paso 1. Agente del servidor </h3><br><br>  Un agente de servidor es un servidor web de Python que administra la biblioteca <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">libvirt</a> , que a su vez administra el <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">hipervisor Qemu-kvm</a> . <br><br>  El agente gestiona todos los servicios en el servidor: crear, detener, desinstalar vds, instalar sistemas operativos, cambiar configuraciones, etc. a través de la biblioteca libvirt.  En el momento de la publicación, se trata de más de cuarenta funciones diferentes, que complementamos según la tarea y las necesidades del cliente. <br><br>  En principio, libvirt se podía administrar directamente desde la facturación, pero requería demasiado código adicional y decidimos distribuir estas funciones entre el agente y la facturación; la facturación simplemente hace solicitudes al agente a través de la API JSON. <br><br>  Lo primero que hicimos fue el agente, porque no requería ninguna interfaz y podía probarse directamente desde la consola del servidor. <br><br>  <b>Lo que nos dio el agente del servidor:</b> apareció una capa que simplifica la vida de todos: la facturación no necesita enviar un montón de comandos, sino solo hacer una solicitud.  Y el agente hará todo lo que necesite: por ejemplo, asignar espacio en disco y RAM. <br><br><h3>  Paso 2. Facturación </h3><br>  Para nuestro desarrollador, Alex, este no fue el primer panel de control: Alex estuvo en hosting durante mucho tiempo, por lo que generalmente entendió lo que el cliente necesitaba y lo que necesitaba el proveedor de alojamiento. <br><br>  Llamamos a la facturación entre nosotros un "panel de control": contiene no solo dinero y servicios, sino también su administración, atención al cliente y mucho más. <br><br>  Para cambiar del software ISPSystem, era necesario retener completamente la funcionalidad anterior para los clientes, transferir todas las acciones de los usuarios financieros de la facturación anterior a la nueva, así como todos los servicios y comunicaciones entre ellos.  Estudiamos lo que hay en el producto actual, luego las decisiones de los competidores, principalmente DO y Vultr.  Analizamos las desventajas y ventajas, recopilamos comentarios de personas que trabajaban con productos antiguos de ISPsystem. <br><br>  En la nueva facturación, se utilizaron dos pilas: PHP clásico, MySQL (y en el futuro se planea cambiar a PostgreSQL), Yii2 como marco en el back-end y VueJS en el frente.  Las pilas funcionan independientemente entre sí, desarrolladas por diferentes personas, y se comunican utilizando la API JSON.  Para el desarrollo, entonces y ahora usamos <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">PHPStorm</a> y <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">WebStorm</a> de JetBrains y los amamos mucho (chicos, ¡hola!) <br><br>  El panel está diseñado de acuerdo con el principio modular: módulos del sistema de pago, módulo de registro de dominio o, por ejemplo, módulo de certificado SSL.  Puede agregar fácilmente una nueva función o eliminar la anterior.  La base para la expansión se colocó arquitectónicamente, incluso en la dirección opuesta, "al hierro". <br><img src="https://habrastorage.org/webt/b-/v7/7u/b-v77ugcsfi0zhdm3bbriq2oxsu.png" alt="imagen"><br>  <b>Lo que obtuvimos</b> : un panel de control sobre el cual tenemos control total.  Ahora los errores se corrigen en horas, no en semanas, y se implementan nuevas funciones a petición de los clientes, y no a petición de ISPSystem. <br><br><h3>  Paso 3. Interfaz </h3><br><img src="https://habrastorage.org/webt/9i/n0/b2/9in0b2skk3doxpelwvckx7ebmei.png" alt="imagen"><br>  La interfaz es una creación de nuestro equipo. <br><br>  Primero, observamos lo que sucedería si hiciéramos un complemento sobre la API del sistema ISP sin cambiar nada dramáticamente en la interfaz.  Resultó regular y decidimos hacer todo desde cero. <br><br>  Creíamos que lo principal era hacer que la interfaz fuera lógica, con un diseño limpio y minimalista, y luego obtendríamos un panel hermoso.  La disposición de los elementos se discutió en Megaplan, y la interfaz que los usuarios ven en el panel de control ahora nacerá gradualmente. <br><br>  El primero apareció en el diseño de la página de facturación, porque ya realizamos complementos de pago para el sistema ISP. <br><br>  <b>Frontend</b> <br><br>  Decidieron hacer del panel una aplicación de SPA, sin recursos y con una carga de datos rápida.  Nuestro front-end Artysh decidió escribirlo en Vue, en ese momento Vue acababa de aparecer.  Asumimos que el marco se desarrollará dinámicamente, como React, después de algún tiempo la comunidad Vue crecerá y aparecerá un mar de bibliotecas.  Lo instalamos en Vue y no nos arrepentimos, ahora agregar al frente nuevas características que ya se han programado en el backend lleva poco tiempo.  Le informaremos más sobre los paneles frontend en un artículo separado. <br><br>  <b>Comunicación del frontend con el backend</b> <br><br>  El frontend estaba atado al backend a través de pushies.  Tuve que sudar y escribir mi propio controlador, pero ahora la información en la página se actualiza casi instantáneamente. <br><br>  <b>Lo que sucedió:</b> la interfaz del panel se ha vuelto más fácil.  Lo adaptamos, y la carga rápida permite que se use incluso desde teléfonos móviles en los últimos minutos antes del despegue, sin instalar una aplicación separada para trabajar con el panel. <br><br><h3>  Paso 4. Prueba y esquema de migración </h3><br>  Cuando todo comenzó y pasaron las primeras pruebas, surgió la cuestión de la migración.  En primer lugar, configuramos la facturación y comenzamos a probar su trabajo con el agente del servidor. <br><br>  Luego escribieron un script simple que transfiere la base de datos de la facturación anterior a la nueva. <br><br>  Tuve que probar y verificar dos veces literalmente todo, ya que los datos se vertieron en una nueva base de datos de las tres antiguas: Billmanager, VMmanager y IPmanager manager.  Quizás la migración de prueba es lo más difícil que encontramos en el proceso de desarrollo de un nuevo panel. <br><br>  Después de volver a verificar, cubrimos la facturación anterior.  La migración final de datos fue un momento muy preocupante, pero, gracias a Dios, se completó en unos minutos y sin problemas notables.  Hubo errores menores que arreglamos en una semana.  El tiempo principal se tomó probando lo que sucedió. <br><br>  Luego enviamos cartas a los clientes con la dirección del nuevo panel y la facturación e hicimos una redirección. <br><br>  <b>En pocas palabras:</b> <b>¡ESTÁ VIVO!</b> <br><br><h2>  Feliz </h2><br>  Desde las primeras horas de nuestro software, sentimos todas las delicias de la transición.  El código era completamente nuestro y con una arquitectura conveniente, y la interfaz era limpia y lógica. <br><img src="https://habrastorage.org/webt/7a/hv/is/7ahvis7zx-1m4pcouleavsqbldo.png" alt="imagen"><br>  <i>La primera revisión después de lanzar un nuevo panel</i> <br><br>  Comenzamos el proceso de transición en diciembre, en la víspera del Año Nuevo de 2017, cuando hubo la menor carga para facilitar la transición a los clientes: casi nadie trabaja en la víspera de las vacaciones. <br><br>  Lo principal que obtuvimos durante la transición a nuestro sistema (además de la confiabilidad y conveniencia generales) es la capacidad de agregar rápidamente funcionalidades para los clientes clave: ser su cara y no su trasero. <br><br><h3>  Que sigue </h3><br>  Estamos creciendo, la cantidad de datos, clientes, datos de clientes está creciendo.  Un servidor memcached y dos gestores de colas con diferentes tareas tuvieron que agregarse al backend.  Hay caché y colas en el front-end. <br><br>  Por supuesto, todavía tuvimos aventuras a medida que desarrollamos y complicamos el producto, por ejemplo, cuando agregamos HighLoad. <br><br>  En el próximo artículo, le diremos cómo se lanzó la tarifa Hi-CPU: sobre hardware, software, qué tareas resolvimos y qué hicimos. <br><br> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><img src="https://habrastorage.org/webt/ud/xv/wf/udxvwfcz80j3nug11rxaguqelww.png"><br></a> <br><h3>  Suscríbase a nuestro desarrollador de Instagram </h3><br> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><img src="https://habrastorage.org/webt/e5/as/-l/e5as-ltfnotkemk2dsqngygimra.png"></a> </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/460107/">https://habr.com/ru/post/460107/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../460091/index.html">Impresión directa en camisetas con Epson SureColor SC - F y su diferencia con la serigrafía, la calcomanía y la sublimación</a></li>
<li><a href="../460095/index.html">Atrapado una prohibición para fork deepNude en gitlab.com</a></li>
<li><a href="../460097/index.html">The Matrix lo tiene a usted: una descripción general de los proyectos que utilizan MITER ATT & CK</a></li>
<li><a href="../460099/index.html">Aplicación de aprendizaje automático a redes neuronales con arquitectura de transformador</a></li>
<li><a href="../460101/index.html">Operación XSS basada en cookies | $ 2300 Bug Bounty story</a></li>
<li><a href="../460109/index.html">Angular: cuando necesita ver la aplicación, pero el backend aún no está listo</a></li>
<li><a href="../460111/index.html">Versión actualizada de SAP Business One 9.3: lo que ha cambiado</a></li>
<li><a href="../460113/index.html">Algunas historias de la vida de JSOC CERT, o análisis forense de Unbanal</a></li>
<li><a href="../460115/index.html">Diez años de programación en Erlang</a></li>
<li><a href="../460117/index.html">¿Son los clientes más grandes de Rusia un gran premio o un dolor de cabeza? Experiencia AGIMA</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>