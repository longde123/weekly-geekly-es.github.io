<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë©üèæ‚Äçüî¨ üé• üéüÔ∏è Infraestrutura System.Transactions no mundo .NET üàµ üôéüèø üèÇüèø</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Voc√™ j√° viu uma constru√ß√£o como using (var scope = new TransactionScope(TransactionScopeOption.Required)) em C #? Isso significa que o c√≥digo em execu...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Infraestrutura System.Transactions no mundo .NET</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/custis/blog/433136/"><div style="text-align:center;"><img src="https://habrastorage.org/webt/ct/df/aq/ctdfaqnuvdjaw6tobyxja78mk-s.png"></div><br>  Voc√™ j√° viu uma constru√ß√£o como <code>using (var scope = new TransactionScope(TransactionScopeOption.Required))</code> em C #?  Isso significa que o c√≥digo em execu√ß√£o no bloco <code>using</code> est√° na transa√ß√£o e, ap√≥s sair desse bloco, as altera√ß√µes ser√£o confirmadas ou revertidas.  Parece compreens√≠vel at√© voc√™ come√ßar a cavar mais fundo.  E quanto mais fundo voc√™ cavar, mais e mais estranho se torna.  De qualquer forma, quando me familiarizei com a classe <code>TransactionScope</code> e, em geral, com as transa√ß√µes .NET, surgiram v√°rias perguntas. <br><br>  O que √© a classe <code>TransactionScope</code> ?  Assim que usamos a constru√ß√£o <code>using (var scope = new TransactionScope())</code> , tudo em nosso programa se torna imediatamente transacional?  O que s√£o "Resource Manager" e "Transaction Manager"?  Posso escrever meu pr√≥prio gerenciador de recursos e como ele se "conecta" √† inst√¢ncia criada do <code>TransactionScope</code> ?  O que √© uma transa√ß√£o distribu√≠da e √© verdade que uma transa√ß√£o distribu√≠da no SQL Server ou Oracle Database √© igual a uma transa√ß√£o .NET distribu√≠da? <br><br>  Nesta publica√ß√£o, tentei coletar material que ajuda a encontrar respostas para essas perguntas e a entender as transa√ß√µes no mundo .NET. <br><a name="habracut"></a><br><div class="spoiler">  <b class="spoiler_title">Conte√∫do</b> <div class="spoiler_text">  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">1. Introdu√ß√£o</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">O que s√£o transa√ß√µes e quais problemas eles resolvem?</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Quais transa√ß√µes s√£o consideradas aqui</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Se√ß√£o TL; DR</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Transa√ß√µes baseadas em System.Transactions</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">O que √© isso</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Gerentes de recursos</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Tipos de gerenciadores de recursos</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Usando o TransactionScope</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Aplicabilidade de transa√ß√£o de software</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Um exemplo de um gerenciador de recursos inconstante</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Se√ß√£o TL; DR</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Transa√ß√µes Distribu√≠das</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">O que √© isso</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Protocolos transacionais</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Fixa√ß√£o bif√°sica</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Folha de dicas do System.Transations</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Limita√ß√µes e alternativas de transa√ß√£o distribu√≠da por software</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Ent√£o est√° no .NET Core?</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Transa√ß√µes Distribu√≠das e WCF</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Se√ß√£o TL; DR</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Conclus√£o Ber√ßo</a> </div></div><br><a name="Introduction"></a><h2>  1. Introdu√ß√£o </h2><br><a name="Transactions"></a><h4>  O que s√£o transa√ß√µes e quais problemas eles resolvem? </h4><br>  As transa√ß√µes em quest√£o aqui s√£o opera√ß√µes que transferem o sistema de um estado aceit√°vel para outro e s√£o garantidas para n√£o deixar o sistema em um estado inaceit√°vel, mesmo que surjam situa√ß√µes imprevistas.  Que tipo de condi√ß√µes aceit√°veis ‚Äã‚Äãs√£o essas, no caso geral, depende do contexto.  Aqui consideraremos uma situa√ß√£o aceit√°vel na qual os dados que processamos s√£o integrais.  Entende-se que as altera√ß√µes que comp√µem a transa√ß√£o s√£o confirmadas juntas ou n√£o confirmadas.  Al√©m disso, as altera√ß√µes em uma transa√ß√£o podem ser isoladas das altera√ß√µes feitas no sistema por outra transa√ß√£o.  Os requisitos b√°sicos para transa√ß√µes s√£o indicados pelo acr√¥nimo ACID.  Para o primeiro contato com eles, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">um artigo na Wikipedia √©</a> adequado. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/4r/p7/2b/4rp72bf2l_qdxmlhawxsjslkj-i.png" width="250"></div><br>  Um exemplo cl√°ssico de uma transa√ß√£o √© a transfer√™ncia de dinheiro entre duas contas.  Nessa situa√ß√£o, retirar dinheiro da conta n√∫mero 1 sem creditar na conta n√∫mero 2 √© inaceit√°vel, da mesma maneira que depositar na conta n√∫mero 2 sem retirar a conta n√∫mero 1. Em outras palavras, queremos que ambas as opera√ß√µes sejam tanto retirada quanto creditando - realizado imediatamente.  Se um deles falhar, a segunda opera√ß√£o n√£o deve ser executada.  Voc√™ pode chamar esse princ√≠pio de "tudo ou nada".  Al√©m disso, √© desej√°vel que as opera√ß√µes sejam executadas de forma s√≠ncrona, mesmo no caso de falhas sist√™micas, como falta de energia, ou seja, que o sistema seja visto em um estado aceit√°vel assim que estiver dispon√≠vel ap√≥s a restaura√ß√£o. <br><br>  Em termos matem√°ticos, podemos dizer que, com rela√ß√£o ao sistema, existe um invariante que gostar√≠amos de preservar.  Por exemplo, o valor em ambas as contas: √© necess√°rio que ap√≥s a transa√ß√£o (transfer√™ncia de dinheiro) o valor permane√ßa o mesmo de antes.  A prop√≥sito, no exemplo cl√°ssico de transfer√™ncia de dinheiro, a contabilidade tamb√©m aparece - uma √°rea de assunto em que o conceito de transa√ß√£o surgiu naturalmente. <br><br>  Ilustramos o exemplo de transfer√™ncia de dinheiro entre duas contas.  A primeira imagem mostra a situa√ß√£o em que a transfer√™ncia de 50 rublos da conta 1 para a conta 2 foi conclu√≠da com √™xito.  A cor verde indica que o sistema est√° em um estado aceit√°vel (os dados est√£o completos). <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/sn/az/ra/snazracqgy0u8fdxtrtksb8jc7g.png"></div><br>  Agora imagine que a transfer√™ncia √© realizada fora da transa√ß√£o e ap√≥s a retirada do dinheiro da conta n¬∫ 1, ocorreu uma falha, devido √† qual o dinheiro retirado n√£o foi creditado na conta n¬∫ 2. O sistema estar√° em um estado inaceit√°vel (cor vermelha). <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/yj/8h/ph/yj8hphqu7cszpcdvnboh97h3xfe.png"></div><br>  Se ocorreu um erro entre as opera√ß√µes de retirada e obten√ß√£o de cr√©ditos, mas a transfer√™ncia foi realizada como parte de uma transa√ß√£o, a opera√ß√£o de retirada ser√° cancelada.  Como resultado, o sistema permanecer√° em seu estado aceit√°vel original. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/3d/6b/wi/3d6bwim5vko1yam5mhiv1ekl9ve.png"></div><br>  Vou dar exemplos de situa√ß√µes da experi√™ncia de nossa empresa nas quais as transa√ß√µes s√£o √∫teis: contabilizar mercadorias (contabilizar o n√∫mero de mercadorias de v√°rios tipos que est√£o em determinadas lojas e a caminho), contabilizar recursos de armazenamento (contabilizar o volume de uma sala ocupada por mercadorias de um determinado tipo, volume de um livre para a coloca√ß√£o de mercadorias, a quantidade de mercadorias que os funcion√°rios e os sistemas de armazenamento automatizados podem mover por dia). <br><br>  Os problemas que surgem quando a integridade dos dados √© violada s√£o √≥bvios.  As informa√ß√µes fornecidas pelo sistema n√£o se tornam apenas falsas - elas perdem contato com a realidade e se transformam em bobagens. <br><br><a name="KindsOfTransactions"></a><h4>  Quais transa√ß√µes s√£o consideradas aqui </h4><br>  Os benef√≠cios fornecidos pelas transa√ß√µes s√£o conhecidos.  Portanto, para manter a integridade dos dados, precisamos de um banco de dados relacional, porque √© a√≠ que as transa√ß√µes s√£o feitas?  Na verdade n√£o.  Foi dito acima que o conceito de transa√ß√£o depende do contexto, e agora consideraremos brevemente de que transa√ß√µes podemos falar ao discutir sistemas de informa√ß√£o. <br><br>  Para come√ßar, separamos os conceitos de transa√ß√µes de dom√≠nio do assunto (transa√ß√µes comerciais) e transa√ß√µes do sistema.  O segundo pode ser implementado em locais diferentes e de maneiras diferentes. <br><br>  Vamos do n√≠vel mais alto - a √°rea de assunto.  A pessoa interessada pode declarar que existem alguns estados aceit√°veis ‚Äã‚Äãe n√£o deseja ver o sistema de informa√ß√£o fora desses estados.  N√£o apresentaremos exemplos extras: a transfer√™ncia de dinheiro entre contas √© adequada aqui.  Esclarecemos apenas que uma transfer√™ncia n√£o √© necessariamente uma transfer√™ncia de dinheiro entre as contas de liquida√ß√£o de dois clientes banc√°rios.  N√£o menos importante √© a tarefa da contabilidade, quando as contas devem refletir as fontes e o objetivo dos fundos da organiza√ß√£o, e a transfer√™ncia deve refletir a mudan√ßa na distribui√ß√£o de fundos por essas fontes e o objetivo.  Este foi um exemplo de uma <b>transa√ß√£o de dom√≠nio do assunto</b> . <br><br>  Agora vamos ver os exemplos mais comuns e interessantes da implementa√ß√£o de transa√ß√µes do sistema.  Nas transa√ß√µes do sistema, v√°rios meios t√©cnicos fornecem os requisitos da √°rea de assunto.  Uma solu√ß√£o cl√°ssica comprovada desse tipo √© uma <strong>transa√ß√£o de DBMS relacional</strong> (primeiro exemplo).  Os sistemas modernos de gerenciamento de banco de dados (relacionais <a href="">e n√£o muito</a> ) fornecem um mecanismo de transa√ß√£o que permite salvar (confirmar) todas as altera√ß√µes feitas no per√≠odo especificado de trabalho ou descart√°-las (retroceder).  Ao usar esse mecanismo, opera√ß√µes de retirada de dinheiro de uma conta e cr√©dito para outra conta que comp√µem a transa√ß√£o da √°rea de assunto, os meios do DBMS ser√£o combinados em uma transa√ß√£o do sistema e ser√£o executados juntos ou n√£o ser√£o executados. <br><br>  Usar um DBMS, √© claro, n√£o √© necess√°rio.  Grosso modo, voc√™ geralmente pode implementar o mecanismo de transa√ß√£o DBMS na sua linguagem de programa√ß√£o favorita e aproveitar o an√°logo inst√°vel e com erros das ferramentas existentes.  Mas sua ‚Äúbicicleta‚Äù pode ser otimizada para situa√ß√µes espec√≠ficas na √°rea de assunto. <br><br>  Existem op√ß√µes mais interessantes.  As linguagens de programa√ß√£o industrial modernas (C # e Java em primeiro lugar) oferecem ferramentas projetadas especificamente para organizar transa√ß√µes envolvendo subsistemas completamente diferentes, e n√£o apenas o DBMS.  Nesta publica√ß√£o, chamaremos esses softwares de transa√ß√µes.  No caso de C #, essas s√£o <b>transa√ß√µes do espa√ßo para nome System.Transactions</b> (o segundo exemplo) e s√£o descritas abaixo. <br><br>  Antes de passar para as transa√ß√µes <code>System.Transactions</code> , n√£o se pode deixar de mencionar mais um fen√¥meno interessante.  <code>System.Transactions</code> ferramentas <code>System.Transactions</code> permitem que o programador implemente independentemente a <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">mem√≥ria de transa√ß√£o program√°tica</a> .  Nesse caso, as opera√ß√µes do programa que afetam o estado do sistema (no caso das linguagens de programa√ß√£o imperativas cl√°ssicas, √© uma opera√ß√£o de atribui√ß√£o) s√£o inclu√≠das por padr√£o nas transa√ß√µes que podem ser confirmadas e revertidas da mesma maneira que as transa√ß√µes do DBMS.  Com essa abordagem, a necessidade de usar mecanismos de sincroniza√ß√£o (em C # - <code>lock</code> , em Java - <code>synchronized</code> ) √© significativamente reduzida.  Um desenvolvimento adicional dessa id√©ia √© a <strong>mem√≥ria transacional de software, suportada no n√≠vel da plataforma</strong> (terceiro exemplo).  Espera-se que esse milagre seja encontrado em uma linguagem cuja eleg√¢ncia supere sua aplicabilidade industrial - Clojure.  E para linguagens trabalhador-camponesas, existem bibliotecas de plug-in que fornecem a funcionalidade da mem√≥ria transacional program√°tica. <br><br>  As transa√ß√µes do sistema podem incluir v√°rios sistemas de informa√ß√£o, caso em que s√£o distribu√≠dos.  Distribu√≠dos podem ser transa√ß√µes e software DBMS;  tudo depende de qual funcionalidade uma ferramenta de transa√ß√£o espec√≠fica suporta.  Transa√ß√µes distribu√≠das mais detalhadas s√£o discutidas na se√ß√£o correspondente.  Vou dar uma imagem para facilitar a compreens√£o dos t√≥picos discutidos. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/di/yd/4s/diyd4spwelqhd61eoetfacuncjm.png"></div><br><a name="TLDR1"></a><h4>  Se√ß√£o TL; DR </h4><br>  Existem processos que consistem em v√°rias opera√ß√µes indivis√≠veis (at√¥micas) aplicadas ao sistema, no caso geral, n√£o necessariamente informativas.  Cada opera√ß√£o indivis√≠vel pode deixar o sistema em um estado inaceit√°vel quando a integridade dos dados √© comprometida.  Por exemplo, se uma transfer√™ncia de dinheiro entre duas contas for representada por duas opera√ß√µes indivis√≠veis de retirada da conta n¬∫ 1 e cr√©dito na conta n¬∫ 2, apenas uma dessas opera√ß√µes violar√° a integridade dos dados.  O dinheiro desaparece no meio do nada ou aparece no meio do nada.  Uma transa√ß√£o combina opera√ß√µes indivis√≠veis para que sejam executadas todas juntas (√© claro, sequencialmente, se necess√°rio) ou n√£o sejam executadas.  Podemos falar sobre transa√ß√µes de dom√≠nio e transa√ß√µes em sistemas t√©cnicos que normalmente implementam transa√ß√µes de dom√≠nio. <br><br><a name="SystemTransactions"></a><h2>  Transa√ß√µes baseadas em System.Transactions </h2><br><a name="WhatIsIt1"></a><h4>  O que √© isso </h4><br>  No mundo .NET, existe uma estrutura de software projetada pelos criadores de uma plataforma de gerenciamento de transa√ß√µes.  Da perspectiva de um programador transacional, essa estrutura consiste nos <code>System.Transactions</code> <code>TransactionScope</code> , <code>TransactionScopeOption</code> , <code>TransactionScopeAsyncFlowOption</code> e <code>TransactionOptions</code> <code>System.Transactions</code> espa√ßo para nome <code>System.Transactions</code> .  Se falarmos sobre o .NET Standard, tudo isso estar√° dispon√≠vel a partir da <a href="">vers√£o 2.0</a> . <br><br>  As transa√ß√µes do namespace <code>System.Transactions</code> s√£o baseadas no <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">padr√£o X / Open XA do The Open Group</a> .  Esta norma introduz muitos dos termos discutidos abaixo e, o mais importante, descreve transa√ß√µes distribu√≠das, que tamb√©m s√£o cobertas nesta publica√ß√£o em uma se√ß√£o especial.  A implementa√ß√£o de transa√ß√µes de software em outras plataformas, por exemplo <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">, Java, √©</a> baseada no mesmo padr√£o. <br><br>  Um caso de uso de transa√ß√£o t√≠pico para um programador C # √© o seguinte: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">using</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> scope = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> System.Transactions.TransactionScope(System.Transactions.TransactionScopeOption.Required)) { <span class="hljs-comment"><span class="hljs-comment">// -  ,    . scope.Complete(); }</span></span></code> </pre> <br>  Dentro do bloco <code>using</code> , est√° o c√≥digo que executa o trabalho, cujos resultados devem ser confirmados ou cancelados todos juntos.  Exemplos cl√°ssicos desse trabalho est√£o lendo e gravando no banco de dados ou enviando e recebendo mensagens da fila.  Quando o controle sair do bloco <code>using</code> , a transa√ß√£o ser√° confirmada.  Se voc√™ remover a chamada <code>Complete</code> , a transa√ß√£o ser√° revertida.  Bem simples. <br><br>  Acontece que, durante uma revers√£o de transa√ß√£o, todas as opera√ß√µes realizadas dentro de um bloco <code>using</code> ser√£o canceladas?  E se eu atribu√≠ uma vari√°vel a um valor diferente, essa vari√°vel restaurar√° o valor antigo?  Quando vi pela primeira vez um design semelhante, pensei que sim.  De fato, √© claro, nem todas as altera√ß√µes ser√£o revertidas, mas apenas muito <i>especiais</i> .  Se todas as altera√ß√µes fossem revertidas, essa seria a mem√≥ria transacional do software descrita acima.  Agora vamos ver quais s√£o essas altera√ß√µes especiais que podem participar de transa√ß√µes do programa com base em <code>System.Transactions</code> . <br><br><a name="ResourceManagers"></a><h4>  Gerentes de recursos </h4><br>  Para que algo <code>System.Transactions</code> suporte a transa√ß√µes baseadas no <code>System.Transactions</code> , √© necess√°rio que ele possua informa√ß√µes de que uma transa√ß√£o est√° em andamento no momento e que esteja registrada em algum registro dos participantes da transa√ß√£o.  Voc√™ pode obter informa√ß√µes sobre se o trabalho transacional est√° em andamento verificando a propriedade est√°tica <code>Current</code> da classe <code>System.Transactions.Transaction</code> .  Digitar o bloco <code>using</code> do tipo indicado acima apenas define essa propriedade, se ainda n√£o tiver sido definida anteriormente.  E para se registrar como participante de uma transa√ß√£o, voc√™ pode usar m√©todos do tipo <code>Transaction.Enlist <i>Smth</i></code> .  Al√©m disso, voc√™ precisa implementar a interface exigida por esses m√©todos.  Gerenciador de recursos - este √© apenas um "algo" que suporta a intera√ß√£o com transa√ß√µes do <code>System.Transactions</code> (uma defini√ß√£o mais espec√≠fica √© fornecida abaixo). <br><br>  O que s√£o gerenciadores de recursos?  Se trabalhamos em C # com um DBMS, por exemplo, SQL Server ou Oracle Database, geralmente usamos os drivers apropriados, e eles s√£o os recursos de gerenciamento.  No c√≥digo, eles s√£o representados pelos tipos <code>System.Data.SqlClient.SqlConnection</code> e <code>Oracle.ManagedDataAccess.Client.OracleConnection</code> .  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Eles tamb√©m dizem</a> que o MSMQ oferece suporte a transa√ß√µes baseadas em <code>System.Transactions</code> .  Guiado pelo conhecimento e exemplos retirados da Internet, voc√™ pode criar seu pr√≥prio gerenciador de recursos.  O exemplo mais simples √© dado na pr√≥xima se√ß√£o. <br><br>  Al√©m dos gerenciadores de recursos, tamb√©m devemos ter um Gerenciador de Transa√ß√µes, que monitorar√° a transa√ß√£o e dar√° ordens aos gerentes de recursos em tempo h√°bil.  Dependendo de quais gerenciadores de recursos est√£o envolvidos na transa√ß√£o (quais caracter√≠sticas eles t√™m e onde est√£o localizados), diferentes gerenciadores de transa√ß√µes s√£o conectados ao trabalho.  Nesse caso, a sele√ß√£o da vers√£o apropriada √© autom√°tica e n√£o requer a interven√ß√£o de um programador. <br><br>  Mais especificamente, o gerenciador de recursos √© uma inst√¢ncia de uma classe que implementa a interface especial <code>System.Transactions.IEnlistmentNotification</code> .  A inst√¢ncia da classe, conforme direcionado pelo cliente, √© registrada como participante da transa√ß√£o usando a propriedade est√°tica <code>System.Transactions.Transaction.Current</code> .  Posteriormente, o gerenciador de transa√ß√µes chama m√©todos da interface especificada, conforme necess√°rio. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/tw/ea/vp/tweavpimeod539do_fkzpr6yzrw.png"></div><br>  √â claro que, no tempo de execu√ß√£o, o conjunto de gerenciadores de recursos envolvidos na transa√ß√£o pode mudar.  Por exemplo, depois de inserir o bloco <code>using</code> , podemos primeiro fazer algo no SQL Server e depois no Oracle Database.  Dependendo desse conjunto de gerenciadores de recursos, o gerenciador de transa√ß√µes usado √© determinado.  Para ser mais preciso, o protocolo de transa√ß√£o usado √© determinado pelo conjunto de gerenciadores de recursos, e o gerenciador de transa√ß√µes que o suporta √© determinado com base no protocolo.  Veremos os protocolos transacionais <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">mais tarde,</a> quando falarmos sobre transa√ß√µes distribu√≠das.  O mecanismo para selecionar automaticamente o gerenciador de transa√ß√µes apropriado no tempo de execu√ß√£o ao alterar os gerenciadores de recursos envolvidos na transa√ß√£o √© chamado Promo√ß√£o de Transa√ß√£o. <br><br><a name="KindsOfResourceManagers"></a><h4>  Tipos de gerenciadores de recursos </h4><br>  Os gerentes de recursos podem ser divididos em dois grandes grupos: dur√°veis ‚Äã‚Äãe vari√°veis. <br><br>  Durable Resource Manager - um gerenciador de recursos que suporta uma transa√ß√£o, mesmo que o sistema de informa√ß√µes n√£o esteja dispon√≠vel (por exemplo, quando o computador reiniciar).  Volatile Resource Manager - Um gerenciador de recursos que n√£o suporta uma transa√ß√£o se o sistema de informa√ß√µes n√£o estiver dispon√≠vel.  Um gerenciador de recursos inconsistente suporta apenas transa√ß√µes na mem√≥ria. <br><br>  Os gerenciadores de recursos cl√°ssicos de longo prazo s√£o o DBMS (ou o driver DBMS da plataforma de software).  N√£o importa o que aconte√ßa - pelo menos um mau funcionamento do sistema operacional, pelo menos uma falta de energia - o DBMS garantir√° a integridade dos dados ap√≥s retornar √† condi√ß√£o de trabalho.  Por isso, √© claro, voc√™ deve pagar alguns inconvenientes, mas neste artigo n√£o os consideraremos.  Um exemplo de um gerenciador de recursos n√£o persistente √© a mem√≥ria transacional do software mencionada acima. <br><br><a name="TransactionScope"></a><h4>  Usando o TransactionScope </h4><br>  Ao criar um objeto do tipo <code>TransactionScope</code> voc√™ pode especificar alguns par√¢metros. <br><br>  Primeiramente, h√° uma configura√ß√£o que informa ao tempo de execu√ß√£o o que ele precisa: <br><br><ol><li>  Use uma transa√ß√£o que j√° existe no momento; </li><li>  Certifique-se de criar um novo; </li><li>  por outro lado, execute o c√≥digo dentro de um bloco <code>using</code> fora de uma transa√ß√£o. </li></ol><br>  A enumera√ß√£o <code>System.Transactions.TransactionScopeOption</code> √© respons√°vel por tudo isso. <br><br>  Em segundo lugar, voc√™ pode definir o n√≠vel de isolamento da transa√ß√£o.  Este √© um par√¢metro que permite encontrar um compromisso entre a independ√™ncia da mudan√ßa e a velocidade.  O n√≠vel mais independente - serializ√°vel - garante que n√£o haja situa√ß√µes em que as altera√ß√µes feitas em uma transa√ß√£o que ainda n√£o foram confirmadas possam ser vistas em outra transa√ß√£o.  Cada pr√≥ximo n√≠vel adiciona uma situa√ß√£o espec√≠fica, quando a execu√ß√£o simult√¢nea de transa√ß√µes pode afetar uma √† outra.<font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Por padr√£o, uma transa√ß√£o √© aberta no n√≠vel serializ√°vel, o que pode ser desagrad√°vel (consulte, por exemplo, </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">este coment√°rio</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ). </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Definir o n√≠vel de isolamento da transa√ß√£o durante a cria√ß√£o </font></font><code>TransactionScope</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">√© um aconselhamento para os gerenciadores de recursos. Eles podem at√© n√£o suportar todos os n√≠veis listados </font></font><code>System.Transactions.IsolationLevel</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Al√©m disso, deve-se ter em mente que, ao usar o pool de conex√µes para trabalhar com o banco de dados, a conex√£o para a qual o n√≠vel de isolamento da transa√ß√£o foi alterado </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">manter√° esse n√≠vel</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ao retornar ao pool </font><font style="vertical-align: inherit;">. Agora, quando o programador receber essa conex√£o do pool e confiar nos valores padr√£o, ele observar√° um comportamento inesperado. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cen√°rios t√≠picos de trabalho c</font></font><code>TransactionScope</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">e armadilhas significativas (ou seja, transa√ß√µes aninhadas) s√£o bem cobertas </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">neste artigo no "Habr"</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br><br><a name="Applicability"></a><h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Aplicabilidade de transa√ß√£o de software </font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Deve-se dizer que em quase qualquer sistema de informa√ß√µes em opera√ß√£o comercial, s√£o iniciados processos que podem levar o sistema a um estado inaceit√°vel. </font><font style="vertical-align: inherit;">Portanto, pode ser necess√°rio controlar esses processos, descobrir se o estado atual do sistema √© aceit√°vel e, se n√£o, restaur√°-lo. </font><font style="vertical-align: inherit;">Transa√ß√µes de software - uma ferramenta pronta para manter o sistema em um estado aceit√°vel. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Em cada caso, seria construtivo considerar o custo:</font></font><br><br><ol><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">integrar processos √† infraestrutura de transa√ß√µes de software (esses processos tamb√©m precisam estar cientes </font></font><code>TransactionScope</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">de muitas outras coisas);</font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> manuten√ß√£o dessa infraestrutura (por exemplo, o custo do aluguel de equipamentos com o Windows a bordo); </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> treinamento de funcion√°rios (j√° que o t√≥pico de transa√ß√µes do .NET n√£o √© comum). </font></font></li></ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">N√£o devemos esquecer que o processo de transa√ß√£o pode ser solicitado a relatar seu progresso ao "mundo externo", por exemplo, para manter um di√°rio de a√ß√µes fora da transa√ß√£o. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Obviamente, a rejei√ß√£o de transa√ß√µes de software exigir√° a cria√ß√£o ou implementa√ß√£o de outros meios de manuten√ß√£o da integridade dos dados, que tamb√©m ter√£o seu valor. </font><font style="vertical-align: inherit;">No final, pode haver casos em que as viola√ß√µes √† integridade dos dados s√£o t√£o raras que √© mais f√°cil restaurar um estado aceit√°vel do sistema por interven√ß√µes cir√∫rgicas do que manter um mecanismo de recupera√ß√£o autom√°tica.</font></font><br><br><a name="Example"></a><h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Um exemplo de um gerenciador de recursos inconstante </font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Agora vamos ver um exemplo de um gerenciador de recursos simples que n√£o oferece suporte √† recupera√ß√£o de uma falha do sistema. Teremos um bloco de mem√≥ria transacional de software que armazena algum valor que pode ser lido e gravado. Na aus√™ncia de uma transa√ß√£o, esse bloco se comporta como uma vari√°vel regular e, na presen√ßa de uma transa√ß√£o, armazena o valor inicial, que pode ser restaurado ap√≥s a revers√£o da transa√ß√£o. O c√≥digo para esse gerenciador de recursos √© apresentado abaixo:</font></font><br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">internal</span></span> <span class="hljs-keyword"><span class="hljs-keyword">sealed</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Stm</span></span>&lt;<span class="hljs-title"><span class="hljs-title">T</span></span>&gt; : <span class="hljs-title"><span class="hljs-title">System</span></span>.<span class="hljs-title"><span class="hljs-title">Transactions</span></span>.<span class="hljs-title"><span class="hljs-title">IEnlistmentNotification</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> T _current; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> T _original; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> _enlisted; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> T Value { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> _current; } <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!Enlist()) { _original = <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>; } _current = <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>; } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Stm</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">T </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">value</span></span></span></span></span><span class="hljs-function">)</span></span> { _current = <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>; _original = <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Enlist</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (_enlisted) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> currentTx = System.Transactions.Transaction.Current; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (currentTx == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; currentTx.EnlistVolatile(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>, System.Transactions.EnlistmentOptions.None); _enlisted = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } <span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">region</span></span></span><span class="hljs-meta"> IEnlistmentNotification public void Commit(System.Transactions.Enlistment enlistment) { _original = _current; _enlisted = false; } public void InDoubt(System.Transactions.Enlistment enlistment) { _enlisted = false; } public void Prepare(System.Transactions.PreparingEnlistment preparingEnlistment) { preparingEnlistment.Prepared(); } public void Rollback(System.Transactions.Enlistment enlistment) { _current = _original; _enlisted = false; } #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">endregion</span></span></span><span class="hljs-meta"> IEnlistmentNotification }</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pode-se observar que o √∫nico requisito formal √© a implementa√ß√£o da interface </font></font><code>System.Transactions.IEnlistmentNotification</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Dos interessantes, m√©todos </font></font><code>Enlist</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(que n√£o fazem parte </font></font><code>System.Transactions.IEnlistmentNotification</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) e </font></font><code>Prepare</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. O m√©todo </font></font><code>Enlist</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">apenas verifica se o c√≥digo fornecido funciona dentro da estrutura da transa√ß√£o e, nesse caso, registra uma inst√¢ncia de sua classe como um gerenciador de recursos n√£o constante. O m√©todo </font></font><code>Prepare</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">√© chamado pelo gerenciador de transa√ß√µes antes de confirmar as altera√ß√µes. Nosso gerente de recursos sinaliza sua prontid√£o para confirmar chamando um m√©todo </font></font><code>System.Transactions.PreparingEnlistment.Prepared</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A seguir, um c√≥digo que mostra um exemplo de uso do nosso gerenciador de recursos:</font></font><br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> stm = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Stm&lt;<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>&gt;(<span class="hljs-number"><span class="hljs-number">1</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> scope = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> System.Transactions.TransactionScope(System.Transactions.TransactionScopeOption.Required)) { stm.Value = <span class="hljs-number"><span class="hljs-number">2</span></span>; scope.Complete(); }</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Se voc√™ </font></font><code>using</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ler a propriedade </font><font style="vertical-align: inherit;">imediatamente ap√≥s sair do bloco </font></font><code>stm.Value</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, o valor esperado ser√° esperado l√° </font></font><code>2</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">E se voc√™ remover a chamada </font></font><code>scope.Complete</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, a transa√ß√£o ser√° revertida e a propriedade </font></font><code>stm.Value</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ter√° o valor </font></font><code>1</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">definido antes do in√≠cio da transa√ß√£o. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Uma sequ√™ncia simplificada de chamadas ao trabalhar com transa√ß√µes √© </font></font><code>System.Transactions</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mostrada no diagrama abaixo.</font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/09/je/1d/09je1dkghhmmwts6rvaufuntpna.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pode-se observar que, neste exemplo, nem todas as possibilidades oferecidas pela infraestrutura s√£o consideradas </font></font><code>System.Transactions</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Vamos consider√°-los mais completamente depois de nos familiarizarmos com protocolos transacionais e transa√ß√µes distribu√≠das na pr√≥xima se√ß√£o.</font></font><br><br><a name="TLDR2"></a><h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Se√ß√£o TL; DR </font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Um programador pode usar uma classe </font></font><code>TransactionScope</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">para executar algum c√≥digo em uma transa√ß√£o existente ou nova. Uma transa√ß√£o √© confirmada se e somente se o </font></font><code>TransactionScope</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">m√©todo for chamado </font><font style="vertical-align: inherit;">em uma inst√¢ncia existente da classe </font></font><code>Dispose</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, mesmo que o m√©todo tenha sido chamado antes</font></font><code>Complete</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Um programador pode indicar se deseja iniciar uma nova transa√ß√£o, tirar proveito de uma transa√ß√£o existente ou, inversamente, executar c√≥digo fora de uma transa√ß√£o existente. Somente gerenciadores de recursos est√£o envolvidos na transa√ß√£o - componentes de software que implementam determinadas funcionalidades. Os gerenciadores de recursos podem ser de longo prazo (recupera√ß√£o de uma falha do sistema) e intermitentes (sem recupera√ß√£o). Um DBMS √© um exemplo de um gerenciador de recursos de longa dura√ß√£o. O gerenciador de recursos √© coordenado por um gerenciador de transa√ß√µes - um componente de software que √© selecionado automaticamente pelo tempo de execu√ß√£o sem a participa√ß√£o de um programador. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O gerenciador de recursos inconsistente √© uma classe que implementa a interface </font></font><code>System.Transactions.IEnlistmentNotification</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">no m√©todo</font></font><code>Prepare</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">confirmando sua disponibilidade para confirmar altera√ß√µes ou, inversamente, sinalizando uma revers√£o de altera√ß√µes. </font><font style="vertical-align: inherit;">Quando o chamador est√° fazendo algo para gerir os recursos, ele verifica se a transa√ß√£o est√° agora aberto, e, se aberto, √© registrado pelo m√©todo </font></font><code>System.Transactions.Transaction.EnlistVolatile</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br><br><a name="DistributedTransactions"></a><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Transa√ß√µes Distribu√≠das </font></font></h2><br><a name="WhatIsIt2"></a><h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> O que √© isso </font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Uma transa√ß√£o distribu√≠da envolve v√°rios subsistemas de informa√ß√µes (na verdade, nem tudo √© t√£o simples, mais sobre isso abaixo). </font><font style="vertical-align: inherit;">Entende-se que as altera√ß√µes em todos os sistemas envolvidos em uma transa√ß√£o distribu√≠da devem ser confirmadas ou revertidas. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">V√°rios meios de implementa√ß√£o de transa√ß√µes foram apresentados acima: DBMS, infraestrutura </font></font><code>System.Transactions</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">e mem√≥ria transacional program√°tica incorporada √† plataforma. </font><font style="vertical-align: inherit;">As transa√ß√µes distribu√≠das tamb√©m podem ser fornecidas com essas ferramentas. </font><font style="vertical-align: inherit;">Por exemplo, no banco de dados Oracle, alterar (e realmente ler) dados em v√°rios bancos de dados em uma √∫nica transa√ß√£o automaticamente os transforma em distribu√≠dos. </font><font style="vertical-align: inherit;">A seguir, falaremos sobre transa√ß√µes distribu√≠das por software, que podem incluir gerenciadores de recursos heterog√™neos.</font></font><br><br><a name="TransactionProtocols"></a><h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Protocolos transacionais </font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Um protocolo transacional √© um conjunto de princ√≠pios pelos quais os aplicativos envolvidos em uma transa√ß√£o interagem. No mundo .NET, os seguintes protocolos s√£o mais comumente encontrados. </font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Leve.</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> N√£o √© usado mais que um gerenciador de recursos dur√°vel. Todas as intera√ß√µes transacionais ocorrem no mesmo dom√≠nio de aplicativo ou o gerenciador de recursos suporta promo√ß√£o e confirma√ß√£o de fase √∫nica (implementos </font></font><code>IPromotableSinglePhaseNotification</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">). </font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">OleTx.</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> √â permitida a interoperabilidade entre v√°rios dom√≠nios de aplicativos e v√°rios computadores. Voc√™ pode usar muitos gerenciadores de recursos dur√°veis. Todos os computadores participantes devem estar executando o Windows. Use chamadas de procedimento remoto (RPCs). </font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">WS-AT.</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">√â permitida a interoperabilidade entre v√°rios dom√≠nios de aplicativos e v√°rios computadores. Voc√™ pode usar muitos gerenciadores de recursos dur√°veis. Os computadores participantes podem estar executando v√°rios sistemas operacionais, n√£o apenas o Windows. O protocolo de transmiss√£o de hipertexto (HTTP) √© usado. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Observou-se acima que o atual protocolo de transa√ß√£o afeta a escolha do gerenciador de transa√ß√µes, e as caracter√≠sticas dos recursos de controle envolvidos na transa√ß√£o influenciam a escolha do protocolo. Agora listamos os conhecidos gerenciadores de transa√ß√µes. </font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Gerenciador de transa√ß√µes leves (LTM)</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Introduzido no .NET Framework 2.0 e posterior. Gerencia transa√ß√µes usando o protocolo Lightweight. </font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Gerenciador de Transa√ß√µes do Kernel (KTM)</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Introduzido no Windows Vista e Windows Server 2008. Gerencia transa√ß√µes usando o protocolo Lightweight. Ele pode chamar um Sistema de arquivos transacionais (TxF) e um Registro transacional (TxR) no Windows Vista e Windows 2008. </font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Coordenador de transa√ß√µes distribu√≠das (MSDTC)</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Gerencia transa√ß√µes usando os protocolos OleTx e WS-AT. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tamb√©m deve-se ter em mente que alguns gerenciadores de recursos n√£o oferecem suporte a todos os protocolos listados. Por exemplo, o MSMQ e o SQL Server 2000 n√£o oferecem suporte ao Lightweight, portanto, as transa√ß√µes envolvendo o MSMQ ou o SQL Server 2000 ser√£o gerenciadas pelo MSDTC, mesmo que sejam os √∫nicos participantes. Tecnicamente, essa limita√ß√£o decorre do fato de que os gerenciadores de recursos especificados, implementando, √© claro, a interface</font></font><code>System.Transactions.IEnlistmentNotification</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">N√£o implemente a interface </font></font><code>System.Transactions.IPromotableSinglePhaseNotification</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Ele cont√©m, entre outras coisas, um m√©todo </font></font><code>Promote</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">que o tempo de execu√ß√£o chama, se necess√°rio, para alternar para um gerenciador de transa√ß√µes mais √≠ngreme. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A ambiguidade do conceito de transa√ß√£o distribu√≠da deve agora se tornar aparente. </font><font style="vertical-align: inherit;">Por exemplo, voc√™ pode definir uma transa√ß√£o distribu√≠da como uma transa√ß√£o da qual ela participa:</font></font><br><br><ol><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> pelo menos dois de qualquer gerenciador de recursos; </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> gerentes de recursos arbitrariamente vari√°veis ‚Äã‚Äãe pelo menos dois de longa dura√ß√£o; </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> pelo menos dois de quaisquer gerenciadores de recursos necessariamente localizados em computadores diferentes. </font></font></li></ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Portanto, √© melhor sempre esclarecer quais transa√ß√µes espec√≠ficas est√£o envolvidas. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">E, neste contexto, o MSDTC √© discutido principalmente. </font><font style="vertical-align: inherit;">√â um componente de software do Windows que gerencia transa√ß√µes distribu√≠das. </font><font style="vertical-align: inherit;">H√° uma interface gr√°fica para configurar e monitorar transa√ß√µes, que pode ser encontrada no utilit√°rio "Servi√ßos de componentes", seguindo o caminho "Computadores - Meu computador - Coordenador de transa√ß√µes distribu√≠das - DTC local".</font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/vo/35/gc/vo35gcdta3c9qx5w5cnsuxkbzz8.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Para configura√ß√£o, selecione o item ‚ÄúPropriedades‚Äù no menu de contexto do n√≥ ‚ÄúLocal DTC‚Äù e, para monitorar transa√ß√µes distribu√≠das, selecione o item ‚ÄúEstat√≠sticas de transa√ß√£o‚Äù no painel central. </font></font><br><br><a name="TwoPhaseCommit"></a><h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Fixa√ß√£o bif√°sica </font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Se v√°rios gerenciadores de recursos participarem da transa√ß√£o, os resultados de seu trabalho poder√£o ser diferentes: por exemplo, um deles foi conclu√≠do com √™xito e ele est√° pronto para confirmar as altera√ß√µes, e o outro tem um erro e reverter√° as altera√ß√µes. No entanto, a ess√™ncia de uma transa√ß√£o distribu√≠da est√° no fato de que as altera√ß√µes em todos os recursos de controle envolvidos na transa√ß√£o s√£o confirmadas todas juntas ou revertidas. Portanto, nesses casos, geralmente √© usado um protocolo de fixa√ß√£o em duas fases. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Em geral, a ess√™ncia deste protocolo √© a seguinte. Durante a </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">primeira fase</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Os gerenciadores de recursos envolvidos na transa√ß√£o preparam informa√ß√µes suficientes para se recuperar da falha (se for um gerenciador de recursos de longo prazo) e para a conclus√£o bem-sucedida como resultado de uma confirma√ß√£o. Do ponto de vista t√©cnico, o gerenciador de recursos sinaliza que ele concluiu a primeira fase chamando o m√©todo </font></font><code>System.Transactions.PreparingEnlistment.Prepared</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">no m√©todo </font></font><code>Prepare</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Ou gest√£o dos recursos pode notificar altera√ß√µes de revers√£o chamando </font></font><code>ForceRollback</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Quando todos os gerenciadores de recursos envolvidos na transa√ß√£o "votaram", ou seja, eles notificaram o gerente de transa√ß√µes se desejam confirmar ou reverter as altera√ß√µes, a </font><b><font style="vertical-align: inherit;">segunda fase</font></b><font style="vertical-align: inherit;"> come√ßa</font></font><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. No momento, os gerentes de recursos s√£o instru√≠dos a confirmar suas altera√ß√µes (se todos os participantes votaram na corre√ß√£o) ou a recusar altera√ß√µes (se pelo menos um participante votou na revers√£o). Tecnicamente, isso √© expresso na invoca√ß√£o dos m√©todos </font></font><code>Commit</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">e </font></font><code>Rollback</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">implementada pelos gerenciadores de recursos e na qual eles invocam o m√©todo </font></font><code>System.Transactions.Enlistment.Done</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O gerenciador de recursos tamb√©m pode chamar o m√©todo </font></font><code>System.Transactions.Enlistment.Done</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">durante a primeira fase. Nesse caso, entende-se que ele n√£o far√° altera√ß√µes (por exemplo, trabalha apenas para leitura) e n√£o participar√° da segunda fase. Leia mais sobre o commit </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">em</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> duas fases </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;">na Microsoft</font></a><font style="vertical-align: inherit;"> .</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Se a conex√£o entre o gerenciador de transa√ß√µes e pelo menos um dos gerenciadores de recursos for perdida, a transa√ß√£o ficar√° congelada ("em d√∫vida", em d√∫vida). </font><font style="vertical-align: inherit;">O gerenciador de transa√ß√µes, chamando m√©todos </font></font><code>InDoubt</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, notifica os gerenciadores de recursos dispon√≠veis deste evento que podem responder adequadamente. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ainda existe uma </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">fixa√ß√£o trif√°sica</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> e suas modifica√ß√µes com suas vantagens e desvantagens. </font><font style="vertical-align: inherit;">O protocolo de consolida√ß√£o trif√°sico √© menos comum, talvez porque exija ainda mais custos de comunica√ß√£o entre os subsistemas em intera√ß√£o.</font></font><br><br><a name="Interfaces"></a><h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Folha de dicas nas interfaces System.Transactions </font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Algo est√° dif√≠cil. Para resolver um pouco as coisas, descreverei brevemente as principais interfaces de namespace </font></font><code>System.Transactions</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">necess√°rias para criar um gerenciador de recursos. Aqui est√° um diagrama de classes.</font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/bs/rj/sx/bsrjsxptqz6w3g7l6zxawrzeyco.png"></div><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">IEnlistmentNotification.</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> O gerenciador de recursos implementa essa interface. O gerenciador de transa√ß√µes chama os m√©todos implementados na seguinte ordem. Durante a primeira fase, ele chama o m√©todo </font></font><code>Prepare</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(a menos que as estrelas se unissem para cham√°-lo </font></font><code>ISinglePhaseNotification.SinglePhaseCommit</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, como descrito no pr√≥ximo par√°grafo). Sob esse m√©todo, o gerenciador de recursos salva as informa√ß√µes necess√°rias para se recuperar de uma falha, se prepara para a confirma√ß√£o final de altera√ß√µes do seu lado e vota para confirmar ou reverter as altera√ß√µes. Se chega uma segunda fase, dependendo da disponibilidade de recursos e controle dos resultados da vota√ß√£o da transa√ß√£o controle √© um dos tr√™s m√©todos: </font></font><code>Commit</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, </font></font><code>InDoubt</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, </font></font><code>Rollback</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ISinglePhaseNotification.</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O gerenciador de recursos implementa essa interface se ele deseja fornecer ao gerente de transa√ß√µes a oportunidade de otimizar a execu√ß√£o, reduzindo a segunda fase de confirma√ß√£o. Se o gerenciador de transa√ß√µes vir apenas um gerenciador de recursos, na primeira fase de confirma√ß√£o, ele tentar√° chamar o m√©todo do gerenciador de recursos </font></font><code>SinglePhaseCommit</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(em vez disso </font></font><code>IEnlistmentNotification.Prepare</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) e, assim, excluir a vota√ß√£o e a transi√ß√£o para a segunda fase. Essa abordagem tem vantagens e desvantagens, sobre as quais a Microsoft escreveu mais claramente </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">aqui</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ITransactionPromoter.</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> O gerenciador de recursos implementa essa interface (n√£o apenas diretamente, mas atrav√©s da interface</font></font><code>IPromotableSinglePhaseNotification</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">), se ele quiser fornecer ao gerente de transa√ß√µes a capacidade de aderir ao protocolo Lightweight, mesmo quando estiver chamando remotamente, at√© que surjam outras condi√ß√µes que exijam complica√ß√£o do protocolo. Quando voc√™ precisar complicar o protocolo, o m√©todo ser√° chamado </font></font><code>Promote</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">IPromotableSinglePhaseNotification.</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> O gerenciador de recursos implementa essa interface para, em primeiro lugar, implementar a interface </font></font><code>ITransactionPromoter</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">e, em segundo lugar, para que o gerenciador de transa√ß√µes possa usar confirma√ß√£o de fase √∫nica, m√©todos de chamada </font></font><code>IPromotableSinglePhaseNotification.SinglePhaseCommit</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">e </font></font><code>IPromotableSinglePhaseNotification.Rollback</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. O gerenciador de transa√ß√µes chama um m√©todo </font></font><code>IPromotableSinglePhaseNotification.Initialize</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">para marcar o registro bem-sucedido do gerenciador de recursos de maneira simplificada. Mais ou menos, isso pode ser entendido em </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">um documento da Microsoft</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Vamos olhar um pouco mais</font></font><code>System.Transactions.Enlistment</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">e seus herdeiros. Esse tipo de inst√¢ncia √© fornecido pelo gerenciador de transa√ß√µes quando ele chama os m√©todos de interface implementados pelo gerenciador de recursos.</font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/qi/bd/xc/qibdxcddktegq5h2xnpuaelygj0.png"></div><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Alistamento. </font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O gerenciador de recursos pode chamar um √∫nico m√©todo desse tipo - </font></font><code>Done</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, - para sinalizar a conclus√£o bem-sucedida de sua parte do trabalho. </font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PreparingEnlistment. </font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Usando uma inst√¢ncia desse tipo durante a primeira fase de confirma√ß√£o, o gerenciador de recursos pode sinalizar sua inten√ß√£o de confirmar ou reverter as altera√ß√µes. </font><font style="vertical-align: inherit;">Um gerenciador de recursos de longa dura√ß√£o tamb√©m pode obter as informa√ß√µes necess√°rias para se recuperar de uma falha do sistema. </font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SinglePhaseEnlistment. </font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Usando uma inst√¢ncia desse tipo, o gerenciador de recursos pode transmitir informa√ß√µes ao gerente de transa√ß√µes sobre os resultados de seu trabalho usando um esquema simplificado (confirma√ß√£o de fase √∫nica).</font></font><br><br><a name="LimitationsAndAlternatives"></a><h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Limita√ß√µes e alternativas de transa√ß√£o distribu√≠da por software </font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Um breve estudo das opini√µes encontradas na Internet mostra que, em muitas √°reas, as transa√ß√µes distribu√≠das est√£o fora de moda. D√™ uma olhada </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">neste coment√°rio malicioso</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , por exemplo </font><font style="vertical-align: inherit;">. O principal objeto de cr√≠tica, que √© brevemente mencionado </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">aqui</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , √© a natureza s√≠ncrona (bloqueadora) das transa√ß√µes distribu√≠das. Se o usu√°rio enviou uma solicita√ß√£o durante o processamento em que uma transa√ß√£o distribu√≠da foi organizada, ele receber√° uma resposta somente depois que (com √™xito ou com erro) todos os subsistemas inclu√≠dos na transa√ß√£o terminarem de funcionar. Ao mesmo tempo, h√° uma opini√£o apoiada por pesquisas de que o protocolo de confirma√ß√£o de duas fases mostra um desempenho ruim, especialmente com um aumento no n√∫mero de subsistemas envolvidos na transa√ß√£o, como √© mencionado, por exemplo, em</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">esta publica√ß√£o em "Habr√©"</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Se o criador do sistema preferir retornar a resposta ao usu√°rio o mais r√°pido poss√≠vel, adiando a coordena√ß√£o dos dados para mais tarde, ent√£o alguma outra solu√ß√£o ser√° mais adequada para ele. No contexto do teorema de Brewer (teorema da </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CAP</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ), podemos dizer que as transa√ß√µes distribu√≠das s√£o adequadas para casos em que a consist√™ncia dos dados √© mais importante que a disponibilidade.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Existem outras restri√ß√µes pr√°ticas no uso de transa√ß√µes distribu√≠das por software. Por exemplo, foi estabelecido experimentalmente que transa√ß√µes distribu√≠das usando o protocolo OleTx n√£o deveriam cruzar dom√≠nios de rede. De qualquer forma, longas tentativas de faz√™-los funcionar n√£o tiveram √™xito. Al√©m disso, foi revelado que a intera√ß√£o entre v√°rias inst√¢ncias do Oracle Database (transa√ß√µes de banco de dados distribu√≠das) imp√µe s√©rias restri√ß√µes √† aplicabilidade das transa√ß√µes distribu√≠das por software (novamente, falha ao iniciar).</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Quais s√£o as alternativas para transa√ß√µes distribu√≠das? Primeiro, devo dizer que ser√° muito dif√≠cil prescindir de transa√ß√µes t√©cnicas (normais, n√£o distribu√≠das). √â prov√°vel que existam processos no sistema que possam interromper temporariamente a integridade dos dados e ser√° necess√°rio, de alguma forma, supervisionar esses processos. Da mesma forma, em termos de √°rea de assunto, pode surgir um conceito que inclua um processo implementado por um conjunto de processos em diferentes sistemas t√©cnicos, que deve come√ßar e terminar no campo de dados integrais. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Passando para alternativas √†s transa√ß√µes distribu√≠das, podemos observar solu√ß√µes baseadas em servi√ßos de mensagens, como RabbitMQ e Apache Kafka. Em </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">desta publica√ß√£o em "Habr√©"</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> visto quatro destas solu√ß√µes:</font></font><br><br><ol><li>   ,        ,    ; </li><li>    ,           (Transaction Log Tailing); </li><li>       ,       ; </li><li>             (Event Sourcing). </li></ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Outra alternativa √© o modelo Saga. Envolve uma cascata de subsistemas com suas transa√ß√µes locais. Ap√≥s a conclus√£o do trabalho, cada sistema chama o seguinte (independentemente ou com a ajuda de um coordenador). Para cada transa√ß√£o, h√° uma transa√ß√£o de cancelamento correspondente e, em vez de transferir o controle, o subsistema pode iniciar o cancelamento das altera√ß√µes feitas anteriormente pelos subsistemas anteriores. Em "Habr√©", existem alguns bons artigos sobre o modelo "Saga". Por exemplo, </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">esta publica√ß√£o</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> fornece informa√ß√µes gerais sobre a manuten√ß√£o dos princ√≠pios do ACID em microsservi√ßos, e </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">este artigo</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> detalha um exemplo de implementa√ß√£o do modelo Saga com um coordenador.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Em nossa empresa, alguns produtos usam com √™xito transa√ß√µes distribu√≠das por software por meio do WCF, mas existem outras op√ß√µes. Certa vez, quando tentamos fazer dos amigos um novo sistema com transa√ß√µes distribu√≠das, tivemos muitos problemas, incluindo uma colis√£o com as limita√ß√µes descritas acima e problemas paralelos com a atualiza√ß√£o da infraestrutura de software. Portanto, em condi√ß√µes de escassez de recursos para execu√ß√£o em outra decis√£o de capital, aplicamos as seguintes t√°ticas. A parte chamada captura as altera√ß√µes em qualquer caso, mas observa que elas est√£o em um estado de rascunho, portanto essas altera√ß√µes ainda n√£o afetam a opera√ß√£o do sistema chamado. Em seguida, o chamador, ao concluir seu trabalho por meio de uma transa√ß√£o distribu√≠da, o DBMS ativa as altera√ß√µes feitas pelo sistema chamado. Desta maneiraem vez de transa√ß√µes distribu√≠das por software, usamos transa√ß√µes DBMS distribu√≠das, que nesse caso se mostraram muito mais confi√°veis.</font></font><br><br><a name="NetCore"></a><h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Ent√£o est√° no .NET Core? </font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">No .NET Core (e at√© no .NET Standard), existem todos os tipos necess√°rios para organizar transa√ß√µes e criar seu pr√≥prio gerenciador de recursos. </font><font style="vertical-align: inherit;">Infelizmente, no .NET Core, as transa√ß√µes baseadas </font></font><code>System.Transactions</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">t√™m uma limita√ß√£o s√©ria: elas funcionam apenas com o protocolo Lightweight. </font><font style="vertical-align: inherit;">Por exemplo, se dois gerenciadores de recursos dur√°veis ‚Äã‚Äãforem usados ‚Äã‚Äãno c√≥digo, em tempo de execu√ß√£o, o ambiente emitir√° uma exce√ß√£o assim que o segundo gerenciador for chamado.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O fato √© que eles tentam tornar o .NET Core independente do sistema operacional; portanto, o link para gerenciadores de transa√ß√µes como KTM e MSDTC √© exclu√≠do, ou seja, eles s√£o necess√°rios para oferecer suporte a transa√ß√µes com as propriedades especificadas. </font><font style="vertical-align: inherit;">√â poss√≠vel que a conex√£o dos gerenciadores de transa√ß√µes seja implementada na forma de plug-ins, mas at√© agora isso foi escrito com um forcado, para que voc√™ ainda n√£o possa contar com o uso industrial de transa√ß√µes distribu√≠das no .NET Core. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Por experi√™ncia, voc√™ pode verificar as diferen√ßas nas transa√ß√µes distribu√≠das no .NET Framework e no .NET Core escrevendo o mesmo c√≥digo, compilando e executando-o em plataformas diferentes.</font></font><br><br><div class="spoiler"> <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Um exemplo desse c√≥digo que chama o SQL Server e o Oracle Database sequencialmente.</font></font></b> <div class="spoiler_text"><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Main</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params">[] args</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> scope = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> System.Transactions.TransactionScope(System.Transactions.TransactionScopeOption.Required)) { MsSqlServer(); Oracle(); scope.Complete(); } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Oracle</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> conn = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Oracle.ManagedDataAccess.Client.OracleConnection(<span class="hljs-string"><span class="hljs-string">"User Id=some_user;Password=some_password;Data Source=some_db"</span></span>)) { conn.Open(); <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> cmd = conn.CreateCommand()) { cmd.CommandText = <span class="hljs-string"><span class="hljs-string">"update t_hello set id_hello = 2 where id_hello = 1"</span></span>; cmd.ExecuteNonQuery(); } conn.Close(); } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">MsSqlServer</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> builder = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> System.Data.SqlClient.SqlConnectionStringBuilder { DataSource = <span class="hljs-string"><span class="hljs-string">"some_computer\\some_db"</span></span>, UserID = <span class="hljs-string"><span class="hljs-string">"some_user"</span></span>, Password = <span class="hljs-string"><span class="hljs-string">"some_password"</span></span>, InitialCatalog = <span class="hljs-string"><span class="hljs-string">"some_scheme"</span></span>, Enlist = <span class="hljs-literal"><span class="hljs-literal">true</span></span>, }; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> conn = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> System.Data.SqlClient.SqlConnection(builder.ConnectionString)) { conn.Open(); <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> cmd = conn.CreateCommand()) { cmd.CommandText = <span class="hljs-string"><span class="hljs-string">"update t_hello set id_hello = 2 where id_hello = 1"</span></span>; cmd.ExecuteNonQuery(); } conn.Close(); } }</code> </pre> </div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Projetos prontos para compila√ß√£o </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">est√£o no GitHub</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A execu√ß√£o do exemplo para o .NET Core falha. </font><font style="vertical-align: inherit;">O local e o tipo da exce√ß√£o lan√ßada dependem da ordem da chamada DBMS, mas, em qualquer caso, essa exce√ß√£o indica uma opera√ß√£o de transa√ß√£o inv√°lida. </font><font style="vertical-align: inherit;">A execu√ß√£o do exemplo para o .NET Framework ser√° bem-sucedida se o MSDTC estiver em execu√ß√£o no momento; </font><font style="vertical-align: inherit;">no entanto, na interface gr√°fica do MSDTC, √© poss√≠vel observar o registro de uma transa√ß√£o distribu√≠da.</font></font><br><br><a name="WCF"></a><h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Transa√ß√µes Distribu√≠das e WCF </font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O Windows Communication Foundation (WCF) √© a estrutura .NET para organizar e chamar servi√ßos de rede. Comparado √†s abordagens mais modernas da Web REST e ASP.NET, ela tem suas pr√≥prias vantagens e desvantagens. O WCF √© muito amigo das transa√ß√µes do .NET e, no mundo do .NET Framework, √© conveniente us√°-lo para organizar transa√ß√µes distribu√≠das entre o cliente e o servi√ßo. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">No .NET Core, essa tecnologia funciona apenas no lado do cliente, ou seja, voc√™ n√£o pode criar um servi√ßo, mas pode se referir apenas a um existente. Isso, no entanto, n√£o √© muito importante, porque, como mencionado acima, com transa√ß√µes distribu√≠das no .NET Core, as coisas n√£o est√£o indo bem. </font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Como o WCF funciona</font></font></b> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Para leitores que n√£o est√£o familiarizados com o WCF, aqui est√£o as informa√ß√µes mais curtas sobre o que essa tecnologia √© na pr√°tica. Contexto - dois sistemas de informa√ß√£o chamados cliente e servi√ßo. O cliente em tempo de execu√ß√£o acessa outro sistema de informa√ß√µes que suporta o servi√ßo de interesse do cliente e requer que alguma opera√ß√£o seja executada. Em seguida, o gerenciamento √© retornado ao cliente.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Para criar um servi√ßo no WCF, voc√™ geralmente precisa escrever uma interface que descreva o contrato para o servi√ßo que est√° sendo criado e uma classe que implemente essa interface. A classe e a interface s√£o marcadas com atributos especiais do WCF que os distinguem do restante dos tipos e especificam alguns detalhes do comportamento durante a descoberta e chamada do servi√ßo. Esses tipos s√£o agrupados em algo que funciona como um servidor (por exemplo, em uma DLL na qual o IIS est√° configurado) e s√£o complementados por um arquivo de configura√ß√£o (existem op√ß√µes), onde s√£o indicados detalhes da implementa√ß√£o do servi√ßo. Ap√≥s o in√≠cio, o servi√ßo pode ser acessado, por exemplo, no endere√ßo de rede; no navegador da Internet, voc√™ pode ver os contratos que o servi√ßo solicitado implementa.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Um programador que deseja acessar um servi√ßo WCF existente usa um utilit√°rio de console ou uma interface gr√°fica incorporada ao ambiente de desenvolvimento para formar tipos em C # (ou em outro idioma suportado) que correspondem aos contratos de servi√ßo no endere√ßo do servi√ßo. O arquivo com os tipos obtidos √© inclu√≠do no projeto do aplicativo cliente e, depois disso, o programador usa os mesmos termos contidos na interface de servi√ßo, aproveitando os benef√≠cios do progresso (digita√ß√£o est√°tica). Al√©m disso, o arquivo de configura√ß√£o do cliente especifica as caracter√≠sticas t√©cnicas do servi√ßo chamado (ele tamb√©m pode ser configurado no c√≥digo, sem o arquivo de configura√ß√£o).</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O WCF suporta v√°rios tipos de transporte, criptografia e outros par√¢metros t√©cnicos mais sutis. </font><font style="vertical-align: inherit;">A maioria deles est√° unida pelo conceito de "encaderna√ß√£o" (encaderna√ß√£o). </font><font style="vertical-align: inherit;">Existem tr√™s par√¢metros importantes para o servi√ßo WCF:</font></font><br><br><ol><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> o endere√ßo em que est√° dispon√≠vel; </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> vinculativo </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> contrato (interfaces). </font></font></li></ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Todos esses par√¢metros s√£o definidos nos arquivos de configura√ß√£o de servi√ßo e cliente. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Em nossa empresa, o WCF (com e sem transa√ß√µes distribu√≠das) √© amplamente utilizado em produtos implementados, no entanto, dadas as tend√™ncias da moda, seu uso em novos produtos ainda est√° em quest√£o. </font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Como iniciar transa√ß√µes distribu√≠das no WCF</font></font></b> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Para iniciar transa√ß√µes baseadas no WCF </font></font><code>System.Transactions</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, o programador precisa definir v√°rios atributos no c√≥digo, verifique se as liga√ß√µes usadas suportam transa√ß√µes distribu√≠das, </font></font><code>transactionFlow="true"</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">que </font><font style="vertical-align: inherit;">elas sejam gravadas no cliente e no servi√ßo </font><font style="vertical-align: inherit;">e se um gerenciador de transa√ß√µes adequado esteja sendo executado em todos os computadores envolvidos (provavelmente , ser√° MSDTC).</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Liga√ß√µes de transa√ß√£o distribu√≠da: NetTcpBinding, NetNamedPipeBinding, WSHttpBinding, WSDualHttpBinding e WSFederationHttpBinding. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O m√©todo (opera√ß√£o) da interface de servi√ßo deve ser marcado com um atributo </font></font><code>System.ServiceModel.TransactionFlowAttribute</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Em seguida, com determinados par√¢metros de atributo e ao definir o par√¢metro de </font></font><code>TransactionScopeRequired</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">atributo </font><font style="vertical-align: inherit;">, </font><font style="vertical-align: inherit;">a </font></font><code>System.ServiceModel.OperationBehaviorAttribute</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">transa√ß√£o ser√° distribu√≠da entre o cliente e o servi√ßo. </font><font style="vertical-align: inherit;">Al√©m disso, por padr√£o, o servi√ßo √© considerado votado para confirmar a transa√ß√£o, a menos que uma exce√ß√£o seja lan√ßada no tempo de execu√ß√£o. </font><font style="vertical-align: inherit;">Para alterar esse comportamento, voc√™ deve definir o valor do par√¢metro do </font></font><code>TransactionAutoComplete</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">atributo </font><font style="vertical-align: inherit;">correspondente </font></font><code>System.ServiceModel.OperationBehaviorAttribute</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br><br><div class="spoiler"> <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O c√≥digo para um servi√ßo WCF simples que suporta transa√ß√µes distribu√≠das.</font></font></b> <div class="spoiler_text"><pre> <code class="cs hljs">[<span class="hljs-meta"><span class="hljs-meta">System.ServiceModel.ServiceContract</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">interface</span></span> <span class="hljs-title"><span class="hljs-title">IMyService</span></span> { [System.ServiceModel.OperationContract] [System.ServiceModel.TransactionFlow(System.ServiceModel.TransactionFlowOption.Mandatory)] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">DoSomething</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> input</span></span></span><span class="hljs-function">)</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">MyService</span></span> : <span class="hljs-title"><span class="hljs-title">IMyService</span></span> { [System.ServiceModel.OperationBehavior(TransactionScopeRequired = <span class="hljs-literal"><span class="hljs-literal">true</span></span>)] [System.ServiceModel.TransactionFlow(System.ServiceModel.TransactionFlowOption.Mandatory)] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">DoSomething</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> input</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (input == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> System.ArgumentNullException(<span class="hljs-keyword"><span class="hljs-keyword">nameof</span></span>(input)); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> input.Length; } }</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Obviamente, ele difere do c√≥digo de servi√ßo regular apenas no uso do atributo </font></font><code>System.ServiceModel.TransactionFlow</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">e na configura√ß√£o especial do atributo </font></font><code>System.ServiceModel.OperationBehavior</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font></div></div><br><div class="spoiler"> <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Exemplo de configura√ß√£o para este servi√ßo.</font></font></b> <div class="spoiler_text"><pre> <code class="cs hljs">&lt;system.serviceModel&gt; &lt;services&gt; &lt;service name=<span class="hljs-string"><span class="hljs-string">"WcfWithTransactionsExample.MyService"</span></span> behaviorConfiguration=<span class="hljs-string"><span class="hljs-string">"serviceBehavior"</span></span>&gt; &lt;endpoint address=<span class="hljs-string"><span class="hljs-string">""</span></span> binding=<span class="hljs-string"><span class="hljs-string">"wsHttpBinding"</span></span> bindingConfiguration=<span class="hljs-string"><span class="hljs-string">"mainWsBinding"</span></span> contract=<span class="hljs-string"><span class="hljs-string">"WcfWithTransactionsExample.IMyService"</span></span>/&gt; &lt;endpoint address=<span class="hljs-string"><span class="hljs-string">"mex"</span></span> contract=<span class="hljs-string"><span class="hljs-string">"IMetadataExchange"</span></span> binding=<span class="hljs-string"><span class="hljs-string">"mexHttpBinding"</span></span>/&gt; &lt;/service&gt; &lt;/services&gt; &lt;bindings&gt; &lt;wsHttpBinding&gt; &lt;binding name=<span class="hljs-string"><span class="hljs-string">"mainWsBinding"</span></span> maxReceivedMessageSize=<span class="hljs-string"><span class="hljs-string">"209715200"</span></span> maxBufferPoolSize=<span class="hljs-string"><span class="hljs-string">"209715200"</span></span> transactionFlow=<span class="hljs-string"><span class="hljs-string">"true"</span></span> closeTimeout=<span class="hljs-string"><span class="hljs-string">"00:10:00"</span></span> openTimeout=<span class="hljs-string"><span class="hljs-string">"00:10:00"</span></span> receiveTimeout=<span class="hljs-string"><span class="hljs-string">"00:10:00"</span></span> sendTimeout=<span class="hljs-string"><span class="hljs-string">"00:10:00"</span></span>&gt; &lt;security mode=<span class="hljs-string"><span class="hljs-string">"None"</span></span>/&gt; &lt;readerQuotas maxArrayLength=<span class="hljs-string"><span class="hljs-string">"209715200"</span></span> maxStringContentLength=<span class="hljs-string"><span class="hljs-string">"209715200"</span></span>/&gt; &lt;/binding&gt; &lt;/wsHttpBinding&gt; &lt;/bindings&gt; &lt;/system.serviceModel&gt;</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Observe que a liga√ß√£o √© do tipo WSHttpBinding e o atributo √© usado </font></font><code>transactionFlow="true"</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br></div></div><br><a name="TLDR3"></a><h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Se√ß√£o TL; DR </font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">As transa√ß√µes distribu√≠das incluem v√°rios gerenciadores de recursos e todas as altera√ß√µes devem ser confirmadas ou revertidas. Alguns DBMSs modernos implementam transa√ß√µes distribu√≠das que fornecem um mecanismo conveniente para conectar v√°rios bancos de dados. As transa√ß√µes distribu√≠das por software (n√£o implementadas no DBMS) podem incluir diferentes combina√ß√µes de gerenciadores de recursos em computadores diferentes executando sistemas operacionais diferentes, mas possuem limita√ß√µes que devem ser levadas em considera√ß√£o antes de confiar nelas. Uma alternativa moderna √†s transa√ß√µes distribu√≠das s√£o as solu√ß√µes de mensagens. No .NET Core, transa√ß√µes distribu√≠das ainda n√£o s√£o suportadas.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O WCF √© uma das ferramentas padr√£o e comprovadas para criar e acessar servi√ßos no mundo .NET, suportando v√°rios tipos de transporte e criptografia. </font><font style="vertical-align: inherit;">O WCF √© muito amigo de transa√ß√µes distribu√≠das com base em </font></font><code>System.Transactions</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">A configura√ß√£o de transa√ß√µes distribu√≠das para o WCF consiste em marcar o c√≥digo com v√°rios atributos e adicionar algumas palavras nos arquivos de configura√ß√£o de servi√ßo e cliente. </font><font style="vertical-align: inherit;">Nem todas as liga√ß√µes do WCF suportam transa√ß√µes distribu√≠das. </font><font style="vertical-align: inherit;">Al√©m disso, √© claro que as transa√ß√µes no WCF t√™m as mesmas limita√ß√µes que sem o uso do WCF. </font><font style="vertical-align: inherit;">At√© agora, a plataforma .NET Core permite acessar servi√ßos no WCF, em vez de cri√°-los.</font></font><br><br><a name="Conclusion"></a><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Conclus√£o Ber√ßo </font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Esta postagem √© uma vis√£o geral dos conceitos b√°sicos das transa√ß√µes de software .NET. Algumas conclus√µes sobre tend√™ncias nas transa√ß√µes de software podem ser encontradas nas se√ß√µes sobre aplicabilidade e limita√ß√µes dos assuntos discutidos e, em conclus√£o, s√£o coletadas as principais teses da publica√ß√£o. Suponho que eles possam ser usados ‚Äã‚Äãcomo uma c√°bula ao considerar as transa√ß√µes de software como uma das op√ß√µes para implementar um sistema t√©cnico ou atualizar informa√ß√µes relevantes na mem√≥ria. </font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Transa√ß√µes (√°rea de assunto, DBMS, software)</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. √Äs vezes, os requisitos de dom√≠nio s√£o formulados na forma de transa√ß√µes - opera√ß√µes que, come√ßando no campo de dados integrais, ap√≥s a conclus√£o (inclusive sem √™xito) tamb√©m devem entrar no campo de dados integrais (possivelmente j√° diferentes). Esses requisitos geralmente s√£o implementados como transa√ß√µes do sistema. Um exemplo cl√°ssico de uma transa√ß√£o √© a transfer√™ncia de dinheiro entre duas contas, consistindo em duas opera√ß√µes indivis√≠veis - retirar dinheiro de uma conta e creditar para outra. Al√©m das transa√ß√µes conhecidas implementadas pelo DBMS, tamb√©m existem transa√ß√µes de software, por exemplo, no mundo .NET. Os gerenciadores de recursos s√£o componentes de software que est√£o cientes da exist√™ncia de tais transa√ß√µes e t√™m a capacidade de serem inclu√≠dos nelas, ou seja, confirmar ou reverter as altera√ß√µes feitas.Os gerentes de recursos recebem instru√ß√µes sobre como confirmar e reverter altera√ß√µes do gerenciador de transa√ß√µes, que √© a base da infraestrutura</font></font><code>System.Transactions</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Gerentes de recursos dur√°veis ‚Äã‚Äãe intermitentes.</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Os gerentes de recursos de longo prazo oferecem suporte √† recupera√ß√£o de dados ap√≥s uma falha do sistema. Os drivers DBMS para .NET geralmente oferecem essa funcionalidade. Os gerenciadores de recursos intermitentes </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">n√£o</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> oferecem suporte √† recupera√ß√£o de desastres. A mem√≥ria transacional program√°tica - uma maneira de gerenciar objetos na RAM - pode ser vista como um exemplo de um gerenciador de recursos inconstante. </font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Transa√ß√µes e gerenciadores de recursos .NET.</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> O programador .NET usa transa√ß√µes de software e cria seus pr√≥prios gerenciadores de recursos usando tipos do espa√ßo para nome</font></font><code>System.Transactions</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Essa infraestrutura permite o uso de transa√ß√µes de v√°rios aninhamentos e isolamentos (com limita√ß√µes conhecidas). O uso de transa√ß√µes n√£o √© complicado e consiste em agrupar o c√≥digo em um bloco </font></font><code>using</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">com certas caracter√≠sticas. No entanto, os gerenciadores de recursos inclu√≠dos dessa maneira na transa√ß√£o devem manter a funcionalidade necess√°ria para sua parte. Usar gerenciadores de recursos heterog√™neos em uma transa√ß√£o ou usar um gerenciador de maneiras diferentes pode transformar automaticamente uma transa√ß√£o em distribu√≠da. </font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Transa√ß√µes distribu√≠das (DBMS, software).</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Uma transa√ß√£o distribu√≠da abrange v√°rios subsistemas, cujas mudan√ßas devem ser sincronizadas, ou seja, elas s√£o confirmadas todas juntas ou revertidas. As transa√ß√µes distribu√≠das s√£o implementadas em alguns DBMSs modernos. As transa√ß√µes distribu√≠das por software (n√£o s√£o as implementadas pelo DBMS) imp√µem restri√ß√µes adicionais aos processos e plataformas em intera√ß√£o. As transa√ß√µes distribu√≠das gradualmente saem de moda, dando lugar a solu√ß√µes baseadas em servi√ßos de mensagens. Para transformar uma transa√ß√£o comum em uma distribu√≠da, o programador n√£o precisa fazer nada: quando um gerenciador de recursos com certas caracter√≠sticas √© inclu√≠do na transa√ß√£o no tempo de execu√ß√£o, o gerenciador de transa√ß√µes faz automaticamente o que for necess√°rio. As transa√ß√µes regulares de software est√£o dispon√≠veis no .NET Core e .NET Standard, e as transa√ß√µes distribu√≠das n√£o est√£o dispon√≠veis.</font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Transa√ß√µes distribu√≠das atrav√©s do WCF. </font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O WCF √© uma das ferramentas .NET padr√£o para criar e chamar servi√ßos, que tamb√©m suporta protocolos padronizados. </font><font style="vertical-align: inherit;">Em outras palavras, os servi√ßos WCF configurados de uma maneira espec√≠fica podem ser acessados ‚Äã‚Äãa partir de qualquer aplicativo, n√£o apenas .NET ou Windows. </font><font style="vertical-align: inherit;">Para criar uma transa√ß√£o distribu√≠da sobre o WCF, √© necess√°rio marcar os tipos que comp√µem o servi√ßo com atributos adicionais e fazer altera√ß√µes m√≠nimas nos arquivos de configura√ß√£o do servi√ßo e do cliente. </font><font style="vertical-align: inherit;">Voc√™ n√£o pode criar servi√ßos WCF no .NET Core e .NET Standard, mas pode criar clientes WCF. </font></font><br><br> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Exemplo para verificar System.Transactions no GitHub</font></font></a> <br><br><div class="spoiler">  <b class="spoiler_title">Refer√™ncias</b> <div class="spoiler_text"><h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Conceitos b√°sicos </font></font></h4><br> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">ACID</a> ( ¬´¬ª) <br> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">  </a> ( Microsoft) <br> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="> </a> ( Microsoft) <br> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">  </a> ( ¬´¬ª) <br> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="> </a> ( ¬´¬ª) <br> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="> </a> ( ¬´¬ª) <br><br><h4>     </h4><br> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">   X/Open XA</a> ( The Open Group) <br> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Java Transaction API</a> ( ¬´¬ª) <br> <a href="">     Cache</a> (  InterSystems) <br><br><h4>   .NET </h4><br> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">   .NET</a> (   Tech Blog Collection) <br> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">     TransactionScope</a> (¬´¬ª) <br> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">  ,     </a> ( Microsoft) <br> <a href="">   .NET Standard 2.0</a> ( .NET Standard  GitHub) <br> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">       </a> ( YarFullStack) <br><br><h4>    </h4><br> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">     </a> (¬´¬ª) <br> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">     </a> (¬´¬ª) <br> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">    ¬´¬ª     </a> (¬´¬ª) <br> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">     ¬´¬ª  </a> (¬´¬ª) <br> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">    </a> (¬´¬ª) <br></div></div><br><div class="spoiler"> <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Editorial</font></font></b> <div class="spoiler_text"><ul><li> 20.12.2018 . </li><li> 21.12.2018  .      <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" class="user_link">OlegAxenow</a> . </li><li> 23.12.2018      <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" class="user_link">qw1</a> . </li></ul><br></div></div></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt433136/">https://habr.com/ru/post/pt433136/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt433122/index.html">React-Hot-Loader v4.6</a></li>
<li><a href="../pt433126/index.html">Zabbix Review: Como organizar uma revis√£o de c√≥digo para monitorar a configura√ß√£o</a></li>
<li><a href="../pt433128/index.html">O que os profissionais de TI jogam e n√£o jogam (Boletim 2018)</a></li>
<li><a href="../pt433130/index.html">Que a for√ßa esteja conosco: nossa pr√≥pria imunidade contra o c√¢ncer</a></li>
<li><a href="../pt433132/index.html">"Calend√°rio do testador" para dezembro. Tente uma abordagem diferente</a></li>
<li><a href="../pt433138/index.html">Cinco princ√≠pios de design de produto no Booking</a></li>
<li><a href="../pt433140/index.html">M√≥dulo de cliente do Google Pay pronto</a></li>
<li><a href="../pt433142/index.html">Cl√°ssicos atemporais ou uma vis√£o geral de novos vetores de ataque atrav√©s do Microsoft Office</a></li>
<li><a href="../pt433144/index.html">Lan√ßamento do .NET Core 2.2. Novidades (1 de 3)</a></li>
<li><a href="../pt433146/index.html">[competi√ß√£o] Os 25 principais consoles de jogos (abane os velhos tempos)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>