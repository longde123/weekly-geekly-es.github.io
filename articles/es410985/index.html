<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ü§òüèº üíô ü•ã Soluci√≥n de c√≥digo abierto para una reducci√≥n de diez veces en la latencia de lectura de datos con Apache Cassandra üò≥ üíá üçû</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Instagram tiene una de las bases de datos Apache Cassandra m√°s grandes del mundo. El proyecto comenz√≥ a usar Cassandra en 2012 para reemplazar a Redis...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Soluci√≥n de c√≥digo abierto para una reducci√≥n de diez veces en la latencia de lectura de datos con Apache Cassandra</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/wirex/blog/410985/"><img src="https://habrastorage.org/webt/8h/qz/qy/8hqzqyfytcsvjn_xc9y5uj9j7ns.jpeg"><br><br>  Instagram tiene una de las bases de datos Apache Cassandra m√°s grandes del mundo.  El proyecto comenz√≥ a usar Cassandra en 2012 para reemplazar a Redis y apoyar la implementaci√≥n de caracter√≠sticas de la aplicaci√≥n, como un sistema de reconocimiento de fraude, Tape y Direct.  Al principio, los cl√∫steres de Cassandra trabajaban en AWS, pero luego los ingenieros los migraron a la infraestructura de Facebook junto con todos los dem√°s sistemas de Instagram.  Cassandra se desempe√±√≥ muy bien en t√©rminos de confiabilidad y tolerancia a fallas.  Al mismo tiempo, las m√©tricas de latencia al leer datos claramente podr√≠an mejorarse. <br><br>  El a√±o pasado, el equipo de soporte de Cassandra en Instagram comenz√≥ a trabajar en un proyecto destinado a reducir significativamente la latencia en la lectura de datos en Cassandra, que los ingenieros llamaron Rocksandra.  En este art√≠culo, el autor explica qu√© motiv√≥ al equipo a implementar este proyecto, las dificultades que tuvieron que superarse y las m√©tricas de rendimiento que los ingenieros usan tanto en los entornos de nube internos como externos. <br><br><h3>  Motivos para la transici√≥n </h3><br>  Instagram utiliza activa y ampliamente Apache Cassandra como un servicio de almacenamiento de valor clave.  La mayor√≠a de las solicitudes de Instagram se realizan en l√≠nea, por lo tanto, para proporcionar una experiencia de usuario confiable y agradable para cientos de millones de usuarios de Instagram, los SLA son muy exigentes con el rendimiento del sistema. <a name="habracut"></a><br><br>  Instagram se adhiere a una calificaci√≥n de confiabilidad de cinco y nueve.  Esto significa que el n√∫mero de fallas en un momento dado no puede exceder 0.001%.  Para mejorar el rendimiento, los ingenieros supervisan activamente el rendimiento y las latencias de varios cl√∫steres de Cassandra y se aseguran de que el 99% de todas las solicitudes se ajusten a un determinado indicador (retraso P99). <br><br>  A continuaci√≥n se muestra un gr√°fico que muestra el retraso del lado del cliente de uno para uno de los grupos de combate de Cassandra.  El azul indica la velocidad de lectura promedio (5 ms) y el naranja indica la velocidad de lectura del 99%, que var√≠a de 25 a 60 ms.  Sus cambios dependen mucho del tr√°fico del cliente. <br><br> <a href=""><img src="https://habrastorage.org/webt/hh/w0/qq/hhw0qq_z9ce4zqkys5m8irabeja.png"></a> <br><br> <a href=""><img src="https://habrastorage.org/webt/h3/bs/oz/h3bsoz7oxelnn-sm9xse1wcn4u4.png"></a> <br><br>  El estudio encontr√≥ que los fuertes estallidos de demora se deben en gran medida al trabajo del recolector de basura JVM.  Los ingenieros introdujeron una m√©trica llamada "porcentaje de paradas para SM" para medir el porcentaje de tiempo que el servidor Cassandra dedic√≥ a "detener el mundo", y fue acompa√±ado por una denegaci√≥n de servicio para las solicitudes de los clientes.  Aqu√≠ est√° la tabla anterior que muestra la cantidad de tiempo (en porcentaje) que pas√≥ hasta que el SM deja de usar el ejemplo de uno de los servidores de combate de Cassandra.  El indicador oscil√≥ entre el 1,25% en los momentos del tr√°fico m√°s peque√±o y el 2,5% en los momentos de carga m√°xima. <br><br>  El gr√°fico muestra que esta instancia del servidor Cassandra podr√≠a pasar el 2.5% de su tiempo recolectando basura en lugar de atender las solicitudes de los clientes.  Las operaciones preventivas del colector obviamente tuvieron un impacto significativo en el retraso P99, y por lo tanto qued√≥ claro que si pudi√©ramos reducir la tasa de detenci√≥n de CM, entonces los ingenieros podr√≠an reducir significativamente la tasa de retraso P99. <br><br><h3>  Soluci√≥n </h3><br>  Apache Cassandra es una base de datos distribuida basada en Java con su propio motor de almacenamiento de datos basado en √°rboles LSM.  Los ingenieros descubrieron que los componentes del motor, como una tabla de memoria, una herramienta de compresi√≥n, rutas de lectura / escritura, y algunos otros crearon muchos objetos en la memoria din√°mica de Java, lo que llev√≥ a la JVM a tener que realizar muchas operaciones generales adicionales.  Para reducir el impacto de los mecanismos de almacenamiento en el trabajo del recolector de basura, el equipo de soporte consider√≥ varios enfoques y finalmente decidi√≥ desarrollar un motor C ++ y reemplazar el existente con √©l. <br><br>  Los ingenieros no quer√≠an hacer todo desde cero y, por lo tanto, decidieron tomar RocksDB como base. <br><br>  RocksDB es una base de datos incorporada de c√≥digo abierto de alto rendimiento para almacenamiento de valor clave.  Est√° escrito en C ++, y su API tiene enlaces de lenguaje oficiales para C ++, C y Java.  RocksDB est√° optimizado para un alto rendimiento, especialmente en unidades r√°pidas como SSD.  Es ampliamente utilizado en la industria como motor de almacenamiento para MySQL, mongoDB y otras bases de datos populares. <br><br><h3>  Dificultades </h3><br>  En el proceso de implementaci√≥n del nuevo motor de almacenamiento en RocksDB, los ingenieros enfrentaron tres tareas dif√≠ciles y las resolvieron. <br><br>  La primera dificultad fue que Cassandra a√∫n carece de una arquitectura que permita la conexi√≥n de procesadores de datos de terceros.  Esto significa que el trabajo del motor existente est√° estrechamente interconectado con otros componentes de la base de datos.  Para encontrar un equilibrio entre la refactorizaci√≥n a gran escala y las iteraciones r√°pidas, los ingenieros definieron la API del nuevo motor, incluidas las interfaces de lectura, escritura y transmisi√≥n m√°s comunes.  Por lo tanto, el equipo de soporte pudo implementar nuevos mecanismos de procesamiento de datos para la API e insertarlos en las rutas de ejecuci√≥n de c√≥digo apropiadas dentro de Cassandra. <br><br>  La segunda dificultad fue que Cassandra soportaba tipos de datos estructurados y esquemas de tablas, mientras que RocksDB solo proporcionaba interfaces clave-valor.  Los ingenieros definieron cuidadosamente los algoritmos de codificaci√≥n y decodificaci√≥n para admitir el modelo de datos de Cassandra dentro de las estructuras de datos de RocksDB y garantizaron la continuidad de la sem√°ntica de consultas similares entre las dos bases de datos. <br><br>  La tercera dificultad estaba asociada con un componente tan importante para cualquier componente de base de datos distribuida como trabajar con flujos de datos.  Cada vez que se agrega o elimina un nodo de un cl√∫ster Cassandra, necesita distribuir correctamente los datos entre diferentes nodos para equilibrar la carga dentro del cl√∫ster.  Las implementaciones existentes de estos mecanismos se basaron en la obtenci√≥n de datos detallados del motor de base de datos existente.  Por lo tanto, los ingenieros tuvieron que separarlos unos de otros, crear una capa de abstracci√≥n e implementar una nueva opci√≥n para procesar secuencias utilizando la API RocksDB.  Para obtener flujos de gran ancho de banda, el equipo de soporte ahora primero distribuye los datos a archivos sst temporales, y luego usa la API especial de RocksDB para "tragar" los archivos, permitiendo que se descarguen simult√°neamente a la instancia de RocksDB. <br><br><h3>  Indicadores de desempe√±o </h3><br>  Despu√©s de casi un a√±o de desarrollo y pruebas, los ingenieros completaron la primera versi√≥n de la implementaci√≥n y la "implementaron" con √©xito en varios grupos de Instagram Instagram Cassandra.  En uno de los grupos de combate, el retraso P99 se redujo de 60 ms a 20 ms.  Las observaciones tambi√©n mostraron que las paradas de SM en este grupo cayeron del 2.5% al ‚Äã‚Äã0.3%, es decir, ¬°casi 10 veces! <br><br>  Los ingenieros tambi√©n quer√≠an verificar si Rocksandra pod√≠a funcionar bien en un entorno de nube p√∫blica.  El equipo de soporte cre√≥ un cl√∫ster Cassandra en AWS utilizando tres instancias i3.8 xlarge EC2, cada una con un procesador de 32 n√∫cleos, 244 GB de RAM y una incursi√≥n cero de cuatro unidades flash NVMe. <br><br>  Para las pruebas comparativas, utilizamos <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">NDBench</a> y el esquema de tabla predeterminado para el marco. <br><br><pre><code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> emp ( emp_uname <span class="hljs-type"><span class="hljs-type">text</span></span> <span class="hljs-keyword"><span class="hljs-keyword">PRIMARY KEY</span></span>, emp_dept <span class="hljs-type"><span class="hljs-type">text</span></span>, emp_first <span class="hljs-type"><span class="hljs-type">text</span></span>, emp_last <span class="hljs-type"><span class="hljs-type">text</span></span> )</code> </pre> <br>  Los ingenieros precargaron 250 millones de 6 filas de 6 KB cada una (se almacenan aproximadamente 500 GB de datos en cada servidor).  Luego, configure 128 lectores y escritores en NDBench. <br><br>  El equipo de soporte prob√≥ varias cargas y midi√≥ las latencias promedio de lectura / escritura de P99 / P999.  Los gr√°ficos a continuaci√≥n muestran que Rocksandra mostr√≥ latencias de lectura y escritura significativamente m√°s bajas y m√°s estables. <br><br><img src="https://habrastorage.org/webt/sc/7j/im/sc7jim4homfpkase00fbjixjhyq.png"><br><br><img src="https://habrastorage.org/webt/z1/ol/pw/z1olpwd4z6q-bp-kihfcf58j9bo.png"><br><br>  Los ingenieros tambi√©n verificaron la carga en modo de lectura sin escribir y descubrieron que con el mismo retraso de lectura P99 (2 ms), Rocksandra puede proporcionar un aumento de m√°s de 10 veces en la velocidad de lectura de informaci√≥n (300 K / s para Rocksandra frente a 30 K / s para C * 3.0). <br><br><img src="https://habrastorage.org/webt/jn/sy/fu/jnsyfumtlax15y1p0tkkalrc_f4.png"><br><br><img src="https://habrastorage.org/webt/iv/js/fs/ivjsfsiexo3bzmuklo_ughr0tju.png"><br><br><h3>  Planes futuros </h3><br>  El equipo de soporte de Instagram ha abierto el c√≥digo y el <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">marco de</a> <a href="">Rocksandra</a> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">para evaluar el rendimiento</a> .  Puede descargarlos de Github y probarlos en su propio entorno.  ¬°Aseg√∫rate de contarnos qu√© sucedi√≥! <br><br>  Como siguiente paso, el equipo est√° trabajando activamente para agregar un soporte m√°s amplio para la funcionalidad C *, como √≠ndices secundarios, correcciones y m√°s.  Y adem√°s, los ingenieros est√°n desarrollando la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">arquitectura del motor de base de datos de complementos en C *</a> para transferir a√∫n m√°s estos desarrollos a la comunidad de Apache Cassandra. <br><br> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><img src="https://habrastorage.org/files/4bd/bf6/597/4bdbf659775744b1bdbb4d8a00a0a980.png" alt="imagen"></a> </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/es410985/">https://habr.com/ru/post/es410985/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../es410969/index.html">5 tecnolog√≠as para el pr√≥ximo quinquenio: pron√≥stico de IBM</a></li>
<li><a href="../es410973/index.html">¬øQu√© drones se usan en el cine mundial?</a></li>
<li><a href="../es410977/index.html">Un intento de crear un dispositivo de entrada de informaci√≥n universal</a></li>
<li><a href="../es410979/index.html">"Hackear" el cerebro usando "im√°genes-contradicciones"</a></li>
<li><a href="../es410981/index.html">Yandex agreg√≥ protecci√≥n contra cripto mineros a su navegador</a></li>
<li><a href="../es410987/index.html">GLONASS se har√° tan preciso como el sistema de navegaci√≥n GPS</a></li>
<li><a href="../es410989/index.html">Predecesores de pulseras de fitness: pod√≥metro, monitor de frecuencia card√≠aca, ciclocomputador</a></li>
<li><a href="../es410991/index.html">Cartera de hardware de criptomonedas Ledger pirateada por un hacker de 15 a√±os</a></li>
<li><a href="../es410993/index.html">Alguien est√° enviando juguetes sexuales de Amazon a extra√±os. Amazon no sabe c√≥mo detenerlos</a></li>
<li><a href="../es410995/index.html">Telegram se queja de Rusia ante el Tribunal Europeo de Derechos Humanos</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>