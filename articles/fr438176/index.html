<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üåñ ‚ô•Ô∏è üå≥ Pr√©sentation d'IPSec chez Mikrotik üñáÔ∏è üñïüèº ‚òÑÔ∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="IPSec (s√©curit√© IP) - un ensemble de protocoles et d'algorithmes pour chiffrer les donn√©es dans les r√©seaux IPv4 et IPv6. Cela ne semble pas compliqu√©...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Pr√©sentation d'IPSec chez Mikrotik</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/438176/"><p>  IPSec (s√©curit√© IP) - un ensemble de protocoles et d'algorithmes pour chiffrer les donn√©es dans les r√©seaux IPv4 et IPv6.  Cela ne semble pas compliqu√©, mais IPSec n'√©tablit pas de r√®gles claires pour le chiffrement du trafic; √† la place, les d√©veloppeurs impl√©mentent un ensemble d'outils (protocoles et algorithmes), √† l'aide desquels l'administrateur cr√©e un canal s√©curis√© pour les donn√©es. </p><br><p>  Je veux aborder IPSec dans RouterOS un peu plus profond√©ment qu'un simple HOWTO, avec une th√©orie minimale et des exemples sur la fa√ßon de configurer et de d√©boguer IPSec.  Ce n'est pas un guide, et sans pratique sur un banc de test, il n'est pas recommand√© de commencer √† configurer de vrais tunnels et serveurs VPN. </p><a name="habracut"></a><br><h3 id="preimuschestva-i-nedostatki-ipsec">  Avantages et inconv√©nients d'IPSec </h3><br><p>  Forces: </p><br><ul><li>  Fonctionne au niveau du r√©seau du mod√®le OSI </li><li>  Il peut crypter le paquet source enti√®rement ou √† partir de la couche de transport et plus </li><li>  Il existe un m√©canisme pour surmonter NAT </li><li>  Une large gamme d'algorithmes de chiffrement et de hachage du trafic au choix </li><li>  IPSec - Un ensemble de normes ouvertes et extensibles </li><li>  Dans le cas de Mikrotik, il ne n√©cessite pas l'achat de frais suppl√©mentaires ou de licences </li></ul><br><p>  Faiblesses: </p><br><ul><li>  Difficult√© </li><li>  Diff√©rents outils de terminologie et de configuration pour diff√©rents fournisseurs </li><li>  L'utilisation d'algorithmes de chiffrement puissants n√©cessite une bonne puissance de calcul. </li><li>  DPI facile √† d√©tecter </li></ul><br><h3 id="protokoly-v-sostave-ipsec">  Protocoles dans IPSec </h3><br><p><img src="https://habrastorage.org/webt/nd/k6/0m/ndk60mwkllka7jpnl2flzdqt8ce.png"></p><br><p>  Globalement, tous les protocoles que vous allez traiter lors de la configuration peuvent √™tre divis√©s en deux groupes: les protocoles d'√©change de cl√©s et les protocoles de protection des donn√©es. </p><br><p>  <strong>Protocoles d'√©change de cl√©s (IKE)</strong> <br>  La t√¢che principale consiste √† authentifier les participants √† la connexion et √† convenir de param√®tres de chiffrement et de cl√©s pour prot√©ger les informations transmises. </p><br><ul><li>  IKE (Internet Key Exchange) - d√©fini en 1998.  De nombreuses fonctionnalit√©s (par exemple, le pontage NAT) ont √©t√© ajout√©es ult√©rieurement en tant que modules compl√©mentaires et peuvent ne pas √™tre impl√©ment√©es avec diff√©rents fournisseurs.  La base de la n√©gociation cl√© est ISAKMP. </li><li>  IKEv2 (Internet Key Exchange version 2) - derni√®re r√©vision de 2014.  Il s'agit d'un d√©veloppement du protocole IKE, dans lequel certains probl√®mes ont √©t√© r√©solus, le m√©canisme d'accord cl√© a √©t√© simplifi√© et des extensions (NAT-T, Keepalives, Mode Config) sont devenues une partie du protocole. </li></ul><br><p>  Dans la pratique, la plupart des connexions IPSec sont impl√©ment√©es √† l'aide d'IKE en raison d'un √©quipement obsol√®te ou de la r√©ticence des administrateurs √† changer quelque chose. </p><br><p>  <strong>Protocoles de protection des donn√©es (ESP, AH)</strong> <br>  La t√¢che principale consiste √† prot√©ger les donn√©es des utilisateurs. </p><br><ul><li>  ESP (Encapsulating Security Payload) - crypte et authentifie partiellement les donn√©es transmises </li><li>  AH (Authentication Header) - authentifie le paquet entier (sauf pour les champs modifiables), ne crypte pas les donn√©es, mais vous permet de vous assurer que le paquet n'a pas √©t√© modifi√© pendant la transmission sur le r√©seau </li></ul><br><h3 id="poryadok-ustanovki-ipsec-soedineniya">  Proc√©dure d'installation de la connexion IPSec </h3><br><p><img src="https://habrastorage.org/webt/lu/rv/ps/lurvpsvrdub2tcgkmpx8ut5ep58.png"></p><br><p>  Les participants d'une connexion IPSec sont g√©n√©ralement appel√©s pairs, ce qui indique leur √©quivalence dans la connexion √©tablie.  Une configuration proche du client-serveur est possible, mais lors de la construction de tunnels IPSec permanents, n'importe lequel des pairs peut √™tre un initialiseur. </p><br><ol><li>  L'un des pairs lance une connexion IPSec </li><li>  Il y a un √©change d'informations cl√©s, l'authentification des pairs, la coordination des param√®tres de connexion </li><li>  Sur la base des informations de cl√© re√ßues, un tunnel crypt√© auxiliaire est form√© </li><li>  √Ä l'aide d'un tunnel crypt√©, les pairs d√©terminent les param√®tres du cryptage des donn√©es et √©changent des informations pour g√©n√©rer des cl√©s </li><li>  Le r√©sultat de la phase pr√©c√©dente est un ensemble de r√®gles et de cl√©s pour la protection des donn√©es (SA) </li><li>  Les pairs mettent r√©guli√®rement √† jour les cl√©s de chiffrement </li></ol><br><p>  L'un des concepts cl√©s d'IPSec est SA (Security Association) - un ensemble d'algorithmes de chiffrement pour le chiffrement et le hachage des informations, ainsi que des cl√©s de chiffrement, convenues par les pairs. </p><br><p>  Parfois, vous pouvez trouver une division en: </p><br><ul><li>  ISAKMP SA - param√®tres et cl√©s li√©s au tunnel auxiliaire </li><li>  Data SA (ou simplement SA) - param√®tres et cl√©s li√©s au chiffrement du trafic </li></ul><br><h3 id="poryadok-raboty-protokolov-soglasovaniya-klyuchey">  Protocoles d'accord cl√©s </h3><br><p>  Le protocole IKE peut fonctionner en deux modes: principal (principal) et agressif (agressif), le protocole IKEv2 contient un mode. </p><br><h4 id="ike-main">  IKE Principal </h4><br><p><img src="https://habrastorage.org/webt/zw/jb/yv/zwjbyvrpmup5t7nfgaol329rudi.png"></p><br><p>  La premi√®re phase comprend six packages: <br>  1-2: Alignement des param√®tres de chiffrement du tunnel secondaire et des diff√©rentes options IPSec <br>  3-4: Partager des informations pour g√©n√©rer une cl√© secr√®te <br>  5-6: Authentification par les pairs utilisant un canal crypt√© auxiliaire </p><br><p>  La deuxi√®me phase comprend trois packages: <br>  1-3: Utilisation d'un canal auxiliaire crypt√©.  Coordination des param√®tres de protection du trafic, √©change d'informations pour g√©n√©rer une cl√© secr√®te </p><br><h3 id="ike-aggressive">  IKE agressif </h3><br><p><img src="https://habrastorage.org/webt/xu/wz/qu/xuwzqu4qle5lxlcvb-hnvuhqehg.png"></p><br><p>  La premi√®re phase comprend trois packages: <br>  1: Soumission d'une offre d'installation d'un canal crypt√© auxiliaire et d'informations pour g√©n√©rer une cl√© priv√©e <br>  2: R√©ponse √† l'offre, informations pour g√©n√©rer la cl√© secr√®te, donn√©es pour l'authentification <br>  3: Donn√©es d'authentification </p><br><p>  La deuxi√®me phase comprend trois packages: <br>  1-3: Utilisation d'un canal auxiliaire crypt√©.  Coordination des param√®tres de protection du trafic, √©change d'informations pour g√©n√©rer une cl√© secr√®te </p><br><p>  En mode agressif, l'initiateur envoie un seul ensemble de param√®tres dans la phrase.  L'√©change d'informations pour l'authentification par les pairs a lieu avant l'installation d'un tunnel auxiliaire s√©curis√©.  Le mode agressif est coh√©rent plus rapidement, mais moins s√©curis√©. </p><br><h3 id="ikev2">  IKEv2 </h3><br><p><img src="https://habrastorage.org/webt/ev/mq/ni/evmqnimq5_sdeybuz63x3ddssbu.png"></p><br><p>  Dans IKEv2, les phases sont nomm√©es: IKE_SA_INIT et IKE_AUTH.  <em>Mais si je parle de Phase1 et Phase2 plus loin dans le texte, cela s'applique √©galement aux phases d'IKEv2.</em> </p><br><p>  Chaque phase d'IKEv2 se compose de deux packages: <br>  IKE_SA_INIT: Coordination des param√®tres de chiffrement du tunnel auxiliaire, √©change d'informations pour la g√©n√©ration d'une cl√© priv√©e </p><br><p>  IKE_AUTH: utilisation du canal auxiliaire chiffr√©.  Authentification des pairs, coordination des param√®tres de protection du trafic, √©change d'informations pour g√©n√©rer une cl√© secr√®te </p><br><h3 id="security-assotiations-database-sad">  Base de donn√©es des associations de s√©curit√© (SAD) </h3><br><p>  Le r√©sultat d'IKE (et IKEv2) sont des associations de s√©curit√© (SA), qui d√©finissent les param√®tres de protection du trafic et les cl√©s de chiffrement.  Chaque SA est unidirectionnelle et la connexion IPSec contient une paire de SA.  Toutes les SA sont stock√©es dans la base de donn√©es SAD et sont accessibles √† l'administrateur pour visualisation et r√©initialisation. </p><br><h3 id="inkapsulyaciya-dannyh">  Encapsulation de donn√©es </h3><br><p><img src="https://habrastorage.org/webt/3z/3k/aa/3z3kaaj2rwmnx59apvueigp3lno.png"></p><br><p>  IPSec propose deux options pour l'encapsulation des donn√©es: </p><br><ul><li>  Mode de transport - seule la charge utile du paquet est prot√©g√©e, laissant l'en-t√™te d'origine.  Pour construire des tunnels, le mode de transport est g√©n√©ralement utilis√© en conjonction avec ipip ou gre, dont la charge utile contient d√©j√† l'int√©gralit√© du paquet source. </li><li>  Mode tunnel - encapsule enti√®rement le package d'origine dans un nouveau (similaire √† gre ou ipip).  Mais pour tunnel ipsec, une interface explicite n'est pas cr√©√©e dans le syst√®me, cela peut √™tre un probl√®me si un routage statique dynamique ou complexe est utilis√©. </li></ul><br><h3 id="security-policy-database-spd">  Base de donn√©es des politiques de s√©curit√© (SPD) </h3><br><p>  Une base de donn√©es de r√®gles qui d√©terminent le trafic √† chiffrer, le protocole de protection des donn√©es, le type d'encapsulation et un certain nombre d'autres param√®tres. <br>  La position de v√©rification SPD peut √™tre affich√©e sur le diagramme de flux de paquets. </p><br><p><img src="https://habrastorage.org/webt/nh/jo/rm/nhjorm-je866yymx0_cxwdnyop8.png"></p><br><h3 id="preodolenie-nat">  Pontage NAT </h3><br><p>  IPSec utilise des protocoles de couche r√©seau pour transf√©rer des donn√©es que NAT ne peut pas g√©rer.  Pour r√©soudre le probl√®me, le protocole NAT-T est utilis√© (une extension dans IKE et une partie de IKEv2).  L'essence de NAT-T r√©side dans l'encapsulation suppl√©mentaire des paquets IPSec dans les paquets UDP que NAT traite. </p><br><h3 id="ipsec-v-mikrotik">  IPSec chez Mikrotik </h3><br><p>  IPSec est disponible gratuitement sur tout appareil ex√©cutant RouterOS avec le package de s√©curit√© install√©. </p><br><h3 id="apparatnoe-shifrovanie">  Cryptage mat√©riel </h3><br><p>  Pour d√©charger le CPU, l'acc√©l√©ration mat√©rielle du chiffrement est ajout√©e √† certains mod√®les de routeurs MikroTik; une liste compl√®te peut √™tre trouv√©e <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">sur le wiki</a> . <br>  Les options les plus √©conomiques: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">RB750Gr3</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">RB3011</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">HAP AC ^ 2</a> . </p><br><p>  J'ai v√©rifi√© par moi-m√™me la vitesse IPSec entre deux RB1100AHx2 et entre deux RB750Gr3. </p><br><p>  Pour obtenir des r√©sultats maximaux sur RB1100AHx2, vous devez: </p><br><ul><li>  Utilisez le port 11 directement connect√© au processeur et configurez un c≈ìur de processeur pour g√©rer le trafic √† 11 ports </li><li>  Utiliser uniquement des files d'attente mat√©rielles sur les interfaces, d√©sactiver RPS </li><li>  Activez Layer3 FastPath (environ 800 Mo / s) ou excluez le trafic IPSec du conntrack (environ 700 Mo / s) <br>  Sans les manipulations d√©crites sur le port le plus lent (ether13), il est possible d'obtenir ~ 170 Mo / s, sur les ~ 400 Mo / s habituels. </li></ul><br><p>  Sur RB750Gr3 sans optimisation, environ 200 Mo / s. </p><br><p>  Les routeurs monoc≈ìur Qualcomm affichent un r√©sultat de 10 √† 40 Mo / s selon le mod√®le, les optimisations et la charge de travail des autres processus. </p><br><p>  Je vous recommande de vous familiariser avec la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">pr√©sentation</a> d'un employ√© de mikrotik, ils ont abord√© des sujets d'optimisation des param√®tres pour r√©duire la charge sur le CPU et augmenter la vitesse, ce que je n'ai pas ajout√© au texte. </p><br><h3 id="razlichiya-642x-i-643x">  Diff√©rences 6.42.X et 6.43.X </h3><br><p>  Selon la version de RouterOS que vous utilisez, le menu de configuration IPSec variera. </p><br><p><img src="https://habrastorage.org/webt/6q/pz/5c/6qpz5cgthate04bihl8gq2zr9t8.png"></p><br><p><img src="https://habrastorage.org/webt/ng/ug/hi/ngughirhx6nwd1v8mjaa9omfb7g.png"></p><br><p><img src="https://habrastorage.org/webt/kv/ow/3-/kvow3-bmivzfr_tf6bqnywr5wu8.png"></p><br><p>  Il y a d√©j√† de nouvelles modifications dans la version de test, alors lisez les notes de publication avant la mise √† niveau. </p><br><p><img src="https://habrastorage.org/webt/ri/rd/gu/rirdgucrebbf1ucxjqbj65gzf-s.png"></p><br><h3 id="konfiguraciya-ipsec">  Configuration IPsec </h3><br><p><img src="https://habrastorage.org/webt/r6/lf/j5/r6lfj5hlclkbx9qmph0owsqf_ak.png"><br>  Le menu [IP] -&gt; [IPSec] n'est pas aussi effrayant qu'il n'y para√Æt √† premi√®re vue.  Le diagramme montre que les principaux √©l√©ments de configuration sont les suivants: homologues et profils. <br>  Les onglets Homologues distants et SA install√©s sont informatifs. </p><br><h4 id="peers-i-peers-profiles">  Peers et profils de pairs </h4><br><p>  Configuration homologue IPSec pour √©tablir une connexion IKE et cr√©er un tunnel s√©curis√© auxiliaire. </p><br><p><img src="https://habrastorage.org/webt/e2/kj/e1/e2kje1zwzhubqsyriypavj3bmfm.png" alt="image"></p><br><p>  <strong>Configurer les homologues distants IPSec</strong> </p><br><p><img src="https://habrastorage.org/webt/pq/9d/cv/pq9dcvyqrf64pdklohgf1eapoze.png"></p><br><div class="spoiler">  <b class="spoiler_title">Remarques</b> <div class="spoiler_text"><ul><li>  √Ä partir de la version 6.43, RouterOS jure lors de l'utilisation du PSK sans authentification suppl√©mentaire.  Si vous ne souhaitez pas configurer en outre des cl√©s, des certificats ou xAuth, vous pouvez basculer vers IKEv2 ou ignorer l'avertissement. </li><li>  En tant que pairs, vous pouvez sp√©cifier des IP ou des sous-r√©seaux sp√©cifiques (pertinents pour le VPN client-serveur) </li><li>  S'il y a des r√®gles en conflit, une r√®gle avec un sous-r√©seau plus pr√©cis sera utilis√©e pour se connecter √† l'homologue (similaire aux routes) </li><li>  L'authentification par cl√© XAuth et rsa ne fonctionne pas dans IKEv2 </li><li>  Pour IKEv2, Mikrotik a rendu leur impl√©mentation de xAuth incompatible avec d'autres plateformes </li><li>  Le mode passif est g√©n√©ralement utilis√© pour cr√©er un VPN client-serveur (configuration en mode L2TP / IPsec ou IKEv2), mais il peut √™tre utile lors de la connexion d'un grand nombre de tunnels de site √† site √† un seul point, pour r√©duire le trafic parasite. </li><li>  Si vous pr√©voyez d'utiliser xAuth, le "serveur" doit √™tre passif.  Les utilisateurs du serveur sont cr√©√©s dans [IPSec] -&gt; [Utilisateurs] </li><li>  Lors de l'utilisation de la strat√©gie G√©n√©rer, s√©lectionnez le mode strict de port </li></ul></div></div><br><p>  <strong>Mise en place de profils (propositions) pour l'harmonisation Phase 1</strong> </p><br><p><img src="https://habrastorage.org/webt/w8/s9/vj/w8s9vjxiguir63a_hfpci1ih1bi.png" alt="image"></p><br><p><img src="https://habrastorage.org/webt/_v/x3/ff/_vx3ff1ogwsxjggebdjqazfqhve.png"></p><br><div class="spoiler">  <b class="spoiler_title">Remarques</b> <div class="spoiler_text"><ul><li>  Des options suppl√©mentaires pour IKE font partie de IKEv2, les param√®tres sont ignor√©s </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Corr√©lation des groupes DH avec leurs num√©ros</a> (les num√©ros de groupe sont utilis√©s par d'autres fournisseurs) </li><li>  Lors de l'envoi de propositions, le syst√®me trie l'algorithme des paires + le groupe dh de plus persistant √† moins persistant <br><img src="https://habrastorage.org/webt/7i/h8/fj/7ih8fjegurxodmq-daxuwxfhpii.png"></li></ul></div></div><br><h4 id="policies-i-policy-proposals">  Politiques et propositions de politiques </h4><br><p>  Les politiciens v√©rifient la conformit√© des paquets qui passent avec les conditions et appliquent les actions sp√©cifi√©es.  Si vous revenez au flux de paquets, les blocs avec la strat√©gie IPSec sont la r√©conciliation avec les strat√©gies.  Les actions sp√©cifient: protocole de s√©curit√© IPSec (ESP ou AH), propositions de n√©gociation SA, mode d'encapsulation. <br><img src="https://habrastorage.org/webt/tp/bk/1n/tpbk1nrkowlvaqdnrfvgpvbaxg0.png" alt="image"></p><br><p>  Le package passe la politique une par une jusqu'√† ce qu'elle corresponde aux conditions de l'une d'entre elles. </p><br><p>  <strong>D√©finition de la politique</strong> <br><img src="https://habrastorage.org/webt/yw/cp/nj/ywcpnjdyjonrxpnfel79irfov4g.png"></p><br><div class="spoiler">  <b class="spoiler_title">Annotations</b> <div class="spoiler_text"><ul><li>  Habituellement, aucun Src sp√©cifique n'est requis.  et Dst.  Port, mais en g√©n√©ral, la possibilit√© de crypter le trafic d'une application individuelle est int√©ressante </li><li>  Tous les protocoles IP ne sont pas pr√©sent√©s dans la liste des protocoles (par exemple, il n'y a pas de gre), vous pouvez sp√©cifier manuellement le num√©ro du protocole requis. </li><li>  Les mod√®les ne sont pas des politiciens!  Ils sont utilis√©s si generate-policy est d√©fini dans la configuration d'homologue. </li><li>  Que faire si aucune association de s√©curit√© sp√©cifique pour une strat√©gie n'a √©t√© trouv√©e.  Auparavant, il y avait un probl√®me avec L2TP / IPSec lorsque plusieurs clients ne pouvaient pas se connecter en raison du m√™me NAT (lors de l'utilisation d'IKE), ce bogue est r√©solu (√† condition que ces clients ne soient pas des fen√™tres) si vous d√©finissez level = unique.  Sinon, passez √† IKEv2 </li><li>  Lors de la configuration des strat√©gies, utilisez le [Mode sans √©chec], un mouvement maladroit et vous risquez de perdre l'acc√®s au routeur en utilisant Level3 </li></ul></div></div><br><p>  <strong>Mettre en place des propositions pour approbation SA</strong> <br><img src="https://habrastorage.org/webt/mh/yf/cd/mhyfcd2-2nsxbouuxhgbecj3kyu.png"></p><br><p><img src="https://habrastorage.org/webt/0n/xk/tw/0nxktwxmxyu2quyanfw-rco-yqa.png"></p><br><h4 id="groups">  Les groupes </h4><br><p>  Utilis√© pour associer des mod√®les de strat√©gie et des pairs. </p><br><p><img src="https://habrastorage.org/webt/do/r7/gc/dor7gc6s4zuwlo2mmz5irrc3alm.png" alt="image"></p><br><p>  Dans l'une des anciennes versions de RouterOS, il y avait un bogue avec le groupe par d√©faut qui ne fonctionnait pas. </p><br><h4 id="mode-config">  Configuration du mode </h4><br><p>  Envoi et r√©ception de param√®tres IP sans utiliser de protocoles suppl√©mentaires.  Vous permet de cr√©er un VPN client-serveur autonome uniquement IPSec. </p><br><p><img src="https://habrastorage.org/webt/sr/s2/dl/srs2dl4tcpixxiwi2mrletlguva.png"></p><br><p><img src="https://habrastorage.org/webt/os/r2/gg/osr2ggrnm_0-vqtoukxb5hnzfjs.png"></p><br><h4 id="keys-i-users">  Cl√©s et utilisateurs </h4><br><p>  Utilis√© pour l'authentification avanc√©e par les pairs. <br>  <strong>Cl√©s</strong> <br>  Cl√©s RSA: g√©n√©ration, importation, exportation.  Non pris en charge dans IKEv2. </p><br><p><img src="https://habrastorage.org/webt/ec/7z/j4/ec7zj4doiqkdgwe4soh7lrk21f8.png"></p><br><p>  <strong>Les utilisateurs</strong> <br>  Base de donn√©es utilisateur XAuth pour le "serveur".  Le client sp√©cifie les param√®tres xAuth dans la configuration d'homologue.  Il est possible de transmettre l'authentification xAuth √† un serveur RADIUS. </p><br><p><img src="https://habrastorage.org/webt/pi/wl/vq/piwlvq80v1cnndmhyjg91jzrqle.png"></p><br><h4 id="remote-peers">  Pairs distants </h4><br><p>  Liste de tous les pairs installant et installant un tunnel auxiliaire (phase 1).  Vous pouvez supprimer des pairs pour mettre √† jour les cl√©s du tunnel auxiliaire. </p><br><p><img src="https://habrastorage.org/webt/j2/-g/ct/j2-gct_8wrf7bl2zgtzqsswwbgk.png" alt="image"></p><br><p><img src="https://habrastorage.org/webt/2k/37/3m/2k373mg8qxox4y-ruph-jza_d0m.png" alt="image"></p><br><h4 id="installed-sas">  SA install√©es </h4><br><p>  Base de donn√©es SAD ou une liste de toutes les SA n√©goci√©es.  Vous pouvez voir les algorithmes et cl√©s de protection des donn√©es utilis√©s. </p><br><p><img src="https://habrastorage.org/webt/jw/jb/su/jwjbsuorsms85vw656xfgvcneuc.png" alt="image"></p><br><p><img src="https://habrastorage.org/webt/wd/8x/gr/wd8xgrc-h0ngxcfq77qun4ymuhk.png" alt="image"></p><br><p>  L'indicateur mat√©riel AEAD indique l'utilisation du chiffrement mat√©riel. </p><br><p><img src="https://habrastorage.org/webt/jz/5-/yv/jz5-yv-xaw_a8gx5zrxz1hlesye.png" alt="image"></p><br><p>  Un administrateur peut r√©initialiser SA, mais uniquement tous du m√™me type (esp ou ah) en m√™me temps. </p><br><h4 id="ipsec-i-firewall">  IPSec et pare-feu </h4><br><p>  Dans le pare-feu, vous pouvez v√©rifier si le trafic est une strat√©gie IPSec entrante ou sortante.  Une application √©vidente est L2TP / IPSec, vous pouvez interdire l'installation de connexions L2TP si le trafic n'a pas √©t√© pr√©alablement chiffr√©. </p><br><p><img src="https://habrastorage.org/webt/xt/06/sw/xt06swif3vlsv_vjcyywb1lepf0.png"></p><br><p>  <strong>Protocoles et ports utilis√©s dans IPSec</strong> </p><br><ul><li>  IKE - UDP: 500 </li><li>  IKEv2 - UDP: 4500 </li><li>  NAT-T - UDP: 4500 </li><li>  ESP - ipsec-esp (50) </li><li>  AH - ipsec-ah (51) </li></ul><br><h3 id="ipsec-i-endpoinds">  IPSec et Endpoinds </h3><br><p>  Et maintenant √† propos de la plaie ... <br>  Le wiki mikrotik a des tableaux avec des algorithmes de hachage et de cryptage pour: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Windows</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">iOS</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">OS-X</a> . </p><br><p>  Je n'ai pas trouv√© d'informations sur le client VPN Android int√©gr√©, mais en g√©n√©ral, cela fonctionne avec les propositions de Windows.  Il n'y a pas de prise en charge IKEv2 dans Android, vous devez utiliser <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">StrongSwan</a> . </p><br><h3 id="primery-konfiguracii">  Exemples de configuration </h3><br><p>  Sch√©ma et configuration de base pour des exemples avec des tunnels de site √† site: </p><br><p><img src="https://habrastorage.org/webt/bn/a7/xu/bna7xud0pazv4ipia2k0083wqom.png"></p><br><pre><code class="plaintext hljs">#Mikrotik1 /ip address add address=10.10.10.10/24 interface=ether1 network=10.10.10.0 add address=192.168.100.1/24 interface=ether2 network=192.168.100.0 /ip firewall nat add action=masquerade chain=srcnat out-interface=ether1 /ip route add distance=1 gateway=10.10.10.1 dst-address=0.0.0.0/0 #Mikrotik2 /ip address add address=10.20.20.20/24 interface=ether1 network=10.20.20.0 add address=192.168.200.1/24 interface=ether2 network=192.168.200.0 /ip firewall nat add action=masquerade chain=srcnat out-interface=ether1 /ip route add distance=1 gateway=10.20.20.1 dst-address=0.0.0.0/0</code> </pre> <br><h4 id="ipsec-v-tunnelnom-rezhime">  IPSec en mode tunnel </h4><br><p><img src="https://habrastorage.org/webt/wy/cg/ad/wycgadjksxuyftckhoctoxciub4.png"></p><br><p>  Configuration pas √† pas: </p><br><ol><li>  Cr√©er des propositions pour IKE Phase1 </li><li>  Cr√©ez un festin.  Nous indiquons l'adresse, les propositions, le mode d'√©change, la cl√© PSK.  J'ai choisi IKEv2, vous pouvez utiliser principal / agressif comme vous le souhaitez </li><li>  Cr√©er des propositions pour SA </li><li>  Sp√©cifiez les sous-r√©seaux entre lesquels nous cr√©ons le tunnel </li><li>  Sp√©cifiez les adresses SA, le mode tunnel et les propositions de chiffrement du trafic </li><li>  Modification de la r√®gle NAT </li></ol><br><div class="spoiler">  <b class="spoiler_title">Mikrotik1</b> <div class="spoiler_text"><p> <a href=""><img src="https://habrastorage.org/webt/c2/tg/at/c2tgatfqb3bgw5qer0u6lvi_jt0.png"></a> </p><br><p>  Option console: </p><br><pre> <code class="plaintext hljs">#1 /ip ipsec peer profile add dh-group=modp2048 enc-algorithm=aes-128 hash-algorithm=sha256 name=ipsec-tunnel-ike nat-traversal=no #2 /ip ipsec peer add address=10.20.20.20/32 exchange-mode=ike2 profile=ipsec-tunnel-ike secret=test-ipsec #3 /ip ipsec proposal add auth-algorithms=sha256 enc-algorithms=aes-256-cbc name=ipsec-tunnel-sa #4-5 /ip ipsec policy add dst-address=192.168.200.0/24 proposal=ipsec-tunnel-sa sa-dst-address=10.20.20.20 sa-src-address=10.10.10.10 src-address=192.168.100.0/24 tunnel=yes #6 /ip firewall nat set 0 ipsec-policy=out,none</code> </pre> </div></div><br><div class="spoiler">  <b class="spoiler_title">Mikrotik2</b> <div class="spoiler_text"><p> <a href=""><img src="https://habrastorage.org/webt/je/5y/gq/je5ygqbnhfjklyqxu8pg1kf2saq.png"></a> </p><br><p>  Option console: </p><br><pre> <code class="plaintext hljs">#1 /ip ipsec peer profile add dh-group=modp2048 enc-algorithm=aes-128 hash-algorithm=sha256 name=ipsec-tunnel-ike nat-traversal=no #2 /ip ipsec peer add address=10.10.10.10/32 exchange-mode=ike2 profile=ipsec-tunnel-ike secret=test-ipsec #3 /ip ipsec proposal add auth-algorithms=sha256 enc-algorithms=aes-256-cbc name=tets-ipsec-sa #4-5 /ip ipsec policy add dst-address=192.168.100.0/24 proposal=tets-ipsec-sa sa-dst-address=10.10.10.10 sa-src-address=10.20.20.20 src-address=192.168.200.0/24 tunnel=yes #6 /ip firewall nat set 0 ipsec-policy=out,none</code> </pre> </div></div><br><div class="spoiler">  <b class="spoiler_title">Et ici NAT?</b> <div class="spoiler_text"><p>  Pour travailler en mode tunnel, vous avez besoin d'une fausse route vers le sous-r√©seau distant ou d'une route par d√©faut, sinon les paquets n'iront pas plus loin que la d√©cision de routage.  Il n'y a g√©n√©ralement aucun probl√®me avec la premi√®re option, mais avec la route par d√©faut et le NAT source (le premier et le second sont pr√©sents sur la grande majorit√© des routeurs domestiques et professionnels), il y aura des probl√®mes. </p><br><p>  Rappeler le flux de paquets.  Les paquets passent par le NAT source plus t√¥t que les politiques IPSec, la r√®gle avec masquerade ne sait rien du fait que le trafic est destin√© √† √™tre envoy√© vers le tunnel "√©ph√©m√®re" et diffusera les en-t√™tes de paquets √† envoyer √† IPSec lorsque le paquet avec l'en-t√™te modifi√© sera v√©rifi√© dans l'adresse source des politiques dans l'en-t√™te ne correspondra pas √† la r√®gle et le paquet s'envolera vers la route par d√©faut qui, apr√®s avoir vu l'adresse de destination du r√©seau priv√©, la supprimera tr√®s probablement. </p><br><p>  Il existe plusieurs solutions au probl√®me: </p><br><ul><li>  Utiliser un faux itin√©raire </li><li>  Utilisation d'une r√®gle d'acceptation facultative avant SourceNAT </li><li>  Soumettre src-nat uniquement aux paquets pour lesquels il n'y a pas de politiques IPSec (dans l'exemple) </li><li>  Exclure le trafic du suivi des connexions √† l'aide de RAW </li></ul></div></div><br><p>  <strong>V√©rifier la connexion √©tablie</strong> <br><img src="https://habrastorage.org/webt/no/xd/cn/noxdcnqrsbftj6mfsxlmpruizmq.png" alt="image"></p><br><ol><li>  Nous voyons un voisin dans les pairs distants </li><li>  Nous voyons le SA install√© (les compteurs de trafic ne changeront pas jusqu'√† ce que vous le d√©marriez) </li><li>  En politique, Statut √©tabli et drapeau (A) ctif </li></ol><br><h4 id="ipipipsec">  IPIP / IPSec </h4><br><p><img src="https://habrastorage.org/webt/2b/hy/1d/2bhy1d1tnwd57iyppymvb8dbkww.png"></p><br><p>  Tunnel IPIP pr√©d√©fini: </p><br><pre> <code class="plaintext hljs">#Mikrotik1 #  ipip /interface ipip add allow-fast-path=no clamp-tcp-mss=no name=ipip-vpn remote-address=10.20.20.20 # ip   ipip  /ip address add address=10.30.30.1/30 interface=ipip-vpn #     /ip route add distance=1 dst-address=192.168.200.0/24 gateway=10.30.30.2 #Mikrotik2 # ,      /interface ipip add allow-fast-path=no clamp-tcp-mss=no name=ipip-vpn remote-address=10.10.10.10 /ip address add address=10.30.30.2/30 interface=ipip-vpn /ip route add distance=1 dst-address=192.168.100.0/24 gateway=10.30.30.1</code> </pre> <br><p>  Configuration pas √† pas IPSec: </p><br><ol><li>  Cr√©er des propositions pour IKE Phase1 </li><li>  Cr√©ez un festin.  Indiquez l'adresse, les propositions, le mode d'√©change, la cl√© PSK </li><li>  Cr√©er des propositions pour SA </li><li>  Sp√©cifiez les sous-r√©seaux entre lesquels nous cr√©ons le tunnel </li><li>  Nous pr√©cisons les adresses de SA, le type de trafic que nous allons chiffrer et les propositions </li></ol><br><div class="spoiler">  <b class="spoiler_title">Mikrotik1</b> <div class="spoiler_text"><p> <a href=""><img src="https://habrastorage.org/webt/5e/mf/_w/5emf_wcxb3ulnjv3fykuino9stg.png"></a> </p><br><p>  Option console: </p><br><pre> <code class="plaintext hljs">#1 /ip ipsec peer profile add dh-group=modp2048 enc-algorithm=aes-128 hash-algorithm=sha256 name=ipsec-tunnel-ike nat-traversal=no #2 /ip ipsec peer add address=10.20.20.20/32 exchange-mode=ike2 profile=ipsec-tunnel-ike secret=test-ipsec #3 /ip ipsec proposal add auth-algorithms=sha256 enc-algorithms=aes-256-cbc name=ipsec-tunnel-sa #4-5 /ip ipsec policy add dst-address=10.20.20.20/32 proposal=ipsec-tunnel-sa protocol=ipencap src-address=10.10.10.10/32 sa-dst-address=10.20.20.20 sa-src-address=10.10.10.10</code> </pre> </div></div><br><div class="spoiler">  <b class="spoiler_title">Mikrotik2</b> <div class="spoiler_text"><p> <a href=""><img src="https://habrastorage.org/webt/9o/dk/oy/9odkoy8krqem4mck9rkfibhm220.png"></a> </p><br><pre> <code class="plaintext hljs">#1 /ip ipsec peer profile add dh-group=modp2048 enc-algorithm=aes-128 hash-algorithm=sha256 name=ipsec-tunnel-ike nat-traversal=no #2 /ip ipsec peer add address=10.10.10.10/32 exchange-mode=ike2 profile=ipsec-tunnel-ike secret=test-ipsec #3 /ip ipsec proposal add auth-algorithms=sha256 enc-algorithms=aes-256-cbc name=tets-ipsec-sa #4-5 /ip ipsec policy add dst-address=10.10.10.10/32 proposal=tets-ipsec-sa protocol=ipencap src-address=10.20.20.20/32 sa-dst-address=10.10.10.10 sa-src-address=10.20.20.20</code> </pre> </div></div><br><p>  Pour inattentif, la vraie diff√©rence dans la configuration du tunnel et du mode de transport dans les strat√©gies IPSec: <br><img src="https://habrastorage.org/webt/5v/ka/fg/5vkafg3ca8vilvv0s-lv1tdbxhw.png" alt="image"></p><br><p>  La v√©rification de la connexion est similaire au mode tunnel. </p><br><h4 id="l2tpipsec">  L2TP / IPSec </h4><br><p>  Les exemples pr√©c√©dents sont bien adapt√©s pour cr√©er des VPN permanents entre deux homologues, avec des adresses IP externes statiques. </p><br><p>  Si l'adresse de l'un des homologues est dynamique (et se trouve g√©n√©ralement derri√®re NAT), vous devez utiliser un autre VPN client-serveur. <br><img src="https://habrastorage.org/webt/ms/l5/3a/msl53ahdcdv8fl2vd-62m1exdmk.png" alt="image"></p><br><p>  Pr√©configuration L2TP: </p><br><pre> <code class="plaintext hljs">#     /ip pool add name=pool-l2tp ranges=192.168.77.10-192.168.77.20 #    /ppp profile add change-tcp-mss=yes local-address=192.168.77.1 name=l2tp-ipsec only-one=yes remote-address=pool-l2tp use-compression=no use-encryption=no use-mpls=no use-upnp=no #   /ppp secret add name=user1 password=test1 profile=l2tp-ipsec service=l2tp add name=user2 password=test2 profile=l2tp-ipsec service=l2tp add name=user3 password=test3 profile=l2tp-ipsec service=l2tp #  L2TP (  ipsec) /interface l2tp-server server set authentication=chap,mschap2 default-profile=l2tp-ipsec enabled=yes</code> </pre> <br><div class="spoiler">  <b class="spoiler_title">Pourquoi dois-je ignorer le r√©glage automatique IPsec</b> <div class="spoiler_text"><p>  Dans la configuration d'ipip, gre, eoip, l2tp, il y a une configuration automatique de la connexion ipsec, en fait le syst√®me cr√©e des r√®gles dynamiques pour les pairs et les politiques pour vous, mais premi√®rement, nous ne cherchons pas de moyens faciles, et deuxi√®mement, lors de la mise √† niveau de 6.42 √† 6.43, des tunnels cr√©√©s automatiquement cass√© et non le fait que cela ne se reproduira plus. </p></div></div><br><p>  Configuration pas √† pas IPSec: </p><br><ol><li>  Cr√©ez un nouveau groupe (vous pouvez utiliser la valeur par d√©faut) </li><li>  Cr√©er des propositions pour IKE Phase1 </li><li>  Nous cr√©ons un festin, ou plut√¥t un sous-r√©seau.  Jure sur la cl√© PSK, mais si nous avons affaire √† Windows en tant que client, nous avons le choix: Certificats ou PSK. </li><li>  D√©finissez passive = yes et send-init-contact = no, dans generate-policy = port-strict (acceptez le port du client) </li><li>  Cr√©er des propositions pour SA </li><li>  Cr√©er un mod√®le pour g√©n√©rer des politiques </li><li>  Sp√©cifiez la proposition pour SA </li></ol><br><div class="spoiler">  <b class="spoiler_title">Configuration de Mikrotik</b> <div class="spoiler_text"><p> <a href=""><img src="https://habrastorage.org/webt/ua/a8/ph/uaa8phm-3iy-qvrxuc6m4kbirr8.png" alt="image"></a> <br>  <em>Dans la capture d'√©cran, l'erreur est de sp√©cifier dst.</em>  <em>port et src.</em>  <em>le port n'est pas n√©cessaire</em> </p><br><p>  Option console: </p><br><pre> <code class="plaintext hljs">#1 /ip ipsec policy group add name=l2tp-ipsec #2 /ip ipsec peer profile add dh-group=modp1024 enc-algorithm=aes-256 hash-algorithm=sha256 name=l2tp-ipsec-ike #3-4 /ip ipsec peer add address=0.0.0.0/0 generate-policy=port-strict passive=yes policy-template-group=l2tp-ipsec profile=l2tp-ipsec-ike secret=secret-ipsec-pass send-initial-contact=no #5 /ip ipsec proposal add auth-algorithms=sha256,sha1 enc-algorithms=aes-256-cbc,aes-128-cbc name=l2tp-ipsec-sa pfs-group=none #6-7 /ip ipsec policy add dst-address=0.0.0.0/0 group=l2tp-ipsec proposal=l2tp-ipsec-sa protocol=udp src-address=0.0.0.0/0 template=yes</code> </pre> </div></div><br><p>  <strong>Configuration du pare-feu pour cr√©er des connexions L2TP uniquement apr√®s IPSec</strong> </p><br><pre> <code class="plaintext hljs">/ip firewall filter # IKE, NAT-T  ipsec-esp add chain=input protocol=17 dst-port=500,4500 action=accept add chain=input protocol=50 action=accept # L2TP,     ipsec    add chain=input protocol=17 dst-port=1701 ipsec-policy=in,ipsec action=accept add chain=input protocol=17 dst-port=1701 action-drop</code> </pre> <br><h4 id="ikev2-vpn">  VPN IKEv2 </h4><br><p>  L'option L2TP est populaire, mais gr√¢ce √† la configuration du mode, vous pouvez configurer le serveur VPN en utilisant uniquement IPSec.  C'est un type de VPN prometteur, mais jusqu'ici rarement utilis√©, donc en plus de configurer le c√¥t√© serveur, je vais donner un exemple de configuration du client strongSwan sur Android. </p><br><p><img src="https://habrastorage.org/webt/el/un/fu/elunfukm2k6qajijslvcfd-zvuy.png" alt="image"></p><br><p>  Bien s√ªr, tout n'est pas si rose.  La plupart des syst√®mes d'exploitation "utilisateur" (en particulier Windows et Android) acceptent de travailler avec un tel VPN uniquement s'ils sont authentifi√©s par des certificats ou EAP. </p><br><p>  <em>Les certificats sont mon point faible, si quelqu'un sait comment g√©n√©rer correctement un certificat auto-sign√© que Windows importe et utilisera dans la connexion, √©crivez dans les commentaires.</em> </p><br><p>  G√©n√©ration pr√©liminaire des certificats: </p><br><pre> <code class="plaintext hljs">#Root CA   /certificate add name=ca common-name="IKEv2 CA" days-valid=6928 /certificate sign ca ca-crl-host=&lt;IP &gt; #   vpn /certificate add common-name=&lt;IP &gt; subject-alt-name=IP:&lt;IP &gt; key-usage=tls-server name=vpn days-valid=6928 #   /certificate sign vpn ca=ca #   #       ,       #     Revoke   /certificate add common-name=client key-usage=tls-client name=client days-valid=6928 #   /certificate sign client ca=ca</code> </pre> <br><p>  Configuration pas √† pas du VPN IKEv2: </p><br><ol><li>  Nous cr√©ons un pool d'adresses √† distribuer aux clients </li><li>  Cr√©er un profil de configuration de mode pour distribuer les param√®tres IP aux clients </li><li>  Cr√©er des groupes pour lier des pairs et des mod√®les de politiques </li><li>  Cr√©er des propositions pour IKE Phase1 </li><li>  Cr√©ez un profil pour connecter des pairs.  Authentification par certificat, protocole IKEv2, mode passif </li><li>  Sp√©cifiez le profil de configuration de mode, un groupe de 3 √©tapes et activez la g√©n√©ration de strat√©gie </li><li>  Cr√©er des propositions pour SA </li><li>  Cr√©er un mod√®le pour g√©n√©rer des politiques </li><li>  Sp√©cifier les propositions pour SA </li></ol><br><div class="spoiler">  <b class="spoiler_title">Configurer Mikrotik</b> <div class="spoiler_text"><p> <a href=""><img src="https://habrastorage.org/webt/1r/8w/vj/1r8wvjsgjjwhijje2dhwb90qv78.png" alt="image"></a> </p><br><pre> <code class="plaintext hljs">#1 /ip pool add name=pool-ike ranges=192.168.77.10-192.168.77.20 #2 /ip ipsec mode-config add address-pool=pool-ike address-prefix-length=32 name=ikev2-vpn static-dns=77.88.8.8 system-dns=no #3 /ip ipsec policy group add name=ikev2-vpn #4 /ip ipsec peer profile add enc-algorithm=aes-256,aes-128 hash-algorithm=sha256 name=ikev2-vpn #5-6 /ip ipsec peer add address=0.0.0.0/0 auth-method=rsa-signature certificate=vpn exchange-mode=ike2 generate-policy=port-strict mode-config=ikev2-vpn passive=yes policy-template-group=ikev2-vpn profile=ikev2-vpn send-initial-contact=no #7 /ip ipsec proposal add auth-algorithms=sha256,sha1 enc-algorithms=aes-256-cbc,aes-128-cbc name=ikev2-vpn #8-9 /ip ipsec policy add dst-address=0.0.0.0/0 group=ikev2-vpn proposal=ikev2-vpn src-address= 0.0.0.0/0 template=yes</code> </pre> </div></div><br><div class="spoiler">  <b class="spoiler_title">Configuration StrongSwan sur Android.</b> <div class="spoiler_text"><p>  <em>Vous devez d'abord transf√©rer les certificats client et ca sur le t√©l√©phone.</em> <br>  <a href="">https://habrastorage.org/webt/tp/pk/ad/tppkadaifd1k7xi6hf3jxgg7vcs.png</a> </p><br><p>  <em>Pour les grands yeux: une croix pr√®s du wi-fi se tient parce que</em>  <em>la plupart des applications syst√®me sont bloqu√©es par AFWall +.</em> </p></div></div><br><p>  Si la connexion r√©ussit, vous verrez: strat√©gie dynamique, √©criture sur des pairs distants et une paire de SA. </p><br><p><img src="https://habrastorage.org/webt/89/ov/4w/89ov4wsqvw7r-dvsoz2crontmlk.png" alt="image"></p><br><p><img src="https://habrastorage.org/webt/cc/b2/ic/ccb2icr_nqz32btmghwptrz7svc.png" alt="image"></p><br><p><img src="https://habrastorage.org/webt/sl/cn/gz/slcngz0e3objej8x3fw4-m3wypc.png" alt="image"></p><br><p>  <em>Les licences de d√©monstration RouterOS x86 n'ont aucune restriction sur le nombre de tunnels IPSec, y compris le VPN IKEv2.</em>  <em>Vous pouvez d√©ployer la d√©mo RouterOS x86 (ne pas confondre avec RouterOS CHR gratuit, tout est triste) sur VPS et obtenir un serveur VPN personnel avec un effort administratif minimal, sans acheter de licence pour RouterOS ou RouterOS CHR.</em> </p><br><h3 id="para-slov-pro-analiz-logov-ipsec">  Quelques mots sur l'analyse des journaux IPSec </h3><br><p>  Les journaux dans Mikrotik sont une histoire distincte, parfois ils sont suffisamment d√©taill√©s pour analyser les probl√®mes, mais le manque de fonctionnalit√©s banales: nettoyer, copier, trouver vous oblige √† installer un serveur syslog s√©par√©. </p><br><p>  Quant √† IPSec, voici une option d'analyse de journal rapide (nous ne laissons que le n√©cessaire dans un onglet s√©par√©): </p><br><p><img src="https://habrastorage.org/webt/05/rz/_g/05rz_grffjd7zz1r-a8zhsi87cy.png" alt="image"></p><br><pre> <code class="plaintext hljs">/system logging action add memory-lines=100000 name=ipsec target=memory /system logging add action=ipsec topics=ipsec,error add action=ipsec topics=ipsec,debug,!packet add action=ipsec topics=ipsec,info</code> </pre> <br><p>  Et quelques exemples de probl√®mes de configuration IPSec typiques: </p><br><div class="spoiler">  <b class="spoiler_title">Probl√®me de coh√©rence des propositions sur la phase 1</b> <div class="spoiler_text"><p><img src="https://habrastorage.org/webt/bp/jm/y1/bpjmy12i4eieobnfhrnj3hlvpcq.png" alt="image"></p><br><ol><li>  Lisez le message d'erreur.  Le probl√®me est lors de la r√©conciliation des propositions dans la premi√®re phase. </li><li>  Nous regardons ci-dessus, le routeur lui-m√™me sugg√®re qu'il a envoy√© un festin, et ce qui est configur√© localement </li></ol></div></div><br><div class="spoiler">  <b class="spoiler_title">Probl√®me de r√©conciliation IKE_SA_INIT</b> <div class="spoiler_text"><p>  Dans les journaux, vous verrez quelque chose comme ceci: </p><br><p><img src="https://habrastorage.org/webt/8i/d9/gh/8id9ghqgdgxsjjsfhn3zcn5_vtq.png"></p><br><p>  Analyser le trafic </p><br><p>  Dans la demande, vous pouvez voir les propositions du banquet: </p><br><p><img src="https://habrastorage.org/webt/pw/u2/ib/pwu2ibw3dyxswemrr74wcbphcoy.png"></p><br><p>  Dans la r√©ponse, nous voyons qu'aucune proposition appropri√©e n'a √©t√© trouv√©e: </p><br><p><img src="https://habrastorage.org/webt/q2/lb/qk/q2lbqkcr8qvtd1hgia4fj0hrb44.png"></p></div></div><br><div class="spoiler">  <b class="spoiler_title">Probl√®me de rapprochement des propositions pour SA</b> <div class="spoiler_text"><p><img src="https://habrastorage.org/webt/2y/yg/7m/2yyg7ma7ko4lce5vsyef4nmojdi.png"><br>  Le routeur demande une erreur sur les propositions lors de la phase 2 et indique ce qui est configur√© localement et ce qui est distant. </p></div></div><br><div class="spoiler">  <b class="spoiler_title">Propositions Probl√®me de r√©conciliation IKE_AUTH</b> <div class="spoiler_text"><p><img src="https://habrastorage.org/webt/bn/pk/vn/bnpkvnfazxyqmpbvdg78e26mfgy.png"><br>  Nous voyons qu'il y avait une connexion et une authentification des pairs, mais en outre une erreur de propositions.  Vous ne verrez aucun d√©tail dans le d√©bogage, dans Wheelshark non plus (le trafic IKE_AUTH est chiffr√©). </p></div></div><br><div class="spoiler">  <b class="spoiler_title">Erreur d'authentification PSK</b> <div class="spoiler_text"><p>  Pour IKE: </p><br><p><img src="https://habrastorage.org/webt/cp/wm/b5/cpwmb55qp8qyjmba_xijboxmiwa.png"></p><br><p>  Pour IKEv2: <br><img src="https://habrastorage.org/webt/ks/fn/k0/ksfnk0qdgmgizzusfsyrlwxvcfs.png"></p></div></div><br><div class="spoiler">  <b class="spoiler_title">Mode IKE incorrect</b> <div class="spoiler_text"><p><img src="https://habrastorage.org/webt/md/fb/ll/mdfbllmvedawn5ptdd-yvjcsrpw.png" alt="image"><br>  Nous voyons que la phase 1 interrompt le d√©lai d'expiration, bien que les paquets passent entre pairs.  Mais la taille du paquet entrant est beaucoup plus grande, si nous analysons via Wirehark, nous verrons que l'homologue distant utilise le mode agressif. </p><br><p><img src="https://habrastorage.org/webt/3g/ke/ii/3gkeiidaj8m-fs0ky7ucxqjxx6k.png"><br>  Nous voyons que des paquets sont envoy√©s de nous √† UDP: 500, et ils arrivent √† UDP: 4500 et sont plut√¥t gros.  Ici, l'homologue distant a le mode IKEv2. </p></div></div><br><p>  Enfin, lisez la section <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">de d√©pannage du wiki</a> .  Et tout le mat√©riel sur IPSec est souhaitable pour la connaissance, je n'ai d√©crit que l'ensemble de base des outils et des param√®tres. </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr438176/">https://habr.com/ru/post/fr438176/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr438166/index.html">Interaction entre un site dans un navigateur et un programme ex√©cut√© localement</a></li>
<li><a href="../fr438168/index.html">Comment casser un appareil photo cher pour que votre femme ne vous tue pas</a></li>
<li><a href="../fr438170/index.html">Prix ‚Äã‚Äãnomm√© d'apr√®s Ilya Segalovich. Histoire de l'informatique et publications de lancement</a></li>
<li><a href="../fr438172/index.html">Apple incapable de d√©placer la production de ses appareils aux √âtats-Unis</a></li>
<li><a href="../fr438174/index.html">Jaune - Vide - Nuage</a></li>
<li><a href="../fr438178/index.html">Cr√©ation de votre premi√®re application ARCore</a></li>
<li><a href="../fr438180/index.html">Enregistrer une transaction immobili√®re en ligne</a></li>
<li><a href="../fr438182/index.html">L'√©tude a r√©v√©l√© les avantages du piratage mod√©r√© pour les producteurs et les distributeurs de contenu</a></li>
<li><a href="../fr438184/index.html">Rapport de la Bank of America: 700 quintillions de dollars depuis l'espace</a></li>
<li><a href="../fr438192/index.html">Dell Inspiron 14 (5482): 2-en-1 √©conomique avec de bonnes options de mise √† niveau</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>