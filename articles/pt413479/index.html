<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ü•ò ‚ûñ üîà Escrevemos nosso protocolo sobre o UDP ü•á üë∑üèª üà∏</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="As primeiras transmiss√µes ao vivo da cena apareceram na R√∫ssia h√° quase 70 anos e foram transmitidas a partir de uma esta√ß√£o de televis√£o m√≥vel (PTS),...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Escrevemos nosso protocolo sobre o UDP</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/oleg-bunin/blog/413479/">  As primeiras transmiss√µes ao vivo da cena apareceram na R√∫ssia h√° quase 70 anos e foram transmitidas a partir de uma esta√ß√£o de televis√£o m√≥vel (PTS), que parecia um tr√≥lebus e permitia a transmiss√£o de fora do est√∫dio.  E apenas tr√™s anos atr√°s, o Periscope permitiu usar um telefone celular em vez de um "tr√≥lebus". <br><br>  Mas esse aplicativo apresentava v√°rios problemas relacionados, por exemplo, a atrasos na transmiss√£o, a incapacidade de assistir a transmiss√µes em alta qualidade etc. <br><br><img src="https://habrastorage.org/webt/ah/bx/dh/ahbxdhk3rew0amnby0xhqmwct98.jpeg"><br>  Seis meses depois, no ver√£o de 2016, o Odnoklassniki lan√ßou seu aplicativo m√≥vel de transmiss√£o ao vivo OK, no qual eles tentaram resolver esses problemas. <br><br>  Alexander Tobol √© respons√°vel pela parte t√©cnica do v√≠deo em Odnoklassniki e, no Highload ++ 2017, ele falou sobre como escrever seu protocolo UDP e por que isso pode ser necess√°rio. <br><br>  Com a transcri√ß√£o do relat√≥rio, voc√™ aprender√° tudo sobre outros protocolos de streaming de v√≠deo, quais s√£o as nuances e quais truques s√£o necess√°rios. <br><br><iframe width="560" height="315" src="https://www.youtube.com/embed/1Ih0bL2Zp1c" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br>  Eles dizem que devemos sempre come√ßar com a arquitetura e o TK - supostamente √© imposs√≠vel sem isso!  Ent√£o vamos l√°. <br><a name="habracut"></a><br><h2>  Arquitetura e TK </h2><br>  No slide abaixo, est√° o diagrama da arquitetura de qualquer servi√ßo de streaming: o <strong>v√≠deo √© alimentado na entrada, convertido e transmitido na sa√≠da</strong> .  Adicionamos um pouco mais de requisitos a essa arquitetura: o v√≠deo deve ser fornecido a partir de desktops e telefones celulares, e a sa√≠da deve ir para os mesmos desktops, telefones celulares, smartTV, Chromcast, AppleTV e outros dispositivos - todos os v√≠deos em que √© poss√≠vel reproduzir. <br><br><img src="https://habrastorage.org/webt/g2/ju/k_/g2juk_sfrmjcu1hv_4ieulhse44.jpeg"><br>  Em seguida, passamos aos termos de refer√™ncia.  Se voc√™ tem um cliente, voc√™ tem TK.  Se voc√™ √© uma rede social, n√£o possui TK.  Como fazer as pazes? <br><br>  Obviamente, voc√™ pode entrevistar os usu√°rios e descobrir tudo o que eles querem.  Mas haver√° um monte de desejos que n√£o se correlacionam com o que as pessoas realmente precisam. <br><br>  Decidimos seguir o caminho oposto e vimos o que os usu√°rios N√ÉO queriam ver no servi√ßo de transmiss√£o. <br><br><ul><li>  A primeira coisa que o usu√°rio n√£o deseja √© ver o <strong>atraso no in√≠cio da transmiss√£o</strong> . <br></li><li>  O usu√°rio n√£o deseja ver uma <strong>imagem de fluxo de baixa qualidade</strong> . <br></li><li>  Se a transmiss√£o for interativa quando o usu√°rio se comunicar com seu p√∫blico (pr√≥ximas transmiss√µes ao vivo, chamadas etc.), ele n√£o deseja ver o <strong>atraso entre a serpentina e o espectador</strong> . <br></li></ul><br>  √â assim que um servi√ßo de streaming normal se parece.  Vamos ver o que pode ser feito para fazer um servi√ßo de streaming regular em vez do habitual. <br><br><img src="https://habrastorage.org/webt/ik/68/zp/ik68zpbfkto_uh2ukzdpdinqoqi.jpeg"><br>  Voc√™ pode come√ßar analisando todos os protocolos de streaming, selecionar os mais interessantes e compar√°-los.  Mas fizemos de forma diferente. <br><br><h2>  O que os concorrentes t√™m? </h2><br>  Come√ßamos explorando os servi√ßos da concorr√™ncia.  <strong>Perisc√≥pio aberto - o que eles t√™m?</strong> <br><br>  Como sempre, o principal √© arquitetura. <br><br><img src="https://habrastorage.org/webt/ex/-e/xo/ex-exowlx_iyvaq5xvqmpsjnata.jpeg"><br>  Sara Hyder, engenheira l√≠der do Periscope, escreve que eles usam o Wowza para o back-end.  Se lermos um pouco mais de artigos, veremos o que eles transmitem usando o protocolo <strong>RTMP</strong> e o distribuiremos no RTMP ou no HLS.  Vamos ver o que s√£o esses protocolos e como eles funcionam. <br><br>  Testamos o Periscope em nossos tr√™s requisitos principais. <br><img src="https://habrastorage.org/webt/i5/6n/y-/i56ny-rn2pymgbg_pujoroehycm.jpeg"><br>  Eles t√™m uma <strong>velocidade inicial</strong> aceit√°vel (menos de um segundo em boas redes), uma <strong>qualidade</strong> constante <strong>de</strong> cerca de 600 px (n√£o HD) e, ao mesmo tempo, <strong>atrasos podem ser de at√© 12 segundos</strong> . <br><br>  A prop√≥sito, como medir o atraso na transmiss√£o? <br><img src="https://habrastorage.org/webt/ug/hs/pa/ughspadkdie3xrgpmxt1vjwrmdm.jpeg"><br>  Esta √© uma fotografia de uma medi√ß√£o de atraso.  H√° um telefone celular com um temporizador.  Ligamos a transmiss√£o e vemos a imagem deste telefone na tela.  Por 0,15 milissegundos, a imagem caiu no sensor da c√¢mera e foi removida da mem√≥ria de v√≠deo para a tela do telefone.  Depois disso, ligamos o navegador e assistimos √† transmiss√£o. <br><br>  Ai!  Ela est√° um pouco atrasada - cerca de 12 segundos. <br><br>  Para descobrir os motivos do atraso, analisamos o fluxo de v√≠deo. <br><img src="https://habrastorage.org/webt/ce/3u/jg/ce3ujgyeow2snntsekcqqq6xcr4.jpeg"><br>  Portanto, existe um telefone celular, o v√≠deo sai da c√¢mera e entra no buffer de v√≠deo.  Aqui os atrasos s√£o m√≠nimos (¬± 0,15 ms).  Em seguida, o codificador codifica o sinal, empacota-o em um pacote e envia-o para o buffer do soquete.  Tudo voa para a web.  Al√©m disso, o mesmo acontece no dispositivo receptor. <br><br>  Basicamente, h√° dois pontos dif√≠ceis a serem considerados: <br><br><ul><li>  <strong>codifica√ß√£o / decodifica√ß√£o de v√≠deo;</strong> <br></li><li>  <strong>protocolos de rede</strong> . <br></li></ul><br><h2>  Codifica√ß√£o / decodifica√ß√£o de v√≠deo </h2><br>  Vou contar um pouco sobre codifica√ß√£o.  Voc√™ o encontrar√° de qualquer maneira se fizer a transmiss√£o ao vivo de baixa lat√™ncia. <br><img src="https://habrastorage.org/webt/gr/op/o_/gropo_fxvnlubkxnrwdjrbhrj-w.jpeg"><br>  O que √© um v√≠deo?  Este √© um conjunto de quadros, mas n√£o √© simples.  Os quadros s√£o de tr√™s tipos: quadro I, P e B: <br><br><ul><li>  <strong>I-frame</strong> √© apenas jpg.  De fato, este √© um quadro de refer√™ncia, n√£o depende de ningu√©m e cont√©m uma imagem clara. <br></li><li>  <strong>O quadro P</strong> depende apenas dos quadros anteriores. <br></li><li>  O <strong>quadro B</strong> complicado pode depender do futuro.  Isso significa que, para calcular o quadro b, √© necess√°rio que os quadros futuros tamb√©m venham da c√¢mera.  Somente ent√£o um quadro b pode ser decodificado com algum atraso. <br></li></ul><br>  Isso mostra que os <strong>quadros</strong> <strong>B</strong> <strong>s√£o prejudiciais</strong> .  Vamos tentar remov√™-los. <br><br><ol><li>  Se voc√™ transmitir a partir de um dispositivo m√≥vel, tente <strong>ativar o perfil da linha de base</strong> .  Isso desativar√° o quadro B. <br></li><li>  Voc√™ pode tentar configurar o codec e reduzir o atraso de quadros futuros para que os quadros cheguem mais rapidamente. <br></li><li>  Outra coisa importante no ajuste do codec √© a <strong>inclus√£o de CBR</strong> (taxa de bits constante). <br></li></ol><br><img src="https://habrastorage.org/webt/yu/xr/0t/yuxr0tpvsdyvqzkfxd_c7k4rop4.jpeg"><br>  Como os codecs funcionam √© ilustrado no slide acima.  Neste exemplo, o v√≠deo √© uma imagem est√°tica, sua codifica√ß√£o economiza espa√ßo em disco, porque  quase nada muda l√°, e a taxa de bits do v√≠deo √© baixa.  As mudan√ßas est√£o ocorrendo - a entropia est√° aumentando, a taxa de bits do v√≠deo est√° aumentando - √© √≥timo armazenar em disco. <br><br>  Por√©m, no momento em que as altera√ß√µes ativas come√ßaram e a taxa de bits aumentou, provavelmente todos os dados n√£o entrariam na rede.  √â exatamente o que acontece quando voc√™ faz uma chamada de v√≠deo e come√ßa a ligar, e seu assinante diminui a velocidade da imagem.  Isso ocorre porque a rede n√£o tem tempo para se adaptar √† altera√ß√£o da taxa de bits. <br><br>  <strong>√â preciso incluir CBR</strong> .  Nem todos os codecs do Android o suportam corretamente, mas eles se esfor√ßam por isso.  Ou seja, voc√™ precisa entender que, com o CBR, voc√™ n√£o ter√° a imagem perfeita do mundo, como na figura inferior, mas ainda vale a pena ativ√°-la. <br><br>  4. E no back-end, voc√™ precisa adicionar o codec de <strong>zerolat√™ncia</strong> ao H264 - isso permitir√° que voc√™ n√£o fa√ßa depend√™ncias nos quadros para o futuro. <br><br><h2>  Protocolos de transfer√™ncia de v√≠deo </h2><br>  Considere quais protocolos de streaming o setor oferece.  Dividi-os condicionalmente em dois tipos: <br><br><ol><li>  protocolos de streaming; <br></li><li>  protocolos de segmento. <br></li></ol><br><img src="https://habrastorage.org/webt/hc/fr/qn/hcfrqnga93h7wofbe6j8ojk1h4g.jpeg"><br>  <strong>Protocolos de streaming</strong> s√£o protocolos do mundo das chamadas p2p: <strong>RTMP, webRTC, RTSP / RTP</strong> .  Eles diferem na medida em que os usu√°rios concordam em qual canal eles t√™m, selecione a taxa de bits do codec de acordo com o canal.  E eles tamb√©m t√™m equipes adicionais desse tipo, como "me d√™ uma chance de refer√™ncia".  Se voc√™ perdeu um quadro, nesses protocolos voc√™ pode solicit√°-lo novamente. <br><br>  A diferen√ßa entre os <strong>protocolos de segmento</strong> √© que ningu√©m negocia com ningu√©m.  Eles cortam o v√≠deo em segmentos, armazenam cada segmento em v√°rias qualidades e o cliente pode escolher qual segmento assistir.  Cada segmento come√ßa com um quadro de refer√™ncia. <br><br>  Considere os protocolos em mais detalhes.  Vamos come√ßar com os protocolos de streaming e descobrir quais problemas podemos encontrar se usarmos protocolos de streaming para streaming de broadcast. <br><br><h3>  Protocolos de Streaming </h3><br>  O perisc√≥pio usa RTMP.  Esse protocolo apareceu em 2009 e, a princ√≠pio, a Adobe n√£o o especificou completamente.  Ent√£o ele teve um certo tipo de dificuldade com o fato de a Adobe querer vender exclusivamente seu servidor.  Ou seja, o RTMP se desenvolveu bastante dif√≠cil.  Seu principal problema √© que <strong>ele usa o TCP</strong> , mas por algum motivo o Periscope o escolheu. <br><br><img src="https://habrastorage.org/webt/p3/qf/8x/p3qf8x_qmpcxxs1ydjzdrewzpv8.jpeg"><br><br>  Se voc√™ ler em detalhes, o Periscope usa o RTMP para transmitir com um pequeno n√∫mero de visualizadores.  Apenas essas transmiss√µes, se voc√™ tiver um canal insuficiente, provavelmente n√£o poder√° assistir. <br><br><img src="https://habrastorage.org/webt/42/cc/oy/42ccoy-bvsta9_1wi47vsetzrpy.jpeg"><br><br>  Considere um exemplo espec√≠fico.  H√° um usu√°rio com um canal estreito de comunica√ß√£o que est√° assistindo a sua transmiss√£o.  Voc√™ concorda com ele no RTMP sobre baixa taxa de bits e come√ßa a transmitir pessoalmente para ele. <br><br>  Um usu√°rio com Internet legal chega at√© voc√™, voc√™ tamb√©m tem Internet legal, mas voc√™ j√° concordou com baixa qualidade com algu√©m, e acontece que este terceiro com Internet legal est√° assistindo a um fluxo de baixa qualidade, apesar do fato de que poderia parece bom. <br><br>  Decidimos corrigir esse problema.  Tornamos poss√≠vel que o RTMP seja truncado individualmente para cada cliente, ou seja, os streamers negociam com o servidor, transmitem com a qualidade mais alta poss√≠vel e cada cliente recebe a qualidade que a rede permite. <br><br>  Uau! <br><br>  Mas ainda assim, temos RTMP sobre TCP e ningu√©m nos assegurou de bloquear o in√≠cio da fila. <br><br><img src="https://habrastorage.org/webt/pr/ri/db/prridbql3upjieh2baseexcnkoa.jpeg"><br><br>  Isso √© ilustrado na figura: recebemos quadros de √°udio e v√≠deo, o RTMP os compacta, talvez eles os misturem de alguma forma e voam para a rede. <br><br>  Mas suponha que perdemos um pacote.  √â poss√≠vel que o mesmo pacote perdido amarelo - esse geralmente seja um quadro P de algum anterior - possa ter sido descartado.  Talvez, no m√≠nimo, algu√©m possa reproduzir √°udio.  Mas o TCP n√£o nos fornecer√° o restante dos pacotes, pois <strong>garante a entrega e a sequ√™ncia de pacotes</strong> .  De alguma forma, devemos lidar com isso. <br><br><img src="https://habrastorage.org/webt/me/vz/at/mevzattuvqxtwrbnu61ubb40nm8.jpeg"><br>  H√° outro problema com o uso do protocolo TCP no streaming. <br><br>  Digamos que temos um buffer e alta largura de banda de rede.  N√≥s geramos pacotes de alta resolu√ß√£o do nosso codec l√°.  Ent√£o - op!  - a rede come√ßou a funcionar pior.  No codec, j√° indicamos que a taxa de bits precisa ser reduzida, mas os pacotes prontos j√° est√£o na fila e <strong>voc√™ n√£o pode remov√™-los de</strong> nenhuma maneira.  O TCP est√° desesperado para enviar pacotes HD atrav√©s do nosso 3G. <br><br>  Como n√£o temos gerenciamento de buffer, nem prioriza√ß√£o, o <strong>TCP √© extremamente inadequado para streaming</strong> . <br><br><img src="https://habrastorage.org/webt/nh/ed/xr/nhedxrx0krpqjjtcq3txpq4a0_i.jpeg"><br><br>  Vamos dar uma olhada nas redes m√≥veis agora.  Pode ser surpreendente para os residentes das capitais, mas nossa rede m√≥vel m√©dia √© mais ou menos assim: <br><br><ul><li>  Tr√°fego de 1,1 Mbps; <br></li><li>  0,1% de perda de pacotes; <br></li><li>  RTT m√©dio de 300 ms. <br></li></ul><br>  E se voc√™ observar algumas regi√µes e operadores espec√≠ficos, eles ter√£o uma <strong>porcentagem m√©dia di√°ria de perda de pacotes superior a 3%</strong> e o RTT de 600 ms √© normal. <br><br>  O TCP √©, por um lado, um protocolo interessante - √© muito dif√≠cil ensinar um carro a dirigir imediatamente em rodovias e fora de estrada.  Mas ensin√°-la tamb√©m a voar sobre redes sem fio era muito dif√≠cil. <br><br><img src="https://habrastorage.org/webt/7d/1u/la/7d1ula7h-j6sf-4mb4xyw-pqi_m.jpeg"><br><br><blockquote>  Perder at√© 0,001% dos pacotes resulta em uma redu√ß√£o de 30% na taxa de transfer√™ncia.  Ou seja, nosso usu√°rio n√£o utiliza o canal em 30% devido √† inefici√™ncia do protocolo TCP em redes com perda aleat√≥ria de pacotes. <br></blockquote><br>  Em certas regi√µes, a perda de pacotes atinge 1% e o usu√°rio possui cerca de 10% da largura de banda. <br><br>  Portanto, <strong>n√£o faremos TCP</strong> . <br><br>  Vamos ver o que mais h√° no mundo do streaming a partir do UDP. <br><br>  <strong>O protocolo WebRTC</strong> funcionou muito bem para chamadas p2p.  Em sites muito populares, eles escrevem que us√°-lo para chamadas √© muito legal, mas para fornecer v√≠deo e m√∫sica n√£o √© bom. <br><br>  Seu principal problema √© que ele <strong>negligencia perdas</strong> .  Com todas as situa√ß√µes estranhas, ele simplesmente cai. <br><br>  Ainda h√° algum problema em seu apego √†s chamadas, o fato √© que ele criptografa tudo.  Portanto, se voc√™ transmitir transmiss√µes e n√£o for necess√°rio criptografar todo o fluxo de √°udio / v√≠deo iniciando o WebRTC, voc√™ sobrecarregar√° seu processador de qualquer maneira.  Voc√™ pode n√£o precisar disso. <br><br><img src="https://habrastorage.org/webt/h4/qq/1o/h4qq1o8awojsly2-fo-mggjb30y.jpeg"><br><br>  <strong>O streaming RTP</strong> √© o protocolo b√°sico para transmiss√£o de dados atrav√©s de UDP.  Abaixo, no slide √† direita, h√° um conjunto de extens√µes e RFCs que precisavam ser implementados no WebRTC para adaptar esse protocolo para chamadas.  Em princ√≠pio, voc√™ pode tentar fazer algo assim - discar um conjunto de extens√µes para o RTP e obter streaming UDP.  <strong>Mas √© muito dif√≠cil</strong> . <br><br>  O segundo problema √© que, se um de seus clientes n√£o suportar nenhuma extens√£o, o protocolo n√£o funcionar√°. <br><br><img src="https://habrastorage.org/webt/vi/ny/wl/vinywlwh6wfdwrrfznzoiccjjzc.jpeg"><br><br><h3>  Protocolos de segmento </h3><br>  Um bom exemplo de um protocolo de v√≠deo segmentado √© o <strong>MPEG-Dash</strong> .  Consiste em um arquivo de manifesto que voc√™ publica no seu portal.  Ele cont√©m links para arquivos de diferentes qualidades; no in√≠cio do arquivo, existe um √≠ndice que indica em qual local do arquivo qual segmento inicia. <br><br><img src="https://habrastorage.org/webt/9x/kd/py/9xkdpywmis1cfrdrmx6peob2gag.jpeg"><br><br>  O v√≠deo inteiro √© dividido em segmentos, por exemplo, por 3 segundos, cada segmento come√ßa com um quadro de refer√™ncia.  Se voc√™ assistir a esse v√≠deo e sua taxa de bits mudar, apenas no lado do cliente come√ßar√° a ter o segmento da qualidade que voc√™ precisa. <br><br>  Outro exemplo de streaming segmentado √© o <strong>HLS</strong> . <br><br>  O MPEG-Dash √© uma solu√ß√£o do Google, funciona bem no Android, e a solu√ß√£o da Apple √© mais antiga, possui v√°rias desvantagens. <br><br><img src="https://habrastorage.org/webt/ed/jv/wv/edjvwvr9g_-n_tihydmscth_rym.jpeg"><br><br>  A primeira delas √© que o manifesto principal cont√©m links para manifestos secund√°rios, os manifestos secund√°rios para cada qualidade espec√≠fica cont√™m links para cada segmento individual e cada segmento individual √© representado por um arquivo separado. <br><br>  Se voc√™ olhar ainda mais detalhadamente, dentro de cada segmento estar√° o MPEG2-TS.  Este protocolo tamb√©m foi feito para o sat√©lite; seu tamanho de pacote √© de <strong>188 bytes</strong> .  √â muito inconveniente compactar v√≠deos com esse tamanho, principalmente porque voc√™ fornece um cabe√ßalho pequeno o tempo todo. <br><br>  De fato, isso √© dif√≠cil n√£o apenas para servidores, que para processar 40 GB de tr√°fego devem coletar <strong>26 milh√µes de pacotes</strong> , mas tamb√©m √© dif√≠cil para o cliente.  Portanto, quando reescrevemos o player iOS no MPEG-Dash, vimos alguns ganhos de desempenho. <br><br><img src="https://habrastorage.org/webt/li/iy/-b/liiy-bk2b4hbreygtlsrypgykb4.jpeg"><br><br>  Mas a Apple n√£o fica parada.  Em 2016, eles finalmente anunciaram que t√™m a oportunidade de empurrar um fragmento do MPEG4 no HLS.  Eles prometeram adicionar isso apenas para desenvolvedores, mas parece que agora o suporte para macOS e iOS deve aparecer. <br><br>  Ou seja, parece que o fluxo de fragmentos √© conveniente - venha, pegue o fragmento desejado, comece pelo quadro de refer√™ncia - ele funciona. <br><br>  Menos: √© claro que o quadro de refer√™ncia a partir do qual voc√™ iniciou n√£o √© o quadro que aquele que transmite agora o possui.  Portanto, <strong>sempre h√° um atraso</strong> . <br><br>  Em geral, √© poss√≠vel finalizar o HLS com atrasos da ordem de 5 segundos, algu√©m diz que conseguiu 4, mas, em princ√≠pio, a <strong>decis√£o de usar o streaming de fragmentos para tradu√ß√£o n√£o √© muito boa</strong> . <br><br><img src="https://habrastorage.org/webt/ot/5d/fx/ot5dfxmgkfjri9h6uqxttl7dwoo.jpeg"><br><br><h3>  Dificuldade vs Atraso </h3><br>  Vamos examinar todos os protocolos dispon√≠veis e classific√°-los por dois par√¢metros: <br><br><ul><li>  a lat√™ncia que eles d√£o entre a transmiss√£o e o visualizador; </li><li>  complexidade </li></ul><br>  Quanto menor o atraso que o protocolo garante, mais complexo √©. <br><br><img src="https://habrastorage.org/webt/va/or/jm/vaorjm1gkqcpwvxf1eos4uds90a.jpeg"><br><br><h3>  O que n√≥s queremos? </h3><br>  Queremos criar um protocolo UDP para transmiss√£o de 1 a N com um atraso compar√°vel √† comunica√ß√£o p2p, com a op√ß√£o de criptografia opcional de pacotes, dependendo da transmiss√£o p√∫blica ou privada. <br><br>  <strong>Que outras op√ß√µes existem?</strong>  Voc√™ pode esperar, por exemplo, quando o Google lan√ßar seu QUIC. <br><br>  Vou lhe contar um pouco o que √©.  O Google est√° posicionando o Google QUIC como um substituto para o TCP - um tipo de TCP 2.0.  Ele foi desenvolvido desde 2013, agora n√£o possui uma especifica√ß√£o, mas est√° totalmente dispon√≠vel no Google Chrome, e parece-me que √†s vezes o ativam em alguns usu√°rios para ver como ele funciona.  Em princ√≠pio, voc√™ pode acessar as configura√ß√µes, ativar o QUIC, acessar qualquer site do Google e obter esse recurso via UDP. <br><br>  Decidimos n√£o esperar at√© que todos especifiquem e arquivar nossa decis√£o. <br><br>  Requisitos de protocolo: <br><br><ol><li>  <strong>Multithreading</strong> , ou seja, temos v√°rios fluxos - controle, v√≠deo, √°udio. <br></li><li>  <strong>Uma garantia de entrega opcional</strong> - o fluxo de controle tem 100% de garantia, o v√≠deo de que precisamos menos - podemos deixar o quadro l√°, ainda gostar√≠amos de √°udio. <br></li><li>  <strong>Prioriza√ß√£o de fluxos</strong> - para que o √°udio avance e o gerente geralmente voe. <br></li><li>  <strong>Criptografia opcional</strong> : todos os dados ou apenas cabe√ßalhos e dados cr√≠ticos. <br></li></ol><br><img src="https://habrastorage.org/webt/k6/un/6t/k6un6tc2qxdngdgbjgvycugso80.jpeg"><br><br>  Este √© um tri√¢ngulo padr√£o: se uma boa rede, alta qualidade e baixa lat√™ncia.  Assim que uma rede inst√°vel aparece, os pacotes come√ßam a desaparecer, equilibramos qualidade e atraso.  Temos uma escolha: esperar at√© que a rede melhore e enviar tudo o que acumulou ou desistir e, de alguma forma, viver com ela. <br><br>  Se voc√™ classificar os protocolos por esse princ√≠pio, poder√° ver que <strong>quanto menor o tempo de espera, pior a qualidade</strong> - uma conclus√£o bastante simples. <br><br>  Queremos inserir nosso protocolo na zona em que os atrasos se aproximam do WebRTC, mas ao mesmo tempo sermos capazes de pression√°-lo um pouco, porque afinal n√£o temos chamadas, mas transmiss√µes.  O usu√°rio deseja finalmente receber um fluxo de qualidade. <br><br><h2>  Desenvolvimento </h2><br>  Vamos come√ßar a escrever o protocolo UDP, mas primeiro observe as estat√≠sticas. <br><br><img src="https://habrastorage.org/webt/7f/pa/g2/7fpag2oc-8grjh0sprl-xjok9hg.jpeg"><br><br>  Estas s√£o as nossas estat√≠sticas sobre redes m√≥veis.  Pode-se observar que a Internet m√©dia √© um pouco mais que megabit, perda de pacotes de cerca de 1% √© normal e RTT na regi√£o de 600 ms - no 3G, esses s√£o apenas valores m√©dios. <br><br>  Vamos nos concentrar nisso ao escrever o protocolo - vamos l√°! <br><br><h2>  Protocolo UDP </h2><br>  Abrimos soquete UDP, tiramos os dados, empacotamos, enviamos.  Pegamos o segundo pacote do codec, ainda enviamos.  Tudo parece estar √≥timo! <br><br><img src="https://habrastorage.org/webt/_z/mn/pb/_zmnpbiqjqaylvgxteujqyehvi4.jpeg"><br><br>  Mas temos a seguinte imagem: se come√ßarmos a enviar pacotes UDP aleatoriamente para soquete, de acordo com as estat√≠sticas, no 21¬∫ pacote, a probabilidade de atingir ser√° de apenas 85%.  Ou seja, a perda de pacotes j√° ser√° de 15%, o que n√£o √© bom.  Isso precisa ser corrigido. <br><br><img src="https://habrastorage.org/webt/-k/9x/yf/-k9xyfgw5atqxwbfgsoz4hwdzpo.jpeg"><br><br>  Isso √© fixo como padr√£o.  A ilustra√ß√£o ilustra a vida sem o Pacer e a vida com o <strong>Pacer</strong> . <br><br>  O marcapasso √© uma coisa que espalha pacotes no tempo e controla sua perda;  Ele analisa o que √© perda de pacotes agora, dependendo disso, ele se adapta √† velocidade do canal. <br><br>  Como lembramos, para redes m√≥veis, a perda de pacotes de 1-3% √© a norma.  Por conseguinte, devemos de alguma forma trabalhar com isso.  E se perdermos pacotes? <br><br><h3>  Retransmitir </h3><br><img src="https://habrastorage.org/webt/rm/6c/sn/rm6csnnevyp8uer3y_88usgnxvi.jpeg"><br><br>  No TCP, como voc√™ sabe, existe um algoritmo de retransmiss√£o r√°pido: enviamos um pacote, o segundo, se o pacote for perdido, depois de um tempo (per√≠odo de retransmiss√£o) enviamos o mesmo pacote. <br><br>  Quais s√£o as vantagens?  Sem problemas, sem redund√¢ncia, mas h√° um <strong>per√≠odo de retransmiss√£o</strong> negativo. <br><br><img src="https://habrastorage.org/webt/wa/91/8x/wa918xscu2p_r9dym0hxtexa-te.jpeg"><br><br>  Parece ser muito simples: depois de algum tempo, voc√™ precisar√° repetir o pacote se n√£o tiver recebido confirma√ß√£o.  Logicamente, esse pode ser um tempo igual ao tempo de ping.  ping ‚Äî    ,      RTT time ,   ,   . <br><br>  ,    , ,   ,  jitter:       ping-. ,   ,    46 .     jitter ‚Äî 50. <br><br><img src="https://habrastorage.org/webt/tc/ut/qp/tcutqprunmcey5nsfas7jobk1ju.jpeg"><br><br>        .   RTT   ,      ,  acknowledge      .  ,  RFC6298,   TCP ,     . <br><br>     jitter.     jitter  ping  15%. ,  retransmit period  ,  ,  20% ,  RTT. <br><br><img src="https://habrastorage.org/webt/ro/0f/ut/ro0futlozzfwqp7frtgd4-26ufg.jpeg"><br><br>     retransmit.       acknowledge   .    ,  ,    .    retransmit period,       .    ,      . <br><br>       ,   retransmit   .   , , packet loss 5%,    400 ,   400    1      packet-drop,  ,    retransmit period  ,      . <br><br>    ,   .    , ,    acknowledge   . ,   ‚Äî   ,       ,  speculative retransmit   . <br><br>      retransmit,     . <br><br>      .  ,   <strong>Forward Error Correction</strong> ?      , , XOR.    ,       ,       . <br><br><img src="https://habrastorage.org/webt/zd/b1/pe/zdb1pedfxegynl5dx-m7qopdgqw.jpeg"><br><br> !     round trip,      . <br><br>  ,     ,   ?   XOR    ‚Äî ,   Reed-Solomon, Fountain codes  ..  :   K ,     N  ,   N   . <br><br>   ! <br><br> ,      ,     ,    Forward Error Correction    negative acknowledgement. <br><br><h3> NACK </h3><br><img src="https://habrastorage.org/webt/yy/6d/uv/yy6duvocxiqc43veskkksrfj7s0.jpeg"><br><br>     ,   parity protection (  )    ,    . <br><br>  NACK: <br><br><ul><li>   ,      negative acknowledgement,    . <br></li><li>    FEC. <br></li></ul><br> ,    : <br><br><ol><li>   , FEC + NACK; <br></li><li>   , Fast retransmit. <br></li></ol><br> ,    . <br><br><img src="https://habrastorage.org/webt/zs/tg/dr/zstgdrqijyhnsnbfx4xfpgfixa8.jpeg"><br><br> ,        ,   (  ).    , ,  11 ,     60-80 .  ,   ,   . <br><br>        6 . <br><br><img src="https://habrastorage.org/webt/7p/bm/1e/7pbm1elkbfopc4zogdohequo4zo.jpeg"><br><br>     ,    ,    .    ,    . , Wi-Fi  22    5 , 3G   34   8 . <br><br><img src="https://habrastorage.org/webt/-1/7_/sg/-17_sgwf_vd6x88lryeyqarozfq.jpeg"><br><br> :   ,    90% packet loss     10 ,     gap  25 ,     ‚Äî FEC + NACK  Fast retransmit? <br><br> , ,  ,  Google,     QUIC  2013 ,  Forward Error Correction  , ,     .   2015   . <br><br>           FEC + NACK,       . <br><br> ,   . <br><br><img src="https://habrastorage.org/webt/vo/vx/en/vovxendpcptrbqle5r-_dsphz7o.jpeg"><br><br>  ,    , c    : <br><br><ul><li> 1 / ; <br></li><li> 1% packet loss; <br></li><li> 300  RTT; <br></li><li> 1 000  ‚Äî   ; <br></li><li> 1 000    . <br></li></ul><br>        10 .   packet loss  1%    1 000   10.  ‚Äî    100   1 ‚Äî  ,        2 ,   . <br><br>     ,     .    500- ,      10 . <br><br>    : <br><br><ul><li>   500      Forward Error Correction.        ,     . <br></li><li>   NACK,   ,    . <br></li><li>      Fast Retransmit,           . <br></li></ul><br>  Forward Error Correction  ,       ‚Äî  gap      200-300     . <br><br><h3> Fast Retransmit </h3><br>   :  ,      10 ,    , ,    retransmit period ,     . <br><br><img src="https://habrastorage.org/webt/uf/8l/vu/uf8lvu8cm-golfpmgpng1rln25y.jpeg"><br><br>    ,  retransmit period     350 ,     packet gap ‚Äî 25-30 ,   100.  ,   ,  retransmit   ,         . <br><br>   ,       . <br><br><h3>   </h3><br>       UDP       ,    . <br><br><img src="https://habrastorage.org/webt/rh/lr/nf/rhlrnfukoaeiiy8vxnrku7qbopg.jpeg"><br><br>   ,     ,   p/b-.     .      ,      . <br><br>  ,      ,    ,     ,   , ,  0,5          . <br><br>  ,    ,       ,     ,    p/b,   ,       ,     . <br><br><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> MTU </font></font></h3><br>  Como estamos escrevendo o protocolo, teremos que lidar com a fragmenta√ß√£o de IP.  Eu acho que muitas pessoas sabem disso, mas por via das d√∫vidas, vou contar brevemente. <br><br><img src="https://habrastorage.org/webt/wy/wy/lt/wywyltg-bw2a3ypzpvmkpz1zcsw.jpeg"><br><br>  Temos um servidor, ele envia alguns pacotes para a rede, eles chegam ao roteador e, no seu n√≠vel, a MTU (unidade m√°xima de transmiss√£o) fica menor que o tamanho do pacote que chegou.  Ele divide o pacote em grande e pequeno (aqui 1100 e 400 bytes) e envia. <br><br>  Em princ√≠pio, n√£o h√° problema, tudo se reunir√° no cliente e funcionar√°.  Mas se perdermos 1 pacote, eliminamos todos os pacotes, al√©m de obtermos custos adicionais para os cabe√ßalhos dos pacotes.  Portanto, se voc√™ estiver escrevendo seu protocolo, √© ideal trabalhar na quantidade de MTU. <br><br>  <strong>Como contar?</strong> <br><br>  De fato, o Google n√£o se incomoda, coloca cerca de 1200 bytes no seu QUIC e n√£o o seleciona, porque a fragmenta√ß√£o de IP coletar√° todos os pacotes. <br><br><img src="https://habrastorage.org/webt/lj/q0/eu/ljq0eutloqqgituniq6jhfodjwo.jpeg"><br><br>  Fazemos exatamente o mesmo - primeiro definimos um tamanho padr√£o e come√ßamos a enviar pacotes - deixe fragment√°-los. <br><br>  Paralelamente, execute um thread separado e crie um soquete com o sinalizador de proibi√ß√£o de fragmenta√ß√£o para todos os pacotes.  Se o roteador encontrar um pacote desse tipo e n√£o puder fragmentar esses dados, ele eliminar√° o pacote e possivelmente enviar√° a voc√™ via ICMP que h√° problemas, mas, muito provavelmente, o ICMP ser√° fechado e isso n√£o acontecer√°.  Portanto, simplesmente tentamos, por exemplo, tr√™s vezes enviar um pacote de um determinado tamanho em algum intervalo.  Se n√£o atingir, acreditamos que o MTU foi excedido e o reduzimos ainda mais. <br><br>  Assim, tendo o MTU da interface da Internet que est√° no dispositivo e algum MTU m√≠nimo, simplesmente selecionamos o MTU correto por pesquisa unidimensional.  Depois disso, ajustamos o tamanho do pacote no protocolo. <br><br>  De fato, √†s vezes muda.  Ficamos surpresos, mas no processo de troca de Wi-Fi, etc. MTU est√° mudando.  √â melhor n√£o parar esse processo paralelo e corrigir o MTU de tempos em tempos. <br><br><img src="https://habrastorage.org/webt/x5/db/hy/x5dbhy0sbgn990swfjmqp2s9z8w.jpeg"><br><br>  Maior distribui√ß√£o de MTU no mundo.  Temos cerca de 1100 bytes no portal. <br><br><h3>  Criptografia </h3><br>  Dissemos que desejamos gerenciar opcionalmente a criptografia.  N√≥s fazemos a op√ß√£o mais simples - Diffie-Hellman em curvas el√≠pticas.  Fazemos isso opcionalmente - criptografamos apenas os pacotes de controle e os cabe√ßalhos para que o homem do meio n√£o possa receber a chave de transmiss√£o, intercept√°-la e assim por diante. <br><br><img src="https://habrastorage.org/webt/nn/sv/h3/nnsvh3c3wxoulkrg31ggc8kkvyg.jpeg"><br><br>  Se a transmiss√£o for privada, tamb√©m podemos adicionar a criptografia de todos os dados. <br><br>  Os pacotes s√£o criptografados com o AES-256 de forma independente, para que a queda de pacotes n√£o afete a criptografia adicional de pacotes. <br><br><h3>  Prioriza√ß√£o </h3><br>  Lembre-se, quer√≠amos mais prioriza√ß√£o do protocolo. <br><br><img src="https://habrastorage.org/webt/cc/ob/hd/ccobhdbwn5xelxwurrvsz7rxttg.jpeg"><br><br>  Temos metadados, quadros de √°udio e v√≠deo, enviamos com sucesso para a rede.  Ent√£o nossa rede queima no inferno e por um longo tempo n√£o funciona - entendemos que precisamos descartar pacotes. <br><br>  Principalmente descartamos pacotes de v√≠deo, depois tentamos eliminar o √°udio e nunca tocamos nos pacotes de controle, porque dados como altera√ß√µes de resolu√ß√£o e outros problemas importantes podem passar por eles. <br><br><h3>  Bun adicional sobre UDP </h3><br>  Se voc√™ escrever seu protocolo UDP, por exemplo, com comunica√ß√£o bidirecional, precisar√° entender que h√° NAT Unbinding e a chance de n√£o encontrar o cliente de volta no servidor. <br><br><img src="https://habrastorage.org/webt/zs/my/ii/zsmyiips__dpgzghjbdeovvz_6g.jpeg"><br><br>  No slide, h√° momentos em que n√£o foi poss√≠vel acessar o cliente a partir do servidor via UDP. <br><br>  Muitos c√©ticos dizem que os roteadores s√£o projetados de tal maneira que o NAT Unbinding exclui principalmente as rotas UDP.  Mas o exposto acima mostra que se o Keep-Alive ou o ping tiver menos de 30 segundos, com uma probabilidade de 99%, ser√° poss√≠vel alcan√ßar o cliente. <br><br><h3>  Disponibilidade de UDP em dispositivos m√≥veis no mundo </h3><br><img src="https://habrastorage.org/webt/nt/mv/5u/ntmv5u_uv_pl1jdgabyewmmhk80.jpeg"><br><br>  O Google diz 6%, mas descobriu-se que <strong>7% dos usu√°rios m√≥veis n√£o podem usar UDP</strong> .  Nesse caso, deixamos nosso lindo protocolo com prioriza√ß√£o, criptografia e tudo, apenas no TCP. <br><br>  No UDP, o VOIP agora funciona no WebRTC, no Google QUIC e muitos jogos funcionam no UDP.  Portanto, eu n√£o acreditaria que o UDP ser√° fechado em dispositivos m√≥veis. <br><br>  Como resultado, n√≥s: <br><br><ul><li>  Reduzido o atraso entre a serpentina e o observador para 1 s. <br></li><li>  Nos livramos do efeito cumulativo nos buffers, ou seja, a transmiss√£o n√£o fica para tr√°s. <br></li><li>  O n√∫mero de <strong>barracas</strong> na plat√©ia <strong>diminuiu</strong> . <br></li><li>  Eles foram capazes de suportar o streaming em dispositivos m√≥veis FullHD. <br></li></ul><br><img src="https://habrastorage.org/webt/im/ql/le/imqlle87zr_gdvhaflkcxe-25_q.jpeg"><br><ul><li>  O atraso em nosso aplicativo m√≥vel OK Live √© 25 ms - 10 ms a mais do que o scanner da c√¢mera funciona, mas n√£o √© t√£o assustador. <br></li><li>  Webcasting mostra um atraso de apenas 690 ms - espa√ßo! <br></li></ul><br><h2>  O que mais pode transmitir no Odnoklassniki </h2><img src="https://habrastorage.org/webt/le/zu/zc/lezuzc64qct36iohbnoyukuab8o.jpeg"><br><br><ul><li>  Aceita nosso protocolo OKMP de dispositivos m√≥veis; <br></li><li>  pode aceitar RTMP e WebRTC; <br></li><li>  fornece HLS, MPEG-Dash, etc. <br></li></ul><br>  Se voc√™ tomou cuidado, percebeu que eu disse que podemos pegar, por exemplo, o WebRTC do usu√°rio e convert√™-lo em RTMP. <br><br><img src="https://habrastorage.org/webt/me/hc/3c/mehc3cteyxhn2hcsrjd1vmx9z_y.jpeg"><br><br>  H√° uma nuance.  De fato, o WebRTC √© um protocolo orientado a pacotes e usa o codec de √°udio OPUS.  Voc√™ n√£o pode usar o OPUS no RTMP. <br><br>  Em servidores back-end, usamos RTMP em qualquer lugar.  Portanto, tivemos que fazer mais algumas corre√ß√µes no FF MPEG, o que nos permite inserir o OPUS no RTMP, convert√™-lo em AAC e fornec√™-lo aos usu√°rios que j√° est√£o no HLS ou em qualquer outra coisa. <br><br><h2>  Como √© dentro de n√≥s? </h2><img src="https://habrastorage.org/webt/v_/s2/z4/v_s2z4ja4xlfcuacadyelfpcdj0.jpeg"><br><br><ul><li>  Usu√°rios que usam um dos protocolos carregam o v√≠deo original em nosso servidor de upload. <br></li><li>  L√°, implantamos o protocolo. <br></li><li>  Enviamos RTMP para um dos servidores de transforma√ß√£o de v√≠deo. <br></li><li>  O original √© sempre armazenado em um armazenamento distribu√≠do para que nada se perca. <br></li><li>  Depois disso, todos os v√≠deos v√£o para o servidor de distribui√ß√£o. <br></li></ul><br>  Para ferro, temos o seguinte: <br><br><img src="https://habrastorage.org/webt/hb/zc/nl/hbzcnl6smz5tevhx5ud_phg0m0q.jpeg"><br>  Vou falar um pouco mais sobre a toler√¢ncia a falhas: <br><br><ul><li>  Os servidores de upload s√£o distribu√≠dos em diferentes datacenters, protegendo IPs diferentes. <br></li><li>  Os usu√°rios v√™m, recebem IP no DNS. <br></li><li>  O servidor de upload envia o v√≠deo para os servidores de fatia, eles cortam e d√£o aos servidores de distribui√ß√£o. <br></li><li>  Para transmiss√µes mais populares, come√ßamos a adicionar um n√∫mero maior de servidores de distribui√ß√£o. <br></li><li>  Salvamos tudo o que veio do usu√°rio no reposit√≥rio, para que mais tarde possamos criar um arquivo de transmiss√£o e n√£o perder nada. <br></li><li>  Armazenamento tolerante a falhas distribu√≠do por tr√™s data centers. <br></li></ul><br>  Para determinar qual servidor √© atualmente respons√°vel pela tradu√ß√£o, usamos o <strong>ZooKeeper</strong> .  Para cada tradu√ß√£o, armazenamos um n√≥ e fazemos n√≥s ef√™meros para cada servidor.  De fato, isso permite que um fluxo crie uma fila de servidores que ser√£o processados.  Sempre o l√≠der atual nesta linha est√° envolvido no processamento de fluxo. <br><br>  Testaremos a toler√¢ncia a falhas rapidamente.  Come√ßamos imediatamente com o desaparecimento de todo o data center. <br><br>  <strong>O que vai acontecer?</strong> <br><br><ul><li>  O usu√°rio DNS receber√° o pr√≥ximo IP de outro servidor de upload. <br></li><li>  A essa altura, o ZooKeeper entender√° que o servidor nesse data center morreu e selecionar√° o servidor de fatiamento para outro. <br></li><li>  Os servidores de download descobrir√£o quem agora √© respons√°vel pela transforma√ß√£o desse fluxo e o distribuir√£o. <br></li></ul><br>  Em princ√≠pio, tudo isso acontecer√° com atrasos m√≠nimos. <br><br><h2>  Usando o protocolo no produto </h2>  Criamos o aplicativo m√≥vel de transmiss√£o ao vivo OK.  Est√° totalmente integrado ao portal.  Os usu√°rios podem se comunicar, realizar transmiss√µes ao vivo, h√° um mapa de transmiss√µes, uma lista de transmiss√µes populares - em geral, tudo o que voc√™ deseja. <br><br><img src="https://habrastorage.org/webt/kz/4n/on/kz4nonh4fuveoh5iilwwhipapl8.jpeg"><br><br>  Tamb√©m adicionamos a capacidade de transmitir em FullHD.  Voc√™ pode conectar uma c√¢mera de a√ß√£o no Android a um dispositivo Android. <br><br><img src="https://habrastorage.org/webt/pi/ut/ga/piutgamml44x_nzqt41dlg3t9za.jpeg"><br><br>  Agora, temos um mecanismo que permite transmiss√µes ao vivo.  Por exemplo, tra√ßamos uma linha direta com o presidente por meio do OK Live e a transmitimos para <strong>todo o pa√≠s</strong> .  Os usu√°rios assistiram e, atrav√©s do fluxo que se aproximava, podiam entrar no ar e fazer suas perguntas. <br><br>  Isto √©, de fato, dois fluxos que se aproximam com um atraso m√≠nimo fornecem um certo formato de confer√™ncia p√∫blica. <br><br>  De fato, nos encontramos em algum lugar em 2 segundos - um segundo l√° e um segundo atr√°s.  Lembre-se do ‚Äúcarrinho‚Äù de que falei no in√≠cio do artigo - agora parece dois caminh√µes enormes.  Para transmiss√£o de TV, remover da c√¢mera e misturar tudo com um atraso de cerca de 1-2 s √© completamente normal. <br><br>  De fato, conseguimos reproduzir algo compar√°vel ao atual TCP moderno. <br><br><img src="https://habrastorage.org/webt/si/io/dg/siiodgw1g17mn3b1jt8270ezuo8.jpeg"><br><br>  As transmiss√µes ao vivo s√£o a tend√™ncia atual.  No √∫ltimo ano e meio, no portal OK, eles triplicaram (n√£o sem a ajuda do aplicativo OK Live). <br><br><img src="https://habrastorage.org/webt/lx/sa/4w/lxsa4wk6ltmz8xefbsunlfbqjrq.jpeg"><br><br>  Todas as transmiss√µes s√£o gravadas por padr√£o.  Temos cerca de 50 mil fluxos por dia, isso gera cerca de 17 terabytes de tr√°fego por dia, mas, em geral, todo o v√≠deo no portal gera cerca de um petabyte de dados por m√™s. <br><br><img src="https://habrastorage.org/webt/zg/n3/h6/zgn3h616zrtpcyw7dkgpuwconp4.jpeg"><br><br>  O que conseguimos: <br><br><ul><li>  Poderia garantir a dura√ß√£o do atraso entre a serpentina e o p√∫blico. <br></li><li>  Criamos o primeiro aplicativo m√≥vel FullHD para streaming em um canal de Internet m√≥vel que muda dinamicamente. <br></li><li>  Tivemos a oportunidade de perder data centers e, ao mesmo tempo, n√£o interromper a transmiss√£o <br></li></ul><br>  O que voc√™ aprendeu: <br><br><ul><li>  O que √© v√≠deo e como transmiti-lo. <br></li><li>  Voc√™ pode escrever seu protocolo UDP se tiver certeza de que possui uma tarefa muito espec√≠fica e usu√°rios espec√≠ficos. <br></li><li>  Sobre a arquitetura de qualquer servi√ßo de streaming - o v√≠deo entra na entrada, converte e sai. <br></li></ul><br><blockquote>  Na <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Highload ++ Siberia,</a> Alexander Tobol promete <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">falar</a> sobre o servi√ßo de chamada OK, ser√° interessante saber o que foi aplicado a partir do que foi discutido neste artigo e o que teve que ser implementado completamente novamente. <br><br>  Na mesma se√ß√£o, s√£o planejados relat√≥rios sobre t√≥picos altamente especializados: <br><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Eugene Rossinsky</a> (ivi) no sistema para coletar estat√≠sticas detalhadas sobre a opera√ß√£o dos n√≥s CDN. <br></li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Anton Rusakova</a> (Badoo) sobre a integra√ß√£o de sistemas de pagamento sem usar seu pr√≥prio faturamento. <br></li></ul><br></blockquote></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt413479/">https://habr.com/ru/post/pt413479/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt413465/index.html">AMD anuncia Threadripper 2 de 32 n√∫cleos</a></li>
<li><a href="../pt413467/index.html">Backup de dados r√°pido e confi√°vel na nuvem</a></li>
<li><a href="../pt413469/index.html">Um teste de mem√≥ria matando laptops √© quase uma hist√≥ria de detetive</a></li>
<li><a href="../pt413471/index.html">Retrospectiva de sexta-feira Mini Toy Tomy</a></li>
<li><a href="../pt413473/index.html">Desenvolvimento de um interruptor Z-Wave de toque na bateria com bot√µes luminosos</a></li>
<li><a href="../pt413481/index.html">Exportar √°rvore de teste do JMeter para texto</a></li>
<li><a href="../pt413485/index.html">Lan√ßamento do GitLab 10.8: espelhamento de push de c√≥digo aberto e implanta√ß√£o incremental</a></li>
<li><a href="../pt413487/index.html">O que um desenvolvedor deve esperar no campo das finan√ßas: condi√ß√µes de trabalho, projetos e habilidades necess√°rias</a></li>
<li><a href="../pt413489/index.html">Como escolher um messenger verdadeiramente seguro e o que a blockchain tem a ver com isso</a></li>
<li><a href="../pt413491/index.html">Food Design Digest, maio de 2018</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>