<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ğŸ™Š ğŸ´ó §ó ¢ó ³ó £ó ´ó ¿ ğŸ¥§ Unicorn Engineçš„ç¬¬ä¸€æ­¥ ğŸ¦‡ ğŸ‘©ğŸ½â€ğŸ”¬ ğŸ…ğŸ¼</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="åœ¨Habrä¸Šæœç´¢â€œ Unicorn Engineâ€æ—¶ï¼Œæˆ‘å¾ˆæƒŠè®¶åœ°å‘ç°æ–‡ç« ä¸­ä»æœªä½¿ç”¨è¿‡æ­¤å·¥å…·ã€‚ æˆ‘å°†å°½åŠ›å¡«è¡¥è¿™ä¸€ç©ºç™½ã€‚ è®©æˆ‘ä»¬ä»åŸºç¡€å¼€å§‹ï¼Œç„¶åçœ‹ä¸€ä¸ªåœ¨ç°å®ç”Ÿæ´»ä¸­ä½¿ç”¨æ¨¡æ‹Ÿå™¨çš„ç¤ºä¾‹ã€‚ ä¸ºäº†ä¸é‡è¹ˆè¦†è¾™ï¼Œæˆ‘å†³å®šåªç¿»è¯‘æœ¬æ‰‹å†Œã€‚ åœ¨å¼€å§‹ä¹‹å‰ï¼Œæˆ‘ä¼šè¯´æˆ‘çš„æ‰€æœ‰è¯„è®ºæˆ–è¯„è®ºå°†çœ‹èµ·æ¥åƒè¿™æ · ã€‚ 
 ä»€ä¹ˆæ˜¯ç‹¬è§’å…½å¼•æ“ï¼Ÿ 

...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Unicorn Engineçš„ç¬¬ä¸€æ­¥</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/431058/"><p> åœ¨Habrä¸Šæœç´¢â€œ Unicorn Engineâ€æ—¶ï¼Œæˆ‘å¾ˆæƒŠè®¶åœ°å‘ç°æ–‡ç« ä¸­ä»æœªä½¿ç”¨è¿‡æ­¤å·¥å…·ã€‚ æˆ‘å°†å°½åŠ›å¡«è¡¥è¿™ä¸€ç©ºç™½ã€‚ è®©æˆ‘ä»¬ä»åŸºç¡€å¼€å§‹ï¼Œç„¶åçœ‹ä¸€ä¸ªåœ¨ç°å®ç”Ÿæ´»ä¸­ä½¿ç”¨æ¨¡æ‹Ÿå™¨çš„ç¤ºä¾‹ã€‚ ä¸ºäº†ä¸é‡è¹ˆè¦†è¾™ï¼Œæˆ‘å†³å®šåªç¿»è¯‘<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">æœ¬</a>æ‰‹å†Œã€‚  <em>åœ¨å¼€å§‹ä¹‹å‰ï¼Œæˆ‘ä¼šè¯´æˆ‘çš„æ‰€æœ‰è¯„è®ºæˆ–è¯„è®ºå°†çœ‹èµ·æ¥åƒè¿™æ ·</em> ã€‚ </p><a name="habracut"></a><br><h1 id="chto-takoe-unicorn-engine"> ä»€ä¹ˆæ˜¯ç‹¬è§’å…½å¼•æ“ï¼Ÿ </h1><br><p>  <em>å¼€å‘äººå‘˜è‡ªå·±å†™</em> <del>  <em>ç‹¬è§’å…½å¼•æ“</em> </del>  <em>ç‹¬è§’å…½å¼•æ“æ˜¯è¿™æ ·çš„ï¼š</em> </p><br><blockquote>  Unicornæ˜¯ä¸€ä¸ªè½»é‡çº§ï¼Œå¤šå¹³å°å’Œå¤šä½“ç³»ç»“æ„çš„å¤„ç†å™¨ä»¿çœŸå™¨ã€‚ </blockquote><p> è¿™ä¸æ˜¯æ ‡å‡†çš„æ¨¡æ‹Ÿå™¨ã€‚ å®ƒä¸ä¼šæ¨¡æ‹Ÿæ•´ä¸ªç¨‹åºæˆ–æ•´ä¸ªOSçš„æ“ä½œã€‚ å®ƒä¸æ”¯æŒç³»ç»Ÿå‘½ä»¤ï¼ˆä¾‹å¦‚æ‰“å¼€æ–‡ä»¶ï¼Œå°†å­—ç¬¦è¾“å‡ºåˆ°æ§åˆ¶å°ç­‰ï¼‰ã€‚ æ‚¨å°†å¿…é¡»å¯¹å†…å­˜è¿›è¡Œæ ‡è®°å¹¶å°†æ•°æ®è‡ªå·±åŠ è½½åˆ°å…¶ä¸­ï¼Œç„¶ååªéœ€ä»æŸä¸ªç‰¹å®šåœ°å€å¼€å§‹æ‰§è¡Œå³å¯ã€‚ </p><br><p> é‚£ä¹ˆå®ƒæœ‰ä»€ä¹ˆç”¨å‘¢ï¼Ÿ </p><br><ul><li> åˆ†æç—…æ¯’æ—¶ï¼Œæ‚¨å¯ä»¥è°ƒç”¨å•ä¸ªåŠŸèƒ½ï¼Œè€Œæ— éœ€åˆ›å»ºæ¶æ„è¿›ç¨‹ã€‚ </li><li> è§£å†³å‘¨å¤§ç¦ã€‚ </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">å¯¹äºèµ·æ¯›</a> ã€‚ </li><li>  <a href="">gdbçš„æ’ä»¶ï¼Œ</a>ç”¨äºé¢„æµ‹å°†æ¥çš„çŠ¶æ€ï¼Œä¾‹å¦‚å°†æ¥çš„è·ƒç‚¹æˆ–å¯„å­˜å™¨å€¼ã€‚ </li><li> æ¨¡æ‹ŸåŠŸèƒ½ä¸°å¯Œçš„ä»£ç ã€‚ </li></ul><br><p> ä½ éœ€è¦ä»€ä¹ˆ </p><br><ul><li> å·²å®‰è£…å…·æœ‰Pythonç»‘å®šçš„Unicorn Engineã€‚ </li><li> æ‹†è£…æœº </li></ul><br><h1 id="primer"> ä¾‹å­ </h1><br><p> ä¾‹å¦‚ï¼Œä»¥åç§°ä¸º<strong><em>Fibonacciçš„</em></strong> hxp CTF 2017è¿›è¡Œä»»åŠ¡ã€‚ äºŒè¿›åˆ¶æ–‡ä»¶å¯ä»¥åœ¨<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">è¿™é‡Œ</a>ä¸‹è½½ã€‚ </p><br><p> å½“æ‚¨å¯åŠ¨ç¨‹åºæ—¶ï¼Œå®ƒå°†å¼€å§‹åœ¨æ§åˆ¶å°ä¸­æ˜¾ç¤ºæˆ‘ä»¬çš„æ ‡å¿—ï¼Œä½†æ˜¯é€Ÿåº¦éå¸¸æ…¢ã€‚ æ¯ä¸ªåç»­æ ‡å¿—å­—èŠ‚è¢«è®¤ä¸ºè¶Šæ¥è¶Šæ…¢ã€‚ </p><br><pre><code class="bash hljs">The flag is: hxp{F</code> </pre> <br><p> è¿™æ„å‘³ç€ä¸ºäº†åœ¨åˆç†çš„æ—¶é—´å†…è·å–æ ‡å¿—ï¼Œæˆ‘ä»¬éœ€è¦ä¼˜åŒ–æ­¤åº”ç”¨ç¨‹åºçš„æ“ä½œã€‚ </p><br><p> ä½¿ç”¨IDA Proï¼ˆ <em>æˆ‘ä¸ªäººä½¿ç”¨radare2 + Cutter</em> ï¼‰ï¼Œæˆ‘ä»¬å°†ä»£ç åç¼–è¯‘ä¸ºç±»ä¼¼Cçš„ä¼ªä»£ç ã€‚ å°½ç®¡ä»£ç æœªæ­£ç¡®åç¼–è¯‘ï¼Œä½†æˆ‘ä»¬ä»ç„¶å¯ä»¥ä»ä¸­è·å–æœ‰å…³å†…éƒ¨å‘ç”Ÿçš„ä¿¡æ¯ã€‚ </p><br><div class="spoiler">  <b class="spoiler_title">åç¼–è¯‘çš„ä»£ç </b> <div class="spoiler_text"><pre> <code class="cpp hljs">__int64 __<span class="hljs-function"><span class="hljs-function">fastcall </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(__int64 a1, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> **a2, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> **a3)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> *v3; <span class="hljs-comment"><span class="hljs-comment">// rbp@1 int v4; // ebx@1 signed __int64 v5; // r8@2 char v6; // r9@3 __int64 v7; // r8@3 char v8; // cl@3 __int64 v9; // r9@5 int a2a; // [sp+Ch] [bp-1Ch]@3 v3 = &amp;encrypted_flag; v4 = 0; setbuf(stdout, 0LL); printf("The flag is: ", 0LL); while ( 1 ) { LODWORD(v5) = 0; do { a2a = 0; fibonacci(v4 + v5, &amp;a2a); v8 = v7; v5 = v7 + 1; } while ( v5 != 8 ); v4 += 8; if ( (unsigned __int8)(a2a &lt;&lt; v8) == v6 ) break; v3 = (char *)v3 + 1; _IO_putc((char)(v6 ^ ((_BYTE)a2a &lt;&lt; v8)), stdout); v9 = *((char *)v3 - 1); } _IO_putc(10, stdout); return 0LL; }</span></span></code> </pre> <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> __<span class="hljs-function"><span class="hljs-function">fastcall </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">fibonacci</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> i, _DWORD *a2)</span></span></span><span class="hljs-function"> </span></span>{ _DWORD *v2; <span class="hljs-comment"><span class="hljs-comment">// rbp@1 unsigned int v3; // er12@3 unsigned int result; // eax@3 unsigned int v5; // edx@3 unsigned int v6; // esi@3 unsigned int v7; // edx@4 v2 = a2; if ( i ) { if ( i == 1 ) { result = fibonacci(0, a2); v5 = result - ((result &gt;&gt; 1) &amp; 0x55555555); v6 = ((result - ((result &gt;&gt; 1) &amp; 0x55555555)) &gt;&gt; 2) &amp; 0x33333333; } else { v3 = fibonacci(i - 2, a2); result = v3 + fibonacci(i - 1, a2); v5 = result - ((result &gt;&gt; 1) &amp; 0x55555555); v6 = ((result - ((result &gt;&gt; 1) &amp; 0x55555555)) &gt;&gt; 2) &amp; 0x33333333; } v7 = v6 + (v5 &amp; 0x33333333) + ((v6 + (v5 &amp; 0x33333333)) &gt;&gt; 4); *v2 ^= ((BYTE1(v7) &amp; 0xF) + (v7 &amp; 0xF) + (unsigned __int8)((((v7 &gt;&gt; 8) &amp; 0xF0F0F) + (v7 &amp; 0xF0F0F0F)) &gt;&gt; 16)) &amp; 1; } else { *a2 ^= 1u; result = 1; } return result; }</span></span></code> </pre> </div></div><br><p> è¿™æ˜¯<em>main</em>å’Œ<em>fibonacci</em>å‡½æ•°çš„æ±‡ç¼–ä»£ç ï¼š </p><br><div class="spoiler">  <b class="spoiler_title">ä¸»è¦çš„</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">.text:0x4004E0 main proc near ; DATA XREF: start+1Do .text:0x4004E0 .text:0x4004E0 var_1C = dword ptr -1Ch .text:0x4004E0 .text:0x4004E0 push rbp .text:0x4004E1 push rbx .text:0x4004E2 xor esi, esi ; buf .text:0x4004E4 mov ebp, offset unk_4007E1 .text:0x4004E9 xor ebx, ebx .text:0x4004EB sub rsp, 18h .text:0x4004EF mov rdi, cs:stdout ; stream .text:0x4004F6 call _setbuf .text:0x4004FB mov edi, offset format ; "The flag is: " .text:0x400500 xor eax, eax .text:0x400502 call _printf .text:0x400507 mov r9d, 49h .text:0x40050D nop dword ptr [rax] .text:0x400510 .text:0x400510 loc_400510: ; CODE XREF: main+8Aj .text:0x400510 xor r8d, r8d .text:0x400513 jmp short loc_40051B .text:0x400513 ; --------------------------------------------------------------------------- .text:0x400515 align 8 .text:0x400518 .text:0x400518 loc_400518: ; CODE XREF: main+67j .text:0x400518 mov r9d, edi .text:0x40051B .text:0x40051B loc_40051B: ; CODE XREF: main+33j .text:0x40051B lea edi, [rbx+r8] .text:0x40051F lea rsi, [rsp+28h+var_1C] .text:0x400524 mov [rsp+28h+var_1C], 0 .text:0x40052C call fibonacci .text:0x400531 mov edi, [rsp+28h+var_1C] .text:0x400535 mov ecx, r8d .text:0x400538 add r8, 1 .text:0x40053C shl edi, cl .text:0x40053E mov eax, edi .text:0x400540 xor edi, r9d .text:0x400543 cmp r8, 8 .text:0x400547 jnz short loc_400518 .text:0x400549 add ebx, 8 .text:0x40054C cmp al, r9b .text:0x40054F mov rsi, cs:stdout ; fp .text:0x400556 jz short loc_400570 .text:0x400558 movsx edi, dil ; c .text:0x40055C add rbp, 1 .text:0x400560 call __IO_putc .text:0x400565 movzx r9d, byte ptr [rbp-1] .text:0x40056A jmp short loc_400510 .text:0x40056A ; --------------------------------------------------------------------------- .text:0x40056C align 10h .text:0x400570 .text:0x400570 loc_400570: ; CODE XREF: main+76j .text:0x400570 mov edi, 0Ah ; c .text:0x400575 call __IO_putc .text:0x40057A add rsp, 18h .text:0x40057E xor eax, eax .text:0x400580 pop rbx .text:0x400581 pop rbp .text:0x400582 retn .text:0x400582 main endp</code> </pre> </div></div><br><div class="spoiler">  <b class="spoiler_title">æ–æ³¢é‚£å¥‘</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">.text:0x400670 fibonacci proc near ; CODE XREF: main+4Cp .text:0x400670 ; fibonacci+19p ... .text:0x400670 test edi, edi .text:0x400672 push r12 .text:0x400674 push rbp .text:0x400675 mov rbp, rsi .text:0x400678 push rbx .text:0x400679 jz short loc_4006F8 .text:0x40067B cmp edi, 1 .text:0x40067E mov ebx, edi .text:0x400680 jz loc_400710 .text:0x400686 lea edi, [rdi-2] .text:0x400689 call fibonacci .text:0x40068E lea edi, [rbx-1] .text:0x400691 mov r12d, eax .text:0x400694 mov rsi, rbp .text:0x400697 call fibonacci .text:0x40069C add eax, r12d .text:0x40069F mov edx, eax .text:0x4006A1 mov ebx, eax .text:0x4006A3 shr edx, 1 .text:0x4006A5 and edx, 55555555h .text:0x4006AB sub ebx, edx .text:0x4006AD mov ecx, ebx .text:0x4006AF mov edx, ebx .text:0x4006B1 shr ecx, 2 .text:0x4006B4 and ecx, 33333333h .text:0x4006BA mov esi, ecx .text:0x4006BC .text:0x4006BC loc_4006BC: ; CODE XREF: fibonacci+C2j .text:0x4006BC and edx, 33333333h .text:0x4006C2 lea ecx, [rsi+rdx] .text:0x4006C5 mov edx, ecx .text:0x4006C7 shr edx, 4 .text:0x4006CA add edx, ecx .text:0x4006CC mov esi, edx .text:0x4006CE and edx, 0F0F0F0Fh .text:0x4006D4 shr esi, 8 .text:0x4006D7 and esi, 0F0F0Fh .text:0x4006DD lea ecx, [rsi+rdx] .text:0x4006E0 mov edx, ecx .text:0x4006E2 shr edx, 10h .text:0x4006E5 add edx, ecx .text:0x4006E7 and edx, 1 .text:0x4006EA xor [rbp+0], edx .text:0x4006ED pop rbx .text:0x4006EE pop rbp .text:0x4006EF pop r12 .text:0x4006F1 retn .text:0x4006F1 ; --------------------------------------------------------------------------- .text:0x4006F2 align 8 .text:0x4006F8 .text:0x4006F8 loc_4006F8: ; CODE XREF: fibonacci+9j .text:0x4006F8 mov edx, 1 .text:0x4006FD xor [rbp+0], edx .text:0x400700 mov eax, 1 .text:0x400705 pop rbx .text:0x400706 pop rbp .text:0x400707 pop r12 .text:0x400709 retn .text:0x400709 ; --------------------------------------------------------------------------- .text:0x40070A align 10h .text:0x400710 .text:0x400710 loc_400710: ; CODE XREF: fibonacci+10j .text:0x400710 xor edi, edi .text:0x400712 call fibonacci .text:0x400717 mov edx, eax .text:0x400719 mov edi, eax .text:0x40071B shr edx, 1 .text:0x40071D and edx, 55555555h .text:0x400723 sub edi, edx .text:0x400725 mov esi, edi .text:0x400727 mov edx, edi .text:0x400729 shr esi, 2 .text:0x40072C and esi, 33333333h .text:0x400732 jmp short loc_4006BC .text:0x400732 fibonacci endp</code> </pre> </div></div><br><p> åœ¨è¿™ä¸ªé˜¶æ®µï¼Œæˆ‘ä»¬æœ‰å¾ˆå¤šæœºä¼šæ¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚ ä¾‹å¦‚ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ä¸€ç§ç¼–ç¨‹è¯­è¨€æ¥è¿˜åŸä»£ç å¹¶åœ¨é‚£é‡Œè¿›è¡Œä¼˜åŒ–ï¼Œä½†æ˜¯æ¢å¤ä»£ç çš„è¿‡ç¨‹æ˜¯éå¸¸å›°éš¾çš„ä»»åŠ¡ï¼Œåœ¨æ­¤æœŸé—´æˆ‘ä»¬å¯èƒ½ä¼šçŠ¯é”™è¯¯ã€‚ å¥½å§ï¼Œç„¶åæ¯”è¾ƒä»£ç ä»¥å‘ç°é”™è¯¯é€šå¸¸æ˜¯æ¯«æ— ä»·å€¼çš„ã€‚ ä½†æ˜¯ï¼Œå¦‚æœä½¿ç”¨Unicorn Engineï¼Œåˆ™å¯ä»¥è·³è¿‡ä»£ç é‡å»ºçš„é˜¶æ®µï¼Œä»è€Œé¿å…äº†ä¸Šè¿°é—®é¢˜ã€‚ å½“ç„¶ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨fridaæˆ–ä¸ºgdbç¼–å†™è„šæœ¬æ¥é¿å…è¿™äº›éº»çƒ¦ï¼Œä½†è¿™å¹¶éå¦‚æ­¤ã€‚ </p><br><p> åœ¨å¼€å§‹ä¼˜åŒ–ä¹‹å‰ï¼Œæˆ‘ä»¬å°†åœ¨Unicorn Engineä¸­è¿è¡Œä»¿çœŸè€Œä¸æ›´æ”¹ç¨‹åºã€‚ åªæœ‰æˆåŠŸå¯åŠ¨åï¼Œæˆ‘ä»¬æ‰èƒ½ç»§ç»­è¿›è¡Œä¼˜åŒ–ã€‚ </p><br><h2 id="shag-1-da-priydet-virtualizaciya"> æ­¥éª¤1ï¼šè®©è™šæ‹ŸåŒ–æ¥ </h2><br><p> è®©æˆ‘ä»¬åˆ›å»ºfibonacci.pyæ–‡ä»¶å¹¶å°†å…¶ä¿å­˜åœ¨äºŒè¿›åˆ¶æ–‡ä»¶æ—è¾¹ã€‚ </p><br><p> è®©æˆ‘ä»¬ä»å¯¼å…¥æ‰€éœ€çš„åº“å¼€å§‹ï¼š </p><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> unicorn <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> unicorn.x86_const <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> struct</code> </pre> <br><p> ç¬¬ä¸€è¡ŒåŠ è½½ä¸»è¦çš„äºŒè¿›åˆ¶å’ŒåŸºæœ¬Unicornå¸¸æ•°ã€‚ ç¬¬äºŒè¡ŒåŠ è½½ä¸¤ä¸ªx86å’Œx86_64ä½“ç³»ç»“æ„çš„å¸¸é‡ã€‚ </p><br><p> æ¥ä¸‹æ¥ï¼Œæ·»åŠ ä¸€äº›å¿…è¦çš„åŠŸèƒ½ï¼š </p><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">read</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(name)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> open(name) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> f: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> f.read() <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">u32</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(data)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> struct.unpack(<span class="hljs-string"><span class="hljs-string">"I"</span></span>, data)[<span class="hljs-number"><span class="hljs-number">0</span></span>] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">p32</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(num)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> struct.pack(<span class="hljs-string"><span class="hljs-string">"I"</span></span>, num)</code> </pre> <br><p> åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬å®£å¸ƒäº†ä»¥åå°†éœ€è¦çš„åŠŸèƒ½ï¼š </p><br><ul><li>  <strong>read</strong>åªæ˜¯è¿”å›æ–‡ä»¶çš„å†…å®¹ï¼Œ </li><li>  <strong>u32</strong>é‡‡ç”¨LEç¼–ç çš„4å­—èŠ‚å­—ç¬¦ä¸²å¹¶å°†å…¶è½¬æ¢ä¸ºintï¼Œ </li><li>  <strong>p32</strong>åšç›¸åçš„äº‹æƒ…-å®ƒæ¥å—ä¸€ä¸ªæ•°å­—å¹¶å°†å…¶è½¬æ¢ä¸ºLEç¼–ç çš„4å­—èŠ‚å­—ç¬¦ä¸²ã€‚ </li></ul><br><p> æ³¨æ„ï¼šå¦‚æœå·²å®‰è£…<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">pwntools</a> ï¼Œåˆ™æ— éœ€åˆ›å»ºè¿™äº›åŠŸèƒ½ï¼Œåªéœ€å¯¼å…¥å®ƒä»¬ï¼š </p><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> pwn <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> *</code> </pre> <br><p> å› æ­¤ï¼Œæœ€åï¼Œè®©æˆ‘ä»¬å¼€å§‹ä¸ºx86_64ä½“ç³»ç»“æ„åˆå§‹åŒ–Unicorn Engineç±»ï¼š </p><br><pre> <code class="python hljs">mu = Uc (UC_ARCH_X86, UC_MODE_64)</code> </pre> <br><p> åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬ä½¿ç”¨ä»¥ä¸‹å‚æ•°è°ƒç”¨<strong>Uc</strong>å‡½æ•°ï¼š </p><br><ul><li> ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ä¸»è¦æ¶æ„ã€‚ å¸¸é‡ä»¥<strong>UC_ARCH_å¼€å¤´</strong> ï¼› </li><li> ç¬¬äºŒä¸ªå‚æ•°æ˜¯ä½“ç³»ç»“æ„çš„è§„èŒƒã€‚ å¸¸é‡ä»¥<strong>UC_MODE_å¼€å¤´</strong> ã€‚ </li></ul><br><p> æ‚¨å¯ä»¥åœ¨<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">å¤‡å¿˜å•ä¸­</a>æ‰¾åˆ°æ‰€æœ‰å¸¸é‡ã€‚ </p><br><p> å¦‚æˆ‘ä¸Šé¢æ‰€å†™ï¼Œè¦ä½¿ç”¨Unicorn Engineï¼Œæˆ‘ä»¬éœ€è¦æ‰‹åŠ¨åˆå§‹åŒ–è™šæ‹Ÿå†…å­˜ã€‚ å¯¹äºæ­¤ç¤ºä¾‹ï¼Œæˆ‘ä»¬éœ€è¦å°†ä»£ç å’Œå †æ ˆæ”¾åœ¨å†…å­˜ä¸­çš„æŸä¸ªä½ç½®ã€‚ </p><br><p> äºŒè¿›åˆ¶æ–‡ä»¶çš„åŸºå€ï¼ˆBase addrï¼‰ä»0x400000å¼€å§‹ã€‚ è®©æˆ‘ä»¬å°†å †æ ˆæ”¾åœ¨0x0å¹¶ä¸ºå…¶åˆ†é…1024 * 1024å†…å­˜ã€‚ æœ€æœ‰å¯èƒ½çš„æ˜¯ï¼Œæˆ‘ä»¬ä¸éœ€è¦é‚£ä¹ˆå¤šçš„ç©ºé—´ï¼Œä½†æ˜¯ä»ç„¶æ²¡æœ‰ä¼¤å®³ã€‚ </p><br><p> æˆ‘ä»¬å¯ä»¥é€šè¿‡è°ƒç”¨<strong>mem_map</strong>æ–¹æ³•æ¥æ ‡è®°å†…å­˜ã€‚ </p><br><p> æ·»åŠ è¿™äº›è¡Œï¼š </p><br><pre> <code class="python hljs">BASE = <span class="hljs-number"><span class="hljs-number">0x400000</span></span> STACK_ADDR = <span class="hljs-number"><span class="hljs-number">0x0</span></span> STACK_SIZE = <span class="hljs-number"><span class="hljs-number">1024</span></span>*<span class="hljs-number"><span class="hljs-number">1024</span></span> mu.mem_map(BASE, <span class="hljs-number"><span class="hljs-number">1024</span></span>*<span class="hljs-number"><span class="hljs-number">1024</span></span>) mu.mem_map(STACK_ADDR, STACK_SIZE)</code> </pre> <br><p> ç°åœ¨ï¼Œæˆ‘ä»¬éœ€è¦ä»¥ä¸å¼•å¯¼åŠ è½½ç¨‹åºç›¸åŒçš„æ–¹å¼å°†äºŒè¿›åˆ¶æ–‡ä»¶åŠ è½½åˆ°å…¶ä¸»åœ°å€ä¸­ã€‚ ä¹‹åï¼Œæˆ‘ä»¬éœ€è¦å°†<strong>RSP</strong>è®¾ç½®åˆ°å †æ ˆçš„æœ«å°¾ã€‚ </p><br><pre> <code class="python hljs">mu.mem_write(BASE, read(<span class="hljs-string"><span class="hljs-string">"./fibonacci"</span></span>)) mu.reg_write(UC_X86_REG_RSP, STACK_ADDR + STACK_SIZE - <span class="hljs-number"><span class="hljs-number">1</span></span>)</code> </pre> <br><p> ç°åœ¨æˆ‘ä»¬å¯ä»¥å¼€å§‹ä»¿çœŸå¹¶è¿è¡Œä»£ç ï¼Œä½†æ˜¯æˆ‘ä»¬éœ€è¦å¼„æ¸…æ¥šå¼€å§‹ä½¿ç”¨å“ªä¸ªåœ°å€ä»¥åŠä»¿çœŸå™¨ä½•æ—¶åœæ­¢ã€‚ </p><br><p> ä»<strong>mainï¼ˆï¼‰</strong>è·å–ç¬¬ä¸€ä¸ªå‘½ä»¤çš„åœ°å€ï¼Œæˆ‘ä»¬å¯ä»¥ä»0x004004e0å¼€å§‹ä»¿çœŸã€‚ æ˜¾ç¤ºæ•´ä¸ªæ ‡å¿—åï¼Œå°†è®¤ä¸ºç»“å°¾æ˜¯å¯¹ä½äº0x00400575çš„<strong>putcï¼ˆâ€œ \ nâ€ï¼‰</strong>çš„è°ƒç”¨ã€‚ </p><br><pre> <code class="plaintext hljs">.text:0x400570 mov edi, 0Ah ; c .text:0x400575 call __IO_putc</code> </pre> <br><p> æˆ‘ä»¬å¯ä»¥å¼€å§‹æ¨¡æ‹Ÿï¼š </p><br><pre> <code class="python hljs">mu.emu_start(<span class="hljs-number"><span class="hljs-number">0x004004e0</span></span>,<span class="hljs-number"><span class="hljs-number">0x00400575</span></span>)</code> </pre> <br><p> ç°åœ¨è¿è¡Œè„šæœ¬ï¼š </p><br><pre> <code class="bash hljs">a@x:~/Desktop/unicorn_engine_lessons$ python solve.py Traceback (most recent call last): File <span class="hljs-string"><span class="hljs-string">"solve.py"</span></span>, line 32, <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> &lt;module&gt; mu.emu_start(0x00000000004004E0, 0x0000000000400575) File <span class="hljs-string"><span class="hljs-string">"/usr/local/lib/python2.7/dist-packages/unicorn/unicorn.py"</span></span>, line 288, <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> emu_start raise UcError(status) unicorn.unicorn.UcError: Invalid memory <span class="hljs-built_in"><span class="hljs-built_in">read</span></span> (UC_ERR_READ_UNMAPPED)</code> </pre> <br><p> ç³Ÿç³•ï¼Œå‡ºäº†ç‚¹é—®é¢˜ï¼Œä½†æˆ‘ä»¬ä»€è‡³éƒ½ä¸çŸ¥é“ã€‚ åœ¨è°ƒç”¨<strong>mu.emu_start</strong>ä¹‹å‰<strong>ï¼Œ</strong>æˆ‘ä»¬å¯ä»¥æ·»åŠ ï¼š </p><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">hook_code</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(mu, address, size, user_data)</span></span></span><span class="hljs-function">:</span></span> print(<span class="hljs-string"><span class="hljs-string">'&gt;&gt;&gt; Tracing instruction at 0x%x, instruction size = 0x%x'</span></span> %(address, size)) mu.hook_add(UC_HOOK_CODE, hook_code)</code> </pre> <br><p> æ­¤ä»£ç æ·»åŠ äº†ä¸€ä¸ªé’©å­ã€‚ æˆ‘ä»¬å£°æ˜äº†è‡ªå·±çš„<strong>hook_code</strong>å‡½æ•°ï¼Œæ¨¡æ‹Ÿå™¨åœ¨æ¯ä¸ªå‘½ä»¤ä¹‹å‰è°ƒç”¨è¯¥å‡½æ•°ã€‚ å®ƒé‡‡ç”¨ä»¥ä¸‹å‚æ•°ï¼š </p><br><ul><li> æˆ‘ä»¬çš„<strong>Uc</strong>å‰¯æœ¬ï¼Œ </li><li> æŒ‡ä»¤åœ°å€ </li><li> å°ºå¯¸è¯´æ˜ </li><li> ç”¨æˆ·æ•°æ®ï¼ˆæˆ‘ä»¬å¯ä»¥å°†æ­¤å€¼ä¸å¯é€‰å‚æ•°ä¸€èµ·<strong>ä¼ é€’</strong>ç»™<strong>hook_addï¼ˆï¼‰</strong> ï¼‰ã€‚ <br> ç°åœ¨ï¼Œå¦‚æœæˆ‘ä»¬è¿è¡Œè„šæœ¬ï¼Œæˆ‘ä»¬åº”è¯¥çœ‹åˆ°ä»¥ä¸‹è¾“å‡ºï¼š <br><pre> <code class="bash hljs">a@x:~/Desktop/unicorn_engine_lessons$ python solve.py &gt;&gt;&gt; Tracing instruction at 0x4004e0, instruction size = 0x1 &gt;&gt;&gt; Tracing instruction at 0x4004e1, instruction size = 0x1 &gt;&gt;&gt; Tracing instruction at 0x4004e2, instruction size = 0x2 &gt;&gt;&gt; Tracing instruction at 0x4004e4, instruction size = 0x5 &gt;&gt;&gt; Tracing instruction at 0x4004e9, instruction size = 0x2 &gt;&gt;&gt; Tracing instruction at 0x4004eb, instruction size = 0x4 &gt;&gt;&gt; Tracing instruction at 0x4004ef, instruction size = 0x7 Traceback (most recent call last): File <span class="hljs-string"><span class="hljs-string">"solve.py"</span></span>, line 41, <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> &lt;module&gt; mu.emu_start(0x00000000004004E0, 0x0000000000400575) File <span class="hljs-string"><span class="hljs-string">"/usr/local/lib/python2.7/dist-packages/unicorn/unicorn.py"</span></span>, line 288, <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> emu_start raise UcError(status) unicorn.unicorn.UcError: Invalid memory <span class="hljs-built_in"><span class="hljs-built_in">read</span></span> (UC_ERR_READ_UNMAPPED)</code> </pre> <br><p> åœ¨å‘ç”Ÿé”™è¯¯çš„åœ°å€ï¼Œæˆ‘ä»¬å¯ä»¥ç†è§£æˆ‘ä»¬çš„è„šæœ¬æ— æ³•å¤„ç†æ­¤å‘½ä»¤ï¼š <br></p><pre> <code class="plaintext hljs">.text:0x4004EF mov rdi, cs:stdout ; stream</code> </pre> <br><p> è¯¥æŒ‡ä»¤ä»åœ°å€0x601038ä¸­è¯»å–æ•°æ®ï¼ˆæ‚¨å¯ä»¥åœ¨IDA Proä¸­çœ‹åˆ°å®ƒï¼‰ã€‚ è¿™æ˜¯æˆ‘ä»¬æœªæ ‡è®°çš„<strong>.bss</strong>éƒ¨åˆ†ã€‚ å¦‚æœä¸å½±å“ç¨‹åºé€»è¾‘ï¼Œæˆ‘çš„è§£å†³æ–¹æ¡ˆå°±æ˜¯ç®€å•åœ°è·³è¿‡æ‰€æœ‰æœ‰é—®é¢˜çš„æŒ‡ä»¤ã€‚ <br> ä»¥ä¸‹æ˜¯å¦ä¸€ä¸ªæœ‰é—®é¢˜çš„è¯´æ˜ï¼š <br></p><pre> <code class="plaintext hljs">.text:0x4004F6 call _setbuf</code> </pre> <br><p> æˆ‘ä»¬æ— æ³•ä½¿ç”¨glibcè°ƒç”¨ä»»ä½•å‡½æ•°ï¼Œå› ä¸ºæˆ‘ä»¬æ²¡æœ‰åœ¨å†…å­˜ä¸­åŠ è½½glibcã€‚ æ— è®ºå¦‚ä½•ï¼Œæˆ‘ä»¬ä¸éœ€è¦æ­¤å‘½ä»¤ï¼Œå› æ­¤æˆ‘ä»¬ä¹Ÿå¯ä»¥è·³è¿‡å®ƒã€‚ <br> è¿™æ˜¯è¦è·³è¿‡çš„å‘½ä»¤çš„å®Œæ•´åˆ—è¡¨ï¼š <br></p><pre> <code class="plaintext hljs">.text:0x4004EF mov rdi, cs:stdout ; stream .text:0x4004F6 call _setbuf .text:0x400502 call _printf .text:0x40054F mov rsi, cs:stdout ; fp</code> </pre> <br><p> è¦è·³è¿‡å‘½ä»¤ï¼Œæˆ‘ä»¬éœ€è¦ä½¿ç”¨ä»¥ä¸‹æŒ‡ä»¤é‡å†™<strong>RIP</strong> ï¼š <br></p><pre> <code class="python hljs">mu.reg_write(UC_X86_REG_RIP, address+size)</code> </pre> <br><p> ç°åœ¨<strong>hook_code</strong>åº”è¯¥çœ‹èµ·æ¥åƒè¿™æ ·ï¼š </p><br><p></p><br><pre> <code class="python hljs">instructions_skip_list = [<span class="hljs-number"><span class="hljs-number">0x004004ef</span></span>,<span class="hljs-number"><span class="hljs-number">0x004004f6</span></span>,<span class="hljs-number"><span class="hljs-number">0x00400502</span></span>,<span class="hljs-number"><span class="hljs-number">0x0040054f</span></span>] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">hook_code</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(mu, address, size, user_data)</span></span></span><span class="hljs-function">:</span></span> print(<span class="hljs-string"><span class="hljs-string">'&gt;&gt;&gt; Tracing instruction at 0x%x, instruction size = 0x%x'</span></span> %(address, size)) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> address <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> instructions_skip_list: mu.reg_write(UC_X86_REG_RIP, address+size)</code> </pre> <br><p> æˆ‘ä»¬è¿˜éœ€è¦å¯¹åœ¨é€å­—èŠ‚æ§åˆ¶å°ä¸­æ˜¾ç¤ºæ ‡å¿—çš„æŒ‡ä»¤æ‰§è¡ŒæŸäº›æ“ä½œã€‚ </p><br><pre> <code class="plaintext hljs">.text:0x400558 movsx edi, dil ; c .text:0x40055C add rbp, 1 .text:0x400560 call __IO_putc</code> </pre> <br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">__IO_putc</a>å°†å­—èŠ‚è¾“å‡ºä½œä¸ºç¬¬<strong>ä¸€ä¸ªå‚æ•°</strong> ï¼ˆè¿™æ˜¯<strong>RDI</strong>å¯„å­˜å™¨ï¼‰ã€‚ </p><br><p> æˆ‘ä»¬å¯ä»¥ç›´æ¥ä»å¯„å­˜å™¨è¯»å–æ•°æ®ï¼Œå°†æ•°æ®è¾“å‡ºåˆ°æ§åˆ¶å°ï¼Œå¹¶è·³è¿‡è¿™ç»„æŒ‡ä»¤ã€‚ æ›´æ–°åçš„<strong>hook_code</strong>å¦‚ä¸‹æ‰€ç¤ºï¼š </p><br><pre> <code class="python hljs">instructions_skip_list = [<span class="hljs-number"><span class="hljs-number">0x004004ef</span></span>,<span class="hljs-number"><span class="hljs-number">0x004004f6</span></span>,<span class="hljs-number"><span class="hljs-number">0x00400502</span></span>,<span class="hljs-number"><span class="hljs-number">0x0040054f</span></span>] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">hook_code</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(mu, address, size, user_data)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-comment"><span class="hljs-comment">#print('&gt;&gt;&gt; Tracing instruction at 0x%x, instruction size = 0x%x' %(address, size)) if address in instructions_skip_list: mu.reg_write(UC_X86_REG_RIP, address+size) elif address == 0x400560: # c = mu.reg_read(UC_X86_REG_RDI) print(chr(c),end="") mu.reg_write(UC_X86_REG_RIP, address+size)</span></span></code> </pre> <br><p> æˆ‘ä»¬å¯ä»¥è¿è¡Œï¼Œå®ƒå°†å…¨éƒ¨è¿è¡Œï¼Œä½†æ˜¯ä»ç„¶å¾ˆæ…¢ã€‚ </p><br><h1 id="shag-2-uvelichim-skorost"> æ­¥éª¤2ï¼šæé«˜é€Ÿåº¦ï¼ </h1><br><p> è®©æˆ‘ä»¬è€ƒè™‘ä¸€ä¸‹æé«˜å·¥ä½œé€Ÿåº¦ã€‚ ä¸ºä»€ä¹ˆè¿™ä¸ªç¨‹åºè¿™ä¹ˆæ…¢ï¼Ÿ </p><br><p> å¦‚æœæŸ¥çœ‹åç¼–è¯‘çš„ä»£ç ï¼Œå°†ä¼šçœ‹åˆ°<strong>mainï¼ˆï¼‰</strong>å¤šæ¬¡è°ƒç”¨<strong>fibonacciï¼ˆï¼‰</strong> ï¼Œè€Œ<strong>fibonacciï¼ˆï¼‰</strong>æ˜¯ä¸€ä¸ªé€’å½’å‡½æ•°ã€‚ è®©æˆ‘ä»¬ä»”ç»†çœ‹ä¸€ä¸‹è¿™ä¸ªå‡½æ•°ï¼›å®ƒæ¥å—å¹¶è¿”å›ä¸¤ä¸ªå‚æ•°ã€‚ ç¬¬ä¸€ä¸ªè¿”å›å€¼é€šè¿‡<strong>RAX</strong>å¯„å­˜å™¨ä¼ é€’ï¼Œç¬¬äºŒä¸ªè¿”å›å€¼é€šè¿‡ç¬¬äºŒä¸ªå‚æ•°ä¼ é€’ç»™å‡½æ•°çš„é“¾æ¥è¿”å›ã€‚ å¦‚æœæˆ‘ä»¬æ›´æ·±å…¥åœ°ç ”ç©¶<strong>mainï¼ˆï¼‰</strong>å’Œ<strong>fibonacciï¼ˆï¼‰</strong>ä¹‹é—´çš„å…³ç³»ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°†çœ‹åˆ°ç¬¬äºŒä¸ªå‚æ•°ä»…é‡‡ç”¨ä¸¤ä¸ªå¯èƒ½çš„å€¼ï¼š0æˆ–1ã€‚å¦‚æœä»ç„¶çœ‹ä¸åˆ°ï¼Œè¯·è¿è¡Œ<strong>gdb</strong>å¹¶å°†æ–­ç‚¹æ”¾åœ¨å‡½æ•°çš„å¼€å¤´<strong>fibonacciï¼ˆï¼‰</strong> ã€‚ </p><br><p> ä¸ºäº†ä¼˜åŒ–ç®—æ³•çš„æ“ä½œï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">åŠ¨æ€ç¼–ç¨‹</a>æ¥è®°ä½è¾“å…¥å‚æ•°çš„è¿”å›å€¼ã€‚ è‡ªå·±æƒ³æƒ³ï¼Œç¬¬äºŒä¸ªå‚æ•°åªèƒ½é‡‡ç”¨ä¸¤ä¸ªå¯èƒ½çš„å€¼ï¼Œæ‰€ä»¥æˆ‘ä»¬è¦åšçš„å°±æ˜¯è®°ä½ <math> </math> $å†…è”$ 2 *æœ€å¤§\ _OF \ _FIRST \ _ARGUMENT $å†…è”$  è’¸ </p><br><div class="spoiler">  <b class="spoiler_title">å¯¹äºé‚£äº›ä¸äº†è§£çš„äºº</b> <div class="spoiler_text"><p>  <strong>fibonacci</strong>æ˜¯ä¸€ä¸ªé€’å½’å‡½æ•°ï¼Œå®ƒè®¡ç®—ä¸‹ä¸€ä¸ªå€¼ä½œä¸ºå‰ä¸¤ä¸ªå€¼çš„å’Œã€‚ åœ¨æ¯ä¸€æ­¥ä¸­ï¼Œå¥¹éƒ½ä¼šæ›´åŠ æ·±å…¥ã€‚ æ¯æ¬¡å¥¹é‡æ–°å¼€å§‹æ—¶ï¼Œéƒ½æŒ‰ç…§ä»¥å‰çš„æ–¹å¼è¿›è¡Œæ“ä½œï¼Œå†åŠ ä¸Šä¸€ç§æ–°çš„å«ä¹‰ã€‚ </p><br><p> ä¸€ä¸ªä¾‹å­ï¼š <br> å‡è®¾æ·±åº¦= 6ï¼Œåˆ™ï¼š <strong>1 1 2 3 5 8</strong> ã€‚ <br> ç°åœ¨æ·±åº¦= 8ï¼Œåˆ™ï¼š <strong>1 1 2 3 5 8</strong> 13 21ã€‚ </p><br><p> æˆ‘ä»¬å¯èƒ½åªè®°å¾—å‰6ä¸ªæˆå‘˜æ˜¯<strong>1 1 2 3 5 8</strong> ï¼Œå½“ä»–ä»¬è¦æ±‚æˆ‘ä»¬è®¡æ•°æ¯”æˆ‘ä»¬è®°ä½çš„æ›´å¤šæ—¶ï¼Œæˆ‘ä»¬ä¼šè®°ä½æˆ‘ä»¬æ‰€è®°çš„å†…å®¹ï¼Œåªè®¡ç®—ç¼ºå¤±çš„å†…å®¹ã€‚ </p></div></div><br><p> ä¸€æ—¦<strong>RIP</strong>ä½äº<strong>fibonacciï¼ˆï¼‰</strong>çš„å¼€å¤´ï¼Œæˆ‘ä»¬å°±å¯ä»¥è·å–å‡½æ•°å‚æ•°ã€‚ æˆ‘ä»¬çŸ¥é“ä¸€ä¸ªå‡½æ•°åœ¨é€€å‡ºå‡½æ•°æ—¶ä¼šè¿”å›ç»“æœã€‚ ç”±äºæˆ‘ä»¬ä¸èƒ½ä¸€æ¬¡ä½¿ç”¨ä¸¤ä¸ªå‚æ•°ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦ä¸€ä¸ªå †æ ˆæ¥è¿”å›å‚æ•°ã€‚ å½“è¾“å…¥<strong>fibonacciï¼ˆï¼‰æ—¶ï¼Œ</strong>æˆ‘ä»¬éœ€è¦å°†å‚æ•°æ”¾åœ¨å †æ ˆä¸Šï¼Œå¹¶åœ¨é€€å‡ºæ—¶å°†å…¶æå–ã€‚ è¦å­˜å‚¨è®¡æ•°å¯¹ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨å­—å…¸ã€‚ </p><br><p> å¦‚ä½•å¤„ç†ä¸€å¯¹å€¼ï¼Ÿ </p><br><ul><li> åœ¨å‡½æ•°çš„æœ€å¼€å§‹ï¼Œæˆ‘ä»¬å¯ä»¥æ£€æŸ¥è¯¥å¯¹æ˜¯å¦åœ¨æˆ‘ä»¬å·²ç»çŸ¥é“çš„ç»“æœä¸­ï¼š <br><ul><li> å¦‚æœæœ‰çš„è¯ï¼Œæˆ‘ä»¬å¯ä»¥é€€è¿˜è¿™å¯¹ã€‚ æˆ‘ä»¬åªéœ€è¦åœ¨<strong>RAX</strong>å’Œé“¾æ¥çš„åœ°å€ï¼ˆç¬¬äºŒä¸ªå‚æ•°ä¸­ï¼‰ä¸­ç¼–å†™è¿”å›å€¼ã€‚ æˆ‘ä»¬è¿˜åˆ†é…äº†ä¸€ä¸ª<strong>RIP</strong>åœ°å€ä»¥é€€å‡ºè¯¥åŠŸèƒ½ã€‚ æˆ‘ä»¬æ— æ³•åœ¨<strong>fibonacciï¼ˆï¼‰ä¸­</strong>ä½¿ç”¨<strong>RET</strong> ï¼Œå› ä¸ºè¿™äº›è°ƒç”¨å·²è¢«é’©ä½ï¼Œå› æ­¤æˆ‘ä»¬å°†ä»<strong>mainï¼ˆï¼‰ä¸­</strong>è·å–ä¸€äº›<strong>RET</strong> ï¼› </li><li> å¦‚æœè¿™äº›å€¼ä¸æ˜¯ï¼Œé‚£ä¹ˆæˆ‘ä»¬åªéœ€å°†å®ƒä»¬æ·»åŠ åˆ°å †æ ˆä¸­ã€‚ </li></ul></li><li> åœ¨é€€å‡ºå‡½æ•°ä¹‹å‰ï¼Œæˆ‘ä»¬å¯ä»¥ä¿å­˜è¿”å›çš„å¯¹ã€‚ æˆ‘ä»¬çŸ¥é“è¾“å…¥å‚æ•°ï¼Œå› ä¸ºæˆ‘ä»¬å¯ä»¥ä»å †æ ˆä¸­è¯»å–å®ƒä»¬ã€‚ </li></ul><br><div class="spoiler">  <b class="spoiler_title">æ­¤ä»£ç åœ¨æ­¤å¤„æ˜¾ç¤ºã€‚</b> <div class="spoiler_text"><pre> <code class="python hljs">FIBONACCI_ENTRY = <span class="hljs-number"><span class="hljs-number">0x00400670</span></span> FIBONACCI_END = [ <span class="hljs-number"><span class="hljs-number">0x004006f1</span></span>, <span class="hljs-number"><span class="hljs-number">0x00400709</span></span>] instructions_skip_list = [<span class="hljs-number"><span class="hljs-number">0x004004ef</span></span>,<span class="hljs-number"><span class="hljs-number">0x004004f6</span></span>,<span class="hljs-number"><span class="hljs-number">0x00400502</span></span>,<span class="hljs-number"><span class="hljs-number">0x0040054f</span></span>] <span class="hljs-comment"><span class="hljs-comment">#     stack = [] # ,       d = {} def hook_code(mu, address, size, user_data): if address in instructions_skip_list: mu.reg_write(UC_X86_REG_RIP, address+size) #      elif address == 0x400560: c = mu.reg_read(UC_X86_REG_RDI) print(chr(c),end="") mu.reg_write(UC_X86_REG_RIP, address+size) #     ? elif address == FIBONACCI_ENTRY: #     RDI arg0 = mu.reg_read(UC_X86_REG_RDI) #    () r_rsi = mu.reg_read(UC_X86_REG_RSI) #   ,    arg1 = u32(mu.mem_read(r_rsi, 4)) # ,    ? if (arg0,arg1) in d: (ret_rax, ret_ref) = d[(arg0,arg1)] #     RAX mu.reg_write(UC_X86_REG_RAX, ret_rax) #     mu.mem_write(r_rsi, p32(ret_ref)) #  RIP  RET ,       fibonacci mu.reg_write(UC_X86_REG_RIP, 0x400582) else: #      ,      stack.append((arg0,arg1,r_rsi)) elif address in FIBONACCI_END: #     (arg0, arg1, r_rsi) = stack.pop() #     RAX ret_rax = mu.reg_read(UC_X86_REG_RAX) #  ,      ret_ref = u32(mu.mem_read(r_rsi,4)) #      d[(arg0, arg1)]=(ret_rax, ret_ref)</span></span></code> </pre></div></div><br><div class="spoiler">  <b class="spoiler_title">è¿™æ˜¯æ•´ä¸ªè„šæœ¬</b> <div class="spoiler_text"><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment">#!/usr/bin/env python # -*- coding: utf-8 -*- from __future__ import print_function from unicorn import * from unicorn.x86_const import * import struct def read(name): with open(name) as f: return f.read() def u32(data): return struct.unpack("I", data)[0] def p32(num): return struct.pack("I", num) FIBONACCI_ENTRY = 0x00400670 FIBONACCI_END = [ 0x004006f1, 0x00400709] instructions_skip_list = [0x004004ef,0x004004f6,0x00400502,0x0040054f] #     stack = [] # ,       d = {} def hook_code(mu, address, size, user_data): if address in instructions_skip_list: mu.reg_write(UC_X86_REG_RIP, address+size) #      elif address == 0x400560: c = mu.reg_read(UC_X86_REG_RDI) print(chr(c),end="") mu.reg_write(UC_X86_REG_RIP, address+size) #     ? elif address == FIBONACCI_ENTRY: #     RDI arg0 = mu.reg_read(UC_X86_REG_RDI) #    () r_rsi = mu.reg_read(UC_X86_REG_RSI) #   ,    arg1 = u32(mu.mem_read(r_rsi, 4)) # ,    ? if (arg0,arg1) in d: (ret_rax, ret_ref) = d[(arg0,arg1)] #     RAX mu.reg_write(UC_X86_REG_RAX, ret_rax) #     mu.mem_write(r_rsi, p32(ret_ref)) #  RIP  RET .     fibonacci mu.reg_write(UC_X86_REG_RIP, 0x400582) else: #      ,      stack.append((arg0,arg1,r_rsi)) elif address in FIBONACCI_END: #     (arg0, arg1, r_rsi) = stack.pop() #     RAX ret_rax = mu.reg_read(UC_X86_REG_RAX) #  ,      ret_ref = u32(mu.mem_read(r_rsi,4)) #      d[(arg0, arg1)]=(ret_rax, ret_ref) mu = Uc (UC_ARCH_X86, UC_MODE_64) BASE = 0x400000 STACK_ADDR = 0x0 STACK_SIZE = 1024*1024 mu.mem_map(BASE, 1024*1024) mu.mem_map(STACK_ADDR, STACK_SIZE) mu.mem_write(BASE, read("./fibonacci")) mu.reg_write(UC_X86_REG_RSP, STACK_ADDR + STACK_SIZE - 1) mu.hook_add(UC_HOOK_CODE, hook_code) mu.emu_start(0x004004e0, 0x00400575) print()</span></span></code> </pre></div></div><br><p>  Hoorayï¼Œæˆ‘ä»¬ç»ˆäºèƒ½å¤Ÿä½¿ç”¨Unicorn Engineä¼˜åŒ–åº”ç”¨ç¨‹åºã€‚ å¹²å¾—å¥½ï¼ </p><br><h1 id="zametka"> ç¬”è®° </h1><br><p> ç°åœ¨æˆ‘å†³å®šç»™ä½ ä¸€ç‚¹åŠŸè¯¾ã€‚ <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">åœ¨è¿™é‡Œæ‚¨å¯ä»¥æ‰¾åˆ°å¦å¤–</a>ä¸‰ä¸ªä»»åŠ¡ï¼Œæ¯ä¸ªä»»åŠ¡éƒ½æœ‰æç¤ºå’Œå®Œæ•´çš„è§£å†³æ–¹æ¡ˆã€‚ è§£å†³é—®é¢˜æ—¶ï¼Œæ‚¨å¯ä»¥æŸ¥çœ‹<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">å¤‡å¿˜å•</a> ã€‚ </p><br><p> æœ€çƒ¦äººçš„é—®é¢˜ä¹‹ä¸€æ˜¯è®°ä½æ‰€éœ€å¸¸é‡çš„åç§°ã€‚ å¦‚æœåœ¨<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">IPythonä¸­</a>ä½¿ç”¨Tabæ’ä»¶ï¼Œè¿™å¾ˆå®¹æ˜“å¤„ç†ã€‚ å®‰è£…IPythonåï¼Œæ‚¨å¯ä»¥<strong>ä»unicorn import UC_ARCH_</strong>ç¼–å†™<strong>ï¼Œ</strong>æŒ‰Tabé”®ï¼Œå°†<strong>æ˜¾ç¤º</strong>ä»¥ç›¸åŒæ–¹å¼å¯åŠ¨çš„æ‰€æœ‰å¸¸é‡ã€‚ </p><p></p><p></p><p></p></li></ul></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN431058/">https://habr.com/ru/post/zh-CN431058/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN431044/index.html">æ£€å¯Ÿå®˜åŠå…¬å®¤å°†é¦–æ¬¡ä¸ºéæ³•é˜»æ­¢è¯¥ç½‘ç«™ä»˜æ¬¾</a></li>
<li><a href="../zh-CN431046/index.html">Z-indexå®é™…å¦‚ä½•å·¥ä½œ</a></li>
<li><a href="../zh-CN431048/index.html">äº‹ä»¶æœºå™¨å®ˆæŠ¤ç”Ÿå‘½å‘¨æœŸ</a></li>
<li><a href="../zh-CN431050/index.html">çº¯å‡€çš„å¹»è§‰ï¼šæ°´çš„çŸ¿åŒ–æ˜¯å¦ä¼šå½±å“å…¶è´¨é‡ï¼ŒTDSè®¡å°†å¦‚ä½•å¸®åŠ©æˆ‘ä»¬ï¼Ÿ</a></li>
<li><a href="../zh-CN431052/index.html">å‰ç«¯å¼€å‘æ—¥ï¼šåœ°å›¾ï¼Œå›¢é˜Ÿï¼Œä¸¤ä¸ªæŸ¥è¯¢</a></li>
<li><a href="../zh-CN431060/index.html">åœ¨å¾·å›½é€šè¿‡åœ¨çº¿èº«ä»½éªŒè¯å’Œéš¾æ°‘èèµ„è¿›è¡Œçš„å¾·å›½èº«ä»½è¯æ¬ºéª—</a></li>
<li><a href="../zh-CN431064/index.html">åˆšæ€§ç¨‹åºå‘˜å®£è¨€</a></li>
<li><a href="../zh-CN431066/index.html">DEFCON 16.æˆ‘æ€ä¹ˆèƒ½æŠ“ä½ä½ ï¼Ÿ è®©æˆ‘åˆ—å‡ºæ–¹æ³•ã€‚ ç¬¬äºŒéƒ¨åˆ†</a></li>
<li><a href="../zh-CN431068/index.html">æ•™è‚²çš„è‰ºæœ¯ï¼šè€è™æœºçš„æ€æƒ³</a></li>
<li><a href="../zh-CN431070/index.html">åŸåƒå— æˆ‘ä»¬æ­£åœ¨è°ˆè®ºç°ä»£ITä¸“å®¶çš„é¥®é£Ÿä¹ æƒ¯</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>