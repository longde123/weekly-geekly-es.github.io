<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üçê ‚¨ÜÔ∏è ‚ôÇÔ∏è Comment j'ai connect√© des ordinateurs et des utilisateurs aux ports de p√©riph√©riques r√©seau dans le programme de surveillance Network MACMonitor üí™ ü§õ üë©üèø‚Äçüåæ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Je suis d√©veloppeur du logiciel de surveillance r√©seau Network MACMonitor . 


 Au cours du d√©veloppement du programme, une t√¢che s'est impos√©e: d√©ter...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Comment j'ai connect√© des ordinateurs et des utilisateurs aux ports de p√©riph√©riques r√©seau dans le programme de surveillance Network MACMonitor</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/macmonitor/blog/416217/"><p>  Je suis d√©veloppeur du <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">logiciel de</a> surveillance r√©seau <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Network MACMonitor</a> . </p><br><p>  Au cours du d√©veloppement du programme, une t√¢che s'est impos√©e: d√©terminer quels ordinateurs les utilisateurs utilisent et associer ces informations aux ports des p√©riph√©riques r√©seau.  Dans cet article, je veux √©crire comment j'ai r√©ussi √† le faire. </p><br><p><img src="https://habrastorage.org/webt/ab/uf/qc/abufqc8euaofveu4dqt-htkaqrm.png" alt="image"></p><a name="habracut"></a><br><p>  J'ai commenc√© par des consid√©rations simples: pour associer un utilisateur √† un port sur un p√©riph√©rique r√©seau, vous devez d'abord connecter l'ordinateur avec lequel l'utilisateur travaille √† ce port.  √âtant donn√© que le programme Network MACMonitor vous permet de trouver des adresses mac sur les ports des p√©riph√©riques r√©seau, il a √©t√© d√©cid√© de connecter les ordinateurs aux ports √† l'aide des adresses mac.  Ensuite, vous devez connecter les utilisateurs aux ordinateurs.  Ces informations peuvent √™tre obtenues en interrogeant les ordinateurs de n'importe quelle mani√®re. </p><br><p>  J'ai vu deux options pour r√©soudre ce probl√®me: </p><br><ol><li>  √âcrivez un agent Windows et interrogez-le √† l'aide de Network MACMonitor; </li><li>  Utilisez Windows Management Instrumentation (WMI). </li></ol><br><p>  La version avec l'agent Windows pr√©sente un certain nombre d'inconv√©nients importants pour moi: </p><br><ul><li>  d√©veloppement d'un protocole s√©curis√© pour l'interaction r√©seau d'un agent Windows avec Network MACMonitor; </li><li>  la n√©cessit√© de pr√©installer l'agent sur les ordinateurs; </li><li>  en utilisant un langage de programmation diff√©rent (j'√©cris en Java), car je consid√®re que Java ne convient pas √† l'√©criture d'un agent: en raison de la consommation assez importante de m√©moire virtuelle et de la n√©cessit√© d'installer JRE sur tous les ordinateurs. </li></ul><br><p>  En raison de tous les inconv√©nients ci-dessus, j'ai d√©cid√© de m'attarder sur l'option utilisant WMI. </p><br><h3>  D√©veloppement client WMI </h3><br><p>  √âtant donn√© que Network MACMonitor est √©crit en Java, j'ai essay√© de trouver une biblioth√®que Java multiplateforme pr√™te √† l'emploi qui impl√©mente les fonctionnalit√©s du client WMI.  Et puis j'ai √©t√© d√©√ßu - il n'y a pas une telle biblioth√®que.  Toutes les biblioth√®ques existantes sont soit des wrappers sur les utilitaires Windows, soit (biblioth√®que j-Interop) n√©cessitent une manipulation de registre suppl√©mentaire (changement de propri√©taire et d'autorisations sur les branches de registre) pour activer WMI via un registre distant.  Puisqu'il n'y avait pas de biblioth√®que enti√®rement fonctionnelle pour Java, j'ai d√©cid√© de trouver une biblioth√®que ou un client WMI √©crit dans n'importe quel autre langage de programmation.  Et trouv√© un client WMI pour Linux.  Apr√®s avoir t√©l√©charg√© et v√©rifi√© son travail, j'ai r√©alis√© qu'il √©tait possible d'interroger des ordinateurs Windows sous Linux. </p><br><p>  Si cela est possible, j'ai d√©cid√© d'√©crire ma biblioth√®que en Java pur, ce qui me permettrait d'interroger l'ordinateur √† l'aide de WMI. </p><br><p>  Pour √©crire la biblioth√®que, une documentation claire sur le fonctionnement du protocole WMI √©tait n√©cessaire.  Il s'est av√©r√© qu'il existe une telle documentation et qu'elle est du domaine public. </p><br><p>  J'ai commenc√© √† pr√©parer l'√©criture de la biblioth√®que en regardant la pile r√©seau du protocole WMI. </p><br><table><tbody><tr><th>  Protocole </th><th>  Sp√©cifications techniques </th></tr><tr><td>  Instrumentation de gestion Windows (WMI) </td><td>  MS-WMI, MS-WMIO </td></tr><tr><td>  Mod√®le d'objet de composant distribu√© (DCOM) </td><td>  MS-DCOM </td></tr><tr><td>  Appel de proc√©dure √† distance (RPC) </td><td>  MS-RPCE </td></tr><tr><td>  Protocole de contr√¥le de transmission (TCP) </td><td>  - </td></tr><tr><td>  Protocole Internet (IP) </td><td>  - </td></tr></tbody></table><br><p>  Pour que WMI fonctionne correctement, tous les niveaux de pile doivent √™tre impl√©ment√©s. </p><br><p>  √âtant donn√© que WMI n'est pas impl√©ment√© en Java, je suis pass√© au protocole suivant dans la pile - DCOM.  Et ici, j'ai eu de la chance.  Bien que la biblioth√®que j-Interop susmentionn√©e n'impl√©mente pas la fonctionnalit√© WMI, la fonctionnalit√© DCOM y est impl√©ment√©e.  Il reste donc √† √©crire une impl√©mentation du protocole WMI, c'est-√†-dire √† √©crire une impl√©mentation des sp√©cifications MS-WMI et MS-WMIO. </p><br><p>  J'ai commenc√© par impl√©menter la sp√©cification MS-WMIO, qui est responsable du format d'encodage des donn√©es dans les paquets r√©seau du protocole WMI.  De la sp√©cification, j'ai appris que lors du codage des donn√©es, la sp√©cification de syntaxe √©tendue Backus-Naur (ABNF, RFC 5234) est utilis√©e.  La sp√©cification MS-WMIO d√©crit enti√®rement le format de codage utilisant ABNF.  Il est connu que s'il existe une grammaire d√©crite dans ABNF, il est possible de cr√©er un analyseur syntaxique pour cette grammaire.  Sur Internet, j'ai trouv√© un g√©n√©rateur d'analyseur ABNF pour Java et l'ai entr√© avec une grammaire tir√©e de la sp√©cification.  √âtant donn√© que l'analyseur g√©n√©r√© fonctionnait avec des cha√Ænes et que MS-WMIO d√©crit un format de codage binaire, l'id√©e √©tait de simplement remplacer l'analyseur g√©n√©r√© par des cha√Ænes par des tableaux et des caract√®res par des octets.  Mais apr√®s avoir regard√© le nombre de fichiers o√π un remplacement √©tait n√©cessaire, et ayant √©galement appris de la sp√©cification MS-WMIO qu'il serait parfois n√©cessaire de travailler avec des bits, j'ai r√©alis√© qu'il serait tr√®s difficile de corriger l'analyseur g√©n√©r√©, et j'ai d√©cid√© d'abandonner cette id√©e.  Je pensais que l'√©criture d'un analyseur √† partir de z√©ro serait plus rapide.  Et maintenant, l'analyseur √©tait pr√™t. </p><br><p>  Mais comment v√©rifier que l'analyseur est correctement √©crit si la sp√©cification MS-WMI, qui est responsable du fonctionnement du protocole WMI, n'est pas encore impl√©ment√©e?  Puis Wireshark, un analyseur de trafic r√©seau, m'a aid√©.  Apr√®s avoir effectu√© des requ√™tes WMI √† l'aide d'outils Windows standard (wbemtest), ayant pr√©c√©demment d√©sactiv√© le cryptage, j'ai re√ßu des paquets r√©seau et les ai enregistr√©s dans des fichiers binaires.  Il √©tait d√©j√† possible d'utiliser ces fichiers comme donn√©es de test pour l'analyseur. </p><br><p>  Lorsque l'analyseur a √©t√© test√© et que les erreurs trouv√©es ont √©t√© corrig√©es, j'ai proc√©d√© √† l'impl√©mentation de la sp√©cification MS-WMI, qui d√©crit le fonctionnement du protocole WMI. </p><br><p>  La sp√©cification MS-WMI est divis√©e en serveur et client.  J'ai partiellement impl√©ment√© la partie client, dans la mesure n√©cessaire pour interroger un ordinateur via WMI.  Dans cette partie, j'avais √©galement besoin de Wireshark, mais d√©j√† pour analyser la s√©quence des paquets r√©seau lors de l'interrogation WMI. </p><br><h3 id="popytka-polucheniya-neobhodimyh-dannyh-s-pomoschyu-wmi">  Essayer d'obtenir les donn√©es n√©cessaires √† l'aide de WMI </h3><br><p>  Apr√®s avoir √©crit la biblioth√®que WMI, la t√¢che de l'utiliser dans le programme Network MACMonitor est devenue.  La question s'est pos√©e: quelles donn√©es devraient √™tre obtenues √† partir des ordinateurs?  Je pensais avoir besoin d'obtenir le nom de l'ordinateur, le domaine, le syst√®me d'exploitation, l'heure de mise en marche, les adresses mac, les adresses ip, les utilisateurs actifs qui travaillent sur l'ordinateur. </p><br><p>  Mais un probl√®me tr√®s important s'est pos√©: comment identifier de mani√®re unique un ordinateur lors de l'interrogation WMI?  J'ai consid√©r√© les options suivantes: </p><br><ul><li>  adresse mac, modification possible, non unique possible; </li><li>  nom et domaine de l'ordinateur (groupe de travail), modification possible, non unique (pour le groupe de travail); </li><li>  le num√©ro de s√©rie du disque dur sur lequel le syst√®me d'exploitation est install√©, les droits d'administrateur sont requis lors de l'interrogation WMI, je n'ai pas v√©rifi√© l'unicit√©, mais je soup√ßonne qu'une non unique est possible; </li><li>  le num√©ro de s√©rie de la carte m√®re, non unique est possible, et assez souvent; </li><li>  l'identifiant du syst√®me informatique (propri√©t√© <em>UUID</em> WMI de la classe <em>Win32_ComputerSystemProduct</em> ), la non-unicit√© est possible, et assez souvent; </li><li>  Le temps d'installation du syst√®me d'exploitation est le meilleur de toutes les options, mais le caract√®re unique est possible lors du clonage du syst√®me ou lors du d√©ploiement √† partir d'une image. </li></ul><br><p>  Aucune option ne vous permet d'identifier de mani√®re unique l'ordinateur, j'ai donc d√©cid√© d'identifier l'ordinateur de trois mani√®res: </p><br><ul><li>  num√©ro de s√©rie de la carte m√®re, </li><li>  identifiant du syst√®me informatique </li><li>  temps d'installation du syst√®me d'exploitation. </li></ul><br><p>  Bien s√ªr, ces trois param√®tres peuvent co√Øncider sur diff√©rents ordinateurs, mais moins fr√©quemment que l'un d'eux. </p><br><p>  Une tentative a √©galement √©t√© effectu√©e pour obtenir des utilisateurs actifs √† l'aide de la classe WMI standard: <em>Win32_LogonSession</em> .  Puis le premier probl√®me est apparu: il s'est av√©r√© que <em>Win32_LogonSession</em> affiche toutes les sessions utilisateur, m√™me celles qui sont d√©j√† termin√©es.  J'ai commenc√© √† penser comment filtrer les sessions actives de celles qui se terminaient.  Trouv√© que cela peut √™tre fait √† l'aide de la classe <em>Win32_SessionProcess</em> , qui associe des instances des classes <em>Win32_LogonSession</em> √† <em>Win32_Process</em> .  Si le lien vers la session est pr√©sent dans la liste des instances de la classe <em>Win32_SessionProcess</em> (il existe au moins un processus avec l'identifiant de cette session), alors il est actif.  Ensuite, la question s'est pos√©e de savoir comment associer une session √† un utilisateur.  Cela peut √™tre fait √† l'aide de la classe <em>Win32_LoggedOnUser</em> , qui lie les instances des <em>classes</em> <em>Win32_LogonSession</em> et <em>Win32_UserAccount</em> .  Il ne reste plus qu'√† obtenir des instances de la classe <em>Win32_UserAccount</em> qui fournissent des informations d√©taill√©es sur l'utilisateur. </p><br><p><img src="https://habrastorage.org/webt/gq/0x/vg/gq0xvgaauo2dtpkmzajpife-x5g.png" alt="image"></p><br><p>  Mais ici, j'ai √©t√© d√©√ßu.  Lorsque vous utilisez WMI √† distance, il s'est av√©r√© qu'en essayant d'obtenir des instances de la classe <em>Win32_UserAccount</em> , il est possible d'obtenir uniquement des utilisateurs d'ordinateurs locaux.  Autrement dit, il s'est av√©r√© qu'en utilisant des outils WMI standard, il est impossible de savoir quels utilisateurs sont actifs sur l'ordinateur. </p><br><h3 id="razrabotka-wmi-provaydera">  D√©veloppement d'un fournisseur WMI. </h3><br><p>  En raison de l'impossibilit√© d'identifier sans ambigu√Øt√© les ordinateurs et de l'impossibilit√© d'obtenir des informations sur les utilisateurs actifs √† l'aide des classes WMI standard, il a √©t√© d√©cid√© d'√©tendre les fonctionnalit√©s de WMI.  Vous pouvez le faire en d√©crivant vos classes WMI dans un fichier MOF et en √©crivant un fournisseur WMI pour obtenir des instances de ces classes. </p><br><p>  Deux nouvelles classes WMI ont √©t√© d√©crites: <em>NMBY_InstallInfo</em> - pour identifier un ordinateur et <em>NMBY_LogonSession</em> - pour identifier les utilisateurs actifs d'un ordinateur. </p><br><p><img src="https://habrastorage.org/webt/5b/op/gi/5bopgiwlndpdgqpb7h2zdhqbyxg.png" alt="image"></p><br><p>  Ensuite, un fournisseur WMI a √©t√© √©crit avec lequel vous pouvez obtenir des instances de ces classes. </p><br><p>  Des exigences suppl√©mentaires ont √©t√© fix√©es pour le fournisseur: </p><br><ul><li>  travailler sur un syst√®me sans .NET; </li><li>  travailler sur le syst√®me d'exploitation Windows XP et sup√©rieur; </li><li>  la possibilit√© d'obtenir des informations √† l'aide d'un compte non administratif. </li></ul><br><p>  Par cons√©quent, le fournisseur a √©t√© √©crit en C ++ √† l'aide de WinApi. </p><br><p>  Lors de la r√©daction du fournisseur, des difficult√©s sont survenues en raison de la petite quantit√© et de la qualit√© de la documentation sur ce sujet, mais malgr√© cela, le fournisseur a √©t√© r√©dig√© avec succ√®s. </p><br><p>  Un fournisseur √©crit est disponible sur la page de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">t√©l√©chargement</a> .  Il peut √™tre install√© et utilis√© gratuitement. </p><br><h3 id="itog">  R√©sum√© </h3><br><p>  En cons√©quence, en utilisant le programme Network MACMonitor, il est devenu possible: </p><br><ul><li>  Associer des utilisateurs √† des ordinateurs </li></ul><br><p><img src="https://habrastorage.org/webt/u7/zn/op/u7znop78jhskuqgge9w7axw1i5g.png" alt="image"></p><br><ul><li>  Associer des ordinateurs √† des ports sur des p√©riph√©riques r√©seau </li></ul><br><p><img src="https://habrastorage.org/webt/ri/53/zq/ri53zqdcphgvs9q5xnyqtc2wdjs.png" alt="image"></p><br><ul><li>  Associer des ports de p√©riph√©rique r√©seau aux ordinateurs et aux utilisateurs </li></ul><br><p><img src="https://habrastorage.org/webt/_0/t-/ks/_0t-kseg8qqmzmxobo4z138hb54.png" alt="image"></p><br><ul><li>  Afficher l'historique d'enregistrement des utilisateurs sur les ordinateurs. </li></ul><br><p><img src="https://habrastorage.org/webt/wp/u0/aa/wpu0aat6iwqqappksaq_vem9-yw.png" alt="image"></p><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Site Web du programme</a> </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr416217/">https://habr.com/ru/post/fr416217/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr416207/index.html">"Pas pire qu'√† Poudlard" - les futurs √©tudiants parlent d'informatique</a></li>
<li><a href="../fr416209/index.html">DeepMind Can't Stop: l'IA peut jouer √† Quake III Arena maintenant</a></li>
<li><a href="../fr416211/index.html">Neurones en 5 minutes</a></li>
<li><a href="../fr416213/index.html">Webinaire ouvert "Injection de d√©pendance angulaire"</a></li>
<li><a href="../fr416215/index.html">Food Design Digest juin 2018</a></li>
<li><a href="../fr416219/index.html">Yandex a commenc√© √† indexer Google Docs avec des mots de passe</a></li>
<li><a href="../fr416229/index.html">10 livres sur le marketing et des sujets connexes qu'un designer devrait lire</a></li>
<li><a href="../fr416231/index.html">Surveillance des salles Zadarma Zabbix</a></li>
<li><a href="../fr416235/index.html">Cr√©ation de composants personnalis√©s pour Bootstrap 4</a></li>
<li><a href="../fr416237/index.html">Devenir designer: du freelance d'une auberge √† la collaboration avec les meilleures entreprises et le lancement de votre produit</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>