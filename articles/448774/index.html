<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üëÖ üí† üëó SQL a CSV usando DBMS_SQL üë©üèø‚Äçü§ù‚Äçüë®üèª ü§µ üé™</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="A menudo, al resolver problemas de integraci√≥n de sistemas, es necesario presentar una cierta cantidad de datos en un formato u otro. Al mismo tiempo,...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>SQL a CSV usando DBMS_SQL</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/448774/">  A menudo, al resolver problemas de integraci√≥n de sistemas, es necesario presentar una cierta cantidad de datos en un formato u otro.  Al mismo tiempo, cualquiera puede ser un consumidor de datos, pero la fuente es casi siempre una base de datos corporativa.  Por ejemplo, un fabricante puede exigir al proveedor que informe peri√≥dicamente sobre el movimiento de sus productos en formato XLSX o XML, etc. <br><br>  Existen muchas herramientas para convertir datos en varios formatos, y la posibilidad de su uso depende de la pila tecnol√≥gica adoptada en la empresa y la arquitectura del software.  Al mismo tiempo, siempre desea que la cadena que consta de varias bibliotecas, marcos y capas del sistema utilizadas para convertir los datos de origen sea lo m√°s breve posible.  Esto reducir√≠a el tiempo dedicado al desarrollo de la soluci√≥n y aumentar√≠a su eficiencia productiva. <br><br>  Si asumimos que, de hecho, la consulta SQL est√° en la ra√≠z del proceso de selecci√≥n de datos, entonces idealmente la cadena de transformaciones ser√≠a deseable para ver esto: <br><p></p><p><math></math><span class="MathJax_Preview" style="color: inherit; display: none;"></span><div class="MathJax_SVG_Display" style="text-align: center;"><span class="MathJax_SVG" id="MathJax-Element-1-Frame" tabindex="0" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot; display=&quot;block&quot;><msup><mi>d</mi><mo>&amp;#x2032;</mo></msup><mo>=</mo><mi>f</mi><mo stretchy=&quot;false&quot;>(</mo><mi>S</mi><mi>Q</mi><mi>L</mi><mo stretchy=&quot;false&quot;>(</mo><mi>d</mi><mo stretchy=&quot;false&quot;>)</mo><mo stretchy=&quot;false&quot;>)</mo></math>" role="presentation" style="font-size: 100%; display: inline-block; position: relative;"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="16.035ex" height="2.78ex" viewBox="0 -883.9 6903.8 1197.1" role="img" focusable="false" style="vertical-align: -0.728ex;" aria-hidden="true"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=https://habr.com/ru/post/448774/&amp;usg=ALkJrhguOk7mG2HRpZxy_TY-KOWDmNOtmQ#MJMATHI-64" x="0" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=https://habr.com/ru/post/448774/&amp;usg=ALkJrhguOk7mG2HRpZxy_TY-KOWDmNOtmQ#MJMAIN-2032" x="741" y="583"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=https://habr.com/ru/post/448774/&amp;usg=ALkJrhguOk7mG2HRpZxy_TY-KOWDmNOtmQ#MJMAIN-3D" x="1097" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=https://habr.com/ru/post/448774/&amp;usg=ALkJrhguOk7mG2HRpZxy_TY-KOWDmNOtmQ#MJMATHI-66" x="2153" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=https://habr.com/ru/post/448774/&amp;usg=ALkJrhguOk7mG2HRpZxy_TY-KOWDmNOtmQ#MJMAIN-28" x="2703" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=https://habr.com/ru/post/448774/&amp;usg=ALkJrhguOk7mG2HRpZxy_TY-KOWDmNOtmQ#MJMATHI-53" x="3093" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=https://habr.com/ru/post/448774/&amp;usg=ALkJrhguOk7mG2HRpZxy_TY-KOWDmNOtmQ#MJMATHI-51" x="3738" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=https://habr.com/ru/post/448774/&amp;usg=ALkJrhguOk7mG2HRpZxy_TY-KOWDmNOtmQ#MJMATHI-4C" x="4530" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=https://habr.com/ru/post/448774/&amp;usg=ALkJrhguOk7mG2HRpZxy_TY-KOWDmNOtmQ#MJMAIN-28" x="5211" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=https://habr.com/ru/post/448774/&amp;usg=ALkJrhguOk7mG2HRpZxy_TY-KOWDmNOtmQ#MJMATHI-64" x="5601" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=https://habr.com/ru/post/448774/&amp;usg=ALkJrhguOk7mG2HRpZxy_TY-KOWDmNOtmQ#MJMAIN-29" x="6124" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=https://habr.com/ru/post/448774/&amp;usg=ALkJrhguOk7mG2HRpZxy_TY-KOWDmNOtmQ#MJMAIN-29" x="6514" y="0"></use></g></svg><span class="MJX_Assistive_MathML MJX_Assistive_MathML_Block" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><msup><mi>d</mi><mo>‚Ä≤</mo></msup><mo>=</mo><mi>f</mi><mo stretchy="false">(</mo><mi>S</mi><mi>Q</mi><mi>L</mi><mo stretchy="false">(</mo><mi>d</mi><mo stretchy="false">)</mo><mo stretchy="false">)</mo></math></span></span></div><script type="math/tex;mode=display" id="MathJax-Element-1"> d '= f (SQL (d)) </script></p><br>  donde <br><math></math><span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax_SVG" id="MathJax-Element-2-Frame" tabindex="0" style="font-size: 100%; display: inline-block; position: relative;" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>d</mi></math>" role="presentation"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.216ex" height="2.057ex" viewBox="0 -780.1 523.5 885.9" role="img" focusable="false" style="vertical-align: -0.246ex;" aria-hidden="true"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=https://habr.com/ru/post/448774/&amp;usg=ALkJrhguOk7mG2HRpZxy_TY-KOWDmNOtmQ#MJMATHI-64" x="0" y="0"></use></g></svg><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mi>d</mi></math></span></span><script type="math/tex" id="MathJax-Element-2"> d </script>  - datos de origen, <br><math></math><span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax_SVG" id="MathJax-Element-3-Frame" tabindex="0" style="font-size: 100%; display: inline-block; position: relative;" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>S</mi><mi>Q</mi><mi>L</mi><mo stretchy=&quot;false&quot;>(</mo><mi>d</mi><mo stretchy=&quot;false&quot;>)</mo></math>" role="presentation"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="7.946ex" height="2.66ex" viewBox="0 -832 3421 1145.2" role="img" focusable="false" style="vertical-align: -0.728ex;" aria-hidden="true"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=https://habr.com/ru/post/448774/&amp;usg=ALkJrhguOk7mG2HRpZxy_TY-KOWDmNOtmQ#MJMATHI-53" x="0" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=https://habr.com/ru/post/448774/&amp;usg=ALkJrhguOk7mG2HRpZxy_TY-KOWDmNOtmQ#MJMATHI-51" x="645" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=https://habr.com/ru/post/448774/&amp;usg=ALkJrhguOk7mG2HRpZxy_TY-KOWDmNOtmQ#MJMATHI-4C" x="1437" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=https://habr.com/ru/post/448774/&amp;usg=ALkJrhguOk7mG2HRpZxy_TY-KOWDmNOtmQ#MJMAIN-28" x="2118" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=https://habr.com/ru/post/448774/&amp;usg=ALkJrhguOk7mG2HRpZxy_TY-KOWDmNOtmQ#MJMATHI-64" x="2508" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=https://habr.com/ru/post/448774/&amp;usg=ALkJrhguOk7mG2HRpZxy_TY-KOWDmNOtmQ#MJMAIN-29" x="3031" y="0"></use></g></svg><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mi>S</mi><mi>Q</mi><mi>L</mi><mo stretchy="false">(</mo><mi>d</mi><mo stretchy="false">)</mo></math></span></span><script type="math/tex" id="MathJax-Element-3"> SQL (d) </script>  - Consulta SQL para recuperar datos, <br><math></math><span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax_SVG" id="MathJax-Element-4-Frame" tabindex="0" style="font-size: 100%; display: inline-block; position: relative;" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><mi>f</mi></math>" role="presentation"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.279ex" height="2.419ex" viewBox="0 -780.1 550.5 1041.5" role="img" focusable="false" style="vertical-align: -0.607ex;" aria-hidden="true"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=https://habr.com/ru/post/448774/&amp;usg=ALkJrhguOk7mG2HRpZxy_TY-KOWDmNOtmQ#MJMATHI-66" x="0" y="0"></use></g></svg><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><mi>f</mi></math></span></span><script type="math/tex" id="MathJax-Element-4"> f </script>  - una funci√≥n que convierte la selecci√≥n al formato deseado, <br><math></math><span class="MathJax_Preview" style="color: inherit; display: none;"></span><span class="MathJax_SVG" id="MathJax-Element-5-Frame" tabindex="0" style="font-size: 100%; display: inline-block; position: relative;" data-mathml="<math xmlns=&quot;http://www.w3.org/1998/Math/MathML&quot;><msup><mi>d</mi><mo>&amp;#x2032;</mo></msup></math>" role="presentation"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="1.903ex" height="2.178ex" viewBox="0 -832 819.3 937.7" role="img" focusable="false" style="vertical-align: -0.246ex;" aria-hidden="true"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=https://habr.com/ru/post/448774/&amp;usg=ALkJrhguOk7mG2HRpZxy_TY-KOWDmNOtmQ#MJMATHI-64" x="0" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=https://habr.com/ru/post/448774/&amp;usg=ALkJrhguOk7mG2HRpZxy_TY-KOWDmNOtmQ#MJMAIN-2032" x="741" y="513"></use></g></svg><span class="MJX_Assistive_MathML" role="presentation"><math xmlns="http://www.w3.org/1998/Math/MathML"><msup><mi>d</mi><mo>‚Ä≤</mo></msup></math></span></span><script type="math/tex" id="MathJax-Element-5"> d '</script>  - datos en el formato requerido. <br><br>  Para Oracle PL / SQL, hay una serie de paquetes integrados y de terceros que implementan esta funcionalidad.  Estos son DBMS_XMLGEN, DBMS_XMLQUERY, AS_XLSX, PL / JSON y otros. <br><br>  Sin embargo, cuando surgi√≥ la pregunta sobre la conversi√≥n de datos al formato CSV, por alguna raz√≥n no hab√≠a soluciones preparadas.  Tuve que hacerlo yo mismo, luego se mostrar√° c√≥mo. <a name="habracut"></a><br><br>  Declaraci√≥n del problema. <br><br>  Cree una herramienta (paquete PL / SQL) que reciba una consulta SELECT arbitraria como una cadena o como una variable de cursor en la entrada, y devuelva un objeto del tipo CLOB encapsulando datos en formato CSV en la salida.  En caso de cualquier error, se debe devolver NULL.  No es necesario representar el formato CSV en s√≠ mismo: son cadenas cuyos elementos est√°n separados por alg√∫n car√°cter, con mayor frecuencia ";", pero en el caso general un car√°cter arbitrario puede actuar como un separador.  Suponga que los caracteres 0x0D + 0x0A se usan para separar las cadenas.  La primera l√≠nea en el archivo CSV suele ser el encabezado y define los nombres de las columnas. <br><br>  Definir la interfaz del paquete. <br><br><pre><code class="pgsql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OR REPLACE</span></span> PACKAGE pp_csv <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">PROCEDURE</span></span> query2sheet( stmt <span class="hljs-keyword"><span class="hljs-keyword">IN</span></span> VARCHAR2, sheet <span class="hljs-keyword"><span class="hljs-keyword">IN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OUT</span></span> CLOB, delimeter <span class="hljs-keyword"><span class="hljs-keyword">IN</span></span> VARCHAR2 <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-string"><span class="hljs-string">';'</span></span> ); <span class="hljs-keyword"><span class="hljs-keyword">PROCEDURE</span></span> query2sheet( ref_cursor <span class="hljs-keyword"><span class="hljs-keyword">IN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OUT</span></span> SYS_REFCURSOR, sheet <span class="hljs-keyword"><span class="hljs-keyword">IN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OUT</span></span> CLOB, delimeter <span class="hljs-keyword"><span class="hljs-keyword">IN</span></span> VARCHAR2 <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-string"><span class="hljs-string">';'</span></span> ); <span class="hljs-keyword"><span class="hljs-keyword">END</span></span>;</code> </pre> <br>  Hay dos procedimientos sobrecargados, la diferencia entre ellos es que uno de ellos recibe la solicitud como una cadena y el otro como un enlace al cursor.  El segundo par√°metro es la salida; este es el resultado deseado en el objeto CLOB.  Finalmente, el tercer par√°metro es el separador CSV. <br><br>  En la implementaci√≥n de estos procedimientos, el paquete DBMS_SQL incorporado nos ayudar√°, lo que nos permite trabajar con cursores din√°micos cuando no se sabe de antemano (en la etapa de compilaci√≥n) exactamente cu√°ntas columnas est√°n involucradas en la selecci√≥n. <br><br>  Las caracter√≠sticas DBMS_SQL le permiten analizar y ejecutar din√°micamente consultas arbitrarias.  Para un procedimiento que acepta una solicitud como una cadena, esto sucede as√≠: <br><br><pre> <code class="pgsql hljs"><span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> cur PLS_INTEGER := DBMS_SQL.OPEN_CURSOR; <span class="hljs-comment"><span class="hljs-comment">--     DBMS_SQL ignore INTEGER; BEGIN DBMS_SQL.PARSE(cur, stmt, DBMS_SQL.NATIVE); ignore := DBMS_SQL.EXECUTE(cur);</span></span></code> </pre> <br>  Para un procedimiento que toma una variable de cursor, todo es m√°s simple: a partir de la 11¬™ versi√≥n de Oracle, la conversi√≥n "variable de cursor ‚Üí n√∫mero de cursor SQL" est√° disponible. <br><br>  La funci√≥n DBMS_SQL.TO_CURSOR_NUMBER convierte la variable REFCURSOR (de tipo fuerte o d√©bil) en el n√∫mero del cursor SQL, que luego puede pasarse a las rutinas DBMS_SQL.  En este caso, la variable del cursor debe estar abierta antes de pasarla a la funci√≥n DBMS_SQL.TO_CURSOR_NUMBER. <br><br><pre> <code class="pgsql hljs">cur PLS_INTEGER := DBMS_SQL.TO_CURSOR_NUMBER(ref_cursor);</code> </pre> <br>  Por lo tanto, ambas versiones de la llamada se redujeron a obtener el <i>n√∫mero del</i> cursor din√°mico y el conjunto de datos asociado.  El siguiente paso es obtener informaci√≥n sobre las columnas de este conjunto y extraer los datos en s√≠. <br><br>  El paquete DMBS_SQL le permite describir las columnas de un cursor din√°mico, devolviendo informaci√≥n sobre cada columna en una matriz asociativa de registros. <br><br>  Para hacer esto, debe declarar la colecci√≥n PL / SQL basada en el tipo de colecci√≥n DBMS_SQL.DESC_TAB (o DESC_TAB2 si la consulta puede devolver nombres de columna que tengan m√°s de 30 caracteres).  Despu√©s de eso, puede usar m√©todos de recopilaci√≥n para iterar sobre la tabla y recuperar la informaci√≥n del cursor. <br><br><pre> <code class="pgsql hljs"><span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> cols DBMS_SQL.DESC_TAB2; ncols NUMBER; <span class="hljs-comment"><span class="hljs-comment">--     col_val_chr VARCHAR2(32767); BEGIN DBMS_SQL.DESCRIBE_COLUMNS2(cur, ncols, cols);</span></span></code> </pre> <br>  A continuaci√≥n, el paquete DBMS_SQL debe ser informado del tipo de cada columna seleccionada utilizando la consulta din√°mica.  Esto se hace llamando a DEFINE_COLUMN. <br><br><pre> <code class="pgsql hljs"><span class="hljs-keyword"><span class="hljs-keyword">FOR</span></span> i <span class="hljs-keyword"><span class="hljs-keyword">IN</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> .. ncols <span class="hljs-keyword"><span class="hljs-keyword">LOOP</span></span> DBMS_SQL.DEFINE_COLUMN(cur, i, col_val_chr, <span class="hljs-number"><span class="hljs-number">32767</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> <span class="hljs-keyword"><span class="hljs-keyword">LOOP</span></span>;</code> </pre> <br>  En el segundo argumento DEFINE_COLUMN, se pasa un n√∫mero: la posici√≥n secuencial de la columna en la lista.  El tercer argumento establece el tipo de datos de la columna del cursor.  Pasa una expresi√≥n del tipo apropiado.  En otras palabras, DBMS_SQL.DEFINE_COLUMN no se pasa una cadena con un nombre de tipo (por ejemplo, "VARCHAR2"), sino una variable definida con el tipo VARCHAR2. <br><br>  Al definir una columna de tipo de car√°cter en el cuarto argumento, debe especificar la longitud m√°xima de los valores que se pueden cargar en el cursor. <br><br>  Las operaciones preparatorias se han completado, ahora puede crear una l√≠nea de encabezado y comenzar a extraer datos. <br><br><pre> <code class="pgsql hljs"><span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> cap CLOB; <span class="hljs-comment"><span class="hljs-comment">--    CSV- BEGIN DBMS_LOB.CREATETEMPORARY(cap, TRUE, DBMS_LOB.SESSION); FOR i IN 1 .. ncols LOOP DBMS_LOB.APPEND(cap, cols(i).col_name || delimeter); END LOOP;</span></span></code> </pre> <br>  Los datos se recuperan l√≠nea por l√≠nea utilizando DBMS_SQL.FETCH_ROWS y llamadas posteriores a DBMS_SQL.COLUMN_VALUE para obtener los valores de las columnas individuales. <br><br><pre> <code class="pgsql hljs"><span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> bod CLOB; <span class="hljs-comment"><span class="hljs-comment">--   CSV- c_line_break CONSTANT VARCHAR2(2) := chr(13) || chr(10); BEGIN DBMS_LOB.CREATETEMPORARY(bod, TRUE, DBMS_LOB.SESSION); WHILE DBMS_SQL.FETCH_ROWS(ur) &gt; 0 LOOP FOR i IN 1 .. ncols LOOP DBMS_SQL.COLUMN_VALUE(cur, i, col_val_chr); DBMS_LOB.APPEND(bod, col_val_chr || delimeter); END LOOP; DBMS_LOB.APPEND(bod, c_line_break); END LOOP;</span></span></code> </pre> <br>  Entonces solo queda recolectar el CSV resultante <br><br><pre> <code class="pgsql hljs">DBMS_LOB.APPEND(sheet, cap); DBMS_LOB.APPEND(sheet, c_line_break); DBMS_LOB.APPEND(sheet, bod);</code> </pre> <br>  Manejar errores <br><br><pre> <code class="pgsql hljs"><span class="hljs-keyword"><span class="hljs-keyword">EXCEPTION</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> OTHERS <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> sheet := <span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span>;</code> </pre> <br>  Y cierra el cursor <br><br><pre> <code class="pgsql hljs">DBMS_SQL.CLOSE_CURSOR(cur);</code> </pre> <br>  Opciones de uso del paquete <br><br><pre> <code class="pgsql hljs"><span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> csv CLOB; <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> DBMS_LOB.CREATETEMPORARY(csv, <span class="hljs-keyword"><span class="hljs-keyword">TRUE</span></span>, DBMS_LOB.<span class="hljs-keyword"><span class="hljs-keyword">SESSION</span></span>); pp_csv.query2sheet(<span class="hljs-string"><span class="hljs-string">'SELECT empcode, fio FROM employee WHERE ROWNUM &lt; 10'</span></span>, csv); DBMS_OUTPUT.PUT_LINE(csv); DBMS_LOB.FREETEMPORARY(csv); <span class="hljs-keyword"><span class="hljs-keyword">END</span></span>;</code> </pre> <br><pre> <code class="pgsql hljs"><span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> csv CLOB; cur SYS_REFCURSOR; <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OPEN</span></span> cur <span class="hljs-keyword"><span class="hljs-keyword">FOR</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> empcode, fio <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> employee <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> ROWNUM &lt; <span class="hljs-number"><span class="hljs-number">10</span></span>; DBMS_LOB.CREATETEMPORARY(csv, <span class="hljs-keyword"><span class="hljs-keyword">TRUE</span></span>, DBMS_LOB.<span class="hljs-keyword"><span class="hljs-keyword">SESSION</span></span>); pp_csv.query2sheet(cur, csv); DBMS_OUTPUT.PUT_LINE(csv); DBMS_LOB.FREETEMPORARY(csv); <span class="hljs-keyword"><span class="hljs-keyword">END</span></span>;</code> </pre> <br>  Eso, de hecho, es todo, el <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">c√≥digo fuente est√° adjunto</a> . <br><br>  El libro ayud√≥ en el desarrollo. <br>  Feuerstein S., lleg√≥ B. - Oracle PL / SQL.  Para profesionales </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/448774/">https://habr.com/ru/post/448774/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../448756/index.html">Antecedentes: por qu√© Apple y Qualcomm se pelearon y luego se reconciliaron</a></li>
<li><a href="../448758/index.html">Reloj inteligente con BASIC en 6502 f√≠sico</a></li>
<li><a href="../448762/index.html">Disturbios en el Picaba. Los usuarios van masivamente a Reddit</a></li>
<li><a href="../448764/index.html">Relojes en ATtiny13</a></li>
<li><a href="../448766/index.html">Cree un monorepository con espacios de trabajo de lerna e hilo</a></li>
<li><a href="../448776/index.html">RxVMS: una arquitectura pr√°ctica para aplicaciones de flutter</a></li>
<li><a href="../448778/index.html">Presentaci√≥n de la depuraci√≥n de viajes en el tiempo para Visual Studio Enterprise 2019</a></li>
<li><a href="../448792/index.html">Prueba de Python con pytest. Accesorios incorporados, Cap√≠tulo 4</a></li>
<li><a href="../448794/index.html">Prueba de Python con pytest. Complementos CAP√çTULO 5</a></li>
<li><a href="../448796/index.html">Prueba de Python con pytest. Configuraci√≥n, CAP√çTULO 6</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>