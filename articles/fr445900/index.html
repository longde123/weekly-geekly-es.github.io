<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üëª üôèüèø üïã Comment r√©sister √† des charges syst√®me accrues: parlez de pr√©parations √† grande √©chelle pour le Black Friday üßóüèº üàµ üë©üèª‚Äçüíº</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Bonjour, Habr! 

 En 2017, lors du Black Friday, la charge a augment√© presque une fois et demie, et nos serveurs √©taient √† la limite des possibilit√©s....">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Comment r√©sister √† des charges syst√®me accrues: parlez de pr√©parations √† grande √©chelle pour le Black Friday</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/retailrocket/blog/445900/">  Bonjour, Habr! <br><br>  En 2017, lors du Black Friday, la charge a augment√© presque une fois et demie, et nos serveurs √©taient √† la limite des possibilit√©s.  Au cours de l'ann√©e, le nombre de clients a consid√©rablement augment√© et il est devenu clair que sans une pr√©paration pr√©alable approfondie, la plate-forme pourrait tout simplement ne pas r√©sister aux charges de 2018. <br><br>  L'objectif a √©t√© fix√© le plus ambitieux de tous: nous voulions √™tre pleinement pr√©par√©s √† toute explosion d'activit√©, m√™me la plus puissante, et avons commenc√© √† retirer de nouvelles capacit√©s √† l'avance au cours de l'ann√©e. <br><br>  Notre CTO Andrei Chizh ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" class="user_link">chizh_andrey</a> ) raconte comment nous nous sommes pr√©par√©s pour le Black Friday 2018, quelles mesures nous avons prises pour √©viter les chutes et, bien s√ªr, les r√©sultats d'une pr√©paration aussi minutieuse. <br><br><img src="https://habrastorage.org/webt/nv/pg/sq/nvpgsqdi4auhsvdmclno1upgvju.jpeg"><br><a name="habracut"></a><br>  Aujourd'hui, je veux parler des pr√©paratifs du Black Friday 2018. Pourquoi maintenant, alors que la plupart des principales ventes sont en retard?  Nous avons commenc√© √† nous pr√©parer environ un an avant les √©v√©nements √† grande √©chelle et, par essais et erreurs, nous avons trouv√© la solution optimale.  Nous vous recommandons de prendre soin des saisons chaudes √† l'avance et d'√©viter les fakaps qui peuvent √©merger au moment le plus inopportun. <br>  Le mat√©riel sera utile √† tous ceux qui veulent tirer le profit maximum de ces stocks, comme  l'aspect technique du probl√®me n'est pas inf√©rieur √† l'aspect marketing. <br><br><h2>  Caract√©ristiques du trafic sur les grosses ventes </h2><br>  Contrairement √† la croyance populaire, le Black Friday n'est pas un jour par an, mais presque toute une semaine: les premi√®res offres de r√©duction arrivent 7 √† 8 jours avant la vente.  Le trafic sur le site Web commence √† cro√Ætre en douceur toute la semaine, atteint son pic vendredi et chute assez fortement samedi aux indicateurs des magasins r√©guliers. <br><br><img src="https://habrastorage.org/webt/fp/gg/zh/fpggzhkt6td7vbzkbmw7k5ljo6u.jpeg"><br><br>  Ceci est important √† consid√©rer: les boutiques en ligne deviennent particuli√®rement sensibles √† tout ¬´ralentissement¬ª du syst√®me.  En outre, notre newsletter par e-mail a √©galement connu une augmentation significative du nombre d'envois. <br><br>  Il est strat√©giquement important pour nous de traverser le Black Friday sans chutes, car  la fonctionnalit√© la plus importante des sites et des listes de diffusion des magasins d√©pend du fonctionnement de la plateforme, √† savoir: <br><br><ul><li>  Suivi et √©mission de recommandations de produits, </li><li>  La publication de documents connexes (par exemple, des blocs de conception d'images de recommandations, tels que des fl√®ches, des logos, des ic√¥nes et d'autres √©l√©ments visuels), </li><li>  √âmission d'images de produits de la bonne taille (√† ces fins, nous avons ¬´ImageResizer¬ª - un sous-syst√®me qui t√©l√©charge une image √† partir du serveur du magasin, la comprime √† la taille souhait√©e et, via des serveurs de mise en cache, fournit des images de la bonne taille pour chaque produit dans chaque bloc de recommandation). </li></ul><br>  En effet, lors du Black Friday 2019, la charge sur le service a augment√© de 40%, soit  le nombre d'√©v√©nements que le syst√®me Retail Rocket surveille et traite sur les sites des magasins en ligne est pass√© de 5 √† 8 000 demandes par seconde.  Du fait que nous nous pr√©parions √† des charges plus graves, nous avons facilement connu une telle mont√©e subite. <br><br><img src="https://habrastorage.org/webt/hj/rf/yi/hjrfyizrdasmrzna_e2yv26s7x4.png"><br><br><h2>  Pr√©paration g√©n√©rale </h2><br><br>  Le Black Friday est une p√©riode chaude pour tous les d√©taillants et pour le commerce √©lectronique en particulier.  Le nombre d'utilisateurs et leur activit√© en ce moment augmentent parfois, nous avons donc, comme toujours, bien pr√©par√© pour cette p√©riode charg√©e.  Nous ajoutons ici le fait que de nombreux magasins en ligne nous sont connect√©s, non seulement en Russie mais aussi en Europe, o√π le battage m√©diatique est beaucoup plus √©lev√©, et nous obtenons un niveau de passions pire que la s√©rie br√©silienne.  Que faut-il faire pour √™tre parfaitement pr√©par√© √† des charges accrues? <br><br><h3>  Travailler avec des serveurs </h3><br>  Pour commencer, il a fallu savoir exactement ce qui nous manquait pour augmenter la capacit√© des serveurs.  D√©j√† en ao√ªt, nous avons commenc√© √† commander de nouveaux serveurs sp√©cifiquement pour le Black Friday - un total de 10 machines suppl√©mentaires ont √©t√© ajout√©es.  En novembre, ils √©taient d√©j√† compl√®tement au combat. <br><br>  Dans le m√™me temps, une partie des machines de g√©n√©ration a √©t√© r√©install√©e pour √™tre utilis√©e comme serveurs d'applications.  Nous les avons imm√©diatement pr√©par√©s pour l'utilisation de diff√©rentes fonctions: √† la fois pour √©mettre des recommandations et pour le service ImageResizer, afin que, selon le type de charge, chacun d'eux puisse √™tre utilis√© pour l'un de ces r√¥les.  En mode normal, les serveurs Application et ImageResizer ont des fonctions clairement d√©finies: les premiers participent √† l'√©mission des recommandations, les seconds fournissent des images de lettres et des blocs de recommandations sur le site des boutiques en ligne.  En pr√©paration du Black Friday, il a √©t√© d√©cid√© de faire en sorte que tous les serveurs √† double usage √©quilibrent le trafic entre eux en fonction du type de charge. <br><br>  Ensuite, nous avons ajout√© deux gros serveurs pour Kafka (Apache Kafka) et obtenu un cluster de 5 machines puissantes.  Malheureusement, tout ne s'est pas d√©roul√© aussi bien que nous le souhaiterions: dans le processus de synchronisation des donn√©es, deux nouvelles machines ont occup√© toute la largeur du canal r√©seau, et nous avons d√ª trouver rapidement comment ex√©cuter le processus d'ajout rapidement et en toute s√©curit√© pour l'ensemble de l'infrastructure.  Pour r√©soudre ce probl√®me, nos administrateurs ont d√ª vaillamment sacrifier le week-end. <br><br><h3>  Travailler avec des donn√©es </h3><br>  En plus des serveurs, nous avons d√©cid√© d'optimiser les fichiers pour faciliter le chargement, et une grande √©tape pour nous a √©t√© la traduction des fichiers statiques.  Tous les fichiers statiques qui √©taient pr√©c√©demment h√©berg√©s sur les serveurs ont √©t√© transf√©r√©s vers S3 + Cloudfront.  Ils voulaient le faire depuis longtemps, car la charge sur le serveur √©tait proche des valeurs limites, et maintenant une excellente raison apparaissait. <br><br>  Une semaine avant le Black Friday, nous avons augment√© le temps de mise en cache des images √† 3 jours, de sorte qu'en cas de chute d'ImageResizer, les images pr√©c√©demment mises en cache ont √©t√© obtenues √† partir de cdn.  Cela a √©galement r√©duit la charge sur nos serveurs, car plus l'image est stock√©e longtemps, moins nous devons d√©penser de ressources pour le redimensionnement. <br><br>  Et enfin, et non des moindres: 5 jours avant le Black Friday, un moratoire a √©t√© annonc√© sur le d√©ploiement de toute nouvelle fonctionnalit√©, ainsi que sur tout travail avec l'infrastructure - toute l'attention a √©t√© port√©e √† faire face √† des charges accrues. <br><br><h2>  Plans d'intervention d'urgence </h2><br>  Quelle que soit la qualit√© de la pr√©paration, la fakapy est toujours possible.  Et nous avons d√©velopp√© 3 plans de r√©ponse aux situations critiques possibles: <br><br><ul><li>  r√©duction de la charge </li><li>  d√©sactiver certains services, </li><li>  arr√™t complet du service. </li></ul><br>  <b>Plan A: r√©duction de charge.</b>  Auraient d√ª √™tre impliqu√©s si, en raison d'une augmentation de la charge, nos serveurs d√©passent les d√©lais de r√©ponse acceptables.  Dans ce cas, nous avons pr√©par√© des m√©canismes pour r√©duire progressivement la charge en transf√©rant une partie du trafic vers les serveurs Amazon, ce qui donnerait simplement ¬´200 OK¬ª √† toutes les demandes et donnerait une r√©ponse vide.  Nous avons compris qu'il s'agit d'une d√©gradation de la qualit√© du service, mais le choix entre le fait que le service ne fonctionne pas du tout ou n'affiche pas de recommandations pour environ 10% du trafic est √©vident. <br><br>  <b>Plan B: d√©sactivation des services.</b>  Impliquait une d√©gradation partielle du service.  Par exemple, r√©duire la vitesse de calcul des recommandations personnelles dans le but de d√©charger certaines bases de donn√©es et canaux de communication.  En mode normal, les recommandations sont calcul√©es en mode temps r√©el, cr√©ant une version de la boutique en ligne pour chaque visiteur, mais dans des conditions de charges accrues, une diminution de la vitesse permet aux autres services de base de continuer √† fonctionner. <br><br>  <b>Plan C: pour Armageddon.</b>  En cas de d√©faillance compl√®te du syst√®me, nous avons pr√©par√© un plan qui nous d√©connectera en toute s√©curit√© des clients.  Les acheteurs cesseront simplement de voir les recommandations; les performances d'une boutique en ligne ne seront pas affect√©es.  Pour ce faire, nous devions r√©initialiser notre fichier d'int√©gration afin que les nouveaux utilisateurs cessent d'interagir avec le service.  Autrement dit, nous d√©sactiverions le travail de notre code de suivi principal, le service cesserait de collecter des donn√©es et calculerait des recommandations, et l'utilisateur verrait simplement une page sans blocs de recommandation.  Pour tous ceux qui ont d√©j√† re√ßu le fichier d'int√©gration, nous avons fourni l'option de basculer les enregistrements DNS vers Amazon et un stub 200 OK. <br><br><h2>  R√©sum√© </h2><br>  Nous avons support√© toute la charge m√™me sans avoir besoin d'utiliser des machines de construction suppl√©mentaires.  Et gr√¢ce √† la pr√©paration pr√©alable, nous n'avons eu besoin d'aucun des plans d'intervention √©labor√©s.  Mais tout le travail accompli est une exp√©rience inestimable qui nous aidera √† faire face aux afflux de trafic les plus inattendus et les plus importants. <br>  Comme en 2017, la charge sur le service a augment√© de 40% et le nombre d'utilisateurs dans les boutiques en ligne pour le Black Friday a augment√© de 60%.  Toutes les difficult√©s et les erreurs se sont produites pendant la p√©riode pr√©paratoire, ce qui nous a sauv√©s, nous et nos clients, de situations impr√©vues. <br><br>  Que pensez-vous du Black Friday?  Comment se pr√©parer aux charges critiques? </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr445900/">https://habr.com/ru/post/fr445900/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr445890/index.html">PyTest Neo</a></li>
<li><a href="../fr445892/index.html">Th√©orie des grandes et petites explosions</a></li>
<li><a href="../fr445894/index.html">[Izhevsk et Perm, annonce] Diffusion en ligne chaude et transistor CodeFest X</a></li>
<li><a href="../fr445896/index.html">Pourquoi les scanners 3D √©conomiques ne conviennent pas aux t√¢ches professionnelles</a></li>
<li><a href="../fr445898/index.html">√Ä propos de nouvelles id√©es, de vues √©troites et du bouche √† oreille</a></li>
<li><a href="../fr445904/index.html">Types d'infinis et de tronc c√©r√©bral</a></li>
<li><a href="../fr445906/index.html">Ne mangez pas d'aspirine</a></li>
<li><a href="../fr445908/index.html">Golang et l'√©volution de l'interaction des bases de donn√©es</a></li>
<li><a href="../fr445910/index.html">Comment nous sommes devenus amis avec EF 6 MSSQL et PostgresSQL</a></li>
<li><a href="../fr445912/index.html">Salut, Habr, nous sommes Advantech</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>