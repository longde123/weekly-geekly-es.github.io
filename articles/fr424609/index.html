<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üåî üéä ü§úüèº Comment √©tendre Kubernetes üèÇüèæ ‚è¨ üö•</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Aujourd'hui, nous allons parler de DevOps, ou plut√¥t, principalement d'Ops. Ils disent qu'il y a tr√®s peu de gens satisfaits du niveau d'automatisatio...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Comment √©tendre Kubernetes</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/jugru/blog/424609/">  Aujourd'hui, nous allons parler de DevOps, ou plut√¥t, principalement d'Ops.  Ils disent qu'il y a tr√®s peu de gens satisfaits du niveau d'automatisation de leurs op√©rations.  Mais la situation semble √™tre r√©parable.  Dans cet article, Nikolai Ryzhikov parlera de son exp√©rience avec l'expansion de Kubernetes. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/b1a/4f7/1a2/b1a4f71a2809a5b098e738ed4e0b5d3f.png"><br><br>  Le mat√©riel a √©t√© pr√©par√© sur la base du discours de Nikolai lors de la conf√©rence d'automne DevOops 2017. Sous la coupe - transcription vid√©o et texte du rapport. <br><a name="habracut"></a><br><iframe width="560" height="315" src="https://www.youtube.com/embed/3BMTNx2xCtQ" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><br>  <i>Actuellement, Nikolai Ryzhikov travaille dans le secteur Sant√©-TI pour cr√©er des syst√®mes d'information m√©dicale.</i>  <i>Membre de la communaut√© des programmeurs fonctionnels FPROG de Saint-P√©tersbourg.</i>  <i>Membre actif de la communaut√© Online Clojure, membre de la norme d'√©change d'informations m√©dicales HL7 FHIR.</i>  <i>Programmation depuis 15 ans.</i> <br><hr><br>  De quel c√¥t√© avons-nous pour DevOps?  Depuis 10 ans, notre formule DevOps est assez simple: les d√©veloppeurs sont responsables des op√©rations, les d√©veloppeurs sont d√©ploy√©s, les d√©veloppeurs sont maintenus.  Avec cet arrangement, qui a l'air un peu dur, vous deviendrez en tout cas DevOps.  Si vous souhaitez impl√©menter rapidement et p√©niblement DevOps - rendez les d√©veloppeurs responsables de votre production.  Si les gars sont intelligents, ils commenceront √† sortir et √† tout comprendre. <br><img src="https://habrastorage.org/getpro/habr/post_images/8f4/799/e0d/8f4799e0d6f25b897b6bd72f2ba1081a.png"><br>  Notre histoire: il y a longtemps, quand il n'y avait pas de Chef et d'automatisation, nous avions d√©j√† d√©ploy√© Capistrano automatique.  Puis ils ont commenc√© √† l'ennuyer pour qu'il fasse de la mode.  Mais le chef est alors apparu.  Nous y sommes pass√©s et sommes partis pour le cloud: nous en avions assez de nos data centers.  Puis Ansible est apparu, Docker s'est lev√©.  Apr√®s cela, nous avons d√©m√©nag√© √† Terraform avec le superviseur de docker Condo manuscrit sur Camel.  Et maintenant, nous passons √† Kubernetes. <br><img src="https://habrastorage.org/getpro/habr/post_images/366/af1/be8/366af1be8b4c4cf204553b48c8a76e70.png"><br>  Quelle est la pire chose au sujet des op√©rations?  Tr√®s peu de gens sont satisfaits du niveau d'automatisation de leurs op√©rations.  C'est effrayant, je confirme: nous avons d√©pens√© beaucoup de ressources et d'efforts pour collecter toutes ces piles pour nous-m√™mes, et le r√©sultat n'est pas satisfaisant. <br><br>  On a le sentiment qu'avec l'av√®nement de Kubernetes, quelque chose peut changer.  Je suis attach√© √† la fabrication all√©g√©e et, de son point de vue, les op√©rations ne sont g√©n√©ralement pas utiles.  Les op√©rations id√©ales sont l'absence ou le minimum d'op√©rations dans un projet.  La valeur est cr√©√©e lorsqu'un d√©veloppeur cr√©e un produit.  Lorsqu'elle est pr√™te, la livraison n'ajoute pas de valeur.  Mais vous devez r√©duire les co√ªts. <br><img src="https://habrastorage.org/getpro/habr/post_images/731/1a4/6e3/7311a46e3eb4d1d73d788f6ee881be3a.png"><br>  Pour moi, l'id√©al √©tait toujours le heroku.  Nous l'avons utilis√© pour des applications simples, o√π le d√©veloppeur pour d√©ployer son service, il suffisait de dire git push et de configurer heroku.  √áa prend une minute. <br><img src="https://habrastorage.org/getpro/habr/post_images/a57/4c0/12b/a574c012ba1158086cd3578287d6d2a9.png"><br>  Comment √™tre  Vous pouvez acheter NoOps - √©galement Heroku.  Et je vous conseille d'acheter, sinon il y a une chance de d√©penser plus d'argent pour le d√©veloppement des op√©rations normales. <br><br>  Il y a des gars Deis, ils essaient de faire quelque chose comme heroku sur Kubernetes.  Il existe une fonderie de cloud, qui fournit √©galement une plate-forme sur laquelle travailler. <br><img src="https://habrastorage.org/getpro/habr/post_images/bbd/7b9/7e0/bbd7b97e07aae6af9a54663d633e3cc2.png"><br>  Mais si vous vous emb√™tez avec quelque chose de plus complexe ou de plus grand, vous pouvez le faire vous-m√™me.  Maintenant, avec Docker et Kubernetes, cela devient une t√¢che qui peut √™tre accomplie dans un d√©lai raisonnable et √† un co√ªt raisonnable.  Auparavant, c'√©tait trop dur. <br><img src="https://habrastorage.org/getpro/habr/post_images/299/2d2/90a/2992d290a7167b9fe4a8cf2320528b8e.png"><br><h2>  Un peu sur Docker et Kubernetes </h2><br>  L'un des probl√®mes des op√©rations est la r√©p√©tabilit√©.  La grande chose que le docker a apport√© est en deux phases.  Nous avons une phase de construction. <br><br>  Le deuxi√®me point qui pla√Æt au docker est une interface universelle pour lancer des services arbitraires.  Quelqu'un a assembl√© Docker, a mis quelque chose √† l'int√©rieur et les op√©rations suffisent √† dire que Docker s'ex√©cute et d√©marre. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/0b4/ca2/5ad/0b4ca25ade4ae7d3513539aaa576d3e7.png"><br><br>  Qu'est-ce que Kubernetes?  Nous avons donc cr√©√© Docker et nous devons le lancer, l'int√©grer, le configurer et le connecter √† d'autres quelque part.  Kubernetes vous permet de le faire.  Il pr√©sente une s√©rie d'abstractions, appel√©es ¬´ressources¬ª.  Nous allons les parcourir rapidement et m√™me essayer de cr√©er. <br><br><h2>  Abstraction </h2><br>  La premi√®re abstraction est un POD ou un ensemble de conteneurs.  Correctement fait, ce qui est exactement un <b>ensemble de</b> conteneurs, et non un.  Les ensembles peuvent fouiller entre eux des volumes qui se voient via localhost.  Cela vous permet d'utiliser un mod√®le tel que sidecar (c'est lorsque nous lan√ßons le conteneur principal, et il y a des conteneurs auxiliaires √† proximit√© qui l'aident). <br><br>  Par exemple, l'approche des ambassadeurs.  C'est lorsque vous ne voulez pas que le conteneur pense o√π se trouvent certains services.  Vous placez un conteneur √† c√¥t√© qui sait o√π se trouvent ces services.  Et ils deviennent disponibles pour le conteneur principal sur localhost.  Ainsi, l'environnement commence √† ressembler √† votre travail local. <br><img src="https://habrastorage.org/getpro/habr/post_images/0b8/ab5/bda/0b8ab5bdae5f0d0e7375ff1b08efc6ee.png"><br>  Levons le POD et voyons comment il est d√©crit.  Localement, vous pouvez d√©velopper un minikube.  Il mange un tas de CPU, mais vous permet de soulever un petit cluster Kubernetes sur une virtualbox et de travailler avec. <br><br>  D√©ployons POD.  J'ai dit que Kubernetes appliquait et inondait le POD.  Je peux voir quels PODs j'ai: je vois qu'un POD est d√©ploy√©.  Cela signifie que Kubernetes a lanc√© ces conteneurs. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/970/862/d90/970862d90a9afea1066caa69c1af63c8.png"></div><br>  Je peux m√™me aller dans ce conteneur. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/122/603/8f7/1226038f78d2c9593826e7f26d611853.png"></div><br>  De ce point de vue, Kubernetes est fait pour les gens.  En effet, ce que nous faisons constamment dans les op√©rations, dans la liaison Kubernetes, par exemple, en utilisant l'utilitaire kubectl, peut √™tre fait facilement. <br><br>  Mais le POD est mortel.  Cela commence comme une course Docker: si quelqu'un l'arr√™te, personne ne le l√®vera.  En plus de cette abstraction, Kubernetes commence √† construire ce qui suit - par exemple, un jeu de r√©plicas.  C'est un tel superviseur qui surveille les POD, surveille leur nombre, et si les POD tombent, il les soul√®ve.  Il s'agit d'un important concept d'auto-gu√©rison dans Kubernetes qui vous permet de dormir paisiblement la nuit. <br><br>  Au-dessus du jeu de r√©pliques, il y a une abstraction du d√©ploiement - √©galement une ressource qui vous permet de faire un d√©ploiement sans temps.  Par exemple, un jeu de r√©pliques fonctionne.  Lorsque nous d√©ployons et modifions la version du conteneur, par exemple la n√¥tre, √† l'int√©rieur du d√©ploiement, un autre jeu de r√©plicas se l√®ve.  Nous attendons que ces conteneurs commencent, effectuons leurs contr√¥les de sant√©, puis nous passons rapidement au nouveau jeu de r√©plicas.  Aussi classique et bonne pratique. <br><img src="https://habrastorage.org/getpro/habr/post_images/02e/d07/f33/02ed07f333733af0155ee539be18c669.png"><br>  Prenons un service simple.  Par exemple, nous avons un d√©ploiement.  √Ä l'int√©rieur, il d√©crit le mod√®le de POD qu'il ramassera.  Nous pouvons appliquer ce d√©ploiement, voir ce que nous avons.  Fonction cool de Kubernetes - tout se trouve dans la base de donn√©es, et nous pouvons regarder ce qui se passe dans le syst√®me. <br><br>  Ici, nous voyons un d√©ploiement.  Si nous essayons de regarder les POD, nous voyons que certains POD ont augment√©.  Nous pouvons prendre et retirer ce POD.  Qu'arrive-t-il aux POD?  L'un est d√©truit et le second monte imm√©diatement.  Ce contr√¥leur de r√©plicas n'a pas trouv√© le POD souhait√© et en a lanc√© un autre. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/524/7f4/0d4/5247f40d4fb21eb93bda0ce14124245e.png"></div><br>  De plus, s'il s'agit d'une sorte de service Web, ou si nos services doivent communiquer, nous avons besoin d'une d√©couverte de service.  Vous devez donner au service un nom et un point d'entr√©e.  Kubernetes propose une ressource appel√©e service pour cela.  Il peut g√©rer l'√©quilibrage de charge et √™tre responsable de la d√©couverte des services. <br><img src="https://habrastorage.org/getpro/habr/post_images/2fa/926/6e5/2fa9266e57c6718a81241ae1ac15da8e.png"><br>  Voyons un service simple.  Nous le connectons avec le d√©ploiement et les POD via des √©tiquettes: un tel lien dynamique.  Un concept tr√®s important dans Kubernetes: le syst√®me est dynamique.  Peu importe dans quel ordre tout cela sera cr√©√©.  Le service essaiera de trouver des POD avec de telles √©tiquettes et commencera leur √©quilibre de charge. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/b48/992/f7d/b48992f7dca832fce9b45276936a4914.png"></div><br>  Appliquez le service, regardez quels services nous avons.  Nous allons dans notre test POD, qui a √©t√© d√©clench√©, et faisons nslookup.  Kubernetes nous donne un DNS-ku √† travers lequel les services peuvent se voir et se d√©couvrir. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/b05/66f/01e/b0566f01e54210ea26c5b6526b0ed0de.png"></div><br>  Le service est plut√¥t une interface.  Il existe plusieurs impl√©mentations diff√©rentes, car les t√¢ches d'√©quilibrage de charge et de service sont assez compliqu√©es: d'une part, nous travaillons avec des bases de donn√©es ordinaires, de l'autre avec des bases de donn√©es charg√©es, et certaines simples sont rendues assez simples.  C'est √©galement un concept important dans Kubernetes: certaines choses peuvent √™tre appel√©es des interfaces plut√¥t que des impl√©mentations.  Ils ne sont pas fix√©s de mani√®re rigide et diff√©rents, par exemple, les fournisseurs de cloud fournissent diff√©rentes impl√©mentations.  C'est-√†-dire, par exemple, qu'il existe un volume persistant de ressources, qui est d√©j√† impl√©ment√© dans chaque cloud particulier par ses moyens r√©guliers. <br><br>  Ensuite, nous voulons g√©n√©ralement sortir le service Web.  Kubernetes a une abstraction d'entr√©e.  SSL y est g√©n√©ralement ajout√©. <br><img src="https://habrastorage.org/getpro/habr/post_images/fc7/69e/4e7/fc769e4e7a526588c3f3ae32388d9c11.png"><br>  L'entr√©e la plus simple ressemble √† ceci.  L√†, nous √©crivons les r√®gles: pour quelles URL, pour quels h√¥tes, vers quel service interne rediriger la demande.  De la m√™me mani√®re, nous pouvons augmenter notre p√©n√©tration. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/69d/79c/046/69d79c046478f1fde2a073f2fe37067f.png"></div><br>  Apr√®s quoi, apr√®s vous √™tre enregistr√© localement dans les h√¥tes, vous pouvez voir ce service √† partir d'ici. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/73d/752/75c/73d75275c26a468f49cd192e781595db.png"></div><br>  C'est une t√¢che tellement r√©guli√®re: nous avons d√©ploy√© un certain service Web, rencontr√© un peu Kubernetes. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/1a3/1f8/c2f/1a31f8c2f639a4758d95719ee6dca1e0.png"></div><br>  Nous allons tout nettoyer, √©liminer les entr√©es et examiner toutes les ressources. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/c75/990/40c/c7599040cd85c2c155e8acf057be0246.png"></div><br>  Il existe un certain nombre de ressources, telles que configmap et secret.  Ce sont des ressources purement informatives que vous pouvez monter dans un conteneur et y transf√©rer, par exemple, le mot de passe de postgres.  Vous pouvez associer cela √† des variables d'environnement qui seront inject√©es dans le conteneur au d√©marrage.  Vous pouvez monter le syst√®me de fichiers.  Tout est assez pratique: t√¢ches standard, belles solutions. <br><br>  Il existe un volume persistant - une interface impl√©ment√©e diff√©remment par diff√©rents fournisseurs de cloud.  Il est divis√© en deux parties: il y a une revendication de volume persistante (demande), puis un EBS est cr√©√© qui se d√©place vers le conteneur.  Vous pouvez travailler avec un service avec √©tat. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/cd6/5c1/2f7/cd65c12f71d417ffd11e3e62c76b484c.png"><br><br>  Mais comment √ßa marche √† l'int√©rieur?  Le concept lui-m√™me est tr√®s simple et transparent.  Kubernetes se compose de deux parties.  L'une n'est qu'une base de donn√©es dans laquelle nous avons toutes ces ressources.  Les ressources peuvent √™tre consid√©r√©es comme des tablettes: en particulier, ces instances sont simplement des enregistrements dans des tablettes.  En plus de Kubernetes, un serveur API est configur√©.  Autrement dit, lorsque vous avez un cluster Kubernetes, vous communiquez g√©n√©ralement avec le serveur API (plus pr√©cis√©ment, le client communique avec lui). <br><br>  En cons√©quence, ce que nous avons cr√©√© (POD, services, etc.) est simplement √©crit dans la base de donn√©es.  Cette base de donn√©es est mise en ≈ìuvre par ETCD, c'est-√†-dire  afin qu'il soit stable au niveau de haute disponibilit√©. <br><br>  Qu'est-ce qui vient ensuite?  Plus loin, sous chaque type de ressources, il y a un certain contr√¥leur.  Il s'agit simplement d'un service qui surveille son type de ressource et fait quelque chose dans le monde ext√©rieur.  Par exemple, un Docker s'ex√©cute-t-il?  Si nous avons des POD, pour chaque n≈ìud, il existe un service kubelet qui surveille les POD connect√©s √† ce n≈ìud.  Et tout ce qu'il fait est Docker ex√©cut√© apr√®s le prochain contr√¥le p√©riodique si ce POD n'est pas l√†. <br><br>  De plus, ce qui est tr√®s important - tout se passe en temps r√©el, donc la puissance de ce contr√¥leur est sup√©rieure au minimum.  Souvent, le contr√¥leur prend toujours les mesures et regarde ce qu'il a commenc√©.  C'est-√†-dire  supprime les commentaires du monde r√©el et les √©crit dans la base de donn√©es, afin que vous ou d'autres contr√¥leurs puissiez les voir.  Par exemple, le m√™me statut POD sera r√©√©crit dans ETCD. <br><br>  Ainsi, tout est impl√©ment√© dans Kubernetes.  C'est tr√®s cool que le mod√®le d'information soit s√©par√© de la salle d'op√©ration.  Dans la base de donn√©es via l'interface CRUD habituelle, nous d√©clarons ce qui devrait √™tre.  Ensuite, l'ensemble des contr√¥leurs essaie de tout arranger.  Certes, cela ne se produit pas toujours. <br><br>  Il s'agit d'un mod√®le cybern√©tique.  Nous avons un certain pr√©r√©glage, il y a une sorte de machine qui essaie de diriger le monde r√©el ou la machine √† l'endroit qui est n√©cessaire.  Cela ne se passe pas toujours comme ceci: nous devrions avoir une boucle de r√©troaction.  Parfois, une machine ne peut pas faire cela et doit se tourner vers une personne. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/59e/0a9/1e8/59e0a91e8974351a5f0f49fd94709c9a.png"><br><br>  Dans les syst√®mes r√©els, nous pensons en abstractions du niveau suivant: nous avons des services, des bases de donn√©es et nous les connectons tous.  Nous ne pensons pas aux POD et aux Ingresss, et nous voulons construire un nouveau niveau d'abstraction. <br><img src="https://habrastorage.org/getpro/habr/post_images/77f/5cb/697/77f5cb6974c6ac85e0b5e8b13921d672.png"><br>  Pour que le d√©veloppeur soit le plus simple possible: pour qu'il dise simplement: ¬´Je veux d√©marrer tel ou tel service¬ª et tout le reste s'est pass√© √† l'int√©rieur. <br><br>  Il y a une telle chose comme HELM.  Ce n'est pas la bonne fa√ßon - un mod√®le de style ansible, o√π nous essayons simplement de g√©n√©rer un ensemble de ressources configur√©es et de les d√©poser dans un cluster Kubernetes. <br><br>  Le probl√®me, tout d'abord, est que cela ne se fait qu'au moment du laminage.  Autrement dit, il ne peut pas mettre en ≈ìuvre beaucoup de logique.  Deuxi√®mement, lors de l'ex√©cution, cette abstraction dispara√Æt.  Lorsque je regarde mon cluster, je ne vois que des POD et des services.  Je ne vois pas que tel ou tel service est d√©ploy√©, que telle ou telle base avec r√©plication y soit √©lev√©e.  J'y vois juste des dizaines de foyers.  L'abstraction dispara√Æt comme dans une matrice. <br><img src="https://habrastorage.org/getpro/habr/post_images/696/6e6/9bd/6966e69bd8b289229194911f62a11f84.png"><br><h2>  Mod√®le de solution interne </h2><br>  D'un autre c√¥t√©, Kubernetes lui-m√™me fournit d√©j√† un mod√®le d'extension tr√®s int√©ressant et simple √† l'int√©rieur.  Nous pouvons d√©clarer de nouveaux types de ressources, par exemple le d√©ploiement.  Il s'agit d'une ressource cr√©√©e au-dessus de POD ou d'un jeu de r√©plicas.  Nous pouvons √©crire un contr√¥leur sur cette ressource, mettre cette ressource dans la base de donn√©es et ex√©cuter notre boucle cybern√©tique pour que tout fonctionne.  Cela semble int√©ressant et il me semble que c'est la bonne fa√ßon d'√©tendre Kubernetes. <br><img src="https://habrastorage.org/getpro/habr/post_images/39e/491/c51/39e491c511ea25078eda191097d88b24.png"><br>  J'aimerais pouvoir simplement √©crire un manifeste pour mon service de style heroku.  Un exemple tr√®s simple: je veux d√©ployer une sorte d'application dans mon environnement r√©el.  Vous avez d√©j√† des accords, SSL, des domaines achet√©s.  Je voudrais juste donner aux d√©veloppeurs l'interface la plus simple possible.  Le manifeste me dit quel conteneur √† soulever, quelles ressources ce conteneur a encore besoin.  Il lance cette annonce dans le cluster, et tout commence √† fonctionner. <br><img src="https://habrastorage.org/getpro/habr/post_images/a91/24e/8a8/a9124e8a8309c952cc0a65b32f28d76f.png"><br><br>  √Ä quoi cela ressemblera-t-il en termes de ressources et de contr√¥leurs personnalis√©s?  Ici, nous aurons une application de ressources dans la base de donn√©es.  Et le contr√¥leur d'application g√©n√©rera trois ressources.  Autrement dit, il notera les r√®gles en entr√©e sur la fa√ßon de router vers ce service, d√©marrera le service pour l'√©quilibrage de charge et lancera le d√©ploiement avec une sorte de configuration. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/807/938/d22/807938d229cb312ca761214fa30829ed.png"><br><br>  Avant de cr√©er une ressource personnalis√©e dans Kubernetes, nous devons la d√©clarer.  Pour cela, il existe une m√©ta-ressource appel√©e CustomResourceDefinition. <br><br>  Pour d√©clarer une nouvelle ressource dans Kubernetes, il nous suffit de publier une telle annonce.  Consid√©rez cette table de cr√©ation. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/09e/253/7d3/09e2537d3520f688c7029a357d9773dd.png"></div><br>  Cr√©√© une table.  Apr√®s cela, nous pouvons regarder √† travers le kubectl obtenir ces ressources tierces que nous avons.  D√®s que nous l'avons annonc√©, nous avons √©galement re√ßu une banni√®re.  Nous pouvons faire, par exemple, kubeclt obtenir des applications.  Mais jusqu'√† pr√©sent, aucune application. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/d5b/c40/9ad/d5bc409ad70866a12358ccb68ba497f8.png"></div><br>  √âcrivons une application.  Apr√®s cela, nous pouvons cr√©er une instance de ressource personnalis√©e.  Examinons-le dans YAML et cr√©ons-le par courrier √† une URL sp√©cifique. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/044/e55/454/044e554549dc4dc00d262ecf49d8d72d.png"></div><br>  Si nous courons et regardons kubectl, alors une application est apparue.  Mais alors que rien ne se passe, cela r√©side simplement dans la base de donn√©es.  Vous pouvez, par exemple, prendre et demander toutes les ressources de l'application. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/701/234/74d/70123474de1bf62ece27d49587098368.png"></div><br>  Nous pouvons cr√©er une deuxi√®me ressource de ce type √† partir du m√™me mod√®le en changeant simplement le nom.  Voici la deuxi√®me ressource. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/842/a58/4b0/842a584b09631555234babcbd3c7e57c.png"></div><br>  De plus, notre contr√¥leur devrait faire des mod√®les, similaires √† ce que fait HELM.  Autrement dit, apr√®s avoir re√ßu une description de notre application, je dois g√©n√©rer un d√©ploiement de ressources et un service de ressources, ainsi que faire une entr√©e en entr√©e.  C'est la partie la plus simple: ici √† clojure se trouve erlmacro.  Je passe la structure de donn√©es, il tire la fonction de d√©ploiement, passe au d√©bogage, qui est le pipeline.  Et ceci est une fonction pure: un mod√®le simple.  En cons√©quence, sous la forme la plus na√Øve, je pouvais imm√©diatement le cr√©er, le transformer en utilitaire de console et commencer √† le distribuer. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/b33/bf5/2cb/b33bf52cbd901d2c5e0a0641daed9161.png"></div><br>  Nous faisons de m√™me pour le service: la fonction service accepte la d√©claration et g√©n√®re pour nous la ressource Kubernetes. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/c2e/daf/e7f/c2edafe7f36d7c0db4573054991c436a.png"></div><br>  Nous faisons de m√™me pour la ligne en entr√©e. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/5d0/22f/156/5d022f15612aa3dcc19f635b0dd9b403.png"></div><br>  Comment tout cela fonctionnera-t-il?  Il y aura quelque chose dans le monde r√©el et il y aura ce que nous voulons.  Ce que nous voulons - nous prenons la ressource d'application et g√©n√©rons sur elle ce qu'elle devrait √™tre.  Et maintenant, nous devons voir ce qui est.  Ce que nous demandons via l'API REST.  Nous pouvons obtenir tous les services, tous les d√©ploiements. <br><br>  Comment fonctionnera notre contr√¥leur personnalis√©?  Il recevra ce que nous voulons et ce qui est, prendre de cette div et appliquer √† Kubernetes.  Ceci est similaire √† React.  J'ai cr√©√© un DOM virtuel lorsque certaines fonctions g√©n√®rent simplement une arborescence d'objets JS.  Et puis un certain algorithme calcule le patch et l'applique au vrai DOM. <br><br>  Nous ferons de m√™me ici.  Cela se fait en 50 lignes de code.  Vous voulez - tout est sur Github.  En fin de compte, nous devrions obtenir la fonction de r√©conciliation-actions. <br><br>  Nous avons une fonction de r√©conciliation-actions qui ne fait rien et calcule simplement cette div.  Elle prend ce qui est, plus ce qui est n√©cessaire.  Et ensuite, il indique ce qui doit √™tre fait pour amener le premier au second. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/460/49b/90d/46049b90d8fa93dfe9279c02828cfa1c.png"></div><br>  Tirons-la.  Il n'y a rien de mal avec elle, elle peut √™tre affaiblie.  Elle dit que vous devez cr√©er un service d'entr√©e, y faire deux entr√©es, cr√©er un d√©ploiement 1 et 2, cr√©er un service 1 et 2. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/c72/c0a/c10/c72c0ac10e4924fde59ed749339345aa.png"></div><br>  Dans ce cas, il ne devrait d√©j√† y avoir qu'un seul service.  Nous voyons par entr√©e qu'il ne reste qu'une seule entr√©e. <br><br>  Il ne reste plus qu'√† √©crire une fonction qui applique ce patch au cluster Kubernetes.  Pour ce faire, nous passons simplement des actions de r√©conciliation √† la fonction de r√©conciliation, et tout s'appliquera.  Et maintenant, nous voyons que le POD a augment√©, le d√©ploiement est devenu et le service a commenc√©. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/66b/144/1a5/66b1441a56d805344c7e734d3b9b2c80.png"></div><br>  Ajoutons un autre service: ex√©cutez √† nouveau la fonction reconcile-actions.  Voyons ce qui s'est pass√©.  Tout a commenc√©, tout va bien. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/32a/f9f/c1e/32af9fc1e444ed1c135e4bbe828a946f.png"></div><br>  Comment y faire face?  Nous emballons tout cela dans un conteneur Docker.  Apr√®s cela, nous √©crivons une fonction qui se r√©veille p√©riodiquement, fait un rapprochement et s'endort.  La vitesse n'est pas tr√®s importante, elle peut dormir pendant cinq secondes et effectuer des actions de r√©conciliation moins souvent. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/bec/04e/8d1/bec04e8d1791843d80aed4f2b3f2a673.png"></div><br>  Notre contr√¥leur personnalis√© n'est qu'un service qui se r√©veillera et calculera p√©riodiquement le patch. <br><br>  Maintenant, nous avons deux services zaddeloino, supprimons l'une des applications.  Voyons comment notre cluster a r√©agi: tout va bien.  Nous supprimons le second: tout est effac√©. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/5ff/a23/96e/5ffa2396ef22187604393a9ae657edd5.png"></div><br>  Voyons √† travers les yeux du d√©veloppeur.  Il lui suffit de dire que Kubernetes postule et nomme le nouveau service.  Nous le faisons, notre contr√¥leur a tout ramass√© et l'a cr√©√©. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/bd6/ca6/3d7/bd6ca63d77dfbadee1587b6f44a680bd.png"></div><br>  Ensuite, nous collectons tout cela dans un service de d√©ploiement, et nous jetons ce contr√¥leur personnalis√© dans le cluster √† l'aide des outils standard de Kubernetes.  Nous avons cr√©√© une abstraction pour 200 lignes de code. <br><br>  Tout cela ressemble √† HELM, mais en fait plus puissant.  Le contr√¥leur fonctionne en cluster: il voit la base, voit le monde ext√©rieur et peut √™tre rendu suffisamment intelligent. <br><br><h2>  Propre CI </h2><br>  Consid√©rez les exemples d'extension Kubernetes.  Nous avons d√©cid√© que CI devrait faire partie de l'infrastructure.  C'est bien, c'est pratique du point de vue de la s√©curit√© - un r√©f√©rentiel priv√©.  Nous avons essay√© d'utiliser jenkins, mais c'est un outil obsol√®te.  Je voulais un pirate informatique CI.  Nous n'avons pas besoin d'interfaces, nous adorons ChatOps: laissez-le simplement dire dans le chat si la version est tomb√©e ou non.  De plus, je voulais tout d√©boguer localement. <br><img src="https://habrastorage.org/getpro/habr/post_images/9a4/ecf/86e/9a4ecf86e022a465ce11072352456728.png"><br>  Nous nous sommes assis et avons √©crit notre CI en une semaine.  Tout comme une extension de Kubernetes.  Si vous pensez √† CI, alors ce n'est qu'un outil qui ex√©cute une sorte de travail.  Dans le cadre de ce travail, nous construisons quelque chose, ex√©cutons des tests et d√©ployons souvent. <br><br>  Comment √ßa marche?  Il est construit sur le m√™me concept de contr√¥leurs personnalis√©s.<font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tout d'abord, nous d√©posons dans Kubernetes une description des r√©f√©rentiels que nous suivons. Le contr√¥leur va juste √† github et ajoute web-hook. Nous avons encore de l'introspection. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Vient ensuite le hook Web, dont la seule t√¢che est de traiter le JSON entrant et de le d√©poser dans une ressource de construction personnalis√©e, qui s'ajoute √©galement √† la base de donn√©es Kubernetes. La ressource de g√©n√©ration est surveill√©e par le contr√¥leur de g√©n√©ration, qui lit le manifeste √† l'int√©rieur du projet et lance le POD. Dans ce POD, tous les services n√©cessaires sont lanc√©s. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dans POD, un agent tr√®s simple qui lit une d√©claration dans le style de travis ou circleci, et dans YAML, un ensemble d'√©tapes. Il commence √† les remplir. Puis √† la fin de la construction, il lance son r√©sultat dans Telegram.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Une autre fonctionnalit√© que nous avons obtenue avec Kubernetes est que l'une des commandes lors de l'ex√©cution de votre CI ou de la livraison continue peut √™tre d√©finie simplement pendant la mise en veille r√©elle 10, et votre POD se figera √† cette √©tape. </font><font style="vertical-align: inherit;">Vous ex√©cutez kubectl, vous vous trouvez dans votre build et vous pouvez d√©buter. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Autre fonctionnalit√© - tout est construit sur des dockers et vous pouvez d√©boguer le script localement en lan√ßant le docker. </font><font style="vertical-align: inherit;">Tout cela a pris deux semaines et 300 lignes de code.</font></font><br><br><img src="https://habrastorage.org/getpro/habr/post_images/72f/334/ec3/72f334ec33db75d3b32e4c464a24dc03.png"><br><br><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Travailler avec PostgreSQL </font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Notre produit est construit sur des postgres, nous utilisons toutes sortes de fonctionnalit√©s int√©ressantes. Nous avons m√™me √©crit un certain nombre d'extensions. Mais nous ne pouvons pas utiliser RDS ou autre chose. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nous sommes en train de d√©velopper un op√©rateur pour un postgres indestructible. Je vais sonner l'architecture. Je veux dire: "Cluster, donnez-moi un postgres qui ne peut pas √™tre tu√©." Ajoutez √† cela que j'ai besoin de deux r√©pliques asynchrones, une synchrone, des sauvegardes quotidiennes et jusqu'√† un t√©raoctet. Je lance tout cela, puis mon contr√¥leur de cluster commence √† faire de l'orchestration et √† √©tendre mon conteneur. Il cr√©e des ressources pginstance qui sont responsables de chaque istor postgres. Ce seront des postgres de cluster.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">En outre, le contr√¥leur de pginstance, assez simple, essaie simplement d'ex√©cuter POD ou de s'y d√©ployer avec ces postgres. Le c≈ìur est un volume persistant. Toute cette machine prend le contr√¥le total des postgres. Vous lui donnez un Docker-container, qui ne contient que des postgres binaires. Tout le reste: le contr√¥leur lui-m√™me fait la configuration et la cr√©ation du cluster de d√©marrage postgres. Il le fait pour que nous puissions reconfigurer plus tard, et pour qu'il puisse configurer la r√©plication, les niveaux de journalisation, etc. Au d√©but, le POD temporaire s'ex√©cute sur le volume persistant et y cr√©e un cluster postgres pour le ma√Ætre. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ensuite, en plus de cela, le d√©ploiement commence par ma√Ætre. Ensuite, un volume persistant est cr√©√© de la m√™me mani√®re. Un autre POD passe au travers, effectue une sauvegarde de base, la tire et, en plus de cela, le d√©ploiement commence par un esclave.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ensuite, le contr√¥leur de cluster cr√©e une ressource de sauvegarde (apr√®s avoir √©t√© d√©crite avec les sauvegardes). Et le contr√¥leur de sauvegarde le prend d√©j√† et le jette dans un S3.</font></font><br><br><img src="https://habrastorage.org/getpro/habr/post_images/972/b42/457/972b42457c664d988fd8eeee0aaa603c.png"><br><br><h2>  Et ensuite? </h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Laissez-nous vous pr√©senter le futur proche. Il peut arriver que t√¥t ou tard nous ayons des ressources personnalis√©es si int√©ressantes, des contr√¥leurs personnalis√©s que je dirai "Donnez-moi des postgres, donnez-moi du kafka, laissez-moi CI et commencez tout." Tout sera simple. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Si nous ne parlons pas du futur proche, alors, en tant que programmeur d√©claratif, je pense que seule la programmation logique ou relationnelle est sup√©rieure √† la programmation fonctionnelle. L√†, notre s√©mantique des op√©rations est compl√®tement distincte de la s√©mantique de l'information. Si nous examinons attentivement nos contr√¥leurs personnalis√©s que nous avons cr√©√©s, nous avons, par exemple, une application de ressources dans notre base de donn√©es. Et nous en tirons trois autres ressources suppl√©mentaires. Ceci est tr√®s similaire √† la vue de la base de donn√©es. Ceci est une constatation des faits. Il s'agit d'une vue logique ou relationnelle.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La prochaine √©tape pour Kubernetes est de donner une certaine illusion d'une base relationnelle ou logique au lieu d'une API REST hach√©e, o√π vous pouvez simplement √©crire une r√®gle. T√¥t ou tard, tout circule dans la base de donn√©es, y compris les commentaires, les r√®gles peuvent ressembler √† ceci: "Si la charge a augment√© comme √ßa, alors augmentez la r√©plication comme √ßa." Nous aurons un petit sql ou une r√®gle logique. Tout ce dont vous avez besoin est un moteur g√©n√©rique qui suivra. Mais c'est un brillant avenir.</font></font><br><img src="https://habrastorage.org/getpro/habr/post_images/fb4/f1e/930/fb4f1e930029011d081eeb911203d289.png"><br><br><blockquote>    ‚Äî   <b>DevOops 2018</b> !     ‚Äî  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="></a> . <br><br>        <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">¬´The DevOps Handbook¬ª</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">¬´Learning Chef: A Guide to Configuration Management and Automation¬ª</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">¬´How to containerize your Go code¬ª</a>   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">¬´Liquid Software: How to Achieve Trusted Continuous Updates in the DevOps World¬ª</a> ‚Äî      .         -    . <br><br>  :       <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="> </a> ! <br><br>    : <b> 1 </b> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Vous</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> pouvez r√©server un </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;">billet</font></a><font style="vertical-align: inherit;"> pour DevOops 2018 √† prix r√©duit.</font></font></blockquote></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr424609/">https://habr.com/ru/post/fr424609/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr424599/index.html">Vous devez choisir le logiciel dont vous avez besoin: √©crit √† temps ou de haute qualit√©</a></li>
<li><a href="../fr424601/index.html">Architecture de l'information sur Internet partie 1</a></li>
<li><a href="../fr424603/index.html">Le livre ¬´Pourquoi avons-nous tort. Penser les pi√®ges en action. Extraits Partie 1</a></li>
<li><a href="../fr424605/index.html">Fonds Zuckerberg: collaboration + technologie + science ouverte</a></li>
<li><a href="../fr424607/index.html">La mont√©e d'H√©lidon</a></li>
<li><a href="../fr424611/index.html">Comment cr√©er un employ√© √† partir d'un pigiste</a></li>
<li><a href="../fr424613/index.html">Exp√©rience de l'utilisation de redux sans r√©ducteurs</a></li>
<li><a href="../fr424615/index.html">Sortie de fonction de courbe pour limiter en douceur les param√®tres, les signaux et pas seulement dans Wolfram Mathematica</a></li>
<li><a href="../fr424621/index.html">Super-h√©ros non-film. Qui et comment prot√®ge le chantier de construction du centre de Lakhta contre les incendies?</a></li>
<li><a href="../fr424623/index.html">Traitons le son sur Go</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>