<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üñïüèΩ ü§ôüèº üßï Caract√©ristiques des appels de fonction en C ++ üñêüèø üë®‚Äçüë®‚Äçüëß üë©üèº‚Äç‚úàÔ∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Il n'y a pas si longtemps, j'ai eu une autre conversation avec un coll√®gue sur un sujet √©ternel: ¬´par r√©f√©rence ou par valeur¬ª. En cons√©quence, cet ar...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Caract√©ristiques des appels de fonction en C ++</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/414443/"><p>  Il n'y a pas si longtemps, j'ai eu une autre conversation avec un coll√®gue sur un sujet √©ternel: ¬´par r√©f√©rence ou par valeur¬ª.  En cons√©quence, cet article a surgi.  Dans ce document, je veux pr√©senter les r√©sultats de mes recherches sur ce sujet et sur des sujets connexes.  Le prochain sera consid√©r√©: </p><br><ul><li>  Les registres et leur fonction lors de l'appel de fonctions. </li><li>  Transfert et retour de types et structures simples. </li><li>  Comment le passage par r√©f√©rence et par valeur affecte l'optimisation du corps de fonction par le compilateur. </li><li>  Comment l'espace est utilis√© dans plusieurs appels de fonction. </li><li>  Le m√©canisme des appels virtuels. </li><li>  Optimisation des appels de queue et de la r√©cursivit√©. </li><li>  Initialisation des structures, des tableaux et des vecteurs. </li></ul><br><p> Attention  L'article contient une grande quantit√© de code C ++ et d'assembleur ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Intel ASM</a> avec commentaires), ainsi que de nombreux tableaux avec des notes de performances.  Tout ce qui est √©crit est pertinent pour <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><em>x86-64 System V ABI</em></a> , qui est utilis√© dans tous les syst√®mes d'exploitation Unix modernes, par exemple, Linux et macOS. </p><a name="habracut"></a><br><p> Les informations proviennent du document <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Interface binaire d'application System V pour x86-64</a> .  Les listes d'assembleurs ont √©t√© obtenues pour <em>clang 5.0.0 x86-64</em> avec les drapeaux <code>-O3 -std=c++1z -march=sandybridge</code> (en utilisant le site <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">https://godbolt.org</a> ).  Les cotes de performances ont √©t√© √©tablies pour le <em>processeur Intel¬Æ Xeon¬Æ E5-2660 2,20 GHz</em> . </p><br><h2 id="soderzhanie">  Table des mati√®res </h2><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Table des mati√®res</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Registres en x86-64</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Passer des param√®tres</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Exemples simples</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Passer par lien</a> <br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Comparaison des performances</a> </li></ul></li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Pointeurs transparents</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">R√©utiliser la pile</a> <br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Comparaison des performances</a> </li></ul></li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Type facultatif</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Fonctions virtuelles</a> <br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Comparaison des performances</a> </li></ul></li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Appels de queue</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Initialisation</a> <br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Un article</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Petit tableau</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Large gamme</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Tableau dynamique</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Comparaison des performances</a> </li></ul></li></ul><br><h2 id="registry-v-x86-64">  Registres en x86-64 </h2><br><p>  Toutes les donn√©es sont stock√©es dans la RAM.  Pour acc√©l√©rer le travail avec elle, des caches √† plusieurs niveaux sont utilis√©s.  Mais pour modifier les donn√©es, d'une mani√®re ou d'une autre, des registres sont utilis√©s ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">discussion dans les commentaires</a> ).  Vous trouverez ci-dessous une br√®ve description des registres les plus utilis√©s dans l'architecture x86-64. </p><br><ul><li>  16 registres √† usage g√©n√©ral: <code>rax, rbx, rcx, rdx, rbp, rsi, rdi, rsp</code> et √©galement <code>r8-r15</code> .  La taille de chacun d'eux est de 64 bits (8 octets).  Pour acc√©der aux 32 bits inf√©rieurs (4 octets), le pr√©fixe <code>e</code> place de <code>r</code> ( <code>rax</code> ‚Üí <code>eax</code> ).  Seules les op√©rations enti√®res non vectorielles sont prises en charge. </li><li>  <code>rip</code> (pointeur d'instruction) indique l'instruction √† ex√©cuter ensuite.  Diverses donn√©es constantes se trouvant dans la section m√©moire avec des instructions peuvent √™tre lues avec un d√©calage par rapport √† la <code>rip</code> . </li><li>  <code>rsp</code> (pointeur de pile) pointe vers le dernier √©l√©ment de la pile.  La pile se d√©veloppe vers des adresses inf√©rieures.  Pousser quelque chose sur la pile <strong>r√©duit</strong> la valeur <code>rsp</code> . </li><li>  16 registres SSE de 128 bits: <code>xmm0 - xmm15</code> .  Si le mode <code>AVX</code> est pris en charge, ils se r√©f√®rent aux 128 bits <code>ymm0 - ymm15</code> chacun ayant une taille de 256 bits.  Pour les op√©rations vectorielles ou non enti√®res, les donn√©es doivent d'abord √™tre charg√©es dans ces registres. </li></ul><br><h2 id="peredacha-parametrov">  Passer des param√®tres </h2><br><p>  Cette section fournit une description quelque peu abr√©g√©e et simplifi√©e de l'algorithme de distribution des arguments entre les registres / piles.  Pour une description compl√®te, voir P. 17 "Syst√®me V ABI". </p><br><p>  Nous introduisons plusieurs classes d'objets: </p><br><ul><li>  <strong>INTEGER</strong> - Types int√©graux plac√©s dans les registres g√©n√©raux.  Ce sont <code>bool</code> , <code>char</code> , <code>int</code> et ainsi de suite. </li><li>  <strong>SSE</strong> sont des nombres √† virgule flottante qui s'inscrivent dans un registre vectoriel.  Ce sont des <code>float</code> et des <code>double</code> . </li><li>  <strong>MEMORY</strong> - les objets ont travers√© la pile. </li></ul><br><p>  Pour unifier la description, les types <code>__int128</code> et <code>complex</code> <code>__int128</code> repr√©sent√©s comme des structures de deux champs: </p><br><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> __</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int128</span></span></span><span class="hljs-class"> {</span></span> int64 low, high; }; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">complexT</span></span></span><span class="hljs-class"> {</span></span> T real, imag; }; <span class="hljs-comment"><span class="hljs-comment">//  T - float,  double.</span></span></code> </pre> <br><p>  Au d√©but, chaque argument de fonction est class√©: </p><br><ol><li>  Si le type est sup√©rieur √† 128 bits ou a des champs non align√©s, il s'agit de <strong>MEMORY</strong> . </li><li>  S'il existe un destructeur non trivial, un constructeur de copie, des m√©thodes virtuelles, des classes de base virtuelles, il est alors transmis via un "lien transparent".  L'objet est remplac√© par un pointeur de type <strong>INTEGER</strong> . </li><li>  Les agr√©gats, et ce sont des structures et des tableaux, sont analys√©s en morceaux de <strong>8 octets</strong> . <br><ol><li>  S'il y a un champ de type <strong>MEMORY</strong> dans la pi√®ce, alors la pi√®ce enti√®re est <strong>MEMORY</strong> . </li><li>  S'il y a un champ de type <strong>INTEGER</strong> , alors la pi√®ce enti√®re est <strong>INTEGER</strong> . </li><li>  Sinon, tout le morceau de <strong>SSE</strong> . </li></ol></li><li>  S'il y a un morceau de type <strong>MEMORY</strong> , alors l'argument entier est <strong>MEMORY</strong> . </li><li>  Les types <code>long double</code> et <code>long double</code> <code>complex long double</code> utilisent un ensemble sp√©cial de registres <code>x87 FPU</code> et sont du type <strong>MEMORY</strong> . </li><li>  Les <code>__m256</code> , <code>__m128</code> et <code>__float128</code> sont de type <strong>SSE</strong> . </li></ol><br><p>  Apr√®s la classification, tous les blocs de <strong>8 octets</strong> (dans un bloc, il peut y avoir plusieurs champs de la structure ou √©l√©ments de tableau) sont r√©partis dans des registres: </p><br><ol><li>  <strong>Les M√âMOIRES</strong> passent par la pile. </li><li>  <strong>Les ENTIERS</strong> sont transmis via le prochain registre libre <code>rdi, rsi, rdx, rcx, r8, r9</code> dans cet ordre. </li><li>  <strong>Les SSE</strong> sont transmises via le registre libre suivant <code>xmm0 - xmm7</code> . </li></ol><br><p>  Les arguments sont consid√©r√©s de gauche √† droite.  Les arguments qui n'avaient pas suffisamment de registres sont pass√©s √† travers la pile.  Si une partie de l'argument n'avait pas de registre, alors l'argument entier est pass√© √† travers la pile. </p><br><p>  Les valeurs de retour sont les suivantes: </p><br><ol><li>  <strong>Les</strong> types <strong>MEMORY</strong> sont retourn√©s via la pile.  La place est fournie par la fonction appelante et l'adresse de son d√©but est pass√©e par <code>rdi</code> comme si c'√©tait le premier argument de la fonction.  Au retour, cette adresse doit √™tre retourn√©e via <code>rax</code> .  Le premier argument d'origine sera transmis, respectivement, comme le deuxi√®me, et ainsi de suite. </li><li>  <strong>Le</strong> bloc <strong>INTEGER</strong> est renvoy√© via le prochain registre libre <code>rax, rdx</code> . </li><li>  <strong>Le</strong> bloc <strong>SSE</strong> est renvoy√© via le registre libre suivant <code>xmm0, xmm1</code> .  Ces registres sont utilis√©s √† la fois pour recevoir et pour renvoyer des valeurs. </li></ol><br><p>  Un tableau crois√© dynamique avec des registres et leur fonction est tr√®s utile lors de la lecture de l'assembleur: </p><br><table><thead><tr><th>  S'inscrire </th><th>  Rendez-vous </th></tr></thead><tbody><tr><td> <code>rax</code> </td> <td>  Registre temporaire, retourne le premier r√©sultat (ret 1) <strong>INTEGER</strong> . </td></tr><tr><td> <code>rbx</code> </td> <td>  Appartient √† la fonction appelante, ne doit pas √™tre modifi√©e au moment du retour. </td></tr><tr><td> <code>rcx</code> </td> <td>  Passer le quatri√®me (4) argument <strong>INTEGER</strong> . </td></tr><tr><td> <code>rdx</code> </td> <td>  Passage du troisi√®me (3) argument <strong>INTEGER</strong> , retour du deuxi√®me r√©sultat (ret 2) <strong>INTEGER</strong> . </td></tr><tr><td> <code>rsp</code> </td> <td>  Pointeur vers la pile. </td></tr><tr><td> <code>rbp</code> </td> <td>  Appartient √† la fonction appelante, ne doit pas √™tre modifi√©e au moment du retour. </td></tr><tr><td> <code>rsi</code> </td> <td>  Passer le deuxi√®me (2) argument <strong>INTEGER</strong> . </td></tr><tr><td> <code>rdi</code> </td> <td>  Passer le premier (1) argument <strong>INTEGER</strong> . </td></tr><tr><td> <code>r8</code> </td> <td>  Passer le cinqui√®me (5) argument <strong>INTEGER</strong> . </td></tr><tr><td> <code>r9</code> </td> <td>  Passer le sixi√®me (6) argument <strong>INTEGER</strong> . </td></tr><tr><td> <code>r10-r11</code> </td> <td>  Registres temporaires. </td></tr><tr><td> <code>r12-r15</code> </td> <td>  Appartient √† la fonction appelante, ne doit pas √™tre modifi√©e au moment du retour. </td></tr><tr><td> <code>xmm0-xmm1</code> </td> <td>  Passez et renvoyez les premier et deuxi√®me arguments <strong>SSE</strong> . </td></tr><tr><td> <code>xmm2-xmm7</code> </td> <td>  Passer les troisi√®me √† sixi√®me arguments <strong>SSE</strong> . </td></tr><tr><td> <code>xmm8-xmm15</code> </td> <td>  Registres temporaires. </td></tr></tbody></table><br><p>  Les registres appartenant √† la fonction appelante ne doivent pas √™tre utilis√©s ou leurs valeurs doivent √™tre stock√©es quelque part, par exemple sur la pile, puis restaur√©es. </p><br><h2 id="prostye-primery">  Exemples simples </h2><br><p>  Sauf indication contraire explicite, toutes les fonctions utilis√©es ont √©t√© marqu√©es comme <code>NOINLINE</code> .  Nous pr√©tendons que le corps de la fonction se trouve dans le fichier cpp et que LTO est d√©sactiv√©.  De plus, tous les r√©sultats de fonction sont transf√©r√©s vers une fonction <code>NOINLINE</code> vide pour emp√™cher l'optimiseur de supprimer tout le code. </p><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> NOINLINE __attribute__((noinline)) #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> INLINE static __attribute__((always_inline))</span></span></code> </pre> <br><p>  Consid√©rez quelque chose de simple. </p><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">double</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">foo</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int8_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> a, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int16_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> b, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int32_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> c, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int64_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> d, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params"> x, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">double</span></span></span></span><span class="hljs-function"><span class="hljs-params"> y)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> a + b + c + d + x + y; } ... <span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> result = foo(<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-number"><span class="hljs-number">3</span></span>, <span class="hljs-number"><span class="hljs-number">4</span></span>, <span class="hljs-number"><span class="hljs-number">5</span></span>, <span class="hljs-number"><span class="hljs-number">6</span></span>);</code> </pre> <br><p>  Les param√®tres sont pass√©s comme ceci: </p><br><table><thead><tr><th>  Pr√©nom </th><th>  S'inscrire </th><th>  Pr√©nom </th><th>  S'inscrire </th><th>  R√©sultat </th></tr></thead><tbody><tr><td>  <strong>un</strong> </td><td> <code>rdi</code> </td> <td>  <strong>d</strong> </td><td> <code>rcx</code> </td> <td> <code>xmm0</code> </td> </tr><tr><td>  <strong>b</strong> </td><td> <code>rsi</code> </td> <td>  <strong>x</strong> </td><td> <code>xmm0</code> </td> <td></td></tr><tr><td>  <strong>c</strong> </td><td> <code>rdx</code> </td> <td>  <strong>y</strong> </td><td> <code>xmm1</code> </td> <td></td></tr></tbody></table><br><p>  Consid√©rez le code g√©n√©r√© plus en d√©tail. </p><br><pre> <code class="hljs pgsql">foo(signed <span class="hljs-type"><span class="hljs-type">char</span></span>, short, <span class="hljs-type"><span class="hljs-type">int</span></span>, long, <span class="hljs-type"><span class="hljs-type">float</span></span>, <span class="hljs-type"><span class="hljs-type">double</span></span>): <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> edi, esi #  a  b. <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> edi, edx #  c. movsxd rax, edi #    rax,    <span class="hljs-number"><span class="hljs-number">64</span></span>    . <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> rax, rcx #  d. vcvtsi2ss xmm2, xmm2, rax #    <span class="hljs-type"><span class="hljs-type">float</span></span>     xmm2. vaddss xmm0, xmm2, xmm0 #  x,  <span class="hljs-string"><span class="hljs-string">'s'</span></span>  vaddss    single <span class="hljs-type"><span class="hljs-type">precision</span></span>. vcvtss2sd xmm0, xmm0, xmm0 #    <span class="hljs-type"><span class="hljs-type">double</span></span>. vaddsd xmm0, xmm0, xmm1 #  y,  <span class="hljs-string"><span class="hljs-string">'d'</span></span>  vaddsd    <span class="hljs-type"><span class="hljs-type">double</span></span> <span class="hljs-type"><span class="hljs-type">precision</span></span>. ret #       ,    ,    ,   rsp   <span class="hljs-number"><span class="hljs-number">8.</span></span> .LCPI1_0: #    . .long <span class="hljs-number"><span class="hljs-number">1084227584</span></span> # <span class="hljs-type"><span class="hljs-type">float</span></span> <span class="hljs-number"><span class="hljs-number">5</span></span> .LCPI1_1: .quad <span class="hljs-number"><span class="hljs-number">4618441417868443648</span></span> # <span class="hljs-type"><span class="hljs-type">double</span></span> <span class="hljs-number"><span class="hljs-number">6</span></span> main: # @main sub rsp, <span class="hljs-number"><span class="hljs-number">24</span></span> #     . vmovss xmm0, dword ptr [rip + .LCPI1_0] # xmm0 = mem[<span class="hljs-number"><span class="hljs-number">0</span></span>],zero,zero,zero vmovsd xmm1, qword ptr [rip + .LCPI1_1] # xmm1 = mem[<span class="hljs-number"><span class="hljs-number">0</span></span>],zero mov edi, <span class="hljs-number"><span class="hljs-number">1</span></span> mov esi, <span class="hljs-number"><span class="hljs-number">2</span></span> mov edx, <span class="hljs-number"><span class="hljs-number">3</span></span> mov ecx, <span class="hljs-number"><span class="hljs-number">4</span></span> <span class="hljs-keyword"><span class="hljs-keyword">call</span></span> foo(signed <span class="hljs-type"><span class="hljs-type">char</span></span>, short, <span class="hljs-type"><span class="hljs-type">int</span></span>, long, <span class="hljs-type"><span class="hljs-type">float</span></span>, <span class="hljs-type"><span class="hljs-type">double</span></span>) # <span class="hljs-keyword"><span class="hljs-keyword">call</span></span>      ,    rsp  <span class="hljs-number"><span class="hljs-number">8</span></span>,      . vmovsd qword ptr [rsp + <span class="hljs-number"><span class="hljs-number">16</span></span>], xmm0 #     .</code> </pre> <br><p>  Si vous transmettez des param√®tres de types simples √† une fonction, vous devez vous efforcer afin qu'ils ne soient pas pass√©s par les registres. </p><br><p>  Consid√©rez divers exemples d'agr√©gats.  Les tableaux peuvent √™tre consid√©r√©s comme des structures √† plusieurs champs. </p><br><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">St</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">double</span></span> a, b; }; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">double</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">foo</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(St s)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> sa + sb; } ... St s{<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>}; <span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> result = foo(s);</code> </pre> <br><table><thead><tr><th>  Pr√©nom </th><th>  S'inscrire </th><th>  Pr√©nom </th><th>  S'inscrire </th><th>  R√©sultat </th></tr></thead><tbody><tr><td>  <strong>sa</strong> </td><td> <code>xmm0</code> </td> <td>  <strong>sb</strong> </td><td> <code>xmm1</code> </td> <td> <code>xmm0</code> </td> </tr></tbody></table><br><p>  Il semblerait que rien n'emp√™che de pousser deux <code>double</code> dans un registre <code>xmm</code> √† la fois.  Mais h√©las, l'algorithme de distribution ne fonctionne que sur des blocs de huit octets. </p><br><pre> <code class="hljs pgsql">foo(St): # @foo(St) vaddsd xmm0, xmm0, xmm1 #     ,       . ret .LCPI1_0: .quad <span class="hljs-number"><span class="hljs-number">4607182418800017408</span></span> # <span class="hljs-type"><span class="hljs-type">double</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> .LCPI1_1: .quad <span class="hljs-number"><span class="hljs-number">4611686018427387904</span></span> # <span class="hljs-type"><span class="hljs-type">double</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span> main: # @main sub rsp, <span class="hljs-number"><span class="hljs-number">24</span></span> #   . vmovsd xmm0, qword ptr [rip + .LCPI1_0] # xmm0 = mem[<span class="hljs-number"><span class="hljs-number">0</span></span>],zero vmovsd xmm1, qword ptr [rip + .LCPI1_1] # xmm1 = mem[<span class="hljs-number"><span class="hljs-number">0</span></span>],zero <span class="hljs-keyword"><span class="hljs-keyword">call</span></span> foo(St) vmovsd qword ptr [rsp + <span class="hljs-number"><span class="hljs-number">16</span></span>], xmm0 #  <span class="hljs-type"><span class="hljs-type">double</span></span>    .</code> </pre> <br><p>  Si vous ajoutez un autre champ <code>double</code> , la structure enti√®re sera transmise √† la pile, car sa taille d√©passera 128 octets. </p><br><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">St</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">double</span></span> a, b, c; }; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">double</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">foo</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(St s)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> sa + sb + sc; } ... St s{<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-number"><span class="hljs-number">3</span></span>}; <span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> result = foo(s);</code> </pre> <br><pre> <code class="hljs pgsql">foo(St): # @foo(St) #   ,    <span class="hljs-number"><span class="hljs-number">8</span></span> ,     .        ,         rsp+<span class="hljs-number"><span class="hljs-number">8.</span></span> vmovsd xmm0, qword ptr [rsp + <span class="hljs-number"><span class="hljs-number">8</span></span>] # xmm0 = mem[<span class="hljs-number"><span class="hljs-number">0</span></span>],zero vaddsd xmm0, xmm0, qword ptr [rsp + <span class="hljs-number"><span class="hljs-number">16</span></span>] vaddsd xmm0, xmm0, qword ptr [rsp + <span class="hljs-number"><span class="hljs-number">24</span></span>] ret .L_ZZ4mainE1s: .quad <span class="hljs-number"><span class="hljs-number">4607182418800017408</span></span> # <span class="hljs-type"><span class="hljs-type">double</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> .quad <span class="hljs-number"><span class="hljs-number">4611686018427387904</span></span> # <span class="hljs-type"><span class="hljs-type">double</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span> .quad <span class="hljs-number"><span class="hljs-number">4613937818241073152</span></span> # <span class="hljs-type"><span class="hljs-type">double</span></span> <span class="hljs-number"><span class="hljs-number">3</span></span> main: # @main sub rsp, <span class="hljs-number"><span class="hljs-number">40</span></span> #    <span class="hljs-number"><span class="hljs-number">40</span></span> . #       ,    .      ,   mov       . mov rax, qword ptr [rip + .L_ZZ4mainE1s+<span class="hljs-number"><span class="hljs-number">16</span></span>] #    <span class="hljs-string"><span class="hljs-string">'3'</span></span>. mov qword ptr [rsp + <span class="hljs-number"><span class="hljs-number">16</span></span>], rax #  <span class="hljs-string"><span class="hljs-string">'3'</span></span>  . vmovups xmm0, xmmword ptr [rip + .L_ZZ4mainE1s] #   xmm0  <span class="hljs-string"><span class="hljs-string">'1'</span></span>  <span class="hljs-string"><span class="hljs-string">'2'</span></span>. vmovups xmmword ptr [rsp], xmm0 #  <span class="hljs-string"><span class="hljs-string">'1'</span></span>  <span class="hljs-string"><span class="hljs-string">'2  .    : 1 = *rsp , 2 = *(rsp+8), 3 = *(rsp+16). call foo(St) vmovsd qword ptr [rsp + 32], xmm0 #     double  .</span></span></code> </pre> <br><p>  Voyons ce qui se passe si nous rempla√ßons <code>double</code> par <code>uint64_t</code> . </p><br><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">St</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">uint64_t</span></span> a, b; }; <span class="hljs-keyword"><span class="hljs-keyword">uint64_t</span></span> foo(St s) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> sa + sb; } ... St s{<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>}; <span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> result = foo(s);</code> </pre> <br><table><thead><tr><th>  Pr√©nom </th><th>  S'inscrire </th><th>  Pr√©nom </th><th>  S'inscrire </th><th>  R√©sultat </th></tr></thead><tbody><tr><td>  <strong>sa</strong> </td><td> <code>rdi</code> </td> <td>  <strong>sb</strong> </td><td> <code>rsi</code> </td> <td> <code>rax</code> </td> </tr></tbody></table><br><pre> <code class="hljs kotlin">foo(St): # <span class="hljs-meta"><span class="hljs-meta">@foo(St)</span></span> lea rax, [rdi + rsi] ret main: # <span class="hljs-meta"><span class="hljs-meta">@main</span></span> sub rsp, <span class="hljs-number"><span class="hljs-number">24</span></span> mov edi, <span class="hljs-number"><span class="hljs-number">1</span></span> mov esi, <span class="hljs-number"><span class="hljs-number">2</span></span> call foo(St) mov qword ptr [rsp + <span class="hljs-number"><span class="hljs-number">16</span></span>], rax</code> </pre> <br><p>  Le r√©sultat est nettement plus compact.  Plus d'informations sur la raison pour laquelle l'instruction <code>lea</code> est utilis√©e plut√¥t que sur <code>add</code> peuvent √™tre lues, par exemple, ici: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">https://stackoverflow.com/a/6328441/1418863</a> </p><br><p>  Si vous ajoutez un autre champ, alors, comme dans l'exemple avec <code>double</code> , la structure sera pass√©e √† travers la pile.  Au fait, le code sera presque identique, m√™me le chargement sur la pile se fera via des registres <code>xmm</code> . </p><br><p>  Consid√©rez quelque chose de plus int√©ressant. </p><br><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">St</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> a, b, c, d; }; <span class="hljs-function"><span class="hljs-function">St </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">foo</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(St s1, St s2)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> {s1.a + s2.a, s1.b + s2.b, s1.c + s2.c, s1.d + s2.d}; } ... St s1{<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-number"><span class="hljs-number">3</span></span>, <span class="hljs-number"><span class="hljs-number">4</span></span>}, s2{<span class="hljs-number"><span class="hljs-number">5</span></span>, <span class="hljs-number"><span class="hljs-number">6</span></span>, <span class="hljs-number"><span class="hljs-number">7</span></span>, <span class="hljs-number"><span class="hljs-number">8</span></span>}; <span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> result = foo(s1, s2);</code> </pre> <br><table><thead><tr><th>  Pr√©nom </th><th>  S'inscrire </th><th>  Pr√©nom </th><th>  S'inscrire </th><th>  R√©sultat </th></tr></thead><tbody><tr><td>  <strong>s1.a</strong> </td><td> <code>xmm0</code> </td> <td>  <strong>s1.b</strong> </td><td> <code>xmm0</code> </td> <td> <code>xmm0, xmm1</code> </td> </tr><tr><td>  <strong>s1.c</strong> </td><td> <code>xmm1</code> </td> <td>  <strong>s1.d</strong> </td><td> <code>xmm1</code> </td> <td></td></tr><tr><td>  <strong>s2.a</strong> </td><td> <code>xmm2</code> </td> <td>  <strong>s2.b</strong> </td><td> <code>xmm2</code> </td> <td></td></tr><tr><td>  <strong>s2.c</strong> </td><td> <code>xmm3</code> </td> <td>  <strong>s2.d</strong> </td><td> <code>xmm3</code> </td> <td></td></tr></tbody></table><br><p>  Deux champs <code>float</code> sont pouss√©s dans chaque registre <code>xmm</code> . </p><br><pre> <code class="hljs objectivec">foo(St, St): <span class="hljs-meta"><span class="hljs-meta"># @foo(St, St) #   vaddps    float . vaddps xmm0, xmm0, xmm2 vaddps xmm1, xmm1, xmm3 ret .LCPI1_0: .long 1065353216 # float 1 .long 1073741824 # float 2 .zero 4 .zero 4 #   LCPI1_1 - LCPI1_3. ... main: # @main sub rsp, 24 #  ,      . vmovapd xmm0, xmmword ptr [rip + .LCPI1_0] # xmm0 = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;1,2,u,u&gt;</span></span></span><span class="hljs-meta"> vmovapd xmm1, xmmword ptr [rip + .LCPI1_1] # xmm1 = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;3,4,u,u&gt;</span></span></span><span class="hljs-meta"> vmovaps xmm2, xmmword ptr [rip + .LCPI1_2] # xmm2 = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;5,6,u,u&gt;</span></span></span><span class="hljs-meta"> vmovaps xmm3, xmmword ptr [rip + .LCPI1_3] # xmm3 = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;7,8,u,u&gt;</span></span></span><span class="hljs-meta"> call foo(St, St) #        ,         . xmm   256 ,    128    a  b,   - c  d. vunpcklpd xmm0, xmm0, xmm1 # xmm0 = xmm0[0],xmm1[0] vmovupd xmmword ptr [rsp + 8], xmm0</span></span></code> </pre> <br><p>  Si la structure n'avait pas 4, mais trois champs, alors le code de fonction serait similaire, sauf pour remplacer la deuxi√®me instruction <code>vaddss</code> par <code>vaddss</code> , qui n'ajoute que les 64 premiers bits du registre. </p><br><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">St</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int32_t</span></span> a, b, c, d; }; <span class="hljs-function"><span class="hljs-function">St </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">foo</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(St s1, St s2)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> {s1.a + s2.a, s1.b + s2.b, s1.c + s2.c, s1.d + s2.d}; } ... St s1{<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-number"><span class="hljs-number">3</span></span>, <span class="hljs-number"><span class="hljs-number">4</span></span>}, s2{<span class="hljs-number"><span class="hljs-number">5</span></span>, <span class="hljs-number"><span class="hljs-number">6</span></span>, <span class="hljs-number"><span class="hljs-number">7</span></span>, <span class="hljs-number"><span class="hljs-number">8</span></span>}; <span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> result = foo(s1, s2);</code> </pre> <br><table><thead><tr><th>  Pr√©nom </th><th>  S'inscrire </th><th>  Pr√©nom </th><th>  S'inscrire </th><th>  R√©sultat </th></tr></thead><tbody><tr><td>  <strong>s1.a</strong> </td><td> <code>rdi</code> </td> <td>  <strong>s1.b</strong> </td><td> <code>rdi</code> </td> <td> <code>rax, rdx</code> </td> </tr><tr><td>  <strong>s1.c</strong> </td><td> <code>rsi</code> </td> <td>  <strong>s1.d</strong> </td><td> <code>rsi</code> </td> <td></td></tr><tr><td>  <strong>s2.a</strong> </td><td> <code>rdx</code> </td> <td>  <strong>s2.b</strong> </td><td> <code>rdx</code> </td> <td></td></tr><tr><td>  <strong>s2.c</strong> </td><td> <code>rcx</code> </td> <td>  <strong>s2.d</strong> </td><td> <code>rcx</code> </td> <td></td></tr></tbody></table><br><pre> <code class="hljs pgsql">foo(St, St): # @foo(St, St) lea eax, [rdx + rdi] movabs r8, <span class="hljs-number"><span class="hljs-number">-4294967296</span></span> # <span class="hljs-number"><span class="hljs-number">0xFFFFFFFF00000000</span></span>  . <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> rdi, r8 <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> rdi, rdx <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> rdi, r8 <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> rax, rdi lea edx, [rcx + rsi] #  ,   <span class="hljs-keyword"><span class="hljs-keyword">add</span></span>. <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> rsi, r8 <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> rsi, rcx <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> rsi, r8 <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> rdx, rsi ret main: # @main sub rsp, <span class="hljs-number"><span class="hljs-number">24</span></span> movabs rdi, <span class="hljs-number"><span class="hljs-number">8589934593</span></span> #       . movabs rsi, <span class="hljs-number"><span class="hljs-number">17179869187</span></span> movabs rdx, <span class="hljs-number"><span class="hljs-number">25769803781</span></span> movabs rcx, <span class="hljs-number"><span class="hljs-number">34359738375</span></span> <span class="hljs-keyword"><span class="hljs-keyword">call</span></span> foo(St, St) mov qword ptr [rsp + <span class="hljs-number"><span class="hljs-number">8</span></span>], rax #    . mov qword ptr [rsp + <span class="hljs-number"><span class="hljs-number">16</span></span>], rdx</code> </pre> <br><p>  La magie des bits se produit √† l'int√©rieur de la fonction, mais le principe est assez clair.  Chaque paire de num√©ros 32 bits est regroup√©e dans un registre 64 bits.  Les remboursements se font de la m√™me mani√®re. </p><br><p>  Voyons ce qui se passe si nous commen√ßons √† m√©langer les types de champs, mais de sorte que dans des blocs de 8 octets, ils soient de la m√™me classe. </p><br><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">St</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int32_t</span></span> a, b; <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> c, d; }; <span class="hljs-function"><span class="hljs-function">St </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">foo</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(St s1, St s2)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> {s1.a + s2.a, s1.b + s2.b, s1.c + s2.c, s1.d + s2.d}; } ... St s1{<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-number"><span class="hljs-number">3</span></span>, <span class="hljs-number"><span class="hljs-number">4</span></span>}, s2{<span class="hljs-number"><span class="hljs-number">5</span></span>, <span class="hljs-number"><span class="hljs-number">6</span></span>, <span class="hljs-number"><span class="hljs-number">7</span></span>, <span class="hljs-number"><span class="hljs-number">8</span></span>}; <span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> result = foo(s1, s2);</code> </pre> <br><table><thead><tr><th>  Pr√©nom </th><th>  S'inscrire </th><th>  Pr√©nom </th><th>  S'inscrire </th><th>  R√©sultat </th></tr></thead><tbody><tr><td>  <strong>s1.a</strong> </td><td> <code>rdi</code> </td> <td>  <strong>s1.b</strong> </td><td> <code>rdi</code> </td> <td> <code>rax, xmm0</code> </td> </tr><tr><td>  <strong>s1.c</strong> </td><td> <code>xmm0</code> </td> <td>  <strong>s1.d</strong> </td><td> <code>xmm0</code> </td> <td></td></tr><tr><td>  <strong>s2.a</strong> </td><td> <code>rsi</code> </td> <td>  <strong>s2.b</strong> </td><td> <code>rsi</code> </td> <td></td></tr><tr><td>  <strong>s2.c</strong> </td><td> <code>xmm1</code> </td> <td>  <strong>s2.d</strong> </td><td> <code>xmm1</code> </td> <td></td></tr></tbody></table><br><pre> <code class="hljs cpp">foo(St, St): # @foo(St, St) lea eax, [rsi + rdi] #     . movabs rcx, <span class="hljs-number"><span class="hljs-number">-4294967296</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> rdi, rcx add rdi, rsi <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> rdi, rcx <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> rax, rdi vaddps xmm0, xmm0, xmm1 #    . ret .LCPI1_0: .<span class="hljs-keyword"><span class="hljs-keyword">long</span></span> <span class="hljs-number"><span class="hljs-number">1077936128</span></span> <span class="hljs-meta"><span class="hljs-meta"># float 3 .long 1082130432 # float 4 .zero 4 .zero 4 ... main: # @main sub rsp, 24 vmovaps xmm0, xmmword ptr [rip + .LCPI1_0] # xmm0 = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;3,4,u,u&gt; vmovaps xmm1, xmmword ptr [rip + .LCPI1_1] # xmm1 = &lt;7,8,u,u&gt; movabs rdi, 8589934593 movabs rsi, 25769803781 call foo(St, St) mov qword ptr [rsp + 8], rax #    . vmovlps qword ptr [rsp + 16], xmm0</span></span></span></span></code> </pre> <br><p>  Mais ce n'est pas int√©ressant, car les types de champs dans chaque bloc de 8 octets sont les m√™mes.  M√©langez les champs. </p><br><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">St</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int32_t</span></span> a; <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> b; <span class="hljs-keyword"><span class="hljs-keyword">int32_t</span></span> c; <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> d; }; <span class="hljs-function"><span class="hljs-function">St </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">foo</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(St s1, St s2)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> {s1.a + s2.a, s1.b + s2.b, s1.c + s2.c, s1.d + s2.d}; } ... St s1{<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-number"><span class="hljs-number">3</span></span>, <span class="hljs-number"><span class="hljs-number">4</span></span>}, s2{<span class="hljs-number"><span class="hljs-number">5</span></span>, <span class="hljs-number"><span class="hljs-number">6</span></span>, <span class="hljs-number"><span class="hljs-number">7</span></span>, <span class="hljs-number"><span class="hljs-number">8</span></span>}; <span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> result = foo(s1, s2);</code> </pre> <br><table><thead><tr><th>  Pr√©nom </th><th>  S'inscrire </th><th>  Pr√©nom </th><th>  S'inscrire </th><th>  R√©sultat </th></tr></thead><tbody><tr><td>  <strong>s1.a</strong> </td><td> <code>rdi</code> </td> <td>  <strong>s1.b</strong> </td><td> <code>rdi</code> </td> <td> <code>rax, rdx</code> </td> </tr><tr><td>  <strong>s1.c</strong> </td><td> <code>rsi</code> </td> <td>  <strong>s1.d</strong> </td><td> <code>rsi</code> </td> <td></td></tr><tr><td>  <strong>s2.a</strong> </td><td> <code>rdx</code> </td> <td>  <strong>s2.b</strong> </td><td> <code>rdx</code> </td> <td></td></tr><tr><td>  <strong>s2.c</strong> </td><td> <code>rcx</code> </td> <td>  <strong>s2.d</strong> </td><td> <code>rcx</code> </td> <td></td></tr></tbody></table><br><p>  Voir paragraphe 3.2.  √âtant donn√© que le bloc de 8 octets contient √† la fois <code>float</code> et <code>int</code> , le bloc entier sera de type <strong>INTEGER</strong> et sera pass√© dans les registres g√©n√©raux. </p><br><pre> <code class="hljs delphi">foo(St, St): # @foo(St, St) mov rax, rdx add edx, edi <span class="hljs-keyword"><span class="hljs-keyword">shr</span></span> rdi, <span class="hljs-number"><span class="hljs-number">32</span></span> vmovd xmm0, edi mov rdi, rcx add ecx, esi <span class="hljs-keyword"><span class="hljs-keyword">shr</span></span> rsi, <span class="hljs-number"><span class="hljs-number">32</span></span> vmovd xmm1, esi <span class="hljs-keyword"><span class="hljs-keyword">shr</span></span> rax, <span class="hljs-number"><span class="hljs-number">32</span></span> vmovd xmm2, eax vaddss xmm0, xmm0, xmm2 <span class="hljs-keyword"><span class="hljs-keyword">shr</span></span> rdi, <span class="hljs-number"><span class="hljs-number">32</span></span> vmovd xmm2, edi vaddss xmm1, xmm1, xmm2 vmovd eax, xmm0 <span class="hljs-keyword"><span class="hljs-keyword">shl</span></span> rax, <span class="hljs-number"><span class="hljs-number">32</span></span> <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> rdx, rax vmovd eax, xmm1 <span class="hljs-keyword"><span class="hljs-keyword">shl</span></span> rax, <span class="hljs-number"><span class="hljs-number">32</span></span> <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> rcx, rax mov rax, rdx mov rdx, rcx ret main: # @main sub rsp, <span class="hljs-number"><span class="hljs-number">24</span></span> movabs rdi, <span class="hljs-number"><span class="hljs-number">4611686018427387905</span></span> # <span class="hljs-number"><span class="hljs-number">0</span></span>x4000000000000001,   <span class="hljs-number"><span class="hljs-number">32</span></span>   int,   - float. movabs rsi, <span class="hljs-number"><span class="hljs-number">4647714815446351875</span></span> movabs rdx, <span class="hljs-number"><span class="hljs-number">4665729213955833861</span></span> movabs rcx, <span class="hljs-number"><span class="hljs-number">4683743612465315847</span></span> call foo(St, St) mov qword ptr [rsp + <span class="hljs-number"><span class="hljs-number">8</span></span>], rax #      <span class="hljs-number"><span class="hljs-number">64</span></span>  . mov qword ptr [rsp + <span class="hljs-number"><span class="hljs-number">16</span></span>], rdx</code> </pre> <br><p>  Ici, vous pouvez voir 6 op√©rations de d√©calage pour extraire les champs <code>float</code> et les pousser dans le registre avec le r√©sultat.  Ainsi que l'absence d'op√©rations vectorielles.  En g√©n√©ral, il est pr√©f√©rable de ne pas interf√©rer avec les types de champ dans les blocs de 8 octets de la structure. </p><br><h2 id="peredacha-po-ssylke">  Passer par lien </h2><br><p>  Le passage de param√®tres via une r√©f√©rence constante est similaire au passage d'un pointeur sur un objet.  Si l'objet ne tient pas dans les registres, il est transmis et renvoy√© via la pile.  Voyons comment cela se produit.  Pour le r√©alisme, consid√©rez la structure d'un point tridimensionnel. </p><br><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Point3f</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> x, y, z; }; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Point3d</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">double</span></span> x, y, z; }; <span class="hljs-function"><span class="hljs-function">Point3f </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">scale</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Point3f p)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> {px * <span class="hljs-number"><span class="hljs-number">2</span></span>, py * <span class="hljs-number"><span class="hljs-number">2</span></span>, pz * <span class="hljs-number"><span class="hljs-number">2</span></span>}; } <span class="hljs-function"><span class="hljs-function">Point3f </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">scaleR</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> Point3f&amp; p)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> {px * <span class="hljs-number"><span class="hljs-number">2</span></span>, py * <span class="hljs-number"><span class="hljs-number">2</span></span>, pz * <span class="hljs-number"><span class="hljs-number">2</span></span>}; } <span class="hljs-function"><span class="hljs-function">Point3d </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">scale</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Point3d p)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> {px * <span class="hljs-number"><span class="hljs-number">2</span></span>, py * <span class="hljs-number"><span class="hljs-number">2</span></span>, pz * <span class="hljs-number"><span class="hljs-number">2</span></span>}; } <span class="hljs-function"><span class="hljs-function">Point3d </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">scaleR</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> Point3d&amp; p)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> {px * <span class="hljs-number"><span class="hljs-number">2</span></span>, py * <span class="hljs-number"><span class="hljs-number">2</span></span>, pz * <span class="hljs-number"><span class="hljs-number">2</span></span>}; }</code> </pre> <br><p>  Comparez le code de fonction.  La plupart du temps, de nouveaux registres <code>xmm</code> seront utilis√©s, donc la logique est compr√©hensible. </p><br><pre> <code class="hljs kotlin">scale(Point3f): # <span class="hljs-meta"><span class="hljs-meta">@scale(Point3f)</span></span> #     , x, y   xmm0, z - xmm1,     . vaddps xmm0, xmm0, xmm0 vaddss xmm1, xmm1, xmm1 ret scaleR(Point3f <span class="hljs-keyword"><span class="hljs-keyword">const</span></span>&amp;): # <span class="hljs-meta"><span class="hljs-meta">@scaleR(Point3f const&amp;)</span></span> #       rdi,     .      xmm0, xmm1. vmovsd xmm0, qword ptr [rdi] # xmm0 = mem[<span class="hljs-number"><span class="hljs-number">0</span></span>],zero vaddps xmm0, xmm0, xmm0 vmovss xmm1, dword ptr [rdi + <span class="hljs-number"><span class="hljs-number">8</span></span>] # xmm1 = mem[<span class="hljs-number"><span class="hljs-number">0</span></span>],zero,zero,zero vaddss xmm1, xmm1, xmm1 ret scale(Point3d): # <span class="hljs-meta"><span class="hljs-meta">@scale(Point3d)</span></span> #   rdi  ,     .          [rsp+<span class="hljs-number"><span class="hljs-number">8</span></span>, rsp+<span class="hljs-number"><span class="hljs-number">32</span></span>).  [rsp, rsp+<span class="hljs-number"><span class="hljs-number">8</span></span>)     . vmovapd xmm0, xmmword ptr [rsp + <span class="hljs-number"><span class="hljs-number">8</span></span>] vaddpd xmm0, xmm0, xmm0 vmovupd xmmword ptr [rdi], xmm0 vmovsd xmm0, qword ptr [rsp + <span class="hljs-number"><span class="hljs-number">24</span></span>] # xmm0 = mem[<span class="hljs-number"><span class="hljs-number">0</span></span>],zero vaddsd xmm0, xmm0, xmm0 vmovsd qword ptr [rdi + <span class="hljs-number"><span class="hljs-number">16</span></span>], xmm0 mov rax, rdi #  ,    . ret scaleR(Point3d <span class="hljs-keyword"><span class="hljs-keyword">const</span></span>&amp;): # <span class="hljs-meta"><span class="hljs-meta">@scaleR(Point3d const&amp;)</span></span> #   ,      [rsp+<span class="hljs-number"><span class="hljs-number">8</span></span>, rsp+<span class="hljs-number"><span class="hljs-number">32</span></span>),   [rsi, rsi+<span class="hljs-number"><span class="hljs-number">24</span></span>). vmovupd xmm0, xmmword ptr [rsi] vaddpd xmm0, xmm0, xmm0 vmovupd xmmword ptr [rdi], xmm0 vmovsd xmm0, qword ptr [rsi + <span class="hljs-number"><span class="hljs-number">16</span></span>] # xmm0 = mem[<span class="hljs-number"><span class="hljs-number">0</span></span>],zero vaddsd xmm0, xmm0, xmm0 vmovsd qword ptr [rdi + <span class="hljs-number"><span class="hljs-number">16</span></span>], xmm0 mov rax, rdi ret</code> </pre> <br><p>  Voyons maintenant l'endroit o√π ces fonctions sont appel√©es. </p><br><pre> <code class="hljs vbscript"># scale(Point3f) main: # @main <span class="hljs-keyword"><span class="hljs-keyword">sub</span></span> rsp, <span class="hljs-number"><span class="hljs-number">24</span></span> #     . vmovaps xmm0, xmmword ptr [rip + .LCPI4_0] # xmm0 = &lt;<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-number"><span class="hljs-number">2</span></span>,u,u&gt; vmovss xmm1, dword ptr [rip + .LCPI4_1] # xmm1 = &lt;<span class="hljs-number"><span class="hljs-number">3</span></span>,u,u,u&gt; <span class="hljs-keyword"><span class="hljs-keyword">call</span></span> scale(Point3f) # scaleR(<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> Point3f&amp;) main: # @main <span class="hljs-keyword"><span class="hljs-keyword">sub</span></span> rsp, <span class="hljs-number"><span class="hljs-number">24</span></span> #         rdi,     . mov edi, .L_ZZ4mainE1p # &lt;<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-number"><span class="hljs-number">2</span></span>,<span class="hljs-number"><span class="hljs-number">3</span></span>,u&gt; <span class="hljs-keyword"><span class="hljs-keyword">call</span></span> scaleR(Point3f <span class="hljs-keyword"><span class="hljs-keyword">const</span></span>&amp;) # scale(Point3d) main: # @main <span class="hljs-keyword"><span class="hljs-keyword">sub</span></span> rsp, <span class="hljs-number"><span class="hljs-number">64</span></span> #        . mov rax, qword ptr [rip + .L_ZZ4mainE1p+<span class="hljs-number"><span class="hljs-number">16</span></span>] mov qword ptr [rsp + <span class="hljs-number"><span class="hljs-number">16</span></span>], rax vmovups xmm0, xmmword ptr [rip + .L_ZZ4mainE1p] vmovups xmmword ptr [rsp], xmm0 lea rbx, [rsp + <span class="hljs-number"><span class="hljs-number">40</span></span>] mov rdi, rbx #     [rsp+<span class="hljs-number"><span class="hljs-number">40</span></span>, rsp+<span class="hljs-number"><span class="hljs-number">64</span></span>). <span class="hljs-keyword"><span class="hljs-keyword">call</span></span> scale(Point3d) .L_ZZ4mainE1p: .quad <span class="hljs-number"><span class="hljs-number">4607182418800017408</span></span> # double <span class="hljs-number"><span class="hljs-number">1</span></span> .quad <span class="hljs-number"><span class="hljs-number">4611686018427387904</span></span> # double <span class="hljs-number"><span class="hljs-number">2</span></span> .quad <span class="hljs-number"><span class="hljs-number">4613937818241073152</span></span> # double <span class="hljs-number"><span class="hljs-number">3</span></span> # scaleR(<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> Point3d&amp;) main: # @main <span class="hljs-keyword"><span class="hljs-keyword">sub</span></span> rsp, <span class="hljs-number"><span class="hljs-number">64</span></span> #   . mov rax, qword ptr [rip + .L_ZZ4mainE1p+<span class="hljs-number"><span class="hljs-number">16</span></span>] mov qword ptr [rsp + <span class="hljs-number"><span class="hljs-number">32</span></span>], rax vmovups xmm0, xmmword ptr [rip + .L_ZZ4mainE1p] vmovaps xmmword ptr [rsp + <span class="hljs-number"><span class="hljs-number">16</span></span>], xmm0 lea rbx, [rsp + <span class="hljs-number"><span class="hljs-number">40</span></span>] lea rsi, [rsp + <span class="hljs-number"><span class="hljs-number">16</span></span>] #     [rsp+<span class="hljs-number"><span class="hljs-number">16</span></span>, rsp+<span class="hljs-number"><span class="hljs-number">40</span></span>). mov rdi, rbx #     [rsp+<span class="hljs-number"><span class="hljs-number">40</span></span>, rsp+<span class="hljs-number"><span class="hljs-number">64</span></span>). <span class="hljs-keyword"><span class="hljs-keyword">call</span></span> scaleR(Point3d <span class="hljs-keyword"><span class="hljs-keyword">const</span></span>&amp;)</code> </pre> <br><p>  Voyons cela si nous avons beaucoup de champs, mais la structure s'inscrit toujours dans les registres.  Ici, le plaisir commence. </p><br><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">St</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> d[<span class="hljs-number"><span class="hljs-number">16</span></span>]; }; <span class="hljs-function"><span class="hljs-function">St </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">foo</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(St s1, St s2)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//   s1  s2. St res; for(int i{}; i &lt; 16; ++i) res.d[i] = s1.d[i] + s2.d[i]; return res; }</span></span></code> </pre> <br><p>  Code pour une fonction qui prend des arguments par valeur. </p><br><table><thead><tr><th>  Pr√©nom </th><th>  S'inscrire </th><th>  Pr√©nom </th><th>  S'inscrire </th><th>  R√©sultat </th></tr></thead><tbody><tr><td>  <strong>s1.d [1: 8]</strong> </td><td> <code>rdi</code> </td> <td>  <strong>s1.d [8:16]</strong> </td><td> <code>rsi</code> </td> <td> <code>rax, rdx</code> </td> </tr><tr><td>  <strong>s2.d [1: 8]</strong> </td><td> <code>rdx</code> </td> <td>  <strong>s2.d [8:16]</strong> </td><td> <code>rcx</code> </td> <td></td></tr></tbody></table><br><pre> <code class="hljs lua">foo(St, St): # @foo(St, St) mov qword ptr [rsp - <span class="hljs-number"><span class="hljs-number">16</span></span>], rdi mov qword ptr [rsp - <span class="hljs-number"><span class="hljs-number">8</span></span>], rsi mov qword ptr [rsp - <span class="hljs-number"><span class="hljs-number">32</span></span>], rdx mov qword ptr [rsp - <span class="hljs-number"><span class="hljs-number">24</span></span>], rcx mov eax, edx add al, dil mov <span class="hljs-built_in"><span class="hljs-built_in">byte</span></span> ptr [rsp - <span class="hljs-number"><span class="hljs-number">48</span></span>], al mov r8, rdi shr r8, <span class="hljs-number"><span class="hljs-number">8</span></span> mov rax, rdx shr rax, <span class="hljs-number"><span class="hljs-number">8</span></span> add al, r8b mov <span class="hljs-built_in"><span class="hljs-built_in">byte</span></span> ptr [rsp - <span class="hljs-number"><span class="hljs-number">47</span></span>], al mov r8, rdi shr r8, <span class="hljs-number"><span class="hljs-number">16</span></span> mov rax, rdx shr rax, <span class="hljs-number"><span class="hljs-number">16</span></span> add al, r8b mov <span class="hljs-built_in"><span class="hljs-built_in">byte</span></span> ptr [rsp - <span class="hljs-number"><span class="hljs-number">46</span></span>], al mov r8, rdi shr r8, <span class="hljs-number"><span class="hljs-number">24</span></span> mov rax, rdx shr rax, <span class="hljs-number"><span class="hljs-number">24</span></span> add al, r8b mov <span class="hljs-built_in"><span class="hljs-built_in">byte</span></span> ptr [rsp - <span class="hljs-number"><span class="hljs-number">45</span></span>], al mov r8, rdi shr r8, <span class="hljs-number"><span class="hljs-number">32</span></span> mov rax, rdx shr rax, <span class="hljs-number"><span class="hljs-number">32</span></span> add al, r8b mov <span class="hljs-built_in"><span class="hljs-built_in">byte</span></span> ptr [rsp - <span class="hljs-number"><span class="hljs-number">44</span></span>], al mov r8, rdi shr r8, <span class="hljs-number"><span class="hljs-number">40</span></span> mov rax, rdx shr rax, <span class="hljs-number"><span class="hljs-number">40</span></span> add al, r8b mov <span class="hljs-built_in"><span class="hljs-built_in">byte</span></span> ptr [rsp - <span class="hljs-number"><span class="hljs-number">43</span></span>], al mov r8, rdi shr r8, <span class="hljs-number"><span class="hljs-number">48</span></span> mov rax, rdx shr rax, <span class="hljs-number"><span class="hljs-number">48</span></span> add al, r8b mov <span class="hljs-built_in"><span class="hljs-built_in">byte</span></span> ptr [rsp - <span class="hljs-number"><span class="hljs-number">42</span></span>], al shr rdi, <span class="hljs-number"><span class="hljs-number">56</span></span> shr rdx, <span class="hljs-number"><span class="hljs-number">56</span></span> add dl, dil mov <span class="hljs-built_in"><span class="hljs-built_in">byte</span></span> ptr [rsp - <span class="hljs-number"><span class="hljs-number">41</span></span>], dl mov eax, ecx add al, sil mov <span class="hljs-built_in"><span class="hljs-built_in">byte</span></span> ptr [rsp - <span class="hljs-number"><span class="hljs-number">40</span></span>], al mov rax, rsi shr rax, <span class="hljs-number"><span class="hljs-number">8</span></span> mov rdx, rcx shr rdx, <span class="hljs-number"><span class="hljs-number">8</span></span> add dl, al mov <span class="hljs-built_in"><span class="hljs-built_in">byte</span></span> ptr [rsp - <span class="hljs-number"><span class="hljs-number">39</span></span>], dl shr rsi, <span class="hljs-number"><span class="hljs-number">16</span></span> shr rcx, <span class="hljs-number"><span class="hljs-number">16</span></span> add cl, sil mov <span class="hljs-built_in"><span class="hljs-built_in">byte</span></span> ptr [rsp - <span class="hljs-number"><span class="hljs-number">38</span></span>], cl mov al, <span class="hljs-built_in"><span class="hljs-built_in">byte</span></span> ptr [rsp - <span class="hljs-number"><span class="hljs-number">21</span></span>] mov cl, <span class="hljs-built_in"><span class="hljs-built_in">byte</span></span> ptr [rsp - <span class="hljs-number"><span class="hljs-number">20</span></span>] add al, <span class="hljs-built_in"><span class="hljs-built_in">byte</span></span> ptr [rsp - <span class="hljs-number"><span class="hljs-number">5</span></span>] mov <span class="hljs-built_in"><span class="hljs-built_in">byte</span></span> ptr [rsp - <span class="hljs-number"><span class="hljs-number">37</span></span>], al add cl, <span class="hljs-built_in"><span class="hljs-built_in">byte</span></span> ptr [rsp - <span class="hljs-number"><span class="hljs-number">4</span></span>] mov <span class="hljs-built_in"><span class="hljs-built_in">byte</span></span> ptr [rsp - <span class="hljs-number"><span class="hljs-number">36</span></span>], cl mov al, <span class="hljs-built_in"><span class="hljs-built_in">byte</span></span> ptr [rsp - <span class="hljs-number"><span class="hljs-number">19</span></span>] mov cl, <span class="hljs-built_in"><span class="hljs-built_in">byte</span></span> ptr [rsp - <span class="hljs-number"><span class="hljs-number">18</span></span>] add al, <span class="hljs-built_in"><span class="hljs-built_in">byte</span></span> ptr [rsp - <span class="hljs-number"><span class="hljs-number">3</span></span>] mov <span class="hljs-built_in"><span class="hljs-built_in">byte</span></span> ptr [rsp - <span class="hljs-number"><span class="hljs-number">35</span></span>], al add cl, <span class="hljs-built_in"><span class="hljs-built_in">byte</span></span> ptr [rsp - <span class="hljs-number"><span class="hljs-number">2</span></span>] mov <span class="hljs-built_in"><span class="hljs-built_in">byte</span></span> ptr [rsp - <span class="hljs-number"><span class="hljs-number">34</span></span>], cl mov al, <span class="hljs-built_in"><span class="hljs-built_in">byte</span></span> ptr [rsp - <span class="hljs-number"><span class="hljs-number">17</span></span>] add al, <span class="hljs-built_in"><span class="hljs-built_in">byte</span></span> ptr [rsp - <span class="hljs-number"><span class="hljs-number">1</span></span>] mov <span class="hljs-built_in"><span class="hljs-built_in">byte</span></span> ptr [rsp - <span class="hljs-number"><span class="hljs-number">33</span></span>], al mov rax, qword ptr [rsp - <span class="hljs-number"><span class="hljs-number">48</span></span>] mov rdx, qword ptr [rsp - <span class="hljs-number"><span class="hljs-number">40</span></span>] ret</code> </pre> <br><p>  Oui, ici tous les arguments sont copi√©s sur la pile, apr√®s quoi ils sont extraits et ajout√©s un octet √† la fois.  Comme vous pouvez le voir, il y a exactement 16 instructions d' <code>add</code> dans la fonction.  GCC, en passant, dans cet exemple, produit un code beaucoup plus compact, mais toujours avec copie via la pile.  Peut-on am√©liorer quelque chose?  Passez la structure par r√©f√©rence. </p><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-function">St </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">fooR</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> St&amp; s1, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> St&amp; s2)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">/*  . */</span></span> }</code> </pre> <br><table><thead><tr><th>  Pr√©nom </th><th>  S'inscrire </th><th>  Pr√©nom </th><th>  S'inscrire </th><th>  R√©sultat </th></tr></thead><tbody><tr><td>  <strong>s1</strong> </td><td> <code>rdi</code> </td> <td>  <strong>s2</strong> </td><td> <code>rsi</code> </td> <td> <code>rax, rdx</code> </td> </tr></tbody></table><br><pre> <code class="hljs vbscript">fooR(St <span class="hljs-keyword"><span class="hljs-keyword">const</span></span>&amp;, St <span class="hljs-keyword"><span class="hljs-keyword">const</span></span>&amp;): # @fooR(St <span class="hljs-keyword"><span class="hljs-keyword">const</span></span>&amp;, St <span class="hljs-keyword"><span class="hljs-keyword">const</span></span>&amp;) vmovdqu xmm0, xmmword ptr [rsi] vpaddb xmm0, xmm0, xmmword ptr [rdi] vmovdqa xmmword ptr [rsp - <span class="hljs-number"><span class="hljs-number">24</span></span>], xmm0 mov rax, qword ptr [rsp - <span class="hljs-number"><span class="hljs-number">24</span></span>] mov rdx, qword ptr [rsp - <span class="hljs-number"><span class="hljs-number">16</span></span>] ret</code> </pre> <br><p>  Oh oui!  √áa a l'air beaucoup mieux.  Nous pouvons charger 16 √©l√©ments √† un octet √† la fois dans le registre <code>xmm</code> et appeler <code>vpaddb</code> qui les <code>vpaddb</code> tous en une seule op√©ration.  Apr√®s cela, le r√©sultat est copi√© dans les registres de sortie via la pile.  Vous pourriez penser que vous pouvez vous d√©barrasser de cette derni√®re op√©ration en rempla√ßant le premier argument par une r√©f√©rence non constante. </p><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">fooR1</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(St &amp;s1, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> St&amp; s2)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i{}; i &lt; <span class="hljs-number"><span class="hljs-number">16</span></span>; ++i) s1.d[i] += s2.d[i]; }</code> </pre> <br><table><thead><tr><th>  Pr√©nom </th><th>  S'inscrire </th><th>  Pr√©nom </th><th>  S'inscrire </th><th>  R√©sultat </th></tr></thead><tbody><tr><td>  <strong>s1</strong> </td><td> <code>rdi</code> </td> <td>  <strong>s2</strong> </td><td> <code>rsi</code> </td> <td></td></tr></tbody></table><br><pre> <code class="hljs go">fooR1(St&amp;, St <span class="hljs-keyword"><span class="hljs-keyword">const</span></span>&amp;): # @fooR1(St&amp;, St <span class="hljs-keyword"><span class="hljs-keyword">const</span></span>&amp;) mov al, <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span> ptr [rsi] add <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span> ptr [rdi], al mov al, <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span> ptr [rsi + <span class="hljs-number"><span class="hljs-number">1</span></span>] add <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span> ptr [rdi + <span class="hljs-number"><span class="hljs-number">1</span></span>], al mov al, <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span> ptr [rsi + <span class="hljs-number"><span class="hljs-number">2</span></span>] add <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span> ptr [rdi + <span class="hljs-number"><span class="hljs-number">2</span></span>], al mov al, <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span> ptr [rsi + <span class="hljs-number"><span class="hljs-number">3</span></span>] add <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span> ptr [rdi + <span class="hljs-number"><span class="hljs-number">3</span></span>], al mov al, <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span> ptr [rsi + <span class="hljs-number"><span class="hljs-number">4</span></span>] add <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span> ptr [rdi + <span class="hljs-number"><span class="hljs-number">4</span></span>], al mov al, <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span> ptr [rsi + <span class="hljs-number"><span class="hljs-number">5</span></span>] add <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span> ptr [rdi + <span class="hljs-number"><span class="hljs-number">5</span></span>], al mov al, <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span> ptr [rsi + <span class="hljs-number"><span class="hljs-number">6</span></span>] add <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span> ptr [rdi + <span class="hljs-number"><span class="hljs-number">6</span></span>], al mov al, <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span> ptr [rsi + <span class="hljs-number"><span class="hljs-number">7</span></span>] add <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span> ptr [rdi + <span class="hljs-number"><span class="hljs-number">7</span></span>], al mov al, <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span> ptr [rsi + <span class="hljs-number"><span class="hljs-number">8</span></span>] add <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span> ptr [rdi + <span class="hljs-number"><span class="hljs-number">8</span></span>], al mov al, <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span> ptr [rsi + <span class="hljs-number"><span class="hljs-number">9</span></span>] add <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span> ptr [rdi + <span class="hljs-number"><span class="hljs-number">9</span></span>], al mov al, <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span> ptr [rsi + <span class="hljs-number"><span class="hljs-number">10</span></span>] add <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span> ptr [rdi + <span class="hljs-number"><span class="hljs-number">10</span></span>], al mov al, <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span> ptr [rsi + <span class="hljs-number"><span class="hljs-number">11</span></span>] add <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span> ptr [rdi + <span class="hljs-number"><span class="hljs-number">11</span></span>], al mov al, <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span> ptr [rsi + <span class="hljs-number"><span class="hljs-number">12</span></span>] add <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span> ptr [rdi + <span class="hljs-number"><span class="hljs-number">12</span></span>], al mov al, <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span> ptr [rsi + <span class="hljs-number"><span class="hljs-number">13</span></span>] add <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span> ptr [rdi + <span class="hljs-number"><span class="hljs-number">13</span></span>], al mov al, <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span> ptr [rsi + <span class="hljs-number"><span class="hljs-number">14</span></span>] add <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span> ptr [rdi + <span class="hljs-number"><span class="hljs-number">14</span></span>], al mov al, <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span> ptr [rsi + <span class="hljs-number"><span class="hljs-number">15</span></span>] add <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span> ptr [rdi + <span class="hljs-number"><span class="hljs-number">15</span></span>], al ret</code> </pre> <br><p>  Quelque chose semble avoir mal tourn√©.  Cela s'est produit parce que, par d√©faut, le compilateur est tr√®s prudent et sugg√®re que le programmeur peut √™tre hors de tri et √©crire quelque chose comme ceci: </p><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">char</span></span> buff[<span class="hljs-number"><span class="hljs-number">17</span></span>]; fooR1(*<span class="hljs-keyword"><span class="hljs-keyword">reinterpret_cast</span></span>&lt;St*&gt;(buff+<span class="hljs-number"><span class="hljs-number">1</span></span>), <span class="hljs-keyword"><span class="hljs-keyword">reinterpret_cast</span></span>&lt;<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> St*&gt;(buff));</code> </pre> <br><p>  Dans ce cas, <code>buff[i+1] += buff[i]</code> calcul√© √† chaque it√©ration, c'est-√†-dire qu'un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">aliasing de pointeur</a> est disponible.  Afin d'indiquer au compilateur qu'une telle utilisation √©trange de la fonction n'est pas attendue, le mot cl√© <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">__restrict</a> existe. </p><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">fooR2</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(St &amp; __restrict s1, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> St&amp; s2)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">/*  . */</span></span> }</code> </pre> <br><p>     . </p><br><pre> <code class="hljs kotlin">fooR2(St&amp;, St <span class="hljs-keyword"><span class="hljs-keyword">const</span></span>&amp;): # <span class="hljs-meta"><span class="hljs-meta">@fooR2(St&amp;, St const&amp;)</span></span> vmovdqu xmm0, xmmword ptr [rdi] vpaddb xmm0, xmm0, xmmword ptr [rsi] vmovdqu xmmword ptr [rdi], xmm0 ret</code> </pre> <br><p>    <code>void fooR3(St &amp;__restrict s1, St s2)</code> ,      ,      <code>St foo(St, St)</code> . </p><br><p> ,      ,  <code>void foo(char* __restrict s1, const char* s2, int size)</code>        ,    <code>__restrict</code> . </p><br><h3 id="sravnenie-proizvoditelnosti">   </h3><br><p>     <code>b</code>  <code>a</code> ,  ,  <code>foo</code>    : </p><br><pre> <code class="cpp hljs">St a, b; st(a, b); <span class="hljs-comment"><span class="hljs-comment">// st(St&amp; a, St&amp; b) { a = b = {}; }   . a = foo(a, b); a = foo(a, b); a = foo(a, b); a = foo(a, b);</span></span></code> </pre> <br><table><thead><tr><th> Code </th><th> Cycles per iteration </th></tr></thead><tbody><tr><td> <code>St a, b; st(a, b);</code> </td> <td> 7.6 </td></tr><tr><td> 4 x <code>foo</code> no reuse </td><td> 121.9 </td></tr><tr><td> 4 x <code>foo</code> </td><td> 117.7 </td></tr><tr><td> 4 x <code>fooR</code> no reuse </td><td> 66.3 </td></tr><tr><td> 4 x <code>fooR</code> </td><td> 64.6 </td></tr><tr><td> 4 x <code>fooR1</code> </td><td> 84.5 </td></tr><tr><td> 4 x <code>fooR2</code> </td><td> 20.6 </td></tr><tr><td> 4 x <code>foo</code> inline </td><td> 51.9 </td></tr><tr><td> 4 x <code>fooR</code> inline </td><td> 30.5 </td></tr><tr><td> 4 x <code>fooR1</code> inline </td><td>  8.8 </td></tr><tr><td> 4 x <code>fooR2</code> inline </td><td>  8.8 </td></tr></tbody></table><br><p> 'no reuse'   ,        . <code>auto a2 = foo(a, b); auto a3 = foo(a2, b);</code>  . 'inline' ,     <strong>INLINE</strong> ,   <strong>NOINLINE</strong> . </p><br><p>     <code>fooR1 inline / fooR2 inline</code> ,       ,   ,   ,    , <code>foo inline / fooR inline</code> ,         . ,        ,             . </p><br><h2 id="prozrachnye-ukazateli">   </h2><br><p> ,  ,    . </p><br><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Point3f</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> x, y, z; ~Point3f() {} }; <span class="hljs-function"><span class="hljs-function">Point3f </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">scale</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Point3f p)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> {px * <span class="hljs-number"><span class="hljs-number">2</span></span>, py * <span class="hljs-number"><span class="hljs-number">2</span></span>, pz * <span class="hljs-number"><span class="hljs-number">2</span></span>}; }</code> </pre> <br><p>    <code>rdi</code>  ,     . ,  <code>rsi</code> ,      . </p><br><pre> <code class="hljs pgsql">scale(Point3f): # @scale(Point3f) vmovss xmm0, dword ptr [rsi] # xmm0 = mem[<span class="hljs-number"><span class="hljs-number">0</span></span>],zero,zero,zero vaddss xmm0, xmm0, xmm0 vmovss dword ptr [rdi], xmm0 vmovss xmm0, dword ptr [rsi + <span class="hljs-number"><span class="hljs-number">4</span></span>] # xmm0 = mem[<span class="hljs-number"><span class="hljs-number">0</span></span>],zero,zero,zero vaddss xmm0, xmm0, xmm0 vmovss dword ptr [rdi + <span class="hljs-number"><span class="hljs-number">4</span></span>], xmm0 vmovss xmm0, dword ptr [rsi + <span class="hljs-number"><span class="hljs-number">8</span></span>] # xmm0 = mem[<span class="hljs-number"><span class="hljs-number">0</span></span>],zero,zero,zero vaddss xmm0, xmm0, xmm0 vmovss dword ptr [rdi + <span class="hljs-number"><span class="hljs-number">8</span></span>], xmm0 mov rax, rdi ret</code> </pre> <br><p>  , ,  ( )        .       POD .      <code>Point3f scaleR(const Point3f&amp;)</code>   .    . </p><br><pre> <code class="cpp hljs">Point3f p{<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-number"><span class="hljs-number">3</span></span>}; <span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> result = scale(p); sink(&amp;result);</code> </pre> <br><pre> <code class="hljs pgsql">main: # @main push rbx sub rsp, <span class="hljs-number"><span class="hljs-number">48</span></span> movabs rax, <span class="hljs-number"><span class="hljs-number">4611686019492741120</span></span> #    . mov qword ptr [rsp + <span class="hljs-number"><span class="hljs-number">16</span></span>], rax mov dword ptr [rsp + <span class="hljs-number"><span class="hljs-number">24</span></span>], <span class="hljs-number"><span class="hljs-number">1077936128</span></span> lea rbx, [rsp + <span class="hljs-number"><span class="hljs-number">32</span></span>] lea rsi, [rsp + <span class="hljs-number"><span class="hljs-number">16</span></span>] #    [rsp+<span class="hljs-number"><span class="hljs-number">16</span></span>, rsp+<span class="hljs-number"><span class="hljs-number">28</span></span>) mov rdi, rbx #    [rsp+<span class="hljs-number"><span class="hljs-number">32</span></span>, rsp+<span class="hljs-number"><span class="hljs-number">44</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">call</span></span> scale(Point3f) mov qword ptr [rsp + <span class="hljs-number"><span class="hljs-number">8</span></span>], rbx #  [rsp+<span class="hljs-number"><span class="hljs-number">8</span></span>, rsp+<span class="hljs-number"><span class="hljs-number">16</span></span>)    . lea rdi, [rsp + <span class="hljs-number"><span class="hljs-number">8</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">call</span></span> <span class="hljs-type"><span class="hljs-type">void</span></span> sink&lt;Point3f*&gt;(Point3f* const&amp;) xor eax, eax <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> rsp, <span class="hljs-number"><span class="hljs-number">48</span></span> pop rbx ret #  . mov rdi, rax <span class="hljs-keyword"><span class="hljs-keyword">call</span></span> _Unwind_Resume</code> </pre> <br><p>    <strong>NOINLINE</strong> ,     . </p><br><pre> <code class="hljs pgsql">main: # @main push r14 push rbx sub rsp, <span class="hljs-number"><span class="hljs-number">56</span></span> movabs rax, <span class="hljs-number"><span class="hljs-number">4611686019492741120</span></span> #    [rsp, rsp+<span class="hljs-number"><span class="hljs-number">12</span></span>).   p. mov qword ptr [rsp], rax mov dword ptr [rsp + <span class="hljs-number"><span class="hljs-number">8</span></span>], <span class="hljs-number"><span class="hljs-number">1077936128</span></span> #    [rsp+<span class="hljs-number"><span class="hljs-number">24</span></span>, rsp+<span class="hljs-number"><span class="hljs-number">36</span></span>),    pTmp. mov eax, dword ptr [rsp + <span class="hljs-number"><span class="hljs-number">8</span></span>] mov dword ptr [rsp + <span class="hljs-number"><span class="hljs-number">32</span></span>], eax mov rax, qword ptr [rsp] mov qword ptr [rsp + <span class="hljs-number"><span class="hljs-number">24</span></span>], rax lea r14, [rsp + <span class="hljs-number"><span class="hljs-number">40</span></span>] lea rbx, [rsp + <span class="hljs-number"><span class="hljs-number">24</span></span>] mov rdi, r14 #    [rsp+<span class="hljs-number"><span class="hljs-number">40</span></span>, rsp+<span class="hljs-number"><span class="hljs-number">52</span></span>),  result. mov rsi, rbx #   -   pTmp. <span class="hljs-keyword"><span class="hljs-keyword">call</span></span> scale(Point3f) mov rdi, rbx #    pTmp.    -  this. <span class="hljs-keyword"><span class="hljs-keyword">call</span></span> Point3f::~Point3f() mov qword ptr [rsp + <span class="hljs-number"><span class="hljs-number">16</span></span>], r14 #  [rsp+<span class="hljs-number"><span class="hljs-number">16</span></span>, rsp+<span class="hljs-number"><span class="hljs-number">24</span></span>)     result.     sink. lea rdi, [rsp + <span class="hljs-number"><span class="hljs-number">16</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">call</span></span> <span class="hljs-type"><span class="hljs-type">void</span></span> sink&lt;Point3f*&gt;(Point3f* const&amp;) lea rdi, [rsp + <span class="hljs-number"><span class="hljs-number">40</span></span>] #    result. <span class="hljs-keyword"><span class="hljs-keyword">call</span></span> Point3f::~Point3f() mov rdi, rsp #    p. <span class="hljs-keyword"><span class="hljs-keyword">call</span></span> Point3f::~Point3f() xor eax, eax <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> rsp, <span class="hljs-number"><span class="hljs-number">56</span></span> pop rbx pop r14 ret #  .           . mov rbx, rax lea rdi, [rsp + <span class="hljs-number"><span class="hljs-number">40</span></span>] #    result. <span class="hljs-keyword"><span class="hljs-keyword">call</span></span> Point3f::~Point3f() mov rdi, rsp #    p. <span class="hljs-keyword"><span class="hljs-keyword">call</span></span> Point3f::~Point3f() mov rdi, rbx <span class="hljs-keyword"><span class="hljs-keyword">call</span></span> _Unwind_Resume</code> </pre> <br><p>   <code>p</code>    ,            . </p><br><h2 id="pereispolzovanie-steka">   </h2><br><p> ,        .      <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="> </a> . </p><br><pre> <code class="hljs pgsql"># Point3f result = scale(scale(Point3f{<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-number"><span class="hljs-number">3</span></span>})); sub rsp, <span class="hljs-number"><span class="hljs-number">24</span></span> vmovaps xmm0, xmmword ptr [rip + .LCPI4_0] # xmm0 = &lt;<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-number"><span class="hljs-number">2</span></span>,u,u&gt; vmovss xmm1, dword ptr [rip + .LCPI4_1] # xmm1 = mem[<span class="hljs-number"><span class="hljs-number">0</span></span>],zero,zero,zero #    xmm0, xmm1    ,    ,       ! <span class="hljs-keyword"><span class="hljs-keyword">call</span></span> scale(Point3f) <span class="hljs-keyword"><span class="hljs-keyword">call</span></span> scale(Point3f) vmovlps qword ptr [rsp + <span class="hljs-number"><span class="hljs-number">8</span></span>], xmm0 vmovss dword ptr [rsp + <span class="hljs-number"><span class="hljs-number">16</span></span>], xmm1 # Point3f result = scaleR(scaleR(Point3f{<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-number"><span class="hljs-number">3</span></span>})); sub rsp, <span class="hljs-number"><span class="hljs-number">56</span></span> #       [rsp+<span class="hljs-number"><span class="hljs-number">24</span></span>, rsp+<span class="hljs-number"><span class="hljs-number">36</span></span>). movabs rax, <span class="hljs-number"><span class="hljs-number">4611686019492741120</span></span> # <span class="hljs-number"><span class="hljs-number">0x400000003F800000</span></span> = [<span class="hljs-number"><span class="hljs-number">2.0</span></span>f, <span class="hljs-number"><span class="hljs-number">1.0</span></span>f] mov qword ptr [rsp + <span class="hljs-number"><span class="hljs-number">24</span></span>], rax mov dword ptr [rsp + <span class="hljs-number"><span class="hljs-number">32</span></span>], <span class="hljs-number"><span class="hljs-number">1077936128</span></span> # <span class="hljs-number"><span class="hljs-number">0x40400000</span></span> = <span class="hljs-number"><span class="hljs-number">3.0</span></span>f lea rdi, [rsp + <span class="hljs-number"><span class="hljs-number">24</span></span>] #      . <span class="hljs-keyword"><span class="hljs-keyword">call</span></span> scaleR(Point3f const&amp;) #    [rsp+<span class="hljs-number"><span class="hljs-number">8</span></span>, rsp+<span class="hljs-number"><span class="hljs-number">20</span></span>). vmovlps qword ptr [rsp + <span class="hljs-number"><span class="hljs-number">8</span></span>], xmm0 vmovss dword ptr [rsp + <span class="hljs-number"><span class="hljs-number">16</span></span>], xmm1 lea rdi, [rsp + <span class="hljs-number"><span class="hljs-number">8</span></span>] #       . <span class="hljs-keyword"><span class="hljs-keyword">call</span></span> scaleR(Point3f const&amp;) vmovlps qword ptr [rsp + <span class="hljs-number"><span class="hljs-number">40</span></span>], xmm0 vmovss dword ptr [rsp + <span class="hljs-number"><span class="hljs-number">48</span></span>], xmm1</code> </pre> <br><p> ,       ,   .      ,    . </p><br><pre> <code class="hljs pgsql"># Point3d result = scale(scale(Point3d{<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-number"><span class="hljs-number">3</span></span>})); sub rsp, <span class="hljs-number"><span class="hljs-number">112</span></span> #    [rsp, rsp+<span class="hljs-number"><span class="hljs-number">24</span></span>). vmovaps xmm0, xmmword ptr [rip + .LCPI4_0] # xmm0 = [<span class="hljs-number"><span class="hljs-number">1.000000e+00</span></span>,<span class="hljs-number"><span class="hljs-number">2.000000e+00</span></span>] vmovaps xmmword ptr [rsp + <span class="hljs-number"><span class="hljs-number">32</span></span>], xmm0 movabs rax, <span class="hljs-number"><span class="hljs-number">4613937818241073152</span></span> # <span class="hljs-number"><span class="hljs-number">0x4008000000000000</span></span> = <span class="hljs-number"><span class="hljs-number">3.0</span></span> mov qword ptr [rsp + <span class="hljs-number"><span class="hljs-number">48</span></span>], rax mov rax, qword ptr [rsp + <span class="hljs-number"><span class="hljs-number">48</span></span>] mov qword ptr [rsp + <span class="hljs-number"><span class="hljs-number">16</span></span>], rax vmovaps xmm0, xmmword ptr [rsp + <span class="hljs-number"><span class="hljs-number">32</span></span>] vmovups xmmword ptr [rsp], xmm0 #    [rsp+<span class="hljs-number"><span class="hljs-number">64</span></span>, rsp+<span class="hljs-number"><span class="hljs-number">88</span></span>). lea rdi, [rsp + <span class="hljs-number"><span class="hljs-number">64</span></span>] #  rdi     . <span class="hljs-keyword"><span class="hljs-keyword">call</span></span> scale(Point3d) #        [rsp, rsp+<span class="hljs-number"><span class="hljs-number">24</span></span>). mov rax, qword ptr [rsp + <span class="hljs-number"><span class="hljs-number">80</span></span>] #  z   z . mov qword ptr [rsp + <span class="hljs-number"><span class="hljs-number">16</span></span>], rax vmovups xmm0, xmmword ptr [rsp + <span class="hljs-number"><span class="hljs-number">64</span></span>] #  [x, y]   [x, y] . vmovups xmmword ptr [rsp], xmm0 #    [rsp+<span class="hljs-number"><span class="hljs-number">88</span></span>, rsp+<span class="hljs-number"><span class="hljs-number">112</span></span>). lea rbx, [rsp + <span class="hljs-number"><span class="hljs-number">88</span></span>] mov rdi, rbx <span class="hljs-keyword"><span class="hljs-keyword">call</span></span> scale(Point3d) # Point3d result = scaleR(scaleR(Point3d{<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-number"><span class="hljs-number">3</span></span>})); sub rsp, <span class="hljs-number"><span class="hljs-number">72</span></span> #    [rsp, rsp+<span class="hljs-number"><span class="hljs-number">24</span></span>),   . vmovaps xmm0, xmmword ptr [rip + .LCPI4_0] vmovaps xmmword ptr [rsp], xmm0 movabs rax, <span class="hljs-number"><span class="hljs-number">4613937818241073152</span></span> mov qword ptr [rsp + <span class="hljs-number"><span class="hljs-number">16</span></span>], rax lea r14, [rsp + <span class="hljs-number"><span class="hljs-number">24</span></span>] mov rsi, rsp #   -       [rsp, rsp+<span class="hljs-number"><span class="hljs-number">24</span></span>). mov rdi, r14 #   -      [rsp+<span class="hljs-number"><span class="hljs-number">24</span></span>, rsp+<span class="hljs-number"><span class="hljs-number">48</span></span>). <span class="hljs-keyword"><span class="hljs-keyword">call</span></span> scaleR(Point3d const&amp;) lea rbx, [rsp + <span class="hljs-number"><span class="hljs-number">48</span></span>] mov rdi, rbx #      [rsp+<span class="hljs-number"><span class="hljs-number">48</span></span>, rsp+<span class="hljs-number"><span class="hljs-number">72</span></span>). mov rsi, r14 #       [rsp+<span class="hljs-number"><span class="hljs-number">24</span></span>, rsp+<span class="hljs-number"><span class="hljs-number">48</span></span>). <span class="hljs-keyword"><span class="hljs-keyword">call</span></span> scaleR(Point3d const&amp;)</code> </pre> <br><p> ,    ,   ,   ,    .      ‚Äì     .                  .       ,       ,      . </p><br><h3 id="sravnenie-proizvoditelnosti-1">   </h3><br><p> ,       .         ,      . ,         , <code>Point3f</code>    ,  <code>Point3d</code> ‚Äì  . </p><br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">//   data.cpp.  . Point3f pf() { return {1, 2, 3}; } Point3d pd() { return {1, 2, 3}; }</span></span></code> </pre> <br><table><thead><tr><th> Code </th><th> Cycles per iteration </th></tr></thead><tbody><tr><td> <code>auto r = pf();</code> </td> <td> 6.7 </td></tr><tr><td> <code>auto r = scale(pf());</code> </td> <td> 11.1 </td></tr><tr><td> <code>auto r = scaleR(pf());</code> </td> <td> 12.6 </td></tr><tr><td> <code>auto r = scale(scale(pf()));</code> </td> <td>  18,2 </td></tr><tr><td> <code>auto r = scaleR(scaleR(pf()));</code> </td> <td> 18.3 </td></tr><tr><td> <code>auto r = scale(scale(scale(pf())));</code> </td> <td> 16.8 </td></tr><tr><td> <code>auto r = scaleR(scaleR(scaleR(pf())));</code> </td> <td> 20.2 </td></tr><tr><td> <code>auto r = pd();</code> </td> <td>  7.3 </td></tr><tr><td> <code>auto r = scale(pd());</code> </td> <td> 11.7 </td></tr><tr><td> <code>auto r = scaleR(pd());</code> </td> <td> 11.0 </td></tr><tr><td> <code>auto r = scale(scale(pd()));</code> </td> <td> 16.9 </td></tr><tr><td> <code>auto r = scaleR(scaleR(pd()));</code> </td> <td>  14,1 </td></tr><tr><td> <code>auto r = scale(scale(scale(pd())));</code> </td> <td> 21.2 </td></tr><tr><td> <code>auto r = scaleR(scaleR(scaleR(pd())));</code> </td> <td> 17.2 </td></tr><tr><td>    <strong>INLINE</strong> </td><td> 8.1 ‚Äî 8.9 </td></tr></tbody></table><br><p>   <code>Point3f</code>  <code>struct Point3i { int32_t x, y, z; };</code>  <code>Point3d</code>  <code>struct Point3ll { int64_t x, y, z; };</code> ,       . ,        , ,    64       int,      .   ,   <code>Point3f</code>  <code>struct Point2ll { int64_t x, y; };</code>  <code>Point3d</code>  <code>struct Point4ll { int64_t x, y, z, a; };</code> ,     -. </p><br><p>   : </p><br><ul><li>      .     . </li><li> ,    ,    . </li><li>      inline      ,    .     ,  ,  ,    .       . </li></ul><br><h2 id="tip-optional">  optional </h2><br><p>   <code>std::optional</code> ,   <code>boost::optional</code> ,     <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="> </a> ,     "x86-64 clang (experimental concepts)" ,  , MSVC  ,  </p><br><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Point</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> x, y; }; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> OptPoint1 = optional&lt;Point&gt;;</code> </pre> <br><p>     </p><br><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">OptPoint2</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> x, y; <span class="hljs-keyword"><span class="hljs-keyword">union</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> _; <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> d; }; <span class="hljs-comment"><span class="hljs-comment">//   std::optional. };</span></span></code> </pre> <br><p>      , <code>OptPoint1</code>    ,  <code>OptPoint2</code> ‚Äì  . </p><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-function">OptPoint1 </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">foo</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(OptPoint1 s)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Point{s-&gt;x + <span class="hljs-number"><span class="hljs-number">1</span></span>, s-&gt;y + <span class="hljs-number"><span class="hljs-number">1</span></span>}; } <span class="hljs-function"><span class="hljs-function">OptPoint2 </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">foo</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(OptPoint2 s)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> {sx + <span class="hljs-number"><span class="hljs-number">1</span></span>, sy + <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-literal"><span class="hljs-literal">true</span></span>}; } ... OptPoint1 s1{Point{<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>}}; OptPoint2 s2{<span class="hljs-number"><span class="hljs-number">3</span></span>, <span class="hljs-number"><span class="hljs-number">4</span></span>, <span class="hljs-literal"><span class="hljs-literal">true</span></span>}; <span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> result1 = foo(s1); <span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> result2 = foo(s2);</code> </pre> <br><pre> <code class="hljs pgsql">.LCPI0_0: .long <span class="hljs-number"><span class="hljs-number">1065353216</span></span> # <span class="hljs-type"><span class="hljs-type">float</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> foo(std::optional&lt;<span class="hljs-type"><span class="hljs-type">Point</span></span>&gt;): # @foo(std::optional&lt;<span class="hljs-type"><span class="hljs-type">Point</span></span>&gt;) vmovss xmm0, dword ptr [rip + .LCPI0_0] # xmm0 = mem[<span class="hljs-number"><span class="hljs-number">0</span></span>],zero,zero,zero #  rsi       . vaddss xmm1, xmm0, dword ptr [rsi] #  x  ,  <span class="hljs-number"><span class="hljs-number">1.</span></span> vaddss xmm0, xmm0, dword ptr [rsi + <span class="hljs-number"><span class="hljs-number">4</span></span>] #  y  ,  <span class="hljs-number"><span class="hljs-number">1.</span></span> vmovss dword ptr [rdi], xmm1 #  x  , rdi      ,     . vmovss dword ptr [rdi + <span class="hljs-number"><span class="hljs-number">4</span></span>], xmm0 #  y  . mov byte ptr [rdi + <span class="hljs-number"><span class="hljs-number">8</span></span>], <span class="hljs-number"><span class="hljs-number">1</span></span> #  optional::has_value(). mov rax, rdi #    . ret .LCPI1_0: .long <span class="hljs-number"><span class="hljs-number">1065353216</span></span> # <span class="hljs-type"><span class="hljs-type">float</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> .long <span class="hljs-number"><span class="hljs-number">1065353216</span></span> # <span class="hljs-type"><span class="hljs-type">float</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> .zero <span class="hljs-number"><span class="hljs-number">4</span></span> .zero <span class="hljs-number"><span class="hljs-number">4</span></span> foo(OptPoint2): # @foo(OptPoint2) vaddps xmm0, xmm0, xmmword ptr [rip + .LCPI1_0] #  [x, y] c [<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>].  xmm0  . mov al, <span class="hljs-number"><span class="hljs-number">1</span></span> #  d, al -   <span class="hljs-number"><span class="hljs-number">8</span></span>   rax. ret .LCPI2_0: .long <span class="hljs-number"><span class="hljs-number">1077936128</span></span> # <span class="hljs-type"><span class="hljs-type">float</span></span> <span class="hljs-number"><span class="hljs-number">3</span></span> .long <span class="hljs-number"><span class="hljs-number">1082130432</span></span> # <span class="hljs-type"><span class="hljs-type">float</span></span> <span class="hljs-number"><span class="hljs-number">4</span></span> .zero <span class="hljs-number"><span class="hljs-number">4</span></span> .zero <span class="hljs-number"><span class="hljs-number">4</span></span> main: # @main push rbx sub rsp, <span class="hljs-number"><span class="hljs-number">64</span></span> movabs rax, <span class="hljs-number"><span class="hljs-number">4611686019492741120</span></span> # <span class="hljs-number"><span class="hljs-number">0x400000003F800000</span></span>  x  y. mov qword ptr [rsp + <span class="hljs-number"><span class="hljs-number">32</span></span>], rax #  x, y  . mov byte ptr [rsp + <span class="hljs-number"><span class="hljs-number">40</span></span>], <span class="hljs-number"><span class="hljs-number">1</span></span> #  optional::has_value(). lea rbx, [rsp + <span class="hljs-number"><span class="hljs-number">48</span></span>] lea rsi, [rsp + <span class="hljs-number"><span class="hljs-number">32</span></span>] #    . mov rdi, rbx #    . <span class="hljs-keyword"><span class="hljs-keyword">call</span></span> foo(std::optional&lt;<span class="hljs-type"><span class="hljs-type">Point</span></span>&gt;) #     . vmovaps xmm0, xmmword ptr [rip + .LCPI2_0] # xmm0 = &lt;<span class="hljs-number"><span class="hljs-number">3</span></span>,<span class="hljs-number"><span class="hljs-number">4</span></span>,u,u&gt; mov edi, <span class="hljs-number"><span class="hljs-number">1</span></span> #  <span class="hljs-type"><span class="hljs-type">bool</span></span> d. <span class="hljs-keyword"><span class="hljs-keyword">call</span></span> foo(OptPoint2) vmovlps qword ptr [rsp + <span class="hljs-number"><span class="hljs-number">16</span></span>], xmm0 #    . mov byte ptr [rsp + <span class="hljs-number"><span class="hljs-number">24</span></span>], al #  al      rax.</code> </pre> <br><p> ,    <code>foo</code>  <code>inline</code> ,         . </p><br><pre> <code class="hljs go"> # OptPoint1 foo(OptPoint1)  OptPoint1 foo(<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> OptPoint1&amp;) vmovss xmm0, dword ptr [rip + .LCPI0_0] # xmm0 = mem[<span class="hljs-number"><span class="hljs-number">0</span></span>],zero,zero,zero vaddss xmm1, xmm0, dword ptr [rsp + <span class="hljs-number"><span class="hljs-number">32</span></span>] vaddss xmm0, xmm0, dword ptr [rsp + <span class="hljs-number"><span class="hljs-number">36</span></span>] vmovss dword ptr [rsp + <span class="hljs-number"><span class="hljs-number">8</span></span>], xmm1 vmovss dword ptr [rsp + <span class="hljs-number"><span class="hljs-number">12</span></span>], xmm0 mov <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span> ptr [rsp + <span class="hljs-number"><span class="hljs-number">16</span></span>], <span class="hljs-number"><span class="hljs-number">1</span></span> # OptPoint2 foo(OptPoint2)  OptPoint2 foo(<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> OptPoint2&amp;) vmovsd xmm0, qword ptr [rsp + <span class="hljs-number"><span class="hljs-number">48</span></span>] # xmm0 = mem[<span class="hljs-number"><span class="hljs-number">0</span></span>],zero vaddps xmm0, xmm0, xmmword ptr [rip + .LCPI0_1] vmovlps qword ptr [rsp + <span class="hljs-number"><span class="hljs-number">8</span></span>], xmm0 mov <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span> ptr [rsp + <span class="hljs-number"><span class="hljs-number">16</span></span>], <span class="hljs-number"><span class="hljs-number">1</span></span></code> </pre> <br><p> ,      ,      ,     . </p><br><p> :    <code>inline</code> ,     <code>std::optional</code>  . </p><br><h2 id="virtualnye-funkcii">   </h2><br><p>  ,     ,    .     . ,    .    , -        , , , .         . </p><br><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Fn</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">virtual</span></span> ~Fn() <span class="hljs-keyword"><span class="hljs-keyword">noexcept</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">default</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">virtual</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">call</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> x)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">const</span></span></span><span class="hljs-function"> </span></span>= <span class="hljs-number"><span class="hljs-number">0</span></span>; }; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Add</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">final</span></span></span><span class="hljs-class"> :</span></span> Fn { Add(<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> a) : a(a) {} <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">call</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> x)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">const</span></span></span><span class="hljs-function"> override </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> a + x; } <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> a; }; <span class="hljs-function"><span class="hljs-function">NOINLINE </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">isFixedPoint</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> Fn&amp; fn, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> x)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> fn.call(x) == x; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ Add add{<span class="hljs-number"><span class="hljs-number">32</span></span>}; <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> result = isFixedPoint(add, <span class="hljs-number"><span class="hljs-number">10</span></span>); }</code> </pre> <br><p>    -  . </p><br><pre> <code class="hljs vbscript">Add::<span class="hljs-keyword"><span class="hljs-keyword">call</span></span>(<span class="hljs-built_in"><span class="hljs-built_in">int</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">const</span></span>: # @Add::<span class="hljs-keyword"><span class="hljs-keyword">call</span></span>(<span class="hljs-built_in"><span class="hljs-built_in">int</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> #  rdi   this  ,   [rdi, rdi+<span class="hljs-number"><span class="hljs-number">8</span></span>)      ,       . add esi, dword ptr [rdi + <span class="hljs-number"><span class="hljs-number">8</span></span>] mov eax, esi #    rax, eax     <span class="hljs-number"><span class="hljs-number">32</span></span> . ret #      Add.       <span class="hljs-number"><span class="hljs-number">16</span></span>,   RTTI    . vtable <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> Add: .quad <span class="hljs-number"><span class="hljs-number">0</span></span> .quad typeinfo <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> Add #   RTTI.  <span class="hljs-number"><span class="hljs-number">-8.</span></span> .quad Fn::~Fn() # ,  <span class="hljs-number"><span class="hljs-number">0</span></span>    . .quad Add::~Add() .quad Add::<span class="hljs-keyword"><span class="hljs-keyword">call</span></span>(<span class="hljs-built_in"><span class="hljs-built_in">int</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> # ,  <span class="hljs-number"><span class="hljs-number">16</span></span> . isFixedPoint(Fn <span class="hljs-keyword"><span class="hljs-keyword">const</span></span>&amp;, <span class="hljs-built_in"><span class="hljs-built_in">int</span></span>): # @isFixedPoint(Fn <span class="hljs-keyword"><span class="hljs-keyword">const</span></span>&amp;, <span class="hljs-built_in"><span class="hljs-built_in">int</span></span>) push rbx #         rbx,    ,    . mov ebx, esi #  <span class="hljs-number"><span class="hljs-number">32</span></span>   . mov rax, qword ptr [rdi] #  rdi    -   Fn,         this . <span class="hljs-keyword"><span class="hljs-keyword">call</span></span> qword ptr [rax + <span class="hljs-number"><span class="hljs-number">16</span></span>] #  Add::<span class="hljs-keyword"><span class="hljs-keyword">call</span></span>. cmp eax, ebx #   <span class="hljs-keyword"><span class="hljs-keyword">call</span></span>    rax,    ebx,      . sete al #     <span class="hljs-number"><span class="hljs-number">8</span></span>   eax. pop rbx #   rbx. ret main: # @main <span class="hljs-keyword"><span class="hljs-keyword">sub</span></span> rsp, <span class="hljs-number"><span class="hljs-number">40</span></span> mov qword ptr [rsp + <span class="hljs-number"><span class="hljs-number">24</span></span>], vtable <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> Add+<span class="hljs-number"><span class="hljs-number">16</span></span> #          Add,    <span class="hljs-number"><span class="hljs-number">16</span></span>  ,    , ,  .    RTTI    . mov dword ptr [rsp + <span class="hljs-number"><span class="hljs-number">32</span></span>], <span class="hljs-number"><span class="hljs-number">32</span></span> #  add.a   . lea rdi, [rsp + <span class="hljs-number"><span class="hljs-number">24</span></span>] #      . mov esi, <span class="hljs-number"><span class="hljs-number">10</span></span> #   . <span class="hljs-keyword"><span class="hljs-keyword">call</span></span> isFixedPoint(Fn <span class="hljs-keyword"><span class="hljs-keyword">const</span></span>&amp;, <span class="hljs-built_in"><span class="hljs-built_in">int</span></span>) mov byte ptr [rsp + <span class="hljs-number"><span class="hljs-number">15</span></span>], al #    . ... mov rdi, rax #  . <span class="hljs-keyword"><span class="hljs-keyword">call</span></span> _Unwind_Resume mov rdi, rax <span class="hljs-keyword"><span class="hljs-keyword">call</span></span> _Unwind_Resume</code> </pre> <br><p>    <code>protected</code>   ,         ( 34-37).        <strong>NOINLINE</strong> ,               ( <code>false</code>   ).    <strong>NOINLINE</strong> ,        .       . </p><br><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Add</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">final</span></span></span><span class="hljs-class"> {</span></span> Add(<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> a) : a(a) {} <span class="hljs-function"><span class="hljs-function">NOINLINE </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">call</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> x)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">const</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> a + x; } <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> a; }; <span class="hljs-keyword"><span class="hljs-keyword">template</span></span>&lt;<span class="hljs-keyword"><span class="hljs-keyword">typename</span></span> T&gt; <span class="hljs-function"><span class="hljs-function">NOINLINE </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">isFixedPoint</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> T&amp; fn, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> x)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> fn.call(x) == x; }</code> </pre> <br><pre> <code class="hljs cpp">Add::call(<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">const</span></span>: # @Add::call(<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> add esi, dword ptr [rdi] #    , <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>   rdi  ,        ,      . mov eax, esi ret <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> isFixedPoint&lt;Add&gt;(Add <span class="hljs-keyword"><span class="hljs-keyword">const</span></span>&amp;, <span class="hljs-keyword"><span class="hljs-keyword">int</span></span>): # @<span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> isFixedPoint&lt;Add&gt;(Add <span class="hljs-keyword"><span class="hljs-keyword">const</span></span>&amp;, <span class="hljs-keyword"><span class="hljs-keyword">int</span></span>) push rbx mov ebx, esi # Add::call         ,   isFixedPoint. call Add::call(<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> cmp eax, ebx sete al pop rbx ret main: # @main sub rsp, <span class="hljs-number"><span class="hljs-number">24</span></span> mov dword ptr [rsp + <span class="hljs-number"><span class="hljs-number">8</span></span>], <span class="hljs-number"><span class="hljs-number">32</span></span> #  add.a. lea rdi, [rsp + <span class="hljs-number"><span class="hljs-number">8</span></span>] #    ,  rdi    add.a. mov esi, <span class="hljs-number"><span class="hljs-number">10</span></span> call <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> isFixedPoint&lt;Add&gt;(Add <span class="hljs-keyword"><span class="hljs-keyword">const</span></span>&amp;, <span class="hljs-keyword"><span class="hljs-keyword">int</span></span>) mov byte ptr [rsp + <span class="hljs-number"><span class="hljs-number">7</span></span>], al ... ret</code> </pre> <br><p>  ,      <strong>NOINLINE</strong> . </p><br><h3 id="sravnenie-proizvoditelnosti-2">   </h3><br><p>           1000   <code>Add</code>   <code>isFixedPoint</code>    . </p><br><table><thead><tr><th> Code </th><th> Cycles per iteration </th></tr></thead><tbody><tr><td>  <code>call</code>  ,   <code>isFixedPoint</code>  <code>call</code> </td><td> 5267 </td></tr><tr><td>  <code>call</code>  , <code>NOINLINE isFixedPoint</code> </td><td> 10721 </td></tr><tr><td>  <code>call</code>  , <code>INLINE isFixedPoint</code> </td><td> 8291 </td></tr><tr><td>   <code>call</code> , <code>NOINLINE isFixedPoint</code> </td><td> 10571 </td></tr><tr><td>   , <code>NOINLINE call</code> ,  <code>NOINLINE isFixedPoint</code> </td><td> 10536 </td></tr><tr><td>   ,   <code>isFixedPoint</code>  <code>call</code> </td><td> 4505 </td></tr><tr><td>   , <code>INLINE call</code> ,  <code>INLINE isFixedPoint</code> </td><td> 4531 </td></tr></tbody></table><br><p>   : </p><br><ul><li>     . </li><li>        ,     . </li><li>  ,       ,  ,  inline.      . </li><li>  <code>inline</code>       .   <code>inline</code>    -    cpp     ,     <strong>NOINLINE</strong> . </li><li> <code>inline</code>      . </li></ul><br><h2 id="hvostovye-vyzovy">   </h2><br><p>        <code>call</code> ,   <code>jmp</code>    . </p><br><p>  .  clang    .  ,   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">   </a> : </p><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">double</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">exp_by_squaring</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">double</span></span></span></span><span class="hljs-function"><span class="hljs-params"> x, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> n, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">double</span></span></span></span><span class="hljs-function"><span class="hljs-params"> y = </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">1</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (n &lt; <span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> exp_by_squaring(<span class="hljs-number"><span class="hljs-number">1.0</span></span> / x, -n, y); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (n == <span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> y; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (n == <span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> x * y; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (n % <span class="hljs-number"><span class="hljs-number">2</span></span> == <span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> exp_by_squaring(x * x, n / <span class="hljs-number"><span class="hljs-number">2</span></span>, y); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> exp_by_squaring(x * x, (n - <span class="hljs-number"><span class="hljs-number">1</span></span>) / <span class="hljs-number"><span class="hljs-number">2</span></span>, x * y); }</code> </pre> <br><p>  Nous obtenons: </p><br><pre> <code class="hljs pgsql">.LCPI0_0: .quad <span class="hljs-number"><span class="hljs-number">4607182418800017408</span></span> # <span class="hljs-type"><span class="hljs-type">double</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> exp_by_squaring(<span class="hljs-type"><span class="hljs-type">double</span></span>, <span class="hljs-type"><span class="hljs-type">int</span></span>, <span class="hljs-type"><span class="hljs-type">double</span></span>): # @exp_by_squaring(<span class="hljs-type"><span class="hljs-type">double</span></span>, <span class="hljs-type"><span class="hljs-type">int</span></span>, <span class="hljs-type"><span class="hljs-type">double</span></span>) vmovsd xmm2, qword ptr [rip + .LCPI0_0] # xmm2 = mem[<span class="hljs-number"><span class="hljs-number">0</span></span>],zero vmovapd xmm3, xmm0 test edi, edi jns .LBB0_4 jmp .LBB0_3 .LBB0_9: # <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Loop</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">Header</span></span>=BB0_4 Depth=<span class="hljs-number"><span class="hljs-number">1</span></span> shr edi vmovapd xmm3, xmm0 test edi, edi jns .LBB0_4 .LBB0_3: # =&gt;This <span class="hljs-keyword"><span class="hljs-keyword">Inner</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Loop</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Header</span></span>: Depth=<span class="hljs-number"><span class="hljs-number">1</span></span> vdivsd xmm3, xmm2, xmm3 neg edi test edi, edi js .LBB0_3 .LBB0_4: # =&gt;This <span class="hljs-keyword"><span class="hljs-keyword">Inner</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Loop</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Header</span></span>: Depth=<span class="hljs-number"><span class="hljs-number">1</span></span> je .LBB0_7 cmp edi, <span class="hljs-number"><span class="hljs-number">1</span></span> je .LBB0_6 vmulsd xmm0, xmm3, xmm3 test dil, <span class="hljs-number"><span class="hljs-number">1</span></span> je .LBB0_9 lea eax, [rdi - <span class="hljs-number"><span class="hljs-number">1</span></span>] shr eax, <span class="hljs-number"><span class="hljs-number">31</span></span> lea edi, [rdi + rax] <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> edi, <span class="hljs-number"><span class="hljs-number">-1</span></span> sar edi vmulsd xmm1, xmm3, xmm1 vmovapd xmm3, xmm0 test edi, edi jns .LBB0_4 jmp .LBB0_3 .LBB0_6: vmulsd xmm1, xmm3, xmm1 .LBB0_7: vmovapd xmm0, xmm1 ret</code> </pre> <br><p>  ,     ,  .    ,   ,   .      ~10% . </p><br><p>            .             . </p><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">int64_t</span></span> sum(<span class="hljs-keyword"><span class="hljs-keyword">int64_t</span></span> x, <span class="hljs-keyword"><span class="hljs-keyword">int64_t</span></span> y) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> x + y; } <span class="hljs-keyword"><span class="hljs-keyword">int64_t</span></span> add1(<span class="hljs-keyword"><span class="hljs-keyword">int64_t</span></span> x) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> sum(x, <span class="hljs-number"><span class="hljs-number">1</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">int64_t</span></span> add2(<span class="hljs-keyword"><span class="hljs-keyword">int64_t</span></span> x) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> sum(<span class="hljs-number"><span class="hljs-number">1</span></span>, x); } <span class="hljs-keyword"><span class="hljs-keyword">int64_t</span></span> add3(<span class="hljs-keyword"><span class="hljs-keyword">int64_t</span></span> x) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> sum(<span class="hljs-number"><span class="hljs-number">-1</span></span>, x) + <span class="hljs-number"><span class="hljs-number">2</span></span>; }</code> </pre> <br><pre> <code class="hljs vala">sum(<span class="hljs-keyword"><span class="hljs-keyword">long</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">long</span></span>): # @sum(<span class="hljs-keyword"><span class="hljs-keyword">long</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">long</span></span>) lea rax, [rdi + rsi] ret add1(<span class="hljs-keyword"><span class="hljs-keyword">long</span></span>): # @add1(<span class="hljs-keyword"><span class="hljs-keyword">long</span></span>) mov esi, <span class="hljs-number"><span class="hljs-number">1</span></span> #   . jmp sum(<span class="hljs-keyword"><span class="hljs-keyword">long</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">long</span></span>) # TAILCALL add2(<span class="hljs-keyword"><span class="hljs-keyword">long</span></span>): # @add2(<span class="hljs-keyword"><span class="hljs-keyword">long</span></span>) mov rax, rdi #   . mov edi, <span class="hljs-number"><span class="hljs-number">1</span></span> mov rsi, rax jmp sum(<span class="hljs-keyword"><span class="hljs-keyword">long</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">long</span></span>) # TAILCALL add3(<span class="hljs-keyword"><span class="hljs-keyword">long</span></span>): # @add3(<span class="hljs-keyword"><span class="hljs-keyword">long</span></span>) push rax #  rax   . mov rax, rdi #  ,    add2,  . mov rdi, <span class="hljs-number"><span class="hljs-number">-1</span></span> mov rsi, rax call sum(<span class="hljs-keyword"><span class="hljs-keyword">long</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">long</span></span>) add rax, <span class="hljs-number"><span class="hljs-number">2</span></span> #  <span class="hljs-number"><span class="hljs-number">2</span></span>    . pop rcx ret</code> </pre> <br><p>  ,           ,     <code>call</code> ,    <code>jmp</code> .   ,     ,     <code>sum</code> ,     ,  <code>add</code> . </p><br><p>       ,          10%. </p><br><p> : </p><br><ul><li>      ,            . </li><li>       . </li></ul><br><h2 id="inicializaciya">  </h2><br><p>           .    2D      : </p><br><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Point</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">double</span></span> x, y; }; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ZeroPoint</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">double</span></span> x{}, y{}; }; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">NanPoint</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">double</span></span> x{quietNaN}, y{quietNaN}; };</code> </pre> <br><p>  <code>Point</code>  . <code>ZeroPoint</code>  .   IEEE 754-1985: </p><br><blockquote> The number zero is represented specially: sign = 0 for positive zero, 1 for negative zero; biased exponent = 0; fraction = 0; </blockquote><p>         <code>memset</code> . <code>NanPoint</code>   <code>numeric_limits&lt;double&gt;::quiet_NaN();</code> ,           . </p><br><h3 id="odin-element">   </h3><br><pre> <code class="cpp hljs">Point data;</code> </pre> <br><pre> <code class="hljs perl"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">sub</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">rsp</span></span></span><span class="hljs-function">, 24</span></span></code> </pre> <br><p>       - . </p><br><pre> <code class="cpp hljs">ZeroPoint data; Point data{};</code> </pre> <br><p>     . </p><br><pre> <code class="hljs powershell"> sub rsp, <span class="hljs-number"><span class="hljs-number">40</span></span> vxorps xmm0, xmm0, xmm0 vmovaps xmmword ptr [<span class="hljs-type"><span class="hljs-type">rsp</span></span> + <span class="hljs-number"><span class="hljs-number">16</span></span>], xmm0</code> </pre> <br><p>    .   <code>xmm0</code> .    <code>XOR</code>   <code>vxorps</code>    .       . </p><br><pre> <code class="cpp hljs">NanPoint data;</code> </pre> <br><pre> <code class="hljs powershell"> sub rsp, <span class="hljs-number"><span class="hljs-number">40</span></span> vmovaps xmm0, xmmword ptr [<span class="hljs-type"><span class="hljs-type">rip</span></span> + <span class="hljs-type"><span class="hljs-type">.LCPI0_0</span></span>] <span class="hljs-comment"><span class="hljs-comment"># xmm0 = [nan,nan] vmovaps xmmword ptr [rsp + 16], xmm0</span></span></code> </pre> <br><p>   ,          . </p><br><h3 id="nebolshoy-massiv">   </h3><br><p>       : </p><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">constexpr</span></span> <span class="hljs-keyword"><span class="hljs-keyword">size_t</span></span> smallSize = <span class="hljs-number"><span class="hljs-number">8</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">constexpr</span></span> <span class="hljs-keyword"><span class="hljs-keyword">size_t</span></span> bigSize = <span class="hljs-number"><span class="hljs-number">321</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">extern</span></span> <span class="hljs-keyword"><span class="hljs-keyword">size_t</span></span> smallUnknownSize; <span class="hljs-comment"><span class="hljs-comment">// Also 8 extern size_t bigUnknownSize; // Also 321</span></span></code> </pre> <br><p>     . </p><br><pre> <code class="cpp hljs"><span class="hljs-built_in"><span class="hljs-built_in">array</span></span>&lt;Point, smallSize&gt; data;</code> </pre> <br><p>    ‚Äì     . </p><br><pre> <code class="hljs perl"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">sub</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">rsp</span></span></span><span class="hljs-function">, 136</span></span></code> </pre> <br><p>       ,     . </p><br><pre> <code class="cpp hljs"><span class="hljs-built_in"><span class="hljs-built_in">array</span></span>&lt;ZeroPoint, smallSize&gt; data; <span class="hljs-built_in"><span class="hljs-built_in">array</span></span>&lt;ZeroPoint, smallSize&gt; data{}; <span class="hljs-built_in"><span class="hljs-built_in">array</span></span>&lt;Point, smallSize&gt; data{};</code> </pre> <br><p>         . </p><br><pre> <code class="hljs powershell"> sub rsp, <span class="hljs-number"><span class="hljs-number">192</span></span> vxorps ymm0, ymm0, ymm0 vmovaps ymmword ptr [<span class="hljs-type"><span class="hljs-type">rsp</span></span> + <span class="hljs-number"><span class="hljs-number">128</span></span>], ymm0 vmovaps ymmword ptr [<span class="hljs-type"><span class="hljs-type">rsp</span></span> + <span class="hljs-number"><span class="hljs-number">96</span></span>], ymm0 vmovaps ymmword ptr [<span class="hljs-type"><span class="hljs-type">rsp</span></span> + <span class="hljs-number"><span class="hljs-number">64</span></span>], ymm0 vmovaps ymmword ptr [<span class="hljs-type"><span class="hljs-type">rsp</span></span> + <span class="hljs-number"><span class="hljs-number">32</span></span>], ymm0</code> </pre> <br><p>     256 ,  2 . </p><br><pre> <code class="cpp hljs"><span class="hljs-built_in"><span class="hljs-built_in">array</span></span>&lt;NanPoint, smallSize&gt; data; <span class="hljs-built_in"><span class="hljs-built_in">array</span></span>&lt;NanPoint, smallSize&gt; data{};</code> </pre> <br><pre> <code class="hljs powershell"> sub rsp, <span class="hljs-number"><span class="hljs-number">136</span></span> vmovaps xmm0, xmmword ptr [<span class="hljs-type"><span class="hljs-type">rip</span></span> + <span class="hljs-type"><span class="hljs-type">.LCPI0_0</span></span>] <span class="hljs-comment"><span class="hljs-comment"># xmm0 = [nan,nan] vmovups xmmword ptr [rsp + 24], xmm0 vmovups xmmword ptr [rsp + 8], xmm0 vmovups xmmword ptr [rsp + 56], xmm0 vmovups xmmword ptr [rsp + 40], xmm0 vmovups xmmword ptr [rsp + 88], xmm0 vmovups xmmword ptr [rsp + 72], xmm0 vmovups xmmword ptr [rsp + 120], xmm0 vmovups xmmword ptr [rsp + 104], xmm0</span></span></code> </pre> <br><p>      . </p><br><h3 id="bolshoy-massiv">   </h3><br><pre> <code class="cpp hljs"><span class="hljs-built_in"><span class="hljs-built_in">array</span></span>&lt;Point, bigSize&gt; data;</code> </pre> <br><pre> <code class="hljs perl"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">sub</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">rsp</span></span></span><span class="hljs-function">, 5144</span></span></code> </pre> <br><p>   . </p><br><pre> <code class="cpp hljs"><span class="hljs-built_in"><span class="hljs-built_in">array</span></span>&lt;ZeroPoint, bigSize&gt; data; <span class="hljs-built_in"><span class="hljs-built_in">array</span></span>&lt;ZeroPoint, bigSize&gt; data{}; <span class="hljs-built_in"><span class="hljs-built_in">array</span></span>&lt;Point, bigSize&gt; data{};</code> </pre> <br><pre> <code class="hljs vbscript"> <span class="hljs-keyword"><span class="hljs-keyword">sub</span></span> rsp, <span class="hljs-number"><span class="hljs-number">5152</span></span> lea rbx, [rsp + <span class="hljs-number"><span class="hljs-number">16</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">xor</span></span> esi, esi mov edx, <span class="hljs-number"><span class="hljs-number">5136</span></span> mov rdi, rbx <span class="hljs-keyword"><span class="hljs-keyword">call</span></span> memset #  memset(rsp+<span class="hljs-number"><span class="hljs-number">16</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">5136</span></span>).</code> </pre> <br><p>     ,  <code>memset</code> .   ,      ,    <code>rdi, esi, edx</code> .  <code>e</code>  <code>d</code>     32  64- . </p><br><pre> <code class="cpp hljs"><span class="hljs-built_in"><span class="hljs-built_in">array</span></span>&lt;NanPoint, bigSize&gt; data;</code> </pre> <br><pre> <code class="hljs powershell"> sub rsp, <span class="hljs-number"><span class="hljs-number">5144</span></span> lea rax, [<span class="hljs-type"><span class="hljs-type">rsp</span></span> + <span class="hljs-number"><span class="hljs-number">8</span></span>] lea rcx, [<span class="hljs-type"><span class="hljs-type">rsp</span></span> + <span class="hljs-number"><span class="hljs-number">5144</span></span>] vmovaps xmm0, xmmword ptr [<span class="hljs-type"><span class="hljs-type">rip</span></span> + <span class="hljs-type"><span class="hljs-type">.LCPI0_0</span></span>] <span class="hljs-comment"><span class="hljs-comment"># xmm0 = [nan,nan] #  . .LBB0_1: # =&gt;This Inner Loop Header: Depth=1 vmovups xmmword ptr [rax], xmm0 vmovups xmmword ptr [rax + 16], xmm0 vmovups xmmword ptr [rax + 32], xmm0 add rax, 48 cmp rax, rcx jne .LBB0_1</span></span></code> </pre> <br><p>    .       ,    321   3  .   <code>rax, rcx</code>      . </p><br><pre> <code class="cpp hljs"><span class="hljs-built_in"><span class="hljs-built_in">array</span></span>&lt;NanPoint, bigSize&gt; data{};</code> </pre> <br><pre> <code class="hljs pgsql"> sub rsp, <span class="hljs-number"><span class="hljs-number">5152</span></span> lea rbx, [rsp + <span class="hljs-number"><span class="hljs-number">16</span></span>] xor esi, esi mov edx, <span class="hljs-number"><span class="hljs-number">5136</span></span> mov rdi, rbx <span class="hljs-keyword"><span class="hljs-keyword">call</span></span> memset #  memset(rsp+<span class="hljs-number"><span class="hljs-number">16</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">5136</span></span>). lea rax, [rsp + <span class="hljs-number"><span class="hljs-number">5152</span></span>] vmovaps xmm0, xmmword ptr [rip + .LCPI0_0] # xmm0 = [<span class="hljs-keyword"><span class="hljs-keyword">nan</span></span>,<span class="hljs-keyword"><span class="hljs-keyword">nan</span></span>] #  . .LBB0_1: # =&gt;This <span class="hljs-keyword"><span class="hljs-keyword">Inner</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Loop</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Header</span></span>: Depth=<span class="hljs-number"><span class="hljs-number">1</span></span> vmovups xmmword ptr [rbx], xmm0 vmovups xmmword ptr [rbx + <span class="hljs-number"><span class="hljs-number">16</span></span>], xmm0 vmovups xmmword ptr [rbx + <span class="hljs-number"><span class="hljs-number">32</span></span>], xmm0 <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> rbx, <span class="hljs-number"><span class="hljs-number">48</span></span> cmp rbx, rax jne .LBB0_1</code> </pre> <br><p>      .   ,    <code>memset</code> .  ,     ,       .        . </p><br><h3 id="dinamicheskiy-massiv">   </h3><br><pre> <code class="cpp hljs"><span class="hljs-built_in"><span class="hljs-built_in">vector</span></span>&lt;Point&gt; data(smallSize);</code> </pre> <br><pre> <code class="hljs css"> <span class="hljs-selector-tag"><span class="hljs-selector-tag">sub</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">rsp</span></span>, 40 <span class="hljs-selector-tag"><span class="hljs-selector-tag">vxorps</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">xmm0</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">xmm0</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">xmm0</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">vmovaps</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">xmmword</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">ptr</span></span> <span class="hljs-selector-attr"><span class="hljs-selector-attr">[rsp]</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">xmm0</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">mov</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">qword</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">ptr</span></span> <span class="hljs-selector-attr"><span class="hljs-selector-attr">[rsp + 16]</span></span>, 0 <span class="hljs-selector-tag"><span class="hljs-selector-tag">mov</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">edi</span></span>, 128 <span class="hljs-selector-tag"><span class="hljs-selector-tag">call</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">operator</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">new</span></span>(<span class="hljs-selector-tag"><span class="hljs-selector-tag">unsigned</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">long</span></span>) #  <span class="hljs-selector-tag"><span class="hljs-selector-tag">new</span></span>(128). <span class="hljs-selector-tag"><span class="hljs-selector-tag">mov</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">qword</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">ptr</span></span> <span class="hljs-selector-attr"><span class="hljs-selector-attr">[rsp]</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">rax</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">mov</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">rcx</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">rax</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">sub</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">rcx</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">-128</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">mov</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">qword</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">ptr</span></span> <span class="hljs-selector-attr"><span class="hljs-selector-attr">[rsp + 16]</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">rcx</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">vxorps</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">xmm0</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">xmm0</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">xmm0</span></span> #     . <span class="hljs-selector-tag"><span class="hljs-selector-tag">vmovups</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">xmmword</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">ptr</span></span> <span class="hljs-selector-attr"><span class="hljs-selector-attr">[rax + 16]</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">xmm0</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">vmovups</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">xmmword</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">ptr</span></span> <span class="hljs-selector-attr"><span class="hljs-selector-attr">[rax]</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">xmm0</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">vmovups</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">xmmword</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">ptr</span></span> <span class="hljs-selector-attr"><span class="hljs-selector-attr">[rax + 32]</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">xmm0</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">vmovups</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">xmmword</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">ptr</span></span> <span class="hljs-selector-attr"><span class="hljs-selector-attr">[rax + 48]</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">xmm0</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">vmovups</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">xmmword</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">ptr</span></span> <span class="hljs-selector-attr"><span class="hljs-selector-attr">[rax + 64]</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">xmm0</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">vmovups</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">xmmword</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">ptr</span></span> <span class="hljs-selector-attr"><span class="hljs-selector-attr">[rax + 80]</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">xmm0</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">vmovups</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">xmmword</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">ptr</span></span> <span class="hljs-selector-attr"><span class="hljs-selector-attr">[rax + 96]</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">xmm0</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">vmovups</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">xmmword</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">ptr</span></span> <span class="hljs-selector-attr"><span class="hljs-selector-attr">[rax + 112]</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">xmm0</span></span></code> </pre> <br><p>  <code>new</code>    .  ,      <code>T{}</code> ,    ,   .   <code>ZeroPoint</code>  <code>NanPoint</code>  .   : </p><br><pre> <code class="cpp hljs"><span class="hljs-built_in"><span class="hljs-built_in">vector</span></span>&lt;Point&gt; data(bigSize);</code> </pre> <br><pre> <code class="hljs pgsql">main: # @main push rbx sub rsp, <span class="hljs-number"><span class="hljs-number">48</span></span> vxorps xmm0, xmm0, xmm0 vmovaps xmmword ptr [rsp], xmm0 mov qword ptr [rsp + <span class="hljs-number"><span class="hljs-number">16</span></span>], <span class="hljs-number"><span class="hljs-number">0</span></span> mov edi, <span class="hljs-number"><span class="hljs-number">5136</span></span> <span class="hljs-keyword"><span class="hljs-keyword">call</span></span> <span class="hljs-keyword"><span class="hljs-keyword">operator</span></span> <span class="hljs-built_in"><span class="hljs-built_in">new</span></span>(unsigned long) #  <span class="hljs-built_in"><span class="hljs-built_in">new</span></span>(<span class="hljs-number"><span class="hljs-number">5136</span></span>). mov qword ptr [rsp], rax mov qword ptr [rsp + <span class="hljs-number"><span class="hljs-number">8</span></span>], rax mov rcx, rax <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> rcx, <span class="hljs-number"><span class="hljs-number">5136</span></span> mov qword ptr [rsp + <span class="hljs-number"><span class="hljs-number">16</span></span>], rcx vxorps xmm0, xmm0, xmm0 vmovaps xmmword ptr [rsp + <span class="hljs-number"><span class="hljs-number">32</span></span>], xmm0 xor edx, edx #    . .LBB0_2: # =&gt;This <span class="hljs-keyword"><span class="hljs-keyword">Inner</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Loop</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Header</span></span>: Depth=<span class="hljs-number"><span class="hljs-number">1</span></span> vmovaps xmm0, xmmword ptr [rsp + <span class="hljs-number"><span class="hljs-number">32</span></span>] vmovups xmmword ptr [rax + rdx], xmm0 vmovaps xmm0, xmmword ptr [rsp + <span class="hljs-number"><span class="hljs-number">32</span></span>] vmovups xmmword ptr [rax + rdx + <span class="hljs-number"><span class="hljs-number">16</span></span>], xmm0 vmovaps xmm0, xmmword ptr [rsp + <span class="hljs-number"><span class="hljs-number">32</span></span>] vmovups xmmword ptr [rax + rdx + <span class="hljs-number"><span class="hljs-number">32</span></span>], xmm0 <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> rdx, <span class="hljs-number"><span class="hljs-number">48</span></span> cmp rdx, <span class="hljs-number"><span class="hljs-number">5136</span></span> jne .LBB0_2 mov qword ptr [rsp + <span class="hljs-number"><span class="hljs-number">8</span></span>], rcx mov rax, rsp</code> </pre> <br><p>      ,     .    <code>NanPoint</code>   . </p><br><pre> <code class="cpp hljs"><span class="hljs-built_in"><span class="hljs-built_in">vector</span></span>&lt;NanPoint&gt; data(bigSize);</code> </pre> <br><pre> <code class="hljs pgsql">main: # @main push rbx sub rsp, <span class="hljs-number"><span class="hljs-number">32</span></span> vxorps xmm0, xmm0, xmm0 vmovaps xmmword ptr [rsp], xmm0 mov qword ptr [rsp + <span class="hljs-number"><span class="hljs-number">16</span></span>], <span class="hljs-number"><span class="hljs-number">0</span></span> mov edi, <span class="hljs-number"><span class="hljs-number">5136</span></span> <span class="hljs-keyword"><span class="hljs-keyword">call</span></span> <span class="hljs-keyword"><span class="hljs-keyword">operator</span></span> <span class="hljs-built_in"><span class="hljs-built_in">new</span></span>(unsigned long) #  <span class="hljs-built_in"><span class="hljs-built_in">new</span></span>(<span class="hljs-number"><span class="hljs-number">5136</span></span>). mov qword ptr [rsp], rax mov qword ptr [rsp + <span class="hljs-number"><span class="hljs-number">8</span></span>], rax mov rcx, rax <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> rcx, <span class="hljs-number"><span class="hljs-number">5136</span></span> mov qword ptr [rsp + <span class="hljs-number"><span class="hljs-number">16</span></span>], rcx xor edx, edx vmovaps xmm0, xmmword ptr [rip + .LCPI0_0] # xmm0 = [<span class="hljs-keyword"><span class="hljs-keyword">nan</span></span>,<span class="hljs-keyword"><span class="hljs-keyword">nan</span></span>] #    <span class="hljs-keyword"><span class="hljs-keyword">NAN</span></span>. .LBB0_2: # =&gt;This <span class="hljs-keyword"><span class="hljs-keyword">Inner</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Loop</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Header</span></span>: Depth=<span class="hljs-number"><span class="hljs-number">1</span></span> vmovups xmmword ptr [rax + rdx], xmm0 vmovups xmmword ptr [rax + rdx + <span class="hljs-number"><span class="hljs-number">16</span></span>], xmm0 vmovups xmmword ptr [rax + rdx + <span class="hljs-number"><span class="hljs-number">32</span></span>], xmm0 <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> rdx, <span class="hljs-number"><span class="hljs-number">48</span></span> cmp rdx, <span class="hljs-number"><span class="hljs-number">5136</span></span> jne .LBB0_2 mov qword ptr [rsp + <span class="hljs-number"><span class="hljs-number">8</span></span>], rcx mov rax, rsp</code> </pre> <br><p> A    <code>ZeroPoint</code>   . </p><br><pre> <code class="cpp hljs"><span class="hljs-built_in"><span class="hljs-built_in">vector</span></span>&lt;ZeroPoint&gt; data(bigSize);</code> </pre> <br><pre> <code class="hljs pgsql"> sub rsp, <span class="hljs-number"><span class="hljs-number">32</span></span> vxorps xmm0, xmm0, xmm0 vmovaps xmmword ptr [rsp], xmm0 mov qword ptr [rsp + <span class="hljs-number"><span class="hljs-number">16</span></span>], <span class="hljs-number"><span class="hljs-number">0</span></span> mov edi, <span class="hljs-number"><span class="hljs-number">5136</span></span> <span class="hljs-keyword"><span class="hljs-keyword">call</span></span> <span class="hljs-keyword"><span class="hljs-keyword">operator</span></span> <span class="hljs-built_in"><span class="hljs-built_in">new</span></span>(unsigned long) #  <span class="hljs-built_in"><span class="hljs-built_in">new</span></span>(<span class="hljs-number"><span class="hljs-number">5136</span></span>). mov qword ptr [rsp], rax mov rbx, rax <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> rbx, <span class="hljs-number"><span class="hljs-number">5136</span></span> mov qword ptr [rsp + <span class="hljs-number"><span class="hljs-number">16</span></span>], rbx xor esi, esi mov edx, <span class="hljs-number"><span class="hljs-number">5136</span></span> mov rdi, rax <span class="hljs-keyword"><span class="hljs-keyword">call</span></span> memset #  memset(&amp;data, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">5136</span></span>).</code> </pre> <br><p>      <code>memset</code> . ,     , <code>memset</code>     <code>Point</code> . ,  ,   <code>bigUnknownSize</code>     . </p><br><pre> <code class="cpp hljs"><span class="hljs-built_in"><span class="hljs-built_in">vector</span></span>&lt;NanPoint&gt; data(bigUnknownSize);</code> </pre> <br><pre> <code class="hljs pgsql"> sub rsp, <span class="hljs-number"><span class="hljs-number">32</span></span> mov rbx, qword ptr [rip + bigUnknownSize] vxorps xmm0, xmm0, xmm0 vmovaps xmmword ptr [rsp], xmm0 mov qword ptr [rsp + <span class="hljs-number"><span class="hljs-number">16</span></span>], <span class="hljs-number"><span class="hljs-number">0</span></span> test rbx, rbx #  bigUnknownSize == <span class="hljs-number"><span class="hljs-number">0</span></span>,   <span class="hljs-built_in"><span class="hljs-built_in">new</span></span>. je .LBB0_1 mov rax, rbx shr rax, <span class="hljs-number"><span class="hljs-number">60</span></span> jne .LBB0_3 mov rdi, rbx shl rdi, <span class="hljs-number"><span class="hljs-number">4</span></span> #   <span class="hljs-number"><span class="hljs-number">16</span></span>    <span class="hljs-number"><span class="hljs-number">4.</span></span> <span class="hljs-keyword"><span class="hljs-keyword">call</span></span> <span class="hljs-keyword"><span class="hljs-keyword">operator</span></span> <span class="hljs-built_in"><span class="hljs-built_in">new</span></span>(unsigned long) #  <span class="hljs-built_in"><span class="hljs-built_in">new</span></span>(bigUnknownSize*<span class="hljs-number"><span class="hljs-number">16</span></span>). jmp .LBB0_6 .LBB0_1: xor eax, eax .LBB0_6: mov rcx, rbx shl rcx, <span class="hljs-number"><span class="hljs-number">4</span></span> <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> rcx, rax mov qword ptr [rsp], rax mov qword ptr [rsp + <span class="hljs-number"><span class="hljs-number">8</span></span>], rax mov qword ptr [rsp + <span class="hljs-number"><span class="hljs-number">16</span></span>], rcx test rbx, rbx #  bigUnknownSize == <span class="hljs-number"><span class="hljs-number">0</span></span>,   . je .LBB0_14 lea rdx, [rbx - <span class="hljs-number"><span class="hljs-number">1</span></span>] mov rsi, rbx <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> rsi, <span class="hljs-number"><span class="hljs-number">7</span></span> je .LBB0_10 neg rsi vmovaps xmm0, xmmword ptr [rip + .LCPI0_0] # xmm0 = [<span class="hljs-keyword"><span class="hljs-keyword">nan</span></span>,<span class="hljs-keyword"><span class="hljs-keyword">nan</span></span>] #   <span class="hljs-number"><span class="hljs-number">0</span></span><span class="hljs-number"><span class="hljs-number">-7</span></span> . .LBB0_9: # =&gt;This <span class="hljs-keyword"><span class="hljs-keyword">Inner</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Loop</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Header</span></span>: Depth=<span class="hljs-number"><span class="hljs-number">1</span></span> vmovups xmmword ptr [rax], xmm0 <span class="hljs-type"><span class="hljs-type">dec</span></span> rbx <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> rax, <span class="hljs-number"><span class="hljs-number">16</span></span> inc rsi jne .LBB0_9 .LBB0_10: cmp rdx, <span class="hljs-number"><span class="hljs-number">7</span></span> jb .LBB0_13 vmovaps xmm0, xmmword ptr [rip + .LCPI0_0] # xmm0 = [<span class="hljs-keyword"><span class="hljs-keyword">nan</span></span>,<span class="hljs-keyword"><span class="hljs-keyword">nan</span></span>] #      <span class="hljs-number"><span class="hljs-number">8.</span></span> .LBB0_12: # =&gt;This <span class="hljs-keyword"><span class="hljs-keyword">Inner</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Loop</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Header</span></span>: Depth=<span class="hljs-number"><span class="hljs-number">1</span></span> vmovups xmmword ptr [rax], xmm0 vmovups xmmword ptr [rax + <span class="hljs-number"><span class="hljs-number">16</span></span>], xmm0 vmovups xmmword ptr [rax + <span class="hljs-number"><span class="hljs-number">32</span></span>], xmm0 vmovups xmmword ptr [rax + <span class="hljs-number"><span class="hljs-number">48</span></span>], xmm0 vmovups xmmword ptr [rax + <span class="hljs-number"><span class="hljs-number">64</span></span>], xmm0 vmovups xmmword ptr [rax + <span class="hljs-number"><span class="hljs-number">80</span></span>], xmm0 vmovups xmmword ptr [rax + <span class="hljs-number"><span class="hljs-number">96</span></span>], xmm0 vmovups xmmword ptr [rax + <span class="hljs-number"><span class="hljs-number">112</span></span>], xmm0 sub rax, <span class="hljs-number"><span class="hljs-number">-128</span></span> <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> rbx, <span class="hljs-number"><span class="hljs-number">-8</span></span> jne .LBB0_12 .LBB0_13: mov rax, rcx .LBB0_14: mov qword ptr [rsp + <span class="hljs-number"><span class="hljs-number">8</span></span>], rax mov rax, rsp</code> </pre> <br><p>    . , <code>LBB0_9</code>       ,        8.      8   . </p><br><p>     ,   <code>Point</code>   ,   <code>ZeroPoint</code>   <code>memset</code> : </p><br><pre> <code class="cpp hljs"><span class="hljs-built_in"><span class="hljs-built_in">vector</span></span>&lt;ZeroPoint&gt; data(bigUnknownSize);</code> </pre> <br><pre> <code class="hljs cpp"> sub rsp, <span class="hljs-number"><span class="hljs-number">40</span></span> mov rbx, qword ptr [rip + bigUnknownSize] vxorps xmm0, xmm0, xmm0 vmovaps xmmword ptr [rsp], xmm0 mov qword ptr [rsp + <span class="hljs-number"><span class="hljs-number">16</span></span>], <span class="hljs-number"><span class="hljs-number">0</span></span> test rbx, rbx #  bigUnknownSize == <span class="hljs-number"><span class="hljs-number">0</span></span>,   <span class="hljs-keyword"><span class="hljs-keyword">new</span></span>. je .LBB0_1 mov rax, rbx shr rax, <span class="hljs-number"><span class="hljs-number">60</span></span> jne .LBB0_3 mov rdi, rbx shl rdi, <span class="hljs-number"><span class="hljs-number">4</span></span> call <span class="hljs-keyword"><span class="hljs-keyword">operator</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span>) #  <span class="hljs-keyword"><span class="hljs-keyword">new</span></span>(bigUnknownSize*<span class="hljs-number"><span class="hljs-number">16</span></span>). jmp .LBB0_6 .LBB0_1: xor eax, eax .LBB0_6: mov rdx, rbx shl rdx, <span class="hljs-number"><span class="hljs-number">4</span></span> lea r14, [rax + rdx] mov qword ptr [rsp], rax mov qword ptr [rsp + <span class="hljs-number"><span class="hljs-number">8</span></span>], rax mov qword ptr [rsp + <span class="hljs-number"><span class="hljs-number">16</span></span>], r14 test rbx, rbx #  bigUnknownSize == <span class="hljs-number"><span class="hljs-number">0</span></span>,   <span class="hljs-built_in"><span class="hljs-built_in">memset</span></span>. je .LBB0_8 xor esi, esi mov rdi, rax call <span class="hljs-built_in"><span class="hljs-built_in">memset</span></span> #  <span class="hljs-built_in"><span class="hljs-built_in">memset</span></span>(&amp;data, <span class="hljs-number"><span class="hljs-number">0</span></span>, bigUnknownSize*<span class="hljs-number"><span class="hljs-number">16</span></span>). mov rax, r14 .LBB0_8: mov qword ptr [rsp + <span class="hljs-number"><span class="hljs-number">8</span></span>], rax mov rax, rsp</code> </pre> <br><p> ,  </p><br><pre> <code class="cpp hljs"><span class="hljs-built_in"><span class="hljs-built_in">vector</span></span>&lt;NanPoint&gt; data; data.resize(bigUnknownSize);</code> </pre> <br><p>   250  ,          .  <code>operator new</code>    ,         . </p><br><h3 id="sravnenie-proizvoditelnosti-3">   </h3><br><p>       . </p><br><table><thead><tr><th> Code </th><th> Cycles per iteration </th></tr></thead><tbody><tr><td> <code>Point p;</code> </td> <td>  4.5 </td></tr><tr><td> <code>ZeroPoint p;</code> </td> <td>  5.2 </td></tr><tr><td> <code>NanPoint p;</code> </td> <td>  4.5 </td></tr><tr><td> <code>array&lt;Point, smallSize&gt; p;</code> </td> <td>  4.5 </td></tr><tr><td> <code>array&lt;ZeroPoint, smallSize&gt; p;</code> </td> <td> 6.7 </td></tr><tr><td> <code>array&lt;NanPoint, smallSize&gt; p;</code> </td> <td> 6.7 </td></tr><tr><td> <code>array&lt;Point, bigSize&gt; p;</code> </td> <td>  4.5 </td></tr><tr><td> <code>array&lt;ZeroPoint, bigSize&gt; p;</code> </td> <td> 296.0 </td></tr><tr><td> <code>array&lt;NanPoint, bigSize&gt; p;</code> </td> <td> 391.0 </td></tr><tr><td> <code>array&lt;Point, bigSize&gt; p{};</code> </td> <td> 292.0 </td></tr><tr><td> <code>array&lt;NanPoint, bigSize&gt; p{};</code> </td> <td> <strong>657.0</strong> </td></tr><tr><td> <code>vector&lt;Point&gt; p(smallSize);</code> </td> <td> 32.3 </td></tr><tr><td> <code>vector&lt;ZeroPoint&gt; p(smallSize);</code> </td> <td> 33.8 </td></tr><tr><td> <code>vector&lt;NanPoint&gt; p(smallSize);</code> </td> <td> 33.8 </td></tr><tr><td> <code>vector&lt;Point&gt; p(bigSize);</code> </td> <td> 323.0 </td></tr><tr><td> <code>vector&lt;ZeroPoint&gt; p(bigSize);</code> </td> <td> 308.0 </td></tr><tr><td> <code>vector&lt;NanPoint&gt; p(bigSize);</code> </td> <td> 281.0 </td></tr><tr><td> <code>vector&lt;ZeroPoint&gt; p(smallUnknownSize);</code> </td> <td> 44.1 </td></tr><tr><td> <code>vector&lt;NanPoint&gt; p(smallUnknownSize);</code> </td> <td> 37.6 </td></tr><tr><td> <code>vector&lt;Point&gt; p(bigUnknownSize);</code> </td> <td> 311.0 </td></tr><tr><td> <code>vector&lt;ZeroPoint&gt; p(bigUnknownSize);</code> </td> <td> 315.0 </td></tr><tr><td> <code>vector&lt;NanPoint&gt; p(bigUnknownSize);</code> </td> <td> 290.0 </td></tr><tr><td> <code>vector&lt;NanPoint&gt; p; p.resize(bigUnknownSize);</code> </td> <td> 315.0 </td></tr></tbody></table><br><p> : </p><br><ul><li>         . </li><li>       . </li><li>      <code>memset</code>   ,        . </li><li>          . </li><li>       ,  .          . </li><li>        .        . </li><li>      ,      .         . </li></ul></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr414443/">https://habr.com/ru/post/fr414443/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr414429/index.html">Comment apprendre une langue √©trang√®re sans professeur. Partie 1. ¬´Mon exp√©rience¬ª</a></li>
<li><a href="../fr414431/index.html">Mitap JavaJam. D√©bat Javista, rafting, exp√©riences et microservices</a></li>
<li><a href="../fr414433/index.html">Nous nous promenons sagement dans la ville: comme j'ai fait le service pour construire des itin√©raires de randonn√©e int√©ressants</a></li>
<li><a href="../fr414437/index.html">Le blocage des t√©l√©grammes a d√©clench√© une augmentation du co√ªt des startups nationales</a></li>
<li><a href="../fr414441/index.html">Exp√©rience des migrations de bases de donn√©es 1440</a></li>
<li><a href="../fr414445/index.html">Am√©liorer Zimbra avec la suite Zextras</a></li>
<li><a href="../fr414447/index.html">Des tr√©sors de tous les temps</a></li>
<li><a href="../fr414449/index.html">Comment se faire des amis de tous les op√©rateurs du stade et ne pas l'ensemencer avec des centaines d'antennes</a></li>
<li><a href="../fr414451/index.html">"Calendrier des testeurs" pour juin. Le testeur doit attraper le bug, lire Caner et organiser le d√©placement.</a></li>
<li><a href="../fr414453/index.html">Impl√©menter Path Finder pour les agents AI avec NavMesh</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>