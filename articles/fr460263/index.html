<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üõí üë¥üèø üê© Faire une recherche vraiment intelligente: guide √©tape par √©tape ‚úçÔ∏è üßëüèΩ‚Äçü§ù‚Äçüßëüèº üóÑÔ∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Recherche dans le syst√®me d'information de l'entreprise - d√©j√† √† partir de cette phrase elle-m√™me reste coinc√©e dans la bouche. C'est bien si vous en ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Faire une recherche vraiment intelligente: guide √©tape par √©tape</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/directum/blog/460263/"><p>  <em>Recherche dans le syst√®me d'information de l'entreprise</em> - d√©j√† √† partir de cette phrase elle-m√™me reste coinc√©e dans la bouche.  C'est bien si vous en avez un, vous n'avez m√™me pas √† penser √† une exp√©rience utilisateur positive.  Comment inverser l'attitude des utilisateurs g√¢t√©s par les moteurs de recherche et cr√©er un produit rapide, pr√©cis et parfaitement compr√©hensible?  Nous devons prendre un bon morceau d'Elasticsearch, une poign√©e de services intelligents et les p√©trir sur ce guide. </p><br><p>  Il existe de nombreux articles sur la fa√ßon d'attacher la recherche de texte int√©gral bas√©e sur Elasticsearch √† la base de donn√©es existante.  Mais il n'y a clairement pas assez d'articles sur la fa√ßon de faire une recherche vraiment intelligente. </p><br><blockquote>  Dans le m√™me temps, l'expression "Smart Search" elle-m√™me est d√©j√† devenue un mot √† la mode et est utilis√©e pour le lieu et non.  Alors, que doit faire un moteur de recherche pour √™tre consid√©r√© comme intelligent?  En fin de compte, cela peut √™tre d√©crit comme donnant le r√©sultat dont l'utilisateur a r√©ellement besoin, m√™me si ce r√©sultat ne correspond pas tout √† fait au texte de la demande.  Les moteurs de recherche populaires comme Google et Yandex vont plus loin et ne trouvent pas seulement les informations dont ils ont besoin, mais r√©pondent directement aux questions des utilisateurs. </blockquote><p>  D'accord, nous ne nous attaquerons pas tout de suite √† la solution ultime, mais que peut-on faire pour rapprocher une recherche plein texte <em>r√©guli√®re d'</em> une recherche <em>intelligente</em> ? </p><a name="habracut"></a><br><h2 id="elementy-intellektualnosti">  √âl√©ments d'intelligence </h2><br><p>  Recherche intelligente - c'est juste le cas lorsque la quantit√© peut entrer dans la qualit√© et que de nombreuses fonctionnalit√©s petites et assez simples peuvent former un sentiment de magie. </p><br><ul><li>  Correction d'erreurs utilisateur - qu'il s'agisse d'une faute de frappe, d'une mise en page incorrecte ou, peut-√™tre, d'une demande avec un nombre √©trangement faible de r√©sultats, mais similaire √† une demande pour laquelle il existe beaucoup plus d'informations. </li><li>  Pour <del>  e </del>  Discussions en PNL (traitement du langage naturel, pas ce que vous pensiez) - si l'utilisateur a saisi <em><strong>des offres commerciales pour l'ann√©e derni√®re</strong></em> , voulait-il vraiment rechercher ces mots dans le texte de tous les documents ou avait-il vraiment besoin uniquement d'offres commerciales et seulement l'ann√©e derni√®re ? </li><li>  Pr√©disez la saisie en fonction des requ√™tes pr√©c√©dentes ou des documents populaires. </li><li> La pr√©sentation du r√©sultat est le point fort habituel du fragment trouv√©, des informations suppl√©mentaires en fonction de ce que vous cherchiez.  √âtant donn√© que des propositions commerciales √©taient n√©cessaires dans le paragraphe pr√©c√©dent, peut-√™tre est-il logique de montrer imm√©diatement le sujet de la proposition et de quelle organisation elle provient? </li><li>  Exploration facile - la possibilit√© d'affiner la requ√™te de recherche √† l'aide de filtres et de facettes suppl√©mentaires. </li></ul><br><h2 id="vvodnaya">  Introduction </h2><br><p>  Il existe un ECM DIRECTUM contenant de nombreux documents.  Le document se compose d'une carte avec des m√©ta-informations et d'un corps, qui peut avoir plusieurs versions. </p><br><p>  L'objectif est de rechercher rapidement et facilement des informations dans ces documents de la mani√®re habituelle pour un utilisateur de moteurs de recherche. </p><br><h2 id="indeksirovanie">  Indexation </h2><br><blockquote>  Pour bien rechercher quelque chose, vous devez d'abord bien l'indexer. </blockquote><p>  Les documents dans ECM ne sont pas statiques, les utilisateurs modifient le texte, cr√©ent de nouvelles versions, changent les donn√©es dans les cartes;  de nouveaux documents sont constamment cr√©√©s et les anciens sont parfois supprim√©s. <br>  Pour conserver des informations √† jour dans Elasticsearch, les documents doivent √™tre constamment r√©index√©s.  Heureusement, ECM a d√©j√† sa propre file d'attente d'√©v√©nements asynchrones, donc lorsque vous modifiez un document, ajoutez-le simplement √† la file d'attente pour l'indexation. </p><br><h3 id="otobrazhenie-dokumentov-ecm-na-dokumenty-elasticsearch">  Mappage de documents ECM √† des documents Elasticsearch </h3><br><p>  Un corps de document dans ECM peut avoir plusieurs versions.  Dans Elasticsearch, cela pourrait √™tre consid√©r√© comme un tableau d'objets imbriqu√©s, mais il devient alors difficile de travailler avec eux - il devient plus difficile d'√©crire des requ√™tes, lorsque vous changez l'une des versions, vous devez tout r√©indexer, diff√©rentes versions du m√™me document ne peuvent pas √™tre stock√©es dans diff√©rents index (pourquoi cela pourrait-il √™tre n√©cessaire - dans la section suivante).  Par cons√©quent, nous d√©normalisons un document d'ECM en plusieurs documents Elasticsearch avec la m√™me carte mais des corps diff√©rents. </p><br><p>  En plus de la carte et du corps, diverses informations de service sont ajout√©es au document Elasticsearch, qui m√©rite d'√™tre mentionn√© s√©par√©ment: </p><br><ul><li>  une liste des identifiants des groupes et des utilisateurs qui ont des droits sur le document - pour les recherches avec des droits; </li><li>  le nombre d'appels au document - pour r√©gler la pertinence; </li><li>  heure de la derni√®re indexation. </li></ul><br><h3 id="sostav-indeksov">  Composition de l'indice </h3><br><p>  Oui, plusieurs indices.  Habituellement, plusieurs index pour stocker des informations de signification similaire dans Elasticsearch ne sont utilis√©s que si ces informations sont immuables et li√©es √† une certaine p√©riode, par exemple, les journaux.  Ensuite, les indices sont cr√©√©s chaque mois / jour ou plus souvent en fonction de l'intensit√© de la charge.  Dans notre cas, tout document peut √™tre modifi√© et il serait possible de tout stocker dans un seul index. </p><br><p>  Mais - les documents dans le syst√®me peuvent √™tre dans diff√©rentes langues, et le stockage de donn√©es multilingues dans Elasticsearch pose 2 probl√®mes: </p><br><ul><li>  Mauvaise racine.  Pour certains mots, la base sera trouv√©e correctement, pour certains - incorrectement (il y aura un autre mot dans l'index), pour certains - ne sera pas trouv√©e du tout (l'index sera obstru√© par des formes de mots).  Pour certains mots de diff√©rentes langues et ayant des significations diff√©rentes, la base co√Øncidera, puis le sens du mot sera perdu.  L'utilisation de plusieurs stemmers cons√©cutifs peut conduire √† un calcul suppl√©mentaire de la base pour une base d√©j√† calcul√©e. </li></ul><br><blockquote>  Stamming - trouver la base du mot.  La tige ne doit pas √™tre la racine du mot ou sa forme normale.  En g√©n√©ral, il suffit que les mots associ√©s soient projet√©s dans un seul cadre. <br>  La lemmatisation est un type de radical dans lequel la forme normale (vocabulaire) d'un mot est consid√©r√©e comme la base. </blockquote><br><ul><li>  Fr√©quence de mot incorrecte.  Certains m√©canismes de d√©termination de la pertinence dans ES prennent en compte la fr√©quence des mots recherch√©s dans le document (plus souvent, plus la pertinence est √©lev√©e) et la fr√©quence des mots recherch√©s dans l'index (plus souvent, plus la pertinence est faible).  Ainsi, une petite diffusion de la langue russe dans un document anglais, lorsque les documents anglais sont principalement dans l'index, aura un poids √©lev√©, mais cela vaut la peine de m√©langer les documents anglais et russes dans l'index, et le poids diminuera. </li></ul><br><p>  Le premier probl√®me peut √™tre r√©solu dans le cas o√π diff√©rentes langues utilisent diff√©rents jeux de caract√®res (les documents russe-anglais utilisent des lettres cyrilliques et latines) - les stemmers de langue ne traiteront que "leurs" caract√®res. </p><br><p>  Pour r√©soudre le deuxi√®me probl√®me, nous avons utilis√© l'approche avec un index s√©par√© pour chaque langue. </p><br><p>  En combinant les deux approches, nous obtenons des indices de langue, qui contiennent n√©anmoins des analyseurs pour plusieurs langues qui ne se croisent pas dans des ensembles de caract√®res: russe-anglais (et s√©par√©ment anglais-russe), polonais-russe, allemand-russe, ukrainien-anglais, etc. . </p><br><p>  Afin de ne pas cr√©er tous les index possibles √† l'avance, nous avons utilis√© des mod√®les d'index - Elasticsearch vous permet de sp√©cifier un mod√®le contenant des param√®tres et des mappages, et de sp√©cifier un mod√®le de nom d'index.  Lorsque vous essayez d'indexer un document dans un index inexistant, dont le nom correspond √† l'un des mod√®les du mod√®le, non seulement un nouvel index sera cr√©√©, mais √©galement des param√®tres et des mappages du mod√®le correspondant lui seront appliqu√©s. </p><br><h3 id="struktura-indeksov">  Structure de l'index </h3><br><p>  Pour l'indexation, nous utilisons deux analyseurs √† la fois (via plusieurs champs): par d√©faut pour la recherche par phrase exacte et personnalis√© pour tout le reste: </p><br><pre><code class="json hljs"><span class="hljs-string"><span class="hljs-string">"ru_en_analyzer"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"filter"</span></span>: [ <span class="hljs-string"><span class="hljs-string">"lowercase"</span></span>, <span class="hljs-string"><span class="hljs-string">"russian_morphology"</span></span>, <span class="hljs-string"><span class="hljs-string">"english_morphology"</span></span>, <span class="hljs-string"><span class="hljs-string">"word_delimiter"</span></span>, <span class="hljs-string"><span class="hljs-string">"ru_en_stopwords"</span></span> ], <span class="hljs-attr"><span class="hljs-attr">"char_filter"</span></span>: [ <span class="hljs-string"><span class="hljs-string">"yo_filter"</span></span> ], <span class="hljs-attr"><span class="hljs-attr">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"custom"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"tokenizer"</span></span>: <span class="hljs-string"><span class="hljs-string">"standard"</span></span>}</code> </pre> <br><p>  Avec le filtre en minuscules, tout est clair, je vais vous parler du reste. </p><br><p>  Les filtres russian_morphology et english_morphology sont destin√©s √† l'analyse morphologique du texte russe et anglais, respectivement.  Ils ne font pas partie d'Elasticsearch et sont inclus dans le cadre d'un plugin d'analyse-morphologie distinct.  Ce sont des lemmatiseurs qui utilisent l'approche du vocabulaire en combinaison avec certaines heuristiques et fonctionnent de mani√®re significative, BEAUCOUP, mieux que les filtres int√©gr√©s pour les langues correspondantes. </p><br><pre> <code class="json hljs">POST _analyze { <span class="hljs-attr"><span class="hljs-attr">"analyzer"</span></span>: <span class="hljs-string"><span class="hljs-string">"russian"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"text"</span></span>: <span class="hljs-string"><span class="hljs-string">"   "</span></span> } &gt;&gt;   </code> </pre> <br><p>  Et: </p><br><pre> <code class="json hljs">POST _analyze { <span class="hljs-attr"><span class="hljs-attr">"analyzer"</span></span>: <span class="hljs-string"><span class="hljs-string">"ru_en_analyzer"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"text"</span></span>: <span class="hljs-string"><span class="hljs-string">"   "</span></span> } &gt;&gt;   </code> </pre> <br><p>  Filtre word_delimiter tr√®s curieux.  Cela aide, par exemple, √† √©liminer les fautes de frappe lorsqu'il n'y a pas d'espace apr√®s le point.  Nous utilisons la configuration suivante: </p><br><pre> <code class="json hljs"><span class="hljs-string"><span class="hljs-string">"word_delimiter"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"catenate_all"</span></span>: <span class="hljs-string"><span class="hljs-string">"true"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"word_delimiter"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"preserve_original"</span></span>: <span class="hljs-string"><span class="hljs-string">"true"</span></span> }</code> </pre> <br><p>  yo_filter vous permet d'ignorer la diff√©rence entre E et E: </p><br><pre> <code class="json hljs"><span class="hljs-string"><span class="hljs-string">"yo_filter"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"mapping"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"mappings"</span></span>: [ <span class="hljs-string"><span class="hljs-string">" =&gt; "</span></span>, <span class="hljs-string"><span class="hljs-string">" =&gt; "</span></span> ] }</code> </pre> <br><p>  ru_en_stopwords filter type stop - notre dictionnaire de mots vides. </p><br><h3 id="process-indeksirovaniya">  Processus d'indexation </h3><br><p>  Les corps de documents dans ECM sont, en r√®gle g√©n√©rale, des fichiers de formats bureautiques: .docx, .pdf, etc.  Pour extraire le texte, le plugin ingest-attachment est utilis√© avec le pipeline suivant: </p><br><pre> <code class="json hljs">{ <span class="hljs-attr"><span class="hljs-attr">"document_version"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"processors"</span></span>: [ { <span class="hljs-attr"><span class="hljs-attr">"attachment"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"field"</span></span>: <span class="hljs-string"><span class="hljs-string">"content"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"target_field"</span></span>: <span class="hljs-string"><span class="hljs-string">"attachment"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"properties"</span></span>: [ <span class="hljs-string"><span class="hljs-string">"content"</span></span>, <span class="hljs-string"><span class="hljs-string">"content_length"</span></span>, <span class="hljs-string"><span class="hljs-string">"content_type"</span></span>, <span class="hljs-string"><span class="hljs-string">"language"</span></span> ], <span class="hljs-attr"><span class="hljs-attr">"indexed_chars"</span></span>: <span class="hljs-number"><span class="hljs-number">-1</span></span>, <span class="hljs-attr"><span class="hljs-attr">"ignore_failure"</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span> } }, { <span class="hljs-attr"><span class="hljs-attr">"remove"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"field"</span></span>: <span class="hljs-string"><span class="hljs-string">"content"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"ignore_failure"</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span> } }, { <span class="hljs-attr"><span class="hljs-attr">"script"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"lang"</span></span>: <span class="hljs-string"><span class="hljs-string">"painless"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"params"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"languages"</span></span>: [<span class="hljs-string"><span class="hljs-string">"ru"</span></span>, <span class="hljs-string"><span class="hljs-string">"en"</span></span> ], <span class="hljs-attr"><span class="hljs-attr">"language_delimeter"</span></span>: <span class="hljs-string"><span class="hljs-string">"_"</span></span> }, <span class="hljs-attr"><span class="hljs-attr">"source"</span></span>: <span class="hljs-string"><span class="hljs-string">"..."</span></span> } }, { <span class="hljs-attr"><span class="hljs-attr">"remove"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"field"</span></span>: <span class="hljs-string"><span class="hljs-string">"attachment"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"ignore_failure"</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span> } } ] } }</code> </pre> <br><p>  De l'inhabituel dans le pipeline, en ignorant les erreurs d'absence du corps (cela se produit pour les documents crypt√©s) et en d√©terminant l'index cible en fonction de la langue du texte.  Ce dernier se fait dans un script indolore, dont je donnerai le corps s√©par√©ment, car  en raison des restrictions JSON, il doit √™tre √©crit sur une seule ligne.  Associ√© √† des difficult√©s de d√©bogage (la m√©thode recommand√©e consiste √† lever des exceptions ici et l√†), cela devient compl√®tement douloureux. </p><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ctx.attachment != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">params</span></span>.languages.contains(ctx.attachment.language)) ctx._index = ctx._index + <span class="hljs-keyword"><span class="hljs-keyword">params</span></span>.language_delimeter + ctx.attachment.language; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ctx.attachment.content != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) ctx.content = ctx.attachment.content; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ctx.attachment.content_length != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) ctx.content_length = ctx.attachment.content_length; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ctx.attachment.content_type != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) ctx.content_type = ctx.attachment.content_type; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ctx.attachment.language != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) ctx.language = ctx.attachment.language; }</code> </pre> <br><p>  Ainsi, nous envoyons toujours le document √† <em>index_name</em> .  Si la langue n'est pas d√©finie ou n'est pas prise en charge, le document s'installe dans cet index, sinon il tombe dans <em>index_name_language</em> . </p><br><p>  Nous ne stockons pas le corps d'origine du fichier, mais le champ _source est activ√©, car  il est n√©cessaire de mettre √† jour partiellement le document et de mettre en √©vidence le trouv√©. </p><br><p>  Si seule la carte a chang√© depuis la derni√®re indexation, nous utilisons l' <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">API Update By Query</a> sans pipeline pour la mettre √† jour.  Cela permet, d'une part, de ne pas extraire des corps de document potentiellement lourds d'ECM, et d'autre part, cela acc√©l√®re consid√©rablement la mise √† jour du c√¥t√© Elasticsearch - vous n'avez pas √† extraire le texte des documents des formats bureautiques, ce qui est tr√®s gourmand en ressources. </p><br><blockquote>  En tant que tel, il n'y a aucune mise √† jour du document dans Elasticsearch, techniquement, lors de la mise √† jour √† partir de l'index, l'ancien document est retir√©, modifi√© et compl√®tement index√© √† nouveau. </blockquote><p>  Mais si le corps a chang√©, l'ancien document est g√©n√©ralement supprim√© et index√© √† partir de z√©ro.  Cela permet aux documents de <em>passer</em> d'un index de langue √† un autre. </p><br><h2 id="poisk">  Chercher </h2><br><p>  Pour faciliter la description, je vais donner une capture d'√©cran du r√©sultat final </p><br><p><img src="https://habrastorage.org/webt/ni/l4/xm/nil4xm-qrg7meikrjbd16mt_ziq.png"></p><br><h3 id="polnotekst">  Texte int√©gral </h3><br><p>  Le type de requ√™te principal que nous avons est la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">requ√™te de cha√Æne de requ√™te simple</a> : </p><br><pre> <code class="json hljs"><span class="hljs-string"><span class="hljs-string">"simple_query_string"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"fields"</span></span>: [ <span class="hljs-string"><span class="hljs-string">"card.d*.*_text"</span></span>, <span class="hljs-string"><span class="hljs-string">"card.d*.*_text.exact"</span></span>, <span class="hljs-string"><span class="hljs-string">"card.name^2"</span></span>, <span class="hljs-string"><span class="hljs-string">"card.name.exact^2"</span></span>, <span class="hljs-string"><span class="hljs-string">"content"</span></span>, <span class="hljs-string"><span class="hljs-string">"content.exact"</span></span> ], <span class="hljs-attr"><span class="hljs-attr">"query"</span></span>: <span class="hljs-string"><span class="hljs-string">" "</span></span>, <span class="hljs-attr"><span class="hljs-attr">"default_operator"</span></span>: <span class="hljs-string"><span class="hljs-string">"or"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"analyze_wildcard"</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>, <span class="hljs-attr"><span class="hljs-attr">"minimum_should_match"</span></span>: <span class="hljs-string"><span class="hljs-string">"-35%"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"quote_field_suffix"</span></span>: <span class="hljs-string"><span class="hljs-string">".exact"</span></span> }</code> </pre> <br><p>  o√π <em>.exact</em> sont les champs index√©s par l'analyseur par <em>d√©faut</em> .  L'importance du nom du document est deux fois plus √©lev√©e que le reste des champs.  La combinaison de <code>"default_operator": "or"</code> et <code>"minimum_should_match": "-35%"</code> vous permet de trouver des documents qui ne contiennent pas jusqu'√† 35% des mots recherch√©s. </p><br><h3 id="sinonimy">  Synonymes </h3><br><p>  En g√©n√©ral, diff√©rents analyseurs sont utilis√©s pour l'indexation et la recherche, mais la seule diff√©rence entre eux est l'ajout d'un filtre pour ajouter des synonymes √† la requ√™te de recherche: </p><br><pre> <code class="json hljs"><span class="hljs-string"><span class="hljs-string">"search_analyzer"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"filter"</span></span>: [ <span class="hljs-string"><span class="hljs-string">"lowercase"</span></span>, <span class="hljs-string"><span class="hljs-string">"russian_morphology"</span></span>, <span class="hljs-string"><span class="hljs-string">"english_morphology"</span></span>, <span class="hljs-string"><span class="hljs-string">"synonym_filter"</span></span>, <span class="hljs-string"><span class="hljs-string">"word_delimiter"</span></span>, <span class="hljs-string"><span class="hljs-string">"ru_en_stopwords"</span></span> ], <span class="hljs-attr"><span class="hljs-attr">"char_filter"</span></span>: [ <span class="hljs-string"><span class="hljs-string">"yo_filter"</span></span> ], <span class="hljs-attr"><span class="hljs-attr">"tokenizer"</span></span>: <span class="hljs-string"><span class="hljs-string">"standard"</span></span> }</code> </pre> <br><pre> <code class="json hljs"><span class="hljs-string"><span class="hljs-string">"synonym_filter"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"synonym_graph"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"synonyms_path"</span></span>: <span class="hljs-string"><span class="hljs-string">"synonyms.txt"</span></span> }</code> </pre> <br><h3 id="uchyot-prav">  Droits comptables </h3><br><p>  Pour les recherches bas√©es sur les droits, la requ√™te principale est int√©gr√©e dans <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Bool Query</a> , avec l'ajout d'un filtre: </p><br><pre> <code class="json hljs"><span class="hljs-string"><span class="hljs-string">"bool"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"must"</span></span>: [ { <span class="hljs-attr"><span class="hljs-attr">"simple_query_string"</span></span>: {...} } ], <span class="hljs-attr"><span class="hljs-attr">"filter"</span></span>: [ { <span class="hljs-attr"><span class="hljs-attr">"terms"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"rights"</span></span>: [           ] } } ] }</code> </pre> <br><p>  Comme nous nous en souvenons de la section sur l'indexation, l'index a un champ avec l'ID des utilisateurs et des groupes qui ont des droits sur le document.  S'il y a une intersection de ce champ avec le tableau transmis, alors il y a des droits. </p><br><h3 id="tyuning-relevantnosti">  R√©glage de la pertinence </h3><br><p>  Par d√©faut, Elasticsearch √©value la pertinence des r√©sultats √† l'aide de l'algorithme <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">BM25</a> √† l'aide de la requ√™te et du texte du document.  Nous avons d√©cid√© que trois autres facteurs devraient influencer l'√©valuation de la conformit√© avec le r√©sultat souhait√© et r√©el: </p><br><ul><li>  le moment de la derni√®re √©dition du document - plus il √©tait loin dans le pass√©, moins il est probable que ce document soit n√©cessaire </li><li>  le nombre d'appels au document - plus il est probable que ce document est n√©cessaire; </li><li><p>  Les versions de corps ECM ont plusieurs √©tats possibles: en cours de d√©veloppement, op√©rationnel et obsol√®te.  Il est logique que le jeu soit plus important que les autres. </p><br><p>  Vous pouvez obtenir cet effet √† l'aide de la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">fonction Function Score Query</a> : </p><br><pre> <code class="json hljs"><span class="hljs-string"><span class="hljs-string">"function_score"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"functions"</span></span>: [ { <span class="hljs-attr"><span class="hljs-attr">"gauss"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"modified_date"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"origin"</span></span>: <span class="hljs-string"><span class="hljs-string">"now"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"scale"</span></span>: <span class="hljs-string"><span class="hljs-string">"1095d"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"offset"</span></span>: <span class="hljs-string"><span class="hljs-string">"31d"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"decay"</span></span>: <span class="hljs-number"><span class="hljs-number">0.5</span></span> } } }, { <span class="hljs-attr"><span class="hljs-attr">"field_value_factor"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"field"</span></span>: <span class="hljs-string"><span class="hljs-string">"access_count"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"missing"</span></span>: <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-attr"><span class="hljs-attr">"modifier"</span></span>: <span class="hljs-string"><span class="hljs-string">"log2p"</span></span> } }, { <span class="hljs-attr"><span class="hljs-attr">"filter"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"term"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"life_stage_value_id"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"value"</span></span>: <span class="hljs-string"><span class="hljs-string">""</span></span> } } }, <span class="hljs-attr"><span class="hljs-attr">"weight"</span></span>: <span class="hljs-number"><span class="hljs-number">1.1</span></span> } ], <span class="hljs-attr"><span class="hljs-attr">"query"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"bool"</span></span>: {...} } }</code> </pre> <br><p>  Par cons√©quent, toutes choses √©gales par ailleurs, nous obtenons approximativement la d√©pendance suivante du modificateur d'√©valuation des r√©sultats √† la date de son dernier changement X et au nombre de r√©sultats Y: </p><br></li></ul><br><p></p><div style="text-align:center;"> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><img src="https://habrastorage.org/webt/wa/wz/td/wawztd9zvlz-fetkplnfrjw8ddy.png"></a> </div><p></p><br><h3 id="vneshniy-intellekt">  Intelligence externe </h3><br><p>  Pour une partie des fonctionnalit√©s de la recherche intelligente, nous devons extraire divers <em>faits</em> de la requ√™te de recherche: dates avec leur application (cr√©ation, modification, approbation, etc.), noms des organisations, types de documents recherch√©s, etc. </p><br><p>  Il est √©galement souhaitable de classer la demande dans une certaine cat√©gorie, par exemple, les documents par organisation, par employ√©, r√©glementaire, etc. </p><br><p>  Ces deux op√©rations sont effectu√©es par le module intelligent ECM - <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">DIRECTUM Ario</a> . </p><br><h3 id="process-umnogo-poiska">  Processus de recherche intelligent </h3><br><p>  Il est temps d'examiner plus en d√©tail quels m√©canismes sont mis en ≈ìuvre les √©l√©ments du renseignement. </p><br><h4 id="ispravlenie-oshibok-polzovatelya">  Correction d'erreurs utilisateur </h4><br><p>  La justesse de la mise en page est d√©termin√©e sur la base du mod√®le de langue du trigramme - pour une ligne, on calcule sa probabilit√© de respecter ses s√©quences de trois caract√®res dans des textes en anglais et en russe.  Si la mise en page actuelle est consid√©r√©e comme moins probable, alors, tout d'abord, un indice avec une mise en page correcte s'affiche: </p><br><p><img src="https://habrastorage.org/webt/ek/ow/c5/ekowc5ikjiwx1xe87b5wewhoohm.png"></p><br><p>  et deuxi√®mement, les autres √©tapes de la recherche sont effectu√©es avec la mise en page correcte: </p><br><p><img src="https://habrastorage.org/webt/ug/dr/tc/ugdrtchejvx024datttkc_zcxxw.png"></p><br><p>  Et si rien ne peut √™tre trouv√© avec la mise en page corrig√©e, la recherche commence par la ligne d'origine. </p><br><p>  La correction des fautes de frappe est impl√©ment√©e √† l'aide de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Phrase Suggester</a> .  Il y a un probl√®me - si vous ex√©cutez une requ√™te sur plusieurs index en m√™me temps, alors suggest peut ne rien retourner, tandis que si vous ex√©cutez sur un seul index, il y a des r√©sultats.  Ceci <em>est trait√© en</em> d√©finissant la confiance = 0, mais sugg√®re ensuite de remplacer les mots par leur forme normale.  D'accord, il sera √©trange lorsque vous rechercherez "lettre <strong>a</strong> " d'obtenir une r√©ponse dans l'esprit: <em>Peut</em> - <em>√™tre cherchiez-vous une lettre <strong>sur</strong> ?</em> </p><br><p>  Cela peut √™tre contourn√© en utilisant deux invites dans la demande: </p><br><pre> <code class="json hljs"><span class="hljs-string"><span class="hljs-string">"suggest"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"content_suggest"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"text"</span></span>: <span class="hljs-string"><span class="hljs-string">" "</span></span>, <span class="hljs-attr"><span class="hljs-attr">"phrase"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"collate"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"query"</span></span>: {         {{suggestion}} } }, } }, <span class="hljs-string"><span class="hljs-string">"check_suggest"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"text"</span></span>: <span class="hljs-string"><span class="hljs-string">""</span></span>, <span class="hljs-attr"><span class="hljs-attr">"phrase"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"collate"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"query"</span></span>: {         {{suggestion}} - ({{source_query}}) }, <span class="hljs-string"><span class="hljs-string">"params"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"source_query"</span></span>: <span class="hljs-string"><span class="hljs-string">" "</span></span> } }, } } }</code> </pre> <br><p>  Des param√®tres communs utilis√©s </p><br><pre> <code class="json hljs"><span class="hljs-string"><span class="hljs-string">"confidence"</span></span>: <span class="hljs-number"><span class="hljs-number">0.0</span></span>, <span class="hljs-string"><span class="hljs-string">"max_errors"</span></span>: <span class="hljs-number"><span class="hljs-number">3.0</span></span>, <span class="hljs-string"><span class="hljs-string">"size"</span></span>: <span class="hljs-number"><span class="hljs-number">1</span></span></code> </pre> <br><p>  Si le premier opposant a renvoy√© le r√©sultat, mais pas le second, alors ce r√©sultat est la cha√Æne d'origine elle-m√™me, √©ventuellement avec des mots sous d'autres formes, et il n'est pas n√©cessaire d'afficher un indice.  Si l'indice est toujours requis, la phrase de recherche d'origine fusionne avec l'indice.  Cela se produit en rempla√ßant uniquement les mots corrig√©s et uniquement ceux que le correcteur orthographique (utilisant Hunspell) consid√®re comme incorrects. </p><br><p>  Si la recherche sur la cha√Æne source a renvoy√© 0 r√©sultats, elle est remplac√©e par la cha√Æne obtenue par la fusion et la recherche est √† nouveau effectu√©e: </p><br><p><img src="https://habrastorage.org/webt/up/r3/wx/upr3wxky4mkbeyy3exjocbwzocy.png"></p><br><p>  Sinon, la cha√Æne d'invite r√©sultante est renvoy√©e uniquement en tant qu'invite pour la recherche: </p><br><p><img src="https://habrastorage.org/webt/qv/ts/4t/qvts4tauspo9yspwy_itbzcdttq.png"></p><br><h4 id="klassifikaciya-zaprosov-i-izvlechenie-faktov">  Classification des requ√™tes et extraction des faits </h4><br><p>  Comme je l'ai mentionn√©, nous utilisons DIRECTUM Ario, √† savoir le service de classification de texte et le service d'extraction de faits.  Pour ce faire, nous avons donn√© aux analystes des requ√™tes de recherche anonymes et une liste de faits qui nous int√©ressent.  Sur la base de requ√™tes et de connaissances sur les documents pr√©sents dans le syst√®me, les analystes ont identifi√© plusieurs cat√©gories et form√© le service de classification pour d√©terminer la cat√©gorie en fonction du texte de la requ√™te.  Sur la base des cat√©gories et de la liste de faits r√©sultants, nous avons formul√© les r√®gles d'utilisation de ces faits.  Par exemple, l'expression <em><strong>pour la derni√®re ann√©e</strong></em> dans la cat√©gorie <strong>Tout</strong> le <strong>monde</strong> est consid√©r√©e comme la date de cr√©ation du document, et dans la cat√©gorie <strong>Par organisation</strong> - la date d'enregistrement.  Dans le m√™me temps, ceux <em><strong>cr√©√©s l'ann√©e derni√®re</strong></em> devraient dans n'importe quelle cat√©gorie tomber √† la date de cr√©ation. </p><br><p>  Du c√¥t√© de la recherche - ils ont fait une configuration dans laquelle ils ont enregistr√© les cat√©gories, quels faits sont appliqu√©s √† quels filtres de facettes. </p><br><h4 id="avtodopolnenie-vvoda">  Ach√®vement de la saisie </h4><br><p>  En plus des corrections de mise en page d√©j√† mentionn√©es, les recherches ant√©rieures de l'utilisateur et des documents publics tombent en auto-compl√©tion. </p><br><p><img src="https://habrastorage.org/webt/zc/52/yo/zc52yohihrkkrnny6ekla80-mro.png"></p><br><p>  Ils sont impl√©ment√©s √† l'aide d'un autre type de Suggestion - <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Suggestion d'ach√®vement</a> , mais chacun a ses propres nuances. </p><br><h5 id="avtodopolnenie-istoriya-poiskov">  Saisie semi-automatique: historique des recherches </h5><br><p>  Il y a beaucoup moins d'utilisateurs dans ECM que les moteurs de recherche et allouez suffisamment de requ√™tes communes pour eux <del>  pourquoi champignon l√©nine </del>  pas possible.  Tout afficher √† la suite n'en vaut pas la peine pour des raisons de confidentialit√©.  Le Suggestion de compl√©tion habituel ne peut rechercher que l'ensemble des documents dans l'index, mais le <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Suggestion de contexte</a> vient √† la rescousse - un moyen de d√©finir un contexte pour chaque indice et de filtrer par ces contextes.  Si les noms d'utilisateur sont utilis√©s comme contextes, alors seul son historique peut √™tre montr√© √† tout le monde. </p><br><p>  Vous devez √©galement donner √† l'utilisateur la possibilit√© de supprimer l'invite pour laquelle il a honte.  Comme cl√© de suppression, nous avons utilis√© le nom d'utilisateur et le texte de l'infobulle.  En cons√©quence, pour l'index avec des conseils, nous avons obtenu un mappage l√©g√®rement dupliqu√©: </p><br><pre> <code class="json hljs"><span class="hljs-string"><span class="hljs-string">"mappings"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"document"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"properties"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"input"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"keyword"</span></span> }, <span class="hljs-attr"><span class="hljs-attr">"suggest"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"completion"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"analyzer"</span></span>: <span class="hljs-string"><span class="hljs-string">"simple"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"preserve_separators"</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>, <span class="hljs-attr"><span class="hljs-attr">"preserve_position_increments"</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>, <span class="hljs-attr"><span class="hljs-attr">"max_input_length"</span></span>: <span class="hljs-number"><span class="hljs-number">50</span></span>, <span class="hljs-attr"><span class="hljs-attr">"contexts"</span></span>: [ { <span class="hljs-attr"><span class="hljs-attr">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"user"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"CATEGORY"</span></span> } ] }, <span class="hljs-attr"><span class="hljs-attr">"user"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"keyword"</span></span> } } } }</code> </pre> <br><p>  Le poids de chaque nouvel indice est d√©fini sur un et augmente chaque fois que vous le saisissez √† nouveau √† l'aide de l' <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">API Update By Query</a> avec un script <code>ctx._source.suggest.weight++</code> tr√®s simple. </p><br><h5 id="avtodopolnenie-dokumenty">  Saisie semi-automatique: documents </h5><br><p>  Mais il peut y avoir beaucoup de documents et des combinaisons possibles de droits.  Par cons√©quent, ici, au contraire, nous avons d√©cid√© de ne pas filtrer par droits lors de l'auto-compl√©tion, mais uniquement d'indexer les documents publics.  Oui, et vous n'avez pas besoin de supprimer les conseils individuels de cet index.  Il semblerait que la mise en ≈ìuvre en tout soit plus facile que la pr√©c√©dente, sinon pour deux points: </p><br><p>  Le premier - Completion Suggester ne prend en charge que la recherche de pr√©fixe, et les clients adorent attribuer des num√©ros d'article √† tout, et certaines <code>.01.01   </code> lorsque vous tapez une requ√™te Il n'y a <code>.01.01   </code> .  Ici, avec le nom complet, vous pouvez √©galement indexer les n-grammes qui en d√©rivent: </p><br><pre> <code class="json hljs">{ <span class="hljs-attr"><span class="hljs-attr">"extension"</span></span>: <span class="hljs-string"><span class="hljs-string">"pdf"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">".01.01   "</span></span>, <span class="hljs-attr"><span class="hljs-attr">"suggest"</span></span>: [ { <span class="hljs-attr"><span class="hljs-attr">"input"</span></span>: <span class="hljs-string"><span class="hljs-string">""</span></span>, <span class="hljs-attr"><span class="hljs-attr">"weight"</span></span>: <span class="hljs-number"><span class="hljs-number">70</span></span> }, { <span class="hljs-attr"><span class="hljs-attr">"input"</span></span>: <span class="hljs-string"><span class="hljs-string">" "</span></span>, <span class="hljs-attr"><span class="hljs-attr">"weight"</span></span>: <span class="hljs-number"><span class="hljs-number">80</span></span> }, { <span class="hljs-attr"><span class="hljs-attr">"input"</span></span>: <span class="hljs-string"><span class="hljs-string">"  "</span></span>, <span class="hljs-attr"><span class="hljs-attr">"weight"</span></span>: <span class="hljs-number"><span class="hljs-number">90</span></span> }, { <span class="hljs-attr"><span class="hljs-attr">"input"</span></span>: <span class="hljs-string"><span class="hljs-string">".01.01   "</span></span>, <span class="hljs-attr"><span class="hljs-attr">"weight"</span></span>: <span class="hljs-number"><span class="hljs-number">100</span></span> } ] }</code> </pre> <br><p>  Ce n'√©tait pas si critique avec l'histoire, mais le m√™me utilisateur entre approximativement la m√™me ligne s'il recherche √† nouveau quelque chose.  <em>Probablement</em> . </p><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/bi/rc/dv/bircdvzu2hvcblxhrryvauzajf0.png"></div><br><p>  La seconde - par d√©faut, tous les conseils sont √©gaux, mais nous aimerions rendre certains d'entre eux plus √©gaux et de pr√©f√©rence afin que cela soit coh√©rent avec le classement des r√©sultats de recherche.  Pour ce faire, r√©p√©tez grossi√®rement les fonctions gauss et field_value_factor utilis√©es dans la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">fonction Function Score Query</a> . </p><br><p>  Il s'av√®re que c'est un tel pipeline: </p><br><pre> <code class="json hljs">{ <span class="hljs-attr"><span class="hljs-attr">"dir_public_documents_pipeline"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"processors"</span></span>: [ ... { <span class="hljs-attr"><span class="hljs-attr">"set"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"field"</span></span>: <span class="hljs-string"><span class="hljs-string">"terms_array"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"value"</span></span>: <span class="hljs-string"><span class="hljs-string">"{{name}}"</span></span> } }, { <span class="hljs-attr"><span class="hljs-attr">"split"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"field"</span></span>: <span class="hljs-string"><span class="hljs-string">"terms_array"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"separator"</span></span>: <span class="hljs-string"><span class="hljs-string">"\\s+|$"</span></span> } }, { <span class="hljs-attr"><span class="hljs-attr">"script"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"source"</span></span>: <span class="hljs-string"><span class="hljs-string">"..."</span></span> } } ] } }</code> </pre> <br><p>  avec le script suivant: </p><br><pre> <code class="cs hljs">Date modified = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Date(<span class="hljs-number"><span class="hljs-number">0</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ctx.modified_date != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) modified = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SimpleDateFormat(<span class="hljs-string"><span class="hljs-string">'dd.MM.yyyy'</span></span>).parse(ctx.modified_date); <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> dayCount = (System.currentTimeMillis() - modified.getTime())/(<span class="hljs-number"><span class="hljs-number">1000</span></span>*<span class="hljs-number"><span class="hljs-number">60</span></span>*<span class="hljs-number"><span class="hljs-number">60</span></span>*<span class="hljs-number"><span class="hljs-number">24</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">double</span></span> score = Math.exp((<span class="hljs-number"><span class="hljs-number">-0.7</span></span>*Math.max(<span class="hljs-number"><span class="hljs-number">0</span></span>, dayCount - <span class="hljs-number"><span class="hljs-number">31</span></span>))/<span class="hljs-number"><span class="hljs-number">1095</span></span>) * Math.log10(ctx.access_count + <span class="hljs-number"><span class="hljs-number">2</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> count = ctx.terms_array.length; ctx.suggest = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ArrayList(); ctx.suggest.<span class="hljs-keyword"><span class="hljs-keyword">add</span></span>([ <span class="hljs-string"><span class="hljs-string">'input'</span></span>: ctx.terms_array[count - <span class="hljs-number"><span class="hljs-number">1</span></span>], <span class="hljs-string"><span class="hljs-string">'weight'</span></span>: Math.round(score * (<span class="hljs-number"><span class="hljs-number">255</span></span> - count + <span class="hljs-number"><span class="hljs-number">1</span></span>)) ]); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = count - <span class="hljs-number"><span class="hljs-number">2</span></span>; i &gt;= <span class="hljs-number"><span class="hljs-number">0</span></span> ; --i) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ctx.terms_array[i].trim() != <span class="hljs-string"><span class="hljs-string">""</span></span>) { ctx.suggest.<span class="hljs-keyword"><span class="hljs-keyword">add</span></span>([ <span class="hljs-string"><span class="hljs-string">"input"</span></span>: ctx.terms_array[i] + <span class="hljs-string"><span class="hljs-string">" "</span></span> + ctx.suggest[ctx.suggest.length - <span class="hljs-number"><span class="hljs-number">1</span></span>].input, <span class="hljs-string"><span class="hljs-string">"weight"</span></span>: Math.round(score * (<span class="hljs-number"><span class="hljs-number">255</span></span> - i))]); } } ctx.<span class="hljs-keyword"><span class="hljs-keyword">remove</span></span>(<span class="hljs-string"><span class="hljs-string">'terms_array'</span></span>); ctx.<span class="hljs-keyword"><span class="hljs-keyword">remove</span></span>(<span class="hljs-string"><span class="hljs-string">'access_count'</span></span>); ctx.<span class="hljs-keyword"><span class="hljs-keyword">remove</span></span>(<span class="hljs-string"><span class="hljs-string">'modified_date'</span></span>);</code> </pre> <br><p>  Pourquoi s'emb√™ter avec un pipeline indolore au lieu de l'√©crire dans une langue plus pratique?  Parce que maintenant, √† l'aide de l' <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">API Reindex</a> , vous pouvez <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">remplacer</a> le contenu des index de recherche en index pour les conseils (en sp√©cifiant uniquement les champs n√©cessaires, bien s√ªr) en une seule commande. </p><br><p>  La composition des documents publics vraiment n√©cessaires n'est pas souvent mise √† jour, donc cette commande peut √™tre laiss√©e sur un d√©marrage manuel. </p><br><h3 id="otobrazhenie-rezultatov">  Afficher les r√©sultats </h3><br><h4 id="kategorii">  Les cat√©gories </h4><br><p>  La cat√©gorie d√©termine quelles facettes seront disponibles et √† quoi ressemblera l'extrait.  Il peut √™tre d√©tect√© automatiquement par <em>une intelligence externe</em> ou s√©lectionn√© manuellement au-dessus de la barre de recherche. </p><br><h4 id="fasety">  Facettes </h4><br><p>  Les facettes sont une chose tellement intuitive pour tous ceux dont le comportement est cependant d√©crit par des r√®gles tr√®s simples.  En voici quelques uns: </p><br><ol><li><p>  Les valeurs des facettes d√©pendent des r√©sultats de la recherche, MAIS et les r√©sultats de la recherche d√©pendent des facettes s√©lectionn√©es.  Comment √©viter la r√©cursivit√©? </p><br></li><li><p>  La s√©lection de valeurs dans une facette n'affecte pas les autres valeurs de cette facette, mais elle affecte les valeurs dans d'autres facettes: </p><br></li></ol><br><p><img src="https://habrastorage.org/webt/60/ei/g6/60eig601ltskcwvcesh5zno8crc.png"></p><br><ol><li>  Les valeurs de facette s√©lectionn√©es par l'utilisateur ne doivent pas dispara√Ætre, m√™me si un choix dans une autre facette les <em>annule</em> √† 0 ou si elles ne sont plus en haut: </li></ol><br><p><img src="https://habrastorage.org/webt/mu/6u/e-/mu6ue-ybxh3sa9h6ymkj1idn_ti.png"></p><br><p>  En √©lasticit√©, les facettes sont r√©alis√©es √† travers le m√©canisme d'agr√©gation, mais pour respecter les r√®gles d√©crites, ces agr√©gations doivent √™tre investies les unes dans les autres et filtr√©es les unes par les autres. </p><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/zd/jt/zu/zdjtzudyw9iei8x-tjarja-a5tm.jpeg"></div><br><p>  Consid√©rez les fragments de requ√™te responsables de cela: </p><br><div class="spoiler">  <b class="spoiler_title">Code trop grand</b> <div class="spoiler_text"><pre> <code class="json hljs">{ ... <span class="hljs-attr"><span class="hljs-attr">"post_filter"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"bool"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"must"</span></span>: [ { <span class="hljs-attr"><span class="hljs-attr">"terms"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"card.author_value_id"</span></span>: [ <span class="hljs-string"><span class="hljs-string">"1951063"</span></span> ] } }, { <span class="hljs-attr"><span class="hljs-attr">"terms"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"editor_value_id"</span></span>: [ <span class="hljs-string"><span class="hljs-string">"2337706"</span></span>, <span class="hljs-string"><span class="hljs-string">"300643"</span></span> ] } } ] } }, <span class="hljs-attr"><span class="hljs-attr">"query"</span></span>: {...} <span class="hljs-string"><span class="hljs-string">"aggs"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"card.author_value_id"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"filter"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"terms"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"editor_value_id"</span></span>: [ <span class="hljs-string"><span class="hljs-string">"2337706"</span></span>, <span class="hljs-string"><span class="hljs-string">"300643"</span></span> ] } }, <span class="hljs-attr"><span class="hljs-attr">"aggs"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"card.author_value_id"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"terms"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"field"</span></span>: <span class="hljs-string"><span class="hljs-string">"card.author_value_id"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"size"</span></span>: <span class="hljs-number"><span class="hljs-number">11</span></span>, <span class="hljs-attr"><span class="hljs-attr">"exclude"</span></span>: [ <span class="hljs-string"><span class="hljs-string">"1951063"</span></span> ], <span class="hljs-attr"><span class="hljs-attr">"missing"</span></span>: <span class="hljs-string"><span class="hljs-string">""</span></span> } }, <span class="hljs-attr"><span class="hljs-attr">"card.author_value_id_selected"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"terms"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"field"</span></span>: <span class="hljs-string"><span class="hljs-string">"card.author_value_id"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"size"</span></span>: <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-attr"><span class="hljs-attr">"include"</span></span>: [ <span class="hljs-string"><span class="hljs-string">"1951063"</span></span> ], <span class="hljs-attr"><span class="hljs-attr">"missing"</span></span>: <span class="hljs-string"><span class="hljs-string">""</span></span> } } } }, ... <span class="hljs-attr"><span class="hljs-attr">"editor_value_id"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"filter"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"terms"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"card.author_value_id"</span></span>: [ <span class="hljs-string"><span class="hljs-string">"1951063"</span></span> ] } }, <span class="hljs-attr"><span class="hljs-attr">"aggs"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"editor_value_id"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"terms"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"field"</span></span>: <span class="hljs-string"><span class="hljs-string">"editor_value_id"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"size"</span></span>: <span class="hljs-number"><span class="hljs-number">11</span></span>, <span class="hljs-attr"><span class="hljs-attr">"exclude"</span></span>: [ <span class="hljs-string"><span class="hljs-string">"2337706"</span></span>, <span class="hljs-string"><span class="hljs-string">"300643"</span></span> ], <span class="hljs-attr"><span class="hljs-attr">"missing"</span></span>: <span class="hljs-string"><span class="hljs-string">""</span></span> } }, <span class="hljs-attr"><span class="hljs-attr">"editor_value_id_selected"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"terms"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"field"</span></span>: <span class="hljs-string"><span class="hljs-string">"editor_value_id"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"size"</span></span>: <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-attr"><span class="hljs-attr">"include"</span></span>: [ <span class="hljs-string"><span class="hljs-string">"2337706"</span></span>, <span class="hljs-string"><span class="hljs-string">"300643"</span></span> ], <span class="hljs-attr"><span class="hljs-attr">"missing"</span></span>: <span class="hljs-string"><span class="hljs-string">""</span></span> } } } }, ... } }</code> </pre> </div></div><br><p>  Qu'est-ce que c'est que: </p><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">post_filter vous</a> permet d'imposer une condition suppl√©mentaire aux r√©sultats d'une requ√™te d√©j√† termin√©e et n'affecte pas les r√©sultats des agr√©gations.  Ce m√™me √©cart de r√©cursivit√©.  Inclut toutes les valeurs s√©lectionn√©es de toutes les facettes. </li><li>  agr√©gations de niveau sup√©rieur, dans les exemples <em>card.author_value_id</em> et <em>editor_value_id</em> .  Chacun a: <br><ul><li>  filtrer par les valeurs de toutes les autres facettes, sauf la v√¥tre; </li><li>  agr√©gation imbriqu√©e pour des valeurs de facettes s√©lectionn√©es - <em>protection contre l'annihilation</em> ; </li><li>  agr√©gation imbriqu√©e pour d'autres valeurs de facette.  Nous affichons le top 10 et demandons le top 11 - pour d√©terminer s'il faut afficher le bouton <strong>Afficher tout</strong> . </li></ul></li></ul><br><h4 id="snippety">  Extraits </h4><br><p>  Selon la cat√©gorie s√©lectionn√©e, l'extrait peut sembler diff√©rent, par exemple, le m√™me document lors de la recherche dans une cat√©gorie </p><br><p>  <strong>Tous</strong> : </p><br><p><img src="https://habrastorage.org/webt/ka/_b/ia/ka_biaaygfgbsk2msyfhu-bnkse.png"></p><br><p>  et <strong>employ√©s</strong> : </p><br><p><img src="https://habrastorage.org/webt/5i/po/k_/5ipok_qgkc9170ucyidespnnitc.png"></p><br><p>  Ou souvenez-vous, nous voulions voir le sujet d'une offre commerciale et de qui venait-elle? </p><br><p><img src="https://habrastorage.org/webt/-i/7z/g7/-i7zg7dwh7kbs9e9_2yk3fnxc6k.png"></p><br><p>  Afin de ne pas faire glisser la carte enti√®re de l'√©lastique (cela ralentit la recherche), le <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">filtrage source est utilis√©</a> : </p><br><pre> <code class="json hljs">{ ... <span class="hljs-attr"><span class="hljs-attr">"_source"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"includes"</span></span>: [ <span class="hljs-string"><span class="hljs-string">"id"</span></span>, <span class="hljs-string"><span class="hljs-string">"card.name"</span></span>, <span class="hljs-string"><span class="hljs-string">"card.card_type_value_id"</span></span>, <span class="hljs-string"><span class="hljs-string">"card.life_stage_value_id"</span></span>, <span class="hljs-string"><span class="hljs-string">"extension"</span></span>, ... ] }, <span class="hljs-attr"><span class="hljs-attr">"query"</span></span>: {...} ... }</code> </pre> <br><p>  Pour mettre en √©vidence les mots trouv√©s dans le texte du document, le <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">surligneur Fast Vector</a> est utilis√© - comme g√©n√©rant les extraits de code les plus appropri√©s pour les gros textes, et pour le nom - <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Surligneur unifi√©</a> - comme le moins exigeant en termes de ressources et de structure d'index: </p><br><pre> <code class="json hljs"><span class="hljs-string"><span class="hljs-string">"highlight"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"pre_tags"</span></span>: [ <span class="hljs-string"><span class="hljs-string">"&lt;strong&gt;"</span></span> ], <span class="hljs-attr"><span class="hljs-attr">"post_tags"</span></span>: [ <span class="hljs-string"><span class="hljs-string">"&lt;/strong&gt;"</span></span> ], <span class="hljs-attr"><span class="hljs-attr">"encoder"</span></span>: <span class="hljs-string"><span class="hljs-string">"html"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"fields"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"card.name"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"number_of_fragments"</span></span>: <span class="hljs-number"><span class="hljs-number">0</span></span> }, <span class="hljs-attr"><span class="hljs-attr">"content"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"fragment_size"</span></span>: <span class="hljs-number"><span class="hljs-number">300</span></span>, <span class="hljs-attr"><span class="hljs-attr">"number_of_fragments"</span></span>: <span class="hljs-number"><span class="hljs-number">3</span></span>, <span class="hljs-attr"><span class="hljs-attr">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"fvh"</span></span> } } },</code> </pre> <br><p>  Dans ce cas, le nom est mis en √©vidence dans son int√©gralit√©, et du texte nous obtenons jusqu'√† 3 fragments de 300 caract√®res.  Le texte renvoy√© par le surligneur Fast Vector est ensuite compress√© par un algorithme de fortune pour obtenir un √©tat d'extrait minimis√©. </p><br><h3 id="kollaps">  R√©duire </h3><br><p>  Historiquement, les utilisateurs de cet ECM sont habitu√©s au fait que la recherche leur renvoie des <em>documents</em> , mais en fait Elasticsearch recherche parmi les <em>versions des documents</em> .  Il peut s'av√©rer que plusieurs versions presque identiques se trouvent sur la m√™me requ√™te.  Cela encombrera les r√©sultats et confondra l'utilisateur.  Heureusement, ce comportement peut √™tre √©vit√© en utilisant le m√©canisme de regroupement de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">champs</a> - une version l√©g√®re d'agr√©gations qui fonctionne d√©j√† sur les r√©sultats finis (en cela, il ressemble √† post_filter, <em>deux b√©quilles sont une paire</em> ).  L' <em>effondrement</em> entra√Ænera le plus pertinent des objets qui s'effondrent. </p><br><pre> <code class="json hljs">{ ... <span class="hljs-attr"><span class="hljs-attr">"query"</span></span>: {...} ... <span class="hljs-string"><span class="hljs-string">"collapse"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"field"</span></span>: <span class="hljs-string"><span class="hljs-string">"id"</span></span> } }</code> </pre> <br><p>  Malheureusement, l'effondrement a un certain nombre d'effets d√©sagr√©ables, par exemple, diverses caract√©ristiques num√©riques du r√©sultat de la recherche continuent de revenir comme s'il n'y avait pas d'effondrement.  Autrement dit, le nombre de r√©sultats, le nombre de valeurs de facette - tout sera <em>l√©g√®rement</em> incorrect, mais l'utilisateur ne le remarque g√©n√©ralement pas, tout comme le lecteur fatigu√©, qui a peu de chances d'avoir lu cette proposition auparavant. </p><br><p>  La fin. </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr460263/">https://habr.com/ru/post/fr460263/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr460253/index.html">10 raisons de faire vos comp√©tences d'assistant vocal</a></li>
<li><a href="../fr460255/index.html">Backdoor sur Node.js: pourquoi, pourquoi et comment cela fonctionne</a></li>
<li><a href="../fr460257/index.html">Bonjour tout le monde! Immersion profonde dans les terminaux</a></li>
<li><a href="../fr460259/index.html">Qu'est-ce que la conception UI et UX? Qu'est-ce qui est commun et diff√©rent?</a></li>
<li><a href="../fr460261/index.html">Amazon: 25 ans de succ√®s dans le commerce √©lectronique</a></li>
<li><a href="../fr460265/index.html">Cr√©er un mod√®le de projet Xcode</a></li>
<li><a href="../fr460273/index.html">Autorisation dans Apple Pay pour le plus petit</a></li>
<li><a href="../fr460275/index.html">Pourquoi n'avez-vous pas besoin de la solution parfaite</a></li>
<li><a href="../fr460279/index.html">Contrat de 10 milliards: qui s'occupera du cloud pour le Pentagone</a></li>
<li><a href="../fr460281/index.html">Comment UX Writer aide √† am√©liorer le produit</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>