<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë©üèø‚Äçüé® üë¶üèæ üì∞ Laborat√≥rio: configurando lvm, raid no linux üö´ üö® üè¥Û†ÅßÛ†Å¢Û†Å•Û†ÅÆÛ†ÅßÛ†Åø</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Uma pequena digress√£o: este l \ r √© sint√©tico. 


 Algumas das tarefas descritas aqui podem ser muito mais f√°ceis, mas como a tarefa de l / r √© famili...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Laborat√≥rio: configurando lvm, raid no linux</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/450896/"><p>  Uma pequena digress√£o: este l \ r √© sint√©tico. </p><br><p>  Algumas das tarefas descritas aqui podem ser muito mais f√°ceis, mas como a tarefa de l / r √© familiarizar-se com a funcionalidade raid, lvm, algumas opera√ß√µes s√£o artificialmente complicadas. </p><br><h2 id="trebovaniya-k-instrumentam-dlya-vypolneniya-lr">  Requisitos para ferramentas para executar l \ r: </h2><br><ul><li>  Ferramentas de virtualiza√ß√£o como o Virtualbox </li><li>  Imagem de instala√ß√£o do Linux como o <a href="">Debian9</a> </li><li>  Disponibilidade da Internet para baixar v√°rios pacotes </li><li>  Conex√£o via ssh √† VM instalada (opcional) </li></ul><br><h2 id="vnimanie">  ATEN√á√ÉO </h2><br><p>  Esse trabalho de laborat√≥rio est√° associado a quest√µes delicadas como a seguran√ßa dos dados - essa √© uma √°rea que permite que voc√™ perca todos os seus dados devido ao menor erro - uma letra ou n√∫mero extra. </p><br><p>  Como voc√™ est√° fazendo um trabalho de laborat√≥rio, n√£o est√° em perigo, a menos que precise come√ßar a faz√™-lo novamente. </p><br><p>  Na vida real, tudo √© muito mais s√©rio, portanto, voc√™ deve digitar com muito cuidado os nomes dos discos, entendendo exatamente o que est√° executando com o comando atual e com quais discos trabalha. </p><a name="habracut"></a><br><p>  O segundo ponto importante √© a nomea√ß√£o de discos e parti√ß√µes: dependendo da situa√ß√£o, os n√∫meros dos discos podem diferir daqueles valores que s√£o apresentados nos comandos do laborat√≥rio. <br>  Portanto, por exemplo, se voc√™ remover a unidade sda ‚Äã‚Äãda matriz e adicionar uma nova unidade, a nova unidade ser√° exibida no sistema com o nome sda.  Se voc√™ reiniciar antes de adicionar um novo disco, o novo disco ser√° chamado sdb e o antigo ser√° chamado sda </p><br><p>  O trabalho de laborat√≥rio deve ser feito sob superusu√°rio (root), pois a maioria dos comandos requer privil√©gios elevados e n√£o faz sentido elevar privil√©gios constantemente por meio do sudo. </p><br><h2 id="materialy-dlya-izucheniya">  Materiais de estudo </h2><br><ul><li>  RAID </li><li>  LVM </li><li>  Nomea√ß√£o de disco do Linux </li><li>  O que √© uma se√ß√£o </li><li>  O que √© uma tabela de parti√ß√£o e onde ela √© armazenada </li><li>  O que √© grub </li></ul><br><h2 id="ispolzuemye-utility">  Utilit√°rios Utilizados </h2><br><ol><li>  Exibir informa√ß√µes do disco: <br><ul><li>  lsblk -o NOME, TAMANHO, FSTYPE, TYPE, MOUNTPOINT </li><li>  fdisk -l </li></ul></li><li>  Exibir informa√ß√µes e trabalhar com LVM <br><ul><li>  pvs </li><li>  pvextend </li><li>  pvcreate </li><li>  pvresize </li><li>  vgs </li><li>  vgreduce </li><li>  lvs </li><li>  lvextend </li></ul></li><li>  Veja informa√ß√µes e trabalhe com RAID: <br><ul><li>  cat / proc / mdstat </li><li>  mdadm </li></ul></li><li>  Pontos de montagem: <br><ul><li>  montar </li><li>  umount </li><li>  cat / etc / fstab </li><li>  cat / etc / mtab </li></ul></li><li>  Re-particionando o disco: <br><ul><li>  fdisk / dev / XXX </li></ul></li><li>  Copiando se√ß√µes: <br><ul><li>  dd se = / dev / xxx de = / dev / aaaa </li></ul></li><li>  Trabalhe com a tabela de parti√ß√£o: <br><ul><li>  partx </li><li>  sfdisk </li><li>  mkfs.ext4 </li></ul></li><li>  Trabalhe com o carregador de inicializa√ß√£o: <br><ul><li>  grub-install / dev / XXX </li><li>  update-grub </li></ul></li><li>  misc <br><ul><li>  lsof </li><li>  apto </li><li>  rsync </li></ul></li></ol><br><h2 id="laboratornaya-rabota-sostoit-iz-3-h-chastey">  O trabalho de laborat√≥rio consiste em 3 partes: </h2><br><ul><li>  Configurando um sistema √≠ntegro usando lvm, raid. </li><li>  Emula√ß√£o de falha de uma das unidades. </li><li>  Substitui√ß√£o de discos dinamicamente, com a adi√ß√£o de novos discos e transfer√™ncia de parti√ß√£o. </li></ul><br><h2 id="zadanie-1-ustanovka-os-i-nastroyka-lvm-raid">  Tarefa 1 (Instalando o SO e Configurando LVM, RAID) </h2><br><ol><li><p>  Crie uma nova m√°quina virtual com os seguintes recursos: </p><br><ul><li>  1 gb de ram </li><li>  1 CPU </li><li>  2 hdd (nomeie-os ssd1, ssd2 e atribua tamanho igual, marque as caixas hot swap e ssd) </li><li>  Controlador SATA configurado em 4 portas: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/18f/6f5/be6/18f6f5be6afbc13138abc3dfe960813b.png" alt="selecionar discos ssd"></li></ul><br></li><li><p>  Comece a instalar o Linux e v√° para a escolha de discos r√≠gidos, fa√ßa o seguinte: </p><br><ul><li>  M√©todo de particionamento: manual, ap√≥s o qual voc√™ dever√° ver a seguinte imagem: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/77a/eb5/3a1/77aeb53a1de2bc7b91d1396dc9b4148e.png" alt="discos de parti√ß√£o"></li><li>  Configurando uma parti√ß√£o separada em / boot: selecione o primeiro disco e crie uma nova tabela de parti√ß√µes: <br><ul><li>  Tamanho da parti√ß√£o: 512M </li><li>  Ponto de montagem: / boot </li></ul></li><li>  Repita a configura√ß√£o para o segundo disco, mas como voc√™ n√£o pode montar / inicializar 2 vezes ao mesmo tempo, selecione o ponto de montagem: none e, finalmente, obtenha o seguinte (imagem com um batente, refaz a pregui√ßa): <br><br><img src="https://habrastorage.org/getpro/habr/post_images/3db/2f0/e48/3db2f0e48423f182016bde06c39dfb8d.png" alt="discos de parti√ß√£o"></li><li>  Configura√ß√£o de RAID: </li><li>  Selecione o espa√ßo livre no primeiro disco e configure o volume f√≠sico para RAID como o tipo de parti√ß√£o. </li><li>  Selecione "Conclu√≠do configurando a parti√ß√£o" </li><li>  Repita exatamente a mesma configura√ß√£o para o segundo disco, resultando no seguinte: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/93f/37c/ec3/93f37cec319d628a3267f94d138145e7.png" alt="discos de parti√ß√£o"></li><li>  Selecione "Configurar RAID de software" <br><ul><li>  Criar dispositivo MD </li><li>  Tipo de dispositivo RAID de software: selecione uma matriz espelhada </li><li>  Dispositivos ativos para a matriz RAID XXXX: selecione as duas unidades </li><li>  Dispositivos de reposi√ß√£o: deixe 0 como padr√£o </li><li>  Dispositivos ativos para a matriz RAID XX: selecione parti√ß√µes que voc√™ criou em RAID </li><li>  Concluir </li></ul></li><li>  No final, voc√™ deve obter esta imagem: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/7a7/9b0/3f5/7a79b03f556925d1fd53ccc4ca77b494.png" alt="discos de parti√ß√£o"></li><li>  Configura√ß√£o do LVM: Selecione Configurar o Logical Volume Manager </li><li>  Mantenha o layout atual da parti√ß√£o e configure o LVM: Sim </li><li>  Criar grupo de volumes </li><li>  Nome do grupo de volumes: sistema </li><li>  Dispositivos para o novo grupo de volumes: Escolha o RAID criado </li><li>  Criar volume l√≥gico <br><ul><li>  nome do volume l√≥gico: raiz </li><li>  tamanho do volume l√≥gico: 2 \ 5 do tamanho do seu disco </li></ul></li><li>  Criar volume l√≥gico <br><ul><li>  nome do volume l√≥gico: var </li><li>  tamanho do volume l√≥gico: 2 \ 5 do tamanho do seu disco </li></ul></li><li>  Criar volume l√≥gico <br><ul><li>  nome do volume l√≥gico: log </li><li>  tamanho do volume l√≥gico: 1 \ 5 do tamanho do seu disco </li></ul></li><li>  Escolhendo Exibir detalhes da configura√ß√£o, voc√™ deve obter a seguinte imagem: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/0b8/8dd/11f/0b88dd11f9372dbf8e53a6727fc69b27.png" alt="discos de parti√ß√£o"></li><li>  Depois de concluir a configura√ß√£o do LVM, voc√™ dever√° ver o seguinte: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/72b/9d4/00d/72b9d400d9b83392c759b7aeb3e9d573.png" alt="discos de parti√ß√£o"></li><li>  Particionamento: por sua vez, selecione cada volume criado no LVM e particione-os, por exemplo, para raiz como esta: <br><ul><li>  Use como: ext4 </li><li>  ponto de montagem: / </li></ul></li><li>  O resultado da marca√ß√£o da parti√ß√£o raiz deve ser o seguinte: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/225/61e/0be/22561e0be2cd905e0948a63ae3460461.png" alt="discos de parti√ß√£o"></li><li>  Repita a opera√ß√£o de marca√ß√£o para var e log selecionando os pontos de montagem apropriados (digite manualmente / var e / var / log), obtendo o seguinte resultado: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/5da/58c/756/5da58c756fd8d205a93ebfd49acc396f.png" alt="discos de parti√ß√£o"></li><li>  Escolha Concluir particionamento </li><li>  Voc√™ ser√° solicitado a fazer algumas perguntas sobre o fato de ainda ter uma parti√ß√£o desmontada e o swap n√£o estar configurado.  Ambas as perguntas devem ser respondidas de forma negativa. </li><li>  O resultado final deve ficar assim: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/117/381/a61/117381a61b766df3c89d2646baa2b33d.png" alt="discos de parti√ß√£o"></li></ul><br></li><li><p>  Conclua a instala√ß√£o do sistema operacional instalando o grub no primeiro dispositivo (sda) e inicialize o sistema. </p><br></li><li><p>  Copie o conte√∫do da parti√ß√£o / boot da unidade sda ‚Äã‚Äã(ssd1) para a unidade sdb (ssd2) </p><br><pre><code class="plaintext hljs">dd if=/dev/sda1 of=/dev/sdb1</code> </pre> <br></li><li><p>  Instale o grub no segundo dispositivo: </p><br><ul><li><p>  Veja as unidades no sistema: </p><br><pre> <code class="plaintext hljs">fdisk -l lsblk -o NAME,SIZE,FSTYPE,TYPE,MOUNTPOINT</code> </pre> <br></li><li>  Liste todos os discos que o comando anterior emitiu para voc√™ e descreva que tipo de disco √©. </li><li><p>  Localize a unidade na qual o grub n√£o foi instalado e conclua esta instala√ß√£o: </p><br><pre> <code class="plaintext hljs">grub-install /dev/sdb</code> </pre> <br></li><li>  Veja o ataque atual com cat / proc / mdstat e anote o que viu. </li><li>  Veja a sa√≠da dos comandos: pvs, vgs, lvs, mount e anote exatamente o que voc√™ viu. </li></ul><br></li></ol><br><p>  Descreva com suas pr√≥prias palavras o que voc√™ fez e qual resultado obteve como resultado da tarefa conclu√≠da. </p><br><p>  Depois de concluir esta tarefa, √© recomend√°vel fazer backup da pasta com a m√°quina virtual ou criar uma <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">caixa vaga</a> . </p><br><p>  Resultado: uma m√°quina virtual com discos ssd1, ssd2. </p><br><h2 id="zadanie-2-emulyaciya-otkaza-odnogo-iz-diskov">  Tarefa 2 (emulando a falha de uma das unidades) </h2><br><ol><li>  Se voc√™ marcou a caixa de sele√ß√£o hot swap, √© poss√≠vel excluir discos em tempo real: <br><ul><li>  Exclua a unidade ssd1 nas propriedades da m√°quina. </li><li>  Localize o diret√≥rio em que os arquivos da sua m√°quina virtual est√£o armazenados e exclua ssd1.vmdk. </li></ul></li><li>  Verifique se sua m√°quina virtual ainda est√° em execu√ß√£o. </li><li>  Reinicie a m√°quina virtual e verifique se ela ainda funciona </li><li>  Verifique o status da matriz RAID: <code>cat /proc/mdstat</code> </li><li>  Adicione um novo disco do mesmo tamanho na interface da VM e chame-o de ssd3. </li><li>  Realize opera√ß√µes: <br><ul><li>  Veja o novo disco que chega ao sistema com o <code>fdisk -l</code> </li><li>  Copie a tabela de parti√ß√£o do disco antigo para o novo: <code>sfdisk -d /dev/XXXX | sfdisk /dev/YYY</code> <code>sfdisk -d /dev/XXXX | sfdisk /dev/YYY</code> </li><li>  Veja o resultado com <code>fdisk -l</code> </li><li>  Adicione um novo disco √† matriz RAID: <code>mdadm --manage /dev/md0 --add /dev/YYY</code> </li><li>  Veja o resultado: <code>cat /proc/mdstat</code> .  Voc√™ deve ver que a sincroniza√ß√£o foi iniciada. </li></ul></li><li><p>  Agora voc√™ precisa sincronizar manualmente as parti√ß√µes que n√£o fazem parte do RAID.  Para fazer isso, usaremos o utilit√°rio dd, copiando do disco "ativo" para o novo que voc√™ instalou recentemente: </p><br><pre> <code class="plaintext hljs">dd if=/dev/XXX of=/dev/YYY</code> </pre> <br></li><li>  Ap√≥s a conclus√£o da sincroniza√ß√£o, instale o grub no novo disco. </li><li>  Reinicie a VM para garantir que tudo esteja funcionando. </li></ol><br><p>  Descreva com suas pr√≥prias palavras o que voc√™ fez e qual resultado obteve como resultado da tarefa conclu√≠da. </p><br><p>  <strong>Resultado:</strong> removeu a unidade ssd1, salvou a unidade ssd2 e adicionou a unidade ssd3. </p><br><h2 id="zadanie-3-dobavlenie-novyh-diskov-i-perenos-razdela">  Tarefa 3 (Adicionando novos discos e particionamento) </h2><br><p>  Esta √© a tarefa mais dif√≠cil e volumosa de todas as apresentadas.  Verifique cuidadosamente o que voc√™ est√° fazendo e com quais discos e parti√ß√µes.  √â recomend√°vel que voc√™ fa√ßa uma c√≥pia antes de execut√°-la.  Esta tarefa, independentemente da tarefa n√∫mero 2, pode ser executada ap√≥s a tarefa n√∫mero 1, ajustada para nomes de disco. </p><br><p>  A segunda parte da tarefa deste laborat√≥rio deve levar exatamente ao mesmo estado que estava ap√≥s a conclus√£o da primeira parte. </p><br><p>  Para facilitar o trabalho, eu recomendo n√£o excluir fisicamente os discos da m√°quina host, mas apenas desconect√°-los nas propriedades da m√°quina.  Do ponto de vista do sistema operacional na VM, isso parecer√° exatamente o mesmo, mas, nesse caso, voc√™ poder√° conectar a unidade novamente e continuar trabalhando, revertendo alguns pontos, caso tenha algum problema.  Por exemplo, voc√™ pode ter executado incorretamente ou se esqueceu de copiar a parti√ß√£o / boot para um novo disco.  S√≥ posso aconselh√°-lo a verificar duas vezes com quais discos e parti√ß√µes voc√™ est√° trabalhando e, melhor ainda, anotar a correspond√™ncia de discos, parti√ß√µes e o n√∫mero "f√≠sico" do disco em um peda√ßo de papel.  O comando <code>lsblk</code> desenha uma √°rvore bonita e compreens√≠vel, use-a o mais r√°pido poss√≠vel para analisar o que voc√™ fez e o que precisa ser feito. </p><br><p>  Para a hist√≥ria ... </p><br><p>  Imagine que seu servidor funcionou por muito tempo em 2 discos ssd, quando de repente ... </p><br><ol><li><p>  Simule uma falha no disco ssd2 removendo o disco das propriedades da VM e reiniciando. </p><br></li><li><p>  Veja o estado atual dos discos e RAID: </p><br><pre> <code class="plaintext hljs">cat /proc/mdstat fdisk -l lsblk -o NAME,SIZE,FSTYPE,TYPE,MOUNTPOINT</code> </pre> <br></li><li><p>  Voc√™ tem sorte - as autoridades est√£o autorizadas a comprar v√°rios discos novos: </p><br><p>  2 Grandes volumes SATA para a tarefa atrasada de mover a se√ß√£o de log para um disco separado.  2 SSDs para substituir o falecido, bem como para substituir o ainda em funcionamento. </p><br><p>  Lembre-se de que a cesta do servidor suporta a instala√ß√£o de apenas 4 unidades.  ao mesmo tempo, para que voc√™ n√£o possa adicionar todos os discos de uma s√≥ vez. </p><br><p>  O volume do HDD √© 2 vezes maior que o SSD. <br>  O volume do SSD escolhe 1,25 vezes o tamanho do antigo SSD. </p><br></li><li><p>  Adicione uma nova unidade ssd, nomeie-a ssd4 e, depois de adicionar, verifique o que aconteceu: </p><br><pre> <code class="plaintext hljs">fdisk -l lsblk -o NAME,SIZE,FSTYPE,TYPE,MOUNTPOINT</code> </pre> <br></li><li><p>  Primeiro de tudo, voc√™ deve cuidar da seguran√ßa dos dados do disco antigo.  Desta vez, transferiremos dados usando o LVM: </p><br><ul><li><p>  Primeiro de tudo, voc√™ precisa copiar a tabela de arquivos do disco antigo para o novo: </p><br><pre> <code class="plaintext hljs">sfdisk -d /dev/XXX | sfdisk /dev/YYY</code> </pre> <br><p>  Substitua os discos corretos em vez de x, y e descubra o que esse comando faz. </p><br></li><li>  Execute lsblk -o NAME, SIZE, FSTYPE, TYPE, MOUNTPOINT e compare sua sa√≠da com a chamada anterior.  O que mudou? </li><li><p>  Use o comando dd para copiar os dados / boot no novo disco: </p><br><pre> <code class="plaintext hljs">dd if=/dev/XXX of=/dev/YYY</code> </pre> <br></li><li><p>  Se / boot permanecer montado na unidade antiga, ele dever√° ser montado em uma unidade ativa: </p><br><pre> <code class="bash hljs">mount | grep boot <span class="hljs-comment"><span class="hljs-comment">#     lsblk #           ,     umount /boot #  /boot mount -a #      /etc/fstab. #      /dev/sda,        </span></span></code> </pre> <br></li><li><p>  Instale o carregador de inicializa√ß√£o na nova unidade ssd: </p><br><pre> <code class="plaintext hljs">grub-install /dev/YYY</code> </pre> <br><p>  Por que estamos fazendo esta opera√ß√£o? </p><br></li><li><p>  Crie uma nova matriz de ataque com apenas uma nova unidade ssd inclu√≠da: </p><br><pre> <code class="plaintext hljs">mdadm --create --verbose /dev/md63 --level=1 --raid-devices=1 /dev/YYY</code> </pre> <br><p>  O comando acima n√£o funcionar√° sem especificar uma chave especial.Leia a ajuda e adicione essa chave ao comando. </p><br></li><li>  Use o comando cat / proc / mdstat para verificar o resultado da sua opera√ß√£o.  O que mudou? </li><li>  Execute lsblk -o NAME, SIZE, FSTYPE, TYPE, MOUNTPOINT e compare sua sa√≠da com a chamada anterior.  O que mudou? </li></ul><br></li><li><p>  O pr√≥ximo passo √© configurar o LVM </p><br><ul><li>  Execute o comando pvs para visualizar informa√ß√µes sobre os volumes f√≠sicos atuais. </li><li><p>  Crie um novo volume f√≠sico incluindo a matriz RAID criada anteriormente: </p><br><pre> <code class="plaintext hljs">pvcreate /dev/md63</code> </pre> <br></li><li>  Execute lsblk -o NAME, SIZE, FSTYPE, TYPE, MOUNTPOINT e compare sua sa√≠da com a chamada anterior.  O que mudou? </li><li>  Execute o comando pvs novamente.  O que mudou? </li><li><p>  Aumente o tamanho do sistema do Grupo de volumes com o seguinte comando: </p><br><pre> <code class="plaintext hljs">vgextend system /dev/md63</code> </pre> <br></li><li><p>  Execute os comandos e anote o que viu e o que mudou. </p><br><pre> <code class="plaintext hljs">vgdisplay system -v pvs vgs lvs -a -o+devices</code> </pre> <br><p>  Em que disco f√≠sico LV var, log, root est√° instalado agora? </p><br></li><li><p>  Mova os dados da unidade antiga para a nova, substituindo os nomes de dispositivos corretos. </p><br><pre> <code class="plaintext hljs">pvmove -i 10 -n /dev/system/root /dev/md0 /dev/md63</code> </pre> <br><p>  Repita a opera√ß√£o para todo o volume l√≥gico. </p><br></li><li><p>  Execute os comandos e anote o que viu e o que mudou. </p><br><pre> <code class="plaintext hljs">vgdisplay system -v pvs vgs lvs -a -o+devices lsblk -o NAME,SIZE,FSTYPE,TYPE,MOUNTPOINT</code> </pre> <br></li><li><p>  Mude o nosso VG removendo o antigo ataque dele.  Substitua o nome correto da invas√£o. </p><br><pre> <code class="plaintext hljs">vgreduce system /dev/md0</code> </pre> <br></li><li><p>  Execute os comandos e anote o que viu e o que mudou. </p><br><pre> <code class="plaintext hljs">lsblk -o NAME,SIZE,FSTYPE,TYPE,MOUNTPOINT pvs vgs</code> </pre> <br></li><li>  Para a beleza da imagem, remonte / inicialize na segunda unidade ssd (ssd4) e execute lsblk.  Como resultado, nada deve ser montado no disco ssd3.  Verifique cuidadosamente se a parti√ß√£o / boot n√£o est√° vazia!  <code>ls /boot</code> deve mostrar v√°rios arquivos e pastas.  Examine o que est√° armazenado nesta se√ß√£o e anote qual arquivo / diret√≥rio √© respons√°vel por qu√™. </li></ul><br></li><li><p>  Remova o disco ssd3 e adicione ssd5, hdd1, hdd2 de acordo com o TK acima, eventualmente obtendo: </p><br><ul><li>  ssd4 - primeiro novo ssd </li><li>  ssd5 - segundo novo ssd </li><li>  hdd1 - o primeiro novo disco r√≠gido </li><li>  hdd2 - segundo novo disco r√≠gido </li></ul><br></li><li><p>  Verifique o que aconteceu depois de adicionar discos: </p><br><pre> <code class="plaintext hljs">fdisk -l lsblk -o NAME,SIZE,FSTYPE,TYPE,MOUNTPOINT</code> </pre> <br></li><li><p>  Vamos restaurar a matriz principal de ataques: </p><br><ul><li><p>  Copie a tabela de parti√ß√£o, substituindo os discos corretos: </p><br><pre> <code class="plaintext hljs">sfdisk -d /dev/XXX | sfdisk /dev/YYY</code> </pre> <br></li><li><p>  Observe que, quando copiamos a tabela de parti√ß√£o do disco antigo, o novo tamanho n√£o usa todo o espa√ßo do disco r√≠gido.  Portanto, em breve precisaremos redimensionar esta se√ß√£o e expandir o ataque.  Veja voc√™ mesmo inserindo o comando: </p><br><pre> <code class="plaintext hljs">lsblk -o NAME,SIZE,FSTYPE,TYPE,MOUNTPOINT</code> </pre> <br></li></ul><br></li><li><p>  Copie a parti√ß√£o de inicializa√ß√£o / boot do ssd4 para o ssd5: </p><br><pre> <code class="plaintext hljs">dd if=/dev/XXX of=/dev/YYY</code> </pre> <br></li><li><p>  Instale o grub no novo disco (ssd5). </p><br></li><li><p>  Altere o tamanho da segunda parti√ß√£o da unidade ssd5. </p><br><ul><li><p>  Execute o utilit√°rio para trabalhar com o layout do disco: </p><br><pre> <code class="plaintext hljs">fdisk /dev/XXX</code> </pre> <br></li><li>  Digite a tecla d para excluir a parti√ß√£o existente (selecione 2). </li><li>  Digite a tecla n para criar uma nova parti√ß√£o. </li><li>  Digite a tecla p para indicar o tipo de parti√ß√£o prim√°ria. </li><li>  Digite a chave 2 para que a nova parti√ß√£o tenha um segundo n√∫mero. </li><li>  Primeiro setor: pressione enter para aceitar o tamanho inicial da se√ß√£o calculada automaticamente. </li><li>  √öltimo setor: pressione enter para aceitar o tamanho da se√ß√£o final calculado automaticamente. </li><li>  Digite a tecla l para ver uma lista de todos os tipos de parti√ß√£o poss√≠veis e encontre o Linux raid auto nela. </li><li>  Digite a tecla t para alterar o tipo da parti√ß√£o criada (2) e digite o n√∫mero encontrado na etapa anterior. </li><li>  Digite a tecla w para gravar a altera√ß√£o no disco. </li></ul><br></li><li><p>  Releia a tabela de parti√ß√£o e verifique o resultado: </p><br><pre> <code class="plaintext hljs">partx -u /dev/XXX lsblk -o NAME,SIZE,FSTYPE,TYPE,MOUNTPOINT</code> </pre> <br><ul><li><p>  Adicione um novo disco √† matriz de ataque atual (n√£o se esque√ßa de substituir os discos corretos): </p><br><pre> <code class="plaintext hljs">mdadm --manage /dev/md63 --add /dev/sda2</code> </pre> <br></li><li><p>  Expandimos o n√∫mero de discos em nossa matriz para 2 partes: </p><br><pre> <code class="plaintext hljs">mdadm --grow /dev/md63 --raid-devices=2</code> </pre> <br></li><li><p>  Veja o resultado: temos duas matrizes marcadas, mas as duas se√ß√µes inclu√≠das nessa matriz t√™m tamanhos diferentes: </p><br><pre> <code class="plaintext hljs">lsblk -o NAME,SIZE,FSTYPE,TYPE,MOUNTPOINT</code> </pre> <br></li></ul><br></li><li><p>  Aumentar o tamanho da parti√ß√£o no disco ssd4 </p><br><ul><li><p>  Execute o utilit√°rio para trabalhar com o layout do disco: </p><br><pre> <code class="plaintext hljs">fdisk /dev/XXX</code> </pre> <br></li><li>  Digite a tecla d para excluir a parti√ß√£o existente (selecione 2). </li><li>  Digite a tecla n para criar uma nova parti√ß√£o. </li><li>  Digite a tecla p para indicar o tipo de parti√ß√£o prim√°ria. </li><li>  Digite a chave 2 para que a nova parti√ß√£o tenha um segundo n√∫mero. </li><li>  Primeiro setor: pressione enter para aceitar o tamanho inicial da se√ß√£o calculada automaticamente. </li><li>  √öltimo setor: pressione enter para aceitar o tamanho da se√ß√£o final calculado automaticamente. </li><li>  No final da marca√ß√£o, selecione N√£o para deixar a assinatura de que a se√ß√£o pertence √† matriz. </li><li>  Digite a tecla w para gravar a altera√ß√£o no disco. </li></ul><br></li><li><p>  Relemos a tabela de parti√ß√£o e verificamos o resultado. </p><br><pre> <code class="plaintext hljs">partx -u /dev/XXX lsblk -o NAME,SIZE,FSTYPE,TYPE,MOUNTPOINT</code> </pre> <br><p>  Observe que agora as parti√ß√µes sda2, sdc2 s√£o maiores que o tamanho do dispositivo RAID. </p><br></li><li><p>  Neste ponto, o tamanho da invas√£o agora pode ser expandido: </p><br><pre> <code class="bash hljs">mdadm --grow /dev/md63 --size=max lsblk -o NAME,SIZE,FSTYPE,TYPE,MOUNTPOINT <span class="hljs-comment"><span class="hljs-comment"># check result</span></span></code> </pre> <br><p>  Navegue pelo lsblk e anote o que mudou. </p><br></li><li><p>  No entanto, mesmo que tenhamos alterado o tamanho da invas√£o, os tamanhos da pr√≥pria raiz vg, var, log n√£o mudaram. </p><br><ul><li><p>  Veja qual √© o tamanho do PV: </p><br><pre> <code class="bash hljs">pvs</code> </pre> <br></li><li><p>  Amplie o tamanho do nosso PV: </p><br><pre> <code class="bash hljs">pvresize /dev/md63</code> </pre> <br></li><li><p>  Veja qual √© o tamanho do PV: </p><br><pre> <code class="bash hljs">pvs</code> </pre> <br></li></ul><br></li><li><p>  Adicione o novo local VG var, root: </p><br><pre> <code class="bash hljs">lvs <span class="hljs-comment"><span class="hljs-comment">#     lvextend -l +50%FREE /dev/system/root lvextend -l +100%FREE /dev/system/var lvs #   </span></span></code> </pre> <br><p>  Neste ponto, voc√™ concluiu a migra√ß√£o da matriz principal para novos discos.  trabalho com ssd1, ssd2 est√° conclu√≠do. </p><br></li><li><p>  Nossa pr√≥xima tarefa √© mover / var / log para novas unidades, para isso criaremos uma nova matriz e lvm nas unidades de disco r√≠gido. </p><br><ul><li><p>  Vamos ver quais nomes t√™m as novas unidades de disco r√≠gido: </p><br><pre> <code class="bash hljs">fdisk -l</code> </pre> <br></li><li><p>  Crie uma matriz de ataque: </p><br><pre> <code class="bash hljs">mdadm --create /dev/md127 --level=1 --raid-devices=2 /dev/sdc /dev/sdd</code> </pre> <br></li><li><p>  Crie um novo PV no ataque a partir de discos grandes: </p><br><pre> <code class="bash hljs">pvcreate data /dev/md127</code> </pre> <br></li><li><p>  Neste PV, crie um grupo chamado data: </p><br><pre> <code class="bash hljs">vgcreate data /dev/md127</code> </pre> <br></li><li><p>  Crie um volume l√≥gico com o tamanho de todo o espa√ßo livre e chame-o de val_log: </p><br><pre> <code class="bash hljs">lvcreate -l 100%FREE -n var_log data <span class="hljs-comment"><span class="hljs-comment"># lvs #  </span></span></code> </pre> <br></li><li><p>  Formate a parti√ß√£o criada no ext4: </p><br><pre> <code class="bash hljs">mkfs.ext4 /dev/mapper/data-var_log</code> </pre> <br></li><li><p>  Vamos ver o resultado: </p><br><pre> <code class="bash hljs">lsblk</code> </pre> <br></li></ul><br></li><li><p>  Transfira os dados do log da se√ß√£o antiga para a nova </p><br><ul><li><p>  Montaremos um novo armazenamento de log tempor√°rio: </p><br><pre> <code class="plaintext hljs">mount /dev/mapper/data-var_log /mnt</code> </pre> <br></li><li><p>  Vamos sincronizar as se√ß√µes: </p><br><pre> <code class="bash hljs">apt install rsync rsync -avzr /var/<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>/ /mnt/</code> </pre> <br></li><li><p>  Descubra agora quais processos est√£o sendo executados com / var / log: </p><br><pre> <code class="bash hljs">apt install lsof lsof | grep <span class="hljs-string"><span class="hljs-string">'/var/log'</span></span></code> </pre> <br></li><li><p>  Paramos estes processos: </p><br><pre> <code class="bash hljs">systemctl stop rsyslog.service syslog.socket</code> </pre> <br></li><li><p>  Realizaremos a sincroniza√ß√£o final das parti√ß√µes (dos dados que poderiam ter sido alterados desde a √∫ltima sincroniza√ß√£o): </p><br><pre> <code class="bash hljs">rsync -avzr /var/<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>/ /mnt/</code> </pre> <br></li><li><p>  Troque as se√ß√µes: </p><br><pre> <code class="bash hljs">umount /mnt umount /var/<span class="hljs-built_in"><span class="hljs-built_in">log</span></span> mount /dev/mapper/data-var_log /var/<span class="hljs-built_in"><span class="hljs-built_in">log</span></span></code> </pre> <br></li><li><p>  Veja o que aconteceu: </p><br><pre> <code class="bash hljs">lsblk</code> </pre> <br></li></ul><br></li><li><p>  Edite / etc / fstab </p><br><p>  fstab - um arquivo no qual as regras s√£o escritas de acordo com as parti√ß√µes que ser√£o montadas na inicializa√ß√£o.  Nossa tarefa √© encontrar a linha na qual / var / log est√° montado e consertar o dispositivo de <code>system-log</code> do <code>system-log</code> em <code>data-var_log</code> . </p><br></li><li><p>  O mais importante nesse est√°gio √© lembrar de alterar a tabela de parti√ß√£o (ext4, por exemplo).  Como n√£o importa como alteramos todos os tipos de invas√µes, lvm - at√© que o FS na parti√ß√£o seja notificado de que o tamanho da parti√ß√£o foi alterado, n√£o poderemos usar o novo espa√ßo.  Use o comando <code>resize2fs</code> para alterar o FS. </p><br></li><li><p>  Acorde final </p><br><ul><li>  Vamos reiniciar.  Se voc√™ fez tudo corretamente, voc√™ se encontrar√° novamente em seu sistema operacional (isso √© necess√°rio para garantir que tudo funcione. Esta etapa n√£o tem significado, exceto para autoteste) </li><li><p>  Verifique se tudo o que quer√≠amos fazer foi realmente feito: </p><br><pre> <code class="bash hljs">pvs lvs vgs lsblk cat /proc/mdstat</code> </pre> <br></li></ul><br></li><li><p>  [OPCIONAL] Siga as etapas </p><br><ul><li>  Reinicialize pressionando F12 para indicar diferentes discos durante a inicializa√ß√£o, para garantir que voc√™ possa inicializar a partir de qualquer um dos discos ssd, para que n√£o tenhamos medo de um deles falhar. </li><li><p>  Agora voc√™ tem o log LV desnecess√°rio no sistema VG.  Distribua esse espa√ßo entre raiz ou var, mas, em vez de usar a constru√ß√£o 100% GR√ÅTIS, especifique o tamanho com as m√£os usando a op√ß√£o -L: </p><br><pre> <code class="bash hljs">-L 500M</code> </pre> <br></li><li>  Corrija o problema com o fato de o / boot estar em duas parti√ß√µes sem sincroniza√ß√£o. Voc√™ n√£o precisa fazer isso da maneira correta. Aqui, ele √© adicionado como exemplo.  N√£o esque√ßa de copiar o conte√∫do de / boot em algum lugar. </li><li>  Crie um novo ataque e inclua sda1, sda2 nele. </li><li>  Inclua essas parti√ß√µes no seu ataque existente e o restore / boot basicamente ataque, mas sem mont√°-lo mais. </li></ul><br></li></ol></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt450896/">https://habr.com/ru/post/pt450896/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt450886/index.html">Antecedentes: como funcionam os carros a hidrog√™nio e quando aparecem nas estradas</a></li>
<li><a href="../pt450888/index.html">Swift: Peneira de Erat√≥stenes</a></li>
<li><a href="../pt450890/index.html">Google I / O News 2019: Pixel 3a, Android Q, Kotlin e mais</a></li>
<li><a href="../pt450892/index.html">A velocidade de armazenamento √© adequada para etcd? Ask fio</a></li>
<li><a href="../pt450894/index.html">Sobre antenas para o menor</a></li>
<li><a href="../pt450898/index.html">Desenvolvimento de interface em v√°rias telas. Etapa para usar a IA</a></li>
<li><a href="../pt450902/index.html">Quer funcion√°rios leais - comece por voc√™ mesmo</a></li>
<li><a href="../pt450904/index.html">Aspectos pr√°ticos da implanta√ß√£o do aplicativo ASP.NET Core encaixado no Heroku</a></li>
<li><a href="../pt450906/index.html">Como come√ßar a viver e cultivar alface</a></li>
<li><a href="../pt450908/index.html">Redes negras para o Asterisk</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>