<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üí≤ üìÇ üëÜ Caixa preta do fumante ü§æüèª üòá üîπ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Muitas pessoas fumam muito, especialmente quando s√£o viciadas em alguma coisa e n√£o percebem como fumam um cigarro ap√≥s o outro. A caixa preta do fuma...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Caixa preta do fumante</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/402867/">  Muitas pessoas fumam muito, especialmente quando s√£o viciadas em alguma coisa e n√£o percebem como fumam um cigarro ap√≥s o outro.  A caixa preta do fumante (CJK) n√£o permite que voc√™ pegue o pr√≥ximo cigarro at√© que um certo per√≠odo de tempo tenha passado.  Neste artigo, prestarei aten√ß√£o a alguns detalhes que podem ser √∫teis para outros desenvolvimentos, especialmente o n√£o t√£o famoso controlador LC Teensy (fam√≠lia Arduino). <br><br><iframe width="560" height="315" src="https://www.youtube.com/embed/mRDSiEAsiAI" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><a name="habracut"></a><br>  <b>A mec√¢nica</b> <br><br>  Os detalhes do ChYAK s√£o impressos em uma impressora 3D e ap√≥s a montagem das partes inferior, m√©dia e superior s√£o coladas. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/353/eb5/369/353eb5369a304723be064ac6e07722e9.jpg"></div><br><br>  O mecanismo de travamento √© eletromec√¢nico, enquanto as fun√ß√µes b√°sicas de travamento s√£o realizadas puramente mecanicamente, isso dificulta a quebra do NJC manipulando as folgas e removendo as baterias. <br><br>  O sistema de travamento consiste em um rack com dentes e uma catraca biest√°vel, que permite que a bandeja se mova apenas na dire√ß√£o de fechamento.  Ao atingir um per√≠odo de tempo predeterminado, o servo faz um √∫nico movimento para frente e para tr√°s e empurra a catraca, que √© definida no segundo estado est√°vel "aberto".  O CFC permanece aberto at√© que o usu√°rio puxe a bandeja mecanicamente.  Quando estendida, a bandeja empurra a catraca e a coloca no estado de arma√ß√£o novamente. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/a0b/9a1/c0e/a0b9a1c0eaf74795b582073f40f55b93.jpg"></div><br><br>  O carregador √© feito na forma de um tambor com 4 recessos para cigarros.  Para evitar tentar enfiar um cigarro no carregador, o mecanismo da catraca n√£o permite o movimento na dire√ß√£o oposta, do lado em que os p√°ra-choques s√£o feitos. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/69b/1af/cb9/69b1afcb91214e94a40b24be99f6895e.jpg"></div><br><br>  Os slots foram feitos na tampa superior, permitindo eliminar poss√≠veis distor√ß√µes de cigarros dentro da caixa e sacudir as lascas de tabaco. <br><br>  <b>Interface</b> <br><br>  Para controlar o tempo, o n√∫mero de cigarros em CHYAK e o n√∫mero de cigarros retirados, o monitor OLED √© monitorado.  Ele √© desligado quase o tempo todo para n√£o descarregar a bateria e √© ligado apenas por um sinal do sensor capacitivo central, que √© acionado quando uma m√£o √© levada ao CHYAK ou um sinal do bot√£o ao carregar cigarros.  Outro bot√£o captura o momento em que a bandeja √© fechada e inicia o pr√≥ximo ciclo de atraso.  Dois sensores capacitivos adicionais est√£o localizados na parede traseira e s√£o usados ‚Äã‚Äãpara ajustar os contadores de cigarros (necess√°rios, por exemplo, ao trocar as baterias). <br><br>  <b>Eletr√¥nicos</b> <br><br>  O microcontrolador √© um LC Teensy.  Este dispositivo do tipo arduin, compat√≠vel com a maioria das bibliotecas do Arduino, foi escolhido porque suporta sensores capacitivos (TSI).  Os sensores s√£o t√£o sens√≠veis que sentem facilmente a m√£o levantada a uma dist√¢ncia de um cent√≠metro.  O Teensy LC possui o chamado modo LLWU; nesse modo, todos os m√≥dulos est√£o no modo de suspens√£o, com exce√ß√£o do oscilador de 1 kHz.  Voc√™ pode sair desse modo de suspens√£o de 4 maneiras: a) interrompa o sensor capacitivo, b) interrompa o pino, c) transborde o contador de 1 kHz (timer de baixa pot√™ncia, LPTMR); d) interrompa o alarme. <br><br>  Aqui o autor estava com problemas: nos planos iniciais, era usado o TSI para acordar quando uma m√£o era apresentada, e o LPTMR para interrup√ß√µes peri√≥dicas para ajustar os n√≠veis do TSI (dependendo das condi√ß√µes ambientais) e o controle do tempo.  Por√©m, o LPTMR √© usado para o funcionamento da ETI e, portanto, n√£o pode ser usado como contador de tempo.  (A interrup√ß√£o de transbordamento LPTMR √© acionada por hardware para TSI e, √© claro, deve ser r√°pida para monitorar o sensor. Geralmente esse contador √© predefinido para menos um, para que o TSI seja pesquisado com a frequ√™ncia mais alta poss√≠vel de 1 kHz). <br><br>  Outra possibilidade seria usar a interrup√ß√£o de alarme do RTC, mas o fato √© que o Tenncy LC n√£o possui um rel√≥gio de tempo real (RTC).  Em vez disso, o RTC est√° no pr√≥prio processador, mas n√£o h√° fia√ß√£o para o quartzo RTC na placa.  No entanto, o desenvolvedor do processador deixou algumas brechas para questionar as mentes.  O oscilador de 1kHz (que opera no modo de suspens√£o) pode ser usado como fonte para os registros RTC do controlador.  Acontece que o RTC pode contar n√£o segundos intervalos (como quando se usa quartzo a 32 kHz), mas 32 segundos se estiver usando um oscilador de 1 kHz.  Essa precis√£o, √© claro, n√£o √© suficiente.  Mas h√° uma sa√≠da. <br><br>  Veja como funciona: <br><br>  H√° um registro de pr√©-escalador de tempo RTC (RTC_TPR).  Este registro de 16 bits conta os pulsos do oscilador.  Quando transborda, o RTC Time Seconds Register (RTC_TSR) aumenta em um.  No modo cl√°ssico, esses s√£o os segundos que s√£o comparados com o Registro de Alarme de Hora RTC (RTC_TAR) e, quando coincidem, √© gerada uma interrup√ß√£o de alarme.  Ao usar quartzo normal de 32kHz, o RTC_TSR n√£o √© pr√©-instalado, mas √© contado a partir de zero todas as vezes (32768 a estouro (segundos)).  Mas se pr√©-instalarmos o RTC_TSR a cada vez, levando em considera√ß√£o que temos um oscilador lento de 1kHz, podemos interromper um alarme com precis√£o de milissegundos (sem levar em conta a imprecis√£o do pr√≥prio oscilador).  Obviamente, RTC_TAR tamb√©m deve ser recalculado de acordo. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/719/cc7/057/719cc7057df74632be110832ac93d99b.png"></div><br><br>  Por exemplo, se quisermos definir o per√≠odo para 87 segundos, devemos escrever 2 em RTC_TSR (2 * 32768 = 65536ms = 65.536s), 2 em RTC_TAR e 32768- (87 * 1000-65536) = 11304 em RTC_TSR.  Ent√£o 32.768-11.304 = 21.464 segundos passar√£o antes do primeiro estouro de RTC_TPR, e dois ciclos completos 2 * 32.768 = 65.536 ser√£o adicionados a eles, que ser√£o apenas 21.464 + 65.536 = 87 segundos <br>  Em geral, assim: <br><br><pre><code class="hljs cpp"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setAlarm</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint32_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> seconds )</span></span></span><span class="hljs-function"> </span></span>{ RTC_SR = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-comment"><span class="hljs-comment">//disable RTC RTC_TPR=32768-(seconds*1000%32768); RTC_TSR=0; //RTC counter RTC_SR = RTC_SR_TCE; //enable RTC RTC_TAR = seconds*1000/32768; }</span></span></code> </pre> <br>  E at√© podemos monitorar o tempo total (at√© um erro de 1kHz do oscilador), por exemplo, se no in√≠cio do programa todos os registros do RTC eram zero: <br><br><pre> <code class="hljs lisp">timeEllapsed=(<span class="hljs-name"><span class="hljs-name">RTC_TSR*32768+RTC_TPR</span></span>)/1000</code> </pre> <br>  A precis√£o do oscilador de 1kHz √© pequena, mas para nossos prop√≥sitos ser√° suficiente.  Observe que, ao iniciar um novo alarme, modificamos os registros RTC, portanto, se voc√™ precisar monitorar o tempo, eles devem ser lembrados antes do alarme iniciar e, ap√≥s sair da interrup√ß√£o do alarme, eles ser√£o recalculados novamente, levando em considera√ß√£o o tempo gasto na hiberna√ß√£o.  Eu a descrevi em detalhes aqui: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">sobre o RTC para Teency LC</a> <br><br>  No CJC, uma interrup√ß√£o a cada 10 minutos mede e armazena o n√≠vel do sinal dos sensores capacitivos na aus√™ncia de uma m√£o.  Isso √© feito para poder rastrear com seguran√ßa as altera√ß√µes nos sinais √† medida que elas se aproximam.  Com o fundo em ~ 500 unidades, usamos um n√≠vel excedente de ~ 20 unidades, possibilitando sentir a m√£o a uma dist√¢ncia de 5 a 10 mm.  O n√≠vel de fundo depende da temperatura e umidade, portanto, para confiabilidade, ele deve ser ajustado periodicamente.  Acredito que isso seja uma falha nos desenvolvedores de processadores.  Por que eles n√£o deram a oportunidade de ativar o TSI e algum outro contador de baixa pot√™ncia ao mesmo tempo (basta adicionar mais um registro), j√° que o ajuste peri√≥dico dos n√≠veis do TSI √© quase obrigat√≥rio, mesmo que voc√™ n√£o precise de um temporizador para outros fins! <br><br>  Agora sobre a energia consumida.  No modo de espera LLWU, o Teensy LC consome cerca de 15 uA quando n√£o h√° kit corporal.  Tivemos que conectar outro monitor OLED e um servo.  Ambos os dispositivos possuem grandes correntes de fuga mesmo em estado passivo. <br><br>  Tudo √© simples com o OLED, este √© o monitor OLED Adafruit de 0,96 ‚Äù, monocrom√°tico de 128x64, √© alimentado por 3,3V, consome corrente de cerca de 20 mA quando est√° ligado (dependendo do n√∫mero de pixels envolvidos) e √© controlado pela SPI.  Ou seja, basta conectar sua entrada de energia √† sa√≠da de 20 miliamperes do Teensy LC (a Teency tem diferentes tipos de sa√≠das) e pronto.  Quando todo mundo dorme, essa sa√≠da √© simplesmente transferida para o terceiro estado e a corrente n√£o passa pelo visor. Com a ativa√ß√£o, a sa√≠da √© transferida para o estado alto de sa√≠da e se torna Vcc para o visor. <br><br>  Servo √© um pouco mais complicado.  Servo no modo de espera consome uma corrente de cerca de 2 mA, o que, √© claro, n√£o √© aceit√°vel.  Portanto, voc√™ deve desativ√°-lo completamente enquanto dorme.  Diferentemente do Arduin cl√°ssico, o Teensy LC tem uma sele√ß√£o bastante pequena de fontes de alimenta√ß√£o: 1,7-3,3 V conectadas diretamente ou 2,6-5,5 V (com o regulador de tens√£o interno ativado).  Servos geralmente acess√≠veis funcionam a partir de pelo menos 1S Lipo, e isso √© de 3,3 a 4,2 V. Portanto, precisamos ligar tr√™s baterias padr√£o em s√©rie para ter de 3,3 (descarga) a 4,6 V (novo).  Para a maioria dos servos, 3,3 V est√° no limite de opera√ß√£o, portanto, diretamente as sa√≠das Teensy n√£o podem ser usadas (como no OLED).  Sim, e a corrente durante a rota√ß√£o √© de cerca de 50 mA, o que √© um pouco demais para o Teensy LC.  Portanto, o servo √© ativado via MOSFET: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/d87/121/7a3/d871217a39f04ecfb537dff032ac7fb1.png"></div><br><br>  Com essa ativa√ß√£o, pode parecer que n√£o √© seguro, pois quando o MOSFET √© desligado, a tens√£o na entrada PWM ctrl excede 3,3 V e as entradas Tennsy LC n√£o s√£o tolerantes a 5V (ao contr√°rio do Arduin cl√°ssico).  Mas voc√™ n√£o deve ter medo disso, lembrando que a atual PWM ctrl √© muito pequena e n√£o h√° necessidade de ter medo do diodo limitador na entrada do processador (a raz√£o da inadmissibilidade de exceder Vcc + 0,5 est√° nesse diodo), al√©m disso, em correntes compar√°veis ‚Äã‚Äã√†s correntes do diodo fechado ele nem estar√° no estado aberto. <br><br>  no CHYAK, uso o HK282 com um limite de 3,3V (s√≥ porque eu o tinha).  Algum tipo de servo de baixa voltagem e baixa pot√™ncia pode ser alimentado diretamente das sa√≠das Teensy, de acordo com o esquema usado para o OLED. <br><br>  Como resultado, a corrente no modo de suspens√£o acabou por ser de cerca de 50 uA, provavelmente foi poss√≠vel reduzi-la ainda mais, mas eu decidi que isso era suficiente (se apenas adormecida, as baterias deveriam durar mais de 4 anos: 2000mAh / 0,05mA). <br><br>  <b>T√©cnico</b> <br><br>  Impresso em uma impressora Monoprice Ultimate 3D, pl√°stico PLA, bico de 0,4 mm, camada de 0,2 mm.  Para detalhes do mecanismo de travamento, uma camada de 0,1 mm para precis√£o.  As molas tamb√©m s√£o impressas em uma impressora 3D.  Digitando por um longo tempo.  Por exemplo, a maior parte do meio (possui muitas partes internas e paredes duplas para eletr√¥nicos e fios) foi impressa por 20 horas.  Ele foi colado com cola de ciano-acrilato.  Se algo quebrar, √© imposs√≠vel distinguir (prote√ß√£o contra man√≠acos-fumantes), voc√™ precisar√° quebr√°-lo como um cofrinho e imprimir novamente (um argumento a favor das impressoras 3D).  Desenhos e anima√ß√µes s√£o feitos no SolidWorks, o ambiente de desenvolvimento AtmelStudio (sim, o AVR (teency) √© suportado imediatamente, como o Arduino, atrav√©s do VisualMicro). </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt402867/">https://habr.com/ru/post/pt402867/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt402853/index.html">A terceira onda de solu√ß√µes blockchain traz tecnologia CATs</a></li>
<li><a href="../pt402859/index.html">Laptops a servi√ßo da pol√≠cia</a></li>
<li><a href="../pt402861/index.html">Primeira Vez: para a estr√©ia do filme</a></li>
<li><a href="../pt402863/index.html">Um contrato modelo honesto como mecanismo de auto-regula√ß√£o das rela√ß√µes p√∫blicas</a></li>
<li><a href="../pt402865/index.html">Dois v√¥os de um est√°gio do Falcon 9 em um v√≠deo</a></li>
<li><a href="../pt402869/index.html">Rastreadores da moda fora de moda: Samsung, Polar, Withings, que n√£o eram esperados</a></li>
<li><a href="../pt402871/index.html">Como abrir um banco na Europa: licenciamento e blockchain</a></li>
<li><a href="../pt402873/index.html">O livro "N√£o morra! Comida na luta pela vida "</a></li>
<li><a href="../pt402875/index.html">Matrizes para c√¢meras de CFTV. O que prestar aten√ß√£o?</a></li>
<li><a href="../pt402877/index.html">Apresenta√ß√£o da impressora de chocolate</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>