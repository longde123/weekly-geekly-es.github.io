<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🦌 ⚖️ 💖 Megapack: bagaimana pengembang Factorio berhasil memecahkan masalah dengan 200 pemain multipemain ↩️ 🌳 🤞🏼</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Pada bulan Mei tahun ini, saya berpartisipasi sebagai pemain dalam acara MMO KatherineOfSky . Saya perhatikan bahwa ketika jumlah pemain mencapai juml...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Megapack: bagaimana pengembang Factorio berhasil memecahkan masalah dengan 200 pemain multipemain</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/466135/"><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/0b7/35a/156/0b735a15617cf15740ddb733b0cff066.jpg" alt="gambar"></div><br>  Pada bulan Mei tahun ini, saya berpartisipasi sebagai pemain dalam <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">acara MMO KatherineOfSky</a> .  Saya perhatikan bahwa ketika jumlah pemain mencapai jumlah tertentu, setiap beberapa menit beberapa dari mereka “jatuh”.  Untungnya bagi Anda (tetapi tidak bagi saya), saya adalah salah satu pemain yang terputus <b>setiap saat</b> , bahkan dengan koneksi yang baik.  Saya menganggap ini sebagai tantangan pribadi dan mulai mencari penyebab masalah.  Setelah tiga minggu debugging, pengujian dan perbaikan, kesalahan akhirnya diperbaiki, tetapi perjalanan ini tidak begitu sederhana. <br><br>  Masalah permainan multipemain sangat sulit dilacak.  Biasanya mereka muncul dalam kondisi yang sangat spesifik dari parameter jaringan dan dalam kondisi permainan yang sangat spesifik (dalam hal ini, kehadiran lebih dari 200 pemain).  Dan bahkan ketika dimungkinkan untuk mereproduksi masalah, itu tidak dapat didebug dengan benar, karena penyisipan titik kontrol menghentikan permainan, membingungkan timer dan biasanya mengarah pada penghentian koneksi karena melebihi waktu tunggu.  Namun berkat kekeraskepalaan dan alat luar biasa yang disebut <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">canggung,</a> saya berhasil mengetahui apa yang terjadi. <br><br>  Singkatnya: karena kesalahan dan implementasi simulasi kondisi keterlambatan yang tidak lengkap, klien terkadang menemukan dirinya dalam situasi di mana ia harus mengirim paket jaringan dalam satu siklus clock, yang terdiri dari tindakan pemain untuk memilih sekitar 400 entitas game (kami menyebutnya "megapackage").  Setelah itu, server seharusnya tidak hanya menerima semua tindakan input ini dengan benar, tetapi juga mengirimkannya ke semua klien lain.  Jika Anda memiliki 200 pelanggan, ini dengan cepat menjadi masalah.  Saluran ke server dengan cepat tersumbat, yang menyebabkan hilangnya paket dan riam paket yang diminta kembali.  Menunda tindakan input kemudian mengarah pada fakta bahwa semakin banyak klien mulai mengirim megapacket, dan longsoran salju mereka menjadi semakin kuat.  Klien yang berhasil berhasil pulih, sisanya “jatuh”. <br><a name="habracut"></a><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/f21/a49/50e/f21a4950e42bd555a91ad923e5067ea6.jpg" alt="gambar"></div><br>  Masalahnya cukup mendasar, dan saya butuh 2 minggu untuk memperbaikinya.  Ini cukup teknis, jadi di bawah ini saya akan menjelaskan detail teknis yang menarik.  Tapi pertama-tama Anda perlu tahu bahwa sejak versi 0.17.54, dirilis pada 4 Juni, dalam menghadapi masalah koneksi sementara, multiplayer menjadi lebih stabil, dan penyembunyian penundaan jauh lebih sedikit buggy (kurang pengereman dan teleportasi).  Selain itu, saya mengubah cara menyembunyikan penundaan dalam pertempuran dan saya berharap bahwa berkat ini mereka akan menjadi sedikit lebih lancar. <br><br><h3>  Megapack Multi-Pengguna - Detail Teknis </h3><br>  Dalam istilah sederhana, multipemain dalam permainan berfungsi sebagai berikut: semua klien mensimulasikan keadaan permainan, menerima dan mengirim hanya input pemain (disebut “Tindakan input”, <i>Tindakan Input</i> ).  Tugas utama server adalah untuk mengirimkan <i>Tindakan Input</i> dan mengontrol bahwa semua klien melakukan tindakan yang sama dalam satu siklus.  Baca lebih lanjut tentang ini di pos <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">FFF-149</a> . <br><br>  Karena server harus membuat keputusan tentang tindakan apa yang harus dilakukan, tindakan pemain bergerak di sepanjang jalur ini: tindakan pemain -&gt; klien game -&gt; jaringan -&gt; server -&gt; jaringan -&gt; klien permainan.  Ini berarti bahwa setiap tindakan pemain dilakukan hanya setelah ia membuat jalur bolak-balik melalui jaringan.  Karena hal ini, permainan akan tampak sangat lambat, jadi hampir segera setelah multipemain muncul dalam permainan, mekanisme untuk menyembunyikan penundaan diperkenalkan.  Menyembunyikan penundaan meniru input pemain tanpa memperhitungkan tindakan pemain lain dan keputusan server. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/8u/2f/ui/8u2fuieagsu2fokkbdny-hxi1cc.png"></div><br>  Factorio memiliki status permainan yang disebut Status <i>Permainan</i> - ini adalah status penuh dari peta, pemain, entitas, dan yang lainnya.  Secara deterministik disimulasikan di semua klien berdasarkan tindakan yang diterima dari server.  Status permainan adalah sakral, dan jika itu mulai berbeda dari server atau klien lain, maka terjadi sinkronisasi. <br><br>  Selain <i>Status</i> <i>Game</i> , kami memiliki <i>status</i> latensi <i>Status</i> Latensi.  Ini berisi subset kecil dari keadaan dasar.  <i>Status Latensi</i> tidak sakral dan hanya menyajikan gambaran tentang bagaimana kondisi permainan di masa depan berdasarkan <i>Tindakan Input yang</i> diperkenalkan oleh pemain. <br><br>  Untuk melakukan ini, kami menyimpan salinan <i>Tindakan Input yang</i> dibuat di antrean penundaan. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/gf/m4/bo/gfm4bo81-iluah40eus3cxjxvjm.png"></div><br>  Yaitu, pada akhir proses di sisi klien, gambarnya terlihat seperti ini: <br><br><ol><li>  Terapkan <i>Tindakan Input dari</i> semua pemain ke <i>Status Game</i> saat tindakan input ini diterima dari server. </li><li>  Kami menghapus dari antrian keterlambatan semua <i>Tindakan Input</i> yang, menurut server, telah diterapkan ke <i>Status Game</i> . </li><li>  Hapus <i>Status Latensi</i> dan setel ulang sehingga terlihat sama persis dengan Status <i>Game</i> . </li><li>  Terapkan semua tindakan dari antrian penundaan ke <i>Status Latency</i> . </li><li>  Berdasarkan data dari <i>Game State</i> dan <i>Latency State, kami</i> memberikan game tersebut kepada pemain. </li></ol><br>  Semua ini diulangi dalam setiap ukuran. <br><br>  Terlalu rumit?  Jangan santai, itu belum semuanya.  Untuk mengimbangi koneksi Internet yang tidak dapat diandalkan, kami menciptakan dua mekanisme: <br><br><ul><li>  Kutu yang terlewat: ketika server memutuskan bahwa <i>Tindakan Input</i> akan dilakukan dalam permainan, maka jika tidak menerima <i>Tindakan Input</i> beberapa pemain (misalnya, karena keterlambatan yang meningkat), itu tidak akan menunggu, tetapi akan memberi tahu klien ini “Saya tidak mempertimbangkan <i>Tindakan Input</i> Anda, saya akan mencoba menambahkannya ke langkah berikutnya. "  Hal ini dilakukan agar, karena masalah dengan koneksi (atau dengan komputer) dari satu pemain, pembaruan peta tidak akan melambat untuk semua orang.  Perlu dicatat bahwa <i>Tindakan Input</i> tidak diabaikan, tetapi hanya ditunda. </li><li>  Round Trip Delay: Server mencoba menebak berapa penundaan round-trip antara klien dan server untuk setiap klien.  Setiap 5 detik, jika perlu, ia membahas dengan klien penundaan baru (tergantung pada bagaimana koneksi berperilaku di masa lalu), dan karenanya menambah atau mengurangi keterlambatan dalam mentransfer data bolak-balik. </li></ul><br>  Sendiri, mekanisme ini cukup sederhana, tetapi ketika mereka digunakan bersama-sama (yang sering terjadi dengan masalah koneksi), logika kode menjadi sulit untuk dikelola dan dengan banyak kasus garis batas.  Selain itu, ketika mekanisme ini ikut <i>berperan</i> , server dan antrean penundaan harus benar mengimplementasikan <i>Input Action</i> khusus yang disebut <i>StopMovementInTheNextTick</i> .  Karena ini, dengan masalah dengan koneksi, karakter tidak akan berjalan dengan sendirinya (misalnya, di bawah kereta). <br><br>  Sekarang Anda perlu menjelaskan kepada Anda bagaimana pemilihan entitas bekerja.  Salah satu jenis <i>Tindakan Input yang</i> disahkan adalah perubahan status pemilihan entitas.  Ini memberi tahu semua orang entitas apa yang dibawa pemain itu.  Seperti yang dapat Anda pahami, ini adalah salah satu tindakan input yang paling sering dikirim oleh klien, jadi untuk menghemat bandwidth, kami mengoptimalkannya sehingga membutuhkan ruang sesedikit mungkin.  Ini diimplementasikan sebagai berikut: saat memilih setiap entitas, alih-alih mempertahankan koordinat peta absolut dan presisi tinggi, game mempertahankan perpindahan relatif arus rendah dari pilihan sebelumnya.  Ini bekerja dengan baik karena pemilihan mouse biasanya terjadi sangat dekat dengan pilihan sebelumnya.  Karena itu, dua persyaratan penting muncul: <i>Tindakan Input</i> tidak boleh dilewati dan harus dilakukan dalam urutan yang benar.  Persyaratan ini dipenuhi untuk <i>Status Game</i> .  Tetapi karena tugas dari <i>negara Latency</i> adalah untuk "terlihat cukup baik" untuk pemain, mereka tidak puas dalam kondisi penundaan.  <i>Negara Latency</i> tidak memperhitungkan <a href="">banyak kasus garis batas yang</a> terkait dengan melewatkan siklus dan mengubah penundaan pulang-pergi. <br><br>  Anda sudah bisa menebak ke mana semuanya berjalan.  Akhirnya, kita mulai melihat penyebab masalah megapackage.  Akar masalahnya adalah bahwa dalam memutuskan apakah akan melewati tindakan perubahan seleksi, logika pemilihan entitas bergantung pada <i>Negara Latensi</i> , dan negara ini tidak selalu berisi informasi yang benar.  Oleh karena itu, megapackage dibuat seperti ini: <br><br><ol><li>  Pemain memiliki masalah koneksi. </li><li>  Mekanisme untuk melewatkan jam dan mengatur penundaan pulang-pergi mulai berlaku. </li><li>  Keterlambatan status antrian tidak memperhitungkan mekanisme ini.  Hal ini menyebabkan beberapa tindakan dihapus sebelum waktunya atau dilakukan dalam urutan yang salah, yang menghasilkan <i>Status Latensi yang</i> salah. </li><li>  Pemain memiliki masalah dengan koneksi dan dia, untuk mengejar ketinggalan dengan server, mensimulasikan hingga 400 siklus clock. </li><li>  Di setiap siklus jam, tindakan baru, mengubah pemilihan entitas, dihasilkan dan disiapkan untuk dikirim ke server. </li><li>  Klien mengirimkan megapacket lebih dari 400 perubahan dalam pilihan entitas (dan dengan tindakan lain: keadaan menembak, berjalan, dll., Juga menderita masalah ini). </li><li>  Server menerima 400 tindakan input.  Karena ia tidak diizinkan untuk melewati satu tindakan input tunggal, ia memerintahkan semua klien untuk melakukan tindakan ini dan mengirimkannya melalui jaringan. </li></ol><br>  Ironisnya adalah bahwa mekanisme yang dirancang untuk menghemat bandwidth saluran menciptakan paket jaringan besar sebagai hasilnya. <br><br>  Kami memecahkan masalah ini dengan memperbaiki semua kasus pembaruan dan mendukung antrean penundaan.  Meskipun butuh waktu cukup lama, pada akhirnya itu layak menerapkan semuanya dengan benar dan tidak mengandalkan peretasan cepat. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/id466135/">https://habr.com/ru/post/id466135/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../id466113/index.html">Menentukan pengodean teks dalam PHP, bukan mb_detect_encoding</a></li>
<li><a href="../id466121/index.html">Pembuatan suara pada mikrokontroler AVR menggunakan metode wavetable dengan dukungan polifoni</a></li>
<li><a href="../id466123/index.html">Pertumbuhan. Berat Tiga tetangga</a></li>
<li><a href="../id466127/index.html">Kola NPP atau berdiri di reaktor</a></li>
<li><a href="../id466129/index.html">Efisiensi transportasi dengan bensin, baterai dan hidrogen</a></li>
<li><a href="../id466137/index.html">System.IO. Pipelines - alat yang sedikit dikenal bagi pecinta kinerja tinggi</a></li>
<li><a href="../id466139/index.html">Teknologi yang diterapkan pada reruntuhan demam blockchain atau manfaat praktis dari alokasi sumber daya</a></li>
<li><a href="../id466143/index.html">Bagaimana kami membuat kode kardus atau versi Awal dari game papan Golem Battle</a></li>
<li><a href="../id466147/index.html">Manajer Tampilan Data Reaktif. Pendahuluan</a></li>
<li><a href="../id466149/index.html">Membuat simbol konektor dengan teks "dinamis" di OrCAD</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>