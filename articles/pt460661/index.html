<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üçΩÔ∏è üë©üèª‚Äç‚úàÔ∏è üë®üèº‚Äçüéì Tudo o que voc√™ precisa saber sobre o Node.js üöµüèø üóÑÔ∏è üòé</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Ol√° Habr! Apresento a voc√™ a tradu√ß√£o do artigo "Tudo o que voc√™ precisa saber sobre o Node.js", de Jorge Ram√≥n. 





 Atualmente, a plataforma Node....">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Tudo o que voc√™ precisa saber sobre o Node.js</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/460661/"><p>  Ol√° Habr!  Apresento a voc√™ a tradu√ß√£o do artigo <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">"Tudo o que voc√™ precisa saber sobre o Node.js",</a> de Jorge Ram√≥n. </p><br><p><img src="https://habrastorage.org/webt/ua/qz/gr/uaqzgrarpig3cxhjdiuiutbxbms.jpeg"></p><br><p>  Atualmente, a plataforma Node.js. √© uma das plataformas mais populares para a cria√ß√£o de APIs REST eficientes e escalon√°veis.  Tamb√©m √© adequado para a cria√ß√£o de aplicativos m√≥veis h√≠bridos, programas de desktop e at√© para IoT. </p><br><p>  Trabalho com a plataforma Node.js. h√° mais de 6 anos e realmente adoro isso.  Esta postagem est√° tentando principalmente ser um guia sobre como o Node.js realmente funciona. </p><a name="habracut"></a><br><p>  Vamos come√ßar !! </p><br><p>  <strong>O que ser√° discutido:</strong> </p><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Mundo antes do Node.js</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Problema C10K</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Node.js e o loop de eventos</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">O problema das tarefas que consomem muita CPU</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Trabalhadores e seus fluxos</a> </li></ul><br><a name="p1"></a><br><h3 id="mir-do-nodejs">  Mundo antes do Node.js </h3><br><p>  <strong>Servidor multithread</strong> </p><br><p>  Os aplicativos da Web gravados seguindo a arquitetura cliente / servidor funcionam da seguinte maneira - o cliente solicita o recurso necess√°rio do servidor e o servidor envia o recurso em resposta.  Nesse esquema, o servidor responde √† solicita√ß√£o e finaliza a conex√£o. </p><br><p>  Esse modelo √© efetivo porque cada solicita√ß√£o ao servidor consome recursos (mem√≥ria, tempo do processador etc.).  Para processar cada solicita√ß√£o subsequente do cliente, o servidor deve concluir o processamento da solicita√ß√£o anterior. </p><br><p>  Isso significa que o servidor pode processar apenas uma solicita√ß√£o por vez?  Na verdade n√£o!  Quando o servidor recebe uma nova solicita√ß√£o, ele cria um <strong>thread</strong> separado para process√°-lo. </p><br><p>  <em>O fluxo</em> , em palavras simples, √© o tempo e os recursos que a CPU aloca para executar um pequeno bloco de instru√ß√µes.  Com isso dito, o servidor pode processar v√°rias solicita√ß√µes por vez, mas apenas uma por thread.  Esse modelo tamb√©m √© chamado de modelo de <strong>thread por solicita√ß√£o</strong> . </p><br><p><img src="https://habrastorage.org/webt/mm/ns/gn/mmnsgnzvz7aptv62xrbo6zxju-w.jpeg"></p><br><p>  Para processar N pedidos, o servidor precisa de N threads.  Se o servidor receber solicita√ß√µes N + 1, dever√° aguardar at√© que um dos encadeamentos fique dispon√≠vel. </p><br><p>  Na figura acima, o servidor pode processar at√© 4 solicita√ß√µes (threads) de cada vez e, quando receber as pr√≥ximas 3 solicita√ß√µes, essas solicita√ß√µes dever√£o aguardar at√© que qualquer um desses 4 threads fique dispon√≠vel. </p><br><p>  Uma maneira de se livrar das restri√ß√µes √© adicionar mais recursos (mem√≥ria, n√∫cleos do processador etc.) ao servidor, mas essa n√£o √© a melhor solu√ß√£o .... </p><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/yb/qz/zl/ybqzzljzkgej-kirqwza-43amcw.gif"></div><br><p>  E, claro, n√£o se esque√ßa das limita√ß√µes tecnol√≥gicas. </p><br><p>  <strong>Bloqueio de entrada / sa√≠da</strong> </p><br><p>  O n√∫mero limitado de threads no servidor n√£o √© o √∫nico problema.  Talvez voc√™ tenha se perguntado por que um √∫nico encadeamento n√£o pode processar v√°rias solicita√ß√µes ao mesmo tempo?  tudo devido ao <strong>bloqueio de opera√ß√µes de E / S.</strong> </p><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/ei/ao/02/eiao02s-dtpki8au6sybf8-dmbu.gif"></div><br><p>  Suponha que voc√™ esteja desenvolvendo uma loja online e precise de uma p√°gina na qual o usu√°rio possa visualizar uma lista de todos os produtos. </p><br><p>  O usu√°rio bate em <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">http://yourstore.com/products</a> e o servidor renderiza um arquivo HTML com todos os produtos do banco de dados em resposta.  N√£o √© nada complicado, certo? </p><br><p>  Mas o que acontece nos bastidores? </p><br><ul><li> Quando um usu√°rio bate em <code>/products</code> m√©todo ou fun√ß√£o espec√≠fica deve ser executada para processar a solicita√ß√£o.  Um pequeno peda√ßo de c√≥digo (o seu ou o seu framework) analisa o URL da solicita√ß√£o e procura um m√©todo ou fun√ß√£o adequada.  <strong>O fluxo est√° em execu√ß√£o</strong> . <img width="20" src="https://habrastorage.org/webt/o1/sw/x5/o1swx5v-gnn2ptqjjzonhq3oew0.png"></li><li>  Agora, o m√©todo ou fun√ß√£o desejado √© executado, como no primeiro par√°grafo, o <strong>thread funciona.</strong> <img width="20" src="https://habrastorage.org/webt/o1/sw/x5/o1swx5v-gnn2ptqjjzonhq3oew0.png"></li><li>  Como voc√™ √© um bom desenvolvedor, salve todos os logs do sistema em um arquivo e, √© claro, para garantir que o roteador execute o m√©todo / fun√ß√£o desejado - voc√™ tamb√©m registra a linha ‚ÄúM√©todo X executando !!‚Äù. Mas tudo isso est√° bloqueando as opera√ß√µes o <strong>fluxo de</strong> entrada / sa√≠da <strong>est√° aguardando</strong> . <img width="20" src="https://habrastorage.org/webt/bq/lm/cq/bqlmcq7ntk4kpr2gncodmxpqqee.png"></li><li>  Todos os logs s√£o salvos e as seguintes linhas de fun√ß√£o s√£o executadas.  <strong>O encadeamento est√° funcionando novamente</strong> . <img width="20" src="https://habrastorage.org/webt/o1/sw/x5/o1swx5v-gnn2ptqjjzonhq3oew0.png"></li><li>  Hora de acessar o banco de dados e obter todos os produtos - uma consulta simples como os <code>SELECT * FROM products</code> faz seu trabalho, mas adivinhe?  Sim, esta √© uma opera√ß√£o de E / S de bloqueio.  <strong>O fluxo est√° aguardando</strong> . <img width="20" src="https://habrastorage.org/webt/bq/lm/cq/bqlmcq7ntk4kpr2gncodmxpqqee.png"></li><li>  Voc√™ recebeu uma matriz ou uma lista de todos os produtos, mas certifique-se de ter prometido tudo isso.  <strong>O fluxo est√° aguardando</strong> . <img width="20" src="https://habrastorage.org/webt/bq/lm/cq/bqlmcq7ntk4kpr2gncodmxpqqee.png"></li><li>  Agora voc√™ tem todos os produtos e √© hora de renderizar o modelo para a p√°gina futura, mas antes disso voc√™ precisa l√™-los.  <strong>O fluxo est√° aguardando</strong> . <img width="20" src="https://habrastorage.org/webt/bq/lm/cq/bqlmcq7ntk4kpr2gncodmxpqqee.png"></li><li>  O mecanismo de renderiza√ß√£o faz seu trabalho e envia uma resposta ao cliente.  <strong>O encadeamento est√° funcionando novamente</strong> . <img width="20" src="https://habrastorage.org/webt/o1/sw/x5/o1swx5v-gnn2ptqjjzonhq3oew0.png"></li><li>  O fluxo √© livre, como um p√°ssaro no c√©u. <img width="20" src="https://habrastorage.org/webt/wr/vg/0_/wrvg0_hul5qltn9qpyg9fv6beua.png"></li></ul><br><p>  Qu√£o lentas s√£o as opera√ß√µes de E / S?  Bem, isso depende do espec√≠fico.  Vamos olhar para a mesa: </p><br><div class="scrollable-table"><table><tbody><tr><th>  <b>Opera√ß√£o</b> </th><th>  <b>Ciclos de CPU</b> </th></tr><tr><td>  Registradores de CPU </td><td>  3 medidas </td></tr><tr><td>  Cache L1 </td><td>  8 medidas </td></tr><tr><td>  Cache L2 </td><td>  12 medidas </td></tr><tr><td>  RAM </td><td>  150 medidas </td></tr><tr><td>  Disco </td><td>  30.000.000 medidas </td></tr><tr><td>  Rede </td><td>  250.000.000 medidas </td></tr></tbody></table></div><br><p>  As opera√ß√µes de leitura de rede e disco s√£o muito lentas.  Imagine quantas solicita√ß√µes ou chamadas para APIs externas seu sistema poderia lidar durante esse per√≠odo. </p><br><p>  Para resumir: As opera√ß√µes de E / S fazem o encadeamento aguardar e desperdi√ßar recursos. </p><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/bg/qm/k1/bgqmk13cgzyfg7vmynzpkxdxbdc.gif"></div><br><a name="p2"></a><br><h3 id="problema-c10k">  Problema C10K </h3><br><p>  <strong>O problema</strong> </p><br><p>  <b>C10k</b> (eng. <i>C10k; conex√µes 10k</i> - problema com 10 mil conex√µes) </p><br><p>  No in√≠cio dos anos 2000, as m√°quinas servidor e cliente estavam lentas.  O problema surgiu ao processar 10.000 conex√µes de clientes com a mesma m√°quina em paralelo. </p><br><p>  Mas por que o modelo tradicional de thread por solicita√ß√£o (thread sob solicita√ß√£o) n√£o conseguiu resolver esse problema?  Bem, vamos usar um pouco de matem√°tica. </p><br><p>  A implementa√ß√£o nativa de encadeamentos aloca mais de 1 MB de mem√≥ria por fluxo, deixando isso - para 10 mil encadeamentos, s√£o necess√°rios 10 GB de RAM e isso √© apenas para a pilha de fluxos.  Sim, e n√£o se esque√ßa, estamos no in√≠cio dos anos 2000 !! </p><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/af/99/xc/af99xcxnykot0wq-zv20o-6cvps.jpeg"></div><br><p>  Hoje, os servidores e os computadores clientes trabalham com mais rapidez e efici√™ncia e quase qualquer linguagem ou estrutura de programa√ß√£o pode lidar com esse problema.  Mas, de fato, o problema n√£o est√° resolvido.  Para 10 milh√µes de conex√µes de clientes com uma m√°quina, o problema retorna novamente (mas agora √© o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">problema</a> do <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">C10M</a> ). </p><br><p>  <strong>Resgate de JavaScript?</strong> </p><br><p>  Spoilers de Cuidado <img width="70" src="https://habrastorage.org/webt/vl/iw/8n/vliw8nxrmg8paobiiyvuozjxpdc.png">  !!! <br>  O Node.js resolve o problema do C10K ... mas como ?! </p><br><p>  O JavaScript do lado do servidor n√£o era algo novo e incomum no in√≠cio dos anos 2000, naquela √©poca j√° havia implementa√ß√µes na JVM (m√°quina virtual java) - RingoJS e AppEngineJS, que trabalhavam no modelo de thread por solicita√ß√£o. </p><br><p>  Mas se eles n√£o conseguiram resolver o problema, como o Node.js ?!  Tudo porque o JavaScript √© <strong>de thread √∫nico</strong> . </p><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/lp/nx/vh/lpnxvhxjbmqmkzmblpqqmfcxq0s.gif"></div><br><a name="p3"></a><br><h3 id="nodejs-i-cikl-sobytiy">  Node.js e o loop de eventos </h3><br><p>  <strong>Node.js</strong> </p><br><p>  O Node.js √© uma plataforma de servidor executada no mecanismo do Google Chrome - V8, que pode compilar o c√≥digo JavaScript no c√≥digo da m√°quina. </p><br><p>  O Node.js usa um modelo <strong>orientado a eventos</strong> e uma arquitetura de <strong>E / S sem bloqueio</strong> , o que o torna leve e eficiente.  Isso n√£o √© uma estrutura, nem uma biblioteca, √© um tempo de execu√ß√£o JavaScript. </p><br><p>  Vamos escrever um pequeno exemplo: </p><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">// Importing native http module const http = require('http'); // Creating a server instance where every call // the message 'Hello World' is responded to the client const server = http.createServer(function(request, response) { response.write('Hello World'); response.end(); }); // Listening port 8080 server.listen(8080);</span></span></code> </pre> <br><p>  <strong>E / S sem bloqueio</strong> </p><br><p>  O Node.js usa opera√ß√µes de entrada / sa√≠da sem bloqueio, o que isso significa: </p><br><ul><li>  O encadeamento principal n√£o ser√° bloqueado pelas opera√ß√µes de E / S. </li><li>  O servidor continuar√° a atender solicita√ß√µes. </li><li>  Teremos que trabalhar com <strong>c√≥digo ass√≠ncrono</strong> . </li></ul><br><p>  Vamos escrever um exemplo no qual o servidor envia uma p√°gina HTML em resposta a uma solicita√ß√£o para <code>/home</code> e para todas as outras solicita√ß√µes - 'Hello World'.  Para enviar uma p√°gina HTML, voc√™ deve primeiro l√™-la em um arquivo. </p><br><p> <code>home.html</code> </p> <br><pre> <code class="html hljs xml"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">html</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">body</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">h1</span></span></span><span class="hljs-tag">&gt;</span></span>This is home page<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">h1</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">body</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">html</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br><p> <code>index.js</code> </p> <br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> http = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'http'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> fs = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'fs'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> server = http.createServer(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">request, response</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (request.url === <span class="hljs-string"><span class="hljs-string">'/home'</span></span>) { fs.readFile(<span class="hljs-string"><span class="hljs-string">`</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${ __dirname }</span></span></span><span class="hljs-string">/home.html`</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">err, content</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!err) { response.setHeader(<span class="hljs-string"><span class="hljs-string">'Content-Type'</span></span>, <span class="hljs-string"><span class="hljs-string">'text/html'</span></span>); response.write(content); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { response.statusCode = <span class="hljs-number"><span class="hljs-number">500</span></span>; response.write(<span class="hljs-string"><span class="hljs-string">'An error has ocurred'</span></span>); } response.end(); }); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { response.write(<span class="hljs-string"><span class="hljs-string">'Hello World'</span></span>); response.end(); } }); server.listen(<span class="hljs-number"><span class="hljs-number">8080</span></span>);</code> </pre> <br><p>  Se o URL solicitado for <code>/home</code> , o m√≥dulo <code>fs</code> nativo ser√° usado para ler o arquivo <code>home.html</code> . </p><br><p>  Fun√ß√µes que se enquadram em <code>http.createServer</code> e <code>fs.readFile</code> como argumentos s√£o <strong>retornos de chamada</strong> .  Essas fun√ß√µes ser√£o executadas em algum momento no futuro (a primeira assim que o servidor receber a solicita√ß√£o e a segunda quando o arquivo for lido do disco e colocado no buffer). </p><br><p>  Enquanto o arquivo est√° sendo lido do disco, o Node.js pode processar outras solicita√ß√µes e at√© mesmo ler o arquivo novamente e tudo isso em um fluxo ... mas como ?! </p><br><p>  <strong>Loop de eventos</strong> </p><br><p>  <strong>O loop de eventos</strong> √© a m√°gica que acontece dentro do Node.js.  Este √© literalmente um loop sem fim e, na verdade, um thread. </p><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/f_/sc/go/f_scgo68j5gpf0xsnzklzdr9cjc.jpeg"></div><br><p>  <strong>Libuv</strong> √© uma biblioteca C que implementa esse padr√£o e faz parte do kernel do Node.js.  Voc√™ pode aprender mais sobre o libuv <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">aqui</a> . </p><br><p>  Um ciclo de eventos possui 6 fases, cada execu√ß√£o de todas as 6 fases √© chamada de <strong>tick</strong> . </p><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/2k/xy/eq/2kxyeqk7srzdocs9egzl5zlpwhm.png"></div><br><ul><li>  <strong>timers</strong> : nesta fase, retornos de chamada agendados pelos m√©todos <code>setTimeout()</code> e <code>setInterval()</code> s√£o executados; </li><li>  <strong>retornos de chamada pendentes</strong> : quase todos os <strong>retornos de chamada</strong> s√£o executados, exceto eventos de <code>close</code> , temporizadores e <code>setImmediate()</code> ; </li><li>  <strong>ocioso, prepare</strong> : usado apenas para fins internos; </li><li>  <strong>sondagem</strong> : respons√°vel por receber novos eventos de E / S.  Node.js pode bloquear neste momento; </li><li>  <strong>check</strong> : retornos de chamada causados ‚Äã‚Äãpelo m√©todo <code>setImmediate()</code> s√£o executados neste est√°gio; </li><li>  <strong>fechar retornos de chamada</strong> : por exemplo <code>socket.on('close', ...)</code> ; </li></ul><br><p>  Bem, existe apenas um segmento, e esse segmento √© um loop de eventos, mas quem realiza toda a E / S? </p><br><p>  Preste aten√ß√£o <img width="60" src="https://habrastorage.org/webt/92/8i/lj/928iljyzpqhkbczypvvqgkx0zc0.png">  !!! <br>  Quando um loop de eventos precisa executar uma opera√ß√£o de E / S, ele usa o encadeamento do SO do conjunto de encadeamentos e, quando a tarefa √© conclu√≠da, o retorno de chamada √© enfileirado durante a fase de <em>retorno de chamada pendente</em> . </p><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/lz/z7/uw/lzz7uwcdvm1xd1yr6utj7cae36g.png"></div><br><p>  Isso n√£o √© legal? </p><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/it/yo/bh/ityobhc10qgnkk5m9yk5xp94ble.gif"></div><br><a name="p4"></a><br><h3 id="problema-cpu-yomkih-zadach">  O problema das tarefas que consomem muita CPU </h3><br><p>  O Node.js parece perfeito!  Voc√™ pode criar o que quiser. </p><br><p>  Vamos escrever uma API para calcular n√∫meros primos. </p><br><p>  Um n√∫mero primo √© um n√∫mero inteiro (natural) maior que um e divis√≠vel por apenas 1 e por si s√≥. </p><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/nl/kn/7f/nlkn7fwr_kxhtktm-_gt0ci7ask.jpeg"></div><br><p>  Dado um n√∫mero N, a API deve calcular e retornar os primeiros N primos na lista (ou matriz). </p><br><p> <code>primes.js</code> </p> <br><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">isPrime</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">n</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">let</span></span> i = <span class="hljs-number"><span class="hljs-number">2</span></span>, s = <span class="hljs-built_in"><span class="hljs-built_in">Math</span></span>.sqrt(n); i &lt;= s; i++) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(n % i === <span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> n &gt; <span class="hljs-number"><span class="hljs-number">1</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">nthPrime</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">n</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> counter = n; <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> iterator = <span class="hljs-number"><span class="hljs-number">2</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> result = []; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span>(counter &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) { isPrime(iterator) &amp;&amp; result.push(iterator) &amp;&amp; counter--; iterator++; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> result; } <span class="hljs-built_in"><span class="hljs-built_in">module</span></span>.exports = { isPrime, nthPrime };</code> </pre> <br><p> <code>index.js</code> </p> <br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> http = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'http'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> url = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'url'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> primes = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'./primes'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> server = http.createServer(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">request, response</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> { pathname, query } = url.parse(request.url, <span class="hljs-literal"><span class="hljs-literal">true</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (pathname === <span class="hljs-string"><span class="hljs-string">'/primes'</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> result = primes.nthPrime(query.n || <span class="hljs-number"><span class="hljs-number">0</span></span>); response.setHeader(<span class="hljs-string"><span class="hljs-string">'Content-Type'</span></span>, <span class="hljs-string"><span class="hljs-string">'application/json'</span></span>); response.write(<span class="hljs-built_in"><span class="hljs-built_in">JSON</span></span>.stringify(result)); response.end(); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { response.statusCode = <span class="hljs-number"><span class="hljs-number">404</span></span>; response.write(<span class="hljs-string"><span class="hljs-string">'Not Found'</span></span>); response.end(); } }); server.listen(<span class="hljs-number"><span class="hljs-number">8080</span></span>);</code> </pre> <br><p>  <code>prime.js</code> √© a implementa√ß√£o dos c√°lculos necess√°rios: a fun√ß√£o <code>isPrime</code> verifica se o n√∫mero √© primo e nthPrime retorna N tais n√∫meros. </p><br><p>  O arquivo <code>index.js</code> √© respons√°vel por criar o servidor e usa o m√≥dulo <code>prime.js</code> para processar cada solicita√ß√£o para <code>/primes</code> .  O n√∫mero N √© lan√ßado atrav√©s da string de consulta no URL. </p><br><p>  Para obter os 20 primeiros n√∫meros primos, precisamos fazer uma solicita√ß√£o para <code>http://localhost:8080/primes?n=20</code> . </p><br><p>  Suponha que tenhamos 3 clientes nos bloqueando e tentando acessar nossa API de E / S sem bloqueio: </p><br><ul><li>  A primeira consulta 5 inicia a cada segundo. </li><li>  O segundo pede 1000 n√∫meros primos a cada segundo </li><li>  O terceiro solicita 10.000.000.000 de n√∫meros primos, mas ... </li></ul><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/pz/rx/bl/pzrxblziplf06w7-kzbyojhafhg.gif"></div><br><p>  Quando o terceiro cliente envia uma solicita√ß√£o, o encadeamento principal √© bloqueado e esse √© o principal sintoma do problema de <strong>tarefas com uso intenso</strong> de <strong>CPU</strong> .  Quando o thread principal est√° ocupado executando uma tarefa "pesada", fica inacess√≠vel para outras tarefas. </p><br><p>  Mas e o libuv?  Se voc√™ se lembra, essa biblioteca ajuda o Node.js. a executar opera√ß√µes de entrada / sa√≠da usando threads do sistema operacional, evitando o bloqueio do thread principal e voc√™ est√° absolutamente certo, esta √© a solu√ß√£o para o nosso problema, mas para que isso seja poss√≠vel, nosso m√≥dulo deve ser escrito no idioma C ++ para que o libuv possa trabalhar com ele. </p><br><p>  Felizmente, a partir da v10.5, o m√≥dulo Native <strong>Threads do Trabalhador</strong> foi adicionado ao Node.js. </p><br><a name="p5"></a><br><h3 id="vorkery-i-ih-potoki">  Trabalhadores e seus fluxos </h3><br><p>  Como a <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">documenta√ß√£o</a> nos diz: </p><br><blockquote>  Os trabalhadores s√£o √∫teis para executar opera√ß√µes JavaScript com uso intenso de CPU;  n√£o os use para opera√ß√µes de entrada / sa√≠da; os mecanismos j√° incorporados ao Node.js s√£o mais eficientes no manuseio dessas tarefas do que o encadeamento Worker. </blockquote><p>  <strong>Corre√ß√£o de c√≥digo</strong> </p><br><p>  √â hora de reescrever nosso c√≥digo: </p><br><p> <code>primes-workerthreads.js</code> </p> <br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> { workerData, parentPort } = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'worker_threads'</span></span>); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">isPrime</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">n</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">let</span></span> i = <span class="hljs-number"><span class="hljs-number">2</span></span>, s = <span class="hljs-built_in"><span class="hljs-built_in">Math</span></span>.sqrt(n); i &lt;= s; i++) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(n % i === <span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> n &gt; <span class="hljs-number"><span class="hljs-number">1</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">nthPrime</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">n</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> counter = n; <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> iterator = <span class="hljs-number"><span class="hljs-number">2</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> result = []; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span>(counter &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) { isPrime(iterator) &amp;&amp; result.push(iterator) &amp;&amp; counter--; iterator++; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> result; } parentPort.postMessage(nthPrime(workerData.n));</code> </pre> <br><p> <code>index-workerthreads.js</code> </p> <br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> http = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'http'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> url = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'url'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> { Worker } = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'worker_threads'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> server = http.createServer(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">request, response</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> { pathname, query } = url.parse(request.url, <span class="hljs-literal"><span class="hljs-literal">true</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (pathname === <span class="hljs-string"><span class="hljs-string">'/primes'</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> worker = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Worker(<span class="hljs-string"><span class="hljs-string">'./primes-workerthreads.js'</span></span>, { <span class="hljs-attr"><span class="hljs-attr">workerData</span></span>: { <span class="hljs-attr"><span class="hljs-attr">n</span></span>: query.n || <span class="hljs-number"><span class="hljs-number">0</span></span> } }); worker.on(<span class="hljs-string"><span class="hljs-string">'error'</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ response.statusCode = <span class="hljs-number"><span class="hljs-number">500</span></span>; response.write(<span class="hljs-string"><span class="hljs-string">'Oops there was an error...'</span></span>); response.end(); }); <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> result; worker.on(<span class="hljs-string"><span class="hljs-string">'message'</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">message</span></span></span><span class="hljs-function">) </span></span>{ result = message; }); worker.on(<span class="hljs-string"><span class="hljs-string">'exit'</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ response.setHeader(<span class="hljs-string"><span class="hljs-string">'Content-Type'</span></span>, <span class="hljs-string"><span class="hljs-string">'application/json'</span></span>); response.write(<span class="hljs-built_in"><span class="hljs-built_in">JSON</span></span>.stringify(result)); response.end(); }); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { response.statusCode = <span class="hljs-number"><span class="hljs-number">404</span></span>; response.write(<span class="hljs-string"><span class="hljs-string">'Not Found'</span></span>); response.end(); } }); server.listen(<span class="hljs-number"><span class="hljs-number">8080</span></span>);</code> </pre> <br><p>  No <code>index-workerthreads.js</code> , cada solicita√ß√£o para <code>/primes</code> cria uma inst√¢ncia da classe <code>Worker</code> (do m√≥dulo nativo <code>worker_threads</code> ) para fazer upload e executar o <code>primes-workerthreads.js</code> no encadeamento do trabalhador.  Quando a lista de n√∫meros primos √© calculada e pronta, o evento da <code>message</code> √© acionado - o resultado cai no fluxo principal devido ao trabalho que ainda n√£o tem trabalho, ele tamb√©m aciona o evento de <code>exit</code> , permitindo que o fluxo principal envie dados ao cliente. </p><br><p>  <code>primes-workerthreads.js</code> mudou um pouco.  Ele importa <code>workerData</code> (esta √© uma c√≥pia dos par√¢metros passados ‚Äã‚Äãdo encadeamento principal) e <code>parentPort</code> atrav√©s dos quais o resultado do trabalho do trabalhador √© passado de volta para o encadeamento principal. </p><br><p>  Agora vamos tentar nosso exemplo novamente e ver o que acontece: </p><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/zu/vk/gh/zuvkghy8dnhjryfdf5b62ped8dw.gif"></div><br><p>  O encadeamento principal n√£o est√° mais bloqueado <img width="115" src="https://habrastorage.org/webt/nn/hs/r3/nnhsr3jiw_4aed53jye8gokutpy.png">  !!!!! </p><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/tt/ij/el/ttijelgt36k_vbengx3qjaaajlc.gif"></div><br><p>  Agora tudo funciona como deveria, mas produzir trabalhadores sem motivo ainda n√£o √© uma boa pr√°tica; criar threads n√£o √© um prazer barato.  Certifique-se de criar um pool de threads antes disso. </p><br><h4 id="zaklyuchenie">  Conclus√£o </h4><br><p>  O Node.js √© uma tecnologia poderosa que deve ser explorada sempre que poss√≠vel. <br>  Minha recomenda√ß√£o pessoal - sempre seja curioso!  Se voc√™ souber como algo funciona por dentro, pode trabalhar com ele de forma mais eficiente. </p><br><p>  Isso √© tudo por hoje pessoal.  Espero que este post tenha sido √∫til para voc√™ e que voc√™ aprendeu algo novo sobre o Node.js. </p><br><p>  Obrigado pela leitura e at√© a pr√≥xima postagem. <img width="20" src="https://habrastorage.org/webt/bd/lk/kd/bdlkkdf7adtljydvhxyw22y3cfi.png">  . </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt460661/">https://habr.com/ru/post/pt460661/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt460645/index.html">Fazendo o bem fazendo o mal: escrevendo c√≥digo mal com Go, Parte 1</a></li>
<li><a href="../pt460647/index.html">Solu√ß√£o de um trabalho com pwnable.kr 05 - c√≥digo de acesso. Reescreva a tabela de links de procedimentos atrav√©s da vulnerabilidade de cadeia de formato</a></li>
<li><a href="../pt460651/index.html">Reuni√£o da Sociedade de Testadores An√¥nimos: TMS, monitoramento, monitoramento, avalia√ß√£o da qualidade da pesquisa e testes iOS nativos</a></li>
<li><a href="../pt460655/index.html">Como quebrei o Telegram</a></li>
<li><a href="../pt460659/index.html">Usando Tubos para Giro</a></li>
<li><a href="../pt460665/index.html">Rascunho de FAQ: Por que os padr√µes C ++ s√£o lan√ßados a cada tr√™s anos?</a></li>
<li><a href="../pt460667/index.html">Automa√ß√£o de teste de servi√ßos pagos no iOS</a></li>
<li><a href="../pt460669/index.html">Como garantir a seguran√ßa do desenvolvimento, economizando tempo e nervosismo</a></li>
<li><a href="../pt460671/index.html">Propriedade e empr√©stimos em D</a></li>
<li><a href="../pt460673/index.html">Expor a magia do DiffUtil</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>