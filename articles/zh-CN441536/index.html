<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ğŸ§“ğŸ» ğŸ¤ğŸ¼ ğŸ¦ å„ç§SIMD ğŸ”¼ ğŸ³ ğŸ˜§</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="åœ¨å¼€å‘meshoptimizerçš„è¿‡ç¨‹ä¸­ ï¼Œç»å¸¸ä¼šå‡ºç°ä»¥ä¸‹é—®é¢˜ï¼šâ€œè¯¥ç®—æ³•å¯ä»¥ä½¿ç”¨SIMDå—ï¼Ÿâ€ 

 è¯¥åº“ä»¥æ€§èƒ½ä¸ºå¯¼å‘ï¼Œä½†æ˜¯SIMDå¹¶ä¸æ€»æ˜¯æä¾›æ˜æ˜¾çš„é€Ÿåº¦ä¼˜åŠ¿ã€‚ ä¸å¹¸çš„æ˜¯ï¼ŒSIMDä¼šä½¿ä»£ç çš„å¯ç§»æ¤æ€§å’Œå¯ç»´æŠ¤æ€§é™ä½ã€‚ å› æ­¤ï¼Œåœ¨æ¯ç§æƒ…å†µä¸‹ï¼Œéƒ½å¿…é¡»å¯»æ±‚æŠ˜è¡·æ–¹æ¡ˆã€‚ å½“æ€§èƒ½è‡³å…³é‡è¦æ—¶ï¼Œæ‚¨å¿…é¡»ä¸ºSSEå’ŒNEON...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>å„ç§SIMD</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/441536/"><img src="https://habrastorage.org/getpro/habr/post_images/a9d/05e/c84/a9d05ec8466285f12b0a33e5978a0c00.png" align="left" width="270"> åœ¨å¼€å‘<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">meshoptimizerçš„è¿‡ç¨‹ä¸­</a> ï¼Œç»å¸¸ä¼šå‡ºç°ä»¥ä¸‹é—®é¢˜ï¼šâ€œè¯¥ç®—æ³•å¯ä»¥ä½¿ç”¨SIMDå—ï¼Ÿâ€ <br><br> è¯¥åº“ä»¥æ€§èƒ½ä¸ºå¯¼å‘ï¼Œä½†æ˜¯SIMDå¹¶ä¸æ€»æ˜¯æä¾›æ˜æ˜¾çš„é€Ÿåº¦ä¼˜åŠ¿ã€‚ ä¸å¹¸çš„æ˜¯ï¼ŒSIMDä¼šä½¿ä»£ç çš„å¯ç§»æ¤æ€§å’Œå¯ç»´æŠ¤æ€§é™ä½ã€‚ å› æ­¤ï¼Œåœ¨æ¯ç§æƒ…å†µä¸‹ï¼Œéƒ½å¿…é¡»å¯»æ±‚æŠ˜è¡·æ–¹æ¡ˆã€‚ å½“æ€§èƒ½è‡³å…³é‡è¦æ—¶ï¼Œæ‚¨å¿…é¡»ä¸ºSSEå’ŒNEONæŒ‡ä»¤é›†å¼€å‘å’Œç»´æŠ¤å•ç‹¬çš„SIMDå®ç°ã€‚ åœ¨å…¶ä»–æƒ…å†µä¸‹ï¼Œæ‚¨éœ€è¦äº†è§£ä½¿ç”¨SIMDçš„æ•ˆæœã€‚ ä»Šå¤©ï¼Œæˆ‘ä»¬å°†å°è¯•ä½¿ç”¨SSEn / AVXnæŒ‡ä»¤é›†æ¥åŠ é€Ÿæœ€è¿‘è¢«æ·»åŠ åˆ°åº“ä¸­çš„æ–°ç½‘æ ¼ç®€åŒ–ç®—æ³•ã€‚ <br><a name="habracut"></a><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/068/8c9/887/0688c9887f9cb61c268383cb4b6621b7.jpg"></div><br><br> å¯¹äºæˆ‘ä»¬çš„åŸºå‡†ï¼Œæˆ‘ä»¬å°†æ³°å›½ä½›é™€æ¨¡å‹ä»600ä¸‡ä¸ªä¸‰è§’å½¢ç®€åŒ–ä¸ºè¯¥æ•°å­—çš„0.1ï¼…ã€‚ æˆ‘ä»¬å°†Microsoft Visual Studio 2019ç¼–è¯‘å™¨ç”¨äºç›®æ ‡x64ä½“ç³»ç»“æ„ã€‚ æ ‡é‡ç®—æ³•å¯ä»¥åœ¨å•ä¸ªIntel Core i7-8700Kçº¿ç¨‹ï¼ˆçº¦4.4 GHzï¼‰ä¸­åœ¨çº¦210 mså†…æ‰§è¡Œè¿™ç§åˆç†åŒ–ã€‚ è¿™ç›¸å½“äºæ¯ç§’çº¦2850ä¸‡ä¸ªä¸‰è§’å½¢ã€‚ åœ¨å®è·µä¸­ä¹Ÿè®¸è¿™è¶³å¤Ÿäº†ï¼Œä½†æ˜¯æˆ‘å¾ˆå¥½å¥‡åœ°æ¢ç´¢äº†è®¾å¤‡çš„æœ€å¤§åŠŸèƒ½ã€‚ <br><br> åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œå¯ä»¥é€šè¿‡å°†ç½‘æ ¼åˆ’åˆ†ä¸ºå¤šä¸ªéƒ¨åˆ†æ¥å¹¶è¡ŒåŒ–æ­¤è¿‡ç¨‹ï¼Œä½†æ˜¯ä¸ºæ­¤ï¼Œæœ‰å¿…è¦è¿›è¡Œè¿é€šæ€§çš„å…¶ä»–åˆ†æä»¥ä¿æŒè¾¹ç•Œï¼Œå› æ­¤ï¼Œç°åœ¨æˆ‘ä»¬å°†ä»…é™äºSIMDä¼˜åŒ–ã€‚ <br><br><h1> ä¸ƒæ¬¡æµ‹é‡ </h1><br> ä¸ºäº†äº†è§£ä¼˜åŒ–çš„å¯èƒ½æ€§ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨è‹±ç‰¹å°”VTuneæ‰§è¡Œæ€§èƒ½åˆ†æã€‚ è¿è¡Œè¯¥è¿‡ç¨‹100æ¬¡ä»¥ç¡®ä¿æœ‰è¶³å¤Ÿçš„æ•°æ®ã€‚ <br><br><img src="https://habrastorage.org/getpro/habr/post_images/1a7/6f0/cea/1a76f0ceaf9dc88617c5296d6ee73467.png"><br><br> åœ¨è¿™é‡Œï¼Œæˆ‘æ‰“å¼€äº†å¾®ä½“ç³»ç»“æ„æ¨¡å¼ï¼Œä»¥å›ºå®šæ¯ä¸ªåŠŸèƒ½çš„æ‰§è¡Œæ—¶é—´ï¼Œå¹¶æŸ¥æ‰¾ç“¶é¢ˆã€‚ æˆ‘ä»¬çœ‹åˆ°åˆç†åŒ–æ˜¯ä½¿ç”¨ä¸€ç»„å‡½æ•°æ‰§è¡Œçš„ï¼Œæ¯ä¸ªå‡½æ•°éƒ½éœ€è¦ä¸€å®šæ•°é‡çš„å¾ªç¯ã€‚ åŠŸèƒ½åˆ—è¡¨æŒ‰æ—¶é—´æ’åºã€‚ è¿™é‡ŒæŒ‰æ‰§è¡Œé¡ºåºæ’åˆ—ï¼Œä½¿ç®—æ³•æ›´æ˜“äºç†è§£ï¼š <br><br><ul><li> <code>rescalePositions</code>å°†æ‰€æœ‰é¡¶ç‚¹çš„ä½ç½®å½’ä¸€åŒ–ä¸ºå•ä¸ªå¤šç»´æ•°æ®é›†ï¼Œä»¥å‡†å¤‡ä½¿ç”¨<code>computeVertexIds</code>è¿›è¡Œé‡åŒ– </li><li>  <code>computeVertexIds</code>ä¸ºç»™å®šå¤§å°çš„ç»Ÿä¸€ç½‘æ ¼ä¸Šçš„æ¯ä¸ªé¡¶ç‚¹è®¡ç®—ä¸€ä¸ª30ä½é‡åŒ–æ ‡è¯†ç¬¦ï¼Œå…¶ä¸­æ¯ä¸ªè½´åœ¨ç½‘æ ¼ä¸Šè¿›è¡Œé‡åŒ–ï¼ˆç½‘æ ¼å¤§å°ä¸º10ä½ï¼Œå› æ­¤æ ‡è¯†ç¬¦ä¸º30ï¼‰ </li><li> å‡è®¾ä¸€ä¸ªç½‘æ ¼å•å…ƒä¸­æ‰€æœ‰é¡¶ç‚¹çš„å¹¶é›†ï¼Œ <code>countTriangles</code>è®¡ç®—åˆ›æ–°è€…å°†ä¸ºç»™å®šç½‘æ ¼å¤§å°åˆ›å»ºçš„è¿‘ä¼¼ä¸‰è§’å½¢æ•° </li><li>  <code>fillVertexCells</code>å¡«å……ä¸€ä¸ªè¡¨ï¼Œè¯¥è¡¨<code>fillVertexCells</code>æ‰€æœ‰é¡¶ç‚¹<code>fillVertexCells</code>åˆ°ç›¸åº”çš„å•å…ƒæ ¼ï¼› å…·æœ‰ç›¸åŒIDçš„æ‰€æœ‰é¡¶ç‚¹å¯¹åº”äºä¸€ä¸ªåƒå…ƒ </li><li>  <code>fillCellQuadrics</code>ä¸ºæ¯ä¸ªåƒå…ƒå¡«å……<code>fillCellQuadrics</code>ç»“æ„ï¼ˆ <code>Quadric</code>å¯¹ç§°çŸ©é˜µï¼‰ï¼Œä»¥åæ˜ æœ‰å…³ç›¸åº”å‡ ä½•çš„èšåˆä¿¡æ¯ </li><li>  <code>fillCellRemap</code>è®¡ç®—æ¯ä¸ªåƒå…ƒçš„é¡¶ç‚¹ç´¢å¼•ï¼Œé€‰æ‹©è¯¥åƒå…ƒä¸­çš„ä¸€ä¸ªé¡¶ç‚¹ï¼Œå¹¶ä½¿å‡ ä½•å˜å½¢æœ€å°åŒ– </li><li>  <code>filterTriangles</code>æ ¹æ®å…ˆå‰æ„é€ çš„vertex-cell-vertexè¡¨æ˜¾ç¤ºæœ€ç»ˆçš„ä¸‰è§’å½¢é›†ï¼› å¹¼ç¨šçš„å¹³ç§»å¯ä»¥å¹³å‡äº§ç”Ÿçº¦5ï¼…çš„é‡å¤ä¸‰è§’å½¢ï¼Œå› æ­¤è¯¥å‡½æ•°å¯ä»¥è¿‡æ»¤é‡å¤çš„ä¸‰è§’å½¢ã€‚ </li></ul><br>  <code>computeVertexIds</code>å’Œ<code>countTriangles</code>æ‰§è¡Œå¤šæ¬¡ï¼šè¯¥ç®—æ³•ç¡®å®šç”¨äºåˆå¹¶é¡¶ç‚¹çš„ç½‘æ ¼å¤§å°ï¼Œæ‰§è¡ŒåŠ é€Ÿçš„äºŒè¿›åˆ¶æœç´¢ä»¥è¾¾åˆ°ç›®æ ‡ä¸‰è§’å½¢æ•°é‡ï¼ˆåœ¨æˆ‘ä»¬çš„ç¤ºä¾‹ä¸­ä¸º6000ï¼‰ï¼Œå¹¶è®¡ç®—æ¯ç§ç½‘æ ¼å¤§å°åœ¨æ¯æ¬¡è¿­ä»£æ—¶ç”Ÿæˆçš„ä¸‰è§’å½¢æ•°é‡ã€‚ å…¶ä»–åŠŸèƒ½ä¸€æ¬¡å¯åŠ¨ã€‚ åœ¨æˆ‘ä»¬çš„æ–‡ä»¶ä¸­ï¼Œäº”æ¬¡æœç´¢é€šè¿‡ç»™å‡ºäº†40 <sup>3</sup>çš„ç›®æ ‡ç½‘æ ¼å¤§å°ã€‚ <br><br>  VTuneæœ‰ç”¨åœ°æŠ¥å‘Šè¯´ï¼Œæœ€è€—èµ„æºçš„å‡½æ•°æ˜¯è®¡ç®—äºŒæ¬¡å‡½æ•°çš„å‡½æ•°ï¼šå®ƒå‡ ä¹èŠ±è´¹äº†21 sçš„æ€»æ‰§è¡Œæ—¶é—´çš„ä¸€åŠã€‚ è¿™æ˜¯ä¼˜åŒ–SIMDçš„é¦–è¦ç›®æ ‡ã€‚ <br><br><h1> ä¸€å¼ ä¸€å¼  </h1><br> è®©æˆ‘ä»¬çœ‹ä¸€ä¸‹<code>fillCellQuadrics</code>çš„æºä»£ç ï¼Œä»¥æ›´å¥½åœ°äº†è§£å®ƒçš„ç¡®åˆ‡è®¡ç®—ç»“æœï¼š <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">fillCellQuadrics</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Quadric* cell_quadrics, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">unsigned</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params">* indices, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">size_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> index_count, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> Vector3* vertex_positions, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">unsigned</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params">* vertex_cells)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">size_t</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; index_count; i += <span class="hljs-number"><span class="hljs-number">3</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i0 = indices[i + <span class="hljs-number"><span class="hljs-number">0</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i1 = indices[i + <span class="hljs-number"><span class="hljs-number">1</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i2 = indices[i + <span class="hljs-number"><span class="hljs-number">2</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> c0 = vertex_cells[i0]; <span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> c1 = vertex_cells[i1]; <span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> c2 = vertex_cells[i2]; <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> single_cell = (c0 == c1) &amp; (c0 == c2); <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> weight = single_cell ? <span class="hljs-number"><span class="hljs-number">3.f</span></span> : <span class="hljs-number"><span class="hljs-number">1.f</span></span>; Quadric Q; quadricFromTriangle(Q, vertex_positions[i0], vertex_positions[i1], vertex_positions[i2], weight); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (single_cell) { quadricAdd(cell_quadrics[c0], Q); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { quadricAdd(cell_quadrics[c0], Q); quadricAdd(cell_quadrics[c1], Q); quadricAdd(cell_quadrics[c2], Q); } } }</code> </pre> <br> è¯¥å‡½æ•°éå†æ‰€æœ‰ä¸‰è§’å½¢ï¼Œä¸ºæ¯ä¸ªä¸‰è§’å½¢è®¡ç®—ä¸€ä¸ªäºŒæ¬¡æ›²é¢ï¼Œå¹¶å°†å…¶æ·»åŠ åˆ°æ¯ä¸ªå•å…ƒçš„äºŒæ¬¡æ›²é¢ã€‚ äºŒæ¬¡æ›²é¢-ä¸€ä¸ª4Ã—4å¯¹ç§°çŸ©é˜µï¼Œè¡¨ç¤ºä¸º10ä¸ªæµ®ç‚¹æ•°ï¼š <br><br><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Quadric</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> a00; <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> a10, a11; <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> a20, a21, a22; <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> b0, b1, b2, c; };</code> </pre> <br> äºŒæ¬¡æ›²é¢çš„è®¡ç®—éœ€è¦æ±‚è§£ä¸‰è§’å½¢çš„å¹³é¢æ–¹ç¨‹ï¼Œæ„é€ äºŒæ¬¡çŸ©é˜µï¼Œå¹¶ä½¿ç”¨ä¸‰è§’å½¢çš„é¢ç§¯å¯¹å…¶è¿›è¡ŒåŠ æƒï¼š <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">quadricFromPlane</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Quadric&amp; Q, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params"> a, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params"> b, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params"> c, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params"> d)</span></span></span><span class="hljs-function"> </span></span>{ Q.a00 = a * a; Q.a10 = b * a; Q.a11 = b * b; Q.a20 = c * a; Q.a21 = c * b; Q.a22 = c * c; Q.b0 = d * a; Q.b1 = d * b; Q.b2 = d * c; Qc = d * d; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">quadricFromTriangle</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Quadric&amp; Q, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> Vector3&amp; p0, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> Vector3&amp; p1, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> Vector3&amp; p2, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params"> weight)</span></span></span><span class="hljs-function"> </span></span>{ Vector3 p10 = {p1.x - p0.x, p1.y - p0.y, p1.z - p0.z}; Vector3 p20 = {p2.x - p0.x, p2.y - p0.y, p2.z - p0.z}; Vector3 normal = { p10.y * p20.z - p10.z * p20.y, p10.z * p20.x - p10.x * p20.z, p10.x * p20.y - p10.y * p20.x }; <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> area = normalize(normal); <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> distance = normal.x*p0.x + normal.y*p0.y + normal.z*p0.z; quadricFromPlane(Q, normal.x, normal.y, normal.z, -distance); quadricMul(Q, area * weight); }</code> </pre> <br> çœ‹èµ·æ¥æœ‰å¾ˆå¤šæµ®ç‚¹è¿ç®—ï¼Œå› æ­¤å¯ä»¥ä½¿ç”¨SIMDå¯¹å…¶è¿›è¡Œå¹¶è¡ŒåŒ–ã€‚ é¦–å…ˆï¼Œæˆ‘ä»¬å°†æ¯ä¸ªå‘é‡è¡¨ç¤ºä¸º4å®½åº¦çš„SIMDå‘é‡ï¼Œè¿˜å°†<code>Quadric</code>ç»“æ„æ›´æ”¹ä¸º12ä¸ªæµ®ç‚¹æ•°ï¼Œè€Œä¸æ˜¯10ä¸ªæµ®ç‚¹æ•°ï¼Œä»¥ä¾¿å®ƒæ°å¥½é€‚åˆä¸‰ä¸ªSIMDå¯„å­˜å™¨ï¼ˆå¢åŠ å¤§å°ä¸ä¼šå½±å“æ€§èƒ½ï¼‰ï¼Œå¹¶æ›´æ”¹å­—æ®µçš„é¡ºåºï¼Œä»¥ä¾¿è¿›è¡Œè®¡ç®—<code>quadricFromPlane</code>å˜å¾—æ›´åŠ ç»Ÿä¸€ï¼š <br><br><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Quadric</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> a00, a11, a22; <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> pad0; <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> a10, a21, a20; <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> pad1; <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> b0, b1, b2, c; };</code> </pre> <br> åœ¨è¿™é‡Œï¼Œä¸€äº›è®¡ç®—ï¼Œå°¤å…¶æ˜¯æ ‡é‡ç§¯ï¼Œä¸ä¸Šè¯æ‰€çš„æ—©æœŸç‰ˆæœ¬ä¸å¤ªä¸€è‡´ã€‚ å¹¸è¿çš„æ˜¯ï¼ŒSSE4.1ä¸­å‡ºç°äº†æ ‡é‡äº§å“çš„è¯´æ˜ï¼Œè¿™å¯¹æˆ‘ä»¬éå¸¸æœ‰ç”¨ã€‚ <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">fillCellQuadrics</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Quadric* cell_quadrics, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">unsigned</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params">* indices, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">size_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> index_count, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> Vector3* vertex_positions, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">unsigned</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params">* vertex_cells)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> yzx = _MM_SHUFFLE(<span class="hljs-number"><span class="hljs-number">3</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> zxy = _MM_SHUFFLE(<span class="hljs-number"><span class="hljs-number">3</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> dp_xyz = <span class="hljs-number"><span class="hljs-number">0x7f</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">size_t</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; index_count; i += <span class="hljs-number"><span class="hljs-number">3</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i0 = indices[i + <span class="hljs-number"><span class="hljs-number">0</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i1 = indices[i + <span class="hljs-number"><span class="hljs-number">1</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i2 = indices[i + <span class="hljs-number"><span class="hljs-number">2</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> c0 = vertex_cells[i0]; <span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> c1 = vertex_cells[i1]; <span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> c2 = vertex_cells[i2]; <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> single_cell = (c0 == c1) &amp; (c0 == c2); __m128 p0 = _mm_loadu_ps(&amp;vertex_positions[i0].x); __m128 p1 = _mm_loadu_ps(&amp;vertex_positions[i1].x); __m128 p2 = _mm_loadu_ps(&amp;vertex_positions[i2].x); __m128 p10 = _mm_sub_ps(p1, p0); __m128 p20 = _mm_sub_ps(p2, p0); __m128 normal = _mm_sub_ps( _mm_mul_ps( _mm_shuffle_ps(p10, p10, yzx), _mm_shuffle_ps(p20, p20, zxy)), _mm_mul_ps( _mm_shuffle_ps(p10, p10, zxy), _mm_shuffle_ps(p20, p20, yzx))); __m128 areasq = _mm_dp_ps(normal, normal, dp_xyz); <span class="hljs-comment"><span class="hljs-comment">// SSE4.1 __m128 area = _mm_sqrt_ps(areasq); // masks the result of the division when area==0 // scalar version does this in normalize() normal = _mm_and_ps( _mm_div_ps(normal, area), _mm_cmpneq_ps(area, _mm_setzero_ps())); __m128 distance = _mm_dp_ps(normal, p0, dp_xyz); // SSE4.1 __m128 negdistance = _mm_sub_ps(_mm_setzero_ps(), distance); __m128 normalnegdist = _mm_blend_ps(normal, negdistance, 8); __m128 Qx = _mm_mul_ps(normal, normal); __m128 Qy = _mm_mul_ps( _mm_shuffle_ps(normal, normal, _MM_SHUFFLE(3, 2, 2, 1)), _mm_shuffle_ps(normal, normal, _MM_SHUFFLE(3, 0, 1, 0))); __m128 Qz = _mm_mul_ps(negdistance, normalnegdist); if (single_cell) { area = _mm_mul_ps(area, _mm_set1_ps(3.f)); Qx = _mm_mul_ps(Qx, area); Qy = _mm_mul_ps(Qy, area); Qz = _mm_mul_ps(Qz, area); Quadric&amp; q0 = cell_quadrics[c0]; __m128 q0x = _mm_loadu_ps(&amp;q0.a00); __m128 q0y = _mm_loadu_ps(&amp;q0.a10); __m128 q0z = _mm_loadu_ps(&amp;q0.b0); _mm_storeu_ps(&amp;q0.a00, _mm_add_ps(q0x, Qx)); _mm_storeu_ps(&amp;q0.a10, _mm_add_ps(q0y, Qy)); _mm_storeu_ps(&amp;q0.b0, _mm_add_ps(q0z, Qz)); } else { // omitted for brevity, repeats the if() body // three times for c0/c1/c2 } } }</span></span></code> </pre> <br> è¿™æ®µä»£ç æ²¡æœ‰ä»€ä¹ˆç‰¹åˆ«æœ‰è¶£çš„ã€‚ æˆ‘ä»¬å¤§é‡ä½¿ç”¨æœªå¯¹é½çš„åŠ è½½/å­˜å‚¨æŒ‡ä»¤ã€‚ å°½ç®¡Vector3çš„è¾“å…¥å¯ä»¥å¯¹é½ï¼Œä½†å¯¹äºæœªå¯¹é½çš„è¯»å–ä¼¼ä¹æ²¡æœ‰æ˜æ˜¾çš„æŸå¤±ã€‚ è¯·æ³¨æ„ï¼Œåœ¨å‡½æ•°çš„å‰åŠéƒ¨åˆ†ä¸ä½¿ç”¨å‘é‡ï¼Œè¿™å¾ˆå¥½-æˆ‘ä»¬çš„å‘é‡å…·æœ‰ä¸‰ä¸ªåˆ†é‡ï¼Œåœ¨æŸäº›æƒ…å†µä¸‹åªæœ‰ä¸€ä¸ªåˆ†é‡ï¼ˆè¯·å‚é˜…areaq / area / distanceçš„è®¡ç®—ï¼‰ï¼Œè€Œå¤„ç†å™¨å¹¶è¡Œæ‰§è¡Œ4ä¸ªè¿ç®—ã€‚ æ— è®ºå¦‚ä½•ï¼Œè®©æˆ‘ä»¬çœ‹çœ‹å¹¶è¡ŒåŒ–æ˜¯å¦‚ä½•å¸®åŠ©çš„ã€‚ <br><br><img src="https://habrastorage.org/getpro/habr/post_images/193/b7c/4a0/193b7c4a0e52429831e1d6feb7999c6f.png"><br><br> ç°åœ¨ï¼Œä¸€ç™¾ä¸ª<code>fillCellQuadrics</code>å¼€å§‹æ—¶é—´æ˜¯5.3 sï¼ˆè€Œä¸æ˜¯9.8 sï¼‰ï¼Œè¿™åœ¨æ¯æ¬¡æ“ä½œä¸ŠèŠ‚çœäº†çº¦45æ¯«ç§’-ä¸é”™ï¼Œä½†ä¸æ˜¯å¾ˆå¥½ã€‚ åœ¨è®¸å¤šæŒ‡ä»¤ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨ä¸‰ä¸ªè€Œä¸æ˜¯å››ä¸ªåˆ†é‡ï¼Œä»¥åŠç²¾ç¡®çš„ä¹˜æ³•ï¼Œè¿™ä¼šäº§ç”Ÿç›¸å½“å¤§çš„å»¶è¿Ÿã€‚ å¦‚æœæ‚¨ä»¥å‰ä¸ºSIMDç¼–å†™è¿‡è¯´æ˜ï¼Œé‚£ä¹ˆæ‚¨å°±ä¼šçŸ¥é“å¦‚ä½•æ­£ç¡®åœ°å¤„ç†æ ‡é‡ç§¯ã€‚ <br><br> ä¸ºæ­¤ï¼Œæ‚¨éœ€è¦ä¸€æ¬¡æ‰§è¡Œå››ä¸ªå‘é‡ã€‚ è€Œä¸æ˜¯å°†ä¸€ä¸ªå®Œæ•´çš„å‘é‡å­˜å‚¨åœ¨ä¸€ä¸ªSIMDå¯„å­˜å™¨ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨ä¸‰ä¸ªå¯„å­˜å™¨-åœ¨ä¸€ä¸ªå¯„å­˜å™¨ä¸­ï¼Œæˆ‘ä»¬å­˜å‚¨<code>x</code>å››ä¸ªåˆ†é‡ï¼Œåœ¨å¦ä¸€ä¸ªå¯„å­˜å™¨ä¸­ï¼Œæˆ‘ä»¬å°†å­˜å‚¨<code></code> ï¼Œè€Œåœ¨ç¬¬ä¸‰ä¸ª<code>z</code> ã€‚ è¿™é‡Œä¸€æ¬¡éœ€è¦å››ä¸ªå‘é‡ï¼šè¿™æ„å‘³ç€æˆ‘ä»¬å°†åŒæ—¶å¤„ç†å››ä¸ªä¸‰è§’å½¢ã€‚ <br><br> æˆ‘ä»¬æœ‰è®¸å¤šå¸¦æœ‰åŠ¨æ€ç´¢å¼•çš„æ•°ç»„ã€‚ é€šå¸¸ï¼Œå®ƒæœ‰åŠ©äºå°†æ•°æ®ä¼ è¾“åˆ°<code>x</code> / <code>y</code> / <code>z</code>åˆ†é‡çš„å‡†å¤‡å¥½çš„æ•°ç»„ï¼ˆæˆ–è€…æ›´ç¡®åˆ‡åœ°è¯´ï¼Œå¯¹äºè¾“å…¥ä¸­çš„8ä¸ªé¡¶ç‚¹ï¼Œé€šå¸¸ä½¿ç”¨å°çš„SIMDå¯„å­˜å™¨ï¼Œä¾‹å¦‚<code>float x[8], y[8], z[8]</code> ï¼‰ã€‚æ•°æ®ï¼šè¿™ç§°ä¸ºAoSoAï¼ˆæ•°ç»„ç»“æ„çš„æ•°ç»„ï¼‰ï¼Œå¯ä»¥åœ¨ç¼“å­˜å±€éƒ¨æ€§å’Œæ˜“äºåŠ è½½åˆ°SIMDå¯„å­˜å™¨ä¹‹é—´å–å¾—è‰¯å¥½çš„å¹³è¡¡ï¼‰ï¼Œä½†æ˜¯è¿™é‡Œçš„åŠ¨æ€ç´¢å¼•æ•ˆæœä¸ä½³ï¼Œå› æ­¤è¯·ç…§å¸¸åŠ è½½å››ä¸ªä¸‰è§’å½¢çš„æ•°æ®ï¼Œå¹¶ä½¿ç”¨æ–¹ä¾¿çš„æ–¹å¼å¯¹å‘é‡è¿›è¡Œè½¬ç½®å®<code>_MM_TRANSPOSE</code> ã€‚ <br><br> ä»ç†è®ºä¸Šè®²ï¼Œæ‚¨éœ€è¦åœ¨è‡ªå·±çš„SIMDå¯„å­˜å™¨ä¸­è®¡ç®—å››ä¸ªæœ‰é™äºŒæ¬¡<code>__m128 Q_a00</code>æ¯ä¸ªåˆ†é‡ï¼ˆä¾‹å¦‚ï¼Œæˆ‘ä»¬å°†æ‹¥æœ‰<code>__m128 Q_a00</code>å…¶ä¸­å››ä¸ªåˆ†é‡å…·æœ‰<code>__m128 Q_a00</code>æœ‰é™äºŒæ¬¡<code>__m128 Q_a00</code> ï¼‰ã€‚ åœ¨è¿™ç§æƒ…å†µä¸‹ï¼ŒäºŒæ¬¡æ›²é¢ä¸Šçš„è¿ç®—éå¸¸é€‚åˆ4å®½SIMDæŒ‡ä»¤ï¼Œå¹¶ä¸”è½¬æ¢å®é™…ä¸Šä¼šå‡æ…¢ä»£ç çš„é€Ÿåº¦-å› æ­¤ï¼Œæˆ‘ä»¬åªè½¬ç½®åˆå§‹å‘é‡ï¼Œç„¶åè½¬ç½®å¹³é¢æ–¹ç¨‹ï¼Œç„¶åè¿è¡Œç”¨äºè®¡ç®—äºŒæ¬¡æ›²é¢çš„ç›¸åŒä»£ç ï¼Œä½†æ˜¯é‡å¤ä¸€ä¸‹å››æ¬¡ã€‚ ä»¥ä¸‹æ˜¯ç”¨äºè®¡ç®—å¹³é¢æ–¹ç¨‹çš„ä»£ç ï¼ˆä¸ºç®€ä¾¿èµ·è§ï¼Œçœç•¥äº†å…¶ä½™éƒ¨åˆ†ï¼‰ï¼š <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i00 = indices[(i + <span class="hljs-number"><span class="hljs-number">0</span></span>) * <span class="hljs-number"><span class="hljs-number">3</span></span> + <span class="hljs-number"><span class="hljs-number">0</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i01 = indices[(i + <span class="hljs-number"><span class="hljs-number">0</span></span>) * <span class="hljs-number"><span class="hljs-number">3</span></span> + <span class="hljs-number"><span class="hljs-number">1</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i02 = indices[(i + <span class="hljs-number"><span class="hljs-number">0</span></span>) * <span class="hljs-number"><span class="hljs-number">3</span></span> + <span class="hljs-number"><span class="hljs-number">2</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i10 = indices[(i + <span class="hljs-number"><span class="hljs-number">1</span></span>) * <span class="hljs-number"><span class="hljs-number">3</span></span> + <span class="hljs-number"><span class="hljs-number">0</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i11 = indices[(i + <span class="hljs-number"><span class="hljs-number">1</span></span>) * <span class="hljs-number"><span class="hljs-number">3</span></span> + <span class="hljs-number"><span class="hljs-number">1</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i12 = indices[(i + <span class="hljs-number"><span class="hljs-number">1</span></span>) * <span class="hljs-number"><span class="hljs-number">3</span></span> + <span class="hljs-number"><span class="hljs-number">2</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i20 = indices[(i + <span class="hljs-number"><span class="hljs-number">2</span></span>) * <span class="hljs-number"><span class="hljs-number">3</span></span> + <span class="hljs-number"><span class="hljs-number">0</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i21 = indices[(i + <span class="hljs-number"><span class="hljs-number">2</span></span>) * <span class="hljs-number"><span class="hljs-number">3</span></span> + <span class="hljs-number"><span class="hljs-number">1</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i22 = indices[(i + <span class="hljs-number"><span class="hljs-number">2</span></span>) * <span class="hljs-number"><span class="hljs-number">3</span></span> + <span class="hljs-number"><span class="hljs-number">2</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i30 = indices[(i + <span class="hljs-number"><span class="hljs-number">3</span></span>) * <span class="hljs-number"><span class="hljs-number">3</span></span> + <span class="hljs-number"><span class="hljs-number">0</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i31 = indices[(i + <span class="hljs-number"><span class="hljs-number">3</span></span>) * <span class="hljs-number"><span class="hljs-number">3</span></span> + <span class="hljs-number"><span class="hljs-number">1</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i32 = indices[(i + <span class="hljs-number"><span class="hljs-number">3</span></span>) * <span class="hljs-number"><span class="hljs-number">3</span></span> + <span class="hljs-number"><span class="hljs-number">2</span></span>]; <span class="hljs-comment"><span class="hljs-comment">// load first vertex of each triangle and transpose into vectors with components (pw0 isn't used later) __m128 px0 = _mm_loadu_ps(&amp;vertex_positions[i00].x); __m128 py0 = _mm_loadu_ps(&amp;vertex_positions[i10].x); __m128 pz0 = _mm_loadu_ps(&amp;vertex_positions[i20].x); __m128 pw0 = _mm_loadu_ps(&amp;vertex_positions[i30].x); _MM_TRANSPOSE4_PS(px0, py0, pz0, pw0); // load second vertex of each triangle and transpose into vectors with components __m128 px1 = _mm_loadu_ps(&amp;vertex_positions[i01].x); __m128 py1 = _mm_loadu_ps(&amp;vertex_positions[i11].x); __m128 pz1 = _mm_loadu_ps(&amp;vertex_positions[i21].x); __m128 pw1 = _mm_loadu_ps(&amp;vertex_positions[i31].x); _MM_TRANSPOSE4_PS(px1, py1, pz1, pw1); // load third vertex of each triangle and transpose into vectors with components __m128 px2 = _mm_loadu_ps(&amp;vertex_positions[i02].x); __m128 py2 = _mm_loadu_ps(&amp;vertex_positions[i12].x); __m128 pz2 = _mm_loadu_ps(&amp;vertex_positions[i22].x); __m128 pw2 = _mm_loadu_ps(&amp;vertex_positions[i32].x); _MM_TRANSPOSE4_PS(px2, py2, pz2, pw2); // p1 - p0 __m128 px10 = _mm_sub_ps(px1, px0); __m128 py10 = _mm_sub_ps(py1, py0); __m128 pz10 = _mm_sub_ps(pz1, pz0); // p2 - p0 __m128 px20 = _mm_sub_ps(px2, px0); __m128 py20 = _mm_sub_ps(py2, py0); __m128 pz20 = _mm_sub_ps(pz2, pz0); // cross(p10, p20) __m128 normalx = _mm_sub_ps( _mm_mul_ps(py10, pz20), _mm_mul_ps(pz10, py20)); __m128 normaly = _mm_sub_ps( _mm_mul_ps(pz10, px20), _mm_mul_ps(px10, pz20)); __m128 normalz = _mm_sub_ps( _mm_mul_ps(px10, py20), _mm_mul_ps(py10, px20)); // normalize; note that areasq/area now contain 4 values, not just one __m128 areasq = _mm_add_ps( _mm_mul_ps(normalx, normalx), _mm_add_ps( _mm_mul_ps(normaly, normaly), _mm_mul_ps(normalz, normalz))); __m128 area = _mm_sqrt_ps(areasq); __m128 areanz = _mm_cmpneq_ps(area, _mm_setzero_ps()); normalx = _mm_and_ps(_mm_div_ps(normalx, area), areanz); normaly = _mm_and_ps(_mm_div_ps(normaly, area), areanz); normalz = _mm_and_ps(_mm_div_ps(normalz, area), areanz); __m128 distance = _mm_add_ps( _mm_mul_ps(normalx, px0), _mm_add_ps( _mm_mul_ps(normaly, py0), _mm_mul_ps(normalz, pz0))); __m128 negdistance = _mm_sub_ps(_mm_setzero_ps(), distance); // this computes the plane equations (a, b, c, d) for each of the 4 triangles __m128 plane0 = normalx; __m128 plane1 = normaly; __m128 plane2 = normalz; __m128 plane3 = negdistance; _MM_TRANSPOSE4_PS(plane0, plane1, plane2, plane3);</span></span></code> </pre> <br> ä»£ç å˜å¾—æ›´é•¿ä¸€äº›ï¼šç°åœ¨ï¼Œæˆ‘ä»¬åœ¨æ¯æ¬¡è¿­ä»£ä¸­å¤„ç†å››ä¸ªä¸‰è§’å½¢ï¼Œå¹¶ä¸”ä¸ºæ­¤ï¼Œæˆ‘ä»¬ä¸å†éœ€è¦SSE4.1æŒ‡ä»¤ã€‚ ä»ç†è®ºä¸Šè®²ï¼Œåº”è¯¥æ›´æœ‰æ•ˆåœ°ä½¿ç”¨SIMDå•å…ƒã€‚ è®©æˆ‘ä»¬çœ‹çœ‹å®ƒå¦‚ä½•å¸®åŠ©æ‚¨ã€‚ <br><br><img src="https://habrastorage.org/getpro/habr/post_images/2ca/735/f51/2ca735f51bf3aa28bbf7c28f50489c15.png"><br><br> å¥½çš„ï¼Œæ²¡å…³ç³»ã€‚ è¯¥ä»£ç å·²ç»éå¸¸ç¼“æ…¢åœ°åŠ é€Ÿäº†ï¼Œå°½ç®¡<code>fillCellQuadrics</code>å‡½æ•°ç°åœ¨çš„è¿è¡Œé€Ÿåº¦å‡ ä¹æ˜¯æ²¡æœ‰SIMDçš„åŸå§‹å‡½æ•°çš„ä¸¤å€ï¼Œä½†æ˜¯å°šä¸æ¸…æ¥šè¿™æ˜¯å¦å¯ä»¥è¯æ˜å¤æ‚æ€§çš„æ˜¾ç€æé«˜ã€‚ ä»ç†è®ºä¸Šè®²ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨AVX2å¹¶åœ¨æ¯æ¬¡è¿­ä»£ä¸­å¤„ç†8ä¸ªä¸‰è§’å½¢ï¼Œä½†æ˜¯åœ¨è¿™é‡Œæ‚¨å°†éœ€è¦è¿›ä¸€æ­¥æ‰‹åŠ¨æ—‹è½¬å¾ªç¯ï¼ˆç†æƒ³æƒ…å†µä¸‹ï¼Œæ‰€æœ‰è¿™äº›ä»£ç éƒ½æ˜¯ä½¿ç”¨ISPCç”Ÿæˆçš„ï¼Œä½†æ˜¯æˆ‘å¹¼ç¨šåœ°å°è¯•ä½¿å…¶ç”Ÿæˆè‰¯å¥½ä»£ç çš„å°è¯•å¹¶æœªæˆåŠŸï¼šä»£æ›¿åŠ è½½/å­˜å‚¨åºåˆ—ä»–æŒç»­å‘å‡ºæ”¶é›†/åˆ†æ•£ä¿¡æ¯ï¼Œè¿™ä¼šå¤§å¤§é™ä½æ‰§è¡Œé€Ÿåº¦ï¼‰ã€‚ è®©æˆ‘ä»¬å°è¯•å…¶ä»–äº‹æƒ…ã€‚ <br><br><h1>  AVX2 = SSE2 + SSE2 </h1><br>  AVX2åªæ˜¯ä¸€ç»„æŒ‡ä»¤ã€‚ å®ƒå…·æœ‰8ä¸ªå®½çš„æµ®ç‚¹å¯„å­˜å™¨ï¼Œä¸€æ¡æŒ‡ä»¤å¯ä»¥æ‰§è¡Œ8ä¸ªæ“ä½œï¼› ä½†æ˜¯ä»æœ¬è´¨ä¸Šè®²ï¼Œè¿™æ ·çš„æŒ‡ä»¤ä¸åœ¨å¯„å­˜å™¨çš„ä¸¤åŠæ‰§è¡Œçš„ä¸¤æ¡SSE2æŒ‡ä»¤æ²¡æœ‰åŒºåˆ«ï¼ˆæ®æˆ‘æ‰€çŸ¥ï¼Œå…·æœ‰AVX2çš„ç¬¬ä¸€æ‰¹å¤„ç†å™¨æ”¯æŒä»¥ä¸¤ä¸ªæˆ–å¤šä¸ªå¾®æ“ä½œå¯¹æ¯ä¸ªæŒ‡ä»¤è¿›è¡Œè§£ç ï¼Œå› æ­¤æ€§èƒ½æå‡å—åˆ°æå–æŒ‡ä»¤é˜¶æ®µçš„é™åˆ¶ï¼‰ã€‚ ä¾‹å¦‚ï¼Œ <code>_mm_dp_ps</code>åœ¨ä¸¤ä¸ªSSE2å¯„å­˜å™¨ä¹‹é—´æ‰§è¡Œæ ‡é‡ç§¯ï¼Œè€Œ<code>_mm256_dp_ps</code>åœ¨ä¸¤ä¸ªAVX2å¯„å­˜å™¨çš„ä¸¤åŠä¹‹é—´äº§ç”Ÿä¸¤ä¸ªæ ‡é‡ç§¯ï¼Œå› æ­¤ï¼Œæ¯åŠåªé™äº4å®½ã€‚ <br><br> å› æ­¤ï¼ŒAVX2ä»£ç é€šå¸¸ä¸é€šç”¨çš„â€œ 8å®½SIMDâ€æœ‰æ‰€ä¸åŒï¼Œä½†åœ¨è¿™é‡Œå®ƒå¯¹æˆ‘ä»¬æœ‰åˆ©ï¼šä¸æ˜¯è¯•å›¾é€šè¿‡è½¬ç½®4å®½çŸ¢é‡æ¥æ”¹å–„çŸ¢é‡åŒ–ï¼Œè€Œæ˜¯è¿”å›åˆ°SIMDçš„ç¬¬ä¸€ä¸ªç‰ˆæœ¬ï¼Œå¹¶ä½¿ç”¨AVX2æŒ‡ä»¤ï¼ˆè€Œä¸æ˜¯SSE2ï¼‰å°†å¾ªç¯åŠ å€/ SSE4ã€‚ æˆ‘ä»¬ä»ç„¶éœ€è¦åŠ è½½å’Œå­˜å‚¨4å®½å‘é‡ï¼Œä½†æ˜¯é€šå¸¸ï¼Œæˆ‘ä»¬åªéœ€ä½¿ç”¨ä»¥ä¸‹å‡ ç§è®¾ç½®<code>_mm256</code>å°†<code>_mm256</code>ä¸­çš„<code>_mm_</code>æ›´æ”¹ä¸º<code>__m256</code> ï¼Œå°†<code>_mm256</code>æ›´æ”¹ä¸º<code>__m256</code> ï¼š <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i00 = indices[(i + <span class="hljs-number"><span class="hljs-number">0</span></span>) * <span class="hljs-number"><span class="hljs-number">3</span></span> + <span class="hljs-number"><span class="hljs-number">0</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i01 = indices[(i + <span class="hljs-number"><span class="hljs-number">0</span></span>) * <span class="hljs-number"><span class="hljs-number">3</span></span> + <span class="hljs-number"><span class="hljs-number">1</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i02 = indices[(i + <span class="hljs-number"><span class="hljs-number">0</span></span>) * <span class="hljs-number"><span class="hljs-number">3</span></span> + <span class="hljs-number"><span class="hljs-number">2</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i10 = indices[(i + <span class="hljs-number"><span class="hljs-number">1</span></span>) * <span class="hljs-number"><span class="hljs-number">3</span></span> + <span class="hljs-number"><span class="hljs-number">0</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i11 = indices[(i + <span class="hljs-number"><span class="hljs-number">1</span></span>) * <span class="hljs-number"><span class="hljs-number">3</span></span> + <span class="hljs-number"><span class="hljs-number">1</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i12 = indices[(i + <span class="hljs-number"><span class="hljs-number">1</span></span>) * <span class="hljs-number"><span class="hljs-number">3</span></span> + <span class="hljs-number"><span class="hljs-number">2</span></span>]; __m256 p0 = _mm256_loadu2_m128( &amp;vertex_positions[i10].x, &amp;vertex_positions[i00].x); __m256 p1 = _mm256_loadu2_m128( &amp;vertex_positions[i11].x, &amp;vertex_positions[i01].x); __m256 p2 = _mm256_loadu2_m128( &amp;vertex_positions[i12].x, &amp;vertex_positions[i02].x); __m256 p10 = _mm256_sub_ps(p1, p0); __m256 p20 = _mm256_sub_ps(p2, p0); __m256 normal = _mm256_sub_ps( _mm256_mul_ps( _mm256_shuffle_ps(p10, p10, yzx), _mm256_shuffle_ps(p20, p20, zxy)), _mm256_mul_ps( _mm256_shuffle_ps(p10, p10, zxy), _mm256_shuffle_ps(p20, p20, yzx))); __m256 areasq = _mm256_dp_ps(normal, normal, dp_xyz); __m256 area = _mm256_sqrt_ps(areasq); __m256 areanz = _mm256_cmp_ps(area, _mm256_setzero_ps(), _CMP_NEQ_OQ); normal = _mm256_and_ps(_mm256_div_ps(normal, area), areanz); __m256 distance = _mm256_dp_ps(normal, p0, dp_xyz); __m256 negdistance = _mm256_sub_ps(_mm256_setzero_ps(), distance); __m256 normalnegdist = _mm256_blend_ps(normal, negdistance, <span class="hljs-number"><span class="hljs-number">0x88</span></span>); __m256 Qx = _mm256_mul_ps(normal, normal); __m256 Qy = _mm256_mul_ps( _mm256_shuffle_ps(normal, normal, _MM_SHUFFLE(<span class="hljs-number"><span class="hljs-number">3</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>)), _mm256_shuffle_ps(normal, normal, _MM_SHUFFLE(<span class="hljs-number"><span class="hljs-number">3</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>))); __m256 Qz = _mm256_mul_ps(negdistance, normalnegdist);</code> </pre> <br> åœ¨è¿™é‡Œï¼Œæ‚¨å¯ä»¥è·å–æ¥æ”¶åˆ°çš„<code>Qx</code> / <code>Qz</code> / <code>Qz</code>æ¯128ä½ä¸€åŠï¼Œå¹¶è¿è¡Œç”¨äºæ·»åŠ äºŒæ¬¡é¡¹çš„ç›¸åŒä»£ç ã€‚ ç›¸åï¼Œæˆ‘ä»¬å‡è®¾å¦‚æœä¸€ä¸ªä¸‰è§’å½¢åœ¨ä¸€ä¸ªå•å…ƒæ ¼ä¸­å…·æœ‰ä¸‰ä¸ªé¡¶ç‚¹ï¼ˆ <code>single_cell == true</code> ï¼‰ï¼Œé‚£ä¹ˆå¦ä¸€ä¸ªä¸‰è§’å½¢åœ¨å¦ä¸€ä¸ªå•å…ƒæ ¼ä¸­å¾ˆæœ‰å¯èƒ½å…·æœ‰ä¸‰ä¸ªé¡¶ç‚¹ï¼Œå¹¶ä¸”æˆ‘ä»¬ä¹Ÿä½¿ç”¨AVX2æ‰§è¡ŒäºŒæ¬¡æ›²é¢çš„æœ€ç»ˆèšåˆï¼š <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> c00 = vertex_cells[i00]; <span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> c01 = vertex_cells[i01]; <span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> c02 = vertex_cells[i02]; <span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> c10 = vertex_cells[i10]; <span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> c11 = vertex_cells[i11]; <span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> c12 = vertex_cells[i12]; <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> single_cell = (c00 == c01) &amp; (c00 == c02) &amp; (c10 == c11) &amp; (c10 == c12); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (single_cell) { area = _mm256_mul_ps(area, _mm256_set1_ps(<span class="hljs-number"><span class="hljs-number">3.f</span></span>)); Qx = _mm256_mul_ps(Qx, area); Qy = _mm256_mul_ps(Qy, area); Qz = _mm256_mul_ps(Qz, area); Quadric&amp; q00 = cell_quadrics[c00]; Quadric&amp; q10 = cell_quadrics[c10]; __m256 q0x = _mm256_loadu2_m128(&amp;q10.a00, &amp;q00.a00); __m256 q0y = _mm256_loadu2_m128(&amp;q10.a10, &amp;q00.a10); __m256 q0z = _mm256_loadu2_m128(&amp;q10.b0, &amp;q00.b0); _mm256_storeu2_m128(&amp;q10.a00, &amp;q00.a00, _mm256_add_ps(q0x, Qx)); _mm256_storeu2_m128(&amp;q10.a10, &amp;q00.a10, _mm256_add_ps(q0y, Qy)); _mm256_storeu2_m128(&amp;q10.b0, &amp;q00.b0, _mm256_add_ps(q0z, Qz)); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-comment"><span class="hljs-comment">// omitted for brevity }</span></span></code> </pre> <br> æ‰€äº§ç”Ÿçš„ä»£ç æ¯”æˆ‘ä»¬ä¸æˆåŠŸçš„SSE2æ–¹æ³•æ›´ç®€å•ï¼Œç®€æ˜å’Œå¿«é€Ÿï¼š <br><br><img src="https://habrastorage.org/getpro/habr/post_images/124/788/954/1247889540c5aab18d1f38738fb46fea.png"><br><br> å½“ç„¶ï¼Œæˆ‘ä»¬æ²¡æœ‰å®ç°8å€çš„åŠ é€Ÿï¼Œè€Œåªæœ‰2.45å€ã€‚ åŠ è½½å’Œå­˜å‚¨æ“ä½œä»ç„¶æ˜¯4å®½ï¼Œå› ä¸ºç”±äºåŠ¨æ€ç´¢å¼•ï¼Œæˆ‘ä»¬ä¸å¾—ä¸ä½¿ç”¨ä¸èˆ’æœçš„å†…å­˜å¸ƒå±€ï¼Œå¹¶ä¸”è®¡ç®—å¯¹äºSIMDå¹¶ä¸æ˜¯æœ€ä½³çš„ã€‚ ä½†æ˜¯ç°åœ¨<code>fillCellQuadrics</code>ä¸å†æ˜¯æˆ‘ä»¬é…ç½®æ–‡ä»¶ç®¡é“ä¸­çš„ç“¶é¢ˆï¼Œæ‚¨å¯ä»¥ä¸“æ³¨äºå…¶ä»–åŠŸèƒ½ã€‚ <br><br><h1> å­©å­ä»¬èšé›† </h1><br> æˆ‘ä»¬åœ¨æµ‹è¯•è¿è¡Œä¸­èŠ‚çœäº†4.8ç§’ï¼ˆæ¯æ¬¡è¿è¡ŒèŠ‚çœäº†48æ¯«ç§’ï¼‰ï¼Œç°åœ¨æˆ‘ä»¬çš„ä¸»è¦å…¥ä¾µè€…æ˜¯<code>countTriangles</code> ã€‚ è¿™ä¼¼ä¹æ˜¯ä¸€ä¸ªç®€å•çš„å‡½æ•°ï¼Œä½†æ˜¯å®ƒæ‰§è¡Œçš„ä¸æ˜¯ä¸€æ¬¡ï¼Œè€Œæ˜¯äº”æ¬¡ï¼š <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> size_t </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">countTriangles</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">unsigned</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params">* vertex_ids, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">unsigned</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params">* indices, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">size_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> index_count)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">size_t</span></span> result = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">size_t</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; index_count; i += <span class="hljs-number"><span class="hljs-number">3</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> id0 = vertex_ids[indices[i + <span class="hljs-number"><span class="hljs-number">0</span></span>]]; <span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> id1 = vertex_ids[indices[i + <span class="hljs-number"><span class="hljs-number">1</span></span>]]; <span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> id2 = vertex_ids[indices[i + <span class="hljs-number"><span class="hljs-number">2</span></span>]]; result += (id0 != id1) &amp; (id0 != id2) &amp; (id1 != id2); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> result; }</code> </pre> <br> è¯¥å‡½æ•°éå†æ‰€æœ‰æºä¸‰è§’å½¢ï¼Œå¹¶é€šè¿‡æ¯”è¾ƒé¡¶ç‚¹çš„æ ‡è¯†ç¬¦æ¥è®¡ç®—éé€€åŒ–ä¸‰è§’å½¢çš„æ•°é‡ã€‚ é™¤éæ‚¨ä½¿ç”¨æ”¶é›†æŒ‡ä»¤ï¼Œå¦åˆ™ç›®å‰å°šä¸æ¸…æ¥šå¦‚ä½•ä½¿ç”¨SIMDå¯¹å…¶è¿›è¡Œå¹¶è¡ŒåŒ–ã€‚ <br><br>  AVX2æŒ‡ä»¤é›†å‘x64 SIMDæ·»åŠ äº†ä¸€ä¸ªæ”¶é›†/åˆ†æ•£æŒ‡ä»¤ç³»åˆ—ã€‚ å®ƒä»¬æ¯ä¸ªéƒ½ä½¿ç”¨å…·æœ‰4æˆ–8ä¸ªå€¼çš„å‘é‡å¯„å­˜å™¨-åŒæ—¶æ‰§è¡Œ4æˆ–8ä¸ªåŠ è½½æˆ–ä¿å­˜æ“ä½œã€‚ å¦‚æœåœ¨æ­¤å¤„ä½¿ç”¨æ”¶é›†ï¼Œåˆ™å¯ä»¥ä¸‹è½½ä¸‰ä¸ªç´¢å¼•ï¼Œä¸€æ¬¡è¿è¡Œæ‰€æœ‰æ”¶é›†ï¼ˆæˆ–ä»¥4æˆ–8ä¸ºä¸€ç»„ï¼‰å¹¶æ¯”è¾ƒç»“æœã€‚ ä»å†å²ä¸Šçœ‹ï¼Œè‹±ç‰¹å°”å¤„ç†å™¨ä¸Šçš„æ”¶é›†é€Ÿåº¦ç›¸å½“ç¼“æ…¢ï¼Œä½†è®©æˆ‘ä»¬å°è¯•ä¸€ä¸‹ã€‚ ä¸ºç®€å•èµ·è§ï¼Œæˆ‘ä»¬ä¸Šè½½äº†8ä¸ªä¸‰è§’å½¢çš„æ•°æ®ï¼Œå¯¹å‘é‡è¿›è¡Œç±»ä¼¼äºå…ˆå‰å°è¯•çš„è½¬ç½®ï¼Œå¹¶æ¯”è¾ƒäº†æ¯ä¸ªå‘é‡çš„å¯¹åº”å…ƒç´ ï¼š <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">size_t</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; (triangle_count &amp; ~<span class="hljs-number"><span class="hljs-number">7</span></span>); i += <span class="hljs-number"><span class="hljs-number">8</span></span>) { __m256 tri0 = _mm256_loadu2_m128( (<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">float</span></span>*)&amp;indices[(i + <span class="hljs-number"><span class="hljs-number">4</span></span>) * <span class="hljs-number"><span class="hljs-number">3</span></span> + <span class="hljs-number"><span class="hljs-number">0</span></span>], (<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">float</span></span>*)&amp;indices[(i + <span class="hljs-number"><span class="hljs-number">0</span></span>) * <span class="hljs-number"><span class="hljs-number">3</span></span> + <span class="hljs-number"><span class="hljs-number">0</span></span>]); __m256 tri1 = _mm256_loadu2_m128( (<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">float</span></span>*)&amp;indices[(i + <span class="hljs-number"><span class="hljs-number">5</span></span>) * <span class="hljs-number"><span class="hljs-number">3</span></span> + <span class="hljs-number"><span class="hljs-number">0</span></span>], (<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">float</span></span>*)&amp;indices[(i + <span class="hljs-number"><span class="hljs-number">1</span></span>) * <span class="hljs-number"><span class="hljs-number">3</span></span> + <span class="hljs-number"><span class="hljs-number">0</span></span>]); __m256 tri2 = _mm256_loadu2_m128( (<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">float</span></span>*)&amp;indices[(i + <span class="hljs-number"><span class="hljs-number">6</span></span>) * <span class="hljs-number"><span class="hljs-number">3</span></span> + <span class="hljs-number"><span class="hljs-number">0</span></span>], (<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">float</span></span>*)&amp;indices[(i + <span class="hljs-number"><span class="hljs-number">2</span></span>) * <span class="hljs-number"><span class="hljs-number">3</span></span> + <span class="hljs-number"><span class="hljs-number">0</span></span>]); __m256 tri3 = _mm256_loadu2_m128( (<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">float</span></span>*)&amp;indices[(i + <span class="hljs-number"><span class="hljs-number">7</span></span>) * <span class="hljs-number"><span class="hljs-number">3</span></span> + <span class="hljs-number"><span class="hljs-number">0</span></span>], (<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">float</span></span>*)&amp;indices[(i + <span class="hljs-number"><span class="hljs-number">3</span></span>) * <span class="hljs-number"><span class="hljs-number">3</span></span> + <span class="hljs-number"><span class="hljs-number">0</span></span>]); _MM_TRANSPOSE8_LANE4_PS(tri0, tri1, tri2, tri3); __m256i i0 = _mm256_castps_si256(tri0); __m256i i1 = _mm256_castps_si256(tri1); __m256i i2 = _mm256_castps_si256(tri2); __m256i id0 = _mm256_i32gather_epi32((<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>*)vertex_ids, i0, <span class="hljs-number"><span class="hljs-number">4</span></span>); __m256i id1 = _mm256_i32gather_epi32((<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>*)vertex_ids, i1, <span class="hljs-number"><span class="hljs-number">4</span></span>); __m256i id2 = _mm256_i32gather_epi32((<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>*)vertex_ids, i2, <span class="hljs-number"><span class="hljs-number">4</span></span>); __m256i deg = _mm256_or_si256( _mm256_cmpeq_epi32(id1, id2), _mm256_or_si256( _mm256_cmpeq_epi32(id0, id1), _mm256_cmpeq_epi32(id0, id2))); result += <span class="hljs-number"><span class="hljs-number">8</span></span> - _mm_popcnt_u32(_mm256_movemask_epi8(deg)) / <span class="hljs-number"><span class="hljs-number">4</span></span>; }</code> </pre> <br>  AVX2ä¸­çš„<code>_MM_TRANSPOSE8_LANE4_PS</code>å®ç­‰æ•ˆäº<code>_MM_TRANSPOSE4_PS</code> ï¼Œè¯¥å®åœ¨æ ‡å‡†æ ‡é¢˜ä¸­æ‰¾ä¸åˆ°ï¼Œä½†å¾ˆå®¹æ˜“æ˜¾ç¤ºã€‚ å®ƒéœ€è¦å››ä¸ªAVX2å‘é‡ï¼Œå¹¶ä¸”å½¼æ­¤ç‹¬ç«‹åœ°è½¬ç½®ä¸¤ä¸ª4Ã—4çŸ©é˜µï¼š <br><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> _MM_TRANSPOSE8_LANE4_PS(row0, row1, row2, row3) \ do { \ __m256 __t0, __t1, __t2, __t3; \ __t0 = _mm256_unpacklo_ps(row0, row1); \ __t1 = _mm256_unpackhi_ps(row0, row1); \ __t2 = _mm256_unpacklo_ps(row2, row3); \ __t3 = _mm256_unpackhi_ps(row2, row3); \ row0 = _mm256_shuffle_ps(__t0, __t2, _MM_SHUFFLE(1, 0, 1, 0)); \ row1 = _mm256_shuffle_ps(__t0, __t2, _MM_SHUFFLE(3, 2, 3, 2)); \ row2 = _mm256_shuffle_ps(__t1, __t3, _MM_SHUFFLE(1, 0, 1, 0)); \ row3 = _mm256_shuffle_ps(__t1, __t3, _MM_SHUFFLE(3, 2, 3, 2)); \ } while (0)</span></span></code> </pre> <br> ç”±äºSSE2 / AVX2æŒ‡ä»¤é›†çš„æŸäº›åŠŸèƒ½ï¼Œè½¬ç½®å‘é‡æ—¶å¿…é¡»ä½¿ç”¨æµ®ç‚¹å¯„å­˜å™¨æ“ä½œã€‚ æˆ‘ä»¬æœ‰ç‚¹ç²—å¿ƒåœ°åŠ è½½æ•°æ®ï¼› ä½†è¿™åŸºæœ¬ä¸Šæ²¡æœ‰å…³ç³»ï¼Œå› ä¸ºæ”¶é›†æ€§èƒ½ä¼šé™åˆ¶æˆ‘ä»¬ï¼š <br><br><img src="https://habrastorage.org/getpro/habr/post_images/1ef/602/0e0/1ef6020e0d5b0c4bbf962335d77c653a.png"><br><br> ç°åœ¨<code>countTriangles</code>é€Ÿåº¦æé«˜äº†çº¦27ï¼…ï¼Œå¹¶æ³¨æ„åˆ°äº†å¯æ€•çš„CPIï¼ˆæ¯æ¡æŒ‡ä»¤çš„å‘¨æœŸæ•°ï¼‰ï¼šæˆ‘ä»¬å‘å‡ºçš„æŒ‡ä»¤å°‘äº†å››å€ï¼Œä½†æ”¶é›†å´èŠ±è´¹äº†å¾ˆå¤šæ—¶é—´ã€‚ åŠ å¿«æ•´ä½“å·¥ä½œçš„é€Ÿåº¦å¾ˆå¥½ï¼Œä½†æ˜¯ï¼Œå½“ç„¶ï¼Œæ€§èƒ½æå‡ä¼šä»¤äººæ²®ä¸§ã€‚ æˆ‘ä»¬è®¾æ³•è¶…è¿‡äº†æ¦‚è¦æ–‡ä»¶ä¸­çš„<code>fillCellQuadrics</code> ï¼Œè¿™ä½¿æˆ‘ä»¬è¿›å…¥äº†å°šæœªæŸ¥çœ‹çš„åˆ—è¡¨é¡¶éƒ¨çš„æœ€åä¸€ä¸ªå‡½æ•°ã€‚ <br><br><h1> ç¬¬6ç« ï¼Œä¸€åˆ‡éƒ½åº”å¼€å§‹è¿›è¡Œ </h1><br> æœ€åä¸€ä¸ªå‡½æ•°æ˜¯<code>computeVertexIds</code> ã€‚ åœ¨ç®—æ³•ä¸­ï¼Œå®ƒæ‰§è¡Œäº†6æ¬¡ï¼Œå› æ­¤å®ƒä¹Ÿä»£è¡¨äº†ä¼˜åŒ–çš„ç»ä½³ç›®æ ‡ã€‚ ç¬¬ä¸€æ¬¡ï¼Œæˆ‘ä»¬çœ‹åˆ°ä¸€ä¸ªä¼¼ä¹æ˜¯ä¸ºäº†åœ¨SIMDä¸­è¿›è¡Œæ¸…æ™°ä¼˜åŒ–è€Œåˆ›å»ºçš„å‡½æ•°ï¼š <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">computeVertexIds</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">unsigned</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params">* vertex_ids, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> Vector3* vertex_positions, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">size_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> vertex_count, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> grid_size)</span></span></span><span class="hljs-function"> </span></span>{ assert(grid_size &gt;= <span class="hljs-number"><span class="hljs-number">1</span></span> &amp;&amp; grid_size &lt;= <span class="hljs-number"><span class="hljs-number">1024</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> cell_scale = <span class="hljs-keyword"><span class="hljs-keyword">float</span></span>(grid_size - <span class="hljs-number"><span class="hljs-number">1</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">size_t</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; vertex_count; ++i) { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> Vector3&amp; v = vertex_positions[i]; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> xi = <span class="hljs-keyword"><span class="hljs-keyword">int</span></span>(vx * cell_scale + <span class="hljs-number"><span class="hljs-number">0.5f</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> yi = <span class="hljs-keyword"><span class="hljs-keyword">int</span></span>(vy * cell_scale + <span class="hljs-number"><span class="hljs-number">0.5f</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> zi = <span class="hljs-keyword"><span class="hljs-keyword">int</span></span>(vz * cell_scale + <span class="hljs-number"><span class="hljs-number">0.5f</span></span>); vertex_ids[i] = (xi &lt;&lt; <span class="hljs-number"><span class="hljs-number">20</span></span>) | (yi &lt;&lt; <span class="hljs-number"><span class="hljs-number">10</span></span>) | zi; } }</code> </pre> <br> ç»è¿‡ä¹‹å‰çš„ä¼˜åŒ–ï¼Œæˆ‘ä»¬çŸ¥é“è¯¥æ€ä¹ˆåšï¼šå°†å¾ªç¯å±•å¼€4æˆ–8æ¬¡ï¼Œå› ä¸ºè¯•å›¾åŠ é€Ÿä¸€æ¬¡è¿­ä»£ï¼Œè½¬ç½®å‘é‡åˆ†é‡å¹¶å¹¶è¡Œè¿è¡Œè®¡ç®—æ²¡æœ‰ä»»ä½•æ„ä¹‰ã€‚ è®©æˆ‘ä»¬ä½¿ç”¨AVX2è¿›è¡Œå¤„ç†ï¼Œä¸€æ¬¡å¤„ç†8ä¸ªé¡¶ç‚¹ï¼š <br><br><pre> <code class="cpp hljs">__m256 scale = _mm256_set1_ps(cell_scale); __m256 half = _mm256_set1_ps(<span class="hljs-number"><span class="hljs-number">0.5f</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">size_t</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; (vertex_count &amp; ~<span class="hljs-number"><span class="hljs-number">7</span></span>); i += <span class="hljs-number"><span class="hljs-number">8</span></span>) { __m256 vx = _mm256_loadu2_m128( &amp;vertex_positions[i + <span class="hljs-number"><span class="hljs-number">4</span></span>].x, &amp;vertex_positions[i + <span class="hljs-number"><span class="hljs-number">0</span></span>].x); __m256 vy = _mm256_loadu2_m128( &amp;vertex_positions[i + <span class="hljs-number"><span class="hljs-number">5</span></span>].x, &amp;vertex_positions[i + <span class="hljs-number"><span class="hljs-number">1</span></span>].x); __m256 vz = _mm256_loadu2_m128( &amp;vertex_positions[i + <span class="hljs-number"><span class="hljs-number">6</span></span>].x, &amp;vertex_positions[i + <span class="hljs-number"><span class="hljs-number">2</span></span>].x); __m256 vw = _mm256_loadu2_m128( &amp;vertex_positions[i + <span class="hljs-number"><span class="hljs-number">7</span></span>].x, &amp;vertex_positions[i + <span class="hljs-number"><span class="hljs-number">3</span></span>].x); _MM_TRANSPOSE8_LANE4_PS(vx, vy, vz, vw); __m256i xi = _mm256_cvttps_epi32( _mm256_add_ps(_mm256_mul_ps(vx, scale), half)); __m256i yi = _mm256_cvttps_epi32( _mm256_add_ps(_mm256_mul_ps(vy, scale), half)); __m256i zi = _mm256_cvttps_epi32( _mm256_add_ps(_mm256_mul_ps(vz, scale), half)); __m256i id = _mm256_or_si256( zi, _mm256_or_si256( _mm256_slli_epi32(xi, <span class="hljs-number"><span class="hljs-number">20</span></span>), _mm256_slli_epi32(yi, <span class="hljs-number"><span class="hljs-number">10</span></span>))); _mm256_storeu_si256((__m256i*)&amp;vertex_ids[i], id); }</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ç„¶åçœ‹ä¸€ä¸‹ç»“æœï¼š</font></font><br><br><img src="https://habrastorage.org/getpro/habr/post_images/895/365/9c9/8953659c9ee67385751dae656e244dbb.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">æˆ‘ä»¬åŠ é€Ÿäº†</font></font><code>computeVertexIds</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ä¸¤æ¬¡ã€‚è€ƒè™‘åˆ°æ‰€æœ‰ä¼˜åŒ–ï¼Œè¯¥ç¨‹åºçš„æ€»æ‰§è¡Œæ—¶é—´å‡å°‘åˆ°å¤§çº¦120æ¯«ç§’ï¼Œè¿™ç›¸å½“äºæ¯ç§’è®¡ç®—5000ä¸‡ä¸ªä¸‰è§’å½¢ã€‚</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ä¼¼ä¹æˆ‘ä»¬åˆæ²¡æœ‰è¾¾åˆ°é¢„æœŸçš„ç”Ÿäº§ç‡å¢é•¿ï¼š</font></font><code>computeVertexIds</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å¹¶è¡ŒåŒ–ä¹‹åï¼Œå®ƒ</font><font style="vertical-align: inherit;">æ˜¯å¦åº”è¯¥</font><font style="vertical-align: inherit;">åŠ é€Ÿä¸¤å€ä»¥ä¸Šï¼Ÿä¸ºäº†å›ç­”è¿™ä¸ªé—®é¢˜ï¼Œè®©æˆ‘ä»¬å°è¯•çœ‹çœ‹è¯¥å‡½æ•°æ‰§è¡Œäº†å¤šå°‘å·¥ä½œã€‚</font></font><br><br> <code>computeVertexIds</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">å®ƒåœ¨ä¸€ä¸ªç¨‹åºå¼€å§‹æ—¶æ‰§è¡Œå…­æ¬¡ï¼šåœ¨äºŒè¿›åˆ¶æœç´¢ä¸­æ‰§è¡Œäº”æ¬¡ï¼Œåœ¨ç»“æŸæ—¶è®¡ç®—ä¸€æ¬¡ï¼Œä»¥è®¡ç®—ç”¨äºè¿›ä¸€æ­¥å¤„ç†çš„æœ€ç»ˆæ ‡è¯†ç¬¦ã€‚æ¯æ¬¡ï¼Œæ­¤å‡½æ•°å¤„ç†300ä¸‡ä¸ªé¡¶ç‚¹ï¼Œæ¯ä¸ªé¡¶ç‚¹è¯»å–12ä¸ªå­—èŠ‚ï¼Œå¹¶å†™å…¥4ä¸ªå­—èŠ‚ã€‚</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">æ€»å…±æœ‰100å¤šæ¬¡åˆ›æ–°è€…è¿è¡Œï¼Œæ­¤åŠŸèƒ½å¤„ç†18äº¿ä¸ªé¡¶ç‚¹ï¼Œè¯»å–21 GBï¼Œå›å†™7 GBã€‚åœ¨1.46ç§’å†…å¤„ç†28 GBéœ€è¦19 GB / sçš„æ€»çº¿å¸¦å®½ã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡è¿è¡Œæ¥æ£€æŸ¥å†…å­˜å¸¦å®½</font></font><code>memcmp(block1, block2, 512 MB)</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã€‚ç»“æœæ˜¯45æ¯«ç§’ï¼Œå³ä¸€ä¸ªå†…æ ¸çº¦22 GB / sï¼ˆå°½ç®¡AIDA64åŸºå‡†æµ‹è¯•æ˜¾ç¤ºæˆ‘çš„ç³»ç»Ÿä¸Šçš„è¯»å–é€Ÿåº¦é«˜è¾¾31 GB / sï¼Œä½†å®ƒä½¿ç”¨å¤šä¸ªå†…æ ¸ï¼‰ã€‚å®é™…ä¸Šï¼Œæˆ‘ä»¬å·²ç»æ¥è¿‘æœ€å¤§å¯è¾¾åˆ°çš„å†…å­˜é™åˆ¶ï¼Œå¹¶ä¸”è¦è¿›ä¸€æ­¥æé«˜æ€§èƒ½ï¼Œå°†éœ€è¦æ›´ç´§å¯†åœ°æ‰“åŒ…è¿™äº›é¡¶ç‚¹ï¼Œä»¥ä¾¿å®ƒä»¬å ç”¨çš„ç©ºé—´å°‘äº12ä¸ªå­—èŠ‚ã€‚</font></font><br><br><h1> ç»“è®º </h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">æˆ‘ä»¬é‡‡ç”¨äº†ä¸€ç§éå¸¸ä¼˜åŒ–çš„ç®—æ³•ï¼Œè¯¥ç®—æ³•ä»¥æ¯ç§’2800ä¸‡ä¸ªä¸‰è§’å½¢çš„é€Ÿåº¦ç®€åŒ–äº†éå¸¸å¤§çš„ç½‘æ ¼ï¼Œå¹¶ä½¿ç”¨SSEå’ŒAVXæŒ‡ä»¤é›†å°†å…¶é€Ÿåº¦å‡ ä¹æé«˜äº†ä¸¤å€ï¼Œè¾¾åˆ°äº†æ¯ç§’5000ä¸‡ä¸ªä¸‰è§’å½¢ã€‚åœ¨æ­¤è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬å¿…é¡»å­¦ä¹ ä½¿ç”¨SIMDçš„ä¸åŒæ–¹æ³•ï¼šç”¨äºå­˜å‚¨3-wideå‘é‡çš„å¯„å­˜å™¨ï¼ŒSoAæ¢ä½ï¼Œç”¨äºå­˜å‚¨ä¸¤ä¸ª3-wideå‘é‡çš„AVX2æŒ‡ä»¤ï¼Œä¸æ ‡é‡æŒ‡ä»¤ç›¸æ¯”ï¼Œæ”¶é›†æŒ‡ä»¤ä»¥åŠ å¿«æ•°æ®åŠ è½½ï¼Œæœ€åæˆ‘ä»¬ç›´æ¥å°†AVX2åº”ç”¨äºæµå¤„ç†ã€‚</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SIMDé€šå¸¸ä¸æ˜¯ä¼˜åŒ–çš„æœ€ä½³èµ·ç‚¹ï¼šç½‘æ ¼åˆç†åŒ–å™¨åœ¨ä¸ä½¿ç”¨ç‰¹å®šäºå¹³å°çš„æŒ‡ä»¤çš„æƒ…å†µä¸‹ç»å†äº†ç®—æ³•ä¼˜åŒ–å’Œå¾®ä¼˜åŒ–çš„è®¸å¤šè¿­ä»£ã€‚ä½†æ˜¯åœ¨æŸäº›æ—¶å€™ï¼Œè¿™äº›å¯èƒ½æ€§å·²è¢«ç©·å°½ï¼Œå¦‚æœæ€§èƒ½è‡³å…³é‡è¦ï¼Œé‚£ä¹ˆSIMDæ˜¯ä¸€ä¸ªå¾ˆæ£’çš„å·¥å…·ï¼Œå¯ä»¥åœ¨å¿…è¦æ—¶ä½¿ç”¨ã€‚</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">æˆ‘ä¸ç¡®å®šè¿™äº›ä¼˜åŒ–ä¸­çš„å“ªä¸€ä¸ªä¼šè½å…¥ä¸»åˆ†æ”¯</font></font><code>meshoptimizer</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ï¼šæœ€åï¼Œè¿™åªæ˜¯ä¸€ä¸ªå®éªŒï¼Œç›®çš„æ˜¯åœ¨ä¸å¤§å¹…æ”¹å˜ç®—æ³•çš„æƒ…å†µä¸‹æŸ¥çœ‹ä»£ç çš„è¶…é¢‘æƒ…å†µã€‚å¸Œæœ›æœ¬æ–‡å†…å®¹ä¸°å¯Œï¼Œå¹¶èƒ½ä¸ºæ‚¨æä¾›ä¼˜åŒ–ä»£ç çš„æƒ³æ³•ã€‚æœ¬æ–‡çš„æœ€ç»ˆèµ„æ–™</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">åœ¨è¿™é‡Œ</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ;è¿™é¡¹å·¥ä½œåŸºäº</font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;">meshoptimizer 99ab49</font></a><font style="vertical-align: inherit;">çš„ç‰ˆæœ¬</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ï¼Œè€Œæ³°å›½ä½›é™€æ¨¡å‹åˆ™</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">åœ¨Sketchfabä¸Šå‘å¸ƒ</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ã€‚</font></font></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN441536/">https://habr.com/ru/post/zh-CN441536/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN441526/index.html">æ¯”ç‰¹å¸ä»·å€¼çš„å› ç´ </a></li>
<li><a href="../zh-CN441528/index.html">æˆ‘çš„ç”Ÿæ´»å¦‚ä½•å˜æˆä¸€æœ¬å¡å¤«å¡ä¹¦</a></li>
<li><a href="../zh-CN441530/index.html">SDNå°†è¿›å…¥å¤ªç©ºï¼šä¸ºä»€ä¹ˆéœ€è¦è¿™æ ·åš</a></li>
<li><a href="../zh-CN441532/index.html">è™è é±¼ å¼•è¨€</a></li>
<li><a href="../zh-CN441534/index.html">ç¼–æ’ç³»ç»Ÿçš„è´Ÿè½½å‡è¡¡å™¨</a></li>
<li><a href="../zh-CN441538/index.html">æ•°æ®ä»“åº“æ¶æ„ï¼šä¼ ç»Ÿå’Œäº‘</a></li>
<li><a href="../zh-CN441540/index.html">Vue mixinsï¼Œæ˜¾å¼æ–¹å¼ï¼ˆé€šè¿‡BEMä¿®é¥°ç¬¦æ’ä»¶ç¤ºä¾‹ï¼‰</a></li>
<li><a href="../zh-CN441546/index.html">â€œ Hayabusa-2â€é¦–æ¬¡ç¢°åˆ°å°è¡Œæ˜Ÿ</a></li>
<li><a href="../zh-CN441550/index.html">ä¸€ä¸ªç®€å•çš„ç¨‹åºå‘˜çš„ç”Ÿæ´»æ˜¯è‰°éš¾è€Œå¹³æ·¡çš„</a></li>
<li><a href="../zh-CN441554/index.html">Linuxçš„æ•´ä¸ªå†å²ã€‚ ç¬¬ä¸€éƒ¨åˆ†ï¼šä¸€åˆ‡å¼€å§‹</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>