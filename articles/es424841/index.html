<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üè´ üë∏üèΩ üö∏ Almacene un archivo de im√°genes para un sitio en Azure BLOB Storage üßîüèø ü•ú ü§≠</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="El art√≠culo describe la experiencia de organizar el almacenamiento de presupuesto de un archivo de im√°genes para un sitio con millones de anuncios. 

...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Almacene un archivo de im√°genes para un sitio en Azure BLOB Storage</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/424841/"> El art√≠culo describe la experiencia de organizar el almacenamiento de presupuesto de un archivo de im√°genes para un sitio con millones de anuncios. <br><br><img src="https://habrastorage.org/webt/9c/_6/sg/9c_6sgzywejobg-vzsrzgazv7_w.png"><br><a name="habracut"></a><br>  En mi caso, las im√°genes se entienden como fotograf√≠as de apartamentos, casas, parcelas, etc.  Tengo mi <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">propio proyecto,</a> que es un sitio con anuncios para la venta y alquiler de bienes inmuebles.  El sitio ha existido durante aproximadamente 6 a√±os y durante este tiempo se ha acumulado una cantidad bastante grande de anuncios.  En cada tarjeta de objeto se muestran fotos, en promedio 8 fotos por anuncio.  En realidad, voy a almacenar estas fotos en la nube para luego mostrarlas a los visitantes en tarjetas de objetos. <br><br>  ¬øC√≥mo los almacen√© antes?  De ninguna manera.  No guard√© im√°genes, excepto las que se colocaron manualmente.  En la mayor√≠a de los casos, los anuncios llegan al sitio a trav√©s de socios mediante la carga autom√°tica de feeds.  En el feed de cada objeto hay enlaces a fotos: almaceno los enlaces y le doy al visitante una foto directamente del socio.  Este circuito funciona muy bien y ahorra una tonelada de recursos. <br><br>  Las fotos que los visitantes ven en la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">selecci√≥n de anuncios</a> o en la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">tarjeta del objeto en</a> realidad se cargan de recursos de terceros. <br><br>  Hay una advertencia relacionada con los detalles del sitio: los objetos de archivo nunca se eliminan.  Es decir  una vez que el anuncio se elimina de la publicaci√≥n, ciertamente desaparece de los resultados de b√∫squeda, pero el enlace directo siempre est√° disponible (sin los contactos del vendedor).  Durante alg√∫n tiempo, los enlaces a las fotograf√≠as siguen vivos, a veces durante a√±os, pero tarde o temprano mueren.  Los objetos archivados son valiosos porque los visitantes de los motores de b√∫squeda contin√∫an llegando a ellos.  Adem√°s, se <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">crea un mapa de precios a</a> partir del archivo (ya <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">escrib√≠ sobre √©l</a> ), y descubr√≠ accidentalmente una fuente adicional de ingresos para el proyecto en forma de venta de informaci√≥n de contacto de objetos de archivo.  No s√© con certeza por qu√© los compran, pero supongo que los visitantes quieren obtener contactos porque piensan que el anuncio fue eliminado de la publicaci√≥n por accidente o por error.  Tambi√©n es probable que quieran aprender algo de los propietarios anteriores.  De una forma u otra, es m√°s probable que se compre un anuncio con fotos en este caso.  El valor de las fotograf√≠as aumenta despu√©s de darse cuenta de este matiz. <br><br>  La cantidad de datos que voy a almacenar en la nube es de aproximadamente 3-4 terabytes.  Adem√°s de una ganancia diaria de varios gigabytes.  Dado que esta innovaci√≥n no traer√° dinero directamente, solo puede afectar indirectamente la toma de decisiones del visitante, el presupuesto en el que quer√≠a cumplir con uno muy modesto es 1000-2000 r.  por mes  Ser√≠a agradable de forma gratuita, pero no encontr√© esa oportunidad. <br><br><h2>  Azur </h2><br>  De alguna manera, inmediatamente mir√© hacia Azure porque trabajo en .net, y a menudo veo hermosos art√≠culos publicitarios sobre este tema.  Adem√°s, tengo que usar esta plataforma para mi trabajo principal, pero all√≠ mis capacidades est√°n limitadas por los requisitos del negocio y los deseos de la gerencia. <br><br>  Azure ofrece almacenamiento BLOB con tres niveles de almacenamiento: Hot, Cool y Archive.  Los precios en todos los niveles son diferentes.  En general, cuanto m√°s caliente, m√°s barata es la lectura / escritura y m√°s costosa la tarifa de almacenamiento mensual, y viceversa.  En caliente: es beneficioso escribir / leer y eliminar mucho, pero es costoso almacenarlo durante mucho tiempo.  El archivo es barato de almacenar pero caro de leer / escribir.  Adem√°s, en los niveles de archivo y fr√≠o, hay una tarifa por eliminaci√≥n anticipada; esto significa que si elimino (o transfiero a otro nivel) un objeto antes de un cierto per√≠odo, a√∫n se me cobrar√° por todo el per√≠odo.  Para el nivel de archivo, esto es 180 d√≠as, para el fr√≠o - 30. <br><br><h2>  Precios </h2><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">El costo de almacenamiento</a> es de $ 0.0023 por GB por mes a nivel de archivo, $ 0.01 en fr√≠o y $ 0.0196 en caliente.  A la tasa actual, esto es aproximadamente 0,15, 0,65 y 1,28 rublos, respectivamente. <br><br>  Comparado con el costo en Amazon y Google, resulta que Azure es m√°s barato. <br><br><table><tbody><tr><td></td><td>  <b><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Azur</a></b> </td><td>  <b><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Amazon (S3)</a></b> </td><td>  <b><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Google</a></b> </td></tr><tr><td>  <b>Caliente</b> </td><td>  $ 0.0196 </td><td>  $ 0.024 </td><td>  $ 0.026 </td></tr><tr><td>  <b>Genial</b> </td><td>  $ 0.01 </td><td>  $ 0.01 </td><td>  $ 0.01 </td></tr><tr><td>  <b>Archivo</b> </td><td>  $ 0.0023 </td><td>  $ 0.0045 </td><td>  $ 0.007 </td></tr></tbody></table><br><br>  Adem√°s del costo de almacenamiento, es necesario tener en cuenta el costo de las operaciones; tambi√©n son diferentes en todos los niveles.  Los precios son por 10,000 transacciones. <br><br>  <b>Caliente</b> <br>  Leer: $ 0.0043, Escribir: $ 0.054 <br><br>  <b>Genial</b> <br>  Leer: $ 0.01, Escribir: $ 0.10 <br><br>  <b>Archivo</b> <br>  Leer: $ 6, Escribir: $ 0.12 <br><br><h2>  L√≥gica de trabajo </h2><br><br>  Mientras el anuncio est√° activo, las fotos se muestran mediante enlaces de recursos de terceros (de socios).  Despu√©s de que el anuncio se elimina de la publicaci√≥n, se convierte en archivo, pero los enlaces a las fotograf√≠as siguen vivos por alg√∫n tiempo.  Tarde o temprano, mueren, y debe asegurarse de que para este momento haya una copia de archivo. <br><br>  El proceso de procesamiento de fotos se puede describir en los siguientes pasos: <br><br><ol><li>  Tan pronto como el anuncio desaparezca del archivo de importaci√≥n de socios, es decir  el socio dej√≥ de publicarlo, se forma una entrada en la cola de prioridad, donde la prioridad es la cantidad de visitas de los visitantes: cuantas m√°s vistas, m√°s probabilidades hay de que se archiven, el objeto se ver√° m√°s. </li><li>  Al procesar un registro desde la cola, se forma un objeto BLOB que contiene fotos reducidas (hasta 800x600) para el anuncio.  El uso de objetos compuestos en lugar de fotograf√≠as directas tambi√©n se debe al ahorro: en lugar de 8 operaciones de grabaci√≥n (un promedio de 8 fotos por objeto), se realiza una y cada operaci√≥n cuesta dinero. </li><li>  BLOB se carga primero en Hot, y luego se transfiere inmediatamente al archivo.  No hay posibilidad de escribir directamente en el archivo, y dado que Cool tiene una tarifa por eliminaci√≥n anticipada, es m√°s barato usar Hot como tr√°nsito. </li><li>  El archivo BLOB es siempre que los enlaces a las fotos originales est√©n activos (las fotos se muestran hasta ahora por enlaces de socios). </li><li>  Se verifica la funcionalidad de los enlaces cuando el visitante visita la tarjeta del objeto; si lo visita, entonces el objeto es popular y tiene sentido restaurar las fotos del archivo. </li><li>  Si los enlaces a las fotos originales han desaparecido, verifico si hay una copia de archivo, y si es as√≠, env√≠o una solicitud para restaurar desde el archivo a Cool (puede tomar hasta 15 horas restaurar un blob del archivo, esto se llama rehidrataci√≥n de Microsoft). </li><li>  Una vez que el BLOB ha sido restaurado del archivo, se copia al almacenamiento local y se divide en fotos normales.  El almacenamiento local es el disco duro de mi servidor. </li><li>  Las fotos en la tarjeta de anuncio ya est√°n dadas del almacenamiento local. </li><li>  Las fotos se almacenan en el almacenamiento local durante varios d√≠as.  Si durante este tiempo hubo escaneos, el per√≠odo de almacenamiento local se extiende.  Si no hubo vistas, las fotos se eliminan del almacenamiento local, pero permanecen en el nivel Cool en Azure. </li><li>  De Cool a Archive se copian si no hubo vistas durante dos meses: el objeto claramente no es popular y, en consecuencia, no tiene sentido pagar de m√°s por el almacenamiento en Cool. </li></ol><br><br><h2>  Primer lanzamiento </h2><br>  Cuando se escribi√≥ y prob√≥ el proceso, lleg√≥ el momento de la operaci√≥n de prueba y se esperaban problemas.  En la cola en ese momento hab√≠a alrededor de 10 millones de objetos, decid√≠ comenzar la migraci√≥n de 30,000 objetos por d√≠a.  Configurar hermosos gr√°ficos en el tablero y comenz√≥ a observar.  En estad√≠sticas, vi extra√±as "estocadas" con las solicitudes de GetBlobProperties.  Se producen con un intervalo aproximadamente igual de una hora, siempre comienzan aproximadamente una hora y media despu√©s del inicio de la migraci√≥n y duran un tiempo despu√©s de su finalizaci√≥n. <br><br><img src="https://habrastorage.org/webt/wm/qx/qr/wmqxqrsvn7zctu-xyulyvr-25wu.png"><br><br>  El n√∫mero de tales solicitudes era demasiado grande para ignorarlas.  Mir√© los registros y vi que estas solicitudes no provienen de mi servidor sino de direcciones IP extranjeras.  No quer√≠a pagar por ellos en absoluto. <br><br>  Busqu√© en la pila y en la documentaci√≥n, pero fue en vano.  Escribi√≥ una <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">pregunta sobre Stackoverflow</a> y soporte t√©cnico.  Como resultado, despu√©s de una larga correspondencia con el soporte t√©cnico y de proporcionarles registros, me dijeron que pueden reproducir la situaci√≥n y que esto es un error de su parte. <br><br>  Un matiz interesante es que mi pregunta sobre Stackoverflow fue respondida no explicando las razones, sino solo confirmando que pagar√© por estas solicitudes, pero la persona que dio la respuesta insistentemente me pidi√≥ que la marcara como correcta.  Tambi√©n me insinu√≥ de pasada que ellos (en apoyo) no son bienvenidos a difundir sobre los errores en sus propios productos.  Le hago saber que no lo har√© hasta que escriba la verdad.  Podr√≠a escribir esto yo mismo, pero pens√© que el personal de soporte t√©cnico probablemente midi√≥ el n√∫mero de respuestas confirmadas, as√≠ que le ped√≠ que escribiera la verdadera raz√≥n y en este caso marco su respuesta como correcta.  Despu√©s de algunas dudas, estuvo de acuerdo y complement√≥ su comentario con un informe de error.  En general, me gust√≥ c√≥mo funciona el soporte t√©cnico: incluso me transfirieron a una chica rusa que todav√≠a me mantiene al tanto de los cambios en este tema. <br><br>  El hecho de que se reconociera el error solo me satisfizo moralmente, pero quer√≠a poner en funcionamiento el mecanismo y, al mismo tiempo, no pagar dinero por las solicitudes de zurdos.  Especialmente teniendo en cuenta que normalmente me confund√≠ para minimizar el n√∫mero de solicitudes y, por lo tanto, el costo. <br><br>  En soporte t√©cnico, me aconsejaron que esperara con el lanzamiento y despu√©s de un par de semanas escribieron que el error se solucion√≥, pero cuando se publicar√° la soluci√≥n, no se sabe.  Ofrecieron habilitar el registro y trabajar as√≠, y despu√©s del lanzamiento, solicitar una compensaci√≥n en Microsoft.  En realidad, en este modo, todav√≠a funciona.  Todos los d√≠as comienzo una migraci√≥n de un peque√±o n√∫mero de objetos y espero el lanzamiento. <br><br><h2>  Conclusi√≥n </h2><br>  El costo de 30,000 objetos diarios sigue siendo 900 p.  por mes, y esto es bastante aceptable.  La mayor√≠a de los gastos son operaciones de escritura.  Entonces, cuando se procesa toda la cola y comienza la etapa de trabajo planificado, quedar√° claro cu√°l es el costo real de dicho almacenamiento.  Pero seg√∫n mis c√°lculos, esto suceder√° en aproximadamente un a√±o. <br><br>  Cuando haya una versi√≥n en Azure Blob-storage, agregar√© aqu√≠ si logr√© obtener una compensaci√≥n.  En cuanto a los gastos mensuales, esto es aproximadamente el 10% del costo. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/es424841/">https://habr.com/ru/post/es424841/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../es424823/index.html">C√≥mo la nutrici√≥n baja en calor√≠as afecta el envejecimiento</a></li>
<li><a href="../es424825/index.html">Robots y comunismo</a></li>
<li><a href="../es424827/index.html">La ilusi√≥n del espacio: c√≥mo el nuevo Spiderman renderiza habitaciones sin geometr√≠a</a></li>
<li><a href="../es424831/index.html">Lo que se invierte en la econom√≠a digital.</a></li>
<li><a href="../es424835/index.html">C√≥mo reducir el riesgo de inversi√≥n en bolsa: 3 factores de diversificaci√≥n</a></li>
<li><a href="../es424843/index.html">¬øIBOutlet es privado en sus aplicaciones de iOS?</a></li>
<li><a href="../es424845/index.html">C√°lculo de cuadrados m√°gicos usando una GPU</a></li>
<li><a href="../es424847/index.html">MNaaS y eSIM: ventajas y desventajas de la virtualizaci√≥n para operadores m√≥viles y sus clientes</a></li>
<li><a href="../es424849/index.html">Lo que hace que el nuevo UCS C480 ML M5 sea interesante: servidor de aprendizaje autom√°tico de Cisco</a></li>
<li><a href="../es424851/index.html">¬øQu√© hay de malo en contratar a TI?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>