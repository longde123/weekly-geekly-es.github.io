<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üçø ü§® üö¥üèª Seccomp bei Kubernetes: 7 Dinge, die Sie von Anfang an wissen m√ºssen üë®üèæ‚Äçüé§ üë©üèΩ‚Äçüíº üõ°Ô∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hinweis perev. : Pr√§sentation einer √úbersetzung eines Artikels eines erfahrenen Anwendungssicherheitsingenieurs bei der britischen Firma ASOS.com. Mit...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Seccomp bei Kubernetes: 7 Dinge, die Sie von Anfang an wissen m√ºssen</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/flant/blog/481114/"> <i><b>Hinweis</b></i>  <i><b>perev.</b></i>  <i>: Pr√§sentation einer √úbersetzung eines Artikels eines erfahrenen Anwendungssicherheitsingenieurs bei der britischen Firma ASOS.com.</i>  <i>Mit ihr beginnt er eine Reihe von Ver√∂ffentlichungen zur Verbesserung der Sicherheit in Kubernetes durch den Einsatz von Seccomp.</i>  <i>Wenn die Leser die Einf√ºhrung m√∂gen, werden wir dem Autor folgen und mit seinen zuk√ºnftigen Materialien zu diesem Thema fortfahren.</i> <br><br><img src="https://habrastorage.org/webt/-u/nv/vk/-unvvkiylrs9ucbym-l4bsobtr8.png"><br><br>  Dieser Artikel ist der erste einer Reihe von Ver√∂ffentlichungen zum Erstellen von Geheimprofilen im Geiste von SecDevOps, ohne auf Magie und Hexerei zur√ºckzugreifen.  Im ersten Teil werde ich √ºber die Grundlagen und internen Details der Implementierung von seccomp in Kubernetes sprechen. <br><br>  Das Kubernetes-√ñkosystem bietet eine Vielzahl von M√∂glichkeiten, um die Sicherheit und Isolierung von Containern zu gew√§hrleisten.  In diesem Artikel geht es um den sicheren Computermodus, auch als " <b>seccomp" bezeichnet</b> .  Das Wesentliche besteht darin, Systemaufrufe zu filtern, die f√ºr die Ausf√ºhrung von Containern verf√ºgbar sind. <a name="habracut"></a><br><br>  Warum ist das wichtig?  Ein Container ist nur ein Prozess, der auf einem bestimmten Computer ausgef√ºhrt wird.  Und es nutzt den Kernel auf einer Stufe mit anderen Anwendungen.  Wenn die Container Systemaufrufe durchf√ºhren k√∂nnten, w√ºrde Malware dies sehr bald ausnutzen, um die Isolation des Containers zu umgehen und andere Anwendungen zu beeinflussen: Informationen abfangen, Systemeinstellungen √§ndern usw. <br><br>  Die seccomp-Profile legen fest, welche Systemaufrufe zugelassen oder abgelehnt werden sollen.  Die Container-Laufzeit aktiviert sie beim Start, damit der Kernel ihre Ausf√ºhrung steuern kann.  Die Verwendung solcher Profile erm√∂glicht es Ihnen, den Angriffsvektor einzuschr√§nken und den Schaden zu reduzieren, wenn ein Programm im Container (dh Ihre Abh√§ngigkeiten oder deren Abh√§ngigkeiten) anf√§ngt, das zu tun, was es nicht tun darf. <br><br><h2>  Grundlagen verstehen </h2><br>  Das seccomp-Basisprofil enth√§lt drei Elemente: <code>defaultAction</code> , <code>architectures</code> (oder <code>archMap</code> ) und <code>syscalls</code> : <br><br><pre> <code class="json hljs">{ <span class="hljs-attr"><span class="hljs-attr">"defaultAction"</span></span>: <span class="hljs-string"><span class="hljs-string">"SCMP_ACT_ERRNO"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"architectures"</span></span>: [ <span class="hljs-string"><span class="hljs-string">"SCMP_ARCH_X86_64"</span></span>, <span class="hljs-string"><span class="hljs-string">"SCMP_ARCH_X86"</span></span>, <span class="hljs-string"><span class="hljs-string">"SCMP_ARCH_X32"</span></span> ], <span class="hljs-attr"><span class="hljs-attr">"syscalls"</span></span>: [ { <span class="hljs-attr"><span class="hljs-attr">"names"</span></span>: [ <span class="hljs-string"><span class="hljs-string">"arch_prctl"</span></span>, <span class="hljs-string"><span class="hljs-string">"sched_yield"</span></span>, <span class="hljs-string"><span class="hljs-string">"futex"</span></span>, <span class="hljs-string"><span class="hljs-string">"write"</span></span>, <span class="hljs-string"><span class="hljs-string">"mmap"</span></span>, <span class="hljs-string"><span class="hljs-string">"exit_group"</span></span>, <span class="hljs-string"><span class="hljs-string">"madvise"</span></span>, <span class="hljs-string"><span class="hljs-string">"rt_sigprocmask"</span></span>, <span class="hljs-string"><span class="hljs-string">"getpid"</span></span>, <span class="hljs-string"><span class="hljs-string">"gettid"</span></span>, <span class="hljs-string"><span class="hljs-string">"tgkill"</span></span>, <span class="hljs-string"><span class="hljs-string">"rt_sigaction"</span></span>, <span class="hljs-string"><span class="hljs-string">"read"</span></span>, <span class="hljs-string"><span class="hljs-string">"getpgrp"</span></span> ], <span class="hljs-attr"><span class="hljs-attr">"action"</span></span>: <span class="hljs-string"><span class="hljs-string">"SCMP_ACT_ALLOW"</span></span> } ] }</code> </pre> <br>  <i>( <a href="https://gist.github.com/pjbgf/ef974f57693bb193f39e8add8a7040d7">medium-basic-seccomp.json</a> )</i> <br><br>  <code>defaultAction</code> bestimmt das Standardschicksal eines Systemaufrufs, der nicht im Abschnitt <code>syscalls</code> ist.  Um die Aufgabe zu vereinfachen, konzentrieren wir uns auf zwei Hauptwerte, die verwendet werden: <br><br><ul><li>  <code>SCMP_ACT_ERRNO</code> - blockiert die Ausf√ºhrung eines Systemaufrufs, </li><li>  <code>SCMP_ACT_ALLOW</code> - erlaubt. </li></ul><br>  Der Abschnitt <code>architectures</code> listet die Zielarchitekturen auf.  Dies ist wichtig, da der Filter selbst, der auf Kernelebene angewendet wird, von den Kennungen der Systemaufrufe und nicht von deren Namen abh√§ngt, die im Profil registriert sind.  Vor der Verwendung ordnet die Container-Laufzeit diese Bezeichnern zu.  Der Punkt ist, dass Systemaufrufe abh√§ngig von der Systemarchitektur v√∂llig unterschiedliche IDs haben k√∂nnen.  Beispielsweise hat der <code>recvfrom</code> (der zum <code>recvfrom</code> Informationen von einem Socket verwendet wird) auf x64-Systemen die ID = 64 und auf x86 die ID = 517.  <a href="">Hier</a> finden Sie eine Liste aller Systemaufrufe f√ºr x86-x64-Architekturen. <br><br>  Der Abschnitt <code>syscalls</code> listet alle Systemaufrufe auf und gibt an, was mit ihnen zu tun ist.  Beispielsweise k√∂nnen Sie eine <code>defaultAction</code> <code>SCMP_ACT_ERRNO</code> , indem Sie <code>defaultAction</code> auf <code>SCMP_ACT_ERRNO</code> und <code>SCMP_ACT_ERRNO</code> Aufrufe f√ºr den Abschnitt <code>SCMP_ACT_ALLOW</code> .  Sie erlauben also nur Anrufe, die im Bereich <code>syscalls</code> registriert sind, und verbieten alle anderen.  F√ºr die Blacklist sollten Sie die <code>defaultAction</code> Werte und -Aktionen auf das Gegenteil √§ndern. <br><br>  Nun sollten ein paar Worte √ºber die Nuancen gesagt werden, die nicht so offensichtlich sind.  Beachten Sie, dass die folgenden Empfehlungen auf der Tatsache beruhen, dass Sie eine Reihe von Gesch√§ftsanwendungen in Kubernetes bereitstellen, und es f√ºr Sie wichtig ist, dass diese mit den geringsten Berechtigungen arbeiten. <br><br><h2>  1. AllowPrivilegeEscalation = false </h2><br>  Im <code>securityContext</code> Containers befindet sich ein <code>AllowPrivilegeEscalation</code> Parameter.  Wenn es auf <code>false</code> , beginnen die Container mit dem Bit <a href="https://www.kernel.org/doc/Documentation/prctl/no_new_privs.txt"><code>no_new_priv</code></a> das auf ( <code>on</code> ) gesetzt ist.  Die Bedeutung dieses Parameters ist aus dem Namen ersichtlich: Der Container kann keine neuen Prozesse mit h√∂heren Rechten als den vorhandenen starten. <br><br>  Ein Nebeneffekt dieses Parametersatzes auf <code>true</code> (Standardwert) ist, dass die Container-Laufzeit das seccomp-Profil zu Beginn des Startvorgangs anwendet.  Daher m√ºssen alle Systemaufrufe, die zum Starten der internen Prozesse der Laufzeit erforderlich sind (z. B. Festlegen von Benutzer- / Gruppen-IDs, L√∂schen einiger Funktionen), im Profil zul√§ssig sein. <br><br>  Der Container, der das banale <code>echo hi</code> ausf√ºhrt, ben√∂tigt die folgenden Berechtigungen: <br><br><pre> <code class="json hljs">{ <span class="hljs-attr"><span class="hljs-attr">"defaultAction"</span></span>: <span class="hljs-string"><span class="hljs-string">"SCMP_ACT_ERRNO"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"architectures"</span></span>: [ <span class="hljs-string"><span class="hljs-string">"SCMP_ARCH_X86_64"</span></span>, <span class="hljs-string"><span class="hljs-string">"SCMP_ARCH_X86"</span></span>, <span class="hljs-string"><span class="hljs-string">"SCMP_ARCH_X32"</span></span> ], <span class="hljs-attr"><span class="hljs-attr">"syscalls"</span></span>: [ { <span class="hljs-attr"><span class="hljs-attr">"names"</span></span>: [ <span class="hljs-string"><span class="hljs-string">"arch_prctl"</span></span>, <span class="hljs-string"><span class="hljs-string">"brk"</span></span>, <span class="hljs-string"><span class="hljs-string">"capget"</span></span>, <span class="hljs-string"><span class="hljs-string">"capset"</span></span>, <span class="hljs-string"><span class="hljs-string">"chdir"</span></span>, <span class="hljs-string"><span class="hljs-string">"close"</span></span>, <span class="hljs-string"><span class="hljs-string">"execve"</span></span>, <span class="hljs-string"><span class="hljs-string">"exit_group"</span></span>, <span class="hljs-string"><span class="hljs-string">"fstat"</span></span>, <span class="hljs-string"><span class="hljs-string">"fstatfs"</span></span>, <span class="hljs-string"><span class="hljs-string">"futex"</span></span>, <span class="hljs-string"><span class="hljs-string">"getdents64"</span></span>, <span class="hljs-string"><span class="hljs-string">"getppid"</span></span>, <span class="hljs-string"><span class="hljs-string">"lstat"</span></span>, <span class="hljs-string"><span class="hljs-string">"mprotect"</span></span>, <span class="hljs-string"><span class="hljs-string">"nanosleep"</span></span>, <span class="hljs-string"><span class="hljs-string">"newfstatat"</span></span>, <span class="hljs-string"><span class="hljs-string">"openat"</span></span>, <span class="hljs-string"><span class="hljs-string">"prctl"</span></span>, <span class="hljs-string"><span class="hljs-string">"read"</span></span>, <span class="hljs-string"><span class="hljs-string">"rt_sigaction"</span></span>, <span class="hljs-string"><span class="hljs-string">"statfs"</span></span>, <span class="hljs-string"><span class="hljs-string">"setgid"</span></span>, <span class="hljs-string"><span class="hljs-string">"setgroups"</span></span>, <span class="hljs-string"><span class="hljs-string">"setuid"</span></span>, <span class="hljs-string"><span class="hljs-string">"stat"</span></span>, <span class="hljs-string"><span class="hljs-string">"uname"</span></span>, <span class="hljs-string"><span class="hljs-string">"write"</span></span> ], <span class="hljs-attr"><span class="hljs-attr">"action"</span></span>: <span class="hljs-string"><span class="hljs-string">"SCMP_ACT_ALLOW"</span></span> } ] }</code> </pre> <br>  <i>( <a href="https://gist.github.com/pjbgf/018658f1aeea1ef696b451bde8c33a8f">hi-pod-seccomp.json</a> )</i> <br><br>  ... statt dieser: <br><br><pre> <code class="json hljs">{ <span class="hljs-attr"><span class="hljs-attr">"defaultAction"</span></span>: <span class="hljs-string"><span class="hljs-string">"SCMP_ACT_ERRNO"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"architectures"</span></span>: [ <span class="hljs-string"><span class="hljs-string">"SCMP_ARCH_X86_64"</span></span>, <span class="hljs-string"><span class="hljs-string">"SCMP_ARCH_X86"</span></span>, <span class="hljs-string"><span class="hljs-string">"SCMP_ARCH_X32"</span></span> ], <span class="hljs-attr"><span class="hljs-attr">"syscalls"</span></span>: [ { <span class="hljs-attr"><span class="hljs-attr">"names"</span></span>: [ <span class="hljs-string"><span class="hljs-string">"arch_prctl"</span></span>, <span class="hljs-string"><span class="hljs-string">"brk"</span></span>, <span class="hljs-string"><span class="hljs-string">"close"</span></span>, <span class="hljs-string"><span class="hljs-string">"execve"</span></span>, <span class="hljs-string"><span class="hljs-string">"exit_group"</span></span>, <span class="hljs-string"><span class="hljs-string">"futex"</span></span>, <span class="hljs-string"><span class="hljs-string">"mprotect"</span></span>, <span class="hljs-string"><span class="hljs-string">"nanosleep"</span></span>, <span class="hljs-string"><span class="hljs-string">"stat"</span></span>, <span class="hljs-string"><span class="hljs-string">"write"</span></span> ], <span class="hljs-attr"><span class="hljs-attr">"action"</span></span>: <span class="hljs-string"><span class="hljs-string">"SCMP_ACT_ALLOW"</span></span> } ] }</code> </pre> <br>  <i>( <a href="https://gist.github.com/pjbgf/7c860ad818e3724d65a96ffdae5da808">hi-container-seccomp.json</a> )</i> <br><br>  Aber warum ist das ein Problem?  Pers√∂nlich w√ºrde ich vermeiden, die folgenden Systemaufrufe auf die <code>capset</code> <code>set_tid_address</code> (wenn sie nicht wirklich ben√∂tigt werden): <code>capset</code> , <code>set_tid_address</code> , <code>setgid</code> , <code>setgroups</code> und <code>setuid</code> .  Die eigentliche Schwierigkeit besteht jedoch darin, dass Sie Profile an die Implementierung der Containerlaufzeit binden, indem Sie Prozesse zulassen, √ºber die Sie absolut keine Kontrolle haben.  Mit anderen Worten, eines Tages kann es vorkommen, dass die Container nach dem Aktualisieren der Laufzeitumgebung des Containers (von Ihnen oder, wahrscheinlicher, vom Cloud-Dienstanbieter) pl√∂tzlich nicht mehr gestartet werden. <br><br>  <b>Tipp 1</b> : F√ºhren Sie Container mit <code>AllowPrivilegeEscaltion=false</code> .  Dies reduziert die Gr√∂√üe von Seccomp-Profilen und macht sie weniger anf√§llig f√ºr √Ñnderungen in der Container-Laufzeit. <br><br><h2>  2. Festlegen von Seccomp-Profilen auf Containerebene </h2><br>  Das Seccomp-Profil kann auf Pod-Ebene festgelegt werden: <br><br><pre> <code class="plaintext hljs">annotations: seccomp.security.alpha.kubernetes.io/pod: "localhost/profile.json"</code> </pre> <br>  ... oder auf Containerebene: <br><br><pre> <code class="plaintext hljs">annotations: container.security.alpha.kubernetes.io/&lt;container-name&gt;: "localhost/profile.json"</code> </pre> <br>  <i>Bitte beachten Sie, dass sich die Syntax √§ndert, wenn Kubernetes seccomp <a href="https://github.com/kubernetes/enhancements/pull/1148">zu GA wird</a> (dieses Ereignis wird voraussichtlich in der n√§chsten Kubernetes-Version - 1.18 - ca. √ºbersetzt).</i> <br><br>  Nur wenige Leute wissen, dass Kubernetes immer einen <a href="https://github.com/kubernetes/kubernetes/issues/84623">Fehler hatte</a> , der dazu f√ºhrte, dass Seccomp-Profile auf den Pausencontainer angewendet wurden.  Die Laufzeit kompensiert diesen Nachteil teilweise, aber dieser Container verschwindet nicht aus den Pods, da er zur Konfiguration ihrer Infrastruktur verwendet wird. <br><br>  Das Problem ist, dass dieser Container immer mit <code>AllowPrivilegeEscalation=true</code> beginnt, was zu den in Absatz 1 <code>AllowPrivilegeEscalation=true</code> Problemen f√ºhrt. Dies kann nicht ge√§ndert werden. <br><br>  Wenn Sie seccomp-Profile auf Containerebene anwenden, vermeiden Sie diese √úberf√ºllung und k√∂nnen ein Profil erstellen, das f√ºr einen bestimmten Container ‚Äûgesch√§rft‚Äú wird.  Dies muss getan werden, bis die Entwickler den Fehler behoben haben und die neue Version (m√∂glicherweise 1.18?) F√ºr alle verf√ºgbar ist. <br><br>  <b>Tipp 2</b> : Legen Sie Seccomp-Profile auf Containerebene fest. <br><br>  In praktischer Hinsicht dient diese Regel in der Regel als universelle Antwort auf die Frage: "Warum wird mein Seccomp-Profil mit <code>docker run</code> , funktioniert aber nach der Bereitstellung in einem Kubernetes-Cluster nicht?" <br><br><h2>  3. Verwenden Sie Runtime / Default als letzten Ausweg </h2><br>  Kubernetes bietet zwei Optionen f√ºr integrierte Profile: <code>runtime/default</code> und <code>docker/default</code> .  Beide werden von der Container-Laufzeit implementiert, nicht von Kubernetes.  Sie k√∂nnen daher je nach verwendeter Laufzeit und Version unterschiedlich sein. <br><br>  Mit anderen Worten kann der Container infolge einer √Ñnderung der Laufzeit auf eine andere Gruppe von Systemaufrufen zugreifen, die er verwenden kann oder nicht.  Die meisten Laufzeiten verwenden <a href="">eine Docker-Implementierung</a> .  Wenn Sie dieses Profil verwenden m√∂chten, stellen Sie sicher, dass es zu Ihnen passt. <br><br>  Das <code>docker/default</code> ist seit Kubernetes 1.11 veraltet. Vermeiden Sie es daher, es zu verwenden. <br><br>  Meiner Meinung nach ist das <code>runtime/default</code> perfekt f√ºr den Zweck, f√ºr den es erstellt wurde: um Benutzer vor den Risiken zu sch√ºtzen, die mit der Ausf√ºhrung des <code>docker run</code> auf ihren Computern verbunden sind.  Wenn wir jedoch von Gesch√§ftsanwendungen sprechen, die in Kubernetes-Clustern ausgef√ºhrt werden, w√ºrde ich behaupten, dass ein solches Profil zu offen ist und Entwickler sich darauf konzentrieren sollten, Profile f√ºr ihre Anwendungen (oder Anwendungstypen) zu erstellen. <br><br>  <b>Tipp 3</b> : Erstellen Sie separate Profile f√ºr bestimmte Anwendungen.  Wenn dies nicht m√∂glich ist, bearbeiten Sie Profile f√ºr Anwendungstypen. Erstellen Sie beispielsweise ein erweitertes Profil, das alle Golang-Webanwendungs-APIs enth√§lt.  Verwenden Sie Runtime / Default nur als letzten Ausweg. <br><br>  In zuk√ºnftigen Ver√∂ffentlichungen werde ich Ihnen erkl√§ren, wie Sie secccomp-Profile im Sinne von SecDevOps erstellen, automatisieren und in Pipelines testen k√∂nnen.  Mit anderen Worten, Sie haben keine Entschuldigung, nicht f√ºr bestimmte Anwendungen zu Profilen zu wechseln. <br><br><h2>  4. Unbeschr√§nkt ist KEINE Option </h2><br>  Bei der <a href="https://www.cncf.io/blog/2019/08/06/open-sourcing-the-kubernetes-security-audit/">ersten Kubernetes-Sicherheits√ºberpr√ºfung</a> stellte sich heraus, dass <a href="https://github.com/kubernetes/kubernetes/issues/81115">seccomp</a> standardm√§√üig <a href="https://github.com/kubernetes/kubernetes/issues/81115">deaktiviert war</a> .  Wenn Sie also keine <code>PodSecurityPolicy</code> angeben, die sie im Cluster <code>PodSecurityPolicy</code> , <code>PodSecurityPolicy</code> alle Pods, f√ºr die das seccomp-Profil nicht definiert ist, im <code>seccomp=unconfined</code> . <br><br>  In diesem Modus zu arbeiten bedeutet, dass eine ganze Isolationsschicht verloren geht, was einen Cluster-Schutz bietet.  Dieser Ansatz wird von Sicherheitsexperten nicht empfohlen. <br><br>  <b>Tipp 4</b> : Kein Container in einem Cluster sollte im <code>seccomp=unconfined</code> , insbesondere in Produktionsumgebungen. <br><br><h2>  5. "√úberwachungsmodus" </h2><br>  Dieser Punkt gilt nicht nur f√ºr Kubernetes, sondern f√§llt auch in die Kategorie ‚ÄûWas Sie wissen sollten, bevor Sie beginnen‚Äú. <br><br>  So kam es, dass das Erstellen von Seccomp-Profilen immer ein heikles Gesch√§ft war und gr√∂√ütenteils auf Versuch und Irrtum beruhte.  Tatsache ist, dass Benutzer einfach nicht die M√∂glichkeit haben, sie in Produktionsumgebungen zu testen, ohne das Risiko einzugehen, dass die Anwendung gel√∂scht wird. <br><br>  Nach dem Aufkommen des Linux 4.14-Kernels wurde es m√∂glich, Teile des Profils im √úberwachungsmodus auszuf√ºhren und Informationen zu allen Systemaufrufen im Syslog aufzuzeichnen, diese jedoch nicht zu blockieren.  Sie k√∂nnen diesen Modus mit dem Parameter <code>SCMT_ACT_LOG</code> aktivieren: <br><br>  <i><b>SCMP_ACT_LOG</b> : seccomp hat keine Auswirkungen auf den Betrieb eines Threads, der einen Systemaufruf ausf√ºhrt, wenn er keiner <b>Filterregel</b> unterliegt. Informationen zum Systemaufruf werden jedoch protokolliert.</i> <br><br>  Hier ist eine Beispielstrategie f√ºr die Verwendung dieser Funktion: <br><br><ol><li>  Erforderliche Systemaufrufe zulassen </li><li>  Blockieren Sie Anrufsysteme, von denen bekannt ist, dass sie nicht n√ºtzlich sind. </li><li>  Notieren Sie Informationen zu allen anderen Anrufen im Protokoll. </li></ol><br>  Ein vereinfachtes Beispiel lautet wie folgt: <br><br><pre> <code class="plaintext hljs">{ "defaultAction": "SCMP_ACT_LOG", "architectures": [ "SCMP_ARCH_X86_64", "SCMP_ARCH_X86", "SCMP_ARCH_X32" ], "syscalls": [ { "names": [ "arch_prctl", "sched_yield", "futex", "write", "mmap", "exit_group", "madvise", "rt_sigprocmask", "getpid", "gettid", "tgkill", "rt_sigaction", "read", "getpgrp" ], "action": "SCMP_ACT_ALLOW" }, { "names": [ "add_key", "keyctl", "ptrace" ], "action": "SCMP_ACT_ERRNO" } ] }</code> </pre> <br>  <i>( <a href="https://gist.github.com/pjbgf/fa4f7a89937c486d940ac8ccf48379c9">medium-mixed-seccomp.json</a> )</i> <br><br>  Denken Sie jedoch daran, dass Sie alle Anrufe blockieren m√ºssen, von denen bekannt ist, dass sie nicht verwendet werden und dem Cluster m√∂glicherweise Schaden zuf√ºgen k√∂nnen.  Eine gute Grundlage f√ºr die Auflistung ist die offizielle <a href="https://docs.docker.com/engine/security/seccomp/">Docker-Dokumentation</a> .  Es wird ausf√ºhrlich erl√§utert, welche Systemaufrufe im Standardprofil blockiert sind und warum. <br><br>  Es gibt jedoch einen Haken.  Obwohl <code>SCMT_ACT_LOG</code> seit Ende 2017 vom Linux-Kernel unterst√ºtzt wird, ist es erst k√ºrzlich in das Kubernetes-√ñkosystem eingetreten.  Zur Verwendung dieser Methode ben√∂tigen Sie daher den Linux 4.14-Kernel und die runC-Version, die nicht <a href="https://github.com/opencontainers/runc/releases/tag/v1.0.0-rc9">√§lter</a> als <a href="https://github.com/opencontainers/runc/releases/tag/v1.0.0-rc9">v1.0.0-rc9 ist</a> . <br><br>  <b>Tipp Nr. 5</b> : Sie k√∂nnen ein √úberwachungsmodusprofil f√ºr Tests in der Produktion erstellen, indem Sie schwarze und wei√üe Listen kombinieren und alle Ausnahmen protokollieren. <br><br><h2>  6. Verwenden Sie Whitelists </h2><br>  Das Erstellen von Whitelists erfordert zus√§tzlichen Aufwand, da Sie jeden Anruf identifizieren m√ºssen, den die Anwendung m√∂glicherweise ben√∂tigt. Dieser Ansatz verbessert jedoch die Sicherheit erheblich: <br><br><blockquote>  <i>Es wird dringend empfohlen, den Whitelisting-Ansatz zu verwenden, da dieser einfacher und zuverl√§ssiger ist.</i>  <i>Die Blacklist muss jedes Mal aktualisiert werden, wenn ein potenziell gef√§hrlicher Systemaufruf (oder eine gef√§hrliche Markierung / Option, wenn sie in der Blacklist enthalten sind) hinzugef√ºgt wird.</i>  <i>Dar√ºber hinaus k√∂nnen Sie die Darstellung eines Parameters h√§ufig √§ndern, ohne sein Wesen zu √§ndern, und so die Einschr√§nkungen der Blacklist umgehen.</i> </blockquote><br>  F√ºr Go-Anwendungen habe ich ein spezielles Tool entwickelt, das die Anwendung begleitet und alle zur Laufzeit get√§tigten Aufrufe sammelt.  Zum Beispiel f√ºr die folgende Anwendung: <br><br><pre> <code class="go hljs"><span class="hljs-keyword"><span class="hljs-keyword">package</span></span> main <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> <span class="hljs-string"><span class="hljs-string">"fmt"</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { fmt.Println(<span class="hljs-string"><span class="hljs-string">"test"</span></span>) }</code> </pre> <br>  ... <code>gosystract</code> so <code>gosystract</code> : <br><br><pre> <code class="bash hljs">go install https://github.com/pjbgf/gosystract gosystract --template=<span class="hljs-string"><span class="hljs-string">'{{- range . }}{{printf "\"%s\",\n" .Name}}{{- end}}'</span></span> application-path</code> </pre> <br>  ... und erhalte folgendes Ergebnis: <br><br><pre> <code class="plaintext hljs">"sched_yield", "futex", "write", "mmap", "exit_group", "madvise", "rt_sigprocmask", "getpid", "gettid", "tgkill", "rt_sigaction", "read", "getpgrp", "arch_prctl",</code> </pre> <br>  Bisher ist dies nur ein Beispiel - Details zu den Werkzeugen werden weiter ausgef√ºhrt. <br><br>  <b>Tipp 6</b> : Lassen Sie nur Anrufe zu, die Sie wirklich ben√∂tigen, und blockieren Sie alle anderen. <br><br><h2>  7. Legen Sie den Grundstein (oder bereiten Sie sich auf unerwartetes Verhalten vor) </h2><br>  Der Kernel √ºberwacht die Einhaltung des Profils, unabh√§ngig davon, was Sie dort registriert haben.  Auch wenn das nicht ganz das ist, was ich wollte.  Wenn Sie beispielsweise den Zugriff auf Aufrufe wie <code>exit</code> oder <code>exit_group</code> , kann der Container den Auftrag nicht ordnungsgem√§√ü <code>exit_group</code> , und selbst ein einfacher Befehl wie <code>echo hi</code> ihn auf unbestimmte Zeit aus.  Als Ergebnis erhalten Sie eine hohe CPU-Auslastung im Cluster: <br><br><img src="https://habrastorage.org/webt/32/no/rt/32nortxic_d8czgqc5jnbzrb-ps.png"><br><br>  In solchen F√§llen kann das Dienstprogramm <code>strace</code> - es zeigt, wo das Problem liegen kann: <br><br><img src="https://habrastorage.org/webt/hg/l3/eh/hgl3ehuqz8a6eprrsycubq_n6hu.png"><br> <i><code>sudo strace -c -p 9331</code></i> <br> <br>  Stellen Sie sicher, dass die Profile alle Systemaufrufe enthalten, die die Anwendung w√§hrend der Ausf√ºhrung ben√∂tigt. <br><br>  <b>Tipp 7</b> : Achten Sie auf die kleinen Dinge und stellen Sie sicher, dass alle erforderlichen Systemaufrufe in der Positivliste enthalten sind. <br><br>  Damit endet der erste Teil einer Artikelserie √ºber die Verwendung von seccomp in Kubernetes im Sinne von SecDevOps.  In den folgenden Abschnitten wird erl√§utert, warum dies wichtig ist und wie der Prozess automatisiert werden kann. <br><br><h2>  PS vom √úbersetzer </h2><br>  Lesen Sie auch in unserem Blog: <br><br><ul><li>  " <a href="https://habr.com/ru/company/flant/blog/474012/">Sicherheit f√ºr Docker-Container</a> "; </li><li>  " <a href="https://habr.com/ru/company/flant/blog/465141/">33+ Kubernetes Security Tools</a> "; </li><li>  " <a href="https://habr.com/ru/company/flant/blog/440504/">Docker und Kubernetes in sicherheitsrelevanten Umgebungen</a> "; </li><li>  " <a href="https://habr.com/ru/company/flant/blog/436300/">9 Best Practices f√ºr Kubernetes-Sicherheit</a> ." </li></ul></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de481114/">https://habr.com/ru/post/de481114/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de481102/index.html">Plattform√ºbergreifende .NET UI-Toolkit-Version AvaloniaUI 0.9</a></li>
<li><a href="../de481104/index.html">Mischen von OpenJDK und NodeJS: Sprach√ºbergreifende Interaktionen und vertikale Architektur</a></li>
<li><a href="../de481106/index.html">Wie LANIT eine DIY-Sitcom in seinem B√ºro drehte</a></li>
<li><a href="../de481110/index.html">Playme VEGA review: Combo-Rekorder mit Touchscreen und Spiegelhalterung</a></li>
<li><a href="../de481112/index.html">Was sagt das Kaugummi-Alter von 5700 Jahren √ºber die Person aus, die es gekaut hat?</a></li>
<li><a href="../de481116/index.html">Automatisch Posts aus der VKontakte-Community in Discord ver√∂ffentlichen</a></li>
<li><a href="../de481118/index.html">Anonymous Santa Claus 2019-2020: Post mit Neujahrsgeschenken</a></li>
<li><a href="../de481120/index.html">Wo und wie werden Edgeserver eingesetzt?</a></li>
<li><a href="../de481122/index.html">PostgreSQL Antipatterns: √úbergeben von Mengen und Auswahlen an SQL</a></li>
<li><a href="../de481124/index.html">Tipps zum Schreiben von selbstdokumentierendem Code</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>