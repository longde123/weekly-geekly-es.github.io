<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ü§öüèø üï¥üèΩ üå®Ô∏è Une autre simulation de biblioth√®que üèÄ ü§ôüèæ üëàüèø</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Bon apr√®s-midi Je suis engag√© dans l'automatisation des tests. Comme tous les ing√©nieurs en automatisation, j'ai un ensemble de biblioth√®ques et d'out...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Une autre simulation de biblioth√®que</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/476904/"><p> Bon apr√®s-midi  Je suis engag√© dans l'automatisation des tests.  Comme tous les ing√©nieurs en automatisation, j'ai un ensemble de biblioth√®ques et d'outils que je choisis g√©n√©ralement pour √©crire des tests.  Mais p√©riodiquement, il existe des situations o√π aucune des biblioth√®ques connues ne peut r√©soudre le probl√®me avec le risque de rendre les autotests instables ou fragiles.  Dans cet article, je voudrais vous dire comment la t√¢che apparemment standard d'utilisation de mock'ov m'a amen√© √† √©crire mon module.  Je voudrais √©galement partager ma d√©cision et entendre des commentaires. </p><a name="habracut"></a><br><h1>  App </h1><br><p>  L'audit est l'un des secteurs n√©cessaires du secteur financier.  Les donn√©es doivent √™tre v√©rifi√©es r√©guli√®rement (rapprochement).  √Ä cet √©gard, l'application que j'ai test√©e est apparue.  Afin de ne pas parler de quelque chose d'abstrait, imaginons que notre √©quipe d√©veloppe une application pour le traitement des applications des messageries instantan√©es.  Pour chaque application, un √©v√©nement appropri√© doit √™tre cr√©√© dans elasticsearch.  L'application de v√©rification sera notre surveillance que les applications ne sont pas ignor√©es. </p><br><p>  Imaginez donc que nous ayons un syst√®me qui comprend les composants suivants: </p><br><ol><li>  Serveur de configuration.  Pour l'utilisateur, il s'agit d'un point d'entr√©e unique o√π il configure non seulement l'application pour v√©rification, mais √©galement d'autres composants du syst√®me. </li><li>  Application de v√©rification. </li><li>  Donn√©es des applications de traitement des applications stock√©es dans elasticsearch. </li><li>  Donn√©es de r√©f√©rence.  Le format des donn√©es d√©pend du messager avec lequel l'application est int√©gr√©e. </li></ol><br><h1>  D√©fi </h1><br><p>  Le test de l'automatisation dans ce cas semble assez simple: </p><br><ol><li>  Pr√©paration de l'environnement: <br><ul><li>  Elasticsearch est install√© avec une configuration minimale (en utilisant msi et la ligne de commande). </li><li>  Une application de v√©rification est install√©e. </li></ul></li><li>  Ex√©cution du test: <br><ul><li>  Une application de v√©rification est configur√©e. </li><li>  Elasticsearch est rempli de donn√©es de test pour le test correspondant (combien de demandes ont √©t√© trait√©es). </li><li>  L'application re√ßoit des donn√©es "de r√©f√©rence" du messager (combien d'applications √©taient cens√©es √™tre r√©ellement). </li><li>  Le verdict √©mis par la demande est v√©rifi√©: le nombre de demandes v√©rifi√©es avec succ√®s, le nombre de demandes manquantes, etc. </li></ul></li><li>  Nettoyage de l'environnement. </li></ol><br><p>  Le probl√®me est que nous testons la surveillance, mais pour la configurer, nous avons besoin des donn√©es du serveur de configuration.  Tout d'abord, l'installation et la configuration d'un serveur pour chaque ex√©cution est une op√©ration longue (il a sa propre base, par exemple).  Deuxi√®mement, je souhaite isoler les applications afin de simplifier la localisation des probl√®mes lors de la recherche d'un d√©faut.  En fin de compte, il a √©t√© d√©cid√© d'utiliser une maquette. </p><br><p>  Cela peut soulever la question: "Si nous nous moquons toujours du serveur, nous ne pouvons peut-√™tre pas passer du temps √† installer et remplir elasticsearch, mais remplacer mock?".  Mais encore, vous devez toujours vous rappeler que l'utilisation de la simulation offre de la flexibilit√©, mais ajoute une obligation de surveiller la pertinence du comportement de la simulation.  J'ai donc refus√© de remplacer elasticsearch: c'est assez simple √† installer et √† remplir. </p><br><h1>  Premi√®re maquette </h1><br><p> Le serveur envoie la configuration aux demandes GET de plusieurs mani√®res dans / configuration.  Nous sommes int√©ress√©s de deux mani√®res.  Le premier est <code>/configuration/data_cluster</code> avec la configuration du cluster </p><br><pre> <code class="json hljs">{ <span class="hljs-attr"><span class="hljs-attr">"host"</span></span>: <span class="hljs-string"><span class="hljs-string">"127.0.0.1"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"port"</span></span>: <span class="hljs-number"><span class="hljs-number">443</span></span>, <span class="hljs-attr"><span class="hljs-attr">"credentials"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"username"</span></span>: <span class="hljs-string"><span class="hljs-string">"user"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"password"</span></span>: <span class="hljs-string"><span class="hljs-string">"pass"</span></span> } }</code> </pre> <br><p>  La seconde est <code>/configuration/reconciliation</code> avec la configuration de l'application de forage </p><br><pre> <code class="json hljs">{ <span class="hljs-attr"><span class="hljs-attr">"reconciliation_interval"</span></span>: <span class="hljs-number"><span class="hljs-number">3600</span></span>, <span class="hljs-attr"><span class="hljs-attr">"configuration_update_interval"</span></span>: <span class="hljs-number"><span class="hljs-number">60</span></span>, <span class="hljs-attr"><span class="hljs-attr">"source"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"address"</span></span>: <span class="hljs-string"><span class="hljs-string">"file:///c:/path"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"credentials"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"username"</span></span>: <span class="hljs-string"><span class="hljs-string">"user"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"password"</span></span>: <span class="hljs-string"><span class="hljs-string">"pass"</span></span> } } }</code> </pre> <br><p>  La difficult√© est que vous devez pouvoir changer la r√©ponse du serveur pendant le test ou entre les tests afin de tester la fa√ßon dont l'application r√©pond aux changements de configuration, aux mots de passe incorrects, etc. </p><br><p>  Ainsi, les simulations statiques et les outils pour les simulations dans les tests unitaires (simulation, monkeypatch de pytest, etc.) ne fonctionneront pas pour nous.  J'ai trouv√© une grande biblioth√®que de <code>pretenders</code> que je pensais √™tre la bonne pour moi.  <a href="https://pretenders.readthedocs.io/en/latest/" title="Lire la documentation des pr√©tendants">Pretenders</a> offre la possibilit√© de cr√©er un serveur HTTP avec des r√®gles qui d√©terminent comment le serveur r√©pondra aux demandes.  Les r√®gles sont stock√©es dans des pr√©r√©glages, ce qui permet d'isoler les simulations pour diff√©rentes suites de tests.  Les pr√©r√©glages peuvent √™tre effac√©s et remplis √† nouveau, vous permettant de mettre √† jour les r√©ponses au besoin.  Il suffit d'√©lever le serveur lui-m√™me une fois lors de la pr√©paration de l'environnement: </p><br><pre> <code class="bash hljs">python -m pretenders.server.server --host 127.0.0.1 --port 8000</code> </pre> <br><p>  Et dans les tests, nous devons ajouter l'utilisation du client.  Dans le cas le plus simple, lorsque les r√©ponses sont compl√®tement cod√©es en dur dans les tests, cela peut ressembler √† ceci: </p><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> json <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> pytest <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> pretenders.client.http <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> HTTPMock <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> pretenders.common.constants <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> FOREVER @pytest.fixture <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">configuration_server_mock</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(request)</span></span></span><span class="hljs-function">:</span></span> mock = HTTPMock(host=<span class="hljs-string"><span class="hljs-string">"127.0.0.1"</span></span>, port=<span class="hljs-number"><span class="hljs-number">8000</span></span>, name=<span class="hljs-string"><span class="hljs-string">"server"</span></span>) request.addfinalizer(mock.reset) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> mock <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">test_something</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(configuration_server_mock)</span></span></span><span class="hljs-function">:</span></span> configuration_server_mock.when(<span class="hljs-string"><span class="hljs-string">"GET /configuration/data_cluster"</span></span>).reply( headers={<span class="hljs-string"><span class="hljs-string">"Content-Type"</span></span>: <span class="hljs-string"><span class="hljs-string">"application/json"</span></span>}, body=json.dumps({ <span class="hljs-string"><span class="hljs-string">"host"</span></span>: <span class="hljs-string"><span class="hljs-string">"127.0.0.1"</span></span>, <span class="hljs-string"><span class="hljs-string">"port"</span></span>: <span class="hljs-number"><span class="hljs-number">443</span></span>, <span class="hljs-string"><span class="hljs-string">"credentials"</span></span>: { <span class="hljs-string"><span class="hljs-string">"username"</span></span>: <span class="hljs-string"><span class="hljs-string">"user"</span></span>, <span class="hljs-string"><span class="hljs-string">"password"</span></span>: <span class="hljs-string"><span class="hljs-string">"pass"</span></span>, }, }), status=<span class="hljs-number"><span class="hljs-number">200</span></span>, times=FOREVER, ) configuration_server_mock.when(<span class="hljs-string"><span class="hljs-string">"GET /configuration/reconciliation"</span></span>).reply( headers={<span class="hljs-string"><span class="hljs-string">"Content-Type"</span></span>: <span class="hljs-string"><span class="hljs-string">"application/json"</span></span>}, body=json.dumps({ <span class="hljs-string"><span class="hljs-string">"reconciliation_interval"</span></span>: <span class="hljs-number"><span class="hljs-number">3600</span></span>, <span class="hljs-string"><span class="hljs-string">"configuration_update_interval"</span></span>: <span class="hljs-number"><span class="hljs-number">60</span></span>, <span class="hljs-string"><span class="hljs-string">"source"</span></span>: { <span class="hljs-string"><span class="hljs-string">"address"</span></span>: <span class="hljs-string"><span class="hljs-string">"file:///c:/path"</span></span>, <span class="hljs-string"><span class="hljs-string">"credentials"</span></span>: { <span class="hljs-string"><span class="hljs-string">"username"</span></span>: <span class="hljs-string"><span class="hljs-string">"user"</span></span>, <span class="hljs-string"><span class="hljs-string">"password"</span></span>: <span class="hljs-string"><span class="hljs-string">"pass"</span></span>, }, }, }), status=<span class="hljs-number"><span class="hljs-number">200</span></span>, times=FOREVER, ) <span class="hljs-comment"><span class="hljs-comment"># test application</span></span></code> </pre> <br><p>  Mais ce n'est pas tout.  Avec sa flexibilit√©, les <code>pretenders</code> ont deux limites qui doivent √™tre rappel√©es et doivent √™tre abord√©es dans notre cas: </p><br><ol><li>  Les r√®gles ne peuvent pas √™tre supprim√©es une par une.  Pour modifier la r√©ponse, vous devez supprimer l'int√©gralit√© du pr√©r√©glage et recr√©er √† nouveau toutes les r√®gles. </li><li>  Tous les chemins utilis√©s dans les r√®gles sont relatifs.  Les pr√©r√©glages ont un chemin unique de la forme / mockhttp / &lt;nom_pr√©set&gt;, et ce chemin est un pr√©fixe commun pour tous les chemins cr√©√©s dans les r√®gles.  L'application test√©e ne re√ßoit que le nom d'h√¥te et ne peut pas conna√Ætre le pr√©fixe. </li></ol><br><p>  La premi√®re limitation est tr√®s d√©sagr√©able, mais peut √™tre r√©solue en √©crivant un module qui encapsule le travail avec la configuration.  Par exemple, </p><br><pre> <code class="python hljs">configuration.data_cluster.port = <span class="hljs-number"><span class="hljs-number">443</span></span></code> </pre> <br><p>  ou (pour effectuer des demandes de mise √† jour moins fr√©quemment) </p><br><pre> <code class="python hljs">data_cluster_config = get_default_data_cluster_config() data_cluster_config.port = <span class="hljs-number"><span class="hljs-number">443</span></span> configuration.update_data_cluster(data_cluster_config)</code> </pre> <br><p>  Une telle encapsulation nous permet de mettre √† jour tous les chemins presque sans douleur.  Vous pouvez √©galement cr√©er un pr√©r√©glage individuel pour chaque point de terminaison individuel et un pr√©r√©glage g√©n√©ral (principal), redirigeant (via 307 ou 308) vers des points individuels.  Ensuite, vous ne pouvez effacer qu'un seul pr√©r√©glage pour mettre √† jour la r√®gle. </p><br><p>  Afin de vous d√©barrasser des pr√©fixes, vous pouvez utiliser la biblioth√®que <a href="https://mitmproxy.org/" title="Acc√©der au site Web mitmproxy">mitmproxy</a> .  Il s'agit d'un outil puissant qui permet, entre autres, de rediriger les demandes.  Nous supprimerons les pr√©fixes comme suit: </p><br><pre> <code class="bash hljs">mitmdump --mode reverse:http://127.0.0.1:8000 --replacements :~http:^/:/mockhttp/server/ --listen-host 127.0.01 --listen-port 80</code> </pre> <br><p>  Les param√®tres de cette commande proc√®dent comme suit: </p><br><ol><li>  <code>--listen-host 127.0.0.1</code> et <code>--listen-port 80</code> √©vidents.  Mitmproxy √©l√®ve son serveur, et avec ces param√®tres, nous d√©terminons l'interface et le port que ce serveur √©coutera. </li><li>  <code>--mode reverse:http://127.0.0.1:8000</code> signifie que les requ√™tes vers le serveur mitproxy seront redirig√©es vers <code>http://127.0.0.1:8000</code> .  Lisez plus <a href="https://docs.mitmproxy.org/stable/concepts-modes/" title="Documentation des diff√©rents modes">ici</a> . </li><li>  <code>--replacements :~http:^/:/mockhttp/server/</code> d√©finit un mod√®le par lequel les requ√™tes seront modifi√©es.  Il se compose de trois parties: un filtre de requ√™te ( <code>~http</code> pour les requ√™tes HTTP), un mod√®le pour changer ( <code>^/</code> pour remplacer le d√©but du chemin), et r√©ellement remplacer ( <code>/mockhttp/server</code> ).  Lisez plus <a href="https://docs.mitmproxy.org/stable/overview-features/" title="Documentation sur les fonctionnalit√©s">ici</a> . </li></ol><br><p>  Dans notre cas, nous ajoutons <code>mockhttp/server</code> √† toutes les requ√™tes HTTP et les redirigeons vers <code>http://127.0.0.1:8000</code> , c'est-√†-dire  √† nos pr√©tendants serveurs.  En cons√©quence, nous avons r√©alis√© que maintenant la configuration peut √™tre obtenue avec une requ√™te GET √† <code>http://127.0.0.1/configuration/data_cluster</code> . </p><br><p>  En g√©n√©ral, j'√©tais satisfait du design avec des <code>pretenders</code> et <code>mitmproxy</code> .  Malgr√© la complexit√© apparente - apr√®s tout, 2 serveurs au lieu d'un seul - la pr√©paration consiste √† installer 2 packages et √† ex√©cuter 2 commandes sur la ligne de commande pour les d√©marrer.  Tout n'est pas aussi simple dans la gestion d'une maquette, mais toute la complexit√© r√©side dans un seul endroit (gestion des pr√©r√©glages) et est r√©solue de mani√®re assez simple et fiable.  Cependant, de nouvelles circonstances sont apparues dans le probl√®me qui m'a fait r√©fl√©chir √† une nouvelle solution. </p><br><h1>  Deuxi√®me maquette </h1><br><p>  Jusqu'√† ce moment, je n'ai presque pas dit d'o√π venaient les donn√©es de r√©f√©rence.  Un lecteur attentif peut remarquer que dans l'exemple ci-dessus, le chemin d'acc√®s au syst√®me de fichiers est utilis√© comme adresse de source de donn√©es.  Et cela fonctionne vraiment quelque chose comme √ßa, mais seulement pour l'un des fournisseurs.  Un autre fournisseur propose une API pour la r√©ception des candidatures, et c'est avec lui qu'un probl√®me est survenu.  Il est difficile de faire monter l'API du fournisseur pendant les tests, j'ai donc pr√©vu de la remplacer par une maquette selon le m√™me sch√©ma qu'auparavant.  Mais pour recevoir les candidatures, une demande du formulaire </p><br><pre> <code class="plaintext hljs">GET /application-history?page=2&amp;size=5&amp;start=1569148012&amp;end=1569148446</code> </pre> <br><p>  Il y a 2 points ici.  Tout d'abord, quelques options.  Le fait est que les param√®tres peuvent √™tre sp√©cifi√©s dans n'importe quel ordre, ce qui complique consid√©rablement l'expression r√©guli√®re de la r√®gle des <code>pretenders</code> .  Il est √©galement n√©cessaire de se rappeler que les param√®tres sont facultatifs, mais ce n'est pas un probl√®me tel que l'ordre al√©atoire.  Deuxi√®mement, les derniers param√®tres (d√©but et fin) sp√©cifient l'intervalle de temps pour filtrer la commande.  Et le probl√®me dans ce cas est que nous ne pouvons pas pr√©dire √† l'avance quel intervalle (pas l'ampleur, mais l'heure de d√©but) sera utilis√© par l'application pour former la r√©ponse factice.  Autrement dit, nous devons conna√Ætre et utiliser les valeurs des param√®tres pour former une r√©ponse ¬´raisonnable¬ª.  La ¬´raisonnabilit√©¬ª dans ce cas est importante, par exemple, pour que nous puissions tester que l'application parcourt toutes les pages de la pagination: si nous r√©pondons √† toutes les demandes de la m√™me mani√®re, nous ne pourrons pas trouver de d√©fauts car une seule page sur cinq est demand√©e . </p><br><p>  J'ai essay√© de chercher des solutions alternatives, mais j'ai finalement d√©cid√© d'√©crire la mienne.  Il y avait donc un <a href="https://github.com/KillAChicken/loose-server" title="Acc√©dez au r√©f√©rentiel et √† la documentation">serveur l√¢che</a> .  Il s'agit d'une application <a href="https://palletsprojects.com/p/flask/" title="Acc√©der √† la page du projet">Flask</a> dans laquelle les chemins et les r√©ponses peuvent √™tre configur√©s apr√®s son d√©marrage.  Hors de la bo√Æte, il sait comment travailler avec des r√®gles pour le type de demande (GET, POST, etc.) et pour le chemin.  Cela vous permet de remplacer les <code>pretenders</code> et <code>mitmproxy</code> dans la t√¢che d'origine.  Je montrerai √©galement comment il peut √™tre utilis√© pour cr√©er une maquette pour l'API du fournisseur. </p><br><p>  Une application a besoin de 2 chemins principaux: </p><br><ol><li>  Point final de base.  Il s'agit du m√™me pr√©fixe qui sera utilis√© pour toutes les r√®gles configur√©es. </li><li>  Point de terminaison de configuration.  Il s'agit du pr√©fixe de ces requ√™tes avec lesquelles vous pouvez configurer le faux serveur lui-m√™me. </li></ol><br><pre> <code class="bash hljs">python -m looseserver.default.server.run --host 127.0.0.1 --port 80 --base-endpoint / --configuration-endpoint /_mock_configuration/</code> </pre> <br><p>  En g√©n√©ral, il est pr√©f√©rable de ne pas configurer le point de terminaison de base et le point de terminaison de configuration de sorte que l'un soit le parent de l'autre.  Sinon, il existe un risque de conflit entre les chemins de configuration et de test.  Le point de terminaison de configuration aura la priorit√©, car les r√®gles de flacon sont ajout√©es pour la configuration plus t√¥t que pour les chemins dynamiques.  Dans notre cas, nous pourrions utiliser <code>--base-endpoint /configuration/</code> si nous <code>--base-endpoint /configuration/</code> pas inclure l'API du fournisseur dans cette maquette. </p><br><p>  La version la plus simple des tests ne change pas grand-chose </p><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> json <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> pytest <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> looseserver.default.client.http <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> HTTPClient <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> looseserver.default.client.rule <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> PathRule <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> looseserver.default.client.response <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> FixedResponse @pytest.fixture <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">configuration_server_mock</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(request)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MockFactory</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__init__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> self._client = HTTPClient(configuration_url=<span class="hljs-string"><span class="hljs-string">"http://127.0.0.1/_mock_configuration/"</span></span>) self._rule_ids = [] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">create_rule</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, path, json_response)</span></span></span><span class="hljs-function">:</span></span> rule = self._client.create_rule(PathRule(path=path)) self._rule_ids.append(rule.rule_id) response = FixedResponse( headers={<span class="hljs-string"><span class="hljs-string">"Content-Type"</span></span>: <span class="hljs-string"><span class="hljs-string">"application/json"</span></span>}, status=<span class="hljs-number"><span class="hljs-number">200</span></span>, body=json.dumps(json_response), ) self._client.set_response(rule_id=rule.rule_id, response=response) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">_delete_rules</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> rule_id <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> self._rule_ids: self._client.remove_rule(rule_id=rule_id) mock = MockFactory() request.addfinalizer(mock._delete_rules) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> mock <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">test_something</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(configuration_server_mock)</span></span></span><span class="hljs-function">:</span></span> configuration_server_mock.create_rule( path=<span class="hljs-string"><span class="hljs-string">"configuration/data_cluster"</span></span>, json_response={ <span class="hljs-string"><span class="hljs-string">"host"</span></span>: <span class="hljs-string"><span class="hljs-string">"127.0.0.1"</span></span>, <span class="hljs-string"><span class="hljs-string">"port"</span></span>: <span class="hljs-number"><span class="hljs-number">443</span></span>, <span class="hljs-string"><span class="hljs-string">"credentials"</span></span>: { <span class="hljs-string"><span class="hljs-string">"username"</span></span>: <span class="hljs-string"><span class="hljs-string">"user"</span></span>, <span class="hljs-string"><span class="hljs-string">"password"</span></span>: <span class="hljs-string"><span class="hljs-string">"pass"</span></span>, }, } ) configuration_server_mock.create_rule( path=<span class="hljs-string"><span class="hljs-string">"configuration/reconciliation"</span></span>, json_response={ <span class="hljs-string"><span class="hljs-string">"reconciliation_interval"</span></span>: <span class="hljs-number"><span class="hljs-number">3600</span></span>, <span class="hljs-string"><span class="hljs-string">"configuration_update_interval"</span></span>: <span class="hljs-number"><span class="hljs-number">60</span></span>, <span class="hljs-string"><span class="hljs-string">"source"</span></span>: { <span class="hljs-string"><span class="hljs-string">"address"</span></span>: <span class="hljs-string"><span class="hljs-string">"file:///applications"</span></span>, <span class="hljs-string"><span class="hljs-string">"credentials"</span></span>: { <span class="hljs-string"><span class="hljs-string">"username"</span></span>: <span class="hljs-string"><span class="hljs-string">"user"</span></span>, <span class="hljs-string"><span class="hljs-string">"password"</span></span>: <span class="hljs-string"><span class="hljs-string">"pass"</span></span>, }, }, } )</code> </pre> <br><p>  Le montage est devenu plus difficile, mais les r√®gles peuvent maintenant √™tre supprim√©es une par une, ce qui simplifie le travail avec elles.  L'utilisation de <code>mitmproxy</code> n'est plus n√©cessaire. </p><br><p>  Revenons √† l'API du fournisseur.  Nous allons cr√©er un nouveau type de r√®gles pour un serveur libre, qui, selon la valeur du param√®tre, donnera des r√©ponses diff√©rentes.  Ensuite, nous utiliserons cette r√®gle pour le param√®tre de page. </p><br><p>  De nouvelles r√®gles et r√©ponses doivent √™tre cr√©√©es pour le serveur et le client.  Commen√ßons par le serveur: </p><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> looseserver.server.rule <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> ServerRule <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ServerParameterRule</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(ServerRule)</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__init__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, parameter_name, parameter_value=None, rule_type=</span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"PARAMETER"</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function">:</span></span> super(ServerParameterRule, self).__init__(rule_type=rule_type) self._parameter_name = parameter_name self._parameter_value = parameter_value <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">is_match_found</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, request)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> self._parameter_value <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> <span class="hljs-keyword"><span class="hljs-keyword">None</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> self._parameter_name <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> request.args <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> request.args.get(self._parameter_name) == self._parameter_value</code> </pre> <br><p>  Chaque r√®gle doit d√©finir une m√©thode <code>is_match_found</code> , qui d√©termine si elle doit fonctionner pour une demande donn√©e ou non.  Le param√®tre d'entr√©e correspondant est l'objet de requ√™te.  Une fois la nouvelle r√®gle cr√©√©e, il est n√©cessaire ¬´d'apprendre¬ª au serveur √† l'accepter du client.  Pour ce faire, utilisez <code>RuleFactory</code> : </p><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> looseserver.default.server.rule <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> create_rule_factory <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> looseserver.default.server.application <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> configure_application <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">_create_application</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(base_endpoint, configuration_endpoint)</span></span></span><span class="hljs-function">:</span></span> server_rule_factory = create_rule_factory(base_endpoint) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">_parse_param_rule</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(rule_type, parameters)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ServerParameterRule( rule_type=rule_type, parameter_name=parameters[<span class="hljs-string"><span class="hljs-string">"parameter_name"</span></span>], parameter_value=parameters[<span class="hljs-string"><span class="hljs-string">"parameter_value"</span></span>], ) server_rule_factory.register_rule( rule_type=<span class="hljs-string"><span class="hljs-string">"PARAMETER"</span></span>, parser=_parse_param_rule, serializer=<span class="hljs-keyword"><span class="hljs-keyword">lambda</span></span> rule_type, rule: <span class="hljs-keyword"><span class="hljs-keyword">None</span></span>, ) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> configure_application( rule_factory=server_rule_factory, base_endpoint=base_endpoint, configuration_endpoint=configuration_endpoint, ) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> __name__ == <span class="hljs-string"><span class="hljs-string">"__main__"</span></span>: application = _create_application(base_endpoint=<span class="hljs-string"><span class="hljs-string">"/"</span></span>, configuration_endpoint=<span class="hljs-string"><span class="hljs-string">"/_mock_configuration"</span></span>) application.run(host=<span class="hljs-string"><span class="hljs-string">"127.0.0.1"</span></span>, port=<span class="hljs-number"><span class="hljs-number">80</span></span>)</code> </pre> <br><p>  Ici, nous cr√©ons une fabrique pour les r√®gles par d√©faut, afin qu'elle contienne les r√®gles que nous avons utilis√©es auparavant, et enregistrons un nouveau type.  Dans ce cas, le client n'a pas besoin des informations de r√®gle, le <code>serializer</code> ne fait donc rien.  De plus, cette usine est transf√©r√©e √† l'application.  Et il peut d√©j√† √™tre ex√©cut√© comme une application Flask standard. </p><br><p>  La situation avec le client est similaire: nous cr√©ons une r√®gle et une usine.  Mais pour le client, d'une part, il n'est pas n√©cessaire de d√©finir la m√©thode <code>is_match_found</code> , et d'autre part, le s√©rialiseur dans ce cas est n√©cessaire pour envoyer la r√®gle au serveur. </p><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> looseserver.client.rule <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> ClientRule <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> looseserver.default.client.rule <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> create_rule_factory <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ClientParameterRule</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(ClientRule)</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__init__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, parameter_name, parameter_value=None, rule_type=</span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"PARAMETER"</span></span></span></span><span class="hljs-function"><span class="hljs-params">, rule_id=None)</span></span></span><span class="hljs-function">:</span></span> super(ClientParameterRule, self).__init__(rule_type=rule_type, rule_id=rule_id) self.parameter_name = parameter_name self.parameter_value = parameter_value <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">_create_client</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(configuration_url)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">_serialize_param_rule</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(rule)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> { <span class="hljs-string"><span class="hljs-string">"parameter_name"</span></span>: rule.parameter_name, <span class="hljs-string"><span class="hljs-string">"parameter_value"</span></span>: rule.parameter_value, } client_rule_factory = create_rule_factory() client_rule_factory.register_rule( rule_type=<span class="hljs-string"><span class="hljs-string">"PARAMETER"</span></span>, parser=<span class="hljs-keyword"><span class="hljs-keyword">lambda</span></span> rule_type, parameters: ClientParameterRule(rule_type=rule_type, parameter_name=<span class="hljs-keyword"><span class="hljs-keyword">None</span></span>), serializer=_serialize_param_rule, ) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> HTTPClient(configuration_url=configuration_url, rule_factory=client_rule_factory)</code> </pre> <br><p>  Il reste √† utiliser <code>_create_client</code> pour cr√©er le client, et les r√®gles peuvent √™tre utilis√©es dans les tests.  Dans l'exemple ci-dessous, j'ai ajout√© l'utilisation d'une autre r√®gle par d√©faut: <code>CompositeRule</code> .  Il vous permet de combiner plusieurs r√®gles en une seule pour qu'elles ne fonctionnent que si chacune d'elles renvoie True pour avoir appel√© <code>is_match_found</code> . </p><br><pre> <code class="python hljs"><span class="hljs-meta"><span class="hljs-meta">@pytest.fixture def configuration_server_mock(request): class MockFactory: def __init__(self): self._client = _create_client("http://127.0.0.1/_mock_configuration/") self._rule_ids = [] def create_paged_rule(self, path, page, json_response): rule_prototype = CompositeRule( children=[ PathRule(path=path), ClientParameterRule(parameter_name="page", parameter_value=page), ] ) rule = self._client.create_rule(rule_prototype) self._rule_ids.append(rule.rule_id) response = FixedResponse( headers={"Content-Type": "application/json"}, status=200, body=json.dumps(json_response), ) self._client.set_response(rule_id=rule.rule_id, response=response) ... mock = MockFactory() request.addfinalizer(mock._delete_rules) return mock def test_something(configuration_server_mock): ... configuration_server_mock.create_paged_rule( path="application-history", page=None, json_response=["1", "2", "3"], ) configuration_server_mock.create_paged_rule( path="application-history", page="1", json_response=["1", "2", "3"], ) configuration_server_mock.create_paged_rule( path="application-history", page="2", json_response=["4", "5"], )</span></span></code> </pre> <br><h1>  Conclusion </h1><br><p>  Une <code>mitmproxy</code> <code>pretenders</code> et de <code>mitmproxy</code> fournit un outil suffisamment puissant et flexible pour cr√©er des simulations.  Ses avantages: </p><br><ol><li>  Configuration facile. </li><li>  Possibilit√© d'isoler des ensembles de requ√™tes √† l'aide de pr√©r√©glages. </li><li>  Supprime un ensemble isol√© entier √† la fois. </li></ol><br><p>  Par contre inclure: </p><br><ol><li>  La n√©cessit√© de cr√©er des expressions r√©guli√®res pour les r√®gles. </li><li>  L'incapacit√© de changer les r√®gles individuellement. </li><li>  La pr√©sence d'un pr√©fixe pour tous les chemins cr√©√©s ou l'utilisation de la redirection √† l'aide de <code>mitmproxy</code> . </li></ol><br><p>  Liens de documentation: <br>  <a href="https://pretenders.readthedocs.io/en/latest/">Pr√©tendants</a> <br>  <a href="https://docs.mitmproxy.org/stable/">Mitmproxy</a> <br>  <a href="https://github.com/KillAChicken/loose-server/wiki">Serveur l√¢che</a> </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr476904/">https://habr.com/ru/post/fr476904/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr476880/index.html">Berceaux de s√©curit√©: CSRF</a></li>
<li><a href="../fr476888/index.html">Quelles tendances UX-design suivre en 2020</a></li>
<li><a href="../fr476890/index.html">Pour ceux qui travaillent chez Houdini. √Ä propos des cours Nature of Vex et Bites of Python</a></li>
<li><a href="../fr476900/index.html">Dispositif autonome sur Arduino, signalant une augmentation (diminution) de la temp√©rature</a></li>
<li><a href="../fr476902/index.html">Barrymore, quel est le buzz autour de Voximplant? Sockets Web impl√©ment√©s, monsieur</a></li>
<li><a href="../fr476906/index.html">Nouveaut√©s de SOLIDWORKS 2020</a></li>
<li><a href="../fr476908/index.html">Hadoop est-il mort? 2e partie</a></li>
<li><a href="../fr476910/index.html">Antiquit√©s: un choix difficile de carte son pour les jeux DOS</a></li>
<li><a href="../fr476912/index.html">Droits des soci√©t√©s sur les programmeurs</a></li>
<li><a href="../fr476914/index.html">Installer le module Powershell √† partir du r√©f√©rentiel Github</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>