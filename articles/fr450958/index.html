<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üöí ‚¨ÖÔ∏è üë®üèø‚Äçü§ù‚Äçüë®üèæ AnyStub, biblioth√®que de stub de connexion Java üíÖ üë®üèø‚Äçüî¨ üë®üèº‚Äçüè´</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Contrairement √† de nombreuses plates-formes, Java souffre d'un manque de biblioth√®ques de stub de connexion. Si vous √™tes dans ce monde depuis longtem...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>AnyStub, biblioth√®que de stub de connexion Java</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/450958/"><p> Contrairement √† de nombreuses plates-formes, Java souffre d'un manque de biblioth√®ques de stub de connexion.  Si vous √™tes dans ce monde depuis longtemps, vous devriez probablement √™tre familier avec WireMock, Betamax ou m√™me Spock.  De nombreux d√©veloppeurs dans les tests utilisent Mockito pour d√©crire le comportement des objets, DataJpaTest avec une base de donn√©es h2 locale, tests Cucumber.  Aujourd'hui, vous rencontrerez une alternative l√©g√®re qui vous aidera √† faire face aux diff√©rents probl√®mes que vous pourriez rencontrer en utilisant ces approches.  En particulier, anyStub essaie de r√©soudre les probl√®mes suivants: </p><br><ul><li>  simplifier la configuration de l'environnement de test </li><li>  automatiser la collecte de donn√©es pour les tests </li><li>  continuez √† tester votre application et √©vitez de tester autre chose </li></ul><a name="habracut"></a><br><h2 id="chto-takoe-anystub-i-kak-eto-rabotaet">  Qu'est-ce qu'anyStub et comment √ßa marche </h2><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">AnyStub encapsule</a> les appels de fonction, essayant de trouver les appels correspondants qui ont d√©j√† √©t√© enregistr√©s.  Deux choses peuvent se produire avec ceci: </p><br><ul><li>  s'il y a un appel correspondant, anyStub restaure le r√©sultat enregistr√© associ√© √† cet appel et le renvoie </li><li>  s'il n'y a pas d'appel correspondant et que l'acc√®s au syst√®me externe est autoris√©, anyStub fera cet appel, enregistrera ce r√©sultat et le renverra </li></ul><br><p>  D√®s la sortie de la bo√Æte, anyStub fournit des wrappers pour le client http d'Apache HttpClient pour cr√©er des stubs pour les requ√™tes http et plusieurs interfaces √† partir de javax.sql. * Pour les connexions DB.  Vous disposez √©galement d'une API pour cr√©er des stubs pour d'autres connexions. </p><br><p>  AnyStub est une biblioth√®que de classes simple et ne n√©cessite pas de configuration sp√©ciale de votre environnement.  Cette biblioth√®que est destin√©e √† travailler avec des applications √† d√©marrage par ressort et vous obtiendrez le maximum d'avantages en suivant ce chemin.  Vous pouvez l'utiliser en dehors de Spring, dans des applications Java simples, mais vous devrez certainement faire un travail suppl√©mentaire.  La description suivante se concentre sur le test des applications Spring-Boot. </p><br><p>  Regardons les tests d'int√©gration.  Il s'agit de la mani√®re la plus excitante et la plus compl√®te de tester votre syst√®me.  En fait, Spring-boot et JUnit font presque tout pour vous lorsque vous √©crivez des annotations magiques: </p><br><pre><code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@RunWith</span></span>(SpringRunner.class) <span class="hljs-meta"><span class="hljs-meta">@SpringBootTest</span></span></code> </pre> <br><p>  √Ä l'heure actuelle, les tests d'int√©gration sont sous-estim√©s et sont utilis√©s dans une mesure limit√©e, et certains d√©veloppeurs les √©vitent.  Cela est principalement d√ª √† la pr√©paration et √† la maintenance fastidieuses des tests ou √† la n√©cessit√© d'une configuration sp√©ciale de l'environnement sur les serveurs de build. </p><br><p>  Avec anyStub, vous n'avez pas √† paralyser le contexte printanier.  Au lieu de cela, garder le contexte proche de la configuration de production est simple et direct. </p><br><p>  Dans cet exemple, nous verrons comment connecter anyStub √† un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Consuming a RESTful Web Service √†</a> partir du manuel de Pivotal. </p><br><p>  Connexion d'une biblioth√®que via pom.xml </p><br><pre> <code class="java hljs"> &lt;dependency&gt; &lt;groupId&gt;org.anystub&lt;/groupId&gt; &lt;artifactId&gt;anystub&lt;/artifactId&gt; &lt;version&gt;<span class="hljs-number"><span class="hljs-number">0.2</span></span>.27&lt;/version&gt; &lt;scope&gt;test&lt;/scope&gt; &lt;/dependency&gt;</code> </pre> <br><p>  L'√©tape suivante consiste √† modifier le contexte du ressort. </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">package</span></span> hello; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.anystub.http.StubHttpClient; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.apache.http.client.HttpClient; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.apache.http.impl.client.HttpClientBuilder; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.boot.web.client.RestTemplateBuilder; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.boot.web.client.RestTemplateCustomizer; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.context.annotation.Bean; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.context.annotation.Configuration; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.http.client.HttpComponentsClientHttpRequestFactory; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.web.client.RestTemplate; <span class="hljs-meta"><span class="hljs-meta">@Configuration</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">TestConfiguration</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Bean</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> RestTemplateBuilder </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">builder</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ RestTemplateCustomizer restTemplateCustomizer = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> RestTemplateCustomizer() { <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">customize</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(RestTemplate restTemplate)</span></span></span><span class="hljs-function"> </span></span>{ HttpClient real = HttpClientBuilder.create().build(); StubHttpClient stubHttpClient = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> StubHttpClient(real); HttpComponentsClientHttpRequestFactory requestFactory = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> HttpComponentsClientHttpRequestFactory(); requestFactory.setHttpClient(stubHttpClient); restTemplate.setRequestFactory(requestFactory); } }; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> RestTemplateBuilder(restTemplateCustomizer); } }</code> </pre> <br><p>  Cette modification ne modifie pas les relations de composants dans l'application, mais remplace uniquement l'impl√©mentation d'une interface unique.  Cela nous renvoie au <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">principe de substitution de Barbara Lisk</a> .  Si la conception de votre application ne la viole pas, cette substitution ne violera pas la fonctionnalit√©. </p><br><p>  Tout est pr√™t.  Ce projet comprend d√©j√† un test. </p><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@RunWith</span></span>(SpringRunner.class) <span class="hljs-meta"><span class="hljs-meta">@SpringBootTest</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ApplicationTest</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Autowired</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> RestTemplate restTemplate; <span class="hljs-meta"><span class="hljs-meta">@Test</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">contextLoads</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ assertThat(restTemplate).isNotNull(); } }</code> </pre> <br><p>  Ce test est vide, mais il ex√©cute d√©j√† le contexte de l'application.  <strong>Le plaisir commence ici</strong> .  Comme nous l'avons dit ci-dessus, le contexte d'application dans le test co√Øncide avec le contexte de travail dans lequel le CommandLineRunner est cr√©√© dans lequel la requ√™te http au syst√®me externe est ex√©cut√©e. </p><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@SpringBootApplication</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Application</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Logger log = LoggerFactory.getLogger(Application.class); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String args[])</span></span></span><span class="hljs-function"> </span></span>{ SpringApplication.run(Application.class); } <span class="hljs-meta"><span class="hljs-meta">@Bean</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> RestTemplate </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">restTemplate</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(RestTemplateBuilder builder)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> builder.build(); } <span class="hljs-meta"><span class="hljs-meta">@Bean</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> CommandLineRunner </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">run</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(RestTemplate restTemplate)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> Exception </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> args -&gt; { Quote quote = restTemplate.getForObject( <span class="hljs-string"><span class="hljs-string">"https://gturnquist-quoters.cfapps.io/api/random"</span></span>, Quote.class); log.info(quote.toString()); }; } }</code> </pre> <br><p>  Cela suffit pour d√©montrer le fonctionnement de la biblioth√®que.  Apr√®s avoir d√©marr√© les tests pour la premi√®re fois, vous trouverez le nouveau <code>complete/src/test/resources/anystub/stub.yml</code> . </p><br><pre> <code class="plaintext hljs">request0: exception: [] keys: [GET, HTTP/1.1, 'https://gturnquist-quoters.cfapps.io/api/random'] values: [HTTP/1.1, '200', OK, 'Content-Type: application/json;charset=UTF-8', 'Date: Thu, 25 Apr 2019 23:04:49 GMT', 'X-Vcap-Request-Id: 5ffce9f3-d972-4e95-6b5c-f88f9b0ae29b', 'Content-Length: 177', 'Connection: keep-alive', '{"type":"success","value":{"id":3,"quote":"Spring has come quite a ways in addressing developer enjoyment and ease of use since the last time I built an application using it."}}']</code> </pre> <br><p>  Qu'est-il arriv√©?  spring-boot a int√©gr√© RestTemplateBuilder √† partir de la configuration de test dans l'application.  Cela a conduit l'application √† travailler sur l'impl√©mentation du stub du client http.  StubHttpClient a intercept√© la demande, n'a pas trouv√© le fichier de raccord, a ex√©cut√© la demande, a enregistr√© le r√©sultat dans un fichier et a renvoy√© le r√©sultat r√©cup√©r√© √† partir du fichier. </p><br><p>  A partir de maintenant, vous pouvez ex√©cuter ce test sans connexion Internet et cette demande sera r√©ussie.  <code>restTemplate.getForObject()</code> renverra le m√™me r√©sultat.  Vous pouvez compter sur ce fait dans vos futurs tests. </p><br><p>  Vous pouvez trouver toutes les modifications d√©crites sur <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">GitHub</a> . </p><br><p>  En fait, nous n'avons toujours pas cr√©√© un seul test.  Avant d'√©crire des tests, voyons comment cela fonctionne avec les bases de donn√©es. </p><br><p>  Dans cet exemple, nous allons ajouter un test d'int√©gration √† <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Acc√®s</a> aux <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">donn√©es relationnelles √† l'aide de JDBC avec Spring √†</a> partir du didacticiel Pivotal. </p><br><p>  La configuration de test pour ce cas ressemble √† ceci: </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">package</span></span> hello; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.anystub.jdbc.StubDataSource; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.h2.jdbcx.JdbcDataSource; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.context.annotation.Bean; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.context.annotation.Configuration; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> javax.sql.DataSource; <span class="hljs-meta"><span class="hljs-meta">@Configuration</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">TestConfiguration</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Bean</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> DataSource </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">dataSource</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ JdbcDataSource ds = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> JdbcDataSource(); ds.setURL(<span class="hljs-string"><span class="hljs-string">"jdbc:h2:./test"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> StubDataSource(ds); } }</code> </pre> <br><p>  Ici, une source de donn√©es r√©guli√®re vers une base de donn√©es externe est cr√©√©e et encapsul√©e avec une impl√©mentation de stub - la classe StubDataSource.  Spring-boot l'int√®gre dans son contexte.  Nous devons √©galement cr√©er au moins un test pour ex√©cuter le contexte Spring dans le test. </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">package</span></span> hello; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.anystub.AnyStubId; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.junit.Test; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.junit.runner.RunWith; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.boot.test.context.SpringBootTest; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.test.context.junit4.SpringRunner; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> org.junit.Assert.*; <span class="hljs-meta"><span class="hljs-meta">@RunWith</span></span>(SpringRunner.class) <span class="hljs-meta"><span class="hljs-meta">@SpringBootTest</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ApplicationTest</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Test</span></span> <span class="hljs-meta"><span class="hljs-meta">@AnyStubId</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">test</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ } }</code> </pre> <br><p>  Il s'agit l√† encore d'un test vide - sa seule t√¢che est d'ex√©cuter le contexte de l'application.  Nous voyons ici une annotation tr√®s importante <code>@AnystubId</code> , mais elle ne sera pas encore impliqu√©e. </p><br><p>  Apr√®s la premi√®re ex√©cution, vous trouverez un nouveau <code>src/test/resources/anystub/stub.yml</code> qui inclut tous les appels de base de donn√©es.  Vous serez surpris de voir comment le printemps fonctionne en arri√®re-plan avec les bases de donn√©es.  Notez que de nouvelles ex√©cutions du test n'aboutiront pas √† un v√©ritable acc√®s √† la base de donn√©es.  Si vous supprimez test.mv.db, il n'appara√Ætra pas apr√®s des ex√©cutions r√©p√©t√©es des tests.  L'ensemble complet des modifications peut √™tre consult√© sur <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">GitHub</a> . </p><br><p>  Pour r√©sumer.  avec anyStub: </p><br><ul><li>  vous n'avez pas besoin de configurer sp√©cifiquement un environnement de test </li><li>  les tests sont effectu√©s avec des donn√©es r√©elles </li><li>  la premi√®re ex√©cution des tests prouve vos hypoth√®ses et enregistre les donn√©es de test, les suivantes v√©rifient que le syst√®me ne s'est pas d√©grad√© </li></ul><br><p>  Vous avez probablement des questions: comment cela couvre-t-il les cas o√π la base de donn√©es n'existe pas encore, que faire avec les tests n√©gatifs et la gestion des exceptions.  Nous y reviendrons, mais d'abord, nous traiterons de l'√©criture de tests simples. </p><br><p>  Nous exp√©rimentons maintenant la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">consommation d'un service Web RESTful</a> .  Ce projet ne contient pas de composants pouvant √™tre test√©s.  Deux classes sont cr√©√©es ci-dessous, qui devraient repr√©senter deux couches d'une conception d'architecture. </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">package</span></span> hello; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.stereotype.Component; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.web.client.RestTemplate; <span class="hljs-meta"><span class="hljs-meta">@Component</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">DataProvider</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> RestTemplate restTemplate; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">DataProvider</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(RestTemplate restTemplate)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.restTemplate = restTemplate; } <span class="hljs-function"><span class="hljs-function">Quote </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">provideData</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> restTemplate.getForObject( <span class="hljs-string"><span class="hljs-string">"https://gturnquist-quoters.cfapps.io/api/random"</span></span>, Quote.class); } }</code> </pre> <br><p>  DataProvider donne acc√®s aux donn√©es dans <del>  volatile </del>  syst√®me externe. </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">package</span></span> hello; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.stereotype.Component; <span class="hljs-meta"><span class="hljs-meta">@Component</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">DataProcessor</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> DataProvider dataProvider; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">DataProcessor</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(DataProvider dataProvider)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.dataProvider = dataProvider; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">processData</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> dataProvider.provideData().getValue().getQuote().length(); } }</code> </pre> <br><p>  DataProcessor traitera les donn√©es d'un syst√®me externe. </p><br><p>  Nous avons l'intention de tester le <code>DataProcessor</code> .  Il est n√©cessaire de tester l'exactitude de l'algorithme de traitement et de prot√©ger le syst√®me contre la d√©gradation des changements futurs. </p><br><p>  Pour atteindre ces objectifs, vous pouvez envisager de cr√©er un objet maquette DataProvider avec un ensemble de donn√©es et de le transmettre au constructeur DataProcessor dans les tests.  Une autre fa√ßon pourrait √™tre de d√©composer le DataProcessor pour mettre en √©vidence le traitement de la classe Quote.  Ensuite, une telle classe est facile √† tester √† l'aide de tests unitaires (c'est s√ªrement la m√©thode recommand√©e dans les livres respect√©s sur le code propre).  Essayons d'√©viter les changements de code et l'invention des donn√©es de test et √©crivons simplement un test. </p><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@RunWith</span></span>(SpringRunner.class) <span class="hljs-meta"><span class="hljs-meta">@SpringBootTest</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">DataProcessorTest</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Autowired</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> DataProcessor dataProcessor; <span class="hljs-meta"><span class="hljs-meta">@Test</span></span> <span class="hljs-meta"><span class="hljs-meta">@AnyStubId</span></span>(filename = <span class="hljs-string"><span class="hljs-string">"stub"</span></span>) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">processDataTest</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ assertEquals(<span class="hljs-number"><span class="hljs-number">131</span></span>, dataProcessor.processData()); } }</code> </pre> <br><p>  Il est temps de parler de l'annotation @AnystubId.  Cette annotation permet de g√©rer et de contr√¥ler les fichiers de raccord dans les tests.  Il peut √™tre utilis√© avec une classe de test ou sa m√©thode.  Cette annotation configure un fichier de raccord individuel pour la zone correspondante.  Si une zone est simultan√©ment couverte par des annotations au niveau de la classe et de la m√©thode, l'annotation de la m√©thode est prioritaire.  Cette annotation a le param√®tre filename, qui d√©finit le nom du fichier de raccord.  l'extension ".yml" est ajout√©e automatiquement si elle est omise.  En ex√©cutant ce test, vous <strong>ne</strong> trouverez <strong>pas de</strong> nouveau fichier.  Le <code>src/test/resources/anystub/stub.yml</code> a d√©j√† √©t√© cr√©√© pr√©c√©demment et ce test le r√©utilisera.  Nous avons obtenu le num√©ro 131 de ce talon en analysant le r√©sultat de la requ√™te. </p><br><pre> <code class="java hljs"> <span class="hljs-meta"><span class="hljs-meta">@Test</span></span> <span class="hljs-meta"><span class="hljs-meta">@AnyStubId</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">processDataTest2</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ assertEquals(<span class="hljs-number"><span class="hljs-number">131</span></span>, dataProcessor.processData()); Base base = getStub(); assertEquals(<span class="hljs-number"><span class="hljs-number">1</span></span>, base.times(<span class="hljs-string"><span class="hljs-string">"GET"</span></span>)); assertTrue(base.history().findFirst().get().matchEx_to(<span class="hljs-keyword"><span class="hljs-keyword">null</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>, <span class="hljs-string"><span class="hljs-string">".*gturnquist-quoters.cfapps.io.*"</span></span>)); }</code> </pre> <br><p>  Dans ce test, l'annotation @AnyStubId appara√Æt sans le param√®tre de nom de fichier.  Dans ce cas, le <code>src/test/resources/anystubprocessDataTest2.yml</code> .  Le nom du fichier est construit √† partir du nom de la fonction (classe) + ".yml".  Une fois que anyStub cr√©e un nouveau fichier pour ce test, vous devez effectuer un v√©ritable appel syst√®me.  Et c'est notre chance que le nouveau devis ait la m√™me longueur.  Les deux derni√®res v√©rifications montrent comment tester le comportement de l'application.  Il est √† votre disposition: s√©lection de requ√™tes par param√®tres ou parties de param√®tres et comptage du nombre de requ√™tes.  Il existe plusieurs variantes des heures <em>et des</em> fonctions de <em>correspondance</em> qui peuvent √™tre trouv√©es dans la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">documentation</a> . </p><br><pre> <code class="java hljs"> <span class="hljs-meta"><span class="hljs-meta">@Test</span></span> <span class="hljs-meta"><span class="hljs-meta">@AnyStubId</span></span>(requestMode = RequestMode.rmTrack) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">processDataTest3</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ assertEquals(<span class="hljs-number"><span class="hljs-number">79</span></span>, dataProcessor.processData()); assertEquals(<span class="hljs-number"><span class="hljs-number">79</span></span>, dataProcessor.processData()); assertEquals(<span class="hljs-number"><span class="hljs-number">168</span></span>, dataProcessor.processData()); assertEquals(<span class="hljs-number"><span class="hljs-number">79</span></span>, dataProcessor.processData()); Base base = getStub(); assertEquals(<span class="hljs-number"><span class="hljs-number">4</span></span>, base.times(<span class="hljs-string"><span class="hljs-string">"GET"</span></span>)); }</code> </pre> <br><p>  Dans ce test, @AnyStubId appara√Æt avec le nouveau param√®tre requestMode.  Il vous permet de g√©rer les autorisations pour les fichiers de raccord.  Il y a deux aspects √† contr√¥ler: la recherche de fichiers et l'autorisation d'appeler un syst√®me externe. </p><br><p>  <code>RequestMode.rmTrack</code> d√©finit les r√®gles suivantes: si le fichier vient d'√™tre cr√©√©, toutes les demandes sont envoy√©es au syst√®me externe et sont √©crites dans le fichier avec les r√©ponses, qu'il y ait ou non une demande identique dans le fichier (les doublons dans le fichier sont autoris√©s).  Si, avant d'ex√©cuter les tests, le fichier de raccord existe, les demandes au syst√®me externe sont interdites.  Les appels sont attendus exactement dans la m√™me s√©quence.  Si la demande suivante ne correspond pas √† la demande du fichier, une exception est lev√©e. </p><br><p>  <code>RequestMode.rmNew</code> ce mode est activ√© par d√©faut.  Chaque demande est recherch√©e dans le fichier de raccord.  Si une demande correspondante est trouv√©e - le r√©sultat correspondant est restaur√© √† partir du fichier, la demande au syst√®me externe est report√©e.  Si la demande n'est pas trouv√©e, le syst√®me externe est demand√©, le r√©sultat est enregistr√© dans un fichier.  Demandes en double dans le fichier - ne se produisent pas. </p><br><p>  <code>RequestMode.rmNone</code> Chaque demande est recherch√©e dans un fichier de raccord.  Si une requ√™te correspondante est trouv√©e, son r√©sultat est restaur√© √† partir du fichier.  Si le test g√©n√®re une demande qui n'est pas dans le fichier, une exception est lev√©e. </p><br><p>  <code>RequestMode.rmAll</code> avant la premi√®re demande, le fichier de raccord est effac√©.  Toutes les demandes sont √©crites dans le fichier (les doublons dans le fichier sont autoris√©s).  Vous pouvez utiliser ce mode si vous souhaitez regarder le travail de connexion. </p><br><p>  <code>RequestMode.rmPassThrough</code> toutes les demandes sont envoy√©es directement au syst√®me externe, en contournant le talon d'impl√©mentation. </p><br><p>  Ces modifications sont disponibles sur <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">GitHub.</a> </p><br><h1 id="chto-eschyo">  Quoi d'autre? </h1><br><p>  Nous avons vu comment anyStub enregistre les r√©ponses.  Si une exception est lev√©e lors de l'acc√®s √† un syst√®me externe, anyStub l'enregistrera et la lira lors des requ√™tes suivantes. </p><br><p>  Souvent, des exceptions sont lev√©es par les classes de niveau sup√©rieur, tandis que les classes de connexion re√ßoivent une r√©ponse valide (probablement avec un code d'erreur).  Dans ce cas, anyStub est responsable de reproduire la r√©ponse m√™me avec le code d'erreur, et les classes de niveau sup√©rieur l√®veront √©galement des exceptions pour vos tests. </p><br><p>  Ajoutez des fichiers de raccord au r√©f√©rentiel. </p><br><p>  N'ayez pas peur de supprimer et d'√©craser des fichiers de raccord. </p><br><p>  G√©rez judicieusement les fichiers de raccord.  Vous pouvez r√©utiliser un fichier dans plusieurs tests ou fournir un fichier individuel pour chaque test.  Profitez de cette opportunit√© pour vos besoins.  Mais g√©n√©ralement, l'utilisation d'un seul fichier avec diff√©rents modes d'acc√®s est une mauvaise id√©e. </p><br><p>  Ce sont toutes les principales fonctionnalit√©s de anyStub. </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr450958/">https://habr.com/ru/post/fr450958/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr450948/index.html">MU-MIMO: l'un des algorithmes d'impl√©mentation</a></li>
<li><a href="../fr450950/index.html">Dart Streams Basics</a></li>
<li><a href="../fr450952/index.html">Indice moyen et antibank</a></li>
<li><a href="../fr450954/index.html">Comment nous avons appris √† exploiter Java dans Docker</a></li>
<li><a href="../fr450956/index.html">Comparaison des COB industriels: ISIM vs. Kics</a></li>
<li><a href="../fr450962/index.html">Pompes √† insuline, micropuces inviolables et radio d√©finie par logiciel</a></li>
<li><a href="../fr450964/index.html">Nouvelle biblioth√®que intrins√®que SIMD x86 - D√©bogage immintrin</a></li>
<li><a href="../fr450966/index.html">Enregistrement de vid√©o √† partir d'un vieil ordinateur - m√©thodes de LGR</a></li>
<li><a href="../fr450970/index.html">Comment vraiment comparer les prix Apple aux √âtats-Unis et en Russie. Exp√©rience personnelle</a></li>
<li><a href="../fr450972/index.html">Comment organiser un studio photo? Cas de Bolshakova Studio</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>