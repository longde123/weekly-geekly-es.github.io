<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë∞üèª üê¢ üì∏ Ajustez OpenStack sous forte charge ü•ä ü§± üëÜ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Bonjour, je m'appelle Maxim, je suis administrateur syst√®me. Il y a trois ans, mes coll√®gues et moi avons commenc√© √† transf√©rer des produits vers des ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Ajustez OpenStack sous forte charge</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/yamoney/blog/427569/"><p>  Bonjour, je m'appelle Maxim, je suis administrateur syst√®me.  Il y a trois ans, mes coll√®gues et moi avons commenc√© √† transf√©rer des produits vers des microservices et avons d√©cid√© d'utiliser Openstack comme plate-forme, et nous avons rencontr√© un certain nombre de r√¢teaux non √©vidents lors de l'automatisation des circuits de test.  Cet article porte sur les nuances de la configuration d'OpenStack, que l'on ne trouve gu√®re sur la cinqui√®me page des r√©sultats des moteurs de recherche (ou mieux, elles sont facilement sur la premi√®re). </p><br><p><img src="https://habrastorage.org/webt/mq/7k/0o/mq7k0oanmmzmtasnicu6ra237po.png"><br>  <em>La charge sur les noyaux: c'√©tait - c'est devenu</em> </p><br><h3 id="nat">  NAT </h3><br><p>  Dans certains cas, nous utilisons dualstack.  C'est lorsque la machine virtuelle re√ßoit deux adresses √† la fois - IPv4 et IPv6.  Tout d'abord, nous nous sommes assur√©s que l'adresse v4 ¬´flottante¬ª a √©t√© attribu√©e dans le r√©seau interne via NAT et la machine a re√ßu la v6 via BGP, mais cela pose quelques probl√®mes. </p><br><p> NAT - un n≈ìud suppl√©mentaire dans le r√©seau, o√π m√™me sans lui, vous devez surveiller la r√©partition normale de la charge.  L'apparition de NAT sur le r√©seau entra√Æne presque toujours des difficult√©s de d√©bogage - il y a une IP sur l'h√¥te, l'autre dans la base de donn√©es, et il devient difficile de suivre la demande.  Les recherches en masse commencent et la solution sera toujours dans OpenStack. </p><br><p>  NAT ne permet toujours pas de segmenter normalement l'acc√®s entre les projets.  Tous les projets ont leurs propres sous-r√©seaux, les IP flottantes migrent constamment et avec NAT, il devient absolument impossible de g√©rer cela.  Certaines installations parlent d'utiliser NAT 1 en 1 (l'adresse interne ne diff√®re pas de l'adresse externe), mais cela laisse encore des liens inutiles dans la cha√Æne d'interaction avec les services externes.  Nous sommes arriv√©s √† la conclusion que pour nous, la meilleure option est un r√©seau BGP. </p><a name="habracut"></a><br><h2 id="chem-prosche-tem-luchshe">  Plus c'est simple, mieux c'est </h2><br><p>  Nous avons essay√© divers outils d'automatisation, mais nous nous sommes install√©s sur Ansible.  C'est un bon outil, mais ses fonctionnalit√©s standard (m√™me en tenant compte de modules suppl√©mentaires) peuvent ne pas √™tre suffisantes dans certaines situations difficiles. </p><br><p>  Par exemple, via le module Ansible, vous ne pouvez pas sp√©cifier √† partir de quelles adresses de sous-r√©seau allouer.  Autrement dit, vous pouvez sp√©cifier un r√©seau, mais vous ne pouvez pas d√©finir un pool d'adresses sp√©cifique.  La commande shell qui cr√©e l'IP flottante vous aidera ici: </p><br><pre><code class="bash hljs">openstack floating ip create -c floating_ip_address -f value -project \ {{ project name }} ‚Äîsubnet private-v4 CLOUD_NET</code> </pre> <br><p>  Un autre exemple de fonctionnalit√© manquante: en raison de la double pile, nous ne pouvons pas cr√©er correctement un routeur avec deux ports pour v4 et v6.  C'est l√† qu'un script bash est utile: </p><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#! /bin/bash # $1 - router_name # $2 - router_project # $3 - router_network # echo "${@:4}" - private subnet lists FIXED4_SUBNET="subnet-bgp-nexthop-v4" FIXED6_SUBNET="subnet-bgp-nexthop-v6" openstack --os-project-name $2 router show $1 if [ $? -eq 0 ] then echo "router is exist" exit 0 fi openstack --os-project-name $2 router create --project $2 $1 for subnet in "${@:4}"; do openstack --os-project-name $2 router add subnet $1 $subnet done openstack --os-project-name $2 router set $1 --external-gateway $3 --fixed-ip subnet=$FIXED4_SUBNET --fixed-ip subnet=$FIXED6_SUBNET</span></span></code> </pre> <br><p>  Le script cr√©e un routeur, lui ajoute des sous-r√©seaux v4 et v6 et lui attribue une passerelle externe. </p><br><h3 id="retry">  R√©essayer </h3><br><p>  Dans toute situation incompr√©hensible - red√©marrez.  R√©essayez, cr√©ez une instance, un routeur ou un enregistrement DNS, car vous ne comprenez pas toujours rapidement quel est votre probl√®me.  R√©essayer peut retarder la d√©gradation du service, et √† ce moment, vous pouvez calmement et sans nerfs r√©soudre le probl√®me. </p><br><p>  Tous les conseils ci-dessus fonctionnent parfaitement avec Terraform, Puppet et tout le reste. </p><br><h2 id="vsemu-svoyo-mesto">  Tout a sa place </h2><br><p>  Tout service important (OpenStack ne fait pas exception) combine de nombreux services plus petits qui peuvent interf√©rer les uns avec les autres.  Voici un exemple. </p><br><p>  Agent r√©seau Neutron-L2-agent est responsable de la connectivit√© r√©seau dans OpenStack.  Si tous les autres agents sont partiellement sur les contr√¥leurs, alors L2, en raison des sp√©cificit√©s, est pr√©sent partout. </p><br><p><img src="https://habrastorage.org/webt/ae/dx/uh/aedxuhggl2u8fyrtqgwkfphjjle.png"><br>  <em>Voici √† quoi ressemblait notre infrastructure au tout d√©but, jusqu'√† ce que le nombre de projets d√©passe 50</em> </p><br><p>  √Ä ce stade, nous avons r√©alis√© qu'en raison de cette disposition des agents, les contr√¥leurs ne pouvaient pas faire face √† la charge, et transf√©r√© les agents aux n≈ìuds de calcul.  Ils sont plus puissants que les contr√¥leurs et, en outre, le contr√¥leur n'a pas √† g√©rer tout le traitement - il doit confier la t√¢che au n≈ìud d'ex√©cution et le n≈ìud l'ex√©cutera. </p><br><p><img src="https://habrastorage.org/webt/63/mh/8v/63mh8vrzvrqv3w5exan5tw8npba.png"><br>  <em>Agents transf√©r√©s aux n≈ìuds de calcul</em> </p><br><p>  Cependant, cela ne suffisait pas, car un tel arrangement avait un mauvais effet sur les performances des machines virtuelles.  Avec une densit√© de 14 c≈ìurs virtuels par physique, si un agent r√©seau commen√ßait √† charger le flux, cela pouvait affecter plusieurs machines virtuelles √† la fois. </p><br><p><img src="https://habrastorage.org/webt/br/z5/zi/brz5ziy4mpmlr2ijectmrezvgtw.png"><br>  <em>Troisi√®me it√©ration.</em>  <em>Des n≈ìuds s√©lectionn√©s sont apparus.</em> </p><br><p>  Nous avons pens√© et d√©plac√© les agents vers des n≈ìuds de r√©seau distincts.  D√©sormais, seuls les services pour les machines virtuelles restent sur les n≈ìuds de calcul, tous les agents travaillent sur les n≈ìuds du r√©seau et seuls les agents bgp qui traitent du r√©seau v6 restent sur les contr√¥leurs (puisqu'un agent bgp ne peut servir qu'un seul type de r√©seau).  La L2 est rest√©e partout, car sans elle, comme nous l'avons √©crit plus haut, il n'y aurait pas de connectivit√© sur le r√©seau. </p><br><p><img src="https://habrastorage.org/webt/pu/yg/ie/puygieqmiyz9zi8dlovcu_j88ma.png"><br>  <em>Chargez le graphique des n≈ìuds de calcul avant que tout soit m√©lang√©.</em>  <em>Il √©tait d'environ 60%, mais la charge a chut√© de mani√®re insignifiante</em> </p><br><p><img src="https://habrastorage.org/webt/y5/im/t2/y5imt2_c5e-7xoha7crtboepbd4.png"><br>  <em>La charge sur softirq avant que les agents r√©seau ne suppriment les n≈ìuds de calcul.</em>  <em>3 noyaux sont rest√©s charg√©s.</em>  <em>A cette √©poque, nous pensions que c'√©tait normal</em> </p><br><h2 id="code-asdocumentation">  Code comme documentation </h2><br><p>  Parfois, il arrive que le code soit la documentation, en particulier dans des services aussi importants que OpenStack.  Avec un cycle de publication de six mois, les d√©veloppeurs oublient ou n'ont tout simplement pas le temps de documenter certaines choses, et cela se passe comme dans l'exemple ci-dessous. </p><br><h4 id="pro-taymauty">  √Ä propos des d√©lais </h4><br><p>  Une fois que nous avons vu que les appels de Neutron √† Open vSwitch ne tiennent pas en cinq secondes et tombent en timeout. </p><br><pre> <code class="bash hljs">127.0.0.1:29696: no response to inactivity probe after 10 seconds, disconnecting neutron.agent.ovsdb.native.commands TimeoutException: Commands [DbSetCommand(table=Port, col_values=((<span class="hljs-string"><span class="hljs-string">'tag'</span></span>, 11),), record=qtoq69a81c6-e2)] exceeded timeout 5 seconds</code> </pre> <br><p>  Bien s√ªr, nous avons suppos√© que quelque part dans les param√®tres, cela √©tait fixe.  Nous avons regard√© dans les configurations, la documentation et le paquet deb, mais au d√©but, ils n‚Äôont rien trouv√©.  En cons√©quence, la description du param√®tre souhait√© a √©t√© trouv√©e sur la cinqui√®me page des r√©sultats de la recherche - nous avons r√©examin√© le code et trouv√© le bon endroit.  Le r√©glage est le suivant: </p><br><pre> <code class="bash hljs">ovs_vsctl_timeout = 30</code> </pre> <br><p>  <em>Nous l'avons r√©gl√© pendant 30 secondes (il √©tait de 5), et tout a commenc√© √† fonctionner un peu mieux.</em> </p><br><p>  Voici une autre √©vidence: lorsque vous red√©marrez des composants r√©seau, certains param√®tres d'Open vSwitch peuvent √™tre r√©initialis√©s.  Cela se produit, par exemple, avec ovs-vsctl inactivity_probe.  C'est √©galement un d√©lai d'attente, mais cela affecte les appels d'ovs-vsctl lui-m√™me √† sa base de donn√©es.  Nous l'avons ajout√© √† systemd init, ce qui nous a permis de d√©marrer tous les commutateurs avec les param√®tres dont nous avons besoin au d√©marrage. </p><br><pre> <code class="bash hljs">ovs-vsctl <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> Controller <span class="hljs-string"><span class="hljs-string">"br-int"</span></span> inactivity_probe=30000</code> </pre> <br><h4 id="pro-nastroyki-setevogo-steka">  √Ä propos des param√®tres de pile r√©seau </h4><br><p>  Nous avons √©galement d√ª nous √©loigner un peu des param√®tres g√©n√©ralement accept√©s dans la pile r√©seau, que nous utilisons sur nos autres serveurs. </p><br><p>  Voici le param√®tre de dur√©e de stockage des enregistrements ARP dans une table: </p><br><pre> <code class="bash hljs">net.ipv4.neigh.default.base_reachable_time = 60 net.ipv4.neigh.default.gc_stale_time=60</code> </pre> <br><p>  La valeur par d√©faut est 1 jour.  En g√©n√©ral, un sch√©ma peut vivre pendant quelques semaines, mais pendant une journ√©e, les sch√©mas peuvent √™tre recr√©√©s 4 √† 6 fois, tandis que la correspondance de l'adresse MAC et de l'adresse IP change constamment.  Pour que les d√©chets ne s'accumulent pas, nous avons r√©gl√© le temps sur une minute. </p><br><pre> <code class="bash hljs">net.ipv4.conf.default.arp_notify = 1 net.nf_conntrack_max = 1000000 (default 262144) net.netfilter.nf_conntrack_max = 1000000 (default 262144)</code> </pre> <br><p>  De plus, nous avons forc√© l'envoi de notifications ARP lors de l'augmentation de l'interface r√©seau.  Nous avons √©galement augment√© la table conntrack, car lors de l'utilisation de NAT et d'ip flottante, nous n'avions pas la valeur par d√©faut.  Pass√© √† un million (avec 262 144 par d√©faut), tout est devenu encore meilleur. </p><br><p>  Nous corrigeons la taille de la table MAC d'Open vSwitch lui-m√™me: </p><br><pre> <code class="bash hljs">ovs-vsctl <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> bridge bt-int other-config:mac-table-size=50000 (default 2048)</code> </pre> <br><p><img src="https://habrastorage.org/webt/px/oi/px/pxoipxvpkzuou-twlr5uf0r28k8.png"><br>  <em>Apr√®s tous les r√©glages, 40% de la charge est devenue presque nulle</em> </p><br><h4 id="rx-flow-hash">  rx-flow-hash </h4><br><p>  Pour r√©partir le traitement du trafic udp entre toutes les files d'attente et les threads de processeur, nous avons inclus rx-flow-hash.  Sur les cartes r√©seau Intel, notamment dans le pilote i40e, cette option est d√©sactiv√©e par d√©faut.  Nous avons des hyperviseurs avec 72 c≈ìurs dans notre infrastructure, et si un seul est occup√©, ce n'est pas tr√®s optimal. </p><br><p>  C'est fait comme ceci: </p><br><pre> <code class="bash hljs">ethtool -N eno50 rx-flow-hash udp4 sdfn</code> </pre> <br><p><img src="https://habrastorage.org/webt/zj/qp/16/zjqp16xvvxmawd1irfjbwaeia9q.png"></p><br><p>  <strong>Une conclusion importante: vous pouvez tout configurer du tout.</strong>  La configuration par d√©faut s'int√©grera √† un moment donn√© (comme nous l'avons fait), mais le probl√®me avec les d√©lais d'attente a rendu n√©cessaire la recherche.  Et c'est normal. </p><br><h3 id="pravila-bezopasnosti">  R√®gles de s√©curit√© </h3><br><p>  Selon les exigences du service de s√©curit√©, tous les projets au sein de l'entreprise ont des r√®gles personnelles et globales - il y en a beaucoup.  Lorsque nous avons d√©m√©nag√© √† l'√©tranger de 300 machines virtuelles vers un seul hyperviseur, tout cela s'est traduit par 80 000 r√®gles pour iptables.  Pour iptables lui-m√™me, ce n'est pas un probl√®me, mais Neutron charge ces r√®gles de RabbitMQ dans un seul flux (car il est √©crit en Python, et tout est triste avec le multithreading l√†-bas).  L'agent Neutron se bloque, perd la connexion avec RabbitMQ et une r√©action en cha√Æne suite √† des d√©lais d'attente, et apr√®s la r√©cup√©ration, Neutron redemande toutes les r√®gles, d√©marre la synchronisation et tout recommence. </p><br><p>  Parall√®lement √† cela, le temps de cr√©ation des stands est pass√© de 20 √† 40 minutes √†, au mieux, une heure. </p><br><p>  Au d√©but, nous avons simplement tout emball√© avec des r√©cup√©rations (d√©j√† √† ce stade, nous avons r√©alis√© que le probl√®me ne pouvait pas √™tre r√©solu si rapidement), puis nous avons commenc√© √† utiliser <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">FWaaS</a> .  Avec lui, nous avons supprim√© des r√®gles de s√©curit√© avec des n≈ìuds de calcul pour s√©parer les n≈ìuds du r√©seau o√π se trouve le routeur lui-m√™me. </p><br><p><img src="https://habrastorage.org/webt/ou/dg/r_/oudgr_riwann3smyytraqiommpe.png"><br>  <em>Source - <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">docs.openstack.org</a></em> </p><br><p>  Ainsi, √† l'int√©rieur du projet, il y a un acc√®s complet √† tout ce qui est n√©cessaire et des r√®gles de s√©curit√© sont appliqu√©es pour les connexions externes.  Nous avons donc r√©duit la charge sur Neutron et sommes revenus √† 20-30 minutes de cr√©ation d'un environnement de test. </p><br><h2 id="itog">  R√©sum√© </h2><br><p>  OpenStack est une chose int√©ressante dans laquelle vous pouvez recycler le fer, cr√©er un cloud interne et cr√©er quelque chose d'autre √† partir de celui-ci.  En plus de cela, il y a une grande communaut√© et un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">groupe</a> actif <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">√† Telegram</a> , o√π ils nous ont inform√©s des temps morts. </p><br><p>  C‚Äôest tout.  Posez des questions, mes coll√®gues et moi sommes pr√™ts √† r√©pondre et √† partager notre exp√©rience. </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr427569/">https://habr.com/ru/post/fr427569/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr427557/index.html">R√©sum√© des √©v√©nements informatiques en novembre (premi√®re partie)</a></li>
<li><a href="../fr427561/index.html">Droit de r√©parer: les premiers pas dans la bonne direction de Motorola</a></li>
<li><a href="../fr427563/index.html">Norme SNI crypt√©e impl√©ment√©e dans Firefox Nightly</a></li>
<li><a href="../fr427565/index.html">¬´Ma r√©ussite est que je suis g√©n√©ralement retourn√© √† la profession¬ª - 10 questions au programmeur, num√©ro 10</a></li>
<li><a href="../fr427567/index.html">Cartes hexagonales dans Unity: cycle de l'eau, √©rosion, biomes, carte cylindrique</a></li>
<li><a href="../fr427571/index.html">L'union de R et PostgreSQL. Nous analysons le travail des a√©roports, calculons les pensions</a></li>
<li><a href="../fr427573/index.html">Candy or Life: Halloween comme raison pour attirer votre enfant vers la science</a></li>
<li><a href="../fr427575/index.html">Pourquoi le Wi-Fi ne fonctionnera pas comme pr√©vu et pourquoi savoir quel t√©l√©phone l'employ√© utilise</a></li>
<li><a href="../fr427577/index.html">Apprentissage automatique vs analyse de signature lors de la d√©tection d'attaques sur une application Web</a></li>
<li><a href="../fr427579/index.html">Distribution d'applications pour iOS au sein de l'entreprise (Enterprise Distribute iOS App en interne)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>