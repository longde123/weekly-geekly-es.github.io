<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👨🏻‍💼 🤼 👩🏿‍🤝‍👩🏼 Un diable pour vous, ou un audit avec piratage 👨🏿‍🎨 👩🏻‍⚕️ 📫</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Comme toujours, sans nom, et puisque je suis en outre associé à une signature de non-divulgation, elle a également un historique légèrement modifié (e...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Un diable pour vous, ou un audit avec piratage</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/416767/"><p>  <em>Comme toujours, sans nom, et puisque je suis en outre associé à une signature de non-divulgation, elle a également un historique légèrement modifié (et en omettant certains détails pour la publication dont je n'ai pas reçu l'autorisation).</em> <em><br></em>  <em>Ce qui suit est la vraie histoire d'un employé pénétrant un ordinateur ... eh bien, disons une banque privée.</em>  <em>Les événements dont parle votre humble serviteur ont eu lieu dans un pays européen il n'y a pas si longtemps, avant le DSGVO (RGPD, RGPD) mais en train de le devenir, en prévision de ce qu'on appelle.</em> </p><br><p> En fait, tout a commencé par un audit de sécurité - ..., une interview, en regardant sous la loupe de tout et de tout, en recherchant et en résolvant les failles et les goulots d'étranglement potentiels à traverser (à la fois là et à partir de là), ..., et en fait le débriefing.  Au cours de laquelle le client a finalement reçu une conclusion décevante pour lui - "C grade with a stretch". </p><br><p>  Oublions les mots que les agents de sécurité informatique rougissaient sous leurs yeux, mais le message lyrique général est que je jette des accusations infondées, et ils ont tout verrouillé, et la clé <abbr title="Capitaine - Chef de la sécurité">CSO</abbr> est dans ma poche sous mon cœur. </p><br><p>  Tente d'expliquer que le système de sécurité est construit autour d'un pare-feu + proxy + webwasher comme un filtre de contenu et un antivirus, sans IDS hybride très mal configuré (HIDS + APIDS), pots de miel, etc.  etc., d'une part, par définition, n'est pas sûr, d'autre part, pour ainsi dire, j'ai déjà montré plusieurs endroits où il n'est au moins pas comme il faut.  Les tentatives de retour à un dialogue constructif (en fait de retour à l'analyse) ont été brisées contre un mur de ressentiment de trois étages construit par l'ensemble du département. </p><br><p>  Limitant la réunion et libérant les employés, <abbr title="Capitaine - Chef de la sécurité">CSO,</abbr> ainsi que deux patrons importants, ont néanmoins essayé de découvrir honnêtement de moi où le chien a fouillé et compris <del>  comment vivre plus loin </del>  en fait et ce qui, à mon humble avis, doit être fait exactement. </p><a name="habracut"></a><br><p>  Parce que  Un aperçu de la compréhension n'a pas été observé à l'avenir non plus, avec enthousiasme j'ai rencontré une proposition à montrer dans la pratique.  Après avoir expliqué que cela ne fonctionnerait pas en ce moment, régler les formalités (signer quelques papiers de plus, etc.), j'ai obtenu le feu vert. </p><br><p>  Je n'aime pas vraiment le fait que je travaille «à l'aveugle» (c'est une corvée, longue et coûteuse, et le pentesting est une question de chance) et veuillez fournir des informations supplémentaires (par exemple, certaines données personnelles d'employés individuels, tels que les développeurs et le personnel de sécurité). ), Je n'ai pas non plus rencontré de contre-entente. </p><br><p>  Êtes-vous un hacker ou non?! <del>  (En fait, non, je suis développeur, sinon c'est plus un hobby). </del></p><br><p>  Je ne m'attarderai pas sur une discussion plus approfondie pendant longtemps - comme toujours, j'ai convaincu le facteur de l'argent et du temps (c'est-à-dire en fait le même argent). </p><br><p>  C'est-à-dire  en conséquence, nous avons une sorte de connaissance sur la structure de défense de l'entreprise (obtenue à la suite d'un audit préliminaire), ainsi qu'un nom complet et une courte biographie de 4 administrateurs et 3 développeurs. </p><br><p>  Pourquoi les administrateurs et les développeurs sont-ils en fait, après tout, vous pourriez demander aux "filles comptables", leur envoyer une sorte de chat avec un animal beaucoup moins sécurisé (ou lancer quelque chose comme ça dans le domaine de l'ingénierie sociale) .  Mais ... <br>  Cependant, beaucoup d'entreprises, en règle générale, n'aiment pas vraiment quand elles commencent à en parler lors de la présentation du <abbr title="Showman - Preuve de concept">PoC</abbr> , c'est-à-dire  Un «système de piratage» basé sur des intrigues du domaine de l'ingénierie sociale n'est au moins pas bien accueilli, quelle que soit la brièveté avec laquelle il a été construit. </p><br><p>  Pour en revenir aux technophiles, ils ne sont tout d'abord pas moins «sociaux» (ce qui ne signifie pas du tout qu'ils lanceront une sorte de «chat», mais le fait lui-même est important), et deuxièmement, ils ont généralement un ordinateur plus «développé fonctionnellement» ( que vous ne rencontrerez pas).  Et ce qui est plus intéressant, en plus, ils ont souvent une sorte de «privilège», contrairement à la même fille comptable, c'est-à-dire,  ils peuvent être moins violés en termes de sécurité et de restrictions du système (telles que les politiques et la coopération - il est nécessaire, par exemple, de faire fonctionner un exe-shnik nouvellement compilé) et / ou ils peuvent grimper à travers un «mur» construit par des agents de sécurité (par exemple, en forçant un tunnel via un proxy), etc.  etc. </p><br><p>  Encore une fois, parcourir la protection, en utilisant le programmeur ou l'administrateur en même temps, sonne complètement différent de, par exemple, «forcer» le cheval de Troie comptable à s'exécuter. </p><br><p>  C'est-à-dire  réception initiale, tâches exprimées - allons-y ... </p><br><p>  La première étape consiste à collecter des informations sur les «clients» - qui, quoi, où, quand. </p><br><p>  Je ne serai pas très distrait ici, l'article ne traite pas entièrement de ça, donc je vais juste dire - je me suis installé sur un gars plutôt social, avec Facebook et co, y compris sa propre chaîne youtube (YouTube, Vasya!), Plusieurs projets open source (à la fois dans le groupe et et propre) et juste une activité de contribution géante <del>  (demande, mais il travaille généralement à la place principale) </del>  . </p><br><p>  Découvrir hoo-hoo aujourd'hui n'est généralement pas un problème du tout (quelque part j'ai utilisé mon vrai nom dans un endroit avec un surnom, quelque part j'ai obtenu une adresse IP proxy de la société et l'image a été formée), mais personne ne le cache vraiment. </p><br><p>  J'ai été obligé de ralentir, y compris <del>  mon flair naturel </del>  le fait que dans l'une des communautés notre héros était engagé dans un support plus ou moins actif dans le chat, et en utilisant le client IRC, qui dans les informations utilisateur fournies en plus de l'IP, d'où les jambes grandissent, le nom et la version de lui-même aimaient, eh bien, c'était célèbre bugs / trous et par défaut, il a été enveloppé par des plugins combien en vain. </p><br><p>  Eh bien, comme d'habitude, un soir, <del>  la maison s'est endormie, une lie dans la boite, la nôtre perd à nouveau :) </del>  dans ce chat, j'ai trouvé un surnom familier en tant qu'utilisateur actif avec une connexion de plus de 12 heures (à en juger par le journal avec les déconnexions / reconnexions intermédiaires, car un proxy d'entreprise est une telle chose, mais plus d'une demi-journée depuis la première connexion), à partir de l'adresse IP dont j'ai besoin c'est-à-dire  avec un login du formulaire <code>max.mustermann@proxyext.our-company.example.com</code> . </p><br><p>  Autrement dit, soit notre client a un jour - 24 heures, ou plus probablement (parce que 2 heures se sont écoulées depuis son dernier message), il n'a tout simplement pas éteint l'ordinateur de travail et a laissé le client IRC actif. </p><br><p>  Ou peut-être qu'il a mis l'ordinateur en veille, mais (encore une fois, l'erreur de sécurité ou les administrateurs), il se produit que ce dernier se réveille, par exemple, pour mettre à jour les mises à jour pour Windows (et après une pause de 4 heures pour redémarrer) ou simplement attraper stupidement un signal de réveil sur réseau local. . </p><br><p>  Quoi qu'il en soit, j'ai eu un peu de temps pour tapoter l'ordinateur, ou plutôt le client IRC de notre «victime». </p><br><p>  Ne pas trouver un seul trou connu dans cette version spécifique (accessoirement pertinente à ce moment-là) du client IRC, armé d'un ida, ollydbg, etc.  et en jetant un coup d'œil à la source (horreur tranquille, Vasya!), il a commencé à rechercher une sorte de vulnérabilité qui lui permettrait au moins d'exécuter quelque chose là-bas, dans le but de contrôler au moins à distance le client IRC (et nous nous souvenons des plugins). </p><br><p>  Et il a été retrouvé, même relativement rapidement! </p><br><p>  L'interception du contrôle a permis l'appel <code>sprintf</code> non sécurisé vers le tampon à partir de la pile avec <code>%s</code> intérieur de l'entrée étrangère mal filtrée (en conjonction avec l'injection de codage), ce qui permet d'écrire «le chargeur de code d'exploitation» sur la pile au bon endroit (grâce aux développeurs du client pour le code, Microsoft pour la pile des basses terres et la chance). </p><br><p>  Bien que le tourment devait encore - parce que  nous avons DEP, vous ne pouvez pas exécuter directement à partir de la pile, vous devez écrire une copie du "code de programme" sur la pile pour exécution, trouver l'appel <code>memcpy</code> avec <code>ret</code> à la fin pour copier au bon endroit (réécrire la classe la moins utilisée), rediriger la sortie de plusieurs procédures vers le bon endroit, écraser plusieurs valeurs VTABLE afin de générer un événement en appelant la prochaine méthode virtuelle qui provoque du code python comme plug-in (et changez ce code python en votre propre, comme un chargeur de messages cassés, afin de déjà assembler un ready-made  ployt-toolkit). </p><br><p>  Oh oui, vous deviez toujours créer un plugin (merci encore aux développeurs du client pour ces fonctionnalités généreuses), en tant que proxy, changer les messages à la volée (ajouter un wrapper pour lancer une injection, rompre l'encodage pour cela, tout en insérant des substituts incomplets au bon endroit, et t etc.), encoder le chargeur initial du message d'injection, etc. <br>  De plus, j'ai dû créer un petit script python en tant que nouveau plugin client pour le système cible en tant qu'émulateur de console (recevoir mes messages dans son stdin et envoyer stdout + stderr dans un message privé à mon surnom). </p><br><p>  Après avoir rassemblé tout cela sur son genou, il a lancé ce client IRC afin de se juger en tant que victime, c'est-à-dire  voyez comment ce sera dans sa forme complète et finie. </p><br><p>  Et en envoyant via mon plug-in d'une autre session de la deuxième version lancée de l'application, plusieurs messages-injections privés, j'ai été ravi de voir le message d'accueil Python habituel <code>&gt;&gt;&gt;</code> (que j'ai collé dans l'émulateur, par souci de clarté - le python). </p><br><p>  Satisfait en tant qu'éléphant (notant que l'application attaquée n'est pas tombée), il a vu ce qui se passait dans sa fenêtre de sortie de message - elle était pleine de divers caractères non-ascii, dont le plus notable était <code> </code>  avec le numéro de série 90h (ce qui n'est au moins pas comme il faut, ça vous donne même une tentative de piratage), je pensais que je devais refaire le bootloader pour masquer les messages suivants (du coup ça marche toujours et ça se remarque). </p><br><p>  Il a examiné le code, et là, ils attendaient la ligne NTS à la sortie, il a décidé de ne pas déranger beaucoup et de réécrire bêtement le premier octet du message après le chargement de zéro (avec l'espoir que le message sera affiché à l'écran un peu plus tard). </p><br><p>  Répéter tout le processus et attendre le <code>&gt;&gt;&gt;</code> souhaité regarda à nouveau une autre fenêtre et découvrit qu'il n'y avait rien de superflu dans le chat <del>  (Je suis toujours un génie) </del>  , a décidé de poursuivre le test. <br>  Le message <code>from glob import glob as ls; ls('*')</code>  <code>from glob import glob as ls; ls('*')</code> et j'ai vu avec joie la réponse comme une liste de dossiers et de fichiers contenus dans le dossier de l'application. </p><br><p>  Certes, j'ai vu le même message dans la fenêtre du client attaquant que celui envoyé à mon surnom.  J'ai également dû mettre 0 octet (NTS) au début de la ligne après l'avoir envoyé. </p><br><p>  Ayant ainsi terminé la phase préparatoire, il a noté que notre ami expérimental était toujours en train de discuter (sans messages, Vasya!), Il avait déjà préparé un exploit pour notre candidat. </p><br><h4 id="poehali">  Allons-y ... </h4><br><p>  Les messages d'injection étaient partis ... Et après quelques longues secondes (apparemment le disque dormait ou le proxy était stupide) j'ai de nouveau vu l'invitation <code>&gt;&gt;&gt;</code> . <br>  Alors que je sautillais dans la pièce, je ne le dirai toujours pas (ce spectacle n'est pas pour les faibles de cœur, car à la suite d'un processus incontrôlé de manifestation de joie, j'ai quand même poussé mes petits pieds sur une jambe de chaise). </p><br><p>  Grimaçant de douleur et pensant immédiatement, «et si quelque chose n'est pas visible dans sa fenêtre de recul, j'ai soudainement foiré quelque part et l'application se bloque en conséquence», se souvient d'un possible redémarrage forcé après la mise à jour (si soudain l'ordinateur s'est réveillé de cela et a déjà roulé la mise à jour), dans une sueur froide (en regardant l'auriculaire gonflé et en enlevant les mains tremblantes) j'ai accéléré. </p><br><p>  La première étape consiste à vérifier au cas où nous serions là. </p><br><pre> <code class="python hljs"><span class="hljs-meta"><span class="hljs-meta">&gt;&gt;&gt; </span></span><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> os; os.environ[<span class="hljs-string"><span class="hljs-string">'userdomain'</span></span>]</code> </pre> <br><p>  et la réponse est: </p><br><pre> <code class="hljs ruby"><span class="hljs-string"><span class="hljs-string">'OUR-COMPANY'</span></span> <span class="hljs-meta"><span class="hljs-meta">&gt;&gt;&gt;</span></span></code> </pre> <br><p>  Eh bien, tout, les mains sont déliées ... Allons-y. </p><br><p>  Après avoir vérifié avec un petit script que logonui est verrouillé, après m'être un peu calmé, j'ai décidé de voir ce qui est disponible sur l'ordinateur en général: </p><br><pre> <code class="python hljs"><span class="hljs-meta"><span class="hljs-meta">&gt;&gt;&gt; </span></span><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> glob <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> glob <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> ls; ls(<span class="hljs-string"><span class="hljs-string">r'C:\Program Files\*'</span></span>)</code> </pre> <br><p>  et dans la réponse, ne croyant pas à sa chance, parmi beaucoup de choses intéressantes, j'ai vu ce qui suit: </p><br><pre> <code class="hljs powershell">[<span class="hljs-type"><span class="hljs-type">...</span></span>,<span class="hljs-string"><span class="hljs-string">'C:\\Program Files\\TeamViewer'</span></span>,<span class="hljs-type"><span class="hljs-type">...</span></span>] &gt;&gt;&gt;</code> </pre> <br><p>  C'est-à-dire  il n'est pas nécessaire de faire des gestes supplémentaires - vous n'avez pas besoin de télécharger quoi que ce soit, de compiler et de rechercher un dossier où vous pouvez tout écrire sans enfreindre les règles. </p><br><p>  Et puis en attendant a volé: </p><br><pre> <code class="python hljs"><span class="hljs-meta"><span class="hljs-meta">&gt;&gt;&gt; </span></span><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> subprocess; subprocess.call([<span class="hljs-string"><span class="hljs-string">r'C:\Program Files\TeamViewer\TeamViewer.exe'</span></span>])</code> </pre> <br><p>  Eh bien, après la réponse de retour: </p><br><pre> <code class="hljs ruby"><span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-meta"><span class="hljs-meta">&gt;&gt;&gt;</span></span></code> </pre> <br><p>  Après avoir attendu un moment pour que TeamViewer passe par le proxy et que le serveur lui ait donné un ID (avec mot de passe), j'ai exécuté un script là-bas, recherchant la fenêtre TeamViewer, en prenant une capture d'écran et en me la renvoyant sous la forme d'une ligne base64, dans laquelle, en la développant à nouveau bitmap, j'ai été heureux de trouver à la fois l'ID et le mot de passe pour la connexion. </p><br><p>  ... </p><br><p>  Le lendemain matin, j'ai été appelé par un <abbr title="Capitaine - Chef de la sécurité">OSC</abbr> surpris, qui a d'abord reçu une lettre de moi (mais pour une raison quelconque, venait du compte Exchange interne de son employé), puis un appel effrayé du même employé avec les mots «Chef, nous l'avons perdu - ils nous ont cassés», qui a trouvé une fenêtre ouverte le matin Mot avec un gros texte à l'intérieur "Deux pour votre sécurité. Vous avez été piraté!", Date, signature. </p><br><p>  Après cela, la communication avec les agents de sécurité était déjà plus fructueuse, sans éclaboussures de salive, sans déchirer les chemises et sans hurler.  Enseigné par une expérience amère ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">par exemple, comme décrit dans cet article</a> ), j'ai essayé autant que possible de reporter le cambriolage lui-même plus tard (parce qu'au début, je voulais recevoir un mandat pour un nouveau «concept de sécurité»), mais après beaucoup de persuasion, des indices de coopération à long terme, etc. n., ainsi que les promesses de leur part de "ne pas toucher" l'employé en cause (collègue après tout), ils ont dû énoncer presque tous les points principaux. </p><br><p>  J'ai ensuite reçu complètement la prime négociée pour le piratage (ainsi que le coût de l'audit préliminaire), mais ensuite le bureau s'est comporté ... disons, pas tout à fait sportif.  Pour poursuivre le concert, ils ont embauché un cabinet d'audit bien connu et bien connu, qui a essentiellement refusé de travailler avec externe en mon nom. </p><br><p>  Eh bien, comme on dit en Allemagne, "Man sieht sich immer zweimal im Leben", ce qui signifie "Soyez sûr de vous revoir". </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr416767/">https://habr.com/ru/post/fr416767/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr416757/index.html">Tests feuilletés</a></li>
<li><a href="../fr416759/index.html">Pourquoi l'intelligence artificielle ne résoudra pas tous les problèmes</a></li>
<li><a href="../fr416761/index.html">Langage cosmique, partie 1: la grammaire universelle est-elle universelle?</a></li>
<li><a href="../fr416763/index.html">Puppet Salt Chef Ensemble: comparez Ansible, SaltStack, Chef et Puppet</a></li>
<li><a href="../fr416765/index.html">Société Foliplast: un cycle complet de production numérique en Russie</a></li>
<li><a href="../fr416775/index.html">Un autre papercraft</a></li>
<li><a href="../fr416777/index.html">Le principe de fonctionnement du réseau neuronal convolutif. À peu près compliqué</a></li>
<li><a href="../fr416781/index.html">Qui sauvera la théorie de la relativité?</a></li>
<li><a href="../fr416783/index.html">Comment la révolution de la décentralisation changera-t-elle l'économie mondiale?</a></li>
<li><a href="../fr416785/index.html">Implémentation du nouveau protocole de transport NTCP2 du réseau I2P</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>