<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🐓 🤱🏽 🚐 تطبيقات سهلة وسهل النشر على خرطوشة Tarantool (الجزء الثاني) 🧖🏼 🕗 😑</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="في الآونة الأخيرة ، تحدثنا عن كيفية نشر التطبيقات المكتوبة في خرطوشة Tarantool . لكن العملية لا تنتهي عند النشر ، لذلك سنقوم اليوم بتحديث تطبيقنا وفهم...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>تطبيقات سهلة وسهل النشر على خرطوشة Tarantool (الجزء الثاني)</h1><div class="post__body post__body_full" style=";text-align:right;direction:rtl"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/mailru/blog/484192/" style=";text-align:right;direction:rtl"><p style=";text-align:right;direction:rtl"><img src="https://habrastorage.org/webt/yc/gm/xx/ycgmxxaqlvyslsrzoo6jnv1vmx0.jpeg"></p><br><p style=";text-align:right;direction:rtl">  في الآونة الأخيرة ، <a href="https://habr.com/ru/company/mailru/blog/478710/">تحدثنا</a> عن كيفية نشر التطبيقات المكتوبة في <a href="https://habr.com/ru/company/mailru/blog/465503/">خرطوشة Tarantool</a> .  لكن العملية لا تنتهي عند النشر ، لذلك سنقوم اليوم بتحديث تطبيقنا وفهم كيفية إدارة الطوبولوجيا والمشاركة والترخيص ، وكذلك تغيير تكوين الأدوار. </p><br><p style=";text-align:right;direction:rtl">  فضولي يرجى قطع! </p><a name="habracut"></a><br><h2 id="na-chem-my-ostanovilis" style=";text-align:right;direction:rtl">  أين توقفنا؟ </h2><br><p style=";text-align:right;direction:rtl">  آخر مرة قمنا بتكوين الطوبولوجيا التالية: </p><br><p style=";text-align:right;direction:rtl"><img src="https://habrastorage.org/webt/sw/0z/gm/sw0zgm53me7ft63db8lxrswcxvw.png"></p><br><p style=";text-align:right;direction:rtl"> تمكن <a href="https://github.com/dokshina/deploy-tarantool-cartridge-app">مستودع</a> المثال من تغيير بعض الملفات الجديدة التي ظهرت هناك ، و <code>getting-started-app-2.0.0-0.rpm</code> و <code>hosts.updated.2.yml</code> .  ليس عليك سحب الإصدار الجديد ، يمكنك فقط تنزيل الحزمة من <a href="">الرابط</a> ، <code>hosts.updated.2.yml</code> حاجة إلى <code>hosts.updated.2.yml</code> فقط حتى تتمكن من <code>hosts.updated.2.yml</code> نظرة خاطفة عليها في حالة وجود صعوبات في تغيير المخزون الحالي. </p><br><p style=";text-align:right;direction:rtl">  إذا كنت قد أكملت جميع خطوات الجزء السابق من هذا البرنامج التعليمي ، فحينئذٍ في <code>hosts.yml</code> hosts.yml لديك تكوين كتلة به نسختان متماثلتان <code>storage</code> (في المستودع ، هذا هو <code>hosts.updated.yml</code> ). </p><br><p style=";text-align:right;direction:rtl">  رفع أجهزتنا الافتراضية: </p><br><pre style=";text-align:right;direction:rtl"> <code class="bash hljs">$ vagrant up</code> </pre> <br><p style=";text-align:right;direction:rtl">  قم بتثبيت الإصدار الجديد من خرطوشة Tarantool ذات Ansible-role (تمكنت من تغييرها ، للأفضل): </p><br><pre style=";text-align:right;direction:rtl"> <code class="bash hljs">$ ansible-galaxy install tarantool.cartridge,1.0.2</code> </pre> <br><p style=";text-align:right;direction:rtl">  لذلك ، تكوين الكتلة الحالي: </p><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">--- all: vars: # common cluster variables cartridge_app_name: getting-started-app cartridge_package_path: ./getting-started-app-1.0.0-0.rpm # path to package cartridge_cluster_cookie: app-default-cookie # cluster cookie # common ssh options ansible_ssh_private_key_file: ~/.vagrant.d/insecure_private_key ansible_ssh_common_args: '-o IdentitiesOnly=yes -o UserKnownHostsFile=/dev/null -o StrictHostKeyChecking=no' # INSTANCES hosts: storage-1: config: advertise_uri: '172.19.0.2:3301' http_port: 8181 app-1: config: advertise_uri: '172.19.0.3:3301' http_port: 8182 storage-1-replica: config: advertise_uri: '172.19.0.3:3302' http_port: 8183 storage-2: config: advertise_uri: '172.19.0.3:3303' http_port: 8184 storage-2-replica: config: advertise_uri: '172.19.0.2:3302' http_port: 8185 children: # GROUP INSTANCES BY MACHINES host1: vars: # first machine connection options ansible_host: 172.19.0.2 ansible_user: vagrant hosts: # instances to be started on the first machine storage-1: storage-2-replica: host2: vars: # second machine connection options ansible_host: 172.19.0.3 ansible_user: vagrant hosts: # instances to be started on the second machine app-1: storage-1-replica: storage-2: # GROUP INSTANCES BY REPLICA SETS replicaset_app_1: vars: # replica set configuration replicaset_alias: app-1 failover_priority: - app-1 # leader roles: - 'api' hosts: # replica set instances app-1: replicaset_storage_1: vars: # replica set configuration replicaset_alias: storage-1 weight: 3 failover_priority: - storage-1 # leader - storage-1-replica roles: - 'storage' hosts: # replica set instances storage-1: storage-1-replica: replicaset_storage_2: vars: # replicaset configuration replicaset_alias: storage-2 weight: 2 failover_priority: - storage-2 - storage-2-replica roles: - 'storage' hosts: # replicaset instances storage-2: storage-2-replica:</code> </pre> <br><p style=";text-align:right;direction:rtl">  انتقل إلى <a href="http://localhost:8181/admin/cluster/dashboard">http: // localhost: 8181 / admin / cluster / dashboard</a> وتأكد من أن نظامك في الحالة الصحيحة. </p><br><p style=";text-align:right;direction:rtl">  كل شيء مماثل لآخر مرة: سنقوم بتغيير هذا الملف تدريجيًا ولاحظ كيف تتغير الكتلة.  يمكنك دائمًا إلقاء نظرة على الإصدار النهائي في <code>hosts.updated.2.yml</code> </p><br><p style=";text-align:right;direction:rtl">  لذلك نحن هنا نذهب! </p><br><h2 id="obnovlyaem-prilozhenie" style=";text-align:right;direction:rtl">  تحديث التطبيق </h2><br><p style=";text-align:right;direction:rtl">  لتبدأ ، دعونا تحديث التطبيق لدينا.  تأكد <code>getting-started-app-2.0.0-0.rpm</code> ملف <code>getting-started-app-2.0.0-0.rpm</code> في الدليل الحالي (إن لم يكن ، <code>getting-started-app-2.0.0-0.rpm</code> <a href="">بتنزيله</a> من المستودع). </p><br><p style=";text-align:right;direction:rtl">  حدد المسار إلى الإصدار الجديد من الحزمة: </p><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">--- all: vars: cartridge_app_name: getting-started-app cartridge_package_path: ./getting-started-app-2.0.0-0.rpm # &lt;== cartridge_enable_tarantool_repo: false # &lt;==</code> </pre> <br><p style=";text-align:right;direction:rtl">  لقد حددنا <code>cartridge_enable_tarantool_repo: false</code> بحيث لا يربط الدور مستودع التخزين بحزمة Tarantool ، التي قمنا بتثبيتها بالفعل في المرة الأخيرة.  سيؤدي ذلك إلى تسريع عملية النشر قليلاً ، لكنه ليس ضروريًا على الإطلاق. </p><br><p style=";text-align:right;direction:rtl">  قم بتشغيل playbook باستخدام علامة <code>cartridge-instances</code> : </p><br><pre style=";text-align:right;direction:rtl"> <code class="bash hljs">$ ansible-playbook -i hosts.yml playbook.yml \ --tags cartridge-instances</code> </pre> <br><p style=";text-align:right;direction:rtl">  ونحن نتحقق من أن الحزمة قد تم تحديثها: </p><br><pre style=";text-align:right;direction:rtl"> <code class="bash hljs">$ vagrant ssh vm1 [vagrant@svm1 ~]$ sudo yum list installed | grep getting-started-app</code> </pre> <br><p style=";text-align:right;direction:rtl">  تأكد من أن الإصدار أصبح <code>2.0.0</code> : </p><br><pre style=";text-align:right;direction:rtl"> <code class="bash hljs">getting-started-app.x86_64 2.0.0-0 installed</code> </pre> <br><p style=";text-align:right;direction:rtl">  يمكنك الآن تجربة الإصدار الجديد من التطبيق بأمان. </p><br><h2 id="vklyuchaem-shardirovanie" style=";text-align:right;direction:rtl">  بدوره على sharding </h2><br><p style=";text-align:right;direction:rtl">  فلنقم بتشغيل المشاركة حتى نتمكن من التحكم في النسخ المتماثلة <code>storage</code> لاحقًا.  يتم ذلك ببساطة شديدة.  أضف المتغير <code>cartridge_bootstrap_vshard</code> قسم <code>all.vars</code> : </p><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">--- all: vars: ... cartridge_cluster_cookie: app-default-cookie # cluster cookie cartridge_bootstrap_vshard: true # &lt;== ... hosts: ... children: ...</code> </pre> <br><p style=";text-align:right;direction:rtl">  نطلق: </p><br><pre style=";text-align:right;direction:rtl"> <code class="bash hljs">$ ansible-playbook -i hosts.yml playbook.yml \ --tags cartridge-config</code> </pre> <br><p style=";text-align:right;direction:rtl">  يرجى ملاحظة أننا حددنا علامة <code>cartridge-config</code> لتشغيل المهام فقط التي تشارك في تكوين الكتلة. </p><br><p style=";text-align:right;direction:rtl">  افتح Web UI <a href="http://localhost:8181/admin/cluster/dashboard">http: // localhost: 8181 / admin / cluster / dashboard</a> ونرى أن مجموعاتنا موزعة على مجموعات النسخ المتماثلة للتخزين بنسبة <code>2:3</code> (حددنا هذه الأوزان لمجموعات النسخ المتماثلة الخاصة بنا ، تذكر؟): </p><br><p style=";text-align:right;direction:rtl"><img src="https://habrastorage.org/webt/g_/vd/78/g_vd787hpifhrlhk-jfs5sw8iu4.png"></p><br><h2 id="vklyuchaem-avtomaticheskiy-failover" style=";text-align:right;direction:rtl">  قم بتشغيل الفشل التلقائي </h2><br><p style=";text-align:right;direction:rtl">  والآن سنقوم بتشغيل وضع الفشل التلقائي حتى نتمكن من معرفة ما هو عليه وكيف يعمل قليلاً في وقت لاحق. </p><br><p style=";text-align:right;direction:rtl">  أضف علامة <code>cartridge_failover</code> إلى التكوين: </p><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">--- all: vars: ... cartridge_cluster_cookie: app-default-cookie # cluster cookie cartridge_bootstrap_vshard: true cartridge_failover: true # &lt;== ... hosts: ... children: ...</code> </pre> <br><p style=";text-align:right;direction:rtl">  نبدأ مرة أخرى مهام إدارة الكتلة: </p><br><pre style=";text-align:right;direction:rtl"> <code class="bash hljs">$ ansible-playbook -i hosts.yml playbook.yml \ --tags cartridge-config</code> </pre> <br><p style=";text-align:right;direction:rtl">  بعد الانتهاء بنجاح من playbook ، يمكنك الانتقال إلى Web UI والتأكد من تبديل مفتاح <code>Failover</code> في الزاوية اليمنى العليا.  لإيقاف تشغيل وضع الفشل التلقائي ، ما عليك سوى تغيير قيمة <code>cartridge_failover</code> إلى <code>false</code> وتشغيل Playbook مرة أخرى. </p><br><p style=";text-align:right;direction:rtl">  لقد حان الوقت لمعرفة نوع النظام هذا ولماذا قمنا بتشغيله. </p><br><h2 id="razbiraemsya-s-failover-om" style=";text-align:right;direction:rtl">  نحن نتعامل مع الفشل </h2><br><p style=";text-align:right;direction:rtl">  ربما لاحظت متغير <code>failover_priority</code> الذي حددناه لكل مجموعة نسخ متماثلة.  دعونا نرى ما هو عليه. </p><br><p style=";text-align:right;direction:rtl">  توفر خرطوشة Tarantool وضع تجاوز الفشل التلقائي.  كل نسخة متماثلة لها قائد - المثيل الذي يتم تسجيله به.  إذا حدث شيء للزعيم ، فستتولى إحدى الملاحظات دوره.  أي واحد؟  دعونا نلقي نظرة فاحصة على مجموعة النسخ المتماثلة <code>storage-2</code> : </p><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">--- all: ... children: ... replicaset_storage_2: vars: ... failover_priority: - storage-2 - storage-2-replica</code> </pre> <br><p style=";text-align:right;direction:rtl">  مثيل <code>storage-2</code> الذي حددناه أولاً في <code>failover_priority</code> .  في Web UI ، يظهر أولاً في قائمة مثيلات النسخ المتماثلة ويتميز بتاج أخضر.  هذا هو القائد - المثيل الأول المحدد في <code>failover_priority</code> : </p><br><p style=";text-align:right;direction:rtl"><img src="https://habrastorage.org/webt/ge/om/bg/geombgvhy6plfnrwpz0o8jqgnaw.png"></p><br><p style=";text-align:right;direction:rtl">  الآن دعونا نرى ما يحدث إذا حدث شيء لقائد مجموعة النسخ المتماثلة.  نذهب إلى الجهاز الظاهري وإيقاف مثيل <code>storage-2</code> : </p><br><pre style=";text-align:right;direction:rtl"> <code class="bash hljs">$ vagrant ssh vm2 [vagrant@vm2 ~]$ sudo systemctl stop getting-started-app@storage-2</code> </pre> <br><p style=";text-align:right;direction:rtl">  العودة إلى الويب UI: </p><br><p style=";text-align:right;direction:rtl"><img src="https://habrastorage.org/webt/iy/b2/ff/iyb2ff_a6dryhg0nik8p48rhqhm.png"></p><br><p style=";text-align:right;direction:rtl">  تحول التاج في مثيل <code>storage-2</code> إلى اللون الأحمر - وهذا يعني أن الزعيم المعين غير صحي.  لكن <code>storage-2-replica</code> له <code>storage-2-replica</code> تاج أخضر - تولى هذا المثال مسؤوليات القيادة حتى يعود <code>storage-2</code> إلى الخدمة.  هذا هو الفشل التلقائي في العمل. </p><br><p style=";text-align:right;direction:rtl">  لنقم بإحياء <code>storage-2</code> : </p><br><pre style=";text-align:right;direction:rtl"> <code class="bash hljs">$ vagrant ssh vm2 [vagrant@vm2 ~]$ sudo systemctl start getting-started-app@storage-2</code> </pre> <br><p style=";text-align:right;direction:rtl">  عاد كل شيء إلى المربع الأول: </p><br><p style=";text-align:right;direction:rtl"><img src="https://habrastorage.org/webt/ge/om/bg/geombgvhy6plfnrwpz0o8jqgnaw.png"></p><br><p style=";text-align:right;direction:rtl">  دعنا نغير ترتيب الحالات في أولوية الفشل.  سنجعل مثيل <code>storage-2-replica</code> قائدًا ، ونزيل <code>storage-2</code> من القائمة بشكل عام: </p><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">--- all: vars: ... hosts: ... children: ... replicaset_storage_2: vars: # replicaset configuration ... failover_priority: - storage-2-replica # &lt;== ...</code> </pre> <br><p style=";text-align:right;direction:rtl">  قم بتشغيل <code>cartridge-replicasets</code> لمثيلات من مجموعة <code>replicaset_storage_2</code> : </p><br><pre style=";text-align:right;direction:rtl"> <code class="bash hljs">$ ansible-playbook -i hosts.yml playbook.yml \ --<span class="hljs-built_in"><span class="hljs-built_in">limit</span></span> replicaset_storage_2 \ --tags cartridge-replicasets</code> </pre> <br><p style=";text-align:right;direction:rtl">  نذهب إلى <a href="http://localhost:8181/admin/cluster/dashboard">http: // localhost: 8181 / admin / cluster / dashboard</a> ونرى أن الزعيم قد تغير: </p><br><p style=";text-align:right;direction:rtl"><img src="https://habrastorage.org/webt/r_/hq/bm/r_hqbmgxwbkvcycacj7pnotjhjc.png"></p><br><p style=";text-align:right;direction:rtl">  لكننا أزلنا مثيل <code>storage-2</code> من التكوين ، لماذا لا يزال هنا؟  والحقيقة هي أن Cartridge ، التي تتلقى قيمة جديدة من <code>failover_priority</code> تنظم الحالات على النحو التالي: تصبح الحالة الأولى من القائمة هي الرائدة ، فيما يلي بقية الحالات المشار إليها.  سيتم طلب المثيلات غير المذكورة في <code>failover_priority</code> بواسطة UUID وإلحاقها حتى النهاية. </p><br><h2 id="izgnanie-instansa" style=";text-align:right;direction:rtl">  حالة المنفى </h2><br><p style=";text-align:right;direction:rtl">  ولكن ماذا لو أردنا استبعاد المثيل من الهيكل؟  كل شيء بسيط للغاية: تحتاج إلى تمرير العلم <code>expelled</code> .  دعنا نستبعد مثيل <code>storage-2-replica</code> .  إنه القائد الآن ، لذلك لن تسمح لنا Cartridge بالقيام بذلك.  لكننا لسنا خائفين من الصعوبات ، وما زلنا نحاول: </p><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">--- all: vars: ... hosts: storage-2-replica: config: advertise_uri: '172.19.0.2:3302' http_port: 8185 expelled: true # &lt;== ...</code> </pre> <br><p style=";text-align:right;direction:rtl">  نحدد <code>cartridge-replicasets</code> ، حيث أن طرد مثيل يعد تغييرًا في الهيكل: </p><br><pre style=";text-align:right;direction:rtl"> <code class="bash hljs">$ ansible-playbook -i hosts.yml playbook.yml \ --<span class="hljs-built_in"><span class="hljs-built_in">limit</span></span> replicaset_storage_2 \ --tags cartridge-replicasets</code> </pre> <br><p style=";text-align:right;direction:rtl">  قم بتشغيل playbook وشاهد الخطأ: </p><br><p style=";text-align:right;direction:rtl"><img src="https://habrastorage.org/webt/hf/wf/tc/hfwftcua4yyueyi0qgngr2mveia.png"></p><br><p style=";text-align:right;direction:rtl">  كما رأينا للتو ، لا تبرر Cartridge إخراج زعيم النسخ المتماثل الحالي من الهيكل.  هذا منطقي تمامًا ، نظرًا لأن النسخ المتماثل غير متزامن ، فمن المحتمل أن يؤدي استبعاد قائد إلى فقدان البيانات.  نحتاج إلى تحديد قائد آخر وفقط بعد استبعاد المثيل.  سيقوم الدور أولاً بتطبيق تكوين مجموعات النسخ المتماثل الجديد ثم التعامل مع الاستثناء.  لذلك ، نغير <code>failover_priority</code> ونشغل كتاب اللعب مرة أخرى: </p><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">--- all: vars: ... hosts: ... children: ... replicaset_storage_2: vars: # replicaset configuration ... failover_priority: - storage-2 # &lt;== ...</code> </pre> <br><pre style=";text-align:right;direction:rtl"> <code class="bash hljs">$ ansible-playbook -i hosts.yml playbook.yml \ --<span class="hljs-built_in"><span class="hljs-built_in">limit</span></span> replicaset_storage_2 \ --tags cartridge-replicasets</code> </pre> <br><p style=";text-align:right;direction:rtl">  فويلا ، اختفى مثيل <code>storage-2-replica</code> من الطبولوجيا! </p><br><p style=";text-align:right;direction:rtl"><img src="https://habrastorage.org/webt/tl/ao/ue/tlaoue_hclprc1i6tdjuil5efyk.png"></p><br><p style=";text-align:right;direction:rtl">  لاحظ أن نفي المثيل نهائي نهائي ولا رجعة فيه.  بعد إزالة المثيل من الهيكل ، سيؤدي دورنا الظاهر إلى إيقاف خدمة systemd وحذف جميع ملفات هذه النسخة. </p><br><p style=";text-align:right;direction:rtl"><img src="https://habrastorage.org/webt/_7/bp/nx/_7bpnxxuydmfmddneontw1nxexi.png"></p><br><p style=";text-align:right;direction:rtl">  إذا غيرت رأيك فجأة وقررت أن مجموعة النسخ المتماثلة <code>storage-2</code> لا تزال بحاجة إلى مثيل آخر ، فلن تتمكن من استعادته.  تتذكر الخرطوشة UUID بجميع الحالات التي تركت الهيكل ولن تسمح للنفي بالعودة.  يمكنك رفع مثيل جديد بنفس الاسم والتكوين ، ولكن من الواضح أنه سيكون له UUID مختلف ، لذلك ستسمح لك Cartridge بالانضمام. </p><br><h2 id="udalenie-replikaseta" style=";text-align:right;direction:rtl">  إزالة النسخ المتماثلة </h2><br><p style=";text-align:right;direction:rtl">  لقد اكتشفنا بالفعل أنه لن يُسمح لنا بطرد قائد مجموعة النسخ المتماثلة.  ولكن ماذا لو أردنا إزالة النسخة المتماثلة <code>storage-2</code> بشكل دائم؟  هناك ، بالطبع ، مخرج. </p><br><p style=";text-align:right;direction:rtl">  لكي لا نفقد البيانات ، يجب علينا أولاً نقل جميع المجموعات إلى <code>storage-1</code> ، ولهذا قمنا بتعيين وزن النسخة المتماثلة <code>storage-2</code> على <code>0</code> : </p><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">--- all: vars: ... hosts: ... children: ... replicaset_storage_2: vars: # replicaset configuration replicaset_alias: storage-2 weight: 0 # &lt;== ... ...</code> </pre> <br><p style=";text-align:right;direction:rtl">  إطلاق إدارة الطوبولوجيا: </p><br><pre style=";text-align:right;direction:rtl"> <code class="bash hljs">$ ansible-playbook -i hosts.yml playbook.yml \ --<span class="hljs-built_in"><span class="hljs-built_in">limit</span></span> replicaset_storage_2 \ --tags cartridge-replicasets</code> </pre> <br><p style=";text-align:right;direction:rtl">  افتح Web UI <a href="http://localhost:8181/admin/cluster/dashboard">http: // localhost: 8181 / admin / cluster / dashboard</a> وشاهد كيف تتدفق جميع <a href="http://localhost:8181/admin/cluster/dashboard">المجموعات</a> في <code>storage-1</code> : </p><br><p style=";text-align:right;direction:rtl"><img src="https://habrastorage.org/webt/nk/mo/fq/nkmofqnvvoccqfqkyz1myryu4-s.png"></p><br><p style=";text-align:right;direction:rtl">  لقد قمنا بتعيين زعيم <code>storage-2</code> للعلم المُطرد ونقول وداعًا لهذه النسخ المتماثلة: </p><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">--- all: vars: ... hosts: ... storage-2: config: advertise_uri: '172.19.0.3:3303' http_port: 8184 expelled: true # &lt;== ...</code> </pre> <br><pre style=";text-align:right;direction:rtl"> <code class="bash hljs">$ ansible-playbook -i hosts.yml playbook.yml \ --tags cartridge-replicasets</code> </pre> <br><p style=";text-align:right;direction:rtl">  يرجى ملاحظة أنه في هذه المرة لم نقم بتحديد خيار <code>limit</code> ، لأنه يجب ألا يتم وضع علامة على الأقل على مثيل واحد على الأقل من كل شيء أطلقنا منه كتاب اللعب. </p><br><p style=";text-align:right;direction:rtl">  لذلك عدنا إلى الهيكل الأصلي: </p><br><p style=";text-align:right;direction:rtl"><img src="https://habrastorage.org/webt/70/zo/vq/70zovqqaeiph6v1bjoenzl_hn1w.png"></p><br><h2 id="avtorizaciya" style=";text-align:right;direction:rtl">  ترخيص </h2><br><p style=";text-align:right;direction:rtl">  أقترح صرف الانتباه عن إدارة مجموعات النسخ المتماثلة والتفكير في الأمان.  الآن يمكن لأي مستخدم غير مصرح له إدارة الكتلة من خلال Web UI.  موافق ، يبدو الأمر كذلك. </p><br><p style=";text-align:right;direction:rtl">  توفر Cartridge القدرة على توصيل وحدة الترخيص الخاصة بك ، مثل LDAP (أو أي شيء لديك) ، واستخدامها لإدارة المستخدمين ووصولهم إلى التطبيق.  لكننا سنستخدم وحدة التخويل المدمجة ، والتي تستخدمها Cartridge افتراضيًا.  تسمح لك هذه الوحدة بإجراء عمليات أساسية مع المستخدمين (حذف ، إضافة ، تحرير) وتنفيذ وظيفة التحقق من كلمة المرور. <br>  يرجى ملاحظة أن دورنا ansible يتطلب الخلفية إذن لتنفيذ جميع هذه الوظائف. </p><br><p style=";text-align:right;direction:rtl">  لذلك ، نحن ننتقل من النظرية إلى الممارسة.  أولاً ، جعل التفويض إلزاميًا ، واضبط معلمات الجلسة وأضف مستخدمًا جديدًا: </p><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">--- all: vars: ... # authorization cartridge_auth: # &lt;== enabled: true # enable authorization cookie_max_age: 1000 cookie_renew_age: 100 users: # cartridge users to set up - username: dokshina password: cartridge-rullez fullname: Elizaveta Dokshina email: dokshina@example.com # deleted: true # uncomment to delete user ...</code> </pre> <br><p style=";text-align:right;direction:rtl">  يتم تنفيذ إدارة التفويض كجزء من مهام <code>cartridge-config</code> إلى هذه العلامة: </p><br><pre style=";text-align:right;direction:rtl"> <code class="bash hljs">$ ansible-playbook -i hosts.yml playbook.yml \ --tags cartridge-config</code> </pre> <br><p style=";text-align:right;direction:rtl">  على <a href="http://localhost:8181/admin/cluster/dashboard">http: // localhost: 8181 / admin / cluster / dashboard</a> تنتظرنا مفاجأة: </p><br><p style=";text-align:right;direction:rtl"><img src="https://habrastorage.org/webt/a2/t8/pq/a2t8pqil4sxnosey38i-baf3q1k.png"></p><br><p style=";text-align:right;direction:rtl">  يمكنك تسجيل الدخول باستخدام <code>username</code> <code>password</code> للمستخدم الجديد أو تسجيل الدخول كمسؤول - المستخدم الافتراضي.  كلمة مروره هي ملف تعريف الارتباط العنقودي ، لقد حددنا هذه القيمة في <code>cartridge_cluster_cookie</code> المتغير (هذا هو <code>app-default-cookie</code> ، لا يمكنك إلقاء نظرة خاطفة عليه). </p><br><p style=";text-align:right;direction:rtl">  بعد تسجيل دخول ناجح ، افتح علامة التبويب <code>Users</code> للتأكد من أن كل شيء سار على ما يرام: </p><br><p style=";text-align:right;direction:rtl"><img src="https://habrastorage.org/webt/af/h_/9o/afh_9ofcv7htwplfgomnxejosxo.png"></p><br><p style=";text-align:right;direction:rtl">  تجربة إضافة مستخدمين جدد وتغيير إعداداتهم.  لحذف مستخدم ، حدد العلامة <code>deleted: true</code>  لا تستخدم Cartridge قيم <code>email</code> وقيم الاسم <code>fullname</code> بأي طريقة ، ولكن يمكنك تحديدها للراحة. </p><br><h2 id="konfiguraciya-prilozheniya" style=";text-align:right;direction:rtl">  تكوين التطبيق </h2><br><p style=";text-align:right;direction:rtl">  دعونا نتذكر كيف بدأ كل شيء. </p><br><p style=";text-align:right;direction:rtl">  لقد قمنا بنشر تطبيق صغير يخزّن بيانات العملاء وحساباتهم المصرفية.  كما تتذكر ، هذا التطبيق له أدوار 2: <code>api</code> <code>storage</code> .  يعالج دور <code>storage</code> البيانات وينفذ عملية المشاركة باستخدام دور التخزين المدمج في <code>vshard-storage</code> .  الدور الثاني ، <code>api</code> ، ينفذ خادم HTTP مع واجهة برمجة تطبيقات لإدارة البيانات ، بالإضافة إلى داخله متصل <code>vshard-router</code> قياسية أخرى ، <code>vshard-router</code> ، والتي تتحكم في المشاركة. </p><br><p style=";text-align:right;direction:rtl">  لذلك ، نحن نقدم الطلب الأول إلى API التطبيق.  إضافة عميل جديد: </p><br><pre style=";text-align:right;direction:rtl"> <code class="bash hljs">$ curl -X POST -H <span class="hljs-string"><span class="hljs-string">"Content-Type: application/json"</span></span> \ -d <span class="hljs-string"><span class="hljs-string">'{"customer_id":1, "name":"Elizaveta", "accounts":[{"account_id": 1}]}'</span></span> \ http://localhost:8182/storage/customers/create</code> </pre> <br><p style=";text-align:right;direction:rtl">  استجابة لذلك ، حصلنا على شيء مثل هذا: </p><br><pre style=";text-align:right;direction:rtl"> <code class="bash hljs">{<span class="hljs-string"><span class="hljs-string">"info"</span></span>:<span class="hljs-string"><span class="hljs-string">"Successfully created"</span></span>}</code> </pre> <br><p style=";text-align:right;direction:rtl">  يرجى ملاحظة أنه في عنوان URL ، حددنا <code>app-1</code> port مثيل <code>app-1</code> ، <code>8082</code> ، لأنه ينفذ واجهة برمجة التطبيقات هذه. </p><br><p style=";text-align:right;direction:rtl">  الآن دعونا نقوم بتحديث رصيد مستخدمنا الجديد: </p><br><pre style=";text-align:right;direction:rtl"> <code class="bash hljs">$ curl -X POST -H <span class="hljs-string"><span class="hljs-string">"Content-Type: application/json"</span></span> \ -d <span class="hljs-string"><span class="hljs-string">"{\"account_id\": 1, \"amount\": \"1000\"}"</span></span> \ http://localhost:8182/storage/customers/1/update_balance</code> </pre> <br><p style=";text-align:right;direction:rtl">  في الرد نرى الرصيد المحدث: </p><br><pre style=";text-align:right;direction:rtl"> <code class="bash hljs">{<span class="hljs-string"><span class="hljs-string">"balance"</span></span>:<span class="hljs-string"><span class="hljs-string">"1000.00"</span></span>}</code> </pre> <br><p style=";text-align:right;direction:rtl">  عظيم ، كل شيء يعمل!  يتم تنفيذ واجهة برمجة التطبيقات ، وتشارك Cartridge في مشاركة البيانات ، وقد أنشأنا بالفعل أولوية تجاوز الفشل لحالات الطوارئ وحتى تمكين التفويض.  لقد حان الوقت للقيام بتكوين التطبيق. </p><br><p style=";text-align:right;direction:rtl">  يتم تخزين تكوين الكتلة الحالي في ملف التكوين الموزع.  يحتفظ كل مثيل بنسخة من هذا الملف ، وتضمن الخرطوشة التزامن بين جميع عقد المجموعة.  يمكننا تحديد تكوين أدوار تطبيقنا في هذا الملف ، وسوف تتولى Cartridge توزيع التكوين الجديد في جميع الحالات. </p><br><p style=";text-align:right;direction:rtl">  لنلقِ نظرة على المحتويات الحالية لهذا الملف.  انتقل إلى علامة التبويب " <code>Cofiguration files</code> وانقر فوق الزر " <code>Download</code> : </p><br><p style=";text-align:right;direction:rtl"><img src="https://habrastorage.org/webt/wx/xw/vc/wxxwvcdusefetrgyaxpnnrvxwya.png"></p><br><p style=";text-align:right;direction:rtl">  في <code>config.yml</code> config.yml الذي تم تنزيله <code>config.yml</code> نجد جدولًا فارغًا.  لا عجب ، لأننا لم نحدد أي معلمات حتى الآن: </p><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">--- [] ...</code> </pre> <br><p style=";text-align:right;direction:rtl">  في الواقع ، ملف التكوين الخاص بمجموعتنا ليس فارغًا ، فهو يخزن الهيكل الحالي وإعدادات التفويض وإعدادات المشاركة.  لكن لن تكون مشاركة هذه المعلومات في Cartridge سهلة ، فهي مخصصة للاستخدام الداخلي ، وبالتالي يتم تخزينها في أقسام النظام المخفية ، والتي لا يمكننا تحريرها. </p><br><p style=";text-align:right;direction:rtl">  يمكن لكل دور تطبيق استخدام قسم أو أكثر من أقسام التكوين.  يحدث تنزيل تكوين جديد على مرحلتين: أولاً ، تحقق كل الأدوار من استعدادها لقبول معلمات جديدة.  إذا لم يكن هناك اعتراض ، فسيتم تطبيق التغييرات ، وإذا كان هناك شخص ما يعارضها ، فسوف يحدث التراجع. </p><br><p style=";text-align:right;direction:rtl">  دعنا نعود إلى طلبنا.  يستخدم دور <code>api</code> قسم <code>max-balance</code> ، حيث يتم تخزين الحد الأقصى للرصيد المسموح به على حساب عميل واحد.  دعنا نهيئ هذا القسم ، لكن ، بالطبع ، ليس يدويًا ، ولكن باستخدام دورنا Ansible. </p><br><p style=";text-align:right;direction:rtl">  لذا ، فإن تكوين التطبيق (أو بالأحرى ، جزء منه متاح لنا) هو جدول فارغ.  إضافة قسم <code>max-balance</code> بقيمة <code>100000</code> .  نكتب المتغير <code>cartridge_app_config</code> في ملف مخزوننا: </p><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">--- all: vars: ... # cluster-wide config cartridge_app_config: # &lt;== max-balance: # section name body: 1000000 # section body # deleted: true # uncomment to delete section max-balance ...</code> </pre> <br><p style=";text-align:right;direction:rtl">  حددنا اسم القسم ، <code>max-balance</code> ، ومحتوياته ، <code>body</code> .  لا يمكن أن تكون محتويات القسم مجرد رقم ، بل يمكن أن تكون أيضًا جدولًا أو صفًا بناءً على كيفية كتابة الدور ونوع القيمة التي تريد استخدامها. </p><br><p style=";text-align:right;direction:rtl">  نطلق: </p><br><pre style=";text-align:right;direction:rtl"> <code class="bash hljs">$ ansible-playbook -i hosts.yml playbook.yml \ --tags cartridge-config</code> </pre> <br><p style=";text-align:right;direction:rtl">  ونحن نتحقق من أن الحد الأقصى للرصيد المسموح به قد تغير بالفعل: </p><br><pre style=";text-align:right;direction:rtl"> <code class="bash hljs">$ curl -X POST -H <span class="hljs-string"><span class="hljs-string">"Content-Type: application/json"</span></span> \ -d <span class="hljs-string"><span class="hljs-string">"{\"account_id\": 1, \"amount\": \"1000001\"}"</span></span> \ http://localhost:8182/storage/customers/1/update_balance</code> </pre> <br><p style=";text-align:right;direction:rtl">  ردا على ذلك ، حصلنا على خطأ ، كما أردنا: </p><br><pre style=";text-align:right;direction:rtl"> <code class="bash hljs">{<span class="hljs-string"><span class="hljs-string">"info"</span></span>:<span class="hljs-string"><span class="hljs-string">"Error"</span></span>,<span class="hljs-string"><span class="hljs-string">"error"</span></span>:<span class="hljs-string"><span class="hljs-string">"Maximum is 1000000"</span></span>}</code> </pre> <br><p style=";text-align:right;direction:rtl">  يمكنك إعادة تنزيل ملف التكوين في علامة التبويب <code>Configuraion files</code> للتأكد من ظهور قسم جديد هناك: </p><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">--- max-balance: 1000000 ...</code> </pre> <br><p style=";text-align:right;direction:rtl">  حاول إضافة أقسام جديدة إلى تكوين التطبيق أو تغيير محتوياتها أو حذفها تمامًا (لهذا تحتاج إلى تعيين العلامة <code>deleted: true</code> علامة <code>deleted: true</code> في القسم). </p><br><p style=";text-align:right;direction:rtl">  يمكنك معرفة كيفية استخدام التكوين الموزع في الأدوار في <a href="https://www.tarantool.io/ru/rocks/cartridge/1.0/modules/cartridge.clusterwide-config/">وثائق</a> خرطوشة Tarantool. </p><br><p style=";text-align:right;direction:rtl">  تذكر أن تتصل <code>vagrant halt</code> لإيقاف <code>vagrant halt</code> عند الانتهاء من العمل معها. </p><br><h2 id="v-zaklyuchenie" style=";text-align:right;direction:rtl">  في الختام </h2><br><p style=";text-align:right;direction:rtl">  آخر مرة ، تعلمنا كيفية نشر تطبيقات خرطوشة Tarantool الموزعة باستخدام دور Ansible خاص.  اليوم قمنا بتحديث التطبيق ، وكذلك أتقن إدارة الطوبولوجيا والمشاركة والتصريح والتكوين للتطبيق. </p><br><p style=";text-align:right;direction:rtl">  لا تتوقف عند هذا الحد ، وتعلم <a href="https://docs.ansible.com/ansible/latest/user_guide/playbooks_best_practices.html">طرقًا مختلفة</a> لكتابة كتب Ansible ، واستخدم تطبيقاتك بأقصى درجات الراحة. </p><br><p style=";text-align:right;direction:rtl">  إذا لم ينجح شيء من أجلك أو إذا كان لديك أفكار حول كيفية تحسين دورنا الظاهر ، فلا تتردد في بدء <a href="https://github.com/tarantool/ansible-cartridge/issues/new">تذكرة</a> .  سنساعد دائمًا في حل مشكلتك وسنكون سعداء بعروض مثيرة للاهتمام! </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/ar484192/">https://habr.com/ru/post/ar484192/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ar484178/index.html">ذكي التبديل إيثرنت لكوكب الأرض</a></li>
<li><a href="../ar484180/index.html">Rostelecom الظاهري PBX: ماذا وكيف يمكن القيام به من خلال API</a></li>
<li><a href="../ar484182/index.html">Xenobots: الكائنات النانوية الحية من خلايا الضفادع</a></li>
<li><a href="../ar484186/index.html">LDAP - "المصادقة" هي أداة مضادة</a></li>
<li><a href="../ar484188/index.html">معايير تصميم قواعد البيانات</a></li>
<li><a href="../ar484194/index.html">Kubernetes تترجم إلى الأطفال</a></li>
<li><a href="../ar484196/index.html">تسجيل صوت JS من ميكروفون أو تعليقات صوتية</a></li>
<li><a href="../ar484198/index.html">الجانب العكسي للعملة: الذي فاز وخسر على نمو أسهم تسلا</a></li>
<li><a href="../ar484200/index.html">كيفية وضع الأهداف لتحقيقها</a></li>
<li><a href="../ar484202/index.html">التعلم الآلي في التحليل الثابت لبرنامج شفرة المصدر</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>