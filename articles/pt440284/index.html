<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üñ§ üò∑ üë®üèø‚Äçü§ù‚Äçüë®üèæ Uma nova vis√£o da exibi√ß√£o de di√°logos no Android üç≥ üëßüèª üïö</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="A figura mostra o primeiro pensamento do leitor que se pergunta o que pode ser escrito sobre uma tarefa t√£o simples como exibir um di√°logo. O gerente ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Uma nova vis√£o da exibi√ß√£o de di√°logos no Android</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/mobileup/blog/440284/"><p> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><img src="https://habrastorage.org/webt/cu/u9/xl/cuu9xl-sjrrfz5v4pqqh9hocnxo.png"></a> </p><br><p>  A figura mostra o primeiro pensamento do leitor que se pergunta o que pode ser escrito sobre uma tarefa t√£o simples como exibir um di√°logo.  O gerente pensa da mesma forma: "N√£o h√° nada complicado aqui, nosso <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Vasya</a> far√° em 5 minutos".  √â claro que exagerei, mas na realidade nem tudo √© t√£o simples quanto parece √† primeira vista.  Especialmente se estamos falando sobre Android. </p><br><p>  Ent√£o, 2019 estava no quintal e <strong>ainda n√£o sabemos como exibir di√°logos corretamente</strong> . </p><a name="habracut"></a><br><p>  Vamos faz√™-lo em ordem e come√ßar com a declara√ß√£o do problema: </p><br><blockquote>  √â necess√°rio mostrar um di√°logo simples com o texto para confirmar a a√ß√£o e os bot√µes "confirmar / cancelar".  Ao clicar no bot√£o "confirmar" - execute uma a√ß√£o, no bot√£o "cancelar" - feche a caixa de di√°logo. </blockquote><br><h1 id="reshenie-v-lob">  Solu√ß√£o na testa </h1><br><p>  Eu chamaria esse m√©todo de junior, porque n√£o √© a primeira vez que me deparei com um mal-entendido por que voc√™ n√£o pode simplesmente usar o AlertDialog, como mostrado abaixo: </p><br><pre><code class="kotlin hljs">AlertDialog.Builder(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>) .setMessage(<span class="hljs-string"><span class="hljs-string">"Please, confirm the action"</span></span>) .setPositiveButton(<span class="hljs-string"><span class="hljs-string">"Confirm"</span></span>) { dialog, which -&gt; <span class="hljs-comment"><span class="hljs-comment">// handle click } .setNegativeButton("Cancel", null) .create() .show()</span></span></code> </pre> <br><p>  Uma maneira bastante comum para um desenvolvedor iniciante, √© √≥bvio e intuitivo.  Mas, como em muitos casos, ao trabalhar com o Android, esse m√©todo est√° completamente errado.  Do nada, temos um vazamento de mem√≥ria, basta ligar o dispositivo e voc√™ ver√° o seguinte erro nos logs: </p><br><div class="spoiler">  <b class="spoiler_title">stacktrace</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">E/WindowManager: android.view.WindowLeaked: Activity com.example.testdialog.MainActivity has leaked window DecorView@71b5789[MainActivity] that was originally added here at android.view.ViewRootImpl.&lt;init&gt;(ViewRootImpl.java:511) at android.view.WindowManagerGlobal.addView(WindowManagerGlobal.java:346) at android.view.WindowManagerImpl.addView(WindowManagerImpl.java:93) at android.app.Dialog.show(Dialog.java:329) at com.example.testdialog.MainActivity.onCreate(MainActivity.kt:27) at android.app.Activity.performCreate(Activity.java:7144) at android.app.Activity.performCreate(Activity.java:7135) at android.app.Instrumentation.callActivityOnCreate(Instrumentation.java:1271) at android.app.ActivityThread.performLaunchActivity(ActivityThread.java:2931) at android.app.ActivityThread.handleLaunchActivity(ActivityThread.java:3086) at android.app.servertransaction.LaunchActivityItem.execute(LaunchActivityItem.java:78) at android.app.servertransaction.TransactionExecutor.executeCallbacks(TransactionExecutor.java:108) at android.app.servertransaction.TransactionExecutor.execute(TransactionExecutor.java:68) at android.app.ActivityThread$H.handleMessage(ActivityThread.java:1816) at android.os.Handler.dispatchMessage(Handler.java:106) at android.os.Looper.loop(Looper.java:193) at android.app.ActivityThread.main(ActivityThread.java:6718) at java.lang.reflect.Method.invoke(Native Method) at com.android.internal.os.RuntimeInit$MethodAndArgsCaller.run(RuntimeInit.java:493) at com.android.internal.os.ZygoteInit.main(ZygoteInit.java:858)</code> </pre></div></div><br><p>  No Stackoverflow, a <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">pergunta</a> sobre esse problema √© uma das mais populares.  Em resumo, o problema √© que mostramos a caixa de di√°logo ou n√£o a fechamos ap√≥s a conclus√£o da ativa√ß√£o. </p><br><p>  Obviamente, voc√™ pode cancelar a chamada na caixa de di√°logo na atividade onPause ou onDestroy, conforme recomendado na resposta por <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">refer√™ncia</a> .  Mas isso n√£o √© exatamente o que precisamos.  Queremos que o di√°logo se recupere depois de ligar o dispositivo. </p><br><h1 id="ustarevshiy-sposob">  Maneira desatualizada </h1><br><p>  Antes de os fragmentos aparecerem no Android, as caixas de di√°logo deveriam ser exibidas por meio de uma chamada para o m√©todo de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">ativa√ß√£o showDialog</a>  Nesse caso, a atividade gerencia corretamente o ciclo de vida do di√°logo e o restaura ap√≥s um turno.  A cria√ß√£o do pr√≥prio di√°logo teve que ser implementada no retorno de chamada onCreateDialog: </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MainActivity</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Activity</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> CONFIRMATION_DIALOG_ID = <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-comment"><span class="hljs-comment">// ... @Override protected Dialog onCreateDialog(int id, Bundle args) { if (id == CONFIRMATION_DIALOG_ID) { return new AlertDialog.Builder(this) .setMessage("Please, confirm the action") .setPositiveButton("Confirm", new DialogInterface.OnClickListener() { @Override public void onClick(DialogInterface dialog, int which) { // handle click } }) .create(); } else { return super.onCreateDialog(id, args); } } }</span></span></code> </pre> <br><p>  N√£o √© muito conveniente que voc√™ precise iniciar um identificador de di√°logo e passar par√¢metros pelo Bundle.  E ainda podemos obter o problema da "janela vazada" se tentarmos exibir uma caixa de di√°logo depois de chamar Destroy na atividade.  Isso √© poss√≠vel, por exemplo, ao tentar mostrar um erro ap√≥s uma opera√ß√£o ass√≠ncrona. </p><br><p>  Em geral, esse problema √© t√≠pico do Android, quando voc√™ precisa fazer algo ap√≥s uma opera√ß√£o ass√≠ncrona, e a atividade ou fragmento j√° est√° destru√≠do naquele momento.  √â provavelmente por isso que os padr√µes MV * s√£o mais populares na comunidade Android do que entre os desenvolvedores do iOS. </p><br><h1 id="sposob-iz-dokumentacii">  M√©todo da documenta√ß√£o </h1><br><p>  Apareceram fragmentos no <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Android Honeycomb</a> , e o m√©todo descrito acima foi preterido, e o m√©todo <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">showDialog</a> da <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">atividade foi</a> marcado como preterido.  N√£o, o AlertDialog n√£o est√° desatualizado, pois muitos est√£o enganados.  Agora mesmo existe o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">DialogFragment</a> , que envolve o objeto de di√°logo e controla seu ciclo de vida. </p><br><blockquote>  Os trechos nativos tamb√©m foram descontinuados desde a API 28.  Agora voc√™ deve usar apenas a implementa√ß√£o da Biblioteca de suporte (AndroidX). </blockquote><p>  Vamos realizar nossa tarefa, conforme prescrito na <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">documenta√ß√£o oficial</a> : </p><br><ol><li>  Primeiro voc√™ precisa herdar de DialogFragment e implementar a cria√ß√£o de uma caixa de di√°logo no m√©todo onCreateDialog. </li><li>  Descreva a interface do evento de di√°logo e instancie o ouvinte no m√©todo onAttach. </li><li>  Implemente uma interface de evento de di√°logo em uma atividade ou fragmento. </li></ol><br><blockquote>  Se o leitor n√£o est√° muito claro por que o ouvinte n√£o pode ser passado pelo construtor, ele pode ler mais sobre isso <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">aqui</a> </blockquote><p>  C√≥digo do fragmento de di√°logo: </p><br><pre> <code class="kotlin hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ConfirmationDialogFragment</span></span></span><span class="hljs-class"> : </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DialogFragment</span></span></span></span>() { <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ConfirmationListener</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">confirmButtonClicked</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">cancelButtonClicked</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">lateinit</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> listener: ConfirmationListener <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onAttach</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(context: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">Context</span></span></span></span><span class="hljs-function"><span class="hljs-params">?)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>.onAttach(context) <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-comment"><span class="hljs-comment">// Instantiate the ConfirmationListener so we can send events to the host listener = activity as ConfirmationListener } catch (e: ClassCastException) { // The activity doesn't implement the interface, throw exception throw ClassCastException(activity.toString() + " must implement ConfirmationListener") } } override fun onCreateDialog(savedInstanceState: Bundle?): Dialog { return AlertDialog.Builder(context!!) .setMessage("Please, confirm the action") .setPositiveButton("Confirm") { _, _ -&gt; listener.confirmButtonClicked() } .setNegativeButton("Cancel") { _, _ -&gt; listener.cancelButtonClicked() } .create() } }</span></span></code> </pre> <br><p>  C√≥digo de Ativa√ß√£o: </p><br><pre> <code class="kotlin hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MainActivity</span></span></span><span class="hljs-class"> : </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">AppCompatActivity</span></span></span></span>(), ConfirmationListener { <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">showConfirmationDialog</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { ConfirmationDialogFragment() .show(supportFragmentManager, <span class="hljs-string"><span class="hljs-string">"ConfirmationDialogFragmentTag"</span></span>) } <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">confirmButtonClicked</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { <span class="hljs-comment"><span class="hljs-comment">// handle click } override fun cancelButtonClicked() { // handle click } }</span></span></code> </pre> <br><p>  C√≥digo suficiente acabou, certo? </p><br><p>  Como regra, h√° algum tipo de MVP no projeto, mas decidi que as chamadas do apresentador podem ser omitidas nesse caso.  No exemplo acima, vale a pena adicionar o m√©todo est√°tico de criar a caixa de di√°logo newInstance e passar par√¢metros aos argumentos do fragmento, tudo conforme o esperado. </p><br><p>  E tudo isso para que o di√°logo oculte no tempo e seja restaurado corretamente.  N√£o √© de surpreender que essas quest√µes surjam no Stackoverflow: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">uma</a> e <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">duas</a> . </p><br><h1 id="poisk-idealnogo-resheniya">  Encontrando a solu√ß√£o perfeita </h1><br><p>  O estado atual n√£o nos convinha e come√ßamos a procurar uma maneira de tornar o trabalho com di√°logos mais confort√°vel.  Havia um sentimento de que voc√™ pode facilitar, quase como no primeiro m√©todo. </p><br><p>  A seguir est√£o as considera√ß√µes que nos guiaram: </p><br><ul><li>  <strong>Preciso salvar e restaurar o di√°logo depois de encerrar o processo de inscri√ß√£o?</strong> <br>  Na maioria dos casos, isso n√£o √© necess√°rio, como no nosso exemplo, quando voc√™ precisa mostrar uma mensagem simples ou perguntar alguma coisa.  Esse di√°logo √© relevante at√© que a aten√ß√£o do usu√°rio seja perdida.  Se voc√™ restaur√°-lo ap√≥s uma longa aus√™ncia no aplicativo, o usu√°rio perder√° o contexto com a a√ß√£o planejada.  Portanto, <strong>voc√™ s√≥ precisa suportar as curvas do dispositivo</strong> e lidar corretamente com o ciclo de vida do di√°logo.  Caso contr√°rio, a partir do movimento desajeitado do dispositivo, o usu√°rio poder√° perder a mensagem que acabou de ser aberta sem l√™-la. </li><li>  Ao usar DialogFragment, muito c√≥digo clich√™ aparece, a simplicidade √© perdida.  Portanto, seria bom se livrar do fragmento como um inv√≥lucro e <strong>usar o Dialog diretamente</strong> .  Para fazer isso, voc√™ precisar√° armazenar o estado da caixa de di√°logo para mostr√°-la novamente ap√≥s recriar a View e ocult√°-la quando a View morrer. </li><li>  Todo mundo est√° acostumado a perceber a exibi√ß√£o do di√°logo como uma equipe, especialmente se voc√™ trabalha apenas com o MVP.  A tarefa da restaura√ß√£o subseq√ºente do estado √© assumida pelo FragmentManager.  Mas voc√™ pode olhar para essa situa√ß√£o de maneira diferente e come√ßar a <strong>perceber o di√°logo como um estado</strong> .  Isso √© muito mais conveniente ao trabalhar com padr√µes PM ou MVVM. </li><li>  Dado que a maioria dos aplicativos agora usa abordagens reativas, √© necess√°rio <strong>que os di√°logos sejam reativos</strong> .  A principal tarefa n√£o √© quebrar a cadeia que inicia a exibi√ß√£o do di√°logo e anexar um fluxo reativo de eventos para obter um resultado disso.  Isso √© muito conveniente no lado PresentationModel / ViewModel quando voc√™ est√° manipulando v√°rios fluxos de dados. </li></ul><br><p>  Levamos em conta todos os requisitos acima e criamos uma maneira de exibir reativamente as caixas de di√°logo, que implementamos com sucesso em nossa biblioteca <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">RxPM</a> (h√° um <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">artigo</a> separado sobre isso). </p><br><p>  A solu√ß√£o em si n√£o requer uma biblioteca e pode ser feita separadamente.  Guiado pela id√©ia de "di√°logo como estado", voc√™ pode tentar criar uma solu√ß√£o baseada no moderno ViewModel e LiveData.  Mas deixarei isso para o leitor e depois falaremos sobre uma solu√ß√£o pronta da biblioteca. </p><br><h1 id="reaktivnyy-sposob">  M√©todo reativo </h1><br><p>  Mostrarei como a tarefa inicial √© resolvida no RxPM, mas primeiro algumas palavras sobre os principais conceitos da biblioteca: </p><br><ul><li>  <strong>PresentationModel</strong> - armazena um estado de rea√ß√£o, cont√©m l√≥gica da interface do usu√°rio, sobrevive √†s curvas. </li><li>  <strong>Estado</strong> √© um <strong>estado</strong> reativo.  Voc√™ pode pensar nisso como um inv√≥lucro sobre BehaviorRelay. </li><li>  <strong>A√ß√£o</strong> - um wrapper sobre PublishRelay, serve para transferir eventos de View para PresentationModel. </li><li>  <strong>Estado</strong> e <strong>A√ß√£o</strong> t√™m observ√°vel e consumidor. </li></ul><br><p>  A classe <a href="">DialogControl</a> √© respons√°vel pelo estado da caixa de di√°logo.  Possui dois par√¢metros: o primeiro para o tipo de dados que deve ser exibido na caixa de di√°logo, o segundo para o tipo de resultado.  No nosso exemplo, o tipo de dados ser√° Unit, mas pode ser uma mensagem para o usu√°rio ou qualquer outro tipo. </p><br><p>  DialogControl possui os seguintes m√©todos: </p><br><ul><li>  <code>show(data: T)</code> - apenas fornece um comando para exibir. </li><li>  <code>showForResult(data: T): Maybe&lt;R&gt;</code> - mostre uma caixa de di√°logo e abra o fluxo para obter o resultado. </li><li>  <code>sendResult(result: R)</code> - envia o resultado, √© chamado do lado de exibi√ß√£o. </li><li>  <code>dismiss()</code> - apenas oculta a caixa de di√°logo. </li></ul><br><p>  O DialogControl armazena o estado - existe ou n√£o um di√°logo na tela (Exibido / Ausente).  √â assim que fica no c√≥digo da classe: </p><br><pre> <code class="kotlin hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">DialogControl</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">T, R</span></span></span><span class="hljs-class">&gt; </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">internal</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">constructor</span></span></span></span>(pm: PresentationModel) { <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> displayed = pm.State&lt;Display&gt;(Absent) <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> result = pm.Action&lt;R&gt;() <span class="hljs-keyword"><span class="hljs-keyword">sealed</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Display</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">data</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Displayed</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">T</span></span></span><span class="hljs-class">&gt;</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">val</span></span> <span class="hljs-keyword"><span class="hljs-keyword">data</span></span>: T) : Display() <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> Absent : Display() } <span class="hljs-comment"><span class="hljs-comment">// ... }</span></span></code> </pre> <br><p>  Crie um PresentationModel simples: </p><br><pre> <code class="kotlin hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SamplePresentationModel</span></span></span><span class="hljs-class"> : </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">PresentationModel</span></span></span></span>() { <span class="hljs-keyword"><span class="hljs-keyword">enum</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ConfirmationDialogResult</span></span></span><span class="hljs-class"> </span></span>{ CONFIRMED, CANCELED } <span class="hljs-comment"><span class="hljs-comment">//        enum    val confirmationDialog = dialogControl&lt;Unit, ConfirmationDialogResult&gt;() val buttonClicks = Action&lt;Unit&gt;() override fun onCreate() { super.onCreate() buttonClicks.observable .switchMapMaybe { //           confirmationDialog.showForResult(Unit) .filter { it == ConfirmationDialogResult.CONFIRMED } } .subscribe { //   } .untilDestroy() } }</span></span></code> </pre> <br><p>  Observe que o processamento de cliques, a confirma√ß√£o de confirma√ß√£o e o processamento de a√ß√µes s√£o implementados na mesma cadeia.  Isso permite que voc√™ concentre o c√≥digo e n√£o espalhe a l√≥gica por v√°rios retornos de chamada. </p><br><p>  Em seguida, simplesmente ligamos DialogControl √† View usando a extens√£o bindTo. <br>  Coletamos o AlertDialog usual e enviamos o resultado via sendResult: </p><br><pre> <code class="kotlin hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SampleActivity</span></span></span><span class="hljs-class"> : </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">PmSupportActivity</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">SamplePresentationModel</span></span></span><span class="hljs-class">&gt;</span></span>() { <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">providePresentationModel</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> = SamplePresentationModel() <span class="hljs-comment"><span class="hljs-comment">//     View  PresentationModel override fun onBindPresentationModel(pm: SamplePresentationModel) { pm.confirmationDialog bindTo { data, dialogControl -&gt; AlertDialog.Builder(this@SampleActivity) .setMessage("Please, confirm the action") .setPositiveButton("Confirm") { _, _ -&gt; dialogControl.sendResult(CONFIRMED) } .setNegativeButton("Cancel") { _, _ -&gt; dialogControl.sendResult(CANCELED) } .create() } button.clicks() bindTo pm.buttonClicks } }</span></span></code> </pre> <br><p>  Em um cen√°rio t√≠pico, algo assim acontece sob o cap√¥: </p><br><ol><li>  Clicamos no bot√£o, o evento atrav√©s da a√ß√£o "buttonClicks" entra no PresentationModel. </li><li>  Para este evento, iniciamos a exibi√ß√£o da caixa de di√°logo atrav√©s da chamada para showForResult. </li><li>  Como resultado, o estado no DialogControl muda de ausente para exibido. </li><li>  Quando o evento Displayed √© recebido, o lambda que passamos na liga√ß√£o bindTo √© chamado.  Um objeto de di√°logo √© criado nele, que √© exibido. </li><li>  O usu√°rio pressiona o bot√£o Confirmar, o ouvinte √© acionado e o resultado do clique √© enviado ao DialogControl chamando sendResult. </li><li>  Em seguida, o resultado cai na A√ß√£o interna "resultado" e o estado de Exibido muda para Ausente. </li><li>  Quando um evento ausente √© recebido, a caixa de di√°logo atual √© fechada. </li><li>  O evento do "resultado" da A√ß√£o cai no fluxo que foi aberto pela chamada para showForResult e √© processado pela cadeia no PresentationModel. </li></ol><br><p>  Vale ressaltar que a caixa de di√°logo √© fechada mesmo quando o View √© desatado do PresentationModel.  Nesse caso, o status permanece exibido.  Ele ser√° recebido na pr√≥xima liga√ß√£o e o di√°logo ser√° restaurado. </p><br><p>  Como voc√™ pode ver, a necessidade de DialogFragment se foi.  A caixa de di√°logo √© mostrada quando a Visualiza√ß√£o √© anexada ao PresentationModel e oculta quando a Visualiza√ß√£o √© desatada.  Como o estado √© armazenado no DialogControl, que por sua vez √© armazenado no PresentationModel, a caixa de di√°logo √© restaurada ap√≥s a rota√ß√£o do dispositivo. </p><br><h1 id="pishite-dialogi-pravilno">  Escreva di√°logos corretamente </h1><br><p>  Examinamos v√°rias maneiras de exibir caixas de di√°logo.  Se voc√™ ainda est√° aparecendo da primeira maneira, eu imploro, n√£o fa√ßa mais isso.  Para os amantes do MVP, n√£o resta nada al√©m de usar o m√©todo padr√£o, descrito na documenta√ß√£o oficial.  Infelizmente, a tend√™ncia √† imperatividade desse padr√£o n√£o permite fazer o contr√°rio.  Bem, eu recomendo aos f√£s do RxJava um olhar mais atento ao m√©todo reativo e √† nossa biblioteca <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">RxPM</a> . </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt440284/">https://habr.com/ru/post/pt440284/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt440274/index.html">Criando um servi√ßo de moeda privada usando o Exonum</a></li>
<li><a href="../pt440276/index.html">Depura√ß√£o de front-end e back-end</a></li>
<li><a href="../pt440278/index.html">Mudar o Tinder para Kubernetes</a></li>
<li><a href="../pt440280/index.html">An√°lise do Software Livre Android</a></li>
<li><a href="../pt440282/index.html">Estruturas da Web Python mais r√°pidas em 2019</a></li>
<li><a href="../pt440286/index.html">Ru√≠do Perlin, gera√ß√£o de conte√∫do processual e espa√ßo interessante</a></li>
<li><a href="../pt440288/index.html">Seguran√ßa da Internet das coisas. Edi√ß√£o 1. Rel√≥gios inteligentes, rastreadores de fitness e balan√ßas</a></li>
<li><a href="../pt440292/index.html">O livro ‚ÄúUnidade em a√ß√£o. Desenvolvimento multiplataforma em C #. 2nd int. edi√ß√£o ¬ª</a></li>
<li><a href="../pt440294/index.html">Roteador MIDI no Raspberry Pi</a></li>
<li><a href="../pt440296/index.html">6 Aplica√ß√µes para a Internet das coisas industrial</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>