<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üå¨Ô∏è ü§úüèª üíáüèΩ Jouez "osu!", N'oubliez pas les erreurs üòπ üíò üõèÔ∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Nous accueillons tous les amateurs d'exotisme et de peu d'erreurs dans le code. Aujourd'hui sur le banc d'essai PVS-Studio est un invit√© assez rare - ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Jouez "osu!", N'oubliez pas les erreurs</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/pvs-studio/blog/483438/"><p><img src="https://habrastorage.org/getpro/habr/post_images/3ac/9da/a12/3ac9daa12b519fc14e45f7f65abdd204.png" alt="Image 1" align="left"></p>  Nous accueillons tous les amateurs d'exotisme et de peu d'erreurs dans le code.  Aujourd'hui sur le banc d'essai PVS-Studio est un invit√© assez rare - un jeu en C #.  √Ä savoir, osu!  Comme d'habitude: recherchez les erreurs, r√©fl√©chissez, jouez. <br><a name="habracut"></a><br><h2>  Le jeu </h2><br>  Osu!  - Un jeu de rythme musical open source.  √Ä en juger par les informations du <a href="https://osu.ppy.sh/home">site Web du jeu</a> , il est assez populaire, car plus de 15 millions de joueurs inscrits sont d√©clar√©s.  Le projet se caract√©rise par un gameplay gratuit, un design color√© avec la possibilit√© de personnaliser les cartes, des fonctionnalit√©s avanc√©es pour compiler un classement en ligne des joueurs, la pr√©sence du multijoueur, un large √©ventail de compositions musicales.  Je ne d√©crirai pas le jeu en d√©tail, les int√©ress√©s trouveront facilement toutes les informations sur le r√©seau.  Par exemple, <a href="https://en.wikipedia.org/wiki/Osu!">ici</a> . <br><br>  Je suis plus int√©ress√© par le code source du projet, qui peut √™tre t√©l√©charg√© depuis <a href="https://github.com/ppy/osu">GitHub</a> .  Un nombre important de validations (plus de 24 mille) dans le r√©f√©rentiel attire imm√©diatement l'attention, ce qui indique le d√©veloppement actif du projet, qui se poursuit √† ce jour (le jeu est sorti en 2007, mais le travail a probablement commenc√© plus t√¥t).  Dans le m√™me temps, il n'y a pas beaucoup de code source - 1813 fichiers .cs qui contiennent 135 000 lignes de code, √† l'exclusion de celles vides.  Ce code contient des tests que je ne prends g√©n√©ralement pas en compte dans les contr√¥les.  Le code de test est contenu dans 306 fichiers .cs et, par cons√©quent, 25 000 lignes de code, √† l'exclusion des lignes vides.  Il s'agit d'un petit projet: √† titre de comparaison, le c≈ìur C # de l'analyseur PVS-Studio contient environ 300 000 lignes de code. <br><br>  Au total, pour v√©rifier le jeu pour les erreurs, j'ai utilis√© des projets non-test contenant 1507 fichiers de code source et 110 mille lignes.  Cependant, le r√©sultat m'a partiellement plu, car il y a eu plusieurs erreurs int√©ressantes dont je m'empresse de vous parler. <br><br><h2>  Erreurs </h2><br>  <a href="https://www.viva64.com/ru/w/v3001/">V3001</a> Il existe des sous-expressions identiques 'result == HitResult.Perfect' √† gauche et √† droite de '||'  op√©rateur.  DrawableHoldNote.cs 266 <br><br><pre><code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CheckForResult</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">....</span></span></span><span class="hljs-function">)</span></span> { .... ApplyResult(r =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (holdNote.hasBroken &amp;&amp; (result == HitResult.Perfect || result == HitResult.Perfect)) result = HitResult.Good; .... }); }</code> </pre> <br>  Un bon exemple de programmation orient√©e copier-coller.  Un terme comique que mon coll√®gue Valery Komarov a r√©cemment utilis√© (introduit) dans son article " <a href="https://www.viva64.com/ru/b/0699/">Top 10 des erreurs dans les projets Java pour 2019</a> ". <br><br>  Ainsi, deux contr√¥les identiques se succ√®dent.  L'une des v√©rifications devrait tr√®s probablement contenir une autre <i>constante d'</i> √©num√©ration <i>HitResult</i> : <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">enum</span></span> HitResult { None, Miss, Meh, Ok, Good, Great, Perfect, }</code> </pre> <br>  Quelle constante particuli√®re devait √™tre utilis√©e, ou la deuxi√®me v√©rification n'est-elle pas n√©cessaire du tout?  Questions auxquelles seul le d√©veloppeur peut r√©pondre.  Dans tous les cas, une erreur a √©t√© commise qui fausse la logique du programme. <br><br>  <a href="https://www.viva64.com/ru/w/v3001/">V3001</a> Il existe des sous-expressions identiques ¬´famille! = GetFamilyString (TournamentTypeface.Aquatico)¬ª √† gauche et √† droite de l'op√©rateur ¬´&amp;&amp;¬ª.  TournamentFont.cs 64 <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">string</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetWeightString</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> family, FontWeight weight</span></span></span><span class="hljs-function">)</span></span> { .... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (weight == FontWeight.Regular &amp;&amp; family != GetFamilyString(TournamentTypeface.Aquatico) &amp;&amp; family != GetFamilyString(TournamentTypeface.Aquatico)) weightString = <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.Empty; .... }</code> </pre> <br>  Et encore une fois copier-coller.  J'ai format√© le code, donc l'erreur est facilement perceptible.  Dans la version originale, la condition enti√®re √©tait √©crite sur une seule ligne.  Il est √©galement difficile de dire comment le code peut √™tre corrig√©.  L'√©num√©ration <i>TournamentTypeface</i> contient une seule constante: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">enum</span></span> TournamentTypeface { Aquatico }</code> </pre> <br>  La condition peut avoir utilis√© la variable <i>familiale</i> deux fois par erreur, mais ce n'est pas exact. <br><br>  <a href="https://www.viva64.com/ru/w/v3009/">V3009</a> [CWE-393] Il est √©trange que cette m√©thode renvoie toujours une seule et m√™me valeur de 'false'.  KeyCounterAction.cs 19 <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OnPressed</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">T action, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">bool</span></span></span></span><span class="hljs-function"><span class="hljs-params"> forwards</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!EqualityComparer&lt;T&gt;.Default.Equals(action, Action)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; IsLit = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (forwards) Increment(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; }</code> </pre> <br>  La m√©thode retournera toujours <i>false</i> .  Pour de telles erreurs, je v√©rifie g√©n√©ralement le code appelant, car ils n'utilisent souvent la valeur de retour nulle part, il n'y a pas d'erreur (sauf pour le style de programmation laid).  Dans ce cas, je suis tomb√© sur le code suivant: <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OnPressed</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">T action</span></span></span><span class="hljs-function">)</span></span> =&gt; Target.Children .OfType&lt;KeyCounterAction&lt;T&gt;&gt;() .Any(c =&gt; c.OnPressed(action, Clock.Rate &gt;= <span class="hljs-number"><span class="hljs-number">0</span></span>));</code> </pre> <br>  Comme vous pouvez le voir, le r√©sultat renvoy√© par la m√©thode <i>OnPressed</i> est utilis√©.  Et comme il est toujours <i>faux</i> , le r√©sultat de l'appel <i>OnPressed</i> sera √©galement toujours <i>faux</i> .  Je pense que vous devriez v√©rifier √† nouveau ce code, car il y a une forte probabilit√© d'erreur. <br><br>  Une autre erreur similaire: <br><br><ul><li>  V3009 [CWE-393] Il est √©trange que cette m√©thode renvoie toujours une seule et m√™me valeur de 'false'.  KeyCounterAction.cs 30 </li></ul><br>  <a href="https://www.viva64.com/ru/w/v3042/">V3042</a> [CWE-476] Possible NullReferenceException.  Le '?.'  et '.'  les op√©rateurs sont utilis√©s pour acc√©der aux membres de l'objet 'val.NewValue' TournamentTeam.cs 41 <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">TournamentTeam</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { Acronym.ValueChanged += val =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (....) FlagName.Value = val.NewValue.Length &gt;= <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-comment"><span class="hljs-comment">// &lt;= ? val.NewValue?.Substring(0, 2).ToUpper() : string.Empty; }; .... }</span></span></code> </pre> <br>  Dans la condition de l'op√©rateur <i>?:</i> , La variable <i>val.NewValue</i> n'est pas s√ªre.  L'analyseur a fait une telle conclusion, car dans la branche alors, une option s√ªre est utilis√©e pour acc√©der √† la variable via l' <i>instruction d'</i> acc√®s conditionnel <i>val.NewValue? .Substring (....)</i> . <br><br>  Une autre erreur similaire: <br><br><ul><li>  V3042 [CWE-476] Possible NullReferenceException.  Le '?.'  et '.'  les op√©rateurs sont utilis√©s pour acc√©der aux membres de l'objet 'val.NewValue' TournamentTeam.cs 48 </li></ul><br>  <a href="https://www.viva64.com/ru/w/v3042/">V3042</a> [CWE-476] Possible NullReferenceException.  Le '?.'  et '.'  les op√©rateurs sont utilis√©s pour acc√©der aux membres de l'objet 'api' SetupScreen.cs 77 <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">reload</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { .... <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ActionableInfo { Label = <span class="hljs-string"><span class="hljs-string">"Current User"</span></span>, ButtonText = <span class="hljs-string"><span class="hljs-string">"Change Login"</span></span>, Action = () =&gt; { api.Logout(); <span class="hljs-comment"><span class="hljs-comment">// &lt;= .... }, Value = api?.LocalUser.Value.Username, .... }, .... } private class ActionableInfo : LabelledDrawable&lt;Drawable&gt; { .... public Action Action; .... }</span></span></code> </pre> <br>  Ce code est moins clair, mais je pense que l'erreur est toujours l√†.  Cr√©ez un objet de type <i>ActionableInfo</i> .  Le champ <i>Action</i> est initialis√© avec un lambda, dans le corps duquel il n'est pas s√ªr de travailler avec une <i>API de</i> r√©f√©rence potentiellement nulle.  L'analyseur a consid√©r√© ce mod√®le comme une erreur, car lors de l'initialisation du param√®tre <i>Value</i> , la variable <i>api</i> fonctionne en toute s√©curit√©.  J'ai appel√© l'erreur ambigu√´, car le code lambda suppose une ex√©cution retard√©e et, peut-√™tre, le d√©veloppeur garantit en quelque sorte une valeur non nulle du lien <i>api</i> .  Mais ce n'est qu'une hypoth√®se, car le corps lambda ne contient aucun signe de travail s√ªr avec le lien (contr√¥les pr√©liminaires, par exemple). <br><br>  <a href="https://www.viva64.com/ru/w/v3066/">V3066</a> [CWE-683] Ordre incorrect possible des arguments pass√©s √† la m√©thode 'Atan2': 'diff.X' et 'diff.Y'.  SliderBall.cs 182 <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">UpdateProgress</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">double</span></span></span></span><span class="hljs-function"><span class="hljs-params"> completionProgress</span></span></span><span class="hljs-function">)</span></span> { .... Rotation = <span class="hljs-number"><span class="hljs-number">-90</span></span> + (<span class="hljs-keyword"><span class="hljs-keyword">float</span></span>)(-Math.Atan2(diff.X, diff.Y) * <span class="hljs-number"><span class="hljs-number">180</span></span> / Math.PI); .... }</code> </pre> <br>  L'analyseur soup√ßonnait qu'en travaillant avec la m√©thode <i>Atan2</i> de la classe <i>Math</i> , le d√©veloppeur m√©langeait l'ordre des arguments.  <i>Annonce Atan2</i> : <br><br><pre> <code class="cs hljs"><span class="hljs-comment"><span class="hljs-comment">// Parameters: // y: // The y coordinate of a point. // // x: // The x coordinate of a point. public static double Atan2(double y, double x);</span></span></code> </pre> <br>  Comme vous pouvez le voir, les valeurs ont √©t√© transf√©r√©es dans l'ordre inverse.  Je ne peux pas juger si c'est une erreur, car la m√©thode <i>UpdateProgress</i> contient beaucoup de calculs non triviaux.  Je note juste le fait d'un probl√®me possible dans le code. <br><br>  <a href="https://www.viva64.com/ru/w/v3080/">V3080</a> [CWE-476] <a href="https://www.viva64.com/ru/w/v3080/">D√©r√©f√©rence</a> nulle possible.  Pensez √† inspecter ¬´Beatmap¬ª.  WorkingBeatmap.cs 57 <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">virtual</span></span></span><span class="hljs-function"> Track </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetVirtualTrack</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { .... <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> lastObject = Beatmap.HitObjects.LastOrDefault(); .... }</code> </pre> <br>  L'analyseur a soulign√© le danger d'acc√®s via le lien nul <i>Beatmap</i> .  Voici ce que c'est: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> IBeatmap Beatmap { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> LoadBeatmapAsync().Result; } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (TaskCanceledException) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } } }</code> </pre> <br>  Eh bien, l'analyseur a raison. <br><br>  Pour plus d'informations sur la fa√ßon dont PVS-Studio d√©tecte ces erreurs, ainsi que sur les innovations C # 8.0 li√©es √† des sujets similaires (travail avec des r√©f√©rences potentiellement nulles), consultez l'article " <a href="https://www.viva64.com/ru/b/0631/">Types de r√©f√©rence nullables en C # 8.0 et analyse statique</a> ". <br><br>  <a href="https://www.viva64.com/ru/w/v3083/">V3083</a> [CWE-367] L'appel non s√©curis√© de l'√©v√©nement 'ObjectConverted', NullReferenceException est possible.  Pensez √† affecter un √©v√©nement √† une variable locale avant de l'invoquer.  BeatmapConverter.cs 82 <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> List&lt;T&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">convertHitObjects</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">....</span></span></span><span class="hljs-function">)</span></span> { .... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ObjectConverted != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { converted = converted.ToList(); ObjectConverted.Invoke(obj, converted); } .... }</code> </pre> <br>  Erreur non critique et assez courante.  Entre la v√©rification de la <i>nullit√© de</i> l'√©v√©nement et son invocation, ils peuvent se d√©sinscrire de l'√©v√©nement, ce qui entra√Ænera le plantage du programme. <br>  L'un des correctifs: <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> List&lt;T&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">convertHitObjects</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">....</span></span></span><span class="hljs-function">)</span></span> { .... converted = converted.ToList(); ObjectConverted?.Invoke(obj, converted); .... }</code> </pre> <br>  <a href="https://www.viva64.com/ru/w/v3095/">V3095</a> [CWE-476] L'objet 'colonnes' a √©t√© utilis√© avant d'√™tre v√©rifi√© par rapport √† null.  V√©rifiez les lignes: 141, 142. SquareGraph.cs 141 <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">redrawProgress</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; ColumnCount; i++) columns[i].State = i &lt;= progress ? ColumnState.Lit : ColumnState.Dimmed; columns?.ForceRedraw(); }</code> </pre> <br>  Il n'est pas s√ªr de contourner la collection de <i>colonnes</i> dans une boucle.  Dans le m√™me temps, le d√©veloppeur a suppos√© que le lien des <i>colonnes</i> pouvait √™tre nul, car plus tard dans le code, un op√©rateur d'acc√®s conditionnel √©tait utilis√© pour acc√©der √† la collection. <br><br>  <a href="https://www.viva64.com/ru/w/v3119/">V3119 L'</a> appel de l'√©v√©nement ignor√© 'OnNewResult' peut entra√Æner un comportement impr√©visible.  Envisagez d'impl√©menter explicitement les accesseurs d'√©v√©nements ou utilisez un mot cl√© ¬´scell√©¬ª.  DrawableRuleset.cs 256 <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">addHitObject</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">TObject hitObject</span></span></span><span class="hljs-function">)</span></span> { .... drawableObject.OnNewResult += (_, r) =&gt; OnNewResult?.Invoke(r); .... } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">event</span></span> Action&lt;JudgementResult&gt; OnNewResult;</code> </pre> <br>  L'analyseur avertit des dangers li√©s √† l'utilisation d'un √©v√©nement ignor√© ou virtuel.  Quel est exactement le danger - je sugg√®re de lire la <a href="https://www.viva64.com/ru/w/v3119/">description</a> du diagnostic.  Aussi, √† un moment donn√©, j'ai √©crit un article sur ce sujet, ¬´ <a href="https://www.viva64.com/ru/b/0453/">√âv√©nements virtuels en C #: quelque chose s'est mal pass√©</a> ¬ª. <br><br>  Une autre construction dangereuse similaire dans le code: <br><br><ul><li>  V3119 L'appel d'un √©v√©nement ignor√© peut entra√Æner un comportement impr√©visible.  Envisagez d'impl√©menter explicitement les accesseurs d'√©v√©nements ou utilisez un mot cl√© ¬´scell√©¬ª.  DrawableRuleset.cs 257 </li></ul><br>  <a href="https://www.viva64.com/ru/w/v3123/">V3123</a> [CWE-783] Peut-√™tre le '??'  L'op√©rateur fonctionne d'une mani√®re diff√©rente de celle attendue.  Sa priorit√© est inf√©rieure √† la priorit√© des autres op√©rateurs dans sa partie gauche.  OsuScreenStack.cs 45 <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onScreenChange</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">IScreen prev, IScreen next</span></span></span><span class="hljs-function">)</span></span> { parallaxContainer.ParallaxAmount = ParallaxContainer.DEFAULT_PARALLAX_AMOUNT * ((IOsuScreen)next)?.BackgroundParallaxAmount ?? <span class="hljs-number"><span class="hljs-number">1.0f</span></span>; }</code> </pre> <br>  Pour une meilleure compr√©hension du probl√®me - je vais donner un exemple synth√©tique de la fa√ßon dont le code fonctionne maintenant: <br><br><pre> <code class="cs hljs">x = (c * a) ?? b;</code> </pre> <br>  L'erreur a √©t√© commise du fait que l'op√©rateur * a une priorit√© plus √©lev√©e que l'op√©rateur ??.  Version corrig√©e du code (crochets ajout√©s): <br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onScreenChange</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">IScreen prev, IScreen next</span></span></span><span class="hljs-function">)</span></span> { parallaxContainer.ParallaxAmount = ParallaxContainer.DEFAULT_PARALLAX_AMOUNT * (((IOsuScreen)next)?.BackgroundParallaxAmount ?? <span class="hljs-number"><span class="hljs-number">1.0f</span></span>); }</code> </pre> <br>  Une autre erreur similaire dans le code: <br><br>  <a href="https://www.viva64.com/ru/w/v3123/">V3123</a> [CWE-783] Peut-√™tre le '??'  L'op√©rateur fonctionne d'une mani√®re diff√©rente de celle attendue.  Sa priorit√© est inf√©rieure √† la priorit√© des autres op√©rateurs dans sa partie gauche.  FramedReplayInputHandler.cs 103 <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> inImportantSection { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> { .... <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> IsImportant(frame) &amp;&amp; Math.Abs(CurrentTime - NextFrame?.Time ?? <span class="hljs-number"><span class="hljs-number">0</span></span>) &lt;= AllowedImportantTimeSpan; } }</code> </pre> <br>  Ici, comme dans le fragment de code pr√©c√©dent, la priorit√© des op√©rateurs n'a pas √©t√© prise en compte.  Maintenant, l'expression pass√©e √† la m√©thode <i>Math.Abs</i> est √©valu√©e comme suit: <br><br><pre> <code class="cs hljs">(a ‚Äì b) ?? <span class="hljs-number"><span class="hljs-number">0</span></span></code> </pre> <br>  Code corrig√©: <br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> inImportantSection { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> { .... <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> IsImportant(frame) &amp;&amp; Math.Abs(CurrentTime ‚Äì (NextFrame?.Time ?? <span class="hljs-number"><span class="hljs-number">0</span></span>)) &lt;= AllowedImportantTimeSpan; } }</code> </pre> <br>  <a href="https://www.viva64.com/ru/w/v3142/">V3142</a> [CWE-561] Code inaccessible d√©tect√©.  Il est possible qu'une erreur soit pr√©sente.  DrawableHoldNote.cs 214 <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OnPressed</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">ManiaAction action</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!<span class="hljs-keyword"><span class="hljs-keyword">base</span></span>.OnPressed(action)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Result.Type == HitResult.Miss) <span class="hljs-comment"><span class="hljs-comment">// &lt;= holdNote.hasBroken = true; .... }</span></span></code> </pre> <br>  L'analyseur pr√©tend que le <i>code du</i> gestionnaire <i>OnPressed</i> , en commen√ßant par la deuxi√®me <i>instruction if</i> , est inaccessible.  Cela d√©coule de l'hypoth√®se que la premi√®re condition est toujours vraie, c'est-√†-dire que la m√©thode <i>base.OnPressed</i> retournera toujours <i>false</i> .  <i>Jetez un</i> ≈ìil √† la m√©thode <i>base.OnPressed</i> : <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">virtual</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OnPressed</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">ManiaAction action</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (action != Action.Value) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> UpdateResult(<span class="hljs-literal"><span class="hljs-literal">true</span></span>); }</code> </pre> <br>  Nous passons √† la m√©thode <i>UpdateResult</i> : <br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">UpdateResult</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">bool</span></span></span></span><span class="hljs-function"><span class="hljs-params"> userTriggered</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Time.Elapsed &lt; <span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Judged) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; .... <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Judged; }</code> </pre> <br>  Notez que l'impl√©mentation de la propri√©t√© <i>Judged</i> n'est pas importante ici, car la logique de la m√©thode <i>UpdateResult</i> implique que la derni√®re <i>instruction de retour est</i> √©quivalente √† ceci: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>;</code> </pre> <br>  Ainsi, la m√©thode <i>UpdateResult</i> retournera toujours <i>false</i> , ce qui entra√Ænera une erreur avec du code inaccessible dans le code au-dessus de la pile. <br><br>  <a href="https://www.viva64.com/ru/w/v3146/">V3146</a> [CWE-476] <a href="https://www.viva64.com/ru/w/v3146/">D√©r√©f√©rence</a> nulle possible de 'jeu de r√®gles'.  Le 'FirstOrDefault' peut renvoyer la valeur nulle par d√©faut.  APILegacyScoreInfo.cs 24 <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> ScoreInfo </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CreateScoreInfo</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">RulesetStore rulesets</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> ruleset = rulesets.GetRuleset(OnlineRulesetID); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> mods = Mods != <span class="hljs-literal"><span class="hljs-literal">null</span></span> ? ruleset.CreateInstance() <span class="hljs-comment"><span class="hljs-comment">// &lt;= .GetAllMods().Where(....) .ToArray() : Array.Empty&lt;Mod&gt;(); .... }</span></span></code> </pre> <br>  L'analyseur consid√®re que l'appel de <i>ruleset.CreateInstance () n'est</i> pas s√ªr.  La variable d'ensemble de <i>r√®gles</i> obtient pr√©c√©demment la valeur suite √† l'appel de <i>GetRuleset</i> : <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> RulesetInfo </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetRuleset</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> id</span></span></span><span class="hljs-function">)</span></span> =&gt; AvailableRulesets.FirstOrDefault(....);</code> </pre> <br>  Comme vous pouvez le voir, l'avertissement de l'analyseur est justifi√©, car la cha√Æne d'appel contient <i>FirstOrDefault</i> , qui peut retourner <i>null</i> . <br><br><h2>  Conclusion </h2><br>  En g√©n√©ral, le projet de jeu "osu!" Satisfait d'un petit nombre d'erreurs.  N√©anmoins, je recommande aux d√©veloppeurs de faire attention aux probl√®mes d√©tect√©s.  Et laissez le jeu continuer de plaire √† ses fans. <br><br>  Et pour ceux qui aiment approfondir le code, je vous rappelle que l'analyseur PVS-Studio, qui est facile √† <a href="https://www.viva64.com/ru/pvs-studio-download/">t√©l√©charger</a> sur le site officiel, sera d'une bonne aide.  Je note √©galement que les v√©rifications de projet ponctuelles, telles que celles d√©crites ci-dessus, n'ont rien √† voir avec l'utilisation d'un analyseur statique dans le travail r√©el.  Une efficacit√© maximale dans la lutte contre les erreurs ne peut √™tre atteinte qu'avec une utilisation r√©guli√®re de l'outil √† la fois sur le serveur de build et directement sur l'ordinateur du d√©veloppeur (analyse incr√©mentale).  L'objectif maximum est d'emp√™cher les erreurs de p√©n√©trer dans le syst√®me de contr√¥le de version, en corrigeant les d√©fauts d√©j√† au stade de l'√©criture du code. <br><br>  Bonne chance et succ√®s! <br><br><h2>  Les r√©f√©rences </h2><br>  Il s'agit de la premi√®re publication en 2020.  Profitant de cette opportunit√©, je fournirai des liens vers des articles sur la v√©rification des projets C # l'ann√©e derni√®re: <br><br><ul><li>  <a href="https://www.viva64.com/ru/b/0605/">Recherche de bogues dans le code source Amazon Web Services SDK for .NET</a> </li><li>  <a href="https://www.viva64.com/ru/b/0622/">V√©rification du code source de Roslyn</a> </li><li>  <a href="https://www.viva64.com/ru/b/0631/">Types de r√©f√©rence nullables dans C # 8.0 et analyse statique</a> </li><li>  <a href="https://www.viva64.com/ru/b/0653/">WinForms: erreurs, Holmes</a> </li><li>  <a href="https://www.viva64.com/ru/b/0654/">L'histoire de la fa√ßon dont PVS-Studio a trouv√© une erreur dans la biblioth√®que utilis√©e dans ... PVS-Studio</a> </li><li>  <a href="https://www.viva64.com/ru/b/0656/">V√©rification du code source des biblioth√®ques .NET Core par l'analyseur statique PVS-Studio</a> </li><li>  <a href="https://www.viva64.com/ru/b/0664/">V√©rification des analyseurs Roslyn</a> </li><li>  <a href="https://www.viva64.com/ru/b/0677/">V√©rifiez l'interface utilisateur Telerik pour UWP pour vous familiariser avec PVS-Studio</a> </li><li>  <a href="https://www.viva64.com/ru/b/0678/">Azure PowerShell: ¬´principalement inoffensif¬ª</a> </li><li>  <a href="https://www.viva64.com/ru/b/0681/">Nous recherchons et analysons les erreurs dans le code CMS Orchard</a> </li><li>  <a href="https://www.viva64.com/ru/b/0683/">V√©rification de l'encapsuleur OpenCvSharp sur OpenCV avec PVS-Studio</a> </li><li>  <a href="https://www.viva64.com/ru/b/0692/">SDK Azure pour .NET: L'histoire d'une recherche de bogue difficile</a> </li><li>  <a href="https://www.viva64.com/ru/b/0694/">SDK SARIF et ses erreurs</a> </li><li>  <a href="https://www.viva64.com/ru/b/0698/">Top 10 des bugs dans les projets C # pour 2019</a> </li></ul><br><p> <a href="https://habr.com/en/company/pvs-studio/blog/483436/"><img src="https://habrastorage.org/getpro/habr/post_images/c78/30f/70c/c7830f70c5577c3d6704f254d7cad6a3.png" align="left"></a> </p><br><br>  Si vous souhaitez partager cet article avec un public anglophone, veuillez utiliser le lien vers la traduction: Sergey Khrenov.  <a href="https://habr.com/en/company/pvs-studio/blog/483436/">Jouez "osu!", Mais attention aux bugs</a> . </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr483438/">https://habr.com/ru/post/fr483438/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr483418/index.html">Syst√®mes de billetterie: comment avez-vous pay√© trois OTRS gratuits?</a></li>
<li><a href="../fr483424/index.html">DBA: transfert de valeurs SEQUENCE entre des bases de donn√©es PostgreSQL</a></li>
<li><a href="../fr483426/index.html">Enqu√™te sur l'onglet du vendredi</a></li>
<li><a href="../fr483428/index.html">Quelle sera la gestion √©lectronique des documents apr√®s l'entr√©e en vigueur des amendements √† la loi sur la signature √©lectronique?</a></li>
<li><a href="../fr483436/index.html">Jouez "osu!", Mais attention aux bugs</a></li>
<li><a href="../fr483440/index.html">Derniers compilateurs D</a></li>
<li><a href="../fr483444/index.html">Rapport DORA 2019: comment am√©liorer les performances de DevOps</a></li>
<li><a href="../fr483446/index.html">Les scientifiques ont trouv√© une nouvelle fa√ßon de r√©duire les niveaux de fer dans l'eau potable</a></li>
<li><a href="../fr483448/index.html">Disney - Le plus grand double sens de l'histoire de l'humanit√©</a></li>
<li><a href="../fr483454/index.html">Passer de Mercurial √† GIT dans Atlassian Bitbucket avec enregistrer des fichiers en cyrillique</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>