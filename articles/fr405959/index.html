<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🧑🏻‍🤝‍🧑🏻 🦄 👇🏻 LED clignotante dans STM32 dans l'assembleur 📸 👩🏻‍🚒 🏇🏼</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Il y a quelque temps, je voulais apprendre l'assembleur, et après avoir lu la littérature pertinente, il était temps de pratiquer. En fait, il sera di...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>LED clignotante dans STM32 dans l'assembleur</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/405959/">  Il y a quelque temps, je voulais apprendre l'assembleur, et après avoir lu la littérature pertinente, il était temps de pratiquer.  En fait, il sera discuté plus loin.  Au début, je pratiquais sur Arduino Uno (Atmega328p), maintenant j'ai décidé de passer à autre chose et j'ai adopté STM32.  STM32F103C8 est en fait tombé entre mes mains et d'autres expériences auront lieu. <br><br><h2>  Les outils </h2><br>  J'ai utilisé les outils suivants: <br><br><ul><li>  Bloc-notes ++ - pour écrire du code </li><li>  Compilateur GNU Assembler </li><li>  STM32 ST-LINK Utility + ST-LINK V2 - pour flasher le code sur le microcontrôleur et déboguer </li></ul><br><h2>  Commencer </h2><br>  Le principal objectif du langage d'assemblage pour moi est d'apprendre.  Comme vous ne savez jamais où rencontrer un autre problème intéressant, il a été décidé de tout écrire à partir de zéro.  La tâche principale était de comprendre le fonctionnement du vecteur d'interruption.  Contrairement à Atmega dans STM32, le vecteur d'interruption ne contient pas d'instructions de saut: <br><br><pre><code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">jmp</span></span> main</code> </pre> <br>  Des adresses spécifiques y sont écrites, et lors de l'interruption, le processeur lui-même substitue l'adresse spécifiée dans le vecteur dans le registre PC.  Voici un exemple de mon vecteur d'interruption: <br><br><pre> <code class="hljs css"><span class="hljs-selector-class"><span class="hljs-selector-class">.org</span></span> 0<span class="hljs-selector-tag"><span class="hljs-selector-tag">x00000000</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">SP</span></span>: <span class="hljs-selector-class"><span class="hljs-selector-class">.word</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">STACKINIT</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">RESET</span></span>: <span class="hljs-selector-class"><span class="hljs-selector-class">.word</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">main</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">NMI_HANDLER</span></span>: <span class="hljs-selector-class"><span class="hljs-selector-class">.word</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">nmi_fault</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">HARD_FAULT</span></span>: <span class="hljs-selector-class"><span class="hljs-selector-class">.word</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">hard_fault</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">MEMORY_FAULT</span></span>: <span class="hljs-selector-class"><span class="hljs-selector-class">.word</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">memory_fault</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">BUS_FAULT</span></span>: <span class="hljs-selector-class"><span class="hljs-selector-class">.word</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">bus_fault</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">USAGE_FAULT</span></span>: <span class="hljs-selector-class"><span class="hljs-selector-class">.word</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">usage_fault</span></span> <span class="hljs-selector-class"><span class="hljs-selector-class">.org</span></span> 0<span class="hljs-selector-tag"><span class="hljs-selector-tag">x000000B0</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">TIMER2_INTERRUPT</span></span>: <span class="hljs-selector-class"><span class="hljs-selector-class">.word</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">timer2_interupt</span></span> + 1</code> </pre><br>  Je veux attirer l'attention du lecteur sur le fait que la première ligne n'est pas le vecteur de réinitialisation, mais les valeurs par lesquelles la pile sera initialisée.  Immédiatement après, il y a un vecteur de réinitialisation suivi de 5 vecteurs d'interruption obligatoires (NMI_HANDLER - USAGE_FAULT). <br><a name="habracut"></a><br><h2>  Développement </h2><br>  La première chose avec laquelle j'ai été coincé a été la syntaxe de l'assembleur ARM.  Même pendant l'étude du vecteur d'interruption, je suis tombé sur des références au fait que ARM a 2 types d'instructions Thumb et non Thumb.  Et que Cortex-M3 (STM32F103C8 à savoir Cortex-M3) ne prend en charge qu'un ensemble d'instructions Thumb.  J'ai écrit des instructions strictement selon la documentation, mais pour une raison quelconque, l'assembleur les a maudites. <blockquote>  registre non décalé requis </blockquote>  Il s'est avéré qu'au début du programme <blockquote>  .syntax unified </blockquote>  cela indique à l'assembleur que vous pouvez utiliser les instructions Thumb et non-Thumb en même temps. <br><br>  La prochaine chose que j'ai rencontrée était les ports GPOI par défaut désactivés.  Pour les faire fonctionner, vous devez entre autres définir les valeurs appropriées dans les registres RCC (réinitialisation et contrôle d'horloge).  J'ai utilisé PORT C, il peut être activé en réglant le bit 4 (la numérotation des bits part de zéro) dans RCC_APB2ENR (registre d'activation d'horloge périphérique 2). <br><br>  LED clignotante supplémentaire.  Tout d'abord, comme dans Arduino, vous devez définir une broche pour l'enregistrement.  Cela se fait via GPIOx_CRL (registre de contrôle bas) ou GPIOx_CRH (registre de contrôle haut).  Ici, il est nécessaire d'annuler que pour chaque broche 4 bits sont responsables dans l'un de ces registres (registres 32 bits).  2 bits (MODEy) déterminent le débit de données maximum et la configuration des broches 2 bits (CNF).  J'ai utilisé la broche 14 de PORT C, pour cela j'ai mis les bits [25:24] = 10 et les bits [27:26] = 00 dans le registre GPIOx_CRH. <br><br>  Pour que la diode brûle, vous devez définir le bit correspondant dans GPIOx_ODR (registre de données de sortie).  Dans mon cas, bit 14. Cela pourrait mettre fin à cet exemple simple en créant une fonction de retard et en mettant le tout dans une boucle, mais je ne pouvais pas le faire.  J'ai décidé de régler des interruptions de minuterie ... Il s'est avéré que c'était en vain, principalement parce que les temporisateurs sont trop rapides pour ce genre de tâche. <br><br>  Je ne décrirai pas en détail les paramètres de la minuterie, qui sont intéressés par le code sur <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Github</a> .  L'idée était simple, dans un cycle, envoyer le processeur en veille, quitter le ralenti par minuterie pour allumer / éteindre la LED et à nouveau en veille.  Mais la minuterie a fonctionné beaucoup plus rapidement que j'ai réussi à faire tout ce qui précède, à cause de laquelle j'ai dû entrer dans un compteur supplémentaire. <br><br>  Le compteur est une variable de 32 bits qui aurait dû être dans SRAM.  Et puis un autre râteau m'attendait.  Lorsque j'ai programmé dans Atmega pour placer une variable dans SRAM, via .org, j'ai défini l'adresse du début de la mémoire où le bloc de données a été réellement placé.  Maintenant, après avoir lu un peu sur l'initialisation de la mémoire, je ne sais pas si c'était correct, mais cela a fonctionné.  Et j'ai décidé de lancer la même chose avec STM32.  L'adresse de début de mémoire dans STM32F103C8 est 0x20000000.  Et quand j'ai fait .org à cette adresse, j'ai eu un binaire de 512 Mo.  Cela m'a envoyé quelques nuits pour fumer des manuels.  Je ne comprends toujours pas à 100% comment cela fonctionne, mais pour autant que je sache, la section .data place les valeurs par lesquelles les variables doivent être initialisées dans un fichier exécutable, mais au moment de l'exécution, le programmeur doit initialiser les valeurs des variables en mémoire.  Corrigez-moi s'il vous plaît si je me trompe.  J'ai fini par créer une variable comme celle-ci: <br><br><pre> <code class="hljs css"><span class="hljs-selector-class"><span class="hljs-selector-class">.section</span></span> <span class="hljs-selector-class"><span class="hljs-selector-class">.bss</span></span> <span class="hljs-selector-class"><span class="hljs-selector-class">.offset</span></span> 0<span class="hljs-selector-tag"><span class="hljs-selector-tag">x20000000</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">flash_counter</span></span>: <span class="hljs-selector-class"><span class="hljs-selector-class">.word</span></span></code> </pre><br>  Initialisé au début de la fonction principale et la LED clignote.  J'espère que cet article aide quelqu'un.  Si vous avez des questions, je me ferai un plaisir d'y répondre. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr405959/">https://habr.com/ru/post/fr405959/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr405949/index.html">Comment un gobelet Electron a tué</a></li>
<li><a href="../fr405951/index.html">Modernisation de la "plaque" sous la lampe GX70</a></li>
<li><a href="../fr405953/index.html">Actualités en neurobiologie: le cerveau sans sommeil se mange, le chapeau magique d'Elon Mask, l'interrupteur et autre chose</a></li>
<li><a href="../fr405955/index.html">Les tentatives des scientifiques pour dissiper les mythes sur la vaccination n'ont fait que renforcer les illusions des gens</a></li>
<li><a href="../fr405957/index.html">Un bug logiciel a bloqué des centaines de verrous intelligents</a></li>
<li><a href="../fr405961/index.html">ARMOUR BOOT 2017: Plus grand, plus frais, plus fort</a></li>
<li><a href="../fr405963/index.html">Un appel de la lune: une startup allemande s'apprête à installer une station de base LTE sur le satellite terrestre</a></li>
<li><a href="../fr405965/index.html">API de géolocalisation: géolocalisation IP ou W3C?</a></li>
<li><a href="../fr405967/index.html">Armes secrètes ou pourquoi flèches de gratte-ciel</a></li>
<li><a href="../fr405969/index.html">Les opérateurs des Quatre Grands ne se sont pas conformés à l'exigence FAS d'annuler l'itinérance nationale en Fédération de Russie</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>