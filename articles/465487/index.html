<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë©üèº‚Äçüç≥ üëä „äóÔ∏è Construye una plataforma kubernetes en Pinterest üç• ‚§¥Ô∏è üé°</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="A lo largo de los a√±os de la existencia de Pinterest, 300 millones de usuarios del servicio han creado m√°s de 200 mil millones de pines en m√°s de 4 mi...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Construye una plataforma kubernetes en Pinterest</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/itsumma/blog/465487/">  <i>A lo largo de los a√±os de la existencia de Pinterest, 300 millones de usuarios del servicio han creado m√°s de 200 mil millones de pines en m√°s de 4 mil millones de tableros.</i>  <i>Para servir a este ej√©rcito de usuarios y una amplia base de contenido, el portal ha desarrollado miles de servicios, que van desde microservicios que pueden manejar varias CPU, y terminando con monolitos gigantes que giran en toda una flota de m√°quinas virtuales.</i>  <i>Y entonces lleg√≥ el momento en que los ojos de la compa√±√≠a se centraron en k8.</i>  <i>¬øQu√© le pareci√≥ el "cubo" a "Inter√©s"?</i>  <i>Aprender√° sobre esto con nuestra traducci√≥n de la √∫ltima <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">publicaci√≥n de blog de ingenier√≠a de Pinterest</a> .</i> <br><br><img src="https://habrastorage.org/webt/ns/nd/tz/nsndtzsnqp6b0zn8ir1zrlzok28.png"><br><br>  Entonces, cientos de millones de usuarios y cientos de miles de millones de pines.  Para servir a este ej√©rcito de usuarios y una amplia base de contenido, hemos desarrollado miles de servicios, que van desde microservicios que pueden ser manejados por varias CPU hasta monolitos gigantes que giran en una flota completa de m√°quinas virtuales.  Adem√°s, tenemos una variedad de marcos que tambi√©n pueden requerir recursos de CPU, memoria o acceso a E / S. <br><br>  En apoyo de este zool√≥gico de herramientas, el equipo de desarrollo enfrenta una serie de desaf√≠os: <br><a name="habracut"></a><br><ul><li>  Los ingenieros no tienen una forma unificada de ejecutar un entorno de trabajo.  Los servicios sin estado, los servicios con estado y los proyectos en desarrollo activo se basan en pilas de tecnolog√≠a completamente diferentes.  Esto condujo a la creaci√≥n de un curso completo de capacitaci√≥n para ingenieros, y tambi√©n complica seriamente el trabajo de nuestro equipo de infraestructura. </li><li>  Los desarrolladores con su propia flota de m√°quinas virtuales crean una gran carga en los administradores internos.  Como resultado, operaciones tan simples como actualizar el SO o AMI duran semanas y meses.  Esto lleva a un aumento en la carga de trabajo en situaciones aparentemente absolutamente cotidianas. </li><li>  Dificultades para crear herramientas de administraci√≥n de infraestructura global adem√°s de las soluciones existentes.  La situaci√≥n se complica por el hecho de que encontrar a los propietarios de m√°quinas virtuales no es f√°cil.  Es decir, no sabemos si es seguro extraer estas capacidades para trabajar en otras partes de nuestra infraestructura. </li></ul><br>  Los sistemas de orquestaci√≥n de contenedores son una forma de unificar la gesti√≥n de la carga de trabajo.  Le abren el camino para aumentar la velocidad de desarrollo y simplificar la administraci√≥n de la infraestructura, ya que todos los recursos involucrados en el proyecto son administrados por un sistema centralizado. <br><br><img src="https://habrastorage.org/webt/6l/eq/7l/6leq7lajojjwmt1mg2hlobt4uce.png"><br><br>  <i>Figura 1: Prioridades de infraestructura (confiabilidad, productividad del desarrollador y eficiencia).</i> <br><br>  El equipo de Cloud Management Platform en Pinterest se reuni√≥ con K8 en 2017.  Para el primer semestre de 2017, documentamos la mayor√≠a de nuestras instalaciones de producci√≥n, incluida la API y todos nuestros servidores web.  Despu√©s de eso, evaluamos cuidadosamente los diversos sistemas de orquestaci√≥n de soluciones de contenedores, construyendo cl√∫steres y trabajando con ellos.  A finales de 2017, decidimos usar Kubernetes.  Fue lo suficientemente flexible y ampliamente compatible con la comunidad de desarrolladores. <br><br>  Hasta ahora, hemos creado nuestras propias herramientas de arranque de cl√∫ster basadas en Kops y hemos migrado a los componentes de infraestructura existentes de Kubernetes como red, seguridad, m√©tricas, registro, gesti√≥n de identidad y tr√°fico.  Tambi√©n implementamos un sistema de modelado de carga de trabajo para nuestro recurso, cuya complejidad est√° oculta para los desarrolladores.  Ahora estamos enfocados en garantizar la estabilidad del cl√∫ster, su escalamiento y la conexi√≥n de nuevos clientes. <br><br><h4>  Kubernetes: el camino de Pinterest </h4><br>  Comenzar con Kubernetes en una escala de Pinterest como una plataforma que nuestros ingenieros adorar√°n es abrumador. <br><br>  Como una gran empresa, hemos invertido mucho en herramientas de infraestructura.  Los ejemplos incluyen herramientas de seguridad que procesan certificados y distribuyen claves, componentes de control de tr√°fico, sistemas de descubrimiento de servicios, visibilidad y env√≠o de registros y m√©tricas.  Todo esto se recopil√≥ por una raz√≥n: seguimos el camino normal de prueba y error y, por lo tanto, quer√≠amos integrar toda esta econom√≠a en la nueva infraestructura en Kubernetes en lugar de reinventar la vieja bicicleta en una nueva plataforma.  Este enfoque generalmente simplifica la migraci√≥n, ya que todo el soporte de aplicaciones ya existe, no necesita ser creado desde cero. <br><br>  Por otro lado, los modelos de pron√≥stico de carga en Kubernetes (por ejemplo, implementaciones, trabajos y kits de Daemon) no son suficientes para nuestro proyecto.  Estos problemas de usabilidad son enormes barreras para mudarse a Kubernetes.  Por ejemplo, escuchamos a los desarrolladores de servicios quejarse de una configuraci√≥n de inicio de sesi√≥n faltante o incorrecta.  Tambi√©n encontramos un uso inadecuado de los motores de plantillas cuando se crearon cientos de copias con la misma especificaci√≥n y tarea, lo que result√≥ en problemas de pesadilla con la depuraci√≥n. <br><br>  Tambi√©n fue muy dif√≠cil admitir diferentes versiones en el mismo cl√∫ster.  Imagine la complejidad de la atenci√≥n al cliente si necesita trabajar de inmediato en muchas versiones del mismo tiempo de ejecuci√≥n, con todos sus problemas, errores y actualizaciones. <br><br><h4>  Recursos y controladores personalizados de Pinterest </h4><br>  Para facilitar la implementaci√≥n de Kubernetes a nuestros ingenieros, as√≠ como para simplificar y acelerar la infraestructura, hemos desarrollado nuestras propias definiciones de recursos personalizados (CRD). <br><br>  Los CRD proporcionan las siguientes caracter√≠sticas: <br><br><ol><li>  Combinando varios recursos nativos de Kubernetes para que funcionen como una sola carga.  Por ejemplo, el recurso PinterestService incluye una implementaci√≥n, un servicio de inicio de sesi√≥n y un mapa de configuraci√≥n.  Esto permite a los desarrolladores no preocuparse por configurar DNS. </li><li>  Implemente el soporte de aplicaciones necesario.  El usuario debe centrarse solo en la especificaci√≥n del contenedor de acuerdo con su l√≥gica empresarial, mientras que el controlador CRD implementa todos los contenedores de inicio necesarios, las variables de entorno y las especificaciones del pod.  Esto proporciona un nivel de comodidad fundamentalmente diferente para los desarrolladores. </li><li>  Los controladores CRD tambi√©n administran el ciclo de vida de sus propios recursos y aumentan la disponibilidad de depuraci√≥n.  Esto incluye acordar las especificaciones deseadas y reales, actualizar el estado del CRD y mantener registros de eventos y m√°s.  Sin CRD, los desarrolladores se ver√≠an obligados a administrar un gran conjunto de recursos, lo que solo aumentar√≠a la probabilidad de un error. </li></ol><br>  Aqu√≠ hay un ejemplo de PinterestService y el recurso interno controlado por nuestro controlador: <br><br><img src="https://habrastorage.org/webt/o8/nh/oh/o8nhohmr-jzi5lzoqpapflkbwdi.png"><br><br>  Como puede ver arriba, para admitir un contenedor personalizado, necesitamos integrar un contenedor de inicializaci√≥n y varios complementos para garantizar la seguridad, la visibilidad y el trabajo con el tr√°fico de red.  Adem√°s, creamos plantillas de mapas de configuraci√≥n e implementamos soporte para plantillas de PVC para trabajos por lotes, as√≠ como tambi√©n rastreamos una variedad de variables de entorno para rastrear la identificaci√≥n, el consumo de recursos y la recolecci√≥n de basura. <br><br>  Es dif√≠cil imaginar que los desarrolladores quieran escribir estos archivos de configuraci√≥n manualmente sin soporte CRD, sin mencionar m√°s soporte y depuraci√≥n de configuraciones. <br><br><h4>  Implementaci√≥n de aplicaciones de flujo de trabajo </h4><br><img src="https://habrastorage.org/webt/ia/s1/ak/ias1akn3t5xtlubqimuo5apiaci.png"><br><br>  La figura anterior muestra c√≥mo implementar un recurso personalizado de Pinterest en un cl√∫ster de Kubernetes: <br><br><ol><li>  Los desarrolladores interact√∫an con nuestro cl√∫ster de Kubernetes a trav√©s de la CLI y la interfaz de usuario. </li><li>  Las herramientas CLI / UI extraen los archivos YAML de configuraci√≥n del flujo de trabajo y otras propiedades de ensamblaje (mismo identificador de versi√≥n) de Artifactory y luego los env√≠an al Servicio de env√≠o de trabajos.  Este paso garantiza que solo se entreguen versiones de producci√≥n al cl√∫ster. </li><li>  JSS es la puerta de entrada a varias plataformas, incluido Kubernetes.  Aqu√≠ es donde se lleva a cabo la autenticaci√≥n del usuario, la emisi√≥n de cuotas y la verificaci√≥n parcial de nuestra configuraci√≥n CRD. </li><li>  Despu√©s de verificar el CRD en el lado JSS, la informaci√≥n se env√≠a a la API de la plataforma k8s. </li><li>  Nuestro controlador CRD monitorea eventos en todos los recursos del usuario.  Convierte CR en recursos nativos de k8, agrega los m√≥dulos necesarios, establece las variables de entorno apropiadas y realiza otro trabajo auxiliar, lo que garantiza a las aplicaciones de usuario de contenedores suficiente soporte de infraestructura. </li><li>  Luego, el controlador CRD transfiere los datos recibidos a la API de Kubernetes para que el planificador los procese y los ponga en funcionamiento. </li></ol><br>  <b>Nota</b> : esta implementaci√≥n de flujo de trabajo de prelanzamiento se cre√≥ para los primeros usuarios de la nueva plataforma k8s.  Ahora estamos en el proceso de finalizar este proceso para integrarnos completamente con nuestro nuevo CI / CD.  Esto significa que no podemos decir todo lo relacionado con Kubernetes.  Esperamos compartir nuestra experiencia y contarle al equipo sobre este progreso en nuestra pr√≥xima publicaci√≥n en el blog ‚ÄúConstruyendo una plataforma CI / CD para Pinterest‚Äù. <br><br><h4>  Tipos de recursos especiales </h4><br>  En base a las necesidades espec√≠ficas de Pinterest, hemos desarrollado los siguientes CRD que son adecuados para una variedad de flujos de trabajo: <br><br><ul><li>  PinterestService es un servicio sin estado de larga duraci√≥n.  Muchos de nuestros sistemas principales se basan en un conjunto de dichos servicios. </li><li>  PinterestJobSet modela trabajos por lotes de ciclo completo.  Pinterest tiene un escenario com√∫n, seg√∫n el cual varias tareas ejecutan los mismos contenedores en paralelo, e independientemente de otros procesos similares. </li><li>  PinterestCronJob se usa ampliamente junto con peque√±as cargas peri√≥dicas.  Este es un shell nativo cron con mecanismos de soporte de Pinterest que son responsables de la seguridad, el tr√°fico, los registros y las m√©tricas. </li><li>  Daemon incluye la infraestructura de Daemon.  Esta familia contin√∫a creciendo a medida que agregamos m√°s apoyo para nuestros grupos. </li><li>  PinterestTrainingJob se extiende a los procesos de Tensorflow y Pytorch, proporcionando el mismo nivel de soporte en l√≠nea que todos los otros CRD.  Dado que Pinterest est√° utilizando activamente Tensorflow y otros sistemas de aprendizaje autom√°tico, ten√≠amos una raz√≥n para construir un CRD separado a su alrededor. </li></ul><br>  Tambi√©n estamos trabajando en PinterestStatefulSet, que pronto se adaptar√° para almacenes de datos y otros sistemas con estado. <br><br><h4>  Soporte de tiempo de ejecuci√≥n </h4><br>  Cuando el m√≥dulo de aplicaci√≥n se ejecuta en Kubernetes, recibe autom√°ticamente un certificado para identificarse.  Este certificado se utiliza para acceder al almac√©n secreto o para comunicarse con otros servicios a trav√©s de mTLS.  Mientras tanto, el configurador de inicializaci√≥n del contenedor y Daemon descargar√°n todas las dependencias necesarias antes de iniciar la aplicaci√≥n del contenedor.  Cuando todo est√© listo, el tr√°fico de sidecar y Daemon registrar√°n la direcci√≥n IP del m√≥dulo en nuestro Zookeeper para que los clientes puedan encontrarlo.  Todo esto funcionar√°, ya que el m√≥dulo de red se configur√≥ antes de que se iniciara la aplicaci√≥n. <br><br>  Los siguientes son ejemplos t√≠picos de soporte de carga de trabajo en tiempo de ejecuci√≥n.  Para otros tipos de cargas de trabajo, es posible que se requiera un soporte ligeramente diferente, pero todos se presentan como m√°quinas virtuales de nivel sidecar pod, nodal o nivel Daemon.  Nos aseguramos de que todo esto se implemente dentro del marco de la infraestructura de administraci√≥n y se coordine entre las aplicaciones, lo que finalmente reduce significativamente la carga en t√©rminos de trabajo t√©cnico y soporte al cliente. <br><br><h4>  Pruebas y control de calidad </h4><br>  Hemos reunido una tuber√≠a de prueba de extremo a extremo sobre la infraestructura de prueba de Kubernetes existente.  Estas pruebas se aplican a todos nuestros grupos.  Nuestra tuber√≠a pas√≥ por muchos cambios antes de convertirse en parte del grupo de productos. <br><br>  Adem√°s de los sistemas de prueba, tenemos sistemas de monitoreo y advertencia que monitorean constantemente el estado de los componentes del sistema, el consumo de recursos y otros indicadores importantes, notific√°ndonos solo cuando es necesaria la intervenci√≥n humana. <br><br><h4>  Alternativas </h4><br>  Analizamos algunas alternativas a los recursos personalizados, como los controladores de acceso mutacional y los sistemas de plantillas.  Sin embargo, todos ellos est√°n llenos de serias dificultades en el trabajo, por lo que elegimos el camino de CRD. <br><br>  Se us√≥ un controlador de tolerancia a la mutaci√≥n para ingresar los sidecars, una variable de entorno y otro soporte de tiempo de ejecuci√≥n.  Sin embargo, se enfrent√≥ a varios problemas, por ejemplo, con la vinculaci√≥n de recursos y la gesti√≥n de su ciclo de vida, cuando tales problemas no surgen en CRD. <br><br>  <b>Nota:</b> Los sistemas de plantillas, como los diagramas de Helm, tambi√©n se usan ampliamente para ejecutar aplicaciones con configuraciones similares.  Sin embargo, nuestras aplicaciones de producci√≥n son demasiado diversas para administrarlas con plantillas.  Adem√°s, durante la implementaci√≥n continua, el uso de plantillas generar√° demasiados errores. <br><br><h4>  Trabajo futuro </h4><br>  Ahora estamos lidiando con una carga mixta en todos nuestros cl√∫steres.  Para admitir procesos similares de diferentes tipos y tama√±os, trabajamos en las siguientes √°reas: <br><br><ul><li>  Un grupo de grupos distribuye grandes aplicaciones entre grupos para proporcionar escalabilidad y estabilidad. </li><li>  Garantizar la estabilidad, escalabilidad y visibilidad del cl√∫ster para crear la conexi√≥n de la aplicaci√≥n y su SLA. </li><li>  Gesti√≥n de recursos y cuotas para que las aplicaciones no entren en conflicto entre s√≠, y la escala del cl√∫ster est√© controlada por nosotros. </li><li>  Nueva plataforma CI / CD para soportar y desplegar aplicaciones en Kubernetes. </li></ul></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/465487/">https://habr.com/ru/post/465487/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../465475/index.html">Mini-entrevista con Oleg Anastasiev: tolerancia a fallas en Apache Cassandra</a></li>
<li><a href="../465477/index.html">C√≥mo le ense√±√© a una serpiente a jugar con Q-Network</a></li>
<li><a href="../465479/index.html">Pixel Lo-fi en Unity</a></li>
<li><a href="../465483/index.html">Antig√ºedades: Windows 3.1 y la vida sin un bot√≥n de inicio</a></li>
<li><a href="../465485/index.html">Imprimir tapiz Game of Thrones en una impresora fiscal usando Python</a></li>
<li><a href="../465489/index.html">Lista de verificaci√≥n de preparaci√≥n de producci√≥n</a></li>
<li><a href="../465491/index.html">Zabbix + Voximplant: monitoreo con llamadas, o c√≥mo dejar de preocuparse y configurarlo r√°pidamente</a></li>
<li><a href="../465493/index.html">Lenguaje de programaci√≥n r√°pido en Raspberry Pi</a></li>
<li><a href="../465495/index.html">C√≥mo no perder tr√°fico cuando se muda a un nuevo dominio: caso "Vse10"</a></li>
<li><a href="../465497/index.html">Mensajes secretos a trav√©s de registros del servidor</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>