<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üåÑ üôÖüèæ üöÄ Python: comment r√©duire de moiti√© la consommation m√©moire en ajoutant une seule ligne de code? üßó ‚è±Ô∏è üò¢</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Salut habr. 

 Dans un projet o√π il √©tait n√©cessaire de stocker et de traiter une liste dynamique assez grande, les testeurs ont commenc√© √† se plaindr...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Python: comment r√©duire de moiti√© la consommation m√©moire en ajoutant une seule ligne de code?</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/427909/">  Salut habr. <br><br>  Dans un projet o√π il √©tait n√©cessaire de stocker et de traiter une liste dynamique assez grande, les testeurs ont commenc√© √† se plaindre du manque de m√©moire.  Un moyen simple de r√©soudre le probl√®me avec "peu de sang" en ajoutant une seule ligne de code est d√©crit ci-dessous.  Le r√©sultat dans l'image: <br><img src="https://habrastorage.org/webt/-z/zv/mu/-zzvmusqts90jkz_wityj3n1yia.png"><br><br>  Comment cela fonctionne, a continu√© sous la coupe. <a name="habracut"></a><br><br>  Prenons un exemple simple de ¬´formation¬ª - cr√©ez une classe DataItem contenant <s>des</s> donn√©es <s>personnelles</s> sur une personne, telles que son nom, son √¢ge et son adresse. <br><pre><code class="python hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">DataItem</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(object)</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__init__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, name, age, address)</span></span></span><span class="hljs-function">:</span></span> self.name = name self.age = age self.address = address</code> </pre> <br>  La question des "enfants" est de savoir combien un tel objet prend en m√©moire? <br><br>  Essayons la solution au front: <br><pre> <code class="python hljs">d1 = DataItem(<span class="hljs-string"><span class="hljs-string">"Alex"</span></span>, <span class="hljs-number"><span class="hljs-number">42</span></span>, <span class="hljs-string"><span class="hljs-string">"-"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">print</span></span> (<span class="hljs-string"><span class="hljs-string">"sys.getsizeof(d1):"</span></span>, sys.getsizeof(d1))</code> </pre> <br>  Nous obtenons une r√©ponse de 56 octets.  Cela semble un peu, assez satisfait. <br>  Cependant, nous v√©rifions un autre objet dans lequel il y a plus de donn√©es: <br><pre> <code class="python hljs">d2 = DataItem(<span class="hljs-string"><span class="hljs-string">"Boris"</span></span>, <span class="hljs-number"><span class="hljs-number">24</span></span>, <span class="hljs-string"><span class="hljs-string">"In the middle of nowhere"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">print</span></span> (<span class="hljs-string"><span class="hljs-string">"sys.getsizeof(d2):"</span></span>, sys.getsizeof(d2))</code> </pre> <br>  La r√©ponse est encore 56. √Ä ce stade, nous comprenons que quelque chose ne se passe pas ici et que tout n'est pas aussi simple qu'il y para√Æt √† premi√®re vue. <br><br>  L'intuition ne nous fait pas d√©faut, et tout n'est vraiment pas si simple.  Python est un langage tr√®s flexible avec une frappe dynamique, et pour son travail, il stocke beaucoup de donn√©es suppl√©mentaires.  Qui en eux-m√™mes prennent beaucoup.  √Ä titre d'exemple, sys.getsizeof ("") renverra 33 - oui, jusqu'√† 33 octets par ligne vide!  Et sys.getsizeof (1) renverra 24 √† 24 octets pour un entier (je demande aux programmeurs C de s'√©loigner de l'√©cran et de ne pas lire plus loin, afin de ne pas perdre confiance dans le beau).  Pour les √©l√©ments plus complexes, comme un dictionnaire, sys.getsizeof (dict ()) renverra 272 octets - et ceci pour un dictionnaire <i>vide</i> .  Je ne continuerai pas plus loin, j'esp√®re que le principe est clair, <s>et les fabricants de RAM doivent √©galement vendre leurs puces</s> . <br><br>  Mais revenons √† notre classe DataItem et √† la question "enfant".  Combien de temps une telle classe prend-elle en m√©moire?  Pour commencer, nous affichons l'int√©gralit√© du contenu de la classe √† un niveau inf√©rieur: <br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">dump</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(obj)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> attr <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> dir(obj): print(<span class="hljs-string"><span class="hljs-string">" obj.%s = %r"</span></span> % (attr, getattr(obj, attr)))</code> </pre> <br>  Cette fonction montrera ce qui est cach√© ¬´sous le capot¬ª afin que toutes les fonctions Python (frappe, h√©ritage et autres goodies) puissent fonctionner. <br>  Le r√©sultat est impressionnant: <br><img src="https://habrastorage.org/webt/_l/w_/sf/_lw_sf57xadzzmacifxd8-hxiru.png"><br><br>  Combien cela prend-il?  Sur github, il y avait une fonction qui calcule la quantit√© r√©elle de donn√©es, appelant r√©cursivement getsizeof pour tous les objets. <br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">get_size</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(obj, seen=None)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-comment"><span class="hljs-comment"># From https://goshippo.com/blog/measure-real-size-any-python-object/ # Recursively finds size of objects size = sys.getsizeof(obj) if seen is None: seen = set() obj_id = id(obj) if obj_id in seen: return 0 # Important mark as seen *before* entering recursion to gracefully handle # self-referential objects seen.add(obj_id) if isinstance(obj, dict): size += sum([get_size(v, seen) for v in obj.values()]) size += sum([get_size(k, seen) for k in obj.keys()]) elif hasattr(obj, '__dict__'): size += get_size(obj.__dict__, seen) elif hasattr(obj, '__iter__') and not isinstance(obj, (str, bytes, bytearray)): size += sum([get_size(i, seen) for i in obj]) return size</span></span></code> </pre><br>  Nous l'essayons: <br><pre> <code class="python hljs">d1 = DataItem(<span class="hljs-string"><span class="hljs-string">"Alex"</span></span>, <span class="hljs-number"><span class="hljs-number">42</span></span>, <span class="hljs-string"><span class="hljs-string">"-"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">print</span></span> (<span class="hljs-string"><span class="hljs-string">"get_size(d1):"</span></span>, get_size(d1)) d2 = DataItem(<span class="hljs-string"><span class="hljs-string">"Boris"</span></span>, <span class="hljs-number"><span class="hljs-number">24</span></span>, <span class="hljs-string"><span class="hljs-string">"In the middle of nowhere"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">print</span></span> (<span class="hljs-string"><span class="hljs-string">"get_size(d2):"</span></span>, get_size(d2))</code> </pre> <br>  Nous obtenons respectivement 460 et 484 octets, ce qui ressemble davantage √† la v√©rit√©. <br><br>  Ayant cette fonction, un certain nombre d'exp√©riences peuvent √™tre effectu√©es.  Par exemple, je me demande quelle quantit√© de donn√©es prendra si vous mettez les structures DataItem dans la liste.  La fonction get_size ([d1]) retourne 532 octets - apparemment, c'est le "m√™me" 460 + quelques frais g√©n√©raux.  Mais get_size ([d1, d2]) renverra 863 octets - moins de 460 + 484 s√©par√©ment.  Encore plus int√©ressant est le r√©sultat pour get_size ([d1, d2, d1]) - nous obtenons 871 octets, juste un peu plus, c'est-√†-dire  Python est suffisamment intelligent pour ne pas allouer de m√©moire pour le m√™me objet une deuxi√®me fois. <br><br>  Passons maintenant √† la deuxi√®me partie de la question - est-il possible de r√©duire la consommation de m√©moire?  Oui tu peux.  Python est un interpr√©teur, et nous pouvons √©tendre notre classe √† tout moment, par exemple, ajouter un nouveau champ: <br><pre> <code class="python hljs">d1 = DataItem(<span class="hljs-string"><span class="hljs-string">"Alex"</span></span>, <span class="hljs-number"><span class="hljs-number">42</span></span>, <span class="hljs-string"><span class="hljs-string">"-"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">print</span></span> (<span class="hljs-string"><span class="hljs-string">"get_size(d1):"</span></span>, get_size(d1)) d1.weight = <span class="hljs-number"><span class="hljs-number">66</span></span> <span class="hljs-keyword"><span class="hljs-keyword">print</span></span> (<span class="hljs-string"><span class="hljs-string">"get_size(d1):"</span></span>, get_size(d1))</code> </pre> <br>  C'est tr√®s bien, mais si nous <u>n'avons pas besoin de</u> cette fonctionnalit√©, nous pouvons forcer l'interpr√©teur √† lister les objets de la classe en utilisant la directive __slots__: <br><pre> <code class="python hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">DataItem</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(object)</span></span></span><span class="hljs-class">:</span></span> __slots__ = [<span class="hljs-string"><span class="hljs-string">'name'</span></span>, <span class="hljs-string"><span class="hljs-string">'age'</span></span>, <span class="hljs-string"><span class="hljs-string">'address'</span></span>] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__init__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, name, age, address)</span></span></span><span class="hljs-function">:</span></span> self.name = name self.age = age self.address = address</code> </pre><br>  Vous pouvez en lire plus dans la documentation ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">RTFM</a> ), qui dit que "__slots__ nous permet de d√©clarer explicitement les membres de donn√©es (comme les propri√©t√©s) et de refuser la cr√©ation de __dict__ et __weakref__. L'espace √©conomis√© en utilisant __dict__ <i>peut √™tre important</i> ". <br>  V√©rifier: oui, vraiment significatif, get_size (d1) renvoie ... 64 octets au lieu de 460, c'est-√†-dire  7 fois moins.  En prime, les objets sont cr√©√©s environ 20% plus rapidement (voir la premi√®re capture d'√©cran de l'article). <br><br>  H√©las, avec une utilisation r√©elle, un tel gain de m√©moire ne sera pas d√ª √† d'autres frais g√©n√©raux.  Cr√©ons un tableau pour 100 000 en ajoutant simplement des √©l√©ments et voyons la consommation de m√©moire: <br><pre> <code class="python hljs">data = [] <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> p <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> range(<span class="hljs-number"><span class="hljs-number">100000</span></span>): data.append(DataItem(<span class="hljs-string"><span class="hljs-string">"Alex"</span></span>, <span class="hljs-number"><span class="hljs-number">42</span></span>, <span class="hljs-string"><span class="hljs-string">"middle of nowhere"</span></span>)) snapshot = tracemalloc.take_snapshot() top_stats = snapshot.statistics(<span class="hljs-string"><span class="hljs-string">'lineno'</span></span>) total = sum(stat.size <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> stat <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> top_stats) print(<span class="hljs-string"><span class="hljs-string">"Total allocated size: %.1f MB"</span></span> % (total / (<span class="hljs-number"><span class="hljs-number">1024</span></span>*<span class="hljs-number"><span class="hljs-number">1024</span></span>)))</code> </pre><br>  Nous avons 16,8 Mo sans __slots__ et 6,9 Mo avec.  Pas 7 fois bien s√ªr, mais quand m√™me assez bien, √©tant donn√© que le changement de code √©tait minime. <br><br>  Maintenant sur les lacunes.  L'activation de __slots__ interdit la cr√©ation de tous les √©l√©ments, y compris __dict__, ce qui signifie, par exemple, qu'un tel code pour traduire la structure en json ne fonctionnera pas: <br><pre> <code class="python hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">toJSON</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> json.dumps(self.__dict__)</code> </pre><br>  Mais c'est facile √† corriger, il suffit de g√©n√©rer votre dict par programme, en triant tous les √©l√©ments de la boucle: <br><pre> <code class="python hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">toJSON</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> data = dict() <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> var <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> self.__slots__: data[var] = getattr(self, var) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> json.dumps(data)</code> </pre><br><br>  Il sera √©galement impossible d'ajouter dynamiquement de nouvelles variables √† la classe, mais dans mon cas, cela n'√©tait pas n√©cessaire. <br><br>  Et le dernier test pour aujourd'hui.  Il est int√©ressant de voir combien de m√©moire prend tout le programme.  Ajoutez une boucle sans fin √† la fin du programme afin qu'il ne se ferme pas et voyez la consommation de m√©moire dans le gestionnaire de t√¢ches Windows. <br>  Sans __slots__: <br><img src="https://habrastorage.org/webt/rj/hf/ge/rjhfgeodoumssq5zlgh_ez0ocwq.png"><br>  16,8 Mo sont en quelque sorte pass√©s miraculeusement (√©dition - une explication du miracle ci-dessous) √† 70 Mo (j'esp√®re que les programmeurs C ne sont pas encore revenus √† l'√©cran?). <br><br>  Avec __slots__ activ√©: <br><img src="https://habrastorage.org/webt/_o/5e/qu/_o5equjilnz9xaps6xegemhj_uy.png"><br><br>  6,9 Mo transform√©s en 27 Mo ... eh bien, apr√®s tout, nous avons √©conomis√© de la m√©moire, 27 Mo au lieu de 70 n'est pas si mal pour le r√©sultat de l'ajout d'une ligne de code. <br><br>  <b>Edit</b> : dans les commentaires (merci √† robert_ayrapetyan pour le test), ils ont sugg√©r√© que la biblioth√®que de d√©bogage tracemalloc occupe beaucoup de m√©moire suppl√©mentaire.  Apparemment, il ajoute des √©l√©ments suppl√©mentaires √† <i>chaque</i> objet cr√©√©.  Si vous le d√©sactivez, la consommation totale de m√©moire sera bien moindre, la capture d'√©cran montre 2 options: <br><img src="https://habrastorage.org/webt/-l/s0/ms/-ls0ms1ccsf6a5d3q-erfppenwk.png"><br><br>  Que faire si vous avez besoin d'√©conomiser encore plus de m√©moire?  Ceci est possible en utilisant la biblioth√®que <b>numpy</b> , qui vous permet de cr√©er des structures de style C, mais dans mon cas, cela n√©cessiterait un raffinement plus approfondi du code, et la premi√®re m√©thode s'est av√©r√©e assez suffisante. <br><br>  Il est √©trange que l'utilisation de __slots__ n'ait jamais √©t√© examin√©e en d√©tail sur Habr√©, j'esp√®re que cet article comblera un peu cette lacune. <br><br>  Au lieu d'une conclusion. <br>  Cet article peut sembler anti-publicit√© de Python, mais ce n'est pas du tout le cas.  Python est tr√®s fiable (vous devez essayer <i>tr√®s</i> fort de supprimer un programme Python), un langage qui est facilement lisible et facile √† √©crire du code.  Ces avantages l'emportent sur les inconv√©nients dans de nombreux cas, mais si vous avez besoin de performances et d'efficacit√© maximales, vous pouvez utiliser des biblioth√®ques comme numpy √©crites en C ++ qui fonctionnent avec les donn√©es assez rapidement et efficacement. <br><br>  Merci √† tous pour votre attention et bon code :) </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr427909/">https://habr.com/ru/post/fr427909/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr427897/index.html">Analyser un imageur √† r√©sonance magn√©tique II: les m√©tamat√©riaux en IRM</a></li>
<li><a href="../fr427899/index.html">JsonWriterSax - une biblioth√®que pour cr√©er JSON</a></li>
<li><a href="../fr427901/index.html">Comment ne pas utiliser l'API de flux Node.js</a></li>
<li><a href="../fr427905/index.html">Extraction de nourriture ou Carrefour √† travers les yeux d'un pirate</a></li>
<li><a href="../fr427907/index.html">Tir de drone, r√¢teau, hacks de vie, d√©veloppement personnel et carri√®re de photographe / vid√©aste: nouveau podcast GLPH</a></li>
<li><a href="../fr427911/index.html">Passions de bureau</a></li>
<li><a href="../fr427913/index.html">Prologue divertissant # 2</a></li>
<li><a href="../fr427915/index.html">Pr√©somption de stupidit√©</a></li>
<li><a href="../fr427917/index.html">R√©ponse au post Pr√©somption de l'esprit</a></li>
<li><a href="../fr427919/index.html">Portage COM vers Linux</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>