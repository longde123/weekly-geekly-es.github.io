<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üï• ‚õπüèæ üíØ SO AQUA RTOS en tiempo real para MK AVR en el entorno BASCOM AVR ‚òéÔ∏è üßëüèª‚Äçü§ù‚Äçüßëüèª üë©üèæ‚Äçüç≥</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Al escribir para c√≥digo MK m√°s complicado que "parpadear una luz", el desarrollador se enfrenta a las limitaciones inherentes a la programaci√≥n lineal...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>SO AQUA RTOS en tiempo real para MK AVR en el entorno BASCOM AVR</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/453708/"> Al escribir para c√≥digo MK m√°s complicado que "parpadear una luz", el desarrollador se enfrenta a las limitaciones inherentes a la programaci√≥n lineal en el estilo de "superciclo m√°s interrupciones".  El procesamiento de las interrupciones requiere velocidad y concisi√≥n, lo que lleva a agregar banderas al c√≥digo y hacer que el estilo del proyecto "superciclo con interrupciones y banderas". <br><br>  Si la complejidad del sistema crece, el n√∫mero de indicadores interdependientes crece exponencialmente, y el proyecto se convierte r√°pidamente en un "c√≥digo de pasta" poco legible y manejable. <br><br>  El uso de sistemas operativos en tiempo real ayuda a eliminar el "c√≥digo de pasta" y devolver la flexibilidad y capacidad de administraci√≥n a un complejo proyecto MK. <br>  Se han desarrollado varios sistemas operativos cooperativos en tiempo real y muy populares para los microcontroladores AVR.  Sin embargo, todos est√°n escritos en C o Assembler y no son adecuados para aquellos que programan MK en el entorno BASCOM AVR, priv√°ndolos de una herramienta tan √∫til para escribir aplicaciones serias. <br><br>  Para corregir esta deficiencia, desarroll√© un RTOS simple para el entorno de programaci√≥n AVR de BASCOM, que llamo la atenci√≥n de los lectores. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/cd6/0be/c64/cd60bec64b2a0b96ed562770a9063355.jpg" alt="imagen"><br><a name="habracut"></a><br>  Para muchos, el estilo de programaci√≥n familiar MK es el llamado  <i>superciclo</i>  En este caso, el c√≥digo consiste en un conjunto de funciones, procedimientos y descriptores (constantes, variables), posiblemente los de la biblioteca, generalmente llamados "c√≥digo de fondo", as√≠ como un gran bucle infinito encerrado en una construcci√≥n <b>do-loop</b> .  Al inicio, el equipo del MK y los dispositivos externos se inicializan primero, se establecen las constantes y los valores iniciales de las variables, y luego se transfiere el control a este superciclo infinito. <br>  La simplicidad del superciclo es obvia.  La mayor√≠a de las tareas realizadas por MK, porque de una forma u otra c√≠clica.  Las desventajas tambi√©n son evidentes: si alg√∫n dispositivo o se√±al requiere una reacci√≥n inmediata, MK lo proporcionar√° tan pronto como el ciclo cambie.  Si la duraci√≥n de la se√±al es m√°s corta que el per√≠odo del ciclo, dicha se√±al se omitir√°. <br><br>  En el siguiente ejemplo, queremos verificar si se <b>presiona</b> el bot√≥n: <br><br><pre><code class="vbscript hljs"><span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-comment"><span class="hljs-comment">' -  if button = 1 then '     '  -  loop</span></span></code> </pre> <br>  Obviamente, si "alg√∫n c√≥digo" funciona el tiempo suficiente, MK puede no notar una breve pulsaci√≥n de un bot√≥n. <br><br>  Afortunadamente, MK est√° equipado con un sistema de interrupci√≥n que puede resolver este problema: todas las se√±ales cr√≠ticas pueden "colgarse" en las interrupciones y se puede escribir un controlador para cada una.  Entonces aparece el siguiente nivel: un <i>superciclo con interrupciones</i> . <br>  El siguiente ejemplo muestra la estructura del programa con un superciclo y una interrupci√≥n que procesa un clic de bot√≥n: <br><br><pre> <code class="vbscript hljs"><span class="hljs-keyword"><span class="hljs-keyword">on</span></span> button button_isr <span class="hljs-comment"><span class="hljs-comment">'    enable interrupts ' ***  *** do ' -  loop end '   button_isr: '  -    return</span></span></code> </pre> <br>  Sin embargo, el uso de interrupciones plantea un nuevo problema: el c√≥digo del controlador de interrupciones debe ser lo m√°s r√°pido y corto posible;  dentro de las interrupciones, la funcionalidad MK es limitada.  Dado que los AVR MK no tienen un sistema de interrupci√≥n jer√°rquico, no puede ocurrir otra interrupci√≥n dentro de una interrupci√≥n; en este momento, est√°n desactivados por hardware.  Por lo tanto, la interrupci√≥n debe ejecutarse lo m√°s r√°pido posible, de lo contrario, otras interrupciones (y posiblemente las m√°s importantes) se omitir√°n y no se procesar√°n. <br><br><div class="spoiler">  <b class="spoiler_title">Interrupci√≥n de la memoria</b> <div class="spoiler_text">  De hecho, al estar dentro de la interrupci√≥n, MK puede notar el hecho de otra interrupci√≥n en un registro especial, lo que permite que se procese m√°s tarde.  Sin embargo, esta interrupci√≥n no se puede procesar de inmediato. <br></div></div><br>  Por lo tanto, no podemos escribir algo complicado en el controlador de interrupciones, especialmente si este c√≥digo debe tener demoras, porque hasta que la demora funcione, el MK no volver√° al programa principal (superciclo) y estar√° sordo a otras interrupciones. <br><br>  Debido a esto, dentro del controlador de interrupciones, a menudo solo tiene que marcar el hecho del evento con una bandera, la suya para cada evento, y luego verificar y procesar las banderas dentro del superciclo.  Esto, por supuesto, alarga el tiempo de reacci√≥n al evento, pero al menos no nos perdemos algo importante. <br><br>  Por lo tanto, surge el siguiente nivel de complejidad: un <i>superciclo con interrupciones y banderas</i> . <br><br>  Se muestra el siguiente c√≥digo: <br><br><pre> <code class="vbscript hljs"><span class="hljs-keyword"><span class="hljs-keyword">on</span></span> button button_isr <span class="hljs-comment"><span class="hljs-comment">'    enable interrupts ' ***  *** do ' -  if button_flag = 1 then '     button_flag = 0 '     end if '  -  loop end ' ***    *** button_isr: button_flag = 1 return</span></span></code> </pre> <br>  Esto limita un n√∫mero considerable de programas para MK.  Sin embargo, estos programas suelen ser a√∫n m√°s o menos simples.  Si escribe algo m√°s complicado, entonces el n√∫mero de banderas comienza a crecer como una bola de nieve, y el c√≥digo se vuelve cada vez m√°s confuso e ilegible.  Adem√°s, en el ejemplo anterior, el problema con los retrasos no se ha resuelto.  Por supuesto, puede "colgar" una interrupci√≥n separada en el temporizador, y en √©l ... tambi√©n controlar varias banderas.  Pero esto hace que el programa sea completamente feo, el n√∫mero de indicadores interdependientes est√° creciendo exponencialmente, e incluso el propio desarrollador dif√≠cilmente puede descubrir un "c√≥digo de pasta" muy pronto.  Tratar de encontrar un error o modificar el c√≥digo a menudo se vuelve igual en los esfuerzos para desarrollar un nuevo proyecto. <br><br>  ¬øC√≥mo resolver el problema del "c√≥digo de pasta" y hacerlo m√°s legible y manejable?  El <i>sistema operativo</i> (SO) viene al rescate.  En √©l, la funcionalidad que MK deber√≠a implementar se divide en tareas cuya operaci√≥n es controlada por el sistema operativo. <br><br><h2>  Tipos de sistemas operativos para MK </h2><br>  Los sistemas operativos para MK se pueden dividir en dos grandes clases: SO con desplazamiento y SO cooperativo.  En cualquiera de estos sistemas operativos, las tareas se controlan mediante un procedimiento especial llamado <i>despachador</i> .  En un sistema operativo con <i>desplazamiento, el</i> despachador de forma independiente en cualquier momento cambia la ejecuci√≥n de una tarea a otra, asignando a cada uno un cierto n√∫mero de ciclos de reloj (posiblemente diferentes, dependiendo de la prioridad de la tarea).  Este enfoque en su conjunto funciona muy bien, lo que le permite no mirar en absoluto el contenido de las tareas: puede escribir al menos el c√≥digo de la tarea <br><br><pre> <code class="vbscript hljs"><span class="hljs-number"><span class="hljs-number">1</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">goto</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span></code> </pre> <br>  - y a√∫n se realizar√°n el resto de las tareas (incluida esta).  Sin embargo, los sistemas operativos preventivos requieren muchos recursos (memoria del procesador y ciclos de reloj), ya que cada conmutador debe guardar completamente el contexto de la tarea que se deshabilitar√° y cargar el contexto del curr√≠culum.  El contexto aqu√≠ se refiere al contenido de los registros de la m√°quina y la pila (BASCOM usa dos pilas: la de hardware para las direcciones de retorno de los subprogramas y la de software para pasar argumentos).  Esta carga no solo requiere muchos ciclos de procesador, sino que tambi√©n el contexto de cada tarea debe almacenarse en alg√∫n lugar durante un tiempo hasta que funcione.  En los procesadores "grandes", inicialmente orientados a la multitarea, estas funciones a menudo son compatibles con el hardware y tienen muchos m√°s recursos.  En AVR MK no hay soporte de hardware para la multitarea (todo debe hacerse "manualmente"), y la memoria disponible es peque√±a.  Por lo tanto, los sistemas operativos de desplazamiento, aunque existen, no son demasiado adecuados para MK simples. <br><br>  Otra cosa es el <i>sistema operativo cooperativo</i> .  Aqu√≠ la tarea misma controla en qu√© punto transferir el control al despachador, lo que le permite iniciar otras tareas.  Adem√°s, las tareas aqu√≠ son necesarias para hacer esto; de lo contrario, la ejecuci√≥n del c√≥digo se detendr√°.  Por un lado, parece que este enfoque reduce la confiabilidad general: si una tarea se cuelga, nunca llamar√° al despachador y todo el sistema dejar√° de responder.  Por otro lado, un c√≥digo lineal o un superciclo no es mejor a este respecto, ya que pueden congelarse con exactamente el mismo riesgo. <br><br>  Sin embargo, un sistema operativo cooperativo tiene una ventaja importante.  Como aqu√≠ el programador establece el momento de cambiarse a s√≠ mismo, no puede suceder repentinamente, por ejemplo, mientras la tarea est√° trabajando con alg√∫n recurso o en el medio del c√°lculo de una expresi√≥n aritm√©tica.  Por lo tanto, en un sistema operativo cooperativo, en la mayor√≠a de los casos, puede hacerlo sin mantener el contexto.  Esto ahorra significativamente tiempo y memoria del procesador y, por lo tanto, parece mucho m√°s adecuado para la implementaci√≥n en MK AVR. <br><br><h2>  Cambio de tareas en BASCOM AVR </h2><br>  Para implementar la conmutaci√≥n de tareas en el entorno AVR de BASCOM, el c√≥digo de la tarea, cada uno de los cuales se implementa como un procedimiento normal, debe en alg√∫n lugar llamar al despachador, tambi√©n implementado como un procedimiento normal. <br>  Imagine que tenemos dos tareas, cada una de las cuales en alg√∫n lugar de su c√≥digo es llamada por el despachador. <br><br><pre> <code class="vbscript hljs"><span class="hljs-keyword"><span class="hljs-keyword">sub</span></span> task1() <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-comment"><span class="hljs-comment">'  1 '  loop end sub ' ---------------------------------- sub task2() do '  2 '  loop end sub</span></span></code> </pre> <br>  Supongamos que se ejecut√≥ la tarea 1. Veamos qu√© sucede en la pila cuando ejecuta una "llamada de despachador": <br><br><blockquote>  direcci√≥n de retorno al c√≥digo principal (2 bytes) <br>  parte superior de la pila -&gt; direcci√≥n de retorno a la Tarea 1 que llam√≥ al despachador (2 bytes) </blockquote><br>  La parte superior de la pila apuntar√° a la direcci√≥n de la instrucci√≥n en la Tarea 1, que sigue a la llamada del despachador (la instrucci√≥n de <b>bucle</b> en nuestro ejemplo). <br><br>  El objetivo del despachador en el caso m√°s simple es transferir el control a la Tarea 2. La pregunta es ¬øc√≥mo hacer esto?  (supongamos que el despachador ya conoce la direcci√≥n de la Tarea 2). <br><br>  Para hacer esto, el despachador debe extraer la direcci√≥n de retorno a la Tarea 1 de la pila (y en alg√∫n lugar para recordar), y poner la direcci√≥n de la Tarea 2 en este lugar en la pila, y luego dar el comando de devoluci√≥n.  El procesador extraer√° la direcci√≥n colocada all√≠ de la pila y, en lugar de regresar a la Tarea 1, proceder√° a la ejecuci√≥n de la Tarea 2. <br><br>  A su vez, cuando la Tarea 2 llama al despachador, tambi√©n extraemos la pila y guardamos la direcci√≥n donde ser√° posible regresar a la Tarea 2, y cargamos la direcci√≥n de la tarea 1 previamente guardada en la pila. D√© el comando de <b>retorno</b> y estaremos en el punto de continuaci√≥n de la Tarea 1 . <br><br>  Como resultado, tenemos un desastre: <br><br><blockquote>  Tarea 1 -&gt; Despachador -&gt; Tarea 2 -&gt; Despachador -&gt; Tarea 1 .... </blockquote><br>  No esta mal!  Y funciona  Pero, por supuesto, esto no es suficiente para un sistema operativo que es pr√°cticamente utilizable.  Despu√©s de todo, no siempre y no todas las tareas deber√≠an funcionar; por ejemplo, pueden <i>esperar</i> algo (la expiraci√≥n del tiempo de retraso, la aparici√≥n de alguna se√±al, etc.).  Por lo tanto, las tareas deben tener un <i>estado</i> (TRABAJOS, LISTO, ESPERADO, etc.).  Adem√°s, ser√≠a bueno tener tareas asignadas con <i>prioridad</i> .  Luego, si hay m√°s de una tarea lista para su ejecuci√≥n, el despachador continuar√° la tarea que tenga la m√°xima prioridad. <br><br><h2>  AQUA RTOS </h2><br>  Para implementar la idea descrita, se desarroll√≥ la cooperativa OS AQUA RTOS, que proporciona los servicios necesarios para las tareas y permite implementar la multitarea cooperativa en el entorno BASCOM AVR. <br><br><div class="spoiler">  <b class="spoiler_title">Aviso importante sobre el modo de procedimiento en BASCOM AVR</b> <div class="spoiler_text">  Antes de comenzar la descripci√≥n de AUQA RTOS, debe tenerse en cuenta que el entorno BASCOM AVR admite dos tipos de procedimientos de direccionamiento.  Esto est√° regulado por el submodo config = nuevo |  viejo <br>  En el caso de especificar la opci√≥n anterior, el compilador, en primer lugar, compilar√° todo el c√≥digo linealmente, independientemente de si se usa en alg√∫n lugar o no, y en segundo lugar, los procedimientos sin argumentos dise√±ados en el estilo del subnombre / subnombre final se percibir√°n como procedimientos , con el estilo del nombre: / return.  Esto nos permite pasar la direcci√≥n del procedimiento como una etiqueta como argumento a otro procedimiento utilizando el modificador bylabel.  Esto tambi√©n se aplica a los procedimientos dise√±ados en el estilo del subnombre / subestilo final (debe pasar el nombre del procedimiento como una etiqueta). <br>  Al mismo tiempo, el modo submode = old impone algunas restricciones: los procedimientos de tareas no deben contener argumentos;  el c√≥digo de los archivos conectados a trav√©s de $ include se incluye linealmente en el proyecto general, por lo tanto, se debe proporcionar un bypass en los archivos conectados; vaya de principio a fin usando goto y una etiqueta. <br>  Por lo tanto, en AQUA RTOS, el usuario debe usar solo la antigua notaci√≥n de tarea en el estilo de nombre_tarea: / return para tareas, o usar el subnombre m√°s com√∫n / end sub, agregando el modificador submode = old al comienzo de su c√≥digo, y omitir los archivos incluidos Ir a etiqueta / incluir c√≥digo de archivo / etiqueta:. <br></div></div><br><h3>  Estados de tareas de AQUA RTOS </h3><br>  Los siguientes estados se definen para tareas en AQUA RTOS: <br><br><pre> <code class="vbscript hljs">OSTS_UNDEFINE OSTS_READY OSTS_RUN OSTS_DELAY OSTS_STOP OSTS_WAIT OSTS_PAUSE OSTS_RESTART</code> </pre> <br>  Si la tarea a√∫n no se ha inicializado, se le asigna el estado <b>OSTS_UNDEFINE</b> . <br>  Despu√©s de la inicializaci√≥n, la tarea tiene el estado <b>OSTS_STOP</b> . <br>  Si la tarea <i>est√° lista para ejecutarse</i> , se le asigna el estado <b>OSTS_READY</b> . <br>  La tarea actualmente en ejecuci√≥n tiene el estado <b>OSTS_RUN</b> . <br>  Desde all√≠, puede ir a los estados <b>OSTS_STOP, OSTS_READY, OSTS_DELAY, OSTS_WAIT, OSTS_PAUSE</b> . <br>  El estado <b>OSTS_DELAY</b> tiene una tarea que cumple un <i>retraso</i> . <br>  El estado <b>OSTS_WAIT se</b> asigna a las tareas que est√°n <i>esperando un sem√°foro, evento o mensaje</i> (m√°s informaci√≥n sobre ellos a continuaci√≥n). <br><br>  ¬øCu√°l es la diferencia entre los <b>estados</b> <b>OSTS_STOP</b> y <b>OSTS_PAUSED</b> ? <br>  Si por alguna raz√≥n la tarea recibe el estado de <b>OSTS_STOP</b> , la reanudaci√≥n posterior de la tarea (al recibir el estado de <b>OSTS_READY</b> ) se llevar√° a cabo desde su punto de entrada, es decir.  Desde el principio.  Desde el estado de <b>OSTS_PAUSE, la</b> tarea continuar√° funcionando en el lugar donde se suspendi√≥. <br><br><h3>  Gesti√≥n del estado de la tarea </h3><br>  Tanto el sistema operativo en s√≠ puede administrar autom√°ticamente las tareas, como el usuario, llamando a los servicios del sistema operativo.  Hay varios servicios de administraci√≥n de tareas (los nombres de todos los servicios del sistema operativo comienzan con el prefijo <b>OS_</b> ): <br><br><pre> <code class="vbscript hljs">OS_InitTask(task_label, task_prio) OS_Stop() OS_StopTask(task_label) OS_Pause() OS_PauseTask(task_label) OS_Resume() OS_ResumeTask(task_label) OS_Restart()</code> </pre> <br>  Cada uno de ellos tiene dos opciones: <b>OS_service</b> y <b>OS_serviceTask</b> (excepto el servicio <b>OS_InitTask</b> , que solo tiene una opci√≥n; el servicio <b>OS_Init</b> inicializa el sistema operativo). <br><br>  ¬øCu√°l es la diferencia entre <b>OS_service</b> y <b>OS_serviceTask</b> ?  El primer m√©todo act√∫a sobre la tarea misma que la caus√≥;  el segundo le permite establecer como argumento un puntero a otra tarea y, por lo tanto, administrar otro desde una tarea. <br><br><div class="spoiler">  <b class="spoiler_title">Sobre OS_Resume</b> <div class="spoiler_text">  Todos los servicios de gesti√≥n de tareas, excepto OS_Resume y OS_ResumeTask, llaman autom√°ticamente al administrador de tareas despu√©s del procesamiento.  Por el contrario, los servicios OS_Resume * solo establecen el estado de la tarea en OSTS_READY.  Este estado se procesar√° solo cuando se llame expl√≠citamente al despachador. <br></div></div><br><h3>  Prioridad y cola de tareas </h3><br>  Como se mencion√≥ anteriormente, en un sistema real, algunas tareas pueden ser m√°s importantes, mientras que otras pueden ser secundarias.  Por lo tanto, una caracter√≠stica √∫til del sistema operativo es la capacidad de asignar tareas prioritarias.  En este caso, si hay varias tareas <i>preparadas</i> al mismo tiempo, el sistema operativo primero seleccionar√° la tarea con la prioridad m√°s alta.  Si <b>todas</b> las tareas preparadas tienen la misma prioridad, el sistema operativo las pondr√° en ejecuci√≥n en un c√≠rculo, en un orden llamado "carrusel" o round-robin. <br><br>  En AQUA RTOS, la prioridad se asigna a una tarea cuando se <i>inicializa a</i> trav√©s de una llamada al servicio <b>OS_InitTask</b> , que <b>recibe la</b> direcci√≥n de la tarea como primer argumento y un n√∫mero del 1 al 15 como segundo argumento. <i>Un n√∫mero m√°s bajo significa una prioridad m√°s alta</i> .  Durante el funcionamiento del sistema operativo, no se proporciona un cambio en la prioridad asignada a la tarea. <br><br><h3>  Retrasos </h3><br>  En cada tarea, el retraso se procesa independientemente de otras tareas. <br>  Por lo tanto, mientras el sistema operativo est√° resolviendo el retraso de una tarea, se pueden ejecutar otras. <br>  Para la organizaci√≥n de los servicios prestados retrasos <b>OS_Delay |</b>  <b>OS_DelayTask</b> .  El argumento es el n√∫mero de milisegundos para los que se <i>retrasa</i> la tarea.  Dado que la dimensi√≥n del argumento es <b>dword</b> , el retraso m√°ximo es de 4294967295 ms, o aproximadamente 120 horas, lo que parece ser suficiente para la mayor√≠a de las aplicaciones.  Despu√©s de llamar al servicio de demora, se llama autom√°ticamente al despachador, que transfiere el control a otras tareas mientras dura la demora. <br><br><h3>  Sem√°foros </h3><br>  Los sem√°foros en AQUA RTOS son algo as√≠ como banderas y variables disponibles para las tareas.  Son de dos tipos: binarios y contables.  Los primeros tienen solo dos estados: libre y cerrado.  El segundo es un contador de bytes (el servicio de contar sem√°foros en la versi√≥n actual de AQUA RTOS no est√° implementado (soy un vago), por lo que todo lo que se dice a continuaci√≥n se aplica solo a los sem√°foros binarios). <br><br>  La diferencia entre un sem√°foro y un indicador simple es que se puede hacer que la tarea <i>espere la liberaci√≥n del</i> sem√°foro especificado.  De alguna manera, el uso de sem√°foros realmente se asemeja a un ferrocarril: al llegar al sem√°foro, la composici√≥n (tarea) verificar√° el sem√°foro, y si no est√° abierto, esperar√° a que la se√±al de activaci√≥n parezca ir m√°s all√°.  En este momento, otros trenes (tareas) pueden continuar movi√©ndose (correr). <br><br>  En este caso, todo el trabajo negro se asigna al despachador.  Tan pronto como se le dice a la tarea que espere el sem√°foro, el control se transfiere autom√°ticamente al despachador, y √©l puede comenzar otras tareas, exactamente hasta que se libere el sem√°foro especificado.  Tan pronto como el estado del sem√°foro cambie a <i>libre</i> , el despachador asigna a todas las tareas que estaban esperando este sem√°foro el estado <i>listo</i> ( <b>OSTS_READY</b> ), y se ejecutar√°n en el orden de prioridad y prioridad. <br>  En total, AQUA RTOS proporciona 16 sem√°foros binarios (este n√∫mero puede, en principio, aumentarse cambiando la dimensi√≥n de la variable en la unidad de control de tareas, porque en su interior se implementan como banderas de bits). <br>  Los sem√°foros binarios funcionan a trav√©s de los siguientes servicios: <br><br><pre> <code class="vbscript hljs">hBSem OS_CreateBSemaphore() OS_WaitBSemaphore(hBSem) OS_WaitBSemaphoreTask(task_label, hBSem) OS_BusyBSemaphore(hBSem) OS_FreeBSemaphore(hBSem)</code> </pre> <br>  Antes de usar un sem√°foro debe ser <i>creado</i> .  Esto se realiza llamando al servicio <b>OS_CreateBSemaphore</b> , que devuelve el identificador de byte √∫nico (identificador) del sem√°foro <b>hBSem</b> creado, o mediante el controlador definido por el usuario genera un error <b>OSERR_BSEM_MAX_REACHED</b> , lo que indica que se ha alcanzado el n√∫mero m√°ximo posible de sem√°foros binarios. <br><br>  Puede trabajar con el identificador recibido pas√°ndolo como argumento a otros servicios de sem√°foros. <br><br>  Servicio <b>OS_WaitBSemaphore |</b>  <b>OS_WaitBSemaphoreTask</b> coloca la tarea (actual | especificada) en un estado para <i>esperar el lanzamiento del sem√°foro</i> <b>hBSem</b> si este sem√°foro est√° ocupado, y luego transfiere el control al despachador para que pueda iniciar otras tareas.  Si el sem√°foro es libre, la transferencia de control no se produce y la tarea simplemente contin√∫a. <br><br>  Los servicios <b>OS_BusyBSemaphore</b> y <b>OS_FreeBSemaphore</b> establecen el sem√°foro <b>hBSem</b> en <i>ocupado</i> o <i>libre,</i> respectivamente. <br><br>  No se proporciona la destrucci√≥n de sem√°foros para simplificar el sistema operativo y reducir la cantidad de c√≥digo.  Por lo tanto, todos los sem√°foros creados son est√°ticos. <br><br><h3>  Eventos </h3><br>  Adem√°s de los sem√°foros, las tareas pueden ser conducidas por eventos.  Se puede indicar a <i>una</i> tarea que <i>espere un evento determinado</i> , y otra tarea (as√≠ como el c√≥digo de fondo) puede <i>indicar</i> este evento.  Al mismo tiempo, todas las tareas que esperaban este evento recibir√°n el estado <i>listo para la ejecuci√≥n</i> ( <b>OSTS_READY</b> ) y ser√°n establecidas por el despachador para su ejecuci√≥n en el orden de prioridad y prioridad. <br><br>  ¬øA qu√© eventos puede responder la tarea?  Bueno, por ejemplo: <br><ul><li>  interrupci√≥n </li><li>  ocurrencia de un error; </li><li>  liberaci√≥n del recurso (a veces es m√°s conveniente usar un sem√°foro para esto); </li><li>  cambiar el estado de la l√≠nea de E / S o presionar una tecla en el teclado; </li><li>  recibir o enviar un personaje a trav√©s de RS-232; </li><li>  transferencia de informaci√≥n de una parte de la aplicaci√≥n a otra (ver tambi√©n mensajes). </li></ul><br>  El sistema de eventos se implementa a trav√©s de los siguientes servicios: <br><br><pre> <code class="vbscript hljs">hEvent OS_CreateEvent() OS_WaitEvent(hEvent) OS_WaitEventTask(task_label, hEvent) OS_WaitEventTO(hEvent, dwTimeout) OS_SignalEvent(hEvent)</code> </pre> <br>  Antes de usar un evento, debe <i>crearlo</i> .  Esto se realiza llamando a la funci√≥n <b>OS_CreateEvent</b> , que devuelve un identificador de byte √∫nico (identificador) para el evento <b>hEvent</b> , o arroja un error <b>OSERR_EVENT_MAX_REACHED a</b> trav√©s del controlador definido por el usuario, lo que indica que se ha alcanzado el l√≠mite en el n√∫mero de eventos que se pueden generar en el sistema operativo (m√°ximo 255 eventos diferentes). <br><br>  Para hacer que una tarea espere un evento <b>hEvent</b> , llame a <b>OS_WaitEvent</b> en su c√≥digo, pasando el identificador del evento como argumento.  Despu√©s de llamar a este servicio, el control se transferir√° autom√°ticamente al despachador. <br><br>  A diferencia del servicio de sem√°foro, el servicio de eventos ofrece una opci√≥n para esperar un evento con un <i>tiempo de espera</i> .  Para hacer esto, use el servicio <b>OS_WaitEventTO</b> .  El segundo argumento aqu√≠ puede especificar el n√∫mero de milisegundos que la tarea puede esperar del evento.  Si el tiempo especificado ha expirado, la tarea recibir√° el estado <i>listo para la ejecuci√≥n</i> como si hubiera ocurrido el evento, y el despachador lo configurar√° para continuar la ejecuci√≥n en el orden de prioridad y prioridad.  La tarea puede conocer el hecho de que no fue un evento, sino un tiempo de espera, marcando el <b>indicador</b> global <b>OS_TIMEOUT</b> . <br><br> <i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> tarea o el c√≥digo de fondo pueden </font><i><font style="vertical-align: inherit;">se√±alar</font></i><font style="vertical-align: inherit;"> la ocurrencia de un evento dado llamando al servicio </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">OS_SignalEvent</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , que </font><b><font style="vertical-align: inherit;">recibe el</font></b><font style="vertical-align: inherit;"> identificador </font><b><font style="vertical-align: inherit;">del</font></b><font style="vertical-align: inherit;"> evento como un argumento. </font><font style="vertical-align: inherit;">En este caso, todas las tareas que esperan este evento, el sistema operativo establecer√° el estado </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">listo para la ejecuci√≥n</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , de modo que puedan continuar ejecut√°ndose en orden de prioridad y prioridad.</font></font><br><br><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Mensajes </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">El sistema de mensajes funciona en general de manera similar al sistema de eventos, pero proporciona tareas con m√°s opciones y flexibilidad: proporciona no solo la expectativa de un mensaje sobre un tema espec√≠fico, sino la forma en que el mensaje se transmite de una tarea a otra: un n√∫mero o una cadena. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Esto se implementa a trav√©s de los siguientes servicios:</font></font><br><br><pre> <code class="vbscript hljs">hTopic OS_CreateMessage() OS_WaitMessage(hTopic) OS_WaitMessageTask(task_label, hTopic) OS_WaitMessageTO(hTopic, dwTimeout) OS_SendMessage(hTopic, wMessage) word_ptr OS_GetMessage(hTopic) word_ptr OS_PeekMessage(hTopic) <span class="hljs-built_in"><span class="hljs-built_in">string</span></span> OS_GetMessageString(hTopic) <span class="hljs-built_in"><span class="hljs-built_in">string</span></span> OS_PeekMessageString(hTopic)</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Para usar el servicio de mensajer√≠a, primero debe crear </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">un asunto de mensaje</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Esto se realiza a trav√©s del servicio </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">OS_CreateMessage</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , que devuelve el identificador de byte del tema </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">hTopic</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , o mediante el controlador definido por el usuario, arroja un error </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">OSERR_TOPIC_MAX_REACHED</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , lo que indica que se ha alcanzado el n√∫mero m√°ximo posible de temas de mensaje y ya no se puede crear. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Para indicarle a la tarea que espere un mensaje sobre el tema </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">hTopic</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , llame a </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">OS_WaitMessage</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> en su c√≥digo </font><font style="vertical-align: inherit;">, pasando el identificador del tema como argumento. Despu√©s de llamar a este servicio, el control se transferir√° autom√°ticamente al administrador de tareas. Por lo tanto, este servicio coloca la tarea actual en un estado</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Espere un </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mensaje hTopic</font></font></b></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">El servicio de espera con el tiempo de espera </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">OS_WaitMessageTO</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> funciona de manera similar al servicio </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">OS_WaitEventTO</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> del </font><font style="vertical-align: inherit;">sistema de </font><b><font style="vertical-align: inherit;">eventos</font></b><font style="vertical-align: inherit;"> . </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Para enviar mensajes, se </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">proporciona el</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> servicio </font><b><font style="vertical-align: inherit;">OS_SendMessage</font></b><font style="vertical-align: inherit;"> . El primer argumento es el identificador del tema al que se transmitir√° el mensaje, y el segundo es el argumento de dimensi√≥n de </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">palabra</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Esto puede ser un n√∫mero independiente o un </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">puntero a una cadena</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , que, a su vez, ya es un mensaje. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Para obtener un puntero de l√≠nea, simplemente use la funci√≥n varptr integrada en </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">BASCOM</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , por ejemplo, as√≠:</font></font><br><br><pre> <code class="vbscript hljs">strMessage = <span class="hljs-string"><span class="hljs-string">"Hello, world!"</span></span> OS_SendMessage hTopic, varptr (strMessage)</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Reanudar el trabajo despu√©s de llamar a </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">OS_WaitMessage</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , es decir, cuando se recibe el mensaje esperado, la tarea puede recibir el mensaje con su posterior destrucci√≥n autom√°tica o simplemente ver el mensaje; en este caso, no se destruir√°. Para hacer esto, use los √∫ltimos cuatro servicios de la lista. Los dos primeros devuelven varias </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">palabras</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> de dimensi√≥n </font><font style="vertical-align: inherit;">, que pueden ser un mensaje independiente o servir como puntero a la cadena que contiene el mensaje. En este caso, </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">OS_GetMessage</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> elimina autom√°ticamente el mensaje y </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">OS_PeekMessage lo</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> deja. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Si la tarea necesita inmediatamente una cadena, no un puntero, puede usar los servicios </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">OS_GetMessageString</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> o </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">OS_PeekMessageString</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , que funcionan de manera similar a las dos anteriores, pero devuelven una cadena, no un puntero. </font></font><br><br><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Servicio de temporizador interno </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Para trabajar con los retrasos y tiempos AQUA RTOS utiliza un temporizador de hardware integrado IC </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">TIMER0</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Por lo tanto, el c√≥digo externo (antecedentes y tareas) no debe usar este temporizador. </font><font style="vertical-align: inherit;">Pero generalmente esto no es necesario, porque </font><font style="vertical-align: inherit;">El sistema operativo proporciona tareas con todas las herramientas necesarias para trabajar con intervalos de tiempo. </font><font style="vertical-align: inherit;">La resoluci√≥n del temporizador es de 1 ms.</font></font><br><br><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Ejemplos de trabajo con AQUA RTOS </font></font></h2><br><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Configuraciones iniciales </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Al comienzo del c√≥digo de usuario, debe determinar si el c√≥digo se ejecutar√° en el simulador incorporado o en hardware real. </font><font style="vertical-align: inherit;">Defina la constante </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">OS_SIM = TRUE | </font><font style="vertical-align: inherit;">FALSO</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , que establece el modo de simulaci√≥n. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Adem√°s, en el c√≥digo del sistema operativo, edite la constante </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">OS_MAX_TASK</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , que determina el n√∫mero m√°ximo de tareas admitidas por el sistema operativo. </font><font style="vertical-align: inherit;">Cuanto menor es este n√∫mero, m√°s r√°pido funciona el sistema operativo (menos sobrecarga) y menos memoria consume. </font><font style="vertical-align: inherit;">Por lo tanto, no debe indicar m√°s tareas de las que necesita. </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">No olvide cambiar esta constante si el n√∫mero de tareas ha cambiado.</font></font></i> <br><br><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Inicializaci√≥n del sistema operativo </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Antes de comenzar, AQUA RTOS debe inicializarse. Para hacer esto, llame al servicio </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">OS_Init</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Este servicio configura la configuraci√≥n inicial del sistema operativo. M√°s importante a√∫n, tiene un argumento: la direcci√≥n de la rutina de manejo de errores definida por el usuario. Ella, a su vez, tambi√©n tiene un argumento: un c√≥digo de error. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Este controlador debe estar en el c√≥digo de usuario (al menos en forma de c√≥digo auxiliar): el sistema operativo le env√≠a c√≥digos de error y el usuario no tiene otra forma de atraparlos y procesarlos en consecuencia. Recomiendo encarecidamente que, al menos en la etapa de desarrollo, no ponga un c√≥digo auxiliar, sino que incluya cualquier salida de informaci√≥n de error en este procedimiento. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Entonces, el primer paso para trabajar con AQUA RTOS es agregar el c√≥digo de inicializaci√≥n del sistema operativo y el procedimiento de manejo de errores al programa del usuario:</font></font><br><br><pre> <code class="vbscript hljs">OS_Init my_err_trap <span class="hljs-comment"><span class="hljs-comment">'... '... '... sub my_err_trap(err_code as byte) print err_code end sub</span></span></code> </pre> <br><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Inicializaci√≥n de tareas </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> El segundo paso es inicializar las tareas especificando sus nombres y prioridad: </font></font><br><br><pre> <code class="vbscript hljs">OS_InitTask task_1, <span class="hljs-number"><span class="hljs-number">1</span></span> OS_InitTask task_2 , <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-comment"><span class="hljs-comment">'... OS_InitTask task_N , 1</span></span></code> </pre> <br><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Tareas de prueba </font></font></h2><br><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> LED intermitente </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Entonces, creemos una aplicaci√≥n de prueba que se pueda descargar a una placa Arduino Nano V3 est√°ndar. </font><font style="vertical-align: inherit;">Cree una carpeta en la carpeta con el archivo del sistema operativo (por ejemplo, prueba), y cree el siguiente archivo bas:</font></font><br><br><pre> <code class="vbscript hljs"><span class="hljs-comment"><span class="hljs-comment">'    config submode = old $include "..\aquaRTOS_1.05.bas" $regfile = "m328pdef.dat" $crystal = 16000000 $hwstack = 48 $swstack = 48 $framesize = 64 '   declare sub my_err_trap (byval err_code as byte) declare sub task_1() declare sub task_2() '       led_1 alias portd.4 led_2 alias portd.5 config portd.4 = output config portd.5 = output ' ***    *** '   OS_Init my_err_trap '   OS_InitTask task_1, 1 OS_InitTask task_2 , 1 '      ¬´¬ª (OSTS_STOP) '    ,     ' ¬´  ¬ª (OSTS_READY)   OS_ResumeTask OS_ResumeTask task_1 OS_ResumeTask task_2 '      OS_Sheduler end ' ***  *** sub task_1 () do toogle led_1 '   1 OS_delay 1000 '   1000  loop end sub sub task_2 () do toogle led_2 '   2 OS_delay 333 '   333  loop end sub ' **************************************************** '   sub my_err_trap(err_code as byte) print "OS Error: "; err_code end sub</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Conecte los √°nodos de los LED a los pines </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">D4</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> y </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">D5</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> de la placa Arduino (u otros pines cambiando las l√≠neas de definici√≥n correspondientes en el c√≥digo). Conecte los c√°todos a trav√©s de resistencias de terminaci√≥n de 100 ... 500 ohmios al bus </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GND</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Compila y sube el firmware a la placa. Los LED comenzar√°n a cambiar de forma asincr√≥nica con un per√≠odo de 2 y 0,66 s. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Miremos el c√≥digo. Entonces, primero inicializamos el equipo (establecemos las opciones del compilador, el modo de operaci√≥n del puerto y asignamos alias), luego el sistema operativo en s√≠ y finalmente las tareas.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dado que las tareas reci√©n creadas est√°n en estado "detenido", debe darles el estado "listo para la ejecuci√≥n" (quiz√°s no todas las tareas en una aplicaci√≥n real; despu√©s de todo, algunas de ellas, seg√∫n la intenci√≥n del desarrollador, pueden estar inicialmente en un estado detenido y ejecutarse en ejecuci√≥n solo desde otras tareas, y no inmediatamente al inicio del sistema; sin embargo, en este ejemplo, ambas tareas deber√≠an comenzar a funcionar inmediatamente). Por lo tanto, para cada tarea, llamamos al servicio </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">OS_ResumeTask</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ahora las tareas est√°n listas para su ejecuci√≥n, pero a√∫n no se han completado. ¬øQui√©n los lanzar√°? Por supuesto, el despachador! Para hacer esto, debemos llamarlo al primer inicio del sistema. Ahora, si todo est√° escrito correctamente, el despachador realizar√° nuestras tareas una por una, y podemos finalizar la parte principal del programa con la declaraci√≥n </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">final</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Veamos las tareas. Es inmediatamente evidente que cada uno de ellos est√° enmarcado como un </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">do-loop</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> sin fin </font><font style="vertical-align: inherit;">. La segunda propiedad importante, dentro de dicho ciclo, debe haber al menos una llamada al despachador o al servicio del sistema operativo que llama autom√°ticamente al despachador despu√©s de s√≠ mismo; de lo contrario, dicha tarea nunca ceder√° el control y otras tareas no podr√°n completarse. En nuestro caso, este es el </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">servicio de</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> demora </font><b><font style="vertical-align: inherit;">OS_Delay</font></b><font style="vertical-align: inherit;"> . Como argumento, le indicamos el n√∫mero de milisegundos para los cuales se debe pausar cada tarea. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Si establece la constante </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">OS_SIM = TRUE</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> al comienzo del c√≥digo </font><font style="vertical-align: inherit;">y ejecuta el c√≥digo no en el chip real, sino en el simulador, puede rastrear c√≥mo funciona el sistema operativo.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">El despachador al que llamamos ver√° si las tareas con el estado est√°n "listas para la ejecuci√≥n" y las alinear√° seg√∫n la prioridad. Si la prioridad es la misma, el despachador "rodar√° las tareas en el carrusel", moviendo la tarea reci√©n completada al final de la cola. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Despu√©s de seleccionar la tarea a ejecutar (por ejemplo, </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tarea_1</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ), el despachador reemplaza la direcci√≥n de retorno (inicialmente, se√±ala la instrucci√≥n </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">final</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> en el c√≥digo principal) con la direcci√≥n del punto de entrada de la tarea </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tarea_1</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , que el sistema reconoce durante la inicializaci√≥n de la tarea, y ejecuta el comando de </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">retorno</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , lo que obliga MK para extraer la direcci√≥n de retorno de la pila e ir a ella, es decir, iniciar la ejecuci√≥n de la tarea </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">task_1</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (operador</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">hacer</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> en la </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tarea_1</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> c√≥digo </font><font style="vertical-align: inherit;">). </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La tarea </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">task_1</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , al cambiar su LED, llama al servicio </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">OS_delay</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , que, una vez completadas las acciones necesarias, va al despachador. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">El despachador guarda la direcci√≥n que estaba en la pila en la </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">unidad de</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> control de tarea </font><b><font style="vertical-align: inherit;">task_1</font></b><font style="vertical-align: inherit;"> (se√±ala la instrucci√≥n que sigue a la llamada </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">OS_delay</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , es decir, la instrucci√≥n de </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">bucle</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ) y luego, "girando el carrusel", descubre que la </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tarea_2</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ahora debe completarse </font><font style="vertical-align: inherit;">. </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Empuja la direcci√≥n de</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> tarea </font><b><font style="vertical-align: inherit;">task_2</font></b><font style="vertical-align: inherit;"> (actualmente apunta a la instrucci√≥n </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">do</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> en el </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">c√≥digo de</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> tarea </font><b><font style="vertical-align: inherit;">task_2</font></b><font style="vertical-align: inherit;"> ) y ejecuta el comando</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">return</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , lo que hace que MK extraiga la direcci√≥n de retorno de la pila y vaya a ella, es decir, comience a ejecutar </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">task_2</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La tarea </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">task_2</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , cambiando su LED, llama al servicio </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">OS_delay</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , que, despu√©s de realizar las acciones necesarias, va al despachador. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">El despachador guarda la direcci√≥n que estaba en la pila en la </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">unidad de</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> control de tarea </font><b><font style="vertical-align: inherit;">task_1</font></b><font style="vertical-align: inherit;"> (se√±ala la instrucci√≥n que sigue a la llamada </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">OS_delay</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , es decir, la instrucci√≥n de </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">bucle</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ) y luego, "girando el carrusel", descubre que </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">task_2</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ahora debe completarse </font><font style="vertical-align: inherit;">. La diferencia con el estado inicial ser√° que ahora en el bloque de control de tareas </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">task_1</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">no se almacena la direcci√≥n de inicio de la tarea, sino la direcci√≥n del punto desde el cual ocurri√≥ la transici√≥n al despachador. </font><font style="vertical-align: inherit;">All√≠ (a la instrucci√≥n de </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">bucle</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> en el </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">c√≥digo de</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> tarea </font><b><font style="vertical-align: inherit;">task_1</font></b><font style="vertical-align: inherit;"> ), y se transferir√° el control. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La tarea </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tarea_1</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ejecutar√° la instrucci√≥n de </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">bucle</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , y luego todo el ciclo "Tarea 1 - Despachador - Tarea 2 - Despachador" se repetir√° sin cesar.</font></font><br><br><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Enviar mensajes </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Ahora intentemos enviar mensajes de una tarea a otra. </font></font><br><br><pre> <code class="vbscript hljs"><span class="hljs-comment"><span class="hljs-comment">'    config submode = old $include "..\aquaRTOS_1.05.bas" $regfile = "m328pdef.dat" $crystal = 16000000 $hwstack = 48 $swstack = 48 $framesize = 64 '   declare sub my_err_trap (byval err_code as byte) declare sub task_1() declare sub task_2() const OS_SIM = TURE '       '   dim hTopic as byte '     dim task_1_cnt as byte '    1 dim strMessage as string * 16 '  ' ***    *** OS_CreateMessage hTopic OS_Init my_err_trap OS_InitTask task_1 , 1 OS_InitTask task_2 , 1 OS_ResumeTask task_1 OS_ResumeTask task_2 OS_Sheduler end ' ***  *** sub task_1() do print "task 1" OS_Sheduler incr task_1_cnt '    1 if task_1_cnt &gt; 3 then print "task 1 is sending message to task 2" strMessage = "Hello, task 2!" '    2 OS_SendMessage hTopic , varptr(strMessage) task_1_cnt = 0 end if loop end sub sub task_2() do print "task 2 is waiting messages..." '      1 OS_WaitMessage hTopic print "message recieved: " ; OS_GetMessageString (hTopic) loop end sub ' **************************************************** '   sub my_err_trap(err_code as byte) print "OS Error: "; err_code end sub</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> El resultado de ejecutar el programa en el simulador ser√° el siguiente resultado en la ventana de terminal: </font></font><br><br><blockquote> task 1 <br> task 2 is waiting messages‚Ä¶ <br> task 1 <br> task 1 <br> task 1 <br> task 1 is sending message to task 2 <br> task 1 <br> message recieved: Hello, task 2! <br> task 2 is waiting messages‚Ä¶ <br> task 1 <br> task 1 <br>  ... <br></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Preste atenci√≥n al orden en que se produce el cambio de trabajo y tarea. Tan pronto como la Tarea 1 imprime la </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tarea 1</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , el control se transfiere al despachador para que pueda comenzar la segunda tarea. La tarea 2 imprime la </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tarea 2 est√° esperando mensajes ...</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , luego llama al servicio de mensajes en espera sobre el tema </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">hTopic</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , y el control se transfiere autom√°ticamente al despachador, que nuevamente llama a la </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tarea</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 1. Imprime la </font><b><font style="vertical-align: inherit;">tarea 1</font></b><font style="vertical-align: inherit;"> nuevamente </font><font style="vertical-align: inherit;">y le da el control al despachador. Sin embargo, dado que el despachador detecta que la Tarea 2 ahora est√° esperando mensajes, devuelve el control a la Tarea 1 en la declaraci√≥n </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">incr</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> despu√©s de la llamada del despachador. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cuando el contador </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">task_1_cnt</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">en la Tarea 1, exceder√° el valor especificado, la tarea env√≠a un mensaje, pero contin√∫a ejecut√°ndose: ejecuta la instrucci√≥n de </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">bucle</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> e imprime la </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tarea 1</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> nuevamente </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Despu√©s de eso, llama al despachador, que ahora descubre que hay un mensaje para la Tarea 2, y le transfiere el control. </font><font style="vertical-align: inherit;">A continuaci√≥n, el proceso se realiza c√≠clicamente.</font></font><br><br><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Manejo de eventos </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> El siguiente c√≥digo sondea dos botones y cambia los LED cuando presiona el bot√≥n correspondiente: </font></font><br><br><pre> <code class="vbscript hljs"><span class="hljs-comment"><span class="hljs-comment">'    config submode = old $include "..\aquaRTOS_1.05.bas" $regfile = "m328pdef.dat" $crystal = 16000000 $hwstack = 48 $swstack = 48 $framesize = 64 '   declare sub my_err_trap (byval err_code as byte) declare sub task_scankeys() declare sub task_led_1() declare sub task_led_2() '        led_1 alias portd.4 led_2 alias portd.5 config portd.4 = output config portd.5 = output button_1 alias pind.6 button_2 alias pind.7 config portd.6 = input config portd.7 = input '   dim eventButton_1 as byte dim eventButton_2 as byte ' ***    *** eventButton_1 = OS_CreateEvent '       eventButton_2 = OS_CreateEvent OS_Init my_err_trap OS_InitTask task_scankeys , 1 OS_InitTask task_led_1 , 1 OS_InitTask task_led_2 , 1 OS_ResumeTask task_scankeys OS_ResumeTask task_led_1 OS_ResumeTask task_led_2 OS_Sheduler end ' ***  *** sub task_scankeys() do debounce button_1 , 0 , btn_1_click , sub debounce button_2 , 0 , btn_2_click , sub OS_Sheduler loop btn_1_click: OS_SignalEvent eventButton_1 return btn_2_click: OS_SignalEvent eventButton_2 return end sub sub task_led_1() do OS_WaitEvent eventButton_1 toggle led_1 loop end sub sub task_led_2() do OS_WaitEvent eventButton_2 toggle led_2 loop end sub ' **************************************************** '   sub my_err_trap(err_code as byte) print "OS Error: "; err_code end sub</span></span></code> </pre> <br><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Un ejemplo de aplicaci√≥n real bajo AQUA RTOS </font></font></h2><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tratemos de imaginar c√≥mo se ver√≠a un programa de m√°quinas expendedoras de caf√©. </font><font style="vertical-align: inherit;">La m√°quina debe indicar la presencia de opciones de caf√© y la elecci√≥n de LED en los botones; </font><font style="vertical-align: inherit;">reciba se√±ales del receptor de monedas, prepare la bebida ordenada, emita el cambio. </font><font style="vertical-align: inherit;">Adem√°s, la m√°quina debe controlar el equipo interno: por ejemplo, mantener la temperatura del calentador de agua a 95 ... 97 ¬∞ C; </font><font style="vertical-align: inherit;">transmite datos sobre el mal funcionamiento del equipo y el stock de ingredientes y recibe comandos a trav√©s de acceso remoto (por ejemplo, a trav√©s de un m√≥dem GSM), as√≠ como se√±al de vandalismo.</font></font><br><br><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Enfoque dirigido por eventos </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Al principio, puede ser dif√≠cil para un desarrollador cambiar del esquema habitual de "superciclo + banderas + interrupciones" a un enfoque basado en tareas y eventos. </font><font style="vertical-align: inherit;">Esto requiere resaltar las tareas b√°sicas que debe realizar el dispositivo. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tratemos de describir tales tareas para nuestra m√°quina:</font></font><br><br><ul><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">control y gesti√≥n de calentadores - </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ControlHeater ()</font></font></b> </li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">indicaci√≥n de disponibilidad y elecci√≥n de bebidas - </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ShowGoods ()</font></font></b> </li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">aceptaci√≥n de monedas / billetes y su suma - </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">AcceptMoney ()</font></font></b> </li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">botones de sondeo - </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ScanKeys ()</font></font></b> </li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">cambiar entrega - </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MakeChange ()</font></font></b> </li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">beber licencia - </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ReleaseCoffee ()</font></font></b> </li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Protecci√≥n contra vandalismo - </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Alarma ()</font></font></b> </li></ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Calculemos el grado de importancia de las tareas y la frecuencia de su llamada. </font></font><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ControlHeater () es</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> obviamente importante porque siempre necesitamos agua hirviendo para hacer caf√©. Pero no debe realizarse con demasiada frecuencia, porque el calentador tiene una alta inercia y el agua se enfr√≠a lentamente. Es suficiente verificar la temperatura una vez por minuto. </font></font><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dar</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> prioridad a esta tarea 5. </font><b><font style="vertical-align: inherit;">ShowGoods ()</font></b><font style="vertical-align: inherit;"> no </font><b><font style="vertical-align: inherit;">es</font></b><font style="vertical-align: inherit;"> demasiado importante. La oferta puede cambiar solo despu√©s de la liberaci√≥n de los productos, si se agota el suministro de cualquier ingrediente. Por lo tanto, le daremos a esta tarea una prioridad de 8 y dejaremos que se ejecute cuando la m√°quina se inicie y cada vez que se liberen los productos. </font></font><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ScanKeys ()</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">debe tener una prioridad lo suficientemente alta para que la m√°quina responda r√°pidamente a las pulsaciones de botones. Otorgue a esta tarea la prioridad 3, y la ejecutaremos cada 40 milisegundos. </font></font><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">AcceptMoney ()</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> tambi√©n </font><b><font style="vertical-align: inherit;">es</font></b><font style="vertical-align: inherit;"> parte de la interfaz de usuario. Le daremos la misma prioridad que </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ScanKeys (),</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> y lo ejecutaremos cada 20 milisegundos. </font></font><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MakeChange ()</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> se ejecuta solo despu√©s de que se liberan los productos. Lo </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">asociaremos</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> con </font><b><font style="vertical-align: inherit;">ReleaseCoffee ()</font></b><font style="vertical-align: inherit;"> y le daremos prioridad 10. </font></font><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ReleaseCoffee ()</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> solo </font><b><font style="vertical-align: inherit;">es</font></b><font style="vertical-align: inherit;"> necesario cuando se ha aceptado la cantidad adecuada de dinero y se presiona el bot√≥n de selecci√≥n de bebida. Para una respuesta r√°pida, le damos prioridad 2. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dado que la resistencia al vandalismo es una funci√≥n bastante importante de la m√°quina, la tarea de </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">alarma ()</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">puede establecer la prioridad m√°s alta: 1 y activar una vez por segundo para verificar los sensores de inclinaci√≥n o manipulaci√≥n. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Por lo tanto, necesitaremos siete tareas con diferentes prioridades. </font><font style="vertical-align: inherit;">Despu√©s del inicio, cuando el programa lee la configuraci√≥n de EEPROM e inicializa el equipo, es hora de inicializar el sistema operativo y comenzar las tareas.</font></font><br><br><pre> <code class="vbscript hljs"><span class="hljs-comment"><span class="hljs-comment">'    declare sub ControlHeater() declare sub ShowGoods() declare sub AcceptMoney() declare sub ScanKeys() declare sub MakeChange () declare sub ReleaseCoffee() declare sub Alarm()</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Para trabajar como parte de RTOS, cada tarea debe tener una estructura determinada: debe tener al menos una llamada al despachador (o un servicio del sistema operativo que transfiere autom√°ticamente el control al despachador): esta es la √∫nica forma de garantizar la multitarea cooperativa. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Por ejemplo, </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ReleaseCoffee ()</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> podr√≠a verse as√≠:</font></font><br><br><pre> <code class="vbscript hljs"><span class="hljs-keyword"><span class="hljs-keyword">sub</span></span> ReleaseCoffee() <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> OS_WaitMessage bCoffeeSelection wItem = OS_GetMessage(bCoffeeSelection) Release wItem <span class="hljs-keyword"><span class="hljs-keyword">loop</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">sub</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La tarea </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ReleaseCoffee</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> en un bucle infinito espera un mensaje sobre el tema </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">bCoffeeSelection</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> y no hace nada hasta que llega (el control se devuelve autom√°ticamente al despachador para que pueda iniciar otras tareas). Tan pronto como se env√≠a el mensaje, </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ReleaseCoffee ()</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> est√° listo para la ejecuci√≥n, y cuando esto sucede, la tarea recibe el contenido del mensaje (c√≥digo de la bebida seleccionada) </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">wItem</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> utilizando el servicio </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">OS_GetMessage</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> y libera los productos al cliente. Dado que </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ReleaseCoffee ()</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> usa el subsistema de mensajes, se debe crear un mensaje antes de comenzar la multitarea:</font></font><br><br><pre> <code class="vbscript hljs"><span class="hljs-keyword"><span class="hljs-keyword">dim</span></span> bCoffeeSelection as byte bCoffeeSelection = OS_CreateMessage()</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Como se mencion√≥ anteriormente, </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ShowGoods ()</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> debe ejecutarse una vez al inicio y cada vez que se liberan productos. </font><font style="vertical-align: inherit;">Para asociarlo con el procedimiento de lanzamiento </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ReleaseCoffee ()</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , utilizamos el servicio de eventos. </font><font style="vertical-align: inherit;">Para hacer esto, cree un evento antes de comenzar la multitarea:</font></font><br><br><pre> <code class="vbscript hljs"><span class="hljs-keyword"><span class="hljs-keyword">dim</span></span> bGoodsReliased as byte bGoodsReliased = OS_CreateEvent()</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Y en el procedimiento </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ReleaseCoffee ()</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font><font style="vertical-align: inherit;">despu√©s de la l√≠nea </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Release wItem</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> agregamos una alarma sobre el evento </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">bGoodsReliased</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br><br><pre> <code class="vbscript hljs">OS_SignalEvent bGoodsReliased</code> </pre> <br><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Inicializaci√≥n del sistema operativo </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Para preparar el sistema operativo para el trabajo, debemos inicializarlo, indicando la direcci√≥n del controlador de errores, que se encuentra en el c√≥digo del usuario. </font><font style="vertical-align: inherit;">Hacemos esto usando el servicio </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">OS_Init</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br><br><pre> <code class="vbscript hljs">OS_Init Mailfuncion</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> En el c√≥digo de usuario, debe agregar un controlador, un procedimiento cuyo argumento de byte es el c√≥digo de error: </font></font><br><br><pre> <code class="vbscript hljs"><span class="hljs-keyword"><span class="hljs-keyword">sub</span></span> Mailfuncion (bCoffeeErr) print <span class="hljs-string"><span class="hljs-string">"Mailfunction! Error #: "</span></span>; bCoffeeErr <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> isErrCritical (bCoffeeErr) = <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> CallService(bCoffeeErr) <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">sub</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Este procedimiento imprime un c√≥digo de error (o puede mostrarlo de alguna otra manera: en la pantalla, a trav√©s de un m√≥dem GSM, etc.), y en caso de que el error sea cr√≠tico, llama al departamento de servicio. </font></font><br><br><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Lanzamiento de tarea </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ya recordamos que eventos, sem√°foros, etc. </font><font style="vertical-align: inherit;">debe inicializarse antes de ser utilizado. </font><font style="vertical-align: inherit;">Adem√°s, las tareas mismas deben inicializarse con el servicio </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">OS_InitTask antes de comenzar</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br><br><pre> <code class="vbscript hljs">OS_InitTask ControlHeater , <span class="hljs-number"><span class="hljs-number">5</span></span> OS_InitTask ShowGoods , <span class="hljs-number"><span class="hljs-number">8</span></span> OS_InitTask AcceptMoney , <span class="hljs-number"><span class="hljs-number">3</span></span> OS_InitTask ScanKeys , <span class="hljs-number"><span class="hljs-number">3</span></span> OS_InitTask MakeChange, <span class="hljs-number"><span class="hljs-number">10</span></span> OS_InitTask ReleaseCoffee , <span class="hljs-number"><span class="hljs-number">2</span></span> OS_InitTask Alarm , <span class="hljs-number"><span class="hljs-number">1</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Como el modo multitarea a√∫n no ha comenzado, el orden en que comienzan las tareas es insignificante y, en cualquier caso, no depende de sus prioridades. </font><font style="vertical-align: inherit;">En este punto, todas las tareas todav√≠a est√°n en estado detenido. </font><font style="vertical-align: inherit;">Para prepararlos para la ejecuci√≥n, debemos usar el servicio </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">OS_ResumeTask para</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> establecer el estado "listo para la ejecuci√≥n":</font></font><br><br><pre> <code class="vbscript hljs">OS_ResumeTask ControlHeater OS_ResumeTask ShowGoods OS_ResumeTask AcceptMoney OS_ResumeTask ScanKeys OS_ResumeTask MakeChange OS_ResumeTask ReleaseCoffee OS_ResumeTask Alarm</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Como ya se mencion√≥, no todas las tareas deben comenzar necesariamente cuando se inicia la multitarea; </font><font style="vertical-align: inherit;">algunos de ellos pueden en cualquier momento permanecer en un estado "detenido" y recibir disponibilidad solo bajo ciertas condiciones. </font><font style="vertical-align: inherit;">El servicio </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">OS_ResumeTask</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> se puede llamar en cualquier momento desde cualquier parte del c√≥digo (fondo o tarea) cuando la multitarea ya se est√° ejecutando. </font><font style="vertical-align: inherit;">Lo principal es que la tarea a la que se refiere est√° preinicializada.</font></font><br><br><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Inicio multitarea </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ahora todo est√° listo para comenzar la multitarea. </font><font style="vertical-align: inherit;">Hacemos esto llamando al despachador:</font></font><br><br><pre> <code class="vbscript hljs">OS_Sheduler</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Despu√©s de eso, podemos poner </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">fin</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> con seguridad en el c√≥digo del programa </font><font style="vertical-align: inherit;">: el sistema operativo ahora se encarga de la ejecuci√≥n posterior del c√≥digo. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Veamos todo el c√≥digo:</font></font><br><br><pre> <code class="vbscript hljs"><span class="hljs-comment"><span class="hljs-comment">'    config submode = old $include "..\aquaRTOS_1.05.bas" $include "coffee_hardware.bas" '      '       Coffee_ $regfile = "m328pdef.dat" ' Arduino Nano v3 $crystal = 16000000 $hwstack = 48 $swstack = 48 $framesize = 64 Coffee_InitHardware '    '   declare sub Mailfuncion (byval bCoffeeErr as byte) '   declare sub ControlHeater () '   declare sub ShowGoods () '    declare sub AcceptMoney () '   declare sub ScanKeys () '   declare sub MakeChange () '      declare sub ReleaseCoffee () '   declare sub Alarm () '    '     Coffee_InitHardware () '   dim wMoney as long '    dim wGoods as long '   ' ***    *** '   OS_Init Mailfuncion '       dim bCoffeeSelection as byte bCoffeeSelection = OS_CreateMessage() '     dim bGoodsReliased as byte bGoodsReliased = OS_CreateEvent() '   OS_InitTask ControlHeater , 5 OS_InitTask ShowGoods , 8 OS_InitTask AcceptMoney , 3 OS_InitTask ScanKeys , 3 OS_InitTask MakeChange, 10 OS_InitTask ReleaseCoffee , 2 OS_InitTask Alarm , 1 '     OS_ResumeTask ControlHeater OS_ResumeTask ShowGoods OS_ResumeTask AcceptMoney OS_ResumeTask ScanKeys OS_ResumeTask MakeChange OS_ResumeTask ReleaseCoffee OS_ResumeTask Alarm '   OS_Sheduler end ' ***   *** ' ----------------------------------- sub ControlHeater() do select case GetWaterTemp() case is &gt; 97 Coffee_HeaterOff '   case is &lt; 95 Coffee_HeaterOn '   case is &lt; 5 CallServce (WARNING_WATER_FROZEN) '   end select OS_Delay 60000 '  1  loop end sub ' ----------------------------------- sub ShowGoods() do LEDS = Coffee_GetDrinkSupplies() '    D, '         '   LEDS OS_WaitEvent bGoodsReliased '   " " loop end sub ' ----------------------------------- sub AcceptMoney() do wMoney = wMoney + ReadMoneyAcceptor() OS_Delay 20 loop end sub ' ----------------------------------- sub ScanKeys() do wGoods = ButtonPressed() if wMoney &gt;= GostOf(wGoods) then OS_SendMessage bCoffeeSelection, wGoods '     bCoffeeSelection,  '     end if OS_Delay 40 loop end sub ' ----------------------------------- sub MakeChange() do OS_WaitEvent bGoodsReliased '   " " Refund wMoney loop end sub ' ----------------------------------- sub ReleaseCoffee() do OS_WaitMessage bCoffeeSelection '  bCoffeeSelection wItem = OS_GetMessage(bCoffeeSelection) '   Release wItem '    wMoney = wMoney ‚Äì CostOf (wItem) '     OS_SignalEvent bGoodsReliased '     '  ,       : ' MakeChange  ShowGoods '  ,  ,     loop end sub ' ----------------------------------- sub Alarm() do OS_Delay 1000 if Hijack() = 1 then CallPolice() end if loop end sub ' ----------------------------------- ' ***    *** sub Mailfuncion (bCoffeeErr) print "Mailfunction! Error #: "; bCoffeeErr if isErrCritical (bCoffeeErr) = 1 then CallService() end if end sub</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Por supuesto, un enfoque ser√≠a m√°s correcto, no con el sondeo peri√≥dico de botones y un sensor de efectivo, sino con el uso de interrupciones. </font><font style="vertical-align: inherit;">En los manejadores de estas interrupciones, podr√≠amos usar el env√≠o de mensajes usando el servicio </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">OS_SendMessage ()</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> con contenido igual al n√∫mero de la tecla presionada o el valor de la moneda / billete ingresado. </font><font style="vertical-align: inherit;">Invito al lector a modificar el programa por su cuenta. </font><font style="vertical-align: inherit;">Gracias al enfoque orientado a tareas y al servicio proporcionado por el sistema operativo, esto requerir√° cambios m√≠nimos de c√≥digo.</font></font><br><br><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> C√≥digo fuente AQUA RTOS </font></font></h2><br> <a href=""><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">El c√≥digo fuente de la versi√≥n 1.05 est√° disponible para descargar aqu√≠</font></font></b></a> <br><br><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Postdata </font></font></h2><br> <i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">P: ¬øPor qu√© AQUA?</font></font></i> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> R: Bueno, hice el controlador del acuario, es como una "casa inteligente", no solo para las personas, sino tambi√©n para los peces. Lleno de todo tipo de sensores, un reloj en tiempo real, rel√©s y salidas de potencia anal√≥gicas, un men√∫ en pantalla, un "programa de eventos" flexible e incluso un m√≥dulo WiFi. Los intervalos deben contarse, los botones deben sondearse, los sensores deben procesarse, el programa del evento debe leerse y ejecutarse desde la EEPROM, la pantalla debe actualizarse y el Wi-Fi debe responder. Adem√°s, el controlador debe ir a un men√∫ de varios niveles para la configuraci√≥n y la programaci√≥n. Hacer en banderas e interrupciones es solo obtener el mismo "c√≥digo de pasta", que no se entiende ni se modifica. Por lo tanto, decid√≠ que necesitaba un sistema operativo. Aqu√≠ ella es AQUA. </font></font><br><br> <i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">P: ¬øSeguramente el c√≥digo est√° lleno de errores l√≥gicos y problemas t√©cnicos?</font></font></i> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A: seguramente. </font><font style="vertical-align: inherit;">Yo, como pude, ide√© una variedad de pruebas y manej√© el sistema operativo en una variedad de tareas, e incluso bloque√© un n√∫mero notable de errores, pero esto no significa que todo est√© completo. </font><font style="vertical-align: inherit;">Estoy m√°s que seguro de que todav√≠a hay muchos de ellos en las calles secundarias del c√≥digo. </font><font style="vertical-align: inherit;">Por lo tanto, estar√© muy agradecido si, en lugar de pincharme con los errores en la cara, los se√±alas educadamente y con tacto, y mejor me dices c√≥mo crees que es mejor solucionarlos. </font><font style="vertical-align: inherit;">Tambi√©n ser√° genial si el proyecto se desarrolla m√°s como producto de la creatividad colectiva. </font><font style="vertical-align: inherit;">Por ejemplo, alguien agregar√° un servicio para contar sem√°foros (¬øno lo olvid√≥? Soy un holgaz√°n) y ofrecer√° otras mejoras. </font><font style="vertical-align: inherit;">En cualquier caso, estar√© muy agradecido por la contribuci√≥n constructiva.</font></font></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/453708/">https://habr.com/ru/post/453708/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../453694/index.html">Con√©ctese a Windows a trav√©s de SSH como en Linux</a></li>
<li><a href="../453696/index.html">Enlace angular de dos v√≠as, un poco m√°s de comprensi√≥n</a></li>
<li><a href="../453698/index.html">Informaci√≥n cu√°ntica en la conciencia cu√°ntica</a></li>
<li><a href="../453700/index.html">Lecciones sobre SDL 2: Lecci√≥n 1 - Hola, SDL 2</a></li>
<li><a href="../453706/index.html">C√≥mo pas√© el examen de certificaci√≥n de ingeniero de datos de Google Cloud Professional</a></li>
<li><a href="../453710/index.html">Pr√°ctica de desarrollo en grandes proyectos: mitp SberPractice iOS # 1</a></li>
<li><a href="../453712/index.html">C√≥mo eBay hizo un esc√°ner de c√≥digo de barras en WebAssembly</a></li>
<li><a href="../453714/index.html">Cliente de prueba TON (Telegram Open Network) y el nuevo lenguaje Fift para contratos inteligentes</a></li>
<li><a href="../453716/index.html">Coworking en el campo para personal de TI familiar: ¬øhay alguien?</a></li>
<li><a href="../453720/index.html">Sutilezas de las expresiones lambda en C #</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>