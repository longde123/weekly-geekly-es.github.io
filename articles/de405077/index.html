<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👨🏿‍🚀 📆 🎑 Budget Temperaturüberwachung: Arduino + Zabbix 🤛 👨🏾‍🏫 🔶</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Unsere Organisation hat einen Zabbix-Server bereitgestellt, um den Zustand von Servern und Workstations zu überwachen. Aufgrund der Besonderheiten des...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Budget Temperaturüberwachung: Arduino + Zabbix</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/405077/">  Unsere Organisation hat einen Zabbix-Server bereitgestellt, um den Zustand von Servern und Workstations zu überwachen.  Aufgrund der Besonderheiten des technischen Prozesses werden die Geräte in mehreren Räumen „verteilt“ und im gesamten Unternehmen verteilt.  Natürlich möchte ich zusammen mit den Hauptparametern von Computern (arbeiten / nicht funktionieren) das Mikroklima in den Servern steuern.  Gleichzeitig sind die Möglichkeiten wie üblich sehr begrenzt, und das „Ausschalten“ erheblicher Mittel für komplexe Temperaturüberwachungssysteme (ich schließe auch Steuerplatinen mit Temperatursensoren für Rack-APC-USVs ein) ist eine separate Aufgabe. <br><br>  Auf dem Hauptserver ist alles einfach: Eine solche Karte ist installiert (sie wurde vor langer Zeit vom Vorgänger zusammen mit der Hauptausrüstung gekauft), ein APC-Sensor ist installiert, ein Agent ist in Zabbix installiert, alles funktioniert über SNMP.  Langweilig :) Es gibt keine Überwachung der Remote-Hardware, bedeutet auch - siehe oben.  Aus diesem Grund wurde beschlossen, intelligent zu sein, das Budget zu sparen und gleichzeitig neue Fähigkeiten zu entwickeln, indem eine einfache und kostengünstige „knietiefe“ Lösung entwickelt wurde, die dennoch in die vorhandene Überwachungsinfrastruktur von Zabbix passt. <br><a name="habracut"></a><br>  Notwendige Komponenten: <br><br><ul><li>  Systembasis - <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Arduino Nano V3</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">LAN-Modul</a> (Ethernet-Shield) </li><li>  Und tatsächlich ein digitaler <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Temperatursensor</a> basierend auf DS18B20 </li></ul><br>  Die Gesamtkosten der Komponenten betragen 10 USD bei Lieferung. <br><br>  Die Montage des Gerätes ist nicht schwierig.  Das Netzwerkmodul wird mit einem „Sandwich“ auf die Hauptplatine gelegt, der Temperatursensor wird an seine Stifte gelötet.  Sensoranschluss: rot +5 V, schwarz - Masse, gelb - Daten;  Löten Sie zwischen + 5V und Daten einen 4,7-kΩ-Pull-up-Widerstand. <br><br>  Der Daten-Pin wird unter Berücksichtigung der vom Netzwerkmodul verwendeten Pins ausgewählt (D10-SS; D11-MOSI; D12-MISO; D13-SCK; D2-IRQ). <br><br>  <i>Rechen: Im Prototyp des Geräts bin ich auf einen Konflikt gestoßen - Temperaturdaten wurden zufällig ausgegeben, "zwei bis drei".</i>  <i>Der Grund war, dass ich den Temperatursensor an Pin 2 angeschlossen habe, der, wie ich später im Internet fand, vom Netzwerkmodul verwendet wird, um einen Interrupt zu generieren, wenn ein Paket ankommt.</i>  <i>Am 4. neu arrangiert - es funktionierte wie eine Uhr.</i> <br><br>  Wechseln Sie nach dem Zusammenbau der Hardware zur Software. <br><br>  Das Gerät arbeitet im Netzwerk und gibt vor, ein Zabbix-Agent zu sein. Dazu benötigt es einen MAC und eine IP-Adresse.  Wir entscheiden, wie es bequemer ist - schwer zu nähen während der Programmierung, generieren einen <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">MAC aus der Adresse des Temperatursensors</a> und empfangen IP über DHCP usw.  Ich habe den einfachsten Weg genommen und beide Parameter fest codiert. <br><br>  Das Kommunikationsprotokoll mit dem zabbix-Server ist in der <a href="">Dokumentation beschrieben</a> .  Unser Gerät reagiert auf zwei Befehle - <i>agent.ping</i> und <i>env.temp</i> (es gibt Raum für weitere Kreativität, Sie können jedes der für Arduino verfügbaren Erweiterungsmodule binden - zumindest einen Feuchtigkeitssensor, mindestens eine Beleuchtung - was auch immer Ihr Herz begehrt).  Es wird auf alle anderen Befehle mit einer Standardantwort <s>schwören</s> , die für den zabbix-Server verständlich ist. <br><br>  Für diejenigen, die von vorne anfangen (wie ich) - Die Arduino-Programmierung erfolgt mit der <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Arduino-IDE</a> , deren Installation und Konfiguration elementar ist.  Für die Komponenten sind die UIPEthernet- und OneWire-Bibliotheken erforderlich, die über das Menü Skizze - Bibliothek verbinden - Bibliotheken verwalten ... installiert und mit dem Projekt verbunden werden. <br>  <i>Wenn Sie andere Komponenten haben (zum Beispiel befindet sich das Netzwerkmodul nicht auf enc28j60, sondern auf einem anderen Chip), benötigen Sie andere Bibliotheken!</i> <br><br>  Der Code für die Arbeit mit dem Netzwerkmodul und dem Temperatursensor ist typisch für das Internet, mit einigen Annahmen und Vereinfachungen. <br><br>  Nachdem wir den Code in die Steuerung eingegeben und das Ethernet-Kabel angeschlossen haben, überprüfen wir von der Konsole aus: <br><br><pre><code class="hljs powershell"><span class="hljs-variable"><span class="hljs-variable">$</span></span> zabbix_get <span class="hljs-literal"><span class="hljs-literal">-s</span></span> <span class="hljs-number"><span class="hljs-number">192.168</span></span>.<span class="hljs-number"><span class="hljs-number">4.5</span></span> <span class="hljs-literal"><span class="hljs-literal">-k</span></span> agent.ping <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-variable"><span class="hljs-variable">$</span></span> zabbix_get <span class="hljs-literal"><span class="hljs-literal">-s</span></span> <span class="hljs-number"><span class="hljs-number">192.168</span></span>.<span class="hljs-number"><span class="hljs-number">4.5</span></span> <span class="hljs-literal"><span class="hljs-literal">-k</span></span> env.temp <span class="hljs-number"><span class="hljs-number">23.12</span></span> <span class="hljs-variable"><span class="hljs-variable">$</span></span> zabbix_get <span class="hljs-literal"><span class="hljs-literal">-s</span></span> <span class="hljs-number"><span class="hljs-number">192.168</span></span>.<span class="hljs-number"><span class="hljs-number">4.5</span></span> <span class="hljs-literal"><span class="hljs-literal">-k</span></span> bla<span class="hljs-literal"><span class="hljs-literal">-blah</span></span> ZBX_NOTSUPPORTED</code> </pre> <br>  <i>Rake: Die kompilierte Version von zabbix_get für Windows auf zabbix.com ist veraltet und verwendet ein anderes Protokoll (mit dem Header ZBXD \ x01 in der Serveranforderung).</i>  <i>Die Linux-Version ist aktuell und das Protokoll entspricht dem angegebenen Code.</i> <br><br>  Alles funktioniert wie vorgesehen.  Erstellen Sie im zabbix-Administrationsbereich einen neuen Host mit der ausgewählten IP-Adresse und zwei Schlüsseln, Numeric (unsigned) agent.ping und Numeric (float) env.temp.  Charts, Trigger - alles ist wie gewohnt. <br><br>  Das Gerät wird über seinen nativen USB-Anschluss mit Strom versorgt.  Gehäuse - optional: geeignete Kunststoffbox, Schrumpfschlauch, blaues Isolierband. <br><br>  Die Auflösung des Sensors beträgt ungefähr 0,06 (genauer gesagt 1/16) ° C, Genauigkeit - beim Eintauchen in schmelzenden Schnee zeigte er 0,19 ° C (vielleicht wäre er noch tiefer gefallen, aber es gab wenig Schnee und er schmolz schnell).  Ich denke für ein Gerät im Wert von 10 Dollar und die beschriebenen Zwecke - mehr als genug. <br><br><div class="spoiler">  <b class="spoiler_title">Skizze</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;OneWire.h&gt; #include &lt;UIPEthernet.h&gt; byte mac[] = { 0xDE, 0x05, 0xB6, 0x27, 0x39, 0x19 }; // random MAC byte ip[] = { 192, 168, 4, 5 }; // IP address in local network String readString = String(20); byte addr[8]; OneWire ds(4); // DS18B20 at pin 4 EthernetServer server(10050); // Zabbix port void setup() { Ethernet.begin(mac, ip); server.begin(); ds.search(addr); } void loop() { byte data[2]; float celsius; readString = ""; if (EthernetClient client = server.available()) { while (client.connected()) { if (client.available()) { char c = client.read(); if (c == '\n') // end of query from zabbix server { client.print("ZBXD\x01"); // response header if (readString == "agent.ping") { byte responseBytes [] = {0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, '1'}; client.write(responseBytes, 9); } else if (readString == "env.temp") { ds.reset(); ds.select(addr); ds.write(0x44); // start conversion with regular (non-parasite!) power delay(1000); ds.reset(); ds.select(addr); ds.write(0xBE); // read Scratchpad data[0] = ds.read(); data[1] = ds.read(); int16_t raw = (data[1] &lt;&lt; 8) | data[0]; celsius = (float)raw / 16.0; byte responseBytes [] = {(byte) String(celsius).length(), 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}; client.write(responseBytes, 8); client.print(celsius); } else { byte responseBytes [] = {0x10, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00}; client.write(responseBytes, 8); client.print("ZBX_NOTSUPPORTED"); } break; } else if (readString.length() &lt; 20) { readString = readString + c; } } } delay(10); client.stop(); } }</span></span></span></span></code> </pre> </div></div></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de405077/">https://habr.com/ru/post/de405077/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de405065/index.html">Der Spielautomat innen und außen. Übersicht vom Hersteller</a></li>
<li><a href="../de405069/index.html">Menschen Computer</a></li>
<li><a href="../de405071/index.html">Die US Air Force wählt SpaceX für den fünften Flug des X-37B-Raumfahrzeugs</a></li>
<li><a href="../de405073/index.html">Rechenzentrum für die Weltmeisterschaft</a></li>
<li><a href="../de405075/index.html">Senden und Empfangen von SMS-Nachrichten über OpenVox VoIP-Gateways</a></li>
<li><a href="../de405079/index.html">Kalifornien bezahlt Nachbarstaaten dafür, überschüssigen Strom aus Solarkraftwerken aufzunehmen</a></li>
<li><a href="../de405081/index.html">[FALL] Wie wir eine Kopie des Worker and Collective Farm Girl für das Museum des Europäischen Parlaments angefertigt haben</a></li>
<li><a href="../de405083/index.html">CCTV-Kameras in der Praxis hacken</a></li>
<li><a href="../de405085/index.html">Videoüberprüfung auf der Clevermic UNO PTZ-Kamera</a></li>
<li><a href="../de405087/index.html">So schließen Sie die Videoüberwachung mithilfe der 2G / 3G / 4G-Signalverstärkung an</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>