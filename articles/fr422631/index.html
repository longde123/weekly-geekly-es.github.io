<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🌯 📟 👩🏻‍🚒 Terminaux QIWI. Comment tirer le meilleur parti des technologies simples 🤷🏻 👼🏿 🏻</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Début 2017, nous, l'équipe de développement logiciel de QIWI Terminals, avons recueilli les souhaits des départements de l'entreprise - nous avons app...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Terminaux QIWI. Comment tirer le meilleur parti des technologies simples</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/qiwi/blog/422631/"><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><img src="https://habrastorage.org/webt/e5/yt/wg/e5ytwgymlworvy2udox4piky1pw.png" align="left" width="200"></a>  Début 2017, nous, l'équipe de développement logiciel de QIWI Terminals, avons recueilli les souhaits des départements de l'entreprise - nous avons appris quelles tâches globales nos collègues aimeraient résoudre avec notre aide, afin que la vie devienne plus facile. <br><br>  J'ai été très satisfait de la demande du service client qui travaille avec les appels et les réclamations des payeurs: <br><br>  <i>«Il y a un problème: le client effectue un paiement au terminal, mais il ne parvient toujours pas au traitement - soit le terminal pourrait se bloquer, soit Internet fonctionnant via le modem gsm est tombé.</i>  <i>Et il s'avère que le client a un chèque, mais il n'y a pas de paiement dans le système.</i>  <i>Ce serait bien dans de tels cas d'apprendre à effectuer des paiements à QIWI.</i> <i><br><br></i>  <i>Il y a aussi un groupe de clients inquiets qui, immédiatement après avoir effectué un paiement, composent un numéro de centre d'appels pour s'assurer que tout va bien avec lui.</i>  <i>Ce serait formidable de couper les os pour de tels appels. »</i> <br><br>  Nous avions donc une tâche complexe: apprendre à créer un paiement en cas d'échec de communication avec le terminal et réduire le nombre d'appels entrants des clients en inventant un outil en libre service pour vérifier l'état du paiement.  L'affaire est claire.  Ils ont commencé à chercher une solution qui soit pratique pour le client et sans risques pour la sécurité. <br><a name="habracut"></a><br>  Le client, selon la tradition, a offert son option - d'imprimer sur le reçu une séquence de caractères que le payeur pourrait dire à l'opérateur, et lui, à son tour, pour comprendre s'il s'agit de notre paiement ou non, filtrer la fraude ou effectuer l'opération manuellement. <br><br>  Le concept de l'idée était clair, mais irréalisable, nous sommes donc allés un peu plus loin: nous avons décidé d'incorporer les données de paiement dans le code QR, de les imprimer sur le reçu et de dupliquer le terminal QIWI à l'écran pour plus de précision.  En scannant le code QR avec la caméra de son appareil, le client peut connaître l'état de l'opération.  Et en cas de non-paiement dans QIWI, le système le crée automatiquement.  Ainsi, le client découvre non seulement si l'argent est arrivé, mais le conduit également de manière indépendante, quel que soit l'état du terminal. <br><br>  À première vue, la solution était évidente: prendre une demande existante avec paiement, l'envelopper dans un code QR, écrire une page Web avec des informations sur les transactions et un microservice mandatant les demandes entre le terminal, le traitement et le Web.  Il a été supposé que le projet fonctionnera sur les méthodes existantes d'authentification des terminaux et utilisera les méthodes de paiement existantes dans le traitement. <br><br>  L'idée est venue tout de suite, révélant le potentiel créatif de l'équipe.  Nous avons commencé à jaillir et à lancer des options supplémentaires jusqu'à placer un logo, un slogan et même de la publicité dans un code QR en plus des données de paiement: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/5p/vy/dl/5pvydljqfmwsttqvkleyotnskfw.png" width="400" height="400" alt="image"></div><br>  Un projet pour quelques sprints, pas plus.  Ça y était. <br><br><h3>  Première frustration </h3><br>  Nous avons pris un paiement existant et y avons formé un code QR: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/yv/ti/pk/yvtipk6l6qkycshzycbfz8eyfu8.gif" alt="image" width="400" height="400"></div><br>  En conséquence, même le dernier iPhone7 à l'époque ne pouvait pas le lire.  Sur le chèque, le code QR, composé uniquement de données de paiement et de signature, tient à peine sur la moitié de la feuille A4.  La ligne de demande de paiement était trop longue.  Ce fut la première tristesse. <br><br>  Il fallait résoudre deux problèmes principaux: <br><br><ul><li>  réduire le nombre de caractères dans une demande de paiement, c'est-à-dire  trouver une solution dans laquelle nous pouvons passer de la requête xml existante à une requête plus compacte; </li><li>  choisissez un algorithme de chiffrement et une longueur de clé qui fourniront une force et une fiabilité cryptographiques élevées avec une taille de signature plus petite. </li></ul><br>  Le critère pour évaluer le nombre optimal de caractères pour le code QR était un - il devrait être lu par les caméras de la plupart des téléphones mobiles. <br><br>  En quelques réunions de travail, une solution a néanmoins été trouvée: <br><br><ul><li>  au lieu de la requête xml, nous avons décidé d'utiliser une requête get avec des paramètres de paiement et des séparateurs entre eux; </li><li>  construit une signature sur les courbes elliptiques pour raccourcir la longueur. </li></ul><br>  L'avantage d'utiliser la get-request était que les caméras des téléphones portables ou des programmes spéciaux, en voyant le lien dans le code QR, l'ouvraient immédiatement dans le navigateur, ce qui permettait d'effectuer un paiement en une seule action.  Pour réduire la taille de la requête get, nous avons dû remplacer le nom du paramètre par des délimiteurs. <br><br>  À la suite de l'ensemble des actions, la demande de paiement a été réduite d'environ 1 100 à 200 caractères.  De plus, j'ai dû appliquer le niveau de correction d'erreur le plus bas du code QR - L. <br><br>  Pour la mise en œuvre, il a été nécessaire de développer des composants dans le système: <br><br><ul><li>  créer une nouvelle api pour effectuer des paiements via un code QR; </li><li>  introduire un nouveau mécanisme pour travailler avec des clés cryptographiques entre le terminal et le traitement; </li><li>  mettre en œuvre un microservice sur lequel la fonctionnalité de proxy des demandes, la vérification de l'intégrité des données reçues, ainsi que la fonction de blocage des demandes suspectes et de collecte des statistiques d'opération seront suspendues; </li><li>  développer une page Web pour afficher les informations de paiement; </li><li>  Développer un système de limites et de contrôles pour un nouveau canal de paiement. </li></ul><br>  Au plan de travail existant: <br><br><img src="https://habrastorage.org/webt/vh/wi/bf/vhwibfzt6s4hebqumpum7anrkv4.png" alt="image"><br><br>  Nous avions prévu d'ajouter une alternative: <br><br><img src="https://habrastorage.org/webt/ze/75/au/ze75auougt6hzcrhryahnftqyca.png" alt="image"><br><br>  Au cours du projet, il semblerait, petit, mais nécessitant de résoudre des problèmes, ce qui en fait a pris beaucoup de temps, reportant la date de lancement. <br><br><h3>  UX-recherche, ou le travail est venu d'où ils n'ont pas attendu </h3><br>  Je voulais tout faire comme les gens, alors ils ont fait appel à des spécialistes UX pour mettre en œuvre le projet afin de résoudre les problèmes: <br><br><ul><li>  dans quelle partie de l'écran du terminal QIWI pour placer le code QR et comment expliquer son utilité au client? </li><li>  où placer le code QR sur le chèque et comment insérer des explications similaires? </li><li>  Comment faire une mise en page d'une page web avec le statut de paiement, pour qu'elle soit claire sur les guides de l'entreprise? </li></ul><br>  De toute évidence, pour la partie avancée des clients, des explications supplémentaires sur le code QR ne sont pas nécessaires, il suffit d'indiquer le résultat.  Mais nous voulions couvrir cette partie des clients pour lesquels le QR code est une abréviation magique ou simplement un «carré noir».  Ce sont eux qui, en fait, rompent la ligne du centre d'appels. <br><br>  Pour le rendre beau et compréhensible, une interview a été réalisée au sein du focus group qui nous intéresse avec des résultats inattendus ... <br><br><h3>  La brièveté est comparable à l'épargne </h3><br>  Cela s'est avéré effrayant - le public dont nous avions besoin ne comprenait pas toujours le sens du mot «Scan» et ses dérivés.  Par conséquent, le libellé original «Scannez et découvrez le statut» a dû être abandonné.  La solution était la capacité technique d'envoyer une photo du code QR par e-mail.  Et il était également nécessaire de le dire brièvement et clairement, car le ruban de contrôle est le matériel consommable des propriétaires de terminaux et notre préoccupation pour les affaires de ces personnes est son économie.  Par conséquent, le chèque ressemble maintenant à ceci: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/1o/dr/yz/1odryzcvlubmpip1uvcd61tuuwi.png" alt="image" width="400" height="400"></div><br>  Quant à l'affichage du code QR sur l'écran du terminal, il a été placé sur la dernière page du paiement - le dernier du scénario de paiement.  Il est affiché au moment de l'impression du chèque et est essentiellement un duplicata électronique du code QR imprimé. <br><br><h3>  L'email est omniprésent </h3><br>  Dans le cadre de l'émergence d'un nouveau canal de traitement des QR codes sous forme d'e-mail, il est devenu nécessaire de développer une mécanique ayant pour fonction de reconnaître les QR codes intégrés dans des lettres et de générer une réponse avec le statut de paiement. <br><br>  La fonction de reconnaissance des codes QR a été supprimée dans le microservice.  Lors de la mise en œuvre initiale, le taux de reconnaissance était d'environ 65% dans l'échantillon de photographies présenté.  Nous avons essayé de jouer avec la décoloration et l'augmentation du contraste - cela a donné environ + 20% de reconnaissance réussie. <br><br>  La cerise sur le gâteau dans la tâche de reconnaissance des photos du code QR a été l'introduction de «l'intelligence naturelle» pour les cas difficiles et mal reconnus - la création des applications et leur traitement ont commencé à se faire en mode manuel: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/49/se/5g/49se5gbmtwhcusd4xolxybtfon8.png" alt="image" width="400" height="400"></div><br><h3>  La technique n'est pas des bagatelles </h3><br>  Les principaux développements de ce projet ont bien sûr concerné le microservice lui-même et le logiciel du terminal. <br><br>  QIWI évolue activement vers une architecture de microservices afin de ne pas toucher le moteur massif.  Le microservice vous permet d'apporter rapidement des modifications aux projets, d'effectuer des tests et de publier les versions.  Par conséquent, dans quelques mois, nous avons écrit le nôtre.  Nous y avons accroché tous les nouveaux développements majeurs qui ne pouvaient être réalisés: <br><br><ul><li>  procuration des requêtes en analysant et en analysant les requêtes get entrantes, en les convertissant en xml pour le traitement, </li><li>  fonctionnalité pour limiter les demandes entrantes des terminaux, </li><li>  Fonctionnalité de reconnaissance de code QR, </li><li>  collecte de statistiques pour une analyse plus approfondie. </li></ul><br>  En plus de la mise en œuvre d'un nouveau mécanisme pour travailler avec des clés cryptographiques, les améliorations des terminaux ont touché l'application d'une nouvelle technologie pour l'impression des reçus. <br><br>  La fonctionnalité de leur formation a été retirée du noyau principal du programme dans le plugin.  Nous pouvions désormais apporter rapidement des modifications à la vérification, sans toucher à l'opérabilité du terminal dans son ensemble.  L'impression d'un code QR, qui, à première vue, semble assez simple et se résume à l'impression d'une photo sur un chèque, n'est pas vraiment telle. <br><br>  En effet, le réseau de nos propriétaires de terminaux compte environ 20 modèles d'une grande variété d'imprimantes et nous imprimons environ 40 types de reçus.  Lorsqu'ils ont commencé l'implémentation, de nombreuses nuances sont apparues: soit les lignes et l'emplacement des objets dans le modèle de vérification ont commencé à flotter lorsque l'image a été ajoutée, puis certaines commandes se sont révélées sensibles à l'emplacement, puis le saut de ligne s'est transformé en onglet. <br><br>  Nous avons commencé les tests, nous avons réalisé la nécessité d'un compromis - certains modèles d'imprimantes ont dû être exclus, car lors du test de toutes les configurations, un très grand nombre de cas sont sortis. <br><br>  Pour les tests, nous avons décidé de choisir 6 modèles principaux, qui couvraient 91% du réseau d'agents.  Et, bien sûr, au moment d'effectuer des tests aléatoires dans un environnement de combat, il s'est avéré que c'était sur des imprimantes anciennes qui couvraient environ 5% du réseau d'agents que des problèmes d'impression de reçus ont été découverts.  Les modèles étaient si vieux que même sur le marché, ils ne pouvaient plus être achetés.  J'ai dû chercher avec des partenaires.  Désormais, le projet couvre 96% du réseau.  Déjà un peu plus près de l'idéal :) <br><br><h3>  Pas un seul chèque </h3><br>  Parallèlement au placement des informations sur le code QR sur le chèque et la dernière page du paiement, une autre tâche a été évoquée - amener cette page à un aspect universel pour tous les projets de terminaux: <br><br>  <i>«En termes de pages d'achèvement de paiement dans les terminaux QIWI, tout était assez archaïque: publicité, bannières et envoi de reçus électroniques.</i>  <i>À partir de cinq pages, les gars en ont créé une, universelle pour tous les paiements. »</i>  - Programmeur leader de l'équipe. <br><br>  Maintenant, cette page universelle est utilisée dans différentes interprétations, sans enfreindre la règle de construction d'un script, fermant ainsi la dette karmique de l'équipe de développement. <br><br>  Ainsi, le problème d'il y a dix ans a été résolu, auquel les mains n'atteignaient pas à chaque fois.  Il y avait plusieurs tâches de longue haleine. <br><br><h3>  "Où est l'argent, Zin?"  ou ce qui est en fin de compte </h3><br>  Le projet, conçu pour quelques sprints, a duré six mois, affectant les ressources de 10 salariés et la périphérie de l'agence d'externalisation. <br><br>  En conséquence, après avoir mis en œuvre le projet sur 85% du réseau de terminaux, nous nous sommes surpris ainsi que le client - le service client.  Le troisième jour du code QR, les collègues pensaient qu'une erreur système s'était glissée dans eux - des statistiques sur le nombre d'appels au centre d'appels avec la question "Où est mon paiement?"  déjà baissé de 20%.  Les clients ont commencé à scanner le code QR et à envoyer des reçus photo par e-mail, en découvrant le statut et en effectuant leur propre paiement.  Et donc pour le deuxième mois.  Je dois dire que les clients ont commencé à comprendre ce qu'est le «carré noir» et à quoi il sert. <br><br>  Le projet avec un code QR a été apprécié par tous ceux qui en ont été informés - c'était une synergie d'intérêts: d'une part, ils ont simplifié la vie du client, et d'autre part, ils ont résolu un problème technique non standard.  Vérifier l'état d'un paiement et le réaliser dans un morceau de papier en traitant simplement un code QR pour QIWI est quelque chose de nouveau.  C'était formidable de prendre des technologies connues et simples à partir desquelles faire un projet utile.  En général, le projet a non seulement stimulé les compétences, mais également amélioré la communication au sein de l'équipe elle-même.  Et c'est presque le principal avantage du karma. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr422631/">https://habr.com/ru/post/fr422631/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr422617/index.html">Toute la vérité sur RTOS. Article # 8. Nucleus SE: conception interne et déploiement</a></li>
<li><a href="../fr422623/index.html">Comment sécuriser C</a></li>
<li><a href="../fr422625/index.html">Nous avons parlé avec Troy Miles - le programmeur de "Neuromancer"</a></li>
<li><a href="../fr422627/index.html">Recherche sur le marché du travail MongoDB et IT</a></li>
<li><a href="../fr422629/index.html">Arrêtez de nourrir les bûcherons! Donnez plus de modificateurs! Champs finaux statiques paresseux. Projet d'esquisse d'objet</a></li>
<li><a href="../fr422633/index.html">Comment nous avons automatisé la surveillance du travail des employés du réseau fédéral de stations-service</a></li>
<li><a href="../fr422635/index.html">Vous n’avez pas encore dit le mot «bonjour», et nous savons déjà qui vous êtes</a></li>
<li><a href="../fr422637/index.html">Cadeau de geek: Protection Auto-Alkash</a></li>
<li><a href="../fr422641/index.html">Nuit polaire, pompage d'eau et coffre-fort intelligent: 5 projets étudiants dans le domaine de l'IoT</a></li>
<li><a href="../fr422643/index.html">Nouveaux appareils avec IFA 2018</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>