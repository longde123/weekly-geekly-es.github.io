<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>   Askozia C贸mo funciona Autoprovisioning Plug & Play Е 锔 ぞ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Al desarrollar Askozia PBX, nos enfrentamos a la tarea de configurar autom谩ticamente los tel茅fonos y resolverlos a nuestra manera. 

 Autoprovisioning...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Askozia C贸mo funciona Autoprovisioning Plug & Play</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/471522/">  Al desarrollar Askozia PBX, nos enfrentamos a la tarea de configurar autom谩ticamente los tel茅fonos y resolverlos a nuestra manera. <br><br>  <b>Autoprovisioning Plug &amp; Play</b> (PnP), esta tecnolog铆a es compatible con muchos fabricantes: Yealink, Snom, Fanvil. <br><br>  Las principales ventajas de la configuraci贸n autom谩tica del tel茅fono: <br><br><ul><li>  <b>Facilita la configuraci贸n inicial</b> : no es necesario ir a la interfaz web de cada dispositivo.  Es suficiente para indicar la correspondencia de la direcci贸n MAC del dispositivo y la cuenta en el servidor de autoajuste. </li><li>  <b>Simplifica el soporte</b> : realmente es m谩s f谩cil si necesita cambiar la configuraci贸n del dispositivo.  Controlamos la configuraci贸n nuevamente en el servidor </li><li>  <b>Es posible reducir la configuraci贸n al conjunto de c贸digos de estrella</b> "* 911 * &lt;SIP_ACC&gt;"; en algunos casos, esta funci贸n simplemente no est谩 disponible.  No todos los trabajadores de oficina podr谩n configurar un tel茅fono IP, pero marcar una combinaci贸n de n煤meros es una tarea simple. </li></ul><br>  Describamos c贸mo funciona Autoprovisioning Plug &amp; Play.  <b>Al final del art铆culo, un enlace al c贸digo fuente de un</b> peque帽o script PHP que implementa la funcionalidad del servidor PnP. <br><a name="habracut"></a><br><h3>  Estudio de caso </h3><br>  Tuvimos un caso interesante cuando presentamos la telefon铆a a uno de nuestros clientes.  El principal problema era que el cliente estaba en otra ciudad.  Al mismo tiempo, uno de los requisitos era que despu茅s de desempacar el paquete con los tel茅fonos y enchufarlos a la red, la telefon铆a deber铆a funcionar de inmediato. <br><br>  El problema se resolvi贸 de manera relativamente simple.  El cliente ha reservado una serie de direcciones IP para nosotros.  Instalamos el equipo en nuestra oficina y lo empacamos en una caja y lo enviamos por mensajer铆a. <br><br>  Usando la configuraci贸n autom谩tica del dispositivo, la tarea se volver铆a mucho m谩s simple. <br><br><h3>  Esquema PnP simplificado </h3><br>  El tel茅fono al comienzo del trabajo env铆a una solicitud de <b>suscripci贸n</b> <b>SIP</b> <b>SUSCRIBIR</b> a la direcci贸n <b>224.0.1.75</b> IP de multidifusi贸n. <br><div class="spoiler">  <b class="spoiler_title">Leer m谩s sobre 224.0.1.75</b> <div class="spoiler_text">  224.0.1.75: se trata de IP de multidifusi贸n (para multidifusi贸n) "reservada" para servidores SIP. <br>  ver <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">networksorcery.com/Enp/protocol/sip.htm</a> <br>  224.0.1.75 SIP, Protocolo de inicio de sesi贸n (todos los servidores). <br></div></div><br>  En respuesta, espera recibir una respuesta de <b>NOTIFICACIN</b> con instrucciones de configuraci贸n. <br><br><img src="https://habrastorage.org/webt/co/v1/ml/cov1mlrt6u8vq2eb_vfdk9eny9g.jpeg" alt="imagen"><br><br><div class="spoiler">  <b class="spoiler_title">SUSCRIBIRSE Ejemplo</b> <div class="spoiler_text"><pre><code class="plaintext hljs">2019/09/02 09:26:41.543856 172.16.32.148:5059 -&gt; 224.0.1.75:5060 SUBSCRIBE sip:MAC0015657322ff@224.0.1.75 SIP/2.0 Via: SIP/2.0/UDP 172.16.32.148:5059;branch=z9hG4bK42032775 From: &lt;sip:MAC0015657322ff@224.0.1.75&gt;;tag=42032772 To: &lt;sip:MAC0015657322ff@224.0.1.75&gt; Call-ID: 42032772@172.16.32.148 CSeq: 1 SUBSCRIBE Contact: &lt;sip:MAC0015657322ff@172.16.32.148:5059&gt; Max-Forwards: 70 User-Agent: Yealink SIP-T21P 34.72.14.6 Expires: 0 Event: ua-profile;profile-type="device";vendor="Yealink";model="T21D";version="34.72.14.6" Accept: application/url Content-Length: 0</code> </pre> <br></div></div><br><h4>  Los titulares m谩s importantes e interesantes. </h4><br><ul><li>  <b>De</b> : la direcci贸n de amapola del dispositivo es <b>0015657322ff</b> </li><li>  <b>Evento</b> : describe exhaustivamente el dispositivo, el fabricante, el modelo y la versi贸n de firmware </li><li>  <b>Contacto</b> - direcci贸n del dispositivo </li><li>  <b>Call-ID</b> : este encabezado es interesante al configurar dispositivos DECT desde Yealink, transfiere el identificador de l铆nea (n煤mero de serie del tubo), delimitador " <b>_</b> " </li></ul><br>  Una vez que el servidor PnP ha recibido dicha solicitud, debe responder <br><br><div class="spoiler">  <b class="spoiler_title">NOTIFY ejemplo</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">2019/09/02 09:26:41.550125 172.16.32.153:57593 -&gt; 172.16.32.148:5059 NOTIFY sip:172.16.32.148:5059 SIP/2.0 Via: SIP/2.0/UDP 172.16.32.148:5059;branch=z9hG4bK42032775 Max-Forwards: 20 Contact: &lt;sip:172.16.32.148:5059;transport=UDP;handler=dum&gt; From: &lt;sip:MAC0015657322ff@224.0.1.75&gt;;tag=42032772 To: &lt;sip:MAC0015657322ff@224.0.1.75&gt; Call-ID: 42032772@172.16.32.148 CSeq: 3 NOTIFY Content-Type: application/url Subscription-State: terminated;reason=timeout Event: ua-profile;profile-type="device";vendor="MIKO";model="MikoServerPnP";version="1.8" Content-Length: 40 http://172.16.32.153:84/0015657322ff.cfg</code> </pre> <br></div></div><br>  En un mensaje de NOTIFICACIN, la informaci贸n m谩s valiosa se encuentra en el cuerpo del mensaje.  Como regla general, en el cuerpo debe pasar un enlace para obtener el archivo de configuraci贸n: <br><br><pre> <code class="plaintext hljs">http://172.16.32.153:84/0015657322ff.cfg</code> </pre> <br>  Si varios servidores PnP se ejecutan en la red, entonces qui茅n es el primero que responder谩 al dispositivo lo configurar谩. <br><br>  El tel茅fono, al recibir NOTIFY, intenta cumplir con la solicitud en la direcci贸n especificada. <br><br><div class="spoiler">  <b class="spoiler_title">Ejemplo de solicitud y respuesta del servidor</b> <div class="spoiler_text"><pre> <code class="plaintext hljs"># curl -i http://172.16.32.153:84/0015657322ff.cfg HTTP/1.0 200 OK Content-type: text/plain Date: Mon, 02 Sep 2019 06:52:23 GMT Connection: close Accept-Ranges: bytes Last-Modified: Mon, 02 Sep 2019 06:25:02 GMT Content-length: 769 #!version:1.0.0.1 account.1.enable = 1 account.1.label = PnP (203) ...</code> </pre> <br></div></div><br>  Un ejemplo de implementaci贸n del servidor est谩 disponible en github <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">https://github.com/boffart/MikoServerPnP</a> <br><br>  Para que este servidor PnP funcione, debe: <br><br><ul><li>  PHP 7.1.9 </li><li>  Tomas de php </li><li>  BusyBox v1.26.2 </li><li>  Las solicitudes de difusi贸n deben estar permitidas en la red </li></ul><br><h3>  Caracter铆sticas del servidor PnP </h3><br><ul><li>  Escucha las solicitudes enviadas a la direcci贸n ' <b>224.0.1.75:5060</b> ' </li><li>  Cuando se inicia, se inicia el servidor web ( <b>busybox httpd</b> ) </li><li>  Le permite crear una configuraci贸n de tel茅fono simplificada </li><li>  Le permite enviar a Yealink NOTIFICAR para reiniciar </li></ul><br><h3>  El uso de un servidor PnP le permite usar "Enlaces 煤nicos". </h3><br>  Supongamos que le damos el archivo por el enlace: <br><br><pre> <code class="plaintext hljs">http://172.16.32.153:84/0015657322ff.cfg</code> </pre> <br>  El enlace directo habitual al archivo.  Obviamente, esto NO es seguro.  Conociendo la direcci贸n MAC del tel茅fono y la direcci贸n del servidor, puede intentar obtener una configuraci贸n con inicios de sesi贸n y contrase帽as. <br><br>  Cuando se trabaja con un servidor PnP, es posible proporcionar un enlace 煤nico para cada solicitud de SUSCRIPCIN: <br><br><pre> <code class="plaintext hljs">http://172.16.32.153:84/?mac=0015657322ff&amp;hash=0a67f5290</code> </pre> <br>  Un ejemplo de una f贸rmula para calcular un hash: <br><br><pre> <code class="plaintext hljs">hash = md5(MAC + DATE + PID)</code> </pre> <br>  <b>PID</b> es el ID de proceso del servidor PnP.  Solo la <b>ra铆z</b> puede reconocerlo. <br>  Elegir tal <b>hash es</b> pr谩cticamente imposible. <br><br>  Si se produce una apelaci贸n a trav茅s de un enlace no v谩lido, entonces prohibimos la plaga. <br><br><h3>  Reiniciar Yealink NOTIFICAR significa sin autorizaci贸n </h3><br>  Si, si, <b>sin autorizaci贸n</b> . <br>  No pude cerrar el dispositivo desde la versi贸n actual del firmware desde esta posibilidad. <br><br>  Solo ejecuta el comando <br><br><pre> <code class="plaintext hljs">php -f MikoServerPnP.php socket_client_notify &lt;IP_PBX&gt; &lt;PORT_SIP_PBX&gt; &lt;IP_PHONE&gt; &lt;PORT_PHONE&gt;</code> </pre> <br>  Y el tel茅fono se reiniciar谩.  Al colgar dicho comando en cron puede lograr un efecto aterrador.  Por supuesto, esto es posible si conocemos la direcci贸n IP y el puerto SIP del tel茅fono. <br><br><div class="spoiler">  <b class="spoiler_title">Un ejemplo de funci贸n PHP para enviar NOTIFICAR</b> <div class="spoiler_text"><pre> <code class="php hljs"> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">socket_client_notify</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($ip_pbx, $port_pbx, $ip_phone, $port_phone)</span></span></span><span class="hljs-function">:</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">void</span></span></span><span class="hljs-function"> </span></span>{ $phone_user = <span class="hljs-string"><span class="hljs-string">'autoprovision_user'</span></span>; $sock = socket_create(AF_INET, SOCK_DGRAM, SOL_UDP); $msg = <span class="hljs-string"><span class="hljs-string">"NOTIFY sip:{$phone_user}@{$ip_phone}:{$port_phone};ob SIP/2.0\r\n"</span></span>. <span class="hljs-string"><span class="hljs-string">"Via: SIP/2.0/UDP {$ip_pbx}:{$port_pbx};branch=z9hG4bK12fd4e5c;rport\r\n"</span></span>. <span class="hljs-string"><span class="hljs-string">"Max-Forwards: 70\r\n"</span></span>. <span class="hljs-string"><span class="hljs-string">"From: \"asterisk\" &lt;sip:asterisk@{$ip_pbx}&gt;;tag=as54cd2be9\r\n"</span></span>. <span class="hljs-string"><span class="hljs-string">"To: &lt;sip:{$phone_user}@{$ip_phone}:{$port_phone};ob&gt;\r\n"</span></span>. <span class="hljs-string"><span class="hljs-string">"Contact: &lt;sip:asterisk@{$ip_pbx}:{$port_pbx}&gt;\r\n"</span></span>. <span class="hljs-string"><span class="hljs-string">"Call-ID: 4afab6ce2bff0be11a4af41064340242@{$ip_pbx}:{$port_pbx}\r\n"</span></span>. <span class="hljs-string"><span class="hljs-string">"CSeq: 102 NOTIFY\r\n"</span></span>. <span class="hljs-string"><span class="hljs-string">"User-Agent: mikopbx\r\n"</span></span>. <span class="hljs-string"><span class="hljs-string">"Allow: INVITE, ACK, CANCEL, OPTIONS, BYE, REFER, SUBSCRIBE, NOTIFY, INFO, PUBLISH, MESSAGE\r\n"</span></span>. <span class="hljs-string"><span class="hljs-string">"Supported: replaces, timer\r\n"</span></span>. <span class="hljs-string"><span class="hljs-string">"Subscription-State: terminated\r\n"</span></span>. <span class="hljs-string"><span class="hljs-string">"Event: check-sync;reboot=true\r\n"</span></span>. <span class="hljs-string"><span class="hljs-string">"Content-Length: 0\r\n\n"</span></span>; $len = strlen($msg); socket_sendto($sock, $msg, $len, <span class="hljs-number"><span class="hljs-number">0</span></span>, $ip_phone, $port_phone); socket_close($sock); }</code> </pre> <br></div></div><br><h3>  Configuraci贸n del servidor PnP </h3><br>  Ubicado en <b>settings / settings.json</b> <br><br><pre> <code class="json hljs">{ <span class="hljs-attr"><span class="hljs-attr">"url"</span></span>: <span class="hljs-string"><span class="hljs-string">"http://&lt;pbx_host&gt;:&lt;http_port&gt;/"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"http_port"</span></span>: <span class="hljs-number"><span class="hljs-number">84</span></span>, <span class="hljs-attr"><span class="hljs-attr">"pbx_host"</span></span>: <span class="hljs-string"><span class="hljs-string">"172.16.32.153"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"pbx_sip_port"</span></span>: <span class="hljs-string"><span class="hljs-string">"5060"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"vm_extension"</span></span>: <span class="hljs-string"><span class="hljs-string">"*001"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"feature_transfer"</span></span>: <span class="hljs-string"><span class="hljs-string">"**"</span></span> }</code> </pre> <br><h4>  Lista blanca de MAC </h4><br>  Se puede describir en <b>settings / mac_white.conf</b> .  Separador - avance de l铆nea. <br><br><h4>  Lista negra de MAC </h4><br>  Se puede describir en <b>settings / mac_black.conf</b> .  Separador - avance de l铆nea. <br><br><h4>  Archivos de configuraci贸n del tel茅fono </h4><br>  Debe colocarse en el directorio <b>configs</b> . <br>  Usando el servidor PnP, puede crear las configuraciones m谩s simples para Yeakink y Snom: <br><br><pre> <code class="plaintext hljs">php -f MikoServerPnP.php mk_config SIP_ACCAUNT SECRET MAC</code> </pre> <br><h3>  Materiales utiles </h3><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Askozia es un producto gratuito.</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Fuentes en Github</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Wiki por Snom</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Sitio de soporte de Yealink</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Repositorio MikoServerPnP en Github</a> </li></ul></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/471522/">https://habr.com/ru/post/471522/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../471512/index.html">28 de octubre, Ekaterimburgo - Comunicaci贸n de calidad</a></li>
<li><a href="../471514/index.html">El t铆tulo "Leer art铆culos para usted". Enero - junio 2019</a></li>
<li><a href="../471516/index.html">Intel 665p: SSD con QLC NAND de 96 capas</a></li>
<li><a href="../471518/index.html">Apple en 2019 es Linux en 2000</a></li>
<li><a href="../471520/index.html">El libro "Tareas de inform谩tica cl谩sica en Python"</a></li>
<li><a href="../471524/index.html">Traducci贸n completa de instrucciones para evaluadores Google</a></li>
<li><a href="../471528/index.html">Implemente aplicaciones con Docker Swarm</a></li>
<li><a href="../471530/index.html">GitLab recorri贸 un camino inusual hacia CI / CD y Kubernetes</a></li>
<li><a href="../471532/index.html">Adi贸s PCB; hola interconexi贸n de silicio</a></li>
<li><a href="../471536/index.html">Predicci贸n de inundaciones de Google: una mirada al interior</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>