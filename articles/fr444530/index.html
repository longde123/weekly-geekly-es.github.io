<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë≤üèΩ üë®üèø‚Äçüîß üõ´ L'avenir de l'injection de d√©pendance dans Android üå∂Ô∏è ‚óºÔ∏è üïµüèª</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="J'attire votre attention sur une traduction de l' article original de Jamie Sanson 

 Cr√©ation d'activit√© avant Android 9 Pie 


 L'injection de d√©pen...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>L'avenir de l'injection de d√©pendance dans Android</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/444530/"><p>  <sup><em>J'attire votre attention sur une traduction de l' <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">article original</a> de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Jamie Sanson</a></em></sup> <br><img src="https://habrastorage.org/getpro/habr/post_images/392/ae0/ac2/392ae0ac22d5b2d9b82a01e41d975278.jpg" alt="image"></p><br><h3 id="sozdanie-activity-do-android-9-pie">  Cr√©ation d'activit√© avant Android 9 Pie </h3><br><p> <em>L'injection de d√©pendance (DI)</em> est un mod√®le commun qui est utilis√© dans toutes les formes de d√©veloppement pour un certain nombre de raisons.  Gr√¢ce au projet Dagger, il est pris comme mod√®le utilis√© dans le d√©veloppement pour Android.  Les r√©cents changements dans Android 9 Pie nous ont fait disposer de plus d'options en mati√®re de DI, en particulier avec la nouvelle classe <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><code>AppComponentFactory</code></a> . </p><br><hr><br><p>  DI est tr√®s important en mati√®re de d√©veloppement Android moderne.  Cela vous permet de r√©duire la quantit√© totale de code lors de l'obtention de liens vers des services utilis√©s entre les classes, et divise g√©n√©ralement bien l'application en composants.  Dans cet article, nous nous concentrerons sur Dagger 2, la biblioth√®que DI la plus courante utilis√©e dans le d√©veloppement Android.  On suppose que vous avez d√©j√† une connaissance de base de la fa√ßon dont cela fonctionne, mais il n'est pas n√©cessaire de comprendre toutes les subtilit√©s.  Il est √† noter que cet article est un peu une aventure.  C'est int√©ressant et tout, mais au moment de sa r√©daction, Android 9 Pie n'apparaissait m√™me pas sur <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">le panneau de version de la plate-forme</a> , donc ce sujet ne sera probablement pas pertinent pour le d√©veloppement quotidien pendant au moins plusieurs ann√©es. </p><a name="habracut"></a><br><h3 id="vnedrenie-zavisimostey-v-android-segodnya">  Injection de d√©pendance dans Android aujourd'hui </h3><br><p>  En termes simples, nous utilisons DI pour fournir des instances de classes de ¬´d√©pendance¬ª √† nos classes d√©pendantes, c'est-√†-dire celles qui font le travail.  Supposons que nous utilisons le <a href="">mod√®le de r√©f√©rentiel</a> pour traiter notre logique li√©e aux donn√©es et que nous voulons utiliser notre r√©f√©rentiel dans Activity pour afficher certaines donn√©es √† l'utilisateur.  Nous pourrions vouloir utiliser le m√™me r√©f√©rentiel √† plusieurs endroits, nous utilisons donc l'injection de d√©pendances pour faciliter le partage de la m√™me instance entre un tas de classes diff√©rentes. </p><br><p>  Tout d'abord, nous fournirons un r√©f√©rentiel.  Nous d√©finirons la fonction <code>Provides</code> dans le module, permettant √† Dagger de savoir que c'est exactement l'instance que nous voulons impl√©menter.  Veuillez noter que notre r√©f√©rentiel a besoin d'une instance de contexte pour travailler avec des fichiers et le r√©seau.  Nous lui fournirons le contexte de l'application. </p><br><pre> <code class="kotlin hljs"><span class="hljs-meta"><span class="hljs-meta">@Module</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AppModule</span></span></span></span>(<span class="hljs-keyword"><span class="hljs-keyword">val</span></span> appContext: Context) { <span class="hljs-meta"><span class="hljs-meta">@Provides</span></span> <span class="hljs-meta"><span class="hljs-meta">@ApplicationScope</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">provideApplicationContext</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>: Context = appContext <span class="hljs-meta"><span class="hljs-meta">@Provides</span></span> <span class="hljs-meta"><span class="hljs-meta">@ApplicationScope</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">provideRepository</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(context: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">Context</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span>: Repository = Repository(context) }</code> </pre> <br><p>  Nous devons maintenant d√©finir <code>Component</code> pour g√©rer l'impl√©mentation des classes dans lesquelles nous voulons utiliser notre <code>Repository</code> . </p><br><pre> <code class="kotlin hljs"><span class="hljs-meta"><span class="hljs-meta">@ApplicationScope</span></span> <span class="hljs-meta"><span class="hljs-meta">@Component(modules = [AppModule::class])</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ApplicationComponent</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">inject</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(activity: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">MainActivity</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span> }</code> </pre> <br><p>  Enfin, nous pouvons configurer notre <code>Activity</code> pour utiliser notre r√©f√©rentiel.  Supposons que nous ayons cr√©√© une instance de notre <code>ApplicationComponent</code> ailleurs. </p><br><pre> <code class="kotlin hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MainActivity</span></span></span><span class="hljs-class">: </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">AppCompatActivity</span></span></span></span>() { <span class="hljs-meta"><span class="hljs-meta">@Inject</span></span> <span class="hljs-keyword"><span class="hljs-keyword">lateinit</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> repository: Repository <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onCreate</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(savedInstanceState: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">Bundle</span></span></span></span><span class="hljs-function"><span class="hljs-params">?)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>.onCreate(savedInstanceState) <span class="hljs-comment"><span class="hljs-comment">//    application.applicationComponent.inject(this) //       } }</span></span></code> </pre> <br><p>  C'est tout!  Nous venons de configurer l'injection de d√©pendances dans l'application √† l'aide de Dagger.  Il existe plusieurs fa√ßons de proc√©der, mais cela semble √™tre l'approche la plus simple. </p><br><h3 id="chto-ne-tak-s-tekuschim-podhodom">  Quel est le probl√®me avec l'approche actuelle? </h3><br><p>  Dans les exemples ci-dessus, nous avons vu deux types d'injections diff√©rents, l'un plus √©vident que l'autre. </p><br><p>  La premi√®re que vous avez peut-√™tre manqu√©e est connue sous le nom d' <strong>int√©gration dans le constructeur</strong> .  Il s'agit d'une m√©thode de fourniture de d√©pendances via le constructeur d'une classe, ce qui signifie qu'une classe utilisant des d√©pendances n'a aucune id√©e de l'origine des instances.  Ceci est consid√©r√© comme la forme la plus pure d'injection de d√©pendances, car elle encapsule parfaitement notre logique d'injection dans nos classes de <code>Module</code> .  Dans notre exemple, nous avons utilis√© cette approche pour fournir un r√©f√©rentiel: </p><br><pre> <code class="kotlin hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">provideRepository</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(context: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">Context</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span>: Repository = Repository(context)</code> </pre> <br><p>  Pour cela, nous avions besoin de <code>Context</code> , que nous avons fourni dans la fonction <code>provideApplicationContext()</code> . </p><br><p>  La deuxi√®me chose, plus √©vidente, que nous avons vue est la <strong>mise en ≈ìuvre de la classe sur le terrain</strong> .  Cette m√©thode a √©t√© utilis√©e dans notre <code>MainActivity</code> pour fournir notre magasin.  Ici, nous d√©finissons les champs comme destinataires des injections √† l'aide de l'annotation <code>Inject</code> .  Ensuite, dans notre fonction <code>onCreate</code> nous indiquons √† <code>ApplicationComponent</code> que les d√©pendances doivent √™tre inject√©es dans nos champs.  Il ne semble pas aussi propre que l'incorporation dans un constructeur, car nous avons une r√©f√©rence explicite √† notre composant, ce qui signifie que le concept de l'int√©gration s'infiltre dans nos classes d√©pendantes.  Un autre d√©faut dans les classes Android Framework, car nous devons √™tre s√ªrs que la premi√®re chose que nous faisons est de fournir des d√©pendances.  Si cela se produit au mauvais moment du cycle de vie, nous pouvons accidentellement essayer d'utiliser un objet qui n'a pas encore √©t√© initialis√©. </p><br><p>  Id√©alement, vous devriez vous d√©barrasser compl√®tement des impl√©mentations dans les champs de classe.  Cette approche ignore les informations d'impl√©mentation pour les classes qui n'ont pas besoin de les conna√Ætre et peuvent potentiellement provoquer des probl√®mes de cycle de vie.  Nous avons vu des tentatives pour le faire mieux, et <em>Dagger</em> sur Android est un moyen assez fiable, mais √† la fin, il serait pr√©f√©rable d'utiliser simplement l'incorporation dans le constructeur.  Actuellement, nous ne pouvons pas utiliser cette approche pour un certain nombre de classes d'infrastructure, telles que ¬´Activit√©¬ª, ¬´Service¬ª, ¬´Application¬ª, etc., car elles sont cr√©√©es pour nous par le syst√®me.  Il semble que pour le moment, nous ne pouvons pas introduire de cours dans les domaines.  N√©anmoins, Android 9 Pie pr√©pare quelque chose d'int√©ressant, qui, peut-√™tre, changera fondamentalement tout. </p><br><h3 id="vnedrenie-zavisimostey-v-android-9-pie">  Injection de d√©pendances dans Android 9 Pie </h3><br><p>  Comme mentionn√© au d√©but de l'article, Android 9 Pie a une classe AppComponentFactory.  La documentation est plut√¥t rare et est simplement affich√©e sur le site Web du d√©veloppeur en tant que telle: </p><br><blockquote>  <em>L'interface utilis√©e pour contr√¥ler la cr√©ation d'√©l√©ments manifestes.</em> </blockquote><p>  C'est intrigant.  Les ¬´√©l√©ments du manifeste¬ª se r√©f√®rent ici aux classes que nous <code>AndroidManifest</code> dans notre fichier <code>AndroidManifest</code> - telles que l'activit√©, le service et notre classe d'application.  Cela nous permet de "contr√¥ler la cr√©ation" de ces √©l√©ments ... alors, h√©, pouvons-nous maintenant fixer les r√®gles de cr√©ation de nos activit√©s?  Quel d√©lice! </p><br><p>  Creusons plus profond√©ment.  Nous allons commencer par √©tendre <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><code>AppComponentFactory</code></a> et <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><code>AppComponentFactory</code></a> la m√©thode <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><code>AppComponentFactory</code></a> . </p><br><pre> <code class="kotlin hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">InjectionComponentFactory</span></span></span><span class="hljs-class">: </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">AppComponentFactory</span></span></span></span>() { <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> repository = NonContextRepository() <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">instantiateActivity</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(cl: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">ClassLoader</span></span></span></span><span class="hljs-function"><span class="hljs-params">, className: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">String</span></span></span></span><span class="hljs-function"><span class="hljs-params">, intent: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">Intent</span></span></span></span><span class="hljs-function"><span class="hljs-params">?)</span></span></span></span>: Activity { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> { className == MainActivity::<span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">java</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">name</span></span></span><span class="hljs-class"> -&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MainActivity</span></span></span></span>(repository) <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> -&gt; <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>.instantiateActivity(cl, className, intent) } } }</code> </pre> <br><p>  Nous devons maintenant d√©clarer notre fabrique de composants dans le manifeste √† l'int√©rieur de la balise d' <strong>application</strong> . </p><br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">application</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:allowBackup</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"true"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:label</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"@string/app_name"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:icon</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"@mipmap/ic_launcher"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">".InjectionApp"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:appComponentFactory</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"com.mypackage.injectiontest.component.InjectionComponentFactory"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:theme</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"@style/AppTheme"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">tools:replace</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"android:appComponentFactory"</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br><p>  Enfin, nous pouvons lancer notre application ... et √ßa marche!  Notre <code>NonContextRepository</code> fourni via le constructeur MainActivity.  Avec gr√¢ce! </p><br><p>  Veuillez noter qu'il y a des r√©serves.  Nous ne pouvons pas utiliser <code>Context</code> ici, car avant m√™me son existence, un appel √† notre fonction se produit - c'est d√©routant!  Nous pouvons aller plus loin pour que le constructeur impl√©mente notre classe Application, mais voyons comment Dagger peut rendre cela encore plus facile. </p><br><h3 id="vstrechayte--dagger-multi-binds">  Rencontre - Dagger Multi-Binds </h3><br><p>  Je n'entrerai pas dans les d√©tails de l'op√©ration de reliure multiple Dagger sous le capot, car cela d√©passe le cadre de cet article.  Tout ce que vous devez savoir, c'est qu'il fournit un bon moyen d'injecter dans le constructeur de classe sans avoir √† appeler manuellement le constructeur.  Nous pouvons l'utiliser pour impl√©menter facilement des classes de framework d'une mani√®re √©volutive.  Voyons comment tout cela s'additionne. </p><br><p>  Commen√ßons par configurer notre activit√© pour d√©terminer o√π aller ensuite. </p><br><pre> <code class="kotlin hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MainActivity</span></span></span><span class="hljs-class"> </span><span class="hljs-meta"><span class="hljs-class"><span class="hljs-meta">@Inject</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">constructor</span></span></span></span>( <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> repository: NonContextRepository ): Activity() { <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onCreate</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(savedInstanceState: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">Bundle</span></span></span></span><span class="hljs-function"><span class="hljs-params">?)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>.onCreate(savedInstanceState) <span class="hljs-comment"><span class="hljs-comment">//       } }</span></span></code> </pre> <br><p>  Cela montre imm√©diatement qu'il n'y a presque <em>aucune</em> mention de l'injection de d√©pendance.  La seule chose que nous voyons est l'annotation <code>Inject</code> devant le constructeur. </p><br><p>  Vous devez maintenant changer le composant et le module Dagger: </p><br><pre> <code class="kotlin hljs"><span class="hljs-meta"><span class="hljs-meta">@Component(modules = [ApplicationModule::class])</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ApplicationComponent</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">inject</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(factory: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">InjectionComponentFactory</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span> }</code> </pre> <br><pre> <code class="kotlin hljs"><span class="hljs-meta"><span class="hljs-meta">@Module(includes = [ComponentModule::class])</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ApplicationModule</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Provides</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">provideRepository</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>: NonContextRepository = NonContextRepository() }</code> </pre> <br><p>  Rien n'a beaucoup chang√©.  Il ne nous reste plus qu'√† impl√©menter notre fabrique de composants, mais comment cr√©er nos √©l√©ments manifestes?  Ici, nous avons besoin d'un <code>ComponentModule</code> .  Voyons voir: </p><br><pre> <code class="kotlin hljs"><span class="hljs-meta"><span class="hljs-meta">@Module</span></span> <span class="hljs-keyword"><span class="hljs-keyword">abstract</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ComponentModule</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Binds</span></span> <span class="hljs-meta"><span class="hljs-meta">@IntoMap</span></span> <span class="hljs-meta"><span class="hljs-meta">@ComponentKey(MainActivity::class)</span></span> <span class="hljs-keyword"><span class="hljs-keyword">abstract</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">bindMainActivity</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(activity: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">MainActivity</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span>: Any <span class="hljs-meta"><span class="hljs-meta">@Binds</span></span> <span class="hljs-keyword"><span class="hljs-keyword">abstract</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">bindComponentHelper</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(componentHelper: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">ComponentHelper</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span>: ComponentInstanceHelper } <span class="hljs-meta"><span class="hljs-meta">@Target(AnnotationTarget.FUNCTION, AnnotationTarget.PROPERTY_GETTER, AnnotationTarget.PROPERTY_SETTER)</span></span> <span class="hljs-meta"><span class="hljs-meta">@Retention(AnnotationRetention.RUNTIME)</span></span> <span class="hljs-meta"><span class="hljs-meta">@MapKey</span></span> <span class="hljs-keyword"><span class="hljs-keyword">internal</span></span> <span class="hljs-keyword"><span class="hljs-keyword">annotation</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ComponentKey</span></span></span></span>(<span class="hljs-keyword"><span class="hljs-keyword">val</span></span> clazz: KClass&lt;<span class="hljs-keyword"><span class="hljs-keyword">out</span></span> Any&gt;)</code> </pre> <br><p>  Ouais, eh bien, juste quelques annotations.  Ici, nous associons notre <code>Activity</code> √† une carte, impl√©mentons cette carte dans notre classe <code>ComponentHelper</code> et fournissons cette <code>ComponentHelper</code> - le tout en deux instructions <code>Binds</code> .  Dagger sait comment instancier notre <code>MainActivity</code> gr√¢ce √† l'annotation <code>MainActivity</code> <code>Inject</code> afin qu'il puisse ¬´lier¬ª le fournisseur √† cette classe, fournissant automatiquement les d√©pendances de constructeur dont nous avons besoin.  Notre <code>ComponentHelper</code> le suivant. </p><br><pre> <code class="kotlin hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ComponentHelper</span></span></span><span class="hljs-class"> </span><span class="hljs-meta"><span class="hljs-class"><span class="hljs-meta">@Inject</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">constructor</span></span></span></span>( <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> creators: Map&lt;Class&lt;<span class="hljs-keyword"><span class="hljs-keyword">out</span></span> Any&gt;, <span class="hljs-meta"><span class="hljs-meta">@JvmSuppressWildcards</span></span> Provider&lt;Any&gt;&gt; ): ComponentInstanceHelper { <span class="hljs-meta"><span class="hljs-meta">@Suppress(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"UNCHECKED_CAST"</span></span></span><span class="hljs-meta">)</span></span> <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-type"><span class="hljs-function"><span class="hljs-type">&lt;T&gt;</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">resolve</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(className: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">String</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span>: T? = creators .filter { it.key.name == className } .values .firstOrNull() ?.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>() <span class="hljs-keyword"><span class="hljs-keyword">as</span></span>? T } <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">InstanceComponentHelper</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-type"><span class="hljs-function"><span class="hljs-type">&lt;T&gt;</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">resolve</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(className: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">String</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span>: T? }</code> </pre> <br><p>  Autrement dit, nous avons maintenant une carte des classes pour les fournisseurs de ces classes.  Lorsque nous essayons de r√©soudre une classe par son nom, nous trouvons simplement le fournisseur de cette classe (si nous en avons un), l'appelons pour obtenir une nouvelle instance de cette classe et la renvoyons. </p><br><p>  Enfin, nous devons apporter des modifications √† notre <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><code>AppComponentFactory</code></a> pour utiliser notre nouvelle classe d'assistance. </p><br><pre> <code class="kotlin hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">InjectionComponentFactory</span></span></span><span class="hljs-class">: </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">AppComponentFactory</span></span></span></span>() { <span class="hljs-meta"><span class="hljs-meta">@Inject</span></span> <span class="hljs-keyword"><span class="hljs-keyword">lateinit</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> componentHelper: ComponentInstanceHelper <span class="hljs-keyword"><span class="hljs-keyword">init</span></span> { DaggerApplicationComponent.create().inject(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>) } <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">instantiateActivity</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(cl: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">ClassLoader</span></span></span></span><span class="hljs-function"><span class="hljs-params">, className: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">String</span></span></span></span><span class="hljs-function"><span class="hljs-params">, intent: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">Intent</span></span></span></span><span class="hljs-function"><span class="hljs-params">?)</span></span></span></span>: Activity { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> componentHelper .resolve&lt;Activity&gt;(className) ?.apply { setIntent(intent) } ?: <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>.instantiateActivity(cl, className, intent) } }</code> </pre> <br><p>  Ex√©cutez √† nouveau le code.  Tout fonctionne!  Quel d√©lice. </p><br><h3 id="problemy-vnedreniya-v-konstruktor">  Probl√®mes d'impl√©mentation du constructeur </h3><br><p>  Un tel titre peut ne pas sembler tr√®s impressionnant.  Bien que nous puissions incorporer la plupart des instances en mode normal en les injectant dans le constructeur, nous n'avons aucun moyen √©vident de fournir un contexte pour nos d√©pendances de mani√®re standard.  Mais le <code>Context</code> dans Android est tout.  Il est n√©cessaire pour acc√©der aux param√®tres, au r√©seau, √† la configuration des applications et bien plus encore.  Nos d√©pendances sont souvent des choses qui utilisent des services li√©s aux donn√©es, tels que le r√©seau et les param√®tres.  Nous pouvons contourner cela en r√©√©crivant nos d√©pendances pour en faire de pures fonctions, ou en initialisant tout avec des instances de contexte dans notre classe <code>Application</code> , mais il faut beaucoup plus de travail pour d√©terminer la meilleure fa√ßon de le faire. </p><br><p>  Un autre inconv√©nient de cette approche est la d√©finition de la port√©e.  Dans Dagger, l'un des concepts cl√©s pour impl√©menter l'injection de d√©pendances hautes performances avec une bonne s√©paration des relations de classe est la modularit√© du graphe d'objet et l'utilisation de la port√©e.  Bien que cette approche n'interdise pas l'utilisation de modules, elle limite l'utilisation de la port√©e.  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><code>AppComponentFactory</code></a> existe √† un niveau d'abstraction compl√®tement diff√©rent par rapport √† nos classes de framework standard - nous ne pouvons pas obtenir de lien vers celui-ci par programme, nous n'avons donc aucun moyen de lui demander de fournir des d√©pendances pour <code>Activity</code> dans une port√©e diff√©rente. </p><br><p>  Il existe de nombreuses fa√ßons de r√©soudre nos probl√®mes avec les √©tendues dans la pratique, dont l'une consiste √† utiliser une <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><code>FragmentFactory</code></a> pour int√©grer nos fragments dans un constructeur avec des √©tendues.  Je n'entrerai pas dans les d√©tails, mais il s'av√®re que nous avons maintenant une m√©thode pour contr√¥ler la cr√©ation de fragments, qui non seulement nous donne beaucoup plus de libert√© en termes de port√©e, mais a √©galement une compatibilit√© descendante. </p><br><h3 id="zaklyuchenie">  Conclusion </h3><br><p>  Android 9 Pie a introduit un moyen d'utiliser l'incorporation dans le constructeur pour fournir des d√©pendances dans nos classes de framework, telles que ¬´Activity¬ª et ¬´Application¬ª.  Nous avons vu qu'avec <em>Dagger Multi-binding,</em> nous pouvons facilement fournir des d√©pendances au niveau de l'application. </p><br><p>  Un constructeur qui impl√©mente tous nos composants est extr√™mement attrayant, et nous pouvons m√™me faire quelque chose pour le faire fonctionner correctement avec des instances de contexte.  C'est un avenir prometteur, mais il n'est disponible qu'√† partir de l'API 28. Si vous souhaitez toucher moins de 0,5% des utilisateurs, vous pouvez l'essayer.  Sinon, vous devriez attendre et voir si une telle m√©thode reste pertinente dans quelques ann√©es. </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr444530/">https://habr.com/ru/post/fr444530/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr444520/index.html">2. Check Point Getting Started R80.20. Architecture de la solution</a></li>
<li><a href="../fr444522/index.html">Apocalypse est annul√©e</a></li>
<li><a href="../fr444524/index.html">Lambdas: de C ++ 11 √† C ++ 20. Partie 1</a></li>
<li><a href="../fr444526/index.html">Pile DOTS: C ++ & C #</a></li>
<li><a href="../fr444528/index.html">Situation: le Japon peut limiter le t√©l√©chargement de contenu √† partir du r√©seau - nous comprenons et discutons</a></li>
<li><a href="../fr444534/index.html">Analyse des vuln√©rabilit√©s et d√©veloppement s√©curis√©. Partie 1</a></li>
<li><a href="../fr444536/index.html">MVCC-2. Calques, fichiers, pages</a></li>
<li><a href="../fr444540/index.html">Intel est pr√™t √† commencer la production de m√©moire MRAM</a></li>
<li><a href="../fr444542/index.html">Diffusion en direct et calendrier des conf√©rences pour SmartMail Conf: Machine Learning</a></li>
<li><a href="../fr444544/index.html">Quelque chose au sujet des centres de donn√©es distribu√©s pour les entreprises</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>