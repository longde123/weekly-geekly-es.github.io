<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ü•â ‚úäüèø üë®üèΩ‚Äç‚öïÔ∏è GraphQL e Golang üíã ‚ò¶Ô∏è ‚ò∫Ô∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="A tecnologia GraphQL nos √∫ltimos anos, depois que a empresa Facebook a transferiu para a categoria de c√≥digo aberto, tornou-se muito popular. O autor ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>GraphQL e Golang</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/ruvds/blog/444346/">  A tecnologia GraphQL nos √∫ltimos anos, depois que a empresa Facebook a transferiu para a categoria de c√≥digo aberto, tornou-se muito popular.  O autor do material, cuja tradu√ß√£o publicamos hoje, diz que tentou trabalhar com o GraphQL no Node.js e, por experi√™ncia pr√≥pria, estava convencido de que essa tecnologia, gra√ßas √†s suas not√°veis ‚Äã‚Äãcapacidades e simplicidade, n√£o atrai acidentalmente tanta aten√ß√£o.  Recentemente, enquanto estava envolvido em um novo projeto, ele mudou do Node.js para Golang.  Ent√£o, ele decidiu testar a colabora√ß√£o de Golang e GraphQL. <br><br> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><img src="https://habrastorage.org/webt/jp/qa/qv/jpqaqvlt5xh7d7mlhwpxvvwhptq.jpeg"></a> <br><a name="habracut"></a><br><h2>  <font color="#3AC1EF">Informa√ß√µes preliminares</font> </h2><br>  Voc√™ pode aprender com a defini√ß√£o oficial do GraphQL que essa √© uma linguagem de consulta para a API e um tempo de execu√ß√£o para executar essas consultas em dados existentes.  O GraphQL fornece uma descri√ß√£o completa e compreens√≠vel dos dados em uma determinada API, permite que os clientes solicitem exatamente as informa√ß√µes necess√°rias e nada mais, simplifica o desenvolvimento da API ao longo do tempo e oferece ferramentas poderosas aos desenvolvedores. <br><br>  N√£o h√° muitas bibliotecas GraphQL para Golang.  Em particular, tentei bibliotecas como <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Thunder</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">graphql</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">graphql-go</a> e <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">gqlgen</a> .  Devo observar que o melhor de tudo que tentei foi a biblioteca gqlgen. <br><br>  A biblioteca gqlgen ainda est√° na vers√£o beta, no momento em que este material foi escrito, era a vers√£o <a href="">0.7.2</a> .  A biblioteca est√° evoluindo rapidamente.  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Aqui</a> voc√™ pode descobrir os planos para seu desenvolvimento.  Agora, o patrocinador oficial do gqlgen √© o projeto <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">99designs</a> , o que significa que essa biblioteca, possivelmente, se desenvolver√° ainda mais r√°pido do que antes.  Os principais desenvolvedores desta biblioteca s√£o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">vektah</a> e <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">neelance</a> , enquanto neelance, al√©m disso, trabalha na biblioteca graphql-go. <br><br>  Vamos falar sobre a biblioteca gqlgen com base no pressuposto de que voc√™ j√° possui conhecimento b√°sico do GraphQL. <br><br><h2>  <font color="#3AC1EF">Recursos do Gqlgen</font> </h2><br>  Na descri√ß√£o do gqlgen, voc√™ pode descobrir o que temos diante de n√≥s √© uma biblioteca para criar rapidamente servidores GraphQL estritamente tipificados no Golang.  Essa frase me parece muito promissora, pois significa que, ao trabalhar com esta biblioteca, n√£o encontrarei algo como a <code>map[string]interface{}</code> , pois uma abordagem baseada em digita√ß√£o estrita √© usada aqui. <br><br>  Al√©m disso, esta biblioteca usa uma abordagem baseada em um esquema de dados.  Isso significa que as APIs s√£o descritas usando a Linguagem de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">defini√ß√£o de esquema</a> do GraphQL.  Essa linguagem possui suas pr√≥prias e poderosas ferramentas de gera√ß√£o de c√≥digo que criam automaticamente o c√≥digo GraphQL.  Nesse caso, o programador pode implementar apenas a l√≥gica b√°sica dos m√©todos de interface correspondentes. <br><br>  Este artigo est√° dividido em duas partes.  O primeiro √© dedicado aos m√©todos b√°sicos de trabalho e o segundo aos avan√ßados. <br><br><h2>  <font color="#3AC1EF">Os principais m√©todos de trabalho: configura√ß√£o, solicita√ß√µes para recebimento e altera√ß√£o de dados, assinaturas</font> </h2><br>  Como aplicativo experimental, usaremos um site no qual os usu√°rios podem publicar v√≠deos, adicionar capturas de tela e cr√≠ticas, pesquisar v√≠deos e exibir listas de registros associados a outros registros.  Vamos come√ßar a trabalhar neste projeto: <br><br><pre> <code class="go hljs">mkdir -p $GOPATH/src/github.com/ridhamtarpara/<span class="hljs-keyword"><span class="hljs-keyword">go</span></span>-graphql-demo/</code> </pre> <br>  Crie o seguinte arquivo de esquema de dados ( <code>schema.graphql</code> ) no diret√≥rio raiz do projeto: <br><br><pre> <code class="go hljs"><span class="hljs-keyword"><span class="hljs-keyword">type</span></span> User {   id: ID!   name: String!   email: String! } <span class="hljs-keyword"><span class="hljs-keyword">type</span></span> Video {   id: ID!   name: String!   description: String!   user: User!   url: String!   createdAt: Timestamp!   screenshots: [Screenshot]   related(limit: Int = <span class="hljs-number"><span class="hljs-number">25</span></span>, offset: Int = <span class="hljs-number"><span class="hljs-number">0</span></span>): [Video!]! } <span class="hljs-keyword"><span class="hljs-keyword">type</span></span> Screenshot {   id: ID!   videoId: ID!   url: String! } input NewVideo {   name: String!   description: String!   userId: ID!   url: String! } <span class="hljs-keyword"><span class="hljs-keyword">type</span></span> Mutation {   createVideo(input: NewVideo!): Video! } <span class="hljs-keyword"><span class="hljs-keyword">type</span></span> Query {   Videos(limit: Int = <span class="hljs-number"><span class="hljs-number">25</span></span>, offset: Int = <span class="hljs-number"><span class="hljs-number">0</span></span>): [Video!]! } scalar Timestamp</code> </pre> <br>  Ele descreve os modelos de dados b√°sicos, uma muta√ß√£o ( <code>Mutation</code> , descri√ß√£o da solicita√ß√£o de altera√ß√£o de dados), usada para publicar novos arquivos de v√≠deo no site, e uma consulta ( <code>Query</code> ) para obter uma lista de todos os arquivos de v√≠deo.  Leia mais sobre o esquema GraphQL <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">aqui</a> .  Al√©m disso, aqui declaramos um de nossos pr√≥prios tipos de dados escalares.  N√£o estamos satisfeitos com os 5 <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">tipos de</a> dados escalares padr√£o ( <code>Int</code> , <code>Float</code> , <code>String</code> , <code>Boolean</code> e <code>ID</code> ) que est√£o no GraphQL. <br><br>  Se voc√™ precisar usar seus pr√≥prios tipos, poder√° declar√°-los em <code>schema.graphql</code> (no nosso caso, esse tipo √© <code>Timestamp</code> ) e fornecer suas defini√ß√µes no c√≥digo.  Ao usar a biblioteca gqlgen, voc√™ precisa fornecer m√©todos para empacotamento e desempacotamento para todos os seus pr√≥prios tipos escalares e configurar o mapeamento usando <code>gqlgen.yml</code> . <br><br>  Note-se que na vers√£o mais recente da biblioteca houve uma mudan√ßa importante.  Nomeadamente, a depend√™ncia dos arquivos bin√°rios compilados foi removida.  Portanto, o arquivo <code>scripts/gqlgen.go</code> deve ser adicionado ao projeto <code>scripts/gqlgen.go</code> seguinte conte√∫do: <br><br><pre> <code class="go hljs"><span class="hljs-comment"><span class="hljs-comment">// +build ignore package main import "github.com/99designs/gqlgen/cmd" func main() { cmd.Execute() }</span></span></code> </pre> <br>  Depois disso, voc√™ precisa inicializar o <code>dep</code> : <br><br><pre> <code class="go hljs">dep init</code> </pre> <br>  Agora √© hora de aproveitar os recursos de gera√ß√£o de c√≥digo da biblioteca.  Eles permitem que voc√™ crie todo o c√≥digo clich√™ chato, que, no entanto, n√£o pode ser chamado de completamente desinteressante.  Para iniciar o mecanismo de gera√ß√£o autom√°tica de c√≥digo, execute o seguinte comando: <br><br><pre> <code class="go hljs"><span class="hljs-keyword"><span class="hljs-keyword">go</span></span> run scripts/gqlgen.<span class="hljs-keyword"><span class="hljs-keyword">go</span></span> init</code> </pre> <br>  Como resultado de sua execu√ß√£o, os seguintes arquivos ser√£o criados: <br><br><ul><li>  <code>gqlgen.yml</code> : arquivo de configura√ß√£o para gerenciar a gera√ß√£o de c√≥digo. <br></li><li>  <code>generated.go</code> : c√≥digo gerado. <br></li><li>  <code>models_gen.go</code> : todos os modelos e tipos de dados do esquema fornecido. <br></li><li>  <code>resolver.go</code> : aqui ser√° o c√≥digo que o programador cria. <br></li><li>  <code>server/server.go</code> : ponto de entrada com <code>http.Handler</code> para iniciar o servidor GraphQL. <br></li></ul><br>  D√™ uma olhada no modelo gerado para o tipo de <code>Video</code> (arquivo <code>generated_video.go</code> ): <br><br><pre> <code class="go hljs"><span class="hljs-keyword"><span class="hljs-keyword">type</span></span> Video <span class="hljs-keyword"><span class="hljs-keyword">struct</span></span> { ID          <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>  <span class="hljs-string"><span class="hljs-string">`json:"id"`</span></span> Name        <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>  <span class="hljs-string"><span class="hljs-string">`json:"name"`</span></span> User        User  <span class="hljs-string"><span class="hljs-string">`json:"user"`</span></span> URL         <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>  <span class="hljs-string"><span class="hljs-string">`json:"url"`</span></span> CreatedAt   <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>  <span class="hljs-string"><span class="hljs-string">`json:"createdAt"`</span></span> Screenshots []*Screenshot <span class="hljs-string"><span class="hljs-string">`json:"screenshots"`</span></span> Related     []Video  <span class="hljs-string"><span class="hljs-string">`json:"related"`</span></span> }</code> </pre> <br>  Aqui voc√™ pode ver que o <code>ID</code> √© uma string, <code>CreatedAt</code> tamb√©m √© uma string.  Outros modelos relacionados s√£o configurados de acordo.  No entanto, em aplica√ß√µes reais, isso n√£o √© necess√°rio.  Se voc√™ estiver usando qualquer tipo de dados SQL, precisar√°, por exemplo, que o campo <code>ID</code> seja, dependendo do banco de dados usado, um <code>int64</code> <code>int</code> ou <code>int64</code> . <br><br>  Por exemplo, eu uso o PostgreSQL neste aplicativo de demonstra√ß√£o, ent√£o √© claro que preciso que o campo <code>ID</code> seja do tipo <code>int</code> e <code>CreatedAt</code> tipo <code>time.Time</code> .  Isso leva ao fato de que precisamos definir nosso pr√≥prio modelo e informar ao gqlgen que precisamos usar nosso modelo em vez de gerar um novo.  Aqui est√° o conte√∫do do arquivo <code>models.go</code> : <br><br><pre> <code class="go hljs"><span class="hljs-keyword"><span class="hljs-keyword">type</span></span> Video <span class="hljs-keyword"><span class="hljs-keyword">struct</span></span> { ID          <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> <span class="hljs-string"><span class="hljs-string">`json:"id"`</span></span> Name        <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> <span class="hljs-string"><span class="hljs-string">`json:"name"`</span></span> Description <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>    <span class="hljs-string"><span class="hljs-string">`json:"description"`</span></span> User        User <span class="hljs-string"><span class="hljs-string">`json:"user"`</span></span> URL         <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> <span class="hljs-string"><span class="hljs-string">`json:"url"`</span></span> CreatedAt   time.Time <span class="hljs-string"><span class="hljs-string">`json:"createdAt"`</span></span> Related     []Video } <span class="hljs-comment"><span class="hljs-comment">//    int  ID func MarshalID(id int) graphql.Marshaler { return graphql.WriterFunc(func(w io.Writer) {   io.WriteString(w, strconv.Quote(fmt.Sprintf("%d", id))) }) } //        func UnmarshalID(v interface{}) (int, error) { id, ok := v.(string) if !ok {   return 0, fmt.Errorf("ids must be strings") } i, e := strconv.Atoi(id) return int(i), e } func MarshalTimestamp(t time.Time) graphql.Marshaler { timestamp := t.Unix() * 1000 return graphql.WriterFunc(func(w io.Writer) {   io.WriteString(w, strconv.FormatInt(timestamp, 10)) }) } func UnmarshalTimestamp(v interface{}) (time.Time, error) { if tmpStr, ok := v.(int); ok {   return time.Unix(int64(tmpStr), 0), nil } return time.Time{}, errors.TimeStampError }</span></span></code> </pre> <br>  Dizemos √† biblioteca que ele deve usar esses modelos (arquivo <code>gqlgen.yml</code> ): <br><br><pre> <code class="go hljs">schema: - schema.graphql exec: filename: generated.<span class="hljs-keyword"><span class="hljs-keyword">go</span></span> model: filename: models_gen.<span class="hljs-keyword"><span class="hljs-keyword">go</span></span> resolver: filename: resolver.<span class="hljs-keyword"><span class="hljs-keyword">go</span></span> <span class="hljs-keyword"><span class="hljs-keyword">type</span></span>: Resolver models: Video:   model: github.com/ridhamtarpara/<span class="hljs-keyword"><span class="hljs-keyword">go</span></span>-graphql-demo/api.Video ID:   model: github.com/ridhamtarpara/<span class="hljs-keyword"><span class="hljs-keyword">go</span></span>-graphql-demo/api.ID Timestamp:   model: github.com/ridhamtarpara/<span class="hljs-keyword"><span class="hljs-keyword">go</span></span>-graphql-demo/api.Timestamp</code> </pre> <br>  O ponto de tudo isso √© que agora temos nossas pr√≥prias defini√ß√µes para <code>ID</code> e <code>Timestamp</code> com m√©todos para empacotamento e desempacotamento e mapeamento deles no arquivo <code>gqlgen.yml</code> .  Agora que o usu√°rio fornece a sequ√™ncia como um <code>ID</code> , o m√©todo <code>UnmarshalID()</code> converte essa sequ√™ncia em um n√∫mero inteiro.  Ao enviar uma resposta, o m√©todo <code>MarshalID()</code> converte o n√∫mero em uma string.  O mesmo acontece com o <code>Timestamp</code> / <code>Timestamp</code> ou com qualquer outro tipo de escalar declarado pelo programador. <br><br>  Agora √© hora de implementar a l√≥gica do aplicativo.  Abra o arquivo <code>resolver.go</code> e adicione descri√ß√µes de muta√ß√µes e consultas nele.  J√° existe um c√≥digo clich√™ gerado automaticamente que precisamos preencher com significado.  Aqui est√° o c√≥digo para este arquivo: <br><br><pre> <code class="go hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(r *mutationResolver)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CreateVideo</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ctx context.Context, input NewVideo)</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(api.Video, error)</span></span></span></span> { newVideo := api.Video{   URL:         input.URL,   Name:        input.Name,   CreatedAt:   time.Now().UTC(), } rows, err := dal.LogAndQuery(r.db, <span class="hljs-string"><span class="hljs-string">"INSERT INTO videos (name, url, user_id, created_at) VALUES($1, $2, $3, $4) RETURNING id"</span></span>,   input.Name, input.URL, input.UserID, newVideo.CreatedAt) <span class="hljs-keyword"><span class="hljs-keyword">defer</span></span> rows.Close() <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> err != <span class="hljs-literal"><span class="hljs-literal">nil</span></span> || !rows.Next() {   <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> api.Video{}, err } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> err := rows.Scan(&amp;newVideo.ID); err != <span class="hljs-literal"><span class="hljs-literal">nil</span></span> {   errors.DebugPrintf(err)   <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> errors.IsForeignKeyError(err) {     <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> api.Video{}, errors.UserNotExist   }   <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> api.Video{}, errors.InternalServerError } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> newVideo, <span class="hljs-literal"><span class="hljs-literal">nil</span></span> } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(r *queryResolver)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Videos</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ctx context.Context, limit *</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params">, offset *</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">([]api.Video, error)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> video api.Video <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> videos []api.Video rows, err := dal.LogAndQuery(r.db, <span class="hljs-string"><span class="hljs-string">"SELECT id, name, url, created_at, user_id FROM videos ORDER BY created_at desc limit $1 offset $2"</span></span>, limit, offset) <span class="hljs-keyword"><span class="hljs-keyword">defer</span></span> rows.Close();   <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> err != <span class="hljs-literal"><span class="hljs-literal">nil</span></span> {   errors.DebugPrintf(err)   <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">nil</span></span>, errors.InternalServerError } <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> rows.Next() {   <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> err := rows.Scan(&amp;video.ID, &amp;video.Name, &amp;video.URL, &amp;video.CreatedAt, &amp;video.UserID); err != <span class="hljs-literal"><span class="hljs-literal">nil</span></span> {     errors.DebugPrintf(err)     <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">nil</span></span>, errors.InternalServerError   }   videos = <span class="hljs-built_in"><span class="hljs-built_in">append</span></span>(videos, video) } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> videos, <span class="hljs-literal"><span class="hljs-literal">nil</span></span> }</code> </pre> <br>  Agora vamos testar a muta√ß√£o. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/f7b/a2c/01f/f7ba2c01f766ebc31ed90880376136f1.png"></div>  <i><font color="#999999">Muta√ß√£o createVideo</font></i> <br><br>  Isso funciona!  Mas por que n√£o h√° nada nas informa√ß√µes do usu√°rio (objeto do <code>user</code> )?  Ao trabalhar com o GraphQL, s√£o aplic√°veis ‚Äã‚Äãconceitos semelhantes ao carregamento ‚Äúpregui√ßoso‚Äù (pregui√ßoso) e ‚Äúganancioso‚Äù (ansioso).  Como esse sistema √© extens√≠vel, voc√™ precisa especificar quais campos precisam ser preenchidos "avidamente" e quais s√£o "pregui√ßosos". <br><br>  Sugeri √† equipe da organiza√ß√£o onde trabalho a seguinte ‚Äúregra de ouro‚Äù que se aplica ao trabalhar com o gqlgen: ‚ÄúN√£o inclua no modelo os campos que precisam ser carregados apenas se solicitados pelo cliente.‚Äù <br><br>  No nosso caso, eu preciso baixar dados sobre clipes de v√≠deo relacionados (e at√© mesmo informa√ß√µes do usu√°rio) apenas se o cliente solicitar esses campos.  Mas como inclu√≠mos esses campos no modelo, o gqlgen assume que fornecemos esses dados recebendo informa√ß√µes sobre o v√≠deo.  Como resultado, agora temos estruturas vazias. <br><br>  √Äs vezes, acontece que um determinado tipo de dados √© necess√°rio sempre, portanto, √© impratic√°vel fazer o download usando uma solicita√ß√£o separada.  Para isso, para melhorar o desempenho, voc√™ pode usar algo como jun√ß√µes SQL.  Uma vez (no entanto, isso n√£o se aplica ao exemplo considerado aqui), eu precisava enviar seus metadados junto com o v√≠deo.  Essas entidades foram armazenadas em locais diferentes.  Como resultado, se meu sistema recebeu uma solicita√ß√£o para baixar um v√≠deo, tive que fazer outra solicita√ß√£o para obter metadados.  Mas, como eu sabia sobre esse requisito (isto √©, eu sabia que no lado do cliente sempre precisava do v√≠deo e de seus metadados), preferi usar a t√©cnica de download guloso para melhorar o desempenho. <br><br>  Vamos reescrever o modelo e gerar o c√≥digo gqlgen novamente.  Para n√£o complicar a hist√≥ria, escrevemos apenas m√©todos para o campo do <code>user</code> (arquivo <code>models.go</code> ): <br><br><pre> <code class="go hljs"><span class="hljs-keyword"><span class="hljs-keyword">type</span></span> Video <span class="hljs-keyword"><span class="hljs-keyword">struct</span></span> { ID          <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> <span class="hljs-string"><span class="hljs-string">`json:"id"`</span></span> Name        <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> <span class="hljs-string"><span class="hljs-string">`json:"name"`</span></span> Description <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>    <span class="hljs-string"><span class="hljs-string">`json:"description"`</span></span> UserID      <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> <span class="hljs-string"><span class="hljs-string">`json:"-"`</span></span> URL         <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> <span class="hljs-string"><span class="hljs-string">`json:"url"`</span></span> CreatedAt   time.Time <span class="hljs-string"><span class="hljs-string">`json:"createdAt"`</span></span> }</code> </pre> <br>  Adicionamos um <code>UserID</code> e removemos a estrutura do <code>User</code> .  Agora gere novamente o c√≥digo: <br><br><pre> <code class="go hljs"><span class="hljs-keyword"><span class="hljs-keyword">go</span></span> run scripts/gqlgen.<span class="hljs-keyword"><span class="hljs-keyword">go</span></span> -v</code> </pre> <br>  Gra√ßas a este comando, os seguintes m√©todos de interface ser√£o criados para resolver estruturas indefinidas.  Al√©m disso, voc√™ precisar√° determinar o seguinte no resolvedor (arquivo gerado.go): <br><br><pre> <code class="go hljs"><span class="hljs-keyword"><span class="hljs-keyword">type</span></span> VideoResolver <span class="hljs-keyword"><span class="hljs-keyword">interface</span></span> { User(ctx context.Context, obj *api.Video) (api.User, error) Screenshots(ctx context.Context, obj *api.Video) ([]*api.Screenshot, error) Related(ctx context.Context, obj *api.Video, limit *<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>, offset *<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>) ([]api.Video, error) }</code> </pre> <br>  Aqui est√° a defini√ß√£o (arquivo <code>resolver.go</code> ): <br><br><pre> <code class="go hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(r *videoResolver)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">User</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ctx context.Context, obj *api.Video)</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(api.User, error)</span></span></span></span> { rows, _ := dal.LogAndQuery(r.db,<span class="hljs-string"><span class="hljs-string">"SELECT id, name, email FROM users where id = $1"</span></span>, obj.UserID) <span class="hljs-keyword"><span class="hljs-keyword">defer</span></span> rows.Close() <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> !rows.Next() {   <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> api.User{}, <span class="hljs-literal"><span class="hljs-literal">nil</span></span> } <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> user api.User <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> err := rows.Scan(&amp;user.ID, &amp;user.Name, &amp;user.Email); err != <span class="hljs-literal"><span class="hljs-literal">nil</span></span> {   errors.DebugPrintf(err)   <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> api.User{}, errors.InternalServerError } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> user, <span class="hljs-literal"><span class="hljs-literal">nil</span></span> }</code> </pre> <br>  Agora, os resultados do teste de muta√ß√£o ter√£o a apar√™ncia mostrada abaixo. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/25a/41d/aaa/25a41daaa86b8db5407bd432312c3028.png"></div><br>  <i><font color="#999999">Muta√ß√£o createVideo</font></i> <br><br>  O que acabamos de discutir s√£o os fundamentos do GraphQL, tendo dominado quais, voc√™ j√° pode escrever algo de sua prefer√™ncia.  No entanto, antes de mergulhar em experimentos com o GraphQL e Golang, ser√° √∫til falar sobre assinaturas, diretamente relacionadas ao que estamos fazendo aqui. <br><br><h3>  <font color="#3AC1EF">‚ñç Assinaturas</font> </h3><br>  O GraphQL fornece a capacidade de assinar altera√ß√µes de dados que ocorrem em tempo real.  A biblioteca gqlgen permite, em tempo real, usando soquetes da web, trabalhar com eventos de assinatura. <br><br>  A assinatura precisa ser descrita no arquivo <code>schema.graphql</code> .  Aqui est√° a descri√ß√£o da assinatura do evento de publica√ß√£o de v√≠deo: <br><br><pre> <code class="go hljs"><span class="hljs-keyword"><span class="hljs-keyword">type</span></span> Subscription {   videoPublished: Video! }</code> </pre> <br>  Agora, execute a gera√ß√£o autom√°tica de c√≥digo novamente: <br><br><pre> <code class="go hljs"><span class="hljs-keyword"><span class="hljs-keyword">go</span></span> run scripts/gqlgen.<span class="hljs-keyword"><span class="hljs-keyword">go</span></span> -v</code> </pre> <br>  Como j√° mencionado, durante a cria√ß√£o autom√°tica de c√≥digo no arquivo <code>generated.go</code> , √© criada uma interface que deve ser implementada no reconhecedor.  No nosso caso, fica assim (arquivo <code>resolver.go</code> ): <br><br><pre> <code class="go hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> videoPublishedChannel <span class="hljs-keyword"><span class="hljs-keyword">map</span></span>[<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>]<span class="hljs-keyword"><span class="hljs-keyword">chan</span></span> api.Video <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">init</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { videoPublishedChannel = <span class="hljs-keyword"><span class="hljs-keyword">map</span></span>[<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>]<span class="hljs-keyword"><span class="hljs-keyword">chan</span></span> api.Video{} } <span class="hljs-keyword"><span class="hljs-keyword">type</span></span> subscriptionResolver <span class="hljs-keyword"><span class="hljs-keyword">struct</span></span>{ *Resolver } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(r *subscriptionResolver)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">VideoPublished</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ctx context.Context)</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(&lt;-</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">chan</span></span></span></span><span class="hljs-function"><span class="hljs-params"> api.Video, error)</span></span></span></span> { id := randx.String(<span class="hljs-number"><span class="hljs-number">8</span></span>) videoEvent := <span class="hljs-built_in"><span class="hljs-built_in">make</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">chan</span></span> api.Video, <span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">go</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> {   &lt;-ctx.Done() }() videoPublishedChannel[id] = videoEvent <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> videoEvent, <span class="hljs-literal"><span class="hljs-literal">nil</span></span> } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(r *mutationResolver)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CreateVideo</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ctx context.Context, input NewVideo)</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(api.Video, error)</span></span></span></span> { <span class="hljs-comment"><span class="hljs-comment">//   ... for _, observer := range videoPublishedChannel {   observer &lt;- newVideo } return newVideo, nil }</span></span></code> </pre> <br>  Agora, ao criar um novo v√≠deo, voc√™ precisa acionar um evento.  No nosso exemplo, isso √© feito na linha <code>for _, observer := range videoPublishedChannel</code> . <br><br>  Agora √© hora de verificar sua assinatura. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/f71/d7f/42b/f71d7f42b147f59d227a25e577ef57fb.gif"></div><br>  <i><font color="#999999">Verificar assinatura</font></i> <br><br>  O GraphQL, √© claro, possui certos recursos valiosos, mas como eles dizem, nem tudo o que reluz √© ouro.  Ou seja, estamos falando do fato de que algu√©m que usa o GraphQL precisa cuidar da autoriza√ß√£o, da complexidade das solicita√ß√µes, do cache, do problema das solicita√ß√µes N + 1, da limita√ß√£o da velocidade de execu√ß√£o da consulta e de outras coisas.  Caso contr√°rio, um sistema desenvolvido usando o GraphQL pode enfrentar uma queda s√©ria no desempenho. <br><br><h2>  <font color="#3AC1EF">T√©cnicas avan√ßadas: autentica√ß√£o, carregadores de dados, complexidade de consultas</font> </h2><br>  Toda vez que leio manuais como esse, sinto que, depois de domin√°-los, aprendo tudo o que preciso saber sobre uma determinada tecnologia e tenho a capacidade de resolver problemas de qualquer complexidade. <br><br>  Por√©m, quando come√ßo a trabalhar em meus pr√≥prios projetos, geralmente encontro situa√ß√µes imprevistas que parecem erros do servidor ou solicita√ß√µes que est√£o em execu√ß√£o h√° muito tempo ou outras situa√ß√µes de conflito.  Como resultado, para fazer isso, tenho que me aprofundar no que recentemente pareceu perfeitamente compreens√≠vel.  Neste mesmo manual, espero que isso possa ser evitado.  √â por isso que nesta se√ß√£o examinaremos algumas t√©cnicas avan√ßadas para trabalhar com o GraphQL. <br><br><h3>  <font color="#3AC1EF">‚ñç Autentica√ß√£o</font> </h3><br>  Ao trabalhar com a API REST, temos um sistema de autentica√ß√£o e ferramentas de autoriza√ß√£o padr√£o ao trabalhar com um determinado terminal.  Por√©m, ao usar o GraphQL, apenas um ponto de extremidade √© usado; portanto, as tarefas de autentica√ß√£o podem ser resolvidas usando diretivas de esquema.  Edite o arquivo <code>schema.graphql</code> seguinte maneira: <br><br><pre> <code class="go hljs"><span class="hljs-keyword"><span class="hljs-keyword">type</span></span> Mutation {   createVideo(input: NewVideo!): Video! @isAuthenticated } directive @isAuthenticated on FIELD_DEFINITION</code> </pre> <br>  Criamos a diretiva <code>isAuthenticated</code> e a <code>createVideo</code> assinatura <code>createVideo</code> .  Ap√≥s a pr√≥xima sess√£o de gera√ß√£o autom√°tica de c√≥digo, voc√™ precisa definir uma defini√ß√£o para esta diretiva.  Agora, as diretivas s√£o implementadas na forma de m√©todos de estrutura, e n√£o na forma de interfaces, portanto, precisamos descrev√™-las.  <code>server.go</code> o c√≥digo gerado automaticamente localizado no arquivo <code>server.go</code> e criei um m√©todo que retorna a configura√ß√£o do <code>server.go</code> para o arquivo <code>server.go</code> .  Aqui est√° o arquivo <code>resolver.go</code> : <br><br><pre> <code class="go hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">NewRootResolvers</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(db *sql.DB)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Config</span></span></span></span> { c := Config{   Resolvers: &amp;Resolver{     db: db,   }, } <span class="hljs-comment"><span class="hljs-comment">//   c.Directives.IsAuthenticated = func(ctx context.Context, obj interface{}, next graphql.Resolver) (res interface{}, err error) {   ctxUserID := ctx.Value(UserIDCtxKey)   if ctxUserID != nil {     return next(ctx)   } else {     return nil, errors.UnauthorisedError   } } return c }</span></span></code> </pre> <br>  Aqui est√° o arquivo <code>server.go</code> : <br><br><pre> <code class="go hljs">rootHandler:= dataloaders.DataloaderMiddleware(   db,   handler.GraphQL(     go_graphql_demo.NewExecutableSchema(go_graphql_demo.NewRootResolvers(db)   ) ) http.Handle(<span class="hljs-string"><span class="hljs-string">"/query"</span></span>, auth.AuthMiddleware(rootHandler))</code> </pre> <br>  Lemos o <code>ID</code> do usu√°rio a partir do contexto.  Voc√™ n√£o acha isso estranho?  Como esse significado entrou no contexto e por que ele apareceu no contexto?  O fato √© que o gqlgen fornece contextos de solicita√ß√£o apenas no n√≠vel de implementa√ß√£o, portanto, n√£o temos como ler nenhum dado de solicita√ß√£o HTTP, como cabe√ßalhos ou cookies, em reconhecedores ou diretivas.  Como resultado, voc√™ precisa adicionar seus pr√≥prios mecanismos intermedi√°rios ao sistema, receber esses dados e coloc√°-los em contexto. <br><br>  Agora, precisamos descrever nosso pr√≥prio mecanismo de autentica√ß√£o intermedi√°ria para obter dados de autentica√ß√£o da solicita√ß√£o e verific√°-los. <br><br>  Nenhuma l√≥gica √© definida aqui.  Em vez disso, para dados de autoriza√ß√£o, para fins de demonstra√ß√£o, o <code>ID</code> do usu√°rio <code>ID</code> simplesmente passado aqui.  Esse mecanismo √© combinado no <code>server.go</code> com um novo m√©todo de carregamento de configura√ß√£o. <br><br>  Agora a descri√ß√£o da diretiva faz sentido.  N√£o processamos solicita√ß√µes de usu√°rio n√£o autorizadas no c√≥digo do middleware, pois essas solicita√ß√µes ser√£o processadas pela diretiva.  Aqui est√° como fica. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/6f6/a26/09c/6f6a2609cec8936c024fd68c7ed30096.png"></div><br>  <i><font color="#999999">Trabalhar com um usu√°rio n√£o autorizado</font></i> <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/267/b92/378/267b923783521a82738973f82600a2a4.png"></div><br>  <i><font color="#999999">Trabalhar com um usu√°rio autorizado</font></i> <br><br>  Ao trabalhar com diretivas de esquema, voc√™ pode at√© passar argumentos: <br><br><pre> <code class="go hljs">directive @hasRole(role: Role!) on FIELD_DEFINITION enum Role { ADMIN USER }</code> </pre> <br><h3>  <font color="#3AC1EF">Carregadores de dados</font> </h3><br>  Parece-me que tudo isso parece bastante interessante.  Voc√™ baixa os dados quando precisar.  Os clientes t√™m a capacidade de gerenciar dados; exatamente o que √© necess√°rio √© retirado do armazenamento.  Mas tudo tem um pre√ßo. <br><br>  Qual o pre√ßo a pagar por essas oportunidades?  D√™ uma olhada nos logs de download de todos os v√≠deos.  Ou seja, estamos falando sobre o fato de termos 8 v√≠deos e 5 usu√°rios. <br><br><pre> <code class="go hljs">query{ Videos(limit: <span class="hljs-number"><span class="hljs-number">10</span></span>){   name   user{     name   } } }</code> </pre> <br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/562/7c1/b5c/5627c1b5c34f74aec26381f8b0431147.png"></div><br>  <i><font color="#999999">Detalhes de Download de V√≠deo</font></i> <br><br><pre> <code class="go hljs">Query: Videos : SELECT id, name, description, url, created_at, user_id FROM videos ORDER BY created_at desc limit $<span class="hljs-number"><span class="hljs-number">1</span></span> offset $<span class="hljs-number"><span class="hljs-number">2</span></span> Resolver: User : SELECT id, name, email FROM users where id = $<span class="hljs-number"><span class="hljs-number">1</span></span> Resolver: User : SELECT id, name, email FROM users where id = $<span class="hljs-number"><span class="hljs-number">1</span></span> Resolver: User : SELECT id, name, email FROM users where id = $<span class="hljs-number"><span class="hljs-number">1</span></span> Resolver: User : SELECT id, name, email FROM users where id = $<span class="hljs-number"><span class="hljs-number">1</span></span> Resolver: User : SELECT id, name, email FROM users where id = $<span class="hljs-number"><span class="hljs-number">1</span></span> Resolver: User : SELECT id, name, email FROM users where id = $<span class="hljs-number"><span class="hljs-number">1</span></span> Resolver: User : SELECT id, name, email FROM users where id = $<span class="hljs-number"><span class="hljs-number">1</span></span> Resolver: User : SELECT id, name, email FROM users where id = $<span class="hljs-number"><span class="hljs-number">1</span></span></code> </pre> <br>  O que est√° acontecendo aqui?  Por que existem 9 solicita√ß√µes (uma solicita√ß√£o est√° associada √† tabela de v√≠deo e 8 - √† tabela do usu√°rio)?  Parece horr√≠vel.  Meu cora√ß√£o quase parou quando pensei que nossa API existente teria que ser substitu√≠da por isso ... √â verdade que os carregadores de dados podem lidar completamente com esse problema. <br><br>  Isso √© conhecido como problema N + 1. Estamos falando do fato de que existe uma consulta para obter todos os dados e, para cada parte dos dados (N), haver√° outra consulta no banco de dados. <br><br>  Esse √© um problema muito s√©rio quando se trata de desempenho e recursos: embora essas solicita√ß√µes sejam paralelas, elas drenam os recursos do sistema. <br><br>  Para resolver esse problema, usaremos a biblioteca <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">dataloaden</a> do autor da biblioteca gqlgen.  Essa biblioteca permite gerar o c√≥digo Go.  Primeiro, gere um carregador de dados para a entidade <code>User</code> : <br><br><pre> <code class="go hljs"><span class="hljs-keyword"><span class="hljs-keyword">go</span></span> get github.com/vektah/dataloaden dataloaden github.com/ridhamtarpara/<span class="hljs-keyword"><span class="hljs-keyword">go</span></span>-graphql-demo/api.User</code> </pre> <br>  Temos √† disposi√ß√£o o arquivo <code>userloader_gen.go</code> , que possui m√©todos como <code>Fetch</code> , <code>LoadAll</code> e <code>Prime</code> . <br><br>  Agora, para obter resultados gerais, precisamos definir o m√©todo <code>Fetch</code> (arquivo <code>dataloader.go</code> ): <br><br><pre> <code class="go hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">DataloaderMiddleware</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(db *sql.DB, next http.Handler)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">http</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Handler</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> http.HandlerFunc(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(w http.ResponseWriter, r *http.Request)</span></span></span></span> {   userloader := UserLoader{     wait : <span class="hljs-number"><span class="hljs-number">1</span></span> * time.Millisecond,     maxBatch: <span class="hljs-number"><span class="hljs-number">100</span></span>,     fetch: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ids []</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">([]*api.User, []error)</span></span></span></span> {       <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> sqlQuery <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>       <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-built_in"><span class="hljs-built_in">len</span></span>(ids) == <span class="hljs-number"><span class="hljs-number">1</span></span> {         sqlQuery = <span class="hljs-string"><span class="hljs-string">"SELECT id, name, email from users WHERE id = ?"</span></span>       } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> {         sqlQuery = <span class="hljs-string"><span class="hljs-string">"SELECT id, name, email from users WHERE id IN (?)"</span></span>       }       sqlQuery, arguments, err := sqlx.In(sqlQuery, ids)       <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> err != <span class="hljs-literal"><span class="hljs-literal">nil</span></span> {         log.Println(err)       }       sqlQuery = sqlx.Rebind(sqlx.DOLLAR, sqlQuery)       rows, err := dal.LogAndQuery(db, sqlQuery, arguments...)       <span class="hljs-keyword"><span class="hljs-keyword">defer</span></span> rows.Close();       <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> err != <span class="hljs-literal"><span class="hljs-literal">nil</span></span> {         log.Println(err)       }       userById := <span class="hljs-keyword"><span class="hljs-keyword">map</span></span>[<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>]*api.User{}       <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> rows.Next() {         user:= api.User{}         <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> err := rows.Scan(&amp;user.ID, &amp;user.Name, &amp;user.Email); err != <span class="hljs-literal"><span class="hljs-literal">nil</span></span> {           errors.DebugPrintf(err)           <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">nil</span></span>, []error{errors.InternalServerError}         }         userById[user.ID] = &amp;user       }       users := <span class="hljs-built_in"><span class="hljs-built_in">make</span></span>([]*api.User, <span class="hljs-built_in"><span class="hljs-built_in">len</span></span>(ids))       <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> i, id := <span class="hljs-keyword"><span class="hljs-keyword">range</span></span> ids {         users[i] = userById[id]         i++       }       <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> users, <span class="hljs-literal"><span class="hljs-literal">nil</span></span>     },   }   ctx := context.WithValue(r.Context(), CtxKey, &amp;userloader)   r = r.WithContext(ctx)   next.ServeHTTP(w, r) }) }</code> </pre> <br>  Aqui esperamos 1 ms.  antes de executar a solicita√ß√£o e coletar as solicita√ß√µes em pacotes de at√© 100 solicita√ß√µes.  Agora, em vez de executar uma solicita√ß√£o para cada usu√°rio individualmente, o carregador aguardar√° o tempo especificado antes de acessar o banco de dados.  Em seguida, voc√™ precisa alterar a l√≥gica do reconhecedor reconfigurando-a usando a solicita√ß√£o para usar o carregador de dados (arquivo <code>resolver.go</code> ): <br><br><pre> <code class="go hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(r *videoResolver)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">User</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ctx context.Context, obj *api.Video)</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(api.User, error)</span></span></span></span> { user, err := ctx.Value(dataloaders.CtxKey).(*dataloaders.UserLoader).Load(obj.UserID) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> *user, err }</code> </pre> <br>  Veja como os logs cuidam disso em uma situa√ß√£o semelhante √† descrita acima: <br><br><pre> <code class="go hljs">Query: Videos : SELECT id, name, description, url, created_at, user_id FROM videos ORDER BY created_at desc limit $<span class="hljs-number"><span class="hljs-number">1</span></span> offset $<span class="hljs-number"><span class="hljs-number">2</span></span> Dataloader: User : SELECT id, name, email from users WHERE id IN ($<span class="hljs-number"><span class="hljs-number">1</span></span>, $<span class="hljs-number"><span class="hljs-number">2</span></span>, $<span class="hljs-number"><span class="hljs-number">3</span></span>, $<span class="hljs-number"><span class="hljs-number">4</span></span>, $<span class="hljs-number"><span class="hljs-number">5</span></span>)</code> </pre> <br>  Apenas duas consultas ao banco de dados s√£o executadas aqui; como resultado, todos est√£o felizes agora.  √â interessante notar que apenas 5 identificadores de usu√°rios s√£o enviados para a solicita√ß√£o, embora dados sejam solicitados para 8 v√≠deos.  Isso sugere que o carregador de dados remova registros duplicados. <br><br><h3> <font color="#3AC1EF">‚ñç </font> </h3><br> GraphQL   API  ,    .    ,   API   DOS-. <br><br>     ,     . <br><br>   <code>Video</code>  ,   .      GraphQL  <code>Video</code> .           .   ‚Äî  . <br><br>  ,      ‚Äî   : <br><br><pre> <code class="go hljs">{ Videos(limit: <span class="hljs-number"><span class="hljs-number">10</span></span>, offset: <span class="hljs-number"><span class="hljs-number">0</span></span>){   name   url   related(limit: <span class="hljs-number"><span class="hljs-number">10</span></span>, offset: <span class="hljs-number"><span class="hljs-number">0</span></span>){     name     url     related(limit: <span class="hljs-number"><span class="hljs-number">10</span></span>, offset: <span class="hljs-number"><span class="hljs-number">0</span></span>){       name       url       related(limit: <span class="hljs-number"><span class="hljs-number">100</span></span>, offset: <span class="hljs-number"><span class="hljs-number">0</span></span>){         name         url       }     }   } } }</code> </pre> <br>           100,        .  (, , )    ,         . <br><br>  gqlgen      ,     .     ,       ( <code>handler.ComplexityLimit(300)</code>   )   GraphQL     (300   ).  ,     ( <code>server.go</code> ): <br><br><pre> <code class="go hljs">rootHandler:= dataloaders.DataloaderMiddleware( db, handler.GraphQL(   go_graphql_demo.NewExecutableSchema(go_graphql_demo.NewRootResolvers(db)),   handler.ComplexityLimit(<span class="hljs-number"><span class="hljs-number">300</span></span>) ), )</code> </pre> <br>       ,   ,        .        12.   ,       ,   ,      ( ,  ,  ,   ,     ).    <code>resolver.go</code> : <br><br><pre> <code class="go hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">NewRootResolvers</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(db *sql.DB)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Config</span></span></span></span> { c := Config{   Resolvers: &amp;Resolver{     db: db,   }, } <span class="hljs-comment"><span class="hljs-comment">//  countComplexity := func(childComplexity int, limit *int, offset *int) int {   return *limit * childComplexity } c.Complexity.Query.Videos = countComplexity c.Complexity.Video.Related = countComplexity //   c.Directives.IsAuthenticated = func(ctx context.Context, obj interface{}, next graphql.Resolver) (res interface{}, err error) {   ctxUserID := ctx.Value(UserIDCtxKey)   if ctxUserID != nil {     return next(ctx)   } else {     return nil, errors.UnauthorisedError   } } return c }</span></span></code> </pre> <br>     ,     ,       . <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/d0a/702/045/d0a7020450bf5115f69c6a1ba61beca4.png"></div><br> <i><font color="#999999">    </font></i> <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/057/fec/7e3/057fec7e30f98b63aed8bbb6aec5193f.png"></div><br> <i><font color="#999999">      </font></i> <br><br>       ,   ,   <code>related</code>  . , , ,      ,             . <br><br><h2>  <font color="#3AC1EF">Sum√°rio</font> </h2><br> ,        ,    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">GitHub</a> .         .       ,     ,      . <br><br>  <b>Caros leitores!</b>     GraphQL  ,   Go? <br><br> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><img src="https://habrastorage.org/files/1ba/550/d25/1ba550d25e8846ce8805de564da6aa63.png"></a> </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt444346/">https://habr.com/ru/post/pt444346/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt444336/index.html">Listas de captura r√°pidas: qual √© a diferen√ßa entre links fracos, fortes e n√£o propriet√°rios?</a></li>
<li><a href="../pt444338/index.html">Encapsulamento em Python 3</a></li>
<li><a href="../pt444340/index.html">Recursos do uso do tipo de dados Symbol em JavaScript</a></li>
<li><a href="../pt444342/index.html">Desenvolvendo aplicativos JavaScript simples e modernos usando o Webpack e tecnologias avan√ßadas da Web</a></li>
<li><a href="../pt444344/index.html">10 etapas para um projeto Python bem-sucedido</a></li>
<li><a href="../pt444348/index.html">Qual a diferen√ßa entre os componentes funcionais do React e os componentes baseados em classe?</a></li>
<li><a href="../pt444350/index.html">Por algum motivo, o MVP (produto m√≠nimo vi√°vel) n√£o inicia</a></li>
<li><a href="../pt444352/index.html">Kontur.Kampus: convidamos voc√™ para um campo de estudantes de desenvolvimento industrial gratuito perto de S√£o Petersburgo</a></li>
<li><a href="../pt444356/index.html">Tutorial Reagir Parte 24: Segunda li√ß√£o sobre formul√°rios</a></li>
<li><a href="../pt444358/index.html">Enumer√°vel: como gerar um valor comercial</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>