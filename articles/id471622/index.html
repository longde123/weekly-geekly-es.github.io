<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>‚òùüèª üî° ‚úçüèª Xamarin.Forms - Contoh Sederhana Emulasi Kartu Berbasis Host ü•• üçâ üö±</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Pada artikel ini kita akan menerapkan Emulasi Kartu Berbasis Host (HCE, emulasi kartu Bank pada ponsel). Jaringan ini memiliki banyak uraian terperinc...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Xamarin.Forms - Contoh Sederhana Emulasi Kartu Berbasis Host</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/471622/"> Pada artikel ini kita akan menerapkan <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Emulasi Kartu Berbasis Host</a> (HCE, emulasi kartu Bank pada ponsel).  Jaringan ini memiliki banyak uraian terperinci tentang teknologi ini, di sini saya fokus pada mendapatkan emulator dan aplikasi pembaca yang berfungsi dan memecahkan sejumlah masalah praktis.  Ya, Anda akan membutuhkan 2 perangkat dengan nfc. <br><br>  Ada banyak skenario penggunaan: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">sistem lulus</a> , kartu loyalitas, kartu transportasi, memperoleh informasi tambahan tentang pameran di museum, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">pengelola kata sandi</a> . <br><br>  Dalam hal ini, aplikasi pada ponsel yang meniru kartu mungkin atau tidak dapat diluncurkan dan layar ponsel Anda mungkin terkunci. <br><a name="habracut"></a><br>  Untuk Xamarin Android, ada contoh siap pakai dari <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">emulator kartu</a> dan <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">pembaca</a> . <br>  Mari kita coba menggunakan contoh-contoh ini untuk membuat 2 aplikasi Xamarin Forms, sebuah emulator dan pembaca, dan memecahkan masalah-masalah berikut di dalamnya: <br><br><ol><li>  menampilkan data dari emulator pada layar pembaca </li><li>  menampilkan data dari pembaca di layar emulator </li><li>  emulator harus bekerja dengan aplikasi yang belum dirilis dan layar yang terkunci </li><li>  kontrol pengaturan emulator </li><li>  luncurkan aplikasi emulator ketika pembaca terdeteksi </li><li>  memeriksa status adaptor nfc dan beralih ke pengaturan nfc </li></ol><br>  Artikel ini tentang android, oleh karena itu, jika Anda memiliki aplikasi juga untuk iOS, maka harus ada implementasi yang terpisah. <br><br>  Minimal teori. <br><br>  Seperti yang tertulis dalam <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">dokumentasi android</a> , dimulai dengan versi 4.4 (kitkat), kemampuan untuk meniru kartu ISO-DEP dan memproses perintah APDU telah ditambahkan. <br><br>  Emulasi kartu didasarkan pada layanan android yang dikenal sebagai ‚Äúlayanan HCE‚Äù. <br><br>  Ketika pengguna memasang perangkat ke pembaca NFC, android perlu memahami layanan HCE mana yang ingin dihubungkan oleh pembaca.  ISO / IEC 7816-4 menjelaskan metode pemilihan aplikasi berdasarkan ID Aplikasi (AID). <br><br>  Jika menarik untuk mempelajari dunia array byte yang indah, maka di <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">sini</a> dan di <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">sini</a> lebih rinci tentang perintah APDU.  Artikel ini hanya menggunakan beberapa perintah yang diperlukan untuk bertukar data. <br><br><h3>  Aplikasi pembaca </h3><br>  Mari kita mulai dengan pembaca, karena  ini lebih sederhana. <br><br>  Kami membuat proyek baru di Visual Studio seperti "Aplikasi Seluler (Xamarin.Forms)", lalu pilih templat "Kosong" dan hanya meninggalkan tanda centang "Android" di bagian "Platform". <br><br>  Dalam proyek android Anda perlu melakukan hal berikut: <br><br><ul><li>  Kelas CardReader - berisi beberapa konstanta dan metode OnTagDiscovered </li><li>  MainActivity - inisialisasi kelas CardReader, serta metode OnPause dan OnResume untuk menghidupkan / mematikan pembaca saat meminimalkan aplikasi </li><li>  AndroidManifest.xml - izin untuk nfc </li></ul><br>  Dan dalam proyek lintas platform dalam file App.xaml.cs: <br><br><ul><li>  Metode untuk menampilkan pesan kepada pengguna </li></ul><br><h4>  Kelas CardReader </h4><br><pre><code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">using</span></span> Android.Nfc; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> Android.Nfc.Tech; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Linq; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Text; <span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">ApduServiceReaderApp.Droid.Services</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">CardReader</span></span> : <span class="hljs-title"><span class="hljs-title">Java</span></span>.<span class="hljs-title"><span class="hljs-title">Lang</span></span>.<span class="hljs-title"><span class="hljs-title">Object</span></span>, <span class="hljs-title"><span class="hljs-title">NfcAdapter</span></span>.<span class="hljs-title"><span class="hljs-title">IReaderCallback</span></span> { <span class="hljs-comment"><span class="hljs-comment">// ISO-DEP command HEADER for selecting an AID. // Format: [Class | Instruction | Parameter 1 | Parameter 2] private static readonly byte[] SELECT_APDU_HEADER = new byte[] { 0x00, 0xA4, 0x04, 0x00 }; // AID for our loyalty card service. private static readonly string SAMPLE_LOYALTY_CARD_AID = "F123456789"; // "OK" status word sent in response to SELECT AID command (0x9000) private static readonly byte[] SELECT_OK_SW = new byte[] { 0x90, 0x00 }; public async void OnTagDiscovered(Tag tag) { IsoDep isoDep = IsoDep.Get(tag); if (isoDep != null) { try { isoDep.Connect(); var aidLength = (byte)(SAMPLE_LOYALTY_CARD_AID.Length / 2); var aidBytes = StringToByteArray(SAMPLE_LOYALTY_CARD_AID); var command = SELECT_APDU_HEADER .Concat(new byte[] { aidLength }) .Concat(aidBytes) .ToArray(); var result = isoDep.Transceive(command); var resultLength = result.Length; byte[] statusWord = { result[resultLength - 2], result[resultLength - 1] }; var payload = new byte[resultLength - 2]; Array.Copy(result, payload, resultLength - 2); var arrayEquals = SELECT_OK_SW.Length == statusWord.Length; if (Enumerable.SequenceEqual(SELECT_OK_SW, statusWord)) { var msg = Encoding.UTF8.GetString(payload); await App.DisplayAlertAsync(msg); } } catch (Exception e) { await App.DisplayAlertAsync("Error communicating with card: " + e.Message); } } } public static byte[] StringToByteArray(string hex) =&gt; Enumerable.Range(0, hex.Length) .Where(x =&gt; x % 2 == 0) .Select(x =&gt; Convert.ToByte(hex.Substring(x, 2), 16)) .ToArray(); } }</span></span></code> </pre> <br>  Dalam mode baca adaptor nfc, ketika kartu terdeteksi, metode OnTagDiscovered akan dipanggil.  Di dalamnya, IsoDep adalah objek yang dengannya kita akan bertukar perintah dengan peta (isoDep.Transceive (perintah)).  Perintah adalah byte array. <br><br>  Kode menunjukkan bahwa kami mengirimkan emulator urutan yang terdiri dari header SELECT_APDU_HEADER, panjang AID kami dalam byte, dan AID itu sendiri: <br><br><pre> <code class="plaintext hljs">0 164 4 0 // SELECT_APDU_HEADER 5 //  AID   241 35 69 103 137 // SAMPLE_LOYALTY_CARD_AID (F1 23 45 67 89)</code> </pre><br><h4>  MainActivity Reader </h4><br>  Di sini Anda perlu mendeklarasikan bidang pembaca: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> CardReader cardReader;</code> </pre><br>  dan dua metode pembantu: <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">EnableReaderMode</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> nfc = NfcAdapter.GetDefaultAdapter(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (nfc != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) nfc.EnableReaderMode(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>, cardReader, READER_FLAGS, <span class="hljs-literal"><span class="hljs-literal">null</span></span>); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">DisableReaderMode</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> nfc = NfcAdapter.GetDefaultAdapter(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (nfc != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) nfc.DisableReaderMode(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>); }</code> </pre><br>  dalam metode OnCreate (), inisialisasi pembaca dan aktifkan mode baca: <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OnCreate</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Bundle savedInstanceState</span></span></span><span class="hljs-function">)</span></span> { ... cardReader = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> CardReader(); EnableReaderMode(); LoadApplication(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> App()); }</code> </pre><br>  dan juga, aktifkan / nonaktifkan mode membaca ketika meminimalkan / membuka aplikasi: <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OnPause</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">base</span></span>.OnPause(); DisableReaderMode(); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OnResume</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">base</span></span>.OnResume(); EnableReaderMode(); }</code> </pre><br><h4>  App.xaml.cs </h4><br>  Metode statis untuk menampilkan pesan: <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">async</span></span></span><span class="hljs-function"> Task </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">DisplayAlertAsync</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> msg</span></span></span><span class="hljs-function">)</span></span> =&gt; <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> Device.InvokeOnMainThreadAsync(<span class="hljs-keyword"><span class="hljs-keyword">async</span></span> () =&gt; <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> Current.MainPage.DisplayAlert(<span class="hljs-string"><span class="hljs-string">"message from service"</span></span>, msg, <span class="hljs-string"><span class="hljs-string">"ok"</span></span>));</code> </pre><br><h4>  AndroidManifest.xml </h4><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Dokumentasi android</a> mengatakan bahwa untuk menggunakan nfc di aplikasi Anda dan bekerja dengan benar, Anda perlu mendeklarasikan elemen-elemen ini di AndroidManifest.xml: <br><br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">uses-permission</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"android.permission.NFC"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">uses-sdk</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:minSdkVersion</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"10"</span></span></span><span class="hljs-tag">/&gt;</span></span>   <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">uses-sdk</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:minSdkVersion</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"14"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">uses-feature</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"android.hardware.nfc"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:required</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"true"</span></span></span><span class="hljs-tag"> /&gt;</span></span></code> </pre><br>  Pada saat yang sama, jika aplikasi Anda dapat menggunakan nfc, tetapi ini bukan fungsi yang diperlukan, maka Anda dapat melewati elemen fitur-penggunaan dan memeriksa ketersediaan nfc selama operasi. <br><br>  Itu saja untuk pembaca. <br><br><h3>  Aplikasi emulator </h3><br>  Sekali lagi, buat proyek baru di Visual Studio seperti "Aplikasi Seluler (Xamarin.Forms)", lalu pilih templat "Kosong" dan tinggalkan hanya tanda centang "Android" di bagian "Platform". <br><br>  Dalam proyek Android, lakukan hal berikut: <br><br><ul><li>  Kelas CardService - Anda memerlukan konstanta dan metode ProcessCommandApdu (), serta metode SendMessageToActivity () </li><li>  Deskripsi layanan di aid_list.xml </li><li>  Mekanisme pengiriman pesan di MainActivity </li><li>  Peluncuran aplikasi (jika perlu) </li><li>  AndroidManifest.xml - izin untuk nfc </li></ul><br>  Dan dalam proyek lintas platform dalam file App.xaml.cs: <br><br><ul><li>  Metode untuk menampilkan pesan kepada pengguna </li></ul><br><h4>  Kelas CardService </h4><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">using</span></span> Android.App; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> Android.Content; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> Android.Nfc.CardEmulators; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> Android.OS; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Linq; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Text; <span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">ApduServiceCardApp.Droid.Services</span></span> { [Service(Exported = <span class="hljs-literal"><span class="hljs-literal">true</span></span>, Enabled = <span class="hljs-literal"><span class="hljs-literal">true</span></span>, Permission = <span class="hljs-string"><span class="hljs-string">"android.permission.BIND_NFC_SERVICE"</span></span>), IntentFilter(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span>[] { <span class="hljs-string"><span class="hljs-string">"android.nfc.cardemulation.action.HOST_APDU_SERVICE"</span></span> }, Categories = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span>[] { <span class="hljs-string"><span class="hljs-string">"android.intent.category.DEFAULT"</span></span> }), MetaData(<span class="hljs-string"><span class="hljs-string">"android.nfc.cardemulation.host_apdu_service"</span></span>, Resource = <span class="hljs-string"><span class="hljs-string">"@xml/aid_list"</span></span>)] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">CardService</span></span> : <span class="hljs-title"><span class="hljs-title">HostApduService</span></span> { <span class="hljs-comment"><span class="hljs-comment">// ISO-DEP command HEADER for selecting an AID. // Format: [Class | Instruction | Parameter 1 | Parameter 2] private static readonly byte[] SELECT_APDU_HEADER = new byte[] { 0x00, 0xA4, 0x04, 0x00 }; // "OK" status word sent in response to SELECT AID command (0x9000) private static readonly byte[] SELECT_OK_SW = new byte[] { 0x90, 0x00 }; // "UNKNOWN" status word sent in response to invalid APDU command (0x0000) private static readonly byte[] UNKNOWN_CMD_SW = new byte[] { 0x00, 0x00 }; public override byte[] ProcessCommandApdu(byte[] commandApdu, Bundle extras) { if (commandApdu.Length &gt;= SELECT_APDU_HEADER.Length &amp;&amp; Enumerable.SequenceEqual(commandApdu.Take(SELECT_APDU_HEADER.Length), SELECT_APDU_HEADER)) { var hexString = string.Join("", Array.ConvertAll(commandApdu, b =&gt; b.ToString("X2"))); SendMessageToActivity($"Recieved message from reader: {hexString}"); var messageToReader = "Hello Reader!"; var messageToReaderBytes = Encoding.UTF8.GetBytes(messageToReader); return messageToReaderBytes.Concat(SELECT_OK_SW).ToArray(); } return UNKNOWN_CMD_SW; } public override void OnDeactivated(DeactivationReason reason) { } private void SendMessageToActivity(string msg) { Intent intent = new Intent("MSG_NAME"); intent.PutExtra("MSG_DATA", msg); SendBroadcast(intent); } } }</span></span></code> </pre><br>  Setelah menerima perintah APDU dari pembaca, metode ProcessCommandApdu akan dipanggil dan perintah akan ditransfer ke sana sebagai array byte. <br><br>  Pertama, kami memverifikasi bahwa pesan dimulai dengan SELECT_APDU_HEADER dan, jika demikian, buat tanggapan kepada pembaca.  Pada kenyataannya, pertukaran dapat terjadi dalam beberapa langkah, tanya-jawab, tanya-jawab, dll. <br><br>  Sebelum kelas, atribut Layanan menjelaskan parameter dari layanan android.  Saat membangun, xamarin mengubah deskripsi ini menjadi elemen seperti di AndroidManifest.xml: <br><br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">service</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">'md51c8b1c564e9c74403ac6103c28fa46ff.CardService'</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">permission</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">'android.permission.BIND_NFC_SERVICE'</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">enabled</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">'true'</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">exported</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">'true'</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">meta-data</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">'android.nfc.cardemulation.host_apdu_service'</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">resource</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">'@res/0x7F100000'</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">meta-data</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">intent-filter</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">action</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">'android.nfc.cardemulation.action.HOST_APDU_SERVICE'</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">action</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">category</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">'android.intent.category.DEFAULT'</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">category</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">intent-filter</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">service</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br><h4>  Deskripsi layanan di aid_list.xml </h4><br>  Di folder xml, buat file aid_list.xml: <br><br><pre> <code class="xml hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?xml version="1.0" encoding="utf-8"?&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">host-apdu-service</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">xmlns:android</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"http://schemas.android.com/apk/res/android"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:description</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"@string/service_name"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:requireDeviceUnlock</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"false"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">aid-group</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:description</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"@string/card_title"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:category</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"other"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">aid-filter</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"F123456789"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">aid-group</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">host-apdu-service</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br>  Referensi untuk itu adalah dalam atribut Layanan di kelas CardService - Resource = "@ xml / aid_list" <br>  Di sini kita mengatur BANTUAN aplikasi kita, yang menurutnya pembaca akan mengaksesnya dan atribut tersebut memerlukanDeviceUnlock = "false" sehingga kartu dibaca dengan layar yang tidak terkunci. <br><br>  Ada 2 konstanta dalam kode: <code>@string/service_name</code> dan <code>@string/card_title</code> .  Mereka dideklarasikan dalam file values ‚Äã‚Äã/ strings.xml: <br><br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">resources</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">string</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"card_title"</span></span></span><span class="hljs-tag">&gt;</span></span>My Loyalty Card<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">string</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">string</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"service_name"</span></span></span><span class="hljs-tag">&gt;</span></span>My Company<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">string</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">resources</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br><h4>  Mekanisme pengiriman pesan: </h4><br>  Layanan tidak memiliki tautan ke MainActivity, yang pada saat menerima perintah APDU bahkan mungkin tidak dimulai.  Oleh karena itu, kami mengirim pesan dari CardService ke MainActivity menggunakan BroadcastReceiver sebagai berikut: <br><br>  Metode untuk mengirim pesan dari CardService: <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">SendMessageToActivity</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> msg</span></span></span><span class="hljs-function">)</span></span> { Intent intent = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Intent(<span class="hljs-string"><span class="hljs-string">"MSG_NAME"</span></span>); intent.PutExtra(<span class="hljs-string"><span class="hljs-string">"MSG_DATA"</span></span>, msg); SendBroadcast(intent); }</code> </pre><br>  Menerima pesan: <br>  Buat kelas MessageReceiver: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">using</span></span> Android.Content; <span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">ApduServiceCardApp.Droid.Services</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">MessageReceiver</span></span> : <span class="hljs-title"><span class="hljs-title">BroadcastReceiver</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">async</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OnReceive</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Context context, Intent intent</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> message = intent.GetStringExtra(<span class="hljs-string"><span class="hljs-string">"MSG_DATA"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> App.DisplayAlertAsync(message); } } }</code> </pre><br>  Daftarkan MessageReceiver di MainActivity: <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OnCreate</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Bundle savedInstanceState</span></span></span><span class="hljs-function">)</span></span> { ... <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> receiver = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> MessageReceiver(); RegisterReceiver(receiver, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> IntentFilter(<span class="hljs-string"><span class="hljs-string">"MSG_NAME"</span></span>)); LoadApplication(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> App()); }</code> </pre><br><h4>  App.xaml.cs </h4><br>  Sama seperti pada metode pembaca untuk menampilkan pesan: <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">async</span></span></span><span class="hljs-function"> Task </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">DisplayAlertAsync</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> msg</span></span></span><span class="hljs-function">)</span></span> =&gt; <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> Device.InvokeOnMainThreadAsync(<span class="hljs-keyword"><span class="hljs-keyword">async</span></span> () =&gt; <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> Current.MainPage.DisplayAlert(<span class="hljs-string"><span class="hljs-string">"message from service"</span></span>, msg, <span class="hljs-string"><span class="hljs-string">"ok"</span></span>));</code> </pre><br><h4>  AndroidManifest.xml </h4><br><pre> <code class="xml hljs"> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">uses-feature</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"android.hardware.nfc.hce"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:required</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"true"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">uses-feature</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"FEATURE_NFC_HOST_CARD_EMULATION"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">uses-permission</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"android.permission.NFC"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">uses-permission</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"android.permission.BIND_NFC_SERVICE"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">uses-sdk</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:minSdkVersion</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"10"</span></span></span><span class="hljs-tag">/&gt;</span></span>  14</code> </pre><br>  Saat ini, kami sudah memiliki fungsi-fungsi berikut: <br><br><ul><li>  menampilkan data dari emulator pada layar pembaca </li><li>  menampilkan data dari pembaca di layar emulator </li><li>  Emulator harus bekerja dengan aplikasi yang tidak berjalan dan layar dimatikan. </li></ul><br>  Selanjutnya <br><br><h4>  Kontrol emulator </h4><br>  Saya akan menyimpan pengaturan menggunakan Xamarin.Essentials. <br><br>  Mari kita lakukan ini: ketika kita me-restart aplikasi emulator, kita akan memperbarui pengaturan: <br><br><pre> <code class="cs hljs">Xamarin.Essentials.Preferences.Set(<span class="hljs-string"><span class="hljs-string">"key1"</span></span>, Guid.NewGuid().ToString());</code> </pre><br>  dan dalam metode ProcessCommandApdu kami akan mengambil nilai ini lagi setiap kali: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> messageToReader = <span class="hljs-string"><span class="hljs-string">$"Hello Reader! - </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{Xamarin.Essentials.Preferences.Get(</span></span><span class="hljs-string"><span class="hljs-string"><span class="hljs-subst"><span class="hljs-string">"key1"</span></span></span></span><span class="hljs-string"><span class="hljs-subst">, </span></span><span class="hljs-string"><span class="hljs-string"><span class="hljs-subst"><span class="hljs-string">"key1 not found"</span></span></span></span><span class="hljs-string"><span class="hljs-subst">)}</span></span></span><span class="hljs-string">"</span></span>;</code> </pre><br>  Sekarang setiap kali Anda me-restart (tidak meminimalkan) aplikasi emulator, kami melihat panduan baru, misalnya: <br><br><pre> <code class="plaintext hljs">Hello Reader! - 76324a99-b5c3-46bc-8678-5650dab0529d</code> </pre> <br>  Juga, melalui pengaturan, hidupkan / matikan emulator: <br><br><pre> <code class="cs hljs">Xamarin.Essentials.Preferences.Set(<span class="hljs-string"><span class="hljs-string">"IsEnabled"</span></span>, <span class="hljs-literal"><span class="hljs-literal">false</span></span>);</code> </pre><br>  dan pada awal metode ProcessCommandApdu tambahkan: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> IsEnabled = Xamarin.Essentials.Preferences.Get(<span class="hljs-string"><span class="hljs-string">"IsEnabled"</span></span>, <span class="hljs-literal"><span class="hljs-literal">false</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!IsEnabled) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> UNKNOWN_CMD_SW; <span class="hljs-comment"><span class="hljs-comment">// 0x00, 0x00</span></span></code> </pre><br>  Ini cara yang mudah, tetapi ada yang <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">lain</a> . <br><br><h4>  Menjalankan aplikasi emulator ketika pembaca terdeteksi </h4><br>  Jika Anda hanya perlu membuka aplikasi emulator, kemudian tambahkan baris dalam metode ProcessCommandApdu: <br><br><pre> <code class="cs hljs">StartActivity(<span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(MainActivity));</code> </pre><br>  Jika Anda perlu memberikan parameter ke aplikasi, maka seperti ini: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> activity = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Intent(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(MainActivity)); intent.PutExtra(<span class="hljs-string"><span class="hljs-string">"MSG_DATA"</span></span>, <span class="hljs-string"><span class="hljs-string">"data for application"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.StartActivity(activity);</code> </pre><br>  Anda dapat membaca parameter yang diteruskan di kelas MainActivity dalam metode OnCreate: <br><br><pre> <code class="cs hljs">... LoadApplication(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> App()); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Intent.Extras != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> message = Intent.Extras.GetString(<span class="hljs-string"><span class="hljs-string">"MSG_DATA"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> App.DisplayAlertAsync(message); }</code> </pre><br><h4>  Memeriksa status adaptor nfc dan beralih ke pengaturan nfc </h4><br>  Bagian ini berlaku untuk pembaca dan emulator. <br><br>  Buat NfcHelper di proyek android dan gunakan DependencyService untuk mengaksesnya dari kode halaman MainPage. <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">using</span></span> Android.App; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> Android.Content; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> Android.Nfc; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> ApduServiceCardApp.Services; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> Xamarin.Forms; [assembly: Dependency(<span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(ApduServiceCardApp.Droid.Services.NfcHelper))] <span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">ApduServiceCardApp.Droid.Services</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">NfcHelper</span></span> : <span class="hljs-title"><span class="hljs-title">INfcHelper</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> NfcAdapterStatus </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetNfcAdapterStatus</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> adapter = NfcAdapter.GetDefaultAdapter(Forms.Context <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> Activity); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> adapter == <span class="hljs-literal"><span class="hljs-literal">null</span></span> ? NfcAdapterStatus.NoAdapter : adapter.IsEnabled ? NfcAdapterStatus.Enabled : NfcAdapterStatus.Disabled; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GoToNFCSettings</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> intent = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Intent(Android.Provider.Settings.ActionNfcSettings); intent.AddFlags(ActivityFlags.NewTask); Android.App.Application.Context.StartActivity(intent); } } }</code> </pre><br>  Sekarang dalam proyek lintas-platform, tambahkan antarmuka INfcHelper: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">ApduServiceCardApp.Services</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">interface</span></span> <span class="hljs-title"><span class="hljs-title">INfcHelper</span></span> { <span class="hljs-function"><span class="hljs-function">NfcAdapterStatus </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetNfcAdapterStatus</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GoToNFCSettings</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">enum</span></span> NfcAdapterStatus { Enabled, Disabled, NoAdapter } }</code> </pre><br>  dan gunakan semua ini dalam kode MainPage.xaml.cs: <br><br><pre> <code class="cs hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">async</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OnAppearing</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">base</span></span>.OnAppearing(); <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> CheckNfc(); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">async</span></span></span><span class="hljs-function"> Task </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CheckNfc</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> nfcHelper = DependencyService.Get&lt;INfcHelper&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> status = nfcHelper.GetNfcAdapterStatus(); <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> (status) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> NfcAdapterStatus.Enabled: <span class="hljs-keyword"><span class="hljs-keyword">default</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> App.DisplayAlertAsync(<span class="hljs-string"><span class="hljs-string">"nfc enabled!"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> NfcAdapterStatus.Disabled: nfcHelper.GoToNFCSettings(); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> NfcAdapterStatus.NoAdapter: <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> App.DisplayAlertAsync(<span class="hljs-string"><span class="hljs-string">"no nfc adapter found!"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } }</code> </pre><br><h4>  Tautan GitHub </h4><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">emulator</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">pembaca</a> </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/id471622/">https://habr.com/ru/post/id471622/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../id471608/index.html">Sistem penghindaran benturan: Bagian 1. Undang-undang sebagai TK untuk pengembang</a></li>
<li><a href="../id471610/index.html">Server REST di Prolog, seperti apa bentuknya?</a></li>
<li><a href="../id471614/index.html">Rilis Rustup 1.20.0: dukungan untuk profil, peningkatan dalam pembaruan dan perintah doc</a></li>
<li><a href="../id471618/index.html">C / C ++ dari Python (boost)</a></li>
<li><a href="../id471620/index.html">Strategi penyebaran di Kubernet: bergulir, diciptakan kembali, biru / hijau, kenari, gelap (pengujian A / B)</a></li>
<li><a href="../id471624/index.html">Memberikan presentasi dengan desain UI / UX yang sempurna</a></li>
<li><a href="../id471626/index.html">AI for people: kata-kata sederhana tentang teknologi</a></li>
<li><a href="../id471628/index.html">Saya seorang diri refactored 15 ribu garis warisan. Itu adalah dua minggu terburuk dalam hidupku</a></li>
<li><a href="../id471630/index.html">Kesenangan terlarang: di negara mana PornHub diblokir dan mengapa</a></li>
<li><a href="../id471634/index.html">Cara membangun pemasaran email di perusahaan dan menghindari masalah: 6 langkah praktis</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>