<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üëÇüèΩ üê± üë©üèΩ‚Äçüé§ DIY Autoscaling dengan AWX, Ansible, haproxy, dan CROC Cloud üï∫üèº ü§õ üë©‚Äçüè≠</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Beberapa waktu yang lalu, kami melakukan pemantauan Agentless dan alarm untuk itu. Ini adalah analog dari CloudWatch di AWS dengan API yang kompatibel...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>DIY Autoscaling dengan AWX, Ansible, haproxy, dan CROC Cloud</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/croccloudteam/blog/456826/"><p><img src="https://habrastorage.org/webt/6f/nt/tj/6fnttjgdk8vat9bbsahsnck_rfa.jpeg" alt="gambar"></p><br><p>  Beberapa waktu yang lalu, kami melakukan pemantauan Agentless dan alarm untuk itu.  Ini adalah analog dari CloudWatch di AWS dengan API yang kompatibel.  Sekarang kami sedang mengerjakan balancers dan penskalaan otomatis.  Tetapi sementara kami tidak menyediakan layanan seperti itu, kami menawarkan pelanggan kami untuk melakukannya sendiri, menggunakan pemantauan dan tag kami (AWS Resource Tagging API) sebagai penemuan layanan sederhana sebagai sumber data.  Kami akan menunjukkan cara melakukan ini di posting ini. </p><a name="habracut"></a><br><p>  Contoh infrastruktur minimal layanan web sederhana: DNS -&gt; 2 balancers -&gt; 2 backend.  Infrastruktur ini dapat dianggap sebagai minimum yang diperlukan untuk operasi dan pemeliharaan yang toleran terhadap kesalahan.  Karena alasan ini, kami tidak akan ‚Äúmenekan‚Äù infrastruktur ini lebih jauh lagi, hanya menyisakan, hanya satu backend.  Tetapi saya ingin menambah jumlah server backend dan mengurangi menjadi dua.  Ini akan menjadi tugas kita.  Semua contoh tersedia di <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">repositori</a> . </p><br><h3 id="bazovaya-infrastruktura">  Infrastruktur dasar </h3><br><p>  Kami tidak akan membahas secara terperinci tentang konfigurasi infrastruktur di atas, kami hanya akan menunjukkan cara membuatnya.  Kami lebih memilih untuk menggunakan infrastruktur menggunakan Terraform.  Ini membantu untuk dengan cepat membuat semua yang Anda butuhkan (VPC, Subnet, Security Group, VMs) dan ulangi prosedur ini berulang-ulang. </p><br><p>  Skrip untuk meningkatkan infrastruktur dasar: </p><br><div class="spoiler">  <b class="spoiler_title">main.tf</b> <div class="spoiler_text"><pre><code class="bash hljs">variable <span class="hljs-string"><span class="hljs-string">"ec2_url"</span></span> {} variable <span class="hljs-string"><span class="hljs-string">"access_key"</span></span> {} variable <span class="hljs-string"><span class="hljs-string">"secret_key"</span></span> {} variable <span class="hljs-string"><span class="hljs-string">"region"</span></span> {} variable <span class="hljs-string"><span class="hljs-string">"vpc_cidr_block"</span></span> {} variable <span class="hljs-string"><span class="hljs-string">"instance_type"</span></span> {} variable <span class="hljs-string"><span class="hljs-string">"big_instance_type"</span></span> {} variable <span class="hljs-string"><span class="hljs-string">"az"</span></span> {} variable <span class="hljs-string"><span class="hljs-string">"ami"</span></span> {} variable <span class="hljs-string"><span class="hljs-string">"client_ip"</span></span> {} variable <span class="hljs-string"><span class="hljs-string">"material"</span></span> {} provider <span class="hljs-string"><span class="hljs-string">"aws"</span></span> { endpoints { ec2 = <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">${var.ec2_url}</span></span></span><span class="hljs-string">"</span></span> } skip_credentials_validation = <span class="hljs-literal"><span class="hljs-literal">true</span></span> skip_requesting_account_id = <span class="hljs-literal"><span class="hljs-literal">true</span></span> skip_region_validation = <span class="hljs-literal"><span class="hljs-literal">true</span></span> access_key = <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">${var.access_key}</span></span></span><span class="hljs-string">"</span></span> secret_key = <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">${var.secret_key}</span></span></span><span class="hljs-string">"</span></span> region = <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">${var.region}</span></span></span><span class="hljs-string">"</span></span> } resource <span class="hljs-string"><span class="hljs-string">"aws_vpc"</span></span> <span class="hljs-string"><span class="hljs-string">"vpc"</span></span> { cidr_block = <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">${var.vpc_cidr_block}</span></span></span><span class="hljs-string">"</span></span> } resource <span class="hljs-string"><span class="hljs-string">"aws_subnet"</span></span> <span class="hljs-string"><span class="hljs-string">"subnet"</span></span> { availability_zone = <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">${var.az}</span></span></span><span class="hljs-string">"</span></span> vpc_id = <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">${aws_vpc.vpc.id}</span></span></span><span class="hljs-string">"</span></span> cidr_block = <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">${cidrsubnet(aws_vpc.vpc.cidr_block, 8, 0)}</span></span></span><span class="hljs-string">"</span></span> } resource <span class="hljs-string"><span class="hljs-string">"aws_security_group"</span></span> <span class="hljs-string"><span class="hljs-string">"sg"</span></span> { name = <span class="hljs-string"><span class="hljs-string">"auto-scaling"</span></span> vpc_id = <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">${aws_vpc.vpc.id}</span></span></span><span class="hljs-string">"</span></span> ingress { from_port = 22 to_port = 22 protocol = <span class="hljs-string"><span class="hljs-string">"tcp"</span></span> cidr_blocks = [<span class="hljs-string"><span class="hljs-string">"0.0.0.0/0"</span></span>] } ingress { from_port = 80 to_port = 80 protocol = <span class="hljs-string"><span class="hljs-string">"tcp"</span></span> cidr_blocks = [<span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">${cidrsubnet(aws_vpc.vpc.cidr_block, 8, 0)}</span></span></span><span class="hljs-string">"</span></span>] } ingress { from_port = 8080 to_port = 8080 protocol = <span class="hljs-string"><span class="hljs-string">"tcp"</span></span> cidr_blocks = [<span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">${cidrsubnet(aws_vpc.vpc.cidr_block, 8, 0)}</span></span></span><span class="hljs-string">"</span></span>] } egress { from_port = 0 to_port = 0 protocol = <span class="hljs-string"><span class="hljs-string">"-1"</span></span> cidr_blocks = [<span class="hljs-string"><span class="hljs-string">"0.0.0.0/0"</span></span>] } } resource <span class="hljs-string"><span class="hljs-string">"aws_key_pair"</span></span> <span class="hljs-string"><span class="hljs-string">"key"</span></span> { key_name = <span class="hljs-string"><span class="hljs-string">"auto-scaling-new"</span></span> public_key = <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">${var.material}</span></span></span><span class="hljs-string">"</span></span> } resource <span class="hljs-string"><span class="hljs-string">"aws_instance"</span></span> <span class="hljs-string"><span class="hljs-string">"compute"</span></span> { count = 5 ami = <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">${var.ami}</span></span></span><span class="hljs-string">"</span></span> instance_type = <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">${count.index == 0 ? var.big_instance_type : var.instance_type}</span></span></span><span class="hljs-string">"</span></span> key_name = <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">${aws_key_pair.key.key_name}</span></span></span><span class="hljs-string">"</span></span> subnet_id = <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">${aws_subnet.subnet.id}</span></span></span><span class="hljs-string">"</span></span> availability_zone = <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">${var.az}</span></span></span><span class="hljs-string">"</span></span> security_groups = [<span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">${aws_security_group.sg.id}</span></span></span><span class="hljs-string">"</span></span>] } resource <span class="hljs-string"><span class="hljs-string">"aws_eip"</span></span> <span class="hljs-string"><span class="hljs-string">"pub_ip"</span></span> { instance = <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">${aws_instance.compute.0.id}</span></span></span><span class="hljs-string">"</span></span> vpc = <span class="hljs-literal"><span class="hljs-literal">true</span></span> } output <span class="hljs-string"><span class="hljs-string">"awx"</span></span> { value = <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">${aws_eip.pub_ip.public_ip}</span></span></span><span class="hljs-string">"</span></span> } output <span class="hljs-string"><span class="hljs-string">"haproxy_id"</span></span> { value = [<span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">${slice(aws_instance.compute.*.id, 1, 3)}</span></span></span><span class="hljs-string">"</span></span>] } output <span class="hljs-string"><span class="hljs-string">"awx_id"</span></span> { value = <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">${aws_instance.compute.0.id}</span></span></span><span class="hljs-string">"</span></span> } output <span class="hljs-string"><span class="hljs-string">"backend_id"</span></span> { value = [<span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">${slice(aws_instance.compute.*.id, 3, 5)}</span></span></span><span class="hljs-string">"</span></span>] }</code> </pre> </div></div><br><p>  Semua entitas yang dijelaskan dalam konfigurasi ini, tampaknya, harus dipahami oleh pengguna rata-rata cloud modern.  Variabel khusus untuk cloud kami dan untuk tugas tertentu dipindahkan ke file terpisah - terraform.tfvars: </p><br><div class="spoiler">  <b class="spoiler_title">terraform.tfvars</b> <div class="spoiler_text"><pre> <code class="bash hljs">ec2_url = <span class="hljs-string"><span class="hljs-string">"https://api.cloud.croc.ru"</span></span> access_key = <span class="hljs-string"><span class="hljs-string">"project:user@customer"</span></span> secret_key = <span class="hljs-string"><span class="hljs-string">"secret-key"</span></span> region = <span class="hljs-string"><span class="hljs-string">"croc"</span></span> az = <span class="hljs-string"><span class="hljs-string">"ru-msk-vol51"</span></span> instance_type = <span class="hljs-string"><span class="hljs-string">"m1.2small"</span></span> big_instance_type = <span class="hljs-string"><span class="hljs-string">"m1.large"</span></span> vpc_cidr_block = <span class="hljs-string"><span class="hljs-string">"10.10.0.0/16"</span></span> ami = <span class="hljs-string"><span class="hljs-string">"cmi-3F5B011E"</span></span></code> </pre> </div></div><br><p>  Luncurkan Terraform: </p><br><div class="spoiler">  <b class="spoiler_title">terraform berlaku</b> <div class="spoiler_text"><pre> <code class="bash hljs">yes yes | terraform apply -var client_ip=<span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$(curl -s ipinfo.io/ip)</span></span></span><span class="hljs-string">/32"</span></span> -var material=<span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$(cat &lt;ssh_publick_key_path&gt;)</span></span></span><span class="hljs-string">"</span></span></code> </pre> </div></div><br><h3 id="nastroyka-monitoringa">  Pengaturan pemantauan </h3><br><p>  VM yang diluncurkan di atas secara otomatis dimonitor oleh cloud kami.  Data pemantauan ini akan menjadi sumber informasi untuk autoscaling di masa depan.  Mengandalkan metrik tertentu kita dapat menambah atau mengurangi daya. </p><br><p>  Pemantauan di cloud kami memungkinkan Anda untuk mengonfigurasi alarm sesuai dengan kondisi yang berbeda untuk metrik yang berbeda.  Sangat nyaman.  Kami tidak perlu menganalisis metrik pada interval apa pun dan membuat keputusan - ini akan dilakukan dengan pemantauan cloud.  Dalam contoh ini, kami akan menggunakan alarm untuk metrik CPU, tetapi dalam pemantauan kami mereka juga dapat dikonfigurasi untuk metrik seperti: pemanfaatan jaringan (kecepatan / pps), pemanfaatan disk (kecepatan / iops). </p><br><div class="spoiler">  <b class="spoiler_title">cloudwatch put-metric-alarm</b> <div class="spoiler_text"><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">export</span></span> CLOUDWATCH_URL=https://monitoring.cloud.croc.ru <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> instance_id <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> &lt;backend_instance_ids&gt;; <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> \ aws --profile &lt;aws_cli_profile&gt; --endpoint-url <span class="hljs-variable"><span class="hljs-variable">$CLOUDWATCH_URL</span></span> \ cloudwatch put-metric-alarm \ --alarm-name <span class="hljs-string"><span class="hljs-string">"scaling-low_</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$instance_id</span></span></span><span class="hljs-string">"</span></span> \ --dimensions Name=InstanceId,Value=<span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$instance_id</span></span></span><span class="hljs-string">"</span></span> \ --namespace <span class="hljs-string"><span class="hljs-string">"AWS/EC2"</span></span> --metric-name CPUUtilization --statistic Average \ --period 60 --evaluation-periods 3 --threshold 15 --comparison-operator LessThanOrEqualToThreshold; <span class="hljs-keyword"><span class="hljs-keyword">done</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> instance_id <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> &lt;backend_instance_ids&gt;; <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> \ aws --profile &lt;aws_cli_profile&gt; --endpoint-url <span class="hljs-variable"><span class="hljs-variable">$CLOUDWATCH_URL</span></span> \ cloudwatch put-metric-alarm\ --alarm-name <span class="hljs-string"><span class="hljs-string">"scaling-high_</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$instance_id</span></span></span><span class="hljs-string">"</span></span> \ --dimensions Name=InstanceId,Value=<span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$instance_id</span></span></span><span class="hljs-string">"</span></span> \ --namespace <span class="hljs-string"><span class="hljs-string">"AWS/EC2"</span></span> --metric-name CPUUtilization --statistic Average\ --period 60 --evaluation-periods 3 --threshold 80 --comparison-operator GreaterThanOrEqualToThreshold; <span class="hljs-keyword"><span class="hljs-keyword">done</span></span></code> </pre> <br><p>  Deskripsi beberapa parameter yang mungkin tidak dapat dipahami: </p><br><p>  --profile - profil pengaturan aws-cli, dijelaskan dalam ~ / .aws / config.  Biasanya, kunci akses yang berbeda diatur dalam profil yang berbeda. </p><br><p>  --dimensions - parameter menentukan sumber daya alarm yang akan dibuat, dalam contoh di atas - untuk instance dengan pengenal dari variabel $ instance_id. </p><br><p>  --namespace - namespace dari mana metrik pemantauan akan dipilih. </p><br><p>  --metric-name - nama metrik pemantauan. </p><br><p>  --statistic - nama metode agregasi nilai metrik. </p><br><p>  - Periode - interval waktu antara pemantauan acara pengumpulan nilai. </p><br><p>  --evaluasi-periode - jumlah interval yang diperlukan untuk memicu alarm. </p><br><p>  --threshold - nilai ambang metrik untuk menilai status alarm. </p><br><p>  --comparison-operator - metode yang digunakan untuk mengevaluasi nilai metrik terhadap nilai ambang batas. </p></div></div><br><p>  Dalam contoh di atas, dua alarm dibuat untuk setiap instance backend.  Scaling-low- &lt;instance-id&gt; akan masuk ke status Alarm saat CPU memuat kurang dari 15% selama 3 menit.  Scaling-high- &lt;instance-id&gt; akan masuk ke status Alarm saat CPU memuat lebih dari 80% selama 3 menit. </p><br><h3 id="nastroyka-tegov">  Kustomisasi tag </h3><br><p>  Setelah mengatur pemantauan, kami dihadapkan dengan tugas pencarian contoh berikut dan nama mereka (penemuan layanan).  Kita perlu entah bagaimana memahami berapa banyak contoh backend yang telah kita luncurkan sekarang, dan kita juga perlu tahu nama mereka.  Dalam dunia di luar cloud, misalnya, template konsul dan konsul akan sangat cocok untuk menghasilkan konfigurasi balancer.  Tetapi ada tag di cloud kami.  Tag akan membantu kami mengelompokkan sumber daya.  Dengan meminta informasi untuk tag tertentu (tag-uraikan), kita dapat memahami berapa banyak contoh yang saat ini kita miliki di kumpulan dan id apa yang mereka miliki.  Secara default, id instance unik digunakan sebagai nama host.  Berkat DNS internal yang bekerja di dalam VPC, id / nama host ini menyelesaikan ke instance ip internal. </p><br><p>  Kami menetapkan tag untuk instance dan penyeimbang backend: </p><br><div class="spoiler">  <b class="spoiler_title">EC2 membuat-tag</b> <div class="spoiler_text"><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">export</span></span> EC2_URL=<span class="hljs-string"><span class="hljs-string">"https://api.cloud.croc.ru"</span></span> aws --profile &lt;aws_cli_profile&gt; --endpoint-url <span class="hljs-variable"><span class="hljs-variable">$EC2_URL</span></span> \ ec2 create-tags --resources <span class="hljs-string"><span class="hljs-string">"&lt;awx_instance_id&gt;"</span></span> \ --tags Key=env,Value=auto-scaling Key=role,Value=awx <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> i <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> &lt;backend_instance_ids&gt;; <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> \ aws --profile &lt;aws_cli_profile&gt; --endpoint-url <span class="hljs-variable"><span class="hljs-variable">$EC2_URL</span></span> \ ec2 create-tags --resources <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$i</span></span></span><span class="hljs-string">"</span></span> \ --tags Key=env,Value=auto-scaling Key=role,Value=backend ; <span class="hljs-keyword"><span class="hljs-keyword">done</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> i <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> &lt;haproxy_instance_ids&gt;; <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> \ aws --profile &lt;aws_cli_profile&gt; --endpoint-url <span class="hljs-variable"><span class="hljs-variable">$EC2_URL</span></span> \ ec2 create-tags --resources <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$i</span></span></span><span class="hljs-string">"</span></span> \ --tags Key=env,Value=auto-scaling Key=role,Value=haproxy; <span class="hljs-keyword"><span class="hljs-keyword">done</span></span>;</code> </pre> <br><p>  Dimana: </p><br><p>  --resources - daftar pengidentifikasi sumber daya untuk tag mana yang akan ditetapkan. </p><br><p>  --tags adalah daftar pasangan kunci-nilai. </p></div></div><br><p>  Contoh-tag yang dijelaskan tersedia dalam <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">dokumentasi</a> CROC Cloud. </p><br><h3 id="nastroyka-avtoskeylinga">  Pengaturan penskalaan otomatis </h3><br><p>  Sekarang setelah cloud memantau, dan kami dapat bekerja dengan tag, kami hanya dapat mensurvei status alarm yang dikonfigurasi untuk pemicunya.  Di sini kita membutuhkan entitas yang akan terlibat dalam pemantauan pemantauan berkala dan meluncurkan tugas untuk membuat / menghapus instance.  Berbagai alat otomasi dapat diterapkan di sini.  Kami akan menggunakan AWX.  AWX adalah versi open-source <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Menara Ansible</a> komersial, produk untuk mengelola infrastruktur Ansible secara terpusat.  Tugas utama adalah untuk meluncurkan buku pedoman yang memungkinkan secara berkala. </p><br><p>  Contoh penyebaran AWX tersedia di halaman <a href="">wiki</a> di repositori resmi.  Konfigurasi AWX juga dijelaskan dalam dokumentasi Ansible Tower.  Agar AWX mulai menjalankan buku pedoman khusus, Anda harus mengonfigurasinya dengan membuat entitas berikut: </p><br><ul><li>  Bukti tiga jenis: <br>  <em>- Kredensial AWS - untuk mengesahkan operasi yang terkait dengan CROC Cloud.</em> <em><br></em>  - Kredensial mesin - kunci ssh untuk mengakses mesin virtual yang baru dibuat. <br>  - Kredensial SCM - untuk otorisasi dalam sistem kontrol versi. </li><li>  Project adalah entitas yang akan mendorong repositori git dari playbook. </li><li>  Skrip - skrip inventaris dinamis untuk memungkinkan. </li><li>  Inventory adalah entitas yang akan memanggil skrip inventaris dinamis sebelum meluncurkan playbook. </li><li>  Templat - konfigurasi panggilan buku pedoman tertentu, terdiri dari sekumpulan Kredensial, Inventaris, dan buku pedoman dari Project. </li><li>  Alur kerja - urutan panggilan ke buku pedoman. </li></ul><br><p>  Proses penskalaan dapat dibagi menjadi dua bagian: </p><br><ul><li>  scale_up - buat instance ketika setidaknya satu alarm tinggi dipicu; </li><li>  scale_down - penghentian instance jika alarm rendah bekerja untuknya. </li></ul><br><p>  Dalam lingkup bagian scale_up, Anda perlu: </p><br><ul><li>  Menginterogasi layanan pemantauan cloud tentang keberadaan alarm tinggi dalam keadaan "Alarm"; </li><li>  hentikan scale_up lebih cepat dari jadwal jika semua alarm tinggi dalam kondisi "OK"; </li><li>  buat instance baru dengan atribut yang diperlukan (tag, subnet, security_group, dll.); </li><li>  buat alarm tinggi dan rendah untuk instance yang sedang berjalan; </li><li>  konfigurasikan aplikasi kita di dalam instance baru (dalam kasus kami hanya akan nginx dengan halaman pengujian); </li><li>  perbarui konfigurasi haproxy, buat ulang agar permintaan mulai masuk ke instance baru. </li></ul><br><div class="spoiler">  <b class="spoiler_title">buat-instance.yaml</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">--- - name: get alarm statuses describe_alarms: region: "croc" alarm_name_prefix: "scaling-high" alarm_state: "alarm" register: describe_alarms_query - name: stop if no alarms fired fail: msg: zero high alarms in alarm state when: describe_alarms_query.meta | length == 0 - name: create instance ec2: region: "croc" wait: yes state: present count: 1 key_name: "{{ hostvars[groups['tag_role_backend'][0]].ec2_key_name }}" instance_type: "{{ hostvars[groups['tag_role_backend'][0]].ec2_instance_type }}" image: "{{ hostvars[groups['tag_role_backend'][0]].ec2_image_id }}" group_id: "{{ hostvars[groups['tag_role_backend'][0]].ec2_security_group_ids }}" vpc_subnet_id: "{{ hostvars[groups['tag_role_backend'][0]].ec2_subnet_id }}" user_data: | #!/bin/sh sudo yum install epel-release -y sudo yum install nginx -y cat &lt;&lt;EOF &gt; /etc/nginx/conf.d/dummy.conf server { listen 8080; location / { return 200 '{"message": "$HOSTNAME is up"}'; } } EOF sudo systemctl restart nginx loop: "{{ hostvars[groups['tag_role_backend'][0]] }}" register: new - name: create tag entry ec2_tag: ec2_url: "https://api.cloud.croc.ru" region: croc state: present resource: "{{ item.id }}" tags: role: backend loop: "{{ new.instances }}" - name: create low alarms ec2_metric_alarm: state: present region: croc name: "scaling-low_{ item.id }}" metric: "CPUUtilization" namespace: "AWS/EC2" statistic: Average comparison: "&lt;=" threshold: 15 period: 300 evaluation_periods: 3 unit: "Percent" dimensions: {'InstanceId':"{{ item.id }}"} loop: "{{ new.instances }}" - name: create high alarms ec2_metric_alarm: state: present region: croc name: "scaling-high_{{ item.id }}" metric: "CPUUtilization" namespace: "AWS/EC2" statistic: Average comparison: "&gt;=" threshold: 80.0 period: 300 evaluation_periods: 3 unit: "Percent" dimensions: {'InstanceId':"{{ item.id }}"} loop: "{{ new.instances }}"</code> </pre> </div></div><br><p>  Di create-instance.yaml, yang terjadi adalah: membuat instance dengan parameter yang benar, memberi tag instance ini dan membuat alarm yang diperlukan.  Instalasi nginx dan skrip konfigurasi juga diteruskan ke data pengguna.  Data pengguna diproses oleh layanan cloud-init, yang memungkinkan konfigurasi yang fleksibel dari instance selama startup tanpa menggunakan alat otomatisasi lainnya. </p><br><p>  Dalam pembaruan-lb.yaml, file /etc/haproxy/haproxy.cfg dibuat ulang pada instance haproxy dan layanan haproxy reload: </p><br><div class="spoiler">  <b class="spoiler_title">perbarui-lb.yaml</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">- name: update haproxy configs template: src: haproxy.cfg.j2 dest: /etc/haproxy/haproxy.cfg - name: add new backend host to haproxy systemd: name: haproxy state: restarted</code> </pre> </div></div><br><p>  Di mana haproxy.cfg.j2 adalah templat file konfigurasi layanan haproxy: </p><br><div class="spoiler">  <b class="spoiler_title">haproxy.cfg.j2</b> <div class="spoiler_text"><pre> <code class="plaintext hljs"># {{ ansible_managed }} global log /dev/log local0 log /dev/log local1 notice chroot /var/lib/haproxy stats timeout 30s user haproxy group haproxy daemon defaults log global mode http option httplog option dontlognull timeout connect 5000 timeout client 50000 timeout server 50000 frontend loadbalancing bind *:80 mode http default_backend backendnodes backend backendnodes balance roundrobin option httpchk HEAD / {% for host in groups['tag_role_backend'] %} server {{hostvars[host]['ec2_id']}} {{hostvars[host]['ec2_private_ip_address']}}:8080 check {% endfor %}</code> </pre> </div></div><br><p>  Karena opsi httpchk ditentukan di bagian haproxy backend, layanan haproxy akan secara otomatis menyurvei keadaan instance backend dan hanya menyeimbangkan lalu lintas antara pemeriksaan kesehatan sebelumnya. </p><br><p>  Pada bagian scale_down yang Anda butuhkan: </p><br><ul><li>  periksa status alarm rendah; </li><li>  mengakhiri permainan sebelum waktunya jika tidak ada alarm rendah dalam kondisi "Alarm"; </li><li>  hentikan semua kejadian yang alarmnya rendah di kelas Alarm; </li><li>  melarang terminasi dari pasangan instance terakhir, bahkan jika alarmnya dalam kondisi Alarm; </li><li>  hapus instance yang kami hapus dari konfigurasi load balancer. </li></ul><br><div class="spoiler">  <b class="spoiler_title">hancurkan-instance.yaml</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">- name: look for alarm status describe_alarms: region: "croc" alarm_name_prefix: "scaling-low" alarm_state: "alarm" register: describe_alarms_query - name: count alarmed instances set_fact: alarmed_count: "{{ describe_alarms_query.meta | length }}" alarmed_ids: "{{ describe_alarms_query.meta }}" - name: stop if no alarms fail: msg: no alarms fired when: alarmed_count | int == 0 - name: count all described instances set_fact: all_count: "{{ groups['tag_role_backend'] | length }}" - name: fail if last two instance remaining fail: msg: cant destroy last two instances when: all_count | int == 2 - name: destroy tags for marked instances ec2_tag: ec2_url: "https://api.cloud.croc.ru" region: croc resource: "{{ alarmed_ids[0].split('_')[1] }}" state: absent tags: role: backend - name: destroy instances ec2: region: croc state: absent instance_ids: "{{ alarmed_ids[0].split('_')[1] }}" - name: destroy low alarms ec2_metric_alarm: state: absent region: croc name: "scaling-low_{{ alarmed_ids[0].split('_')[1] }}" - name: destroy high alarms ec2_metric_alarm: state: absent region: croc name: "scaling-high_{{ alarmed_ids[0].split('_')[1] }}"</code> </pre> </div></div><br><p>  Di destroy-instance.yaml, alarm dihapus, instance dan tag-nya diakhiri, dan kondisi yang melarang penghentian instance terbaru diperiksa. </p><br><p>  Kami secara eksplisit menghapus tag setelah menghapus instance karena fakta bahwa setelah menghapus instance, tag yang terkait dengannya dihapus ditunda dan tersedia untuk beberapa menit lagi. <br>  AWX </p><br><h3 id="nastroyka-zadach-shablonov">  Pengaturan tugas, template </h3><br><p>  Serangkaian tugas berikut akan membuat entitas yang diperlukan di AWX: </p><br><div class="spoiler">  <b class="spoiler_title">awx-configure.yaml</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">--- - name: Create tower organization tower_organization: name: "scaling-org" description: "scaling-org organization" state: present - name: Add tower cloud credential tower_credential: name: cloud description: croc cloud api creds organization: scaling-org kind: aws state: present username: "{{ croc_user }}" password: "{{ croc_password }}" - name: Add tower github credential tower_credential: name: ghe organization: scaling-org kind: scm state: present username: "{{ ghe_user }}" password: "{{ ghe_password }}" - name: Add tower ssh credential tower_credential: name: ssh description: ssh creds organization: scaling-org kind: ssh state: present username: "ec2-user" ssh_key_data: "{{ lookup('file', 'private.key') }}" - name: Add tower project tower_project: name: "auto-scaling" scm_type: git scm_credential: ghe scm_url: &lt;repo-name&gt; organization: "scaling-org" scm_branch: master state: present - name: create inventory tower_inventory: name: dynamic-inventory organization: "scaling-org" state: present - name: copy inventory script to awx copy: src: "{{ role_path }}/files/ec2.py" dest: /root/ec2.py - name: create inventory source shell: | export SCRIPT=$(tower-cli inventory_script create -n "ec2-script" --organization "scaling-org" --script @/root/ec2.py | grep ec2 | awk '{print $1}') tower-cli inventory_source create --update-on-launch True --credential cloud --source custom --inventory dynamic-inventory -n "ec2-source" --source-script $SCRIPT --source-vars '{"EC2_URL":"api.cloud.croc.ru","AWS_REGION": "croc"}' --overwrite True - name: Create create-instance template tower_job_template: name: "create-instance" job_type: "run" inventory: "dynamic-inventory" credential: "cloud" project: "auto-scaling" playbook: "create-instance.yaml" state: "present" register: create_instance - name: Create update-lb template tower_job_template: name: "update-lb" job_type: "run" inventory: "dynamic-inventory" credential: "ssh" project: "auto-scaling" playbook: "update-lb.yaml" credential: "ssh" state: "present" register: update_lb - name: Create destroy-instance template tower_job_template: name: "destroy-instance" job_type: "run" inventory: "dynamic-inventory" project: "auto-scaling" credential: "cloud" playbook: "destroy-instance.yaml" credential: "ssh" state: "present" register: destroy_instance - name: create workflow tower_workflow_template: name: auto_scaling organization: scaling-org schema: "{{ lookup('template', 'schema.j2')}}" - name: set scheduling shell: | tower-cli schedule create -n "3min" --workflow "auto_scaling" --rrule "DTSTART:$(date +%Y%m%dT%H%M%SZ) RRULE:FREQ=MINUTELY;INTERVAL=3"</code> </pre> </div></div><br><p>  Cuplikan sebelumnya akan membuat templat untuk masing-masing buku pedoman yang mungkin digunakan.  Setiap templat mengonfigurasi peluncuran buku pedoman dengan serangkaian kredensial dan inventaris yang ditentukan. </p><br><p>  Untuk membangun pipa untuk panggilan ke buku pedoman akan memungkinkan templat alur kerja.  Menyiapkan alur kerja untuk autoscaling disajikan di bawah ini: </p><br><div class="spoiler">  <b class="spoiler_title">schema.j2</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">- failure_nodes: - id: 101 job_template: {{ destroy_instance.id }} success_nodes: - id: 102 job_template: {{ update_lb.id }} id: 103 job_template: {{ create_instance.id }} success_nodes: - id: 104 job_template: {{ update_lb.id }}</code> </pre> </div></div><br><p>  Templat sebelumnya menunjukkan diagram alur kerja, mis.  urutan eksekusi template.  Dalam alur kerja ini, setiap langkah berikutnya (success_nodes) akan dilakukan hanya jika yang sebelumnya berhasil diselesaikan.  Representasi grafis dari alur kerja ditunjukkan pada gambar: <br><img src="https://habrastorage.org/webt/po/l-/vb/pol-vbfpulv4hoimk99mvbtig-u.png" alt="alur kerja"></p><br><p>  Sebagai hasilnya, alur kerja umum dibuat yang mengeksekusi playbook create-instace dan, tergantung pada status eksekusi, destroy-instance dan / atau update-lb playbooks.  Alur kerja terintegrasi nyaman untuk dijalankan pada jadwal yang diberikan.  Proses penskalaan otomatis akan dimulai setiap tiga menit, meluncurkan dan menghentikan instance tergantung pada kondisi alarm. </p><br><h3 id="testirovanie-raboty">  Tes kerja </h3><br><p>  Sekarang periksa operasi sistem yang dikonfigurasi.  Pertama, instal utilitas wrk untuk pembandingan http. </p><br><div class="spoiler">  <b class="spoiler_title">wrk instal</b> <div class="spoiler_text"><pre> <code class="bash hljs">ssh -A ec2-user@&lt;aws_instance_ip&gt; sudo su - <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> /opt yum groupinstall <span class="hljs-string"><span class="hljs-string">'Development Tools'</span></span> yum install -y openssl-devel git git <span class="hljs-built_in"><span class="hljs-built_in">clone</span></span> https://github.com/wg/wrk.git wrk <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> wrk make install wrk /usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/bin <span class="hljs-built_in"><span class="hljs-built_in">exit</span></span></code> </pre> </div></div><br><p>  Kami akan menggunakan pemantauan cloud untuk memantau penggunaan sumber daya instan saat memuat: </p><br><div class="spoiler">  <b class="spoiler_title">pemantauan</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">function CPUUtilizationMonitoring() { local AWS_CLI_PROFILE="&lt;aws_cli_profile&gt;" local CLOUDWATCH_URL="https://monitoring.cloud.croc.ru" local API_URL="https://api.cloud.croc.ru" local STATS="" local ALARM_STATUS="" local IDS=$(aws --profile $AWS_CLI_PROFILE --endpoint-url $API_URL ec2 describe-instances --filter Name=tag:role,Values=backend | grep -i instanceid | grep -oE 'i-[a-zA-Z0-9]*' | tr '\n' ' ') for instance_id in $IDS; do STATS="$STATS$(aws --profile $AWS_CLI_PROFILE --endpoint-url $CLOUDWATCH_URL cloudwatch get-metric-statistics --dimensions Name=InstanceId,Value=$instance_id --namespace "AWS/EC2" --metric CPUUtilization --end-time $(date --iso-8601=minutes) --start-time $(date -d "$(date --iso-8601=minutes) - 1 min" --iso-8601=minutes) --period 60 --statistics Average | grep -i average)"; ALARMS_STATUS="$ALARMS_STATUS$(aws --profile $AWS_CLI_PROFILE --endpoint-url $CLOUDWATCH_URL cloudwatch describe-alarms --alarm-names scaling-high-$instance_id | grep -i statevalue)" done echo $STATS | column -s ',' -o '|' -N $(echo $IDS | tr ' ' ',') -t echo $ALARMS_STATUS | column -s ',' -o '|' -N $(echo $IDS | tr ' ' ',') -t } export -f CPUUtilizationMonitoring watch -n 60 bash -c CPUUtilizationMonitoring</code> </pre> </div></div><br><p>  Skrip sebelumnya sekali setiap 60 detik mengambil informasi tentang nilai rata-rata metrik CPUUtilization untuk menit terakhir dan polling status alarm untuk contoh backend. </p><br><p>  Sekarang Anda dapat menjalankan wrk dan melihat pemanfaatan sumber daya dari instance backend yang dimuat: </p><br><div class="spoiler">  <b class="spoiler_title">wrk run</b> <div class="spoiler_text"><pre> <code class="bash hljs">ssh -A ec2-user@&lt;awx_instance_ip&gt; wrk -t12 -c100 -d500s http://&lt;haproxy_instance_id&gt; <span class="hljs-built_in"><span class="hljs-built_in">exit</span></span></code> </pre> </div></div><br><p>  Perintah terakhir akan meluncurkan benchmark selama 500 detik, menggunakan 12 utas dan membuka 100 koneksi http. </p><br><p>  Seiring waktu, skrip pemantauan harus menunjukkan bahwa selama benchmark, nilai statistik metrik CPUisasi meningkat hingga mencapai 300%.  180 detik setelah dimulainya patokan, bendera StateValue harus beralih ke status Alarm.  Setiap dua menit, alur kerja autoscaling dimulai.  Secara default, eksekusi paralel dari alur kerja yang sama dilarang.  Artinya, setiap dua menit, tugas untuk mengeksekusi alur kerja akan ditambahkan ke antrian dan akan diluncurkan hanya setelah yang sebelumnya selesai.  Jadi, selama pekerjaan wrk, akan ada peningkatan sumber daya yang konstan sampai alarm tinggi dari semua instance backend masuk ke kondisi OK.  Setelah selesai, alur kerja scale_down wrk mengakhiri semua kecuali dua instance backend. </p><br><p>  Contoh output dari skrip pemantauan: </p><br><div class="spoiler">  <b class="spoiler_title">hasil pemantauan</b> <div class="spoiler_text"><pre> <code class="plaintext hljs"># start test i-43477460 |i-AC5D9EE0 "Average": 0.0 | "Average": 0.0 i-43477460 |i-AC5D9EE0 "StateValue": "ok"| "StateValue": "ok" # start http load i-43477460 |i-AC5D9EE0 "Average": 267.0 | "Average": 111.0 i-43477460 |i-AC5D9EE0 "StateValue": "ok"| "StateValue": "ok" # alarm state i-43477460 |i-AC5D9EE0 "Average": 267.0 | "Average": 282.0 i-43477460 |i-AC5D9EE0 "StateValue": "alarm"| "StateValue": "alarm" # two new instances created i-1E399860 |i-F307FB00 |i-43477460 |i-AC5D9EE0 "Average": 185.0 | "Average": 215.0 | "Average": 245.0 | i-1E399860 |i-F307FB00 |i-43477460 |i-AC5D9EE0 "StateValue": "insufficient_data"| "StateValue": "insufficient_data"| "StateValue": "alarm"| "StateValue": "alarm" # only two instances left after load has been stopped i-935BAB40 |i-AC5D9EE0 "Average": 0.0 | "Average": 0.0 i-935BAB40 |i-AC5D9EE0 "StateValue": "ok"| "StateValue": "ok"</code> </pre> </div></div><br><p>  Juga di Cloud CROC, Anda dapat melihat grafik yang digunakan dalam pos pemantauan di halaman instance pada tab yang sesuai. </p><br><p>  Lihat alarm tersedia di halaman pemantauan pada tab alarm. </p><br><h3 id="zaklyuchenie">  Kesimpulan </h3><br><p>  Autoscaling adalah skenario yang cukup populer, tetapi, sayangnya, ini belum ada di cloud kami (tetapi hanya untuk saat ini).  Namun, kami memiliki banyak API yang kuat untuk melakukan hal serupa dan banyak hal lainnya, menggunakan alat yang populer, hampir standar, seperti Terraform, ansible, aws-cli dan lainnya. </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/id456826/">https://habr.com/ru/post/id456826/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../id456812/index.html">Apa yang ada di ITMO University - festival IT, hackathons, konferensi, dan seminar terbuka</a></li>
<li><a href="../id456814/index.html">Pelajari Pemrograman Fungsional dalam Python dalam 10 Menit</a></li>
<li><a href="../id456818/index.html">Administrator sistem di perusahaan yang tidak dapat didekati. Beban makhluk yang tak tertahankan?</a></li>
<li><a href="../id456820/index.html">Clay ‚Üí Brick ‚Üí Kompor</a></li>
<li><a href="../id456824/index.html">Apa itu probabilitas dan bagaimana cara menghitungnya</a></li>
<li><a href="../id456828/index.html">Tuning vias untuk papan sirkuit tercetak</a></li>
<li><a href="../id456830/index.html">Vivaldi 2.6 - Summer Fun</a></li>
<li><a href="../id456836/index.html">Pilihan: 5 alat analisis kompetitif yang tidak terlihat yang mungkin belum Anda ketahui</a></li>
<li><a href="../id456838/index.html">Pengantar Penilaian ICE untuk Prioritas Fitur Produk</a></li>
<li><a href="../id456840/index.html">Pelajaran SDL 2: Pelajaran 6 - Primitif</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>