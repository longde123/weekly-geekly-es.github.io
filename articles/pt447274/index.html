<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë©üèΩ‚Äçüç≥ üîâ üÜé O que acontece nos bastidores C #: o b√°sico de trabalhar com a pilha üë©‚Äçüë¶ üò¥ üàµ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Proponho olhar para os internos que est√£o por tr√°s das linhas simples de inicializa√ß√£o dos objetos, m√©todos de chamada e passagem de par√¢metros. E, √© ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>O que acontece nos bastidores C #: o b√°sico de trabalhar com a pilha</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/447274/">  Proponho olhar para os internos que est√£o por tr√°s das linhas simples de inicializa√ß√£o dos objetos, m√©todos de chamada e passagem de par√¢metros.  E, √© claro, usaremos essas informa√ß√µes na pr√°tica - subtrairemos a pilha do m√©todo de chamada. <br><br><h3>  Isen√ß√£o de responsabilidade </h3><br>  Antes de prosseguir com a hist√≥ria, recomendo vivamente que leia o primeiro post sobre o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">StructLayout</a> ; existe um exemplo que ser√° usado neste artigo. <br><br>  Todo o c√≥digo por tr√°s do de alto n√≠vel √© apresentado para o modo de <b>depura√ß√£o</b> , porque mostra a base conceitual.  A otimiza√ß√£o de JIT √© um grande t√≥pico separado que n√£o ser√° abordado aqui. <br><br>  Gostaria tamb√©m de advertir que este artigo n√£o cont√©m material que deve ser usado em projetos reais. <br><br><h3>  Primeira - teoria </h3><br>  Qualquer c√≥digo eventualmente se torna um conjunto de comandos da m√°quina.  O mais compreens√≠vel √© sua representa√ß√£o na forma de instru√ß√µes em linguagem Assembly que correspondem diretamente a uma (ou v√°rias) instru√ß√µes da m√°quina. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/ya/yv/k7/yayvk7f2o3tfr5flwaybim4u1m8.jpeg"></div><a name="habracut"></a><br>  Antes de passar para um exemplo simples, proponho me familiarizar com a pilha.  <b>A pilha</b> √© principalmente um peda√ßo de mem√≥ria usado, como regra, para armazenar v√°rios tipos de dados (geralmente eles podem ser chamados de <i>dados temporais</i> ).  Tamb√©m vale lembrar que a pilha cresce em dire√ß√£o a endere√ßos menores.  Ou seja, quanto mais tarde um objeto for colocado na pilha, menos endere√ßo ele ter√°. <br><br>  Agora, vamos dar uma olhada no pr√≥ximo trecho de c√≥digo na linguagem Assembly (omiti algumas das chamadas inerentes ao modo de depura√ß√£o). <br><br>  C #: <br><br><pre><code class="plaintext hljs">public class StubClass { public static int StubMethod(int fromEcx, int fromEdx, int fromStack) { int local = 5; return local + fromEcx + fromEdx + fromStack; } public static void CallingMethod() { int local1 = 7, local2 = 8, local3 = 9; int result = StubMethod(local1, local2, local3); } }</code> </pre> <br>  Asm: <br><br><pre> <code class="plaintext hljs">StubClass.StubMethod(Int32, Int32, Int32) 1: push ebp 2: mov ebp, esp 3: sub esp, 0x10 4: mov [ebp-0x4], ecx 5: mov [ebp-0x8], edx 6: xor edx, edx 7: mov [ebp-0xc], edx 8: xor edx, edx 9: mov [ebp-0x10], edx 10: nop 11: mov dword [ebp-0xc], 0x5 12: mov eax, [ebp-0xc] 13: add eax, [ebp-0x4] 14: add eax, [ebp-0x8] 15: add eax, [ebp+0x8] 16: mov [ebp-0x10], eax 17: mov eax, [ebp-0x10] 18: mov esp, ebp 19: pop ebp 20: ret 0x4 StubClass.CallingMethod() 1: push ebp 2: mov ebp, esp 3: sub esp, 0x14 4: xor eax, eax 5: mov [ebp-0x14], eax 6: xor edx, edx 7: mov [ebp-0xc], edx 8: xor edx, edx 9: mov [ebp-0x8], edx 10: xor edx, edx 11: mov [ebp-0x4], edx 12: xor edx, edx 13: mov [ebp-0x10], edx 14: nop 15: mov dword [ebp-0x4], 0x7 16: mov dword [ebp-0x8], 0x8 17: mov dword [ebp-0xc], 0x9 18: push dword [ebp-0xc] 19: mov ecx, [ebp-0x4] 20: mov edx, [ebp-0x8] 21: call StubClass.StubMethod(Int32, Int32, Int32) 22: mov [ebp-0x14], eax 23: mov eax, [ebp-0x14] 24: mov [ebp-0x10], eax 25: nop 26: mov esp, ebp 27: pop ebp 28: ret</code> </pre><br>  A primeira coisa a notar √© o <b>EBP</b> e o <b>ESP</b> registram e operam com eles. <br><br>  Um equ√≠voco de que o registro <b>EBP</b> esteja de alguma forma relacionado ao ponteiro para o topo da pilha √© comum entre meus amigos.  Devo dizer que n√£o √©. <br><br>  O registro <b>ESP</b> √© respons√°vel por apontar para o topo da pilha.  Da mesma forma, com cada instru√ß√£o <b>PUSH</b> (colocando um valor no topo da pilha), o valor do registro <b>ESP</b> √© decrementado (a pilha cresce em dire√ß√£o a endere√ßos menores) e, a cada instru√ß√£o <b>POP</b> , √© incrementada.  Al√©m disso, o comando <b>CALL</b> pressiona o endere√ßo de retorno na pilha, diminuindo assim o valor do registro <b>ESP</b> .  De fato, a altera√ß√£o do registro <b>ESP</b> √© realizada n√£o apenas quando essas instru√ß√µes s√£o executadas (por exemplo, quando chamadas de interrup√ß√£o s√£o feitas, o mesmo ocorre com as instru√ß√µes <b>CALL</b> ). <br><br>  Considerar√° <i>StubMethod ()</i> . <br><br>  Na primeira linha, o conte√∫do do registro <b>EBP</b> √© salvo (colocado em uma pilha).  Antes de retornar de uma fun√ß√£o, esse valor ser√° restaurado. <br><br>  A segunda linha armazena o valor atual do endere√ßo da parte superior da pilha (o valor do registro <b>ESP</b> √© movido para <b>EBP</b> ).  Em seguida, movemos o topo da pilha para quantas posi√ß√µes precisarmos para armazenar vari√°veis ‚Äã‚Äãe par√¢metros locais (terceira linha).  Algo como aloca√ß√£o de mem√≥ria para todas as necessidades locais - <b>quadro de pilha</b> .  Ao mesmo tempo, o registro <b>EBP</b> √© um ponto de partida no contexto da chamada atual.  O endere√ßamento √© baseado nesse valor. <br><br>  Todos os itens acima s√£o chamados de <b>pr√≥logo da fun√ß√£o</b> . <br><br>  Depois disso, as vari√°veis ‚Äã‚Äãna pilha s√£o acessadas atrav√©s do registro <b>EBP</b> armazenado, que aponta para o local onde as vari√°veis ‚Äã‚Äãdeste m√©todo come√ßam.  Em seguida, vem a inicializa√ß√£o das vari√°veis ‚Äã‚Äãlocais. <br><br>  Lembrete de chamada <i>r√°pida</i> : em .net, a <i>conven√ß√£o de</i> chamada de chamada <i>r√°pida</i> √© usada. <br>  A conven√ß√£o de chamada controla o local e a ordem dos par√¢metros passados ‚Äã‚Äãpara a fun√ß√£o. <br>  O primeiro e o segundo par√¢metros s√£o passados ‚Äã‚Äãpelos registradores <b>ECX</b> e <b>EDX</b> , respectivamente, os par√¢metros subsequentes s√£o transmitidos pela pilha.  (Isso √© para sistemas de 32 bits, como sempre. Nos sistemas de 64 bits, quatro par√¢metros passaram pelos registradores ( <b>RCX</b> , <b>RDX</b> , <b>R8</b> , <b>R9</b> )) <br><br>  Para m√©todos n√£o est√°ticos, o primeiro par√¢metro est√° impl√≠cito e cont√©m o endere√ßo da inst√¢ncia na qual o m√©todo √© chamado (este endere√ßo). <br><br>  Nas linhas 4 e 5, os par√¢metros que foram passados ‚Äã‚Äãpelos registradores (os 2 primeiros) s√£o armazenados na pilha. <br><br>  A seguir, √© necess√°rio limpar o espa√ßo na pilha para vari√°veis ‚Äã‚Äãlocais ( <i>quadro da pilha</i> ) e inicializar vari√°veis ‚Äã‚Äãlocais. <br><br>  Vale ressaltar que o resultado da fun√ß√£o est√° no registro <b>EAX</b> . <br><br>  Nas linhas 12-16, ocorre a adi√ß√£o das vari√°veis ‚Äã‚Äãdesejadas.  Chamo sua aten√ß√£o para a linha 15. H√° um valor de acesso pelo endere√ßo que √© maior que o in√≠cio da pilha, ou seja, para a pilha do m√©todo anterior.  Antes de ligar, o chamador envia um par√¢metro para o topo da pilha.  Aqui n√≥s lemos.  O resultado da adi√ß√£o √© obtido no registro <b>EAX</b> e colocado na pilha.  Como esse √© o valor de retorno do <i>StubMethod ()</i> , ele √© colocado novamente no <b>EAX</b> .  Obviamente, esses conjuntos absurdos de instru√ß√µes s√£o inerentes apenas ao modo de depura√ß√£o, mas mostram exatamente como nosso c√≥digo se parece sem o otimizador inteligente que faz a maior parte do trabalho. <br><br>  Nas linhas 18 e 19, o <b>EBP</b> anterior (m√©todo de chamada) e o ponteiro para o topo da pilha s√£o restaurados (no momento em que o m√©todo √© chamado).  A √∫ltima linha √© o retorno da fun√ß√£o.  Sobre o valor 0x4, falarei um pouco mais tarde. <br><br>  Essa sequ√™ncia de comandos √© chamada ep√≠logo de fun√ß√£o. <br><br>  Agora vamos dar uma olhada em <i>CallingMethod ()</i> .  Vamos direto para a linha 18. Aqui, colocamos o terceiro par√¢metro no topo da pilha.  Observe que fazemos isso usando a instru√ß√£o <b>PUSH</b> , ou seja, o valor do <b>ESP</b> √© diminu√≠do.  Os outros 2 par√¢metros s√£o colocados em registradores ( <i>chamada r√°pida</i> ).  Em seguida, vem a chamada do m√©todo <i>StubMethod ()</i> .  Agora vamos lembrar a instru√ß√£o <b>RET 0x4</b> .  Aqui a seguinte pergunta √© poss√≠vel: o que √© 0x4?  Como mencionei acima, colocamos os par√¢metros da fun√ß√£o chamada na pilha.  Mas agora n√£o precisamos deles.  0x4 indica quantos bytes precisam ser limpos da pilha ap√≥s a chamada da fun√ß√£o.  Como o par√¢metro era um, voc√™ precisa limpar 4 bytes. <br><br>  Aqui est√° uma imagem aproximada da pilha: <br><br><img src="https://habrastorage.org/webt/vz/eo/vz/vzeovzr2rvkuetuzi4xyp4iuxye.png"><br><br>  Assim, se nos virarmos e vermos o que est√° na pilha logo ap√≥s a chamada do m√©todo, a primeira coisa que veremos <b>EBP</b> , que foi empurrada para a pilha (na verdade, isso aconteceu na primeira linha do m√©todo atual).  A pr√≥xima coisa ser√° o endere√ßo de retorno.  Ele determina o local para retomar a execu√ß√£o ap√≥s a conclus√£o da nossa fun√ß√£o (usada pelo <b>RET</b> ).  E logo ap√≥s esses campos, veremos os par√¢metros da fun√ß√£o atual (a partir do terceiro, os dois primeiros par√¢metros s√£o passados ‚Äã‚Äãpelos registradores).  E atr√°s deles a pilha do m√©todo de chamada se esconde! <br><br>  O primeiro e o segundo campos mencionados anteriormente ( <b>EBP</b> e endere√ßo de retorno) explicam o deslocamento em + 0x8 quando acessamos par√¢metros. <br><br>  Correspondentemente, os par√¢metros devem estar no topo da pilha em uma ordem estritamente definida antes da chamada da fun√ß√£o.  Portanto, antes de chamar o m√©todo, cada par√¢metro √© enviado para a pilha. <br>  Mas e se eles n√£o pressionarem, e a fun√ß√£o ainda os levar? <br><br><h3>  Pequeno exemplo </h3><br>  Portanto, todos os fatos acima me causaram um desejo irresist√≠vel de ler a pilha do m√©todo que chamar√° meu m√©todo.  A ideia de que estou apenas em uma posi√ß√£o do terceiro argumento (ser√° o mais pr√≥ximo da pilha do m√©todo de chamada) s√£o os dados estimados que desejo receber tanto, n√£o me deixaram dormir. <br><br>  Portanto, para ler a pilha do m√©todo de chamada, preciso ir um pouco al√©m dos par√¢metros. <br><br>  Ao se referir a par√¢metros, o c√°lculo do endere√ßo de um par√¢metro espec√≠fico √© baseado apenas no fato de que o chamador colocou todos eles na pilha. <br><br>  Mas a passagem impl√≠cita pelo par√¢metro <b>EDX</b> (quem est√° interessado - <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">artigo anterior</a> ) me faz pensar que podemos ser mais espertos que o compilador em alguns casos. <br><br>  A ferramenta que eu costumava fazer isso √© chamada StructLayoutAttribute (todos os recursos est√£o no <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">primeiro artigo</a> ).  // Um ‚Äã‚Äãdia vou aprender um pouco mais do que apenas esse atributo, prometo <br><br>  Usamos o mesmo m√©todo favorito com tipos de refer√™ncia sobrepostos. <br><br>  Ao mesmo tempo, se os m√©todos sobrepostos tiverem um n√∫mero diferente de par√¢metros, o compilador n√£o enviar√° os necess√°rios para a pilha (pelo menos porque n√£o sabe quais). <br>  No entanto, o m√©todo realmente chamado (com o mesmo deslocamento de um tipo diferente) se transforma em endere√ßos positivos em rela√ß√£o √† sua pilha, ou seja, aqueles em que planeja encontrar os par√¢metros. <br><br>  Mas ningu√©m passa par√¢metros e o m√©todo come√ßa a ler a pilha do m√©todo de chamada.  E o endere√ßo do objeto (com a propriedade Id, usada no <i>WriteLine ()</i> ) est√° no local, onde o terceiro par√¢metro √© esperado. <br><br><div class="spoiler">  <b class="spoiler_title">O c√≥digo est√° no spoiler</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">using System; using System.Runtime.InteropServices; namespace Magic { public class StubClass { public StubClass(int id) { Id = id; } public int Id; } [StructLayout(LayoutKind.Explicit)] public class CustomStructWithLayout { [FieldOffset(0)] public Test1 Test1; [FieldOffset(0)] public Test2 Test2; } public class Test1 { public virtual void Useless(int skipFastcall1, int skipFastcall2, StubClass adressOnStack) { adressOnStack.Id = 189; } } public class Test2 { public virtual int Useless() { return 888; } } class Program { static void Main() { Test2 objectWithLayout = new CustomStructWithLayout { Test2 = new Test2(), Test1 = new Test1() }.Test2; StubClass adressOnStack = new StubClass(3); objectWithLayout.Useless(); Console.WriteLine($"MAGIC - {adressOnStack.Id}"); // MAGIC - 189 } } }</code> </pre><br></div></div><br>  N√£o vou dar o c√≥digo da linguagem assembly, est√° tudo bem claro l√°, mas se houver alguma d√∫vida, tentarei respond√™-la nos coment√°rios <br><br>  Entendo perfeitamente que esse exemplo n√£o pode ser usado na pr√°tica, mas, na minha opini√£o, pode ser muito √∫til para entender o esquema geral do trabalho. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt447274/">https://habr.com/ru/post/pt447274/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt447262/index.html">Acelerando o site com o JivoSite. Download diferido de consultor on-line</a></li>
<li><a href="../pt447264/index.html">Ignite Grade de Servi√ßo - Reinicializa√ß√£o</a></li>
<li><a href="../pt447266/index.html">√ìrg√£os da linguagem e dos sentidos</a></li>
<li><a href="../pt447268/index.html">Centro de Seguran√ßa do Microsoft Azure anuncia novos recursos</a></li>
<li><a href="../pt447270/index.html">Ferida perfurante por BGP</a></li>
<li><a href="../pt447276/index.html">O que √© a biblioteca ITIL e por que sua empresa precisa</a></li>
<li><a href="../pt447278/index.html">A Est√¥nia est√° tentando usar a IA na justi√ßa</a></li>
<li><a href="../pt447280/index.html">Nivelando contas de jogos na China: um neg√≥cio s√©rio e uma dor de cabe√ßa para desenvolvedores</a></li>
<li><a href="../pt447282/index.html">Erros de programadores de sistema e aplicativos capturados no frontend (artigo exclu√≠do)</a></li>
<li><a href="../pt447284/index.html">Atualizar ferramentas da Web e do Azure no Visual Studio 2019</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>