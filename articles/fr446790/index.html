<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ü§¥üèº üîª üë®üèª‚Äçüöí Comment j'ai d√©couvert un ≈ìuf de P√¢ques dans la s√©curit√© d'Android et que je n'ai pas d√©croch√© d'emploi chez Google ü§πüèª ü§´ üéôÔ∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Google adore les ≈ìufs de P√¢ques. Il les aime tellement, en fait, que vous pouvez les trouver dans pratiquement tous leurs produits. La tradition des ≈ì...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Comment j'ai d√©couvert un ≈ìuf de P√¢ques dans la s√©curit√© d'Android et que je n'ai pas d√©croch√© d'emploi chez Google</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/446790/"><img src="https://habrastorage.org/webt/cx/0o/3t/cx0o3tqoavfz_opnsomw9-65h_i.jpeg" align="left">  Google adore les ≈ìufs de P√¢ques.  Il les aime tellement, en fait, que vous pouvez les trouver dans pratiquement tous leurs produits.  La tradition des ≈ìufs de P√¢ques Android a commenc√© dans les toutes premi√®res versions du syst√®me d'exploitation (je pense que tout le monde sait ce qui se passe lorsque vous acc√©dez aux param√®tres g√©n√©raux et appuyez plusieurs fois sur le num√©ro de version). <br><br>  Mais parfois, vous pouvez trouver un ≈ìuf de P√¢ques dans les endroits les plus improbables.  Il y a m√™me une l√©gende urbaine qu'un jour, un programmeur a recherch√© ¬´verrouillage mutex¬ª sur Google, mais au lieu de r√©sultats de recherche, il a atterri sur foo.bar, a r√©solu toutes les t√¢ches et a d√©croch√© un emploi chez Google. <br><br><div class="spoiler">  <b class="spoiler_title">Reconstruction</b> <div class="spoiler_text"><img src="https://habrastorage.org/getpro/habr/post_images/157/242/ffc/157242ffcbf299f7a67641f9df1e551e.jpg" alt="image"><br></div></div><br>  La m√™me chose (sauf sans la fin heureuse) m'est arriv√©e.  Messages cach√©s l√† o√π il n'y en avait certainement pas, inversant le code Java et ses biblioth√®ques natives, une machine virtuelle secr√®te, une interview de Google - tout cela est ci-dessous. <br><a name="habracut"></a><br><h3>  Droidguard </h3><br>  Une nuit ennuyeuse, j'ai r√©initialis√© mon t√©l√©phone aux r√©glages d'usine et j'ai pu le configurer √† nouveau.  Tout d'abord, une nouvelle installation d'Android m'a demand√© de me connecter au compte Google.  Et je me suis demand√©: comment fonctionne le processus de connexion √† Android?  Et la nuit est soudainement devenue moins ennuyeuse. <br><br>  J'utilise la suite Burp de PortSwigger pour intercepter et analyser le trafic r√©seau.  La version communautaire gratuite est suffisante pour nos besoins.  Pour voir les demandes https, nous devons d'abord installer le certificat de PortSwigger sur l'appareil.  En tant qu'appareil de test, j'ai choisi un Samsung Galaxy S de 8 ans avec Android 4.4.  Quoi de plus r√©cent que cela et vous pourriez avoir des probl√®mes avec l'√©pinglage de certificats et d'autres choses. <br><br>  En toute honn√™tet√©, il n'y a rien de particuli√®rement sp√©cial avec les demandes de l'API Google.  L'appareil envoie des informations sur lui-m√™me et obtient des jetons en r√©ponse ... La seule √©tape curieuse est une demande POST au service anti-abus. <br><br><img src="https://habrastorage.org/webt/nv/4c/7n/nv4c7njt_zecyvp0vquekhnoxbm.png"><br><br>  Une fois la demande effectu√©e, parmi de nombreux param√®tres tr√®s normaux, il en appara√Æt un int√©ressant, nomm√© <b>droidguard_result</b> .  C'est une tr√®s longue cha√Æne Base64: <br><br><img src="https://habrastorage.org/webt/kp/h3/i-/kph3i-1n7tw9dv-ckitddw4rxdm.png"><br><br>  DroidGuard est le m√©canisme de Google pour d√©tecter les robots et les √©mulateurs parmi les vrais appareils.  SafetyNet, par exemple, utilise √©galement les donn√©es de DroidGuard.  Google a √©galement une chose similaire pour les navigateurs - Botguard. <br><br>  Mais quelles sont ces donn√©es?  Voyons. <br><br><h3>  Tampons de protocole </h3><br>  Qu'est-ce qui g√©n√®re ce lien ( <i><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">www.googleapis.com/androidantiabuse/v1/x/create?alt=PROTO&amp;key=AIzaSyBofcZsgLSS7BOnBjZPEkk4rYwzOIz-lTI</a></i> ) et √† l'int√©rieur d'Android qui fait cette demande?  Apr√®s une courte enqu√™te, il s'est av√©r√© que le lien, sous cette forme exacte, se trouve dans l'une des classes obscures des services Google Play: <br><br><pre><code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">bdd</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Context var1, bdh var2)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>(var1, <span class="hljs-string"><span class="hljs-string">"https://www.googleapis.com/androidantiabuse/v1/x/create?alt=PROTO&amp;key=AIzaSyBofcZsgLSS7BOnBjZPEkk4rYwzOIz-lTI"</span></span>, var2); }</code> </pre> <br>  Comme nous l'avons d√©j√† vu dans Burp, les requ√™tes POST sur ce lien ont <b>Content-Type</b> - <b>application / x-protobuf</b> (Google Protocol Buffers, le protocole de Google pour la s√©rialisation binaire).  Ce n'est pas json, cependant - il est difficile de d√©couvrir exactement ce qui est envoy√©. <br><br>  Les tampons de protocole fonctionnent comme ceci: <br><br><ul><li>  Nous d√©crivons d'abord la structure du message dans un format sp√©cial et l'enregistrons dans un fichier .proto; </li><li>  Ensuite, nous compilons des fichiers .proto, et le compilateur de protocole g√©n√®re du code source dans une langue choisie (dans le cas d'Android, c'est Java); </li><li>  Enfin, nous utilisons les classes g√©n√©r√©es dans notre projet. </li></ul><br>  Nous avons deux fa√ßons de d√©coder les messages protobuf.  La premi√®re consiste √† utiliser un analyseur de protobuf et √† essayer de recr√©er la description originale des fichiers .proto.  La seconde consiste √† extraire les classes g√©n√©r√©es par le protocole des services Google Play, ce que j'ai d√©cid√© de faire. <br><br>  Nous prenons le fichier .apk des services Google Play de la m√™me version que celle install√©e sur l'appareil (ou, si l'appareil est enracin√©, prenez simplement le fichier directement √† partir de l√†).  En utilisant dex2jar, nous reconvertissons le fichier .dex en .jar et ouvrons dans un d√©compilateur de choix.  J'aime personnellement Fernflower de JetBrains.  Il fonctionne comme un plugin pour IntelliJ IDEA (ou Android Studio), nous lan√ßons donc simplement Android Studio et ouvrons le fichier avec le lien que nous essayons d'analyser.  Si proguard n'essayait pas trop, le code Java d√©compil√© pour cr√©er des messages protobuf pourrait simplement √™tre copi√©-coll√© dans votre projet. <br><br>  En regardant le code d√©compil√©, nous voyons que Build. * Les constantes sont envoy√©es √† l'int√©rieur du message protobuf.  (d'accord, ce n'√©tait pas trop difficile √† deviner). <br><br><pre> <code class="java hljs">... var3.a(<span class="hljs-string"><span class="hljs-string">"4.0.33 (910055-30)"</span></span>); a(var3, <span class="hljs-string"><span class="hljs-string">"BOARD"</span></span>, Build.BOARD); a(var3, <span class="hljs-string"><span class="hljs-string">"BOOTLOADER"</span></span>, Build.BOOTLOADER); a(var3, <span class="hljs-string"><span class="hljs-string">"BRAND"</span></span>, Build.BRAND); a(var3, <span class="hljs-string"><span class="hljs-string">"CPU_ABI"</span></span>, Build.CPU_ABI); a(var3, <span class="hljs-string"><span class="hljs-string">"CPU_ABI2"</span></span>, Build.CPU_ABI2); a(var3, <span class="hljs-string"><span class="hljs-string">"DEVICE"</span></span>, Build.DEVICE); ...</code> </pre><br>  Mais malheureusement, dans la r√©ponse du serveur, tous les champs de protobuf se sont transform√©s en soupe √† l'alphabet apr√®s l'obscurcissement.  Mais nous pouvons d√©couvrir ce qu'il contient en utilisant un gestionnaire d'erreurs.  Voici comment les donn√©es provenant du serveur sont v√©rifi√©es: <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!var7.d()) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> bdf(<span class="hljs-string"><span class="hljs-string">"byteCode"</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!var7.f()) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> bdf(<span class="hljs-string"><span class="hljs-string">"vmUrl"</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!var7.h()) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> bdf(<span class="hljs-string"><span class="hljs-string">"vmChecksum"</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!var7.j()) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> bdf(<span class="hljs-string"><span class="hljs-string">"expiryTimeSecs"</span></span>); }</code> </pre><br>  Apparemment, c'est ainsi que les champs √©taient appel√©s avant l'obfuscation: <b>byteCode</b> , <b>vmUrl</b> , <b>vmChecksum</b> et <b>expiryTimeSecs</b> .  Ce sch√©ma de d√©nomination nous donne d√©j√† quelques id√©es. <br><br>  Nous combinons toutes les classes d√©compil√©es de Google Play Services dans un projet de test, les renommons, g√©n√©rons le test Build. * Commandes et lancons (imitant tout appareil que nous voulons).  Si quelqu'un veut le faire lui-m√™me, voici <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">le lien vers mon GitHub</a> . <br><br>  Si la demande est correcte, le serveur renvoie ceci: <br><blockquote>  00: 06: 26.761 [principal] INFO daresponse.AntiabuseResponse - octet Taille du code: 34446 <br>  00: 06: 26.761 [principal] INFO daresponse.AntiabuseResponse - vmChecksum: C15E93CCFD9EF178293A2334A1C9F9B08F115993 <br>  00: 06: 26.761 [principal] INFO daresponse.AntiabuseResponse - vmUrl: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">www.gstatic.com/droidguard/C15E93CCFD9EF178293A2334A1C9F9B08F115993</a> <br>  00: 06: 26.761 [principal] INFO daresponse.AntiabuseResponse - expiryTimeSecs: 10 </blockquote><br>  √âtape 1 termin√©e.  Voyons maintenant ce qui se cache derri√®re le lien <b>vmUrl</b> . <br><br><h3>  Secret APK </h3><br>  Le lien nous m√®ne directement √† un fichier .apk, nomm√© d'apr√®s son propre hachage SHA-1.  C'est plut√¥t minuscule - seulement 150 Ko.  Et c'est tout √† fait justifi√©: s'il est t√©l√©charg√© par chacun des 2 milliards d'appareils Android, cela repr√©sente 270 To de trafic sur les services de Google. <br><br><img src="https://habrastorage.org/webt/-s/di/nj/-sdinjinilpprsvgslvs3e6gsdk.png"><br><br>  <code>DroidGuardService</code> classe <code>DroidGuardService</code> , faisant partie des services Google Play, t√©l√©charge le fichier sur l'appareil, le d√©compresse, extrait .dex et utilise la classe <code>com.google.ccc.abuse.droidguard.DroidGuard</code> par r√©flexion.  En cas d'erreur, <code>DroidGuardService</code> de DroidGuard √† Droidguasso.  Mais c'est une autre histoire enti√®rement. <br><br>  Essentiellement, la classe <code>DroidGuard</code> est un simple wrapper JNI autour de la biblioth√®que native .so.  L'ABI de la biblioth√®que native correspond √† ce que nous avons envoy√© dans le champ <code>CPU_ABI</code> dans la requ√™te protobuf: nous pouvons demander armeabi, x86 ou m√™me MIPS. <br><br>  Le service <code>DroidGuardService</code> lui-m√™me ne contient aucune logique int√©ressante pour travailler avec la classe <code>DroidGuard</code> .  Il cr√©e simplement une nouvelle instance de <code>DroidGuard</code> , lui envoie le <b>byteCode √†</b> partir du message protobuf, appelle une m√©thode publique, qui retourne un tableau d'octets.  Ce tableau est ensuite envoy√© au serveur √† l'int√©rieur du param√®tre <b>droidguard_result</b> . <br><br>  Pour avoir une id√©e approximative de ce qui se passe √† l'int√©rieur de <code>DroidGuard</code> nous pouvons r√©p√©ter la logique de <code>DroidGuardService</code> (mais sans t√©l√©charger le .apk, car nous avons d√©j√† la biblioth√®que native).  Nous pouvons prendre un fichier .dex de l'APK secret, le convertir en .jar et ensuite l'utiliser dans notre projet.  Le seul probl√®me est de savoir comment la classe <code>DroidGuard</code> charge la biblioth√®que native.  Le bloc d'initialisation statique appelle la m√©thode <code>loadDroidGuardLibrary()</code> : <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">static</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { loadDroidGuardLibrary(); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (Exception ex) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> RuntimeException(ex); } }</code> </pre><br>  Ensuite, la m√©thode <code>loadDroidGuardLibrary()</code> lit library.txt (situ√©e √† la racine du fichier .apk) et charge la biblioth√®que avec ce nom <code>System.load(String filename)</code> l' <code>System.load(String filename)</code> .  Pas tr√®s pratique pour nous, car nous aurions besoin de construire le .apk d'une mani√®re tr√®s sp√©cifique pour mettre library.txt et le fichier .so dans sa racine.  Il serait beaucoup plus pratique de conserver le fichier .so dans le dossier lib et de le charger via <code>System.loadLibrary(String libname)</code> . <br><br>  Ce n'est pas difficile √† faire.  Nous utiliserons <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">smali / baksmali</a> - assembleur / d√©sassembleur pour les fichiers .dex.  Apr√®s l'avoir utilis√©, classes.dex se transforme en un tas de fichiers .smali.  La classe <code>com.google.ccc.abuse.droidguard.DroidGuard</code> doit √™tre modifi√©e de sorte que le bloc d'initialisation statique appelle la <code>System.loadLibrary("droidguard")</code> au lieu de <code>loadDroidGuardLibrary()</code> .  La syntaxe de Smali est assez simple, le nouveau bloc d'initialisation ressemble √† ceci: <br><br><pre> <code class="plaintext hljs">.method static constructor &lt;clinit&gt;()V .locals 1 const-string v0, "droidguard" invoke-static {v0}, Ljava/lang/System;-&gt;loadLibrary(Ljava/lang/String;)V return-void .end method</code> </pre><br>  Ensuite, nous utilisons backsmali pour tout reconstruire en .dex, puis nous le convertissons en .jar.  √Ä la fin, nous obtenons un fichier .jar que nous pouvons utiliser dans notre projet - le <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">voici</a> d'ailleurs. <br><br>  Toute la section li√©e √† DroidGuard est longue de quelques cha√Ænes.  La partie la plus importante est de t√©l√©charger le tableau d'octets que nous avons obtenu √† l'√©tape pr√©c√©dente apr√®s avoir adress√© le service anti-abus et de le remettre au constructeur <code>DroidGuard</code> : <br><br><pre> <code class="kotlin hljs"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">runDroidguard</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> byteCode: ByteArray? = loadBytecode(<span class="hljs-string"><span class="hljs-string">"bytecode.base64"</span></span>); byteCode?.let { <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> droidguard = DroidGuard(applicationContext, <span class="hljs-string"><span class="hljs-string">"addAccount"</span></span>, it) <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> params = mapOf(<span class="hljs-string"><span class="hljs-string">"dg_email"</span></span> to <span class="hljs-string"><span class="hljs-string">"test@gmail.com"</span></span>, <span class="hljs-string"><span class="hljs-string">"dg_gmsCoreVersion"</span></span> to <span class="hljs-string"><span class="hljs-string">"910055-30"</span></span>, <span class="hljs-string"><span class="hljs-string">"dg_package"</span></span> to <span class="hljs-string"><span class="hljs-string">"com.google.android.gms"</span></span>, <span class="hljs-string"><span class="hljs-string">"dg_androidId"</span></span> to UUID.randomUUID().toString()) droidguard.<span class="hljs-keyword"><span class="hljs-keyword">init</span></span>() <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> result = droidguard.ss(params) droidguard.close() } }</code> </pre><br>  Maintenant, nous pouvons utiliser le profileur d'Android Studio et voir ce qui se passe pendant le travail de DroidGuard: <br><br><img src="https://habrastorage.org/webt/c-/9w/pz/c-9wpzbrrpibjyflhyrunq3azu0.png"><br><br>  La m√©thode native initNative () collecte des donn√©es sur le p√©riph√©rique et appelle les m√©thodes Java <code>hasSystemFeature(), getMemoryInfo(), getPackageInfo()</code> ... c'est quelque chose, mais je ne vois toujours pas de logique solide.  Eh bien, il ne reste plus qu'√† d√©monter le fichier .so. <br><br><h3>  libdroidguard.so </h3><br>  Heureusement, l'analyse de la biblioth√®que native n'est pas plus difficile que de le faire avec des fichiers .dex et .jar.  Nous aurions besoin d'une application similaire √† Hex-Rays IDA et d'une certaine connaissance du code assembleur x86 ou ARM.  J'ai choisi ARM, car j'avais un appareil enracin√© √† d√©boguer.  Si vous n'en avez pas, vous pouvez prendre une biblioth√®que x86 et d√©boguer √† l'aide d'un √©mulateur. <br><br>  Une application similaire √† Hex-Rays IDA d√©compile le binaire en quelque chose qui ressemble au code C.  Si nous ouvrons la m√©thode <code>Java_com_google_ccc_abuse_droidguard_DroidGuard_ssNative</code> , nous verrons quelque chose comme ceci: <br><br><pre> <code class="cpp hljs">__int64 __<span class="hljs-function"><span class="hljs-function">fastcall </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Java_com_google_ccc_abuse_droidguard_DroidGuard_initNative</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> a1, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> a2, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> a3, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> a4, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> a5, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> a6, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> a7, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> a8, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> a9)</span></span></span><span class="hljs-function"> ... v14 </span></span>= (*(_DWORD *)v9 + <span class="hljs-number"><span class="hljs-number">684</span></span>))(v9, a5); v15 = (*(_DWORD *)v9 + <span class="hljs-number"><span class="hljs-number">736</span></span>))(v9, a5, <span class="hljs-number"><span class="hljs-number">0</span></span>); ...</code> </pre><br>  Ne semble pas trop prometteur.  Nous devons d'abord faire quelques √©tapes pr√©liminaires pour transformer cela en quelque chose de plus utile.  Le d√©compilateur ne sait rien de JNI, nous installons donc Android NDK et importons le fichier jni.h.  Comme nous le savons, les deux premiers param√®tres d'une m√©thode JNI sont <code>JNIEnv*</code> et <code>jobject (this)</code> .  Nous pouvons d√©couvrir les types d'autres param√®tres √† partir du code Java de DroidGuard.  Apr√®s avoir attribu√© les types corrects, les d√©calages sans signification se transforment en appels de m√©thode JNI: <br><br><pre> <code class="cpp hljs">__int64 __<span class="hljs-function"><span class="hljs-function">fastcall </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Java_com_google_ccc_abuse_droidguard_DroidGuard_initNative</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(_JNIEnv *env, jobject thiz, jobject context, jstring flow, jbyteArray byteCode, jobject runtimeApi, jobject extras, jint loggingFd, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> runningInAppSide)</span></span></span><span class="hljs-function"> </span></span>{ ... programLength = _env-&gt;functions-&gt;GetArrayLength)(_env, byteCode); programBytes = (jbyte *)_env-&gt;functions-&gt;GetByteArrayElements)(_env, byteCode, <span class="hljs-number"><span class="hljs-number">0</span></span>); ...</code> </pre><br>  Si nous avons assez de patience pour retracer le tableau d'octets re√ßu du serveur anti-abus, nous serons ... d√©√ßus.  Malheureusement, il n'y a pas de r√©ponse simple √† "que se passe-t-il ici?".  C'est du code d'octets pur et distill√©, et la biblioth√®que native est une machine virtuelle.  Un chiffrement AES saupoudr√© sur le dessus, puis la machine virtuelle lit le code octet, octet par octet, et ex√©cute des commandes.  Chaque octet est une commande suivie d'op√©randes.  Il n'y a pas beaucoup de commandes, seulement environ 70: lire int, lire octet, lire cha√Æne, appeler m√©thode Java, multiplier deux nombres, if-goto etc. <br><br><h3>  R√©veillez-vous n√©o </h3><br>  J'ai d√©cid√© d'aller encore plus loin et de comprendre la structure du code d'octet pour cette machine virtuelle.  Il y a un autre probl√®me avec les appels: parfois (une fois toutes les deux semaines) il y a une nouvelle version de la biblioth√®que native o√π les paires octet-commande sont brouill√©es.  Cela ne m'a pas arr√™t√© et j'ai d√©cid√© de recr√©er la VM en utilisant Java. <br><br>  Le code d'octet fait tout le travail de routine sur la collecte d'informations sur le p√©riph√©rique.  Par exemple, il charge une cha√Æne avec le nom d'une m√©thode, obtient son adresse via dlsym et s'ex√©cute.  Dans ma version Java de la machine virtuelle, j'ai recr√©√© seulement 5 m√©thodes environ et j'ai appris √† interpr√©ter les 25 premi√®res commandes du code d'octet du service anti-abus.  Lors de la 26e commande, la machine virtuelle a lu une autre cha√Æne chiffr√©e √† partir du code d'octet.  Il s'est av√©r√© que ce n'√©tait pas le nom d'une autre m√©thode.  Loin de l√†. <br><blockquote>  Commande de machine virtuelle # 26 <br>  Invocation de m√©thode vm-&gt; vm_method_table [2 * 0x77] <br>  M√©thode vmMethod_readString <br>  l'index est 0x9d <br>  la longueur de la cha√Æne est 0x0066 <br>  (une nouvelle cl√© est g√©n√©r√©e) <br>  les octets de cha√Æne cod√©s sont EB 4E E6 DC 34 13 35 4A DD 55 B3 91 33 05 61 04 C0 54 FD 95 2F 18 72 04 C1 55 E1 92 28 11 66 04 DD 4F B3 94 33 04 35 0A C1 4E B2 DB 12 17 79 4F 92 55 FC DB 33 05 35 45 C6 01 F7 89 29 1F 71 43 C7 40 E1 9F 6B 1E 70 48 DE 4E B8 CD 75 44 23 14 85 14 A7 C2 7F 40 26 42 84 17 A2 BB 21 19 7A 43 DE 44 BD 98 29 1B <br>  les octets de cha√Æne d√©cod√©s sont 59 6F 75 27 72 65 20 6E 6F 74 20 6A 75 73 74 20 72 75 6E 6E 69 6E 67 20 73 74 72 69 6E 67 73 20 6F 6E 20 6F 75 72 20 2E 73 6F 21 20 54 61 6C 6B 20 74 6F 20 75 73 20 61 74 20 64 72 6F 69 64 67 75 61 72 64 2D 68 65 6C 6C 6F 2B 36 33 32 36 30 37 35 34 39 39 36 33 66 36 36 31 40 67 6F 6F 67 6C 65 2E 63 6F 6D <br>  la valeur de cha√Æne d√©cod√©e est ( <b>Vous n'√™tes pas en train d'ex√©cuter des cha√Ænes sur notre .so! Parlez-nous √† droidguard@google.com</b> ) </blockquote>  C'est √©trange.  Une machine virtuelle ne m'a jamais parl√© auparavant.  Je pensais que si vous commencez √† voir des messages secrets dirig√©s vers vous, vous devenez fou.  Juste pour m'assurer que j'√©tais toujours sain d'esprit, j'ai ex√©cut√© quelques centaines de r√©ponses diff√©rentes du service anti-abus via ma machine virtuelle.  Litt√©ralement toutes les 25 √† 30 commandes, un message √©tait cach√© dans le code d'octet.  Ils ont souvent r√©p√©t√©, mais voici quelques exemples uniques.  J'ai cependant modifi√© les adresses e-mail: chaque message avait une adresse diff√©rente, quelque chose comme "droidguard+tag@google.com", la balise √©tant unique pour chacun. <br><blockquote>  droidguard@google.com: ne soyez pas un √©tranger! <br>  Vous √™tes entr√©!  Parlez-nous √† droidguard@google.com <br>  Salutations de droidguard@google.com voyageur intr√©pide!  Dites bonjour! <br>  √âtait-ce facile de trouver √ßa?  droidguard@google.com aimerait savoir <br>  Les gens de droidguard@google.com appr√©cieraient d'avoir de vos nouvelles! <br>  Quel est tout ce charabia?  Demandez √† droidguard@google.com ... ils sauraient! <br>  H√©!  Envie de vous voir ici.  Avez-vous d√©j√† parl√© √† droidguard@google.com? <br>  Vous ne faites pas que courir des cordes sur notre .so!  Parlez-nous √† droidguard@google.com <br></blockquote>  Suis-je l'√©lu?  Je pensais qu'il √©tait temps d'arr√™ter de jouer avec DroidGuard et de parler √† Google, car ils me l'avaient demand√©. <br><br><h3>  Votre appel est tr√®s important pour nous </h3><br>  J'ai racont√© mes d√©couvertes sur l'e-mail que j'ai trouv√©.  Pour rendre les r√©sultats un peu plus impressionnants, j'ai automatis√© un peu le processus d'analyse.  Le fait est que les cha√Ænes et les tableaux d'octets sont stock√©s dans le code d'octets crypt√©.  La machine virtuelle les d√©code √† l'aide de constantes int√©gr√©es par le compilateur.  En utilisant une application similaire √† Hex-Rays IDA, vous pouvez les extraire assez facilement.  Mais √† chaque nouvelle version, les constantes changent et il est assez peu pratique de toujours les extraire manuellement. <br><br>  Mais l'analyse Java de la biblioth√®que native s'est av√©r√©e √©tonnamment simple.  En utilisant <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">jelf</a> (une biblioth√®que pour analyser les fichiers ELF), nous trouvons l'offset de la m√©thode <code>Java_com_google_ccc_abuse_droidguard_DroidGuard_initNative</code> dans le binaire, puis en utilisant <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Capstone</a> (un cadre de d√©montage avec des liaisons pour diverses langues, y compris Java), nous obtenons le code assembleur et le recherchons pour charger des constantes dans registres. <br><br>  √Ä la fin, j'ai obtenu une application qui √©mulait l'ensemble du processus DroidGuard: fait une demande au service anti-abus, t√©l√©charge le .apk, le d√©compresse, analyse la biblioth√®que native, extrait les constantes requises, s√©lectionne le mappage des commandes VM et interpr√®te le code d'octet.  J'ai tout compil√© et envoy√© √† Google.  Pendant que j'y √©tais, j'ai commenc√© √† pr√©parer un d√©m√©nagement et j'ai cherch√© sur Glassdoor pour un salaire moyen chez Google.  J'ai d√©cid√© de ne pas accepter moins de six chiffres. <br><br>  La r√©ponse ne tarda pas.  Un e-mail d'un membre de l'√©quipe DroidGuard disait simplement: "Pourquoi faites-vous cela?" <br><br><img src="https://habrastorage.org/webt/go/ql/kf/goqlkffwq02w6daa9-e22xxgdiq.jpeg"><br><br>  ¬´Parce que je peux¬ª - ai-je r√©pondu.  Un employ√© de Google m'a expliqu√© que DroidGuard est cens√© prot√©ger Android contre les pirates (vous ne le dites pas!) Et il serait sage de garder pour moi le code source de ma machine virtuelle DroidGuard.  Notre conversation s'est termin√©e l√†. <br><br><h3>  Interview </h3><br>  Un mois plus tard, j'ai re√ßu un autre e-mail.  L'√©quipe DroidGuard de Zurich avait besoin d'un nouvel employ√©.  √âtais-je int√©ress√© √† rejoindre?  Bien s√ªr! <br><br>  Il n'y a pas de raccourci pour acc√©der √† Google.  Tout ce que je pouvais faire √©tait de transmettre mon CV au service RH.  Apr√®s cela, j'ai d√ª passer par le marasme bureaucratique habituel et une s√©rie d'entretiens. <br><br>  Il y a beaucoup d'histoires sur les interviews de Google.  Les algorithmes, les t√¢ches de l'Olympiade et la programmation de Google Docs ne sont pas mon truc, alors j'ai commenc√© mes pr√©paratifs.  J'ai lu le cours ¬´Algorithmes¬ª de Coursera des dizaines de fois, r√©solu des centaines de t√¢ches sur Hackerrank et appris √† contourner un graphique dans les deux dimensions les yeux ferm√©s. <br><br>  Deux mois se sont √©coul√©s.  Dire que je me sentais pr√©par√© serait un euph√©misme.  Google Docs est devenu mon IDE pr√©f√©r√©.  J'avais l'impression de tout savoir sur les algorithmes.  Bien s√ªr, je connaissais mes faiblesses et j'ai r√©alis√© que je ne passerais probablement pas la s√©rie de 5 interviews √† Zurich, mais aller au Disneyland du programmeur gratuitement √©tait une r√©compense en soi.  La premi√®re √©tape a √©t√© un entretien t√©l√©phonique pour √©liminer les candidats les plus faibles et ne pas perdre le temps des d√©veloppeurs zurichois lors de r√©unions en personne.  Le jour √©tait fix√©, le t√©l√©phone sonna ... <br><br><img src="https://habrastorage.org/webt/5c/nk/uh/5cnkuh5btyvoaz0pyz-zma3flzs.png"><br><br>  ... et j'ai imm√©diatement √©chou√© √† mon premier test.  J'ai eu de la chance - ils ont pos√© une question que j'ai d√©j√† vue sur Internet et que j'ai d√©j√† r√©solue.  Il s'agissait de s√©rialiser un tableau de cha√Ænes.  J'ai propos√© de coder des cha√Ænes en Base64 et de les enregistrer via un diviseur.  L'intervieweur m'a demand√© de d√©velopper un algorithme Base64.  Apr√®s cela, l'interview s'est transform√©e en une sorte de monologue, o√π l'interview√© m'a expliqu√© comment fonctionne Base64 et j'ai essay√© de me souvenir des op√©rations sur les bits en Java. <br><br><div class="spoiler">  <b class="spoiler_title">Si quelqu'un chez Google lit ceci</b> <div class="spoiler_text">  Les gars, vous √™tes des g√©nies sanglants si vous y √™tes!  S√©rieusement.  Je ne peux pas imaginer comment on peut franchir tous les obstacles qu'ils mettent devant vous. <br></div></div><br>  3 jours apr√®s l'appel, j'ai re√ßu un e-mail me disant qu'ils ne voulaient plus m'interviewer.  Et c'est ainsi que ma communication avec Google s'est termin√©e. <br><br>  Pourquoi il y a des messages dans DroidGuard demandant √† discuter, je n'en ai toujours aucune id√©e.  Probablement juste pour les statistiques.  Le gars √† qui j'ai √©crit en premier m'a dit que les gens y √©crivaient, mais la fr√©quence varie: parfois ils obtiennent 3 r√©ponses en une semaine, parfois 1 par an. <br><br>  Je pense qu'il existe des moyens plus faciles d'obtenir une interview chez Google.  Apr√®s tout, vous pouvez simplement demander √† l'un des 100 000 employ√©s (bien que tous ne soient pas des d√©veloppeurs, certes).  Mais c'√©tait quand m√™me une exp√©rience amusante. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr446790/">https://habr.com/ru/post/fr446790/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr446776/index.html">Preuve de travail efficace</a></li>
<li><a href="../fr446780/index.html">Comment cr√©er un th√®me sombre et ne pas nuire. Exp√©rience de l'√©quipe Yandex.Mail</a></li>
<li><a href="../fr446782/index.html">Yo-ho-ho et une bouteille de rhum</a></li>
<li><a href="../fr446786/index.html">Pourquoi ai-je refus√© Disqus et tu devrais y aller aussi</a></li>
<li><a href="../fr446788/index.html">Trucs et astuces Kubernetes: sur le d√©veloppement local et la t√©l√©pr√©sence</a></li>
<li><a href="../fr446794/index.html">Nous travaillons correctement avec Wordstat. Guide complet</a></li>
<li><a href="../fr446796/index.html">Circuit non standard: indicateur √† sept segments sur ATtiny13</a></li>
<li><a href="../fr446798/index.html">Le d√©part d'un ing√©nieur √©lectronique d'Apple a fait sensation parmi les sp√©culateurs boursiers. Comment devenir comme lui?</a></li>
<li><a href="../fr446802/index.html">Recharge de cartouches Dot - c'est int√©ressant</a></li>
<li><a href="../fr446806/index.html">Contexte: "Runet autonome" - qu'est-ce que c'est et qui en a besoin</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>