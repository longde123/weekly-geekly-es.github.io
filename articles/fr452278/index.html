<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë¶üèΩ üôèüèº üßùüèª Bluetooth LE n'est pas si effrayant, ou comment am√©liorer l'exp√©rience utilisateur sans trop d'effort üêá üíÜüèΩ üåû</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="R√©cemment, notre √©quipe a con√ßu et mis en ≈ìuvre la fonction de transfert d'argent par voie a√©rienne √† l'aide de la technologie Bluetooth LE. Je veux v...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Bluetooth LE n'est pas si effrayant, ou comment am√©liorer l'exp√©rience utilisateur sans trop d'effort</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/raiffeisenbank/blog/452278/">  R√©cemment, notre √©quipe a con√ßu et mis en ≈ìuvre la fonction de transfert d'argent par voie a√©rienne √† l'aide de la technologie Bluetooth LE.  Je veux vous dire comment nous l'avons fait et ce que Apple nous offre √† partir des outils.  De nombreux d√©veloppeurs pensent que Bluetooth est difficile, car il s'agit d'un protocole de bas niveau, et il n'y a pas beaucoup d'experts √† ce sujet.  Mais tout n'est pas si effrayant, et en fait, utiliser cette fonction est tr√®s simple!  Et ces fonctions qui peuvent √™tre impl√©ment√©es √† l'aide de Bluetooth LE sont certainement int√©ressantes et mettront par la suite en valeur votre application parmi les concurrents. <br><br><img src="https://habrastorage.org/webt/97/vu/bb/97vubbbho3z3z4dx_fwnztumh9u.png"><br><a name="habracut"></a><br>  Commen√ßons par comprendre de quel type de technologie il s'agit et quelle est sa diff√©rence par rapport au Bluetooth classique. <br><br><h3>  Qu'est-ce que Bluetooth LE? </h3><br>  Pourquoi les d√©veloppeurs Bluetooth ont-ils nomm√© cette technologie √† savoir Low Energy?  Apr√®s tout, avec chaque nouvelle version de Bluetooth, la consommation d'√©nergie √©tait d√©j√† beaucoup plus faible.  La r√©ponse r√©side dans cette batterie. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/ce/qb/65/ceqb65oxhimqzgzovufqysqvsqk.png"></div><br>  Son diam√®tre n'est que de 2 cm et sa capacit√© est d'environ 220 mA * h.  Lorsque les ing√©nieurs ont d√©velopp√© Bluetooth LE, ils voulaient que l'appareil avec une telle batterie fonctionne pendant plusieurs ann√©es.  Et ils l'ont fait!  Les appareils Bluetooth LE dot√©s d'une telle batterie peuvent fonctionner pendant un an.  Combien d'entre vous d√©sactivent toujours le Bluetooth sur votre t√©l√©phone √† l'ancienne pour √©conomiser de l'√©nergie, comme vous l'avez fait en 2000?  En vain, vous faites cela - les √©conomies seront inf√©rieures √† 10 secondes du t√©l√©phone par jour.  Et vous d√©sactivez de tr√®s grandes fonctionnalit√©s, telles que Handoff, AirDrop et autres. <br><br>  Qu'ont r√©alis√© les ing√©nieurs en d√©veloppant Bluetooth LE?  Ont-ils affin√© le protocole classique?  Le rend plus √©conome en √©nergie?  Vous venez d'optimiser tous les processus?  Non.  Ils ont compl√®tement repens√© l'architecture de la pile Bluetooth et ont r√©alis√© que maintenant, pour √™tre visible par tous les autres appareils, vous avez besoin de moins de temps pour √™tre en ondes et occuper le canal.  √Ä son tour, cela a permis une bonne √©conomie sur la consommation d'√©nergie.  Et avec la nouvelle architecture, tout nouvel appareil peut d√©sormais √™tre standardis√©, gr√¢ce auquel les d√©veloppeurs du monde entier peuvent communiquer avec l'appareil et, par cons√©quent, √©crire facilement de nouvelles applications pour le g√©rer.  De plus, le principe de la d√©couverte de soi est int√©gr√© dans l'architecture: lors de la connexion √† un appareil, vous n'avez pas besoin de saisir de code PIN, et si votre application peut communiquer avec cet appareil, la connexion prend quelques millisecondes. <br><br><ul><li>  Moins de temps sur l'air. </li><li>  Moins de consommation d'√©nergie. </li><li>  Nouvelle architecture. </li><li>  Temps de connexion r√©duit. </li></ul><br>  <b>Comment les ing√©nieurs ont-ils r√©ussi √† faire un si grand bond en mati√®re d'efficacit√© √©nerg√©tique?</b> <br><br>  La fr√©quence est rest√©e la m√™me: 2,4 GHz, non certifi√©e et gratuite pour une utilisation dans de nombreux pays.  Mais le d√©lai de connexion est devenu moindre: 15-30 ms au lieu de 100 ms avec le Bluetooth classique.  La distance de travail est rest√©e la m√™me - 100 m. L'intervalle de transmission n'√©tait pas fort, mais a chang√© - au lieu de 0,625 ms, il est devenu 3 ms. <br><br>  Mais pour cette raison, la consommation d'√©nergie n'a pas pu √™tre d√©cupl√©e.  Bien s√ªr, quelque chose devait souffrir.  Et c'est la vitesse: au lieu de 24 Mbps, c'est devenu 0,27 Mbps.  Vous direz probablement que c'est une vitesse ridicule pour 2018. <br><br><h3>  O√π Bluetooth LE est-il utilis√©? </h3><br><img src="https://habrastorage.org/webt/bz/0r/ca/bz0rcanj9nvdu_gijz0f6ip3h18.png"><br><br>  Cette technologie n'est pas jeune, elle est apparue pour la premi√®re fois sur l'iPhone 4s.  Et d√©j√† r√©ussi √† conqu√©rir de nombreux domaines.  Bluetooth LE est utilis√© dans tous les appareils domestiques intelligents et l'√©lectronique portable.  Maintenant, il y a m√™me des chips de la taille des grains de caf√©. <br><br><img src="https://habrastorage.org/webt/ex/0c/go/ex0cgowkyn9nhzx_c5vnwvn7v3g.png"><br><br>  <b>Et comment cette technologie est-elle appliqu√©e aux logiciels?</b> <br><br>  Depuis qu'Apple a √©t√© le premier √† int√©grer Bluetooth dans leur appareil et √† commencer √† l'utiliser, ils ont d√©sormais bien progress√© et int√©gr√© la technologie dans leur √©cosyst√®me.  Et maintenant, vous pouvez rencontrer cette technologie dans des services tels que AirDrop, d√©marrage rapide des appareils, partage des mots de passe, transfert.  Et m√™me les notifications de la montre sont effectu√©es via Bluetooth LE.  En outre, Apple a mis √† la disposition du public une documentation sur la fa√ßon de s'assurer que les notifications de toutes les applications parviennent √† vos propres appareils.  Quels sont les r√¥les des appareils dans Bluetooth LE? <br><br><img src="https://habrastorage.org/webt/vd/gk/85/vdgk85ww_wcqq_jykxexwqidgcw.png"><br><br>  <b>Brodcaster.</b>  Envoie des messages √† tous ceux qui se trouvent √† proximit√©, vous ne pouvez pas vous connecter √† cet appareil.  Par ce principe, les iBeacons et la navigation int√©rieure fonctionnent. <br><br>  <b>Observateur.</b>  √âcoute ce qui se passe et ne re√ßoit des donn√©es que des messages publics.  Ne cr√©e pas de connexions. <br><br>  Mais avec <b>Central</b> et <b>p√©riph√©rique</b> plus int√©ressant.  Pourquoi ne s'appelaient-ils pas simplement serveur-client?  Logiquement, √† en juger par le nom.  Mais non. <br><br>  Parce que Peripheral agit en fait comme un serveur.  Il s'agit d'un p√©riph√©rique qui consomme moins d'√©nergie et se connecte √† la centrale plus puissante.  Le p√©riph√©rique peut vous informer de sa proximit√© et de ses services.  Un seul appareil peut s'y connecter et le p√©riph√©rique poss√®de des donn√©es.  Et Central peut analyser l'air √† la recherche d'appareils, envoyer des demandes de connexion, se connecter √† n'importe quel nombre d'appareils, lire, √©crire et s'abonner aux donn√©es de Peripheral. <br><br>  √Ä quoi avons-nous acc√®s en tant que d√©veloppeurs dans l'√©cosyst√®me Apple? <br><br><h3>  Qu'est-ce qui est √† notre disposition? </h3><br>  <b>iOS / Mac OS:</b> <br><br><ul><li>  P√©riph√©rique et Central. </li><li>  Mode fond. </li><li>  R√©cup√©ration de l'√©tat. </li><li>  Intervalle de connexion 15 ms. </li></ul><br>  <b>watchOS / tvOS:</b> <br><br><ul><li>  watchOS 4+ / tvOS 9+. </li><li>  Central seulement. </li><li>  Maximum deux connexions. </li><li>  Apple Watch s√©rie 2+ / AppleTv 4+. </li><li>  Arr√™t lors de l'entr√©e en arri√®re-plan. </li><li>  Intervalle de connexion 30 ms. </li></ul><br>  La diff√©rence la plus importante est l'intervalle de connexion.  Qu'est-ce que cela affecte?  Pour r√©pondre √† cette question, vous devez d'abord comprendre comment fonctionne le protocole Bluetooth LE et pourquoi une si petite diff√©rence en valeurs absolues est tr√®s importante. <br><br><h3>  Fonctionnement du protocole </h3><br>  Comment se d√©roule le processus de recherche et de connexion? <br><br>  Peripheral annonce sa pr√©sence √† la fr√©quence de l'intervalle de publicit√©, son package est tr√®s petit et ne contient que quelques identifiants de service fournis par l'appareil, ainsi que le nom de l'appareil.  L'intervalle peut √™tre assez long et peut varier en fonction de l'√©tat actuel de l'appareil, du mode d'√©conomie d'√©nergie et d'autres param√®tres.  Apple conseille aux d√©veloppeurs d'appareils externes de lier la longueur de l'intervalle √† l'acc√©l√©rom√®tre: augmentez l'intervalle si l'appareil n'est pas utilis√©, et lorsqu'il est actif, diminuez pour trouver rapidement l'appareil.  L'intervalle de publication ne correspond pas √† l'intervalle de connexion et est d√©termin√© par le p√©riph√©rique lui-m√™me, en fonction de la consommation d'√©nergie et de ses param√®tres.  Il est inaccessible et inconnu de nous dans l'√©cosyst√®me Apple, il est enti√®rement contr√¥l√© par le syst√®me. <br><br><img src="https://habrastorage.org/webt/na/_v/66/na_v662ojn9_xtvkdfma2wxyfaa.png"><br><br>  Apr√®s avoir trouv√© l'appareil, nous envoyons une demande de connexion, et ici l'intervalle de connexion entre en sc√®ne - le temps apr√®s lequel le deuxi√®me appareil peut r√©pondre √† la demande.  Mais c'est lors de la connexion, mais que se passe-t-il lors de la lecture / √©criture? <br><br><img src="https://habrastorage.org/webt/iq/mv/hg/iqmvhgecmnlikziagjsbda4vxe0.png"><br><br>  L'intervalle de connexion appara√Æt √©galement lors de la lecture des donn√©es - une r√©duction de 2 fois augmente le taux de transfert de donn√©es.  Mais vous devez comprendre que si les deux appareils ne prennent pas en charge le m√™me intervalle, le maximum d'entre eux sera s√©lectionn√©. <br><br>  Voyons en quoi consiste un paquet d'informations que le p√©riph√©rique transmet. <br><br>  La MTU (unit√© de transmission maximale) d'un tel package est d√©termin√©e au cours du processus de connexion et varie d'un appareil √† l'autre et en fonction du syst√®me d'exploitation.  Dans la version de protocole 4.0, le MTU √©tait d'environ 30 et la taille de la charge utile ne d√©passait pas 20 octets.  Dans la version 4.2, tout a chang√©, vous pouvez d√©sormais transf√©rer environ 520 octets.  Mais, malheureusement, seuls les appareils plus jeunes que l'iPhone 5 prennent en charge cette version du protocole.  La taille de la surcharge, quelle que soit la taille du MTU, est de 7 octets: cela inclut les en-t√™tes ATT et L2CAP.  Avec le dossier, en g√©n√©ral, une situation similaire. <br><br><img src="https://habrastorage.org/webt/gp/zi/ho/gpzihocxxa6po-lfmmlqyl5e7wu.png"><br><br>  Il n'y a que deux modes: avec r√©ponse et sans.  Le mode sans r√©ponse acc√©l√®re consid√©rablement le transfert de donn√©es, car il n'y a pas d'intervalle d'attente avant le prochain enregistrement.  Mais ce mode n'est pas toujours disponible, pas sur tous les appareils et pas sur tous les syst√®mes.  L'acc√®s √† ce mode d'enregistrement peut √™tre limit√© par le syst√®me lui-m√™me, car il est consid√©r√© comme moins √©conome en √©nergie.  Dans iOS, il existe une m√©thode dans laquelle vous pouvez v√©rifier avant d'enregistrer si ce mode est disponible. <br><br>  Voyons maintenant en quoi consiste le protocole. <br><br><img src="https://habrastorage.org/webt/um/mh/um/ummhumgo7y_x3aeeu03wcv9shiy.png"><br><br>  Le protocole comprend 5 niveaux.  <b>La couche application</b> est votre logique, d√©crite au-dessus de CoreBluetooth.  <b>GATT (Generic Attributes Layer)</b> est utilis√© pour √©changer les services et les caract√©ristiques qui se trouvent sur les appareils.  <b>ATT (Attributes Layer) est</b> utilis√© pour g√©rer vos caract√©ristiques et transf√©rer vos donn√©es.  <b>L2CAP</b> est un protocole d'√©change de donn√©es de bas niveau.  <b>Le contr√¥leur</b> est la puce BT elle-m√™me. <br><br>  <b>Vous vous demandez probablement ce qu'est le GATT et comment nous pouvons travailler avec lui?</b> <br><br>  Le GATT comprend des fonctionnalit√©s et des services.  Une caract√©ristique est un objet dans lequel vos donn√©es sont stock√©es, comme une variable.  Et un service est un groupe dans lequel se trouvent vos caract√©ristiques, comme un espace de noms.  Le service a un nom - UUID, vous le choisissez vous-m√™me.  Un service peut contenir un service subsidiaire. <br><br><img src="https://habrastorage.org/webt/qs/cr/8k/qscr8kzsigratdfk7boemuqz_ri.png"><br><br>  La caract√©ristique a √©galement son propre <b>UUID</b> - en fait, un nom.  <b>La valeur de la</b> caract√©ristique est NSData, ici vous pouvez enregistrer et stocker des donn√©es.  <b>Les descripteurs</b> sont une description de votre caract√©ristique, vous pouvez d√©crire les donn√©es que vous attendez de cette caract√©ristique, ou ce qu'elles signifient.  Il existe de nombreux descripteurs dans le protocole Bluetooth, mais jusqu'√† pr√©sent, seuls deux sont disponibles sur les syst√®mes Apple: la description humaine et le format des donn√©es.  Il existe √©galement des autorisations pour votre fonctionnalit√©: <br><br><img src="https://habrastorage.org/webt/xz/zh/kz/xzzhkzptblzhshwvso6kiiygtwe.png"><br><br><h3>  Essayons vous-m√™me </h3><br>  Nous avons eu l'id√©e de permettre le transfert d'argent par avion sans rien demander au destinataire.  Imaginez, vous √™tes perplexe sur une t√¢che tr√®s int√©ressante, √©crivant le code parfait, et ici un coll√®gue sugg√®re d'aller prendre un caf√©.  Et vous √™tes tellement passionn√© par la t√¢che que vous ne pouvez pas partir, et demandez-lui de vous acheter une tasse de d√©licieux cappuccino.  Il vous apporte du caf√© et vous devez lui rendre l'argent.  Vous pouvez traduire par num√©ro de t√©l√©phone, cela fonctionne tr√®s bien.  Mais voici une situation d√©licate - vous ne connaissez pas son num√©ro.  Eh bien, comme √ßa, vous travaillez depuis trois ans, mais vous n'avez pas √©chang√© de num√©ros :) <br><br>  Par cons√©quent, nous avons d√©cid√© de permettre de transf√©rer de l'argent √† ceux qui se trouvent √† proximit√©, sans entrer de donn√©es utilisateur.  Comme dans AirDrop.  S√©lectionnez simplement un utilisateur et envoyez le montant dont il a besoin.  Voyons voir ce dont nous avons besoin pour cela. <br><br><img src="https://habrastorage.org/webt/kp/tc/vs/kptcvsdcwhwapavwoxyq7h20nq4.png"><br><br><h3>  Cartographie PUSH </h3><br>  Nous avons besoin de l'exp√©diteur: <br><br><ol><li>  J'ai pu trouver tous les appareils √† proximit√© et prendre en charge notre service. </li><li>  J'ai pu lire les d√©tails. </li><li>  Et il pourrait envoyer un message au destinataire qu'il lui avait bien envoy√© l'argent. </li></ol><br>  Le destinataire, √† son tour, doit √™tre en mesure d'informer les exp√©diteurs environnants qu'il dispose d'un service avec les donn√©es n√©cessaires et de pouvoir recevoir des messages de l'exp√©diteur.  Je pense que cela ne vaut pas la peine de d√©crire comment se d√©roule le processus de transfert d'argent par des d√©tails dans notre banque.  Essayons maintenant de l'impl√©menter. <br><br>  Vous devez d'abord trouver les noms de nos services et caract√©ristiques.  Comme je l'ai dit, c'est l'UUID.  Nous les g√©n√©rons simplement et les enregistrons sur P√©riph√©rique et Central afin qu'ils soient les m√™mes sur les deux appareils. <br><br><img src="https://habrastorage.org/webt/xp/bd/xi/xpbdxioazo7xd4wbnnluhmncbk4.png"><br><br>  Vous √™tes libre d'utiliser tous les UUID, √† l'exception de ceux se terminant comme ceci: XXXXXXXX- <b>0000-1000-8000-00805F9B34FB</b> - ils sont r√©serv√©s √† diff√©rentes soci√©t√©s.  Vous pouvez vous-m√™me acheter un tel num√©ro et personne ne l'utilisera.  Cela <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">co√ªtera</a> 2500 $. <br><br>  Ensuite, nous devrons cr√©er des gestionnaires: l'un pour transf√©rer des fonds, l'autre pour recevoir.  Il vous suffit de sp√©cifier les d√©l√©gu√©s.  Nous transmettrons Central, recevrons P√©riph√©rique.  Nous cr√©ons les deux, car l'exp√©diteur et le destinataire peuvent √™tre une seule personne √† des moments diff√©rents. <br><br><img src="https://habrastorage.org/webt/m3/vl/ta/m3vltagqi_tzwe8r6ayu70j3wyg.png"><br><br>  Maintenant, nous devons permettre de d√©tecter le destinataire et d'√©crire les d√©tails du destinataire dans notre caract√©ristique. <br><br><img src="https://habrastorage.org/webt/ui/nf/hb/uinfhboh_hqspuyugii1xkukh1a.png"><br><br>  Cr√©ez d'abord un service.  Nous enregistrerons l'UUID et indiquerons qu'il est principal - c'est-√†-dire que le service est le principal pour cet appareil.  Un bon exemple: un moniteur de fr√©quence cardiaque, pour lequel la fr√©quence cardiaque actuelle sera le service principal, et l'√©tat de la batterie est une information secondaire. <br><br>  Ensuite, nous cr√©ons deux caract√©ristiques: l'une pour lire les d√©tails du destinataire, la seconde pour √©crire afin que le destinataire puisse s'informer sur l'envoi d'argent.  Nous les enregistrons dans notre service, puis les ajoutons au gestionnaire, commen√ßons la d√©couverte et indiquons l'UUID du service afin que tous les appareils √† proximit√© puissent d√©couvrir notre service avant de s'y connecter.  Ces donn√©es sont plac√©es dans le paquet que Central envoie pendant la diffusion. <br><br>  Le destinataire est pr√™t, passez √† l'exp√©diteur.  Ex√©cutez la recherche et connectez-vous. <br><br><img src="https://habrastorage.org/webt/zq/d6/6j/zqd66jsw2k8gyb-chlj778dx_u8.png"><br><br>  Lorsque vous activez le gestionnaire, nous d√©marrons la recherche d'appareils avec notre service.  Lorsque nous les trouvons, nous les obtenons dans la m√©thode d√©l√©gu√©e et nous nous connectons imm√©diatement.  Important: vous devez maintenir un lien solide avec tous les p√©riph√©riques avec lesquels vous travaillez, sinon ils fuiront. <br><br><img src="https://habrastorage.org/webt/ll/ce/nf/llcenfrfgkrgdgxxy0wh2usf9-q.png"><br><br>  Apr√®s une connexion r√©ussie, nous configurons le d√©l√©gu√© qui travaillera avec cet appareil et nous obtenons le service dont nous avons besoin de l'appareil. <br><br><img src="https://habrastorage.org/webt/j3/f0/lh/j3f0lh82sza1lncds8ujfd4yoac.png"><br><br>  Nous avons r√©ussi √† nous connecter au destinataire, vous devez maintenant lire ses d√©tails. <br><br>  Apr√®s la connexion, nous avons d√©j√† demand√© tous les services de l'appareil.  Et apr√®s les avoir re√ßues, la m√©thode d√©l√©gu√©e sera appel√©e, qui r√©pertoriera tous les services disponibles sur cet appareil.  Nous trouvons la bonne et demandons ses caract√©ristiques.  Le r√©sultat peut √™tre trouv√© par l'UUID dans la m√©thode d√©l√©gu√©e, qui stocke les donn√©es √† traduire.  Nous essayons de les lire, et nous obtenons √† nouveau le d√©sir√© dans la m√©thode d√©l√©gu√©e.  Tous les services, caract√©ristiques et leurs valeurs sont mis en cache par le syst√®me, il n'est donc pas n√©cessaire de les demander plus tard √† chaque fois. <br><br><img src="https://habrastorage.org/webt/cn/e8/qh/cne8qh7dtbbir7q76abbpil4ywk.png"><br><br>  C'est tout, nous avons envoy√© de l'argent pour le caf√©, il est temps de montrer au destinataire un bel avis pour qu'il attende des roubles sur son compte.  Pour ce faire, vous devez impl√©menter le processus d'envoi d'un message. <br><br>  Nous obtenons la caract√©ristique dont nous avons besoin de l'exp√©diteur, dans ce cas, nous l'avons prise de la valeur stock√©e.  Mais avant cela, vous devez l'obtenir de l'appareil, comme nous l'avons fait auparavant.  Et puis il suffit d'√©crire les donn√©es dans la caract√©ristique souhait√©e. <br><br>  Apr√®s cela, sur l'autre appareil, nous obtenons une demande d'√©criture dans la m√©thode d√©l√©gu√©e.  Ici, vous pouvez lire les donn√©es qui vous sont envoy√©es, r√©pondre √† toute erreur, par exemple, il n'y a pas d'acc√®s ou cette caract√©ristique n'existe pas.  Tout fonctionnera, mais uniquement si les deux appareils sont allum√©s et que les applications sont actives.  Et nous devons travailler en arri√®re-plan! <br><br><img src="https://habrastorage.org/webt/3n/3x/4n/3n3x4no4wu9c95ej5nlmxrfc5g8.png"><br><br>  Apple vous permet d'utiliser Bluetooth en arri√®re-plan.  Pour ce faire, vous devez indiquer dans info.plist la cl√© dans quel mode nous voulons utiliser, en p√©riph√©rique ou central. <br><br><img src="https://habrastorage.org/webt/e8/sk/ns/e8skns2rwruttrhvy1wagrcoppq.png"><br><br>  Ensuite, dans le gestionnaire, vous devez sp√©cifier la cl√© de r√©cup√©ration et cr√©er une m√©thode d√©l√©gu√©e.  Maintenant, le mode d'arri√®re-plan est disponible pour nous.  Si l'application s'endort ou est d√©charg√©e de la m√©moire, lorsque vous trouvez le p√©riph√©rique souhait√© ou lorsque Central est connect√©, il se r√©veille et le gestionnaire r√©tablit avec votre cl√©. <br><br><img src="https://habrastorage.org/webt/7y/lz/xd/7ylzxdqlziqkiiqyby2ppkbcfws.png"><br><br>  Tout va bien, pr√™t √† √™tre publi√©.  Mais ici, les concepteurs viennent en courant vers nous et disent: "Nous voulons ins√©rer des photos d'utilisateurs afin qu'il soit plus facile pour eux de se retrouver."  Que faire?  Dans notre caract√©ristique, vous pouvez √©crire seulement quelque 500 octets, mais sur certains appareils en g√©n√©ral 20 :( <br><br><img src="https://habrastorage.org/webt/cu/dd/_l/cudd_lekcmzrpsmf-mz-9w7is0m.png"><br><br><h3>  Allez plus loin </h3><br>  Pour r√©soudre ce probl√®me, nous avons d√ª aller plus loin. <br><br><img src="https://habrastorage.org/webt/rt/bf/8h/rtbf8hlexfy42goqfvxs8mojyig.png"><br><br>  Nous avons maintenant parl√© des appareils au niveau du GATT / ATT.  Mais dans iOS 11, nous avons acc√®s au protocole L2CAP.  Cependant, dans ce cas, vous devrez vous occuper vous-m√™me du transfert de donn√©es.  Les paquets sont envoy√©s avec 2 Ko de MTU, pas besoin de r√©-encoder quoi que ce soit, NSStream normal est appliqu√©.  Des d√©bits de donn√©es allant jusqu'√† 394 Kbps, selon Apple. <br><br>  Supposons que vous transf√©riez toutes les donn√©es de votre service du p√©riph√©rique au central sous la forme de caract√©ristiques normales.  Et il m'a fallu ouvrir la cha√Æne.  Vous l'ouvrez sur Peripheral, en retour vous obtenez PSM - c'est le num√©ro du canal auquel vous pouvez vous connecter, et vous devez le transf√©rer vers Central en utilisant les m√™mes caract√©ristiques.  Le nombre est dynamique, le syst√®me lui-m√™me choisit quel PSM ouvrir pour le moment.  Apr√®s le transfert, vous pouvez d√©j√† vous connecter √† Peripheral sur le Central et √©changer des donn√©es dans un format qui vous convient.  Voyons comment proc√©der. <br><br>  Tout d'abord, ouvrez le port crypt√© sur le p√©riph√©rique.  Vous pouvez le faire sans cryptage, ce qui acc√©l√©rera un peu le transfert. <br><br><img src="https://habrastorage.org/webt/ov/yd/ku/ovydkugm5hgyddaroucpcdjmaq0.png"><br><br>  Ensuite, dans la m√©thode d√©l√©gu√©e, nous obtenons le PSM et l'envoyons √† un autre appareil. <br><br><img src="https://habrastorage.org/webt/tm/5g/bv/tm5gbvpsr1dbn8_x3jhg1btpth4.png"><br><br>  Apr√®s avoir connect√© un autre appareil, nous serons appel√©s une m√©thode dans laquelle nous pouvons obtenir le NSStream dont nous avons besoin pour la transmission √† partir du canal. <br><br><img src="https://habrastorage.org/webt/nf/ec/kw/nfeckwjotne6tgzochcost5dr5g.png"><br><br>  Le central est encore plus simple, on se connecte juste au canal avec le num√©ro souhait√© ... <br><br><img src="https://habrastorage.org/webt/oi/tm/hg/oitmhgdbpty9nmathmdnbhsisok.png"><br><br>  ... et apr√®s cela, nous obtenons les flux dont nous avons besoin.  En eux, vous pouvez transf√©rer absolument toutes les donn√©es de n'importe quelle taille et construire votre protocole sur L2CAP.  Nous avons donc r√©alis√© le transfert des photos des destinataires. <br><br><img src="https://habrastorage.org/webt/fq/hq/ha/fqhqha7vfucpkksx4whppmay_du.png"><br><br>  Mais il y a des pi√®ges, o√π s'en passer. <br><br><h3>  Pi√®ges </h3><br>  Regardons les pi√®ges lorsque vous travaillez en arri√®re-plan.  √âtant donn√© que les r√¥les de p√©riph√©rique et central sont √† votre disposition, vous pourriez penser.  qu'en arri√®re-plan, vous pouvez d√©terminer quels appareils se trouvent √† proximit√© en arri√®re-plan et lesquels sont actifs.  En th√©orie, cela aurait d√ª l'√™tre, mais Apple a introduit une restriction: les t√©l√©phones en arri√®re-plan, qu'ils soient centraux ou p√©riph√©riques, ne sont pas disponibles pour d'autres t√©l√©phones qui sont √©galement en arri√®re-plan.  De plus, les t√©l√©phones en arri√®re-plan ne sont pas visibles depuis les appareils non iOS.  Voyons pourquoi cela se produit. <br><br>  Lorsque votre appareil est actif, il envoie un paquet de diffusion normal, qui peut contenir le nom de l'appareil et une liste de services.  que cet appareil fournit.  Et les donn√©es de d√©bordement sont tout ce qui ne convenait pas. <br><br><img src="https://habrastorage.org/webt/si/ca/ri/sicarigcdlr017kg1zpesa15psc.png"><br><br>  Lorsque l'appareil passe en arri√®re-plan, il ne transmet pas le nom et transf√®re la liste des services pris en charge pour d√©border les donn√©es.  Si l'application est active, lors de la num√©risation √† partir d'un appareil iOS, elle lit ces donn√©es et lors du passage en arri√®re-plan, elle les ignore.  Par cons√©quent, lorsque vous passez en arri√®re-plan, vous ne pourrez pas voir les applications qui sont √©galement en arri√®re-plan.<font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Les autres syst√®mes d'exploitation Apple ignorent toujours les donn√©es de d√©bordement, donc si vous recherchez des appareils qui prennent en charge votre service, vous obtiendrez un tableau vide. </font><font style="vertical-align: inherit;">Et si vous vous connectez √† chaque appareil √† proximit√© et demandez des services pris en charge, la liste peut contenir votre service et vous pouvez l'utiliser. </font></font><br><br><img src="https://habrastorage.org/webt/nj/qc/s5/njqcs5ytnn4czeiumbsvwiqb3cu.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">De plus, nous nous pr√©parions d√©j√† √† soumettre √† des tests, corrigions des d√©fauts mineurs et √©tions engag√©s dans l'optimisation. </font><font style="vertical-align: inherit;">Et soudain, √† un moment donn√©, nous avons commenc√© √† obtenir cette erreur dans la console:</font></font><br><br><pre><code class="javascript hljs">CoreBluetooth[WARNING] Unknown error: <span class="hljs-number"><span class="hljs-number">124</span></span></code> </pre> <br>  Le pire √©tait qu'aucune m√©thode d√©l√©gu√©e n'√©tait appel√©e, nous ne pouvions m√™me pas battre cette erreur pour l'utilisateur.  Juste un message dans le journal - et le silence, tout a gel√©.  Aucun changement majeur n'a √©t√© apport√©, nous avons donc commenc√© √† revenir sur les commits.  Et ils ont constat√© qu'ils avaient une fois optimis√© le code et refait la fa√ßon d'√©crire des donn√©es.  Le probl√®me √©tait que tous les clients n'√©taient pas mis √† jour, cette erreur s'est donc produite. <br><br><pre> <code class="javascript hljs">.write != .writeWithoutResponse</code> </pre> <br>  Heureux d'avoir tout r√©par√©, nous avons couru plut√¥t pour le tester, et ils nous sont presque imm√©diatement revenus: ¬´Vos photos de mode ne fonctionnent pas.  Ils sont tous sous-charg√©s. ¬ª  Nous avons commenc√© √† essayer, et il est vrai que parfois, sur diff√©rents appareils, les photos cass√©es arrivent √† des moments diff√©rents.  Ils ont commenc√© √† chercher une raison. <br><br>  Et l√† encore, ils ont vu l'erreur pr√©c√©dente.  Imm√©diatement pens√© qu'il √©tait dans diff√©rentes versions.  Mais apr√®s la suppression compl√®te de l'ancienne version de tous les appareils de test, l'erreur s'est reproduite.  Nous √©tions tristes ... <br><br><pre> <code class="javascript hljs">CoreBluetooth[WARNING] Unknown error: <span class="hljs-number"><span class="hljs-number">722</span></span> CoreBluetooth[WARNING] Unknown error: <span class="hljs-number"><span class="hljs-number">249</span></span> CoreBluetooth[WARNING] Unknown error: <span class="hljs-number"><span class="hljs-number">312</span></span></code> </pre> <br>  Nous avons commenc√© √† chercher un outil de d√©bogage.  La premi√®re chose que nous avons rencontr√©e √©tait l'Apple Bluetooth Explorer.  Un programme puissant, il peut faire beaucoup de choses, mais pour d√©boguer le protocole Bluetooth LE, il y a un petit onglet avec la recherche de p√©riph√©riques et l'obtention de caract√©ristiques.  Et nous devions analyser L2CAP. <br><br>  Ensuite, ils ont trouv√© LightBlue Explorer.  Il s'est av√©r√© √™tre un programme assez d√©cent, mais avec un design iOS 7. Il peut faire la m√™me chose que Bluetooth Explorer, et sait √©galement comment s'abonner aux sp√©cifications.  Et cela fonctionne plus stable.  Tout va bien, mais encore une fois sans L2CAP. <br><br>  Et puis nous nous sommes souvenus du renifleur WireShark bien connu. <br><br>  Il s'est av√©r√© qu'il connaissait Bluetooth LE: il peut lire L2CAP, mais uniquement sous Windows.  Bien que ce ne soit pas effrayant que nous ne trouvions pas Windows ou quelque chose.  Le plus gros inconv√©nient - le programme ne fonctionne qu'avec un appareil sp√©cifique.  Autrement dit, vous deviez trouver l'appareil quelque part dans la boutique officielle.  Et vous comprenez vous-m√™me qu'il est peu probable qu'une grande entreprise approuve l'achat d'un appareil incompr√©hensible sur un march√© aux puces.  Nous avons m√™me commenc√© √† parcourir les magasins en ligne √† l'√©tranger. <br><br>  Mais ici, ils ont trouv√© le programme PacketLogger dans les outils Xcode suppl√©mentaires.  Il vous permet de surveiller le trafic qui circule sur l'appareil OS X.  Pourquoi ne pas r√©√©crire notre MoneyDrop sous OS X?  Nous avions d√©j√† une biblioth√®que s√©par√©e.  Nous venons de remplacer UIImage par NSImage, tout a commenc√© apr√®s 10 minutes. <br><br><img src="https://habrastorage.org/webt/vm/tn/z3/vmtnz3yw28-g7zsb8-cf6nldt6o.png"><br><br>  Enfin, nous avons pu lire les paquets √©chang√©s entre les appareils.  Il est imm√©diatement devenu √©vident qu'au moment de la transmission des donn√©es via L2CAP, l'une des caract√©ristiques √©tait enregistr√©e.  Et en raison du fait que la cha√Æne √©tait compl√®tement occup√©e par le transfert de photos, iOS a ignor√© l'enregistrement et l'exp√©diteur apr√®s l'ignorer a cass√© la cha√Æne.  Apr√®s avoir r√©solu les probl√®mes avec le transfert de la photo n'√©tait pas. <br><br><img src="https://habrastorage.org/webt/ig/gw/sn/iggwsno_4bqfunmdzy0pigsn77i.png"><br><br>  C'est tout, merci d'avoir lu :) <br><br><h3>  <b>Liens utiles</b> </h3><br>  <b>WWDC / CoreBluetooth:</b> <br><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">https://developer.apple.com/videos/play/wwdc2017/712/</a> </li><li>  WWDC 2012 Session 703 Core Bluetooth 101 </li><li>  WWDC 2012 Session 705 Advanced Core Bluetooth </li></ul><br>  <b>Bluetooth</b> <br><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">https://www.bluetooth.com/specifications/gatt</a> </li><li>  D√©buter avec Bluetooth Low Energy O'Reilly </li></ul><br>  <b>YouTube</b> <br><br><ul><li>  Arrow Electronics ‚Üí S√©rie Bluetooth Low Energy </li></ul></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr452278/">https://habr.com/ru/post/fr452278/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr452266/index.html">Racks sans serveur</a></li>
<li><a href="../fr452268/index.html">Fen√™tre analogique C # WPF.ShowDialog () ou g√©rer DispatcherFrame</a></li>
<li><a href="../fr452270/index.html">La documentation de l'API Xamarin est d√©sormais accessible au public</a></li>
<li><a href="../fr452272/index.html">Fille sous la cascade</a></li>
<li><a href="../fr452276/index.html">Ing√©nierie inverse du client Dropbox</a></li>
<li><a href="../fr452280/index.html">PostgreSQL 11: L'√©volution du partitionnement de Postgres 9.6 √† Postgres 11</a></li>
<li><a href="../fr452282/index.html">Elementary, Watson: vous int√©grez avec Voximplant</a></li>
<li><a href="../fr452284/index.html">Classification de la couverture terrestre √† l'aide de l'eo-learn. Partie 1</a></li>
<li><a href="../fr452288/index.html">Situation: des op√©rateurs de t√©l√©phonie mobile am√©ricains accus√©s de commerce ill√©gal de g√©odonn√©es d'abonn√©s</a></li>
<li><a href="../fr452290/index.html">Qu'est-ce que les pirates manquent lors de la rupture d'une banque les PHDays</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>