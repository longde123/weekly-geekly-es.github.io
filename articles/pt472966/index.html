<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ü§¥üèΩ üåÜ üöû Como √© o arquivo zip e o que podemos fazer com ele. Parte 2 - Descritor e compacta√ß√£o de dados üì∏ üë©‚Äçüë¶‚Äçüë¶ üñêüèº</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Continua√ß√£o do artigo Como √© o arquivo zip e o que podemos fazer com ele . 
 Pref√°cio 


 Bom dia 
 E novamente no ar, temos programa√ß√£o n√£o convencio...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Como √© o arquivo zip e o que podemos fazer com ele. Parte 2 - Descritor e compacta√ß√£o de dados</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/472966/"><p>  <i>Continua√ß√£o do artigo <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Como √© o arquivo zip e o que podemos fazer com ele</a> .</i> </p><br><h3>  Pref√°cio </h3><br><p> Bom dia <br>  E novamente no ar, temos programa√ß√£o n√£o convencional em PHP. </p><br><p>  Em um artigo anterior, estimados leitores estavam interessados ‚Äã‚Äãem compacta√ß√£o e streaming de zip.  Hoje vamos tentar abrir um pouco esse t√≥pico. </p><a name="habracut"></a><br><p>  Vamos dar uma olhada <br><br></p><div class="spoiler">  <b class="spoiler_title">C√≥digo do √∫ltimo artigo</b> <div class="spoiler_text"><pre><code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-comment"><span class="hljs-comment">//        (1.txt  2.txt)   : $entries = [ '1.txt' =&gt; 'Lorem ipsum dolor sit amet, consectetur adipiscing elit. Nunc id ante ultrices, fermentum nibh eleifend, ullamcorper nunc. Sed dignissim ut odio et imperdiet. Nunc id felis et ligula viverra blandit a sit amet magna. Vestibulum facilisis venenatis enim sed bibendum. Duis maximus felis in suscipit bibendum. Mauris suscipit turpis eleifend nibh commodo imperdiet. Donec tincidunt porta interdum. Aenean interdum condimentum ligula, vitae ornare lorem auctor in. Suspendisse metus ipsum, porttitor et sapien id, fringilla aliquam nibh. Curabitur sem lacus, ultrices quis felis sed, blandit commodo metus. Duis tincidunt vel mauris at accumsan. Integer et ipsum fermentum leo viverra blandit.', '2.txt' =&gt; 'Mauris in purus sit amet ante tempor finibus nec sed justo. Integer ac nibh tempus, mollis sem vel, consequat diam. Pellentesque ut condimentum ex. Praesent finibus volutpat gravida. Vivamus eleifend neque sit amet diam scelerisque lacinia. Nunc imperdiet augue in suscipit lacinia. Curabitur orci diam, iaculis non ligula vitae, porta pellentesque est. Duis dolor erat, placerat a lacus eu, scelerisque egestas massa. Aliquam molestie pulvinar faucibus. Quisque consequat, dolor mattis lacinia pretium, eros eros tempor neque, volutpat consectetur elit elit non diam. In faucibus nulla justo, non dignissim erat maximus consectetur. Sed porttitor turpis nisl, elementum aliquam dui tincidunt nec. Nunc eu enim at nibh molestie porta ut ac erat. Sed tortor sem, mollis eget sodales vel, faucibus in dolor.', ]; //      Lorem.zip,      cwd (      ) $destination = 'Lorem.zip'; $handle = fopen($destination, 'w'); //      ,    ,     ,   "" Central Directory File Header $written = 0; $dictionary = []; foreach ($entries as $filename =&gt; $content) { //         Local File Header,     //        ,      . $fileInfo = [ //     'versionToExtract' =&gt; 10, //   0,        - 'generalPurposeBitFlag' =&gt; 0, //      ,    0 'compressionMethod' =&gt; 0, // -    mtime ,    ,      ? 'modificationTime' =&gt; 28021, //   , ? 'modificationDate' =&gt; 20072, //      .     ,       ,   ? 'crc32' =&gt; hexdec(hash('crc32b', $content)), //     .        . //       :) 'compressedSize' =&gt; $size = strlen($content), 'uncompressedSize' =&gt; $size, //    'filenameLength' =&gt; strlen($filename), //  .    ,   0. 'extraFieldLength' =&gt; 0, ]; //      . $LFH = pack('LSSSSSLLLSSa*', ...array_values([ 'signature' =&gt; 0x04034b50, //  Local File Header ] + $fileInfo + ['filename' =&gt; $filename])); //       ,       Central Directory File Header $dictionary[$filename] = [ 'signature' =&gt; 0x02014b50, //  Central Directory File Header 'versionMadeBy' =&gt; 798, //  .    ,  -  . ] + $fileInfo + [ 'fileCommentLength' =&gt; 0, //    . No comments 'diskNumber' =&gt; 0, //     0,        'internalFileAttributes' =&gt; 0, //    'externalFileAttributes' =&gt; 2176057344, //    'localFileHeaderOffset' =&gt; $written, //      Local File Header 'filename' =&gt; $filename, //  . ]; //      $written += fwrite($handle, $LFH); //    $written += fwrite($handle, $content); } // ,     ,    . //          End of central directory record (EOCD) $EOCD = [ //  EOCD 'signature' =&gt; 0x06054b50, //  .    ,   0 'diskNumber' =&gt; 0, //      -  0 'startDiskNumber' =&gt; 0, //       . 'numberCentralDirectoryRecord' =&gt; $records = count($dictionary), //    .    ,     'totalCentralDirectoryRecord' =&gt; $records, //   Central Directory Record. //      ,      'sizeOfCentralDirectory' =&gt; 0, // ,    Central Directory Records 'centralDirectoryOffset' =&gt; $written, //     'commentLength' =&gt; 0 ]; //     !   foreach ($dictionary as $entryInfo) { $CDFH = pack('LSSSSSSLLLSSSSSLLa*', ...array_values($entryInfo)); $written += fwrite($handle, $CDFH); } // ,   .  ,    $EOCD['sizeOfCentralDirectory'] = $written - $EOCD['centralDirectoryOffset']; //     End of central directory record $EOCD = pack('LSSSSLLS', ...array_values($EOCD)); $written += fwrite($handle, $EOCD); //  . fclose($handle); echo '  : ' . $written . ' ' . PHP_EOL; echo '     `unzip -tq ' . $destination . '`' . PHP_EOL; echo PHP_EOL;</span></span></code> </pre> <br></div></div><br><p>  Qual √© o problema dele?  Bem, para ser justo, vale a pena notar que sua √∫nica vantagem √© que ele funciona, e h√° problemas l√°, mas ainda assim. <br><br>  Na minha opini√£o, o principal problema √© que devemos primeiro escrever o <b>Local File Header (LFH)</b> com <b>crc32</b> e o tamanho do arquivo e, em seguida, o conte√∫do do pr√≥prio arquivo. <br>  O que isso amea√ßa?  Ou carregamos o arquivo inteiro na mem√≥ria, consideramos o crc32 para ele, escrevemos <b>LFH</b> e, em seguida, o conte√∫do do arquivo √© econ√¥mico do ponto de vista da E / S, mas √© inaceit√°vel em arquivos grandes.  Ou ent√£o, lemos o arquivo duas vezes - primeiro para calcular o hash, e depois para ler o conte√∫do e gravar no arquivo - economicamente do ponto de vista da RAM, mas, por exemplo, primeiro dobra a carga na unidade, o que n√£o √© necessariamente um SSD. <br><br>  E se o arquivo estiver localizado remotamente e seu volume, por exemplo, 1,5 GB?  Bem, voc√™ precisa carregar todos os 1,5 GB na mem√≥ria ou esperar at√© que todos esses 1,5 GB sejam baixados e calcularemos o hash e depois baix√°-los novamente para fornecer o conte√∫do.  No caso, se quisermos fornecer dinamicamente, por exemplo, um banco de dados de despejo, que, por exemplo, lemos no stdout, isso geralmente √© inaceit√°vel - os dados no banco de dados foram alterados, os dados de despejo ser√£o alterados, haver√° um hash completamente diferente e obteremos um arquivo inv√°lido.  Sim, as coisas est√£o ruins, √© claro. </p><br><h3>  Estrutura do descritor de dados para registros de arquivamento de fluxo cont√≠nuo </h3><br><p>  Mas n√£o desanime, a especifica√ß√£o ZIP permite escrever dados primeiro e depois colar a estrutura do <b>Descritor de Dados (DD)</b> ap√≥s os dados, nos quais j√° haver√° crc32, o comprimento dos dados compactados e o comprimento dos dados sem compacta√ß√£o.  Para fazer isso, precisamos <strike>apenas 3 vezes por dia com o est√¥mago vazio</strike> no <b>LFH,</b> especificar <b>generalPurposeBitFlag</b> igual a <b>0x0008</b> e <b>crc32</b> , <b>compressedSize</b> e <b>uncompressedSize</b> especificar <b>0</b> .  Depois dos dados, escrevemos a estrutura <b>DD</b> , que ser√° algo como isto: </p><br><br><pre> <code class="php hljs">pack(<span class="hljs-string"><span class="hljs-string">'LLLL'</span></span>, ...array_values([ <span class="hljs-string"><span class="hljs-string">'signature'</span></span> =&gt; <span class="hljs-number"><span class="hljs-number">0x08074b50</span></span>, <span class="hljs-comment"><span class="hljs-comment">//  Data Descriptor 'crc32' =&gt; $crc32, //  crc32    'compressedSize' =&gt; $compressedSize, //    'uncompressedSize' =&gt; $uncompressedSize, //    . ]));</span></span></code> </pre> <br><p>  E no <b>CDFH (Central Directory File Header)</b> apenas o <b>generalPurposeBitFlag √© alterado</b> , o restante dos dados deve ser real.  Mas isso n√£o √© um problema, j√° que escrevemos <b>CDFH</b> ap√≥s todos os dados, e hashes com comprimentos de dados s√£o conhecidos em qualquer caso. </p><br><p>  Isso √© tudo, √© claro, bom.  Resta apenas implementar no PHP. <br>  E a biblioteca <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Hash</a> padr√£o nos ajudar√° bastante.  Podemos criar um contexto de hash no qual ser√° suficiente para encher peda√ßos com dados e, no final, obter o valor do hash.  Obviamente, essa solu√ß√£o ser√° um pouco mais complicada que o <i>hash ('crc32b', $ content)</i> , mas nos poupar√° apenas um monte inimagin√°vel de recursos e tempo. <br><br>  Parece algo como isto: <br><br></p><pre> <code class="php hljs">$hashCtx = hash_init(<span class="hljs-string"><span class="hljs-string">'crc32b'</span></span>); $handle = fopen($source, <span class="hljs-string"><span class="hljs-string">'r'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (!feof($handle)) { $chunk = fread($handle, <span class="hljs-number"><span class="hljs-number">8</span></span> * <span class="hljs-number"><span class="hljs-number">1024</span></span>); hash_update($hashCtx, $chunk); $chunk = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; } $hash = hash_final($hashCtx);</code> </pre> <br>  Se tudo for feito corretamente, o valor n√£o ser√° diferente de <i>hash_file ('crc32b', $ source)</i> ou <i>hash ('crc32b', file_get_content ($ source))</i> . <br><br><p>  Vamos tentar, de alguma forma, agrupar tudo isso em uma √∫nica fun√ß√£o, para que possamos ler o arquivo de uma maneira conveniente para n√≥s e, no final, obter seu hash e comprimento.  E os geradores nos ajudar√£o com isso: <br><br></p><pre> <code class="php hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">read</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(string $path)</span></span></span><span class="hljs-function">: \</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Generator</span></span></span><span class="hljs-function"> </span></span>{ $length = <span class="hljs-number"><span class="hljs-number">0</span></span>; $handle = fopen($path, <span class="hljs-string"><span class="hljs-string">'r'</span></span>); $hashCtx = hash_init(<span class="hljs-string"><span class="hljs-string">'crc32b'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (!feof($handle)) { $chunk = fread($handle, <span class="hljs-number"><span class="hljs-number">8</span></span> * <span class="hljs-number"><span class="hljs-number">1024</span></span>); $length += strlen($chunk); hash_update($hashCtx, $chunk); <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span> $chunk; $chunk = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; } fclose($handle); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> [<span class="hljs-string"><span class="hljs-string">'length'</span></span> =&gt; $length, <span class="hljs-string"><span class="hljs-string">'crc32'</span></span> =&gt; hexdec(hash_final($hashCtx))]; }</code> </pre> <br>  e agora podemos apenas <br><br><pre> <code class="php hljs">$reader = read(<span class="hljs-string"><span class="hljs-string">'https://speed.hetzner.de/1GB.bin'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> ($reader <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> $chunk) { <span class="hljs-comment"><span class="hljs-comment">// -   . } //      . ['length' =&gt; $length, 'crc32' =&gt; $crc32] = $reader-&gt;getReturn(); echo round(memory_get_peak_usage(true) / 1024 / 1024, 2) . 'MB - Memory Peak Usage' . PHP_EOL;</span></span></code> </pre> <br>  Na minha opini√£o, √© bastante simples e conveniente.  Com um arquivo de 1 GB, meu consumo m√°ximo de mem√≥ria era de 2 MB. <br><p>  Agora vamos tentar modificar o c√≥digo do artigo anterior para que possamos usar esta fun√ß√£o. <br><br></p><div class="spoiler">  <b class="spoiler_title">Roteiro final</b> <div class="spoiler_text"><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">read</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(string $path)</span></span></span><span class="hljs-function">: \</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Generator</span></span></span><span class="hljs-function"> </span></span>{ $length = <span class="hljs-number"><span class="hljs-number">0</span></span>; $handle = fopen($path, <span class="hljs-string"><span class="hljs-string">'r'</span></span>); $hashCtx = hash_init(<span class="hljs-string"><span class="hljs-string">'crc32b'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (!feof($handle)) { $chunk = fread($handle, <span class="hljs-number"><span class="hljs-number">8</span></span> * <span class="hljs-number"><span class="hljs-number">1024</span></span>); $length += strlen($chunk); hash_update($hashCtx, $chunk); <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span> $chunk; $chunk = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; } fclose($handle); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> [<span class="hljs-string"><span class="hljs-string">'length'</span></span> =&gt; $length, <span class="hljs-string"><span class="hljs-string">'crc32'</span></span> =&gt; hexdec(hash_final($hashCtx))]; } $entries = [<span class="hljs-string"><span class="hljs-string">'https://speed.hetzner.de/100MB.bin'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">__FILE__</span></span>]; $destination = <span class="hljs-string"><span class="hljs-string">'test.zip'</span></span>; $handle = fopen($destination, <span class="hljs-string"><span class="hljs-string">'w'</span></span>); $written = <span class="hljs-number"><span class="hljs-number">0</span></span>; $dictionary = []; <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> ($entries <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> $entry) { $filename = basename($entry); $fileInfo = [ <span class="hljs-string"><span class="hljs-string">'versionToExtract'</span></span> =&gt; <span class="hljs-number"><span class="hljs-number">10</span></span>, <span class="hljs-comment"><span class="hljs-comment">//       Data Descriptor,     00008, //   00000    . 'generalPurposeBitFlag' =&gt; 0x0008, 'compressionMethod' =&gt; 0, 'modificationTime' =&gt; 28021, 'modificationDate' =&gt; 20072, 'crc32' =&gt; 0, 'compressedSize' =&gt; 0, 'uncompressedSize' =&gt; 0, 'filenameLength' =&gt; strlen($filename), 'extraFieldLength' =&gt; 0, ]; $LFH = pack('LSSSSSLLLSSa*', ...array_values([ 'signature' =&gt; 0x04034b50, ] + $fileInfo + ['filename' =&gt; $filename])); $fileOffset = $written; $written += fwrite($handle, $LFH); //     $reader = read($entry); foreach ($reader as $chunk) { //      $written += fwrite($handle, $chunk); $chunk = null; } //       ['length' =&gt; $length, 'crc32' =&gt; $crc32] = $reader-&gt;getReturn(); //    fileInfo,     CDFH $fileInfo['crc32'] = $crc32; $fileInfo['compressedSize'] = $length; $fileInfo['uncompressedSize'] = $length; //  Data Descriptor $DD = pack('LLLL', ...array_values([ 'signature' =&gt; 0x08074b50, 'crc32' =&gt; $fileInfo['crc32'], 'compressedSize' =&gt; $fileInfo['compressedSize'], 'uncompressedSize' =&gt; $fileInfo['uncompressedSize'], ])); $written += fwrite($handle, $DD); $dictionary[$filename] = [ 'signature' =&gt; 0x02014b50, 'versionMadeBy' =&gt; 798, ] + $fileInfo + [ 'fileCommentLength' =&gt; 0, 'diskNumber' =&gt; 0, 'internalFileAttributes' =&gt; 0, 'externalFileAttributes' =&gt; 2176057344, 'localFileHeaderOffset' =&gt; $fileOffset, 'filename' =&gt; $filename, ]; } $EOCD = [ 'signature' =&gt; 0x06054b50, 'diskNumber' =&gt; 0, 'startDiskNumber' =&gt; 0, 'numberCentralDirectoryRecord' =&gt; $records = count($dictionary), 'totalCentralDirectoryRecord' =&gt; $records, 'sizeOfCentralDirectory' =&gt; 0, 'centralDirectoryOffset' =&gt; $written, 'commentLength' =&gt; 0 ]; foreach ($dictionary as $entryInfo) { $CDFH = pack('LSSSSSSLLLSSSSSLLa*', ...array_values($entryInfo)); $written += fwrite($handle, $CDFH); } $EOCD['sizeOfCentralDirectory'] = $written - $EOCD['centralDirectoryOffset']; $EOCD = pack('LSSSSLLS', ...array_values($EOCD)); $written += fwrite($handle, $EOCD); fclose($handle); echo '  : ' . memory_get_peak_usage(true) . ' ' . PHP_EOL; echo '  : ' . $written . ' ' . PHP_EOL; echo '   `unzip -tq ' . $destination . '`: ' . PHP_EOL; echo '&gt; ' . exec('unzip -tq ' . $destination) . PHP_EOL; echo PHP_EOL;</span></span></code> </pre> <br></div></div><br>  Na sa√≠da, devemos obter um arquivo Zip com o nome test.zip, no qual haver√° um arquivo com o script acima e 100MB.bin, com aproximadamente 100 MB de tamanho. <br><br><h3>  Compacta√ß√£o em arquivos zip </h3><br><p>  Agora, temos praticamente tudo para compactar os dados e faz√™-lo tamb√©m em tempo real. <br>  Assim como obtemos um hash atribuindo pequenos blocos √†s fun√ß√µes, tamb√©m podemos compactar dados gra√ßas √† maravilhosa biblioteca <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Zlib</a> e suas <i>fun√ß√µes deflate_init</i> e <i>deflate_add</i> . </p><br><p>  Parece algo como isto: <br><br></p><pre> <code class="php hljs">$deflateCtx = deflate_init(ZLIB_ENCODING_RAW, [<span class="hljs-string"><span class="hljs-string">'level'</span></span> =&gt; <span class="hljs-number"><span class="hljs-number">6</span></span>]); $handle = fopen($source, <span class="hljs-string"><span class="hljs-string">'r'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (!feof($handle)) { $chunk = fread($handle, <span class="hljs-number"><span class="hljs-number">8</span></span> * <span class="hljs-number"><span class="hljs-number">1024</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span> deflate_add($deflateCtx, $chunk, feof($handle) ? ZLIB_FINISH : ZLIB_SYNC_FLUSH); $chunk = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; }</code> </pre> <br>  <i>Eu encontrei uma op√ß√£o como esta que, em compara√ß√£o com a anterior, adicionar√° alguns zeros no final.</i> <div class="spoiler">  <b class="spoiler_title">T√≠tulo de spoiler</b> <div class="spoiler_text"><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (!feof($handle)) { <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span> deflate_add($deflateCtx, $chunk, ZLIB_SYNC_FLUSH); } <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span> deflate_add($deflateCtx, <span class="hljs-string"><span class="hljs-string">''</span></span>, ZLIB_FINISH);</code> </pre> <br></div></div>  <i>Mas descompacte o juramento, ent√£o tive que me livrar dessa simplifica√ß√£o.</i> <br><br><p>  Vamos corrigir nosso <i>leitor</i> para compactar imediatamente nossos dados e, no final, retornar um hash, o comprimento dos dados sem compacta√ß√£o e o comprimento dos dados com compacta√ß√£o: <br><br></p><pre> <code class="php hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">read</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(string $path)</span></span></span><span class="hljs-function">: \</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Generator</span></span></span><span class="hljs-function"> </span></span>{ $uncompressedSize = <span class="hljs-number"><span class="hljs-number">0</span></span>; $compressedSize = <span class="hljs-number"><span class="hljs-number">0</span></span>; $hashCtx = hash_init(<span class="hljs-string"><span class="hljs-string">'crc32b'</span></span>); $deflateCtx = deflate_init(ZLIB_ENCODING_RAW, [<span class="hljs-string"><span class="hljs-string">'level'</span></span> =&gt; <span class="hljs-number"><span class="hljs-number">6</span></span>]); $handle = fopen($path, <span class="hljs-string"><span class="hljs-string">'r'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (!feof($handle)) { $chunk = fread($handle, <span class="hljs-number"><span class="hljs-number">8</span></span> * <span class="hljs-number"><span class="hljs-number">1024</span></span>); hash_update($hashCtx, $chunk); $compressedChunk = deflate_add($deflateCtx, $chunk, feof($handle) ? ZLIB_FINISH : ZLIB_SYNC_FLUSH); $uncompressedSize += strlen($chunk); $compressedSize += strlen($compressedChunk); <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span> $compressedChunk; $chunk = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; $compressedChunk = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; } fclose($handle); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> [ <span class="hljs-string"><span class="hljs-string">'uncompressedSize'</span></span> =&gt; $uncompressedSize, <span class="hljs-string"><span class="hljs-string">'compressedSize'</span></span> =&gt; $compressedSize, <span class="hljs-string"><span class="hljs-string">'crc32'</span></span> =&gt; hexdec(hash_final($hashCtx)) ]; }</code> </pre> <br>  e experimente um arquivo de 100 mb: <br><br><pre> <code class="php hljs">$reader = read(<span class="hljs-string"><span class="hljs-string">'https://speed.hetzner.de/100MB.bin'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> ($reader <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> $chunk) { <span class="hljs-comment"><span class="hljs-comment">// -   . } ['uncompressedSize' =&gt; $uncompressedSize, 'compressedSize' =&gt; $compressedSize, 'crc32' =&gt; $crc32] = $reader-&gt;getReturn(); echo 'Uncompressed size: ' . $uncompressedSize . PHP_EOL; echo 'Compressed size: ' . $compressedSize . PHP_EOL; echo round(memory_get_peak_usage(true) / 1024 / 1024, 2) . 'MB - Memory Peak Usage' . PHP_EOL;</span></span></code> </pre> <br>  O consumo de mem√≥ria ainda mostra que n√£o carregamos o arquivo inteiro na mem√≥ria. <br><br><p>  Vamos juntar tudo e finalmente obter um arquivador de scripts realmente real. <br>  Diferentemente da vers√£o anterior, nosso <b>generalPurposeBitFlag</b> mudar√° - agora seu valor √© <b>0x0018</b> , assim como o <b>compressionMethod</b> - <b>8</b> (que significa <b>Deflate</b> ). <br><br></p><div class="spoiler">  <b class="spoiler_title">Roteiro final</b> <div class="spoiler_text"><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">read</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(string $path)</span></span></span><span class="hljs-function">: \</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Generator</span></span></span><span class="hljs-function"> </span></span>{ $uncompressedSize = <span class="hljs-number"><span class="hljs-number">0</span></span>; $compressedSize = <span class="hljs-number"><span class="hljs-number">0</span></span>; $hashCtx = hash_init(<span class="hljs-string"><span class="hljs-string">'crc32b'</span></span>); $deflateCtx = deflate_init(ZLIB_ENCODING_RAW, [<span class="hljs-string"><span class="hljs-string">'level'</span></span> =&gt; <span class="hljs-number"><span class="hljs-number">6</span></span>]); $handle = fopen($path, <span class="hljs-string"><span class="hljs-string">'r'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (!feof($handle)) { $chunk = fread($handle, <span class="hljs-number"><span class="hljs-number">8</span></span> * <span class="hljs-number"><span class="hljs-number">1024</span></span>); hash_update($hashCtx, $chunk); $compressedChunk = deflate_add($deflateCtx, $chunk, feof($handle) ? ZLIB_FINISH : ZLIB_SYNC_FLUSH); $uncompressedSize += strlen($chunk); $compressedSize += strlen($compressedChunk); <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span> $compressedChunk; $chunk = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; $compressedChunk = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; } fclose($handle); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> [ <span class="hljs-string"><span class="hljs-string">'uncompressedSize'</span></span> =&gt; $uncompressedSize, <span class="hljs-string"><span class="hljs-string">'compressedSize'</span></span> =&gt; $compressedSize, <span class="hljs-string"><span class="hljs-string">'crc32'</span></span> =&gt; hexdec(hash_final($hashCtx)) ]; } $entries = [<span class="hljs-string"><span class="hljs-string">'https://speed.hetzner.de/100MB.bin'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">__FILE__</span></span>]; $destination = <span class="hljs-string"><span class="hljs-string">'test.zip'</span></span>; $handle = fopen($destination, <span class="hljs-string"><span class="hljs-string">'w'</span></span>); $written = <span class="hljs-number"><span class="hljs-number">0</span></span>; $dictionary = []; <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> ($entries <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> $entry) { $filename = basename($entry); $fileInfo = [ <span class="hljs-string"><span class="hljs-string">'versionToExtract'</span></span> =&gt; <span class="hljs-number"><span class="hljs-number">10</span></span>, <span class="hljs-comment"><span class="hljs-comment">//   ,        0x0018  0x0008 'generalPurposeBitFlag' =&gt; 0x0018, 'compressionMethod' =&gt; 8, //      : 8 - Deflate 'modificationTime' =&gt; 28021, 'modificationDate' =&gt; 20072, 'crc32' =&gt; 0, 'compressedSize' =&gt; 0, 'uncompressedSize' =&gt; 0, 'filenameLength' =&gt; strlen($filename), 'extraFieldLength' =&gt; 0, ]; $LFH = pack('LSSSSSLLLSSa*', ...array_values([ 'signature' =&gt; 0x04034b50, ] + $fileInfo + ['filename' =&gt; $filename])); $fileOffset = $written; $written += fwrite($handle, $LFH); $reader = read($entry); foreach ($reader as $chunk) { $written += fwrite($handle, $chunk); $chunk = null; } [ 'uncompressedSize' =&gt; $uncompressedSize, 'compressedSize' =&gt; $compressedSize, 'crc32' =&gt; $crc32 ] = $reader-&gt;getReturn(); $fileInfo['crc32'] = $crc32; $fileInfo['compressedSize'] = $compressedSize; $fileInfo['uncompressedSize'] = $uncompressedSize; $DD = pack('LLLL', ...array_values([ 'signature' =&gt; 0x08074b50, 'crc32' =&gt; $fileInfo['crc32'], 'compressedSize' =&gt; $fileInfo['compressedSize'], 'uncompressedSize' =&gt; $fileInfo['uncompressedSize'], ])); $written += fwrite($handle, $DD); $dictionary[$filename] = [ 'signature' =&gt; 0x02014b50, 'versionMadeBy' =&gt; 798, ] + $fileInfo + [ 'fileCommentLength' =&gt; 0, 'diskNumber' =&gt; 0, 'internalFileAttributes' =&gt; 0, 'externalFileAttributes' =&gt; 2176057344, 'localFileHeaderOffset' =&gt; $fileOffset, 'filename' =&gt; $filename, ]; } $EOCD = [ 'signature' =&gt; 0x06054b50, 'diskNumber' =&gt; 0, 'startDiskNumber' =&gt; 0, 'numberCentralDirectoryRecord' =&gt; $records = count($dictionary), 'totalCentralDirectoryRecord' =&gt; $records, 'sizeOfCentralDirectory' =&gt; 0, 'centralDirectoryOffset' =&gt; $written, 'commentLength' =&gt; 0 ]; foreach ($dictionary as $entryInfo) { $CDFH = pack('LSSSSSSLLLSSSSSLLa*', ...array_values($entryInfo)); $written += fwrite($handle, $CDFH); } $EOCD['sizeOfCentralDirectory'] = $written - $EOCD['centralDirectoryOffset']; $EOCD = pack('LSSSSLLS', ...array_values($EOCD)); $written += fwrite($handle, $EOCD); fclose($handle); echo '  : ' . memory_get_peak_usage(true) . ' ' . PHP_EOL; echo '  : ' . $written . ' ' . PHP_EOL; echo '   `unzip -tq ' . $destination . '`: ' . PHP_EOL; echo '&gt; ' . exec('unzip -tq ' . $destination) . PHP_EOL; echo PHP_EOL;</span></span></code> </pre> </div></div><br>  Como resultado, obtive um arquivo de 360183 bytes de tamanho (nosso arquivo de 100 MB foi compactado muito bem, no qual provavelmente apenas um conjunto de bytes id√™nticos), e o <i>descompacta√ß√£o</i> mostrou que nenhum erro foi encontrado no arquivo. <br><br><h3>  Conclus√£o </h3><br><p>  Se eu tiver energia e tempo suficientes para outro artigo, tentarei mostrar como e, o mais importante, por que tudo isso pode ser usado. <br><br>  Se voc√™ estiver interessado em mais alguma coisa sobre esse t√≥pico - sugira nos coment√°rios, tentarei responder √† sua pergunta.  Provavelmente n√£o lidaremos com criptografia, porque o script j√° cresceu e, na vida real, esses arquivos, ao que me parece, n√£o s√£o usados ‚Äã‚Äãcom muita frequ√™ncia. </p><br><br><p>  Obrigado por sua aten√ß√£o e por seus coment√°rios. </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt472966/">https://habr.com/ru/post/pt472966/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt472956/index.html">A hist√≥ria da constru√ß√£o de um rob√¥ lagarta</a></li>
<li><a href="../pt472958/index.html">Como criar programas do Windows no Arduino</a></li>
<li><a href="../pt472960/index.html">A melhor lente / pre√ßo / qualidade da Sony</a></li>
<li><a href="../pt472962/index.html">Postagem em v√≠deo: experimentos como forma de visualiza√ß√£o cient√≠fica</a></li>
<li><a href="../pt472964/index.html">Situa√ß√£o: mais e mais empresas de c√≥digo aberto est√£o trocando licen√ßas - discutimos opini√µes de especialistas</a></li>
<li><a href="../pt472978/index.html">Curso de autoria de Arduino para seu pr√≥prio filho</a></li>
<li><a href="../pt472980/index.html">Cal√ß√µes Belokamentseva</a></li>
<li><a href="../pt472982/index.html">‚ÄúOu√ßa para encontrar um colapso‚Äù: s√£o publicadas grava√ß√µes em √°udio de m√°quinas industriais com falha</a></li>
<li><a href="../pt472984/index.html">Carrinho de caminh√£o ROS. Parte 7. Localiza√ß√£o do rob√¥: gmapping, AMCL, pontos de refer√™ncia no mapa da sala</a></li>
<li><a href="../pt472994/index.html">O que estamos fazendo de errado com o Spring</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>