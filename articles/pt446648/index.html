<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ü•Ñ üå≥ üßúüèø Desenvolvimento de operadores Kubernetes com Operator Framework ü•ó üêò üôåüèΩ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Como mencionado no artigo Radar Technology , a Lamoda est√° se movendo ativamente em dire√ß√£o √† arquitetura de microsservi√ßo. A maioria dos nossos servi...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Desenvolvimento de operadores Kubernetes com Operator Framework</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/lamoda/blog/446648/"><p><img src="https://habrastorage.org/getpro/habr/post_images/352/5c8/f16/3525c8f16510afa2b61b0ff9b8434a02.png" alt="Imagem"></p><br><p>  Como mencionado no artigo <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Radar Technology</a> , a Lamoda est√° se movendo ativamente em dire√ß√£o √† arquitetura de microsservi√ßo.  A maioria dos nossos servi√ßos √© empacotada usando o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Helm</a> e implantada no Kubernetes.  Essa abordagem atende totalmente √†s nossas necessidades em 99% dos casos.  1% permanece quando a funcionalidade padr√£o do Kubernetes n√£o √© suficiente, por exemplo, quando voc√™ precisa configurar um backup ou atualizar um servi√ßo para um evento espec√≠fico.  Para resolver esse problema, usamos o padr√£o do operador.  Nesta s√©rie de artigos, I - Grigory Mikhalkin, desenvolvedor da equipe de P&amp;D da Lamoda - falar√° sobre as li√ß√µes que aprendi da minha experi√™ncia no desenvolvimento de operadores K8s usando a <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Estrutura</a> do <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Operador</a> . </p><a name="habracut"></a><br><h2 id="chto-takoe-operator">  O que √© um operador? </h2><br><p>  Uma maneira de estender a funcionalidade do Kubernetes √© criar seus pr√≥prios controladores.  As principais abstra√ß√µes no Kubernetes s√£o objetos e controladores.  Objetos descrevem o estado desejado do cluster.  Por exemplo, um <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Pod</a> descreve quais cont√™ineres precisam ser iniciados e os par√¢metros de inicializa√ß√£o, e o objeto <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">ReplicaSet</a> informa quantas r√©plicas de um determinado Pod precisam ser iniciadas.  Os controladores controlam o estado do cluster com base na descri√ß√£o dos objetos. No caso descrito acima, o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">ReplicationController</a> suportar√° o n√∫mero de r√©plicas de Pods especificadas no ReplicaSet.  Com a ajuda de novos controladores, voc√™ pode implementar l√≥gica adicional, como enviar notifica√ß√µes para eventos, recuperar-se de uma falha ou gerenciar <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">recursos de terceiros</a> . </p><br><p> Um operador √© um aplicativo kubernetes que inclui um ou mais controladores que servem um recurso de terceiros.  O conceito foi <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">inventado pela equipe do CoreOS</a> em 2016 e, recentemente, a popularidade das operadoras vem crescendo rapidamente.  Voc√™ pode tentar encontrar o operador desejado na <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">lista no kubedex</a> (mais de 100 operadores publicamente dispon√≠veis est√£o listados aqui), bem como no <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">OperatorHub</a> .  Existem tr√™s ferramentas populares para o desenvolvimento do operador: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Kubebuilder</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Operator SDK</a> e <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Metacontroller</a> .  Em Lamoda, usamos o Operator SDK, portanto falaremos sobre isso mais tarde. </p><br><h2 id="operator-sdk">  SDK do operador </h2><br><p><img src="https://habrastorage.org/getpro/habr/post_images/f7e/56d/194/f7e56d1948a2f5291ef189e7a03df9be.png" alt="Imagem"></p><br><p>  O Operator SDK faz parte da Estrutura do operador, que inclui duas partes mais importantes: Operator Lifecycle Manager e Operator Metering. </p><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">O Operator SDK</a> √© um wrapper para <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">controller-runtime</a> , uma biblioteca popular para o desenvolvimento de controladores (que, por sua vez, √© um wrapper para o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">client-go</a> ), um gerador de c√≥digo + estrutura para a grava√ß√£o de testes E2E. </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Operator Lifecycle Manager</a> - uma estrutura para gerenciar operadores existentes;  resolve situa√ß√µes em que o operador entra no modo zumbi ou uma nova vers√£o √© lan√ßada. </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Medi√ß√£o do operador</a> - como o nome indica, ele coleta dados sobre o trabalho do operador e tamb√©m pode gerar relat√≥rios com base neles. </li></ul><br><h2 id="sozdanie-novogo-proekta">  Crie um novo projeto </h2><br><p>  Um exemplo √© um operador que monitora um arquivo com configura√ß√µes no reposit√≥rio e, quando atualizado, reinicia a implanta√ß√£o do servi√ßo com novas configura√ß√µes.  O c√≥digo de amostra completo est√° dispon√≠vel <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">aqui</a> . </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/4c0/e84/ebc/4c0e84ebcba8cad49b2bea8506f79d32.png" alt="Imagem"></p><br><p>  Crie um projeto com um novo operador: </p><br><pre><code class="plaintext hljs">operator-sdk new config-monitor</code> </pre> <br><p>  O gerador de c√≥digo criar√° c√≥digo para o operador que trabalha no <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">espa√ßo para nome</a> alocado.  Essa abordagem √© prefer√≠vel a dar acesso a todo o cluster, pois, em caso de erros, os problemas ser√£o isolados no mesmo espa√ßo para nome.  O operador em <code>cluster-wide</code> pode ser gerado adicionando <code>--cluster-scoped</code> .  Os seguintes diret√≥rios estar√£o localizados dentro do projeto criado: </p><br><ul><li>  cmd - cont√©m o <code>main package</code> , no qual o <code>Manager</code> inicializado e lan√ßado; </li><li>  deploy - cont√©m declara√ß√µes do operador, CRD e objetos necess√°rios para configurar o operador RBAC; </li><li>  pkg - aqui ser√° o nosso c√≥digo principal para novos objetos e controladores. </li></ul><br><p>  H√° apenas um arquivo <a href=""><code>cmd/manager/main.go</code></a> no <a href=""><code>cmd/manager/main.go</code></a> . </p><br><div class="spoiler">  <b class="spoiler_title">Snippet de c√≥digo</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">// Become the leader before proceeding err = leader.Become(ctx, "config-monitor-lock") if err != nil { log.Error(err, "") os.Exit(1) } // Create a new Cmd to provide shared dependencies and start components mgr, err := manager.New(cfg, manager.Options{ Namespace: namespace, MetricsBindAddress: fmt.Sprintf("%s:%d", metricsHost, metricsPort), }) ... // Setup Scheme for all resources if err := apis.AddToScheme(mgr.GetScheme()); err != nil { log.Error(err, "") os.Exit(1) } // Setup all Controllers if err := controller.AddToManager(mgr); err != nil { log.Error(err, "") os.Exit(1) } ... // Start the Cmd if err := mgr.Start(signals.SetupSignalHandler()); err != nil { log.Error(err, "Manager exited non-zero") os.Exit(1) }</code> </pre> </div></div><br><p>  Na primeira linha: <code>err = leader.Become(ctx, "config-monitor-lock")</code> - um l√≠der √© selecionado.  Na maioria dos cen√°rios, apenas uma inst√¢ncia ativa de uma instru√ß√£o no espa√ßo para nome / cluster √© necess√°ria.  Por padr√£o, o Operator SDK usa a estrat√©gia <a href="">Leader for life</a> - a primeira inst√¢ncia iniciada do operador permanecer√° l√≠der at√© ser removida do cluster. </p><br><p>  Ap√≥s essa inst√¢ncia do operador ter sido nomeada l√≠der, um novo <code>Manager</code> √© inicializado - <code>mgr, err := manager.New(...)</code> .  Suas responsabilidades incluem: </p><br><ul><li>  <code>err := apis.AddToScheme(mgr.GetScheme())</code> - registro de novos esquemas de recursos; </li><li>  <code>err := controller.AddToManager(mgr)</code> - registro de controladores; </li><li>  <code>err := mgr.Start(signals.SetupSignalHandler())</code> - inicia e controla os controladores. </li></ul><br><p>  No momento, n√£o temos novos recursos nem controladores para registro.  Voc√™ pode adicionar um novo recurso usando o comando: </p><br><pre> <code class="plaintext hljs">operator-sdk add api --api-version=services.example.com/v1alpha1 --kind=MonitoredService</code> </pre> <br><p>  Este comando incluir√° a defini√ß√£o de esquema de recurso <code>MonitoredService</code> no diret√≥rio <code>pkg/apis</code> , bem como yaml com a defini√ß√£o de <code>CRD</code> em <code>deploy/crds</code> .  De todos os arquivos gerados, voc√™ deve alterar manualmente apenas a defini√ß√£o de esquema em <a href=""><code>monitoredservice_types.go</code></a> .  O tipo <code>MonitoredServiceSpec</code> define o estado desejado do recurso: o que o usu√°rio especifica no yaml com a defini√ß√£o do recurso.  No contexto de nosso operador, o campo <code>Size</code> determina o n√∫mero desejado de r√©plicas, <code>ConfigRepo</code> indica de onde as configura√ß√µes atuais podem ser <code>ConfigRepo</code> .  <code>MonitoredServiceStatus</code> determina o estado observado do recurso, por exemplo, armazena os nomes dos Pods pertencentes a esse recurso e os Pods de <code>spec</code> atual. </p><br><p>  Ap√≥s editar o esquema, voc√™ precisa executar o comando: </p><br><pre> <code class="plaintext hljs">operator-sdk generate k8s</code> </pre> <br><p>  Ele atualizar√° a defini√ß√£o de <code>CRD</code> em <code>deploy/crds</code> . </p><br><p>  Agora vamos criar a parte principal do nosso operador, o controlador: </p><br><pre> <code class="plaintext hljs">operator-sdk add controller --api-version=services.example.com/v1alpha1 --kind=Monitor</code> </pre> <br><p>  O arquivo <a href=""><code>monitor_controller.go</code></a> aparecer√° no <a href=""><code>monitor_controller.go</code></a> <code>pkg/controller</code> , no qual adicionamos a l√≥gica necess√°ria. </p><br><h2 id="razrabotka-kontrollera">  Desenvolvimento de Controladores </h2><br><p>  O controlador √© a principal unidade de trabalho do operador.  No nosso caso, existem dois controladores: </p><br><ul><li>  O controlador do monitor monitora as altera√ß√µes na configura√ß√£o do servi√ßo; </li><li>  O controlador de atualiza√ß√£o atualiza o servi√ßo e o mant√©m no estado desejado. </li></ul><br><p>  Em sua ess√™ncia, o controlador √© um loop de controle, monitora a fila com os eventos nos quais est√° inscrito e os processa: </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/220/2e6/a09/2202e6a0931df3e5b87c4442dd839615.png" alt="Imagem"></p><br><p>  Um novo controlador √© criado e registrado pelo gerente no m√©todo <code>add</code> : </p><br><pre> <code class="plaintext hljs">c, err := controller.New("monitor-controller", mgr, controller.Options{Reconciler: r})</code> </pre> <br><p>  Usando o m√©todo <code>Watch</code> , n√≥s o inscrevemos em eventos relacionados √† cria√ß√£o de um novo recurso ou √† atualiza√ß√£o <code>Spec</code> de um recurso <code>MonitoredService</code> existente: </p><br><pre> <code class="plaintext hljs">err = c.Watch(&amp;source.Kind{Type: &amp;servicesv1alpha1.MonitoredService{}}, &amp;handler.EnqueueRequestForObject{}, common.CreateOrUpdateSpecPredicate)</code> </pre> <br><p>  O tipo de evento pode ser configurado usando os par√¢metros <code>src</code> e <code>predicates</code> .  <code>src</code> aceita objetos do tipo <code>Source</code> . </p><br><ul><li>  <code>Informer</code> - pesquisa periodicamente o <code>apiserver</code> em <code>apiserver</code> de eventos que correspondam ao filtro, se houver, coloca-o na fila do controlador.  No <code>controller-runtime</code> esse √© um wrapper sobre o <code>SharedIndexInformer</code> do <code>client-go</code> . </li><li>  <code>Kind</code> tamb√©m √© um inv√≥lucro do <code>SharedIndexInformer</code> , mas, diferentemente do <code>Informer</code> , ele cria independentemente uma inst√¢ncia do informer com base nos par√¢metros passados ‚Äã‚Äã(esquema do recurso monitorado). </li><li>  <code>Channel</code> - aceita o <code>chan event.GenericEvent</code> como par√¢metro, os eventos que passam por ele s√£o colocados na fila do controlador. </li></ul><br><p>  <code>redicates</code> espera objetos que satisfa√ßam a interface do <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><code>Predicate</code></a> .  Na verdade, esse √© um filtro adicional para eventos, por exemplo, ao filtrar o <code>UpdateEvent</code> voc√™ pode ver exatamente quais altera√ß√µes foram feitas na <code>spec</code> recurso. </p><br><p>  Quando um evento chega, um <code>EventHandler</code> aceita - o segundo argumento do m√©todo <code>Watch</code> - que envolve o evento no formato de solicita√ß√£o que o <code>Reconciler</code> espera: </p><br><ul><li>  <code>EnqueueRequestForObject</code> - cria uma solicita√ß√£o com o nome e o espa√ßo para nome do objeto que causou o evento; </li><li>  <code>EnqueueRequestForOwner</code> - cria uma solicita√ß√£o com os dados do pai do objeto.  Isso √© necess√°rio, por exemplo, se o <code>Pod</code> controlado por recursos foi exclu√≠do e voc√™ precisa iniciar sua substitui√ß√£o; </li><li>  <code>EnqueueRequestsFromMapFunc</code> - usa como par√¢metro a fun√ß√£o de <code>map</code> que recebe um evento ( <code>MapObject</code> em <code>MapObject</code> ) e retorna uma lista de solicita√ß√µes.  <a href="">Um exemplo em que esse manipulador</a> √© <a href="">necess√°rio</a> - existe um cron√¥metro, para cada marca da qual voc√™ precisa obter novas configura√ß√µes para todos os servi√ßos dispon√≠veis. </li></ul><br><p>  As solicita√ß√µes s√£o colocadas na fila do controlador e um dos trabalhadores (por padr√£o, o controlador possui um) puxa o evento para fora da fila e o passa para o <code>Reconciler</code> . </p><br><p>  <strong>O reconciliador</strong> implementa apenas um m√©todo - <code>Reconcile</code> , que cont√©m a l√≥gica b√°sica do processamento de eventos: </p><br><div class="spoiler">  <b class="spoiler_title">m√©todo de reconcilia√ß√£o</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">func (r *ReconcileMonitor) Reconcile(request reconcile.Request) (reconcile.Result, error) { reqLogger := log.WithValues("Request.Namespace", request.Namespace, "Request.Name", request.Name) reqLogger.Info("Checking updates in repo for MonitoredService") // fetch the Monitor instance instance := &amp;servicesv1alpha1.MonitoredService{} err := r.client.Get(context.Background(), request.NamespacedName, instance) if err != nil { if errors.IsNotFound(err) { // Request object not found, could have been deleted after reconcile request. // Owned objects are automatically garbage collected. For additional cleanup logic use finalizers. // Return and don't requeue return reconcile.Result{}, nil } // Error reading the object - requeue the request. return reconcile.Result{}, err } // check if service's config was updated // if it was, send event to upgrade controller if podSpec, ok := r.isServiceConfigUpdated(instance); ok { // Update instance Spec instance.Status.PodSpec = *podSpec instance.Status.ConfigChanged = true err = r.client.Status().Update(context.Background(), instance) if err != nil { reqLogger.Error(err, "Failed to update service status", "Service.Namespace", instance.Namespace, "Service.Name", instance.Name) return reconcile.Result{}, err } r.eventsChan &lt;- event.GenericEvent{Meta: &amp;servicesv1alpha1.MonitoredService{}, Object: instance} } return reconcile.Result{}, nil }</code> </pre> </div></div><br><p>  O m√©todo aceita um objeto <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><code>Request</code></a> com o campo <code>NamespacedName</code> , pelo qual o recurso pode ser extra√≠do do cache: <code>r.client.Get(context.TODO(), request.NamespacedName, instance)</code> .  No exemplo, √© feita uma solicita√ß√£o ao arquivo com a configura√ß√£o de servi√ßo referenciada pelo campo <code>ConfigRepo</code> na <code>spec</code> recurso.  Se a configura√ß√£o for atualizada, um novo evento do tipo <code>GenericEvent</code> ser√° <code>GenericEvent</code> e enviado ao canal que o controlador de <code>Upgrade</code> ouve. </p><br><p>  Ap√≥s o processamento da solicita√ß√£o, <code>Reconcile</code> retorna um objeto do tipo <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><code>Result</code></a> e <code>error</code> .  Se o campo <code>Result</code> for <code>Requeue: true</code> ou <code>error != nil</code> , o controlador retornar√° a solicita√ß√£o de volta para a fila usando o m√©todo <code>queue.AddRateLimited</code> .  A solicita√ß√£o ser√° retornada para a fila com um atraso, determinado pelo <code>RateLimiter</code> .  Por padr√£o, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><code>ItemExponentialFailureRateLimiter</code></a> usado, o que aumenta exponencialmente o tempo de atraso com um aumento no n√∫mero de "retornos" de solicita√ß√£o.  Se o campo <code>Requeue</code> n√£o <code>Requeue</code> definido e nenhum erro ocorreu durante o processamento da solicita√ß√£o, o controlador chamar√° o m√©todo <code>Queue.Forget</code> , que remover√° a solicita√ß√£o do cache do <code>RateLimiter</code> (redefinindo o n√∫mero de devolu√ß√µes).  No final do processamento da solicita√ß√£o, o controlador o remove da fila usando o m√©todo <code>Queue.Done</code> . </p><br><h2 id="zapusk-operatora">  Lan√ßamento do operador </h2><br><p>  Os componentes do operador foram descritos acima, e uma pergunta permaneceu: como inici√°-lo.  Primeiro, voc√™ precisa garantir que todos os recursos necess√°rios estejam instalados (para testes locais, recomendo <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">configurar</a> o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">minikube</a> ): </p><br><pre> <code class="plaintext hljs"># Setup Service Account kubectl create -f deploy/service_account.yaml # Setup RBAC kubectl create -f deploy/role.yaml kubectl create -f deploy/role_binding.yaml # Setup the CRD kubectl create -f deploy/crds/services_v1alpha1_monitoredservice_crd.yaml # Setup custom resource kubectl create -f deploy/crds/services_v1alpha1_monitoredservice_cr.yaml</code> </pre> <br><p>  Depois que os pr√©-requisitos forem atendidos, h√° duas maneiras f√°ceis de executar a instru√ß√£o para teste.  O mais f√°cil √© inici√°-lo fora do cluster usando o comando: </p><br><pre> <code class="plaintext hljs">operator-sdk up local --namespace=default</code> </pre> <br><p>  A segunda maneira √© implantar o operador no cluster.  Primeiro, voc√™ precisa criar uma imagem do Docker com o operador: </p><br><pre> <code class="plaintext hljs">operator-sdk build config-monitor-operator:latest</code> </pre> <br><p>  No arquivo <code>deploy/operator.yaml</code> , substitua <code>REPLACE_IMAGE</code> por <code>config-monitor-operator:latest</code> : </p><br><pre> <code class="plaintext hljs">sed -i "" 's|REPLACE_IMAGE|config-monitor-operator:latest|g' deploy/operator.yaml</code> </pre> <br><p>  Crie a implanta√ß√£o com a instru√ß√£o: </p><br><pre> <code class="plaintext hljs">kubectl create -f deploy/operator.yaml</code> </pre> <br><p>  Agora, na lista de <code>Pod</code> no cluster, deve aparecer o <code>Pod</code> com um servi√ßo de teste e, no segundo caso - outro com um operador. </p><br><h2 id="vmesto-zaklyucheniya-ili-best-practices">  Em vez de uma conclus√£o ou melhores pr√°ticas </h2><br><p>  Os principais problemas do desenvolvimento do operador no momento s√£o a documenta√ß√£o fraca das ferramentas e a falta de boas pr√°ticas estabelecidas.  Quando um novo desenvolvedor come√ßa a desenvolver um operador, ele praticamente n√£o tem onde procurar exemplos da implementa√ß√£o de um requisito espec√≠fico, de modo que erros s√£o inevit√°veis.  Abaixo est√£o algumas li√ß√µes que aprendemos com nossos erros: </p><br><ul><li>  Se houver dois aplicativos relacionados, evite o desejo de combin√°-los com um √∫nico operador.  Caso contr√°rio, o princ√≠pio dos servi√ßos de acoplamento flex√≠vel √© violado. </li><li>  Voc√™ precisa se lembrar sobre a separa√ß√£o de preocupa√ß√µes: voc√™ n√£o deve tentar implementar toda a l√≥gica em um controlador.  Por exemplo, vale a pena espalhar as fun√ß√µes de monitorar configura√ß√µes e criar / atualizar um recurso. </li><li>  O bloqueio de chamadas deve ser evitado no m√©todo <code>Reconcile</code> .  Por exemplo, voc√™ pode obter configura√ß√µes de uma fonte externa, mas se a opera√ß√£o for mais longa, crie uma goroutine para isso e envie a solicita√ß√£o de volta para a fila, indicando na resposta <code>Requeue: true</code> . </li></ul><br><p>  Nos coment√°rios, seria interessante ouvir sobre sua experi√™ncia no desenvolvimento de operadores.  E na pr√≥xima parte, falaremos sobre testes de operadores. </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt446648/">https://habr.com/ru/post/pt446648/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt446638/index.html">Cisco HyperFlex vs. concorrentes: testando o desempenho</a></li>
<li><a href="../pt446640/index.html">20 projetos, 20 idiomas, prazo de ontem. Parte 2</a></li>
<li><a href="../pt446642/index.html">Lista de verifica√ß√£o para criar e publicar aplicativos da web</a></li>
<li><a href="../pt446644/index.html">Como executar o SMM em 2019: 17 diagramas de Neil Patel</a></li>
<li><a href="../pt446646/index.html">Vers√£o InterSystems IRIS 2019.1</a></li>
<li><a href="../pt446650/index.html">Quanto custam os testadores e em que dependem seus sal√°rios? Criando um retrato de um especialista em controle de qualidade bem-sucedido</a></li>
<li><a href="../pt446654/index.html">Como salvamos a revis√£o de c√≥digo</a></li>
<li><a href="../pt446656/index.html">Codifica√ß√£o de fala de 1600 bits / s com vocoder neural LPCNet</a></li>
<li><a href="../pt446658/index.html">Entrevista com Andrei Stankevich sobre programa√ß√£o esportiva</a></li>
<li><a href="../pt446660/index.html">IA, aluno e grande pr√™mio: como fazer o aprendizado de m√°quina na 8¬™ s√©rie</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>