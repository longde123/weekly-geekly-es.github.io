<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🚴🏽 💎 🧛🏻 Por que o Windows lê um arquivo cem mil vezes para abrir um menu? 🙅 🈯️ 👩🏻‍🏫</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="“O Explorer gasta 700 ms para abrir o menu de contexto da barra de tarefas. 75% desse tempo, ele realiza 114.801 operações de leitura de um arquivo, a...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Por que o Windows lê um arquivo cem mil vezes para abrir um menu?</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/466941/"><div style="text-align:center;"><img src="https://habrastorage.org/webt/ch/_4/cr/ch_4crxmyunnytvqypom95isxzu.png"></div><br>  <i>“O Explorer gasta 700 ms para abrir o menu de contexto da barra de tarefas.</i>  <i>75% desse tempo, ele realiza 114.801 operações de leitura de um arquivo, a quantidade média de dados de leitura é de 68 bytes.</i> <i><br><br></i>  <i>Devo escrever um post sobre isso ou um tweet bastante sarcástico? ”</i> <br><br>  Trabalho rapidamente em um computador e, portanto, me incomoda quando tenho que esperar pela conclusão de uma operação que deve ser executada instantaneamente.  Um obstáculo constante no meu laptop doméstico pesado foi o lento fechamento das janelas na barra de tarefas.  Clique com o botão direito do mouse no ícone, aguarde o menu abrir e, em seguida, selecione "Fechar janela".  O mais lento nesse processo deve ser o movimento do mouse, mas o componente mais longo é o atraso antes que o menu seja exibido. <br><br>  Isso me incomodou por um longo tempo, mas eu demonstrei autocontrole incomum e me mantive irritada.  Isso foi até hoje, quando eu finalmente quebrei e agarrei o marcador <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">ETW</a> . <br><br><blockquote>  Este post foi escrito como uma verificação de velocidade dos blogs.  Cerca de 90 minutos se passaram desde o momento em que o problema foi encontrado e o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">tweet sarcástico</a> até a publicação do post. </blockquote><a name="habracut"></a><br>  O rastreador ETW corrigiu como eu clico com o botão direito na barra de tarefas e fecho as duas janelas do Explorer.  Usei o <em>rastreamento de</em> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">UIforETW</a> <em>para arquivar a</em> função com opções padrão, resultando em um <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">log de diagnóstico de 20,9 MB</a> . <br><br>  Às vezes, a parte mais difícil na análise de um rastreamento é encontrar a localização do problema, mas, nesse caso, essa parte da análise é trivial.  Havia três sinais inequívocos indicando o lugar certo e o culpado dolorosamente óbvio do crime. <br><br>  O primeiro sinal foram os eventos de entrada.  O UIforETW contém um <a href="">logger de entrada</a> integrado (suficientemente anonimizado para que eu não roube senhas ou informações pessoais acidentalmente), então eu apenas tive que estudar os eventos <em>MouseUp</em> e <em>Button Type</em> em detalhes com um valor 2 correspondente ao botão direito do mouse.  Ao mesmo tempo, as marcas na linha do tempo <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">WPA</a> aparecem quando esses eventos ocorrem - veja as linhas verticais na captura de tela: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/473/260/dfb/473260dfbe7feb356779ba3856bd0200.png"></div><br>  Isso deixou claro para mim que, quando solto o botão direito do mouse, após 600 ms, o foco da janela muda, o que, na minha opinião, corresponde ao momento em que o menu é exibido.  Além disso, o RuntimeBroker.exe possui um bloco claro de atividade da CPU entre os eventos de liberação do botão do mouse e alteração do foco da janela. <br><br>  <em>Não foi provado</em> que a alteração no foco da janela e na atividade da CPU esteja relacionada, mas depois de fazer medições usando o aplicativo de gravação de tela, vi que são necessários cerca de 660 ms para exibir o menu, por isso, confio nisso. <br><br>  O próximo passo é aprender o que o RuntimeBroker.exe está fazendo.  Embora <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">o Uso da CPU (Preciso)</a> ajude você a ver quanto tempo de CPU o processo usa e por que ele está ocioso, a <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">tabela Uso</a> da <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">CPU (Amostrada)</a> é uma boa ferramenta para descobrir em que tempo de CPU é gasto.  Estudei-o cuidadosamente e descobri rapidamente que 264 amostras eram do <em>KernelBase.dll!</em> <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/af9/b29/3fb/af9b293fbc60d45984d282de5c7ac571.png"></div><br>  Depois de pesquisar um pouco mais, encontrei outras pilhas de chamadas que também afetavam essa função. <em>Cliquei</em> com o botão direito do mouse e selecionei <em>Ver chamadores-&gt; Por função</em> .  O modo ativado (com pilhas invertidas) mostrou que de 899 amostras desse processo, 628 amostras ou 70% de pilhas de chamadas diferentes passaram por esta função: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/027/118/5ee/0271185ee13e7aa4eafdb84921bbde1f.png"></div><br>  271 amostras neste fluxo não passaram pela função e as amostras restantes (não mostradas) estavam em outros fluxos. <br><br>  Observe que 899 amostras em um fluxo de 10252 representam dois cliques do mouse, isto é, aproximadamente 450 amostras ou 450 ms (com uma frequência de amostragem padrão de 1 kHz) por clique do mouse. <br><br><h2>  Às vezes, a E / S do arquivo é o tempo da CPU </h2><br>  O uso da CPU (amostrado) mostra o tempo da <em>CPU</em> ; portanto, a E / S do disco geralmente não é exibida aqui, porque nesses momentos o fluxo adormece e aguarda o disco.  O fato de as operações de E / S serem exibidas como tempo da CPU significa que todas as leituras caíram no cache do sistema e o tempo da CPU foi um recurso extra do kernel (consulte <em>ntoskrnl.exe</em> na primeira pilha de chamadas de amostra) gasto na obtenção de dados do cache. <br><br>  Agora que a <em>E / S de arquivo</em> ficou sob suspeita, precisamos ir para o <em>Graph Explorer-&gt; Armazenamento-&gt; Arquivo de E / S.</em>  Depois de ajustar ligeiramente a aparência das colunas, obtivemos o seguinte resultado impressionante: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/3a6/778/c22/3a6778c22693377d8954494d5714c3b3.png"></div><br>
  ,    10 252     <em>RuntimeBroker.exe</em>  229 604  <em>ReadFile</em>,    15 686 586 .         68 .<br>
<br>
    .<br>
<br>
 ,       —  .  ,   <em>RuntimeBroker.exe</em>     .         4 027 904 ,    ,         ,   1,9      .<br>
<br>
  ,              .     ,        (   ):<br>
<br>
<code>%appdata%\Microsoft\Windows\Recent\AutomaticDestinations\f01b4d95cf55d32a.automaticDestinations-ms</code><br>
<br>
        WPA.    —     ,         .               :<br>
<br>
<div style="text-align:center;"><img width="654" height="145" alt="Image" src="https://habrastorage.org/getpro/habr/post_images/6e7/f9c/edd/6e7f9cedde92e2f54da11fd5858b26e5.png"></div><br>
  «     „“,   ( )   (  )     „“/ .     ,   ». <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">, </a>!<br>
<br>
,     .       ,        ,       ,     .<br>
<br>
<h2> </h2><br>
<ul>
<li>  ReadFile,   68 . ,   ,      .  ,  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">     4 </a>,     <em></em>.</li>
<li>, -   ,        —   .</li>
<li>, -     ,     . ,    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">  ETW</a>   !</li>
<li>      <a title="https://aka.ms/AA60dfg" href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">https://aka.ms/AA60dfg</a></li>
<li>      ,     <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">UIforETW</a>   ,     <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="></a></li>
<li> ,        ( ,     ),  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">shift+    </a>.     ,      .</li>
<li>  Hacker news  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="></a></li>
<li>  Reddit  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="></a></li>
<li>  Twitter  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="></a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="></a></li>
</ul></div>
      
    </div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt466941/">https://habr.com/ru/post/pt466941/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt466925/index.html">Como executar o VDS Hi-CPU para Bitrix, dispersar papagaios e não quebrar</a></li>
<li><a href="../pt466929/index.html">Adicionar token de atualização</a></li>
<li><a href="../pt466931/index.html">Otimização de desempenho para aplicativos .NET (C #)</a></li>
<li><a href="../pt466933/index.html">Como fazer amigos indústria e big data</a></li>
<li><a href="../pt466937/index.html">Como fazemos a Olimpíada on-line totalmente russa em inglês, matemática e ciência da computação</a></li>
<li><a href="../pt466949/index.html">Perspectivas para redes quânticas: quem se envolve nelas e por que</a></li>
<li><a href="../pt466955/index.html">Enigmas do currículo. Parte 3. O véu dos segredos removidos</a></li>
<li><a href="../pt466957/index.html">iPhone 11, o novo iPad, TV +, Arcade e muito mais. O que a Apple mostrou hoje</a></li>
<li><a href="../pt466963/index.html">Habrastatistics: como Habr vive sem geektimes</a></li>
<li><a href="../pt466965/index.html">Apresentação da Apple 10 de setembro de 2019</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>