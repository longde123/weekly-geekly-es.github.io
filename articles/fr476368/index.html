<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üïñ üèâ üêÅ Construire un CI / CD personnel avec des actions GitHub et Python üè≥Ô∏è‚Äçüåà üèòÔ∏è üåæ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Un soir, en rentrant du travail, j'ai d√©cid√© de faire un peu de devoirs. J'ai fait plusieurs modifications et j'ai imm√©diatement voulu les exp√©rimente...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Construire un CI / CD personnel avec des actions GitHub et Python</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/476368/"><p> Un soir, en rentrant du travail, j'ai d√©cid√© de faire un peu de devoirs.  J'ai fait plusieurs modifications et j'ai imm√©diatement voulu les exp√©rimenter.  Mais avant les exp√©riences, je devais aller dans le VPS, pousser les changements, reconstruire le conteneur et l'ex√©cuter.  J'ai alors d√©cid√© qu'il √©tait temps de s'occuper de la livraison continue. <br><img src="https://habrastorage.org/webt/xa/l4/dm/xal4dmowtxwpuoxxrutujwwy4fm.jpeg"></p><a name="habracut"></a><br><p>  Au d√©part, j'avais le choix entre Circle CI, Travis ou Jenkins.  J'ai exclu Jenkins presque imm√©diatement en raison du manque de besoin d'un outil aussi puissant.  Apr√®s une lecture rapide de Travis, je suis arriv√© √† la conclusion qu'il est pratique de l'assembler et de le tester, mais vous ne pouvez pas imaginer de livraison avec.  J'ai d√©couvert Circle CI gr√¢ce √† des publicit√©s trop intrusives sur YouTube.  J'ai commenc√© √† exp√©rimenter avec des exemples, mais √† un moment donn√© je me suis tromp√© et j'ai eu des tests √©ternels, ce qui m'a pris beaucoup de pr√©cieuses minutes de montage (en g√©n√©ral, il y a une limite suffisante pour ne pas s'inqui√©ter, mais √ßa m'a frapp√©).  Reprenant la recherche, je suis tomb√© sur Github Actions.  Apr√®s avoir jou√© avec les exemples de prise en main, j'ai eu une impression positive et apr√®s un rapide coup d'≈ìil √† la documentation, je suis arriv√© √† la conclusion qu'il est tr√®s cool de pouvoir garder des secrets pour l'assemblage, collecter et d√©ployer pratiquement des projets en un seul endroit.  Avec des yeux brillants, il dessina rapidement le sch√©ma souhait√© et les engrenages tourn√®rent. </p><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/h1/fp/rv/h1fprvm3jru4em3vj0ae6xruu5i.jpeg" alt="planifier"></div><br><p>  Tout d'abord, nous allons essayer de faire le test.  √Ä titre exp√©rimental, j'ai √©crit un serveur Web simple sur Flask avec 2 points de terminaison: </p><br><div class="spoiler">  <b class="spoiler_title">Lister une application Web simple</b> <div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> flask <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> Flask <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> flask <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> request, jsonify app = Flask(__name__) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">validate_post_data</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(data: dict)</span></span></span><span class="hljs-function"> -&gt; bool:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> isinstance(data, dict): <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">False</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> data.get(<span class="hljs-string"><span class="hljs-string">'name'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> isinstance(data[<span class="hljs-string"><span class="hljs-string">'name'</span></span>], str): <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">False</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> data.get(<span class="hljs-string"><span class="hljs-string">'age'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> isinstance(data[<span class="hljs-string"><span class="hljs-string">'age'</span></span>], int): <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">False</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">True</span></span> @app.route(<span class="hljs-string"><span class="hljs-string">'/'</span></span>, methods=[<span class="hljs-string"><span class="hljs-string">'GET'</span></span>]) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">hello</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">'Hello World!'</span></span> @app.route(<span class="hljs-string"><span class="hljs-string">'/api'</span></span>, methods=[<span class="hljs-string"><span class="hljs-string">'GET'</span></span>, <span class="hljs-string"><span class="hljs-string">'POST'</span></span>]) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">api</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-string"><span class="hljs-string">""" /api entpoint GET - returns json= {'status': 'test'} POST - { name - str not null age - int optional } :return: """</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> request.method == <span class="hljs-string"><span class="hljs-string">'GET'</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> jsonify({<span class="hljs-string"><span class="hljs-string">'status'</span></span>: <span class="hljs-string"><span class="hljs-string">'test'</span></span>}) <span class="hljs-keyword"><span class="hljs-keyword">elif</span></span> request.method == <span class="hljs-string"><span class="hljs-string">'POST'</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> validate_post_data(request.json): <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> jsonify({<span class="hljs-string"><span class="hljs-string">'status'</span></span>: <span class="hljs-string"><span class="hljs-string">'OK'</span></span>}) <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> jsonify({<span class="hljs-string"><span class="hljs-string">'status'</span></span>: <span class="hljs-string"><span class="hljs-string">'bad input'</span></span>}), <span class="hljs-number"><span class="hljs-number">400</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">:</span></span> app.run(host=<span class="hljs-string"><span class="hljs-string">'0.0.0.0'</span></span>, port=<span class="hljs-number"><span class="hljs-number">8080</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> __name__ == <span class="hljs-string"><span class="hljs-string">'__main__'</span></span>: main()</code> </pre> </div></div><br><p>  Et quelques tests: </p><br><div class="spoiler">  <b class="spoiler_title">Liste des tests d'application</b> <div class="spoiler_text"><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> unittest <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> app <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> tested_app <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> json <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">FlaskAppTests</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(unittest.TestCase)</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setUp</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> tested_app.app.config[<span class="hljs-string"><span class="hljs-string">'TESTING'</span></span>] = <span class="hljs-keyword"><span class="hljs-keyword">True</span></span> self.app = tested_app.app.test_client() <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">test_get_hello_endpoint</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> r = self.app.get(<span class="hljs-string"><span class="hljs-string">'/'</span></span>) self.assertEqual(r.data, <span class="hljs-string"><span class="hljs-string">b'Hello World!'</span></span>) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">test_post_hello_endpoint</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> r = self.app.post(<span class="hljs-string"><span class="hljs-string">'/'</span></span>) self.assertEqual(r.status_code, <span class="hljs-number"><span class="hljs-number">405</span></span>) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">test_get_api_endpoint</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> r = self.app.get(<span class="hljs-string"><span class="hljs-string">'/api'</span></span>) self.assertEqual(r.json, {<span class="hljs-string"><span class="hljs-string">'status'</span></span>: <span class="hljs-string"><span class="hljs-string">'test'</span></span>}) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">test_correct_post_api_endpoint</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> r = self.app.post(<span class="hljs-string"><span class="hljs-string">'/api'</span></span>, content_type=<span class="hljs-string"><span class="hljs-string">'application/json'</span></span>, data=json.dumps({<span class="hljs-string"><span class="hljs-string">'name'</span></span>: <span class="hljs-string"><span class="hljs-string">'Den'</span></span>, <span class="hljs-string"><span class="hljs-string">'age'</span></span>: <span class="hljs-number"><span class="hljs-number">100</span></span>})) self.assertEqual(r.json, {<span class="hljs-string"><span class="hljs-string">'status'</span></span>: <span class="hljs-string"><span class="hljs-string">'OK'</span></span>}) self.assertEqual(r.status_code, <span class="hljs-number"><span class="hljs-number">200</span></span>) r = self.app.post(<span class="hljs-string"><span class="hljs-string">'/api'</span></span>, content_type=<span class="hljs-string"><span class="hljs-string">'application/json'</span></span>, data=json.dumps({<span class="hljs-string"><span class="hljs-string">'name'</span></span>: <span class="hljs-string"><span class="hljs-string">'Den'</span></span>})) self.assertEqual(r.json, {<span class="hljs-string"><span class="hljs-string">'status'</span></span>: <span class="hljs-string"><span class="hljs-string">'OK'</span></span>}) self.assertEqual(r.status_code, <span class="hljs-number"><span class="hljs-number">200</span></span>) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">test_not_dict_post_api_endpoint</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> r = self.app.post(<span class="hljs-string"><span class="hljs-string">'/api'</span></span>, content_type=<span class="hljs-string"><span class="hljs-string">'application/json'</span></span>, data=json.dumps([{<span class="hljs-string"><span class="hljs-string">'name'</span></span>: <span class="hljs-string"><span class="hljs-string">'Den'</span></span>}])) self.assertEqual(r.json, {<span class="hljs-string"><span class="hljs-string">'status'</span></span>: <span class="hljs-string"><span class="hljs-string">'bad input'</span></span>}) self.assertEqual(r.status_code, <span class="hljs-number"><span class="hljs-number">400</span></span>) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">test_no_name_post_api_endpoint</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> r = self.app.post(<span class="hljs-string"><span class="hljs-string">'/api'</span></span>, content_type=<span class="hljs-string"><span class="hljs-string">'application/json'</span></span>, data=json.dumps({<span class="hljs-string"><span class="hljs-string">'age'</span></span>: <span class="hljs-number"><span class="hljs-number">100</span></span>})) self.assertEqual(r.json, {<span class="hljs-string"><span class="hljs-string">'status'</span></span>: <span class="hljs-string"><span class="hljs-string">'bad input'</span></span>}) self.assertEqual(r.status_code, <span class="hljs-number"><span class="hljs-number">400</span></span>) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">test_bad_age_post_api_endpoint</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> r = self.app.post(<span class="hljs-string"><span class="hljs-string">'/api'</span></span>, content_type=<span class="hljs-string"><span class="hljs-string">'application/json'</span></span>, data=json.dumps({<span class="hljs-string"><span class="hljs-string">'name'</span></span>: <span class="hljs-string"><span class="hljs-string">'Den'</span></span>, <span class="hljs-string"><span class="hljs-string">'age'</span></span>: <span class="hljs-string"><span class="hljs-string">'100'</span></span>})) self.assertEqual(r.json, {<span class="hljs-string"><span class="hljs-string">'status'</span></span>: <span class="hljs-string"><span class="hljs-string">'bad input'</span></span>}) self.assertEqual(r.status_code, <span class="hljs-number"><span class="hljs-number">400</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> __name__ == <span class="hljs-string"><span class="hljs-string">'__main__'</span></span>: unittest.main()</code> ) <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> unittest <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> app <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> tested_app <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> json <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">FlaskAppTests</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(unittest.TestCase)</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setUp</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> tested_app.app.config[<span class="hljs-string"><span class="hljs-string">'TESTING'</span></span>] = <span class="hljs-keyword"><span class="hljs-keyword">True</span></span> self.app = tested_app.app.test_client() <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">test_get_hello_endpoint</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> r = self.app.get(<span class="hljs-string"><span class="hljs-string">'/'</span></span>) self.assertEqual(r.data, <span class="hljs-string"><span class="hljs-string">b'Hello World!'</span></span>) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">test_post_hello_endpoint</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> r = self.app.post(<span class="hljs-string"><span class="hljs-string">'/'</span></span>) self.assertEqual(r.status_code, <span class="hljs-number"><span class="hljs-number">405</span></span>) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">test_get_api_endpoint</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> r = self.app.get(<span class="hljs-string"><span class="hljs-string">'/api'</span></span>) self.assertEqual(r.json, {<span class="hljs-string"><span class="hljs-string">'status'</span></span>: <span class="hljs-string"><span class="hljs-string">'test'</span></span>}) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">test_correct_post_api_endpoint</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> r = self.app.post(<span class="hljs-string"><span class="hljs-string">'/api'</span></span>, content_type=<span class="hljs-string"><span class="hljs-string">'application/json'</span></span>, data=json.dumps({<span class="hljs-string"><span class="hljs-string">'name'</span></span>: <span class="hljs-string"><span class="hljs-string">'Den'</span></span>, <span class="hljs-string"><span class="hljs-string">'age'</span></span>: <span class="hljs-number"><span class="hljs-number">100</span></span>})) self.assertEqual(r.json, {<span class="hljs-string"><span class="hljs-string">'status'</span></span>: <span class="hljs-string"><span class="hljs-string">'OK'</span></span>}) self.assertEqual(r.status_code, <span class="hljs-number"><span class="hljs-number">200</span></span>) r = self.app.post(<span class="hljs-string"><span class="hljs-string">'/api'</span></span>, content_type=<span class="hljs-string"><span class="hljs-string">'application/json'</span></span>, data=json.dumps({<span class="hljs-string"><span class="hljs-string">'name'</span></span>: <span class="hljs-string"><span class="hljs-string">'Den'</span></span>})) self.assertEqual(r.json, {<span class="hljs-string"><span class="hljs-string">'status'</span></span>: <span class="hljs-string"><span class="hljs-string">'OK'</span></span>}) self.assertEqual(r.status_code, <span class="hljs-number"><span class="hljs-number">200</span></span>) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">test_not_dict_post_api_endpoint</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> r = self.app.post(<span class="hljs-string"><span class="hljs-string">'/api'</span></span>, content_type=<span class="hljs-string"><span class="hljs-string">'application/json'</span></span>, data=json.dumps([{<span class="hljs-string"><span class="hljs-string">'name'</span></span>: <span class="hljs-string"><span class="hljs-string">'Den'</span></span>}])) self.assertEqual(r.json, {<span class="hljs-string"><span class="hljs-string">'status'</span></span>: <span class="hljs-string"><span class="hljs-string">'bad input'</span></span>}) self.assertEqual(r.status_code, <span class="hljs-number"><span class="hljs-number">400</span></span>) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">test_no_name_post_api_endpoint</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> r = self.app.post(<span class="hljs-string"><span class="hljs-string">'/api'</span></span>, content_type=<span class="hljs-string"><span class="hljs-string">'application/json'</span></span>, data=json.dumps({<span class="hljs-string"><span class="hljs-string">'age'</span></span>: <span class="hljs-number"><span class="hljs-number">100</span></span>})) self.assertEqual(r.json, {<span class="hljs-string"><span class="hljs-string">'status'</span></span>: <span class="hljs-string"><span class="hljs-string">'bad input'</span></span>}) self.assertEqual(r.status_code, <span class="hljs-number"><span class="hljs-number">400</span></span>) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">test_bad_age_post_api_endpoint</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> r = self.app.post(<span class="hljs-string"><span class="hljs-string">'/api'</span></span>, content_type=<span class="hljs-string"><span class="hljs-string">'application/json'</span></span>, data=json.dumps({<span class="hljs-string"><span class="hljs-string">'name'</span></span>: <span class="hljs-string"><span class="hljs-string">'Den'</span></span>, <span class="hljs-string"><span class="hljs-string">'age'</span></span>: <span class="hljs-string"><span class="hljs-string">'100'</span></span>})) self.assertEqual(r.json, {<span class="hljs-string"><span class="hljs-string">'status'</span></span>: <span class="hljs-string"><span class="hljs-string">'bad input'</span></span>}) self.assertEqual(r.status_code, <span class="hljs-number"><span class="hljs-number">400</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> __name__ == <span class="hljs-string"><span class="hljs-string">'__main__'</span></span>: unittest.main()</code> : 'test'}) <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> unittest <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> app <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> tested_app <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> json <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">FlaskAppTests</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(unittest.TestCase)</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setUp</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> tested_app.app.config[<span class="hljs-string"><span class="hljs-string">'TESTING'</span></span>] = <span class="hljs-keyword"><span class="hljs-keyword">True</span></span> self.app = tested_app.app.test_client() <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">test_get_hello_endpoint</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> r = self.app.get(<span class="hljs-string"><span class="hljs-string">'/'</span></span>) self.assertEqual(r.data, <span class="hljs-string"><span class="hljs-string">b'Hello World!'</span></span>) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">test_post_hello_endpoint</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> r = self.app.post(<span class="hljs-string"><span class="hljs-string">'/'</span></span>) self.assertEqual(r.status_code, <span class="hljs-number"><span class="hljs-number">405</span></span>) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">test_get_api_endpoint</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> r = self.app.get(<span class="hljs-string"><span class="hljs-string">'/api'</span></span>) self.assertEqual(r.json, {<span class="hljs-string"><span class="hljs-string">'status'</span></span>: <span class="hljs-string"><span class="hljs-string">'test'</span></span>}) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">test_correct_post_api_endpoint</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> r = self.app.post(<span class="hljs-string"><span class="hljs-string">'/api'</span></span>, content_type=<span class="hljs-string"><span class="hljs-string">'application/json'</span></span>, data=json.dumps({<span class="hljs-string"><span class="hljs-string">'name'</span></span>: <span class="hljs-string"><span class="hljs-string">'Den'</span></span>, <span class="hljs-string"><span class="hljs-string">'age'</span></span>: <span class="hljs-number"><span class="hljs-number">100</span></span>})) self.assertEqual(r.json, {<span class="hljs-string"><span class="hljs-string">'status'</span></span>: <span class="hljs-string"><span class="hljs-string">'OK'</span></span>}) self.assertEqual(r.status_code, <span class="hljs-number"><span class="hljs-number">200</span></span>) r = self.app.post(<span class="hljs-string"><span class="hljs-string">'/api'</span></span>, content_type=<span class="hljs-string"><span class="hljs-string">'application/json'</span></span>, data=json.dumps({<span class="hljs-string"><span class="hljs-string">'name'</span></span>: <span class="hljs-string"><span class="hljs-string">'Den'</span></span>})) self.assertEqual(r.json, {<span class="hljs-string"><span class="hljs-string">'status'</span></span>: <span class="hljs-string"><span class="hljs-string">'OK'</span></span>}) self.assertEqual(r.status_code, <span class="hljs-number"><span class="hljs-number">200</span></span>) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">test_not_dict_post_api_endpoint</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> r = self.app.post(<span class="hljs-string"><span class="hljs-string">'/api'</span></span>, content_type=<span class="hljs-string"><span class="hljs-string">'application/json'</span></span>, data=json.dumps([{<span class="hljs-string"><span class="hljs-string">'name'</span></span>: <span class="hljs-string"><span class="hljs-string">'Den'</span></span>}])) self.assertEqual(r.json, {<span class="hljs-string"><span class="hljs-string">'status'</span></span>: <span class="hljs-string"><span class="hljs-string">'bad input'</span></span>}) self.assertEqual(r.status_code, <span class="hljs-number"><span class="hljs-number">400</span></span>) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">test_no_name_post_api_endpoint</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> r = self.app.post(<span class="hljs-string"><span class="hljs-string">'/api'</span></span>, content_type=<span class="hljs-string"><span class="hljs-string">'application/json'</span></span>, data=json.dumps({<span class="hljs-string"><span class="hljs-string">'age'</span></span>: <span class="hljs-number"><span class="hljs-number">100</span></span>})) self.assertEqual(r.json, {<span class="hljs-string"><span class="hljs-string">'status'</span></span>: <span class="hljs-string"><span class="hljs-string">'bad input'</span></span>}) self.assertEqual(r.status_code, <span class="hljs-number"><span class="hljs-number">400</span></span>) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">test_bad_age_post_api_endpoint</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> r = self.app.post(<span class="hljs-string"><span class="hljs-string">'/api'</span></span>, content_type=<span class="hljs-string"><span class="hljs-string">'application/json'</span></span>, data=json.dumps({<span class="hljs-string"><span class="hljs-string">'name'</span></span>: <span class="hljs-string"><span class="hljs-string">'Den'</span></span>, <span class="hljs-string"><span class="hljs-string">'age'</span></span>: <span class="hljs-string"><span class="hljs-string">'100'</span></span>})) self.assertEqual(r.json, {<span class="hljs-string"><span class="hljs-string">'status'</span></span>: <span class="hljs-string"><span class="hljs-string">'bad input'</span></span>}) self.assertEqual(r.status_code, <span class="hljs-number"><span class="hljs-number">400</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> __name__ == <span class="hljs-string"><span class="hljs-string">'__main__'</span></span>: unittest.main()</code> : 'entr√©e mauvaise'}) <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> unittest <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> app <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> tested_app <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> json <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">FlaskAppTests</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(unittest.TestCase)</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setUp</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> tested_app.app.config[<span class="hljs-string"><span class="hljs-string">'TESTING'</span></span>] = <span class="hljs-keyword"><span class="hljs-keyword">True</span></span> self.app = tested_app.app.test_client() <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">test_get_hello_endpoint</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> r = self.app.get(<span class="hljs-string"><span class="hljs-string">'/'</span></span>) self.assertEqual(r.data, <span class="hljs-string"><span class="hljs-string">b'Hello World!'</span></span>) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">test_post_hello_endpoint</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> r = self.app.post(<span class="hljs-string"><span class="hljs-string">'/'</span></span>) self.assertEqual(r.status_code, <span class="hljs-number"><span class="hljs-number">405</span></span>) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">test_get_api_endpoint</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> r = self.app.get(<span class="hljs-string"><span class="hljs-string">'/api'</span></span>) self.assertEqual(r.json, {<span class="hljs-string"><span class="hljs-string">'status'</span></span>: <span class="hljs-string"><span class="hljs-string">'test'</span></span>}) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">test_correct_post_api_endpoint</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> r = self.app.post(<span class="hljs-string"><span class="hljs-string">'/api'</span></span>, content_type=<span class="hljs-string"><span class="hljs-string">'application/json'</span></span>, data=json.dumps({<span class="hljs-string"><span class="hljs-string">'name'</span></span>: <span class="hljs-string"><span class="hljs-string">'Den'</span></span>, <span class="hljs-string"><span class="hljs-string">'age'</span></span>: <span class="hljs-number"><span class="hljs-number">100</span></span>})) self.assertEqual(r.json, {<span class="hljs-string"><span class="hljs-string">'status'</span></span>: <span class="hljs-string"><span class="hljs-string">'OK'</span></span>}) self.assertEqual(r.status_code, <span class="hljs-number"><span class="hljs-number">200</span></span>) r = self.app.post(<span class="hljs-string"><span class="hljs-string">'/api'</span></span>, content_type=<span class="hljs-string"><span class="hljs-string">'application/json'</span></span>, data=json.dumps({<span class="hljs-string"><span class="hljs-string">'name'</span></span>: <span class="hljs-string"><span class="hljs-string">'Den'</span></span>})) self.assertEqual(r.json, {<span class="hljs-string"><span class="hljs-string">'status'</span></span>: <span class="hljs-string"><span class="hljs-string">'OK'</span></span>}) self.assertEqual(r.status_code, <span class="hljs-number"><span class="hljs-number">200</span></span>) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">test_not_dict_post_api_endpoint</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> r = self.app.post(<span class="hljs-string"><span class="hljs-string">'/api'</span></span>, content_type=<span class="hljs-string"><span class="hljs-string">'application/json'</span></span>, data=json.dumps([{<span class="hljs-string"><span class="hljs-string">'name'</span></span>: <span class="hljs-string"><span class="hljs-string">'Den'</span></span>}])) self.assertEqual(r.json, {<span class="hljs-string"><span class="hljs-string">'status'</span></span>: <span class="hljs-string"><span class="hljs-string">'bad input'</span></span>}) self.assertEqual(r.status_code, <span class="hljs-number"><span class="hljs-number">400</span></span>) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">test_no_name_post_api_endpoint</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> r = self.app.post(<span class="hljs-string"><span class="hljs-string">'/api'</span></span>, content_type=<span class="hljs-string"><span class="hljs-string">'application/json'</span></span>, data=json.dumps({<span class="hljs-string"><span class="hljs-string">'age'</span></span>: <span class="hljs-number"><span class="hljs-number">100</span></span>})) self.assertEqual(r.json, {<span class="hljs-string"><span class="hljs-string">'status'</span></span>: <span class="hljs-string"><span class="hljs-string">'bad input'</span></span>}) self.assertEqual(r.status_code, <span class="hljs-number"><span class="hljs-number">400</span></span>) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">test_bad_age_post_api_endpoint</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> r = self.app.post(<span class="hljs-string"><span class="hljs-string">'/api'</span></span>, content_type=<span class="hljs-string"><span class="hljs-string">'application/json'</span></span>, data=json.dumps({<span class="hljs-string"><span class="hljs-string">'name'</span></span>: <span class="hljs-string"><span class="hljs-string">'Den'</span></span>, <span class="hljs-string"><span class="hljs-string">'age'</span></span>: <span class="hljs-string"><span class="hljs-string">'100'</span></span>})) self.assertEqual(r.json, {<span class="hljs-string"><span class="hljs-string">'status'</span></span>: <span class="hljs-string"><span class="hljs-string">'bad input'</span></span>}) self.assertEqual(r.status_code, <span class="hljs-number"><span class="hljs-number">400</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> __name__ == <span class="hljs-string"><span class="hljs-string">'__main__'</span></span>: unittest.main()</code> </pre> </div></div><br><p>  Sortie de couverture: </p><br><pre> <code class="plaintext hljs">coverage report Name Stmts Miss Cover ------------------------------------------------------------------ src/app.py 28 2 93% src/tests.py 37 0 100% ------------------------------------------------------------------ TOTAL 65 2 96%</code> </pre> <br><p>  Cr√©ez maintenant notre premi√®re action, qui ex√©cutera les tests.  Selon la documentation, toutes les actions doivent √™tre stock√©es dans un r√©pertoire sp√©cial: </p><br><pre> <code class="bash hljs">$ mkdir -p .github/workflows $ touch .github/workflows/test_on_push.yaml</code> </pre> <br><p>  Je veux que cette action s'ex√©cute sur n'importe quel √©v√©nement push dans n'importe quelle branche, √† l'exception des versions (balises, car il y aura des tests s√©par√©s): </p><br><pre> <code class="plaintext hljs">on: push: tags: - '!refs/tags/*' branches: - '*'</code> </pre> <br><p>  Ensuite, nous cr√©ons une t√¢che qui s'ex√©cutera dans la derni√®re version disponible d'Ubuntu: </p><br><pre> <code class="plaintext hljs">jobs: run_tests: runs-on: [ubuntu-latest]</code> </pre> <br><p>  Dans les √©tapes, nous allons v√©rifier le code, installer python, installer les d√©pendances, ex√©cuter les tests et afficher la couverture: </p><br><pre> <code class="plaintext hljs">steps: #   - uses: actions/checkout@master #  python   - uses: actions/setup-python@v1 with: python-version: '3.8' architecture: 'x64' - name: Install requirements #   run: pip install -r requirements.txt - name: Run tests run: coverage run src/tests.py - name: Tests report run: coverage report</code> en <code class="plaintext hljs">steps: #   - uses: actions/checkout@master #  python   - uses: actions/setup-python@v1 with: python-version: '3.8' architecture: 'x64' - name: Install requirements #   run: pip install -r requirements.txt - name: Run tests run: coverage run src/tests.py - name: Tests report run: coverage report</code> </pre> <br><div class="spoiler">  <b class="spoiler_title">Tous ensemble</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">name: Run tests on any Push event #    push    ,    . #      on: push: tags: - '!refs/tags/*' branches: - '*' jobs: run_tests: runs-on: [ubuntu-latest] steps: #   - uses: actions/checkout@master #  python   - uses: actions/setup-python@v1 with: python-version: '3.8' architecture: 'x64' - name: Install requirements #   run: pip install -r requirements.txt - name: Run tests run: coverage run src/tests.py - name: Tests report run: coverage report</code> </pre> </div></div><br><p>  Essayons de cr√©er un commit et voyons comment fonctionne notre action. <br><img src="https://habrastorage.org/webt/qy/v7/by/qyv7byybfnvpnkurriqvydsp_xk.png"><br>  <em>R√©ussite des tests dans l'interface Actions</em> </p><br><p>  Hourra, nous avons r√©ussi √† cr√©er la premi√®re action et √† l'ex√©cuter!  Essayons de casser une sorte de test et regardons la sortie: <br><img src="https://habrastorage.org/webt/dr/vn/_s/drvn_sgrq-esw6sgxjiylhhy02w.png"><br>  <em>Les tests se bloquent dans l'interface Actions</em> </p><br><p>  Les tests ont √©chou√©.  L'indicateur est devenu rouge et a m√™me re√ßu une notification par courrier.  Ce dont vous avez besoin!  3 points sur 8 du programme cible peuvent √™tre consid√©r√©s comme remplis.  Essayons maintenant de traiter l'assemblage, le stockage de nos images de docker. </p><br><p>  <strong>Remarque!</strong>  <strong>Ensuite, nous avons besoin d'un compte <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Docker</a></strong> </p><br><p>  Tout d'abord, nous allons √©crire un Dockerfile simple dans lequel notre application sera ex√©cut√©e. </p><br><div class="spoiler">  <b class="spoiler_title">Dockerfile</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">#     FROM python:3.8-alpine #        /app  COPY ./ /app #    RUN apk update &amp;&amp; pip install -r /app/requirements.txt --no-cache-dir #   (  Distutils) RUN pip install -e /app #      EXPOSE 8080 #       CMD web_server #    distutils      #CMD python /app/src/app.py</code> les <code class="plaintext hljs">#     FROM python:3.8-alpine #        /app  COPY ./ /app #    RUN apk update &amp;&amp; pip install -r /app/requirements.txt --no-cache-dir #   (  Distutils) RUN pip install -e /app #      EXPOSE 8080 #       CMD web_server #    distutils      #CMD python /app/src/app.py</code> r√©pertoire <code class="plaintext hljs">#     FROM python:3.8-alpine #        /app  COPY ./ /app #    RUN apk update &amp;&amp; pip install -r /app/requirements.txt --no-cache-dir #   (  Distutils) RUN pip install -e /app #      EXPOSE 8080 #       CMD web_server #    distutils      #CMD python /app/src/app.py</code> </pre> </div></div><br><p>  Pour envoyer un conteneur au hub, il sera n√©cessaire de se connecter au docker, mais comme je ne veux pas que le monde entier apprenne le mot de passe du compte, je vais utiliser les secrets int√©gr√©s √† GitHub.  En g√©n√©ral, seuls les mots de passe peuvent √™tre mis dans des secrets, et le reste sera cod√© en dur dans * .yaml, et cela fonctionnera.  Mais je voudrais copier-coller mes actions sans changements, et extraire toutes les informations sp√©cifiques des secrets. </p><br><p><img src="https://habrastorage.org/webt/2c/h8/5t/2ch85tdbuovsc7ywejh5gmrmvgw.png"><br>  <em>Github Secrets</em> </p><br><p>  DOCKER_LOGIN - connectez-vous sur hub.docker.com <br>  DOCKER_PWD - Mot de passe <br>  DOCKER_NAME - nom du r√©f√©rentiel docker pour ce projet (doit √™tre cr√©√© √† l'avance) </p><br><p>  D'accord, la pr√©paration est termin√©e, cr√©ons maintenant notre deuxi√®me action: </p><br><pre> <code class="bash hljs">$ touch .github/workflows/pub_on_release.yaml</code> </pre> <br><p>  Nous copions les tests de l'action pr√©c√©dente, √† l'exception du d√©clencheur de lancement (je n'ai pas trouv√© comment importer les actions).  Nous le rempla√ßons par ¬´Launch on release¬ª: </p><br><pre> <code class="plaintext hljs">on: release: types: [published]</code> </pre> <br><p>  <strong>IMPORTANT!</strong>  <strong>Il est tr√®s important de faire la bonne condition sur.</strong> <br>  Par exemple, si on.release ne sp√©cifie pas de types, cet √©v√©nement d√©clenche au moins 2 √©v√©nements: publi√© et cr√©√©.  Autrement dit, 2 processus d'assemblage seront lanc√©s imm√©diatement. </p><br><p>  Maintenant, dans le m√™me fichier, nous ferons une autre t√¢che en fonction du premier: </p><br><pre> <code class="plaintext hljs">build_and_pub: needs: [run_tests]</code> </pre> <br><p>  besoins - indique que cette t√¢che ne d√©marrera pas avant la fin de run_tests </p><br><p>  <strong>IMPORTANT!</strong>  <strong>Si vous avez plusieurs fichiers avec l'action, et dans quelques probl√®mes ils commencent tous en m√™me temps dans des environnements diff√©rents.</strong>  Un environnement distinct est cr√©√© pour chaque t√¢che, ind√©pendamment des autres t√¢ches.  si vous ne sp√©cifiez pas de besoins, la t√¢che de test et les assemblages seront lanc√©s simultan√©ment et ind√©pendamment les uns des autres. </p><br><p>  Ajoutez des variables d'environnement dans lesquelles nos secrets seront: </p><br><pre> <code class="plaintext hljs">env: LOGIN: ${{ secrets.DOCKER_LOGIN }} NAME: ${{ secrets.DOCKER_NAME }}</code> </pre> <br><p>  Maintenant, les √©tapes de notre t√¢che, en elles, nous devons nous connecter au docker, collecter le conteneur et le publier dans le registre: </p><br><pre> <code class="plaintext hljs">steps: - name: Login to docker.io run: echo ${{ secrets.DOCKER_PWD }} | docker login -u ${{ secrets.DOCKER_LOGIN }} --password-stdin - uses: actions/checkout@master - name: Build image run: docker build -t $LOGIN/$NAME:${GITHUB_REF:11} -f Dockerfile . - name: Push image to docker.io run: docker push $LOGIN/$NAME:${GITHUB_REF:11}</code> </pre> <br><p>  $ {GITHUB_REF: 11} est une variable github qui stocke une ligne avec une r√©f√©rence √† l'√©v√©nement pour lequel le d√©clencheur a fonctionn√© (nom de branche, balise, etc.), si nous avons des balises au format "v0.0.0" alors vous devez couper les 11 premiers caract√®res, "0.0.0" reste. </p><br><p>  Poussez le code et cr√©ez une nouvelle balise.  Et nous voyons que notre conteneur a √©t√© assembl√© avec succ√®s et envoy√© au registre, et nous n'avons allum√© notre mot de passe nulle part. </p><br><p><img src="https://habrastorage.org/webt/mg/yt/i-/mgyti-mww_fcqsmbiqk6zli7swo.png"><br>  <em>Cr√©er et exp√©dier un conteneur dans l'interface Actions</em> </p><br><p>  V√©rifiez le moyeu: </p><br><p><img src="https://habrastorage.org/webt/ut/nw/vd/utnwvdtcprbqfpavnnirqmqim0s.png"><br>  <em>Conteneur stock√© dans le docker hub</em> </p><br><p>  Tout fonctionne, mais la t√¢che la plus difficile reste - le d√©ploiement.  Ici, vous aurez d√©j√† besoin d'un VPS et d'une adresse IP blanche o√π nous d√©ploierons le conteneur et o√π vous pourrez envoyer le crochet.  En th√©orie, du c√¥t√© du VPS ou du serveur domestique, vous pouvez ex√©cuter un script sur la couronne, qui dans le cas d'une nouvelle image la d√©clencherait, ou jouer d'une mani√®re ou d'une autre avec le bot de t√©l√©gramme.  Il y a probablement plusieurs fa√ßons de proc√©der.  Mais je vais travailler avec une adresse IP externe.  Afin de ne pas √™tre intelligent, j'ai √©crit un petit service web dans Flask avec une API simple. <br>  En bref, il y a point final 1 ¬´ / ¬ª. <br>  Une demande GET renvoie json avec tous les conteneurs actifs sur l'h√¥te. <br>  POST - re√ßoit les donn√©es au format: </p><br><pre> <code class="json hljs">{ <span class="hljs-attr"><span class="hljs-attr">"owner"</span></span>: <span class="hljs-string"><span class="hljs-string">"  "</span></span>, <span class="hljs-attr"><span class="hljs-attr">"repository"</span></span>: <span class="hljs-string"><span class="hljs-string">"  "</span></span>, <span class="hljs-attr"><span class="hljs-attr">"tag"</span></span>: <span class="hljs-string"><span class="hljs-string">"v0.0.1"</span></span>, #    <span class="hljs-attr"><span class="hljs-attr">"ports"</span></span>: {<span class="hljs-attr"><span class="hljs-attr">"8080"</span></span>: <span class="hljs-number"><span class="hljs-number">8080</span></span>, ‚Äú443‚Äù: <span class="hljs-number"><span class="hljs-number">443</span></span>} #      }</code> </pre> <br><p>  Que se passe-t-il sur l'h√¥te: </p><br><ol><li>  du json re√ßu le nom de la nouvelle image est recueilli </li><li>  une nouvelle image est bomb√©e </li><li>  si l'image a √©t√© t√©l√©charg√©e, le conteneur actuel est arr√™t√© et supprim√© </li><li>  un nouveau conteneur est lanc√©, avec la publication des ports (drapeau -p) </li></ol><br><p>  Tout le travail avec docker se fait √† l'aide de la biblioth√®que <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">docker-py</a> </p><br><p>  Il serait tr√®s erron√© de publier un tel service sur Internet sans aucune protection minimale, et j'ai cr√©√© un semblant de cl√© API, le service lit le jeton √† partir des variables d'environnement, puis le compare avec l'en-t√™te {Autorisation: CI_TOKEN} </p><br><div class="spoiler">  <b class="spoiler_title">Liste des serveurs Web pour le d√©ploiement</b> <div class="spoiler_text"><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment"># coding=utf-8 import os import sys import logging import logging.config import logging.handlers from flask import Flask from flask import request, jsonify import docker log = logging.getLogger(__name__) app = Flask(__name__) docker_client = docker.from_env() MY_AUTH_TOKEN = os.getenv('CI_TOKEN', None) #       def init_logging(): """   :return: """ log_format = f"[%(asctime)s] [ CI/CD server ] [%(levelname)s]:%(name)s:%(message)s" formatters = {'basic': {'format': log_format}} handlers = {'stdout': {'class': 'logging.StreamHandler', 'formatter': 'basic'}} level = 'INFO' handlers_names = ['stdout'] loggers = { '': { 'level': level, 'propagate': False, 'handlers': handlers_names }, } logging.basicConfig(level='INFO', format=log_format) log_config = { 'version': 1, 'disable_existing_loggers': False, 'formatters': formatters, 'handlers': handlers, 'loggers': loggers } logging.config.dictConfig(log_config) def get_active_containers(): """     :return: """ containers = docker_client.containers.list() result = [] for container in containers: result.append({ 'short_id': container.short_id, 'container_name': container.name, 'image_name': container.image.tags, 'created': container.attrs['Created'], 'status': container.status, 'ports': container.ports, }) return result def get_container_name(item: dict) -&gt; [str, str]: """   image  POST  :param item: :return: """ if not isinstance(item, dict): return '' owner = item.get('owner') repository = item.get('repository') tag = item.get('tag', 'latest').replace('v', '') if owner and repository and tag: return f'{owner}/{repository}:{tag}', repository if repository and tag: return f'{repository}:{tag}', repository return '', '' def kill_old_container(container_name: str) -&gt; bool: """    ,   :param container_name: :return: """ try: #    container = docker_client.containers.get(container_name) #  container.kill() except Exception as e: #       log.warning(f'Error while delete container {container_name}, {e}') return False finally: #   ,     log.debug(docker_client.containers.prune()) log.info(f'Container deleted. container_name = {container_name}') return True def deploy_new_container(image_name: str, container_name: str, ports: dict = None): try: #   image  docker hub'a log.info(f'pull {image_name}, name={container_name}') docker_client.images.pull(image_name) log.debug('Success') kill_old_container(container_name) log.debug('Old killed') #    docker_client.containers.run(image=image_name, name=container_name, detach=True, ports=ports) except Exception as e: log.error(f'Error while deploy container {container_name}, \n{e}') return {'status': False, 'error': str(e)}, 400 log.info(f'Container deployed. container_name = {container_name}') return {'status': True}, 200 @app.route('/', methods=['GET', 'POST']) def MainHandler(): """ GET -      POST -      : { "owner": "gonfff", "repository": "ci_example", "tag": "v0.0.1", "ports": {"8080": 8080} } :return: """ if request.headers.get('Authorization') != MY_AUTH_TOKEN: return jsonify({'message': 'Bad token'}), 401 if request.method == 'GET': return jsonify(get_active_containers()) elif request.method == 'POST': log.debug(f'Recieved {request.data}') image_name, container_name = get_container_name(request.json) ports = request.json.get('ports') if request.json.get('ports') else None result, status = deploy_new_container(image_name, container_name, ports) return jsonify(result), status def main(): init_logging() if not MY_AUTH_TOKEN: log.error('There is no auth token in env') sys.exit(1) app.run(host='0.0.0.0', port=5000) if __name__ == '__main__': main()</span></span></code> 'class': 'logging.StreamHandler', <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment"># coding=utf-8 import os import sys import logging import logging.config import logging.handlers from flask import Flask from flask import request, jsonify import docker log = logging.getLogger(__name__) app = Flask(__name__) docker_client = docker.from_env() MY_AUTH_TOKEN = os.getenv('CI_TOKEN', None) #       def init_logging(): """   :return: """ log_format = f"[%(asctime)s] [ CI/CD server ] [%(levelname)s]:%(name)s:%(message)s" formatters = {'basic': {'format': log_format}} handlers = {'stdout': {'class': 'logging.StreamHandler', 'formatter': 'basic'}} level = 'INFO' handlers_names = ['stdout'] loggers = { '': { 'level': level, 'propagate': False, 'handlers': handlers_names }, } logging.basicConfig(level='INFO', format=log_format) log_config = { 'version': 1, 'disable_existing_loggers': False, 'formatters': formatters, 'handlers': handlers, 'loggers': loggers } logging.config.dictConfig(log_config) def get_active_containers(): """     :return: """ containers = docker_client.containers.list() result = [] for container in containers: result.append({ 'short_id': container.short_id, 'container_name': container.name, 'image_name': container.image.tags, 'created': container.attrs['Created'], 'status': container.status, 'ports': container.ports, }) return result def get_container_name(item: dict) -&gt; [str, str]: """   image  POST  :param item: :return: """ if not isinstance(item, dict): return '' owner = item.get('owner') repository = item.get('repository') tag = item.get('tag', 'latest').replace('v', '') if owner and repository and tag: return f'{owner}/{repository}:{tag}', repository if repository and tag: return f'{repository}:{tag}', repository return '', '' def kill_old_container(container_name: str) -&gt; bool: """    ,   :param container_name: :return: """ try: #    container = docker_client.containers.get(container_name) #  container.kill() except Exception as e: #       log.warning(f'Error while delete container {container_name}, {e}') return False finally: #   ,     log.debug(docker_client.containers.prune()) log.info(f'Container deleted. container_name = {container_name}') return True def deploy_new_container(image_name: str, container_name: str, ports: dict = None): try: #   image  docker hub'a log.info(f'pull {image_name}, name={container_name}') docker_client.images.pull(image_name) log.debug('Success') kill_old_container(container_name) log.debug('Old killed') #    docker_client.containers.run(image=image_name, name=container_name, detach=True, ports=ports) except Exception as e: log.error(f'Error while deploy container {container_name}, \n{e}') return {'status': False, 'error': str(e)}, 400 log.info(f'Container deployed. container_name = {container_name}') return {'status': True}, 200 @app.route('/', methods=['GET', 'POST']) def MainHandler(): """ GET -      POST -      : { "owner": "gonfff", "repository": "ci_example", "tag": "v0.0.1", "ports": {"8080": 8080} } :return: """ if request.headers.get('Authorization') != MY_AUTH_TOKEN: return jsonify({'message': 'Bad token'}), 401 if request.method == 'GET': return jsonify(get_active_containers()) elif request.method == 'POST': log.debug(f'Recieved {request.data}') image_name, container_name = get_container_name(request.json) ports = request.json.get('ports') if request.json.get('ports') else None result, status = deploy_new_container(image_name, container_name, ports) return jsonify(result), status def main(): init_logging() if not MY_AUTH_TOKEN: log.error('There is no auth token in env') sys.exit(1) app.run(host='0.0.0.0', port=5000) if __name__ == '__main__': main()</span></span></code> la <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment"># coding=utf-8 import os import sys import logging import logging.config import logging.handlers from flask import Flask from flask import request, jsonify import docker log = logging.getLogger(__name__) app = Flask(__name__) docker_client = docker.from_env() MY_AUTH_TOKEN = os.getenv('CI_TOKEN', None) #       def init_logging(): """   :return: """ log_format = f"[%(asctime)s] [ CI/CD server ] [%(levelname)s]:%(name)s:%(message)s" formatters = {'basic': {'format': log_format}} handlers = {'stdout': {'class': 'logging.StreamHandler', 'formatter': 'basic'}} level = 'INFO' handlers_names = ['stdout'] loggers = { '': { 'level': level, 'propagate': False, 'handlers': handlers_names }, } logging.basicConfig(level='INFO', format=log_format) log_config = { 'version': 1, 'disable_existing_loggers': False, 'formatters': formatters, 'handlers': handlers, 'loggers': loggers } logging.config.dictConfig(log_config) def get_active_containers(): """     :return: """ containers = docker_client.containers.list() result = [] for container in containers: result.append({ 'short_id': container.short_id, 'container_name': container.name, 'image_name': container.image.tags, 'created': container.attrs['Created'], 'status': container.status, 'ports': container.ports, }) return result def get_container_name(item: dict) -&gt; [str, str]: """   image  POST  :param item: :return: """ if not isinstance(item, dict): return '' owner = item.get('owner') repository = item.get('repository') tag = item.get('tag', 'latest').replace('v', '') if owner and repository and tag: return f'{owner}/{repository}:{tag}', repository if repository and tag: return f'{repository}:{tag}', repository return '', '' def kill_old_container(container_name: str) -&gt; bool: """    ,   :param container_name: :return: """ try: #    container = docker_client.containers.get(container_name) #  container.kill() except Exception as e: #       log.warning(f'Error while delete container {container_name}, {e}') return False finally: #   ,     log.debug(docker_client.containers.prune()) log.info(f'Container deleted. container_name = {container_name}') return True def deploy_new_container(image_name: str, container_name: str, ports: dict = None): try: #   image  docker hub'a log.info(f'pull {image_name}, name={container_name}') docker_client.images.pull(image_name) log.debug('Success') kill_old_container(container_name) log.debug('Old killed') #    docker_client.containers.run(image=image_name, name=container_name, detach=True, ports=ports) except Exception as e: log.error(f'Error while deploy container {container_name}, \n{e}') return {'status': False, 'error': str(e)}, 400 log.info(f'Container deployed. container_name = {container_name}') return {'status': True}, 200 @app.route('/', methods=['GET', 'POST']) def MainHandler(): """ GET -      POST -      : { "owner": "gonfff", "repository": "ci_example", "tag": "v0.0.1", "ports": {"8080": 8080} } :return: """ if request.headers.get('Authorization') != MY_AUTH_TOKEN: return jsonify({'message': 'Bad token'}), 401 if request.method == 'GET': return jsonify(get_active_containers()) elif request.method == 'POST': log.debug(f'Recieved {request.data}') image_name, container_name = get_container_name(request.json) ports = request.json.get('ports') if request.json.get('ports') else None result, status = deploy_new_container(image_name, container_name, ports) return jsonify(result), status def main(): init_logging() if not MY_AUTH_TOKEN: log.error('There is no auth token in env') sys.exit(1) app.run(host='0.0.0.0', port=5000) if __name__ == '__main__': main()</span></span></code> en <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment"># coding=utf-8 import os import sys import logging import logging.config import logging.handlers from flask import Flask from flask import request, jsonify import docker log = logging.getLogger(__name__) app = Flask(__name__) docker_client = docker.from_env() MY_AUTH_TOKEN = os.getenv('CI_TOKEN', None) #       def init_logging(): """   :return: """ log_format = f"[%(asctime)s] [ CI/CD server ] [%(levelname)s]:%(name)s:%(message)s" formatters = {'basic': {'format': log_format}} handlers = {'stdout': {'class': 'logging.StreamHandler', 'formatter': 'basic'}} level = 'INFO' handlers_names = ['stdout'] loggers = { '': { 'level': level, 'propagate': False, 'handlers': handlers_names }, } logging.basicConfig(level='INFO', format=log_format) log_config = { 'version': 1, 'disable_existing_loggers': False, 'formatters': formatters, 'handlers': handlers, 'loggers': loggers } logging.config.dictConfig(log_config) def get_active_containers(): """     :return: """ containers = docker_client.containers.list() result = [] for container in containers: result.append({ 'short_id': container.short_id, 'container_name': container.name, 'image_name': container.image.tags, 'created': container.attrs['Created'], 'status': container.status, 'ports': container.ports, }) return result def get_container_name(item: dict) -&gt; [str, str]: """   image  POST  :param item: :return: """ if not isinstance(item, dict): return '' owner = item.get('owner') repository = item.get('repository') tag = item.get('tag', 'latest').replace('v', '') if owner and repository and tag: return f'{owner}/{repository}:{tag}', repository if repository and tag: return f'{repository}:{tag}', repository return '', '' def kill_old_container(container_name: str) -&gt; bool: """    ,   :param container_name: :return: """ try: #    container = docker_client.containers.get(container_name) #  container.kill() except Exception as e: #       log.warning(f'Error while delete container {container_name}, {e}') return False finally: #   ,     log.debug(docker_client.containers.prune()) log.info(f'Container deleted. container_name = {container_name}') return True def deploy_new_container(image_name: str, container_name: str, ports: dict = None): try: #   image  docker hub'a log.info(f'pull {image_name}, name={container_name}') docker_client.images.pull(image_name) log.debug('Success') kill_old_container(container_name) log.debug('Old killed') #    docker_client.containers.run(image=image_name, name=container_name, detach=True, ports=ports) except Exception as e: log.error(f'Error while deploy container {container_name}, \n{e}') return {'status': False, 'error': str(e)}, 400 log.info(f'Container deployed. container_name = {container_name}') return {'status': True}, 200 @app.route('/', methods=['GET', 'POST']) def MainHandler(): """ GET -      POST -      : { "owner": "gonfff", "repository": "ci_example", "tag": "v0.0.1", "ports": {"8080": 8080} } :return: """ if request.headers.get('Authorization') != MY_AUTH_TOKEN: return jsonify({'message': 'Bad token'}), 401 if request.method == 'GET': return jsonify(get_active_containers()) elif request.method == 'POST': log.debug(f'Recieved {request.data}') image_name, container_name = get_container_name(request.json) ports = request.json.get('ports') if request.json.get('ports') else None result, status = deploy_new_container(image_name, container_name, ports) return jsonify(result), status def main(): init_logging() if not MY_AUTH_TOKEN: log.error('There is no auth token in env') sys.exit(1) app.run(host='0.0.0.0', port=5000) if __name__ == '__main__': main()</span></span></code> d' <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment"># coding=utf-8 import os import sys import logging import logging.config import logging.handlers from flask import Flask from flask import request, jsonify import docker log = logging.getLogger(__name__) app = Flask(__name__) docker_client = docker.from_env() MY_AUTH_TOKEN = os.getenv('CI_TOKEN', None) #       def init_logging(): """   :return: """ log_format = f"[%(asctime)s] [ CI/CD server ] [%(levelname)s]:%(name)s:%(message)s" formatters = {'basic': {'format': log_format}} handlers = {'stdout': {'class': 'logging.StreamHandler', 'formatter': 'basic'}} level = 'INFO' handlers_names = ['stdout'] loggers = { '': { 'level': level, 'propagate': False, 'handlers': handlers_names }, } logging.basicConfig(level='INFO', format=log_format) log_config = { 'version': 1, 'disable_existing_loggers': False, 'formatters': formatters, 'handlers': handlers, 'loggers': loggers } logging.config.dictConfig(log_config) def get_active_containers(): """     :return: """ containers = docker_client.containers.list() result = [] for container in containers: result.append({ 'short_id': container.short_id, 'container_name': container.name, 'image_name': container.image.tags, 'created': container.attrs['Created'], 'status': container.status, 'ports': container.ports, }) return result def get_container_name(item: dict) -&gt; [str, str]: """   image  POST  :param item: :return: """ if not isinstance(item, dict): return '' owner = item.get('owner') repository = item.get('repository') tag = item.get('tag', 'latest').replace('v', '') if owner and repository and tag: return f'{owner}/{repository}:{tag}', repository if repository and tag: return f'{repository}:{tag}', repository return '', '' def kill_old_container(container_name: str) -&gt; bool: """    ,   :param container_name: :return: """ try: #    container = docker_client.containers.get(container_name) #  container.kill() except Exception as e: #       log.warning(f'Error while delete container {container_name}, {e}') return False finally: #   ,     log.debug(docker_client.containers.prune()) log.info(f'Container deleted. container_name = {container_name}') return True def deploy_new_container(image_name: str, container_name: str, ports: dict = None): try: #   image  docker hub'a log.info(f'pull {image_name}, name={container_name}') docker_client.images.pull(image_name) log.debug('Success') kill_old_container(container_name) log.debug('Old killed') #    docker_client.containers.run(image=image_name, name=container_name, detach=True, ports=ports) except Exception as e: log.error(f'Error while deploy container {container_name}, \n{e}') return {'status': False, 'error': str(e)}, 400 log.info(f'Container deployed. container_name = {container_name}') return {'status': True}, 200 @app.route('/', methods=['GET', 'POST']) def MainHandler(): """ GET -      POST -      : { "owner": "gonfff", "repository": "ci_example", "tag": "v0.0.1", "ports": {"8080": 8080} } :return: """ if request.headers.get('Authorization') != MY_AUTH_TOKEN: return jsonify({'message': 'Bad token'}), 401 if request.method == 'GET': return jsonify(get_active_containers()) elif request.method == 'POST': log.debug(f'Recieved {request.data}') image_name, container_name = get_container_name(request.json) ports = request.json.get('ports') if request.json.get('ports') else None result, status = deploy_new_container(image_name, container_name, ports) return jsonify(result), status def main(): init_logging() if not MY_AUTH_TOKEN: log.error('There is no auth token in env') sys.exit(1) app.run(host='0.0.0.0', port=5000) if __name__ == '__main__': main()</span></span></code> container_name} ¬´ ) <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment"># coding=utf-8 import os import sys import logging import logging.config import logging.handlers from flask import Flask from flask import request, jsonify import docker log = logging.getLogger(__name__) app = Flask(__name__) docker_client = docker.from_env() MY_AUTH_TOKEN = os.getenv('CI_TOKEN', None) #       def init_logging(): """   :return: """ log_format = f"[%(asctime)s] [ CI/CD server ] [%(levelname)s]:%(name)s:%(message)s" formatters = {'basic': {'format': log_format}} handlers = {'stdout': {'class': 'logging.StreamHandler', 'formatter': 'basic'}} level = 'INFO' handlers_names = ['stdout'] loggers = { '': { 'level': level, 'propagate': False, 'handlers': handlers_names }, } logging.basicConfig(level='INFO', format=log_format) log_config = { 'version': 1, 'disable_existing_loggers': False, 'formatters': formatters, 'handlers': handlers, 'loggers': loggers } logging.config.dictConfig(log_config) def get_active_containers(): """     :return: """ containers = docker_client.containers.list() result = [] for container in containers: result.append({ 'short_id': container.short_id, 'container_name': container.name, 'image_name': container.image.tags, 'created': container.attrs['Created'], 'status': container.status, 'ports': container.ports, }) return result def get_container_name(item: dict) -&gt; [str, str]: """   image  POST  :param item: :return: """ if not isinstance(item, dict): return '' owner = item.get('owner') repository = item.get('repository') tag = item.get('tag', 'latest').replace('v', '') if owner and repository and tag: return f'{owner}/{repository}:{tag}', repository if repository and tag: return f'{repository}:{tag}', repository return '', '' def kill_old_container(container_name: str) -&gt; bool: """    ,   :param container_name: :return: """ try: #    container = docker_client.containers.get(container_name) #  container.kill() except Exception as e: #       log.warning(f'Error while delete container {container_name}, {e}') return False finally: #   ,     log.debug(docker_client.containers.prune()) log.info(f'Container deleted. container_name = {container_name}') return True def deploy_new_container(image_name: str, container_name: str, ports: dict = None): try: #   image  docker hub'a log.info(f'pull {image_name}, name={container_name}') docker_client.images.pull(image_name) log.debug('Success') kill_old_container(container_name) log.debug('Old killed') #    docker_client.containers.run(image=image_name, name=container_name, detach=True, ports=ports) except Exception as e: log.error(f'Error while deploy container {container_name}, \n{e}') return {'status': False, 'error': str(e)}, 400 log.info(f'Container deployed. container_name = {container_name}') return {'status': True}, 200 @app.route('/', methods=['GET', 'POST']) def MainHandler(): """ GET -      POST -      : { "owner": "gonfff", "repository": "ci_example", "tag": "v0.0.1", "ports": {"8080": 8080} } :return: """ if request.headers.get('Authorization') != MY_AUTH_TOKEN: return jsonify({'message': 'Bad token'}), 401 if request.method == 'GET': return jsonify(get_active_containers()) elif request.method == 'POST': log.debug(f'Recieved {request.data}') image_name, container_name = get_container_name(request.json) ports = request.json.get('ports') if request.json.get('ports') else None result, status = deploy_new_container(image_name, container_name, ports) return jsonify(result), status def main(): init_logging() if not MY_AUTH_TOKEN: log.error('There is no auth token in env') sys.exit(1) app.run(host='0.0.0.0', port=5000) if __name__ == '__main__': main()</span></span></code> la <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment"># coding=utf-8 import os import sys import logging import logging.config import logging.handlers from flask import Flask from flask import request, jsonify import docker log = logging.getLogger(__name__) app = Flask(__name__) docker_client = docker.from_env() MY_AUTH_TOKEN = os.getenv('CI_TOKEN', None) #       def init_logging(): """   :return: """ log_format = f"[%(asctime)s] [ CI/CD server ] [%(levelname)s]:%(name)s:%(message)s" formatters = {'basic': {'format': log_format}} handlers = {'stdout': {'class': 'logging.StreamHandler', 'formatter': 'basic'}} level = 'INFO' handlers_names = ['stdout'] loggers = { '': { 'level': level, 'propagate': False, 'handlers': handlers_names }, } logging.basicConfig(level='INFO', format=log_format) log_config = { 'version': 1, 'disable_existing_loggers': False, 'formatters': formatters, 'handlers': handlers, 'loggers': loggers } logging.config.dictConfig(log_config) def get_active_containers(): """     :return: """ containers = docker_client.containers.list() result = [] for container in containers: result.append({ 'short_id': container.short_id, 'container_name': container.name, 'image_name': container.image.tags, 'created': container.attrs['Created'], 'status': container.status, 'ports': container.ports, }) return result def get_container_name(item: dict) -&gt; [str, str]: """   image  POST  :param item: :return: """ if not isinstance(item, dict): return '' owner = item.get('owner') repository = item.get('repository') tag = item.get('tag', 'latest').replace('v', '') if owner and repository and tag: return f'{owner}/{repository}:{tag}', repository if repository and tag: return f'{repository}:{tag}', repository return '', '' def kill_old_container(container_name: str) -&gt; bool: """    ,   :param container_name: :return: """ try: #    container = docker_client.containers.get(container_name) #  container.kill() except Exception as e: #       log.warning(f'Error while delete container {container_name}, {e}') return False finally: #   ,     log.debug(docker_client.containers.prune()) log.info(f'Container deleted. container_name = {container_name}') return True def deploy_new_container(image_name: str, container_name: str, ports: dict = None): try: #   image  docker hub'a log.info(f'pull {image_name}, name={container_name}') docker_client.images.pull(image_name) log.debug('Success') kill_old_container(container_name) log.debug('Old killed') #    docker_client.containers.run(image=image_name, name=container_name, detach=True, ports=ports) except Exception as e: log.error(f'Error while deploy container {container_name}, \n{e}') return {'status': False, 'error': str(e)}, 400 log.info(f'Container deployed. container_name = {container_name}') return {'status': True}, 200 @app.route('/', methods=['GET', 'POST']) def MainHandler(): """ GET -      POST -      : { "owner": "gonfff", "repository": "ci_example", "tag": "v0.0.1", "ports": {"8080": 8080} } :return: """ if request.headers.get('Authorization') != MY_AUTH_TOKEN: return jsonify({'message': 'Bad token'}), 401 if request.method == 'GET': return jsonify(get_active_containers()) elif request.method == 'POST': log.debug(f'Recieved {request.data}') image_name, container_name = get_container_name(request.json) ports = request.json.get('ports') if request.json.get('ports') else None result, status = deploy_new_container(image_name, container_name, ports) return jsonify(result), status def main(): init_logging() if not MY_AUTH_TOKEN: log.error('There is no auth token in env') sys.exit(1) app.run(host='0.0.0.0', port=5000) if __name__ == '__main__': main()</span></span></code> de <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment"># coding=utf-8 import os import sys import logging import logging.config import logging.handlers from flask import Flask from flask import request, jsonify import docker log = logging.getLogger(__name__) app = Flask(__name__) docker_client = docker.from_env() MY_AUTH_TOKEN = os.getenv('CI_TOKEN', None) #       def init_logging(): """   :return: """ log_format = f"[%(asctime)s] [ CI/CD server ] [%(levelname)s]:%(name)s:%(message)s" formatters = {'basic': {'format': log_format}} handlers = {'stdout': {'class': 'logging.StreamHandler', 'formatter': 'basic'}} level = 'INFO' handlers_names = ['stdout'] loggers = { '': { 'level': level, 'propagate': False, 'handlers': handlers_names }, } logging.basicConfig(level='INFO', format=log_format) log_config = { 'version': 1, 'disable_existing_loggers': False, 'formatters': formatters, 'handlers': handlers, 'loggers': loggers } logging.config.dictConfig(log_config) def get_active_containers(): """     :return: """ containers = docker_client.containers.list() result = [] for container in containers: result.append({ 'short_id': container.short_id, 'container_name': container.name, 'image_name': container.image.tags, 'created': container.attrs['Created'], 'status': container.status, 'ports': container.ports, }) return result def get_container_name(item: dict) -&gt; [str, str]: """   image  POST  :param item: :return: """ if not isinstance(item, dict): return '' owner = item.get('owner') repository = item.get('repository') tag = item.get('tag', 'latest').replace('v', '') if owner and repository and tag: return f'{owner}/{repository}:{tag}', repository if repository and tag: return f'{repository}:{tag}', repository return '', '' def kill_old_container(container_name: str) -&gt; bool: """    ,   :param container_name: :return: """ try: #    container = docker_client.containers.get(container_name) #  container.kill() except Exception as e: #       log.warning(f'Error while delete container {container_name}, {e}') return False finally: #   ,     log.debug(docker_client.containers.prune()) log.info(f'Container deleted. container_name = {container_name}') return True def deploy_new_container(image_name: str, container_name: str, ports: dict = None): try: #   image  docker hub'a log.info(f'pull {image_name}, name={container_name}') docker_client.images.pull(image_name) log.debug('Success') kill_old_container(container_name) log.debug('Old killed') #    docker_client.containers.run(image=image_name, name=container_name, detach=True, ports=ports) except Exception as e: log.error(f'Error while deploy container {container_name}, \n{e}') return {'status': False, 'error': str(e)}, 400 log.info(f'Container deployed. container_name = {container_name}') return {'status': True}, 200 @app.route('/', methods=['GET', 'POST']) def MainHandler(): """ GET -      POST -      : { "owner": "gonfff", "repository": "ci_example", "tag": "v0.0.1", "ports": {"8080": 8080} } :return: """ if request.headers.get('Authorization') != MY_AUTH_TOKEN: return jsonify({'message': 'Bad token'}), 401 if request.method == 'GET': return jsonify(get_active_containers()) elif request.method == 'POST': log.debug(f'Recieved {request.data}') image_name, container_name = get_container_name(request.json) ports = request.json.get('ports') if request.json.get('ports') else None result, status = deploy_new_container(image_name, container_name, ports) return jsonify(result), status def main(): init_logging() if not MY_AUTH_TOKEN: log.error('There is no auth token in env') sys.exit(1) app.run(host='0.0.0.0', port=5000) if __name__ == '__main__': main()</span></span></code> dans env ¬ª) <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment"># coding=utf-8 import os import sys import logging import logging.config import logging.handlers from flask import Flask from flask import request, jsonify import docker log = logging.getLogger(__name__) app = Flask(__name__) docker_client = docker.from_env() MY_AUTH_TOKEN = os.getenv('CI_TOKEN', None) #       def init_logging(): """   :return: """ log_format = f"[%(asctime)s] [ CI/CD server ] [%(levelname)s]:%(name)s:%(message)s" formatters = {'basic': {'format': log_format}} handlers = {'stdout': {'class': 'logging.StreamHandler', 'formatter': 'basic'}} level = 'INFO' handlers_names = ['stdout'] loggers = { '': { 'level': level, 'propagate': False, 'handlers': handlers_names }, } logging.basicConfig(level='INFO', format=log_format) log_config = { 'version': 1, 'disable_existing_loggers': False, 'formatters': formatters, 'handlers': handlers, 'loggers': loggers } logging.config.dictConfig(log_config) def get_active_containers(): """     :return: """ containers = docker_client.containers.list() result = [] for container in containers: result.append({ 'short_id': container.short_id, 'container_name': container.name, 'image_name': container.image.tags, 'created': container.attrs['Created'], 'status': container.status, 'ports': container.ports, }) return result def get_container_name(item: dict) -&gt; [str, str]: """   image  POST  :param item: :return: """ if not isinstance(item, dict): return '' owner = item.get('owner') repository = item.get('repository') tag = item.get('tag', 'latest').replace('v', '') if owner and repository and tag: return f'{owner}/{repository}:{tag}', repository if repository and tag: return f'{repository}:{tag}', repository return '', '' def kill_old_container(container_name: str) -&gt; bool: """    ,   :param container_name: :return: """ try: #    container = docker_client.containers.get(container_name) #  container.kill() except Exception as e: #       log.warning(f'Error while delete container {container_name}, {e}') return False finally: #   ,     log.debug(docker_client.containers.prune()) log.info(f'Container deleted. container_name = {container_name}') return True def deploy_new_container(image_name: str, container_name: str, ports: dict = None): try: #   image  docker hub'a log.info(f'pull {image_name}, name={container_name}') docker_client.images.pull(image_name) log.debug('Success') kill_old_container(container_name) log.debug('Old killed') #    docker_client.containers.run(image=image_name, name=container_name, detach=True, ports=ports) except Exception as e: log.error(f'Error while deploy container {container_name}, \n{e}') return {'status': False, 'error': str(e)}, 400 log.info(f'Container deployed. container_name = {container_name}') return {'status': True}, 200 @app.route('/', methods=['GET', 'POST']) def MainHandler(): """ GET -      POST -      : { "owner": "gonfff", "repository": "ci_example", "tag": "v0.0.1", "ports": {"8080": 8080} } :return: """ if request.headers.get('Authorization') != MY_AUTH_TOKEN: return jsonify({'message': 'Bad token'}), 401 if request.method == 'GET': return jsonify(get_active_containers()) elif request.method == 'POST': log.debug(f'Recieved {request.data}') image_name, container_name = get_container_name(request.json) ports = request.json.get('ports') if request.json.get('ports') else None result, status = deploy_new_container(image_name, container_name, ports) return jsonify(result), status def main(): init_logging() if not MY_AUTH_TOKEN: log.error('There is no auth token in env') sys.exit(1) app.run(host='0.0.0.0', port=5000) if __name__ == '__main__': main()</span></span></code> </pre> </div></div><br><p>  Pour cette application, j'ai √©galement fait setup.py pour l'installer sur le syst√®me.  Vous pouvez l'installer en utilisant: </p><br><pre> <code class="bash hljs">$ python3 setup.sy install</code> </pre> <br><p>  √† condition que vous ayez t√©l√©charg√© les fichiers et que vous soyez dans le r√©pertoire de cette application. <br>  Apr√®s l'installation, vous devez activer l'application en tant que service afin qu'elle d√©marre d'elle-m√™me en cas de red√©marrage du serveur, pour cela nous utilisons <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">systemd</a> <br>  Voici un exemple de fichier de configuration: </p><br><pre> <code class="plaintext hljs">[Unit] Description=Deployment web server After=network-online.target [Service] Type=simple RestartSec=3 ExecStart=/usr/local/bin/ci_example Environment=CI_TOKEN=#&lt;I generate it with $(openssl rand -hex 20)&gt; [Install] WantedBy=multi-user.target</code> </pre><br><p>  Il ne reste plus qu'√† l'ex√©cuter: </p><br><pre> <code class="bash hljs">$ sudo systemctl daemon-reload $ sudo systemctl <span class="hljs-built_in"><span class="hljs-built_in">enable</span></span> ci_example.service $ sudo systemctl start ci_example.service</code> </pre> <br><p>  Vous pouvez afficher le journal du serveur de diffusion Web √† l'aide de </p><br><pre> <code class="bash hljs">$ sudo systemctl status ci_example.service</code> </pre> <br><p>  La partie serveur est pr√™te, il ne reste plus qu'√† ajouter un hook √† notre action.  Pour ce faire, ajoutez les secrets de l'adresse IP de notre serveur et du CI_TOKEN que nous avons g√©n√©r√© lors de l'installation de l'application. <br>  Au d√©but, je voulais utiliser une action pr√™te √† l'emploi pour curl sur le march√© github, mais malheureusement, cela supprime les citations du corps de la demande POST, ce qui a rendu impossible l'analyse de json.  Cela ne me convenait √©videmment pas, et j'ai d√©cid√© d'utiliser la boucle int√©gr√©e dans ubuntu (sur laquelle je collecte des conteneurs), ce qui a d'ailleurs eu un effet positif sur les performances, car elle ne n√©cessite pas l'assemblage d'un conteneur suppl√©mentaire: </p><br><pre> <code class="plaintext hljs">deploy: needs: [build_and_pub] runs-on: [ubuntu-latest] steps: - name: Set tag to env run: echo ::set-env name=TAG::$(echo ${GITHUB_REF:11}) - name: Send webhook for deploy run: "curl --silent --show-error --fail -X POST ${{ secrets.DEPLOYMENT_SERVER }} -H 'Authorization: ${{ secrets.DEPLOYMENT_TOKEN }}' -H 'Content-Type: application/json' -d '{\"owner\": \"${{ secrets.DOCKER_LOGIN }}\", \"repository\": \"${{ secrets.DOCKER_NAME }}\", \"tag\": \"${{ env.TAG }}\", \"ports\": {\"8080\": 8080}}'"</code> = TAG :: $ (echo $ {GITHUB_REF: <code class="plaintext hljs">deploy: needs: [build_and_pub] runs-on: [ubuntu-latest] steps: - name: Set tag to env run: echo ::set-env name=TAG::$(echo ${GITHUB_REF:11}) - name: Send webhook for deploy run: "curl --silent --show-error --fail -X POST ${{ secrets.DEPLOYMENT_SERVER }} -H 'Authorization: ${{ secrets.DEPLOYMENT_TOKEN }}' -H 'Content-Type: application/json' -d '{\"owner\": \"${{ secrets.DOCKER_LOGIN }}\", \"repository\": \"${{ secrets.DOCKER_NAME }}\", \"tag\": \"${{ env.TAG }}\", \"ports\": {\"8080\": 8080}}'"</code> </pre><br><p>  <strong>Remarque: il est tr√®s important de sp√©cifier le commutateur --fail, sinon toute demande r√©ussira, m√™me si une erreur a √©t√© re√ßue en r√©ponse.</strong> <br>  Il convient √©galement de noter que les variables utilis√©es dans la demande ne sont pas vraiment des variables, mais des fonctions sp√©ciales appel√©es √† l'exception de GITHUB_REF, c'est pourquoi pendant longtemps je n'ai pas pu comprendre pourquoi la demande ne fonctionnait pas correctement.  Mais apr√®s en avoir fait une fonction, tout a fonctionn√©. </p><br><div class="spoiler">  <b class="spoiler_title">Action construit et d√©ploie</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">name: Publish on Docker Hub and Deploy on: release: types: [published] #       jobs: run_tests: #          runs-on: [ubuntu-latest] steps: #   - uses: actions/checkout@master #  python   - uses: actions/setup-python@v1 with: python-version: '3.8' architecture: 'x64' - name: Install requirements #   run: pip install -r requirements.txt - name: Run tests #   run: coverage run src/tests.py - name: Tests report run: coverage report build_and_pub: #      needs: [run_tests] runs-on: [ubuntu-latest] env: LOGIN: ${{ secrets.DOCKER_LOGIN }} NAME: ${{ secrets.DOCKER_NAME }} steps: - name: Login to docker.io #     docker.io run: echo ${{ secrets.DOCKER_PWD }} | docker login -u ${{ secrets.DOCKER_LOGIN }} --password-stdin #   - uses: actions/checkout@master - name: Build image #  image        hub.docker .. login/repository:version run: docker build -t $LOGIN/$NAME:${GITHUB_REF:11} -f Dockerfile . - name: Push image to docker.io #    registry run: docker push $LOGIN/$NAME:${GITHUB_REF:11} deploy: #         registry,      #    curl   needs: [build_and_pub] runs-on: [ubuntu-latest] steps: - name: Set tag to env run: echo ::set-env name=RELEASE_VERSION::$(echo ${GITHUB_REF:11}) - name: Send webhook for deploy run: "curl --silent --show-error --fail -X POST ${{ secrets.DEPLOYMENT_SERVER }} -H 'Authorization: ${{ secrets.DEPLOYMENT_TOKEN }}' -H 'Content-Type: application/json' -d '{\"owner\": \"${{ secrets.DOCKER_LOGIN }}\", \"repository\": \"${{ secrets.DOCKER_NAME }}\", \"tag\": \"${{ env.RELEASE_VERSION }}\", \"ports\": {\"8080\": 8080}}'"</code> ] <code class="plaintext hljs">name: Publish on Docker Hub and Deploy on: release: types: [published] #       jobs: run_tests: #          runs-on: [ubuntu-latest] steps: #   - uses: actions/checkout@master #  python   - uses: actions/setup-python@v1 with: python-version: '3.8' architecture: 'x64' - name: Install requirements #   run: pip install -r requirements.txt - name: Run tests #   run: coverage run src/tests.py - name: Tests report run: coverage report build_and_pub: #      needs: [run_tests] runs-on: [ubuntu-latest] env: LOGIN: ${{ secrets.DOCKER_LOGIN }} NAME: ${{ secrets.DOCKER_NAME }} steps: - name: Login to docker.io #     docker.io run: echo ${{ secrets.DOCKER_PWD }} | docker login -u ${{ secrets.DOCKER_LOGIN }} --password-stdin #   - uses: actions/checkout@master - name: Build image #  image        hub.docker .. login/repository:version run: docker build -t $LOGIN/$NAME:${GITHUB_REF:11} -f Dockerfile . - name: Push image to docker.io #    registry run: docker push $LOGIN/$NAME:${GITHUB_REF:11} deploy: #         registry,      #    curl   needs: [build_and_pub] runs-on: [ubuntu-latest] steps: - name: Set tag to env run: echo ::set-env name=RELEASE_VERSION::$(echo ${GITHUB_REF:11}) - name: Send webhook for deploy run: "curl --silent --show-error --fail -X POST ${{ secrets.DEPLOYMENT_SERVER }} -H 'Authorization: ${{ secrets.DEPLOYMENT_TOKEN }}' -H 'Content-Type: application/json' -d '{\"owner\": \"${{ secrets.DOCKER_LOGIN }}\", \"repository\": \"${{ secrets.DOCKER_NAME }}\", \"tag\": \"${{ env.RELEASE_VERSION }}\", \"ports\": {\"8080\": 8080}}'"</code> - <code class="plaintext hljs">name: Publish on Docker Hub and Deploy on: release: types: [published] #       jobs: run_tests: #          runs-on: [ubuntu-latest] steps: #   - uses: actions/checkout@master #  python   - uses: actions/setup-python@v1 with: python-version: '3.8' architecture: 'x64' - name: Install requirements #   run: pip install -r requirements.txt - name: Run tests #   run: coverage run src/tests.py - name: Tests report run: coverage report build_and_pub: #      needs: [run_tests] runs-on: [ubuntu-latest] env: LOGIN: ${{ secrets.DOCKER_LOGIN }} NAME: ${{ secrets.DOCKER_NAME }} steps: - name: Login to docker.io #     docker.io run: echo ${{ secrets.DOCKER_PWD }} | docker login -u ${{ secrets.DOCKER_LOGIN }} --password-stdin #   - uses: actions/checkout@master - name: Build image #  image        hub.docker .. login/repository:version run: docker build -t $LOGIN/$NAME:${GITHUB_REF:11} -f Dockerfile . - name: Push image to docker.io #    registry run: docker push $LOGIN/$NAME:${GITHUB_REF:11} deploy: #         registry,      #    curl   needs: [build_and_pub] runs-on: [ubuntu-latest] steps: - name: Set tag to env run: echo ::set-env name=RELEASE_VERSION::$(echo ${GITHUB_REF:11}) - name: Send webhook for deploy run: "curl --silent --show-error --fail -X POST ${{ secrets.DEPLOYMENT_SERVER }} -H 'Authorization: ${{ secrets.DEPLOYMENT_TOKEN }}' -H 'Content-Type: application/json' -d '{\"owner\": \"${{ secrets.DOCKER_LOGIN }}\", \"repository\": \"${{ secrets.DOCKER_NAME }}\", \"tag\": \"${{ env.RELEASE_VERSION }}\", \"ports\": {\"8080\": 8080}}'"</code> l' <code class="plaintext hljs">name: Publish on Docker Hub and Deploy on: release: types: [published] #       jobs: run_tests: #          runs-on: [ubuntu-latest] steps: #   - uses: actions/checkout@master #  python   - uses: actions/setup-python@v1 with: python-version: '3.8' architecture: 'x64' - name: Install requirements #   run: pip install -r requirements.txt - name: Run tests #   run: coverage run src/tests.py - name: Tests report run: coverage report build_and_pub: #      needs: [run_tests] runs-on: [ubuntu-latest] env: LOGIN: ${{ secrets.DOCKER_LOGIN }} NAME: ${{ secrets.DOCKER_NAME }} steps: - name: Login to docker.io #     docker.io run: echo ${{ secrets.DOCKER_PWD }} | docker login -u ${{ secrets.DOCKER_LOGIN }} --password-stdin #   - uses: actions/checkout@master - name: Build image #  image        hub.docker .. login/repository:version run: docker build -t $LOGIN/$NAME:${GITHUB_REF:11} -f Dockerfile . - name: Push image to docker.io #    registry run: docker push $LOGIN/$NAME:${GITHUB_REF:11} deploy: #         registry,      #    curl   needs: [build_and_pub] runs-on: [ubuntu-latest] steps: - name: Set tag to env run: echo ::set-env name=RELEASE_VERSION::$(echo ${GITHUB_REF:11}) - name: Send webhook for deploy run: "curl --silent --show-error --fail -X POST ${{ secrets.DEPLOYMENT_SERVER }} -H 'Authorization: ${{ secrets.DEPLOYMENT_TOKEN }}' -H 'Content-Type: application/json' -d '{\"owner\": \"${{ secrets.DOCKER_LOGIN }}\", \"repository\": \"${{ secrets.DOCKER_NAME }}\", \"tag\": \"${{ env.RELEASE_VERSION }}\", \"ports\": {\"8080\": 8080}}'"</code> </pre> </div></div><br><p>  D'accord, nous avons rassembl√© tous ensemble, cr√©er maintenant une nouvelle version et de regarder les jeux d'action. <br><img src="https://habrastorage.org/webt/07/dn/5q/07dn5qrqodyyfaulm6gpey7w8my.png"><br>  <em>Interface Webhook pour l'application Actions de d√©ploiement</em> </p><br><p>  Tout s'est av√©r√©, nous faisons une requ√™te GET au service de d√©ploiement (affiche tous les conteneurs actifs sur l'h√¥te): <br><img src="https://habrastorage.org/webt/gq/1w/yg/gq1wygbewjefugj8itjchn2ucki.png"><br>  <em>D√©ploy√© sur le conteneur VPS</em> </p><br><p>  Nous allons maintenant envoyer des demandes √† notre application d√©ploy√©e: <br><img src="https://habrastorage.org/webt/hs/9x/hz/hs9xhzawrwliyoptcccjd-48bco.png"><br>  <em>GET demande de d√©ploiement</em> d' <em>un conteneur</em> </p><br><img src="https://habrastorage.org/webt/jf/fy/xc/jffyxcdf8zyzfylylyufv8wlcp0.png" alt="Demande post au conteneur d√©ploy√©"><br><p>  <em>Demande POST au conteneur d√©ploy√©</em> </p><br><p>  <strong>Conclusions</strong> <br>  GitHub Actions est un outil tr√®s pratique et flexible avec lequel vous pouvez faire beaucoup de choses qui peuvent grandement vous simplifier la vie.  Tout d√©pend de l'imagination. <br>  Ils prennent en charge les tests d'int√©gration avec les services. <br>  Comme suite logique de ce projet, vous pouvez ajouter √† webhook la possibilit√© de passer des param√®tres personnalis√©s pour lancer le conteneur. <br>  √Ä l'avenir, j'essaierai de prendre comme base ce projet de d√©ploiement de cartes de barre lorsque j'√©tudierai et exp√©rimenterai avec des k8 </p><br><p>  Si vous avez une sorte de projet personnel, les actions GitHub peuvent simplifier consid√©rablement le travail avec le r√©f√©rentiel. </p><br><p>  Les d√©tails de la syntaxe peuvent √™tre trouv√©s <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ici.</a> <br>  Toutes les sources de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">projets</a> </p><cut text=" "></cut></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr476368/">https://habr.com/ru/post/fr476368/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr476348/index.html">Comment les chimistes d'une universit√© d'√âtat ont introduit les principes informatiques dans leur travail et sont devenus chefs d'√©quipe</a></li>
<li><a href="../fr476352/index.html">Gestion des services sur le terrain et service sur le terrain. La Russie a-t-elle atteint le stade de la gestion des ing√©nieurs de service sur le terrain?</a></li>
<li><a href="../fr476354/index.html">Trois √©tapes pratiques pour √©conomiser les ressources de votre startup</a></li>
<li><a href="../fr476358/index.html">Maillage de service pour microservices. Partie I</a></li>
<li><a href="../fr476366/index.html">Le toit est all√©: comment comprendre qu'il est temps pour un th√©rapeute et comment le trouver</a></li>
<li><a href="../fr476370/index.html">Le site officiel de JetBrains est maintenant disponible en russe</a></li>
<li><a href="../fr476372/index.html">La th√©orie des cat√©gories permet aux math√©matiques d'abandonner les √©galit√©s</a></li>
<li><a href="../fr476374/index.html">Les fr√®res Wright: premiers brevets de trolls</a></li>
<li><a href="../fr476378/index.html">Recover, CUDA - Intel annonce un processeur graphique 7 nm pour les centres de donn√©es</a></li>
<li><a href="../fr476380/index.html">Commerce de crypto-monnaie - Comment d√©velopper une strat√©gie durable</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>