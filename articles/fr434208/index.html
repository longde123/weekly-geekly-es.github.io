<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ğŸ‘¨ğŸ¼â€ğŸ”§ ğŸ‘¨ğŸ»â€âœˆï¸ â›¹ï¸ Comment Go a sauvÃ© notre Black Friday ğŸ˜š ğŸ˜ƒ â™ ï¸</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Plus tÃ´t, nous avons expliquÃ© comment, Ã  mesure que la charge augmentait, nous avons progressivement abandonnÃ© l'utilisation de Python dans le backend...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Comment Go a sauvÃ© notre Black Friday</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/lamoda/blog/434208/">  Plus tÃ´t, nous avons expliquÃ© comment, Ã  mesure que la charge augmentait, nous avons progressivement abandonnÃ© l'utilisation de Python dans le backend des services critiques en production, en le remplaÃ§ant par Go.  Et aujourd'hui, moi, Denis Girko, chef d'Ã©quipe de l'Ã©quipe de dÃ©veloppement Madmin, souhaite partager les dÃ©tails: comment et pourquoi cela s'est produit sur l'exemple de l'un des services les plus importants pour notre entreprise - calculer le prix en tenant compte des remises sur les coupons. <br><br><img src="https://habrastorage.org/webt/8q/bo/y4/8qboy4stjrxnm432zasibweeyqe.jpeg"><br><a name="habracut"></a><br>  Les mÃ©canismes de travail avec les coupons sont probablement reprÃ©sentÃ©s par toute personne qui a effectuÃ© au moins une fois des achats dans des magasins en ligne.  Sur une page spÃ©ciale ou directement dans le panier, vous saisissez le numÃ©ro du coupon, et les prix sont recalculÃ©s en fonction de la remise promise.  Le calcul dÃ©pend du type de remise que le coupon offre - en pourcentage, sous la forme d'un montant fixe ou en utilisant d'autres mathÃ©matiques (par exemple, nous tenons Ã©galement compte des points du programme de fidÃ©litÃ©, des promotions en magasin, des types de marchandises, etc.).  Naturellement, la commande est dÃ©jÃ  Ã©mise avec de nouveaux prix. <br><br>  Les entreprises sont ravies de tous ces mÃ©canismes de travail avec les prix, mais nous voulons parler du service d'un point de vue lÃ©gÃ¨rement diffÃ©rent. <br><br><h2>  Comment Ã§a marche </h2><br>  Pour une tarification tenant compte de toutes ces difficultÃ©s sur le backend, nous avons dÃ©sormais un service sÃ©parÃ©.  Cependant, il n'Ã©tait pas toujours indÃ©pendant.  Le service est apparu un an ou deux aprÃ¨s le dÃ©marrage de la boutique en ligne et, en 2016, il faisait partie d'un grand monolithe Python qui comprenait une grande variÃ©tÃ© de composants pour l'activitÃ© marketing (Madmin).  Plus tard, il s'est imposÃ© comme un Â«blocÂ» indÃ©pendant en s'orientant vers l'architecture de microservices. <br><br>  Comme c'est gÃ©nÃ©ralement le cas avec les monolithes, Madmin a Ã©tÃ© modifiÃ© et correspondait en partie Ã  un grand nombre de dÃ©veloppeurs.  Des bibliothÃ¨ques tierces y ont Ã©tÃ© intÃ©grÃ©es, ce qui a simplifiÃ© le dÃ©veloppement, mais n'a souvent pas eu le meilleur effet sur les performances.  Cependant, Ã  cette Ã©poque, nous ne nous soucions pas vraiment de la rÃ©sistance aux charges lourdes pendant les ventes, car le service a fait un excellent travail.  Mais 2016 a tout changÃ©. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/e40/3a3/3e1/e403a33e16fea41905491776c8b0c26e.jpg"><br><br>  Aux Ã‰tats-Unis, le Â«Black FridayÂ» est connu depuis les annÃ©es 60 du siÃ¨cle dernier.  En Russie, il a commencÃ© Ã  Ãªtre lancÃ© dans les annÃ©es 2010, alors que l'action devait Ãªtre crÃ©Ã©e Ã  partir de zÃ©ro - le marchÃ© n'Ã©tait pas tout Ã  fait prÃªt pour cela.  Cependant, les efforts des organisateurs n'ont pas Ã©tÃ© vains, et avec chaque annÃ©e le trafic des utilisateurs sur notre site a augmentÃ© pendant les jours de vente.  Et donc, notre collision avec la charge, excessive pour cette version du service de calcul des prix, n'Ã©tait qu'une question de temps. <br><br><h2>  Vendredi noir 2016. Et nous l'avons trop dormie </h2><br>  Ã‰tant donnÃ© que l'idÃ©e de vente a fonctionnÃ© Ã  son plein potentiel, le Â«Black FridayÂ» diffÃ¨re de tout autre jour de l'annÃ©e en ce sens qu'Ã  minuit, une audience hebdomadaire du site Web arrive dans le magasin.  C'est une pÃ©riode difficile pour tous les services.  MÃªme dans ceux d'entre eux qui fonctionnent bien tout au long de l'annÃ©e, des problÃ¨mes surgissent parfois. <br><br>  Nous nous prÃ©parons maintenant pour chaque nouveau Â«Black FridayÂ», en imitant la charge attendue, mais en 2016, nous avons toujours agi diffÃ©remment.  Lors du test de Madmin avant un jour important, nous avons testÃ© la rÃ©sistance Ã  la charge Ã  l'aide de scÃ©narios de comportement de l'utilisateur les jours normaux.  Il s'est avÃ©rÃ© que ce test ne reflÃ¨te pas tout Ã  fait la situation rÃ©elle, car le Â«Black FridayÂ», beaucoup de gens ont le mÃªme coupon.  Par consÃ©quent, le service de calcul des prix tenant compte de cette remise, incapable de faire face Ã  une triple charge (par rapport aux jours ordinaires), a bloquÃ© notre capacitÃ© Ã  servir les clients pendant deux heures au plus fort pic de la vente. <br><br>  Le service "est passÃ©" une heure avant minuit.  Tout a commencÃ© par une interruption de la connexion Ã  la base de donnÃ©es (MySQL Ã  l'Ã©poque), aprÃ¨s quoi toutes les copies en cours d'exÃ©cution du service de calcul des prix n'ont pas pu se reconnecter.  Et ceux qui Ã©taient toujours connectÃ©s n'ont pas rÃ©sistÃ© Ã  la charge et ont cessÃ© de rÃ©pondre, Ã©tant coincÃ©s sur les verrous de la base. <br><br>  Par coÃ¯ncidence, le cadet est restÃ© en service Ã  ce moment-lÃ  qui, au moment de la chute du service, se rendait du bureau.  Il n'a pu se connecter au problÃ¨me que lorsqu'il est arrivÃ© sur les lieux et a appelÃ© Â«l'artillerie lourdeÂ» - l'officier de service d'urgence.  Ensemble, ils n'ont cependant normalisÃ© la situation qu'aprÃ¨s deux heures. <br><br>  Au dÃ©but de la procÃ©dure, des dÃ©tails ont commencÃ© Ã  s'ouvrir sur le caractÃ¨re sous-optimal du service.  Par exemple, il s'est avÃ©rÃ© que pour calculer un coupon, 28 requÃªtes ont Ã©tÃ© effectuÃ©es dans la base de donnÃ©es (il n'est pas surprenant que tout fonctionne avec une utilisation Ã  100% du processeur).  Les utilisateurs mentionnÃ©s ci-dessus avec le mÃªme coupon Black Friday n'ont pas simplifiÃ© la situation, d'autant plus que nous avions un compteur d'applications pour tous les coupons - donc chaque utilisation augmentait la charge en se rÃ©fÃ©rant Ã  ce compteur. <br><br>  2016 nous a donnÃ© matiÃ¨re Ã  rÃ©flexion - principalement sur la maniÃ¨re d'ajuster notre travail avec des coupons et des tests afin que cette situation ne se reproduise plus.  Et en chiffres, ce vendredi est mieux dÃ©crit par cette image: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/75e/310/1fc/75e3101fca74fc4e8b220673619eaada.jpg"><br>  <i>Les rÃ©sultats du Black Friday 2016</i> <br><br><h2>  Vendredi noir 2017. Nous nous prÃ©parions sÃ©rieusement, mais ... </h2><br>  Ayant reÃ§u une bonne leÃ§on, nous nous sommes prÃ©parÃ©s Ã  l'avance pour le prochain Â«Black FridayÂ», aprÃ¨s avoir sÃ©rieusement reconstruit et optimisÃ© le service.  Par exemple, nous avons finalement crÃ©Ã© deux types de coupons: limitÃ© et illimitÃ© - afin d'Ã©viter les verrous sur l'accÃ¨s simultanÃ© Ã  la base de donnÃ©es, nous avons supprimÃ© l'entrÃ©e de la base de donnÃ©es du script pour appliquer le coupon populaire.  En parallÃ¨le, 1 Ã  2 mois avant le Black Friday, nous sommes passÃ©s de MySQL Ã  PostgreSQL dans le service, ce qui, avec l'optimisation du code, a rÃ©duit le nombre d'appels de base de donnÃ©es de 28 Ã  4 Ã  5. Ces amÃ©liorations nous ont permis d'Ã©tendre le service de test aux exigences de SLA - rÃ©ponse en 3 secondes, 95 centile Ã  600 RPS. <br><br>  Ne sachant pas Ã  quel point nos amÃ©liorations ont accÃ©lÃ©rÃ© le travail de l'ancienne version du service en production, Ã  ce moment-lÃ , deux versions de code Python Ã©taient en cours de prÃ©paration pour le Black Friday - une version existante hautement optimisÃ©e et un code entiÃ¨rement nouveau Ã©crit Ã  partir de zÃ©ro.  En production, le second a Ã©tÃ© dÃ©ployÃ©, qui a Ã©tÃ© testÃ© avant ce jour et cette nuit.  Cependant, comme il s'est avÃ©rÃ© "au combat", un peu sous-testÃ©. <br><br>  Le jour de Â«l'urgenceÂ» avec l'arrivÃ©e du flux principal de clients, la charge sur le service a commencÃ© Ã  croÃ®tre de faÃ§on exponentielle.  Certaines demandes ont Ã©tÃ© traitÃ©es jusqu'Ã  deux minutes.  En raison du long traitement de certaines demandes, la charge des autres travailleurs a augmentÃ©. <br><br>  Notre tÃ¢che principale Ã©tait de servir un trafic aussi prÃ©cieux pour les entreprises.  Mais il est devenu Ã©vident que Â«couler avec du ferÂ» ne rÃ©sout pas le problÃ¨me et Ã  tout moment le nombre de travailleurs occupÃ©s atteindra 100%.  Ne sachant alors pas exactement Ã  quoi nous Ã©tions confrontÃ©s, nous avons dÃ©cidÃ© d'activer harakiri dans uWSGI et de simplement clouer les longues demandes (qui sont traitÃ©es pendant plus de 6 secondes) pour libÃ©rer des ressources pour les normales.  Et cela a vraiment aidÃ© Ã  rÃ©sister - les travailleurs ont commencÃ© Ã  Ãªtre libÃ©rÃ©s quelques minutes avant d'Ãªtre complÃ¨tement Ã©puisÃ©s. <br><br>  Un peu plus tard, nous avons compris la situation ... Il s'est avÃ©rÃ© qu'il s'agissait de demandes avec de trÃ¨s grands paniers - de 40 Ã  100 produits - et avec un coupon spÃ©cifique ayant des restrictions sur la gamme.  Cette situation a Ã©tÃ© mal rÃ©glÃ©e par le nouveau code.  Il a montrÃ© un travail incorrect avec le tableau, qui s'est transformÃ© en rÃ©cursion infinie.  Il est curieux que nous ayons ensuite testÃ© un Ã©tui avec de grands paniers, mais pas en combinaison avec un coupon dÃ©licat.  Comme solution, nous sommes simplement passÃ©s Ã  une version diffÃ©rente du code.  Certes, cela s'est produit trois heures avant la fin du Black Friday.  Ã€ partir de ce moment, tous les paniers ont commencÃ© Ã  Ãªtre traitÃ©s correctement.  Et bien que nous ayons terminÃ© le plan de vente Ã  ce moment-lÃ , nous avons Ã©vitÃ© des problÃ¨mes mondiaux miraculeux en raison de la charge cinq fois par jour. <br><br><h2>  Vendredi noir 2018 </h2><br>  En 2018, pour les services trÃ¨s chargÃ©s qui desservent le site, nous avons progressivement commencÃ© Ã  implÃ©menter Go.  Compte tenu de l'histoire des prÃ©cÃ©dents vendredis noirs, le service de calcul des remises a Ã©tÃ© l'un des premiers candidats au traitement. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/2f2/257/86a/2f225786a88b927c087c904c36702203.jpg"><br><br>  Bien sÃ»r, nous pourrions enregistrer la version de Python qui Ã©tait dÃ©jÃ  Â«testÃ©e au combatÂ», et avant le nouveau Â«Black FridayÂ», nous pourrions dÃ©sactiver les bibliothÃ¨ques lourdes et jeter du code non optimal.  Cependant, Golang avait dÃ©jÃ  pris racine Ã  cette Ã©poque et semblait plus prometteur. <br><br>  Nous sommes passÃ©s Ã  un nouveau service cet Ã©tÃ©, donc avant la prochaine vente, nous avons rÃ©ussi Ã  bien le tester, y compris sur un profil de charge croissant. <br><br>  Lors des tests, il s'est avÃ©rÃ© que la faiblesse en termes de charges Ã©levÃ©es reste notre base.  Des transactions trop longues ont conduit au fait que nous avons sÃ©lectionnÃ© l'ensemble du pool de connexions et que les demandes ont Ã©tÃ© mises en file d'attente.  Nous avons donc dÃ» refaire un peu la logique de l'application, en rÃ©duisant l'utilisation de la base de donnÃ©es au minimum (en y faisant rÃ©fÃ©rence uniquement lorsqu'il n'y a rien Ã  faire) et en mettant en cache les rÃ©pertoires de la base de donnÃ©es et les donnÃ©es sur les coupons populaires le Black Friday. <br><br>  Certes, cette annÃ©e, nous nous sommes trompÃ©s avec des prÃ©visions de charge Ã  la hausse: nous nous prÃ©parions Ã  une croissance de 6 Ã  8 fois dans les pics et avons rÃ©alisÃ© un bon travail de services juste pour un tel volume de demandes (caches ajoutÃ©s, fonctions expÃ©rimentales dÃ©sactivÃ©es Ã  l'avance, simplifiÃ© certaines choses, dÃ©ployÃ© des nÅ“uds Kubernetes supplÃ©mentaires et mÃªme des serveurs de bases de donnÃ©es pour les rÃ©pliques, qui n'Ã©taient finalement pas nÃ©cessaires).  En fait, la montÃ©e de l'intÃ©rÃªt des utilisateurs a Ã©tÃ© moindre, donc tout s'est dÃ©roulÃ© comme d'habitude.  Le temps de rÃ©ponse du service n'a pas dÃ©passÃ© 50 ms Ã  95 centile. <br><br>  Pour nous, l'une des caractÃ©ristiques les plus importantes est la faÃ§on dont l'application Ã©volue lorsqu'il n'y a pas suffisamment de ressources pour une copie.  Go utilise les ressources matÃ©rielles plus efficacement, donc avec la mÃªme charge, vous devez exÃ©cuter moins de copies (en fin de compte, servir plus de demandes sur les mÃªmes ressources matÃ©rielles).  Cette annÃ©e, au plus fort de la vente, 16 instances de l'application fonctionnaient, ce qui a traitÃ© en moyenne 300 demandes par seconde avec des pointes allant jusqu'Ã  400 demandes par seconde, soit environ deux fois plus que la charge habituelle.  Notez que l'annÃ©e derniÃ¨re, un service Python a nÃ©cessitÃ© 102 instances. <br><br>  Il semblerait que le service on Go de la premiÃ¨re approche ait fermÃ© tous nos besoins.  Mais Golang n'est pas une "solution unique Ã  tous les problÃ¨mes".  Il ne pouvait pas se passer de certaines fonctionnalitÃ©s.  Par exemple, nous avons dÃ» limiter le nombre de threads que le service peut dÃ©marrer sur le nÅ“ud multiprocesseur Kubernetes, afin que lors de sa mise Ã  l'Ã©chelle, il n'interfÃ¨re pas avec les applications "voisines" en production (par dÃ©faut, Go n'a aucune limite sur le nombre de processeurs qu'il prendra).  Pour ce faire, nous avons configurÃ© GOMAXPROCS dans toutes les applications sur Go.  Nous serons ravis de vous dire Ã  quel point cela a Ã©tÃ© utile - dans notre Ã©quipe, ce nâ€™Ã©tait lÃ  quâ€™une des hypothÃ¨ses concernant la maniÃ¨re de faire face Ã  la dÃ©gradation des Â«voisinsÂ». <br><br>  Une autre Â«configurationÂ» est le nombre de connexions dÃ©tenues en tant que Keep-Alive.  Les clients HTTP et DB rÃ©guliers dans Go par dÃ©faut ne dÃ©tiennent que deux connexions, donc s'il y a beaucoup de demandes simultanÃ©es et que vous devez Ã©conomiser sur le trafic de la configuration de la connexion TCP, il est logique d'augmenter cette valeur en dÃ©finissant respectivement MaxIdleConnsPerHost et SetMaxIdleConns. <br><br>  Cependant, mÃªme avec ces Â«rebondissementsÂ» manuels, Golang nous a fourni une grande marge de performance pour les ventes futures. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr434208/">https://habr.com/ru/post/fr434208/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr434196/index.html">3CX v16 Alpha 2 et plans pour la nouvelle annÃ©e</a></li>
<li><a href="../fr434198/index.html">Choisir un mode de fonctionnement du serveur Web en fonction de son expÃ©rience personnelle</a></li>
<li><a href="../fr434200/index.html">La rouille est-elle si terrible qu'elle est peinte</a></li>
<li><a href="../fr434202/index.html">4 secrets pour ne pas perdre son emploi en science des donnÃ©es</a></li>
<li><a href="../fr434206/index.html">Distributeur de jet ok.ru/music</a></li>
<li><a href="../fr434210/index.html">Analyse du concours de quiz Android du stand HeadHunter au Mobius 2018 Moscou</a></li>
<li><a href="../fr434212/index.html">Tour de Tesla. Que se passe-t-il dans et prÃ¨s d'un gratte-ciel lorsque la foudre frappe?</a></li>
<li><a href="../fr434214/index.html">Proxy dynamique Java: qu'est-ce que c'est et comment l'utiliser?</a></li>
<li><a href="../fr434216/index.html">Attaques par force brute avec Kali Linux</a></li>
<li><a href="../fr434218/index.html">Bot clicker Java simple sur l'exemple du jeu World of Warcraft 3.3.5a</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>